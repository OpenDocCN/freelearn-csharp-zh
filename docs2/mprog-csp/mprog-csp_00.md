# 前言

“始终编写代码，就好像最终维护你代码的人是一个知道你住在哪里、性格暴力的精神病患者。”

– 马丁·戈尔丁

在软件的世界里，有很多事情可能会出错，而且通常确实会出错。我们是一个相对年轻的行业，处于不断变化的状态。事物尚未稳定，创新以闪电般的速度发生。这不像木工，有着几千年的经验，知道什么可行什么不可行。在软件领域，我们仍在发明工具，并在前进的过程中重新发明它们。为我们的最终用户提高生产力的可能性设定了很高的期望，在日益竞争的市场中，上市时间至关重要。

在我们今天编写软件的水平上，我们有巨大的潜力利用围绕我们自己的代码的元数据来确保我们编写的软件的质量和可维护性。这就是元编程之旅开始的地方。

元编程在工作中真的很有趣，但它代表了开发者和企业区分自己的真正机会。元编程能为你做的事情包括以下内容：

+   提高代码的可维护性

+   自动化繁琐的任务

+   让开发者更多地关注你的业务，而不是基础设施

+   帮助你保持更高的合规性

+   降低与安全相关的风险

与任何其他技术一样，深入研究元编程有技术上的原因，但我认为通过利用它来帮助你和你的团队提高生产力，最终交付更多业务关键特性，这些特性在多年后更容易更改和维护，这是有真正价值的。

# 这本书面向的对象

这本书面向任何对元编程及其可能为你带来的益处感兴趣的 C#开发者。更具体地说，以下角色是目标受众：

+   熟悉 C#和.NET 作为运行时并希望扩展其视野、更深入地了解.NET 运行时和编译器功能的开发者

+   熟悉 C#和.NET 的软件架构师，正在寻找如何改进其架构的灵感

+   具有开发者背景或理解软件开发并希望为开发者组织提供灵感的 CTO 或开发经理

# 这本书涵盖的内容

*第一章*，*元编程如何为你带来益处*，深入探讨了元编程是什么以及它如何改善开发者的日常工作。它通过一些具体的例子来解释其功能。

*第二章*，*元编程概念*，通过具体的例子解释了隐式和显式元数据之间的区别。此外，它还揭示了.NET 运行时的工作原理。

*第三章*, *通过现有真实世界示例去神秘化*，展示了微软作为例子如何利用元编程，以及您可能已经使用它的情况。

*第四章*, *使用反射推理类型*，概述了.NET 运行时反射的强大功能以及如何利用其隐式元数据。

*第五章*, *利用属性*，介绍了利用 C#属性作为显式元编程技术以及如何使用它，并提供了实际应用的示例。

*第六章*, *动态代理生成*，介绍了在运行时生成代码的代码，这是一个真正能够提高开发者生产力的强大概念，如果明智地使用的话。

*第七章*, *推理表达式*，介绍了 C#和.NET 表达式树，它们如何表示元数据的另一个方面，以及如何在代码中进行推理和展开。

*第八章*, *构建和执行表达式*，介绍了如何在运行时构建自己的表达式以及如何执行这些表达式——生成代码的另一种技术。

*第九章*, *利用动态语言运行时*，涵盖了动态语言运行时的概念以及如何使用它来动态生成代码——您的代码的另一种选择是创建代码。

*第十章*, *约定优于配置*，揭示了约定的超级能力——重复您可能已经拥有的模式的代码，使您的开发者更加高效，代码库更加一致。

*第十一章*, *应用开闭原则*，深入探讨了如何创建既可扩展又不可修改的代码库——这是一个强大的原则，用于维护性软件，使用元编程作为进入该原则的角度。

*第十二章*, *超越继承*，在常规约定之上提供了另一个层次，为开发者提供了不仅仅受编程语言提供的功能所限制的机会，旨在提高可读性和可维护性。

*第十三章*, *应用横切关注点*，揭示了如何在整个代码库中一致地应用代码，而无需回到手动配方。

*第十四章*, *面向方面编程*，提供了关于面向方面编程形式化的详细信息以及如何作为一种更正式的技术来帮助您提供横切关注点。

*第十五章*, *Roslyn 编译器扩展*，详细介绍了.NET 编译器 SDK 提供的基本内容以及如何开始使用它，为以下章节奠定了基础。

*第十六章*, *生成代码*，介绍了如何在进入运行时之前使用编译器级别的代码生成代码，这是提高开发人员生产力和保持代码库一致性的另一种绝佳方法。

*第十七章*, *静态代码分析*，介绍了如何构建自己的规则，对添加到项目中的任何代码进行分析，帮助您创建一致、统一且易于维护的代码。

*第十八章*, *注意事项和结语*，探讨了本书涵盖的内容、有哪些好处以及有哪些注意事项。与任何事物一样，你必须找到正确的平衡，并知道何时使用什么。

# 要充分利用本书

| **本书涵盖的软件/硬件** | **操作系统要求** |
| --- | --- |
| 使用.NET 7 的 C# | Windows、macOS 或 Linux |
| Postman | Windows、macOS 或 Linux |
| MongoDB | Windows、macOS 或 Linux |

**如果您使用的是本书的数字版，我们建议您亲自输入代码或从本书的 GitHub 仓库（下一节中提供链接）获取代码。这样做将帮助您避免与代码的复制和粘贴相关的任何潜在错误。**

# 下载示例代码文件

您可以从 GitHub 下载本书的示例代码文件[`github.com/PacktPublishing/Metaprogramming-in-C-Sharp`](https://github.com/PacktPublishing/Metaprogramming-in-C-Sharp)。如果代码有更新，它将在 GitHub 仓库中更新。

我们还有来自我们丰富的书籍和视频目录的其他代码包可供选择，这些代码包可在[`github.com/PacktPublishing/`](https://github.com/PacktPublishing/)找到。查看它们吧！

# 下载彩色图像

我们还提供了一份包含本书中使用的截图和图表的彩色 PDF 文件。您可以从这里下载：[`packt.link/nZUlx`](https://packt.link/nZUlx)。

# 使用的约定

本书使用了多种文本约定。

**文本中的代码**: 表示文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 昵称。以下是一个示例：“提供商寻找**ConfidentialAttribute**以决定是否可以提供。”

代码块设置为以下格式：

```cs
namespace Fundamentals.Compliance;
public interface ICanProvideComplianceMetadataForType
{
 bool CanProvide(Type type);
 ComplianceMetadata Provide(Type type);
}
```

任何命令行输入或输出都按照以下方式编写：

```cs
Checking type for compliance rules: Chapter11.Patient
Property: FirstName - Employment records
Property: LastName - Employment records
Property: SocialSecurityNumber - Uniquely identifies the employee
Property JournalEntries is a collection of type Chapter11.JournalEntry with type level metadata
```

**粗体**: 表示新术语、重要单词或屏幕上看到的单词。例如，菜单或对话框中的单词以**粗体**显示。以下是一个示例：“然后在**Body**选项卡中选择**JSON**，添加一个空白的 JSON 文档，然后点击**Send**。”

小贴士或重要注意事项

看起来像这样。

# 联系我们

我们始终欢迎读者的反馈。

**一般反馈**：如果你对本书的任何方面有疑问，请通过电子邮件联系我们 customercare@packtpub.com，并在邮件主题中提及书名。

**勘误表**：尽管我们已经尽一切努力确保我们内容的准确性，但错误仍然可能发生。如果你在这本书中发现了错误，我们将不胜感激，如果你能向我们报告这一点。请访问[www.packtpub.com/support/errata](http://www.packtpub.com/support/errata)并填写表格。

**盗版**：如果你在互联网上以任何形式遇到我们作品的非法副本，我们将不胜感激，如果你能向我们提供位置地址或网站名称。请通过电子邮件联系我们 copyright@packtpub.com，并提供材料的链接。

**如果你有兴趣成为作者**：如果你在某个领域有专业知识，并且你感兴趣的是撰写或为书籍做出贡献，请访问[authors.packtpub.com](http://authors.packtpub.com)。

# 分享你的想法

一旦你阅读了《C#元编程》，我们很乐意听听你的想法！请[点击此处直接进入此书的亚马逊评论页面](https://packt.link/r/1-837-63542-0)并分享你的反馈。

你的评论对我们和科技社区都很重要，并将帮助我们确保我们提供高质量的内容。

# 下载此书的免费 PDF 副本

感谢你购买这本书！

你喜欢在旅途中阅读，但无法携带你的印刷书籍到处走吗？你的电子书购买是否与你的选择设备不兼容？

别担心，现在每购买一本 Packt 书籍，你都可以免费获得该书的 DRM 免费 PDF 版本。

在任何地方、任何设备上阅读。直接从你最喜欢的技术书籍中搜索、复制和粘贴代码到你的应用程序中。

优惠不会就此结束，你还可以获得独家折扣、时事通讯和每日收件箱中的精彩免费内容。

按照以下简单步骤获取优惠：

1.  扫描下面的二维码或访问以下链接！[](img/B19418_QR_Free_PDF.jpg)

https://packt.link/free-ebook/9781837635429

1.  提交你的购买证明

1.  就这些！我们将直接将免费的 PDF 和其他优惠发送到你的邮箱。

# 第一部分：为什么需要元编程？

在这部分，你将了解什么是元编程，它的好处，以及如何通过实际案例利用它的想法。你还将看到你很可能会直接或间接地已经在使用它，以及如何获得一些快速胜利和早期收益。

本部分包含以下章节：

+   *第一章*，*元编程如何为你带来好处？*

+   *第二章*，*元编程概念*

+   *第三章*，*通过现有实际案例去神秘化*
