<html><head></head><body><div><div><div><h1 class="chapterNumber">15</h1>
    <h1 id="_idParaDest-810" class="chapterTitle">Building and Consuming Web Services</h1>
    <p class="normal">This chapter is about learning how to build web services (aka HTTP or <strong class="keyWord">Representational State Transfer</strong> (<strong class="keyWord">REST</strong>) services) using ASP.NET Core Minimal APIs. You will then <a id="_idIndexMarker2125"/>learn how to consume web services using HTTP clients, which could be any other type of .NET app, including a website or a mobile or desktop app. We will create a Blazor WebAssembly client.</p>
    <p class="normal">This chapter requires the knowledge and skills that you gained in <em class="chapterRef">Chapter 10</em>, <em class="italic">Working with Data Using Entity Framework Core</em>, and <em class="chapterRef">Chapters 12</em> to <em class="chapterRef">14</em>, about building websites using ASP.NET Core and Blazor.</p>
    <p class="normal">In this chapter, we will cover the following topics:</p>
    <ul>
      <li class="bulletList">Building web services using ASP.NET Core</li>
      <li class="bulletList">Creating a web service for the Northwind database</li>
      <li class="bulletList">Documenting and trying out web services</li>
      <li class="bulletList">Consuming web services using HTTP clients</li>
    </ul>
    <h1 id="_idParaDest-811" class="heading-1">Building web services using ASP.NET Core</h1>
    <p class="normal">Before we build a <a id="_idIndexMarker2126"/>modern web service, we need to cover some background to set the context for this chapter.</p>
    <h2 id="_idParaDest-812" class="heading-2">Understanding web service acronyms</h2>
    <p class="normal">Although HTTP was<a id="_idIndexMarker2127"/> originally designed to <a id="_idIndexMarker2128"/>request and respond with HTML and other resources for humans to look at, it is also good for building services.</p>
    <p class="normal">Roy Fielding stated in his doctoral dissertation, describing the <strong class="keyWord">REST </strong>architectural style, that the HTTP standard would be good for building services because it defines the following:</p>
    <ul>
      <li class="bulletList">URIs to uniquely identify resources, like <code class="inlineCode">https://localhost:5151/products/23</code>.</li>
      <li class="bulletList">Methods for performing common tasks on those resources, like <code class="inlineCode">GET</code>, <code class="inlineCode">POST</code>, <code class="inlineCode">PUT</code>, and <code class="inlineCode">DELETE</code>.</li>
      <li class="bulletList">The ability to negotiate the media type of content exchanged in requests and responses, such as XML and JSON. Content negotiation happens when the client specifies a request header like <code class="inlineCode">Accept: application/xml,*/*;q=0.8</code>. The default response format used by the ASP.NET Core web services is JSON, which means one of the response headers would be <code class="inlineCode">Content-Type: application/json; charset=utf-8</code>.</li>
    </ul>
    <p class="normal"><strong class="keyWord">Web services</strong> use the HTTP <a id="_idIndexMarker2129"/>communication <a id="_idIndexMarker2130"/>standard, so they are sometimes called <strong class="keyWord">HTTP services</strong> or <strong class="keyWord">RESTful services</strong>.</p>
    <h2 id="_idParaDest-813" class="heading-2">Understanding HTTP requests and responses</h2>
    <p class="normal">HTTP defines<a id="_idIndexMarker2131"/> standard <a id="_idIndexMarker2132"/>types of requests and standard codes to indicate a type of response. Most of them can be used to implement web services.</p>
    <p class="normal">The most common type of request is <code class="inlineCode">GET</code>, to retrieve a resource identified by a unique path, with additional options like what media type is acceptable to set as a request header, like <code class="inlineCode">Accept</code>, as shown in the following example:</p>
    <pre class="programlisting con"><code class="hljs-con">GET /path/to/resource
Accept: application/json
</code></pre>
    <p class="normal">Common responses <a id="_idIndexMarker2133"/>include<a id="_idIndexMarker2134"/> success and multiple types of failure, as shown in <em class="italic">Table 15.1</em>:</p>
    <table id="table001-14" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Status code</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">101 Switching Protocols</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The requester has asked the server to switch protocols and the server has agreed to do so. For example, it is common to switch from HTTP to <strong class="keyWord">WebSockets</strong> (<strong class="keyWord">WS</strong>) for more efficient communication.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">103 Early Hints</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Used to convey hints that help a client make preparations to process the final response. For example, the server might send the following response before then sending a normal <code class="inlineCode">200 OK</code> response for a web page that uses a stylesheet and JavaScript file:</p>
            <pre class="programlisting code"><code class="hljs-code">HTTP/1.1 103 Early Hints
Link: &lt;/style.css&gt;; rel=preload; as=style
Link: &lt;/script.js&gt;; rel=preload; as=script
</code></pre>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">200 OK</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The path was correctly formed and the resource was successfully found, serialized into an acceptable media type, and then returned in the response body. The response headers specify the <code class="inlineCode">Content-Type</code>, <code class="inlineCode">Content-Length</code>, and <code class="inlineCode">Content-Encoding</code>, for example, <code class="inlineCode">GZIP</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">301 Moved Permanently</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Over time, a web service may change its resource model, including the path used to identify an existing resource. The web service can indicate the new path by returning this status code and a response header named <code class="inlineCode">Location</code> that has the new path.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">302 Found</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This is the same as <code class="inlineCode">301</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">304 Not Modified</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">If the request includes the <code class="inlineCode">If-Modified-Since</code> header, then the web service can respond with this status code. The response body is empty because the client should use its cached copy of the resource.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">307 Temporary Redirect</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The requested resource has been temporarily moved to the URL in the <code class="inlineCode">Location</code> header. The browser should make a new request using that URL. For example, this is what happens if you enable <code class="inlineCode">UseHttpsRedirection</code> and a client makes an HTTP request.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">400 Bad Request</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The request was invalid, for example, it used a path for a product using an integer ID where the ID value is missing.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">401 Unauthorized</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The request was valid and the resource was found, but the client did not supply credentials or is not authorized to access that resource. Re-authenticating may enable access, for example, by adding or changing the <code class="inlineCode">Authorization</code> request header.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">403 Forbidden</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The request was valid and the resource was found, but the client is not authorized to access that resource. Re-authenticating will not fix the issue.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">404 Not Found</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The request was valid, but the resource was not found. The resource may be found<a id="_idIndexMarker2135"/> if the <a id="_idIndexMarker2136"/>request is repeated later. To indicate that a resource will never be found, return <code class="inlineCode">410 Gone</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">406 Not Acceptable</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">If the request has an <code class="inlineCode">Accept</code> header that only lists media types that the web service does not support. For example, if the client requests JSON but the web service can only return XML.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">451 Unavailable for Legal Reasons</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">A website hosted in the USA might return this for requests coming from Europe to avoid having to comply with the <strong class="keyWord">General Data Protection Regulation</strong> (<strong class="keyWord">GDPR</strong>). The <a id="_idIndexMarker2137"/>number was chosen as a reference to the novel Fahrenheit 451, in which books are banned and burned.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">500 Server Error</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The request was valid, but something went wrong on the server side while processing the request. Retrying again later might work.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">503 Service Unavailable</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The web service is busy and cannot handle the request. Trying again later might work.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 15.1: Common HTTP status code responses to the GET method</p>
    <p class="normal">Other common types of HTTP requests include <code class="inlineCode">POST</code>, <code class="inlineCode">PUT</code>, <code class="inlineCode">PATCH</code>, or <code class="inlineCode">DELETE</code>, which create, modify, or delete resources.</p>
    <p class="normal">To create a new resource, you might make a <code class="inlineCode">POST</code> request with a body that contains the new resource, as shown in the following code:</p>
    <pre class="programlisting con"><code class="hljs-con">POST /path/to/resource
Content-Length: 123
Content-Type: application/json
</code></pre>
    <p class="normal">To create a new resource or update an existing resource, you might make a <code class="inlineCode">PUT</code> request with a body that contains a whole new version of the existing resource, and if the resource <a id="_idIndexMarker2138"/>does not<a id="_idIndexMarker2139"/> exist, it is created, or if it does exist, it is replaced (sometimes <a id="_idIndexMarker2140"/>called an <strong class="keyWord">upsert</strong> operation), as shown in the following code:</p>
    <pre class="programlisting con"><code class="hljs-con">PUT /path/to/resource
Content-Length: 123
Content-Type: application/json
</code></pre>
    <p class="normal">To update an existing resource more efficiently, you might make a <code class="inlineCode">PATCH</code> request with a body that contains an object with only the properties that need changing, as shown in the following code:</p>
    <pre class="programlisting con"><code class="hljs-con">PATCH /path/to/resource
Content-Length: 123
Content-Type: application/json
</code></pre>
    <p class="normal">To delete an existing resource, you might make a <code class="inlineCode">DELETE</code> request, as shown in the following code:</p>
    <pre class="programlisting con"><code class="hljs-con">DELETE /path/to/resource
</code></pre>
    <p class="normal">As well as the responses shown in the table above for a <code class="inlineCode">GET</code> request, all the types of requests that<a id="_idIndexMarker2141"/> create, modify, or<a id="_idIndexMarker2142"/> delete a resource have additional possible common responses, as shown in <em class="italic">Table 15.2</em>:</p>
    <table id="table002-13" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Status code</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">201 Created</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The new resource was created successfully, the response header named <code class="inlineCode">Location</code> contains its path, and the response body contains the newly created resource. Immediately <code class="inlineCode">GET</code>-ing the resource should return <code class="inlineCode">200</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">202 Accepted</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The new resource cannot be created immediately, so the request is queued for later processing, and immediately <code class="inlineCode">GET</code>-ing the resource might return <code class="inlineCode">404</code>. The body can contain a resource that points to some form of status checker or an estimate of when the resource will become available.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">204 No Content</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Commonly used in response to a <code class="inlineCode">DELETE</code> request since returning the resource in the body after deleting it does not usually make sense! Sometimes used in response to <code class="inlineCode">POST</code>, <code class="inlineCode">PUT</code>, or <code class="inlineCode">PATCH</code> requests if the client does not need to confirm that the request was processed correctly.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">405 Method Not Allowed</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returned when the request used a method that is not supported. For example, a web service designed to be read-only may explicitly disallow <code class="inlineCode">PUT</code>, <code class="inlineCode">DELETE</code>, and so on.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">415 Unsupported Media Type</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returned when the resource in the request body uses a media type that the web service cannot handle. For example, if the body contains a resource in <a id="_idIndexMarker2143"/>XML format but<a id="_idIndexMarker2144"/> the web service can only process JSON.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 15.2: Common HTTP status code responses to other methods like POST and PUT</p>
    <h2 id="_idParaDest-814" class="heading-2">ASP.NET Core Minimal APIs projects</h2>
    <p class="normal">We will build a <a id="_idIndexMarker2145"/>web <a id="_idIndexMarker2146"/>service that provides a way to work with data in the Northwind database using ASP.NET Core so that the data can be used by any client application on any platform that can make HTTP requests and receive HTTP responses.</p>
    <p class="normal">Traditionally, you use the <strong class="screenText">ASP.NET Core Web API</strong> / <code class="inlineCode">dotnet new webapi</code> project template. This allows the creation of a web service implemented using either controllers or the newer Minimal APIs.</p>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> With .NET 6 and .NET 7, the <code class="inlineCode">dotnet new webapi</code> command creates a service implemented using controllers. With .NET 6 and .NET 7, to implement the service using Minimal APIs, you need to add the <code class="inlineCode">--use-minimal-apis</code> switch to the command. Using .NET 8 or later, the <code class="inlineCode">dotnet new webapi</code> command creates a service implemented using Minimal APIs. To implement the service using controllers, you need to add the <code class="inlineCode">--use-controllers</code> switch.</p>
    </div>
    <h3 id="_idParaDest-815" class="heading-3">Minimal APIs web service and native AOT compilation</h3>
    <p class="normal">.NET 8 introduced <a id="_idIndexMarker2147"/>the <strong class="screenText">ASP.NET Core Web API (native AOT)</strong> / <code class="inlineCode">dotnet new webapiaot</code> project template, which <a id="_idIndexMarker2148"/>only uses Minimal APIs and supports native AOT publishing. More components of .NET will support AOT over time, as you can read in the following quote:</p>
    <blockquote class="packt_quote">
      <p class="quote">“We expect to make progress investigating Native AOT support for MVC &amp; Blazor in the .NET 9 timeframe, but we don’t expect to deliver production ready Native AOT support for .NET 9 given the large amount of work involved.” – Dan Roth</p>
    </blockquote>
    <p class="normal"><a href="https://github.com/dotnet/aspnetcore/issues/51834#issuecomment-1913300365">https://github.com/dotnet/aspnetcore/issues/51834#issuecomment-1913300365</a></p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Minimal APIs work especially well with <strong class="keyWord">Vertical Slice Architecture (VSA)</strong>. A <a id="_idIndexMarker2149"/>major benefit of Minimal APIs over a controller-based Web API is that each Minimal API endpoint only needs to instantiate the <strong class="keyWord">dependency injection</strong> (<strong class="keyWord">DI</strong>) services that it needs. With controllers, to execute any action method within that controller, all DI services used in any of the action methods must be instantiated for <a id="_idIndexMarker2150"/>every <a id="_idIndexMarker2151"/>call. This is a waste of time and resources!</p>
    </div>
    <h3 id="_idParaDest-816" class="heading-3">Creating an ASP.NET Core Minimal API project</h3>
    <p class="normal">Let’s go:</p>
    <ol>
      <li class="numberedList" value="1">Use<a id="_idIndexMarker2152"/> your preferred code editor to open the <code class="inlineCode">ModernWeb</code> solution and then add a new project, as defined in the following list:<ul>
          <li class="bulletList level-2">Project template: <strong class="screenText">ASP.NET Core Web API</strong> / <code class="inlineCode">webapi</code></li>
          <li class="bulletList level-2">Solution file and folder: <code class="inlineCode">ModernWeb</code></li>
          <li class="bulletList level-2">Project file and folder: <code class="inlineCode">Northwind.WebApi</code></li>
        </ul>
      </li>
      <li class="numberedList">If you are using Visual Studio, then confirm the following defaults have been chosen:<ul>
          <li class="bulletList level-2"><strong class="screenText">Authentication type</strong>: None</li>
          <li class="bulletList level-2"><strong class="screenText">Configure for HTTPS</strong>: Selected</li>
          <li class="bulletList level-2"><strong class="screenText">Enable container support</strong>: Cleared</li>
          <li class="bulletList level-2"><strong class="screenText">Enable OpenAPI support</strong>: Selected</li>
          <li class="bulletList level-2"><strong class="screenText">Do not use top-level statements</strong>: Cleared</li>
          <li class="bulletList level-2"><strong class="screenText">Use controllers</strong>: Cleared</li>
        </ul>
      </li>
    </ol>
    <div><p class="normal">Make sure to clear the <strong class="screenText">Use controllers</strong> check box, or your code will look very different to what you will see in this book!</p>
    </div>
    <ol>
      <li class="numberedList" value="3">If you are using VS Code or Rider, then in the <code class="inlineCode">ModernWeb</code> directory, at the command prompt or terminal, enter the following:
        <pre class="programlisting con-one"><code class="hljs-con">dotnet new webapi -o Northwind.WebApi
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.WebApi</code> project.</li>
      <li class="numberedList">In the project file, remove the version number for the package that implements OpenAPI web service documentation because we are using CPM, as shown in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">&lt;PackageReference Include="Microsoft.AspNetCore.OpenApi" /&gt;
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, review<a id="_idIndexMarker2153"/> the code, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">var builder = WebApplication.CreateBuilder(args);
// Add services to the container.
// Learn more about configuring OpenAPI at https://aka.ms/aspnet/openapi
builder.Services.AddOpenApi();
var app = builder.Build();
// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
  app.MapOpenApi();
}
app.UseHttpsRedirection();
var summaries = new[]
{
    "Freezing", "Bracing", "Chilly", "Cool", "Mild", "Warm", "Balmy", "Hot", "Sweltering", "Scorching"
};
app.MapGet("/weatherforecast", () =&gt;
{
  var forecast = Enumerable.Range(1, 5).Select(index =&gt;
    new WeatherForecast
    (
      DateOnly.FromDateTime(DateTime.Now.AddDays(index)),
      Random.Shared.Next(-20, 55),
      summaries[Random.Shared.Next(summaries.Length)]
    ))
    .ToArray();
  return forecast;
})
.WithName("GetWeatherForecast");
app.Run();
internal record WeatherForecast(DateOnly Date,
  int TemperatureC, string? Summary)
{
  public int TemperatureF =&gt; 32 +
    (int)(TemperatureC / 0.5556);
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">While reviewing <a id="_idIndexMarker2154"/>the preceding code, note the following:</p>
    <ul>
      <li class="bulletList level-2">The program starts with a similar configuration to any other ASP.NET Core project, with a call to <code class="inlineCode">WebApplication.CreateBuilder</code>.</li>
      <li class="bulletList level-2">The services collection has an OpenAPI service added. This is used to document a web service. In .NET 8 and earlier, the third-party Swashbuckle package was used to do this, but with .NET 9 and later, Microsoft has written their own implementation. You can read more about this at the following link: <a href="https://github.com/dotnet/aspnetcore/issues/54599">https://github.com/dotnet/aspnetcore/issues/54599</a>. By default, OpenAPI document generation creates a document that is compliant with v3.0 of the OpenAPI specification: <a href="https://spec.openapis.org/oas/v3.0.0">https://spec.openapis.org/oas/v3.0.0</a>.</li>
      <li class="bulletList level-2">During development, the OpenAPI documentation is mapped as endpoints so that other developers can use it to create clients easily. By default, the OpenAPI endpoint registered via a call to MapOpenApi exposes the document at the <a href="https://openapi/%7BdocumentName%7D.json">/openapi/{documentName}.json</a> endpoint. By default, the <code class="inlineCode">documentName</code> is <code class="inlineCode">v1</code>. In the production environment, these endpoints are not mapped because they are no longer necessary.</li>
      <li class="bulletList level-2">The <code class="inlineCode">MapGet</code> call registers a relative path of <code class="inlineCode">/weatherforecast</code> to respond to HTTP <code class="inlineCode">GET</code> requests, and its implementation uses the shared <code class="inlineCode">Random</code> object to return an array of <code class="inlineCode">WeatherForecast</code> objects with random temperatures and summaries like <code class="inlineCode">Bracing</code> or <code class="inlineCode">Balmy</code> for the next five days of weather.</li>
    </ul>
    <p class="normal">Now let’s allow <a id="_idIndexMarker2155"/>the HTTP request to specify how many days ahead the forecast should be. At the same time, we will implement good practices by putting the weather endpoint implementation in its own code file:</p>
    <ol>
      <li class="numberedList" value="1">Add a new class file named <code class="inlineCode">Program.Weather.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.Weather.cs</code>, add statements to extend the automatically generated <code class="inlineCode">partial</code> <code class="inlineCode">Program</code> class by moving (cut and paste the statements) the weather-related statements from <code class="inlineCode">Program.cs</code> and making small adjustments like defining a <code class="inlineCode">GetWeather</code> method with a <code class="inlineCode">days</code> parameter to control how many weather forecasts to generate, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">public partial class Program
{
  static string[] summaries = { "Freezing", "Bracing",
    "Chilly", "Cool", "Mild", "Warm", "Balmy", "Hot",
    "Sweltering", "Scorching" };
  internal static WeatherForecast[]? GetWeather(int days)
  {
    WeatherForecast[]? forecast = Enumerable.Range(1, days)
      .Select(index =&gt; new WeatherForecast
      (
        DateOnly.FromDateTime(DateTime.Now.AddDays(index)),
        Random.Shared.Next(-20, 55),
        summaries[Random.Shared.Next(summaries.Length)]
      ))
      .ToArray();
    return forecast;
  }
  internal record WeatherForecast(DateOnly Date,
    int TemperatureC, string? Summary)
  {
    public int TemperatureF =&gt; 32 +
      (int)(TemperatureC / 0.5556);
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, modify<a id="_idIndexMarker2156"/> the <code class="inlineCode">MapGet</code> call, as shown highlighted in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">app.UseHttpsRedirection();
<strong class="hljs-keyword-slc">app</strong><strong class="hljs-slc">.MapGet(</strong><strong class="hljs-string-slc">"/weatherforecast/{days:int?}"</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">  (int days = 5) =&gt; GetWeather(days))</strong>
<strong class="hljs-slc">  .WithName(</strong><strong class="hljs-string-slc">"GetWeatherForecast"</strong><strong class="hljs-slc">);</strong>
app.Run();
</code></pre>
      </li>
    </ol>
    <div><p class="normal">In the <code class="inlineCode">MapGet</code> call, note the route template pattern <code class="inlineCode">{days:int?}</code> constrains the <code class="inlineCode">days</code> parameter to <code class="inlineCode">int</code> values. The <code class="inlineCode">?</code> makes the <code class="inlineCode">days</code> parameter optional, and if missing it <a id="_idIndexMarker2157"/>will default to <code class="inlineCode">5</code>.</p>
    </div>
    <h2 id="_idParaDest-817" class="heading-2">Reviewing the web service’s functionality</h2>
    <p class="normal">Now, we<a id="_idIndexMarker2158"/> will test the web service’s functionality:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">Properties</code> folder, in <code class="inlineCode">launchSettings.json</code>, note that by default, if you are using Visual Studio, the <code class="inlineCode">https</code> profile will launch the browser and navigate to the <code class="inlineCode">/weatherforecast</code> relative URL path, as shown highlighted in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">"https": {
  "commandName": "Project",
  "dotnetRunMessages": true,
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"launchBrowser"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">true</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"launchUrl"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"weatherforecast"</strong>,
</code></pre>
      </li>
      <li class="numberedList">For the <code class="inlineCode">https</code> profile, for its <code class="inlineCode">applicationUrl</code>, change the random port number for HTTPS to <code class="inlineCode">5151</code> and for HTTP to <code class="inlineCode">5150</code>, as shown highlighted in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">"applicationUrl": "https://localhost:<strong class="hljs-string-slc">5151</strong>;http://localhost:<strong class="hljs-string-slc">5150</strong>",
</code></pre>
      </li>
      <li class="numberedList">Save changes to all modified files.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi</code> web service project using the <code class="inlineCode">https</code> launch profile.</li>
      <li class="numberedList">On Windows, if you see a <strong class="screenText">Windows Security Alert</strong> dialog box saying <strong class="screenText">Windows Defender Firewall has blocked some features of this app</strong>, then click <a id="_idIndexMarker2159"/>the <strong class="screenText">Allow access</strong> button.</li>
      <li class="numberedList">Start Chrome, navigate to <code class="inlineCode">https://localhost:5151/</code>, and note you will get a <code class="inlineCode">404</code> status code response because we have not enabled static files and there is not an <code class="inlineCode">index.html</code>. Remember that this project is not designed for a human to view and interact with, so this is expected behavior for a web service.</li>
      <li class="numberedList">In Chrome, show <strong class="screenText">Developer Tools</strong>.</li>
      <li class="numberedList">Navigate to <code class="inlineCode">https://localhost:5151/weatherforecast</code> and note the web service should return a JSON document with five random weather forecast objects in an array, as shown in <em class="italic">Figure 15.1</em>:</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_15_01.png" alt="" width="812" height="414"/></figure>
    <p class="packt_figref">Figure 15.1: A request and response from a weather forecast web service</p>
    <ol>
      <li class="numberedList" value="9">Close <strong class="screenText">Developer Tools</strong>.</li>
      <li class="numberedList">Navigate to <code class="inlineCode">https://localhost:5151/weatherforecast/14</code> and note that the response when requesting a two-week weather forecast contains 14 forecasts.</li>
      <li class="numberedList">Select the <strong class="screenText">Pretty print</strong> checkbox, as shown in <em class="italic">Figure 15.1</em>, and note that recent versions of Chrome can now format JSON responses better for humans to read.</li>
      <li class="numberedList">Close Chrome <a id="_idIndexMarker2160"/>and shut down the web server.</li>
    </ol>
    <h2 id="_idParaDest-818" class="heading-2">Route constraints</h2>
    <p class="normal">To register<a id="_idIndexMarker2161"/> the <code class="inlineCode">/weatherforecast</code> route <a id="_idIndexMarker2162"/>endpoint, we used a route constraint to limit acceptable values for the <code class="inlineCode">days</code> parameter to integers, as shown highlighted in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">app.MapGet("/weatherforecast/{days:int?}", ...
</code></pre>
    <p class="normal">Route constraints allow us to control matches based on data types and other validation. They are summarized in <em class="italic">Table 15.3</em>:</p>
    <table id="table003-9" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Constraint</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Example</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">required</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">{id:required}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The parameter has been provided.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">int</code> and <code class="inlineCode">long</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">{id:int}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Any integer of the correct size.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">decimal</code>, <code class="inlineCode">double</code>, and <code class="inlineCode">float</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">{unitprice:decimal}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Any real number of the correct size.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">bool</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">{discontinued:bool}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Case-insensitive match on <code class="inlineCode">true</code> or <code class="inlineCode">false</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">datetime</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">{hired:datetime}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">An invariant culture date/time.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">guid</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">{id:guid}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">A GUID value.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">minlength(n)</code>, <code class="inlineCode">maxlength(n)</code>, <code class="inlineCode">length(n)</code>, and <code class="inlineCode">length(n, m)</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">{title:minlength(5)}</code>, <code class="inlineCode">{title:length(5, 25)}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The text must have the defined minimum and/or maximum length.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">min(n)</code>, <code class="inlineCode">max(n)</code>, and <code class="inlineCode">range(n, m)</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">{age:range(18, 65)}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The integer must be within the defined minimum and/or maximum range.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">alpha</code>, <code class="inlineCode">regex</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">{firstname:alpha}</code>, <code class="inlineCode">{id:regex(^[A-Z]{{5}}$)}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The parameter must match one or more alphabetic characters or the regular expression. </p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 15.3: Route constraints with examples and descriptions</p>
    <p class="normal">Use colons to separate <a id="_idIndexMarker2163"/>multiple <a id="_idIndexMarker2164"/>constraints, as shown in the following example:</p>
    <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">app</strong><strong class="hljs-selector-class-slc">.MapGet</strong><strong class="hljs-slc">("/weatherforecast/{days:int:</strong><strong class="hljs-built_in-slc">min</strong><strong class="hljs-slc">(</strong><strong class="hljs-number-slc">5</strong><strong class="hljs-slc">)}", ...</strong>
</code></pre>
    <p class="normal">For regular expressions, <code class="inlineCode">RegexOptions.IgnoreCase | RegexOptions.Compiled | RegexOptions.CultureInvariant</code> is added automatically. Regular expression tokens must be escaped (replace <code class="inlineCode">\</code> with <code class="inlineCode">\\</code>, <code class="inlineCode">{</code> with <code class="inlineCode">{{</code>, and <code class="inlineCode">}</code> with <code class="inlineCode">}}</code>) or use verbatim string<a id="_idIndexMarker2165"/> literals.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can create custom route constraints by defining a class that implements <code class="inlineCode">IRouteConstraint</code>. This is beyond the scope of this book, but you can read about it at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/routing#custom-route-constraints">https://learn.microsoft.com/en-us/aspnet/core/fundamentals/routing#custom-route-constraints</a>.</p>
    </div>
    <h2 id="_idParaDest-819" class="heading-2">Short-circuit routes</h2>
    <p class="normal">When routing <a id="_idIndexMarker2166"/>matches a <a id="_idIndexMarker2167"/>request to an endpoint, it lets the rest of the middleware pipeline run before invoking the endpoint logic. That takes time, so in ASP.NET Core 8 and later, you can invoke the endpoint immediately and return the response.</p>
    <p class="normal">You do this by calling the <code class="inlineCode">ShortCircuit</code> method on a mapped endpoint route, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">app.MapGet("/", () =&gt; "Hello World").ShortCircuit();
</code></pre>
    <p class="normal">Alternatively, you can call the <code class="inlineCode">MapShortCircuit</code> method to respond with a <code class="inlineCode">404 Missing Resource</code> or other status code for resources that don’t need further processing, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">app.MapShortCircuit(404, "robots.txt", "favicon.ico");
</code></pre>
    <h2 id="_idParaDest-820" class="heading-2">Improved route tooling in ASP.NET Core 8 and later</h2>
    <p class="normal">Microsoft has <a id="_idIndexMarker2168"/>improved <a id="_idIndexMarker2169"/>the tooling for working with routes for all ASP.NET Core 8 and later technologies including Web APIs and Blazor. The features include the following:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Route syntax highlighting</strong>: Different parts of routes are now highlighted in your code editor.</li>
      <li class="bulletList"><strong class="keyWord">Autocompletion</strong>: Parameter and route names and route constraints are autocompleted.</li>
      <li class="bulletList"><strong class="keyWord">Route analyzers and fixers</strong>: These address common problems that developers have when implementing their routes.</li>
    </ul>
    <p class="normal">You can read <a id="_idIndexMarker2170"/>about them in the blog article <em class="italic">ASP.NET Core Route Tooling Enhancements in .NET 8</em>, found at the following link: <a href="https://devblogs.microsoft.com/dotnet/aspnet-core-route-tooling-dotnet-8/">https://devblogs.microsoft.com/dotnet/aspnet-core-route-tooling-dotnet-8/</a>.</p>
    <h2 id="_idParaDest-821" class="heading-2">Understanding endpoint route handler return types</h2>
    <p class="normal">An endpoint <a id="_idIndexMarker2171"/>lambda <a id="_idIndexMarker2172"/>expression can return .NET types like a single <code class="inlineCode">string</code> value; complex objects defined by a <code class="inlineCode">class</code>, <code class="inlineCode">record</code>, or <code class="inlineCode">struct</code>; or collections of complex objects. ASP.NET Core Minimal APIs will serialize them into JSON or plain text.</p>
    <p class="normal">Consider the following endpoint route handler, which returns a <code class="inlineCode">string</code> value, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">app.MapGet("/hello", () =&gt; "Hello World");
</code></pre>
    <p class="normal">ASP.NET Core Minimal APIs will return a <code class="inlineCode">200</code> status code with a <code class="inlineCode">Content-Type: text/plain; charset=utf-8</code> header and the following content in the body: <code class="inlineCode">Hello World</code>.</p>
    <p class="normal">Now consider the following endpoint route handler, which returns an anonymous type, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">app.MapGet("/user", () =&gt; new {
  FirstName = "Bob",
  Age = 45 });
</code></pre>
    <p class="normal">ASP.NET Core Minimal APIs will return a <code class="inlineCode">200</code> status code with a <code class="inlineCode">Content-Type: application/json; charset=utf-8</code> header and the following content in the body:</p>
    <pre class="programlisting code"><code class="hljs-code">{"firstName":"Bob","age":45}
</code></pre>
    <p class="normal">For more control over the response, there are helper methods that return an <code class="inlineCode">IResult</code>, which defines a contract that represents the result of an HTTP endpoint. The static <code class="inlineCode">Results</code> and <code class="inlineCode">TypedResults</code> classes can be used to create various <code class="inlineCode">IResult</code> objects that represent different types of responses.</p>
    <p class="normal">Returning <code class="inlineCode">TypedResults</code> rather than <code class="inlineCode">Results</code> has the following advantages:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">TypedResults</code> helpers return strongly typed objects, which can improve code readability and unit testing and reduce the chance of runtime errors.</li>
      <li class="bulletList">The implementation type automatically provides the response type metadata for OpenAPI to describe the endpoint.</li>
    </ul>
    <p class="normal">The <code class="inlineCode">TypedResults</code> class has a property named <code class="inlineCode">Empty</code> that produces an empty result response, which when executed will do nothing.</p>
    <p class="normal">The <code class="inlineCode">TypedResults</code> class has <a id="_idIndexMarker2173"/>methods to<a id="_idIndexMarker2174"/> make it easy to return different responses, as shown in <em class="italic">Table 15.4</em>:</p>
    <table id="table004-8" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Method</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Bytes</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returns a <code class="inlineCode">200</code> status code and writes byte-array content to the response.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Content</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returns a <code class="inlineCode">200</code> status code and writes the content string to the HTTP response. Has an optional parameter to specify the media type header.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">File</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returns a <code class="inlineCode">200</code> status code and writes the specified <code class="inlineCode">Stream</code> to the response.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Json</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returns a <code class="inlineCode">200</code> status code and serializes the specified data object in JSON format to the response.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Ok</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returns a <code class="inlineCode">200</code> status code and a resource converted into the client’s preferred format, like JSON or XML. Commonly used in response to a <code class="inlineCode">GET</code> request.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Created</code>, <code class="inlineCode">CreatedAtRoute</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returns a <code class="inlineCode">201</code> status code and the path to the new resource. Commonly used in response to a <code class="inlineCode">POST</code> request to create a resource that can be created quickly.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Accepted</code>, <code class="inlineCode">AcceptedAtRoute</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returns a <code class="inlineCode">202</code> status code to indicate the request is being processed but has not been completed. Commonly used in response to a <code class="inlineCode">POST</code>, <code class="inlineCode">PUT</code>, <code class="inlineCode">PATCH</code>, or <code class="inlineCode">DELETE</code> request that triggers a background process that takes a long time to complete.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Redirect</code>, <code class="inlineCode">RedirectToRoute</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returns a <code class="inlineCode">301</code>, <code class="inlineCode">307</code>, or <code class="inlineCode">308</code> status code depending on a temporary or permanent redirect <code class="inlineCode">bool</code> parameter, with the <code class="inlineCode">url</code> to redirect to. </p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Problem</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Produces a <code class="inlineCode">ProblemDetails</code> response.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">NoContent</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returns a <code class="inlineCode">204</code> status code and an empty response body. Commonly used in response to a <code class="inlineCode">PUT</code>, <code class="inlineCode">PATCH</code>, or <code class="inlineCode">DELETE</code> request when the response does not need to contain the affected resource.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">BadRequest</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returns a <code class="inlineCode">400</code> status code and an optional message string with more details.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">NotFound</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Returns a <code class="inlineCode">404</code> status code and automatically populates the <code class="inlineCode">ProblemDetails</code> body (requires a compatibility version of 2.2 or later).</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 15.4: TypedResults helper methods that return a response</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You <a id="_idIndexMarker2175"/>can learn <a id="_idIndexMarker2176"/>more about how to create responses in a Minimal APIs web service at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/responses?view=aspnetcore-9.0">https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/responses?view=aspnetcore-9.0</a>.</p>
    </div>
    <h1 id="_idParaDest-822" class="heading-1">Creating a web service for the Northwind database</h1>
    <p class="normal">We will reference<a id="_idIndexMarker2177"/> the Entity Framework Core entity data model for the Northwind database that you created in <em class="chapterRef">Chapter 12</em>,<em class="italic"> Introducing Modern Web Development Using .NET</em>:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi</code> project, globally and statically import the <code class="inlineCode">System.Console</code> class, and add a project reference to the Northwind data context class library for either SQLite or SQL Server, as shown in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">&lt;ItemGroup Label="To simplify use of WriteLine."&gt;
  &lt;Using Include="System.Console" Static="true" /&gt;
&lt;/ItemGroup&gt;
&lt;ItemGroup&gt;
  &lt;!-- change Sqlite to SqlServer if you prefer --&gt;
  &lt;ProjectReference Include=
"..\Northwind.DataContext.Sqlite\Northwind.DataContext.Sqlite.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.WebApi</code> project and fix any compile errors in your code.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, import namespaces for working with the Northwind entity model, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">using Northwind.EntityModels; // To use AddNorthwindContext method.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, add a statement before the call to <code class="inlineCode">Build</code> to register the <code class="inlineCode">Northwind</code> database context class (it will use either SQLite or SQL Server depending on which database provider you referenced in the project file), as<a id="_idIndexMarker2178"/> shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">builder.Services.AddNorthwindContext();
</code></pre>
      </li>
    </ol>
    <h2 id="_idParaDest-823" class="heading-2">Registering dependency services</h2>
    <p class="normal">You can register <a id="_idIndexMarker2179"/>dependency<a id="_idIndexMarker2180"/> services with different lifetimes, as shown in the following list:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Transient</strong>: These services are created each time they’re requested. Transient services should be lightweight and stateless.</li>
      <li class="bulletList"><strong class="keyWord">Scoped</strong>: These services are created once per client request and are disposed of. Then, the response is returned to the client.</li>
      <li class="bulletList"><strong class="keyWord">Singleton</strong>: These services are usually created the first time they are requested and then are shared, although you can provide an instance at the time of registration too.</li>
    </ul>
    <p class="normal">Introduced in .NET 8 is the ability to set a key for a dependency service. This allows multiple services to be registered with different keys and then retrieved later using that key.</p>
    <pre class="programlisting code"><code class="hljs-code">builder.Services.AddKeyedsingleton&lt;IMemoryCache, BigCache&gt;("big");
builder.Services.AddKeyedSingleton&lt;IMemoryCache, SmallCache&gt;("small");
class BigCacheConsumer([FromKeyedServices("big")] IMemoryCache cache)
{
  public object? GetData() =&gt; cache.Get("data");
}
class SmallCacheConsumer(IKeyedServiceProvider keyedServiceProvider)
{
  public object? GetData() =&gt; keyedServiceProvider
    .GetRequiredKeyedService&lt;IMemoryCache&gt;("small");
}
</code></pre>
    <p class="normal">In this book, you <a id="_idIndexMarker2181"/>will <a id="_idIndexMarker2182"/>use all three types of lifetimes, but we will not need to use keyed services.</p>
    <h2 id="_idParaDest-824" class="heading-2">In-memory, distributed, and hybrid caches</h2>
    <p class="normal">Now let’s see an overview of in-memory, distributed, and hybrid caching.</p>
    <h3 id="_idParaDest-825" class="heading-3">In-memory caching</h3>
    <p class="normal">In-memory <a id="_idIndexMarker2183"/>caching stores<a id="_idIndexMarker2184"/> data in the memory of the web server where the application is running. This is useful for small to medium-sized applications where the caching needs are not too extensive and can be handled by a single server’s memory.</p>
    <p class="normal">The key points about in-memory caching are shown in the following list:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Performance</strong>: Fast retrieval since the data is stored locally in RAM.</li>
      <li class="bulletList"><strong class="keyWord">Simplicity</strong>: Easy to implement and configure within the application.</li>
      <li class="bulletList"><strong class="keyWord">Volatility</strong>: Data is lost if the application restarts or the server goes down.</li>
      <li class="bulletList"><strong class="keyWord">Scalability</strong>: Limited to a single server’s memory; not suitable for large-scale applications needing distributed caching.</li>
    </ul>
    <p class="normal">To implement in-memory caching, add the memory cache service to the services collection in <code class="inlineCode">Program.cs</code>, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">services.AddMemoryCache();
</code></pre>
    <p class="normal">Retrieve the service in an endpoint, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">private readonly IMemoryCache _cache;
</code></pre>
    <p class="normal">Set data in the cache, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">_cache.Set(key, data);
</code></pre>
    <p class="normal">Get data from the cache, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">return _cache.TryGetValue(key, out var data) ? data : null;
</code></pre>
    <p class="normal">Now let’s compare <a id="_idIndexMarker2185"/>in-memory <a id="_idIndexMarker2186"/>caching to distributed caching.</p>
    <h3 id="_idParaDest-826" class="heading-3">Distributed caching</h3>
    <p class="normal">Distributed <a id="_idIndexMarker2187"/>caching <a id="_idIndexMarker2188"/>allows caching data across multiple servers, making it suitable for large-scale, distributed applications. This ensures data availability and consistency across different nodes in a web farm.</p>
    <p class="normal">The key points about in-memory caching are shown in the following list:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Scalability</strong>: Can handle large datasets and provide caching across multiple servers.</li>
      <li class="bulletList"><strong class="keyWord">Persistence</strong>: Depending on the provider, data can be persisted beyond application restarts.</li>
      <li class="bulletList"><strong class="keyWord">Latency</strong>: May have higher latency compared to in-memory caching due to network calls.</li>
      <li class="bulletList"><strong class="keyWord">Providers</strong>: Common providers include Redis, SQL Server, and NCache.</li>
    </ul>
    <p class="normal">To implement in-memory caching, add it to the services collection in <code class="inlineCode">Program.cs</code>, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">services.AddStackExchangeRedisCache(options =&gt;
  options.Configuration = "localhost:6379";
  options.InstanceName = "SampleInstance";
});
</code></pre>
    <p class="normal">Retrieve the<a id="_idIndexMarker2189"/> service in an<a id="_idIndexMarker2190"/> endpoint, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">private readonly IDistributedCache _cache;
</code></pre>
    <p class="normal">Set data in the cache, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">await _cache.SetStringAsync(key, value);
</code></pre>
    <p class="normal">Get data from the cache, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">return await _cache.GetStringAsync(key);
</code></pre>
    <p class="normal">So, in-memory caching is fast and simple but limited to the server’s memory and loses data on restart. Distributed caching is scalable and persistent, ideal for large applications, with various providers like Redis and SQL Server.</p>
    <p class="normal">Both approaches help improve application performance by reducing the need to repeatedly fetch or compute data. The choice between them depends on the application’s<a id="_idIndexMarker2191"/> scale, performance needs, and architecture.</p>
    <p class="normal">But what if <a id="_idIndexMarker2192"/>we could get the best of both worlds?</p>
    <p class="normal">Let’s see a new option called hybrid caching.</p>
    <h3 id="_idParaDest-827" class="heading-3">Hybrid caching</h3>
    <p class="normal">The HybridCache API introduced <a id="_idIndexMarker2193"/>with<a id="_idIndexMarker2194"/> ASP.NET Core 9 addresses some limitations found in the <code class="inlineCode">IDistributedCache</code> and <code class="inlineCode">IMemoryCache</code> APIs. As an abstract class with a default implementation, <code class="inlineCode">HybridCache</code> efficiently manages most tasks related to storing and retrieving data from the cache.</p>
    <p class="normal">The key points about hybrid caching are shown in the following list:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Unified API</strong>: Provides a single interface for both in-process and out-of-process caching. <code class="inlineCode">HybridCache</code> can seamlessly replace any existing <code class="inlineCode">IDistributedCache</code> and <code class="inlineCode">IMemoryCache</code> usage. It always uses the in-memory cache initially, and when an <code class="inlineCode">IDistributedCache</code> implementation is available, <code class="inlineCode">HybridCache</code> leverages it for secondary caching. This dual-level caching approach combines the speed of in-memory caching with the durability of distributed or persistent caching.</li>
      <li class="bulletList"><strong class="keyWord">Stampede Protection</strong>: <code class="inlineCode">HybridCache</code> prevents cache stampedes, which occur when a frequently used cache entry is invalidated, causing multiple requests to try to repopulate it simultaneously. <code class="inlineCode">HybridCache</code> merges concurrent operations, ensuring all requests for the same response wait for the first request to be completed.</li>
      <li class="bulletList"><strong class="keyWord">Configurable Serialization</strong>: <code class="inlineCode">HybridCache</code> allows for configurable serialization during service registration, supporting both type-specific and generalized serializers via the <code class="inlineCode">WithSerializer</code> and <code class="inlineCode">WithSerializerFactory</code> methods, which are chained from the <code class="inlineCode">AddHybridCache</code> call. By default, it manages <code class="inlineCode">string</code> and <code class="inlineCode">byte[]</code> internally and utilizes <code class="inlineCode">System.Text.Json</code> for other types. It can be configured to use other serializers, such as Protobuf or XML.</li>
    </ul>
    <div><p class="normal">Although HybridCache was introduced with .NET 9, its package targets .NET Standard 2.0, so it can be used with older versions of .NET, even .NET Framework 4.6.2 or later.</p>
    </div>
    <p class="normal">Now that you’ve learned the concepts and basic implementation options for caching, let’s create <a id="_idIndexMarker2195"/>a data repository <a id="_idIndexMarker2196"/>for our web service that caches entities to improve performance and scalability.</p>
    <h2 id="_idParaDest-828" class="heading-2">Creating data repositories with caching for entities</h2>
    <p class="normal">Defining and<a id="_idIndexMarker2197"/> implementing a data repository to provide CRUD operations <a id="_idIndexMarker2198"/>is good practice. We will create a data repository for the <code class="inlineCode">Customers</code> table in Northwind. There are only 91 customers in this table, so we will cache a copy of the whole table in memory to improve scalability and performance when reading customer records.</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: In a real web service, you should use a distributed cache like Redis, an open-source data structure store that can be used as a high-performance, high-availability database, cache, or message broker. You can learn about this at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/distributed">https://learn.microsoft.com/en-us/aspnet/core/performance/caching/distributed</a>.</p>
    </div>
    <p class="normal">In .NET 9, <code class="inlineCode">HybridCache</code> was introduced, which automatically switches between in-memory and distributed cache types.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn more about <code class="inlineCode">HybridCache</code> at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/hybrid?view=aspnetcore-9.0">https://learn.microsoft.com/en-us/aspnet/core/performance/caching/hybrid?view=aspnetcore-9.0</a>.</p>
    </div>
    <p class="normal">We will follow a modern good practice and make the repository API asynchronous. It will be instantiated by an endpoint using parameter injection, so a new instance is created to handle every HTTP request. It will use a singleton instance of <code class="inlineCode">HybridCache</code>. Let’s go:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.csproj</code> project file, add a package reference for hybrid caching, as shown in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">&lt;PackageReference Include=
  "Microsoft.Extensions.Caching.Hybrid" /&gt;
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, import the namespace for working with a hybrid cache, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">using Microsoft.Extensions.Caching.Hybrid; // To use HybridCacheEntryOptions.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, before the call to <code class="inlineCode">Build</code>, in the section for configuring services, register the hybrid cache service with a default cache entry duration of 60 seconds <a id="_idIndexMarker2199"/>overall, and 30 seconds<a id="_idIndexMarker2200"/> for local in-memory caching, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">builder.Services.AddHybridCache(options =&gt;
{
  options.DefaultEntryOptions = new HybridCacheEntryOptions
  {
    Expiration = TimeSpan.FromSeconds(60),
    LocalCacheExpiration = TimeSpan.FromSeconds(30)
  };
});
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi</code> project, create a folder named <code class="inlineCode">Repositories</code>.</li>
      <li class="numberedList">Add a new interface file and a class file to the <code class="inlineCode">Repositories</code> folder, named <code class="inlineCode">ICustomerRepository.cs</code> and <code class="inlineCode">CustomerRepository.cs</code>, respectively.</li>
      <li class="numberedList">In <code class="inlineCode">ICustomerRepository.cs</code>, define an interface with five CRUD methods, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">using Northwind.EntityModels; // To use Customer.
namespace Northwind.WebApi.Repositories;
public interface ICustomerRepository
{
  Task&lt;Customer?&gt; CreateAsync(Customer c);
  Task&lt;Customer[]&gt; RetrieveAllAsync();
  Task&lt;Customer?&gt; RetrieveAsync(string id,
    CancellationToken token);
  Task&lt;Customer?&gt; UpdateAsync(Customer c);
  Task&lt;bool?&gt; DeleteAsync(string id);
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">CustomerRepository.cs</code>, define a class that will implement the interface and uses the hybrid cache (its methods will be implemented over the next<a id="_idIndexMarker2201"/> few steps, so, for now, ignore the <a id="_idIndexMarker2202"/>errors you will be shown), as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">using Microsoft.EntityFrameworkCore.ChangeTracking; // To use EntityEntry&lt;T&gt;.
using Northwind.EntityModels; // To use Customer.
using Microsoft.EntityFrameworkCore; // To use ToArrayAsync.
using Microsoft.Extensions.Caching.Hybrid; // To use HybridCache.
namespace Northwind.WebApi.Repositories;
public class CustomerRepository : ICustomerRepository
{
  private readonly HybridCache _cache;
  // Use an instance data context field because it should not be
  // cached due to the data context having internal caching.
  private NorthwindContext _db;
  public CustomerRepository(NorthwindContext db,
    HybridCache hybridCache)
  {
    _db = db;
    _cache = hybridCache;
  }
}
</code></pre>
      </li>
      <li class="numberedList">Implement the method that retrieves all customers to always read the latest customers from the database, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">public Task&lt;Customer[]&gt; RetrieveAllAsync()
{
  return _db.Customers.ToArrayAsync();
}
</code></pre>
      </li>
      <li class="numberedList">Implement the <code class="inlineCode">Retrieve</code> method to get the customer from the cache if possible, or<a id="_idIndexMarker2203"/> from the data model, and set it in <a id="_idIndexMarker2204"/>the cache for next time, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">public async Task&lt;Customer?&gt; RetrieveAsync(string id,
  CancellationToken token = default)
{
  id = id.ToUpper(); // Normalize to uppercase.
  return await _cache.GetOrCreateAsync(
    key: id, // Unique key to the cache entry.
    factory: async cancel =&gt; await _db.Customers
      .FirstOrDefaultAsync(c =&gt; c.CustomerId == id, token),
    cancellationToken: token);
}
</code></pre>
      </li>
      <li class="numberedList">Implement the <code class="inlineCode">Create</code> method, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">public async Task&lt;Customer?&gt; CreateAsync(Customer c)
{
  c.CustomerId = c.CustomerId.ToUpper(); // Normalize to uppercase.
  // Add to database using EF Core.
  EntityEntry&lt;Customer&gt; added =
    await _db.Customers.AddAsync(c);
  int affected = await _db.SaveChangesAsync();
  if (affected == 1)
  {
    // If saved to database then store in cache.
    await _cache.SetAsync(c.CustomerId, c);
    return c;
  }
  return null;
}
</code></pre>
      </li>
      <li class="numberedList">Implement the <code class="inlineCode">Update</code> method to update the database, and if successful, update <a id="_idIndexMarker2205"/>the cached customer as well, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">public async Task&lt;Customer?&gt; UpdateAsync(Customer c)
{
  c.CustomerId = c.CustomerId.ToUpper();
  _db.Customers.Update(c);
  int affected = await _db.SaveChangesAsync();
  if (affected == 1)
  {
    await _cache.SetAsync(c.CustomerId, c);
    return c;
  }
  return null;
}
</code></pre>
      </li>
      <li class="numberedList">Implement <a id="_idIndexMarker2206"/>the <code class="inlineCode">Delete</code> method to delete the customer from the database, and if successful, remove the cached customer<a id="_idIndexMarker2207"/> as well, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">public async Task&lt;bool?&gt; DeleteAsync(string id)
{
  id = id.ToUpper();
  Customer? c = await _db.Customers.FindAsync(id);
  if (c is null) return null;
  _db.Customers.Remove(c);
  int affected = await _db.SaveChangesAsync();
  if (affected == 1)
  {
    await _cache.RemoveAsync(c.CustomerId);
    return true;
  }
  return null;
}
</code></pre>
      </li>
    </ol>
    <h2 id="_idParaDest-829" class="heading-2">Configuring the customer repository</h2>
    <p class="normal">Now that you’ve <a id="_idIndexMarker2208"/>learned the<a id="_idIndexMarker2209"/> theory, you will put it into practice to configure the repository so that it can be called from within a Minimal API endpoint.</p>
    <p class="normal">You will register a scoped dependency service implementation for the repository when the web service starts up, and then use constructor parameter injection to get it inside the definition of a new Minimal API endpoint for working with customers.</p>
    <p class="normal">It will have five action methods to perform CRUD operations on customers—two <code class="inlineCode">GET</code> methods (for all customers or one customer), <code class="inlineCode">POST</code> (create), <code class="inlineCode">PUT</code> (update), and <code class="inlineCode">DELETE</code>:</p>
    <ol>
      <li class="numberedList" value="1">In <code class="inlineCode">Program.cs</code>, import the namespace for working with our customer repository, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">using Northwind.WebApi.Repositories; // To use ICustomerRepository.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, add a statement before the call to the <code class="inlineCode">Build</code> method, which will register the <code class="inlineCode">CustomerRepository</code> for use at runtime as a scoped dependency, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">builder.Services.AddScoped&lt;ICustomerRepository,
  CustomerRepository&gt;();
</code></pre>
      </li>
    </ol>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Our repository uses a database context that is registered as a scoped dependency. You can only use scoped dependencies inside other scoped dependencies, so we cannot register the repository as a singleton. You can read more about this at the following link: <a href="https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection#scoped">https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection#scoped</a>.</p>
    </div>
    <ol>
      <li class="numberedList" value="3">In the <code class="inlineCode">Northwind.WebApi</code> project, add a new class named <code class="inlineCode">Program.Customers.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.Customers.cs</code>, add statements to define two Minimal API endpoint<a id="_idIndexMarker2210"/> route<a id="_idIndexMarker2211"/> handlers that respond to HTTP <code class="inlineCode">GET</code> requests for all customers or customers within a specified country, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">using Microsoft.AspNetCore.Mvc; // To use ProblemDetails.
using Northwind.EntityModels; // To use Customer.
using Northwind.WebApi.Repositories; // To use ICustomerRepository.
static partial class Program
{
  internal static void MapCustomers(this WebApplication app)
  {
    // GET: /customers
    app.MapGet(pattern: "/customers", handler:
      async (ICustomerRepository repo) =&gt;
    {
      return await repo.RetrieveAllAsync();
    });
    // GET: customers/in/[country]
    app.MapGet(pattern: "/customers/in/{country}", handler:
      async (string country, ICustomerRepository repo) =&gt;
    {
      return (await repo.RetrieveAllAsync())
        .Where(customer =&gt; customer.Country == country);
    });
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.Customers.cs</code>, in the <code class="inlineCode">MapCustomers</code> method, add statements to map an endpoint route handler that responds to HTTP <code class="inlineCode">GET</code> requests for an individual<a id="_idIndexMarker2212"/> customer, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">// GET: customers/[id]
app.MapGet("/customers/{id:regex(^[A-Z]{{5}}$)}",
  async Task&lt;IResult&gt; (string id, ICustomerRepository repo,
    CancellationToken token = default) =&gt;
{
  Customer? c = await repo.RetrieveAsync(id, token);
  if (c is null)
  {
    return TypedResults.NotFound(); // 404 Resource not found.
  }
  return TypedResults.Ok(c); // 200 OK with customer in body.
});
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.Customers.cs</code>, add statements to map an endpoint route handler that <a id="_idIndexMarker2213"/>responds to<a id="_idIndexMarker2214"/> HTTP <code class="inlineCode">POST</code> requests to insert a new customer entity, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">// POST: /customers
// BODY: Customer (JSON)
app.MapPost(pattern: "/customers", handler:
  async Task&lt;IResult&gt; (Customer c,
    ICustomerRepository repo) =&gt;
{
  if (c is null)
  {
    return TypedResults.BadRequest(); // 400 Bad request.
  }
  Customer? addedCustomer = await repo.CreateAsync(c);
  if (addedCustomer is null)
  {
    return TypedResults.BadRequest("Repository failed to create customer.");
  }
  else
  {
    return TypedResults.CreatedAtRoute( // 201 Created.
      routeName: "GetCustomer",
      routeValues: new { id = addedCustomer
        .CustomerId.ToLower() },
      value: addedCustomer);
  }
});
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.Customers.cs</code>, add statements to map an endpoint route handler that <a id="_idIndexMarker2215"/>responds to HTTP <code class="inlineCode">PUT</code> requests, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">// PUT: /customers/[id]
// BODY: Customer (JSON)
app.MapPut(pattern: "/customers/{id}", handler:
  async Task&lt;IResult&gt; (Customer c,
    string id, ICustomerRepository repo,
    CancellationToken token = default) =&gt;
{
  id = id.ToUpper();
  c.CustomerId = c.CustomerId.ToUpper();
  if (c is null || c.CustomerId != id)
  {
    return TypedResults.BadRequest(); // 400 Bad request.
  }
  Customer? existing = await repo.RetrieveAsync(id, token);
  if (existing is null)
  {
    return TypedResults.NotFound(); // 404 Resource not found.
  }
  await repo.UpdateAsync(c);
  return new TypedResults.NoContent(); // 204 No content.
});
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.Customers.cs</code>, add statements to map an endpoint route handler that<a id="_idIndexMarker2216"/> responds to HTTP <code class="inlineCode">DELETE</code> requests, as shown in the following <a id="_idIndexMarker2217"/>code:
        <pre class="programlisting code-one"><code class="hljs-code">// DELETE: /customers/[id]
app.MapDelete(pattern: "/customers/{id}", handler:
  async Task&lt;IResult&gt; (string id, ICustomerRepository repo,
    CancellationToken token = default) =&gt;
{
  Customer? existing = await repo.RetrieveAsync(id, token);
  if (existing is null)
  {
    return TypedResults.NotFound(); // 404 Resource not found.
  }
  bool? deleted = await repo.DeleteAsync(id);
  if (deleted.HasValue &amp;&amp; deleted.Value) // Short circuit AND.
  {
    return TypedResults.NoContent(); // 204 No content.
  }
  else
  {
    return TypedResults.BadRequest( // 400 Bad request.
      $"Customer {id} was found but failed to delete.");
  }
});
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, before the call to <code class="inlineCode">Run</code>, call the extension method to map all the customer endpoint route handlers, as shown highlighted in the following code:
        <pre class="programlisting code-one"><code class="hljs-code"><strong class="hljs-keyword-slc">app</strong><strong class="hljs-slc">.MapCustomers();</strong>
app.Run();
</code></pre>
      </li>
      <li class="numberedList">Save all the changes.</li>
    </ol>
    <p class="normal">When an HTTP request is received by the service, it will create an instance of the <code class="inlineCode">Controller</code> class, call the appropriate action method, return the response in the format preferred<a id="_idIndexMarker2218"/> by the<a id="_idIndexMarker2219"/> client, and release the resources used by the controller, including the repository and its data context.</p>
    <h2 id="_idParaDest-830" class="heading-2">Specifying problem details</h2>
    <p class="normal">A feature added in <a id="_idIndexMarker2220"/>ASP.NET Core 2.1 and later is an implementation of a web standard for specifying problem details. If you want to take control, then you can create a <code class="inlineCode">ProblemDetails</code> instance yourself and include additional information.</p>
    <p class="normal">Let’s simulate a bad request that needs custom data to be returned to the client.</p>
    <p class="normal">At the top of the implementation of the <code class="inlineCode">Delete</code> endpoint route handler, add statements to check if the <code class="inlineCode">id</code> matches the literal string value <code class="inlineCode">"bad"</code>, and if so, return a custom <code class="inlineCode">ProblemDetails</code> object, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">// Take control of problem details.
if (id == "bad")
{
  ProblemDetails problemDetails = new()
  {
    Status = StatusCodes.Status400BadRequest,
    Type = "https://localhost:5151/customers/failed-to-delete",
    Title = $"Customer ID {id} found but failed to delete.",
    Detail = "More details like Company Name, Country and so on."
  };
  return TypedResults.BadRequest(problemDetails); // 400 Bad Request
}
</code></pre>
    <p class="normal">You will try out <a id="_idIndexMarker2221"/>this functionality later.</p>
    <h1 id="_idParaDest-831" class="heading-1">Documenting and trying out web services</h1>
    <p class="normal">You can easily try out<a id="_idIndexMarker2222"/> a web service by making HTTP <code class="inlineCode">GET</code> requests using a browser. To try out other HTTP methods, we need a more advanced tool.</p>
    <h2 id="_idParaDest-832" class="heading-2">Trying out GET requests using a browser</h2>
    <p class="normal">You will use <a id="_idIndexMarker2223"/>Chrome to try out the <a id="_idIndexMarker2224"/>three<a id="_idIndexMarker2225"/> implementations of a <code class="inlineCode">GET</code> request—for all customers, for customers in a specified country, and for a single customer using their unique customer ID:</p>
    <ol>
      <li class="numberedList" value="1">Start the <code class="inlineCode">Northwind.WebApi</code> web service project using the <code class="inlineCode">https</code> launch profile.</li>
      <li class="numberedList">Start Chrome, navigate to <code class="inlineCode">https://localhost:5151/customers</code>, and note the JSON document returned, containing all 91 customers in the Northwind database (unsorted), as shown in <em class="italic">Figure 15.2</em>:</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_15_02.png" alt="" width="812" height="154"/></figure>
    <p class="packt_figref">Figure 15.2: Customers from the Northwind database as a JSON document</p>
    <ol>
      <li class="numberedList" value="3">Navigate to <code class="inlineCode">https://localhost:5151/customers/in/Germany</code> and note the JSON document returned, containing only the customers in Germany.</li>
    </ol>
    <div><p class="normal">If you get an empty array <code class="inlineCode">[]</code> returned, then make sure you have entered the country name using the correct casing, because the database query is case-sensitive. For example, compare the results of <code class="inlineCode">uk</code> and <code class="inlineCode">UK</code>.</p>
    </div>
    <ol>
      <li class="numberedList" value="4">Navigate to <code class="inlineCode">https://localhost:5151/customers/alfki</code> and note the JSON document returned containing only the customer named <strong class="screenText">Alfreds Futterkiste</strong>.</li>
    </ol>
    <p class="normal">Unlike country<a id="_idIndexMarker2226"/> names, we do not<a id="_idIndexMarker2227"/> need<a id="_idIndexMarker2228"/> to worry about casing for the customer <code class="inlineCode">id</code> value because, in the customer repository implementation, we normalized the <code class="inlineCode">string</code> value as uppercase.</p>
    <p class="normal">But how can we try out the other HTTP methods, such as <code class="inlineCode">POST</code>, <code class="inlineCode">PUT</code>, and <code class="inlineCode">DELETE</code>? And how can we document our web service so it’s easy for anyone to understand how to interact with it?</p>
    <div><p class="normal">There are many tools for testing web services, for example, <strong class="keyWord">Postman</strong>. Although Postman is popular, I prefer tools like <strong class="keyWord">HTTP Editor</strong> in Visual Studio or <strong class="keyWord">REST Client</strong> in VS Code because they do not hide what is happening. I feel Postman is too GUI-y. But I encourage you to explore different tools and find the ones that fit your style. You can learn more about Postman at the following link: <a href="https://www.postman.com/">https://www.postman.com/</a>.</p>
    </div>
    <p class="normal">To solve the first problem, we can <a id="_idIndexMarker2229"/>use the <strong class="keyWord">HTTP Editor</strong> tool built into Visual Studio and install a VS Code extension<a id="_idIndexMarker2230"/> named <strong class="keyWord">REST Client</strong>. Rider has its own equivalent. These are tools that allow you to send any type of HTTP request and view the response in your code editor.</p>
    <p class="normal">To solve the second problem, we<a id="_idIndexMarker2231"/> can use <strong class="keyWord">OpenAPI</strong>, aka <strong class="keyWord">Swagger</strong>, the<a id="_idIndexMarker2232"/> world’s most popular<a id="_idIndexMarker2233"/> technology <a id="_idIndexMarker2234"/>for<a id="_idIndexMarker2235"/> documenting HTTP APIs. But first, let’s see what is possible with the code editor HTTP/REST tools.</p>
    <h2 id="_idParaDest-833" class="heading-2">Making GET requests using HTTP/REST tools</h2>
    <p class="normal">We will start by <a id="_idIndexMarker2236"/>creating<a id="_idIndexMarker2237"/> a file <a id="_idIndexMarker2238"/>for making <code class="inlineCode">GET</code> requests:</p>
    <ol>
      <li class="numberedList" value="1">If you have not already installed <strong class="screenText">REST Client</strong> by Huachao Mao (<code class="inlineCode">humao.rest-client</code>), then install it for VS Code now.</li>
      <li class="numberedList">In your preferred code editor, open the <code class="inlineCode">ModernWeb</code> solution and then start the <code class="inlineCode">Northwind.WebApi</code> project web service.</li>
      <li class="numberedList">In <strong class="screenText">File Explorer</strong>, <strong class="screenText">Finder</strong>, or your favorite Linux file tool, in the <code class="inlineCode">ModernWeb</code> folder, create an <code class="inlineCode">HttpRequests</code> folder.</li>
      <li class="numberedList">In the <code class="inlineCode">HttpRequests</code> folder, create a file named <code class="inlineCode">get-customers.http</code>, and open it in your preferred code editor.</li>
      <li class="numberedList">In <code class="inlineCode">get-customers.http</code>, modify its contents to contain an HTTP <code class="inlineCode">GET</code> request to retrieve all customers, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">### Configure a variable for the web service base address.
@base_address = https://localhost:5151/customers/
### Make a GET request to the base address.
GET {{base_address}}
</code></pre>
      </li>
      <li class="numberedList">Above the HTTP <code class="inlineCode">GET</code> request, click <strong class="screenText">Send request</strong>, as shown in <em class="italic">Figure 15.3</em>.</li>
    </ol>
    <p class="normal-one">Note the response is shown in a new tabbed window.</p>
    <ol>
      <li class="numberedList" value="7">If you are using Visual Studio, then click the <strong class="screenText">Raw</strong> tab, and note the JSON that<a id="_idIndexMarker2239"/> was <a id="_idIndexMarker2240"/>returned, as <a id="_idIndexMarker2241"/>shown in <em class="italic">Figure 15.3</em>:</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_15_03.png" alt="" width="812" height="379"/></figure>
    <p class="packt_figref">Figure 15.3: Sending an HTTP GET request using Visual Studio</p>
    <div><p class="normal">HTTP Editor in Visual Studio version 17.8 and later is a feature designed to add REST client-like capabilities, and its user interface is likely to evolve rapidly as it catches up. You can read its official documentation at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/test/http-files">https://learn.microsoft.com/en-us/aspnet/core/test/http-files</a>.</p>
    </div>
    <ol>
      <li class="numberedList" value="8">In <code class="inlineCode">get-customers.http</code>, add more <code class="inlineCode">GET</code> requests, each separated by three hash symbols, to test getting customers in various countries and getting a single customer using their ID, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">### Get customers in Germany
GET {{base_address}}in/Germany
### Get customers in USA
GET {{base_address}}in/USA
### Get Alfreds Futterkiste
GET {{base_address}}ALFKI
### Get a non-existent customer
GET {{base_address}}abcxy
</code></pre>
      </li>
      <li class="numberedList">Click the <strong class="screenText">Send Request</strong> link above each request to send it, and confirm<a id="_idIndexMarker2242"/> you get <a id="_idIndexMarker2243"/>the<a id="_idIndexMarker2244"/> expected response, like a 404 for a non-existent customer.</li>
    </ol>
    <h2 id="_idParaDest-834" class="heading-2">Making other requests using HTTP/REST tools</h2>
    <p class="normal">Next, we will create<a id="_idIndexMarker2245"/> a file<a id="_idIndexMarker2246"/> for making other requests like <code class="inlineCode">POST</code>:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">HttpRequests</code> folder, create a file named <code class="inlineCode">create-customer.http</code> and modify its contents to define a <code class="inlineCode">POST</code> request to create a new customer, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">### Configure a variable for the web service base address.
@base_address = https://localhost:5151/customers/
### Make a POST request to the base address.
POST {{base_address}}
Content-Type: application/json
{
  "customerID": "ABCXY",
  "companyName": "ABC Corp",
  "contactName": "John Smith",
  "contactTitle": "Sir",
  "address": "Main Street",
  "city": "New York",
  "region": "NY",
  "postalCode": "90210",
  "country":  "USA",
  "phone": "(123) 555-1234"
}
</code></pre>
      </li>
      <li class="numberedList">Send the request <a id="_idIndexMarker2247"/>and note the response is <code class="inlineCode">201 Created</code>. Also note in the <strong class="screenText">Headers</strong> section that the <strong class="screenText">Location</strong> (that is, the URL) of the newly created customer is <code class="inlineCode">/customers/ABCXY</code>, as shown in <em class="italic">Figure 15.4</em>, and the response included the newly created customer in the response body (not shown in the screenshot but you can see it in the <strong class="screenText">Formatted</strong> and <strong class="screenText">Raw</strong> sections):</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_15_04.png" alt="" width="812" height="498"/></figure>
    <p class="packt_figref">Figure 15.4: Adding a new customer by POSTing to the web service</p>
    <p class="normal">I will leave you an <a id="_idIndexMarker2248"/>optional<a id="_idIndexMarker2249"/> challenge to create <code class="inlineCode">.http</code> files that try updating a customer (using <code class="inlineCode">PUT</code>) and deleting a customer (using <code class="inlineCode">DELETE</code>). Try them on customers that do exist as well as customers that do not. Solutions are in the GitHub repository for this book at the following link:</p>
    <p class="normal"><a href="https://github.com/markjprice/cs13net9/tree/main/code/ModernWeb/HttpRequests">https://github.com/markjprice/cs13net9/tree/main/code/ModernWeb/HttpRequests</a></p>
    <h2 id="_idParaDest-835" class="heading-2">Passing environment variables</h2>
    <p class="normal">To get an<a id="_idIndexMarker2250"/> environment variable <a id="_idIndexMarker2251"/>in a <code class="inlineCode">.http</code> script, use <code class="inlineCode">$processenv</code>, as shown in the following command:</p>
    <pre class="programlisting code"><code class="hljs-code">{{$processEnv [%]envVarName}}
</code></pre>
    <p class="normal">For example, if you have set an environment variable to store a secret value like a password to connect to a SQL Server database that must be kept out of any files committed to a GitHub repository, you can use the following command:</p>
    <pre class="programlisting code"><code class="hljs-code">{{$processEnv MY_SQL_PWD}}
</code></pre>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn more about using environment variables with the REST client at the following link: <a href="https://marketplace.visualstudio.com/items?itemName=humao.rest-client#environments">https://marketplace.visualstudio.com/items?itemName=humao.rest-client#environments</a>. You can learn more about using environment variables and Secret Manager with HTTP Editor at the following link: <a href="https://devblogs.microsoft.com/visualstudio/safely-use-secrets-in-http-requests-in-visual-studio-2022/">https://devblogs.microsoft.com/visualstudio/safely-use-secrets-in-http-requests-in-visual-studio-2022/</a>.</p>
    </div>
    <p class="normal">Now that we’ve seen a quick and easy way to test our service, which also happens to be a great way to learn HTTP, what about external developers? We want it to be as easy<a id="_idIndexMarker2252"/> as possible for them to learn about <a id="_idIndexMarker2253"/>and then call our service. For that purpose, we will use Swagger.</p>
    <h2 id="_idParaDest-836" class="heading-2">Understanding the OpenAPI Specification</h2>
    <p class="normal">The <strong class="keyWord">OpenAPI Specification</strong> defines a<a id="_idIndexMarker2254"/> REST-style <a id="_idIndexMarker2255"/>contract for your API, detailing all its resources and operations in a human- and machine-readable format for easy development, discovery, and integration.</p>
    <p class="normal">Developers can use the OpenAPI Specification for a web service to automatically generate strongly typed client-side code in their preferred language or library.</p>
    <p class="normal">Let’s review how OpenAPI is enabled for our web service:</p>
    <ol>
      <li class="numberedList" value="1">If the web service is running, shut down the web server.</li>
      <li class="numberedList">In <code class="inlineCode">Northwind.WebApi.csproj</code>, note the package reference for Microsoft’s package that implements documentation for OpenAPI that was added by the project template, as shown in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">&lt;PackageReference Include="Microsoft.AspNetCore.OpenApi" /&gt;
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, in the section for adding services to the container, note the service registered by the project template to use OpenAPI, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">// Learn more about configuring OpenAPI at https://aka.ms/aspnet/openapi
builder.Services.AddOpenApi();
</code></pre>
      </li>
      <li class="numberedList">By default, the document name is <code class="inlineCode">v1</code>. Set the document name parameter to <code class="inlineCode">v2</code>, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">builder.Services.AddOpenApi(documentName: "v2");
</code></pre>
      </li>
      <li class="numberedList">In the <a id="_idIndexMarker2256"/>section that configures the <a id="_idIndexMarker2257"/>HTTP request pipeline, note the statements for using OpenAPI when in development mode, as shown highlighted in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">// Configure the HTTP request pipeline.
if (builder.Environment.IsDevelopment())
{
  <strong class="hljs-slc">app</strong><strong class="hljs-selector-class-slc">.MapOpenApi</strong><strong class="hljs-slc">();</strong>
}
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi</code> web service project using the <code class="inlineCode">https</code> launch profile.</li>
      <li class="numberedList">Start Chrome, navigate to <code class="inlineCode">https://localhost:5151/openapi/v2.json</code>, and note the JSON document returned, as shown in <em class="italic">Figure 15.5</em>:</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_15_05.png" alt="" width="812" height="211"/></figure>
    <p class="packt_figref">Figure 15.5: OpenAPI JSON documentation for the Northwind web service</p>
    <p class="normal">Note the following about the OpenAPI JSON document:</p>
    <ul>
      <li class="bulletList">It specifies all the relative paths for the service, like <code class="inlineCode">/weatherforecast/{days}</code>.</li>
      <li class="bulletList">For parameters like <code class="inlineCode">days</code>, it specifies their type and default value, like <code class="inlineCode">"parameters":[{"name":"days","in":"path","required":true,"schema":{"type":"integer","format":"int32","default":5}}]</code>.</li>
    </ul>
    <p class="normal">There are two techniques that you can use to add extra information to the generated documentation, <code class="inlineCode">WithSummary</code> and <code class="inlineCode">WithDescription</code>. These are available as either calling<a id="_idIndexMarker2258"/> extension methods after mapping the<a id="_idIndexMarker2259"/> endpoint or by decorating the lambda expression with attributes, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">app.MapGet("/helloUsingMethods", () =&gt; "Hello world!")
  .WithSummary("This is a summary.")
  .WithDescription("This is a description.");
app.MapGet("/helloUsingAttributes",
  [EndpointSummary("This is a summary.")]
  [EndpointDescription("This is a description.")]
  () =&gt; "Hello world!");
</code></pre>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn more at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/openapi?view=aspnetcore-9.0#describe-endpoints">https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/openapi?view=aspnetcore-9.0#describe-endpoints</a>.</p>
    </div>
    <h2 id="_idParaDest-837" class="heading-2">Enabling HTTP logging</h2>
    <p class="normal">HTTP logging is <a id="_idIndexMarker2260"/>an optional middleware <a id="_idIndexMarker2261"/>component that is useful when testing a web service. It logs information about HTTP requests and HTTP responses, including the following:</p>
    <ul>
      <li class="bulletList">Information about the HTTP request</li>
      <li class="bulletList">Headers</li>
      <li class="bulletList">Body</li>
      <li class="bulletList">Information about the HTTP response</li>
    </ul>
    <p class="normal">This is valuable in web services for auditing and debugging scenarios but beware because it can negatively impact performance. You might also log <strong class="keyWord">Personally Identifiable Information </strong>(<strong class="keyWord">PII</strong>), which <a id="_idIndexMarker2262"/>can cause compliance issues in some jurisdictions.</p>
    <p class="normal">Log levels can be set to the following:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">Error</code>: Only <code class="inlineCode">Error</code> level logs</li>
      <li class="bulletList"><code class="inlineCode">Warning</code>: <code class="inlineCode">Error</code> and <code class="inlineCode">Warning</code> level logs</li>
      <li class="bulletList"><code class="inlineCode">Information</code>: <code class="inlineCode">Error</code>, <code class="inlineCode">Warning</code>, and <code class="inlineCode">Information</code> level logs</li>
      <li class="bulletList"><code class="inlineCode">Verbose</code>: All level logs</li>
    </ul>
    <p class="normal">Log levels can be set for the namespace in which the functionality is defined. Nested namespaces allow us to control which functionality has logging enabled:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">Microsoft</code>: Include all log types in the <code class="inlineCode">Microsoft</code> namespace</li>
      <li class="bulletList"><code class="inlineCode">Microsoft.AspNetCore</code>: Include all log types in the <code class="inlineCode">Microsoft.AspNetCore</code> namespace</li>
      <li class="bulletList"><code class="inlineCode">Microsoft.AspNetCore.HttpLogging</code>: Include all log types in the <code class="inlineCode">Microsoft.AspNetCore.HttpLogging</code> namespace</li>
    </ul>
    <p class="normal">Let’s see HTTP logging in action:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi</code> project, <code class="inlineCode">appsettings.Development.json</code>, add an entry to set the HTTP logging middleware to the <code class="inlineCode">Information</code> level, as shown highlighted in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"<strong class="hljs-slc">,</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-attr-slc">"Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"Information"</strong>
    }
  }
}
</code></pre>
        <div><p class="normal">Although the <code class="inlineCode">Default</code> log level might be set to <code class="inlineCode">Information</code>, more specific configurations take priority. For example, any logging systems in the <code class="inlineCode">Microsoft.AspNetCore</code> namespace will use the <code class="inlineCode">Warning</code> level. By making the change we did, any logging systems in the <code class="inlineCode">Microsoft.AspNetCore.</code> <code class="inlineCode">HttpLogging.HttpLoggingMiddleware</code> namespace will now use <code class="inlineCode">Information</code>.</p>
        </div>
      </li>
    </ol>
    <ol>
      <li class="numberedList" value="2">In <code class="inlineCode">Program.cs</code>, import the namespace for working with HTTP logging, as shown<a id="_idIndexMarker2263"/> in <a id="_idIndexMarker2264"/>the following code:
        <pre class="programlisting code-one"><code class="hljs-code">using Microsoft.AspNetCore.HttpLogging; // To use HttpLoggingFields.
</code></pre>
      </li>
      <li class="numberedList">In the services configuration section, before the call to <code class="inlineCode">Build</code>, add a statement to configure HTTP logging, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">builder.Services.AddHttpLogging(options =&gt;
{
  options.LoggingFields = HttpLoggingFields.All;
  options.RequestBodyLogLimit = 4096; // Default is 32k.
  options.ResponseBodyLogLimit = 4096; // Default is 32k.
});
</code></pre>
      </li>
      <li class="numberedList">In the HTTP pipeline configuration section, before the call to <code class="inlineCode">app.UseHttpsRedirection</code>, add a statement to add HTTP logging, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">app.UseHttpLogging();
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi</code> web service using the <code class="inlineCode">https</code> launch profile.</li>
      <li class="numberedList">Start Chrome and navigate to <code class="inlineCode">https://localhost:5151/customers</code>.</li>
      <li class="numberedList">In the command prompt or terminal that shows the output from the web service host, note the request and response have been logged, as shown<a id="_idIndexMarker2265"/> in the following partial <a id="_idIndexMarker2266"/>output:
        <pre class="programlisting con-one"><code class="hljs-con">info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[1]
      Request:
      Protocol: HTTP/2
      Method: GET
      Scheme: https
      PathBase:
      Path: /weatherforecast
      Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
      Host: localhost:5151
      User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36
      Accept-Encoding: gzip, deflate, br
      Accept-Language: en-US,en-GB;q=0.9,en;q=0.8,fr-FR;q=0.7,fr;q=0.6
      Upgrade-Insecure-Requests: [Redacted]
...
info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[2]
      Response:
      StatusCode: 200
      Content-Type: application/json; charset=utf-8
info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[4]
      ResponseBody: [{"date":"2024-08-06","temperatureC":50,"summary":"Freezing","temperatureF":121},{"date":"2024-08-07","temperatureC":53,"summary":"Scorching","temperatureF":127},{"date":"2024-08-08","temperatureC":40,"summary":"Mild","temperatureF":103},{"date":"2024-08-09","temperatureC":8,"summary":"Bracing","temperatureF":46},{"date":"2024-08-10","temperatureC":-10,"summary":"Freezing","temperatureF":15}]
info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[8]
      Duration: 6.8678ms
</code></pre>
      </li>
      <li class="numberedList">Close <a id="_idIndexMarker2267"/>Chrome and shut down<a id="_idIndexMarker2268"/> the web server.</li>
    </ol>
    <h2 id="_idParaDest-838" class="heading-2">Logging to the Windows-only Event Log</h2>
    <p class="normal">When <a id="_idIndexMarker2269"/>configuring logging, you<a id="_idIndexMarker2270"/> might want to enable logging to the Windows Event Log, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">var builder = Host.CreateApplicationBuilder();
// Option 1
builder.Services.AddLogging(logging =&gt;
{
  logging.AddEventLog();
});
// Option 2
builder.Host.ConfigureLogging(logging =&gt;
{
  logging.AddEventLog();
});
// Option 3: .NET 6 or later. Concise and recommended by Microsoft.
builder.Logging.AddEventLog();
</code></pre>
    <p class="normal">You will see a code analyzer warning, <code class="inlineCode">CA1416</code>, because enabling Event Log only works on Windows. If you run this code on any other OS, then a runtime exception would be thrown. To avoid the warning (and runtime error), you should wrap the call to <code class="inlineCode">AddEventLog</code> with an OS check.</p>
    <p class="normal">First, import a namespace, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">using System.Runtime.InteropServices; // To use RuntimeInformation.
</code></pre>
    <p class="normal">Then, wrap any <a id="_idIndexMarker2271"/>calls to <code class="inlineCode">AddEventLog</code>, as shown in <a id="_idIndexMarker2272"/>the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">if (RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
{
  // Call the AddEventLog method.
}
</code></pre>
    <h2 id="_idParaDest-839" class="heading-2">Support for logging additional request headers in W3CLogger</h2>
    <p class="normal">W3CLogger<a id="_idIndexMarker2273"/> is a <a id="_idIndexMarker2274"/>middleware that writes logs in the W3C standard format. You can:</p>
    <ul>
      <li class="bulletList">Record details of HTTP requests and responses.</li>
      <li class="bulletList">Filter which headers and parts of the request and response messages are logged.</li>
    </ul>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> W3CLogger can reduce the performance of an app.</p>
    </div>
    <div><p class="normal">W3CLogger is like HTTP logging, so I will not cover details of how to use it in this book. You can learn more about W3CLogger at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/w3c-logger/">https://learn.microsoft.com/en-us/aspnet/core/fundamentals/w3c-logger/</a>.</p>
    </div>
    <p class="normal">In ASP.NET Core 7 or later, you can specify that you want to log additional request headers when using W3CLogger. Call the <code class="inlineCode">AdditionalRequestHeaders</code> method and pass the name of the header you want to log, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">services.AddW3CLogging(options =&gt;
{
  options.AdditionalRequestHeaders.Add("x-forwarded-for");
  options.AdditionalRequestHeaders.Add("x-client-ssl-protocol");
});
</code></pre>
    <p class="normal">You are now<a id="_idIndexMarker2275"/> ready<a id="_idIndexMarker2276"/> to build applications that consume your web service.</p>
    <h1 id="_idParaDest-840" class="heading-1">Consuming web services using HTTP clients</h1>
    <p class="normal">Now that we have <a id="_idIndexMarker2277"/>built and tested our Northwind service, we will learn how to call it from any .NET app using the <code class="inlineCode">HttpClient</code> class and its factory.</p>
    <h2 id="_idParaDest-841" class="heading-2">Understanding HttpClient</h2>
    <p class="normal">The easiest way <a id="_idIndexMarker2278"/>to consume a web service is to use the <code class="inlineCode">HttpClient</code> class. However, many people use it wrongly because it implements <code class="inlineCode">IDisposable</code>, and Microsoft’s own documentation shows poor usage of it. See the book links in the GitHub repository for articles with more discussion of this.</p>
    <p class="normal">Usually, when a type implements <code class="inlineCode">IDisposable</code>, you should create it inside a <code class="inlineCode">using</code> statement to ensure that it is disposed of as soon as possible. <code class="inlineCode">HttpClient</code> is different because it is shared, reentrant, and partially thread-safe.</p>
    <p class="normal">The problem has to do with how the underlying network sockets must be managed. The bottom line is that you should use a single instance of it for each HTTP endpoint that you consume during the life of your application. This will allow each <code class="inlineCode">HttpClient</code> instance to have defaults set that are appropriate for the endpoint it works with<a id="_idIndexMarker2279"/> while managing the underlying network sockets efficiently.</p>
    <h2 id="_idParaDest-842" class="heading-2">Configuring HTTP clients</h2>
    <p class="normal">Microsoft is aware<a id="_idIndexMarker2280"/> of the issue of .NET developers misusing <code class="inlineCode">HttpClient</code>, and in ASP.NET Core 2.1, it introduced <code class="inlineCode">HttpClientFactory</code> to encourage best practices; that is the technique we will use.</p>
    <p class="normal">In the following example, we will create a Northwind Blazor WebAssembly standalone project as a client for the Northwind Web API service. Let’s configure an HTTP client:</p>
    <ol>
      <li class="numberedList" value="1">Use your preferred code editor to open the <code class="inlineCode">ModernWeb</code> solution and then add a new project, as defined in the following list:<ul>
          <li class="bulletList level-2">Project template: <strong class="screenText">Blazor WebAssembly Standalone App</strong><strong class="keyWord"> </strong>/ <code class="inlineCode">blazorwasm</code></li>
          <li class="bulletList level-2">Solution file and folder: <code class="inlineCode">ModernWeb</code></li>
          <li class="bulletList level-2">Project file and folder: <code class="inlineCode">Northwind.WebApi.WasmClient</code></li>
          <li class="bulletList level-2"><strong class="screenText">Authentication type</strong>: None</li>
          <li class="bulletList level-2"><strong class="screenText">Configure for HTTPS</strong>: Selected</li>
          <li class="bulletList level-2"><strong class="screenText">Progressive Web Application</strong>: Cleared</li>
          <li class="bulletList level-2"><strong class="screenText">Include sample pages</strong>: Selected</li>
          <li class="bulletList level-2"><strong class="screenText">Do not use top-level statements</strong>: Cleared</li>
        </ul>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.WasmClient.csproj</code> project file, in the package references, remove version attributes.</li>
      <li class="numberedList">In the <code class="inlineCode">Properties</code> folder, in <code class="inlineCode">launchSettings.json</code>, for the <code class="inlineCode">https</code> profile, for its <code class="inlineCode">applicationUrl</code>, change the random port number for HTTPS to <code class="inlineCode">5152</code> and for HTTP to <code class="inlineCode">5153</code>, as shown highlighted in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">"applicationUrl": "https://localhost:<strong class="hljs-string-slc">5152</strong>;http://localhost:<strong class="hljs-string-slc">5153</strong>",
</code></pre>
      </li>
      <li class="numberedList">Save changes to all modified files.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, in the call to the <code class="inlineCode">AddScoped</code> method, add a statement to enable <code class="inlineCode">HttpClientFactory</code> with a named client to make calls to the Northwind Web API service using HTTPS on port <code class="inlineCode">5151</code> and request JSON as the default response format, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">builder.Services.AddScoped(sp =&gt; new HttpClient {
  BaseAddress = new Uri("https://localhost:5151/") });
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi</code> project, in <code class="inlineCode">Program.cs</code>, at the top of the file after the <a id="_idIndexMarker2281"/>namespace imports, declare a string constant for the name of a CORS policy, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">const string corsPolicyName = "allowWasmClient";
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, before the call to <code class="inlineCode">Build</code>, add CORS and configure a policy to allow HTTP calls from clients with different port numbers from the web service itself, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">builder.Services.AddCors(options =&gt;
{
  options.AddPolicy(name: corsPolicyName,
    policy =&gt;
    {
      policy.WithOrigins("https://localhost:5152",
        "http://localhost:5153");
    });
});
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after the call to <code class="inlineCode">UseHttpsRedirection</code>, enable CORS with the named<a id="_idIndexMarker2282"/> policy, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">app.UseCors(corsPolicyName);
</code></pre>
      </li>
    </ol>
    <h2 id="_idParaDest-843" class="heading-2">Getting customers as JSON in a Blazor component</h2>
    <p class="normal">We<a id="_idIndexMarker2283"/> can <a id="_idIndexMarker2284"/>now create a client page that:</p>
    <ul>
      <li class="bulletList">Makes a <code class="inlineCode">GET</code> request for customers.</li>
      <li class="bulletList">Deserializes the JSON response using convenient extension methods introduced with .NET 5 in the <code class="inlineCode">System.Net.Http.Json</code> assembly and namespace.</li>
    </ul>
    <p class="normal">Let’s go:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.WasmClient.csproj</code> project file, add a reference to the entity models project, as shown in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include=
"..\Northwind.EntityModels.Sqlite\Northwind.EntityModels.Sqlite.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.WasmClient</code> project, in <code class="inlineCode">_Imports.razor</code>, import the namespace for working with entity models, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">@using Northwind.EntityModels @* To use Customer. *@
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.WasmClient</code> project, in the <code class="inlineCode">Pages</code> folder, add a new file named <code class="inlineCode">Customers.razor</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Customers.razor</code>, inject the HTTP client service, and use it to call the Northwind Web API service, fetching all customers, and passing them to a table, as shown in <a id="_idIndexMarker2285"/>the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">@attribute [StreamRendering]
@page "/customers/{country?}"
@inject HttpClient Http
&lt;h3&gt;
  Customers @(string.IsNullOrWhiteSpace(Country)
    ? "Worldwide" : "in " + Country)
&lt;/h3&gt;
@if (customers is null)
{
  &lt;p&gt;&lt;em&gt;Loading...&lt;/em&gt;&lt;/p&gt;
}
else
{
  &lt;table class="table"&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;Id&lt;/th&gt;
        &lt;th&gt;Company Name&lt;/th&gt;
        &lt;th&gt;Address&lt;/th&gt;
        &lt;th&gt;Phone&lt;/th&gt;
        &lt;th&gt;&lt;/th&gt;
      &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
      @foreach (Customer c in customers)
      {
        &lt;tr&gt;
          &lt;td&gt;@c.CustomerId&lt;/td&gt;
          &lt;td&gt;@c.CompanyName&lt;/td&gt;
          &lt;td&gt;
            @c.Address&lt;br /&gt;
            @c.City&lt;br /&gt;
            @c.PostalCode&lt;br /&gt;
            @c.Country
          &lt;/td&gt;
          &lt;td&gt;@c.Phone&lt;/td&gt;
        &lt;/tr&gt;
      }
    &lt;/tbody&gt;
  &lt;/table&gt;
}
@code {
  [Parameter]
  public string? Country { get; set; }
  private IEnumerable&lt;Customer&gt;? customers;
  protected override async Task OnParametersSetAsync()
  {
    if (string.IsNullOrWhiteSpace(Country))
    {
      customers = await Http.GetFromJsonAsync
        &lt;Customer[]&gt;("/customers");
    }
    else
    {
      customers = await Http.GetFromJsonAsync
        &lt;Customer[]&gt;($"/customers/in/{Country}");
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Layout</code> folder, in <code class="inlineCode">NavMenu.razor</code>, change the <strong class="screenText">Weather</strong> menu item to show<a id="_idIndexMarker2286"/> customers<a id="_idIndexMarker2287"/> instead, as shown in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">&lt;NavLink class="nav-link" href="customers"&gt;
  &lt;span class="bi bi-list-nested-nav-menu" aria-hidden="true"&gt;&lt;/span&gt; Customers
&lt;/NavLink&gt;
</code></pre>
      </li>
    </ol>
    <h2 id="_idParaDest-844" class="heading-2">Starting multiple projects</h2>
    <p class="normal">Up to this point, we <a id="_idIndexMarker2288"/>have only started one project at a time. Now we have two projects that need to be started, a web service and a Blazor client website. In the step-by-step instructions, I will only tell you to start individual projects one at a time, but you should use whatever technique you prefer to start them.</p>
    <h3 id="_idParaDest-845" class="heading-3">If you are using Visual Studio</h3>
    <p class="normal">Visual Studio<a id="_idIndexMarker2289"/> can start multiple projects manually one by one if the debugger is not attached, as described in the following steps:</p>
    <ol>
      <li class="numberedList" value="1">In <strong class="screenText">Solution Explorer</strong>, right-click on the solution or any project and then select <strong class="screenText">Configure Startup Projects…</strong>, or select the solution and navigate to <strong class="screenText">Project</strong> | <strong class="screenText">Configure Startup Projects…</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Solution ‘&lt;name&gt;’ Property Pages</strong> dialog box, select <strong class="screenText">Current selection</strong>.</li>
      <li class="numberedList">Click <strong class="screenText">OK</strong>.</li>
      <li class="numberedList">Select a project in <strong class="screenText">Solution Explorer</strong> so that its name becomes bold.</li>
      <li class="numberedList">Navigate to <strong class="screenText">Debug</strong> | <strong class="screenText">Start Without Debugging</strong> or press <em class="keystroke">Ctrl</em> + <em class="keystroke">F5</em>.</li>
      <li class="numberedList">Repeat <em class="italic">steps 2</em> and <em class="italic">3</em> for as many projects as you need.</li>
    </ol>
    <p class="normal">If you need to<a id="_idIndexMarker2290"/> debug the projects, then you must start multiple instances of Visual Studio. Each instance can start a single project with debugging.</p>
    <p class="normal">You can also configure multiple projects to start up at the same time using the following steps:</p>
    <ol>
      <li class="numberedList" value="1">In <strong class="screenText">Solution Explorer</strong>, right-click the solution or any project and then select <strong class="screenText">Configure Startup Projects…</strong>, or select the solution and navigate to <strong class="screenText">Project</strong> | <strong class="screenText">Configure Startup Projects…</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Solution ‘&lt;name&gt;’ Property Pages</strong> dialog box, select <strong class="screenText">Multiple startup projects</strong>, and for any projects that you want to start, select either <strong class="screenText">Start</strong> or <strong class="screenText">Start without debugging</strong>, as shown in <em class="italic">Figure 15.6</em>:</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_15_06.png" alt="" width="812" height="431"/></figure>
    <p class="packt_figref">Figure 15.6: Selecting multiple projects to start up in Visual Studio</p>
    <ol>
      <li class="numberedList" value="3">Click <strong class="screenText">OK</strong>.</li>
      <li class="numberedList">Navigate to <strong class="screenText">Debug</strong> | <strong class="screenText">Start Debugging</strong> or <strong class="screenText">Debug</strong> | <strong class="screenText">Start Without Debugging</strong> or<a id="_idIndexMarker2291"/> click the equivalent buttons in the toolbar to start all the projects that you <a id="_idIndexMarker2292"/>selected.</li>
    </ol>
    <div><p class="normal">You can learn more about multi-project startup using Visual Studio at the following link: <a href="https://learn.microsoft.com/en-us/visualstudio/ide/how-to-set-multiple-startup-projects">https://learn.microsoft.com/en-us/visualstudio/ide/how-to-set-multiple-startup-projects</a>.</p>
    </div>
    <h3 id="_idParaDest-846" class="heading-3">If you are using VS Code</h3>
    <p class="normal">If you need to<a id="_idIndexMarker2293"/> start multiple projects at the command line with <code class="inlineCode">dotnet</code>, then write a script or batch file to execute multiple <code class="inlineCode">dotnet run</code> commands, or open multiple command prompt or terminal windows.</p>
    <p class="normal">If you need to debug multiple projects using VS Code, then after you’ve started the first debug session, you can just launch another session. Once the second session is running, the user interface switches to multi-target mode. For example, in the <strong class="screenText">CALL STACK</strong>, you will see both named projects with their own threads, and then the debug toolbar shows a drop-down list of sessions with the active one selected. Alternatively, you can define <a id="_idIndexMarker2294"/>compound launch configurations <a id="_idIndexMarker2295"/>in the <code class="inlineCode">launch.json</code>.</p>
    <div><p class="normal">You can learn more about multi-target debugging using VS Code at the following link: <a href="https://code.visualstudio.com/Docs/editor/debugging#_multitarget-debugging">https://code.visualstudio.com/Docs/editor/debugging#_multitarget-debugging</a>.</p>
    </div>
    <h2 id="_idParaDest-847" class="heading-2">Starting the web service and Blazor client projects</h2>
    <p class="normal">Now we can try <a id="_idIndexMarker2296"/>out the web service<a id="_idIndexMarker2297"/> with the Blazor client calling it:</p>
    <ol>
      <li class="numberedList" value="1">Start the <code class="inlineCode">Northwind.WebApi</code> project and confirm that the web service is listening on ports <code class="inlineCode">5151</code> and <code class="inlineCode">5150</code>, as shown in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">info: Microsoft.Hosting.Lifetime[14]
  Now listening on: https://localhost:5151
info: Microsoft.Hosting.Lifetime[14]
  Now listening on: http://localhost:5150
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.WasmClient</code> project and confirm that the website is listening on ports <code class="inlineCode">5152</code> and <code class="inlineCode">5153</code>, as shown in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">info: Microsoft.Hosting.Lifetime[14]
  Now listening on: https://localhost:5152
info: Microsoft.Hosting.Lifetime[14]
  Now listening on: http://localhost:5153
</code></pre>
      </li>
      <li class="numberedList">Start Chrome and navigate to <code class="inlineCode">https://localhost:5152/</code>.</li>
      <li class="numberedList">On the home page, in the left navigation menu, click <strong class="screenText">Customers</strong>, and note the list of customers, as shown in <em class="italic">Figure 15.7</em>:</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_15_07.png" alt="" width="812" height="346"/></figure>
    <p class="packt_figref">Figure 15.7: Customers worldwide fetched from a web service</p>
    <ol>
      <li class="numberedList" value="5">In the<a id="_idIndexMarker2298"/> command<a id="_idIndexMarker2299"/> prompt or terminal for the web service, note that HTTP logging shows that a successful request was made for customers, as shown in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (20ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT "c"."CustomerId", "c"."Address", "c"."City", "c"."CompanyName", "c"."ContactName", "c"."ContactTitle", "c"."Country", "c"."Fax", "c"."Phone", "c"."PostalCode", "c"."Region"
      FROM "Customers" AS "c"
info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[2]
      Response:
      StatusCode: 200
      Content-Type: application/json; charset=utf-8
info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[4]
      ResponseBody: [{"customerId":"ALFKI","companyName":"Alfreds Futterkiste","contactName":"Maria Anders","contactTitle":"Sales Representative","address":"Obere Str. 57","city":"Berlin","region":null,"postalCode":"12209","country":"Germany","phone":"030-0074321","fax":"030-0076545","orders":[]},...
info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[8]
      Duration: 1039.4409ms
</code></pre>
      </li>
      <li class="numberedList">In the address bar, change the path to specify a country like <code class="inlineCode">Germany</code>, <code class="inlineCode">UK</code>, or <code class="inlineCode">USA</code>, for example: <code class="inlineCode">customers/UK</code>. Press <em class="keystroke">Enter</em> and note the table updates to only show UK customers.</li>
      <li class="numberedList">Close Chrome<a id="_idIndexMarker2300"/> and shut<a id="_idIndexMarker2301"/> down the two web servers.</li>
    </ol>
    <h1 id="_idParaDest-848" class="heading-1">Practicing and exploring</h1>
    <p class="normal">Test your knowledge and understanding by answering some questions, getting some hands-on practice, and exploring this chapter’s topics with deeper research.</p>
    <h2 id="_idParaDest-849" class="heading-2">Exercise 15.1 – Online material</h2>
    <p class="normal">Online material could be created by Microsoft or third-parties, or extra content for this book.</p>
    <h3 id="_idParaDest-850" class="heading-3">Implementing advanced features for web services</h3>
    <p class="normal">If you would like to learn about web service health checks, OpenAPI analyzers, adding security HTTP headers, and enabling HTTP/3 support for <code class="inlineCode">HttpClient</code>, then you can read the optional online-only section at the following link:</p>
    <p class="normal"><a href="https://github.com/markjprice/cs13net9/blob/main/docs/ch15-advanced.md">https://github.com/markjprice/cs13net9/blob/main/docs/ch15-advanced.md</a></p>
    <h3 id="_idParaDest-851" class="heading-3">Minimal APIs parameter binding</h3>
    <p class="normal">You can learn more about how to convert HTTP request data into strongly typed parameters for Minimal APIs endpoints at the following link:</p>
    <p class="normal"><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/parameter-binding">https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/parameter-binding</a></p>
    <h3 id="_idParaDest-852" class="heading-3">Refit client</h3>
    <p class="normal">Refit is an automatic type-safe REST library for .NET. It was inspired by Square’s Retrofit library, and it turns your REST service into a live interface.</p>
    <p class="normal"><a href="https://github.com/reactiveui/refit">https://github.com/reactiveui/refit</a></p>
    <h3 id="_idParaDest-853" class="heading-3">Web service security using Microsoft Identity</h3>
    <p class="normal">You can learn what’s new with Microsoft Identity for authentication and authorization at the following link:</p>
    <p class="normal"><a href="https://devblogs.microsoft.com/dotnet/whats-new-with-identity-in-dotnet-8/">https://devblogs.microsoft.com/dotnet/whats-new-with-identity-in-dotnet-8/</a></p>
    <h2 id="_idParaDest-854" class="heading-2">Exercise 15.2 – Practice exercises</h2>
    <p class="normal">Practice exercises go deeper into the topics for this chapter.</p>
    <h3 id="_idParaDest-855" class="heading-3">Creating and deleting customers with HttpClient</h3>
    <p class="normal">Extend the <code class="inlineCode">Northwind.WebApi.ClientWasm</code> project to have pages where a visitor can fill in a form to create a new customer, or search for a customer and then delete them. The Blazor components should make calls to the Northwind Web API web service to create and delete customers.</p>
    <h2 id="_idParaDest-856" class="heading-2">Exercise 15.3 – Test your knowledge</h2>
    <p class="normal">Answer the following questions:</p>
    <ol>
      <li class="numberedList" value="1">ASP.NET Core has multiple project templates for building web services. What are they and how do you create them using the CLI?</li>
      <li class="numberedList">When configuring an HTTP client, how do you specify the format of data that you prefer in the response from the web service?</li>
      <li class="numberedList">Why did the ASP.NET Core team replace the Swashbuckle package with their own implementation of OpenAPI support?</li>
      <li class="numberedList">What must you do to specify what responses should be expected when calling a <code class="inlineCode">MapGet</code> or similar method?</li>
      <li class="numberedList">List three methods that can be called to return responses with different status codes.</li>
      <li class="numberedList">List four ways that you can test a web service.</li>
      <li class="numberedList">Why should you not wrap your use of <code class="inlineCode">HttpClient</code> in a <code class="inlineCode">using</code> statement to dispose of it when you are finished even though it implements the <code class="inlineCode">IDisposable</code> interface, and what should you use instead?</li>
      <li class="numberedList">What are the benefits of HTTP/2 and HTTP/3 compared to HTTP/1.1?</li>
      <li class="numberedList">How can you enable clients to detect if your web service is healthy with ASP.NET Core 2.2 and later?</li>
      <li class="numberedList">What are the main types of object caching and why is the <code class="inlineCode">HybridCache</code> introduced with .NET 9 the best?</li>
    </ol>
    <h2 id="_idParaDest-857" class="heading-2">Exercise 15.4 – Explore topics</h2>
    <p class="normal">Use the links in the following GitHub repository to learn more details about the topics covered in this chapter:</p>
    <p class="normal"><a href="https://github.com/markjprice/cs13net9/blob/main/docs/book-links.md#chapter-15---building-and-consuming-web-services">https://github.com/markjprice/cs13net9/blob/main/docs/book-links.md#chapter-15---building-and-consuming-web-services</a></p>
    <h1 id="_idParaDest-858" class="heading-1">Summary</h1>
    <p class="normal">In this chapter, you learned:</p>
    <ul>
      <li class="bulletList">How to build an ASP.NET Core web service using Minimal APIs that can be called by any app on any platform that can make an HTTP request and process an HTTP response</li>
      <li class="bulletList">How to document web service APIs with OpenAPI</li>
      <li class="bulletList">How to test web services using a browser, HTTP editor, or REST client</li>
      <li class="bulletList">How to consume services efficiently</li>
    </ul>
    <p class="normal">In the <em class="chapterRef">Epilogue</em>, I will make some suggestions for books to take you deeper into C# and .NET.</p>
  </div>
</div></div></body></html>