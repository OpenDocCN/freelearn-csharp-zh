<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;8.&#xA0;Web Services with Push Notifications"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch08" class="calibre1"/>Chapter 8. Web Services with Push Notifications</h1></div></div></div><p class="calibre8">Modern mobile applications are defined by their network connectivity. A mobile app that does not interact with a web server is both a rare find and not as interactive or social as it would otherwise be. In this book, we'll use the <span class="strong"><strong class="calibre2">Windows Azure</strong></span> cloud platform to implement a server-side backend for our XamChat application. We'll use a feature called <span class="strong"><strong class="calibre2">Azure Mobile Services</strong></span>, which<a id="id468" class="calibre1"/> is an excellent fit for our application and has the benefit of built-in push notifications. Once we are done with this chapter, our XamChat sample application will be much closer to being a real application and will allow its users to interact with one another.</p><p class="calibre8">In this chapter, we will cover the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The services offered by Windows Azure</li><li class="listitem">Setting up your Azure account</li><li class="listitem">Azure Mobile Services as a backend for XamChat</li><li class="listitem">Creating tables and scripts</li><li class="listitem">Implementing a real web service for XamChat</li><li class="listitem">Using the Apple Push Notification service</li><li class="listitem">Sending notifications with Google Cloud Messaging</li></ul></div></div>

<div class="book" title="Chapter&#xA0;8.&#xA0;Web Services with Push Notifications">
<div class="book" title="Learning Windows Azure"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch08lvl1sec56" class="calibre1"/>Learning Windows Azure</h1></div></div></div><p class="calibre8">Windows Azure is an<a id="id469" class="calibre1"/> excellent cloud platform released by Microsoft in 2010. Azure provides both<a id="id470" class="calibre1"/> <span class="strong"><strong class="calibre2">Infrastructure as a Service</strong></span> (<span class="strong"><strong class="calibre2">IaaS</strong></span>) and <a id="id471" class="calibre1"/><span class="strong"><strong class="calibre2">Platform as a Service</strong></span> (<span class="strong"><strong class="calibre2">PaaS</strong></span>) for building modern web applications and services. This means that it provides you with access to direct virtual machines within which you can deploy any operating system or software of your choice. This is known as IaaS. Azure also provides multiple platforms for building applications such as <a id="id472" class="calibre1"/><span class="strong"><strong class="calibre2">Azure Websites</strong></span> or <span class="strong"><strong class="calibre2">SQL Azure</strong></span>. These<a id="id473" class="calibre1"/> platforms are known as PaaS since you deploy your software at a high level and do not have to deal directly with virtual machines or manage software upgrades.</p><p class="calibre8">Let's go through the<a id="id474" class="calibre1"/> following more common services provided by Windows Azure:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre2">Virtual machines</strong></span>: Azure provides<a id="id475" class="calibre1"/> you with access to virtual machines of all sizes. You can install practically any operating system<a id="id476" class="calibre1"/> of your choice. There are many premade distributions to choose from within Azure's gallery.</li><li class="listitem"><span class="strong"><strong class="calibre2">Websites</strong></span>: You can deploy any<a id="id477" class="calibre1"/> type of website that<a id="id478" class="calibre1"/> will run in Microsoft IIS from ASP.NET sites to<a id="id479" class="calibre1"/> <span class="strong"><strong class="calibre2">PHP</strong></span> or <a id="id480" class="calibre1"/><span class="strong"><strong class="calibre2">Node.js</strong></span>.</li><li class="listitem"><span class="strong"><strong class="calibre2">SQL Azure</strong></span>: This is a <a id="id481" class="calibre1"/>cloud-based version of Microsoft SQL <a id="id482" class="calibre1"/>Server, which is a full-featured <a id="id483" class="calibre1"/><span class="strong"><strong class="calibre2">Relational Database Management System</strong></span> (<span class="strong"><strong class="calibre2">RDMS</strong></span>) for storing data.</li><li class="listitem"><span class="strong"><strong class="calibre2">Mobile Services</strong></span>: This is a<a id="id484" class="calibre1"/> simple platform for building web services for mobile apps. It uses <span class="strong"><strong class="calibre2">SQL Azure</strong></span> for backend storage and a simple JavaScript scripting system based on Node.js for adding business logic. In the latest version of Azure<a id="id485" class="calibre1"/> Mobile Services, you can also use C# and the ASP.NET Web API for developing server-side code.</li><li class="listitem"><span class="strong"><strong class="calibre2">Storage</strong></span>: Azure provides <span class="strong"><strong class="calibre2">Blob storage</strong></span>, a <a id="id486" class="calibre1"/>method for storing binary<a id="id487" class="calibre1"/> files, and <a id="id488" class="calibre1"/><span class="strong"><strong class="calibre2">Table storage</strong></span>, which is a <span class="strong"><strong class="calibre2">NoSQL</strong></span> solution for persisting data.</li><li class="listitem"><span class="strong"><strong class="calibre2">Service bus</strong></span>: This is a cloud-based solution for creating queues to facilitate communication between<a id="id489" class="calibre1"/> other cloud services. It<a id="id490" class="calibre1"/> also includes notification hubs as a simple way of providing push notifications to mobile apps.</li><li class="listitem"><span class="strong"><strong class="calibre2">Worker roles</strong></span>: A simple <a id="id491" class="calibre1"/>way to run a custom process in the cloud can be a plain Windows executable or a .NET worker role<a id="id492" class="calibre1"/> project.</li><li class="listitem"><span class="strong"><strong class="calibre2">Media services</strong></span>: A mechanism<a id="id493" class="calibre1"/> for providing<a id="id494" class="calibre1"/> streaming audio or video to nearly any device. It handles both encoding and delivery and can scale to support a large volume of users.</li><li class="listitem"><span class="strong"><strong class="calibre2">HDInsight</strong></span>: A version of Apache Hadoop running in Windows Azure for managing extremely large<a id="id495" class="calibre1"/> databases, also called<a id="id496" class="calibre1"/> big data.</li><li class="listitem"><span class="strong"><strong class="calibre2">Cloud services</strong></span>: This is a <a id="id497" class="calibre1"/>conglomeration of other services. Cloud services allow you to bundle multiple services<a id="id498" class="calibre1"/> together and create staging and production environments. It is a great tool for deployment; you can deploy changes to staging and swap staging and production to preserve uptime for your users.</li></ul></div><p class="calibre8">Apart from these services, there are many more, and new ones are added pretty regularly. We will use <a id="id499" class="calibre1"/><span class="strong"><strong class="calibre2">Azure Mobile Services</strong></span>, which leverages SQL Azure, to build our web service for XamChat. You can visit <a class="calibre1" href="http://windowsazure.com">http://windowsazure.com</a> for a full rundown of pricing and services offered.</p><p class="calibre8">In this book, we chose to demonstrate a solution using Windows Azure as a web service backend for XamChat, since it is very easy to use with Xamarin applications because of the fantastic library found in the Xamarin Component Store. However, there are many more choices out there besides Azure that you might want to look at. Using Xamarin's development platform does not limit the types of web services your applications can interact with.</p><p class="calibre8">Here are a few more common ones:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre2">Parse</strong></span>: This service<a id="id500" class="calibre1"/> provides a product similar to that of Azure Mobile Services, complete with data storage and push notifications. This is a popular service among many mobile developers, even those not using Xamarin. You can get<a id="id501" class="calibre1"/> more information at <a class="calibre1" href="http://parse.com">http://parse.com</a>.</li><li class="listitem"><span class="strong"><strong class="calibre2">Urban Airship</strong></span>: This <a id="id502" class="calibre1"/>service provides push notifications for mobile apps across multiple<a id="id503" class="calibre1"/> platforms. You can get more information at <a class="calibre1" href="http://urbanairship.com">http://urbanairship.com</a>.</li><li class="listitem"><span class="strong"><strong class="calibre2">Amazon Web Services</strong></span>: This service is a complete cloud solution that is equivalent to Windows Azure. It has everything that you need to deploy applications in the <a id="id504" class="calibre1"/>cloud with total virtual machine support. The main difference is that Azure is very C# focused and built for .NET developers. There are also not as many PaaS options on Amazon. You<a id="id505" class="calibre1"/> can get more information at <a class="calibre1" href="http://aws.amazon.com">http://aws.amazon.com</a>.</li></ul></div><p class="calibre8">Additionally, you can develop your own web services with on-premises web servers or inexpensive hosting services using the languages and technologies of your choice.</p></div></div>
<div class="book" title="Setting up your Azure account"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec57" class="calibre1"/>Setting up your Azure account</h1></div></div></div><p class="calibre8">To start <a id="id506" class="calibre1"/>developing with Windows Azure, you can subscribe to a free one-month trial along with free credits worth $200. You can get even more perks if you have an MSDN subscription. To go along with this, many of Azure's services have free tiers that give you lower performance versions. So if your trial expires, you can continue your development at little or no cost, depending on the services you are using.</p><p class="calibre8">Let's begin by<a id="id507" class="calibre1"/> navigating to <a class="calibre1" href="http://windowsazure.com/en-us/pricing/free-trial">http://windowsazure.com/en-us/pricing/free-trial</a> and performing the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Click on the <span class="strong"><strong class="calibre2">Try it now</strong></span> link.</li><li class="listitem" value="2">Sign in with a Windows Live ID.</li><li class="listitem" value="3">For security purposes, verify your account via phone or text message.</li><li class="listitem" value="4">Enter the payment information. This is only used if you exceed your spending limits. You won't accidentally spend beyond budget by developing your app—it is fairly difficult to accidentally spend money until real users are interacting with your services.</li><li class="listitem" value="5">Check <span class="strong"><strong class="calibre2">I agree</strong></span> to the policies and click on <span class="strong"><strong class="calibre2">Sign Up</strong></span>.</li><li class="listitem" value="6">Review the final setting and click on <span class="strong"><strong class="calibre2">Submit</strong></span>.</li><li class="listitem" value="7">If all the required information is entered correctly, you will now finally have access to the Azure subscription page. Your subscription page will look similar to the following screenshot:</li></ol><div class="calibre13"/></div><div class="mediaobject"><img src="../images/00059.jpeg" alt="Setting up your Azure account" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">You can click on the <span class="strong"><strong class="calibre2">Portal</strong></span> link in the top-right corner of the page to access your account. In future, you can manage your <a id="id508" class="calibre1"/>Azure services at: <a class="calibre1" href="http://manage.windowsazure.com">http://manage.windowsazure.com</a>.</p><p class="calibre8">Complete the<a id="id509" class="calibre1"/> Windows Azure tour to get a quick rundown of the management portal's features. You can then access the main menu to create new Azure services, virtual machines, and so on. The main menu looks similar to the following screenshot:</p><div class="mediaobject"><img src="../images/00060.jpeg" alt="Setting up your Azure account" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">This concludes the sign-up process for Windows Azure. It is pretty simple compared to the Apple and Google Play developer programs. Feel free to play around, but don't be too worried about <a id="id510" class="calibre1"/>spending money. Azure has free versions of most services and also delivers a good amount of bandwidth for free. You can get more<a id="id511" class="calibre1"/> information on pricing at <a class="calibre1" href="http://windowsazure.com/en-us/pricing/overview">http://windowsazure.com/en-us/pricing/overview</a>.</p><p class="calibre8">Note that there are a lot of misconceptions about Windows Azure being expensive. You can do all of your development for an application on the free tier without spending a dime. When putting applications into production, you can easily scale up or down on the number of VM instances to keep your costs under control. In general, you will not be spending much money if you do not have a lot of users. Likewise, you should be earning plenty of revenue if you happen to have lots of users.</p></div>
<div class="book" title="Exploring Azure Mobile Services"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec58" class="calibre1"/>Exploring Azure Mobile Services</h1></div></div></div><p class="calibre8">For the server side of XamChat, we'll use Azure Mobile Services to provide backend storage to the application. A mobile service is a neat solution to accelerate development for mobile <a id="id512" class="calibre1"/>applications that provide data storage and a <span class="strong"><strong class="calibre2">REST-based</strong></span> API, which is a standards-based way of communicating with a web service over HTTP. Azure Mobile Services also includes a .NET client library for interacting with the service from C#.</p><p class="calibre8">A few nice features<a id="id513" class="calibre1"/> of Azure Mobile Services are as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Storage of data in the cloud with SQL Azure or other Azure data services such as Blob or Table storage</li><li class="listitem">Easy authentication with Windows Live ID, Facebook, Google, and Twitter</li><li class="listitem">Push notifications with iOS, Android, and Windows devices</li><li class="listitem">Code the server side with JavaScript and Node.js or C#</li><li class="listitem">An easy-to-use .NET library for client-side development</li><li class="listitem">Scale Azure Mobile Services to accommodate high volumes of data</li></ul></div><p class="calibre8">You can see why using Azure is a good choice for simple mobile applications. The benefits of accelerated development and the many features it provides are a great fit for our XamChat sample application.</p><p class="calibre8">Let's navigate to your account at <a class="calibre1" href="http://manage.windowsazure.com">http://manage.windowsazure.com</a> and perform the following steps to create a mobile service:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Click on the plus button in the bottom-left corner of the window.</li><li class="listitem" value="2">Navigate to<a id="id514" class="calibre1"/> <span class="strong"><strong class="calibre2">Compute</strong></span> | <span class="strong"><strong class="calibre2">Mobile Service</strong></span> | <span class="strong"><strong class="calibre2">Create</strong></span> through the menu.</li><li class="listitem" value="3">Enter a domain URL of your choice such as <code class="literal">yourname-xamchat</code>.</li><li class="listitem" value="4">We use the free database option for now.</li><li class="listitem" value="5">Select a data center near your location in the <span class="strong"><strong class="calibre2">Region</strong></span> dropdown.</li><li class="listitem" value="6">For the <span class="strong"><strong class="calibre2">Backend</strong></span> dropdown, leave the selection on <span class="strong"><strong class="calibre2">JavaScript</strong></span> for this book. It will be simpler to set up the backend since we are focusing more on the client side. Feel free to use C# as an alternative, but keep in mind the examples in this book will be written in JavaScript.</li><li class="listitem" value="7">Now, click on <span class="strong"><strong class="calibre2">Next</strong></span>.</li><li class="listitem" value="8">Use the default database name and choose <span class="strong"><strong class="calibre2">New SQL database server</strong></span>.</li><li class="listitem" value="9">Enter a login name and password for the SQL server, and keep this information in a safe place.</li><li class="listitem" value="10">Make sure the region is the same as that of your mobile service to ensure good performance between your mobile service and its database.</li><li class="listitem" value="11">Review your final settings and hit the <span class="strong"><strong class="calibre2">Finish</strong></span> button.</li></ol><div class="calibre13"/></div><p class="calibre8">The management portal will display the progress, and it will take several seconds to create your mobile service and SQL Server instances. Remember that Azure is creating and starting new virtual machines for you under the hood, so it is really doing a decent amount of work to accommodate your request.</p><p class="calibre8">When completed, your account will have one <span class="strong"><strong class="calibre2">Mobile Service</strong></span> and one <span class="strong"><strong class="calibre2">SQL database</strong></span> in addition to the <span class="strong"><strong class="calibre2">Default Directory</strong></span> that is included in all the accounts, as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00061.jpeg" alt="Exploring Azure Mobile Services" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">If you take a look at the <span class="strong"><strong class="calibre2">Scale</strong></span> tab for your mobile service, you'll notice that it is running under the <span class="strong"><strong class="calibre2">Free</strong></span> tier by default. This is a great place for development. At the time of writing this book, it accommodates 500 devices. When deploying your applications to production, you<a id="id515" class="calibre1"/> might consider the <span class="strong"><strong class="calibre2">Basic</strong></span> or <span class="strong"><strong class="calibre2">Standard</strong></span> tiers, which also give you the option to add multiple instances.</p></div>
<div class="book" title="Creating tables and scripts"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec59" class="calibre1"/>Creating tables and scripts</h1></div></div></div><p class="calibre8">The first step to implement <a id="id516" class="calibre1"/>something in Azure Mobile Services is to create a new table. By default, Azure Mobile Services uses a feature called <span class="strong"><strong class="calibre2">dynamic schemas</strong></span> with its SQL database. When you insert a row from the client, new columns are dynamically added to the table. This prevents you from having to create the database schema manually<a id="id517" class="calibre1"/> and is a neat code-first approach to develop your backend database. You can always connect to the SQL database manually to fine tune things or make manual changes to the schema.</p><p class="calibre8">Return to the management portal, select your mobile services instance, and perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Click on the <span class="strong"><strong class="calibre2">Data</strong></span> tab.</li><li class="listitem" value="2">Click on the <span class="strong"><strong class="calibre2">Create</strong></span> button found at the bottom center of the page.</li><li class="listitem" value="3">Enter <code class="literal">User</code> as the table name.</li><li class="listitem" value="4">Leave everything else at its default value and click on the <span class="strong"><strong class="calibre2">Save</strong></span> button.</li><li class="listitem" value="5">Repeat this process to create three more tables named <code class="literal">Friend</code>, <code class="literal">Message</code>, and <code class="literal">Conversation</code>.</li></ol><div class="calibre13"/></div><p class="calibre8">Now that we have our four tables, we need to create a script to facilitate the login process for the users of our app. Azure Mobile Services allows you to add custom logic to your tables by creating scripts that run in Node.js, a framework for developing web services with JavaScript. You can override what happens to each table during the <code class="literal">insert</code>, <code class="literal">read</code>, <code class="literal">update</code>, or <code class="literal">delete</code><a id="id518" class="calibre1"/> operations. In addition to this, you can also create scripts that are completely customized if you need other functionalities.</p><p class="calibre8">Click on the <code class="literal">User</code> table and then click on the <span class="strong"><strong class="calibre2">Script</strong></span> tab. Make sure you are viewing the <code class="literal">insert</code> operation. By default, your <a id="id519" class="calibre1"/>script will be very simple, as shown in the following snippet:</p><div class="informalexample"><pre class="programlisting">function insert(item, user, request) {

  request.execute();

}</pre></div><p class="calibre8">Scripts in Azure Mobile Services have three parameters, which are stated as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="literal">item</code>: This parameter is the object that the client sends to the service. In our case, it will be the <code class="literal">User</code> object we created in the previous chapters.</li><li class="listitem"><code class="literal">user</code>: This parameter includes information about the authenticated user. We won't be using this in our examples.</li><li class="listitem"><code class="literal">request</code>: This parameter is an object used to run the <code class="literal">table</code> operation and send a response back to the client. Calling <code class="literal">execute</code> will complete the operation and return a successful response to the client.</li></ul></div><p class="calibre8">We need to modify the preceding script to only insert a new user when that user does not already exist. If the user does exist, we need to make sure that the password matches the username. Let's make a few changes to the script, as shown in the following lines of code:</p><div class="informalexample"><pre class="programlisting">function insert(item, user, request) { 
  var users = tables.getTable('user');
  users.where({ username : item.Username }).read({
    success: function(results) {
      if (results.length == 0) {
        //This is a new user
        request.execute();
      }
      else {
        var user = results[0];
        if (item.Password == user.Password) {
          request.respond(statusCodes.OK, user);
        }
        else {
        request.respond(statusCodes.UNAUTHORIZED, "Incorrect username or password");
        }
      }
    }
  });
}</pre></div><p class="calibre8">Let's summarize what <a id="id520" class="calibre1"/>we did in the preceding JavaScript:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we grabbed the <code class="literal">user</code> table. Note that you can reference the name of the table using lowercase.</li><li class="listitem" value="2">Next, we ran a query to pull out any existing users with the <code class="literal">where</code> function. We used <code class="literal">item.Username</code> since this matches our <code class="literal">User</code> object in C#. Notice how this method is similar to <code class="literal">Linq</code> in C#.</li><li class="listitem" value="3">If there are no results, we let the request execute normally.</li><li class="listitem" value="4">Otherwise, we compare the passwords and return <code class="literal">statusCodes.OK</code> if they match.</li><li class="listitem" value="5">If the passwords<a id="id521" class="calibre1"/> do not match, we return <code class="literal">statusCodes.UNAUTHORIZED</code>. This will cause the client to receive an error.</li><li class="listitem" value="6">For a complete list of available functions and methods, make sure you check out the server script reference on MSDN at <a class="calibre1" href="http://tinyurl.com/AzureMobileServices">http://tinyurl.com/AzureMobileServices</a>.</li></ol><div class="calibre13"/></div><p class="calibre8">From here, just make<a id="id522" class="calibre1"/> sure that you click on the <span class="strong"><strong class="calibre2">Save</strong></span> button to apply your changes. Azure Mobile Services also has the option of providing source control for your scripts via <span class="strong"><strong class="calibre2">Git</strong></span>. Feel free to take advantage of this feature if you want to make changes to the script in your favorite editor locally instead of the website editor.</p><p class="calibre8">After this, we need to create one more script. The way XamChat was implemented earlier in the book allows, users to add friends by entering their friends' usernames. So, in order to insert into the <code class="literal">Friend</code> table, we will need to modify the <code class="literal">insert</code> script to look up users by their usernames.</p><p class="calibre8">Let's modify the <code class="literal">insert</code> script for the <code class="literal">Friends</code> table as follows:</p><div class="informalexample"><pre class="programlisting">function insert(item, user, request) { 
  var users = tables.getTable('user');
  users.where({ username : item.Username }).read({
    success: function(results) {
      if (results.length === 0) {
        //Could not find the user
        request.respond(statusCodes.NOT_FOUND, "User not found");
      }
      else {
        var existingUser = results[0];
        item.UserId = existingUser.id;
        request.execute();
      }
    }
  });
}</pre></div><p class="calibre8">This is pretty similar<a id="id523" class="calibre1"/> to what we did before; we ran a simple query to load the <code class="literal">user</code> table based on the <code class="literal">Username</code> value. We merely have to set the <code class="literal">UserId</code> value on the new <code class="literal">friend</code> table prior to the execution of the request.</p></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding a backend to XamChat"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec60" class="calibre1"/>Adding a backend to XamChat</h1></div></div></div><p class="calibre8">With our server-side changes<a id="id524" class="calibre1"/> complete, the next step is to implement our new service in our XamChat iOS and Android applications. Luckily, as we used an interface named <code class="literal">IWebService</code>, all we need to do is implement this interface to get it working in our application.</p><p class="calibre8">Now we can start<a id="id525" class="calibre1"/> setting up our service in our iOS application by performing the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Open the <code class="literal">XamChat.Core</code> project that we created in <a class="calibre1" title="Chapter 4. XamChat – a Cross-platform App" href="part0036_split_000.html#page">Chapter 4</a>, <span class="strong"><em class="calibre12">XamChat – a Cross-platform App</em></span>.</li><li class="listitem" value="2">Create an <code class="literal">Azure</code> folder within the project.</li><li class="listitem" value="3">Create a new class named <code class="literal">AzureWebService.cs</code>.</li><li class="listitem" value="4">Create the <code class="literal">public</code> class and implement <code class="literal">IWebService</code>.</li><li class="listitem" value="5">Right-click on <code class="literal">IWebService</code> in your code and navigate to <span class="strong"><strong class="calibre2">Refactor</strong></span> | <span class="strong"><strong class="calibre2">Implement Interface</strong></span>.</li><li class="listitem" value="6">A line will appear; press <span class="strong"><em class="calibre12">Enter</em></span> to insert the method stubs.</li></ol><div class="calibre13"/></div><p class="calibre8">When this setup is complete, your class will look something similar to the following:</p><div class="informalexample"><pre class="programlisting">public class AzureWebService : IWebService
{
  #region IWebService implementation

  public Task&lt;User&gt; Login(string username, string password)
  {
    throw new NotImplementedException();
  }

  // -- More methods here -- 

  #endregion
}</pre></div></div>

<div class="book" title="Adding a backend to XamChat">
<div class="book" title="Adding the Azure Mobile Services NuGet package"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch08lvl2sec33" class="calibre1"/>Adding the Azure Mobile Services NuGet package</h2></div></div></div><p class="calibre8">To make <a id="id526" class="calibre1"/>development with Azure Mobile Services much easier, we need to add a reference to the .NET client library. To do this, we<a id="id527" class="calibre1"/> will use NuGet to add<a id="id528" class="calibre1"/> the library:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Right-click on the <code class="literal">XamChat.Core</code> project and navigate to <span class="strong"><strong class="calibre2">Add</strong></span> | <span class="strong"><strong class="calibre2">Add Packages</strong></span>.</li><li class="listitem" value="2">Search for <code class="literal">Azure Mobile Services</code> using the search box.</li><li class="listitem" value="3">Select the <code class="literal">Azure Mobile Services</code> package, which at the time of writing this book was version 1.2.5.</li><li class="listitem" value="4">Click on <span class="strong"><strong class="calibre2">Add Package</strong></span>.</li><li class="listitem" value="5">Repeat this process for the <code class="literal">XamChat.iOS</code> and <code class="literal">XamChat.Android</code> projects. There is some platform-specific setup for each platform.</li></ol><div class="calibre13"/></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip12" class="calibre1"/>Tip</h3><p class="calibre8">You can also get the Azure Mobile Services library from the Xamarin Component Store if you like. It is very similar to using NuGet.</p></div><p class="calibre8">This will download the library and automatically add references to it in your projects. The NuGet package manager might complain of warnings, which can be ignored. NuGet was originally developed for Visual Studio on Windows, so any packages that contain PowerShell scripts or prompt for a license agreement might give you a warning.</p><p class="calibre8">Now, let's modify our <code class="literal">AzureWebService.cs</code> file. Add <code class="literal">using Microsoft.WindowsAzure.MobileServices</code> to the top of the file, and then make the following changes:</p><div class="informalexample"><pre class="programlisting">public class AzureWebService : IWebService
{
  MobileServiceClient client = new MobileServiceClient("https://your-service-name.azure-mobile.net/", "your-application-key");

  // -- Existing code here --
}</pre></div><p class="calibre8">Make sure you<a id="id529" class="calibre1"/> fill in your mobile service name and application key. You can find your key on the <span class="strong"><strong class="calibre2">Dashboard</strong></span> tab of the Azure <a id="id530" class="calibre1"/>Management Portal<a id="id531" class="calibre1"/> under the <span class="strong"><strong class="calibre2">Manage Keys</strong></span> section. </p><p class="calibre8">Now let's implement our first method, <code class="literal">Login</code>, in the following manner:</p><div class="informalexample"><pre class="programlisting">public async Task&lt;User&gt; Login(string username, string password)
{
  var user = new User 
  {
    Username = username, 
    Password = password 
  };
  await client.GetTable&lt;User&gt;().InsertAsync(user);
  return user;
}</pre></div><p class="calibre8">This is fairly straightforward, because of how nice this library is to use. The <code class="literal">GetTable&lt;T&gt;</code> method knows<a id="id532" class="calibre1"/> how to use a table named <code class="literal">User</code> based on the C# class name. Upon the first call, the dynamic schema feature will create two new columns named <code class="literal">Username</code> and <code class="literal">Password</code> based on the C# properties of our class. Note that the <code class="literal">InsertAsync</code> method will also fill in the user's <code class="literal">Id</code> property for later use in our application since we will need the <code class="literal">Id</code> for future calls to the mobile service.</p><p class="calibre8">Next, open the <code class="literal">AppDelegate.cs</code> file to set up our new service and add the following code:</p><div class="informalexample"><pre class="programlisting">//Replace this line
ServiceContainer.Register&lt;IWebService&gt;(() =&gt; new FakeWebService());

//With this line
ServiceContainer.Register&lt;IWebService&gt;(() =&gt; new AzureWebService());</pre></div><p class="calibre8">Additionally, you will need to add some platform-specific setup for Azure Mobile Services. Add <code class="literal">using Microsoft.WindowsAzure.MobileServices</code> to the top of the file and add the following line of code to the bottom of <code class="literal">FinishedLaunching</code> in your <code class="literal">AppDelegate.cs</code> file:</p><div class="informalexample"><pre class="programlisting">CurrentPlatform.Init();</pre></div><p class="calibre8">Now, if you compile<a id="id533" class="calibre1"/> and run your application after you log in, your app should successfully call Azure Mobile Services and insert a new user. Navigate to the <span class="strong"><strong class="calibre2">Data</strong></span> tab of your Azure <a id="id534" class="calibre1"/>Mobile Service in the Azure Management Portal, and select the <code class="literal">User</code> table. You will see the user you just inserted, as shown<a id="id535" class="calibre1"/> in the following screenshot:</p><div class="mediaobject"><img src="../images/00062.jpeg" alt="Adding the Azure Mobile Services NuGet package" class="calibre9"/></div><p class="calibre10"> </p><div class="informalexample" title="Note"><h3 class="title2"><a id="note03" class="calibre1"/>Note</h3><p class="calibre8">It is generally a bad idea to store passwords in plain text in your database. A simple approach to make things a bit more secure would be to store them as an MD5 hash. You should be able to make this change in the custom JavaScript that we are using to insert the password on the <code class="literal">User</code> table. A complete guide to securing Windows Azure applications can be found at <a class="calibre1" href="http://msdn.microsoft.com/en-us/library/windowsazure/hh696898.aspx">http://msdn.microsoft.com/en-us/library/windowsazure/hh696898.aspx</a>.</p></div><p class="calibre8">Next, let's make a new class named <code class="literal">Friend.cs</code>. Add it to the <code class="literal">Azure</code> folder that is next to the other class specific to Azure as follows:</p><div class="informalexample"><pre class="programlisting">public class Friend
{
  public string Id { get; set; }
  public string MyId { get; set; }
  public string UserId { get; set; }
  public string Username { get; set; }
}</pre></div><p class="calibre8">We'll use this class to store the friends information about each user. Note that we also have an <code class="literal">Id</code> property, and all the classes saved in Azure Mobile Services should have a <code class="literal">string</code> property named <code class="literal">Id</code>. This will be the table's primary key in the SQL database.</p><p class="calibre8">Next, let's modify<a id="id536" class="calibre1"/> the <code class="literal">Message</code> and <code class="literal">Conversation</code> classes to<a id="id537" class="calibre1"/> prepare for push notifications down the road. Add a new property to the <code class="literal">Message</code> class as follows:</p><div class="informalexample"><pre class="programlisting">public string ToId { get; set; }</pre></div><p class="calibre8">Then, add the following new property to <code class="literal">Conversation.cs</code>:</p><div class="informalexample"><pre class="programlisting">public string MyId { get; set; }</pre></div><p class="calibre8">Here, we'll need to insert or seed some test data for our application to function correctly. The easiest way to<a id="id538" class="calibre1"/> insert data would be from C#, so let's implement the following simple method on our service to do so:</p><div class="informalexample"><pre class="programlisting">public async Task LoadData()
{
  var users = client.GetTable&lt;User&gt;();
  var friends = client.GetTable&lt;Friend&gt;();

  var me = new User
  {
    Username = "jonathanpeppers",
    Password = "password"
  };
  var friend = new User
  {
    Username = "chucknorris",
    Password = "password"
  };
  await users.InsertAsync(me);
  await users.InsertAsync(friend);
  await friends.InsertAsync(new Friend { MyId = me.Id, Username = friend.Username });
  await friends.InsertAsync(new Friend { MyId = friend.Id, Username = me.Username });
}</pre></div><p class="calibre8">Next, let's add the following method to <code class="literal">AppDelegate.cs</code> and call it from within <code class="literal">FinishedLaunching</code>:</p><div class="informalexample"><pre class="programlisting">private async void LoadData()
{
  var service = ServiceContainer.Resolve&lt;IWebService&gt;() as AzureWebService;
  await service.LoadData();
}</pre></div><p class="calibre8">If you run your application at this point, it will insert two users and make them friends with one another. Before <a id="id539" class="calibre1"/>doing so, let's add some more code to the <code class="literal">LoadData</code> method in <code class="literal">AzureWebService.cs</code> to insert conversations and <a id="id540" class="calibre1"/>messages as<a id="id541" class="calibre1"/> follows:</p><div class="informalexample"><pre class="programlisting">var conversations = client.GetTable&lt;Conversation&gt;();
var messages = client.GetTable&lt;Message&gt;();

var conversation = new Conversation
{
  MyId = me.Id,
  UserId = friend.Id,
  Username = friend.Username,
  LastMessage = "HEY!"
};
await conversations.InsertAsync(conversation);
await messages.InsertAsync(new Message { 
  ConversationId = conversation.Id, 
  ToId = me.Id,
  UserId = friend.Id, Username = friend.Username, 
  Text = "What's up?", Date = DateTime.Now.AddSeconds(-60)
});
await messages.InsertAsync(new Message { 
  ConversationId = conversation.Id, 
  ToId = friend.Id,
  UserId = me.Id, Username = me.Username, 
  Text = "Not much", Date = DateTime.Now.AddSeconds(-30)
});
await messages.InsertAsync(new Message { 
  ConversationId = conversation.Id, 
  ToId = me.Id,
  UserId = friend.Id, Username = friend.Username, 
  Text = "HEY!", Date = DateTime.Now
});</pre></div><p class="calibre8">Now, if you run the <a id="id542" class="calibre1"/>application, it will seed the database with some good data to work with. I'd recommend that you remove the call to <code class="literal">LoadData</code> once it is successful the first time, and perhaps remove the method entirely when the <a id="id543" class="calibre1"/>development is<a id="id544" class="calibre1"/> complete.</p><p class="calibre8">Before going further, let's implement the rest of our <code class="literal">IWebService</code> interface. It can be done as follows:</p><div class="informalexample"><pre class="programlisting">public async Task&lt;User&gt; Register(User user)
{
  await client.GetTable&lt;User&gt;().InsertAsync(user);
  return user;
}
public async Task&lt;User[]&gt; GetFriends(string userId)
{
  var list = await client.GetTable&lt;Friend&gt;().Where(f =&gt; f.MyId == userId).ToListAsync();
  return list.Select(f =&gt; new User { Id = f.UserId, Username = f.Username }).ToArray();
}
public async Task&lt;User&gt; AddFriend( string userId, string username)
{
  var friend = new Friend { MyId = userId, Username = username };
  await client.GetTable&lt;Friend&gt;().InsertAsync(friend);
  return new User { Id = friend.UserId, Username = friend.Username };
}</pre></div><p class="calibre8">Each method here is pretty simple. <code class="literal">Register</code> is very similar to <code class="literal">Login</code>, but the main complication for the other methods is the need to convert a <code class="literal">Friend</code> object to <code class="literal">User</code>. We used the <a id="id545" class="calibre1"/><code class="literal">ToListAsync</code> method from the Azure library to get <code class="literal">List&lt;T&gt;</code>; however, since our interface uses<a id="id546" class="calibre1"/> arrays, we quickly converted the list to an array. We also utilized a couple of basic <code class="literal">Linq</code> operators such as <code class="literal">Where</code> and <code class="literal">Select</code> to accomplish our implementation<a id="id547" class="calibre1"/> of <code class="literal">IWebService</code>.</p><p class="calibre8">Now let's complete the methods related to conversations and messages, which are as follows:</p><div class="informalexample"><pre class="programlisting">public async Task&lt;Conversation[]&gt; GetConversations(string userId)
{
  var list = await client.GetTable&lt;Conversation&gt;().Where(c =&gt; c.MyId == userId).ToListAsync();
  return list.ToArray();
}
public async Task&lt;Message[]&gt; GetMessages(string conversationId)
{
  var list = await client.GetTable&lt;Message&gt;().Where(m =&gt; m.ConversationId == conversationId).ToListAsync();
  return list.ToArray();
}
public async Task&lt;Message&gt; SendMessage(Message message)
{
  await client.GetTable&lt;Message&gt;().InsertAsync(message);
  return message;
}</pre></div><p class="calibre8">This completes <a id="id548" class="calibre1"/>our implementation of <code class="literal">IWebService</code>. If you run the application at this point, it will function exactly as before with the exception that the app is actually talking to a real web server. New messages will get persisted in the SQL database, and our custom scripts will handle the custom logic that we need. Feel free to play around with our implementation; you might discover some features of Azure Mobile Services that will work great with your own applications.</p><p class="calibre8">At this point, another good exercise would be to set up Azure Mobile Services in our Android application. To do so, you will merely need to add the Azure Mobile Services NuGet package. After that, you should be able to swap out the <code class="literal">ServiceContainer.Register</code> call in your <code class="literal">Application</code> class and call <code class="literal">CurrentPlatform.Init()</code>. Everything will function exactly like on iOS. Isn't cross-platform development great?</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Using the Apple Push Notification service"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec61" class="calibre1"/>Using the Apple Push Notification service</h1></div></div></div><p class="calibre8">Implementing push notifications with Azure Mobile Services on iOS is very simple to set up from an <a id="id549" class="calibre1"/>Azure backend perspective. The most complicated part is working through Apple's process of creating certificates and provisioning profiles in order to configure your iOS application. Before we continue, make sure you have a valid iOS Developer Program account, as you will not be able to send <a id="id550" class="calibre1"/>push notifications without one. If you are unfamiliar with the concept of push notifications, take a look at <a id="id551" class="calibre1"/>Apple's documentation at <a class="calibre1" href="http://tinyurl.com/XamarinAPNS">http://tinyurl.com/XamarinAPNS</a>.</p><p class="calibre8">To send push notifications, you<a id="id552" class="calibre1"/> need to set up the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">An explicit App ID registered with Apple</li><li class="listitem">A provisioning profile targeting that App ID</li><li class="listitem">A certificate for your server to trigger the push notification</li></ul></div><p class="calibre8">Apple provides both a development and production certificate that you can use to send push notifications from your server.</p></div>

<div class="book" title="Using the Apple Push Notification service">
<div class="book" title="Setting up proper provisioning"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch08lvl2sec34" class="calibre1"/>Setting up proper provisioning</h2></div></div></div><p class="calibre8">Let's begin by navigating to <a class="calibre1" href="http://developer.apple.com/account">http://developer.apple.com/account</a> and performing the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Click<a id="id553" class="calibre1"/> on the <span class="strong"><strong class="calibre2">Identifiers</strong></span> link.</li><li class="listitem" value="2">Click on the plus button in the top-right corner of the window.</li><li class="listitem" value="3">Enter a description, such as <code class="literal">XamChat</code>, for the bundle ID.</li><li class="listitem" value="4">Enter your bundle ID under the <span class="strong"><strong class="calibre2">Explicit App ID</strong></span> section. This should match the bundle ID you set up in your <code class="literal">Info.plist</code> file, for example, <code class="literal">com.yourcompanyname.xamchat</code>.</li><li class="listitem" value="5">Under <span class="strong"><strong class="calibre2">App Services</strong></span>, make sure you check <span class="strong"><strong class="calibre2">Push Notifications</strong></span>.</li><li class="listitem" value="6">Now, click on <span class="strong"><strong class="calibre2">Continue</strong></span>.</li><li class="listitem" value="7">Review your final settings and hit <span class="strong"><strong class="calibre2">Submit</strong></span>.</li></ol><div class="calibre13"/></div><p class="calibre8">This will create an<a id="id554" class="calibre1"/> explicit App ID similar to what you can see in the following screenshot, which we can use for sending push notifications:</p><div class="mediaobject"><img src="../images/00063.jpeg" alt="Setting up proper provisioning" class="calibre9"/></div><p class="calibre10"> </p></div></div>

<div class="book" title="Using the Apple Push Notification service">
<div class="book" title="Setting up your provisioning profile"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch08lvl2sec35" class="calibre1"/>Setting up your provisioning profile</h2></div></div></div><p class="calibre8">For push<a id="id555" class="calibre1"/> notifications, we have to<a id="id556" class="calibre1"/> use a profile with an explicit App ID that is not a development certificate. Now let's set up a provisioning profile:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Click on the <span class="strong"><strong class="calibre2">Development</strong></span> link under <span class="strong"><strong class="calibre2">Provisioning Profiles</strong></span> in the right-hand side pane.</li><li class="listitem" value="2">Click on the plus button in the top-right corner.</li><li class="listitem" value="3">Check <span class="strong"><strong class="calibre2">iOS App Development</strong></span> and click on <span class="strong"><strong class="calibre2">Continue</strong></span>.</li><li class="listitem" value="4">Select the App ID we just created and click on <span class="strong"><strong class="calibre2">Continue</strong></span>.</li><li class="listitem" value="5">Select the developer and click on <span class="strong"><strong class="calibre2">Continue</strong></span>.</li><li class="listitem" value="6">Select the devices you will be using and click on <span class="strong"><strong class="calibre2">Continue</strong></span>.</li><li class="listitem" value="7">Enter a name for the profile and click on <span class="strong"><strong class="calibre2">Generate</strong></span>.</li><li class="listitem" value="8">Download the profile and install it, or open<a id="id557" class="calibre1"/> <span class="strong"><strong class="calibre2">XCode</strong></span> and use the sync button by navigating to <span class="strong"><strong class="calibre2">Preferences</strong></span> | <span class="strong"><strong class="calibre2">Accounts</strong></span>.</li></ol><div class="calibre13"/></div><p class="calibre8">When finished, you <a id="id558" class="calibre1"/>should arrive at a <a id="id559" class="calibre1"/>success web page that looks similar to the following screenshot:</p><div class="mediaobject"><img src="../images/00064.jpeg" alt="Setting up your provisioning profile" class="calibre9"/></div><p class="calibre10"> </p></div></div>

<div class="book" title="Using the Apple Push Notification service">
<div class="book" title="Setting up a certificate signing request"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch08lvl2sec36" class="calibre1"/>Setting up a certificate signing request</h2></div></div></div><p class="calibre8">Next, we perform<a id="id560" class="calibre1"/> the following <a id="id561" class="calibre1"/>steps to set up the certificate our server needs:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Click on the <span class="strong"><strong class="calibre2">Development</strong></span> link under <span class="strong"><strong class="calibre2">Certificates</strong></span> in the right-hand side pane.</li><li class="listitem" value="2">Click on the plus button in the top-right corner.</li><li class="listitem" value="3">Enable <span class="strong"><strong class="calibre2">Apple Push Notifications service SSL (Sandbox)</strong></span> and click on <span class="strong"><strong class="calibre2">Continue</strong></span>.</li><li class="listitem" value="4">Select your App ID as before and click on <span class="strong"><strong class="calibre2">Continue</strong></span>.</li><li class="listitem" value="5">Create a new certificate signing request as per Apple's instructions. You can also refer to <a class="calibre1" title="Chapter 7. Deploying and Testing on Devices" href="part0056_split_000.html#page">Chapter 7</a>, <span class="strong"><em class="calibre12">Deploying and Testing on Devices</em></span>, or locate the <code class="literal">*.certSigningRequest</code> file.</li><li class="listitem" value="6">Next, click on <span class="strong"><strong class="calibre2">Continue</strong></span>.</li><li class="listitem" value="7">Upload the <a id="id562" class="calibre1"/>signing request file and click on <span class="strong"><strong class="calibre2">Generate</strong></span>.</li><li class="listitem" value="8">Next, click on <span class="strong"><strong class="calibre2">Download</strong></span>.</li><li class="listitem" value="9">Open the file to import the certificate into <span class="strong"><strong class="calibre2">Keychain</strong></span>.</li><li class="listitem" value="10">Locate the certificate in <span class="strong"><strong class="calibre2">Keychain</strong></span>. It will be titled <span class="strong"><strong class="calibre2">Apple Development iOS Push Services</strong></span> and will <a id="id563" class="calibre1"/>contain your bundle ID.</li><li class="listitem" value="11">Right-click on the certificate and export it somewhere on your filesystem. Enter a password that you will remember.</li></ol><div class="calibre13"/></div><p class="calibre8">This will create the certificate that we need to send push notifications to our users from Azure Mobile Services. All that remains is to return to the Azure Management Portal and upload the certificate from the <span class="strong"><strong class="calibre2">Push</strong></span> tab under <span class="strong"><strong class="calibre2">Apple Push Notification Settings</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00065.jpeg" alt="Setting up a certificate signing request" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">This upload concludes<a id="id564" class="calibre1"/> the configuration<a id="id565" class="calibre1"/> we need from Apple's side.</p></div></div>

<div class="book" title="Using the Apple Push Notification service">
<div class="book" title="Making client-side changes for push notifications"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch08lvl2sec37" class="calibre1"/>Making client-side changes for push notifications</h2></div></div></div><p class="calibre8">Next, let's return to our <code class="literal">XamChat.iOS</code> project in Xamarin Studio to make the necessary changes on the client<a id="id566" class="calibre1"/> side for push notifications. We will need to add a few new classes to our shared code to start with.</p><p class="calibre8">Open <code class="literal">IWebService.cs</code> and add the following new method:</p><div class="informalexample"><pre class="programlisting">Task RegisterPush(string userId, string deviceToken);</pre></div><p class="calibre8">Next, let's implement this method in <code class="literal">FakeWebService.cs</code> (just so it compiles) as follows:</p><div class="informalexample"><pre class="programlisting">public async Task RegisterPush(string userId, string deviceToken)
{
  await Sleep();
}</pre></div><p class="calibre8">Now, let's add a new class named <code class="literal">Device.cs</code> in the <code class="literal">Core</code>/<code class="literal">Azure</code> folder:</p><div class="informalexample"><pre class="programlisting">public class Device
{
  public string Id { get; set;}
  public string UserId { get; set; }
  public string DeviceToken { get; set; }
}</pre></div><p class="calibre8">Finally, we can implement the real method in <code class="literal">AzureWebService.cs</code> as follows:</p><div class="informalexample"><pre class="programlisting">public async Task RegisterPush( string userId, string deviceToken)
{
  await client.GetTable&lt;Device&gt;().InsertAsync(new Device {
      UserId = userId,
      DeviceToken = deviceToken
    });
}</pre></div><p class="calibre8">As for ViewModels, we need to add one more new method to <code class="literal">LoginViewModel.cs</code>:</p><div class="informalexample"><pre class="programlisting">public async Task RegisterPush(string deviceToken)
{
  if (settings.User == null)
    throw new Exception("User is null");
  await service.RegisterPush(settings.User.Id, deviceToken);
}</pre></div><p class="calibre8">Then, we <a id="id567" class="calibre1"/>need to add a small modification to <code class="literal">MessageViewModel.cs</code>. Add the following line when creating a new <code class="literal">Message</code> object in the <code class="literal">SendMessage</code> method:</p><div class="informalexample"><pre class="programlisting">ToId = Conversation.UserId,</pre></div><p class="calibre8">This modification concludes what we need to add to our shared code. We will reuse this new functionality when we add push notifications to Android, so go ahead and take the time to link in the new <code class="literal">Device.cs</code> file in your <code class="literal">XamChat.Droid</code> project to build your entire solution.</p><p class="calibre8">Now, let's add the iOS platform-specific code we need. Add the following methods to your <code class="literal">AppDelegate.cs</code> file:</p><div class="informalexample"><pre class="programlisting">public async override void RegisteredForRemoteNotifications(UIApplication application, NSData deviceToken)
{
  var loginViewModel = ServiceContainer.Resolve&lt;LoginViewModel&gt;();
  try
  {
    string token = deviceToken.Description;
    token = token.Substring(1, token.Length - 2);
    await loginViewModel.RegisterPush(token);
  }
  catch (Exception exc)
  {
    Console.WriteLine("Error registering push: " + exc);
  }
}
public override void FailedToRegisterForRemoteNotifications(UIApplication application, NSError error)
{
  Console.WriteLine("Error registering push: " + error.LocalizedDescription);
}</pre></div><p class="calibre8">We implemented a couple of important methods in the preceding code snippet. <code class="literal">RegisteredForRemoteNotifications</code> will occur when Apple successfully returns a device token<a id="id568" class="calibre1"/> from its servers. It is returned within angle brackets, so we do a little work to trim those off and pass the device token through <code class="literal">LoginViewModel</code> to Azure Mobile Services. We also implemented <code class="literal">FailedToRegisterForRemoteNotifications</code> just to report any errors that might occur throughout the process.</p><p class="calibre8">One last thing to do is to actually make a call to register for remote notifications. Open <code class="literal">LoginController.cs</code> and add the following line of code directly after the successful call to log in:</p><div class="informalexample"><pre class="programlisting">UIApplication.SharedApplication.RegisterForRemoteNotificationTypes( 
UIRemoteNotificationType.Alert | 
UIRemoteNotificationType.Badge | 
UIRemoteNotificationType.Sound);</pre></div><p class="calibre8">You can also call the method on startup; however, in our situation, we need a valid user ID to store in the <code class="literal">Device</code> table in Azure.</p><p class="calibre8">Now let's switch to the Azure Management Portal and make the remaining changes in JavaScript on the server side. Under the <span class="strong"><strong class="calibre2">Data</strong></span> tab, create a new table named <code class="literal">Device</code> with the default settings.</p><p class="calibre8">Next, we need to modify the <code class="literal">insert</code> script so that the duplicate device tokens are not inserted:</p><div class="informalexample"><pre class="programlisting">function insert(item, user, request)
{
  var devicesTable = tables.getTable('device');
  devicesTable.where({ userId: item.UserId, deviceToken: item.DeviceToken }).read({ success: function (devices)
    {
      if (devices.length &gt; 0)
      {
        request.respond(200, devices[0]);
      }
      else
      {
        request.execute();
      }
    }
  });
}</pre></div><p class="calibre8">Last but not least, we need to modify the <code class="literal">insert</code> script for the <code class="literal">Message</code> table to send push notifications to<a id="id569" class="calibre1"/> the user. The message was sent as follows:</p><div class="informalexample"><pre class="programlisting">function insert(item, user, request) {
  request.execute();
  var devicesTable = tables.getTable('device');
  devicesTable.where({ userId : item.ToId }).read({
    success: function(devices) {
      devices.forEach(function(device) {
        var text = item.Username + ": " + item.Text;
        push.apns.send(device.DeviceToken, {
          alert: text,
          badge: 1,
          payload: {
            message: text
          }
        });
      });
    }
  });
}</pre></div><p class="calibre8">After executing the request, we retrieve a list of devices from the database and send out a push notification for each one. To test push notifications, deploy the application and log in with the secondary user (if using our examples: <code class="literal">chucknorris</code>). After logging in, you can just background the app with the home button. Next, log in with the primary user on your iOS simulator<a id="id570" class="calibre1"/> and send a message. You should receive a push notification, as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00066.jpeg" alt="Making client-side changes for push notifications" class="calibre9"/></div><p class="calibre10"> </p></div></div>
<div class="book" title="Implementing Google Cloud Messaging"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec62" class="calibre1"/>Implementing Google Cloud Messaging</h1></div></div></div><p class="calibre8">Since we have already <a id="id571" class="calibre1"/>set up everything we need in the shared code and on Azure, setting up push notifications for Android will be a lot less work at this point of time. To continue, you will need a Google account with a verified e-mail address; however, I would recommend that you use an account registered with <span class="strong"><strong class="calibre2">Google Play</strong></span> if you have one. You can refer to the full documentation on<a id="id572" class="calibre1"/> <span class="strong"><strong class="calibre2">Google Cloud Messaging</strong></span> (<span class="strong"><strong class="calibre2">GCM</strong></span>) at <a class="calibre1" href="http://developer.android.com/google/gcm">http://developer.android.com/google/gcm</a>.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note04" class="calibre1"/>Note</h3><p class="calibre8">Note that Google Cloud Messaging requires that Google Play be installed on the Android device and that the Android OS be at least version 2.2.</p></div><p class="calibre8">Let's begin by <a id="id573" class="calibre1"/>navigating to <a class="calibre1" href="http://cloud.google.com/console">http://cloud.google.com/console</a> and performing the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Click on the <span class="strong"><strong class="calibre2">Create Project</strong></span> button.</li><li class="listitem" value="2">Enter an appropriate project name such as <code class="literal">XamChat</code>.</li><li class="listitem" value="3">Enter a project ID; you can use the generated one. I prefer to use my application's bundle ID and replace the periods with hyphens.</li><li class="listitem" value="4">Agree to the <span class="strong"><strong class="calibre2">Terms of Service</strong></span>.</li><li class="listitem" value="5">Click on the <span class="strong"><strong class="calibre2">Create</strong></span> button.</li><li class="listitem" value="6">When creating your first project, you might have to verify the mobile number associated with your account.</li><li class="listitem" value="7">Note the <span class="strong"><strong class="calibre2">Project Number</strong></span> field on the <span class="strong"><strong class="calibre2">Overview</strong></span> page. We will need this number later.</li></ol><div class="calibre13"/></div><p class="calibre8">The following screenshot shows the <span class="strong"><strong class="calibre2">Overview</strong></span> tab:</p><div class="mediaobject"><img src="../images/00067.jpeg" alt="Implementing Google Cloud Messaging" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">Now we can continue with our setup as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Click on <span class="strong"><strong class="calibre2">APIs &amp; auth</strong></span> in the left-hand side pane.</li><li class="listitem" value="2">Scroll down and click on <span class="strong"><strong class="calibre2">Google Cloud Messaging for Android</strong></span>.</li><li class="listitem" value="3">Click<a id="id574" class="calibre1"/> on the <span class="strong"><strong class="calibre2">OFF</strong></span> button at the top to enable the service. You might have to accept another agreement.</li><li class="listitem" value="4">Click on <span class="strong"><strong class="calibre2">Registered Apps</strong></span> in the left-hand side pane.</li><li class="listitem" value="5">Click on the <span class="strong"><strong class="calibre2">Register App</strong></span> button at the top.</li><li class="listitem" value="6">Enter <code class="literal">XamChat</code> in the <span class="strong"><strong class="calibre2">App Name</strong></span> field and click on <span class="strong"><strong class="calibre2">Register</strong></span>. You can leave the <span class="strong"><strong class="calibre2">Platform</strong></span> selection on <span class="strong"><strong class="calibre2">Web Application</strong></span> at its default value.</li><li class="listitem" value="7">Expand the <span class="strong"><strong class="calibre2">Server Key</strong></span> section and copy the <span class="strong"><strong class="calibre2">API Key</strong></span> value to your clipboard.</li><li class="listitem" value="8">Switch to the Azure Management Portal and navigate to the <span class="strong"><strong class="calibre2">Push</strong></span> tab in your Azure Mobile Service instance.</li><li class="listitem" value="9">Paste the API key in the <span class="strong"><strong class="calibre2">google cloud messaging settings</strong></span> section and click on <span class="strong"><strong class="calibre2">Save</strong></span>.</li></ol><div class="calibre13"/></div><div class="mediaobject"><img src="../images/00068.jpeg" alt="Implementing Google Cloud Messaging" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">Next, let's modify our <code class="literal">insert</code> script for the <code class="literal">Message</code> table to support Android as follows:</p><div class="informalexample"><pre class="programlisting">function insert(item, user, request) {
  request.execute();
  var devicesTable = tables.getTable('device');
  devicesTable.where({ userId : item.ToId }).read({
    success: function(devices) {
      devices.forEach(function(device) {
        if (device.DeviceToken.length &gt; 72) {
          push.gcm.send(device.DeviceToken, {
            title: item.Username, 
            message: item.Text, 
          });
        }
        else {
          var text = item.Username + ": " + item.Text;
          push.apns.send(device.DeviceToken, {
            alert: text,
            badge: 1,
            payload: {
              message: text
            }
          });
        }
      });
    }
  });
}</pre></div><p class="calibre8">Basically, we send any <code class="literal">deviceToken</code> values that are longer than 72 characters to GCM. This is one simple way to do it, but you can also add a value to the <code class="literal">Device</code> table that indicates <a id="id575" class="calibre1"/>whether the device is Android or iOS. GCM also supports sending custom values to be displayed in the notification area, so we send an actual title along with the message.</p><p class="calibre8">This completes our setup on Azure's side. Setting up the next part in our Android application can be a bit difficult, so we will use a library called <a id="id576" class="calibre1"/><span class="strong"><strong class="calibre2">PushSharp</strong></span> to simplify our implementation.</p><p class="calibre8">First, navigate to <a class="calibre1" href="http://github.com/Redth/PushSharp">http://github.com/Redth/PushSharp</a> and perform<a id="id577" class="calibre1"/> the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Download the project and place it in the same folder as your XamChat solution.</li><li class="listitem" value="2">Add the <code class="literal">PushSharp.Client.MonoForAndroid.Gcm</code> project to your solution. You can locate the project in the <code class="literal">PushSharp.Client</code> subdirectory.</li><li class="listitem" value="3">Reference the new project from your <code class="literal">XamChat.Droid</code> project.</li><li class="listitem" value="4">If it's not already installed, you will need to install the <span class="strong"><strong class="calibre2">Android SDK Platform</strong></span> for<a id="id578" class="calibre1"/> Android 2.2 (API 8). You can install this from the Android SDK manager that can be launched from the <span class="strong"><strong class="calibre2">Tools</strong></span> menu in Xamarin Studio.</li></ol><div class="calibre13"/></div><p class="calibre8">Next, create a new class called <code class="literal">PushConstants.cs</code> as follows:</p><div class="informalexample"><pre class="programlisting">public static class PushConstants
{
  public const string BundleId = "your-bundle-id";
  public const string ProjectNumber = "your-project-number";
}</pre></div><p class="calibre8">Fill out the <code class="literal">BundleId</code> value with your application's bundle ID and the <code class="literal">ProjectNumber</code> value with the <a id="id579" class="calibre1"/>project number found on the <span class="strong"><strong class="calibre2">Overview</strong></span> page of your Google Cloud Console.</p><p class="calibre8">Next, we need to set up some permissions to support push notifications in our application. Above the namespace declaration in this file, add the following:</p><div class="informalexample"><pre class="programlisting">[assembly: Permission(
  Name = XamChat.Droid.PushConstants.BundleId + 
  ".permission.C2D_MESSAGE")]
[assembly: UsesPermission(
  Name = XamChat.Droid.PushConstants.BundleId + 
  ".permission.C2D_MESSAGE")]
[assembly: UsesPermission(
  Name = "com.google.android.c2dm.permission.RECEIVE")]
[assembly: UsesPermission(
  Name = "android.permission.GET_ACCOUNTS")]
[assembly: UsesPermission(
  Name = "android.permission.INTERNET")]
[assembly: UsesPermission(
  Name = "android.permission.WAKE_LOCK")]
</pre></div><p class="calibre8">You can also make these changes in our <code class="literal">AndroidManifest.xml</code> file; however, using C# attributes can be better since it gives you the ability to use code completion while typing.</p><p class="calibre8">Next, create another new class named <code class="literal">PushReceiver.cs</code> as follows:</p><div class="informalexample"><pre class="programlisting">[BroadcastReceiver(
  Permission = GCMConstants.PERMISSION_GCM_INTENTS)]
[IntentFilter(
  new string[] { GCMConstants.INTENT_FROM_GCM_MESSAGE }, 
  Categories = new string[] { PushConstants.BundleId })]
[IntentFilter(
  new string[] { 
  GCMConstants.INTENT_FROM_GCM_REGISTRATION_CALLBACK }, 
  Categories = new string[] { PushConstants.BundleId })]
[IntentFilter(
  new string[] { 
  GCMConstants.INTENT_FROM_GCM_LIBRARY_RETRY }, 
  Categories = new string[] { PushConstants.BundleId })]
public class PushReceiver :
  PushHandlerBroadcastReceiverBase&lt;PushHandlerService&gt;
{ }
</pre></div><p class="calibre8">The <code class="literal">PushReceiver.cs</code> class sets up <code class="literal">BroadcastReceiver</code>, which is Android's native way for different <a id="id580" class="calibre1"/>applications to talk with one another. For more information on this topic, check out the<a id="id581" class="calibre1"/> Android documentation at <a class="calibre1" href="http://developer.android.com/reference/android/content/BroadcastReceiver.html">http://developer.android.com/reference/android/content/BroadcastReceiver.html</a>.</p><p class="calibre8">Next, create one last class named <code class="literal">PushService.cs</code> as follows:</p><div class="informalexample"><pre class="programlisting">[Service]
public class PushHandlerService : PushHandlerServiceBase
{
  public PushHandlerService() : base (PushConstants.ProjectNumber) 
  { }
}</pre></div><p class="calibre8">Now, right-click on <code class="literal">PushHandlerServiceBase</code> and navigate to <span class="strong"><strong class="calibre2">Refactor</strong></span> | <span class="strong"><strong class="calibre2">Implement abstract members</strong></span>. Next, let's implement each member one by one:</p><div class="informalexample"><pre class="programlisting">protected async override void OnRegistered (Context context, string registrationId)
{
  Console.WriteLine("Push successfully registered!");
  var loginViewModel = ServiceContainer.Resolve&lt;LoginViewModel&gt;();
  try
  {
    await loginViewModel.RegisterPush(registrationId);
  }
  catch (Exception exc)
  {
    Console.WriteLine("Error registering push: " + exc);
  }
}</pre></div><p class="calibre8">The preceding code is very similar to what we did on iOS. We merely have to send the <code class="literal">registrationId</code> value to <code class="literal">loginViewModel</code>.</p><p class="calibre8">Next, we have<a id="id582" class="calibre1"/> to write the following code when the message is received:</p><div class="informalexample"><pre class="programlisting">protected override void OnMessage (Context context, Intent intent)
{
  //Pull out the notification details
  string title = intent.Extras.GetString("title");
  string message = intent.Extras.GetString("message");

  //Create a new intent
  intent = new Intent(this, typeof(ConversationsActivity));

  //Create the notification
  var notification = new Notification(Android.Resource.Drawable.SymActionEmail, title);
  notification.Flags = NotificationFlags.AutoCancel;
  notification.SetLatestEventInfo(this, 
    new Java.Lang.String(title), 
    new Java.Lang.String(message), PendingIntent.GetActivity(this, 0, intent, 0));

  //Send the notification through the NotificationManager
  var notificationManager = GetSystemService(Context.NotificationService) as NotificationManager;
  notificationManager.Notify(1, notification);
}</pre></div><p class="calibre8">This code will actually pull out the values from the notification and display them in the notification center of the Android device. We used the built-in resource for <code class="literal">SymActionEmail</code> to display an e-mail icon in the notification.</p><p class="calibre8">Next, we just need to implement two more abstract methods. For now, let's just use <code class="literal">Console.WriteLine</code> to report these events as follows:</p><div class="informalexample"><pre class="programlisting">protected override void OnUnRegistered(Context context, string registrationId)
{
  Console.WriteLine("Push unregistered!");
}

protected override void OnError (Context context, string errorId)
{
  Console.WriteLine("Push error: " + errorId);
}</pre></div><p class="calibre8">Down the road, you should consider removing registrations from the <code class="literal">Device</code> table in Azure when <code class="literal">OnUnRegistered</code> is called. Occasionally, a user's <code class="literal">registrationId</code> will change, so this is the place where your application is notified of this change.</p><p class="calibre8">Next, open <code class="literal">Application.cs</code> and add the following lines to the end of <code class="literal">OnCreate</code>:</p><div class="informalexample"><pre class="programlisting">PushClient.CheckDevice(this);
PushClient.CheckManifest(this);</pre></div><p class="calibre8">Next, open <code class="literal">LoginActivity.cs</code> and add the following line after a successful login:</p><div class="informalexample"><pre class="programlisting">PushClient.Register(this, PushConstants.ProjectNumber);</pre></div><p class="calibre8">Now if you<a id="id583" class="calibre1"/> repeat the steps for testing push notifications on iOS, you should be able to send a push notification to our Android app. Even better, you should be able to send push notifications across platforms, since an iOS user can send a message to an Android user.</p><div class="mediaobject"><img src="../images/00069.jpeg" alt="Implementing Google Cloud Messaging" class="calibre9"/></div><p class="calibre10"> </p></div>
<div class="book" title="Summary"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec63" class="calibre1"/>Summary</h1></div></div></div><p class="calibre8">In this chapter, we went through what Windows Azure provides: Infrastructure as a Service and Platform as a Service. We set up a free Windows Azure account and set up an Azure Mobile Services instance. Next, we created all the tables we needed to store our data and wrote a few scripts to add the business logic to the web service. We implemented the client-side code for making requests against Azure Mobile Services. Lastly, we implemented push notifications for iOS using the Apple Push Notification Service and for Android using Google Cloud Messaging.</p><p class="calibre8">Using Azure Mobile Services, we were able to get by without writing much of the server-side code—mainly a few simple scripts. It would be pretty challenging to implement push notifications yourself instead of leveraging Azure's functionality for this. In the next chapter, we'll explore how to use third-party libraries with Xamarin. This includes everything from the Xamarin Component Store to using native Objective-C or Java libraries.</p></div></body></html>