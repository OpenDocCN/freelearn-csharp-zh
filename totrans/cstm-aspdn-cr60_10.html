<html><head></head><body>
		<div id="_idContainer042">
			<h1 id="_idParaDest-86"><em class="italic"><a id="_idTextAnchor156"/>Chapter 10</em>: Customizing ASP.NET Core Identity</h1>
			<p>In this tenth chapter, we are going to learn how to customize ASP.NET Core Identity. Security is one of the most important aspects of an application. Microsoft ships ASP.NET Core Identity as part of the ASP.NET Core framework to add authentication and user management to ASP.NET Core applications. </p>
			<p>In this chapter, you will learn how to customize the basic implementation of the ASP.NET Core Identity UI and how to add custom information to <strong class="bold">IdentityUser</strong>. We'll cover the following points:</p>
			<ul>
				<li>Introducing ASP.Net Core Identity</li>
				<li>Customizing IdentityUser</li>
				<li>Customizing the Identity views </li>
			</ul>
			<p>The topics of this chapter relate to the MVC layer of the ASP.NET Core architecture:</p>
			<div>
				<div id="_idContainer033" class="IMG---Figure">
					<img src="image/Figure_10.1_B17996.jpg" alt="Figure 10.1 – ASP.NET Core architecture"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.1 – ASP.NET Core architecture</p>
			<h1 id="_idParaDest-87"><a id="_idTextAnchor157"/>Technical requirements</h1>
			<p>To follow the exercises in this chapter, you will need to create an ASP.NET Core MVC application. Open your console, shell, or Bash terminal and change to your working directory. Use the following command to create a new MVC application:</p>
			<p class="source-code">dotnet new mvc -n AuthSample -o AuthSample --auth Individual</p>
			<p>Now, open the project in Visual Studio by double-clicking the project file, or open it in Visual Studio Code by typing the following command in the already-open console:</p>
			<p class="source-code">cd AuthSample</p>
			<p class="source-code">code .</p>
			<p>All of the code samples for this chapter can be found in the GitHub repo for this book: <a href="https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter10">https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter10</a>.</p>
			<h1 id="_idParaDest-88">I<a id="_idTextAnchor158"/><a id="_idTextAnchor159"/>ntroducing ASP.NET Core Identity</h1>
			<p>An <strong class="bold">identity</strong> is basically an object that represents a user but could be a group as well. It is an object that helps <a id="_idIndexMarker145"/>you to know your user and their rights. An identity can have roles assigned that represent those rights. For example, a role called <strong class="source-inline">writer</strong> tells the application that the identity is allowed to write something. Identities can be nested as well. A user can be part of a group, and a group can be part of another group, and so forth.</p>
			<p>ASP.NET Core Identity is a framework that structures this concept in .NET objects to help you store and read the user information.  The framework also provides a mechanism to add a login form, a registration form, session handling, and so on. It also helps you to store the credentials in an encrypted and secure way.</p>
			<p>ASP.NET Core Identity provides multiple ways to authenticate your users:</p>
			<ul>
				<li><strong class="bold">Individual</strong>: The application manages the identities on its own. It has a database where user information <a id="_idIndexMarker146"/>is stored and manages the login, logout, registration, and so on on its own.</li>
				<li><strong class="bold">IndividualB2C</strong>: Manages the user data on its own, but gets it from Azure B2C.</li>
				<li><strong class="bold">SingleOrg</strong>: The identities get managed by Azure <strong class="bold">Active Directory</strong> (<strong class="bold">AD</strong>); the login, logout, and so <a id="_idIndexMarker147"/>on are done by Azure AD. The application just gets a ready-to-use identity from the web server.</li>
				<li><strong class="bold">MultiOrg</strong>: Same as the previous but enabled for multiple Azure AD organizations.</li>
				<li><strong class="bold">Windows</strong>: This means the classical Windows authentication, which is only available if <a id="_idIndexMarker148"/>the application is hosted with IIS. The user also gets a ready-to-use identity from the web server.</li>
			</ul>
			<p>This chapter is not about the different ways to authenticate because this topic would fill an entire book.</p>
			<p>Let's explore an application with <strong class="bold">individual</strong> authentication enabled.</p>
			<p>As you might remember from the technical requirements, the <strong class="source-inline">--auth</strong> flag is used to create the <a id="_idIndexMarker149"/>application. It is set to <strong class="source-inline">Individual</strong> to create an ASP.NET Core MVC application with individual authentication enabled. This means it comes with a database to store the users. The <strong class="source-inline">--auth</strong> flag adds all the relevant code and dependencies to enable authentication in your freshly created application.</p>
			<div>
				<div id="_idContainer034" class="IMG---Figure">
					<img src="image/Figure_10.2_B17996.jpg" alt="Figure 10.2 – Layout reference for the ASP.NET Identity UI"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.2 – Layout reference for the ASP.NET Identity UI</p>
			<p>The <strong class="source-inline">--auth</strong> flag creates an area called <strong class="source-inline">Identity</strong> that contains a <strong class="source-inline">_ViewStart.cshtml</strong> file, which references the <strong class="source-inline">_Layout.cshtml</strong> file of the new project. The actual login <a id="_idIndexMarker150"/>or register screens are provided in a compiled library that is referenced to this project.</p>
			<p>The AUTHSAMPLE contains a <strong class="source-inline">Data</strong> folder that contains an Entity Framework Core DbContext, as well as a database migration to create and update the database that is used here.</p>
			<p>All the other parts, except <strong class="source-inline">Program.cs</strong>, are completely the same as in regular MVC applications.</p>
			<p>If you created the application using the .NET CLI as shown in the technical requirements, a <strong class="bold">SQLite</strong> database is used. If you used Visual <a id="_idIndexMarker151"/>Studio to create this application, SQL Server is used to store the user data.</p>
			<p>Before starting the application, call the following command in the terminal:</p>
			<p class="source-code">dotnet ef database update</p>
			<p>This will create and update the database.</p>
			<p>If it doesn't work, you might need to install the Entity Framework tool in the .NET CLI first:</p>
			<p class="source-code">dotnet tool install -g dotnet-ef</p>
			<p>Then, call the following:</p>
			<p class="source-code">dotnet watch</p>
			<p>The application will now <a id="_idIndexMarker152"/>start up in watch mode with hot-reload enabled. It will also open a browser window and call the application:</p>
			<div>
				<div id="_idContainer035" class="IMG---Figure">
					<img src="image/Figure_10.3_B17996.jpg" alt="Figure 10.3 – AuthSample home page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.3 – AuthSample home page</p>
			<p>As you can see, there is a menu on the upper right-hand side with the <strong class="bold">Register</strong> and <strong class="bold">Login</strong> options for this application. A click on the <strong class="bold">Login</strong> link takes you to the following login screen:</p>
			<div>
				<div id="_idContainer036" class="IMG---Figure">
					<img src="image/Figure_10.4_B17996.jpg" alt="Figure 10.4 – Login screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.4 – Login screen</p>
			<p>As mentioned, this view comes from a compiled Razor library that provides the necessary view to the Identity area. We automatically get this UI from the framework.</p>
			<p>As the last thing in this section, we should have a quick look into <strong class="source-inline">Program.cs</strong>, which also differs <a id="_idIndexMarker153"/>from the files we saw in the last chapters.</p>
			<p>In the upper section, where the services are registered, there are lines of code to register <strong class="source-inline">DbContext</strong> as well as database exception pages:</p>
			<p class="source-code">var connectionString = builder.Configuration</p>
			<p class="source-code">    .GetConnectionString("DefaultConnection");</p>
			<p class="source-code">builder.Services.AddDbContext&lt;ApplicationDbContext&gt;(</p>
			<p class="source-code">    options =&gt; options.UseSqlite(connectionString));</p>
			<p class="source-code">builder.Services.AddDatabaseDeveloperPageExceptionFilter();</p>
			<p class="source-code">builder.Services.AddDefaultIdentity&lt;IdentityUser&gt;(</p>
			<p class="source-code">    options =&gt; options.SignIn.RequireConfirmedAccount = </p>
			<p class="source-code">        true)</p>
			<p class="source-code">    .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();</p>
			<p>There is also a registration for default identity that adds the <strong class="source-inline">EntityFramework</strong> store. It is also <a id="_idIndexMarker154"/>configured to only allow confirmed accounts, which means you as a user need to confirm your email address before you are allowed to log in.</p>
			<p>In the lower section, where the middleware is used, we see that the authentication and authorization is used:</p>
			<p class="source-code">app.UseAuthentication();</p>
			<p class="source-code">app.UseAuthorization();</p>
			<p>These two middleware enable authentication and authorization. The first tries to recognize the user by reading the authentication cookie. It also adds all the relevant information to the Identity object. </p>
			<p>What you might need to do is to extend the user profile by adding some more properties to the user. Let's see how to do so in the next section.</p>
			<h1 id="_idParaDest-89"><a id="_idTextAnchor160"/>Customizing IdentityUser</h1>
			<p><strong class="source-inline">IdentityUser</strong> has the following fields: <strong class="source-inline">Id</strong>, <strong class="source-inline">Username</strong>, <strong class="source-inline">Password</strong>, <strong class="source-inline">Email</strong>, and <strong class="source-inline">Phonenumber</strong>. </p>
			<p>Since the display <a id="_idIndexMarker155"/>name might differ from the username, we should add a <strong class="source-inline">Name</strong> property. Say we would like to send birthday wishes to the user; so, we would like to know their date of birth.</p>
			<p>To do so, a file called <strong class="source-inline">WebAppUser.cs</strong> is added to the <strong class="source-inline">Data</strong> folder that contains the following lines:</p>
			<p class="source-code">using Microsoft.AspNetCore.Identity;</p>
			<p class="source-code">namespace AuthSample.Data;</p>
			<p class="source-code">public class WebAppUser : IdentityUser</p>
			<p class="source-code">{</p>
			<p class="source-code">    [PersonalData]</p>
			<p class="source-code">    public string? Name { get; set; }</p>
			<p class="source-code">    [PersonalData]</p>
			<p class="source-code">    public DateTime DOB { get; set; }</p>
			<p class="source-code">}</p>
			<p>As shown here, <strong class="source-inline">WebAppUser</strong> derives from <strong class="source-inline">IdentityUser</strong> and extends it with the two already-mentioned properties.</p>
			<p>In <strong class="source-inline">Program.cs</strong>, we need to modify the service registration to use the new <strong class="source-inline">WebAppUser</strong>:</p>
			<p class="source-code">builder.Services.AddDefaultIdentity&lt;WebAppUser&gt;</p>
			<p>We also need to change <strong class="source-inline">DbContext</strong> in a way to use this <strong class="source-inline">WebAppUser</strong>, by changing the base class:</p>
			<p class="source-code">public class ApplicationDbContext : </p>
			<p class="source-code">     IdentityDbContext&lt;WebAppUser, IdentityRole, string&gt;</p>
			<p>You might need <a id="_idIndexMarker156"/>to add a <strong class="source-inline">using</strong> statement to <strong class="source-inline">Microsoft.AspNetCore.Identity</strong>.</p>
			<p>That's it for the first step. We now need to update the database:</p>
			<p class="source-code">dotnet ef migrations add CustomUserData</p>
			<p class="source-code">dotnet ef database update</p>
			<p>Once you have <strong class="source-inline">IdentityUser</strong> extended with the custom properties, you can start to use this in the user profile. This needs some customization in the ASP.NET Core Identity UI.</p>
			<h1 id="_idParaDest-90"><a id="_idTextAnchor161"/>Customizing the Identity views</h1>
			<p>Even if the ASP.NET Core Identity views come from a compiled Razor library, you can customize those views to add <a id="_idIndexMarker157"/>more fields or change the layout. To do so, you just need to override the given views with custom ones in the predefined folder structure within the area.</p>
			<p>As mentioned, there is already an area called <strong class="source-inline">Identity</strong> in the project. Inside this area, there is a <strong class="source-inline">Pages</strong> folder. Here, a new folder called <strong class="source-inline">Account</strong> needs to be created, to match the route of the <strong class="bold">Register</strong> page.</p>
			<p>If this is done, place a new Razor page called <strong class="source-inline">Register.cshtml</strong> inside this folder and put the following content inside just to see whether the overriding of views is working:</p>
			<p class="source-code">@page</p>
			<p class="source-code">@{</p>
			<p class="source-code">}</p>
			<p class="source-code">&lt;h1&gt;Hello Register Form&lt;/h1&gt; </p>
			<p>If you now run the app and click on <strong class="bold">Register</strong> in the upper left-hand corner, you will see the following page:</p>
			<div>
				<div id="_idContainer037" class="IMG---Figure">
					<img src="image/Figure_10.5_B17996.jpg" alt="Figure 10.5 – Register page"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.5 – Register page</p>
			<p>It is working.</p>
			<p>Actually, you don't need to override the views on your own. There is a code generator available to <a id="_idIndexMarker158"/>scaffold the views you'd like to override.</p>
			<p>Install the code generator by calling this command:</p>
			<p class="source-code">dotnet tool install -g dotnet-aspnet-codegenerator</p>
			<p>If not already done, you also need to install the following packages in your project:</p>
			<p class="source-code">dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design</p>
			<p class="source-code">dotnet add package Microsoft.EntityFrameworkCore.Design</p>
			<p class="source-code">dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore</p>
			<p class="source-code">dotnet add package Microsoft.AspNetCore.Identity.UI</p>
			<p class="source-code">dotnet add package Microsoft.EntityFrameworkCore.SqlServer</p>
			<p class="source-code">dotnet add package Microsoft.EntityFrameworkCore.Tools</p>
			<p>To learn what the code generator can do, run the following command:</p>
			<p class="source-code">dotnet aspnet-codegenerator identity -h</p>
			<p>You can scaffold the entire Identity UI as well as specific pages. If you don't specify pages of the default UI, all pages will be generated in your project. To see which pages you can generate, type the following command:</p>
			<p class="source-code">dotnet aspnet-codegenerator identity -lf</p>
			<p>The idea for the first <a id="_idIndexMarker159"/>change is to let the user fill in the name property on the registration page.</p>
			<p>So, let's scaffold the <strong class="bold">Register</strong> page:</p>
			<p class="source-code">dotnet aspnet-codegenerator identity -dc AuthSample.Data.ApplicationDbContext --files "Account.Register" -sqlite</p>
			<p>This command tells the code generator to use the already-existing <strong class="source-inline">ApplicationDbContext</strong> and <strong class="source-inline">Sqlite</strong>. If you don't specify this, it will either create a new <strong class="source-inline">DbContext</strong> or register the existing <strong class="source-inline">DbContext</strong> to use with SQL Server instead of SQLite. </p>
			<p>If all is done right, the code generator should only add the <strong class="source-inline">Register.cshtml</strong> page as well as some infrastructure files:</p>
			<div>
				<div id="_idContainer038" class="IMG---Figure">
					<img src="image/Figure_10.6_B17996.jpg" alt="Figure 10.6 – Files added by the code generator"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.6 – Files added by the code generator</p>
			<p>The code generator also knows that the project is using a custom <strong class="source-inline">WebAppUser</strong> instead of <strong class="source-inline">IdentityUser</strong>, which means <strong class="source-inline">WebAppUser</strong> is used in the generated code.</p>
			<p>Now, you should change <strong class="source-inline">Register.cshtml</strong> to add the display name to the form. Add the following <a id="_idIndexMarker160"/>lines right before the form elements for the email field on line 15 and thereafter:</p>
			<p class="source-code">&lt;div class="form-floating"&gt;</p>
			<p class="source-code">    &lt;input asp-for="Input.Name" class="form-control" </p>
			<p class="source-code">        autocomplete="name" aria-required="true" /&gt;</p>
			<p class="source-code">    &lt;label asp-for="Input.Name"&gt;&lt;/label&gt;</p>
			<p class="source-code">    &lt;span asp-validation-for="Input.Name"</p>
			<p class="source-code">        class="text-danger"&gt;&lt;/span&gt;</p>
			<p class="source-code">&lt;/div&gt;</p>
			<p>Also, <strong class="source-inline">Regiser.cshtml.cs</strong> need to be changed. The <strong class="source-inline">ImportModel</strong> class needs the <strong class="source-inline">Name</strong> property:</p>
			<p class="source-code">public class InputModel</p>
			<p class="source-code">{</p>
			<p class="source-code">    [Required]</p>
			<p class="source-code">    [Display(Name = "Display name")]</p>
			<p class="source-code">    public string Name { get; set; }</p>
			<p>In the <strong class="source-inline">PostAsync</strong> method, assign the <strong class="source-inline">Name</strong> property to the newly created user:</p>
			<p class="source-code">var user = CreateUser();</p>
			<p class="source-code">user.Name = Input.Name;</p>
			<p>That's it.</p>
			<p>After starting the application, you will see the following registration form:</p>
			<div>
				<div id="_idContainer039" class="IMG---Figure">
					<img src="image/Figure_10.7_B17996.jpg" alt="Figure 10.7 – Registration form&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.7 – Registration form</p>
			<p>Try it out and you will see that it is working.</p>
			<p>Since the user might <a id="_idIndexMarker161"/>need to update the name, we also need to change the view on the profile page. Here, the date of birth also needs to be added:</p>
			<p class="source-code">dotnet aspnet-codegenerator identity -dc AuthSample.Data.ApplicationDbContext --files "Account.Manage.Index" -sqlite</p>
			<p>Open the newly created <strong class="source-inline">Index.cshtml.cs</strong> that is located in the <strong class="source-inline">/Areas/Identity/Pages/Account/Manage/</strong> folder and place the following properties inside the <strong class="source-inline">InputModel</strong> class:</p>
			<p class="source-code">public class InputModel</p>
			<p class="source-code">{</p>
			<p class="source-code">    [Required]</p>
			<p class="source-code">    [Display(Name = "Display name")]</p>
			<p class="source-code">    public string Name { get; set; }</p>
			<p class="source-code">    [Display(Name = "Date of birth")]</p>
			<p class="source-code">    public DateTime DOB { get; set; }</p>
			<p>You can now use these properties in the corresponding <strong class="source-inline">Index.cshtml</strong>. The next snippet needs to be placed between the validation summary and the username:</p>
			<p class="source-code">&lt;div class="form-floating"&gt;</p>
			<p class="source-code">    &lt;input asp-for="Input.Name" class="form-control" </p>
			<p class="source-code">        autocomplete="name" aria-required="true" /&gt;</p>
			<p class="source-code">    &lt;label asp-for="Input.Name"&gt;&lt;/label&gt;</p>
			<p class="source-code">    &lt;span asp-validation-for="Input.Name" </p>
			<p class="source-code">        class="text-danger"&gt;&lt;/span&gt;</p>
			<p class="source-code">&lt;/div&gt;</p>
			<p class="source-code">&lt;div class="form-floating"&gt;</p>
			<p class="source-code">    &lt;input asp-for="Input.DOB" class="form-control" </p>
			<p class="source-code">         type="date"/&gt;</p>
			<p class="source-code">    &lt;label asp-for="Input.DOB" class="form-label"&gt;&lt;/label&gt;</p>
			<p class="source-code">&lt;/div&gt;</p>
			<p>This would be <a id="_idIndexMarker162"/>enough to display the fields, but there are some more changes needed to fill the form with saved data. Within the <strong class="source-inline">LoadAsync</strong> method, the instantiation of <strong class="source-inline">InputModel</strong> needs to be extended with the new properties:</p>
			<p class="source-code">Input = new InputModel</p>
			<p class="source-code">{</p>
			<p class="source-code">    PhoneNumber = phoneNumber,</p>
			<p class="source-code">    Name = user.Name,</p>
			<p class="source-code">    DOB = user.DOB</p>
			<p class="source-code">};</p>
			<p>The changed values also need to get saved when the user saves the form. Place the next snippet right before the third-from-last line of the <strong class="source-inline">OnPostAsync</strong> method:</p>
			<p class="source-code">user.Name = Input.Name;</p>
			<p class="source-code">user.DOB = Input.DOB;</p>
			<p class="source-code">await _userManager.UpdateAsync(user);</p>
			<p>This sets the <a id="_idIndexMarker163"/>values of <strong class="source-inline">InputModel</strong> to the <strong class="source-inline">WebAppUser</strong> properties and saves the changes in the database.</p>
			<p>Let's try it out by calling <strong class="source-inline">dotnet watch</strong> in the terminal.</p>
			<p>The profile page will now look similar to this:</p>
			<div>
				<div id="_idContainer040" class="IMG---Figure">
					<img src="image/Figure_10.8_B17996.jpg" alt="Figure 10.8 – Manage your account page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.8 – Manage your account page</p>
			<p>You can now change the display name and add your date of birth.</p>
			<p>If the user provides <a id="_idIndexMarker164"/>a display name, they might show it in the upper left-hand corner after the login.</p>
			<p>Open the <strong class="source-inline">_LoginPartial.cshtml</strong> that is in the <strong class="source-inline">Views/Shared</strong> folder and replace the first four lines with the following code snippet:</p>
			<p class="source-code">@using Microsoft.AspNetCore.Identity</p>
			<p class="source-code">@using AuthSample.Data</p>
			<p class="source-code">@inject SignInManager&lt;WebAppUser&gt; SignInManager</p>
			<p class="source-code">@inject UserManager&lt;WebAppUser&gt; UserManager</p>
			<p class="source-code">@{</p>
			<p class="source-code"> var user = await @UserManager.GetUserAsync(User);</p>
			<p class="source-code">}</p>
			<p>This changes the generic type argument of <strong class="source-inline">SignInManager</strong> and <strong class="source-inline">UserManager</strong> from the <strong class="source-inline">IdentityUser</strong> type to the <strong class="source-inline">WebAppUser</strong> type. Inside the code block, the current <strong class="source-inline">WebAppUser</strong> is loaded via <strong class="source-inline">UserManager</strong> by passing the current user in.</p>
			<p>Now, the output of the username on line 12 needs to be changed to write the display name:</p>
			<p class="source-code">Hello @user?.Name!</p>
			<p>When <strong class="source-inline">dotnet watch</strong> is still running, the application running in the browser should already be updated. Maybe you <a id="_idIndexMarker165"/>need to log in again. You should now see the display name in the upper right-hand corner:</p>
			<div>
				<div id="_idContainer041" class="IMG---Figure">
					<img src="image/Figure_10.9_B17996.jpg" alt="Figure 10.9 – Display name&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.9 – Display name</p>
			<p>That's it.</p>
			<h1 id="_idParaDest-91"><a id="_idTextAnchor162"/>Summary</h1>
			<p>In this chapter, you learned how to extend ASP.NET Core Identity to enhance the user object by adding additional properties. You also learned how to enhance the Identity UI to load, save, and update the values of the new user properties.</p>
			<p>But how would you manage roles for the users of your application?</p>
			<p>This is what you will learn in the next chapter, about configuring identity management.</p>
		</div>
	</body></html>