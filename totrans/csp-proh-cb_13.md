# 第十三章。在 Azure 中创建 Web 应用程序

本章将向您介绍 Azure。如果您以前从未使用过 Azure，界面可能看起来有些令人畏惧。然而，Azure 实际上并不那么复杂，并且对任何开发者来说都是巨大的好处。在本章中，我们将探讨以下内容：

+   在 Azure 中创建用于测试的数据库

+   在 Azure 上创建 Web 应用程序并进行托管

+   在 Azure 上使用虚拟机

# 简介

Azure 允许开发者提高生产力。这是一系列开发者可以用来构建应用程序、保护数据和为您的应用程序提供高可用性的云服务，无论您正在构建什么。移动应用程序、企业应用程序、Web、**物联网**（**IoT**）……所有这些都欢迎在 Azure 上。

您可以使用 .NET、JavaScript、PHP、Node.js、Python 创建应用程序，甚至运行 Linux 容器。Azure 还允许您只为您实际使用的部分付费，使您能够随着需求的增长轻松扩展。

# 在 Azure 中创建用于测试的数据库

在 Azure 中创建数据库实际上是一个非常直接的过程。为了使过程更加流畅，已经投入了大量工作，使其具有一个过于熟悉的向导式界面。

## 准备工作

要开始使用 Azure，您需要一个 Azure 账户。您可以创建一个免费试用账户。有关 Azure 定价的更多信息，请查看以下 URL：[`azure.microsoft.com/en-us/pricing/`](https://azure.microsoft.com/en-us/pricing/)。

## 如何操作…

1.  登录到您的 Azure 账户后，您将被带到您的**仪表板**。从这里您可以查看您可能已固定的任何项目。在左侧，您将看到菜单。我们只想创建一个 SQL 数据库，因此点击**SQL 数据库**菜单项：![如何操作…](img/B05391_13_01.jpg)

1.  如果这是您第一次使用 Azure，您在**默认目录**中将没有任何可用的数据库。点击**添加**以创建一个新的数据库：![如何操作…](img/B05391_13_02.jpg)

1.  现在，您将看到一个表单，您可以使用它来指定数据库详细信息。如您所见，您可能没有选择服务器。这可能是因为您可能还没有服务器。点击**服务器配置所需设置**：![如何操作…](img/B05391_13_03.jpg)

1.  您将有机会创建一个新的服务器。这也是您创建**服务器管理员登录**的地方：![如何操作…](img/B05391_13_04.jpg)

1.  当您创建了自己的服务器后，您将被带回到数据库设置屏幕。您创建的服务器现在已被选中：![如何操作…](img/B05391_13_05.jpg)

1.  当您点击**创建**按钮时，Azure 将开始将您的数据库部署到您创建的服务器上：![如何操作…](img/B05391_13_06.jpg)

1.  此过程可能需要几分钟，所以在它完成时请耐心等待。当数据库部署完成后，你将在 Azure 门户顶部的通知标签页中看到一个通知：![如何操作…](img/B05391_13_07.jpg)

1.  你可能需要刷新你的 SQL 数据库屏幕以查看新部署的数据库。为了完成下一步，点击数据库列表中创建的数据库：![如何操作…](img/B05391_13_08.jpg)

1.  创建的数据库的属性和设置随后将显示出来。在这里，你可以看到你选择的**资源组**，以及**服务器名称**和其他属性。特别值得注意的是**连接字符串**属性：![如何操作…](img/B05391_13_09.jpg)

1.  点击**连接字符串**将显示你创建的数据库的不同提供者的连接字符串。记下**ADO.NET(SQL 身份验证)**字符串：![如何操作…](img/B05391_13_10.jpg)

1.  返回到上一个屏幕，点击**服务器名称**属性。在这里，你会找到**防火墙**设置。你需要向防火墙添加一个规则，以允许你的计算机连接到此数据库：![如何操作…](img/B05391_13_11.jpg)

1.  点击**显示防火墙设置**，你会看到你可以添加客户端 IP。默认情况下，你访问**防火墙设置**时显示的机器 IP 地址将在**客户端 IP 地址**字段中。点击**添加客户端 IP**以将你当前机器的 IP 地址添加到防火墙中允许通过。你可以将**规则名称**改为更友好的名称：![如何操作…](img/B05391_13_12.jpg)

    ### 注意

    你也可以在此处定义不同的 IP 地址，以便同事可以从他们的机器访问此数据库。

1.  在你已经添加了防火墙规则后，在你的本地开发机器上打开 SQL Server Management Studio。在**对象资源管理器**中，点击**连接对象资源管理器**按钮：![如何操作…](img/B05391_13_13.jpg)

1.  看一下你之前记下的连接字符串。在连接字符串的服务器部分之后，我将服务器名称复制为 `tcp:srvcookbook.database.windows.net`。将其粘贴到**连接到服务器**屏幕中的**服务器名称**字段。最后，输入你在 Azure 上创建服务器时定义的**登录名**和**密码**。点击**连接**按钮：![如何操作…](img/B05391_13_14.jpg)

1.  SQL Server Management Studio 将现在连接到 Azure 上的 `CookbookDb` 数据库：![如何操作…](img/B05391_13_15.jpg)

## 它是如何工作的…

Azure 是存储数据库的完美之地。它安全，并且只有你选择的开发者可以访问。你需要意识到，如果你的 IP 地址发生变化，你可能需要重新配置 Azure 数据库上的防火墙规则。然而，这对安全性来说是个好兆头，因为你可以确信你的数据是安全的。有关 Azure 中数据库的更多信息，请参阅以下文档：[`azure.microsoft.com/en-us/documentation/services/sql-database/`](https://azure.microsoft.com/en-us/documentation/services/sql-database/)。

# 在 Azure 上创建网络应用并进行托管

网络开发者经常要做的事情之一是为（**用户验收测试**）**UAT**或开发者测试目的部署网络应用。Azure 通过在 Visual Studio 内提供无缝的发布体验，使这个过程对你来说非常方便。要将网络应用或网站发布到 Azure，你首先需要在 Azure 上创建一个网络应用来发布你的网站。

## 准备工作

要开始使用 Azure，你需要有一个 Azure 账户。你可以创建一个免费试用账户。有关 Azure 定价的更多信息，请查看以下 URL：[`azure.microsoft.com/en-us/pricing/`](https://azure.microsoft.com/en-us/pricing/)。

## 如何操作…

1.  登录到你的 Azure 账户后，你将被带到你的**仪表板**。从这里你可以看到你可能已经固定的任何项目。在左侧，你会看到一个菜单。我们想要创建一个网站，所以点击**应用服务**菜单项：![如何操作…](img/B05391_13_16.jpg)

1.  如果你第一次使用 Azure，你可能不会显示任何应用服务。点击**添加**来创建一个新的：![如何操作…](img/B05391_13_17.jpg)

1.  给应用服务起一个名字，并选择或创建一个**资源组**：![如何操作…](img/B05391_13_18.jpg)

1.  当你点击**创建**按钮时，Azure 开始部署。这个过程可能需要几分钟才能完成，所以你可以趁等待的时候去拿一杯咖啡：![如何操作…](img/B05391_13_19.jpg)

1.  部署完成后，你将在通知菜单中收到通知：![如何操作…](img/B05391_13_20.jpg)

1.  刷新**应用服务**部分，你会看到我们刚刚创建的**cookbookdemo**网络应用。你可能需要点击**刷新**按钮，**cookbookdemo**网络应用才会变得可见：![如何操作…](img/B05391_13_21.jpg)

1.  点击**cookbookdemo**网络应用将显示属性。特别注意右上角的**URL**：![如何操作…](img/B05391_13_22.jpg)

1.  如果你点击这个 URL，你将被带到你的网络应用的默认占位符网站。是时候将我们的网站发布到 Azure 了：![如何操作…](img/B05391_13_23.jpg)

1.  启动 Visual Studio 并创建或打开你想要发布的网站。我已经创建了一个简单的网站，想要发布：![如何操作…](img/B05391_13_24.jpg)

1.  右键单击你的网站项目，然后从上下文菜单中选择**发布** **Web 应用程序**：![如何做…](img/B05391_13_25.jpg)

1.  **发布 Web**屏幕将显示。在这里，你可以看到可用的各种发布目标。我们只想将我们的应用程序发布到 Azure。选择**Microsoft Azure Web Apps**作为发布目标：![如何做…](img/B05391_13_26.jpg)

1.  点击**下一步**将要求你连接到 Azure，或者如果你之前已经连接，则从下拉选择中选择你的**订阅**。任何现有的 Web 应用程序都将显示在**现有 Web 应用程序**列表中。我们之前创建的**cookbookdemo** Web 应用程序将显示：![如何做…](img/B05391_13_27.jpg)

1.  选择**cookbookdemo** Web 应用程序，你现在必须定义你的 Web 应用程序连接和**发布方法**。目前，我们将仅选择**Web Deploy**作为将我们的 Web 应用程序发布到 Azure 的方法：![如何做…](img/B05391_13_28.jpg)

1.  你还可以点击**验证连接**按钮，确保一切就绪后再继续：![如何做…](img/B05391_13_29.jpg)

1.  点击**下一步**将带你进入**设置**屏幕。在这里，你可以选择要部署的**配置**，以及定义数据库连接：![如何做…](img/B05391_13_30.jpg)

    ### 注意

    正如你所注意到的，我正在使用的数据库连接是我们在本章第一个菜谱中创建的数据库的连接，*在 Azure 中创建数据库进行测试*。

1.  当你点击**下一步**时，你会看到你可以预览要发布到 Azure Web 应用程序上的文件。初始发布显然包含最多的文件，因为 Web 应用程序上还没有任何内容：![如何做…](img/B05391_13_31.jpg)

1.  当你准备好时，点击**发布**按钮将开始将你的网站发布到 Azure 的过程。这可能需要几分钟才能完成。发布完成后，Visual Studio 将自动打开已发布的网站：![如何做…](img/B05391_13_32.jpg)

1.  回到 Azure，你会看到**监控**窗口活跃起来。你还可以在此处添加其他部分，以提供更多关于你的 Web 应用程序状态的信息：![如何做…](img/B05391_13_33.jpg)

## 它是如何工作的…

当你在 Azure 上部署时，Azure 将大量权力交到开发者手中。你可以添加额外的部分来帮助管理你的 Web 应用程序。这些部分以瓷砖的形式显示给你。一些可用的部分包括：

+   进程资源管理器

+   Web 作业

+   流量路由

+   请求和错误

+   Http 4xx

+   Http 5xx

+   文件系统存储

+   Web 测试

+   用户和角色

+   性能测试

+   即使是你的预估 Azure 支出

Azure 确实是一个非常灵活的云解决方案，无论你的个人需求如何。

# 在 Azure 上使用虚拟机

**虚拟机**（**VM**）对于开发者来说是必不可少的。我自己有几个用于个人使用和尝试新软件。其背后的技术相当令人难以置信，因为它为您虚拟化了一个特定的环境，以便您可以准确测试您的应用程序。在我之前的工作单位，我们会创建特定客户端环境的 VM，以便测试应用程序部署，基本上是看看应用程序是否正确运行。

使用 Azure，开发者在决定特定的 VM 平台时有很多选择。您几乎可以启动任何类型的 VM。如果您想尝试新的 Visual Studio，您可以。Windows 的新版本？您可以在 Azure 上找到相应的 VM。想稍微玩一下 Linux 和 WordPress？没问题。Azure 可以做到这一切，并且设置起来非常简单。

考虑一下替代方案。如果不存在 VM，您想在 Windows 10 这样的操作系统上测试应用程序，您可能需要留出一台特定的机器来测试不同的操作系统版本。这样，您就失去了一台机器，不能再用于其他工作了。然后您需要花上一两个小时设置这台 PC，安装正确的操作系统。然后您需要设置这台 PC，使其在您的办公室的本地网络中可用。如果您想从远程位置（例如家中）访问这台测试机器怎么办？您需要配置它以便远程访问，同时保持安全性。因此，您设置了 VPN，以便在开发者需要加班工作时远程访问这台机器。这必须为正在开发中的应用程序的单个实例完成。如果您有可用的服务器，当然，这可能不是问题。然而，如果您是一家资源有限的小到中型公司，您可能会很快重新安装这台机器，为不同的客户端设置进行测试。

这就是 Azure 在创造差异方面表现得非常出色的地方。设置过程只需几分钟，与在办公室设置一台 PC 相比，这只是瞬间的事情。远程访问、安全性、事件监控、警报以及许多其他功能立即对您团队中的所有开发者可用。

## 准备工作

要开始使用 Azure，您需要一个 Azure 账户。您可以创建一个免费试用账户。有关 Azure 定价的更多信息，请查看以下网址：[`azure.microsoft.com/en-us/pricing/`](https://azure.microsoft.com/en-us/pricing/).

## 如何操作...

1.  登录您的 Azure 账户后，您将被带到您的**仪表板**。从这里您可以查看您可能已固定的任何项目。在左侧您将看到菜单。点击**虚拟机**菜单项：![如何操作…](img/B05391_13_34.jpg)

1.  然后，您将被带到 Azure 订阅中虚拟机的默认目录。我们需要通过点击**添加**按钮来创建一个新的虚拟机：![如何操作…](img/B05391_13_35.jpg)

1.  Azure 会显示所有可供您使用的虚拟机类型。可供选择的主机类型相当多。从服务网格到 Linux，再到 Ubuntu，选择范围很广：![如何操作…](img/B05391_13_36.jpg)

1.  对于我们的目的，我们只需创建一个 Windows 虚拟机：![如何操作…](img/B05391_13_37.jpg)

1.  点击**Windows**组，您可以看到我们有两个选择：Windows 10 企业版或 Windows 8.1 企业版 64 位虚拟机。我们将简单地选择 Windows 10 虚拟机以开始操作：![如何操作…](img/B05391_13_38.jpg)

1.  您现在将被要求输入各种设置以配置您的 Windows 10 虚拟机。为您的虚拟机命名并定义登录用户名和密码。**资源组**将允许您选择一个现有的资源组或创建一个新的资源组：![如何操作…](img/B05391_13_39.jpg)

1.  在下一个配置屏幕上，您将看到推荐的虚拟机大小，每个大小都有其不同的定价选项以您所在地区的货币显示。选择最适合您、您的需求或/和预算的选项。

1.  下一屏允许您配置可选功能。您可用的功能如下：

    +   存储账户是创建虚拟机磁盘的地方。

    +   虚拟网络与传统网络类似。同一虚拟网络中的任何虚拟机都可以相互访问，并且默认情况下已配置。

    +   子网允许您将虚拟机与其他虚拟机或互联网隔离。

    +   公共 IP 地址允许您与之前定义的虚拟网络之外的机器进行通信。

    +   网络安全组是在您的防火墙上定义的一组规则，用于控制谁可以访问您的 Windows 10 虚拟机。

    +   扩展相当不错。这些是额外的附加组件，例如防病毒软件包。

    +   监控默认开启，允许您收集有关虚拟机的信息，并根据监控信息定义警报。这使您始终处于控制状态并保持信息畅通。

    +   诊断存储账户是监控指标存储的地方。如果需要，您可以使用自己的工具分析这些指标。

    +   可用性设置允许您将两个或更多虚拟机集群在一起，以便在其中一个虚拟机需要离线进行维护时提供故障转移。此步骤需要配置，因为创建虚拟机后无法更改可用性设置：

    ![如何操作…](img/B05391_13_41.jpg)

1.  一旦您配置了虚拟机，您将看到在设置过程中选择的配置选项的摘要：![如何操作…](img/B05391_13_42.jpg)

1.  当您确认虚拟机已正确设置后，Azure 将开始部署过程：![如何操作…](img/B05391_13_43.jpg)

1.  部署过程的进度也可见于**仪表板**，并需要几分钟才能完成：![如何操作…](img/B05391_13_44.jpg)

1.  几分钟后，虚拟机将可用并准备就绪。您将被带到**cookbookvm**的虚拟机页面：![如何操作…](img/B05391_13_45.jpg)

1.  要连接到您的虚拟机，请点击**连接**按钮：![如何操作…](img/B05391_13_46.jpg)

1.  然后将下载一个`.rdp`文件。您可以直接点击该文件以启动**远程桌面连接**会话：![如何操作…](img/B05391_13_47.jpg)

1.  你可能会被问到是否信任远程连接的出版商。显然你是信任的，所以只需点击**连接**按钮：![如何操作…](img/B05391_13_48.jpg)

1.  现在，您将能够输入之前在虚拟机设置期间定义的登录凭据：![如何操作…](img/B05391_13_49.jpg)

1.  现在，您将通过远程桌面连接连接到 Windows 10 虚拟机：![如何操作…](img/B05391_13_50.jpg)

1.  在 Azure 中，如果您在虚拟机设置期间选择了**监控**选项，您会看到有一个默认的**监控**选项卡用于**CPU 百分比**。Azure 允许您添加更多监控事件并为每个事件创建警报：![如何操作…](img/B05391_13_51.jpg)

## 它是如何工作的…

虚拟机可以通过远程连接访问。您可以使用传统的远程桌面连接，或者如果您需要访问多个远程机器，可以使用更复杂的工具如 mRemoteNG。Azure 非常适合开发测试的原因在于，资源根本不需要存在于您的本地网络中。这意味着维护开发虚拟机备份的开销在很大程度上被避免了。

我记得在我之前雇主那里工作的网络管理员经常询问我们还在使用哪些虚拟机。其中一些虚拟机可能一年只用上一两次，所以不能删除。有多个开发者访问这些虚拟机也意味着这些虚拟机上有很多垃圾文件，这使得备份这些虚拟机变得痛苦不堪（通常在周末进行）。

Azure 为 IT 专业人员解决了许多问题和难题。在本章中，我们只探讨了您作为开发者可用的三种解决方案。不要被误导，Azure 的功能远不止为开发者提供一个强大的测试平台。详细探讨 Azure 可能需要一本单独的书。
