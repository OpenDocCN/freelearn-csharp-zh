<html><head></head><body><p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch05"/>&#13;
 Chapter 5. Models</h1>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>Data is the heart of every application. A user enters data into the application, edits the entered data, and searches the data. We can even say that an application that we build is just an interface for the operations that we perform on the application data. So, it is absolutely necessary for any framework to provide a mechanism to handle data operations easier and more manageable. Models in ASP.NET MVC are used to represent the business domain data.</p>&#13;
<p>In this chapter, you'll be learning about the following topics:</p>&#13;
<p>&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">Models and their purpose</li>&#13;
<li class="listitem">Creating a simple model and using it in the controller and views of the ASP.NET MVC application</li>&#13;
<li class="listitem">Creating a model specific to a View model</li>&#13;
<li class="listitem">Data flow in an ASP.NET MVC application in the context of models and <code class="literal">ViewModels</code>&#13;
</li>&#13;
<li class="listitem">Purpose of the Entity Framework along with its features and benefits</li>&#13;
<li class="listitem">Adding, updating, and deleting data using the Entity Framework</li>&#13;
<li class="listitem">Using the Entity Framework in ASP.NET MVC applications</li>&#13;
</ul>&#13;
</p>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch05lvl1sec37"/>&#13;
 Models</h1>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>Models are simple &#13;
<strong>POCO</strong>&#13;
&#13;
 (&#13;
<strong>Plain Old C# Objects</strong>&#13;
&#13;
 ) classes representing your business domain data. For an e-commerce business, model classes would be <code class="literal">Product</code>&#13;
 , <code class="literal">Order</code>&#13;
 , and <code class="literal">Inventory</code>&#13;
 . If you are building an application for a university, model classes would be <code class="literal">Student</code>&#13;
 , <code class="literal">Teacher,</code>&#13;
 and <code class="literal">Subject</code>&#13;
 . Models represent the business domain data in your application and they are not aware of the underlying database that is being used in your application. In fact, you don't even need a database to work with models.</p>&#13;
<p>They can represent the data stored in an XML file or CSV file or any other data in your application. Having said that, these models could be used to interact with your database (in most cases) but they don't have any dependency to the database.</p>&#13;
<p>The following steps describe how to create an ASP.NET Core application that uses Models:</p>&#13;
<p>&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Make sure to create an ASP.NET 5 application with an empty template. Install the ASP.NET Core <code class="literal">NuGet</code>&#13;
 package and configure this, as discussed in an earlier chapter.</li>&#13;
<li class="listitem" value="2">Create a <code class="literal">Controllers</code>&#13;
 folder and create a <code class="literal">HomeController</code>&#13;
 with a single <code class="literal">Index</code>&#13;
 action method.</li>&#13;
<li class="listitem" value="3">Create the following folder/files for the <code class="literal">Views</code>&#13;
 model:<div>&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">&#13;
<code class="literal">Views</code>&#13;
 : This folder is inside your project.</li>&#13;
<li class="listitem">&#13;
<code class="literal">Views\_ViewStart.cshtml</code>&#13;
 : This identifies the name of the <code class="literal">Layout</code>&#13;
 file.</li>&#13;
<li class="listitem">&#13;
<code class="literal">Views\Shared</code>&#13;
 folder: This folder holds all the shared View components for your application.</li>&#13;
<li class="listitem">&#13;
<code class="literal">Shared\_Layout.cshtml</code>&#13;
 : This file identifies what your web application structure should look like.</li>&#13;
<li class="listitem">&#13;
<code class="literal">Views\Home</code>&#13;
 folder: This folder contains all of the Views of your <code class="literal">HomeController</code>&#13;
 .</li>&#13;
<li class="listitem">&#13;
<code class="literal">Views\Home\Index.cshtml</code>&#13;
 : This is the view corresponding to the <code class="literal">Index</code>&#13;
 action method of <code class="literal">HomeController</code>&#13;
 .</li>&#13;
</ul>&#13;
</p>&#13;
</li>&#13;
</ol>&#13;
<p>&#13;
</p>&#13;
<p>Now, we have created an ASP.NET Core application with Controllers and Views.</p>&#13;
<p>Let us create a <code class="literal">Models</code>&#13;
 folder in our application; this folder will contain all of your model files. In a real world application, this folder and the respective model files would reside in separate projects. For the sake of simplicity, we are keeping the <code class="literal">Models</code>&#13;
 folder and its files in the same project.</p>&#13;
<div><img src="img/Image00067.jpg" alt="Models"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>Let us create a simple model class <code class="literal">Product</code>&#13;
 model, in the <code class="literal">Models</code>&#13;
 folder:</p>&#13;
<pre class="programlisting">public class Product { 
  public int ProductId { get; set; } 
  public string Name { get; set; } 
  public decimal Price { get; set; } 
} 
</pre>&#13;
<p>This <code class="literal">Product</code>&#13;
 model class is no different from any other C# class and contains a few properties about the product.</p>&#13;
<p>Update the <code class="literal">Index</code>&#13;
 action method in <code class="literal">HomeController</code>&#13;
 to use the <code class="literal">Product</code>&#13;
 model, as shown in the following code snippet. We are building the model data and passing the model data to the View so that it can be shown to the users. However, it is &#13;
<em>NOT</em>&#13;
&#13;
 recommended to build the Model data in the controller's action methods as it violates the separation of concerns. For the sake of simplicity only, we are building the Model data in an action method.</p>&#13;
<pre class="programlisting">public IActionResult Index() { 
  /* Build the products model. It is NOT RECOMMENDED to build    models in Controller action methods  like this. In real world appication, these models and the    respective Data Access Layer(DAL) would  be in separate projects. We are creating it here to make things    simpler to explain */ 
  List&lt;Product&gt; Products = new List&lt;Product&gt; { 
    new Product { 
      Name = "Mobile Phone", 
      Price = 300 
    }, 
    new Product { 
      Name = "Laptop", 
      Price = 1000 
    }, 
    new Product { 
      Name = "Tablet", 
      Price = 600 
    } 
  }; 
  return View(Products); 
} 
</pre>&#13;
<p>Update the corresponding <code class="literal">Index</code>&#13;
 View method to use the Model data loop through each product and show it as an unordered list item. The <code class="literal">@model</code>&#13;
 in the first line represents the Model metadata; the type of data being passed to the View. The Model in the <code class="literal">for…each</code>&#13;
 loop represents the actual data itself, a list of products in our case:</p>&#13;
<pre class="programlisting">@model List&lt;Chapter5.Models.Product&gt; 
 
&lt;ul&gt; 
  @foreach (var Product in Model) { 
    &lt;li&gt;@Product.Name&lt;/li&gt; 
  } 
&lt;/ul&gt; 
</pre>&#13;
<p>When you run the application, you'll get the following output:</p>&#13;
<div><img src="img/Image00068.jpg" alt="Models"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>We have successfully created a Model and have used it in our Controller and View.</p>&#13;
<p>Let us create a comparatively complex Model class, <code class="literal">Order</code>&#13;
 (<code class="literal">Order.cs</code>&#13;
 in the <code class="literal">Models</code>&#13;
 folder), which contains a list of products and their total amount:</p>&#13;
<pre class="programlisting">public class Order { 
  public int OrderId { get; set; } 
  public List&lt;Product&gt; Products { get; set; } 
  public decimal Total { get; set; } 
} 
</pre>&#13;
<div><img src="img/Image00069.jpg" alt="Models"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>Now, we have to update the <code class="literal">Index</code>&#13;
 action method to use the <code class="literal">Order</code>&#13;
 model. Once we build the list of products, we are assigning the products list to the <code class="literal">Order</code>&#13;
  property and calculating the total cost of the order. These calculations would usually be done as part of the business layer. Again, for the sake of simplicity, we are building the data Model and calculations here in the action; this should never be the case in a real world application.</p>&#13;
<p>The code highlighted in bold is the changes that we have made in the action method:</p>&#13;
<pre class="programlisting">public IActionResult Index() { 
  /* Build the products model. It is NOT RECOMMENDED to build    models in Controller action methods  like this. In real world appication, these models and the    respective Data Access Layer(DAL) would  be in separate projects. We are creating it here to make things    simpler to explain   */ 
  List&lt;Product&gt; Products = new List&lt;Product&gt; { 
    new Product { 
      Name = "Mobile Phone", 
      Price = 300 
    }, 
    new Product { 
      Name = "Laptop", 
      Price = 1000 
    }, 
    new Product { 
      Name = "Tablet", 
      Price = 600 
    } 
  }; 
 

<strong>  Order order = new Order(); 
  order.Products = Products; 
  order.Total = Products.Sum(product =&gt; product.Price); 
 
  return View(order);</strong>&#13;

&#13;

 
} 
</pre>&#13;
<p>The View is updated to accommodate the Model changes. Model metadata (<code class="literal">@model</code>&#13;
 ) is changed to indicate that the Order information is passed to the View instead of the list of products.</p>&#13;
<p>Then, we are showing the list of products in table format. Please note that all of the Model data (<code class="literal">Order</code>&#13;
 object and its properties, in this case) can be accessed through the Model. For example, the <code class="literal">Products</code>&#13;
 class can be accessed through <code class="literal">Model.Products</code>&#13;
 and the value of the <code class="literal">Total</code>&#13;
 can be obtained through <code class="literal">Model.Total</code>&#13;
 :</p>&#13;
<pre class="programlisting">@model Chapter5.Models.Order 
 
&lt;table border="1"&gt; 
 
  &lt;tr&gt; 
    &lt;th&gt;Product Name&lt;/th&gt; 
    &lt;th&gt;Price&lt;/th&gt; 
  &lt;/tr&gt; 
 
  @foreach (var Product in Model.Products){ 
    &lt;tr&gt; 
      &lt;td&gt;@Product.Name&lt;/td&gt; 
      &lt;td&gt;@Product.Price&lt;/td&gt; 
    &lt;/tr&gt; 
  } 
  &lt;tr&gt; 
    &lt;td&gt;&lt;b&gt;Total&lt;/b&gt;&lt;/td&gt; 
    &lt;td&gt;&lt;b&gt;@Model.Total&lt;/b&gt;&lt;/td&gt; 
  &lt;/tr&gt; 
&lt;/table&gt; 
</pre>&#13;
<p>When you run the application, you'll see the following output:</p>&#13;
<div><img src="img/Image00070.jpg" alt="Models"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch05lvl2sec33"/>&#13;
 Models specific to a View component</h2>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>There are scenarios where you might want to update only a few properties in a large Model or you might want to create a new Model based on a few models. In such scenarios, it is better to create a new Model specific to the View.</p>&#13;
<p>For example, let us assume that we are building a screen where you update the price of the product. This simple screen may contain only three properties—product ID, product name, and price of the product. But the product's Model may contain more than 30 properties to hold all details of the product such as manufacturer, color, size, and other properties. Instead of sending the complete Model with all the properties, we can create a new Model specific to this view with only a few properties—ID, Name, and Price.</p>&#13;
</div>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch05lvl2sec34"/>&#13;
 Note on ViewModels</h2>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>The ViewModels are entities where when you update the Model, your View would get updated automatically and vice versa. In many online articles and even in some books, they are referring to &#13;
<em>ViewModels</em>&#13;
&#13;
 when they are actually trying to mean &#13;
<em>Models specific to the View</em>&#13;
&#13;
 .</p>&#13;
<p>In ViewModels, binding is two ways—when you update either the Model or the View, the other one would get updated automatically. Let us consider a simple example; you have a form with various fields on the left-hand side and print preview on the right side. In this case, whatever you type in real time in the form will be reflected immediately on the right side. In such cases, you can use pure View models when you type, your ViewModel would be updated and that <code class="literal">ViewModel</code>&#13;
 would be consumed in the right-hand side print preview. These pure ViewModels are being used in advanced JavaScript frameworks such as &#13;
<strong>Knockout</strong>&#13;
&#13;
 or &#13;
<strong>AngularJS</strong>&#13;
&#13;
 .</p>&#13;
<p>In &#13;
<em>Models specific to the View</em>&#13;
&#13;
 , we are binding in only one way from the Model to the View. Here, we are sending a Model specific to the View instead of the generic Model (which represents a business domain class).</p>&#13;
<p>However, in this book, we will be referring to &#13;
<em>Models specific to View</em>&#13;
&#13;
 as <code class="literal">ViewModel</code>&#13;
 for brevity. Unless otherwise specified, you should read all ViewModels as &#13;
<em>Models specific to View</em>&#13;
&#13;
 . So, I am making the same mistake made by other authors <img src="img/Image00071.jpg" alt="Note on ViewModels"/>&#13;
&#13;
 .</p>&#13;
</div>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch05lvl2sec35"/>&#13;
 Data flow with respect to a Model</h2>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>The following block diagram shows the data flow in an ASP.NET MVC application:</p>&#13;
<div><img src="img/Image00072.jpg" alt="Data flow with respect to a Model"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>&#13;
&#13;
<strong>Data Source</strong>&#13;
&#13;
 represents your application data. The application data could reside anywhere—from full-fledged RDBMS such as SQL servers to simple Excel spreadsheets, or anything in between.</p>&#13;
<p>&#13;
&#13;
<strong>Models</strong>&#13;
&#13;
 represent the business domain data for your application and are independent of the data source being used. The same model could be used with different data sources.</p>&#13;
<p>We can use the &#13;
<strong>Model as-is in our views</strong>&#13;
&#13;
 to get data or to present it. But in some views, you might not need all the properties of the model. So, instead of sending the entire Model to the View, we create models specific to the View and use them in our View. This makes things simpler.</p>&#13;
<p>The following is the high-level sequence of events that happens when you store or retrieve a record in ASP.NET Core using the Model:</p>&#13;
<p>&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Users enter the data in a form (created using Views) in the application. The fields in the form do not need to represent the complete model as we need only a few properties in the Model.</li>&#13;
<li class="listitem" value="2">The entered data is passed to the controller where Model binding happens. Model binding is the process where the data entered in the View gets mapped to the Model or ViewModel.</li>&#13;
<li class="listitem" value="3">If the data is received in the ViewModel, then we would be converting the ViewModel to the Model.</li>&#13;
<li class="listitem" value="4">Finally, the Model data is stored in the data source.</li>&#13;
</ol>&#13;
<div>&#13;
</p>&#13;
<p>Till now, we have been handling only in-memory data in our application. In almost all real world applications, some form of the database will be used for data storage, access, and retrieval. In the next section, we will discuss the Entity Framework (ORM framework), which makes data access simpler from a .NET application.</p>&#13;
</div>&#13;
</div>&#13;
</div>&#13;

<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch05lvl1sec38"/>&#13;
 Model binding</h1>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>&#13;
&#13;
<strong>Model binding</strong>&#13;
&#13;
 is the process of mapping the Model data coming from the View to the ViewModel parameter of the action method in the Controller.</p>&#13;
<p>Let us consider a simple form with a couple of form fields—<code class="literal">Name</code>&#13;
 and <code class="literal">EmailID</code>&#13;
 . On the submission of the form, these values would be mapped to the <code class="literal">ViewModel</code>&#13;
 object of the action method of the Controller. Model binding takes care of this mapping. The Model binder looks for a match in the form fields, query strings, and request parameters.</p>&#13;
<p>In the preceding example, any class with these properties would be picked up by ModelBinder without any issues.</p>&#13;
<p>As the following <code class="literal">Person</code>&#13;
 class contains the <code class="literal">Name</code>&#13;
 and <code class="literal">EmailID</code>&#13;
 properties, the model binder would not complain about using this model for mapping the entered values in the form:</p>&#13;
<pre class="programlisting">public class Person { 
  public string Name { get; set; } 
  public string EmailID { get; set; } 
} 
</pre>&#13;
<p>The following code snippet shows how to use the <code class="literal">Person</code>&#13;
 class in the action method:</p>&#13;
<pre class="programlisting">public ActionResult Add(Person p) { 
  return View(); 
} 
</pre>&#13;
</div>&#13;

<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch05lvl1sec39"/>&#13;
 The Entity Framework</h1>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>The Entity Framework is the &#13;
<strong>Object Relational Mapping (ORM)</strong>&#13;
&#13;
  framework that enables developers to work on domain-specific objects directly for data access instead of working on database queries. This reduces a lot of the code complexity in the data access layer in the application.</p>&#13;
<p>Before discussing the Entity Framework and its features, let us pause for a moment and think about the steps that we follow when we try to save some information to the database when using ADO.NET:</p>&#13;
<p>&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Construct the business domain object.</li>&#13;
<li class="listitem" value="2">Create a connection to your database.</li>&#13;
<li class="listitem" value="3">Open the connection.</li>&#13;
<li class="listitem" value="4">Create a command object along with the command type.</li>&#13;
<li class="listitem" value="5">Add the properties of your business domain object to the parameters of the command object.</li>&#13;
<li class="listitem" value="6">Execute the command that saves the data into the database.</li>&#13;
</ol>&#13;
<div>&#13;
</p>&#13;
<p>We have to follow the previously mentioned six steps for common operations such as saving a piece of data into the database.</p>&#13;
<p>If you are using an ORM framework such as the Entity Framework, you just need three steps:</p>&#13;
<p>&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Construct the business domain object.</li>&#13;
<li class="listitem" value="2">Create the <code class="literal">DbContext</code>&#13;
 class for your business domain object. The instance of the <code class="literal">DbContext</code>&#13;
 class represents the session with the database.</li>&#13;
<li class="listitem" value="3">Save it to the database using the instance of the <code class="literal">DBContext</code>&#13;
 class.</li>&#13;
</ol>&#13;
<div>&#13;
</p>&#13;
<p>You might wonder how that is possible.</p>&#13;
<p>As a matter of fact, in the background, the Entity Framework creates a connection to the database and executes the query to save the business domain object to the database. To make it simple, the Entity Framework writes all the data access code for you so that you can concentrate on achieving the business functionality of the application rather than writing the database layer code.</p>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch05lvl2sec36"/>&#13;
 The Entity Framework is independent of ASP.NET MVC</h2>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>As discussed earlier, the Entity Framework is an ORM framework for accessing data and is independent of ASP.NET MVC. The Entity Framework could be used in &#13;
<strong>Windows Communication Foundation</strong>&#13;
&#13;
 (&#13;
<strong>WCF</strong>&#13;
&#13;
 ) services, Web API services, and even in console applications. You could use the Entity Framework in any type of application and make use of it to access data using objects. The concepts and the functionalities of the Entity Framework remain the same, irrespective of the type of application that you use it with.</p>&#13;
<p>Now, we are going to use the Entity Framework with the console application. This allows us to concentrate on the task at hand and demonstrate the functionalities of the Entity Framework instead of working on the boilerplate code of the ASP.NET Core application. In a later part of this chapter, we will integrate the Entity Framework with the ASP.NET Core application.</p>&#13;
<p>The latest version of the Entity Framework for the SQL server is 7.0.0 and it is still in beta at the time of writing this book. EF7 (Entity Framework 7) brings significant changes when compared to its previous version (Entity Framework 6). However, EF7 is the recommended version when building ASP.NET 5 applications and hence we will be using this version in this book.</p>&#13;
<p>&#13;
<h3 class="title"><a id="note6"/>&#13;
 Note</h3>&#13;
<p>We need a database to explain many of the features of the Entity Framework. Please install SQL Server 2014 Express on your PC before continuing further. Step by step instructions for installing SQL Server 2014 Express and SQL Server Management Studio is given in &#13;
<em>Appendix A</em>&#13;
&#13;
 .</p>&#13;
</p>&#13;
</div>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch05lvl2sec37"/>&#13;
 Creating console applications with the Entity Framework</h2>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>Follow these steps to create a simple console application:</p>&#13;
<p>&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Select &#13;
<strong>File</strong>&#13;
&#13;
 | &#13;
<strong>New Project</strong>&#13;
&#13;
 and select &#13;
<strong>Console Application</strong>&#13;
&#13;
 .</li>&#13;
<li class="listitem" value="2">Name the project and click on &#13;
<strong>OK</strong>&#13;
&#13;
 .<div><img src="img/Image00073.jpg" alt="Creating console applications with the Entity Framework"/>&#13;
</p>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
</ol>&#13;
<p>&#13;
</p>&#13;
</div>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch05lvl2sec38"/>&#13;
 Installing the Entity Framework 7 NuGet package</h2>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>There are two ways to install any <code class="literal">NuGet</code>&#13;
 package in your application:</p>&#13;
<p>&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">Using the <code class="literal">NuGet</code>&#13;
 Package Manager</li>&#13;
<li class="listitem">Using Package Manager Console</li>&#13;
</ul>&#13;
</p>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h3 class="title"><a id="ch05lvl3sec16"/>&#13;
 Using the NuGet Package Manager</h3>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>People who prefer graphical interfaces can use this option:</p>&#13;
<p>&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Right-click on the console project and select &#13;
<strong>Manage NuGet Packages</strong>&#13;
&#13;
 from the context menu:<div><img src="img/Image00074.jpg" alt="Using the NuGet Package Manager"/>&#13;
</p>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
<li class="listitem" value="2">Search for <code class="literal">EntityFramework.MicrosoftSqlServer</code>&#13;
 in the <code class="literal">NuGet</code>&#13;
 package and make sure the &#13;
<strong>Include prerelease</strong>&#13;
&#13;
 checkbox is checked. Click on &#13;
<strong>Install</strong>&#13;
&#13;
 once you select &#13;
<strong>EntityFramework.MicrosoftSqlServer</strong>&#13;
&#13;
 and select &#13;
<strong>Latest pre-release 7.0.0-rc1-final</strong>&#13;
&#13;
 (at the time of writing this book). You can select any latest version of Entity Framework 7:<div><img src="img/Image00075.jpg" alt="Using the NuGet Package Manager"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
<li class="listitem" value="3">Once you click on &#13;
<strong>Install</strong>&#13;
&#13;
 , the <code class="literal">NuGet</code>&#13;
 package manager will ask you to review the changes. Click on &#13;
<strong>OK</strong>&#13;
&#13;
 :<div><img src="img/Image00076.jpg" alt="Using the NuGet Package Manager"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
<li class="listitem" value="4">Click on &#13;
<strong>I Accept</strong>&#13;
&#13;
 in the &#13;
<strong>License Acceptance</strong>&#13;
&#13;
 window:<div><img src="img/Image00077.jpg" alt="Using the NuGet Package Manager"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
<li class="listitem" value="5">Once you click on &#13;
<strong>I Accept</strong>&#13;
&#13;
 , it will install the Entity Framework with all its dependencies. In the &#13;
<strong>Output</strong>&#13;
&#13;
 window, you will get the &#13;
<strong>Finished</strong>&#13;
&#13;
 message once the installation is complete:<div><img src="img/Image00078.jpg" alt="Using the NuGet Package Manager"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
</ol>&#13;
<p>&#13;
</p>&#13;
</div>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h3 class="title"><a id="ch05lvl3sec17"/>&#13;
 Using the Package Manager Console</h3>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>To install the <code class="literal">NuGet</code>&#13;
 package using the Package Manager Console, follow these steps:</p>&#13;
<p>&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Open the &#13;
<strong>Package Manager Console</strong>&#13;
&#13;
 window by selecting the menu option &#13;
<strong>View</strong>&#13;
&#13;
 | &#13;
<strong>Other Windows</strong>&#13;
&#13;
 | &#13;
<strong>Package Manager Console</strong>&#13;
&#13;
 .<div><img src="img/Image00079.jpg" alt="Using the Package Manager Console"/>&#13;
</p>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
<li class="listitem" value="2">Type <code class="literal">Install-Package EntityFramework.MicrosoftSqlServer - Pre</code>&#13;
 in the &#13;
<strong>Package Manager Console</strong>&#13;
&#13;
 window as shown in the following screenshot:<div><img src="img/Image00080.jpg" alt="Using the Package Manager Console"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
<li class="listitem" value="3">Once the installation is complete, a message, &#13;
<strong>Successfully installed 'EntityFramework.MicrosoftSqlServer 7.0.0-rc1-final'</strong>&#13;
&#13;
 , will be shown:<div><img src="img/Image00081.jpg" alt="Using the Package Manager Console"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
</ol>&#13;
<p>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch05lvl2sec39"/>&#13;
 Installing Entity Framework commands</h2>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>We need to install the Entity Framework commands package in order to perform migration activities. Migration includes the creation of a database and its associated tables. Any changes in the schema will also be taken care of by migration:</p>&#13;
<div><img src="img/Image00082.jpg" alt="Installing Entity Framework commands"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>As discussed earlier, we need to follow three steps in order to interact with the database when we are using the Entity Framework:</p>&#13;
<p>&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Create the <code class="literal">Model</code>&#13;
 classes.</li>&#13;
<li class="listitem" value="2">Create the <code class="literal">DbContext</code>&#13;
 class for your business domain object. The instance of the <code class="literal">DbContext</code>&#13;
 class represents the session with the database.</li>&#13;
<li class="listitem" value="3">Construct the business domain object and save it to the database using the instance of the <code class="literal">DBContext</code>&#13;
 class.</li>&#13;
</ol>&#13;
<div>&#13;
</p>&#13;
<p>Let us discuss each of the preceding steps in details and try to save an object to the database.</p>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h3 class="title"><a id="ch05lvl3sec18"/>&#13;
 Creating Model classes</h3>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>The <code class="literal">Model</code>&#13;
 classes are simple POCO objects, which can be used with the Entity Framework.</p>&#13;
<p>Let us create a POCO class for our business domain object, the <code class="literal">Employee</code>&#13;
 class in our case. I have created a new file named <code class="literal">Employee.cs</code>&#13;
 in our console application with the following content. This <code class="literal">Employee</code>&#13;
 class contains a few properties of an employee and has no special properties or fields to make it work with the Entity Framework.</p>&#13;
<p>Let's take a look at the following code snippet:</p>&#13;
<pre class="programlisting">public class Employee { 
  public int EmployeeId { get; set; } 
  public string Name { get; set; } 
  public decimal Salary { get; set; } 
  public string Designation { get; set; } 
} 
</pre>&#13;
<p>By convention, if the property name is <code class="literal">Id</code>&#13;
 or <code class="literal">ClassName+Id</code>&#13;
 , it will be considered as a primary key by Entity Framework while creating the database table.</p>&#13;
<p>Properties with string data types will be created as fields of the type <code class="literal">nvarchar(max)</code>&#13;
 . However, we can override this behavior by using annotations, which we will be discussed later.</p>&#13;
</div>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h3 class="title"><a id="ch05lvl3sec19"/>&#13;
 Creating the DbContext class</h3>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>The instance of the <code class="literal">DbContext</code>&#13;
 class represents the session to the database and this <code class="literal">DbContext</code>&#13;
 class does most of the heavy lifting of your data access for your application.</p>&#13;
<p>Create a new class by the named <code class="literal">EmployeeDbContext</code>&#13;
 with the following content:</p>&#13;
<pre class="programlisting">using Microsoft.Data.Entity; 
using System.Configuration; 
 
namespace ConsoleEF7 { 
  public class EmployeeDbContext : DbContext{ 
    public DbSet&lt;Employee&gt; Employees {get; set;} 
 
    protected override void OnConfiguring(DbContextOptionsBuilder      optionsBuilder) {string connectionString =        ConfigurationManager.ConnectionStrings       ["SqlServerExpress"].ConnectionString; 
      optionsBuilder.UseSqlServer(connectionString); 
      base.OnConfiguring(optionsBuilder); 
    } 
  } 
} 
</pre>&#13;
<p>Configure it using <code class="literal">App.Config</code>&#13;
 :</p>&#13;
<pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8" ?&gt; 
&lt;configuration&gt; 
  &lt;startup&gt; 
    &lt;supportedRuntime version="v4.0"  
    sku=".NETFramework,Version=v4.6.1" /&gt; 
  &lt;/startup&gt; 
  &lt;connectionStrings&gt; 
    &lt;add name="SqlServerExpress" connectionString="Data Source=     MUGIL-PC\SQLEXPRESS;Initial Catalog=EF7Console;Integrated      Security=True"/&gt; 
  &lt;/connectionStrings&gt; 
&lt;/configuration&gt; 
</pre>&#13;
<p>There are a few things to be noted in the preceding code snippet:</p>&#13;
<p>&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">Include the <code class="literal">Microsoft.Data.Entity</code>&#13;
 namespace as the <code class="literal">DbContext</code>&#13;
 class available in this namespace. Our connection string is available in the <code class="literal">App.Config</code>&#13;
 file. In order to read the contents of the <code class="literal">App.Config</code>&#13;
 file, we are including the <code class="literal">ConfigurationManager</code>&#13;
 class in <code class="literal">System.Configuration</code>&#13;
 .</li>&#13;
<li class="listitem">In order to use the <code class="literal">DbContext</code>&#13;
 API, a class has to be created which inherits from the <code class="literal">DbContext</code>&#13;
 class so that we can access methods of the <code class="literal">DbContext</code>&#13;
 API. We have created the <code class="literal">EmployeeDbContext</code>&#13;
 class which was inherited from <code class="literal">DbContext</code>&#13;
 class.</li>&#13;
<li class="listitem">&#13;
<code class="literal">DbSet</code>&#13;
 is a class which allows operations of the Entity Framework to be performed for a given Entity type. We need to create the <code class="literal">DbSet</code>&#13;
 object for each of the Entity types that we use in our application. In this example, we are using only one <code class="literal">DbSet</code>&#13;
 object as we are working with the <code class="literal">Employee</code>&#13;
 class.</li>&#13;
</ul>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch05lvl2sec40"/>&#13;
 Create a migration</h2>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>&#13;
&#13;
<strong>Migration</strong>&#13;
&#13;
 is the process of recording all the changes of your database. <code class="literal">Add-Migration</code>&#13;
 is the Entity Framework command for adding migration:</p>&#13;
<div><img src="img/Image00083.jpg" alt="Create a migration"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Once you add the migration, you can revoke the changes by executing the  <code class="literal">Remove-Migration</code>&#13;
 Entity Framework command.<div><img src="img/Image00084.jpg" alt="Create a migration"/>&#13;
</p>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">This is what the migrations directory looks like:<div><img src="img/Image00085.jpg" alt="Create a migration"/>&#13;
</p>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
</ul>&#13;
</div>&#13;
</li>&#13;
<li class="listitem" value="2">Update the database by issuing the Entity Framework command <code class="literal">Update-Database</code>&#13;
  , which updates the database tables as per the information available in the migration. As we have installed the <code class="literal">EntityFramework.Commands</code>&#13;
 package earlier, these commands will be available for the application:<div><img src="img/Image00086.jpg" alt="Create a migration"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
<li class="listitem" value="3">Once you update the database, you can see the changes in the database by connecting to SQL Server Management Studio:<div><img src="img/Image00087.jpg" alt="Create a migration"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</li>&#13;
<li class="listitem" value="4">Perform the database operation to save the business domain object in the database. You can create the database manually or, if the database is not available, it will create one for you.</li>&#13;
</ol>&#13;
<p>&#13;
</p>&#13;
<p>The <code class="literal">Main</code>&#13;
 method is updated with the following code:</p>&#13;
<pre class="programlisting">class Program { 
  static void Main(string[] args) { 
    AddEmployee(); 
  } 
 
  static void AddEmployee() { 
    using (var db = new EmployeeDbContext()) { 
      Employee employee= new Employee { 
        Designation = "Software Engineer", 
        Name = "Scott", 
        Salary = 5600 
      }; 
 
      db.Employees.Add(employee); 
      int recordsInserted = db.SaveChanges(); 
      Console.WriteLine("Number of records inserted:" +        recordsInserted); 
      Console.ReadLine();
    } 
  } 
} 
</pre>&#13;
<p>Firstly, we are constructing the business domain object. Then, we are adding the constructed <code class="literal">Employee</code>&#13;
 object to the employee's <code class="literal">DbSet</code>&#13;
 of the <code class="literal">DbContext</code>&#13;
 class. Finally, we are calling the <code class="literal">SaveChanges</code>&#13;
 method <code class="literal">DbContext</code>&#13;
 API, which will save all the pending changes to the database.</p>&#13;
<p>You might be wondering how it can save it to the database when we have not even given the connection string.</p>&#13;
<p>Let us discuss what happens behind the scenes when we run the program:</p>&#13;
<p>&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">When you make changes to any of the <code class="literal">DbSet</code>&#13;
 collection, the Entity Framework checks whether the database exists. If it does not exist, it creates a new one using the pattern <code class="literal">&lt;Namespace of DbContextName&gt;</code>&#13;
 . In our case, a database called by <code class="literal">EF6.EmployeeDbContext</code>&#13;
 would be created.</li>&#13;
<li class="listitem">Then, it creates database tables for the entities declared in <code class="literal">DbSet</code>&#13;
 . By convention, the Entity Framework uses the pluralized form of Entity for the table names. As we have declared <code class="literal">DbSet</code>&#13;
 for the <code class="literal">Employee</code>&#13;
 entity, the Entity Framework creates a pluralized form of <code class="literal">Employee</code>&#13;
 and creates the table named <code class="literal">Employees</code>&#13;
 .</li>&#13;
</ul>&#13;
</p>&#13;
<p>The creation of the database and tables happens when the following code is executed:</p>&#13;
<pre class="programlisting">db.Employees.Add(employee); 
</pre>&#13;
<p>When <code class="literal">SaveChanges</code>&#13;
 method is executed, the data in the <code class="literal">Employee</code>&#13;
 object will get saved to the database and returns the number of records affected. In the preceding case, it returns <code class="literal">1</code>&#13;
 .</p>&#13;
<p>When you run the application again, the first two steps mentioned previously will be skipped as the database and table will have already been created.</p>&#13;
<p>When you query the database, you can see the newly inserted record:</p>&#13;
<div><img src="img/Image00088.jpg" alt="Create a migration"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</div>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch05lvl2sec41"/>&#13;
 How the SaveChanges method works</h2>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>When we are making changes, the Entity Framework tracks the state of each of the objects and executes the appropriate query when <code class="literal">SaveChanges</code>&#13;
 method is called.</p>&#13;
<p>For example, when we add an <code class="literal">Employee</code>&#13;
 object to the employees' collection (<code class="literal">DbSet</code>&#13;
 ), this object is being tracked as <code class="literal">Entity</code>&#13;
 in the <code class="literal">Added</code>&#13;
 state. When <code class="literal">SaveChanges</code>&#13;
 is called, the Entity Framework creates an <code class="literal">insert</code>&#13;
 query for the same and executes it. The same is the case with updating and deleting the object. The Entity Framework sets the <code class="literal">Entity</code>&#13;
 state of the respective objects to <code class="literal">Modified</code>&#13;
 and <code class="literal">Deleted</code>&#13;
 . When <code class="literal">SaveChanges</code>&#13;
 is called, it creates and executes the <code class="literal">Update</code>&#13;
 and <code class="literal">Delete</code>&#13;
 queries.</p>&#13;
<div><img src="img/Image00089.jpg" alt="How the SaveChanges method works"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>The preceding figure explains how the <code class="literal">SaveChanges</code>&#13;
 method works at a high-level for different types of change. We have a couple of POCO objects (&#13;
<strong>Object 1</strong>&#13;
&#13;
 and &#13;
<strong>Object 2</strong>&#13;
&#13;
 ), which have been added to the employees' <code class="literal">DbSet</code>&#13;
 object. Let us assume &#13;
<strong>Object 3</strong>&#13;
&#13;
 and &#13;
<strong>Object 4</strong>&#13;
&#13;
 have been modified and objects &#13;
<strong>Object 5</strong>&#13;
&#13;
 and &#13;
<strong>Object 6</strong>&#13;
&#13;
 are in <code class="literal">Deleted</code>&#13;
 state. When you call <code class="literal">SaveChanges</code>&#13;
 method, it creates three sets of queries. The first set of queries is for the addition of objects, resulting in <code class="literal">insert</code>&#13;
 queries getting executed against the database. In the second set of queries, <code class="literal">Update</code>&#13;
 queries are created and executed for the objects whose state is modified. Finally, <code class="literal">Delete</code>&#13;
 queries are executed for the objects for all the <code class="literal">Deleted</code>&#13;
 state objects.</p>&#13;
</div>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch05lvl2sec42"/>&#13;
 Updating the record</h2>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>Let us try to update the salary of an inserted employee record using the Entity Framework:</p>&#13;
<pre class="programlisting">static void UpdateSalary() { 
  using (var db = new EmployeeDbContext()){ 
    Employee employee = db.Employees.Where(emp =&gt; emp.EmployeeId      == 1).FirstOrDefault(); 
    if(employee!=null){
      employee.Salary = 6500; 
      int recordsUpdated = db.SaveChanges(); 
      Console.WriteLine("Records updated:" + recordsUpdated); 
      Console.ReadLine(); 
    }
  } 
} 
</pre>&#13;
<p>In the preceding method, we find the employee with <code class="literal">EmployeeId = 1</code>&#13;
 . Then, we update the salary of the employee to <code class="literal">6500</code>&#13;
 and save the <code class="literal">employee</code>&#13;
 object to the database. Please note that, in the preceding method, we interact with the database a couple of times—once to find the correct employee record (<code class="literal">read</code>&#13;
 operation) and again to update the record (<code class="literal">update</code>&#13;
 operation).</p>&#13;
<pre class="programlisting">static void Main(string[] args){
  UpdateSalary(); 
} 
</pre>&#13;
<p>The <code class="literal">Main</code>&#13;
 method is updated to call the <code class="literal">UpdateSalary</code>&#13;
 method. When you query the database, you should see the record with the updated information:</p>&#13;
<div><img src="img/Image00090.jpg" alt="Updating the record"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</div>&#13;
<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch05lvl2sec43"/>&#13;
 Deleting the record</h2>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>Deleting the record is a bit tricky as it involves setting the state directly. In the following method, firstly we get the object and setting the state of the object to <code class="literal">Deleted</code>&#13;
 . Then calling the <code class="literal">SaveChanges</code>&#13;
 method will generate the <code class="literal">delete</code>&#13;
 query for the object and execute it, which in turn will eventually delete the record in the database:</p>&#13;
<pre class="programlisting">static void DeleteEmployee() { 
  using (var db = new EmployeeDbContext()) { 
    Employee employeeToBeDeleted = db.Employees.Where(emp =&gt;      emp.EmployeeId == 1).FirstOrDefault(); 
    if (employeeToBeDeleted != null) { 
      db.Entry(employeeToBeDeleted).State =        Microsoft.Data.Entity.EntityState.Deleted; 
      int recordsDeleted = db.SaveChanges(); 
      Console.WriteLine("Number of records deleted:" +        recordsDeleted); 
      Console.ReadLine(); 
    } 
  } 
} 
 
static void Main(string[] args) { 
  DeleteEmployee(); 
} 
</pre>&#13;
</div>&#13;
</div>&#13;

<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch05lvl1sec40"/>&#13;
 Using the Entity Framework in ASP.NET MVC applications</h1>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>There is not much difference between using the Entity Framework in a console application and ASP.NET MVC application. Now, we are going to build a simple application with a single screen as shown in the following image. In this screen, we will have a form where the user will enter the information about the employee; once the user submits the form, the information will be saved to the database and reflected in the following screenshots:</p>&#13;
<div><img src="img/Image00091.jpg" alt="Using the Entity Framework in ASP.NET MVC applications"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>We can create a simple Model for the employee. We need to build a ViewModel for this View, as we need to get the employee information from the user and we need to show a list of employees as well on the same screen.</p>&#13;
<p>Let us create an ASP.NET Core application, adding the employee and showing the list of employees. The following is the step-by-step instructions to create the application for the previously mentioned objective:</p>&#13;
<p>&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Create an ASP.NET Core project in Visual Studio by selecting an empty ASP.NET 5 application.</li>&#13;
<li class="listitem" value="2">Install the ASP.NET Core <code class="literal">NuGet</code>&#13;
 package.</li>&#13;
<li class="listitem" value="3">Install the Entity Framework 7 <code class="literal">NuGet</code>&#13;
 package and <code class="literal">&#13;
&#13;
<strong>ef</strong>&#13;
&#13;
</code>&#13;
 EntityFramework commands (for database migration) as explained earlier in this chapter.</li>&#13;
<li class="listitem" value="4">Add <code class="literal">config.json</code>&#13;
 to declare the connection string of the database:<pre class="programlisting">{ 
  "Data": { 
    "DefaultConnection": { 
      "ConnectionString": "Data Source=MUGIL-PC\\SQLEXPRESS;Initial Catalog=Validation;Integrated Security=True" 
    } 
  } 
} 
</pre>&#13;
</li>&#13;
<li class="listitem" value="5">Update <code class="literal">project.json</code>&#13;
 to include EntityFramework 7 and EntityFramework commands. The changes are highlighted in bold:<pre class="programlisting">{ 
  "version": "1.0.0-*", 
  "compilationOptions":{ 
    "emitEntryPoint": true 
  }, 
 
  "dependencies": { 
    "Microsoft.AspNet.IISPlatformHandler":      "1.0.0-rc1-final", 
    "Microsoft.AspNet.Mvc": "6.0.0-rc1-final", 
    "Microsoft.AspNet.Server.Kestrel": "1.0.0-rc1-final", 
    
<strong>"EntityFramework.MicrosoftSqlServer":      "7.0.0-rc1-final", 
    "EntityFramework.Commands": "7.0.0-rc1-final"</strong>&#13;

&#13;

 
  }, 
 
  "commands": { 
    "web": "Microsoft.AspNet.Server.Kestrel", 
    
<strong>"ef": "EntityFramework.Commands"</strong>&#13;

&#13;

 
  }, 
 
  "frameworks": { 
    "dnx451": { }, 
    "dnxcore50": { } 
  }, 
 
  "exclude": [ 
    "wwwroot", 
    "node_modules" 
  ], 
  "publishExclude": [ 
    "**.user", 
    "**.vspscc" 
  ] 
} 
</pre>&#13;
</li>&#13;
<li class="listitem" value="6">Configure MVC in the <code class="literal">Startup</code>&#13;
 class (<code class="literal">Startup.cs</code>&#13;
 ):<div>&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">In the constructor, we are building the configuration by reading the <code class="literal">config.json</code>&#13;
 file</li>&#13;
<li class="listitem">Add the MVC service and the Entity Framework service to the services in the <code class="literal">ConfigureServices</code>&#13;
 method</li>&#13;
<li class="listitem">Configure the MVC routing in the <code class="literal">Configure</code>&#13;
 method:<pre class="programlisting">using Microsoft.AspNet.Builder;
using Microsoft.AspNet.Hosting;
using Microsoft.AspNet.Http;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Configuration;
using Validation.Models;
using Microsoft.Data.Entity;
using Microsoft.Extensions.PlatformAbstractions;

namespace Validation {
 public class Startup {
 public IConfigurationRoot Configuration { get; set; }

public Startup(IHostingEnvironment env, IApplicationEnvironment appEnv) {
 var builder = new ConfigurationBuilder()
 .AddJsonFile("config.json")
 .AddEnvironmentVariables();
 Configuration = builder.Build();
 }

// This method gets called by the runtime. Use this method to add services to the container. 
// For more information on how to configure your application, visit http
://go.microsoft.com/fwlink/?LinkID=398940 

public void ConfigureServices(IServiceCollection services) {
services.AddEntityFramework()
 .AddSqlServer()
 .AddDbContext&lt;EmployeeDbContext&gt;(options =&gt; {
 options.UseSqlServer(Configuration.Get&lt;string&gt; ("Data:DefaultConnection:ConnectionString"));
 });
 services.AddMvc();
 }
// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
 
public void Configure(IApplicationBuilder app) {
 app.UseIISPlatformHandler();
 app.UseMvc(routes =&gt; {
 routes.MapRoute(
 name: "default",
 template: "{controller=Employee}/ {action=Index}/{id?}");
 });
 }
// Entry point for the application.
 public static void Main(string[] args) =&gt; WebApplication.Run&lt;Startup&gt;(args);
 }
 }</pre>&#13;
</li>&#13;
</ul>&#13;
</p>&#13;
</li>&#13;
<li class="listitem" value="7">Create <code class="literal">Models</code>&#13;
 and <code class="literal">DbContext</code>&#13;
  classes.</li>&#13;
<li class="listitem" value="8">Create the <code class="literal">Models</code>&#13;
 folder and add the <code class="literal">Employee</code>&#13;
 model class and <code class="literal">EmployeeDbContext</code>&#13;
 class.</li>&#13;
<li class="listitem" value="9">Create the <code class="literal">Employee</code>&#13;
 Model class (<code class="literal">Employee.cs</code>&#13;
 in the <code class="literal">Models</code>&#13;
 folder):<pre class="programlisting">public class Employee { 
  public int EmployeeId { get; set; } 
  public string Name { get; set; } 
  public string Designation { get; set; } 
  public decimal Salary { get; set; } 
} 
</pre>&#13;
</li>&#13;
<li class="listitem" value="10">Create <code class="literal">EmployeeDbContext</code>&#13;
 (<code class="literal">EmployeeDbContext.cs</code>&#13;
 in the <code class="literal">Models</code>&#13;
 folder):<pre class="programlisting">using Microsoft.Data.Entity; 
using Microsoft.Extensions.Configuration; 
 
namespace Validation.Models { 
  public class EmployeeDbContext : DbContext { 
 
    public IConfigurationRoot Configuration { get; set; } 
 
    public DbSet&lt;Employee&gt; Employees { get; set; } 
 
    public EmployeeDbContext() { 
      var builder = new ConfigurationBuilder() 
      .AddJsonFile("config.json") 
      .AddEnvironmentVariables(); 
      Configuration = builder.Build(); 
    } 
 
    protected override void OnConfiguring     (DbContextOptionsBuilder optionsBuilder) {      optionsBuilder.UseSqlServer       (Configuration.Get&lt;string&gt;       ("Data:DefaultConnection:ConnectionString")); 
      base.OnConfiguring(optionsBuilder); 
    } 
  } 
} 
</pre>&#13;
</li>&#13;
<li class="listitem" value="11">Create <code class="literal">ViewModels</code>&#13;
 :<p>&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">As we are going to show a list of employees and the form to add employees in the same screen, we are going to build a Model specific to this View. This model will contain information about the list of employees and the employee to be added.</li>&#13;
</ul>&#13;
</p>&#13;
</li>&#13;
<li class="listitem" value="12">Create the <code class="literal">ViewModels</code>&#13;
 folder and add the <code class="literal">EmployeeAddViewModel</code>&#13;
 :<pre class="programlisting">using MVCEF7.Models; 
 
namespace MVCEF7.ViewModels { 
  public class EmployeeAddViewModel { 
    public List&lt;Employee&gt; EmployeesList { get; set; } 
    public Employee NewEmployee { get; set; } 
  } 
} 
</pre>&#13;
<p>&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">This <code class="literal">ViewModel</code>&#13;
 has a couple of properties. <code class="literal">EmployeesList</code>&#13;
 and <code class="literal">NewEmployee</code>&#13;
 . <code class="literal">EmployeesList</code>&#13;
 will contain the list of employees. This list would be fetched from the database. <code class="literal">NewEmployee</code>&#13;
 will hold the employee information entered by the user.</li>&#13;
</ul>&#13;
</p>&#13;
</li>&#13;
<li class="listitem" value="13">Create <code class="literal">Controllers</code>&#13;
 to handle the incoming requests:<p>&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">Create a <code class="literal">Controllers</code>&#13;
 folder and add the <code class="literal">EmployeeController</code>&#13;
 class with a couple of action methods-one for <code class="literal">GET</code>&#13;
 and another for <code class="literal">POST</code>&#13;
 . The <code class="literal">Index</code>&#13;
 action method corresponding to the <code class="literal">GET</code>&#13;
 action method will be called when you access the URL (<code class="literal">http://localhost/Employee/Index</code>&#13;
 ) or when you run the application. The <code class="literal">POST Index</code>&#13;
 action method will be called when you submit the form as following:<pre class="programlisting">public IActionResult Index() { 
  EmployeeAddViewModel employeeAddViewModel = new    EmployeeAddViewModel(); 
  using (var db = new EmployeeDbContext()) { 
    employeeAddViewModel.EmployeesList =      db.Employees.ToList(); 
    employeeAddViewModel.NewEmployee = new Employee(); 
 
  } 
  return View(employeeAddViewModel); 
} 
</pre>&#13;
</li>&#13;
<li class="listitem">In the preceding <code class="literal">GET Index</code>&#13;
 action method, we are creating the <code class="literal">ViewModel</code>&#13;
 object and passing it to the View.</li>&#13;
<li class="listitem">The following code uses <code class="literal">POST Index</code>&#13;
 action method:<pre class="programlisting">[HttpPost] 
public IActionResult Index(EmployeeAddViewModel  employeeAddViewModel) { 
 
  using (var db = new EmployeeDbContext()) { 
    db.Employees.Add(employeeAddViewModel.NewEmployee); 
    db.SaveChanges(); 
    //Redirect to get Index GET method 
    return RedirectToAction("Index"); 
  } 
 
} 
</pre>&#13;
</li>&#13;
<li class="listitem">We get the <code class="literal">NewEmployee</code>&#13;
 property in the ViewModel, which contains the information on the user. Save it to the database. Once we save the employee information to the database and we redirect the control to the <code class="literal">GET Index</code>&#13;
 action method, the <code class="literal">GET Index</code>&#13;
 action method will again show the form to enter the employee information and the list of employees in table format.</li>&#13;
</ul>&#13;
</p>&#13;
</li>&#13;
<li class="listitem" value="14">Add the <code class="literal">Views</code>&#13;
 folder:<p>&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Create <code class="literal">Views\_ViewStart.cshtml</code>&#13;
 with the following content:<pre class="programlisting">@{ 
  Layout = "_Layout"; 
} 
</pre>&#13;
</li>&#13;
<li class="listitem" value="2">Create <code class="literal">Views\Shared\_Layout.cshtml</code>&#13;
  with the following content:<pre class="programlisting">&lt;!DOCTYPE html&gt; 
 
&lt;html&gt; 
  &lt;head&gt; 
    &lt;meta name="viewport" content="width=device-width" /&gt; 
    &lt;title&gt;@ViewBag.Title&lt;/title&gt; 
  &lt;/head&gt; 
  &lt;body&gt; 
    &lt;div&gt; 
      @RenderBody() 
    &lt;/div&gt; 
  &lt;/body&gt; 
&lt;/html&gt; 
</pre>&#13;
</li>&#13;
<li class="listitem" value="3">Create <code class="literal">Views\Employee\Index.cshtml</code>&#13;
  with the following content:<pre class="programlisting">@model MVCEF.ViewModels.EmployeeAddViewModel 
@* 
//For more information on enabling MVC for empty projects,  visit http://go.microsoft.com/fwlink/?LinkID=397860 
*@ 
@{ 
} 
 
&lt;div&gt; 
  @using (Html.BeginForm("Index", "Employee",    FormMethod.Post)) { 
    &lt;table&gt; 
      &lt;tr&gt; 
        &lt;td&gt;@Html.LabelFor(Model =&gt;          Model.NewEmployee.Name)&lt;/td&gt; 
        &lt;td&gt;@Html.TextBoxFor(Model =&gt;          Model.NewEmployee.Name)&lt;/td&gt; 
      &lt;/tr&gt; 
      &lt;tr&gt; 
        &lt;td&gt;@Html.LabelFor(Model =&gt;          Model.NewEmployee.Designation)&lt;/td&gt; 
        &lt;td&gt;@Html.TextBoxFor(Model =&gt;          Model.NewEmployee.Designation)&lt;/td&gt; 
      &lt;/tr&gt; 
      &lt;tr&gt; 
        &lt;td&gt;@Html.LabelFor(Model =&gt;          Model.NewEmployee.Salary)&lt;/td&gt; 
        &lt;td&gt;@Html.TextBoxFor(Model =&gt;          Model.NewEmployee.Salary)&lt;/td&gt; 
      &lt;/tr&gt; 
      &lt;tr&gt; 
        &lt;td colspan="2"&gt;&lt;input type="submit"          value="Submit"/&gt; 
        &lt;/td&gt; 
      &lt;/tr&gt; 
    &lt;/table&gt; 
 
  } 
&lt;/div&gt; 
 
&lt;br/&gt;&lt;br/&gt; &lt;br/&gt; 
 
&lt;b&gt; List of employees:&lt;/b&gt; &lt;br/&gt; 
&lt;div&gt; 
  &lt;table border="1"&gt; 
    &lt;tr&gt; 
      &lt;th&gt; ID &lt;/th&gt; 
      &lt;th&gt; Name &lt;/th&gt; 
      &lt;th&gt; Designation &lt;/th&gt; 
      &lt;th&gt; Salary &lt;/th&gt; 
    &lt;/tr&gt; 
    @foreach(var employee in Model.EmployeesList) { 
      &lt;tr&gt; 
        &lt;td&gt;@employee.EmployeeId&lt;/td&gt; 
        &lt;td&gt;@employee.Name&lt;/td&gt; 
        &lt;td&gt;@employee.Designation&lt;/td&gt; 
        &lt;td&gt;@employee.Salary&lt;/td&gt; 
      &lt;/tr&gt; 
    } 
  &lt;/table&gt; 
&lt;/div&gt; 
</pre>&#13;
</li>&#13;
</ol>&#13;
<div>&#13;
</p>&#13;
</li>&#13;
</ol>&#13;
<p>&#13;
</p>&#13;
<p>In the preceding <code class="literal">Index</code>&#13;
 view, we create a form where we get the employee information from the user in the topmost <code class="literal">div</code>&#13;
 . In the next <code class="literal">div</code>&#13;
 , we show the list of employees in a tabular format.</p>&#13;
<p>Once we create all the folders and the files, the project structure should look like the following:</p>&#13;
<div><img src="img/Image00092.jpg" alt="Using the Entity Framework in ASP.NET MVC applications"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</div>&#13;

<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch05lvl1sec41"/>&#13;
 Database migration</h1>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>We have created the business entity—the <code class="literal">Employee</code>&#13;
 class. Now, we can proceed with the migration. Migration is a two-step process: in the first step, we create the migration files. This can be done by executing the following command from the command prompt from the context of the project:</p>&#13;
<pre class="programlisting">

<strong>dnx ef migrations add InitialMigration</strong>&#13;

&#13;


</pre>&#13;
<div><img src="img/Image00093.jpg" alt="Database migration"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>This command will create the migration files in your project, as shown in the following screenshot:</p>&#13;
<div><img src="img/Image00094.jpg" alt="Database migration"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>Then execute the following command to create the database:</p>&#13;
<div><img src="img/Image00095.jpg" alt="Database migration"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>This command will read the migration files created in the previous step and create the database along with the associated tables:</p>&#13;
<div><img src="img/Image00096.jpg" alt="Database migration"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>Run the application. You will get the following screen, where the user can enter the employee information in the form. As we are using the strongly typed model in our view, it takes the default values for all the properties. The <code class="literal">Name</code>&#13;
 and <code class="literal">Designation</code>&#13;
 are properties of type <code class="literal">string</code>&#13;
 and the default values are empty string for these fields, <code class="literal">Salary</code>&#13;
 is of type <code class="literal">decimal</code>&#13;
 and the default value for <code class="literal">decimal</code>&#13;
 is <code class="literal">0</code>&#13;
   hence <code class="literal">0</code>&#13;
 is shown in the form when it is loaded for the <code class="literal">Salary</code>&#13;
 field.</p>&#13;
<p>As there are no records, we are showing <code class="literal">0</code>&#13;
 records in the <code class="literal">List of employees</code>&#13;
 table:</p>&#13;
<div><img src="img/Image00097.jpg" alt="Database migration"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>When you enter the information in the form and submit it, the information gets saved in the database and all the database records in the <code class="literal">Employees</code>&#13;
 table will be presented as follows:</p>&#13;
<div><img src="img/Image00098.jpg" alt="Database migration"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
</div>&#13;

<p>&#13;
<div>&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch05lvl1sec42"/>&#13;
 Summary</h1>&#13;
</p>&#13;
</div>&#13;
</div>&#13;
<p>In this chapter, we learned what a Model is and how it fits in the ASP.NET MVC application. Then, we created a simple Model, built model data in a Controller, passed the Model to the View, and shown the data using the View. We have learned about the &#13;
<em>Models specific to a View</em>&#13;
&#13;
 and have discussed the flow of the data with respect to Models. We learned about the Entity Framework, an ORM framework from Microsoft, and how it simplifies database access from your .NET application. We have created simple console application where we have inserted, updated, and deleted the records. Finally, we have built an ASP.NET Core application that uses Model, ViewModel, and Entity Framework.</p>&#13;
</div>&#13;
</body></html>