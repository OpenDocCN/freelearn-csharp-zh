<html><head></head><body>
<div><h1 class="chapterNumber"><a id="_idTextAnchor332"/>11</h1>
<h1 class="chapterTitle" id="_idParaDest-232"><a id="_idTextAnchor333"/>The Car Sharing App</h1>
<p class="normal">The Car Sharing app was introduced in <a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic">Chapter 2</em></a>, <em class="italic">Demystifying Microservices Applications</em>. Regardless of the technology used to implement it, any microservice is either processing a user interface request, processing a message from another microservice, or streaming a result to the communication bus defined for the solution. Therefore, we decided to dedicate a chapter to provide you with more details about it. The idea of putting the description of the entire solution into one chapter is to help you better understand the principles that we have covered throughout the book. Let’s now understand the general architecture of the app.</p>
<h1 class="heading-1" id="_idParaDest-233"><a id="_idTextAnchor334"/>General architecture description</h1>
<p class="normal">The application <a id="_idIndexMarker942"/>that we will describe in more detail in this chapter is the Car Sharing app. The following figure presents the entire solution and the microservices involved in enabling the solution:</p>
<figure class="mediaobject"><img alt="Figure 11.1: Car Sharing app" src="img/B31916_11_1.png"/></figure>
<p class="packt_figref">Figure 11.1: Car Sharing app</p>
<p class="normal">In <a href="Chapter_7.xhtml#_idTextAnchor151"><em class="italic">Chapter 7</em></a>,<em class="italic"> Microservices in Practice</em>, we described some messages of this demo that are exchanged between<a id="_idIndexMarker943"/> the microservices. All classes that implement these messages are included in the <code class="inlineCode">SharedMessages</code> library project presented in the demo code. It is important to mention that all microservices must add this library to facilitate communication between the services. It is also worth noting that RabbitMQ is the message broker defined for this demonstration, which has already been presented in the book.</p>
<h2 class="heading-2" id="_idParaDest-234"><a id="_idTextAnchor335"/>Microservices involved</h2>
<p class="normal">As you can see in the <a id="_idIndexMarker944"/>preceding figure, there are five microservices designed<a id="_idIndexMarker945"/> to demonstrate the solution. There is also a service that simply deploys the user interface using Blazor as the basis (Blazor UI). Its purpose is to host the user interface that interacts with the following microservices via HTTP and RabbitMQ where applicable.</p>
<h3 class="heading-3" id="_idParaDest-235"><a id="_idTextAnchor336"/>Authorization microservice</h3>
<p class="normal">In <a href="Chapter_10.xhtml#_idTextAnchor297"><em class="italic">Chapter 10</em></a>, <em class="italic">Security and Observability for Serverless and Microservices Applications</em>, we discussed the importance of implementing<a id="_idIndexMarker946"/> security with different layers of <a id="_idIndexMarker947"/>protection. The <strong class="keyWord">Authorization </strong>microservice is one of these layers, and it handles user logins and bearer token emissions. It also contains user information. It intercepts the route extension-accepted message of each car sharer and allows the users whose requests were accepted to access the car-sharer profile. The user who needs to car share can access the user profile of a car sharer who accepted their request by providing the route ID of the route it was accepted in.</p>
<p class="normal">To implement this, the ASP.NET Core Web API was used. The same bearer token will be required for all endpoints. These are the endpoints proposed for this microservice:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Login</strong> – Accepts credentials and returns a JWT</li>
<li class="bulletList"><strong class="keyWord">Renew</strong> – Accepts a token and returns a renewed JWT</li>
<li class="bulletList"><strong class="keyWord">Change Password</strong> – Accepts current and new passwords to update user credentials</li>
<li class="bulletList"><strong class="keyWord">Reset Password</strong> – Sends a temporary password to the user’s email</li>
<li class="bulletList"><strong class="keyWord">Add User</strong> – Registers a new user</li>
<li class="bulletList"><strong class="keyWord">User Profile</strong> – Provides user’s email and name for matched car-sharing trips</li>
</ul>
<p class="normal">The purpose of managing user login, password updates, and token generation is common to all applications. It is worth noting that, in the real world, many solutions will decide to have this service done by <strong class="keyWord">identity providers</strong> from Microsoft, Google, or Meta.</p>
<h3 class="heading-3" id="_idParaDest-236"><a id="_idTextAnchor337"/>CarSharer microservice</h3>
<p class="normal">The <strong class="keyWord">CarSharer </strong>microservice<a id="_idIndexMarker948"/> interacts with the Blazor UI and <a id="_idIndexMarker949"/>contains the web API that implements all car-sharer operations. The car sharer inserts an initial route containing their departure and destination towns and possible intermediary towns.</p>
<p class="normal">Then, they receive possible matchings with car-sharing requests by the <code class="codeHighlighted" style="font-weight: bold;">RoutesPlanning</code> microservice. Accordingly, it shows all possible extensions, and the car sharer can reject or accept each extension. They can also close the route, meaning they reach an acceptable number of people for the trip. Here, you have the routes imagined for the scenario of this sample:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Create Route</strong> – Creates a new route with the date and all towns’ milestones</li>
<li class="bulletList"><strong class="keyWord">Delete Route</strong> – Removes a specific route</li>
<li class="bulletList"><strong class="keyWord">Close Route</strong> – Closes a route to prevent further matching</li>
<li class="bulletList"><strong class="keyWord">Extend Route</strong> – Accepts user requests to an existing route</li>
<li class="bulletList"><strong class="keyWord">Get Suggested Extensions</strong> – Lists compatible ride requests for a route</li>
<li class="bulletList"><strong class="keyWord">Get Active Routes</strong> – Lists all active (not expired or deleted) routes for a specific user</li>
</ul>
<p class="normal">Considering this is essentially a CRUD operation, this microservice can be implemented using Azure Functions, as we discussed in <a href="Chapter_4.xhtml#_idTextAnchor105"><em class="italic">Chapter 4</em></a>, <em class="italic">Azure Functions and Triggers Available</em>.</p>
<h3 class="heading-3" id="_idParaDest-237"><a id="_idTextAnchor338"/>CarRequests microservice</h3>
<p class="normal">The<strong class="keyWord"> CarRequests</strong> microservice <a id="_idIndexMarker950"/>also interacts with the Blazor UI. It <a id="_idIndexMarker951"/>contains the web API that implements all car ride request operations. Requests to go from a source to a destination are inserted by the user. Then, the user can verify whether a car sharer inserted their request in their request. When a car sharer accepts the request, no other car sharer can select it, so just one option is handled. We assume that the user automatically accepts the car-sharer proposal. Here, we have the endpoints for this implementation:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Add New Request</strong> – Inserts a ride request with source, destination, and date. It is important to have confirmation of whether the request has been registered or not.</li>
<li class="bulletList"><strong class="keyWord">Get My Requests</strong> – Lists active requests with matching car-sharer options. Matching routes also contain the car owner’s details, which can be used to get user information from the authentication server.</li>
</ul>
<p class="normal">The Azure <a id="_idIndexMarker952"/>Functions<a id="_idIndexMarker953"/> technology here is, again, a good option.</p>
<h3 class="heading-3" id="_idParaDest-238"><a id="_idTextAnchor339"/>RoutesPlanning microservice</h3>
<p class="normal">The <strong class="keyWord">RoutesPlanning </strong>microservice <a id="_idIndexMarker954"/>matches car-sharer <a id="_idIndexMarker955"/>routes with car requests according to a distance minimization criterion. Its behavior is fully described in <a href="Chapter_7.xhtml#_idTextAnchor151"><em class="italic">Chapter 7</em></a>,<em class="italic"> Microservices in Practice</em>, and the technology used here is the ASP.NET Core Web API. To facilitate the understanding, the code that implements it is also available in this chapter.</p>
<h3 class="heading-3" id="_idParaDest-239"><a id="_idTextAnchor340"/>Email microservice</h3>
<p class="normal">To finish, the <strong class="keyWord">Email </strong>microservice<strong class="keyWord"> </strong>intercepts<a id="_idIndexMarker956"/> the route extension-accepted event <a id="_idIndexMarker957"/>emitted by a car sharer and informs all users included in the route that they were included via email. It works in the background, as we checked some implementations in <a href="Chapter_5.xhtml#_idTextAnchor122"><em class="italic">Chapter 5</em></a>, <em class="italic">Background Functions in Practice</em>. The route extension-accepted event emitted contains <code class="inlineCode">UserBasicInfoMessage</code>, where the user’s <code class="codeHighlighted" style="font-weight: bold;">DisplayName</code> in the example is supposed to be the email. These are the functions that will be executed in this microservice:</p>
<p class="normal">Listen to the <code class="codeHighlighted" style="font-weight: bold;">RouteExtensionAccepted</code> event and enqueue a request for sending an email</p>
<p class="normal">Process email, which is the routine that will dequeue the requests and send the email</p>
<p class="normal">The Azure Functions technology will be also used in this case. The idea of the microservice is not to have the processing of the emails attached directly to the listening event. That is why a queue is being used.</p>
<h1 class="heading-1" id="_idParaDest-240"><a id="_idTextAnchor341"/>The demonstration code</h1>
<p class="normal">You<a id="_idIndexMarker958"/> can find the <a id="_idIndexMarker959"/>sample code for this chapter at <a href="https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp/tree/main/ch11">https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp/tree/main/ch11</a>. This chapter will require, at least, the Visual Studio 2022 free <em class="italic">Community Edition</em>.</p>
<p class="normal">Please note that the provided code is not fully functional. You, as the reader, are encouraged to further develop it. Its main purpose is to offer a foundation for implementing different microservice approaches in a specific use case.</p>
<p class="normal">The following table summarizes the list of microservices proposed: </p>
<table class="table-container" id="table001-2">
<thead>
<tr>
<th class="table-head">
<p class="normal"><strong class="keyWord">Microservice</strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord">Technology</strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord">Key Responsibility</strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord">API/Event Highlights</strong></p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td class="table-cell">
<p class="normal"><code class="codeHighlighted" style="font-weight: bold;">Authorization</code></p>
</td>
<td class="table-cell">
<p class="normal">ASP.NET Core Web API</p>
</td>
<td class="table-cell">
<p class="normal">Manage user auth and profiles</p>
</td>
<td class="table-cell">
<p class="normal"><code class="codeHighlighted" style="font-weight: bold;">Login</code>, <code class="codeHighlighted" style="font-weight: bold;">Renew</code>, <code class="codeHighlighted" style="font-weight: bold;">AddUser</code>, <code class="codeHighlighted" style="font-weight: bold;">GetProfile</code></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><code class="codeHighlighted" style="font-weight: bold;">CarSharer</code></p>
</td>
<td class="table-cell">
<p class="normal">Azure Functions</p>
</td>
<td class="table-cell">
<p class="normal">Manage car owner routes</p>
</td>
<td class="table-cell">
<p class="normal"><code class="codeHighlighted" style="font-weight: bold;">CreateRoute</code>, <code class="codeHighlighted" style="font-weight: bold;">ExtendRoute</code>, <code class="codeHighlighted" style="font-weight: bold;">GetSuggestions</code></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><code class="codeHighlighted" style="font-weight: bold;">CarRequest</code></p>
</td>
<td class="table-cell">
<p class="normal">Azure Functions</p>
</td>
<td class="table-cell">
<p class="normal">Manage ride requests from users</p>
</td>
<td class="table-cell">
<p class="normal"><code class="codeHighlighted" style="font-weight: bold;">AddRequest</code>, <code class="codeHighlighted" style="font-weight: bold;">GetRequests</code></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><code class="codeHighlighted" style="font-weight: bold;">RoutesPlanning</code></p>
</td>
<td class="table-cell">
<p class="normal">ASP.NET Core Web API</p>
</td>
<td class="table-cell">
<p class="normal">Suggest optimal route-request matches</p>
</td>
<td class="table-cell">
<p class="normal">Event-driven logic, covered in <a href="Chapter_7.xhtml#_idTextAnchor151"><em class="italic">Chapter 7</em></a></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><code class="codeHighlighted" style="font-weight: bold;">Email</code></p>
</td>
<td class="table-cell">
<p class="normal">Azure Functions</p>
</td>
<td class="table-cell">
<p class="normal">Notify users via email</p>
</td>
<td class="table-cell">
<p class="normal"><code class="codeHighlighted" style="font-weight: bold;">RouteExtensionAccepted</code> → Queue → Email</p>
</td>
</tr>
</tbody>
</table>
<p class="normal">A SQL instance accepts TCP/IP requests and user/password authentication since it must communicate with clients running inside Docker containers. Please note that the SQL instance that comes with the Visual Studio installation doesn’t support TCP/IP, so you need either to install SQL Server Express or use a cloud instance. For local installation, both the installer and instructions are available here: <a href="https://www.microsoft.com/en-US/download/details.aspx?id=104781">https://www.microsoft.com/en-US/download/details.aspx?id=104781</a>. You may also run the SQL Server development edition as a Docker image with the following:</p>
<pre class="programlisting con"><code class="hljs-con">docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=yourStrong(!)Password" -p 1433:1433 -d mcr.microsoft.com/mssql/server:2022-latest
</code></pre>
<ol>
<li class="numberedList" value="1">The username corresponding to the chosen password will be <code class="inlineCode">sa</code>.</li>
<li class="numberedList">To run<a id="_idIndexMarker960"/> Docker, use <strong class="keyWord">Docker Desktop</strong> for Windows (<a href="https://www.docker.com/products/docker-desktop">https://www.docker.com/products/docker-desktop</a>).</li>
<li class="numberedList"><strong class="keyWord">Docker Desktop</strong>, in turn, requires <strong class="keyWord">Windows Subsystem for Linux</strong> (<strong class="keyWord">WSL</strong>), which can be<a id="_idIndexMarker961"/> installed by <a id="_idIndexMarker962"/>following<a id="_idIndexMarker963"/> these steps:</li>
<li class="numberedList">Type <code class="codeHighlighted" style="font-weight: bold;">powershell</code> in the Windows 10/11 search bar.</li>
<li class="numberedList">When Windows PowerShell is proposed as a search result, click on <strong class="screenText">Run as an administrator</strong>.</li>
<li class="numberedList">In the Windows PowerShell administrative console that appears, run the <code class="codeHighlighted" style="font-weight: bold;">wsl --install</code> command.</li>
</ol>
<p class="normal">The following figure shows how the code structure is organized:</p>
<figure class="mediaobject"><img alt="Figure 11.2: Car Sharing app code structure" src="img/B31916_11_2.png"/></figure>
<p class="packt_figref">Figure 11.2: Car Sharing app code structure</p>
<p class="normal">As you can see, there <a id="_idIndexMarker964"/>is a <code class="codeHighlighted" style="font-weight: bold;">Common</code> library that shares messages that will be<a id="_idIndexMarker965"/> transferred between the microservices. <code class="codeHighlighted" style="font-weight: bold;">Authorization</code> and <code class="codeHighlighted" style="font-weight: bold;">RoutesPlanning</code> were written using web API microservices while <code class="codeHighlighted" style="font-weight: bold;">CarRequests</code>, <code class="codeHighlighted" style="font-weight: bold;">CarSharer</code>, and <code class="codeHighlighted" style="font-weight: bold;">Email</code> were written using Azure Functions as the basis. That is why we showed both possibilities during the presentation of the book. According to what we have presented, depending on the complexity of the microservices and the real need of the business rules, we<a id="_idIndexMarker966"/> can <a id="_idIndexMarker967"/>choose between one of these alternatives for creating distributed applications.</p>
<h1 class="heading-1" id="_idParaDest-241"><a id="_idTextAnchor342"/>Summary</h1>
<p class="normal">In this chapter, we have presented a detailed demonstration of an event-driven application using microservices as the basis for connecting each message that is transferred from frontend to backend. We hope that this demo will help you better understand all the principles that we have presented throughout the book.</p>
<h1 class="heading-1" id="_idParaDest-242"><a id="_idTextAnchor343"/>Further reading</h1>
<ul>
<li class="bulletList">Cloud design patterns: <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/">https://learn.microsoft.com/en-us/azure/architecture/patterns/</a><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/ "/></li>
<li class="bulletList">Event-driven application: <a href="https://learn.microsoft.com/en-us/azure/architecture/guide/architecture-styles/event-driven">https://learn.microsoft.com/en-us/azure/architecture/guide/architecture-styles/event-driven</a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-243"><a id="_idTextAnchor344"/>Join our community on Discord</h1>
<p class="normal">Join our community’s Discord space for discussions with the author and other readers:</p>
<p class="normal"><a href="https://packt.link/PSMCSharp">https://packt.link/PSMCSharp</a></p>
<p class="normal"><img alt="A qr code with black squares  AI-generated content may be incorrect." src="img/B31916_Discord-QR-Code.png"/></p>
</div>
</body></html>