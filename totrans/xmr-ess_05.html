<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Developing Your First Android App with Xamarin.Android</h1></div></div></div><p>In this chapter, we will develop a sample app similar to <code class="literal">NationalParks.iOS</code> from the last chapter using Xamarin.Android. This chapter covers the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Overview of the sample app</li><li class="listitem" style="list-style-type: disc">Creating a Xamarin.Android app</li><li class="listitem" style="list-style-type: disc">Editing Android layout files with Xamarin Studio</li><li class="listitem" style="list-style-type: disc">Running and debugging apps with Xamarin Studio</li><li class="listitem" style="list-style-type: disc">Running and debugging apps with Visual Studio</li><li class="listitem" style="list-style-type: disc">Inspecting compile-time generated elements of a Xamarin.Android app</li></ul></div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec41"/>The sample app</h1></div></div></div><p>The <a class="indexterm" id="id336"/>sample app we will create in this chapter follows the same basic design as the <code class="literal">NationalParks.iOS</code> app from the previous chapter. To review the screen mockups and general description you can refer to the <em>The sample national parks app</em> section in <a class="link" href="ch04.html" title="Chapter 4. Developing Your First iOS App with Xamarin.iOS">Chapter 4</a>, <em>Developing Your First iOS App with Xamarin.iOS</em>. The following screenshots show the Android screens from the provided solution:</p><div><img alt="The sample app" src="img/0838OT_05_06.jpg"/></div><p>There is one design <a class="indexterm" id="id337"/>change we will introduce in the Android version of the app; we will create a singleton class to help manage loading and saving parks to a JSON-formatted file. This will be discussed further when we start building the singleton class in an upcoming section, <em>Creating the NationalParksData singleton</em>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec42"/>Creating NationalParks.Droid</h1></div></div></div><p>We will begin by<a class="indexterm" id="id338"/> creating a new Android project and adding it to our existing <code class="literal">NationalParks</code> solution created in the previous chapter. Xamarin Studio allows both Android and iOS projects to be part of the same solution. This proves to be very useful particularly as we move towards the later chapters that are focused on code reuse. You will find that the next chapter, <a class="link" href="ch06.html" title="Chapter 6. The Sharing Game">Chapter 6</a>, <em>The Sharing Game</em>, will show you exactly how to do this.</p><p>To create the national parks Android app, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">You first need to launch Xamarin Studio and open the <code class="literal">NationalParks</code> solution created in the previous chapter.</li><li class="listitem">Following this, select the <code class="literal">NationalParks</code> solution in the <strong>Solution</strong> pad on the left-hand side of Xamarin Studio, right-click on it, and navigate to <strong>Add</strong> | <strong>Add New Project…</strong>, as shown in the following screenshot:<div><img alt="Creating NationalParks.Droid" src="img/0838OT_05_07.jpg"/></div></li><li class="listitem">Navigate to <strong>C#</strong> | <strong>Android</strong> on the <a class="indexterm" id="id339"/>left-hand side of the dialog box and <strong>Android Application</strong> in the middle section, as follows:<div><img alt="Creating NationalParks.Droid" src="img/0838OT_05_08.jpg"/></div></li><li class="listitem">You now need to enter <code class="literal">NationalParks.Droid</code> in the <strong>Name</strong> field and click on <strong>OK</strong>. Xamarin Studio will then create a new project, add it to the <code class="literal">NationalParks</code> solution, and open it.</li></ol></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec43"/>Reviewing the app</h1></div></div></div><p>A simple <a class="indexterm" id="id340"/>working app has been created that contains a number of files; let's take a few minutes to review what was created.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec45"/>Resources</h2></div></div></div><p>The <a class="indexterm" id="id341"/><code class="literal">Resources</code> folder<a class="indexterm" id="id342"/> corresponds to the <code class="literal">res</code> folder in a traditional Java Android app. It contains subfolders with the various types of resources that can be used, including layouts, menus, drawables, strings, and styles. Subfolders within <code class="literal">Resources</code> follow the same naming conventions as in traditional Java Android apps, drawables, layouts, values, and so on.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec46"/>The Resource.designer.cs file</h2></div></div></div><p>
<code class="literal">Resource.designer.cs</code> is a C# source<a class="indexterm" id="id343"/> file in the <code class="literal">Resources</code> folder that is generated by Xamarin.Android <a class="indexterm" id="id344"/>and contains constant ID definitions for all the resources in the app; it corresponds to the <code class="literal">R.java</code> file generated for Java Android apps.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec47"/>The MainActivity.cs file</h2></div></div></div><p>
<code class="literal">MainActivity.cs</code> is a <a class="indexterm" id="id345"/>C# source file in<a class="indexterm" id="id346"/> the root of the <code class="literal">NationalParks.Droid</code> project and is the only activity added to the project. Open the file to view the contents. Note the attributes at the top of the class:</p><div><pre class="programlisting">[Activity (Label = "NationalParks.Droid",
    MainLauncher = true)]</pre></div><p>The specification of <code class="literal">Label</code> and <code class="literal">MainLauncher</code> will affect the contents of <code class="literal">ApplicationManifest.xml</code>. Note the overridden <code class="literal">OnCreate()</code> method in the following code snippet:</p><div><pre class="programlisting">protected override void OnCreate (Bundle bundle)
{
    base.OnCreate (bundle);

    // Set our view from the "main" layout resource
    SetContentView (Resource.Layout.Main);

    // Get our button from the layout resource,
    // and attach an event to it
    Button button =
        FindViewById&lt;Button&gt; (Resource.Id.myButton);
      
    button.Click += delegate {
        button.Text = string.Format (
            "{0} clicks!", count++);
    };
}</pre></div><p>With the exception<a class="indexterm" id="id347"/> of the fact that <code class="literal">OnCreate()</code> is using C# syntax, the code within it looks very similar to what you might find in <a class="indexterm" id="id348"/>a Java Android app. Near the top, the content is set to the <code class="literal">Main</code> layout file; <code class="literal">Resource.Layout.Main</code> is a constant defined in <code class="literal">Resource.designer.cs</code>. A reference to a <code class="literal">Button</code> instance is obtained by a call to <code class="literal">FindViewById()</code>, and then an event handler is assigned to handle click events.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec48"/>The Main.axml file</h2></div></div></div><p>
<code class="literal">Main.axml</code> <a class="indexterm" id="id349"/>is an XML layout file<a class="indexterm" id="id350"/> located in the <code class="literal">Resources/layout</code> folder. Xamarin.Android uses the extension <code class="literal">.axml</code> for layout files rather than simply using <code class="literal">.xml</code>. Other than using a different extension, Xamarin.Android treats layout files in essentially the same way that a Java Android app does. Open <code class="literal">Main.axml</code> to view the contents; at the bottom of the screen, there are tabs to switch between a visual, content view, and a source or XML view. Notice that there is a single <code class="literal">Button</code> instance defined with <code class="literal">LinearLayout</code>.</p><p>Xamarin.Android honors the Android <a class="indexterm" id="id351"/>naming convention for layout folders, as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Resources/layout</code>: This naming convention is used for a normal screen size (default)</li><li class="listitem" style="list-style-type: disc"><code class="literal">Resources/layout-small</code>: This naming convention is used for small screens</li><li class="listitem" style="list-style-type: disc"><code class="literal">Resources/layout-large</code>: This naming convention is used for large screens</li><li class="listitem" style="list-style-type: disc"><code class="literal">Resources/layout-land</code>: This naming convention is used for a normal screen size in landscape mode</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec49"/>Project Options</h2></div></div></div><p>There are <a class="indexterm" id="id352"/>many options that can be set that affect the way your app is compiled, linked, and executed. These options can be viewed <a class="indexterm" id="id353"/>and modified from the <strong>Project Options</strong> dialog box. The sections that are most interesting for Android apps are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Build</strong> | <strong>General</strong>: This setting is used for the Target framework version</li><li class="listitem" style="list-style-type: disc"><strong>Build</strong> | <strong>Android Build</strong>: This setting is used by the compile and link process to optimize the resulting executable</li><li class="listitem" style="list-style-type: disc"><strong>Build</strong> | <strong>Android Application</strong>: This setting gives the default package name, app version number, and app permissions</li></ul></div><p>To set the Target framework version for <code class="literal">NationalParks.Droid</code>, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">NationalParks.Droid</code> project in the <strong>Solution</strong> pad.</li><li class="listitem">Right-click and select <strong>Options</strong>.</li><li class="listitem">Navigate to <strong>Build</strong> | <strong>General</strong> and set the <strong>Target Framework</strong> option to <strong>4.0.3 (Ice Cream Sandwich)</strong> and click on <strong>OK</strong>.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec50"/>Xamarin Studio Preferences</h2></div></div></div><p>Xamarin Studio<a class="indexterm" id="id354"/> provides<a class="indexterm" id="id355"/> a <strong>Preferences</strong> dialog box that allows you to adjust various preferences that control how the environment operates. These are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Projects</strong> | <strong>SDK Locations</strong> | <strong>Android</strong>: Using this option, you can control the location for the Android SDK, Java SDK, and Android NDK that should be used to compile and run apps</li><li class="listitem" style="list-style-type: disc"><strong>Projects</strong> | <strong>Android</strong>: These settings affect how the Android Emulator is launched including command-line arguments</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec44"/>Running and debugging with Xamarin Studio</h1></div></div></div><p>While the <a class="indexterm" id="id356"/>app we currently have is very simple, it is runnable, and now is a good time to take a look at how you can<a class="indexterm" id="id357"/> execute and debug Xamarin.Android apps. Apps <a class="indexterm" id="id358"/>can be <a class="indexterm" id="id359"/>executed in a number of ways; the two most common ways are the Android Emulator and a physical device.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec51"/>Running apps with the Android Emulator</h2></div></div></div><p>Xamarin.Android<a class="indexterm" id="id360"/> works with the Android Emulator to support executing and debugging your app. When Xamarin.Android is installed, a number of <a class="indexterm" id="id361"/><strong>Android Virtual Devices</strong> (<strong>AVD</strong>) are automatically set up for your use. You can launch the AVD Manager from the <strong>Tools</strong> menu by choosing <strong>Open Android Emulator Manager</strong>.</p><p>To run<a class="indexterm" id="id362"/> <code class="literal">NationalParks.Droid</code>, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Click on the <strong>Start/Stop</strong> button on the left-hand side of the taskbar. You can also run the app by pressing <em>F5</em> or by navigating to <strong>Run</strong> | <strong>Start Debugging</strong>.</li><li class="listitem">Then, select an AVD on the <strong>Select Device</strong> dialog box and click on <strong>Start Emulator</strong>.</li><li class="listitem">When the emulator has completed startup, select the name of the running emulator instance in the <strong>Devices</strong> list and click on <strong>OK</strong>.</li><li class="listitem">You now need to click on the <strong>Hello World</strong> button on the app and note the caption change.</li><li class="listitem">Switch back to Xamarin Studio and stop the app by clicking on the <strong>Start/Stop</strong> button on the left-hand side of the taskbar.</li><li class="listitem">Open <code class="literal">MainActivity.cs</code> and set a breakpoint on the <code class="literal">SetContentView()</code> statement in <code class="literal">OnCreate()</code> by clicking in the far-left margin of the editor window, which you can see in the following screenshot. At this point, restart <code class="literal">NationalParks.Droid</code>; the app will stop at the breakpoint:<div><img alt="Running apps with the Android Emulator" src="img/0838OT_05_02.jpg"/></div></li><li class="listitem">You will find the basic flow controls to step through execution in the taskbar. These allow you to (icons from left to right) continue execution, step over the current line, step into the current function, and step out of the current function:<div><img alt="Running apps with the Android Emulator" src="img/0838OT_05_05.jpg"/></div></li><li class="listitem">Use the step controls to go to line 27, highlight the button in the text, right-click <a class="indexterm" id="id363"/>on it and <a class="indexterm" id="id364"/>select <strong>Expression Evaluator</strong>. The <strong>Expression Evaluator</strong> dialog box can be used to view the state of objects during the program execution, as follows:<div><img alt="Running apps with the Android Emulator" src="img/0838OT_05_03.jpg"/></div></li><li class="listitem">You will also notice a set of panels at the bottom of Xamarin Studio that contains tabs for <strong>Watch</strong>, <strong>Locals</strong>, <strong>Breakpoints</strong>, <strong>Threads</strong>, <strong>Application Output</strong>, and <strong>Call Stack</strong>, as follows:<div><img alt="Running apps with the Android Emulator" src="img/0838OT_05_04.jpg"/></div></li><li class="listitem">Click on the <strong>Continue</strong> button to allow the app to continue running.</li></ol></div><p>As you can<a class="indexterm" id="id365"/> see, Xamarin Studio, in combination with the Android Emulator, provides a robust environment to<a class="indexterm" id="id366"/> execute and debug apps with most of the features that can be found in most modern IDEs.</p><p>You can make any modifications to the list of AVDs from the AVD Manager (<strong>Tools</strong> | <strong>Open Android Emulator Manager</strong>), and you can make any adjustments to the Android SDK from Android SDK Manager (<strong>Tools</strong> | <strong>Open Android SDK Manager</strong>).</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec52"/>Running apps on a physical device</h2></div></div></div><p>Xamarin Studio also <a class="indexterm" id="id367"/>supports debugging apps running on a physical device. This is generally the most productive way to develop and debug apps as many of the device features can be challenging to configure and use in the emulator. There is really nothing special about getting Xamarin Studio to work with a device; simply go through the normal steps of enabling USB debugging on the device, attach the device to your computer, and start the app from Xamarin Studio; the device will show up in Xamarin Studio's <strong>Select Device</strong> dialog box. As you might be aware, on Windows, a special USB driver is required that corresponds with the device being used; generally OS X users are good to go.</p><p>The issues related to debugging with an emulator or physical device is not unique or even different because of the use of Xamarin; it's an issue that all Android developers face.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec53"/>Running apps with Genymotion</h2></div></div></div><p>A while <a class="indexterm" id="id368"/>ago, I became aware of<a class="indexterm" id="id369"/> another option to run Android apps. Genymotion is a product that is based on the VirtualBox virtualization platform. Genymotion provides a set of virtual device templates for many of the Android devices available on the market today. Once a virtual device is created, you simply start it and it will be selectable from Xamarin Studio's <strong>Select Device</strong> dialog box just like a running AVD.</p><p>With all the different device templates that come with Genymotion, it's a great testing tool. Genymotion also has a much quicker start time and a much more responsive execution time than the standard Android Emulators. There are free and paid versions depending on what features you need, irrespective of whether you are using Xamarin.Android or native Java Android development. You can find more information about Genymotion on their home page <a class="indexterm" id="id370"/>at <a class="ulink" href="http://www.genymotion.com">http://www.genymotion.com</a>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec45"/>Extending NationalParks.Droid</h1></div></div></div><p>As we <a class="indexterm" id="id371"/>have a good understanding of our starting point, we can now turn our attention to enhance <a class="indexterm" id="id372"/>what we have to support the features we need. We have the following enhancements to complete:</p><div><ol class="orderedlist arabic"><li class="listitem">Add a <code class="literal">ListView</code> instance to <code class="literal">MainActivity</code> to list national parks and an add action in the <code class="literal">ActionBar</code> class to add a new national park.</li><li class="listitem">Add a detail view that can be used to view and update national parks with actions to save and delete national parks as well as to view photos on <a class="ulink" href="http://www.Bing.com">www.Bing.com</a> and get directions from a map provider.</li><li class="listitem">Add logic to load and save national parks to a JSON-formatted text file.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec54"/>Storing and loading national parks</h2></div></div></div><p>Similar to<a class="indexterm" id="id373"/> the <code class="literal">NationalParks.iOS</code> project, we will store our parks data in a JSON-formatted text file. In this project, we will create a singleton class to help manage<a class="indexterm" id="id374"/> loading and saving parks. We are going with a singleton class for a couple of reasons:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the next chapter, we are <a class="indexterm" id="id375"/>going to start looking at sharing and reusing code; this gets us started on a solution we will want to reuse</li><li class="listitem" style="list-style-type: disc">It's a little more <a class="indexterm" id="id376"/>difficult to pass an object between <code class="literal">Activities</code> in Android than it is between <code class="literal">ViewControllers</code> in iOS, and the singleton class will provide a convenient way to share park data</li></ul></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec22"/>Adding Json.NET</h3></div></div></div><p>If you<a class="indexterm" id="id377"/> worked through <a class="link" href="ch04.html" title="Chapter 4. Developing Your First iOS App with Xamarin.iOS">Chapter 4</a>, <em>Developing Your First iOS App with Xamarin.iOS</em>, Json.NET will already be installed on your machine and you simply need to add this to your project.</p><p>To add Json.NET to the <code class="literal">NationalParks.Droid</code> project, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">Components</code> folder in the <code class="literal">NationalParks.Droid</code> project in the <strong>Solution</strong> pad, right-click and choose <strong>Edit Components</strong>.</li><li class="listitem">If you see Json.NET listed in the <strong>Installed on this machine</strong> section, click on <strong>Add to Project</strong> and you are done; otherwise continue with the next step.</li><li class="listitem">In the upper-right hand corner, click on <strong>Get More Components</strong> and enter <code class="literal">Json.NET</code> in the search field.</li><li class="listitem">Select <strong>Json.NET</strong> from the list and choose <strong>Add to App</strong>.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec23"/>Borrowing the entity class and JSON file</h3></div></div></div><p>We need an <a class="indexterm" id="id378"/>entity class that represents our subject area: the national parks. This sounds familiar if you worked through <a class="link" href="ch04.html" title="Chapter 4. Developing Your First iOS App with Xamarin.iOS">Chapter 4</a>, <em>Developing Your First iOS App with Xamarin.iOS</em>, where we created one. As one already exists, there is no need to create one from scratch, so let's<a class="indexterm" id="id379"/> just copy it from <code class="literal">NationalParks.iOS</code>. In <a class="link" href="ch06.html" title="Chapter 6. The Sharing Game">Chapter 6</a>, <em>The Sharing Game</em>, we will look at actually sharing the code between projects.</p><p>To copy the <code class="literal">NationalPark.cs</code> file, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">NationalPark.cs</code> file in the <code class="literal">NationalParks.iOS</code> project, right-click on it, and choose <strong>Copy</strong>.</li><li class="listitem">Select the <code class="literal">NationalPark.Droid</code> project, right-click on it and choose <strong>Paste</strong>.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec24"/>Creating the NationalParksData singleton</h3></div></div></div><p>As we <a class="indexterm" id="id380"/>mentioned previously, we will create a singleton class to simplify sharing and accessing national parks. A singleton is a design pattern that restricts the number of instances of class that can exist within an app to a single instance. Singletons can be helpful in maintaining global state and sharing a single object across multiple views. For our purposes, the singleton pattern simplifies managing a single collection of national parks and housing the logic required to load and save parks to a JSON-formatted file. </p><p>To create<a class="indexterm" id="id381"/> <code class="literal">NationalParksData</code>, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Select <code class="literal">NationalParks.Droid</code>, right-click on it, and navigate to <strong>Add</strong> | <strong>New File</strong>.</li><li class="listitem">Select <strong>General</strong> | <strong>Empty Class</strong>, enter <code class="literal">NationalParksData</code> for the <strong>Name</strong> field, and click on <strong>New</strong>.</li><li class="listitem">Add a <code class="literal">static</code> <code class="literal">instance</code> property to access a single instance for <code class="literal">NationalParksData</code> and initialize the single instance in the getter for the property, as follows:<div><pre class="programlisting">private static NationalParksData _instance;
public static NationalParksData Instance
{
    get { return _instance ??
        (_instance = new NationalParksData()); }
}</pre></div></li><li class="listitem">Add a <code class="literal">Parks</code> collection property to load the parks into:<div><pre class="programlisting">   public List&lt;NationalPark&gt; Parks { get; protected set; }</pre></div><div><div><h3 class="title"><a id="note11"/>Note</h3><p>Note the use of <code class="literal">protected set</code>, which protects the <code class="literal">Parks</code> property from being modified outside of the singleton class.</p></div></div></li><li class="listitem">There are several places we need to determine the filename to load and save parks to a JSON-formatted file. Create a method that returns a fully-qualified filename, as follows:<div><pre class="programlisting">protected string GetFilename()
{
  return Path.Combine (
       Environment.GetFolderPath(
           Environment.SpecialFolder.MyDocuments),
          "NationalParks.json");
}</pre></div></li><li class="listitem">Add a private constructor that loads the <code class="literal">Parks</code> collection if a file exists. Providing a <a class="indexterm" id="id382"/>private constructor is a part of implementing the singleton pattern as it helps ensure only a single instance exists. The private constructor can be added using the following code snippet:<div><pre class="programlisting">private NationalParksData ()
{
  if (File.Exists (GetFilename())) {
    string var serializedParks = File.ReadAllText
        (GetFilename());
    Parks =
      JsonConvert.DeserializeObject&lt;List&lt;NationalPark&gt;&gt;
        (serializedParks);
  }
  else
    Parks = new List&lt;NationalPark&gt; ();
}</pre></div></li><li class="listitem">Add a <code class="literal">Save()</code> method. This <a class="indexterm" id="id383"/>method <a class="indexterm" id="id384"/>accepts a park, adds it to the <code class="literal">Parks</code> collection if it is a new park, and then saves the collection to the file, as follows:<div><pre class="programlisting">public void Save(NationalPark park)
{
  if (Parks != null) {
    if (!Parks.Contains (park))
      _parks.Add (park);
    string var serializedParks =
      JsonConvert.SerializeObject (Parks);
    File.WriteAllText (GetFilename (), serializedParks);
  }
}</pre></div></li><li class="listitem">Add a <code class="literal">Delete()</code> method. This<a class="indexterm" id="id385"/> method removes the park from the <code class="literal">Parks</code> collection and saves the updated collection to the file, as follows:<div><pre class="programlisting">public void Delete(NationalPark park)
{
  if (Parks != null) {
    Parks.Remove (park);
    string serializedParks =
      JsonConvert.SerializeObject (Parks);
    File.WriteAllText (GetFilename (), serializedParks);
  }
}</pre></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec55"/>Enhancing MainActivity</h2></div></div></div><p>With the <code class="literal">NationalParksData</code> singleton<a class="indexterm" id="id386"/> in place, we <a class="indexterm" id="id387"/>can move on to some of the UI work. The Xamarin.Android project template did not give us much of a head start as we received in the last chapter. We need to add a list view to <code class="literal">MainActivity</code>, create a <code class="literal">DetailActivity</code> to view a park, and create an <code class="literal">EditActivity</code> to update and delete parks. <code class="literal">MainActivity</code> is a good starting point.</p><div><div><div><div><h3 class="title"><a id="ch05lvl3sec25"/>Adding a ListView instance</h3></div></div></div><p>The default<a class="indexterm" id="id388"/> view (<code class="literal">Main.xml</code>) generated when we created the project contains a <code class="literal">Button</code> instance within <code class="literal">LinearLayout</code>. We need to remove this button and add a <code class="literal">ListView</code> instance to display our parks.</p><div><div><div><div><h4 class="title"><a id="ch05lvl4sec01"/>Touring the Xamarin.Android Designer</h4></div></div></div><p>Xamarin Studio<a class="indexterm" id="id389"/> provides a graphical design tool to create and edit layout files. As this is our first time using this tool, we will devote a few minutes to become familiar with it. Perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">Main.xml</code>; note the two tabs at the bottom of the view, <strong>Content</strong> and <strong>Source</strong>. With the <strong>Content</strong> tab selected, a visual representation of the layout is displayed. With the <strong>Source</strong> tab selected, the raw XML is displayed in an XML editor.</li><li class="listitem">Now, switch to the <strong>Content</strong> tab. Note that on the right-hand side of Xamarin Studio, there are two pads, <strong>Document Outline</strong> and <strong>Properties</strong>. When a layout is opened in the <strong>Content</strong> mode, the <strong>Document Outline</strong> pad displays a hierarchical view of the contents of the layout file. The <strong>Document Outline</strong> pad shows the <strong>Button</strong> control within <code class="literal">LinearLayout</code>.</li><li class="listitem">The <strong>Properties</strong> pad displays properties for the currently selected widget. Select the <strong>Button</strong> instance and switch to the <strong>Properties</strong> pad. Note the tabs at the top of the <strong>Properties</strong> pad: <strong>Widget</strong>, <strong>Style</strong>, <strong>Layout</strong>, <strong>Scroll</strong>, and <strong>Behavior</strong>. The tabs group together the various types of properties available for a particular widget.</li></ol></div></div><div><div><div><div><h4 class="title"><a id="ch05lvl4sec02"/>Editing the Main.xml file</h4></div></div></div><p>To add a <code class="literal">ListView</code> instance in <code class="literal">Main.xml</code>, perform<a class="indexterm" id="id390"/> the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">With <code class="literal">Main.axml</code> open in the <strong>Content</strong> mode, select the <strong>Button</strong> instance, right-click on it, and choose <strong>Delete</strong> (or press the <em>Delete</em> key).</li><li class="listitem">In the search field at the top of the <strong>Toolbox</strong> tab, enter <code class="literal">List</code>. Select the <code class="literal">ListView</code> widget displayed and drag-and-drop it to <code class="literal">Main.axml</code>.</li><li class="listitem">In the <strong>Document Outline</strong> pad, select the <code class="literal">ListView</code> widget.</li><li class="listitem">In the <strong>Properties</strong> pad under the <strong>Widget</strong> tab, enter <code class="literal">@+id/parksListView</code> for the <strong>ID</strong> value.</li><li class="listitem">In the <strong>Document Outline</strong> pad, select the <code class="literal">LinearLayout</code> widget.</li><li class="listitem">In the <strong>Properties</strong> pad under the <strong>Layout</strong> tab, enter <code class="literal">8dp</code> for <strong>Padding</strong>.</li></ol></div></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec26"/>Creating an adapter</h3></div></div></div><p>We need <a class="indexterm" id="id391"/>a <code class="literal">ListAdapter</code> instance to populate our <code class="literal">ListView</code> with national parks. We will create an adapter that extends from <code class="literal">BaseAdapter</code>.</p><p>To create <code class="literal">NationalParksAdapter.cs</code>, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">NationalParks.Droid</code> project, right-click on it, and choose <strong>New File</strong>. In the <strong>New File</strong> dialog box, navigate to <strong>Android</strong> | <strong>Android Class</strong>.</li><li class="listitem">Enter <code class="literal">NationalParks.cs</code> for the <strong>Name</strong> field and click on <strong>New</strong>.</li><li class="listitem">Change <code class="literal">NationalParksAdapter</code> to be a public class and to extend <code class="literal">BaseAdapter&lt;&gt;</code> using <code class="literal">NationalPark</code> as the type specification, as follows:<div><pre class="programlisting">public class NationalParksAdapter :
    BaseAdapter&lt;NationalPark&gt;
{
}</pre></div></li><li class="listitem">Place the cursor on <code class="literal">BaseAdapater&lt;&gt;</code>, right-click on it, and navigate to <strong>Refactor</strong> | <strong>Implement</strong> abstract members, and then press <em>Enter</em>. Xamarin Studio will create a default method stub for each abstract method with code that throws the exception <code class="literal">NotImplementedException</code>.</li><li class="listitem">At this point, you can implement a constructor that accepts an activity and saves the reference for use within <code class="literal">GetView()</code>, as shown in the following code snippet:<div><pre class="programlisting">private Activity _context;
public NationalParksAdapter(Activity context)
{
    _context = context;
}</pre></div></li><li class="listitem">Implement<a class="indexterm" id="id392"/> the <code class="literal">GetItemId()</code> method and return the position that was passed as the ID. The <code class="literal">GetItemId()</code> method<a class="indexterm" id="id393"/> is intended to provide an ID for a row of data displayed in <code class="literal">AdapterView</code>. Unfortunately, the method must return a <code class="literal">long</code> instance, and our ID is a GUID. The best we can do is return the position that is passed to us, as follows:<div><pre class="programlisting">public override long GetItemId(int position)
{
    return  position;
}</pre></div></li><li class="listitem">Implement the <code class="literal">Count</code> property to return the number of items in the <code class="literal">Parks</code> collection, as follows:<div><pre class="programlisting">public override int Count
{
    get { return NationalParksData.Instance.Parks.Count; }
}</pre></div></li><li class="listitem">Implement the indexed property and return the <code class="literal">NationalPark</code> instance located at the position passed in within the <code class="literal">Parks</code> collection, as follows:<div><pre class="programlisting">public override NationalPark this[int position]
{
    get { return NationalParksData.Instance.Parks[position]; }
}</pre></div></li><li class="listitem">Implement the <code class="literal">GetView()</code> method and return a populated <code class="literal">View</code> instance for a park using the default Android layout <code class="literal">SimpleListItem1</code>, as follows:<div><pre class="programlisting">public override View GetView(int position,
    View convertView, ViewGroup parent)
{
    View view = convertView;
    if (view == null) {
        view = 
            _context.LayoutInflater.Inflate(
                Android.Resource.Layout.SimpleListItem1,
                null);
    }
  
    view.FindViewById&lt;TextView&gt;
        (Android.Resource.Id.Text1).Text =
            NationalParksData.Instance.Parks [position].Name;

    return view;
}</pre></div></li><li class="listitem">To conclude<a class="indexterm" id="id394"/> these steps, hook up the adapter to <code class="literal">ListView</code> on <code class="literal">MainActivity</code>. This is normally done in the <code class="literal">OnCreate()</code> method, as follows:<div><pre class="programlisting">NationalParksAdapter _adapter;
. . .
protected override void OnCreate (Bundle bundle)
{
    . . . 
    _adapter = new NationalParksAdapter (this);
    FindViewById&lt;ListView&gt;
       (Resource.Id.parksListView).Adapter = _adapter;
    . . .
}</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec27"/>Adding the New action to the ActionBar</h3></div></div></div><p>We now need<a class="indexterm" id="id395"/> to add an <code class="literal">Add</code> action to the ActionBar, which can be used to create a new national park.</p><p>To create the <code class="literal">Add</code> action, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">You firstly need to select the <code class="literal">Resources</code> folder in the <code class="literal">NationalParks.Droid</code> project, right-click on it, and navigate to <strong>Add</strong> | <strong>New Folder</strong>.</li><li class="listitem">At this point, name the folder <code class="literal">menu</code>.</li><li class="listitem">Select the newly created <code class="literal">menu</code> folder, right-click on it, and navigate to <strong>Add</strong> | <strong>New File</strong>, then select <strong>XML</strong> | <strong>Empty XML File</strong>, enter <code class="literal">MainMenu.xml</code> in the <strong>Name</strong> field, and click on <strong>New</strong>.</li><li class="listitem">Fill in the newly created XML file with a menu definition for the <strong>Add</strong> action. The following sample demonstrates what is needed:<div><pre class="programlisting">&lt;menu
  &gt;
    &lt;item android:id="@+id/actionNew"
        android:icon="@drawable/ic_new"
        android:title="New"
        android:showAsAction="ifRoom" /&gt;
&lt;/menu&gt;</pre></div></li><li class="listitem">Copy all of the image files (<code class="literal">*.png</code>) from the <code class="literal">Assets</code> folder to the <code class="literal">Resources/drawable</code> folder in the <code class="literal">NationalParks.Droid</code> project.</li><li class="listitem">Select the <code class="literal">Resources/drawable</code> folder, right-click and choose <strong>Add Files</strong>, select all of the image files, including <code class="literal">ic_new.png</code>, and click on <strong>Open</strong>.</li></ol></div><p>Now that we have <a class="indexterm" id="id396"/>the menu definition and graphics in place, we need to add some code to put the menus in place. Android provides several virtual methods to create and process clicks for ActionBar items.</p><div><div><div><div><h4 class="title"><a id="ch05lvl4sec03"/>Overriding the OnCreateOptionsMenu() method</h4></div></div></div><p>The <a class="indexterm" id="id397"/><code class="literal">OnCreateOptionsMenu()</code> method <a class="indexterm" id="id398"/>is called when an activity is started and provides a place to create ActionBar items. The following code demonstrates how to use the definition in <code class="literal">MainMenu.xml</code> to create the <code class="literal">Add</code> action:</p><div><pre class="programlisting">public override bool OnCreateOptionsMenu(IMenu menu)
{
    MenuInflater.Inflate(Resource.Menu.MainMenu, menu);
    return base.OnCreateOptionsMenu(menu);
}</pre></div></div><div><div><div><div><h4 class="title"><a id="ch05lvl4sec04"/>Overriding the OnOptionsItemSelected() method</h4></div></div></div><p>The <a class="indexterm" id="id399"/><code class="literal">OnOptionsItemsSelected()</code> method<a class="indexterm" id="id400"/> is called when an action in the ActionBar is clicked on, and it provides a place to handle the request. In our case, we want to navigate to the detail view, which has not been created yet. For now, simply implement the <code class="literal">OnOptionsItemSelected()</code> method with a placeholder <a class="indexterm" id="id401"/>for the <a class="indexterm" id="id402"/>navigation logic. The following code demonstrates what is needed:</p><div><pre class="programlisting">public override bool OnOptionsItemSelected (
    IMenuItem item)
{
    switch (item.ItemId)
    {
    case Resource.Id.actionNew:
        // Navigate to Detail View
        return true;

    default :
        return base.OnOptionsItemSelected(item);
    }
}</pre></div></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec28"/>Running the app</h3></div></div></div><p>We have <a class="indexterm" id="id403"/>completed our enhancements to <code class="literal">MainActivity</code>. Run the app and review the changes. When you initially start the app, you will notice that <code class="literal">ListView</code> is empty. You can place the <code class="literal">NationalParks.json</code> file in the emulator virtual device using the <a class="indexterm" id="id404"/><strong>Android Device Monitor</strong> (<strong>ADM</strong>). Xamarin Studio is not configured with a menu item for ADM, but you can add one using <strong>Preferences</strong> | <strong>External Tools</strong>.</p><p>Upload <code class="literal">NationalParks.json</code> to the emulator using the ADM application. Restart <code class="literal">NationalParks.Droid</code>; you should now see parks listed.</p></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec56"/>Creating the DetailActivity view</h2></div></div></div><p>Now, let's add a <a class="indexterm" id="id405"/>view that displays<a class="indexterm" id="id406"/> the details for a national park. For this, we need to create a simple view with <code class="literal">ScrollView</code> as the parent <code class="literal">ViewGroup</code> and <code class="literal">EditText</code> widgets for each of the properties on the <code class="literal">NationalPark</code> entity class.</p><p>To create the <code class="literal">DetailActivity</code> view, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">NationalParks.Droid</code> project in the <strong>Solution</strong> pad, right-click and navigate to <strong>Add</strong> | <strong>New File</strong>.</li><li class="listitem">After this, navigate to <strong>Android</strong> | <strong>Android Activity</strong>, enter <code class="literal">DetailActivity</code> for the value of the <strong>Name</strong> field, and click on <strong>New</strong>.</li><li class="listitem">Then, select the <code class="literal">Resources/layout</code> folder in <code class="literal">NationalParks.Droid</code>, right-click on it, and navigate to <strong>Add</strong> | <strong>New File</strong>.</li><li class="listitem">Navigate to <strong>Android</strong> | <strong>Android Layout</strong>, enter <code class="literal">Detail</code> for the <strong>Name</strong> field, and click on <strong>New</strong>.</li><li class="listitem">In the <strong>Outline</strong> pad, select <code class="literal">LinearLayout</code>, right-click on it, and choose <strong>Delete</strong>.</li><li class="listitem">From the <strong>Toolbox</strong> pad, select the <code class="literal">ScrollView</code> widget and drag it onto the <code class="literal">Detail.axml</code> layout.</li><li class="listitem">From the <strong>Toolbox</strong> pad, select <code class="literal">LinearLayout</code> and drag it onto the <code class="literal">Detail.axml</code> layout.</li><li class="listitem">In the <strong>Properties</strong> pad under the <strong>Layout</strong> tab, set <strong>Padding</strong> to <code class="literal">8dp</code> for <code class="literal">LinearLayout</code>.</li><li class="listitem">Add <code class="literal">TextView</code> widgets for each property on the <code class="literal">NationalPark</code> entity class <a class="indexterm" id="id407"/>except the <code class="literal">ID</code> property. Also, add <code class="literal">TextView</code> widgets that serve as labels. For each of the <code class="literal">TextView</code> widgets that will be used to display properties, fill in the <code class="literal">ID</code> property with a name that corresponds to the property names on the entity, for example, <code class="literal">nameTextView</code>. Arrange the widgets based on your preferences; you <a class="indexterm" id="id408"/>can use the screen mockups in the <em>The sample national parks app</em> section of <a class="link" href="ch04.html" title="Chapter 4. Developing Your First iOS App with Xamarin.iOS">Chapter 4</a>, <em>Developing Your First iOS App with Xamarin.iOS</em>, or the sample solution as a guide.</li><li class="listitem">Review <code class="literal">Detail.axml</code> in the <strong>Content</strong> mode and adjust it as needed.</li><li class="listitem">In <code class="literal">DetailActivity.OnCreate()</code>, add call to <code class="literal">SetContentView()</code>, and pass the layout ID for <code class="literal">Detail.axml</code>, as follows:<div><pre class="programlisting">SetContentView (Resource.Layout.Detail);</pre></div></li></ol></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec29"/>Adding ActionBar items</h3></div></div></div><p>We now need to add<a class="indexterm" id="id409"/> three items to the action bar: an action to edit a park, view photos on <a class="ulink" href="http://www.bing.com">www.bing.com</a> for a park, and get directions to a park. Follow the same steps used previously to create a new menu definition file named <code class="literal">DetailMenu.xml</code>. The following XML shows the code that needs to be used:</p><div><pre class="programlisting">&lt;menu &gt;
    &lt;item android:id="@+id/actionEdit"
        android:icon="@drawable/ic_edit"
       android:title="Edit"
       android:showAsAction="ifRoom" /&gt;
   &lt;item android:id="@+id/actionPhotos"
       android:title="Photos"
       android:showAsAction="never" /&gt;
    &lt;item android:id="@+id/actionDirections"
       android:title="Directions"
       android:showAsAction="never" /&gt;
&lt;/menu&gt;</pre></div><p>After adding the <a class="indexterm" id="id410"/>menu definition, implement the <code class="literal">OnCreateOptionsMenu()</code>and <code class="literal">OnOptionsItemSelected()</code> methods like we did for <code class="literal">MainActivity</code>. Just add empty stubs to handle the actual actions and we will fill in the logic in the coming sections.</p></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec30"/>Populating DetailActivity</h3></div></div></div><p>Add logic to <a class="indexterm" id="id411"/>populate <code class="literal">DetailActivity</code> in <code class="literal">OnCreate()</code>, using the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">The first step is to determine if a park <code class="literal">Id</code> was passed in as an intent extra. If one was passed in, locate it in the <code class="literal">Parks</code> list on <code class="literal">NationalParksData</code>. If not, create a new instance using the following snippet:<div><pre class="programlisting">if (Intent.HasExtra ("parkid")) {
    string parkId = Intent.GetStringExtra ("parkid");
    _park = NationalParksData.Instance.
        Parks.FirstOrDefault (x =&gt; x.Id == parkId);
}
else
    _park = new NationalPark ();</pre></div></li><li class="listitem">Now populate the <code class="literal">EditText</code> fields based on data from the park. The sample solution has a <code class="literal">ParkToUI()</code> method for this logic, as follows:<div><pre class="programlisting">protected void ParkToUI()
{
    _nameEditText.Text = _park.Name;
    . . .
    _latEditText.Text = _park.Latitude.ToString();
    . . .
}</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec31"/>Handling the Show Photos action</h3></div></div></div><p>We would <a class="indexterm" id="id412"/>like to direct the user to <a class="ulink" href="http://www.bing.com">www.bing.com</a> to view photos for a park. This can be accomplished with a simple <code class="literal">ActionView</code> intent and a properly formatted search URI for <a class="ulink" href="http://www.bing.com">www.bing.com</a>.</p><p>To handle the Show Photos action, create<a class="indexterm" id="id413"/> some logic on the <code class="literal">OnOptionsItemSelected()</code> method to create an <code class="literal">ActionView</code> intent and pass in a formatted URI to search <a class="ulink" href="http://www.bing.com">www.bing.com</a> for photos. The following code demonstrates the required action:</p><div><pre class="programlisting">public override bool OnOptionsItemSelected (
    IMenuItem item)
{
    switch (item.ItemId) {
    . . .
    case Resource.Id.actionPhotos:
        Intent urlIntent =
            new Intent (Intent.ActionView);
          urlIntent.SetData (
            Android.Net.Uri.Parse (
            String.Format(
                "http://www.bing.com/images/search?q={0}",
                _park.Name)));
        StartActivity (urlIntent);
        return true;
    . . .
    }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec32"/>Handling the Show Directions action</h3></div></div></div><p>We<a class="indexterm" id="id414"/> would like to direct the user to an external map app to get directions to a park. Again, this can be accomplished with a simple <code class="literal">ActionView</code> intent along with a properly formatted URI requesting map information.</p><p>To handle the Show Directions action, create a logic on the <code class="literal">OnOptionsItemSelected()</code> method to create an <code class="literal">ActionView</code> intent and <a class="indexterm" id="id415"/>pass in a formatted URI to display the map information. The following code demonstrates the required action:</p><div><pre class="programlisting">case Resource.Id.actionDirections:

    if ((_park.Latitude.HasValue) &amp;&amp;
       (_park.Longitude.HasValue)) {
        Intent mapIntent = new Intent
           (Intent.ActionView,
            Android.Net.Uri.Parse (
            String.Format ("geo:0,0?q={0},{1}&amp;z=16 ({2})",
            _park.Latitude,
            _park.Longitude,
            _park.Name)));
        StartActivity (mapIntent);
    }

    return true;</pre></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec33"/>Adding navigation</h3></div></div></div><p>Now that <a class="indexterm" id="id416"/>we have <code class="literal">DetailActivity</code> in place, we need to go back and add some navigation logic in <code class="literal">MainActivity</code> so that when a park is selected in the list, <code class="literal">DetailActivity</code> will be displayed.</p><p>A user clicking on an item in <code class="literal">ListView</code> can be handled by providing an event handler for <code class="literal">ListView.OnItemClicked</code>.</p><p>To add navigation from <code class="literal">MainActivity</code>, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">MainActivity.cs</code>.</li><li class="listitem">Create an event handler to handle an <code class="literal">OnItemClicked</code> event. The following event handler represents what is needed:<div><pre class="programlisting">public void ParkClicked(object sender,
    ListView.ItemClickEventArgs e)
{
    Intent intent = new Intent (this,
        typeof(DetailActivity));
    intent.PutExtra("parkid", adapter[e.Position].Id);
    StartActivity (intent);
}</pre></div></li><li class="listitem">Hook up the event handler in the <code class="literal">OnCreate()</code> method, as follows:<div><pre class="programlisting">FindViewById&lt;ListView&gt;
    (Resource.Id.parksListView).ItemClick   += ParkClicked;</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec34"/>Running the app</h3></div></div></div><p>We have now <a class="indexterm" id="id417"/>completed <code class="literal">DetailActivity</code>. Run the app and select a park to display the new activity. Choose the Show Photos and Show Directions actions. If you are running the application in an emulator, you will not be able to view directions as the emulator will not have access to Google Play Services.</p></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec57"/>Creating EditActivity</h2></div></div></div><p>We are<a class="indexterm" id="id418"/> now <a class="indexterm" id="id419"/>ready to add our last activity, <code class="literal">EditActivity</code>. This exercise will be similar to the one we just finished except that we will use <code class="literal">EditText</code> widgets so that users will be able to modify data. In addition, <code class="literal">EditActivity</code> can be used to display an existing park or a new one.</p><p>To create <code class="literal">EditActivity</code>, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Follow the same steps used in the previous section to create a new activity and layout file named <code class="literal">EditActivity</code> and <code class="literal">Edit.axml</code> respectively.</li><li class="listitem">Also, add <code class="literal">ScrollView</code>, <code class="literal">LinearLayout</code>, and <code class="literal">Padding</code> in the same manner as was done for <code class="literal">Detail.axml</code>.</li><li class="listitem">Add <code class="literal">TextView</code> widgets and <code class="literal">EditText</code> widgets for each property on the <code class="literal">NationalPark</code> entity class except the <code class="literal">Id</code> property. The <code class="literal">TextView</code> widgets should be used as labels and the <code class="literal">EditText</code> widgets to edit properties. For each of the <code class="literal">EditView</code> widgets that will be used to display properties, fill in the <code class="literal">Id</code> property with a name that corresponds to the property names on the entity, for example, <code class="literal">nameTextView</code>. Arrange the widgets based on your preferences; you can use the screen mockups in the <em>The sample national parks app</em> section of <a class="link" href="ch04.html" title="Chapter 4. Developing Your First iOS App with Xamarin.iOS">Chapter 4</a>, <em>Developing Your First iOS App with Xamarin.iOS</em>, or sample solution as a guide.</li><li class="listitem">Review <code class="literal">Edit.axml</code> in the <strong>Content</strong> mode and adjust as needed.</li><li class="listitem">In <code class="literal">EditActivity.OnCreate()</code>, add a call to <code class="literal">SetContentView()</code> and pass in the layout <code class="literal">Id</code> for <code class="literal">Edit.axml</code>, as follows:<div><pre class="programlisting">SetContentView (Resource.Layout.Edit);</pre></div></li></ol></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec35"/>Adding ActionBar items</h3></div></div></div><p>We now<a class="indexterm" id="id420"/> need to add three items to the action bar: an action to edit a park, view photos on <a class="ulink" href="http://www.bing.com">www.bing.com</a> for a park, and get directions to a park. Follow the same steps used previously in the section <em>Adding the New action to the ActionBar</em> to create a new menu definition file named <code class="literal">DetailMenu.xml</code>. The following XML shows the required code:</p><div><pre class="programlisting">&lt;menu &gt;
    &lt;item android:id="@+id/actionSave"
    android:icon="@drawable/ic_save"
      android:title="Save"
      android:showAsAction="always" /&gt;
    &lt;item android:id="@+id/actionDelete"
    android:icon="@drawable/ic_delete"
      android:title="Delete"
      android:showAsAction="always" /&gt;
&lt;/menu&gt;</pre></div><p>After adding the <a class="indexterm" id="id421"/>menu definition, implement the <code class="literal">OnCreateOptionsMenu()</code>and <code class="literal">OnOptionsItemSelected()</code> methods like we did for <code class="literal">MainActivity</code>. Add empty stubs to handle each action and we will fill in the logic in the coming sections, as follows:</p><div><pre class="programlisting">public override bool OnOptionsItemSelected (IMenuItem item)
{
    switch (item.ItemId)
    {
        case Resource.Id.actionSave:
            // will add save logic here…
            return true;

        case Resource.Id.actionDelete: 
            // will add delete logic here…
            return true;

        default :
            return base.OnOptionsItemSelected(item);
    }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec36"/>Creating reference variables for widgets</h3></div></div></div><p>As we will <a class="indexterm" id="id422"/>be putting data in the <code class="literal">EditText</code> widgets and then pulling it back out again, it make sense to create reference variables for the widgets and set the references in the <code class="literal">OnCreate()</code> method.</p><p>To create reference variables for widgets, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a set of references to <code class="literal">EditText</code> objects in the <code class="literal">EditActivity</code> class, as follows:<div><pre class="programlisting">EditText _nameEditText;
EditText _descrEditText;
. . .</pre></div></li><li class="listitem">In the <code class="literal">OnCreate()</code> method of <code class="literal">EditActivity</code>, set the references to the appropriate widgets using <code class="literal">FindViewById()</code>, as follows:<div><pre class="programlisting">_nameEditText= FindViewById&lt;EditText&gt;
    (Resource.Id.nameEditText);
_descrEditText = FindViewById&lt;EditText&gt;
    (Resource.Id.descrEditText);
. . .</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec37"/>Populating EditActivity</h3></div></div></div><p>To populate<a class="indexterm" id="id423"/> EditActivity, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a method named <code class="literal">ParkToUI()</code> to move data from the <code class="literal">_park</code> object to the <code class="literal">EditText</code> widgets, as follows:<div><pre class="programlisting">protected void ParkToUI()
{
      _nameEditText.Text = _park.Name;
      _descrEditText.Text = _park.Description;
      . . .
}</pre></div></li><li class="listitem">Override <code class="literal">OnResume()</code> and add a call to the <code class="literal">ToUI()</code> method to populate the <code class="literal">EditText</code> widgets, as follows:<div><pre class="programlisting">protected override void OnResume ()
{
    base.OnResume ();
    ParkToUI ();
}</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec38"/>Handling the Save action</h3></div></div></div><p>When the<a class="indexterm" id="id424"/> <code class="literal">Save</code> action is clicked on, the <code class="literal">OnOptionsItemSelected()</code> method is called. Create a <code class="literal">Save()</code> method on <code class="literal">DetailActivity</code> and call it from <code class="literal">OnOptionsItemSelected()</code>. The solution project has a <code class="literal">UIToPark()</code> method to take content from the <code class="literal">EditText</code> widgets and populate the <code class="literal">Park</code> entity before saving it.</p><p>To handle the <code class="literal">Save</code> action, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a method named <code class="literal">ToPark()</code> to move data from the <code class="literal">EditText</code> widgets to the <code class="literal">_park</code> object. This method will be used when handling the <code class="literal">Save</code> action, as follows:<div><pre class="programlisting">protected void UIToPark()
{
    _park.Name = _nameEditText.Text;
    _park.Description = _descrEditText.Text;
    . . .
    if (!String.IsNullOrEmpty (_latEditText.Text))
        _park.Latitude = Double.Parse (_latEditText.Text);
    else
        _park.Latitude = null;
    . . .
}</pre></div></li><li class="listitem">Create a method <a class="indexterm" id="id425"/>to handle saving the park that calls <code class="literal">UIToPark()</code> to populate the <code class="literal">_park</code> object with changes, then it calls the <code class="literal">Save()</code> method on <code class="literal">NationalParksData</code> to save the changes to file, sets the result code, and finishes the activity. The required code is as follows:<div><pre class="programlisting">protected void SavePark()
  {
      UIToPark ();
      NationalParksData.Instance.Save (_park);

    Intent returnIntent = new Intent ();
    returnIntent.PutExtra ("parkdeleted", false);
    SetResult (Result.Ok, returnIntent);

      Finish ();
}</pre></div><div><div><h3 class="title"><a id="note12"/>Note</h3><p>Note that a Boolean <code class="literal">Extra</code> named <code class="literal">parkdeleted</code> is set to <code class="literal">false</code>. This is used to communicate to the calling activity that the park was not deleted.</p></div></div></li><li class="listitem">Update <code class="literal">OnOptionsItemSelected()</code> to call <code class="literal">SavePark()</code>, as follows:<div><pre class="programlisting">case Resource.Id.actionSave:
      SavePark ();
      return true;</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec39"/>Handling the Delete action</h3></div></div></div><p>Handling <a class="indexterm" id="id426"/>the <code class="literal">Delete</code> action is similar to the <code class="literal">Save</code> action, but somewhat simpler as we do not have to save changes from the UI widgets.</p><p>To handle the Delete action, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a method to handle the deleting of the park by calling the <code class="literal">Delete()</code> method on <code class="literal">NationalParksData</code>, setting the result code, and finishing the activity, as follows:<div><pre class="programlisting">protected void DeletePark()
{
    NationalParksData.Instance.Delete (_park);

    Intent returnIntent = new Intent ();
    returnIntent.PutExtra ("parkdeleted", true);
    SetResult (Result.Ok, returnIntent);

    Finish ();
}</pre></div><div><div><h3 class="title"><a id="note13"/>Note</h3><p>Note that the Boolean <code class="literal">Extra</code> named <code class="literal">parkdeleted</code> is set to <code class="literal">true</code> to tell the calling activity that the park was deleted. This is important to the <code class="literal">DetailActivity</code> because when a park was previously shown as deleted, it should be finished and returned to <code class="literal">MainActivity</code>.</p></div></div></li><li class="listitem">Update <code class="literal">OnOptionsItemSelected()</code> to call <code class="literal">DeletePark()</code>, as follows:<div><pre class="programlisting">case Resource.Id.actionDelete:
      DeletePark ();
      return true;</pre></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec40"/>Adding navigation</h3></div></div></div><p>Now that<a class="indexterm" id="id427"/> <code class="literal">EditActivity</code> is in place, we need to add navigation logic to <code class="literal">MainActivity</code> when a user chooses the <code class="literal">New</code> action and to <code class="literal">DetailActivity</code> when the user chooses the <code class="literal">Edit</code> action.</p><div><div><div><div><h4 class="title"><a id="ch05lvl4sec05"/>Navigating on the New action</h4></div></div></div><p>As you <a class="indexterm" id="id428"/>can recall, in <code class="literal">OnMenuItemSelected()</code> in <code class="literal">MainActivity</code>, we added a comment to the place where we need to navigate to <code class="literal">EditActivity</code>. We can now replace this comment with the following use of <code class="literal">StartActivity()</code>:</p><div><pre class="programlisting">public override bool OnOptionsItemSelected (
    IMenuItem item)
{
    switch (item.ItemId)
    {
        case Resource.Id.actionNew:
            StartActivity (typeof(DetailActivity));
            return true;
        default :
            return base.OnOptionsItemSelected(item);
    }
}</pre></div></div><div><div><div><div><h4 class="title"><a id="ch05lvl4sec06"/>Navigating on the Edit action</h4></div></div></div><p>In the same way, we<a class="indexterm" id="id429"/> need to add navigation code to <code class="literal">OnMenuItemSelected()</code> in <code class="literal">DetailActivity</code>. However, there are a few differences. We need to pass in the <code class="literal">Id</code> property for the park we want to edit and we want to receive back a result that indicates whether or not the user deleted this park. The required code is as follows:</p><div><pre class="programlisting">case Resource.Id.actionEdit:
    Intent editIntent = new Intent(this, 
        typeof(EditActivity));
    editIntent.PutExtra("parkid", _park.Id);
    StartActivityForResult(editIntent, 1);
    return true;</pre></div><p>
<code class="literal">DetailActivity</code> also needs to detect when a park is deleted so that it can finish and return to <code class="literal">MainActivity</code> to view the list. To accomplish this, override <code class="literal">OnActivityResult()</code> and check the Boolean <code class="literal">Extra</code> named <code class="literal">parkdeleted</code> to determine if the park was deleted, as follows:</p><div><pre class="programlisting">protected override void OnActivityResult (
    int requestCode, Result resultCode, Intent data)
  {
      if ((requestCode == 1) &amp;&amp; (resultCode == Result.Ok))
      {
          if (data.GetBooleanExtra ("parkdeleted", false))
              Finish ();
          }
        else
            base.OnActivityResult (
                requestCode, resultCode, data);
      }
}</pre></div></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec41"/>Refreshing ListView in MainActivity</h3></div></div></div><p>The last <a class="indexterm" id="id430"/>thing we need to implement is the logic that will refresh <code class="literal">ListView</code> in <code class="literal">MainActivity</code> with any changes that might have been made on <code class="literal">EditActivity</code>. To accomplish this, call <code class="literal">NotifyDataSetChanged()</code> on the adapter object within an override to the <code class="literal">OnResume()</code> method on <code class="literal">MainActivity</code>, as follows:</p><div><pre class="programlisting">protected override void OnResume ()
{
    base.OnResume ();
    adapter.NotifyDataSetChanged ();
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch05lvl3sec42"/>Running the app</h3></div></div></div><p>We have now<a class="indexterm" id="id431"/> completed the <code class="literal">NationalParks.Droid</code> app. You should now be able to run your app and exercise each of the features.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec46"/>Working with Xamarin.Android projects in Visual Studio</h1></div></div></div><p>If you have<a class="indexterm" id="id432"/> installed Xamarin.Android on<a class="indexterm" id="id433"/> a Windows machine with Visual Studio 2010 or Visual Studio 2013 (which is the current version), the Xamarin.Android Visual Studio add-on will already be installed. Working with projects in Visual Studio is similar to working with Xamarin Studio with the exception of certain features. To access options for the project, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">NationalParks.Droid</code> project, right-click and select <strong>Properties</strong>. A multi-tabbed window will be open that allows various project-related options to be specified.</li><li class="listitem">To access <a class="indexterm" id="id434"/>Xamarin.Android-related options for Visual Studio, navigate to <strong>Tools</strong> | <strong>Options</strong> | <strong>Xamarin</strong> | <strong>Android Settings</strong>.</li><li class="listitem">To access the AVD Manager, navigate to <strong>Tools</strong> | <strong>Open Android Emulator Manager</strong>.</li><li class="listitem">To manage your Xamarin account and activate a license, navigate to <strong>Tools</strong> | <strong>Xamarin Account</strong>.</li></ol></div><p>If you are working <a class="indexterm" id="id435"/>on a Windows machine with Visual Studio installed and you have not taken time to try out the add-on, open <code class="literal">NationalParks.Droid</code> in Visual Studio and run the app.</p></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec47"/>Reviewing the generated elements</h1></div></div></div><p>Prior to wrapping<a class="indexterm" id="id436"/> this chapter up, let's look at some of the things that go on behind the scenes.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec58"/>Peer objects</h2></div></div></div><p>In <a class="link" href="ch03.html" title="Chapter 3. Demystifying Xamarin.Android">Chapter 3</a>, <em>Demystifying Xamarin.Android</em>, we discussed the role of peer objects in a Xamarin.Android app. Let's<a class="indexterm" id="id437"/> now take a look at one of the generated Java peer objects from our project. The source for these classes can be found in <code class="literal">NationalParks.Droid/obj/Debug/android/src</code>. Open <code class="literal">nationalparks.droid.MainActivity.java</code>. Now, note the following pointers:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">MainActivity</code> extends <code class="literal">android.app.Activity</code>.</li><li class="listitem" style="list-style-type: disc">Each method we created an override for has a corresponding method created that calls our override. For example, we created an override for <code class="literal">OnCreate()</code>. The generated class has a method named <code class="literal">onCreate()</code> that calls a private native method <code class="literal">n_onCreate()</code>, which in turn points to our override through a JNI reference.</li><li class="listitem" style="list-style-type: disc">The static class initializer for <code class="literal">MainActivity</code> registers all the native methods for use with JNI using the <code class="literal">mono.android.Runtime.register()</code> method.</li><li class="listitem" style="list-style-type: disc">The class constructor activates an instance of our managed C# class using the <code class="literal">mono.android.TypeManager.Activate()</code>method.</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec59"/>The AndroidManifest.xml file</h2></div></div></div><p>Xamarin.Android <a class="indexterm" id="id438"/>generates an <code class="literal">AndroidManifest.xml</code> file at build time using two sources as input: the first one being<a class="indexterm" id="id439"/> the content in the <code class="literal">AndroidManifest.xml</code> file in <code class="literal">NationalParks.Droid/Properties</code> and the second one being the attributes specified on classes, primarily activities in your project. You can find the generated <code class="literal">AndroidManifest.xml</code> in <code class="literal">NationalParks.Droid/obj/Debug/android</code>. Open the file with a text editor and note the following pointers:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There are two <code class="literal">&lt;activity/&gt;</code> elements in the file and <code class="literal">MainActivity</code> is specified to be the launch activity. These entries are generated from the attributes specified on each of the activity classes.</li><li class="listitem" style="list-style-type: disc">A single permission of <code class="literal">INTERNET</code> is specified. This came from the <code class="literal">AndroidManifest.xml</code> file in the <code class="literal">NationalParks.Droid/Properties</code> folder.</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec60"/>The APK file</h2></div></div></div><p>Another interesting <a class="indexterm" id="id440"/>thing to look at is the APK produced for a Xamarin.Android app. We will be covering in detail how to create APKs in <a class="link" href="ch10.html" title="Chapter 10. Preparing Xamarin.Android Apps for Distribution">Chapter 10</a>, <em>Preparing Xamarin.Android Apps for Distribution</em>. This a fairly simple process; if you can't wait, use the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">In the upper-left hand corner of the toolbar, set the built type to <strong>Release</strong>.</li><li class="listitem">From the <strong>Project</strong> menu, select <strong>Publish Android Project</strong>.</li><li class="listitem">In the <strong>Publish Android Application</strong> dialog box, choose <strong>Create new keystore</strong>, fill out all of the required information, and click on <strong>Create</strong>.</li><li class="listitem">Xamarin.Android will publish the APK in the location you selected. As APKs are ZIP files, simply unzip the APK to view the contents.<p>The following screenshot shows<a class="indexterm" id="id441"/> the contents of the resulting APK:</p><div><img alt="The APK file" src="img/0838OT_05_01.jpg"/></div></li></ol></div><p>The following table <a class="indexterm" id="id442"/>provides a description of the contents of the APK:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Content</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">assemblies/System.*</code>
</p>
</td><td style="text-align: left" valign="top">
<p>These assemblies contain core .NET namespaces such as <code class="literal">System.IO</code> and <code class="literal">System.Collection</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">assemblies/Mono.Android.dll</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This assembly contains the Xamarin.Android binding classes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">assemblies/NationalParks.Droid.dll</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This assembly contains the classes we created: <code class="literal">MainActivity</code>, <code class="literal">DetailActivity</code>, and <code class="literal">NationalParksAdapter</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">assemblies/Newtonsoft.Json.dll</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This assembly contains the Json.NET classes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">classes.dex</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This file contains all the generated Java peer objects in a Dalvik-compiled format</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">lib/armeabi-v7a/libmonodroid.so</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a class="indexterm" id="id443"/> is the Mono CLR for Android</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">res/*</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This folder contains all the resources; drawables, layouts, menus, and so on</p>
</td></tr></tbody></table></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec48"/>Summary</h1></div></div></div><p>In this chapter, we created a sample Xamarin.Android app and demonstrated the concepts that need to be understood to work with the Xamarin.Android platform. While we did not demonstrate all of the features that can be used in an Android app, you should now feel comfortable with how to access these features.</p><p>In the next chapter, we will turn our attention to the important topics of sharing code across apps, one of the key advantages of using Xamarin.</p></div></body></html>