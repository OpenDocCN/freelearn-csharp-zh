<html><head></head><body>
<div id="_idContainer180">
<h1 class="chapter-number" id="_idParaDest-353"><a id="_idTextAnchor671"/><span class="koboSpan" id="kobo.1.1">16</span></h1>
<h1 id="_idParaDest-354"><a id="_idTextAnchor672"/><span class="koboSpan" id="kobo.2.1">Error Handling, Monitoring, and Observability</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In </span><a href="B18971_04.xhtml#_idTextAnchor170"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.4.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.5.1">, we introduced how to use logging in ASP.NET Core web API applications. </span><span class="koboSpan" id="kobo.5.2">Logging is a critical part of application development that helps developers understand what’s happening in their applications. </span><span class="koboSpan" id="kobo.5.3">However, logging is not enough – we need more tools to monitor and observe how our application is running. </span><span class="koboSpan" id="kobo.5.4">In this chapter, we will explore the </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">following topics:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.7.1">Error handling</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.8.1">Health checks</span></span></li>
<li><span class="koboSpan" id="kobo.9.1">Monitoring </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">and observability</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.11.1">After reading this chapter, you will be able to understand how to monitor ASP.NET Core web API applications. </span><span class="koboSpan" id="kobo.11.2">You will have gained knowledge of observability and </span><strong class="bold"><span class="koboSpan" id="kobo.12.1">OpenTelemetry</span></strong><span class="koboSpan" id="kobo.13.1">, as well as how to use some tools, such as Prometheus and Grafana, to </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">monitor applications.</span></span></p>
<h1 id="_idParaDest-355"><a id="_idTextAnchor673"/><span class="koboSpan" id="kobo.15.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.16.1">The code samples for this chapter can be found at </span><a href="https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8/tree/main/samples/chapter16"><span class="koboSpan" id="kobo.17.1">https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8/tree/main/samples/chapter16</span></a><span class="koboSpan" id="kobo.18.1">. </span><span class="koboSpan" id="kobo.18.2">You can use VS 2022 or VS Code to open </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">the solutions.</span></span></p>
<h1 id="_idParaDest-356"><a id="_idTextAnchor674"/><span class="koboSpan" id="kobo.20.1">Error handling</span></h1>
<p><span class="koboSpan" id="kobo.21.1">When an </span><a id="_idIndexMarker1768"/><span class="koboSpan" id="kobo.22.1">exception occurs in an ASP.NET Core web API application, the application will throw an exception. </span><span class="koboSpan" id="kobo.22.2">If this exception is not handled, the application will crash and cause a 500 error. </span><span class="koboSpan" id="kobo.22.3">The response body will contain the stack trace of the exception. </span><span class="koboSpan" id="kobo.22.4">Displaying the stack trace to the client is acceptable during development. </span><span class="koboSpan" id="kobo.22.5">However, we should never expose the stack trace to the client in production. </span><span class="koboSpan" id="kobo.22.6">The stack trace contains sensitive information about the application that can be used by attackers to attack </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">the application.</span></span><a id="_idTextAnchor675"/></p>
<h2 id="_idParaDest-357"><a id="_idTextAnchor676"/><span class="koboSpan" id="kobo.24.1">Handling exceptions</span></h2>
<p><span class="koboSpan" id="kobo.25.1">Let’s look</span><a id="_idIndexMarker1769"/><span class="koboSpan" id="kobo.26.1"> at an example. </span><span class="koboSpan" id="kobo.26.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.27.1">MyWebApiDemo</span></strong><span class="koboSpan" id="kobo.28.1"> sample application has a controller named </span><strong class="source-inline"><span class="koboSpan" id="kobo.29.1">UsersController</span></strong><span class="koboSpan" id="kobo.30.1">, which has an action to get a user by their user ID. </span><span class="koboSpan" id="kobo.30.2">This action looks </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.32.1">
[HttpGet("{id:int}")]public ActionResult&lt;User&gt; Get(int id)
{
    var user = Users.First(u =&gt; u.Id == id);
    if (user == null)
    {
        return NotFound();
    }
    return Ok(user);
}</span></pre>
<p><span class="koboSpan" id="kobo.33.1">It is not advisable to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.34.1">First</span></strong><span class="koboSpan" id="kobo.35.1"> in this instance as it will result in an exception being thrown if the user is not found in the collection. </span><span class="koboSpan" id="kobo.35.2">To illustrate how to handle exceptions in the application, we will use </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">this example.</span></span></p>
<p><span class="koboSpan" id="kobo.37.1">Run the application and send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.38.1">GET</span></strong><span class="koboSpan" id="kobo.39.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.40.1">https://localhost:5001/users/100</span></strong><span class="koboSpan" id="kobo.41.1"> endpoint. </span><span class="koboSpan" id="kobo.41.2">You can test it in the Swagger UI directly. </span><span class="koboSpan" id="kobo.41.3">The application will return a 500 error because no user with an ID of 100 will be found. </span><span class="koboSpan" id="kobo.41.4">The response body will look </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer143">
<span class="koboSpan" id="kobo.43.1"><img alt="Figure 16.1 – The response body contains the stack trace" src="image/B18971_16_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.44.1">Figure 16.1 – The response body contains the stack trace</span></p>
<p><span class="koboSpan" id="kobo.45.1">Regardless </span><a id="_idIndexMarker1770"/><span class="koboSpan" id="kobo.46.1">of whether the application is running in the development environment, the response body contains the stack trace. </span><span class="koboSpan" id="kobo.46.2">We should never show the stack trace for the production environment. </span><span class="koboSpan" id="kobo.46.3">Additionally, the response body is not a valid JSON payload, making it difficult for the client to </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">parse it.</span></span></p>
<p><span class="koboSpan" id="kobo.48.1">ASP.NET Core provides a built-in exception handling middleware to handle exceptions and return an error payload. </span><span class="koboSpan" id="kobo.48.2">The exception handling middleware can return a valid JSON payload to the client. </span><span class="koboSpan" id="kobo.48.3">This kind of JSON payload for error and exceptions is called </span><strong class="bold"><span class="koboSpan" id="kobo.49.1">Problem Details</span></strong><span class="koboSpan" id="kobo.50.1"> and is defined in </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">RFC7807: </span></span><a href="https://datatracker.ietf.org/doc/html/rfc7807"><span class="No-Break"><span class="koboSpan" id="kobo.52.1">https://datatracker.ietf.org/doc/html/rfc7807</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.53.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.54.1">A problem details object can have the </span><span class="No-Break"><span class="koboSpan" id="kobo.55.1">following properties:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.56.1">type</span></strong><span class="koboSpan" id="kobo.57.1">: A URI reference that’s used to identify the problem type. </span><span class="koboSpan" id="kobo.57.2">This reference provides helpful documentation in a human-readable format, which can assist clients in understanding </span><span class="No-Break"><span class="koboSpan" id="kobo.58.1">the error.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.59.1">title</span></strong><span class="koboSpan" id="kobo.60.1">: A summary that describes the problem’s type in a </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">human-readable format.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.62.1">status</span></strong><span class="koboSpan" id="kobo.63.1">: An HTTP status code generated by the original server to indicate the status of </span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">the problem.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.65.1">detail</span></strong><span class="koboSpan" id="kobo.66.1">: A human-readable description of </span><span class="No-Break"><span class="koboSpan" id="kobo.67.1">the problem.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.68.1">instance</span></strong><span class="koboSpan" id="kobo.69.1">: A URI reference that provides a specific occurrence of the problem, allowing for a more precise understanding of </span><span class="No-Break"><span class="koboSpan" id="kobo.70.1">the issue.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.71.1">The client </span><a id="_idIndexMarker1771"/><span class="koboSpan" id="kobo.72.1">can parse the problem details object and display a user-friendly error message. </span><span class="koboSpan" id="kobo.72.2">This object can be extended to include additional information about the error, though the existing properties should be sufficient for </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">most cases.</span></span></p>
<p><span class="koboSpan" id="kobo.74.1">To use the exception handling middleware, we need to create a controller to show the problem details. </span><span class="koboSpan" id="kobo.74.2">Create a new controller named </span><strong class="source-inline"><span class="koboSpan" id="kobo.75.1">ErrorController</span></strong><span class="koboSpan" id="kobo.76.1"> and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.78.1">
[ApiController][ApiExplorerSettings(IgnoreApi = true)]
public class ErrorController(ILogger&lt;ErrorController&gt; logger) : ControllerBase
{
    [Route("/error-development")]
    public IActionResult HandleErrorDevelopment(
        [FromServices] IHostEnvironment hostEnvironment)
    {
        if (!hostEnvironment.IsDevelopment())
        {
            return NotFound();
        }
        var exceptionHandlerFeature =
            HttpContext.Features.Get&lt;IExceptionHandlerFeature&gt;()!;
        logger.LogError(exceptionHandlerFeature.Error, exceptionHandlerFeature.Error.Message);
        return Problem(
            detail: exceptionHandlerFeature.Error.StackTrace,
            title: exceptionHandlerFeature.Error.Message);
    }
    [Route("/error")]
    public IActionResult HandleError()
    {
        var exceptionHandlerFeature =
            HttpContext.Features.Get&lt;IExceptionHandlerFeature&gt;()!;
        logger.LogError(exceptionHandlerFeature.Error, exceptionHandlerFeature.Error.Message);
        return Problem();
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.79.1">The preceding</span><a id="_idIndexMarker1772"/><span class="koboSpan" id="kobo.80.1"> code comes from Microsoft’s official </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">documentation: </span></span><a href="https://learn.microsoft.com/en-us/aspnet/core/web-api/handle-errors"><span class="No-Break"><span class="koboSpan" id="kobo.82.1">https://learn.microsoft.com/en-us/aspnet/core/web-api/handle-errors</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.83.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.84.1">There are several things to note in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.85.1">ErrorController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.86.1"> class:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.87.1">The controller is marked with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.88.1">[ApiExplorerSettings(IgnoreApi = true)]</span></strong><span class="koboSpan" id="kobo.89.1"> attribute. </span><span class="koboSpan" id="kobo.89.2">This attribute is used to hide this endpoint from the OpenAPI specification and </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">Swagger UI.</span></span></li>
<li><span class="koboSpan" id="kobo.91.1">The controller has two actions. </span><span class="koboSpan" id="kobo.91.2">The first action is used to show a detailed error message in the development environment, so it provides the route </span><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">/error-development</span></strong><span class="koboSpan" id="kobo.93.1"> that shows the stack trace of the exception. </span><span class="koboSpan" id="kobo.93.2">The second action is used to show a generic error message in the production environment, so it provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.94.1">/error</span></strong><span class="koboSpan" id="kobo.95.1"> route that has no additional information about </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">the exception.</span></span></li>
<li><span class="koboSpan" id="kobo.97.1">In the </span><a id="_idIndexMarker1773"/><span class="koboSpan" id="kobo.98.1">actions, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.99.1">IExceptionHandlerFeature</span></strong><span class="koboSpan" id="kobo.100.1"> interface to get the exception information. </span><span class="koboSpan" id="kobo.100.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.101.1">IExceptionHandlerFeature</span></strong><span class="koboSpan" id="kobo.102.1"> interface is a feature containing the exception of the original request to be examined by an exception handler. </span><span class="koboSpan" id="kobo.102.2">We can log the exception information or return it to </span><span class="No-Break"><span class="koboSpan" id="kobo.103.1">the client.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.104.1">Next, we need to register the exception handling middleware in the application. </span><span class="koboSpan" id="kobo.104.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.105.1">Program.cs</span></strong><span class="koboSpan" id="kobo.106.1"> file and call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.107.1">UseExceptionHandler</span></strong><span class="koboSpan" id="kobo.108.1"> method to add the exception </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">handling middleware:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.110.1">
if (app.Environment.IsDevelopment()){
    app.UseSwagger();
    app.UseSwaggerUI();
    app.UseExceptionHandler("/error-development");
}
else
{
    app.UseExceptionHandler("/error");
}</span></pre>
<p><span class="koboSpan" id="kobo.111.1">For the development environment, we can use the /</span><strong class="source-inline"><span class="koboSpan" id="kobo.112.1">error-development</span></strong><span class="koboSpan" id="kobo.113.1"> endpoint to show the detailed error message. </span><span class="koboSpan" id="kobo.113.2">For the production environment, we can use the /</span><strong class="source-inline"><span class="koboSpan" id="kobo.114.1">error</span></strong><span class="koboSpan" id="kobo.115.1"> endpoint to show the generic error message. </span><span class="koboSpan" id="kobo.115.2">It is a good practice to hide the stack trace in the </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">production environment.</span></span></p>
<p><span class="koboSpan" id="kobo.117.1">Run the application and send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.118.1">GET</span></strong><span class="koboSpan" id="kobo.119.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.120.1">https://localhost:5001/users/100</span></strong><span class="koboSpan" id="kobo.121.1"> endpoint. </span><span class="koboSpan" id="kobo.121.2">The application will return a 500 error. </span><span class="koboSpan" id="kobo.121.3">The response body will look </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer144">
<span class="koboSpan" id="kobo.123.1"><img alt="Figure 16.2 – The response body contains the problem details alongside the stack trace in the development environment" src="image/B18971_16_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.124.1">Figure 16.2 – The response body contains the problem details alongside the stack trace in the development environment</span></p>
<p><span class="koboSpan" id="kobo.125.1">The response</span><a id="_idIndexMarker1774"/><span class="koboSpan" id="kobo.126.1"> body now contains a problem details JSON payload. </span><span class="koboSpan" id="kobo.126.2">It also contains the stack trace of the exception for troubleshooting in the development environment. </span><span class="koboSpan" id="kobo.126.3">The client can parse the response body and display a user-friendly error message. </span><span class="koboSpan" id="kobo.126.4">Meanwhile, the response headers contain the </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">Content-Type</span></strong><span class="koboSpan" id="kobo.128.1"> header with a value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">application</span></strong><span class="koboSpan" id="kobo.130.1">/</span><strong class="source-inline"><span class="koboSpan" id="kobo.131.1">problem+json</span></strong><span class="koboSpan" id="kobo.132.1">. </span><span class="koboSpan" id="kobo.132.2">This indicates that the response body is a problem details </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">JSON payload.</span></span></p>
<p><span class="koboSpan" id="kobo.134.1">If you run the application in the production environment, the response body will not contain the stack trace of the exception. </span><span class="koboSpan" id="kobo.134.2">The response body will look </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer145">
<span class="koboSpan" id="kobo.136.1"><img alt="Figure 16.3 – The response body contains a general error message in the production environment" src="image/B18971_16_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.137.1">Figure 16.3 – The response body contains a general error message in the production environment</span></p>
<p><span class="koboSpan" id="kobo.138.1">The default problem details object can be extended to include additional information about the error. </span><span class="koboSpan" id="kobo.138.2">We will discuss how to customize the problem details in the </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">next secti</span><a id="_idTextAnchor677"/><span class="koboSpan" id="kobo.140.1">on.</span></span></p>
<h3><span class="koboSpan" id="kobo.141.1">Model validation</span></h3>
<p><span class="koboSpan" id="kobo.142.1">When a </span><a id="_idIndexMarker1775"/><span class="koboSpan" id="kobo.143.1">client sends a request to the application, the application needs to validate the request. </span><span class="koboSpan" id="kobo.143.2">For example, when a user updates their profile, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">Email</span></strong><span class="koboSpan" id="kobo.145.1"> property must be a valid email address. </span><span class="koboSpan" id="kobo.145.2">If the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">Email</span></strong><span class="koboSpan" id="kobo.147.1"> property is invalid, the application should return an HTTP 400 response with a problem details object that contains the validation </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">error message.</span></span></p>
<p><span class="koboSpan" id="kobo.149.1">ASP.NET Core offers a built-in model validation feature to validate the request model. </span><span class="koboSpan" id="kobo.149.2">This feature is enabled using validation attributes, which are defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.150.1">System.ComponentModel.DataAnnotations</span></strong><span class="koboSpan" id="kobo.151.1"> namespace. </span><span class="koboSpan" id="kobo.151.2">The following table outlines some available </span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">validation attributes:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-11">
<colgroup>
<col/>
<col/>
</colgroup>
<thead>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.153.1">Attribute name</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.154.1">Description</span></span></p>
</td>
</tr>
</thead>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">Required</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.156.1">Specifies that a data field </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">is required</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.158.1">Range</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.159.1">Specifies that a numeric field must be in a </span><span class="No-Break"><span class="koboSpan" id="kobo.160.1">specified range</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">StringLength</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.162.1">Specifies the minimum and maximum length of a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">string</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.164.1"> field</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">EmailAddress</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.166.1">Specifies that a data field must be a valid </span><span class="No-Break"><span class="koboSpan" id="kobo.167.1">email address</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">RegularExpression</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.169.1">Specifies that a data field must match the specified </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">regular expression</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.171.1">Url</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.172.1">Specifies that a data field must be a </span><span class="No-Break"><span class="koboSpan" id="kobo.173.1">valid URL</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.174.1">Table 16.1 – Common model validation attributes</span></p>
<p><span class="koboSpan" id="kobo.175.1">We can apply these validation attributes </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.177.1">
public class User{
    public int Id { get; set; }
    [Required]
    [StringLength(50, MinimumLength = 3, ErrorMessage = "The length of FirstName must be between 3 and 50.")]
    public string FirstName { get; set; } = string.Empty;
    [Required]
    [StringLength(50, MinimumLength = 3, ErrorMessage = "The length of LastName must be between 3 and 50.")]
    public string LastName { get; set; } = string.Empty;
    [Required]
    [Range(1, 120, ErrorMessage = "The value of Age must be between 1 and 120.")]
    public int Age { get; set; }
    [Required]
    [EmailAddress]
    public string Email { get; set; } = string.Empty;
    [Required]
    [Phone]
    public string PhoneNumber { get; set; } = string.Empty;
}</span></pre>
<p><span class="koboSpan" id="kobo.178.1">Run the application and send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">POST</span></strong><span class="koboSpan" id="kobo.180.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">/users</span></strong><span class="koboSpan" id="kobo.182.1"> endpoint with an invalid request body, </span><span class="No-Break"><span class="koboSpan" id="kobo.183.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.184.1">
{  "firstName": "ab",
  "lastName": "xy",
  "age": 20,
  "email": "user-example.com",
  "phoneNumber": "abcxyz"
}</span></pre>
<p><span class="koboSpan" id="kobo.185.1">The application </span><a id="_idIndexMarker1776"/><span class="koboSpan" id="kobo.186.1">will return an HTTP 400 response with a problem details object, </span><span class="No-Break"><span class="koboSpan" id="kobo.187.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.188.1">
{  "type": "https://tools.ietf.org/html/rfc9110#section-15.5.1",
  "title": "One or more validation errors occurred.",
  "status": 400,
  "errors": {
    "Email": [
      "The Email field is not a valid e-mail address."
</span><span class="koboSpan" id="kobo.188.2">    ],
    "LastName": [
      "The length of LastName must be between 3 and 50."
</span><span class="koboSpan" id="kobo.188.3">    ],
    "FirstName": [
      "The length of FirstName must be between 3 and 50."
</span><span class="koboSpan" id="kobo.188.4">    ],
    "PhoneNumber": [
      "The PhoneNumber field is not a valid phone number."
</span><span class="koboSpan" id="kobo.188.5">    ]
  },
  "traceId": "00-8bafbe8952051318d15ddb570d2872b0-369effbb9978122b-00"
}</span></pre>
<p><span class="koboSpan" id="kobo.189.1">In this way, the</span><a id="_idIndexMarker1777"/><span class="koboSpan" id="kobo.190.1"> client can parse the response body and display a user-friendly error message so that the user can correct </span><span class="No-Break"><span class="koboSpan" id="kobo.191.1">the input</span><a id="_idTextAnchor678"/><span class="koboSpan" id="kobo.192.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.193.1">Using FluentValidation to validate models</span></h3>
<p><span class="koboSpan" id="kobo.194.1">The </span><a id="_idIndexMarker1778"/><span class="koboSpan" id="kobo.195.1">previous section discussed the use of built-in validation attributes. </span><span class="koboSpan" id="kobo.195.2">However, these have </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">certain limitations:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.197.1">The validation attributes are tightly coupled with the model. </span><span class="koboSpan" id="kobo.197.2">The models are polluted with </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">validation attributes.</span></span></li>
<li><span class="koboSpan" id="kobo.199.1">The validation attributes cannot validate complex validation rules. </span><span class="koboSpan" id="kobo.199.2">If one property has dependencies on other properties, or the validation needs external services, the validation attributes cannot </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">handle this.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.201.1">To solve these problems, we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.202.1">FluentValidation</span></strong><span class="koboSpan" id="kobo.203.1"> to validate the models. </span><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">FluentValidation</span></strong><span class="koboSpan" id="kobo.205.1"> is a popular open-source library for building strongly typed validation rules, allowing us to separate the validation logic from the models. </span><span class="koboSpan" id="kobo.205.2">It also supports complex </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">validation rules.</span></span></p>
<p><span class="koboSpan" id="kobo.207.1">To use </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">FluentValidation</span></strong><span class="koboSpan" id="kobo.209.1">, we need to install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">FluentValidation.AspNetCore</span></strong><span class="koboSpan" id="kobo.211.1"> NuGet package. </span><span class="koboSpan" id="kobo.211.2">Run the following command in the terminal to install </span><span class="No-Break"><span class="koboSpan" id="kobo.212.1">the package:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.213.1">
dotnet add package FluentValidation</span></pre> <p class="callout-heading"><span class="koboSpan" id="kobo.214.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.215.1">Previously, </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">FluentValidation</span></strong><span class="koboSpan" id="kobo.217.1"> provided a separate package for ASP.NET Core named </span><strong class="source-inline"><span class="koboSpan" id="kobo.218.1">FluentValidation.AspNetCore</span></strong><span class="koboSpan" id="kobo.219.1">. </span><span class="koboSpan" id="kobo.219.2">However, this package is deprecated. </span><span class="koboSpan" id="kobo.219.3">It is recommended to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">FluentValidation</span></strong><span class="koboSpan" id="kobo.221.1"> package directly and use manual validation instead of using the ASP.NET Core validation pipeline. </span><span class="koboSpan" id="kobo.221.2">This is because the ASP.NET Core validation pipeline does not support </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">asynchronous validation.</span></span></p>
<p><span class="koboSpan" id="kobo.223.1">Next, we </span><a id="_idIndexMarker1779"/><span class="koboSpan" id="kobo.224.1">need to create a validator for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">User</span></strong><span class="koboSpan" id="kobo.226.1"> model. </span><span class="koboSpan" id="kobo.226.2">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.227.1">UserValidator</span></strong><span class="koboSpan" id="kobo.228.1"> and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.230.1">
public class UserValidator : AbstractValidator&lt;User&gt;{
    public UserValidator()
    {
        RuleFor(u =&gt; u.FirstName)
            .NotEmpty()
            .WithMessage("The FirstName field is required.")
            .Length(3, 50)
            .WithMessage("The length of FirstName must be between 3 and 50.");
        // Omitted other rules for brevity
        // Create a custom rule to validate the Country and PhoneNumber. </span><span class="koboSpan" id="kobo.230.2">If the country is New Zealand, the phone number must start with 64.
</span><span class="koboSpan" id="kobo.230.3">        RuleFor(u =&gt; u)
            .Custom((user, context) =&gt;
            {
                if (user.Country.ToLower() == "new zealand" &amp;&amp; !user.PhoneNumber.StartsWith("64"))
                {
                    context.AddFailure("The phone number must start with 64 for New Zealand users.");
                }
            });
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.231.1">In the</span><a id="_idIndexMarker1780"/><span class="koboSpan" id="kobo.232.1"> preceding code, we use fluent syntax to specify validation rules for each property. </span><span class="koboSpan" id="kobo.232.2">We can also create a custom rule for dependent properties. </span><span class="koboSpan" id="kobo.232.3">In this example, we’re creating a custom rule to validate the </span><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">Country</span></strong><span class="koboSpan" id="kobo.234.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.235.1">PhoneNumber</span></strong><span class="koboSpan" id="kobo.236.1"> properties. </span><span class="koboSpan" id="kobo.236.2">If the country is New Zealand, we can create a custom rule that requires the phone number to start with 64. </span><span class="koboSpan" id="kobo.236.3">This is just one example of how to validate properties that depend on other properties; built-in validation attributes cannot handle this type </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">of validation.</span></span></p>
<p><span class="koboSpan" id="kobo.238.1">Next, we need to register the validator in the application. </span><span class="koboSpan" id="kobo.238.2">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.239.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.240.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.241.1">
builder.Services.AddScoped&lt;IValidator&lt;User&gt;, UserValidator&gt;();</span></pre> <p><span class="koboSpan" id="kobo.242.1">The preceding code looks straightforward. </span><span class="koboSpan" id="kobo.242.2">But what if we have many validators? </span><span class="koboSpan" id="kobo.242.3">We can register all validators in a specific assembly. </span><span class="koboSpan" id="kobo.242.4">To do this, we need to install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">FluentValidation.DependencyInjectionExtensions</span></strong><span class="koboSpan" id="kobo.244.1"> NuGet package. </span><span class="koboSpan" id="kobo.244.2">Run the following command in the terminal to install </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">the package:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.246.1">
dotnet add package FluentValidation.DependencyInjectionExtensions</span></pre> <p><span class="koboSpan" id="kobo.247.1">Then, we can register all validators, </span><span class="No-Break"><span class="koboSpan" id="kobo.248.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.249.1">
builder.Services.AddValidatorsFromAssemblyContaining&lt;UserValidator&gt;();</span></pre> <p><span class="koboSpan" id="kobo.250.1">Now, we can validate the model in the controller. </span><span class="koboSpan" id="kobo.250.2">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">Post</span></strong><span class="koboSpan" id="kobo.252.1"> action, </span><span class="No-Break"><span class="koboSpan" id="kobo.253.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.254.1">
[HttpPost]public async Task&lt;ActionResult&lt;User&gt;&gt; Post(User user)
{
    var validationResult = await _validator.ValidateAsync(user);
    if (!validationResult.IsValid)
    {
        return BadRequest(new ValidationProblemDetails(validationResult.ToDictionary()));
    }
    user.Id = Users.Max(u =&gt; u.Id) + 1;
    Users.Add(user);
    return CreatedAtRoute("", new { id = user.Id }, user);
}</span></pre>
<p><span class="koboSpan" id="kobo.255.1">In the</span><a id="_idIndexMarker1781"/><span class="koboSpan" id="kobo.256.1"> preceding code, we utilize the </span><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">ValidateAsync()</span></strong><span class="koboSpan" id="kobo.258.1"> method to validate the model. </span><span class="koboSpan" id="kobo.258.2">If the model is invalid, we return an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">400</span></strong><span class="koboSpan" id="kobo.260.1"> response containing a problem details object that contains the associated validation </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">error message.</span></span></p>
<p><span class="koboSpan" id="kobo.262.1">Send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">POST</span></strong><span class="koboSpan" id="kobo.264.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">/users</span></strong><span class="koboSpan" id="kobo.266.1"> endpoint with the </span><span class="No-Break"><span class="koboSpan" id="kobo.267.1">following payload:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.268.1">
{  "firstName": "ab",
  "lastName": "xy",
  "age": 20,
  "email": "user-example.com",
  "country": "New Zealand",
  "phoneNumber": "12345678"
}</span></pre>
<p><span class="koboSpan" id="kobo.269.1">The application </span><a id="_idIndexMarker1782"/><span class="koboSpan" id="kobo.270.1">will return a 400 error with the following problem </span><span class="No-Break"><span class="koboSpan" id="kobo.271.1">details object:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.272.1">
{  "title": "One or more validation errors occurred.",
  "status": 400,
  "errors": {
    "FirstName": [
      "The length of LastName must be between 3 and 50."
</span><span class="koboSpan" id="kobo.272.2">    ],
    "LastName": [
      "The length of LastName must be between 3 and 50."
</span><span class="koboSpan" id="kobo.272.3">    ],
    "Email": [
      "The Email field is not a valid e-mail address."
</span><span class="koboSpan" id="kobo.272.4">    ],
    "": [
      "The phone number must start with 64 for New Zealand users."
</span><span class="koboSpan" id="kobo.272.5">    ]
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.273.1">As we can see, the custom validation rule is executed and the error message is returned to </span><span class="No-Break"><span class="koboSpan" id="kobo.274.1">the client.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">FluentValidation</span></strong><span class="koboSpan" id="kobo.276.1"> has more features than just built-in validation attributes. </span><span class="koboSpan" id="kobo.276.2">If you have complex validation rules, you can consider using </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">FluentValidation</span></strong><span class="koboSpan" id="kobo.278.1">. </span><span class="koboSpan" id="kobo.278.2">For more details, please refer to the official </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">documentation: </span></span><a href="https://docs.fluentvalidation.net/en/latest/index﻿.html"><span class="No-Break"><span class="koboSpan" id="kobo.280.1">https://docs.fluentvalidation.net/en/latest/index</span><span id="_idTextAnchor679"/><span class="koboSpan" id="kobo.281.1">.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.282.1">.</span></span></p>
<h1 id="_idParaDest-358"><a id="_idTextAnchor680"/><span class="koboSpan" id="kobo.283.1">Health checks</span></h1>
<p><span class="koboSpan" id="kobo.284.1">To monitor the application, we need to know whether the application is running correctly or not. </span><span class="koboSpan" id="kobo.284.2">We can perform health checks to monitor the application. </span><span class="koboSpan" id="kobo.284.3">Normally, a health check is an endpoint that returns the health status of the application. </span><span class="koboSpan" id="kobo.284.4">This status can be </span><em class="italic"><span class="koboSpan" id="kobo.285.1">Healthy</span></em><span class="koboSpan" id="kobo.286.1">, </span><em class="italic"><span class="koboSpan" id="kobo.287.1">Degraded</span></em><span class="koboSpan" id="kobo.288.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.289.1">or </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.290.1">Unhealthy</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.291.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.292.1">A </span><a id="_idIndexMarker1783"/><span class="koboSpan" id="kobo.293.1">health check is a critical part of the microservice architecture. </span><span class="koboSpan" id="kobo.293.2">In the microservice architecture, one API service may have multiple instances and also have dependencies on other services. </span><span class="koboSpan" id="kobo.293.3">A load balancer or orchestrator can be used to distribute the traffic to different instances. </span><span class="koboSpan" id="kobo.293.4">If one instance is unhealthy, the load balancer or orchestrator can stop sending traffic to the unhealthy instance. </span><span class="koboSpan" id="kobo.293.5">For example, Kubernetes – a popular container orchestrator – can use health checks to determine whether a container is healthy or not. </span><span class="koboSpan" id="kobo.293.6">If a container is not live, Kubernetes will restart </span><span class="No-Break"><span class="koboSpan" id="kobo.294.1">the container.</span></span></p>
<p><span class="koboSpan" id="kobo.295.1">We won’t discuss the details of Kubernetes in this book. </span><span class="koboSpan" id="kobo.295.2">Instead, we will focus on how to implement health checks for Kubernetes in ASP.NET Core web </span><span class="No-Break"><span class="koboSpan" id="kobo.296.1">API applic</span><a id="_idTextAnchor681"/><span class="koboSpan" id="kobo.297.1">ations.</span></span></p>
<h2 id="_idParaDest-359"><a id="_idTextAnchor682"/><span class="koboSpan" id="kobo.298.1">Implementing a basic health check</span></h2>
<p><span class="koboSpan" id="kobo.299.1">ASP.NET Core</span><a id="_idIndexMarker1784"/><span class="koboSpan" id="kobo.300.1"> provides a straightforward way to configure health checks. </span><span class="koboSpan" id="kobo.300.2">We can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">AddHealthChecks</span></strong><span class="koboSpan" id="kobo.302.1"> method to add health checks to the application. </span><span class="koboSpan" id="kobo.302.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">Program.cs</span></strong><span class="koboSpan" id="kobo.304.1"> file and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.306.1">
builder.Services.AddHealthChecks();var app = builder.Build();
app.MapHealthChecks("healthcheck");</span></pre>
<p><span class="koboSpan" id="kobo.307.1">The preceding code adds a basic health check to the application. </span><span class="koboSpan" id="kobo.307.2">The health check’s endpoint is </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">/healthcheck</span></strong><span class="koboSpan" id="kobo.309.1">. </span><span class="koboSpan" id="kobo.309.2">Run the application and send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">GET</span></strong><span class="koboSpan" id="kobo.311.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">/healthcheck</span></strong><span class="koboSpan" id="kobo.313.1"> endpoint. </span><span class="koboSpan" id="kobo.313.2">If successful, the application will return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">200</span></strong><span class="koboSpan" id="kobo.315.1"> response with </span><strong class="source-inline"><span class="koboSpan" id="kobo.316.1">Healthy</span></strong><span class="koboSpan" id="kobo.317.1"> in plain text in the </span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">response body.</span></span></p>
<p><span class="koboSpan" id="kobo.319.1">However, this health check is too simple. </span><span class="koboSpan" id="kobo.319.2">In the real world, a web API application may be more complex. </span><span class="koboSpan" id="kobo.319.3">It may have multiple dependencies, such as databases, message queues, and other services. </span><span class="koboSpan" id="kobo.319.4">We</span><a id="_idIndexMarker1785"/><span class="koboSpan" id="kobo.320.1"> need to check the health status of these dependencies. </span><span class="koboSpan" id="kobo.320.2">If some core dependencies are unhealthy, the application should be unhealthy. </span><span class="koboSpan" id="kobo.320.3">Let’s see how to implement a more complex </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">heal</span><a id="_idTextAnchor683"/><span class="koboSpan" id="kobo.322.1">th check.</span></span></p>
<h3><span class="koboSpan" id="kobo.323.1">Implementing a complex health check</span></h3>
<p><span class="koboSpan" id="kobo.324.1">A health check</span><a id="_idIndexMarker1786"/><span class="koboSpan" id="kobo.325.1"> implementation class implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">IHealthCheck</span></strong><span class="koboSpan" id="kobo.327.1"> interface. </span><span class="koboSpan" id="kobo.327.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">IHealthCheck</span></strong><span class="koboSpan" id="kobo.329.1"> interface is defined </span><span class="No-Break"><span class="koboSpan" id="kobo.330.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.331.1">
public interface IHealthCheck{
    Task&lt;HealthCheckResult&gt; CheckHealthAsync(
        HealthCheckContext context,
        CancellationToken cancellationToken = default);
}</span></pre>
<p><span class="koboSpan" id="kobo.332.1">We can create a custom health check implementation to ensure the proper functioning of our API. </span><span class="koboSpan" id="kobo.332.2">For instance, if the API depends on another service, we can create a health check implementation to verify the health status of the dependent service. </span><span class="koboSpan" id="kobo.332.3">If the dependent service is unhealthy, the API won’t be able to function correctly. </span><span class="koboSpan" id="kobo.332.4">Here is an example of a health </span><span class="No-Break"><span class="koboSpan" id="kobo.333.1">check implementation:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.334.1">
public class OtherServiceHealthCheck(IHttpClientFactory httpClientFactory) : IHealthCheck{
    public async Task&lt;HealthCheckResult&gt; CheckHealthAsync(
        HealthCheckContext context,
        CancellationToken cancellationToken = default)
    {
        var client = httpClientFactory.CreateClient("JsonPlaceholder");
        var response = await client.GetAsync("posts", cancellationToken);
        return response.IsSuccessStatusCode
            ? </span><span class="koboSpan" id="kobo.334.2">HealthCheckResult.Healthy("A healthy result.")
            : HealthCheckResult.Unhealthy("An unhealthy result.");
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.335.1">In the</span><a id="_idIndexMarker1787"/><span class="koboSpan" id="kobo.336.1"> preceding code, we create a health check implementation to check the health status of the </span><a href="https://jsonplaceholder.typicode.com/posts"><span class="koboSpan" id="kobo.337.1">https://jsonplaceholder.typicode.com/posts</span></a><span class="koboSpan" id="kobo.338.1"> endpoint. </span><span class="koboSpan" id="kobo.338.2">If the endpoint returns a 200 response, the health check returns healthy. </span><span class="koboSpan" id="kobo.338.3">Otherwise, the health check </span><span class="No-Break"><span class="koboSpan" id="kobo.339.1">returns unhealthy.</span></span></p>
<p><span class="koboSpan" id="kobo.340.1">Next, we need to register the health check implementation in the application. </span><span class="koboSpan" id="kobo.340.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">Program.cs</span></strong><span class="koboSpan" id="kobo.342.1"> file and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.344.1">
builder.Services.AddHealthChecks()    .AddCheck&lt;OtherServiceHealthCheck&gt;("OtherService");
// Omitted other code for brevity
app.MapHealthChecks("/other-service-health-check",
    new HealthCheckOptions() { Predicate = healthCheck =&gt; healthCheck.Name == "OtherService" });</span></pre>
<p><span class="koboSpan" id="kobo.345.1">This code is similar to the previous health check. </span><span class="koboSpan" id="kobo.345.2">First, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">AddHealthChecks</span></strong><span class="koboSpan" id="kobo.347.1"> method to register the strongly typed health check implementation. </span><span class="koboSpan" id="kobo.347.2">Then, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">MapHealthCheck</span></strong><span class="koboSpan" id="kobo.349.1"> method to map the </span><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">/other-service-health-check</span></strong><span class="koboSpan" id="kobo.351.1"> endpoint to the health check implementation. </span><span class="koboSpan" id="kobo.351.2">We also use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.352.1">HealthCheckOptions</span></strong><span class="koboSpan" id="kobo.353.1"> object to specify the name of the health check, which is used to filter the health checks. </span><span class="koboSpan" id="kobo.353.2">If we do not specify the name of the health check, all health check implementations will </span><span class="No-Break"><span class="koboSpan" id="kobo.354.1">be executed.</span></span></p>
<p><span class="koboSpan" id="kobo.355.1">Run the application and send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">GET</span></strong><span class="koboSpan" id="kobo.357.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">/other-service-health-check</span></strong><span class="koboSpan" id="kobo.359.1"> endpoint. </span><span class="koboSpan" id="kobo.359.2">If the dependent service, </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">https://jsonplaceholder.typicode.com/posts</span></strong><span class="koboSpan" id="kobo.361.1">, is healthy, the application will return a 200 response with </span><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">Healthy</span></strong><span class="koboSpan" id="kobo.363.1"> in plain text in the </span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">response body.</span></span></p>
<p><span class="koboSpan" id="kobo.365.1">Sometimes, we </span><a id="_idIndexMarker1788"/><span class="koboSpan" id="kobo.366.1">need to check multiple dependent services. </span><span class="koboSpan" id="kobo.366.2">We can register multiple health check implementations with a specific tag, at which point we can use this tag to filter the health checks. </span><span class="koboSpan" id="kobo.366.3">The following code shows how to register multiple health </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">check implementations:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.368.1">
builder.Services.AddHealthChecks()    .AddCheck&lt;OtherServiceHealthCheck&gt;("OtherService", tags: new[] { "other-service" })
    .AddCheck&lt;OtherService2HealthCheck&gt;("OtherService2", tags: new[] { "other-service" });
    .AddCheck&lt;OtherService3HealthCheck&gt;("OtherService3", tags: new[] { "other-service" });</span></pre>
<p><span class="koboSpan" id="kobo.369.1">In the preceding code, we register three health check implementations with the same tag – that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">other-service</span></strong><span class="koboSpan" id="kobo.371.1">. </span><span class="koboSpan" id="kobo.371.2">Now, we can use the tag to filter the health checks. </span><span class="koboSpan" id="kobo.371.3">The following code shows how to filter the </span><span class="No-Break"><span class="koboSpan" id="kobo.372.1">health checks:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.373.1">
app.MapHealthChecks("/other-services-health-check",    new HealthCheckOptions() { Predicate = healthCheck =&gt; healthCheck.Tags.Contains("other-service") });</span></pre>
<p><span class="koboSpan" id="kobo.374.1">Like the </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">Name</span></strong><span class="koboSpan" id="kobo.376.1"> property, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">Tags</span></strong><span class="koboSpan" id="kobo.378.1"> property to filter the health checks. </span><span class="koboSpan" id="kobo.378.2">When we send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">GET</span></strong><span class="koboSpan" id="kobo.380.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">/other-services-health-check</span></strong><span class="koboSpan" id="kobo.382.1"> endpoint, the application will return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">200 OK</span></strong><span class="koboSpan" id="kobo.384.1"> response with </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">Healthy</span></strong><span class="koboSpan" id="kobo.386.1"> in plain text in the response body if all dependent services are healthy. </span><span class="koboSpan" id="kobo.386.2">But if one of the dependent services is unhealthy, the health check will return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">503 Service Unavailable</span></strong><span class="koboSpan" id="kobo.388.1"> response with </span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">Unhealthy</span></strong><span class="koboSpan" id="kobo.390.1"> in plain text in the </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">response body.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.392.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.393.1">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">MapHealthChecks()</span></strong><span class="koboSpan" id="kobo.395.1"> method does not use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">HealthCheckOptions</span></strong><span class="koboSpan" id="kobo.397.1"> parameter, the health check endpoint will run all registered health checks</span><a id="_idTextAnchor684"/> <span class="No-Break"><span class="koboSpan" id="kobo.398.1">by default.</span></span></p>
<h3><span class="koboSpan" id="kobo.399.1">Implementing a database health check</span></h3>
<p><span class="koboSpan" id="kobo.400.1">In the</span><a id="_idIndexMarker1789"/><span class="koboSpan" id="kobo.401.1"> previous section, we discussed how to implement a health check for a dependent service. </span><span class="koboSpan" id="kobo.401.2">As databases are a common component of web API applications, this section will focus on how to implement a database </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">health check.</span></span></p>
<p><span class="koboSpan" id="kobo.403.1">The approach to implementing a database health check is similar to what we covered in the previous section: we need to connect to the database and execute a simple query to check if the database is healthy. </span><span class="koboSpan" id="kobo.403.2">If you use EF Core to access the database, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.404.1">Microsoft.Extensions.Diagnostics.HealthChecks.EntityFrameworkCore</span></strong><span class="koboSpan" id="kobo.405.1"> package to implement a database health check. </span><span class="koboSpan" id="kobo.405.2">This package provides a health check implementation for EF Core, so we do not need to write the health check implementation ourselves. </span><span class="koboSpan" id="kobo.405.3">Run the following command in the terminal to install </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">the package:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.407.1">
dotnet add package Microsoft.Extensions.Diagnostics.HealthChecks.EntityFrameworkCore</span></pre> <p><span class="koboSpan" id="kobo.408.1">In the sample project, we have an </span><strong class="source-inline"><span class="koboSpan" id="kobo.409.1">InvoiceDbContext</span></strong><span class="koboSpan" id="kobo.410.1"> class to access the database. </span><span class="koboSpan" id="kobo.410.2">The following code shows how to register the </span><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">InvoiceDbContext</span></strong><span class="koboSpan" id="kobo.412.1"> class in </span><span class="No-Break"><span class="koboSpan" id="kobo.413.1">the application:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.414.1">
builder.Services.AddDbContext&lt;InvoiceDbContext&gt;(options =&gt;    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));</span></pre>
<p><span class="koboSpan" id="kobo.415.1">Once you’ve done this, register the EF Core </span><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">DbContext</span></strong><span class="koboSpan" id="kobo.417.1"> health check implementation, </span><span class="No-Break"><span class="koboSpan" id="kobo.418.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.419.1">
builder.Services.AddHealthChecks().AddDbContextCheck&lt;InvoiceDbContext&gt;("Database", tags: new[] { "database" });</span></pre> <p><span class="koboSpan" id="kobo.420.1">Similarly, assign a tag to the health check implementation so that we can filter the health checks. </span><span class="koboSpan" id="kobo.420.2">Then, we can map the health check endpoint to the health check’s implementation, </span><span class="No-Break"><span class="koboSpan" id="kobo.421.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.422.1">
app.MapHealthChecks("/database-health-checks",    new HealthCheckOptions() { Predicate = healthCheck =&gt; healthCheck.Tags.Contains("database") });</span></pre>
<p><span class="koboSpan" id="kobo.423.1">Run the</span><a id="_idIndexMarker1790"/><span class="koboSpan" id="kobo.424.1"> application and send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">GET</span></strong><span class="koboSpan" id="kobo.426.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">/database-health-checks</span></strong><span class="koboSpan" id="kobo.428.1"> endpoint. </span><span class="koboSpan" id="kobo.428.2">If the database is healthy, the application will return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">200 OK</span></strong><span class="koboSpan" id="kobo.430.1"> response with </span><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">Healthy</span></strong><span class="koboSpan" id="kobo.432.1"> in plain text in the response body. </span><span class="koboSpan" id="kobo.432.2">Additionally, you can register multiple health checks for different databases </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">if necessary.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.434.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.435.1">If you are using other ORMs to access the database, you can create a custom health check implementation following the previous section. </span><span class="koboSpan" id="kobo.435.2">This can be done by executing a simple query, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">SELECT 1</span></strong><span class="koboSpan" id="kobo.437.1">, to determine whether the database is </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">functio</span><a id="_idTextAnchor685"/><span class="koboSpan" id="kobo.439.1">ning properly.</span></span></p>
<h3><span class="koboSpan" id="kobo.440.1">Understanding readiness and liveness</span></h3>
<p><span class="koboSpan" id="kobo.441.1">In the previous sections, we discussed how to implement health checks for ASP.NET Core web API applications. </span><span class="koboSpan" id="kobo.441.2">In the real world, we may need to deploy the applications to a container orchestrator, such as Kubernetes. </span><span class="koboSpan" id="kobo.441.3">Kubernetes is a popular container orchestrator that can manage containerized applications, monitor health statuses, and scale up or down </span><a id="_idIndexMarker1791"/><span class="koboSpan" id="kobo.442.1">based on workload. </span><span class="koboSpan" id="kobo.442.2">Kubernetes uses the term </span><strong class="bold"><span class="koboSpan" id="kobo.443.1">probe</span></strong><span class="koboSpan" id="kobo.444.1">, which is similar to health checks, to monitor the health status of the applications. </span><span class="koboSpan" id="kobo.444.2">While this book does not cover the details of Kubernetes, it will discuss how to implement Kubernetes probes in ASP.NET Core web </span><span class="No-Break"><span class="koboSpan" id="kobo.445.1">API applications.</span></span></p>
<p><span class="koboSpan" id="kobo.446.1">Kubernetes has three types of probes: </span><em class="italic"><span class="koboSpan" id="kobo.447.1">readiness</span></em><span class="koboSpan" id="kobo.448.1">, </span><em class="italic"><span class="koboSpan" id="kobo.449.1">liveness</span></em><span class="koboSpan" id="kobo.450.1">, and </span><em class="italic"><span class="koboSpan" id="kobo.451.1">startup</span></em><span class="koboSpan" id="kobo.452.1">. </span><span class="koboSpan" id="kobo.452.2">Let’s take a </span><span class="No-Break"><span class="koboSpan" id="kobo.453.1">closer look:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.454.1">liveness</span></strong><span class="koboSpan" id="kobo.455.1">: This probe </span><a id="_idIndexMarker1792"/><span class="koboSpan" id="kobo.456.1">indicates whether the application is running correctly. </span><span class="koboSpan" id="kobo.456.2">Kubernetes performs a </span><strong class="source-inline"><span class="koboSpan" id="kobo.457.1">liveness</span></strong><span class="koboSpan" id="kobo.458.1"> probe every few seconds. </span><span class="koboSpan" id="kobo.458.2">If the application does not respond to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.459.1">liveness</span></strong><span class="koboSpan" id="kobo.460.1"> probe for a specified period, the container will be killed and Kubernetes will create a new one to replace it. </span><span class="koboSpan" id="kobo.460.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">liveness</span></strong><span class="koboSpan" id="kobo.462.1"> probe can execute either an HTTP request, a command, or a TCP socket check. </span><span class="koboSpan" id="kobo.462.2">It also supports gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.463.1">health checks.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">readiness</span></strong><span class="koboSpan" id="kobo.465.1">: This </span><a id="_idIndexMarker1793"/><span class="koboSpan" id="kobo.466.1">probe is used to determine whether the application is ready to receive traffic. </span><span class="koboSpan" id="kobo.466.2">Some applications need to perform some initialization tasks before they can receive traffic, such as connecting to the database, loading configuration, checking the dependent services, and so on. </span><span class="koboSpan" id="kobo.466.3">During this period, the application cannot receive traffic, but this does not mean that the application is unhealthy. </span><span class="koboSpan" id="kobo.466.4">Kubernetes should not kill the application and restart it. </span><span class="koboSpan" id="kobo.466.5">After the initialization is complete and all dependent services are healthy, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.467.1">readiness</span></strong><span class="koboSpan" id="kobo.468.1"> probe will inform Kubernetes that the application is ready to </span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">receive traffic.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.470.1">startup</span></strong><span class="koboSpan" id="kobo.471.1">: This</span><a id="_idIndexMarker1794"/><span class="koboSpan" id="kobo.472.1"> probe is similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">readiness</span></strong><span class="koboSpan" id="kobo.474.1"> probe. </span><span class="koboSpan" id="kobo.474.2">However, the difference is that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">startup</span></strong><span class="koboSpan" id="kobo.476.1"> probe is only executed once the application starts. </span><span class="koboSpan" id="kobo.476.2">It is used to determine whether the application has completed the initialization process. </span><span class="koboSpan" id="kobo.476.3">If this probe is configured, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">liveness</span></strong><span class="koboSpan" id="kobo.478.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">readiness</span></strong><span class="koboSpan" id="kobo.480.1"> probes will not be executed until the </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">startup</span></strong><span class="koboSpan" id="kobo.482.1"> probe </span><span class="No-Break"><span class="koboSpan" id="kobo.483.1">is successful.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.484.1">Configuring the probes incorrectly may cause cascading failures. </span><span class="koboSpan" id="kobo.484.2">For example, service A depends on service B and service B depends on service C. </span><span class="koboSpan" id="kobo.484.3">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">liveness</span></strong><span class="koboSpan" id="kobo.486.1"> probes are misconfigured incorrectly to check the dependent services when service C is unhealthy, service A and service B will be restarted, which does not solve the problem. </span><span class="koboSpan" id="kobo.486.2">This is a cascading failure. </span><span class="koboSpan" id="kobo.486.3">In this case, service A and service B should not be restarted. </span><span class="koboSpan" id="kobo.486.4">Instead, only service C should </span><span class="No-Break"><span class="koboSpan" id="kobo.487.1">be restarted.</span></span></p>
<p><span class="koboSpan" id="kobo.488.1">Here’s an </span><a id="_idIndexMarker1795"/><span class="koboSpan" id="kobo.489.1">example of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.490.1">liveness</span></strong><span class="koboSpan" id="kobo.491.1"> HTTP probe configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">for Kubernetes:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.493.1">
livenessProbe:  httpGet:
    path: /liveness
    port: 8080
    httpHeaders:
    - name: Custom-Header
      value: X-Health-Check
  initialDelaySeconds: 3
  periodSeconds: 5
  timeoutSeconds: 1
  successThreshold: 1
  failureThreshold: 3</span></pre>
<p><span class="koboSpan" id="kobo.494.1">In the configuration, we</span><a id="_idIndexMarker1796"/><span class="koboSpan" id="kobo.495.1"> define the </span><span class="No-Break"><span class="koboSpan" id="kobo.496.1">following properties:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.497.1">path</span></strong><span class="koboSpan" id="kobo.498.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.499.1">port</span></strong><span class="koboSpan" id="kobo.500.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.501.1">httpHeaders</span></strong><span class="koboSpan" id="kobo.502.1">: These properties are used to configure the HTTP request. </span><span class="koboSpan" id="kobo.502.2">In the preceding example, we specify a custom HTTP header called </span><strong class="source-inline"><span class="koboSpan" id="kobo.503.1">Custom-Header</span></strong><span class="koboSpan" id="kobo.504.1"> with a value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.505.1">X-Health-Check</span></strong><span class="koboSpan" id="kobo.506.1">. </span><span class="koboSpan" id="kobo.506.2">The application can use this HTTP header to identify whether the request is a health check request. </span><span class="koboSpan" id="kobo.506.3">If the request does not have this HTTP header, the application can deny </span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">the request.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.508.1">initialDelaySeconds</span></strong><span class="koboSpan" id="kobo.509.1">: This property is used to specify the number of seconds after the container has started before the first probe is executed. </span><span class="koboSpan" id="kobo.509.2">The default value is 0. </span><span class="koboSpan" id="kobo.509.3">Do not use a high value for this property. </span><span class="koboSpan" id="kobo.509.4">You can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">startup</span></strong><span class="koboSpan" id="kobo.511.1"> probe to check the initialization of the </span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">application instead.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.513.1">periodSeconds</span></strong><span class="koboSpan" id="kobo.514.1">: This property is used to specify the number of seconds between each probe. </span><span class="koboSpan" id="kobo.514.2">The default value is 10. </span><span class="koboSpan" id="kobo.514.3">The minimum value is 1. </span><span class="koboSpan" id="kobo.514.4">You can adjust this value based on your scenarios. </span><span class="koboSpan" id="kobo.514.5">Make sure Kubernetes can discover the unhealthy container as soon </span><span class="No-Break"><span class="koboSpan" id="kobo.515.1">as possible.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.516.1">timeoutSeconds</span></strong><span class="koboSpan" id="kobo.517.1">: This property is used to specify the number of seconds after which the probe times out. </span><span class="koboSpan" id="kobo.517.2">The default value is 1 and the minimum value is also 1. </span><span class="koboSpan" id="kobo.517.3">Make sure the probe </span><span class="No-Break"><span class="koboSpan" id="kobo.518.1">is fast.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.519.1">successThreshold</span></strong><span class="koboSpan" id="kobo.520.1">: This property is used to determine the number of consecutive successful responses required for a probe to be considered successful after having previously failed. </span><span class="koboSpan" id="kobo.520.2">The value must be 1 for </span><span class="No-Break"><span class="koboSpan" id="kobo.521.1">liveness probes.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.522.1">failureThreshold</span></strong><span class="koboSpan" id="kobo.523.1">: This property is used to specify the number of consecutive failures for the probe to be considered failed after having succeeded. </span><span class="koboSpan" id="kobo.523.2">Do not use a high value for this property; otherwise, Kubernetes needs to wait a long time to restart </span><span class="No-Break"><span class="koboSpan" id="kobo.524.1">the container.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.525.1">Keep in mind </span><a id="_idIndexMarker1797"/><span class="koboSpan" id="kobo.526.1">that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">liveness</span></strong><span class="koboSpan" id="kobo.528.1"> probe should not depend on other services. </span><span class="koboSpan" id="kobo.528.2">In other words, do not check the health status of other services in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">liveness</span></strong><span class="koboSpan" id="kobo.530.1"> probe. </span><span class="koboSpan" id="kobo.530.2">Instead, this probe should only check whether the application can respond to </span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">the request.</span></span></p>
<p><span class="koboSpan" id="kobo.532.1">An example</span><a id="_idIndexMarker1798"/><span class="koboSpan" id="kobo.533.1"> of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.534.1">readiness</span></strong><span class="koboSpan" id="kobo.535.1"> HTTP probe’s configuration is </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.537.1">
readinessProbe:  httpGet:
    path: /readiness
    port: 8080
    httpHeaders:
    - name: Custom-Header
      value: X-Health-Check
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 1
  successThreshold: 3
  failureThreshold: 2</span></pre>
<p><span class="koboSpan" id="kobo.538.1">There are a few different considerations for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">readiness</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.540.1"> probe:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">successThreshold</span></strong><span class="koboSpan" id="kobo.542.1">: The default value is 1. </span><span class="koboSpan" id="kobo.542.2">However, we can increase this value to make sure the application is ready to </span><span class="No-Break"><span class="koboSpan" id="kobo.543.1">receive traffic.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.544.1">failureThreshold</span></strong><span class="koboSpan" id="kobo.545.1">: After at least </span><strong class="source-inline"><span class="koboSpan" id="kobo.546.1">failureThreshold</span></strong><span class="koboSpan" id="kobo.547.1"> probes have failed, Kubernetes will stop sending traffic to the container. </span><span class="koboSpan" id="kobo.547.2">As the application may have temporary problems, we can allow a few failures before the application is </span><a id="_idIndexMarker1799"/><span class="koboSpan" id="kobo.548.1">considered unhealthy. </span><span class="koboSpan" id="kobo.548.2">However, do not use a high value for </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">this property.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.550.1">If the application takes a long time to initialize, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.551.1">startup</span></strong><span class="koboSpan" id="kobo.552.1"> probe to check the initialization of the application. </span><span class="koboSpan" id="kobo.552.2">An example of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.553.1">startup</span></strong><span class="koboSpan" id="kobo.554.1"> HTTP probe configuration</span><a id="_idIndexMarker1800"/><span class="koboSpan" id="kobo.555.1"> is </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.557.1">
startupProbe:  httpGet:
    path: /startup
    port: 8080
    httpHeaders:
    - name: Custom-Header
      value: X-Health-Check
  periodSeconds: 5
  timeoutSeconds: 1
  successThreshold: 1
  failureThreshold: 30</span></pre>
<p><span class="koboSpan" id="kobo.558.1">In this configuration, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.559.1">startup</span></strong><span class="koboSpan" id="kobo.560.1"> probe will be executed every 5 seconds, and the application will have a maximum of 150 seconds (5 * 30 = 150 seconds) to complete the initialization. </span><strong class="source-inline"><span class="koboSpan" id="kobo.561.1">successThreshold</span></strong><span class="koboSpan" id="kobo.562.1"> must be 1 so that once the </span><strong class="source-inline"><span class="koboSpan" id="kobo.563.1">startup</span></strong><span class="koboSpan" id="kobo.564.1"> probe is successful, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">liveness</span></strong><span class="koboSpan" id="kobo.566.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">readiness</span></strong><span class="koboSpan" id="kobo.568.1"> probes will be executed. </span><span class="koboSpan" id="kobo.568.2">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">startup</span></strong><span class="koboSpan" id="kobo.570.1"> probe fails after 150 seconds (about 2 and a half minutes), Kubernetes will kill the container and start a new one. </span><span class="koboSpan" id="kobo.570.2">So, ensure that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.571.1">startup</span></strong><span class="koboSpan" id="kobo.572.1"> probe has enough time to complete </span><span class="No-Break"><span class="koboSpan" id="kobo.573.1">the initialization.</span></span></p>
<p><span class="koboSpan" id="kobo.574.1">Configuring Kubernetes probes is not a simple task. </span><span class="koboSpan" id="kobo.574.2">We need to consider many factors. </span><span class="koboSpan" id="kobo.574.3">For example, should we check the dependent services in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">readiness</span></strong><span class="koboSpan" id="kobo.576.1"> probe? </span><span class="koboSpan" id="kobo.576.2">If the application can partially operate without a specific dependent service, it can be considered as </span><a id="_idIndexMarker1801"/><span class="koboSpan" id="kobo.577.1">degraded instead of unhealthy. </span><span class="koboSpan" id="kobo.577.2">In this case, if the application has mechanisms to handle transient failures gracefully, it might be acceptable to omit specific dependent services in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">readiness</span></strong><span class="koboSpan" id="kobo.579.1"> probe. </span><span class="koboSpan" id="kobo.579.2">So, please consider your scenarios carefully; you may need a compromise when configuring </span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">the probes.</span></span></p>
<p><span class="koboSpan" id="kobo.581.1">This section is not intended to cover all the details of Kubernetes probes. </span><span class="koboSpan" id="kobo.581.2">For more details, please refer to the following </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">official documentation:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.583.1">Kubernetes </span><span class="No-Break"><span class="koboSpan" id="kobo.584.1">documentation: </span></span><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/"><span class="No-Break"><span class="koboSpan" id="kobo.585.1">https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.586.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.587.1">Health checks in ASP.NET </span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">Core: </span></span><a href="https://learn.microsoft.com/en-us/aspnet/core/host-﻿and-deploy/health-checks"><span class="No-Break"><span class="koboSpan" id="kobo.589.1">https://learn.microsoft.com/en-us/aspnet/core/host-</span><span id="_idTextAnchor686"/><span class="koboSpan" id="kobo.590.1">and-deploy/health-checks</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.591.1">.</span></span></li>
</ul>
<h1 id="_idParaDest-360"><a id="_idTextAnchor687"/><span class="koboSpan" id="kobo.592.1">Monitoring and observability</span></h1>
<p><span class="koboSpan" id="kobo.593.1">In the real world, building </span><a id="_idIndexMarker1802"/><span class="koboSpan" id="kobo.594.1">an application is just the first step. </span><span class="koboSpan" id="kobo.594.2">We also need to monitor and observe how the application is performing. </span><span class="koboSpan" id="kobo.594.3">This is where the concept of </span><em class="italic"><span class="koboSpan" id="kobo.595.1">observability</span></em><span class="koboSpan" id="kobo.596.1"> comes in. </span><span class="koboSpan" id="kobo.596.2">In this section, we will discuss observability and how to use OpenTelemetry to monitor</span><a id="_idTextAnchor688"/><span class="koboSpan" id="kobo.597.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">observe applications.</span></span></p>
<h2 id="_idParaDest-361"><a id="_idTextAnchor689"/><span class="koboSpan" id="kobo.599.1">What is observability?</span></h2>
<p><span class="koboSpan" id="kobo.600.1">In </span><a href="B18971_04.xhtml#_idTextAnchor170"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.601.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.602.1">, we introduced</span><a id="_idIndexMarker1803"/><span class="koboSpan" id="kobo.603.1"> logging in ASP.NET Core web API applications. </span><span class="koboSpan" id="kobo.603.2">We learned how to use the built-in logging framework to log messages to different logging providers. </span><strong class="bold"><span class="koboSpan" id="kobo.604.1">Observability</span></strong><span class="koboSpan" id="kobo.605.1"> is a more comprehensive concept than logging. </span><span class="koboSpan" id="kobo.605.2">Besides logging, observability allows us to gain a deeper understanding of how the application is performing. </span><span class="koboSpan" id="kobo.605.3">For instance, we can determine how many requests are processed in a given hour, what the request latency is, and how requests are handled by multiple services in a microservice architecture. </span><span class="koboSpan" id="kobo.605.4">All of these are part </span><span class="No-Break"><span class="koboSpan" id="kobo.606.1">of observability.</span></span></p>
<p><span class="koboSpan" id="kobo.607.1">In general, observability has </span><span class="No-Break"><span class="koboSpan" id="kobo.608.1">three pillars:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.609.1">Logs</span></strong><span class="koboSpan" id="kobo.610.1">: Logs</span><a id="_idIndexMarker1804"/><span class="koboSpan" id="kobo.611.1"> are used to record what is happening within the application, such as incoming requests, outgoing responses, important business logic executions, exceptions, errors, warnings, and </span><span class="No-Break"><span class="koboSpan" id="kobo.612.1">so on.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.613.1">Metrics</span></strong><span class="koboSpan" id="kobo.614.1">: Metrics</span><a id="_idIndexMarker1805"/><span class="koboSpan" id="kobo.615.1"> are used to measure the performance of the application, such as the number of requests, the request latency, error rates, resource usage, and so on. </span><span class="koboSpan" id="kobo.615.2">These metrics can be used to trigger alerts when the application is not </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">performing well.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.617.1">Traces</span></strong><span class="koboSpan" id="kobo.618.1">: Traces </span><a id="_idIndexMarker1806"/><span class="koboSpan" id="kobo.619.1">are used to track the flow of requests across multiple services to identify where the time is spent or where the errors occur. </span><span class="koboSpan" id="kobo.619.2">This is especially useful in the </span><span class="No-Break"><span class="koboSpan" id="kobo.620.1">microservice architecture.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.621.1">To summarize, observability is the practice of understanding the application’s internal state and operational characteristics by analyzing its logs, metrics, and traces. </span><span class="koboSpan" id="kobo.621.2">There are a few different ways to implement observability in ASP.NET Core web API applications – we can update the source code to add logging, metrics, and traces or use tools to monitor and observe the application without changing the code. </span><span class="koboSpan" id="kobo.621.3">In this section, we will discuss the first approach by using OpenTelemetry to implement observability in ASP.NET Core web API applications. </span><span class="koboSpan" id="kobo.621.4">This gives us more flexibility to custo</span><a id="_idTextAnchor690"/><span class="koboSpan" id="kobo.622.1">mize the </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">observability aspect.</span></span></p>
<h3><span class="koboSpan" id="kobo.624.1">Using OpenTelemetry to collect observability data</span></h3>
<p><span class="koboSpan" id="kobo.625.1">OpenTelemetry</span><a id="_idIndexMarker1807"/><span class="koboSpan" id="kobo.626.1"> is a </span><a id="_idIndexMarker1808"/><span class="koboSpan" id="kobo.627.1">popular cross-platform, open-source standard for collecting observability data. </span><span class="koboSpan" id="kobo.627.2">It provides a set of APIs, SDKs, and tools to instrument, generate, collect, and export </span><a id="_idIndexMarker1809"/><span class="koboSpan" id="kobo.628.1">telemetry data so that we can analyze the application’s performance and behavior. </span><span class="koboSpan" id="kobo.628.2">It supports many platforms and languages, as well as popular cloud providers. </span><span class="koboSpan" id="kobo.628.3">You can find more details </span><a id="_idIndexMarker1810"/><span class="koboSpan" id="kobo.629.1">about OpenTelemetry </span><span class="No-Break"><span class="koboSpan" id="kobo.630.1">at </span></span><a href="https://opentelemetry.io/"><span class="No-Break"><span class="koboSpan" id="kobo.631.1">https://opentelemetry.io/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.632.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.633.1">The .NET OpenTelemetry implementation consists of the </span><span class="No-Break"><span class="koboSpan" id="kobo.634.1">following components:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.635.1">Core API</span></strong><span class="koboSpan" id="kobo.636.1">: The</span><a id="_idIndexMarker1811"/><span class="koboSpan" id="kobo.637.1"> core API is a set of interfaces and classes that define the OpenTelemetry API. </span><span class="koboSpan" id="kobo.637.2">It is a platform-independent API that can be used to instrument </span><span class="No-Break"><span class="koboSpan" id="kobo.638.1">the application.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.639.1">Instrumentation</span></strong><span class="koboSpan" id="kobo.640.1">: This is a </span><a id="_idIndexMarker1812"/><span class="koboSpan" id="kobo.641.1">set of libraries that can be used to collect instrumentation from the application. </span><span class="koboSpan" id="kobo.641.2">This component includes multiple packages for different frameworks and platforms, such as ASP.NET Core, gRPC, HTTP calls, SQL database operations, and </span><span class="No-Break"><span class="koboSpan" id="kobo.642.1">so on.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.643.1">Exporters</span></strong><span class="koboSpan" id="kobo.644.1">: Exporters are </span><a id="_idIndexMarker1813"/><span class="koboSpan" id="kobo.645.1">used to export the collected telemetry data to different targets, such as console and </span><strong class="bold"><span class="koboSpan" id="kobo.646.1">Application Performance Monitoring</span></strong><span class="koboSpan" id="kobo.647.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.648.1">APM</span></strong><span class="koboSpan" id="kobo.649.1">) systems, including Prometheus, Zipkin, and </span><span class="No-Break"><span class="koboSpan" id="kobo.650.1">so on.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.651.1">In </span><a href="B18971_04.xhtml#_idTextAnchor170"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.652.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.653.1">, we</span><a id="_idIndexMarker1814"/><span class="koboSpan" id="kobo.654.1"> introduced using </span><em class="italic"><span class="koboSpan" id="kobo.655.1">Serilog</span></em><span class="koboSpan" id="kobo.656.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.657.1">Seq</span></em><span class="koboSpan" id="kobo.658.1"> to </span><a id="_idIndexMarker1815"/><span class="koboSpan" id="kobo.659.1">collect logs. </span><span class="koboSpan" id="kobo.659.2">In the next few sections, we will focus on how to use OpenTelemetry to collect metrics and traces. </span><span class="koboSpan" id="kobo.659.3">We will use </span><em class="italic"><span class="koboSpan" id="kobo.660.1">Prometheus</span></em><span class="koboSpan" id="kobo.661.1"> to collect metrics and </span><em class="italic"><span class="koboSpan" id="kobo.662.1">Grafana</span></em><span class="koboSpan" id="kobo.663.1"> to visualize the metrics. </span><span class="koboSpan" id="kobo.663.2">We will also use </span><em class="italic"><span class="koboSpan" id="kobo.664.1">Jaeger</span></em><span class="koboSpan" id="kobo.665.1"> to collect traces. </span><span class="koboSpan" id="kobo.665.2">All these tools are open-source. </span><span class="koboSpan" id="kobo.665.3">In addition, we will explore Azure Application Insights, a pow</span><a id="_idTextAnchor691"/><span class="koboSpan" id="kobo.666.1">erful APM system provided </span><span class="No-Break"><span class="koboSpan" id="kobo.667.1">by Microsoft.</span></span></p>
<h3><span class="koboSpan" id="kobo.668.1">Integrating OpenTelemetry with ASP.NET Core web API applications</span></h3>
<p><span class="koboSpan" id="kobo.669.1">In this section, we</span><a id="_idIndexMarker1816"/><span class="koboSpan" id="kobo.670.1"> will explore how to use metrics in ASP.NET Core web API applications. </span><span class="koboSpan" id="kobo.670.2">In</span><a id="_idIndexMarker1817"/><span class="koboSpan" id="kobo.671.1"> the sample project, we have an </span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">InvoiceController</span></strong><span class="koboSpan" id="kobo.673.1"> class to manage invoices. </span><span class="koboSpan" id="kobo.673.2">We want to know how many requests are executed and the duration of each request. </span><span class="koboSpan" id="kobo.673.3">We have several steps </span><span class="No-Break"><span class="koboSpan" id="kobo.674.1">to perform:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.675.1">Define the metrics for </span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">these activities.</span></span></li>
<li><span class="koboSpan" id="kobo.677.1">Generate and collect </span><span class="No-Break"><span class="koboSpan" id="kobo.678.1">instrumentation data.</span></span></li>
<li><span class="koboSpan" id="kobo.679.1">Visualize the data in </span><span class="No-Break"><span class="koboSpan" id="kobo.680.1">a dashboard.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.681.1">To start, we need to install some NuGet packages using the </span><span class="No-Break"><span class="koboSpan" id="kobo.682.1">following commands:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.683.1">
dotnet add package OpenTelemetry.Instrumentation.AspNetCore --prereleasedotnet add package OpenTelemetry.Instrumentation.Http --prerelease
dotnet add package OpenTelemetry.Exporter.OpenTelemetryProtocol
dotnet add package OpenTelemetry.Exporter.Console
dotnet add package OpenTelemetry.Extensions.Hosting</span></pre>
<p><span class="koboSpan" id="kobo.684.1">These </span><a id="_idIndexMarker1818"/><span class="koboSpan" id="kobo.685.1">packages include the required .NET OpenTelemetry implementations. </span><span class="koboSpan" id="kobo.685.2">Note that at the time of writing, some packages did not have stable versions available, so we needed to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.686.1">--prerelease</span></strong><span class="koboSpan" id="kobo.687.1"> option to install the latest preview versions. </span><span class="koboSpan" id="kobo.687.2">If you are reading this book when the stable versions are available, you can omit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.688.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">prerelease</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.690.1"> option.</span></span></p>
<p><span class="koboSpan" id="kobo.691.1">Next, we </span><a id="_idIndexMarker1819"/><span class="koboSpan" id="kobo.692.1">must define the metrics. </span><span class="koboSpan" id="kobo.692.2">In this example, we want to know how many requests are executed for each action for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.693.1">/api/Invoices</span></strong><span class="koboSpan" id="kobo.694.1"> endpoint. </span><span class="koboSpan" id="kobo.694.2">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.695.1">InvoiceMetrics</span></strong><span class="koboSpan" id="kobo.696.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.697.1">\OpenTelemetry\Metrics</span></strong><span class="koboSpan" id="kobo.698.1"> folder. </span><span class="koboSpan" id="kobo.698.2">The following code shows how to define </span><span class="No-Break"><span class="koboSpan" id="kobo.699.1">the metrics:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.700.1">
public class InvoiceMetrics{
    private readonly Counter&lt;long&gt; _invoiceCreateCounter;
    private readonly Counter&lt;long&gt; _invoiceReadCounter;
    private readonly Counter&lt;long&gt; _invoiceUpdateCounter;
    private readonly Counter&lt;long&gt; _invoiceDeleteCounter;
    public InvoiceMetrics(ImeterFactory meterFactory)
    {
        var meter = meterFactory.Create("MyWebApiDemo.Invoice");
        _invoiceCreateCounter = meter.CreateCounter&lt;long&gt;("mywebapidemo.invoices.created");
        _invoiceReadCounter = meter.CreateCounter&lt;long&gt;("mywebapidemo.invoices.read");
        _invoiceUpdateCounter = meter.CreateCounter&lt;long&gt;("mywebapidemo.invoices.updated");
        _invoiceDeleteCounter = meter.CreateCounter&lt;long&gt;("mywebapidemo.invoices.deleted");
    }
    public void IncrementCreate()
    {
        _invoiceCreateCounter.Add(1);
    }
    public void IncrementRead()
    {
        _invoiceReadCounter.Add(1);
    }
    // Omitted other methods for brevity
}</span></pre>
<p><span class="koboSpan" id="kobo.701.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.702.1">IMeterFactory</span></strong><span class="koboSpan" id="kobo.703.1"> interface</span><a id="_idIndexMarker1820"/><span class="koboSpan" id="kobo.704.1"> is registered in ASP.NET Core’s DI</span><a id="_idIndexMarker1821"/><span class="koboSpan" id="kobo.705.1"> container by default and is used to create a meter. </span><span class="koboSpan" id="kobo.705.2">This meter, which is called </span><strong class="source-inline"><span class="koboSpan" id="kobo.706.1">MyWebApiDemo.Invoice</span></strong><span class="koboSpan" id="kobo.707.1">, is used to record the metrics. </span><span class="koboSpan" id="kobo.707.2">Additionally, four counters are created to record the number of requests for each action. </span><span class="koboSpan" id="kobo.707.3">To facilitate this, four public methods are exposed to increment </span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">the counters.</span></span></p>
<p><span class="koboSpan" id="kobo.709.1">The name of each metric must be unique. </span><span class="koboSpan" id="kobo.709.2">When we create a metric or a counter, it is recommended to follow the OpenTelemetry naming </span><span class="No-Break"><span class="koboSpan" id="kobo.710.1">guidelines: </span></span><a href="https://github.com/open-telemetry/semantic-conventions/blob/main/docs/general/metrics.md#general-guidelines"><span class="No-Break"><span class="koboSpan" id="kobo.711.1">https://github.com/open-telemetry/semantic-conventions/blob/main/docs/general/metrics.md#general-guidelines</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.712.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.713.1">Next, we need to register the metrics in the application. </span><span class="koboSpan" id="kobo.713.2">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.714.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.715.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.716.1">
builder.Services.AddOpenTelemetry()    .ConfigureResource(config =&gt;
    {
        config.AddService(nameof(MyWebApiDemo));
    })
    .WithMetrics(b =&gt;
    {
        b.AddConsoleExporter();
        b.AddAspNetCoreInstrumentation();
        b.AddMeter("Microsoft.AspNetCore.Hosting",
            "Microsoft.AspNetCore.Server.Kestrel",
            "MyWebApiDemo.Invoice");
    });
builder.Services.AddSingleton&lt;InvoiceMetrics&gt;();</span></pre>
<p><span class="koboSpan" id="kobo.717.1">In the</span><a id="_idIndexMarker1822"/><span class="koboSpan" id="kobo.718.1"> preceding code, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.719.1">AddOpenTelemetry()</span></strong><span class="koboSpan" id="kobo.720.1"> method to register the </span><a id="_idIndexMarker1823"/><span class="koboSpan" id="kobo.721.1">OpenTelemetry services. </span><span class="koboSpan" id="kobo.721.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.722.1">ConfigureResource()</span></strong><span class="koboSpan" id="kobo.723.1"> method registers the service name. </span><span class="koboSpan" id="kobo.723.2">Inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.724.1">WithMetrics()</span></strong><span class="koboSpan" id="kobo.725.1"> method, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">AddConsoleExporter()</span></strong><span class="koboSpan" id="kobo.727.1"> method to add a console exporter. </span><span class="koboSpan" id="kobo.727.2">This console exporter is useful for local development and debugging. </span><span class="koboSpan" id="kobo.727.3">We also added three meters, including the ASP.NET Core hosting and Kestrel server, so that we can collect the metrics from the ASP.NET Core web API framework. </span><span class="koboSpan" id="kobo.727.4">Finally, we registered the </span><strong class="source-inline"><span class="koboSpan" id="kobo.728.1">InvoiceMetrics</span></strong><span class="koboSpan" id="kobo.729.1"> class in the dependency injection container as </span><span class="No-Break"><span class="koboSpan" id="kobo.730.1">a singleton.</span></span></p>
<p><span class="koboSpan" id="kobo.731.1">Next, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.732.1">InvoiceMetrics</span></strong><span class="koboSpan" id="kobo.733.1"> class to record the metrics. </span><span class="koboSpan" id="kobo.733.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.734.1">InvoiceController</span></strong><span class="koboSpan" id="kobo.735.1"> class and call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.736.1">IncrementCreate()</span></strong><span class="koboSpan" id="kobo.737.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.738.1">Post</span></strong><span class="koboSpan" id="kobo.739.1"> action, </span><span class="No-Break"><span class="koboSpan" id="kobo.740.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.741.1">
[HttpPost]public async Task&lt;ActionResult&lt;Invoice&gt;&gt; Post(Invoice invoice)
{
    // Omitted for brevity
    await dbContext.SaveChangesAsync();
    // Instrumentation
    _invoiceMetrics.IncrementCreate();
    return CreatedAtAction(nameof(Get), new { id = invoice.Id }, invoice);
}</span></pre>
<p><span class="koboSpan" id="kobo.742.1">The </span><a id="_idIndexMarker1824"/><span class="koboSpan" id="kobo.743.1">other </span><a id="_idIndexMarker1825"/><span class="koboSpan" id="kobo.744.1">actions are similar. </span><span class="koboSpan" id="kobo.744.2">Before we check the metrics in the console, we need to install </span><a id="_idIndexMarker1826"/><span class="koboSpan" id="kobo.745.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.746.1">dotnet-counters</span></strong><span class="koboSpan" id="kobo.747.1"> tool, a command-line tool for viewing live metrics. </span><span class="koboSpan" id="kobo.747.2">Run the following command in the terminal to install </span><span class="No-Break"><span class="koboSpan" id="kobo.748.1">the tool:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.749.1">
dotnet tool install --global dotnet-counters</span></pre> <p><span class="koboSpan" id="kobo.750.1">Then, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.751.1">dotnet counters</span></strong><span class="koboSpan" id="kobo.752.1"> command to view the metrics. </span><span class="koboSpan" id="kobo.752.2">We can check the metrics from </span><strong class="source-inline"><span class="koboSpan" id="kobo.753.1">Microsoft.AspNetCore.Hosting</span></strong><span class="koboSpan" id="kobo.754.1"> using the </span><span class="No-Break"><span class="koboSpan" id="kobo.755.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.756.1">
dotnet-counters monitor -n MyWebApiDemo --counters Microsoft.AspNetCore.Hosting</span></pre> <p><span class="koboSpan" id="kobo.757.1">Run the application and send some requests to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">/api/Invoices</span></strong><span class="koboSpan" id="kobo.759.1"> endpoint. </span><span class="koboSpan" id="kobo.759.2">You will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.760.1">following metrics:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.761.1">
Press p to pause, r to resume, q to quit.    Status: Running
[Microsoft.AspNetCore.Hosting]
    http.server.active_requests ({request})
        http.request.method=GET,url.scheme=https                           0
        http.request.method=POST,url.scheme=https                          0
    http.server.request.duration (s)
        http.request.method=GET,http.response.status_code=200,ht           0.006
        http.request.method=GET,http.response.status_code=200,ht           0.006
        http.request.method=GET,http.response.status_code=200,ht           0.006
        http.request.method=POST,http.response.status_code=201,h           0.208
        http.request.method=POST,http.response.status_code=201,h           0.208
        http.request.method=POST,http.response.status_code=201,h           0.208</span></pre>
<p><span class="koboSpan" id="kobo.762.1">Here, you</span><a id="_idIndexMarker1827"/><span class="koboSpan" id="kobo.763.1"> can see the metrics for the HTTP actions, including the active requests and the request </span><a id="_idIndexMarker1828"/><span class="koboSpan" id="kobo.764.1">duration. </span><span class="koboSpan" id="kobo.764.2">You can use this tool to observe more performance metrics, such as CPU usage or the rate of exceptions being thrown in the application. </span><span class="koboSpan" id="kobo.764.3">For more information about this tool, please refer to the official </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">documentation: </span></span><a href="https://learn.microsoft.com/en-us/dotnet/core/diagnostics/dotnet-counters"><span class="No-Break"><span class="koboSpan" id="kobo.766.1">https://learn.microsoft.com/en-us/dotnet/core/diagnostics/dotnet-counters</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.767.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.768.1">To check the custom metrics via </span><strong class="source-inline"><span class="koboSpan" id="kobo.769.1">InvoiceMetrics</span></strong><span class="koboSpan" id="kobo.770.1">, you need to specify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.771.1">--counters</span></strong><span class="koboSpan" id="kobo.772.1"> option in the command, </span><span class="No-Break"><span class="koboSpan" id="kobo.773.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.774.1">
dotnet-counters monitor -n MyWebApiDemo --counters MyWebApiDemo.Invoice</span></pre> <p><span class="koboSpan" id="kobo.775.1">The output may look </span><span class="No-Break"><span class="koboSpan" id="kobo.776.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.777.1">
Press p to pause, r to resume, q to quit.    Status: Running
[MyWebApiDemo.Invoice]
    mywebapidemo.invoices.created (Count / 1 sec)                    0
    mywebapidemo.invoices.read (Count / 1 sec)                       0</span></pre>
<p><span class="koboSpan" id="kobo.778.1">Here, you</span><a id="_idIndexMarker1829"/><span class="koboSpan" id="kobo.779.1"> can</span><a id="_idIndexMarker1830"/><span class="koboSpan" id="kobo.780.1"> see the metrics we defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.781.1">invoiceMetrics</span></strong><span class="koboSpan" id="kobo.782.1"> class. </span><span class="koboSpan" id="kobo.782.2">Note that you can include multiple counters in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">--counters</span></strong><span class="koboSpan" id="kobo.784.1"> option, separated by commas. </span><span class="koboSpan" id="kobo.784.2">For example, you can use the following command to check the metrics for both </span><strong class="source-inline"><span class="koboSpan" id="kobo.785.1">Microsoft.AspNetCore.Hosting</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.786.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.787.1">MyWebApiDemo.Invoice</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.788.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.789.1">
dotnet-counters monitor -n MyWebApiDemo --counters Microsoft.AspNetCore.Hosting,MyWebApiDemo.Invoice</span></pre> <p><span class="koboSpan" id="kobo.790.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.791.1">InvoiceMetrics</span></strong><span class="koboSpan" id="kobo.792.1"> class, we defined four counters. </span><span class="koboSpan" id="kobo.792.2">There are more types of instruments in OpenTelemetry, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.793.1">Gauge</span></strong><span class="koboSpan" id="kobo.794.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.795.1">Histogram</span></strong><span class="koboSpan" id="kobo.796.1">, and others. </span><span class="koboSpan" id="kobo.796.2">Here are some of the different types of instruments that </span><span class="No-Break"><span class="koboSpan" id="kobo.797.1">are available:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.798.1">Counter</span></strong><span class="koboSpan" id="kobo.799.1">: A counter is used to track a value that can only increase over time – for example, the number of requests after the </span><span class="No-Break"><span class="koboSpan" id="kobo.800.1">application starts.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">UpDownCounter</span></strong><span class="koboSpan" id="kobo.802.1">: An up-down counter is similar to a counter, but it can increase or decrease over time. </span><span class="koboSpan" id="kobo.802.2">An example of this is the number of active requests. </span><span class="koboSpan" id="kobo.802.3">When a request starts, the counter increases by 1. </span><span class="koboSpan" id="kobo.802.4">When the request ends, the counter decreases by 1. </span><span class="koboSpan" id="kobo.802.5">It can also be used to monitor the size of </span><span class="No-Break"><span class="koboSpan" id="kobo.803.1">a queue.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.804.1">Gauge</span></strong><span class="koboSpan" id="kobo.805.1">: A gauge measures a current value at a specific point in time, such as CPU usage or </span><span class="No-Break"><span class="koboSpan" id="kobo.806.1">memory usage.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.807.1">Histogram</span></strong><span class="koboSpan" id="kobo.808.1">: A histogram measures the statistical distribution of values using aggregations. </span><span class="koboSpan" id="kobo.808.2">For example, a histogram can measure how many requests are processed longer than a </span><span class="No-Break"><span class="koboSpan" id="kobo.809.1">specific duration.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.810.1">We can </span><a id="_idIndexMarker1831"/><span class="koboSpan" id="kobo.811.1">define more </span><a id="_idIndexMarker1832"/><span class="koboSpan" id="kobo.812.1">metrics to monitor the application. </span><span class="koboSpan" id="kobo.812.2">Define an </span><strong class="source-inline"><span class="koboSpan" id="kobo.813.1">UpDownCounter</span></strong><span class="koboSpan" id="kobo.814.1"> instrument to track how many active requests there are for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.815.1">/api/Invoices</span></strong><span class="koboSpan" id="kobo.816.1"> endpoint. </span><span class="koboSpan" id="kobo.816.2">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.817.1">InvoiceMetrics</span></strong><span class="koboSpan" id="kobo.818.1"> class, </span><span class="No-Break"><span class="koboSpan" id="kobo.819.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.820.1">
private readonly UpDownCounter&lt;long&gt; _invoiceRequestUpDownCounter;public InvoiceMetrics(IMeterFactory meterFactory)
{
    // Omitted for brevity
    _invoiceRequestUpDownCounter = meter.CreateUpDownCounter&lt;long&gt;("mywebapidemo.invoices.requests");
}
public void IncrementRequest()
{
    _invoiceRequestUpDownCounter.Add(1);
}
public void DecrementRequest()
{
    _invoiceRequestUpDownCounter.Add(-1);
}</span></pre>
<p><span class="koboSpan" id="kobo.821.1">Then, update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.822.1">InvoiceController</span></strong><span class="koboSpan" id="kobo.823.1"> class so that it increments and decrements the counter. </span><span class="koboSpan" id="kobo.823.2">For</span><a id="_idIndexMarker1833"/><span class="koboSpan" id="kobo.824.1"> simplicity, we’ll just call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.825.1">IncrementRequest()</span></strong><span class="koboSpan" id="kobo.826.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.827.1">DecrementRequest()</span></strong><span class="koboSpan" id="kobo.828.1"> methods in the controller. </span><span class="koboSpan" id="kobo.828.2">In the real world, it is recommended to use an ASP.NET Core middleware to handle this. </span><span class="koboSpan" id="kobo.828.3">The following code shows how to update the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.829.1">InvoiceController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.830.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.831.1">
[HttpGet("{id}")]public async Task&lt;ActionResult&lt;Invoice&gt;&gt; Get(Guid id)
{
    _invoiceMetrics.IncrementRequest();
    // Omitted for brevity
    _invoiceMetrics.DecrementRequest();
    return Ok(result);
}</span></pre>
<p><span class="koboSpan" id="kobo.832.1">An example</span><a id="_idIndexMarker1834"/><span class="koboSpan" id="kobo.833.1"> of </span><strong class="source-inline"><span class="koboSpan" id="kobo.834.1">Histogram</span></strong><span class="koboSpan" id="kobo.835.1"> is </span><span class="No-Break"><span class="koboSpan" id="kobo.836.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.837.1">
private readonly Histogram&lt;double&gt; _invoiceRequestDurationHistogram;public InvoiceMetrics(IMeterFactory meterFactory)
{
    // Omitted for brevity
    _invoiceRequestDurationHistogram = meter.CreateHistogram&lt;double&gt;("mywebapidemo.invoices.request_duration");
}
public void RecordRequestDuration(double duration)
{
    _invoiceRequestDurationHistogram.Record(duration);
}</span></pre>
<p><span class="koboSpan" id="kobo.838.1">Then, update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.839.1">InvoiceController</span></strong><span class="koboSpan" id="kobo.840.1"> class so that it records the request’s duration. </span><span class="koboSpan" id="kobo.840.2">Similarly, we </span><a id="_idIndexMarker1835"/><span class="koboSpan" id="kobo.841.1">can just use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.842.1">RecordRequestDuration()</span></strong><span class="koboSpan" id="kobo.843.1"> method in the controller. </span><span class="koboSpan" id="kobo.843.2">The following code shows how to update the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.844.1">InvoiceController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.845.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.846.1">
[HttpGet("{id}")]public async Task&lt;ActionResult&lt;Invoice&gt;&gt; Get(Guid id)
{
    var stopwatch = Stopwatch.StartNew();
    // Omitted for brevity
    // Simulate a latency
    await Task.Delay(_random.Next(0, 500));
    // Omitted for brevity
    stopwatch.Stop();
    _invoiceMetrics.RecordRequestDuration(stopwatch.Elapsed.TotalMilliseconds);
    return Ok(result);
}</span></pre>
<p><span class="koboSpan" id="kobo.847.1">Here, we </span><a id="_idIndexMarker1836"/><span class="koboSpan" id="kobo.848.1">use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.849.1">Task.Delay()</span></strong><span class="koboSpan" id="kobo.850.1"> method to simulate latency. </span><span class="koboSpan" id="kobo.850.2">Run the application and send some requests to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.851.1">/api/Invoices</span></strong><span class="koboSpan" id="kobo.852.1"> endpoint. </span><span class="koboSpan" id="kobo.852.2">Then, check the metrics using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.853.1">dotnet-counters</span></strong><span class="koboSpan" id="kobo.854.1"> tool. </span><span class="koboSpan" id="kobo.854.2">You will see the metrics, </span><span class="No-Break"><span class="koboSpan" id="kobo.855.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.856.1">
Press p to pause, r to resume, q to quit.    Status: Running
[Microsoft.AspNetCore.Hosting]
    http.server.active_requests ({request})
        http.request.method=GET,url.scheme=https                           0
        http.request.method=POST,url.scheme=https                          0
    http.server.request.duration (s)
        http.request.method=GET,http.response.status_code=200,ht           0.075
        http.request.method=GET,http.response.status_code=200,ht           0.24
        http.request.method=GET,http.response.status_code=200,ht           0.24
        http.request.method=POST,http.response.status_code=201,h           0.06
        http.request.method=POST,http.response.status_code=201,h           0.06
        http.request.method=POST,http.response.status_code=201,h           0.06
[MyWebApiDemo.Invoice]
    mywebapidemo.invoices.created (Count / 1 sec)                          0
    mywebapidemo.invoices.read (Count / 1 sec)                             0
    mywebapidemo.invoices.request_duration
        Percentile=50                                                     74.25
        Percentile=95                                                    239.5
        Percentile=99                                                    239.5
    mywebapidemo.invoices.requests                                         0</span></pre>
<p><span class="koboSpan" id="kobo.857.1">In the </span><a id="_idIndexMarker1837"/><span class="koboSpan" id="kobo.858.1">preceding output, the histogram instruments are shown as </span><strong class="source-inline"><span class="koboSpan" id="kobo.859.1">Percentile=50</span></strong><span class="koboSpan" id="kobo.860.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.861.1">Percentile=95</span></strong><span class="koboSpan" id="kobo.862.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.863.1">Percentile=99</span></strong><span class="koboSpan" id="kobo.864.1">. </span><span class="koboSpan" id="kobo.864.2">This is the default configuration for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.865.1">dotnet-counters</span></strong><span class="koboSpan" id="kobo.866.1"> tool. </span><span class="koboSpan" id="kobo.866.2">We can use other tools, such as Prometheus and Grafana, to provide more vis</span><a id="_idTextAnchor692"/><span class="koboSpan" id="kobo.867.1">ualization</span><a id="_idIndexMarker1838"/><span class="koboSpan" id="kobo.868.1"> options. </span><span class="koboSpan" id="kobo.868.2">We will discuss this in the </span><span class="No-Break"><span class="koboSpan" id="kobo.869.1">next section.</span></span></p>
<h3><span class="koboSpan" id="kobo.870.1">Using Prometheus to collect and query metrics</span></h3>
<p><strong class="bold"><span class="koboSpan" id="kobo.871.1">Prometheus</span></strong><span class="koboSpan" id="kobo.872.1"> is a </span><a id="_idIndexMarker1839"/><span class="koboSpan" id="kobo.873.1">widely used open-source monitoring system. </span><span class="koboSpan" id="kobo.873.2">Prometheus was </span><a id="_idIndexMarker1840"/><span class="koboSpan" id="kobo.874.1">originally developed by SoundCloud (</span><a href="https://soundcloud.com/"><span class="koboSpan" id="kobo.875.1">https://soundcloud.com/</span></a><span class="koboSpan" id="kobo.876.1">), then joined </span><a id="_idIndexMarker1841"/><span class="koboSpan" id="kobo.877.1">the Cloud Native </span><a id="_idIndexMarker1842"/><span class="koboSpan" id="kobo.878.1">Computing Foundation (</span><a href="https://cncf.io/"><span class="koboSpan" id="kobo.879.1">https://cncf.io/</span></a><span class="koboSpan" id="kobo.880.1">) in 2016. </span><span class="koboSpan" id="kobo.880.2">Prometheus is capable of collecting metrics from a variety of sources, including applications, databases, operating systems, and more. </span><span class="koboSpan" id="kobo.880.3">It also offers a powerful query language for querying the collected metrics, as well as a dashboard to </span><span class="No-Break"><span class="koboSpan" id="kobo.881.1">visualize them.</span></span></p>
<p><span class="koboSpan" id="kobo.882.1">In this section, we </span><a id="_idIndexMarker1843"/><span class="koboSpan" id="kobo.883.1">will use Prometheus to collect metrics from the ASP.NET Core web API application and visualize </span><span class="No-Break"><span class="koboSpan" id="kobo.884.1">the metrics.</span></span></p>
<p><span class="koboSpan" id="kobo.885.1">To </span><a id="_idIndexMarker1844"/><span class="koboSpan" id="kobo.886.1">install Prometheus, navigate to the official website: </span><a href="https://prometheus.io/download/"><span class="koboSpan" id="kobo.887.1">https://prometheus.io/download/</span></a><span class="koboSpan" id="kobo.888.1">. </span><span class="koboSpan" id="kobo.888.2">Download the latest version of Prometheus for your </span><span class="No-Break"><span class="koboSpan" id="kobo.889.1">operating system.</span></span></p>
<p><span class="koboSpan" id="kobo.890.1">Next, we need to configure the ASP.NET web API application to export metrics for Prometheus. </span><span class="koboSpan" id="kobo.890.2">Install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.891.1">OpenTelemetry.Exporter.Prometheus.AspNetCore</span></strong><span class="koboSpan" id="kobo.892.1"> package in the ASP.NET Core web API project using the </span><span class="No-Break"><span class="koboSpan" id="kobo.893.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.894.1">
dotnet add package OpenTelemetry.Exporter.Prometheus.AspNetCore --prerelease</span></pre> <p><span class="koboSpan" id="kobo.895.1">Then, register </span><a id="_idIndexMarker1845"/><span class="koboSpan" id="kobo.896.1">the Prometheus</span><a id="_idIndexMarker1846"/><span class="koboSpan" id="kobo.897.1"> exporter in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.898.1">Program.cs</span></strong><span class="koboSpan" id="kobo.899.1"> file, </span><span class="No-Break"><span class="koboSpan" id="kobo.900.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.901.1">
builder.Services.AddOpenTelemetry()    .ConfigureResource(config =&gt;
    {
        config.AddService(nameof(MyWebApiDemo));
    })
    .WithMetrics(metrics =&gt;
    {
        metrics.AddAspNetCoreInstrumentation()
            .AddMeter("Microsoft.AspNetCore.Hosting")
            .AddMeter("Microsoft.AspNetCore.Server.Kestrel")
            .AddMeter("MyWebApiDemo.Invoice")
            .AddConsoleExporter()
            .AddPrometheusExporter();
    });
// Omitted for brevity
// Add the Prometheus scraping endpoint
app.MapPrometheusScrapingEndpoint();</span></pre>
<p><span class="koboSpan" id="kobo.902.1">Now, we have two exporters: the console exporter and the Prometheus exporter. </span><span class="koboSpan" id="kobo.902.2">If you don’t need the console exporter, you can remove it. </span><span class="koboSpan" id="kobo.902.3">We’re also using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.903.1">MapPrometheusScrapingEndpoint()</span></strong><span class="koboSpan" id="kobo.904.1"> method to map the </span><strong class="source-inline"><span class="koboSpan" id="kobo.905.1">/metrics</span></strong><span class="koboSpan" id="kobo.906.1"> endpoint for the Prometheus exporter. </span><span class="koboSpan" id="kobo.906.2">This endpoint is used by Prometheus to scrape metrics from </span><span class="No-Break"><span class="koboSpan" id="kobo.907.1">the application.</span></span></p>
<p><span class="koboSpan" id="kobo.908.1">Next, we need to </span><a id="_idIndexMarker1847"/><span class="koboSpan" id="kobo.909.1">configure Prometheus to collect metrics from the ASP.NET Core web API application. </span><span class="koboSpan" id="kobo.909.2">Find the port number of the ASP.NET Core web API application. </span><span class="koboSpan" id="kobo.909.3">In the sample project, we use port number 5125 for HTTP. </span><span class="koboSpan" id="kobo.909.4">You can find the relevant port numbers in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.910.1">launchSettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.911.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.912.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">prometheus.yml</span></strong><span class="koboSpan" id="kobo.914.1"> file in the Prometheus folder. </span><span class="koboSpan" id="kobo.914.2">Add a job at the end of the file, </span><span class="No-Break"><span class="koboSpan" id="kobo.915.1">as follows:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.916.1">- job_name: 'MyWebApiDemo'</span></strong><strong class="bold"><span class="koboSpan" id="kobo.917.1">  scrape_interval: 5s # Set the scrape interval to 5 seconds so we can see the metrics update immediately.</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.918.1">  static_configs:</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.919.1">    - targets: ['localhost:5125'</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.920.1">]</span></strong></pre>
<p><span class="koboSpan" id="kobo.921.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.922.1">scrape_interval</span></strong><span class="koboSpan" id="kobo.923.1"> property is set to specify the interval at which metrics should be scrapped. </span><span class="koboSpan" id="kobo.923.2">For testing purposes, this can be set to 5 seconds so that you can view metrics</span><a id="_idIndexMarker1848"/><span class="koboSpan" id="kobo.924.1"> immediately. </span><span class="koboSpan" id="kobo.924.2">However, in production scenarios, it is recommended to set this to a higher value, such as 15 seconds. </span><span class="koboSpan" id="kobo.924.3">Additionally, ensure that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.925.1">targets</span></strong><span class="koboSpan" id="kobo.926.1"> property is set to the correct port number before saving </span><span class="No-Break"><span class="koboSpan" id="kobo.927.1">the file.</span></span></p>
<p><span class="koboSpan" id="kobo.928.1">If you use HTTPS for the ASP.NET Core web API application, you need to specify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.929.1">schema</span></strong><span class="koboSpan" id="kobo.930.1"> property, </span><span class="No-Break"><span class="koboSpan" id="kobo.931.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.932.1">
- job_name: 'MyWebApiDemo'  scrape_interval: 5s # Set the scrape interval to 5 seconds so we can see the metrics update immediately.
</span><span class="koboSpan" id="kobo.932.2">  scheme: https
  static_configs:
    - targets: ['localhost:7003']</span></pre>
<p><span class="koboSpan" id="kobo.933.1">Run the application and send some requests to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.934.1">/api/Invoices</span></strong><span class="koboSpan" id="kobo.935.1"> endpoint. </span><span class="koboSpan" id="kobo.935.2">Navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.936.1">/metrics</span></strong><span class="koboSpan" id="kobo.937.1"> endpoint; you will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.938.1">relevant metrics:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer146">
<span class="koboSpan" id="kobo.939.1"><img alt="Figure 16.4 – Metrics for Prometheus" src="image/B18971_16_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.940.1">Figure 16.4 – Metrics for Prometheus</span></p>
<p><span class="koboSpan" id="kobo.941.1">Now, we can</span><a id="_idIndexMarker1849"/><span class="koboSpan" id="kobo.942.1"> run Prometheus by executing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.943.1">prometheus.exe</span></strong><span class="koboSpan" id="kobo.944.1"> file. </span><span class="koboSpan" id="kobo.944.2">In the output, you will find the </span><span class="No-Break"><span class="koboSpan" id="kobo.945.1">following line:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.946.1">
ts=2023-10-14T10:44:55.133Z caller=web.go:566 level=info component=web msg="Start listening for connections" address=0.0.0.0:9090</span></pre> <p><span class="koboSpan" id="kobo.947.1">This means that Prometheus is running on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.948.1">9090</span></strong><span class="koboSpan" id="kobo.949.1">. </span><span class="koboSpan" id="kobo.949.2">Navigate to </span><strong class="source-inline"><span class="koboSpan" id="kobo.950.1">http://localhost:9090</span></strong><span class="koboSpan" id="kobo.951.1">. </span><span class="koboSpan" id="kobo.951.2">You will see the Prometheus dashboard, </span><span class="No-Break"><span class="koboSpan" id="kobo.952.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer147">
<span class="koboSpan" id="kobo.953.1"><img alt="Figure 16.5 – Prometheus dashboard" src="image/B18971_16_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.954.1">Figure 16.5 – Prometheus dashboard</span></p>
<p><span class="koboSpan" id="kobo.955.1">Prometheus </span><a id="_idIndexMarker1850"/><span class="koboSpan" id="kobo.956.1">will start to scrape metrics from the ASP.NET Core web API application we configured in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.957.1">prometheus.yml</span></strong><span class="koboSpan" id="kobo.958.1"> file. </span><span class="koboSpan" id="kobo.958.2">Click </span><strong class="bold"><span class="koboSpan" id="kobo.959.1">Status</span></strong><span class="koboSpan" id="kobo.960.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.961.1">Targets</span></strong><span class="koboSpan" id="kobo.962.1"> at the top. </span><span class="koboSpan" id="kobo.962.2">You will see the following page, which shows the status of the ASP.NET Core web </span><span class="No-Break"><span class="koboSpan" id="kobo.963.1">API application:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer148">
<span class="koboSpan" id="kobo.964.1"><img alt="Figure 16.6 – Prometheus targets" src="image/B18971_16_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.965.1">Figure 16.6 – Prometheus targets</span></p>
<p><span class="koboSpan" id="kobo.966.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.967.1">Graph</span></strong><span class="koboSpan" id="kobo.968.1"> in</span><a id="_idIndexMarker1851"/><span class="koboSpan" id="kobo.969.1"> the top menu. </span><span class="koboSpan" id="kobo.969.2">You will see the following page, which shows the available metrics. </span><span class="koboSpan" id="kobo.969.3">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.970.1">Open Metrics Explorer</span></strong><span class="koboSpan" id="kobo.971.1"> button (highlighted in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.972.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.973.1">.7</span></em><span class="koboSpan" id="kobo.974.1">) to open </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.975.1">Metrics Explorer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.976.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer149">
<span class="koboSpan" id="kobo.977.1"><img alt="Figure 16.7 – Prometheus Metrics Explorer" src="image/B18971_16_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.978.1">Figure 16.7 – Prometheus Metrics Explorer</span></p>
<p><span class="koboSpan" id="kobo.979.1">Choose one </span><a id="_idIndexMarker1852"/><span class="koboSpan" id="kobo.980.1">metric, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.981.1">mywebapidemo_invoices_read_total</span></strong><span class="koboSpan" id="kobo.982.1">, and click the </span><strong class="bold"><span class="koboSpan" id="kobo.983.1">Execute</span></strong><span class="koboSpan" id="kobo.984.1"> button. </span><span class="koboSpan" id="kobo.984.2">Then, click the </span><strong class="bold"><span class="koboSpan" id="kobo.985.1">Graph</span></strong><span class="koboSpan" id="kobo.986.1"> tab; you will see the following page, which shows the </span><span class="No-Break"><span class="koboSpan" id="kobo.987.1">metric graph:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer150">
<span class="koboSpan" id="kobo.988.1"><img alt="Figure 16.8 – Prometheus graph" src="image/B18971_16_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.989.1">Figure 16.8 – Prometheus graph</span></p>
<p><span class="koboSpan" id="kobo.990.1">Prometheus</span><a id="_idIndexMarker1853"/><span class="koboSpan" id="kobo.991.1"> provides a powerful query language to query the metrics. </span><span class="koboSpan" id="kobo.991.2">For example, we can use the following query to get the </span><strong class="source-inline"><span class="koboSpan" id="kobo.992.1">mywebapidemo.invoices.read</span></strong><span class="koboSpan" id="kobo.993.1"> counter </span><span class="No-Break"><span class="koboSpan" id="kobo.994.1">per minute:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.995.1">
rate(mywebapidemo_invoices_read_total[1m])</span></pre> <p><span class="koboSpan" id="kobo.996.1">You will </span><a id="_idIndexMarker1854"/><span class="koboSpan" id="kobo.997.1">see the </span><span class="No-Break"><span class="koboSpan" id="kobo.998.1">following graph:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer151">
<span class="koboSpan" id="kobo.999.1"><img alt="Figure 16.9 – Requests per minute" src="image/B18971_16_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1000.1">Figure 16.9 – Requests per minute</span></p>
<p><span class="koboSpan" id="kobo.1001.1">The</span><a id="_idIndexMarker1855"/><span class="koboSpan" id="kobo.1002.1"> following</span><a id="_idIndexMarker1856"/><span class="koboSpan" id="kobo.1003.1"> query can get the requests that take longer than </span><span class="No-Break"><span class="koboSpan" id="kobo.1004.1">100 milliseconds:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1005.1">
histogram_quantile(0.95, sum(rate(mywebapidemo_invoices_request_duration_bucket[1m])) by (le)) &gt; 100</span></pre> <p><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1006.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1007.1">.10</span></em><span class="koboSpan" id="kobo.1008.1"> shows </span><span class="No-Break"><span class="koboSpan" id="kobo.1009.1">the result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer152">
<span class="koboSpan" id="kobo.1010.1"><img alt="Figure 16.10 – Requests that take longer than 100 milliseconds" src="image/B18971_16_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1011.1">Figure 16.10 – Requests that take longer than 100 milliseconds</span></p>
<p><span class="koboSpan" id="kobo.1012.1">This section</span><a id="_idIndexMarker1857"/><span class="koboSpan" id="kobo.1013.1"> provided a </span><a id="_idIndexMarker1858"/><span class="koboSpan" id="kobo.1014.1">brief introduction to Prometheus. </span><span class="koboSpan" id="kobo.1014.2">For more information about the querying language syntax, please refer to the official </span><span class="No-Break"><span class="koboSpan" id="kobo.1015.1">documentation: </span></span><a href="https://prometheus.io/docs/prometheus/latest/querying/basics/"><span class="No-Break"><span class="koboSpan" id="kobo.1016.1">https://prometheus.io/docs/prometheus/latest/querying/basics/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1017.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1018.1">Prometheus is a powerful tool for collecting and querying metrics. </span><span class="koboSpan" id="kobo.1018.2">To gain better visualization of these metrics, Grafana can be used to create dashboards. </span><span class="koboSpan" id="kobo.1018.3">In the following section, we will explore how to use</span><a id="_idTextAnchor693"/><span class="koboSpan" id="kobo.1019.1"> Grafana to read metrics from Prometheus and create </span><span class="No-Break"><span class="koboSpan" id="kobo.1020.1">informative dashboards.</span></span></p>
<h3><span class="koboSpan" id="kobo.1021.1">Using Grafana to create dashboards</span></h3>
<p><strong class="bold"><span class="koboSpan" id="kobo.1022.1">Grafana</span></strong><span class="koboSpan" id="kobo.1023.1"> is a </span><a id="_idIndexMarker1859"/><span class="koboSpan" id="kobo.1024.1">popular opensource</span><a id="_idIndexMarker1860"/><span class="koboSpan" id="kobo.1025.1"> analytics and dashboarding tool. </span><span class="koboSpan" id="kobo.1025.2">It can visualize metrics from </span><a id="_idIndexMarker1861"/><span class="koboSpan" id="kobo.1026.1">multiple data sources, such as Prometheus, Elasticsearch, Azure Monitor, and others. </span><span class="koboSpan" id="kobo.1026.2">Grafana can create beautiful dashboards to help us understand the application’s performance and behavior. </span><span class="koboSpan" id="kobo.1026.3">In this section, we will use Grafana to create dashboards for the ASP.NET Core web </span><span class="No-Break"><span class="koboSpan" id="kobo.1027.1">API application.</span></span></p>
<p><span class="koboSpan" id="kobo.1028.1">Grafana also provides a managed service </span><a id="_idIndexMarker1862"/><span class="koboSpan" id="kobo.1029.1">called </span><strong class="bold"><span class="koboSpan" id="kobo.1030.1">Grafana Cloud</span></strong><span class="koboSpan" id="kobo.1031.1">. </span><span class="koboSpan" id="kobo.1031.2">The free tier of Grafana Cloud has a limit of 10,000 metrics, 3 users, and 50 GB of logs. </span><span class="koboSpan" id="kobo.1031.3">You can check the pricing here: </span><a href="https://grafana.com/pricing/"><span class="koboSpan" id="kobo.1032.1">https://grafana.com/pricing/</span></a><span class="koboSpan" id="kobo.1033.1">. </span><span class="koboSpan" id="kobo.1033.2">In this book, we will install Grafana locally. </span><span class="koboSpan" id="kobo.1033.3">Download the latest version of Grafana from the official website: </span><a href="https://grafana.com/oss/grafana/"><span class="koboSpan" id="kobo.1034.1">https://grafana.com/oss/grafana/</span></a><span class="koboSpan" id="kobo.1035.1">. </span><span class="koboSpan" id="kobo.1035.2">Then, choose the version for your </span><span class="No-Break"><span class="koboSpan" id="kobo.1036.1">operating system.</span></span></p>
<p><span class="koboSpan" id="kobo.1037.1">Run Grafana by executing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1038.1">grafana-server.exe</span></strong><span class="koboSpan" id="kobo.1039.1"> file if you’re using Windows. </span><span class="koboSpan" id="kobo.1039.2">You may see a Windows Security Alert dialog box. </span><span class="koboSpan" id="kobo.1039.3">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1040.1">Allow</span></strong><span class="koboSpan" id="kobo.1041.1"> button to allow Grafana to communicate on these networks. </span><span class="koboSpan" id="kobo.1041.2">You will find the following line in </span><span class="No-Break"><span class="koboSpan" id="kobo.1042.1">the output:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1043.1">
INFO [10-15|12:31:31] Validated license token                  logger=licensing appURL=http://localhost:3000/ source=disk status=NotFound</span></pre> <p><span class="koboSpan" id="kobo.1044.1">This means that Grafana is running on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.1045.1">3000</span></strong><span class="koboSpan" id="kobo.1046.1">. </span><span class="koboSpan" id="kobo.1046.2">Navigate to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1047.1">http://localhost:3000</span></strong><span class="koboSpan" id="kobo.1048.1">. </span><span class="koboSpan" id="kobo.1048.2">The default username and password are both </span><strong class="source-inline"><span class="koboSpan" id="kobo.1049.1">admin</span></strong><span class="koboSpan" id="kobo.1050.1">. </span><span class="koboSpan" id="kobo.1050.2">Once you’ve logged in, you will be prompted to change </span><span class="No-Break"><span class="koboSpan" id="kobo.1051.1">the password.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1052.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1053.1">The default theme of Grafana is dark. </span><span class="koboSpan" id="kobo.1053.2">If you prefer a light theme, you can change it by going to the </span><strong class="bold"><span class="koboSpan" id="kobo.1054.1">Preferences</span></strong><span class="koboSpan" id="kobo.1055.1"> page. </span><span class="koboSpan" id="kobo.1055.2">We’re using the light theme in this book for </span><span class="No-Break"><span class="koboSpan" id="kobo.1056.1">better readability.</span></span></p>
<p><span class="koboSpan" id="kobo.1057.1">Click </span><a id="_idIndexMarker1863"/><span class="koboSpan" id="kobo.1058.1">the </span><a id="_idIndexMarker1864"/><span class="koboSpan" id="kobo.1059.1">hamburger menu in the top-left corner, and then click </span><strong class="bold"><span class="koboSpan" id="kobo.1060.1">Connections</span></strong><span class="koboSpan" id="kobo.1061.1">. </span><span class="koboSpan" id="kobo.1061.2">This page shows the data sources that </span><span class="No-Break"><span class="koboSpan" id="kobo.1062.1">Grafana supports:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer153">
<span class="koboSpan" id="kobo.1063.1"><img alt="Figure 16.11 – Grafana data sources" src="image/B18971_16_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1064.1">Figure 16.11 – Grafana data sources</span></p>
<p><span class="koboSpan" id="kobo.1065.1">Search for </span><em class="italic"><span class="koboSpan" id="kobo.1066.1">Prometheus</span></em><span class="koboSpan" id="kobo.1067.1"> and click on it. </span><span class="koboSpan" id="kobo.1067.2">Then, click the </span><strong class="bold"><span class="koboSpan" id="kobo.1068.1">Create a Prometheus data source</span></strong><span class="koboSpan" id="kobo.1069.1"> button</span><a id="_idIndexMarker1865"/><span class="koboSpan" id="kobo.1070.1"> in the top-right corner. </span><span class="koboSpan" id="kobo.1070.2">On the </span><strong class="bold"><span class="koboSpan" id="kobo.1071.1">Settings</span></strong><span class="koboSpan" id="kobo.1072.1"> page, we can configure the data source, </span><span class="No-Break"><span class="koboSpan" id="kobo.1073.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer154">
<span class="koboSpan" id="kobo.1074.1"><img alt="Figure 16.12 – Configuring the Prometheus data source" src="image/B18971_16_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1075.1">Figure 16.12 – Configuring the Prometheus data source</span></p>
<p><span class="koboSpan" id="kobo.1076.1">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1077.1">http://localhost:9090</span></strong><span class="koboSpan" id="kobo.1078.1"> as the URL. </span><span class="koboSpan" id="kobo.1078.2">Then, click the </span><strong class="bold"><span class="koboSpan" id="kobo.1079.1">Save &amp; Test</span></strong><span class="koboSpan" id="kobo.1080.1"> button. </span><span class="koboSpan" id="kobo.1080.2">If the data</span><a id="_idIndexMarker1866"/><span class="koboSpan" id="kobo.1081.1"> source has been configured correctly, you will </span><a id="_idIndexMarker1867"/><span class="koboSpan" id="kobo.1082.1">see a message box that states </span><strong class="source-inline"><span class="koboSpan" id="kobo.1083.1">Successfully queried the Prometheus API</span></strong><span class="koboSpan" id="kobo.1084.1">. </span><span class="koboSpan" id="kobo.1084.2">At this point, we can create dashboards to visualize </span><span class="No-Break"><span class="koboSpan" id="kobo.1085.1">the metrics.</span></span></p>
<p><span class="koboSpan" id="kobo.1086.1">Navigate to the </span><strong class="bold"><span class="koboSpan" id="kobo.1087.1">Dashboards</span></strong><span class="koboSpan" id="kobo.1088.1"> page and click the </span><strong class="bold"><span class="koboSpan" id="kobo.1089.1">New</span></strong><span class="koboSpan" id="kobo.1090.1"> button. </span><span class="koboSpan" id="kobo.1090.2">From the drop-down list, click </span><strong class="bold"><span class="koboSpan" id="kobo.1091.1">New Dashboard</span></strong><span class="koboSpan" id="kobo.1092.1">. </span><span class="koboSpan" id="kobo.1092.2">You will be navigated to the new dashboard page. </span><span class="koboSpan" id="kobo.1092.3">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1093.1">Add visualization</span></strong><span class="koboSpan" id="kobo.1094.1"> button, then choose Prometheus as the data source, </span><span class="No-Break"><span class="koboSpan" id="kobo.1095.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer155">
<span class="koboSpan" id="kobo.1096.1"><img alt="Figure 16.13 – Adding a visualization" src="image/B18971_16_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1097.1">Figure 16.13 – Adding a visualization</span></p>
<p><span class="koboSpan" id="kobo.1098.1">Then, we</span><a id="_idIndexMarker1868"/><span class="koboSpan" id="kobo.1099.1"> can use the query language to </span><a id="_idIndexMarker1869"/><span class="koboSpan" id="kobo.1100.1">query the metrics. </span><span class="koboSpan" id="kobo.1100.2">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1101.1">Query</span></strong><span class="koboSpan" id="kobo.1102.1"> tab, you can choose the relevant metrics from the drop-down list. </span><span class="koboSpan" id="kobo.1102.2">You can also filter the metrics by job name. </span><span class="koboSpan" id="kobo.1102.3">For example, we can use the following query to get the number of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1103.1">mywebapidemo.invoices.read</span></strong><span class="koboSpan" id="kobo.1104.1"> requests for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1105.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1106.1">api/Invoices</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1107.1"> endpoint:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer156">
<span class="koboSpan" id="kobo.1108.1"><img alt="Figure 16.14 – Querying the metrics" src="image/B18971_16_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1109.1">Figure 16.14 – Querying the metrics</span></p>
<p><span class="koboSpan" id="kobo.1110.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1111.1">Run queries</span></strong><span class="koboSpan" id="kobo.1112.1"> button; you will see the following output in </span><span class="No-Break"><span class="koboSpan" id="kobo.1113.1">the panel:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer157">
<span class="koboSpan" id="kobo.1114.1"><img alt="Figure 16.15 – Query result" src="image/B18971_16_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1115.1">Figure 16.15 – Query result</span></p>
<p><span class="koboSpan" id="kobo.1116.1">Then, click the </span><strong class="bold"><span class="koboSpan" id="kobo.1117.1">Apply</span></strong><span class="koboSpan" id="kobo.1118.1"> button; you will see the graph in </span><span class="No-Break"><span class="koboSpan" id="kobo.1119.1">the dashboard:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer158">
<span class="koboSpan" id="kobo.1120.1"><img alt="Figure 16.16 – Grafana dashboard" src="image/B18971_16_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1121.1">Figure 16.16 – Grafana dashboard</span></p>
<p><span class="koboSpan" id="kobo.1122.1">You can </span><a id="_idIndexMarker1870"/><span class="koboSpan" id="kobo.1123.1">adjust the size of the dashboard </span><a id="_idIndexMarker1871"/><span class="koboSpan" id="kobo.1124.1">as necessary. </span><span class="koboSpan" id="kobo.1124.2">Feel free to add more dashboard panels to visualize the metrics. </span><span class="koboSpan" id="kobo.1124.3">Before you leave the dashboard, click the </span><strong class="bold"><span class="koboSpan" id="kobo.1125.1">Save</span></strong><span class="koboSpan" id="kobo.1126.1"> button in the top-right corner to save it. </span><span class="koboSpan" id="kobo.1126.2">You can also export the dashboard as a JSON file and import </span><span class="No-Break"><span class="koboSpan" id="kobo.1127.1">it later:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer159">
<span class="koboSpan" id="kobo.1128.1"><img alt="Figure 16.17 – Adding more panels" src="image/B18971_16_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1129.1">Figure 16.17 – Adding more panels</span></p>
<p><span class="koboSpan" id="kobo.1130.1">To simplify </span><a id="_idIndexMarker1872"/><span class="koboSpan" id="kobo.1131.1">the process of creating Grafana </span><a id="_idIndexMarker1873"/><span class="koboSpan" id="kobo.1132.1">dashboards, James Newton-King, the esteemed author of JSON.NET, has provided a Grafana dashboard template for ASP.NET Core web API applications. </span><span class="koboSpan" id="kobo.1132.2">You can find the template here: </span><a href="https://github.com/JamesNK/aspnetcore-grafana/blob/main/README.md"><span class="koboSpan" id="kobo.1133.1">https://github.com/JamesNK/aspnetcore-grafana/blob/main/README.md</span></a><span class="koboSpan" id="kobo.1134.1">. </span><span class="koboSpan" id="kobo.1134.2">There are two dashboards in </span><span class="No-Break"><span class="koboSpan" id="kobo.1135.1">this repository:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1136.1">ASP.NET Core.json</span></strong><span class="koboSpan" id="kobo.1137.1">: This dashboard shows an overview of the ASP.NET Core web </span><span class="No-Break"><span class="koboSpan" id="kobo.1138.1">API application</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1139.1">ASP.NET Core Endpoint.json</span></strong><span class="koboSpan" id="kobo.1140.1">: This dashboard shows the details for </span><span class="No-Break"><span class="koboSpan" id="kobo.1141.1">specific endpoints</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1142.1">Create a new dashboard and click the </span><strong class="bold"><span class="koboSpan" id="kobo.1143.1">Import</span></strong><span class="koboSpan" id="kobo.1144.1"> button this time. </span><span class="koboSpan" id="kobo.1144.2">Then, upload the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1145.1">ASP.NET Core.json</span></strong><span class="koboSpan" id="kobo.1146.1"> file or paste the content of the file into the textbox, </span><span class="No-Break"><span class="koboSpan" id="kobo.1147.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer160">
<span class="koboSpan" id="kobo.1148.1"><img alt="Figure 16.18 – Importing the dashboard" src="image/B18971_16_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1149.1">Figure 16.18 – Importing the dashboard</span></p>
<p><span class="koboSpan" id="kobo.1150.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1151.1">Load</span></strong><span class="koboSpan" id="kobo.1152.1"> button. </span><span class="koboSpan" id="kobo.1152.2">On</span><a id="_idIndexMarker1874"/><span class="koboSpan" id="kobo.1153.1"> the next page, choose</span><a id="_idIndexMarker1875"/><span class="koboSpan" id="kobo.1154.1"> the Prometheus data source and click the </span><strong class="bold"><span class="koboSpan" id="kobo.1155.1">Import</span></strong><span class="koboSpan" id="kobo.1156.1"> button. </span><span class="koboSpan" id="kobo.1156.2">You will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.1157.1">following dashboard:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer161">
<span class="koboSpan" id="kobo.1158.1"><img alt="Figure 16.19 – ASP.NET Core dashboard provided by James Newton-King" src="image/B18971_16_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1159.1">Figure 16.19 – Overview of the ASP.NET Core dashboard provided by James Newton-King</span></p>
<p><span class="koboSpan" id="kobo.1160.1">This dashboard </span><a id="_idIndexMarker1876"/><span class="koboSpan" id="kobo.1161.1">provides an overview of the ASP.NET Core web API application. </span><span class="koboSpan" id="kobo.1161.2">Here, you can see the number of requests, the request’s duration, the </span><a id="_idIndexMarker1877"/><span class="koboSpan" id="kobo.1162.1">number of active requests, and so on. </span><span class="koboSpan" id="kobo.1162.2">You can also see the error rate, which is important for monitoring </span><span class="No-Break"><span class="koboSpan" id="kobo.1163.1">the application.</span></span></p>
<p><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1164.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1165.1">.20</span></em><span class="koboSpan" id="kobo.1166.1"> shows the </span><strong class="bold"><span class="koboSpan" id="kobo.1167.1">ASP.NET Core </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1168.1">Endpoint</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1169.1"> dashboard:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer162">
<span class="koboSpan" id="kobo.1170.1"><img alt="Figure 16.20 – The ASP.NET Core Endpoint dashboard provided by James Newton-King" src="image/B18971_16_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1171.1">Figure 16.20 – Overview of the ASP.NET Core Endpoint dashboard provided by James Newton-King </span></p>
<p><span class="koboSpan" id="kobo.1172.1">You can choose the endpoint from the drop-down list. </span><span class="koboSpan" id="kobo.1172.2">Once you’ve done this, you will see the metrics for the endpoint. </span><span class="koboSpan" id="kobo.1172.3">For example, </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1173.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1174.1">.20</span></em><span class="koboSpan" id="kobo.1175.1"> shows the metrics for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1176.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1177.1">api/Invoices</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1178.1"> endpoint.</span></span></p>
<p><span class="koboSpan" id="kobo.1179.1">Grafana offers many options to customize dashboards. </span><span class="koboSpan" id="kobo.1179.2">On any dashboard panel, you can click the three dots in the top-right corner and then click </span><strong class="bold"><span class="koboSpan" id="kobo.1180.1">Edit</span></strong><span class="koboSpan" id="kobo.1181.1"> to edit the panel. </span><span class="koboSpan" id="kobo.1181.2">You can change the title, the</span><a id="_idIndexMarker1878"/><span class="koboSpan" id="kobo.1182.1"> visualization type, the query, and so on. </span><span class="koboSpan" id="kobo.1182.2">You can also use the </span><strong class="bold"><span class="koboSpan" id="kobo.1183.1">Builder</span></strong><span class="koboSpan" id="kobo.1184.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.1185.1">Code</span></strong><span class="koboSpan" id="kobo.1186.1"> editor to edit the query, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1187.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1188.1">.21</span></em><span class="koboSpan" id="kobo.1189.1"> and </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1190.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1191.1">.22</span></em><span class="koboSpan" id="kobo.1192.1">, respectively. </span><span class="koboSpan" id="kobo.1192.2">Here’s what the </span><strong class="bold"><span class="koboSpan" id="kobo.1193.1">Builder</span></strong><span class="koboSpan" id="kobo.1194.1"> editor </span><span class="No-Break"><span class="koboSpan" id="kobo.1195.1">looks like:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer163">
<span class="koboSpan" id="kobo.1196.1"><img alt="Figure 16.21 – Editing the query using the Builder editor" src="image/B18971_16_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1197.1">Figure 16.21 – Editing the query using the Builder editor</span></p>
<p><span class="koboSpan" id="kobo.1198.1">Here’s what</span><a id="_idIndexMarker1879"/><span class="koboSpan" id="kobo.1199.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.1200.1">Code</span></strong><span class="koboSpan" id="kobo.1201.1"> editor </span><span class="No-Break"><span class="koboSpan" id="kobo.1202.1">looks like:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer164">
<span class="koboSpan" id="kobo.1203.1"><img alt="Figure 16.22 – Editing the query using the Code editor" src="image/B18971_16_22.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1204.1">Figure 16.22 – Editing the query using the Code editor</span></p>
<p><span class="koboSpan" id="kobo.1205.1">Grafana provides a better visualization of the metrics. </span><span class="koboSpan" id="kobo.1205.2">You can learn more about Grafana by reading the official </span><span class="No-Break"><span class="koboSpan" id="kobo.1206.1">documentation: </span></span><a href="https://grafana.com/docs/grafana/latest/. "><span class="No-Break"><span class="koboSpan" id="kobo.1207.1">https://grafana.com/docs/grafana/latest/.</span></span></a></p>
<p><span class="koboSpan" id="kobo.1208.1">In </span><a id="_idTextAnchor694"/><span class="koboSpan" id="kobo.1209.1">the next section, we will explore how to use OpenTelemetry and Jaeger to </span><span class="No-Break"><span class="koboSpan" id="kobo.1210.1">collect traces.</span></span></p>
<h3><span class="koboSpan" id="kobo.1211.1">Using Jaeger to collect traces</span></h3>
<p><span class="koboSpan" id="kobo.1212.1">Traces </span><a id="_idIndexMarker1880"/><span class="koboSpan" id="kobo.1213.1">are important for understanding how </span><a id="_idIndexMarker1881"/><span class="koboSpan" id="kobo.1214.1">requests are handled by the application. </span><span class="koboSpan" id="kobo.1214.2">In a microservice</span><a id="_idIndexMarker1882"/><span class="koboSpan" id="kobo.1215.1"> architecture, a request will be handled by multiple services. </span><span class="koboSpan" id="kobo.1215.2">Distributed tracing can be used to track the flow of requests across multiple services. </span><span class="koboSpan" id="kobo.1215.3">In this section, we will learn about the basic concepts of distributed tracing and how to use OpenTelemetry and Jaeger to </span><span class="No-Break"><span class="koboSpan" id="kobo.1216.1">collect traces.</span></span></p>
<p><span class="koboSpan" id="kobo.1217.1">For example, in a microservice architecture, service A calls service B, and service B calls service C and service D. </span><span class="koboSpan" id="kobo.1217.2">When a client sends a request to service A, the request will be passed through service B, service C, and service D. </span><span class="koboSpan" id="kobo.1217.3">In this case, if any of these services fails to process the request, or the request takes too long to process, we need to know which service is responsible for the failure and which part of the request contributes to the latency or errors. </span><span class="koboSpan" id="kobo.1217.4">Distributed tracing can give us the big picture of how the request is processed by </span><span class="No-Break"><span class="koboSpan" id="kobo.1218.1">these services.</span></span></p>
<p><span class="koboSpan" id="kobo.1219.1">We have not discussed microservice architecture in detail in this book. </span><span class="koboSpan" id="kobo.1219.2">To demonstrate distributed tracing, we added two web API projects to the sample project. </span><span class="koboSpan" id="kobo.1219.3">You can find a controller named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1220.1">OrdersController</span></strong><span class="koboSpan" id="kobo.1221.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1222.1">MyWebApiDemo</span></strong><span class="koboSpan" id="kobo.1223.1"> project. </span><span class="koboSpan" id="kobo.1223.2">In this controller, we can call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1224.1">Post</span></strong><span class="koboSpan" id="kobo.1225.1"> action to create an order. </span><span class="koboSpan" id="kobo.1225.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1226.1">Post</span></strong><span class="koboSpan" id="kobo.1227.1"> action will call two </span><span class="No-Break"><span class="koboSpan" id="kobo.1228.1">external services:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1229.1">CustomerService</span></strong><span class="koboSpan" id="kobo.1230.1">: A service to check whether the </span><span class="No-Break"><span class="koboSpan" id="kobo.1231.1">customer exists</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1232.1">ProductService</span></strong><span class="koboSpan" id="kobo.1233.1">: A service to check whether the </span><span class="No-Break"><span class="koboSpan" id="kobo.1234.1">product exists</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1235.1">To create an order, we must ensure the customer ID is valid by calling the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1236.1">/api/customers/{id}</span></strong><span class="koboSpan" id="kobo.1237.1"> endpoint of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1238.1">CustomerService</span></strong><span class="koboSpan" id="kobo.1239.1">. </span><span class="koboSpan" id="kobo.1239.2">Additionally, we must verify that the products are valid by calling the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1240.1">/api/products/{id}</span></strong><span class="koboSpan" id="kobo.1241.1"> endpoint </span><span class="No-Break"><span class="koboSpan" id="kobo.1242.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1243.1">ProductService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1244.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1245.1">Note that these services are for demonstration purposes only and should not be used for production purposes. </span><span class="koboSpan" id="kobo.1245.2">As such, there is no real database access layer; instead, a static list is used to store the temporary data. </span><span class="koboSpan" id="kobo.1245.3">Additionally, there is no consideration for transaction and </span><span class="No-Break"><span class="koboSpan" id="kobo.1246.1">concurrency management.</span></span></p>
<p><span class="koboSpan" id="kobo.1247.1">First, let’s enable tracing in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1248.1">MyWebApiDemo</span></strong><span class="koboSpan" id="kobo.1249.1"> project. </span><span class="koboSpan" id="kobo.1249.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1250.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1251.1"> file and add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1252.1">MyWebApiDemo</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1253.1"> project:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1254.1">
builder.Services.AddOpenTelemetry()    .ConfigureResource(config =&gt;
    {
        config.AddService(nameof(MyWebApiDemo));
    })
    .WithMetrics(metrics =&gt;
    {
        // Omitted for brevity
    })
    .WithTracing(tracing =&gt;
    {
        tracing.AddAspNetCoreInstrumentation()
            .AddHttpClientInstrumentation()
            .AddConsoleExporter();
    });</span></pre>
<p><span class="koboSpan" id="kobo.1255.1">In the </span><a id="_idIndexMarker1883"/><span class="koboSpan" id="kobo.1256.1">preceding code, we enabled tracing in our</span><a id="_idIndexMarker1884"/><span class="koboSpan" id="kobo.1257.1"> code using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1258.1">WithTracing</span></strong><span class="koboSpan" id="kobo.1259.1"> method. </span><span class="koboSpan" id="kobo.1259.2">To further instrument our application, we added ASP.NET Core and HTTP client instrumentation. </span><span class="koboSpan" id="kobo.1259.3">The HTTP client instrumentation is used to trace the HTTP calls to the external services. </span><span class="koboSpan" id="kobo.1259.4">Finally, we added a console exporter to export the traces to </span><span class="No-Break"><span class="koboSpan" id="kobo.1260.1">the console.</span></span></p>
<p><span class="koboSpan" id="kobo.1261.1">Run the application and send some requests to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1262.1">api/orders</span></strong><span class="koboSpan" id="kobo.1263.1"> endpoint. </span><span class="koboSpan" id="kobo.1263.2">You will see some tracing information in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1264.1">terminal output:</span></span></p>
<p><span class="koboSpan" id="kobo.1265.1">In the </span><a id="_idIndexMarker1885"/><span class="koboSpan" id="kobo.1266.1">console trace, you will find two important </span><a id="_idIndexMarker1886"/><span class="koboSpan" id="kobo.1267.1">properties: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1268.1">Activity.TraceId</span></strong><span class="koboSpan" id="kobo.1269.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1270.1">Activity.SpanId</span></strong><span class="koboSpan" id="kobo.1271.1">. </span><span class="koboSpan" id="kobo.1271.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1272.1">Activity.TraceId</span></strong><span class="koboSpan" id="kobo.1273.1"> property is used to identify a trace, which is a collection of spans. </span><span class="koboSpan" id="kobo.1273.2">A span is a unit of work in a trace. </span><span class="koboSpan" id="kobo.1273.3">For example, if we send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1274.1">POST</span></strong><span class="koboSpan" id="kobo.1275.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1276.1">api/Orders</span></strong><span class="koboSpan" id="kobo.1277.1"> endpoint to create an order, the application will call </span><strong class="source-inline"><span class="koboSpan" id="kobo.1278.1">ProductService</span></strong><span class="koboSpan" id="kobo.1279.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1280.1">CustomerService</span></strong><span class="koboSpan" id="kobo.1281.1">. </span><span class="koboSpan" id="kobo.1281.2">Each call is a span. </span><span class="koboSpan" id="kobo.1281.3">However, it is not convenient to search for a specific span in the console output. </span><span class="koboSpan" id="kobo.1281.4">Next, we will use Jaeger to collect and visualize </span><span class="No-Break"><span class="koboSpan" id="kobo.1282.1">the traces.</span></span></p>
<p><strong class="bold"><span class="koboSpan" id="kobo.1283.1">Jaeger</span></strong><span class="koboSpan" id="kobo.1284.1"> is</span><a id="_idIndexMarker1887"/><span class="koboSpan" id="kobo.1285.1"> an open-source distributed tracing platform that is used to monitor and troubleshoot distributed workflows and identify performance bottlenecks. </span><span class="koboSpan" id="kobo.1285.2">Jaeger was originally developed by Uber Technologies (</span><a href="http://uber.github.io/"><span class="koboSpan" id="kobo.1286.1">http://uber.github.io/</span></a><span class="koboSpan" id="kobo.1287.1">) and joined the Cloud Native Computing Foundation </span><span class="No-Break"><span class="koboSpan" id="kobo.1288.1">in 2017.</span></span></p>
<p><span class="koboSpan" id="kobo.1289.1">Install</span><a id="_idIndexMarker1888"/><span class="koboSpan" id="kobo.1290.1"> Jaeger</span><a id="_idIndexMarker1889"/><span class="koboSpan" id="kobo.1291.1"> from</span><a id="_idIndexMarker1890"/><span class="koboSpan" id="kobo.1292.1"> the official website: </span><a href="https://www.jaegertracing.io/download/"><span class="koboSpan" id="kobo.1293.1">https://www.jaegertracing.io/download/</span></a><span class="koboSpan" id="kobo.1294.1">. </span><span class="koboSpan" id="kobo.1294.2">You can choose the version for your operating system or use the Docker image. </span><span class="koboSpan" id="kobo.1294.3">In this book, we will use the executable binaries on Windows. </span><span class="koboSpan" id="kobo.1294.4">Navigate to the Jaeger folder in the terminal and run the following command to </span><span class="No-Break"><span class="koboSpan" id="kobo.1295.1">start Jaeger:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1296.1">
./jaeger-all-in-one --collector.otlp.enabled</span></pre> <p><span class="koboSpan" id="kobo.1297.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1298.1">jaeger-all-in-one</span></strong><span class="koboSpan" id="kobo.1299.1"> command is for quick local testing. </span><span class="koboSpan" id="kobo.1299.2">It starts all the components of Jaeger, including the Jaeger UI, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1300.1">jaeger-collector</span></strong><span class="koboSpan" id="kobo.1301.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1302.1">jaeger-agent</span></strong><span class="koboSpan" id="kobo.1303.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1304.1">jaeger-query</span></strong><span class="koboSpan" id="kobo.1305.1">, and in-memory storage. </span><span class="koboSpan" id="kobo.1305.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1306.1">--collector.otlp.enabled</span></strong><span class="koboSpan" id="kobo.1307.1"> option is used to specify that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1308.1">jaeger-collector</span></strong><span class="koboSpan" id="kobo.1309.1"> should accept</span><a id="_idIndexMarker1891"/><span class="koboSpan" id="kobo.1310.1"> traces in OTLP format. </span><span class="koboSpan" id="kobo.1310.2">In the output, you can find the following line, which indicates that Jaeger is receiving data </span><span class="No-Break"><span class="koboSpan" id="kobo.1311.1">from OTLP:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1312.1">
{"level":"info","ts":1697354213.8840668,"caller":"otlpreceiver@v0.86.0/otlp.go:83","msg":"Starting GRPC server","endpoint":"0.0.0.0:4317"}</span></pre> <p><strong class="source-inline"><span class="koboSpan" id="kobo.1313.1">jaeger-collector</span></strong><span class="koboSpan" id="kobo.1314.1"> utilizes port </span><strong class="source-inline"><span class="koboSpan" id="kobo.1315.1">4317</span></strong><span class="koboSpan" id="kobo.1316.1"> to receive data via the gRPC protocol and port </span><strong class="source-inline"><span class="koboSpan" id="kobo.1317.1">4318</span></strong><span class="koboSpan" id="kobo.1318.1"> via the HTTP protocol. </span><span class="koboSpan" id="kobo.1318.2">This allows for efficient communication between </span><strong class="source-inline"><span class="koboSpan" id="kobo.1319.1">jaeger-collector</span></strong><span class="koboSpan" id="kobo.1320.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.1321.1">other services.</span></span></p>
<p><span class="koboSpan" id="kobo.1322.1">Next, we need to configure the ASP.NET Core web API project so that it exports the OTLP traces to Jaeger. </span><span class="koboSpan" id="kobo.1322.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1323.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1324.1"> file and update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1325.1">WithTracing()</span></strong><span class="koboSpan" id="kobo.1326.1"> method, </span><span class="No-Break"><span class="koboSpan" id="kobo.1327.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1328.1">
.WithTracing(tracing =&gt;{
    tracing.AddAspNetCoreInstrumentation()
        .AddHttpClientInstrumentation()
        .AddConsoleExporter()
        .AddOtlpExporter(options =&gt;
        {
            options.Endpoint = new Uri("http://localhost:4317");
        });
});</span></pre>
<p><span class="koboSpan" id="kobo.1329.1">We use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1330.1">AddOtlpExporter</span></strong><span class="koboSpan" id="kobo.1331.1"> method to add the exporter for Jaeger. </span><span class="koboSpan" id="kobo.1331.2">As a best practice, it is</span><a id="_idIndexMarker1892"/><span class="koboSpan" id="kobo.1332.1"> recommended to use the configuration system to set the URL, rather than hard-coding it. </span><span class="koboSpan" id="kobo.1332.2">As an example, you can define it in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1333.1">appsettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1334.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.1335.1">Restart the three </span><a id="_idIndexMarker1893"/><span class="koboSpan" id="kobo.1336.1">applications and send some </span><strong class="source-inline"><span class="koboSpan" id="kobo.1337.1">POST</span></strong><span class="koboSpan" id="kobo.1338.1"> requests to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1339.1">/api/Orders</span></strong><span class="koboSpan" id="kobo.1340.1"> endpoint. </span><span class="koboSpan" id="kobo.1340.2">Here is a </span><span class="No-Break"><span class="koboSpan" id="kobo.1341.1">payload example:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1342.1">
{  "id": 0,
  "orderNumber": "string",
  "contactName": "string",
  "description": "string",
  "amount": 0,
  "customerId": 1,
  "orderDate": "2023-10-15T08:57:54.724Z",
  "dueDate": "2023-10-15T08:57:54.724Z",
  "orderItems": [
    {
      "id": 1,
      "orderId": 0,
      "productId": 1,
      "quantity": 0,
      "unitPrice": 0
    }
  ],
  "status": 0
}</span></pre>
<p><span class="koboSpan" id="kobo.1343.1">Navigate to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1344.1">http://localhost:16686/</span></strong><span class="koboSpan" id="kobo.1345.1">; you will see the Jaeger UI. </span><span class="koboSpan" id="kobo.1345.2">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1346.1">Search</span></strong><span class="koboSpan" id="kobo.1347.1"> tab, choose </span><strong class="bold"><span class="koboSpan" id="kobo.1348.1">Service</span></strong><span class="koboSpan" id="kobo.1349.1">, then </span><strong class="bold"><span class="koboSpan" id="kobo.1350.1">Operation</span></strong><span class="koboSpan" id="kobo.1351.1">, and then </span><a id="_idIndexMarker1894"/><span class="koboSpan" id="kobo.1352.1">click the </span><strong class="bold"><span class="koboSpan" id="kobo.1353.1">Find Traces</span></strong><span class="koboSpan" id="kobo.1354.1"> button. </span><span class="koboSpan" id="kobo.1354.2">You will see the</span><a id="_idIndexMarker1895"/><span class="koboSpan" id="kobo.1355.1"> traces, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1356.1">shown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer165">
<span class="koboSpan" id="kobo.1357.1"><img alt="Figure 16.23 – Jaeger traces" src="image/B18971_16_23.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1358.1">Figure 16.23 – Jaeger traces</span></p>
<p><span class="koboSpan" id="kobo.1359.1">Click on a trace to view </span><span class="No-Break"><span class="koboSpan" id="kobo.1360.1">its details:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer166">
<span class="koboSpan" id="kobo.1361.1"><img alt="Figure 16.24 – A trace’s details" src="image/B18971_16_24.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1362.1">Figure 16.24 – A trace’s details</span></p>
<p><span class="koboSpan" id="kobo.1363.1">You will see </span><a id="_idIndexMarker1896"/><span class="koboSpan" id="kobo.1364.1">that this request includes three spans. </span><span class="koboSpan" id="kobo.1364.2">The</span><a id="_idIndexMarker1897"/><span class="koboSpan" id="kobo.1365.1"> parent is the inbound request, and it has two outbound requests to </span><span class="No-Break"><span class="koboSpan" id="kobo.1366.1">other services.</span></span></p>
<p><span class="koboSpan" id="kobo.1367.1">We can enable traces in the dependent services to better understand how these requests are processed. </span><span class="koboSpan" id="kobo.1367.2">Configure </span><strong class="source-inline"><span class="koboSpan" id="kobo.1368.1">ProductService</span></strong><span class="koboSpan" id="kobo.1369.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1370.1">CustomerService</span></strong><span class="koboSpan" id="kobo.1371.1"> following the same methods. </span><span class="koboSpan" id="kobo.1371.2">These traces should be sent to one Jaeger instance so that Jaeger can correlate the requests across </span><span class="No-Break"><span class="koboSpan" id="kobo.1372.1">different services.</span></span></p>
<p><span class="koboSpan" id="kobo.1373.1">Check the Jaeger UI now. </span><span class="koboSpan" id="kobo.1373.2">You will find that one </span><strong class="source-inline"><span class="koboSpan" id="kobo.1374.1">/api/Orders</span></strong><span class="koboSpan" id="kobo.1375.1"> call has five </span><span class="No-Break"><span class="koboSpan" id="kobo.1376.1">spans now:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer167">
<span class="koboSpan" id="kobo.1377.1"><img alt="Figure 16.25 – The traces across multiple services" src="image/B18971_16_25.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1378.1">Figure 16.25 – The traces across multiple services</span></p>
<p><span class="koboSpan" id="kobo.1379.1">We can also check the latency for each span, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1380.1">Figure 16</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1381.1">.26</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1382.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer168">
<span class="koboSpan" id="kobo.1383.1"><img alt="Figure 16.26 – The latency for each span" src="image/B18971_16_26.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1384.1">Figure 16.26 – The latency for each span</span></p>
<p><span class="koboSpan" id="kobo.1385.1">Using traces </span><a id="_idIndexMarker1898"/><span class="koboSpan" id="kobo.1386.1">can help us understand how </span><a id="_idIndexMarker1899"/><span class="koboSpan" id="kobo.1387.1">requests are handled by the application. </span><span class="koboSpan" id="kobo.1387.2">We can also use traces to find performance bottlenecks. </span><span class="koboSpan" id="kobo.1387.3">It is especially useful for microservice architectures. </span><span class="koboSpan" id="kobo.1387.4">For more information about Jaeger, please refer to the official</span><a id="_idIndexMarker1900"/> <span class="No-Break"><span class="koboSpan" id="kobo.1388.1">documentation: </span></span><a href="https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8/tree/main/samples/chapter16/MyWebApiDemo"><span class="No-Break"><span class="koboSpan" id="kobo.1389.1">https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8/tree/main/samples/chapter16/MyWebApiDemo</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1390.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1391.1">Next, we will recap logging and discuss how to propagate the trace context in </span><span class="No-Break"><span class="koboSpan" id="kobo.1392.1">the logs.</span></span></p>
<h3><span class="koboSpan" id="kobo.1393.1">Using HTTP logging</span></h3>
<p><span class="koboSpan" id="kobo.1394.1">In </span><a href="B18971_04.xhtml#_idTextAnchor170"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1395.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.1396.1">, we </span><a id="_idIndexMarker1901"/><span class="koboSpan" id="kobo.1397.1">discussed how to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1398.1">ILogger</span></strong><span class="koboSpan" id="kobo.1399.1"> interface to</span><a id="_idIndexMarker1902"/><span class="koboSpan" id="kobo.1400.1"> log messages. </span><span class="koboSpan" id="kobo.1400.2">Sometimes, we want to log the HTTP requests and responses for troubleshooting purposes. </span><span class="koboSpan" id="kobo.1400.3">In this section, we will discuss </span><span class="No-Break"><span class="koboSpan" id="kobo.1401.1">HTTP logging.</span></span></p>
<p><span class="koboSpan" id="kobo.1402.1">Follow </span><a href="B18971_04.xhtml#_idTextAnchor170"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1403.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.1404.1"> to configure the logging system. </span><span class="koboSpan" id="kobo.1404.2">You can use Serilog to send logs to Seq. </span><span class="koboSpan" id="kobo.1404.3">To enable HTTP logging, we need to use the HTTP logging middleware. </span><span class="koboSpan" id="kobo.1404.4">The middleware will log the inbound requests and outbound responses. </span><span class="koboSpan" id="kobo.1404.5">The updated code is </span><span class="No-Break"><span class="koboSpan" id="kobo.1405.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1406.1">
var logger = new LoggerConfiguration().WriteTo.Seq("http://localhost:5341").CreateLogger();builder.Logging.AddSerilog(logger);
builder.Services.AddHttpLogging(logging =&gt;
{
    logging.LoggingFields = HttpLoggingFields.All;
});
// Omitted for brevity
app.UseHttpLogging();</span></pre>
<p><span class="koboSpan" id="kobo.1407.1">In the</span><a id="_idIndexMarker1903"/><span class="koboSpan" id="kobo.1408.1"> preceding code, we specify </span><strong class="source-inline"><span class="koboSpan" id="kobo.1409.1">HttpLoggingFields</span></strong><span class="koboSpan" id="kobo.1410.1"> to log all fields. </span><span class="koboSpan" id="kobo.1410.2">Be careful when you use this option in production because</span><a id="_idIndexMarker1904"/><span class="koboSpan" id="kobo.1411.1"> it may potentially impact the performance and log sensitive information. </span><span class="koboSpan" id="kobo.1411.2">We should not log </span><strong class="bold"><span class="koboSpan" id="kobo.1412.1">personally identifiable information</span></strong><span class="koboSpan" id="kobo.1413.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1414.1">PII</span></strong><span class="koboSpan" id="kobo.1415.1">) and </span><a id="_idIndexMarker1905"/><span class="koboSpan" id="kobo.1416.1">any sensitive information. </span><span class="koboSpan" id="kobo.1416.2">We’re using it for demonstration purposes </span><span class="No-Break"><span class="koboSpan" id="kobo.1417.1">only here.</span></span></p>
<p><span class="koboSpan" id="kobo.1418.1">We can also update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1419.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1420.1"> file to specify the log levels. </span><span class="koboSpan" id="kobo.1420.2">Add the following code to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1421.1">LogLevel</span></strong><span class="koboSpan" id="kobo.1422.1"> section of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1423.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1424.1"> file so that we can see </span><span class="No-Break"><span class="koboSpan" id="kobo.1425.1">information logs:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1426.1">
"Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware": "Information"</span></pre> <p><span class="koboSpan" id="kobo.1427.1">Configure the logging in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1428.1">CustomerService</span></strong><span class="koboSpan" id="kobo.1429.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1430.1">ProductService</span></strong><span class="koboSpan" id="kobo.1431.1"> projects using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1432.1">same methods.</span></span></p>
<p><span class="koboSpan" id="kobo.1433.1">Run the three applications and send some requests to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1434.1">/api/Orders</span></strong><span class="koboSpan" id="kobo.1435.1"> endpoint. </span><span class="koboSpan" id="kobo.1435.2">You will see the following logs in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1436.1">Seq dashboard:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer169">
<span class="koboSpan" id="kobo.1437.1"><img alt="Figure 16.27 – HTTP logging" src="image/B18971_16_27.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1438.1">Figure 16.27 – HTTP logging</span></p>
<p><span class="koboSpan" id="kobo.1439.1">In the logs, you will find </span><a id="_idIndexMarker1906"/><span class="koboSpan" id="kobo.1440.1">details about the HTTP requests and responses. </span><span class="koboSpan" id="kobo.1440.2">If you want to change the logging fields, you can change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1441.1">LoggingFields</span></strong><span class="koboSpan" id="kobo.1442.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1443.1">HttpLoggingOptions</span></strong><span class="koboSpan" id="kobo.1444.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1445.1">AddHttpLogging()</span></strong><span class="koboSpan" id="kobo.1446.1"> method. </span><span class="koboSpan" id="kobo.1446.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1447.1">LoggingFields</span></strong><span class="koboSpan" id="kobo.1448.1"> property is an enum. </span><span class="koboSpan" id="kobo.1448.2">You can choose </span><strong class="source-inline"><span class="koboSpan" id="kobo.1449.1">RequestPath</span></strong><span class="koboSpan" id="kobo.1450.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1451.1">RequestQuery</span></strong><span class="koboSpan" id="kobo.1452.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1453.1">RequestMethod</span></strong><span class="koboSpan" id="kobo.1454.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1455.1">RequestStatusCode</span></strong><span class="koboSpan" id="kobo.1456.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1457.1">RequestBody</span></strong><span class="koboSpan" id="kobo.1458.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1459.1">RequestHeaders</span></strong><span class="koboSpan" id="kobo.1460.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1461.1">ResponseHeaders</span></strong><span class="koboSpan" id="kobo.1462.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1463.1">ResponseBody</span></strong><span class="koboSpan" id="kobo.1464.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1465.1">Duration</span></strong><span class="koboSpan" id="kobo.1466.1">, and so on. </span><span class="koboSpan" id="kobo.1466.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1467.1">HttpLoggingOptions</span></strong><span class="koboSpan" id="kobo.1468.1"> class has other properties, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1469.1">RequestHeaders</span></strong><span class="koboSpan" id="kobo.1470.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1471.1">ResponseHeaders</span></strong><span class="koboSpan" id="kobo.1472.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1473.1">RequestBodyLogLimit</span></strong><span class="koboSpan" id="kobo.1474.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1475.1">ResponseBodyLogLimit</span></strong><span class="koboSpan" id="kobo.1476.1">, and others. </span><span class="koboSpan" id="kobo.1476.2">You </span><a id="_idIndexMarker1907"/><span class="koboSpan" id="kobo.1477.1">can use these properties to configure the </span><span class="No-Break"><span class="koboSpan" id="kobo.1478.1">logging system.</span></span></p>
<p><span class="koboSpan" id="kobo.1479.1">Since we enabled HTTP logging for all requests, we can filter the logs by trace ID. </span><span class="koboSpan" id="kobo.1479.2">Check the Jaeger UI and click on a trace. </span><span class="koboSpan" id="kobo.1479.3">You will find the trace ID in </span><span class="No-Break"><span class="koboSpan" id="kobo.1480.1">the URL:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer170">
<span class="koboSpan" id="kobo.1481.1"><img alt="Figure 16.28 – The trace ID in Jaeger" src="image/B18971_16_28.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1482.1">Figure 16.28 – The trace ID in Jaeger</span></p>
<p><span class="koboSpan" id="kobo.1483.1">In the preceding screenshot, the trace ID is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1484.1">8c7ab3bccf13135f27baf11c161e17ca</span></strong><span class="koboSpan" id="kobo.1485.1">. </span><span class="koboSpan" id="kobo.1485.2">Copy this trace ID and use the following query in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1486.1">Seq dashboard:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1487.1">
@TraceId = '8c7ab3bccf13135f27baf11c161e17ca'</span></pre> <p><span class="koboSpan" id="kobo.1488.1">Click the green </span><strong class="bold"><span class="koboSpan" id="kobo.1489.1">Go</span></strong><span class="koboSpan" id="kobo.1490.1"> button to filter the logs. </span><span class="koboSpan" id="kobo.1490.2">You will see the logs for </span><span class="No-Break"><span class="koboSpan" id="kobo.1491.1">this trace:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer171">
<span class="koboSpan" id="kobo.1492.1"><img alt="Figure 16.29 – Filtering the logs by trace ID" src="image/B18971_16_29.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1493.1">Figure 16.29 – Filtering the logs by trace ID</span></p>
<p><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1494.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1495.1">.29</span></em><span class="koboSpan" id="kobo.1496.1"> provides</span><a id="_idIndexMarker1908"/><span class="koboSpan" id="kobo.1497.1"> a comprehensive view of all the logs for the</span><a id="_idIndexMarker1909"/><span class="koboSpan" id="kobo.1498.1"> trace, in</span><a id="_idTextAnchor695"/><span class="koboSpan" id="kobo.1499.1">cluding HTTP requests and responses for three services. </span><span class="koboSpan" id="kobo.1499.2">This is an invaluable resource </span><span class="No-Break"><span class="koboSpan" id="kobo.1500.1">for troubleshooting.</span></span></p>
<h3><span class="koboSpan" id="kobo.1501.1">Using Azure Application Insights</span></h3>
<p><span class="koboSpan" id="kobo.1502.1">In the </span><a id="_idIndexMarker1910"/><span class="koboSpan" id="kobo.1503.1">preceding sections, we explored how</span><a id="_idIndexMarker1911"/><span class="koboSpan" id="kobo.1504.1"> to use OpenTelemetry to collect metrics and traces. </span><span class="koboSpan" id="kobo.1504.2">We also discussed how to leverage open-source tools such as Prometheus, Grafana, Jaeger, and Seq to visualize the metrics, traces, and logs. </span><span class="koboSpan" id="kobo.1504.3">Now, we’ll look at how to use Azure Application Insights to create a unified dashboard for monitoring an ASP.NET Core web </span><span class="No-Break"><span class="koboSpan" id="kobo.1505.1">API application.</span></span></p>
<p><span class="koboSpan" id="kobo.1506.1">Azure Application Insights is an extensible APM service for monitoring applications. </span><span class="koboSpan" id="kobo.1506.2">It can collect and analyze logs, metrics, and traces from multiple sources. </span><span class="koboSpan" id="kobo.1506.3">To follow this section, you need to have an Azure subscription. </span><span class="koboSpan" id="kobo.1506.4">If you do not have one, you can create a free account </span><span class="No-Break"><span class="koboSpan" id="kobo.1507.1">here: </span></span><a href="https://azure.microsoft.com/en-us/free/"><span class="No-Break"><span class="koboSpan" id="kobo.1508.1">https://azure.microsoft.com/en-us/free/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1509.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1510.1">Go to the</span><a id="_idIndexMarker1912"/><span class="koboSpan" id="kobo.1511.1"> Azure </span><a id="_idIndexMarker1913"/><span class="koboSpan" id="kobo.1512.1">portal and create a new Application Insights resource. </span><span class="koboSpan" id="kobo.1512.2">You can find the Application Insights service in the </span><strong class="bold"><span class="koboSpan" id="kobo.1513.1">Monitoring</span></strong><span class="koboSpan" id="kobo.1514.1"> category. </span><span class="koboSpan" id="kobo.1514.2">Choose the </span><strong class="bold"><span class="koboSpan" id="kobo.1515.1">Application Insights</span></strong><span class="koboSpan" id="kobo.1516.1"> service and click the </span><strong class="bold"><span class="koboSpan" id="kobo.1517.1">Create</span></strong><span class="koboSpan" id="kobo.1518.1"> button. </span><span class="koboSpan" id="kobo.1518.2">On the next page, you need to specify the resource group, name, region, and pricing tier, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1519.1">Figure 16</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1520.1">.30</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1521.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer172">
<span class="koboSpan" id="kobo.1522.1"><img alt="Figure 16.30 – Creating an Application Insights resource" src="image/B18971_16_30.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1523.1">Figure 16.30 – Creating an Application Insights resource</span></p>
<p><span class="koboSpan" id="kobo.1524.1">Once the </span><a id="_idIndexMarker1914"/><span class="koboSpan" id="kobo.1525.1">Application Insights resource has been created, navigate</span><a id="_idIndexMarker1915"/><span class="koboSpan" id="kobo.1526.1"> to the </span><strong class="bold"><span class="koboSpan" id="kobo.1527.1">Overview</span></strong><span class="koboSpan" id="kobo.1528.1"> page. </span><span class="koboSpan" id="kobo.1528.2">You will find the </span><strong class="bold"><span class="koboSpan" id="kobo.1529.1">Instrumentation Key</span></strong><span class="koboSpan" id="kobo.1530.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.1531.1">Connection String</span></strong><span class="koboSpan" id="kobo.1532.1"> values. </span><strong class="bold"><span class="koboSpan" id="kobo.1533.1">Instrumentation Key</span></strong><span class="koboSpan" id="kobo.1534.1"> is used to identify the Application Insights resource, while </span><strong class="bold"><span class="koboSpan" id="kobo.1535.1">Connection String</span></strong><span class="koboSpan" id="kobo.1536.1"> is used to connect to the Application Insights resource. </span><span class="koboSpan" id="kobo.1536.2">We will use </span><strong class="bold"><span class="koboSpan" id="kobo.1537.1">Connection String</span></strong><span class="koboSpan" id="kobo.1538.1"> to configure the ASP.NET Core web </span><span class="No-Break"><span class="koboSpan" id="kobo.1539.1">API applications.</span></span></p>
<p><span class="koboSpan" id="kobo.1540.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1541.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1542.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1543.1">MyWebApiDemo</span></strong><span class="koboSpan" id="kobo.1544.1"> project. </span><span class="koboSpan" id="kobo.1544.2">Add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1545.1">following setting:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1546.1">
"APPLICATIONINSIGHTS_CONNECTION_STRING": "InstrumentationKey=xxxxx"</span></pre> <p><span class="koboSpan" id="kobo.1547.1">Please replace </span><a id="_idIndexMarker1916"/><span class="koboSpan" id="kobo.1548.1">the connection string with your</span><a id="_idIndexMarker1917"/><span class="koboSpan" id="kobo.1549.1"> own value. </span><span class="koboSpan" id="kobo.1549.2">This is for demonstration purposes only. </span><span class="koboSpan" id="kobo.1549.3">It is recommended to use different Application Insights resources for different environments. </span><span class="koboSpan" id="kobo.1549.4">This will ensure that metrics and traces are </span><span class="No-Break"><span class="koboSpan" id="kobo.1550.1">not mixed.</span></span></p>
<p><span class="koboSpan" id="kobo.1551.1">Next, we need to install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1552.1">Azure.Monitor.OpenTelemetry.AspNetCore</span></strong><span class="koboSpan" id="kobo.1553.1"> package using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1554.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1555.1">
dotnet add package Azure.Monitor.OpenTelemetry.AspNetCore --prerelease</span></pre> <p><span class="koboSpan" id="kobo.1556.1">This package is used to export metrics and traces to Azure Application Insights. </span><span class="koboSpan" id="kobo.1556.2">At the time of writing, the package was still in preview. </span><span class="koboSpan" id="kobo.1556.3">If you are reading this book after the package has been released, you can omit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1557.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1558.1">prerelease</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1559.1"> option.</span></span></p>
<p><span class="koboSpan" id="kobo.1560.1">Then, update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1561.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1562.1"> file, </span><span class="No-Break"><span class="koboSpan" id="kobo.1563.1">as follows:</span></span></p>
<pre class="source-code">
<strong class="source-inline"><span class="koboSpan" id="kobo.1564.1">builder.Services.AddOpenTelemetry()</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.1565.1">    // Omitted for brevity</span></strong>
<strong class="source-inline"><span class="koboSpan" id="kobo.1566.1">    .UseAzureMonitor()</span></strong></pre>
<p><span class="koboSpan" id="kobo.1567.1">This method will read the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1568.1">APPLICATIONINSIGHTS_CONNECTION_STRING</span></strong><span class="koboSpan" id="kobo.1569.1"> setting from the configuration system and export the metrics and traces to Azure </span><span class="No-Break"><span class="koboSpan" id="kobo.1570.1">Application Insights.</span></span></p>
<p><span class="koboSpan" id="kobo.1571.1">Configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1572.1">CustomerService</span></strong><span class="koboSpan" id="kobo.1573.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1574.1">ProductService</span></strong><span class="koboSpan" id="kobo.1575.1"> projects using the same methods. </span><span class="koboSpan" id="kobo.1575.2">Run the three applications and send some </span><strong class="source-inline"><span class="koboSpan" id="kobo.1576.1">POST</span></strong><span class="koboSpan" id="kobo.1577.1"> requests to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1578.1">/api/Orders</span></strong><span class="koboSpan" id="kobo.1579.1"> endpoint. </span><span class="koboSpan" id="kobo.1579.2">Then, navigate to the Application Insights resource in the Azure portal. </span><span class="koboSpan" id="kobo.1579.3">You will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.1580.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer173">
<span class="koboSpan" id="kobo.1581.1"><img alt="Figure 16.31 – Azure Application Insights" src="image/B18971_16_31.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1582.1">Figure 16.31 – Overview of Azure Application Insights</span></p>
<p><span class="koboSpan" id="kobo.1583.1">You can </span><a id="_idIndexMarker1918"/><span class="koboSpan" id="kobo.1584.1">find even more information</span><a id="_idIndexMarker1919"/><span class="koboSpan" id="kobo.1585.1"> about logs, metrics, and traces. </span><span class="koboSpan" id="kobo.1585.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1586.1">Logs</span></strong><span class="koboSpan" id="kobo.1587.1"> tab; you will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.1588.1">following page:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer174">
<span class="koboSpan" id="kobo.1589.1"><img alt="Figure 16.32 – Azure Application Insights logs" src="image/B18971_16_32.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1590.1">Figure 16.32 – Azure Application Insights logs</span></p>
<p><span class="koboSpan" id="kobo.1591.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1592.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1593.1">.32</span></em><span class="koboSpan" id="kobo.1594.1">, we use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1595.1">requests | where url !contains "metrics"</span></strong><span class="koboSpan" id="kobo.1596.1"> to query the logs. </span><span class="koboSpan" id="kobo.1596.2">This query will filter the logs that do not contain the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1597.1">metrics</span></strong><span class="koboSpan" id="kobo.1598.1"> keyword. </span><span class="koboSpan" id="kobo.1598.2">You can also use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1599.1">traces</span></strong><span class="koboSpan" id="kobo.1600.1"> to query </span><span class="No-Break"><span class="koboSpan" id="kobo.1601.1">the traces.</span></span></p>
<p><span class="koboSpan" id="kobo.1602.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.1603.1">Metrics</span></strong><span class="koboSpan" id="kobo.1604.1"> tab shows the available metrics, </span><span class="No-Break"><span class="koboSpan" id="kobo.1605.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer175">
<span class="koboSpan" id="kobo.1606.1"><img alt="Figure 16.33 – Azure Application Insights metrics" src="image/B18971_16_33.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1607.1">Figure 16.33 – Azure Application Insights metrics</span></p>
<p><span class="koboSpan" id="kobo.1608.1">Here, you</span><a id="_idIndexMarker1920"/><span class="koboSpan" id="kobo.1609.1"> can </span><a id="_idIndexMarker1921"/><span class="koboSpan" id="kobo.1610.1">find the metrics we defined for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1611.1">api/Invoices</span></strong><span class="koboSpan" id="kobo.1612.1"> endpoint. </span><span class="koboSpan" id="kobo.1612.2">If you cannot see the metrics, send some requests to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1613.1">api/Invoices</span></strong><span class="koboSpan" id="kobo.1614.1"> endpoint and wait a </span><span class="No-Break"><span class="koboSpan" id="kobo.1615.1">few minutes.</span></span></p>
<p><span class="koboSpan" id="kobo.1616.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1617.1">Application map</span></strong><span class="koboSpan" id="kobo.1618.1"> tab; you will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.1619.1">following page:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer176">
<span class="koboSpan" id="kobo.1620.1"><img alt="Figure 16.34 – Azure Application Insights application map" src="image/B18971_16_34.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1621.1">Figure 16.34 – Overview of the Azure Application Insights application map </span></p>
<p><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1622.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1623.1">.34</span></em><span class="koboSpan" id="kobo.1624.1"> shows the</span><a id="_idIndexMarker1922"/><span class="koboSpan" id="kobo.1625.1"> requests flow across multiple services. </span><span class="koboSpan" id="kobo.1625.2">You can also find the latency for </span><span class="No-Break"><span class="koboSpan" id="kobo.1626.1">each service.</span></span></p>
<p><span class="koboSpan" id="kobo.1627.1">Upon clicking any </span><a id="_idIndexMarker1923"/><span class="koboSpan" id="kobo.1628.1">request in the diagram, you will see details such as the response time, dependency count, performance histogram, and dependencies, </span><span class="No-Break"><span class="koboSpan" id="kobo.1629.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer177">
<span class="koboSpan" id="kobo.1630.1"><img alt="Figure 16.35 – Azure Application Insights request details" src="image/B18971_16_35.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1631.1">Figure 16.35 – Overview of Azure Application Insights request details</span></p>
<p><span class="koboSpan" id="kobo.1632.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1633.1">Performance</span></strong><span class="koboSpan" id="kobo.1634.1"> tab; you </span><a id="_idIndexMarker1924"/><span class="koboSpan" id="kobo.1635.1">will see the overall </span><a id="_idIndexMarker1925"/><span class="koboSpan" id="kobo.1636.1">performance of </span><span class="No-Break"><span class="koboSpan" id="kobo.1637.1">the application:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer178">
<span class="koboSpan" id="kobo.1638.1"><img alt="Figure 16.36 – Azure Application Insights performance" src="image/B18971_16_36.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1639.1">Figure 16.36 – Overview of Azure Application Insights performance</span></p>
<p><span class="koboSpan" id="kobo.1640.1">Clicking on one operation, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1641.1">POST api/Orders</span></strong><span class="koboSpan" id="kobo.1642.1">, will allow you to view the performance of that operation. </span><span class="koboSpan" id="kobo.1642.2">For further details, click the </span><strong class="bold"><span class="koboSpan" id="kobo.1643.1">xx Samples</span></strong><span class="koboSpan" id="kobo.1644.1"> button located under the </span><strong class="bold"><span class="koboSpan" id="kobo.1645.1">Drill into...</span></strong><span class="koboSpan" id="kobo.1646.1"> label in the bottom-right corner. </span><span class="koboSpan" id="kobo.1646.2">You will see a list of all the requests for that operation on the right-hand side of the screen. </span><span class="koboSpan" id="kobo.1646.3">Clicking on one of these requests will allow you to view the details of that request, including the request and response body, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1647.1">Figure 16</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1648.1">.37</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1649.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer179">
<span class="koboSpan" id="kobo.1650.1"><img alt="Figure 16.37 – Azure Application Insights end-to-end transaction details" src="image/B18971_16_37.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1651.1">Figure 16.37 – Azure Application Insights end-to-end transaction details</span></p>
<p><span class="koboSpan" id="kobo.1652.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1653.1">Figure 16</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1654.1">.37</span></em><span class="koboSpan" id="kobo.1655.1">, you </span><a id="_idIndexMarker1926"/><span class="koboSpan" id="kobo.1656.1">can see how the request is processed by </span><a id="_idIndexMarker1927"/><span class="koboSpan" id="kobo.1657.1">multiple services, similar to what the Jaeger </span><span class="No-Break"><span class="koboSpan" id="kobo.1658.1">UI does.</span></span></p>
<p><span class="koboSpan" id="kobo.1659.1">Azure Application Insights is a super powerful tool for monitoring applications. </span><span class="koboSpan" id="kobo.1659.2">The benefits of using </span><a id="_idIndexMarker1928"/><span class="koboSpan" id="kobo.1660.1">Azure Application Insights are </span><span class="No-Break"><span class="koboSpan" id="kobo.1661.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1662.1">It is a managed service. </span><span class="koboSpan" id="kobo.1662.2">You do not need to maintain </span><span class="No-Break"><span class="koboSpan" id="kobo.1663.1">the infrastructure.</span></span></li>
<li><span class="koboSpan" id="kobo.1664.1">It provides a unified dashboard for monitoring applications. </span><span class="koboSpan" id="kobo.1664.2">You do not need to use multiple tools. </span><span class="koboSpan" id="kobo.1664.3">Application Insights can provide a centralized view of the metrics, traces, </span><span class="No-Break"><span class="koboSpan" id="kobo.1665.1">and logs.</span></span></li>
<li><span class="koboSpan" id="kobo.1666.1">It is easy to integrate with your applications. </span><span class="koboSpan" id="kobo.1666.2">Configuring one connection string is much easier than configuring </span><span class="No-Break"><span class="koboSpan" id="kobo.1667.1">multiple tools.</span></span></li>
<li><span class="koboSpan" id="kobo.1668.1">It provides a powerful query language to query metrics, traces, and logs. </span><span class="koboSpan" id="kobo.1668.2">You can use the query language to create </span><span class="No-Break"><span class="koboSpan" id="kobo.1669.1">custom dashboards.</span></span></li>
<li><span class="koboSpan" id="kobo.1670.1">It offers more features, such as alerting, failure analysis, funnel analysis, user flows, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1671.1">so on.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1672.1">Note that Azure Application Insights is not free. </span><span class="koboSpan" id="kobo.1672.2">It is part of Azure Monitor, a comprehensive monitoring solution f</span><a id="_idTextAnchor696"/><span class="koboSpan" id="kobo.1673.1">or enterprise applications. </span><span class="koboSpan" id="kobo.1673.2">You can find its pricing </span><span class="No-Break"><span class="koboSpan" id="kobo.1674.1">here: </span></span><a href="https://azure.microsoft.com/en-us/pricing/details/monitor/"><span class="No-Break"><span class="koboSpan" id="kobo.1675.1">https://azure.microsoft.com/en-us/pricing/details/monitor/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1676.1">.</span></span></p>
<h1 id="_idParaDest-362"><a id="_idTextAnchor697"/><span class="koboSpan" id="kobo.1677.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1678.1">In this chapter, we discussed monitoring and observability in ASP.NET Core web API applications. </span><span class="koboSpan" id="kobo.1678.2">We explored how to handle errors and exceptions and return proper error responses. </span><span class="koboSpan" id="kobo.1678.3">We also discussed how to implement health checks to determine the status of the application. </span><span class="koboSpan" id="kobo.1678.4">Then, we learned about the basic concepts of observability, including logs, metrics, and traces, and how to integrate with OpenTelemetry and define custom metrics. </span><span class="koboSpan" id="kobo.1678.5">We also explored some open-source tools, such as Prometheus, Grafana, Jaeger, and Seq, to collect and visualize metrics, traces, and logs. </span><span class="koboSpan" id="kobo.1678.6">Finally, we introduced Azure Application Insights, a managed service for monitoring applications in </span><span class="No-Break"><span class="koboSpan" id="kobo.1679.1">one place.</span></span></p>
<p><span class="koboSpan" id="kobo.1680.1">Monitoring and observability are complex topics that require a deeper understanding of distributed systems and microservice architecture. </span><span class="koboSpan" id="kobo.1680.2">In this chapter, we only introduced the basic concepts. </span><span class="koboSpan" id="kobo.1680.3">To gain a more comprehensive understanding of these topics, further study </span><span class="No-Break"><span class="koboSpan" id="kobo.1681.1">is necessary.</span></span></p>
<p><span class="koboSpan" id="kobo.1682.1">In the next chapter, we will explore advanced topics related to architecture and design patterns. </span><span class="koboSpan" id="kobo.1682.2">These include </span><strong class="bold"><span class="koboSpan" id="kobo.1683.1">domain-driven design</span></strong><span class="koboSpan" id="kobo.1684.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1685.1">DDD</span></strong><span class="koboSpan" id="kobo.1686.1">), clean architecture, and cloud-native patterns such as CQRS, resilience patterns, and more. </span><span class="koboSpan" id="kobo.1686.2">This will provide you with a comprehensive overview of the various approaches to architecture </span><span class="No-Break"><span class="koboSpan" id="kobo.1687.1">and design.</span></span></p>
</div>
</body></html>