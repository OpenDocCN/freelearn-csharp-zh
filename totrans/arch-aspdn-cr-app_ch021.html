<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="packt" name="generator"/>
<title>20 Modular Monolith</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<link href="../styles/stylesheet2.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body>
<section class="level1 pkt" data-number="21" id="modular-monolith">
<h1 data-number="21"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">20 Modular Monolith</span></h1>
<section class="level2" data-number="21.1" id="before-you-begin-join-our-book-community-on-discord-19">
<h2 data-number="21.1"><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Before you begin: Join our book community on Discord</span></h2>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">Give your feedback straight to the author himself and chat to other early readers on our Discord server (find the "architecting-aspnet-core-apps-3e" channel under EARLY ACCESS SUBSCRIPTION).</span></p>
<p><a href="https://packt.link/EarlyAccess"><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">https://packt.link/EarlyAccess</span></a></p>
<p><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Qr code Description automatically generated" src="../media/file172.png" style="width:10em"/></span></p>
<p><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">In the ever-evolving software development landscape, choosing the right architecture is like laying the foundation for a building. </span><span class="koboSpan" id="kobo.6.2" xmlns="http://www.w3.org/1999/xhtml">The architecture dictates how the software is structured, impacting its scalability, maintainability, and overall success. </span><span class="koboSpan" id="kobo.6.3" xmlns="http://www.w3.org/1999/xhtml">Traditional monolithic architecture and microservices have long been the dominant paradigms, each with advantages and challenges.However, a new architectural style has been gaining traction—Modular Monoliths. </span><span class="koboSpan" id="kobo.6.4" xmlns="http://www.w3.org/1999/xhtml">This approach aims to offer the best of both worlds by combining the simplicity of monoliths with the flexibility of microservices. </span><span class="koboSpan" id="kobo.6.5" xmlns="http://www.w3.org/1999/xhtml">It serves as a middle ground that addresses some of the complexities associated with microservices, making it particularly appealing for small to medium-sized projects or teams transitioning from a traditional monolithic architecture.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">I wrote an article about this in 2017 entitled </span><em><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml">Microservices Aggregation</span></em><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.9.2" xmlns="http://www.w3.org/1999/xhtml">I recently read the name </span><em><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml">Modular Monolith</span></em><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml"> and loved it better. </span><span class="koboSpan" id="kobo.11.2" xmlns="http://www.w3.org/1999/xhtml">This architectural style is gaining traction, yet it is not entirely new. </span><span class="koboSpan" id="kobo.11.3" xmlns="http://www.w3.org/1999/xhtml">The Modular Monolith style is a way to modularize and organize an application, lowering our chances of creating a big ball of mud.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">This chapter aims to provide a comprehensive understanding of Modular Monoliths. </span><span class="koboSpan" id="kobo.12.2" xmlns="http://www.w3.org/1999/xhtml">We delve into its core principles, advantages, and key components and explore when and how to implement this architecture. </span><span class="koboSpan" id="kobo.12.3" xmlns="http://www.w3.org/1999/xhtml">We build upon our nano e-commerce application to get hands-on insights into Modular Monoliths' practical applications. </span><span class="koboSpan" id="kobo.12.4" xmlns="http://www.w3.org/1999/xhtml">Additionally, we discuss how they compare with other architectural styles to help you make informed decisions for your next projects.By the end of this chapter, you should have a solid grasp of Modular Monoliths, why they might be the right choice for your project, and how to implement them.In this chapter, we cover the following topics:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">What is a Modular Monolith?</span></li>
<li><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml">Advantages of Modular Monoliths</span></li>
<li><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">Key Components of a Modular Monolith</span></li>
<li><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml">Implementing a Modular Monolith</span></li>
<li><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">Project—Modular Monolith</span></li>
<li><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">Transitioning to Microservices</span></li>
<li><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml">Challenges and Pitfalls</span></li>
</ul>
<p><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start by exploring what is a Modular Monolith.</span></p>
</section>
<section class="level2" data-number="21.2" id="what-is-a-modular-monolith">
<h2 data-number="21.2"><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">What is a Modular Monolith?</span></h2>
<p><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">A Modular Monolith is an architectural style that aims to combine the best aspects of traditional monolithic architectures and microservices. </span><span class="koboSpan" id="kobo.22.2" xmlns="http://www.w3.org/1999/xhtml">It organizes the software application into well-defined, loosely coupled modules. </span><span class="koboSpan" id="kobo.22.3" xmlns="http://www.w3.org/1999/xhtml">Each is responsible for a specific business capability. </span><span class="koboSpan" id="kobo.22.4" xmlns="http://www.w3.org/1999/xhtml">However, unlike microservices, all these modules are deployed as a single unit like a monolith.The core principles of a Modular Monolith are:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">Treat each module as a microservice.</span></li>
<li><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">Deploy the application as a single unit.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">Here are the fundamental principles of a successful microservice as studied in </span><em><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 19</span></em><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">Introduction to Microservices Architecture</span></em><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml">:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml">Each microservice should be a cohesive unit of business.</span></li>
<li><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml">Each microservice should own its data.</span></li>
<li><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml">Each microservice should be independent of the others.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">In a nutshell, we get the best of both worlds. </span><span class="koboSpan" id="kobo.33.2" xmlns="http://www.w3.org/1999/xhtml">Yet, understanding how a Modular Monolith compares with other architectural styles is crucial for making informed decisions.</span></p>
<section class="level3" data-number="21.2.1" id="what-are-traditional-monoliths">
<h3 data-number="21.2.1"><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">What are traditional Monoliths?</span></h3>
<p><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">In a traditional monolithic architecture, we build the application as a single, indivisible unit. </span><span class="koboSpan" id="kobo.35.2" xmlns="http://www.w3.org/1999/xhtml">This leads to the functionalities being tightly coupled together, making it difficult to make changes or scale specific features. </span><span class="koboSpan" id="kobo.35.3" xmlns="http://www.w3.org/1999/xhtml">This approach makes creating a big ball of mud easier, particularly when the team invests little effort in domain modeling and analysis before and during development.On top of that, while this approach is simple and straightforward, it lacks the flexibility and scalability of more modern architectures.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">A monolith does not have to be indivisible, yet most end up this way because it is easy to create tight coupling in a single application.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">Let’s look at microservices next.</span></p>
</section>
<section class="level3" data-number="21.2.2" id="what-are-microservices-1">
<h3 data-number="21.2.2"><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">What are microservices?</span></h3>
<p><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml">Microservices architecture, on the other hand, takes modularity to the extreme. </span><span class="koboSpan" id="kobo.39.2" xmlns="http://www.w3.org/1999/xhtml">Each service is a completely independent unit, running in its own environment. </span><span class="koboSpan" id="kobo.39.3" xmlns="http://www.w3.org/1999/xhtml">Microservices architecture allows for high scalability and flexibility but comes at the cost of increased operational complexity.</span></p>
<blockquote>
<p><em><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 19</span></em><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml">Introduction to Microservices Architecture</span></em><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml">, covers this topic more in-depth.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml">The following sections delve deeper into this emerging architectural style, starting with its advantages.</span></p>
</section>
</section>
<section class="level2" data-number="21.3" id="advantages-of-modular-monoliths">
<h2 data-number="21.3"><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">Advantages of Modular Monoliths</span></h2>
<p><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml">One of the best things about Modular Monoliths is that they are easy to manage. </span><span class="koboSpan" id="kobo.46.2" xmlns="http://www.w3.org/1999/xhtml">You don't have to worry about many moving parts like with microservices. </span><span class="koboSpan" id="kobo.46.3" xmlns="http://www.w3.org/1999/xhtml">Everything is in one place but still separated into modules. </span><span class="koboSpan" id="kobo.46.4" xmlns="http://www.w3.org/1999/xhtml">This makes it easier for us to keep track of things and to work with them.With Modular Monoliths, each module is like its own small project. </span><span class="koboSpan" id="kobo.46.5" xmlns="http://www.w3.org/1999/xhtml">We can test, fix, or improve a module without affecting the others. </span><span class="koboSpan" id="kobo.46.6" xmlns="http://www.w3.org/1999/xhtml">This is great because it lets us focus on one thing at a time, which improves productivity by lowering the cognitive load required to work on that feature.When it's time to release the software, we only have one application to deploy. </span><span class="koboSpan" id="kobo.46.7" xmlns="http://www.w3.org/1999/xhtml">Even though it has many modules, we treat them like one deployable unit. </span><span class="koboSpan" id="kobo.46.8" xmlns="http://www.w3.org/1999/xhtml">This makes managing deployments much more straightforward as we don’t have to juggle multiple services like we would with microservices.Modular Monoliths can save us money because we don't need as many resources since we deploy a single monolith. </span><span class="koboSpan" id="kobo.46.9" xmlns="http://www.w3.org/1999/xhtml">Because of that, we don't need a team to manage and run complicated infrastructure. </span><span class="koboSpan" id="kobo.46.10" xmlns="http://www.w3.org/1999/xhtml">We don't need to worry about distributed tracing between our services, which reduces the upfront monitoring cost. </span><span class="koboSpan" id="kobo.46.11" xmlns="http://www.w3.org/1999/xhtml">This deployment style is highly beneficial when starting a project with a small team or if the team is not proficient with microservices architecture.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml">Modular Monoliths can still be valuable even if you are part of a large team, part of a larger organization, or have experience with microservices architecture. </span><span class="koboSpan" id="kobo.47.2" xmlns="http://www.w3.org/1999/xhtml">It is not one or the other kind of scenario.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml">As we just explored, Modular Monoliths bring many advantages:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">The reduced operational complexity makes deploying a complex application as a single unit easier than microservices.</span></li>
<li><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">They improve our development and testing experience because of their simplicity, improving our efficiency.</span></li>
<li><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml">They are easier to manage than most traditional monoliths because modules are well segregated.</span></li>
<li><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml">They are more cost-effective than microservices.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml">The following section looks at what makes up a Modular Monolith.</span></p>
</section>
<section class="level2" data-number="21.4" id="key-components-of-a-modular-monolith">
<h2 data-number="21.4"><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml">Key Components of a Modular Monolith</span></h2>
<p><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml">The first thing to know about Modular Monoliths is that they are composed of different parts called </span><strong><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml">modules</span></strong><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.57.2" xmlns="http://www.w3.org/1999/xhtml">Each module is like a mini-app that performs a specific job. </span><span class="koboSpan" id="kobo.57.3" xmlns="http://www.w3.org/1999/xhtml">This job is related to a particular business capability. </span><span class="koboSpan" id="kobo.57.4" xmlns="http://www.w3.org/1999/xhtml">A business capability comes from the business domain and aims at a cohesive group of scenarios. </span><span class="koboSpan" id="kobo.57.5" xmlns="http://www.w3.org/1999/xhtml">Such a group is called a bounded context in DDD. </span><span class="koboSpan" id="kobo.57.6" xmlns="http://www.w3.org/1999/xhtml">Think of each module as a microservice or a well-defined chunk of the domain.That separation means everything we need to complete a specific task is in one module, which makes it easier for us to understand and work on the software because we don’t have to jump from one place to another to get things done. </span><span class="koboSpan" id="kobo.57.7" xmlns="http://www.w3.org/1999/xhtml">So, if one module needs an update or has a problem, we can fix it without touching the others. </span><span class="koboSpan" id="kobo.57.8" xmlns="http://www.w3.org/1999/xhtml">This segregation is also perfect for testing since we can test each module in isolation to ensure it works well. </span><span class="koboSpan" id="kobo.57.9" xmlns="http://www.w3.org/1999/xhtml">For example, one module might handle a shopping cart while another takes care of the shipping, but we piece all modules together in a final aggregated application.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">We can create the modular monolith as a single project. </span><span class="koboSpan" id="kobo.58.2" xmlns="http://www.w3.org/1999/xhtml">However, in a .NET-specific environment, when each module comprises one or more assemblies, it is harder to create unwanted coupling between modules. </span><span class="koboSpan" id="kobo.58.3" xmlns="http://www.w3.org/1999/xhtml">We explore this in the project we are about to build.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml">module aggregator</span></strong><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml">—the monolith—is responsible for loading and serving the modules as if they were just one application.Even though each module is independent, they still need to talk to each other sometimes. </span><span class="koboSpan" id="kobo.61.2" xmlns="http://www.w3.org/1999/xhtml">For example, the product catalog module might need to tell the shopping cart module that an employee has added a new product to the catalog. </span><span class="koboSpan" id="kobo.61.3" xmlns="http://www.w3.org/1999/xhtml">There are many ways to make this communication happen. </span><span class="koboSpan" id="kobo.61.4" xmlns="http://www.w3.org/1999/xhtml">One of the best ways to keep a low coupling level between the modules is to leverage event-driven architecture. </span><span class="koboSpan" id="kobo.61.5" xmlns="http://www.w3.org/1999/xhtml">On top of loose coupling, this opens doors like scaling the Modular Monolith by migrating one or more modules to a microservices architecture; more on that later.Here's a diagram that represents these relationships:</span></p>
<figure>
<span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 20.1: Diagram representing the relationships between the module aggregator, the modules, and an event broker." src="../media/file173.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml">Figure 20.1: Diagram representing the relationships between the module aggregator, the modules, and an event broker.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have explored the key components of a Modular Monolith, the next section discusses planning and implementing one.</span></p>
</section>
<section class="level2" data-number="21.5" id="implementing-a-modular-monolith">
<h2 data-number="21.5"><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml">Implementing a Modular Monolith</span></h2>
<p><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml">Planning is essential before building a Modular Monolith. </span><span class="koboSpan" id="kobo.66.2" xmlns="http://www.w3.org/1999/xhtml">We must consider what each module does and how modules work together. </span><span class="koboSpan" id="kobo.66.3" xmlns="http://www.w3.org/1999/xhtml">A good plan helps us avoid problems later on.Choosing the right tools to create a lean stack is also essential. </span><span class="koboSpan" id="kobo.66.4" xmlns="http://www.w3.org/1999/xhtml">The good news is that we don't need to define a large shared stack since each module is independent. </span><span class="koboSpan" id="kobo.66.5" xmlns="http://www.w3.org/1999/xhtml">Like a slice in Vertical Slice architecture, each module can determine its patterns and data sources. </span><span class="koboSpan" id="kobo.66.6" xmlns="http://www.w3.org/1999/xhtml">Yet, we must define a few common elements to assemble a Modular Monolith successfully. </span><span class="koboSpan" id="kobo.66.7" xmlns="http://www.w3.org/1999/xhtml">Here are a few items to consider to improve the chances of success of a Modular Monolith:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">The modules share a URL space.</span></li>
<li><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml">The modules share the configuration infrastructure.</span></li>
<li><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml">The modules share a single dependency injection object graph (one container).</span></li>
<li><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml">The modules share the inter-module communication infrastructure (event broker).</span></li>
</ul>
<p><span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml">We can mitigate the first two elements using the module name as a discriminator. </span><span class="koboSpan" id="kobo.71.2" xmlns="http://www.w3.org/1999/xhtml">For example, using the </span><code><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">/{module name}/{module space}</span></code><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml"> URI space would yield the following results (</span><code><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">products</span></code><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">baskets</span></code><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml">customers</span></code><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml"> are modules):</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">/products</span></code></li>
<li><code><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml">/products/123</span></code></li>
<li><code><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml">/baskets</span></code></li>
<li><code><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">/customers</span></code></li>
</ul>
<p><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml">Using the module name as the top-level key of the configuration also makes it easy to avoid conflicts, like </span><code><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml">{module name}:{key}</span></code><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml">, or like the following JSON (say from the </span><code><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml"> file):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml">"{module name}": {
    "{key}": "Module configs"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml">We can mitigate the last two elements by managing the shared code in a certain way. </span><span class="koboSpan" id="kobo.90.2" xmlns="http://www.w3.org/1999/xhtml">For example, limiting the amount of shared code reduces the chances of conflict between the modules. </span><span class="koboSpan" id="kobo.90.3" xmlns="http://www.w3.org/1999/xhtml">Yet, multiple modules globally configuring ASP.NET Core or a third-party library can result in conflicts; centralizing those configurations into the aggregator instead and treating them as a convention will help mitigate most issues. </span><span class="koboSpan" id="kobo.90.4" xmlns="http://www.w3.org/1999/xhtml">Cross-cutting concerns like exception handling, JSON serialization, logging, and security are great candidates for this.Lastly, sharing a single way to communicate between modules and configuring it in the aggregator will help mitigate the communication issues.Let's start planning the project next.</span></p>
<section class="level3" data-number="21.5.1" id="planning-the-project">
<h3 data-number="21.5.1"><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml">Planning the project</span></h3>
<p><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml">Planning is a crucial part of any software. </span><span class="koboSpan" id="kobo.92.2" xmlns="http://www.w3.org/1999/xhtml">Without a plan, you increase your chances of building the wrong thing. </span><span class="koboSpan" id="kobo.92.3" xmlns="http://www.w3.org/1999/xhtml">A plan does not guarantee success, but it improves your chances. </span><span class="koboSpan" id="kobo.92.4" xmlns="http://www.w3.org/1999/xhtml">Overplanning is the other side of this coin. </span><span class="koboSpan" id="kobo.92.5" xmlns="http://www.w3.org/1999/xhtml">It can lead to </span><strong><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml">analysis paralysis</span></strong><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml">, which means you may never even deliver your project or that it will take you so long to deliver it that it will be the wrong product because the needs changed along the way and you did not adapt.Here's a high-level way to accomplish planning a Modular Monolith. </span><span class="koboSpan" id="kobo.94.2" xmlns="http://www.w3.org/1999/xhtml">You don't have to execute all the steps in order. </span><span class="koboSpan" id="kobo.94.3" xmlns="http://www.w3.org/1999/xhtml">You can perform many of them iteratively, or multiple people or teams can even work on them in parallel:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml">Analyse and model the domain.</span></li>
<li><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml">Identify and design the modules.</span></li>
<li><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml">Identify the interactions between modules and design the integration events that cover those interactions.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">Once we are done planning, we can develop and operate the application. </span><span class="koboSpan" id="kobo.98.2" xmlns="http://www.w3.org/1999/xhtml">Here are a few high-level steps:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml">Build and test the modules in isolation.</span></li>
<li><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml">Build and test the module aggregator application that integrates one or more modules.</span></li>
<li><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">Deploy, operate, and monitor the monolith.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml">Implementing a Modular Monolith, like any program, is a step-by-step process. </span><span class="koboSpan" id="kobo.102.2" xmlns="http://www.w3.org/1999/xhtml">We plan, build, test, and then deploy it. </span><span class="koboSpan" id="kobo.102.3" xmlns="http://www.w3.org/1999/xhtml">Each part is simple enough on its own, and when we piece all of them together, we get an easy-to-maintain system. </span><span class="koboSpan" id="kobo.102.4" xmlns="http://www.w3.org/1999/xhtml">Even if continuously improving the application and refining the analysis and the model over time should yield the best results, having a good idea of the high-level domain—the modules—and at least a vague view of their interactions before starting will help avoid mistakes and potentially significant refactoring further down the road. </span><span class="koboSpan" id="kobo.102.5" xmlns="http://www.w3.org/1999/xhtml">Here’s a general representation of this process:</span></p>
<p><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml">∞</span></p><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">
Figure 20.2: A partial Agile and DevOps view of the Modular Monolith phases
</span><p><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml">Next, we plan our nano e-commerce application.</span></p>
<section class="level4" data-number="21.5.1.1" id="analyzing-the-domain">
<h4 data-number="21.5.1.1"><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml">Analyzing the domain</span></h4>
<p><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml">As we continue to iterate over the nano e-commerce application we built in </span><em><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 18</span></em><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><em><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 19</span></em><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml">, the domain analysis will be very short. </span><span class="koboSpan" id="kobo.111.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, we are not expanding the application further than products and baskets because the application is already too large to fit in a single chapter. </span><span class="koboSpan" id="kobo.111.3" xmlns="http://www.w3.org/1999/xhtml">Of course, this time, we are making it a Modular Monolith. </span><span class="koboSpan" id="kobo.111.4" xmlns="http://www.w3.org/1999/xhtml">Here are the high-level entities and their relationships:</span></p>
<figure>
<span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 20.3: The high-level entities of our nono e-commerce app and their relationships" src="../media/file174.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml">Figure 20.3: The high-level entities of our nono e-commerce app and their relationships</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml">As the diagram shows, we have a </span><code><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml">Product</span></code><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml"> entity that could benefit from more details like categories, hence the </span><code><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml">...</span></code><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml"> box. </span><span class="koboSpan" id="kobo.118.2" xmlns="http://www.w3.org/1999/xhtml">We also have the </span><code><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml">BasketItem</span></code><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml"> entity we use for people to save their shopping baskets to the database. </span><span class="koboSpan" id="kobo.120.2" xmlns="http://www.w3.org/1999/xhtml">Finally, a </span><code><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml">Customer</span></code><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml"> entity represents the person to whom a shopping basket belongs.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">We did not implement a </span><code><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">Customer</span></code><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml"> class, yet the customer is conceptually present through the </span><code><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">CustomerId</span></code><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml"> property.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml">Next, we split this subset of the domain into modules.</span></p>
</section>
<section class="level4" data-number="21.5.1.2" id="identifying-the-modules">
<h4 data-number="21.5.1.2"><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml">Identifying the modules</span></h4>
<p><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have identified the entities, it is time to map them into modules. </span><span class="koboSpan" id="kobo.130.2" xmlns="http://www.w3.org/1999/xhtml">Let’s start with the following diagram:</span></p>
<figure>
<span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 20.4: Modules (bounded context) separation and entities relationships." src="../media/file175.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml">Figure 20.4: Modules (bounded context) separation and entities relationships.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml">As expected, we have a product catalog, a shopping basket, and a customer management modules. </span><span class="koboSpan" id="kobo.133.2" xmlns="http://www.w3.org/1999/xhtml">What’s new here is the relationships between the entities. </span><span class="koboSpan" id="kobo.133.3" xmlns="http://www.w3.org/1999/xhtml">The catalog mainly manages the </span><code><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml">Product</span></code><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml"> entity, yet the shopping basket needs to know about it to operate. </span><span class="koboSpan" id="kobo.135.2" xmlns="http://www.w3.org/1999/xhtml">The same logic applies to the </span><code><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml">Customer</span></code><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml"> entity. </span><span class="koboSpan" id="kobo.137.2" xmlns="http://www.w3.org/1999/xhtml">In this case, the shopping basket only needs to know the unique identifier of each entity, but another module could need more information.Based on that high-level view, we need to create three modules. </span><span class="koboSpan" id="kobo.137.3" xmlns="http://www.w3.org/1999/xhtml">In our case, we continue with only two modules. </span><span class="koboSpan" id="kobo.137.4" xmlns="http://www.w3.org/1999/xhtml">In an actual application, we’d have more than three modules since we’d have to manage the purchases, the shipping, the inventory, and more.Let’s look at the interactions between the modules.</span></p>
</section>
<section class="level4" data-number="21.5.1.3" id="identifying-the-interactions-between-modules">
<h4 data-number="21.5.1.3"><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml">Identifying the interactions between modules</span></h4>
<p><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml">Based on our analysis and limited to the two modules we are building, the shopping basket module needs to know about the products. </span><span class="koboSpan" id="kobo.139.2" xmlns="http://www.w3.org/1999/xhtml">Here’s our </span><code><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml">BasketItem</span></code><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml">public record class BasketItem(int CustomerId, int ProductId, int Quantity);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml">The preceding class shows that we only need to know about the unique product identifier. </span><span class="koboSpan" id="kobo.143.2" xmlns="http://www.w3.org/1999/xhtml">So, with an event-driven mindset, the shopping basket module wants to be notified when:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml">A product is created.</span></li>
<li><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml">A product is deleted.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">With those two events, the basket module can manage its cache of products and only allow customers to add existing items to their shopping basket. </span><span class="koboSpan" id="kobo.146.2" xmlns="http://www.w3.org/1999/xhtml">It can also remove items from customers’ shopping baskets when unavailable. </span><span class="koboSpan" id="kobo.146.3" xmlns="http://www.w3.org/1999/xhtml">Here’s a diagram representing these flows:</span></p>
<figure>
<span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 20.5: The integration event flows between the catalog and the basket modules." src="../media/file176.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">Figure 20.5: The integration event flows between the catalog and the basket modules.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have analyzed the domain and the modules, before building anything, let's define our stack.</span></p>
</section>
</section>
<section class="level3" data-number="21.5.2" id="defining-our-stack">
<h3 data-number="21.5.2"><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml">Defining our stack</span></h3>
<p><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml">We know we are using ASP.NET Core and C#. </span><span class="koboSpan" id="kobo.151.2" xmlns="http://www.w3.org/1999/xhtml">We continue leveraging minimal APIs, yet MVC could achieve the same. </span><span class="koboSpan" id="kobo.151.3" xmlns="http://www.w3.org/1999/xhtml">We also continue to leverage </span><em><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml">EF Core</span></em><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper</span></em><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidation</span></em><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><em><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">Mapperly</span></em><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.159.2" xmlns="http://www.w3.org/1999/xhtml">But what about the modules and the other shared aspects of the project? </span><span class="koboSpan" id="kobo.159.3" xmlns="http://www.w3.org/1999/xhtml">Let's have a look.</span></p>
<section class="level4" data-number="21.5.2.1" id="the-module-structure">
<h4 data-number="21.5.2.1"><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml">The module structure</span></h4>
<p><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml">We are using a flexible yet straightforward module structure. </span><span class="koboSpan" id="kobo.161.2" xmlns="http://www.w3.org/1999/xhtml">You can organize your projects however you like; this is not a prescriptive approach. </span><span class="koboSpan" id="kobo.161.3" xmlns="http://www.w3.org/1999/xhtml">For example, you can get inspired by other architectural styles, like Clean Architecture, or invent your own based on your own experience, context, and work environment.In our case, I opted for the following directory structure:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml">applications</span></code><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml"> directory contains the deployable applications, like the aggregator. </span><span class="koboSpan" id="kobo.164.2" xmlns="http://www.w3.org/1999/xhtml">We could add user interfaces in this directory or other deployable applications, like the BFF we built in Chapter 19. </span><span class="koboSpan" id="kobo.164.3" xmlns="http://www.w3.org/1999/xhtml">Each application is contained within its own subdirectory.</span></li>
<li><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml">modules</span></code><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml"> directory contains the modules, each within its own subdirectory.</span></li>
<li><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml">shared</span></code><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml"> directory contains the shared projects.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml">In real-world software, we could extend this setup and add </span><code><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml">infrastructure</span></code><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml">pipelines</span></code><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml"> directories to store our Infrastructure as Code (IaC), documentation, and CI/CD pipelines next to our code.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">What I like about this mono-repo-inspired structure is that each module and application is self-contained. </span><span class="koboSpan" id="kobo.178.2" xmlns="http://www.w3.org/1999/xhtml">For example, the aggregator’s API, contracts, and tests are next to each other:</span></p>
<figure>
<span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 20.6: The aggregator’s directory and project hierarchy." src="../media/file177.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">Figure 20.6: The aggregator’s directory and project hierarchy.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml">The modules are organized similarly:</span></p>
<figure>
<span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 20.7: The modules' subdirectories and catalog’s project hierarchy." src="../media/file178.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml">Figure 20.7: The modules' subdirectories and catalog’s project hierarchy.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">I kept the REPR prefix since it’s based on Chapter 18’s code, but I changed the code structure a bit. </span><span class="koboSpan" id="kobo.184.2" xmlns="http://www.w3.org/1999/xhtml">In this version, I got rid of the nested classes and created one class per file. </span><span class="koboSpan" id="kobo.184.3" xmlns="http://www.w3.org/1999/xhtml">This follows a more classic .NET convention and allows us to extract the API contracts to another assembly. </span><span class="koboSpan" id="kobo.184.4" xmlns="http://www.w3.org/1999/xhtml">If you remember, in Chapter 19, the BFF project referenced the two APIs to reuse their </span><code><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml">Query</span></code><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml">Response</span></code><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml"> contracts. </span><span class="koboSpan" id="kobo.190.2" xmlns="http://www.w3.org/1999/xhtml">We fix this problem through the </span><code><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml">Contracts</span></code><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml"> class library projects in this solution.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml">Why is it a problem? </span><span class="koboSpan" id="kobo.193.2" xmlns="http://www.w3.org/1999/xhtml">The BFF depends on all the microservices, including their logic and dependencies. </span><span class="koboSpan" id="kobo.193.3" xmlns="http://www.w3.org/1999/xhtml">This is a recipe to introduce unwanted coupling. </span><span class="koboSpan" id="kobo.193.4" xmlns="http://www.w3.org/1999/xhtml">Moreover, since it inherits all the dependencies transitively, it increases its deployment size and vulnerability surface; more dependencies and more code means more possibilities for a malicious actor to find an exploitable hole.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml">On top of the API contracts, the </span><code><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml">Contracts</span></code><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml"> projects also contain the integration events. </span><span class="koboSpan" id="kobo.196.2" xmlns="http://www.w3.org/1999/xhtml">We could have separated the API contracts and the integration events if the application was larger; in this case, we only have two integration events. </span><span class="koboSpan" id="kobo.196.3" xmlns="http://www.w3.org/1999/xhtml">Design choices must be taken relative to the current project and context.Let’s explore the URI space next.</span></p>
</section>
<section class="level4" data-number="21.5.2.2" id="the-uri-space">
<h4 data-number="21.5.2.2"><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml">The URI space</span></h4>
<p><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml">The modules of this application follow the previously discussed URI space: </span><code><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml">/{module name}/{module space}</span></code><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.200.2" xmlns="http://www.w3.org/1999/xhtml">Each module has a </span><code><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml">Constants</span></code><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml"> file at its root that looks like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml">namespace REPR.Baskets;
public sealed class Constants
{
    public const string ModuleName = nameof(Baskets);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">We use the </span><code><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml">ModuleName</span></code><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml"> constant in the </span><code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml">{module name}ModuleExtensions</span></code><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml"> files to set the URI prefix and tag the endpoints like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml">namespace REPR.Baskets;
public static class BasketModuleExtensions
{
    public static IEndpointRouteBuilder MapBasketModule(this IEndpointRouteBuilder endpoints)
    {
        _ = endpoints
            .MapGroup(Constants.ModuleName.ToLower())
            .WithTags(Constants.ModuleName)
            .AddFluentValidationFilter()
            // Map endpoints
            .MapFetchItems()
            .MapAddItem()
            .MapUpdateQuantity()
            .MapRemoveItem()
        ;
        return endpoints;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml">With this in place, both modules self-register themselves in the correct URI space.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">We can apply these types of conventions in many different ways. </span><span class="koboSpan" id="kobo.211.2" xmlns="http://www.w3.org/1999/xhtml">In this case, we opted for simplicity, which is the most error-prone, leaving the responsibility to the mercy of each module. </span><span class="koboSpan" id="kobo.211.3" xmlns="http://www.w3.org/1999/xhtml">With a more framework-oriented mindset, we could create a strongly typed module contract that gets loaded automatically, like an </span><code><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">IModule</span></code><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.213.2" xmlns="http://www.w3.org/1999/xhtml">The aggregator could also create the root groups and enforce the URI space.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml">Next, we explore the data space.</span></p>
</section>
<section class="level4" data-number="21.5.2.3" id="the-data-space">
<h4 data-number="21.5.2.3"><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml">The data space</span></h4>
<p><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml">Since we are following the microservices architecture tenets and each module should own its data, we must find a way to ensure our data contexts do not conflict.The project uses the EF Core in-memory provider to develop locally. </span><span class="koboSpan" id="kobo.216.2" xmlns="http://www.w3.org/1999/xhtml">For production, we plan on using SQL Server. </span><span class="koboSpan" id="kobo.216.3" xmlns="http://www.w3.org/1999/xhtml">One excellent way to ensure our </span><code><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml"> classes do not conflict with each other is to create one database schema per context. </span><span class="koboSpan" id="kobo.218.2" xmlns="http://www.w3.org/1999/xhtml">Each module has one context, so one schema per module. </span><span class="koboSpan" id="kobo.218.3" xmlns="http://www.w3.org/1999/xhtml">We don’t have to overthink this; we can reuse the same idea as the URI and leverage the module name. </span><span class="koboSpan" id="kobo.218.4" xmlns="http://www.w3.org/1999/xhtml">So, each module will group its tables under the </span><code><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml">{module name}</span></code><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml"> schema instead of </span><code><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml">dbo</span></code><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml"> (the default SQL Server schema).</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml">We can apply different security rules and permissions to each schema in SQL Server, so we could craft a very secure database model by expanding this. </span><span class="koboSpan" id="kobo.223.2" xmlns="http://www.w3.org/1999/xhtml">For instance, we could employ multiple users possessing minimal privileges, utilize different connection strings within the modules, etc.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">In code, doing this is reflected by setting the default schema name in the </span><code><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml">OnModelCreating</span></code><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml"> method of each </span><code><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.228.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the </span><code><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml">ProductContext</span></code><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">namespace REPR.Products.Data;
public class ProductContext : DbContext
{
    public ProductContext(DbContextOptions&lt;ProductContext&gt; options)
        : base(options) { }
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        modelBuilder.HasDefaultSchema(Constants.ModuleName.ToLower());
    }
    public DbSet&lt;Product&gt; Products =&gt; Set&lt;Product&gt;();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code makes all </span><code><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml">ProductContext</span></code><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml">’s tables part of the </span><code><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml">products</span></code><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml"> schema. </span><span class="koboSpan" id="kobo.236.2" xmlns="http://www.w3.org/1999/xhtml">We then apply the same for the basket module:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml">namespace REPR.Baskets.Data;
public class BasketContext : DbContext
{
    public BasketContext(DbContextOptions&lt;BasketContext&gt; options)
        : base(options) { }
    public DbSet&lt;BasketItem&gt; Items =&gt; Set&lt;BasketItem&gt;();
    public DbSet&lt;Product&gt; Products =&gt; Set&lt;Product&gt;();
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        modelBuilder.HasDefaultSchema(Constants.ModuleName.ToLower());
        modelBuilder
            .Entity&lt;BasketItem&gt;()
            .HasKey(x =&gt; new { x.CustomerId, x.ProductId })
        ;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code makes all </span><code><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml">BasketContext</span></code><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml">’s tables part of the </span><code><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml">baskets</span></code><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml"> schema.Due to the schema, both contexts are safe from hindering the other. </span><span class="koboSpan" id="kobo.242.2" xmlns="http://www.w3.org/1999/xhtml">But wait! </span><span class="koboSpan" id="kobo.242.3" xmlns="http://www.w3.org/1999/xhtml">Both contexts have a </span><code><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml">Products</span></code><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml"> table; what happens then? </span><span class="koboSpan" id="kobo.244.2" xmlns="http://www.w3.org/1999/xhtml">The catalog module uses the </span><code><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml">products.products</span></code><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml"> table, while the basket module uses the </span><code><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml">baskets.products</span></code><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml"> table. </span><span class="koboSpan" id="kobo.248.2" xmlns="http://www.w3.org/1999/xhtml">Different schema, different tables, case closed!</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml">We can apply these notions to more than Modular Monolith as it is general SQL Server and EF Core knowledge.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">If you are using another relational database engine that does not offer schema or a NoSQL database, you must also think about this. </span><span class="koboSpan" id="kobo.250.2" xmlns="http://www.w3.org/1999/xhtml">Each NoSQL database has different ways to think about the data, and it would be impossible to cover them all here. </span><span class="koboSpan" id="kobo.250.3" xmlns="http://www.w3.org/1999/xhtml">The important piece is to find a discriminator that segregates the data of your modules. </span><span class="koboSpan" id="kobo.250.4" xmlns="http://www.w3.org/1999/xhtml">At the limit, it can even be one different database per module; however, this increases the operational complexity of the application.Next, we explore the message broker.</span></p>
</section>
<section class="level4" data-number="21.5.2.4" id="the-message-broker">
<h4 data-number="21.5.2.4"><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml">The message broker</span></h4>
<p><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">To handle the integration events between the catalog and the basket modules, I decided to pick MassTransit. </span><span class="koboSpan" id="kobo.252.2" xmlns="http://www.w3.org/1999/xhtml">To quote their GitHub project:</span></p>
<blockquote>
<em><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml">MassTransit is a free, open-source distributed application framework for .NET. </span><span class="koboSpan" id="kobo.253.2" xmlns="http://www.w3.org/1999/xhtml">MassTransit makes it easy to create applications and services that leverage message-based, loosely-coupled asynchronous communication for higher availability, reliability, and scalability.</span></em>
</blockquote>
<p><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">I picked MassTransit because it is a popular project with 5,800 GitHub stars as of 2023 and supports many providers, including in-memory. </span><span class="koboSpan" id="kobo.254.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, it offers many features that are way above our needs. </span><span class="koboSpan" id="kobo.254.3" xmlns="http://www.w3.org/1999/xhtml">Once again, we could have used anything. </span><span class="koboSpan" id="kobo.254.4" xmlns="http://www.w3.org/1999/xhtml">For example, MediatR could have also done the job.The </span><code><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">REPR.API</span></code><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml"> project—the aggregator—and the modules depend on the following NuGet package to use MassTransit:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml">&lt;PackageReference Include="MassTransit" Version="8.1.0" /&gt;</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml">Our usage is very simple; the aggregator registers and configures MassTransit like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.AddMassTransit(x =&gt;
{
    x.SetKebabCaseEndpointNameFormatter();
    x.UsingInMemory((context, cfg) =&gt;
    {
        cfg.ConfigureEndpoints(context);
    });
    x.AddBasketModuleConsumers();
});</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">The highlighted line delegates the registration of event consumers to the basket module. </span><span class="koboSpan" id="kobo.260.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml">AddBasketModuleConsumers</span></code><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml"> method is part of the </span><code><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml">BasketModuleExtensions</span></code><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml"> class and contains the following code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml">public static void AddBasketModuleConsumers(this IRegistrationConfigurator configurator)
{
    configurator.AddConsumers(typeof(ProductEventsConsumers));
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml">ProductEventsConsumers</span></code><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml"> class manages the two events. </span><span class="koboSpan" id="kobo.268.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml">AddConsumers</span></code><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml"> method is part of MassTransit. </span><span class="koboSpan" id="kobo.270.2" xmlns="http://www.w3.org/1999/xhtml">We explore the </span><code><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml">ProductEventsConsumers</span></code><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml"> class in the project section.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml">We would register the event consumers of other modules here if we had more. </span><span class="koboSpan" id="kobo.273.2" xmlns="http://www.w3.org/1999/xhtml">Yet the delegation of that registration to each module makes it modular.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml">Next, we write some C# code to transform our microservices application into a Modular Monolith.</span></p>
</section>
</section>
</section>
<section class="level2" data-number="21.6" id="projectmodular-monolith">
<h2 data-number="21.6"><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml">Project—Modular Monolith</span></h2>
<p><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml">This project has the same building block as </span><em><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 18</span></em><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><em><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 19</span></em><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml">, but we use the Modular Monolith approach. </span><span class="koboSpan" id="kobo.280.2" xmlns="http://www.w3.org/1999/xhtml">On top of the previous versions, we leverage events to enable the shopping basket to validate the existence of a product before allowing customers to add it to their shopping basket.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml">The complete source code is available on GitHub: </span><a href="https://adpg.link/gyds"><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/gyds</span></a></p>
<blockquote>
<p><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml">The test projects in the solution are empty. </span><span class="koboSpan" id="kobo.283.2" xmlns="http://www.w3.org/1999/xhtml">They only exist for the organizational aspect of the solution. </span><span class="koboSpan" id="kobo.283.3" xmlns="http://www.w3.org/1999/xhtml">As an exercise, you can migrate the tests from </span><em><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 18</span></em><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml"> and adapt them to this new architectural style.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start with the communication piece.</span></p>
<section class="level3" data-number="21.6.1" id="sending-events-from-the-catalog-module">
<h3 data-number="21.6.1"><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml">Sending events from the catalog module</span></h3>
<p><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">For the catalog to communicate the events that the basket module needs, it must define the following new operations:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml">Create products</span></li>
<li><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml">Delete products</span></li>
</ul>
<p><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml">Here are the API contracts we must create in the </span><code><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml">REPR.Products.Contracts</span></code><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml"> project to support those two operations:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml">namespace REPR.Products.Contracts;
public record class CreateProductCommand(string Name, decimal UnitPrice);
public record class CreateProductResponse(int Id, string Name, decimal UnitPrice);
public record class DeleteProductCommand(int ProductId);
public record class DeleteProductResponse(int Id, string Name, decimal UnitPrice);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">The API contracts should look very familiar by now and are similar to those from previous chapters. </span><span class="koboSpan" id="kobo.295.2" xmlns="http://www.w3.org/1999/xhtml">We then need the following two event contracts:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">namespace REPR.Products.Contracts;
public record class ProductCreated(int Id, string Name, decimal UnitPrice);
public record class ProductDeleted(int Id);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml">The two event classes are also very straightforward, but their name is in the past tense because an event happened in the past. </span><span class="koboSpan" id="kobo.297.2" xmlns="http://www.w3.org/1999/xhtml">So, the module creates the product and then notifies its subscribers that a product was created (in the past). </span><span class="koboSpan" id="kobo.297.3" xmlns="http://www.w3.org/1999/xhtml">Exactly like we studied in </span><em><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 19</span></em><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml">Introduction to Microservices Architecture</span></em><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.301.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, the events are simple data containers, like an API contract—a DTO—is.How do we send those events? </span><span class="koboSpan" id="kobo.301.3" xmlns="http://www.w3.org/1999/xhtml">Let’s have a look at the </span><code><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml">CreateProductHandler</span></code><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml">namespace REPR.Products.Features;
public class CreateProductHandler
{
    private readonly ProductContext _db;
    private readonly CreateProductMapper _mapper;
    private readonly IBus _bus;
    public CreateProductHandler(ProductContext db, CreateProductMapper mapper, IBus bus)
    {
        _db = db ?? </span><span class="koboSpan" id="kobo.304.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(db));
        _mapper = mapper ?? </span><span class="koboSpan" id="kobo.304.3" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(mapper));
        _bus = bus ?? </span><span class="koboSpan" id="kobo.304.4" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(bus));
    }
    public async Task&lt;CreateProductResponse&gt; HandleAsync(CreateProductCommand command, CancellationToken cancellationToken)
    {
        var product = _mapper.Map(command);
        var entry = _db.Products.Add(product);
        await _db.SaveChangesAsync(cancellationToken);
        var productCreated = _mapper.MapToIntegrationEvent(entry.Entity);
        await _bus.Publish(productCreated, CancellationToken.None);
        var response = _mapper.MapToResponse(entry.Entity);
        return response;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we inject an </span><code><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">IBus</span></code><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml"> interface from MassTransit in the </span><code><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml">CreateProductHandler</span></code><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.309.2" xmlns="http://www.w3.org/1999/xhtml">We also inject an object mapper and an EF Core </span><code><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">ProductContext</span></code><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.311.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml">HandleAsync</span></code><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml"> method does the following:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml">Creates the product and saves it to the database.</span></li>
<li><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml">Publishes a </span><code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml">ProductCreated</span></code><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml"> event (highlighted code).</span></li>
<li><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml">Returns a </span><code><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml">CreateProductResponse</span></code><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml"> instance based on the new product.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml">Publish</span></code><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml"> method sends the event to the configured pipe, which is in memory in our case. </span><span class="koboSpan" id="kobo.323.2" xmlns="http://www.w3.org/1999/xhtml">The code passes a </span><code><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml">CancellationToken.None</span></code><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml"> argument here because we don’t want this operation to be canceled by any external force because the change is already saved in the database.Because of the mapping code, the publishing code may be hard to understand in a book. </span><span class="koboSpan" id="kobo.325.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml">MapToIntegrationEvent</span></code><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml"> method converts a </span><code><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml">Product</span></code><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml"> object to a </span><code><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml">ProductCreated</span></code><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml"> instance, so the </span><code><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml">productCreated</span></code><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml"> variable is of type </span><code><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml">ProductCreated</span></code><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.335.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the </span><em><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml">Mapperly</span></em><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml"> mapper class with that method highlighted:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">namespace REPR.Products.Features;
[Mapper]
public partial class CreateProductMapper
{
    public partial Product Map(CreateProductCommand product);
    public partial ProductCreated MapToIntegrationEvent(Product product);
    public partial CreateProductResponse MapToResponse(Product product);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml">DeleteProductHandler</span></code><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml"> class follows a similar pattern but publishes the </span><code><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml">ProductDeleted</span></code><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml"> event instead.Now, let’s explore how the basket module consumes those events.</span></p>
</section>
<section class="level3" data-number="21.6.2" id="consuming-the-events-from-the-basket-module">
<h3 data-number="21.6.2"><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml">Consuming the events from the basket module</span></h3>
<p><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">The basket module wants to cache existing products. </span><span class="koboSpan" id="kobo.345.2" xmlns="http://www.w3.org/1999/xhtml">We can achieve this in different ways. </span><span class="koboSpan" id="kobo.345.3" xmlns="http://www.w3.org/1999/xhtml">In this case, we create the following </span><code><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml">Product</span></code><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml"> class that we persist in the database:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">namespace REPR.Baskets.Data;
public record class Product(int Id);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml">To make use of it, we must expose the following property from the </span><code><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">BasketContext</span></code><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">public DbSet&lt;Product&gt; Products =&gt; Set&lt;Product&gt;();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">Then, we can start to leverage this cache. </span><span class="koboSpan" id="kobo.353.2" xmlns="http://www.w3.org/1999/xhtml">Firstly, we must populate it when the catalog module creates a product and remove that product when deleted. </span><span class="koboSpan" id="kobo.353.3" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml">ProductEventsConsumers</span></code><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml"> class handles both events. </span><span class="koboSpan" id="kobo.355.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the skeleton of this class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml">using REPR.Products.Contracts;
namespace REPR.Baskets.Features;
public class ProductEventsConsumers : IConsumer&lt;ProductCreated&gt;, IConsumer&lt;ProductDeleted&gt;
{
    private readonly BasketContext _db;
    private readonly ILogger _logger;
    public ProductEventsConsumers(BasketContext db, ILogger&lt;ProductEventsConsumers&gt; logger)
    {
        _db = db ?? </span><span class="koboSpan" id="kobo.356.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(db));
        _logger = logger ?? </span><span class="koboSpan" id="kobo.356.3" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(logger));
    }
    public async Task Consume(ConsumeContext&lt;ProductCreated&gt; context) 
    {...}
    public async Task Consume(ConsumeContext&lt;ProductDeleted&gt; context) 
    {...}
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml">The highlighted code represents the two event handlers. </span><span class="koboSpan" id="kobo.357.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml">IConsumer&lt;TMessage&gt;</span></code><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml"> interface contains the </span><code><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml">Consume</span></code><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.361.2" xmlns="http://www.w3.org/1999/xhtml">Implementing the interface twice with a different </span><code><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml">TMessage</span></code><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml"> generic parameter prescribes implementing the two </span><code><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml">Consume</span></code><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml"> methods in the </span><code><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml">ProductEventsConsumers</span></code><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.367.2" xmlns="http://www.w3.org/1999/xhtml">Each method handles its own event.When a product is created in the product module, the following method is executed in the basket module (I removed the logging code for brevity):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml">public async Task Consume(ConsumeContext&lt;ProductCreated&gt; context)
{
    var product = await _db.Products.FirstOrDefaultAsync(
        x =&gt; x.Id == context.Message.Id,
        cancellationToken: context.CancellationToken
    );
    if (product is not null)
    {
        return;
    }
    _db.Products.Add(new(context.Message.Id));
    await _db.SaveChangesAsync();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code adds a new product to the database if it does not exist. </span><span class="koboSpan" id="kobo.369.2" xmlns="http://www.w3.org/1999/xhtml">If it does exist, it does nothing.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml">We could add telemetry here to log and flag the conflict and explore how to solve it. </span><span class="koboSpan" id="kobo.370.2" xmlns="http://www.w3.org/1999/xhtml">If the product already exists, the event was received twice, which may indicate an issue with our system.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml">Here’s the flow of what happens when an employee creates a new product:</span></p>
<figure>
<span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 20.8: A diagram showcasing the sequence of operations when someone adds a product to the system." src="../media/file179.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml">Figure 20.8: A diagram showcasing the sequence of operations when someone adds a product to the system.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml">Let’s review the operations:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">A client sends a POST request to the API (the aggregator application). </span><span class="koboSpan" id="kobo.375.2" xmlns="http://www.w3.org/1999/xhtml">The catalog module receives the request.</span></li>
<li><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">The catalog creates the product and adds it to the database.</span></li>
<li><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml">The catalog then publishes the </span><code><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml">ProductCreated</span></code><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml"> event using MassTransit.</span></li>
<li><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml">In the basket module, the </span><code><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">Consume</span></code><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml"> method of the </span><code><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml">ProductEventsConsumers</span></code><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml"> class gets called by MassTransit in reaction to the </span><code><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml">ProductCreated</span></code><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml"> event.</span></li>
<li><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml">The basket module adds the product's identifier to the database to its materialized view.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml">Now that we know how the </span><code><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml">ProductEventsConsumers</span></code><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml"> class handles the </span><code><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml">ProductCreated</span></code><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml"> events, let’s explore the </span><code><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml">ProductDeleted</span></code><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml"> events (logging code omitted for brevity):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">public async Task Consume(ConsumeContext&lt;ProductDeleted&gt; context)
{
    var item = await _db.Products.FirstOrDefaultAsync(
        x =&gt; x.Id == context.Message.Id,
        cancellationToken: context.CancellationToken
    );
    if (item is null)
    {
        return;
    }
    // Remove the products from existing baskets
    var existingItemInCarts = _db.Items
        .Where(x =&gt; x.ProductId == context.Message.Id);
    var count = existingItemInCarts.Count();
    _db.Items.RemoveRange(existingItemInCarts);
    // Remove the product from the internal cache
    _db.Products.Remove(item);
    // Save the changes
    await _db.SaveChangesAsync();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml">The preceding </span><code><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml">Consume</span></code><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml"> method removes the products from people’s shopping baskets and the materialized view. </span><span class="koboSpan" id="kobo.398.2" xmlns="http://www.w3.org/1999/xhtml">If the product does not exist, the method does nothing because there’s nothing to handle.A similar flow happens when an employee deletes a product from the catalog and publishes a </span><code><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml">ProductDeleted</span></code><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml"> event. </span><span class="koboSpan" id="kobo.400.2" xmlns="http://www.w3.org/1999/xhtml">The basket module then reacts to the event and updates its cache (materialized view).Now that we have explored this exciting part of the project, let’s look at the aggregator.</span></p>
</section>
<section class="level3" data-number="21.6.3" id="inside-the-aggregator">
<h3 data-number="21.6.3"><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml">Inside the aggregator</span></h3>
<p><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml">The aggregator application is like an empty shell that loads the other assemblies and configures the cross-cutting concerns. </span><span class="koboSpan" id="kobo.402.2" xmlns="http://www.w3.org/1999/xhtml">It references the modules, then assembles and boots the application. </span><span class="koboSpan" id="kobo.402.3" xmlns="http://www.w3.org/1999/xhtml">Here’s the first part of the </span><code><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml"> file:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml">using FluentValidation;
using FluentValidation.AspNetCore;
using MassTransit;
using REPR.API.HttpClient;
using REPR.Baskets;
using REPR.Products;
using System.Reflection;
var builder = WebApplication.CreateBuilder(args);
// Register fluent validation
builder.AddFluentValidationEndpointFilter();
builder.Services
    .AddFluentValidationAutoValidation()
    .AddValidatorsFromAssemblies(new[] {
        Assembly.GetExecutingAssembly(),
        Assembly.GetAssembly(typeof(BasketModuleExtensions)),
        Assembly.GetAssembly(typeof(ProductsModuleExtensions)),
    })
;
builder.AddApiHttpClient();
builder.AddExceptionMapper();
builder
    .AddBasketModule()
    .AddProductsModule()
;
builder.Services.AddMassTransit(x =&gt;
{
    x.SetKebabCaseEndpointNameFormatter();
    x.UsingInMemory((context, cfg) =&gt;
    {
        cfg.ConfigureEndpoints(context);
    });
    x.AddBasketModuleConsumers();
});</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code registers the following:</span></p>
<ul>
<li><em><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidation</span></em><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">; it also scans the assemblies for validators.</span></li>
<li><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml">IWebClient</span></code><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml"> interface that we use to seed the database (the </span><code><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml">AddApiHttpClient</span></code><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml"> method).</span></li>
<li><em><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper</span></em><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml">The modules' dependencies (highlighted)</span></li>
<li><em><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml">MassTransit</span></em><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">; it also registers the consumers from the basket module (highlighted).</span></li>
</ul>
<p><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">The container we register those dependencies into is also used for and by the modules because the aggregator is the host. </span><span class="koboSpan" id="kobo.419.2" xmlns="http://www.w3.org/1999/xhtml">Those dependencies are shared across the modules.The second part of the </span><code><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml"> file is the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">var app = builder.Build();
app.UseExceptionMapper();
app
    .MapBasketModule()
    .MapProductsModule()
;
// Convenience endpoint, seeding the catalog
app.MapGet("/", async (IWebClient client, CancellationToken cancellationToken) =&gt;
{
    await client.Catalog.CreateProductAsync(new("Banana", 0.30m), cancellationToken);
    await client.Catalog.CreateProductAsync(new("Apple", 0.79m), cancellationToken);
    await client.Catalog.CreateProductAsync(new("Habanero Pepper", 0.99m), cancellationToken);
    return new
    {
        Message = "Application started and catalog seeded. </span><span class="koboSpan" id="kobo.422.2" xmlns="http://www.w3.org/1999/xhtml">Do not refresh this page, or it will reseed the catalog."
    </span><span class="koboSpan" id="kobo.422.3" xmlns="http://www.w3.org/1999/xhtml">};
});
app.Run();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code registers the </span><code><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper</span></code><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml"> middleware, then the modules. </span><span class="koboSpan" id="kobo.425.2" xmlns="http://www.w3.org/1999/xhtml">It also adds a seeding endpoint (highlighted). </span><span class="koboSpan" id="kobo.425.3" xmlns="http://www.w3.org/1999/xhtml">If you remember, we were seeding the database using the </span><code><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml"> in the previous versions. </span><span class="koboSpan" id="kobo.427.2" xmlns="http://www.w3.org/1999/xhtml">However, since the basket module needs to receive the events from the catalog to build a materialized view, it is more convenient to seed the database through the catalog module. </span><span class="koboSpan" id="kobo.427.3" xmlns="http://www.w3.org/1999/xhtml">In this version, the program seeds the database when a client hits the </span><code><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml">/</span></code><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml"> endpoint. </span><span class="koboSpan" id="kobo.429.2" xmlns="http://www.w3.org/1999/xhtml">By default, when starting the application, Visual Studio should open a browser at that URL, which will seed the database.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml">Seeding the database by sending a GET request to the </span><code><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">/</span></code><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml"> endpoint is very convenient for an academic scenario where we use in-memory databases. </span><span class="koboSpan" id="kobo.432.2" xmlns="http://www.w3.org/1999/xhtml">However, this could be disastrous in a production environment because it would reseed the database whenever someone hits that endpoint.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml">Let’s explore the </span><code><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml">IWebClient</span></code><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml">, next.</span></p>
</section>
<section class="level3" data-number="21.6.4" id="exploring-the-rest-api-httpclient">
<h3 data-number="21.6.4"><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml">Exploring the REST API HttpClient</span></h3>
<p><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml">In the </span><code><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml">shared</span></code><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml"> directory, the </span><code><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml">REPR.API.HttpClient</span></code><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml"> project contains the REST API client code. </span><span class="koboSpan" id="kobo.441.2" xmlns="http://www.w3.org/1999/xhtml">The code is very similar to the previous project, but the </span><code><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml">IProductsClient</span></code><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml"> now exposes a create and delete method (highlighted):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml">using Refit;
using REPR.Products.Contracts;
namespace REPR.API.HttpClient;
public interface IProductsClient
{
    [Get("/products/{query.ProductId}")]
    Task&lt;FetchOneProductResponse&gt; FetchProductAsync(
        FetchOneProductQuery query,
        CancellationToken cancellationToken);
    [Get("/products")]
    Task&lt;FetchAllProductsResponse&gt; FetchProductsAsync(
        CancellationToken cancellationToken);
    [Post("/products")]
    Task&lt;CreateProductResponse&gt; CreateProductAsync(
        CreateProductCommand command,
        CancellationToken cancellationToken);
    [Delete("/products/{command.ProductId}")]
    Task&lt;DeleteProductResponse&gt; DeleteProductAsync(
        DeleteProductCommand command,
        CancellationToken cancellationToken);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">On top of this, the project only references the </span><code><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml">Contracts</span></code><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml"> projects, limiting its dependencies to the classes it needs. </span><span class="koboSpan" id="kobo.447.2" xmlns="http://www.w3.org/1999/xhtml">It does not reference the complete modules anymore. </span><span class="koboSpan" id="kobo.447.3" xmlns="http://www.w3.org/1999/xhtml">This makes this project easy to reuse. </span><span class="koboSpan" id="kobo.447.4" xmlns="http://www.w3.org/1999/xhtml">For example, we could build another project, like a user interface (UI), then reference and use this typed client to query the API (modular monolith) from that .NET UI.Since we created this client for a microservices application, we have two base downstream service URLs—one for the product microservice and one for the basket microservice. </span><span class="koboSpan" id="kobo.447.5" xmlns="http://www.w3.org/1999/xhtml">This nuance suits us well since we may want to migrate our monolith to microservices later. </span><span class="koboSpan" id="kobo.447.6" xmlns="http://www.w3.org/1999/xhtml">In the meantime, all we have to do is set the two keys to the same host, like the following </span><code><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml"> file from the aggregator:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml">{
  "Downstream": {
    "Baskets": {
      "BaseAddress": "https://localhost:7164/"
    },
    "Products": {
      "BaseAddress": "https://localhost:7164/"
    }
  }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml">With these configurations, the </span><code><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml">AddApiHttpClient</span></code><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml"> method configures two </span><code><span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml">HttpClient</span></code><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml"> with the same </span><code><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml">BaseAddress</span></code><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml"> value, like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml">using Microsoft.AspNetCore.Builder;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Refit;
namespace REPR.API.HttpClient;
public static class ApiHttpClientExtensions
{
    public static WebApplicationBuilder AddApiHttpClient(this WebApplicationBuilder builder)
    {
        const string basketsBaseAddressKey = "Downstream:Baskets:BaseAddress";
        const string productsBaseAddressKey = "Downstream:Products:BaseAddress";
        var basketsBaseAddress = builder.Configuration
            .GetValue&lt;string&gt;(basketsBaseAddressKey) ?? </span><span class="koboSpan" id="kobo.458.2" xmlns="http://www.w3.org/1999/xhtml">throw new BaseAddressNotFoundException(basketsBaseAddressKey);
        var productsBaseAddress = builder.Configuration
            .GetValue&lt;string&gt;(productsBaseAddressKey) ?? </span><span class="koboSpan" id="kobo.458.3" xmlns="http://www.w3.org/1999/xhtml">throw new BaseAddressNotFoundException(productsBaseAddressKey);
        builder.Services
            .AddRefitClient&lt;IBasketsClient&gt;()
            .ConfigureHttpClient(c =&gt; c.BaseAddress = new Uri(basketsBaseAddress))
        ;
        builder.Services
            .AddRefitClient&lt;IProductsClient&gt;()
            .ConfigureHttpClient(c =&gt; c.BaseAddress = new Uri(productsBaseAddress))
        ;
        builder.Services.AddTransient&lt;IWebClient, DefaultWebClient&gt;();
        return builder;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml">And voilà, we have a functional typed client we can reuse and a working modular monolith. </span><span class="koboSpan" id="kobo.459.2" xmlns="http://www.w3.org/1999/xhtml">Let’s test this out next.</span></p>
</section>
<section class="level3" data-number="21.6.5" id="sending-http-requests-to-the-api">
<h3 data-number="21.6.5"><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml">Sending HTTP requests to the API</span></h3>
<p><span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have a working modular monolith, we can reuse similar HTTP requests than the previous versions.At the root of the REPR.API project, we can use the following:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml">API-Products.http</span></code><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml"> file contains requests to the product module.</span></li>
<li><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.466.1" xmlns="http://www.w3.org/1999/xhtml">API-Baskets.http</span></code><span class="koboSpan" id="kobo.467.1" xmlns="http://www.w3.org/1999/xhtml"> file contains requests to the basket module.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.468.1" xmlns="http://www.w3.org/1999/xhtml">A new outcome in this API compared to the previous versions is when we try to add a product that does not exist in the catalog to our basket, like the following request:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.469.1" xmlns="http://www.w3.org/1999/xhtml">POST https://localhost:7164/baskets
Content-Type: application/json
{
    "customerId": 1, 
    "productId": 5, 
    "quantity": 99
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.470.1" xmlns="http://www.w3.org/1999/xhtml">Since the product </span><code><span class="koboSpan" id="kobo.471.1" xmlns="http://www.w3.org/1999/xhtml">5</span></code><span class="koboSpan" id="kobo.472.1" xmlns="http://www.w3.org/1999/xhtml"> does not exist, the API returns the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.473.1" xmlns="http://www.w3.org/1999/xhtml">HTTP/1.1 400 Bad Request
Content-Type: application/problem+json
{
  "type": "https://tools.ietf.org/html/rfc9110#section-15.5.1",
  "title": "One or more validation errors occurred.",
  "status": 400,
  "errors": {
    "productId": [
      "The Product does not exist."
    </span><span class="koboSpan" id="kobo.473.2" xmlns="http://www.w3.org/1999/xhtml">]
  }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.474.1" xmlns="http://www.w3.org/1999/xhtml">That error confirms that the validation works as expected. </span><span class="koboSpan" id="kobo.474.2" xmlns="http://www.w3.org/1999/xhtml">But how are we validating this?</span></p>
</section>
<section class="level3" data-number="21.6.6" id="validating-the-existence-of-a-product">
<h3 data-number="21.6.6"><span class="koboSpan" id="kobo.475.1" xmlns="http://www.w3.org/1999/xhtml">Validating the existence of a product</span></h3>
<p><span class="koboSpan" id="kobo.476.1" xmlns="http://www.w3.org/1999/xhtml">In the </span><em><span class="koboSpan" id="kobo.477.1" xmlns="http://www.w3.org/1999/xhtml">add item</span></em><span class="koboSpan" id="kobo.478.1" xmlns="http://www.w3.org/1999/xhtml"> feature, the </span><code><span class="koboSpan" id="kobo.479.1" xmlns="http://www.w3.org/1999/xhtml">AddItemValidator</span></code><span class="koboSpan" id="kobo.480.1" xmlns="http://www.w3.org/1999/xhtml"> class ensures the product exists while validating the </span><code><span class="koboSpan" id="kobo.481.1" xmlns="http://www.w3.org/1999/xhtml">AddItemCommand</span></code><span class="koboSpan" id="kobo.482.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.482.2" xmlns="http://www.w3.org/1999/xhtml">To achieve this, we leverage the </span><code><span class="koboSpan" id="kobo.483.1" xmlns="http://www.w3.org/1999/xhtml">MustAsync</span></code><span class="koboSpan" id="kobo.484.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.485.1" xmlns="http://www.w3.org/1999/xhtml">WithMessage</span></code><span class="koboSpan" id="kobo.486.1" xmlns="http://www.w3.org/1999/xhtml"> methods from FluentValidation. </span><span class="koboSpan" id="kobo.486.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.487.1" xmlns="http://www.w3.org/1999/xhtml">namespace REPR.Baskets.Features;
public class AddItemValidator : AbstractValidator&lt;AddItemCommand&gt;
{
    private readonly BasketContext _db;
    public AddItemValidator(BasketContext db)
    {
        _db = db ?? </span><span class="koboSpan" id="kobo.487.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(db));
        RuleFor(x =&gt; x.CustomerId).GreaterThan(0);
        RuleFor(x =&gt; x.ProductId)
            .GreaterThan(0)
            .MustAsync(ProductExistsAsync)
            .WithMessage("The Product does not exist.")
        ;
        RuleFor(x =&gt; x.Quantity).GreaterThan(0);
    }
    private async Task&lt;bool&gt; ProductExistsAsync(int productId, CancellationToken cancellationToken)
    {
        var product = await _db.Products
            .FirstOrDefaultAsync(x =&gt; x.Id == productId, cancellationToken);
        return product is not null;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.488.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code implements the same rules as the previous versions but also calls the </span><code><span class="koboSpan" id="kobo.489.1" xmlns="http://www.w3.org/1999/xhtml">ProductExistsAsync</span></code><span class="koboSpan" id="kobo.490.1" xmlns="http://www.w3.org/1999/xhtml"> method that fetches the requested product from the cache. </span><span class="koboSpan" id="kobo.490.2" xmlns="http://www.w3.org/1999/xhtml">If the result is </span><code><span class="koboSpan" id="kobo.491.1" xmlns="http://www.w3.org/1999/xhtml">false</span></code><span class="koboSpan" id="kobo.492.1" xmlns="http://www.w3.org/1999/xhtml">, the validation fails with the message “</span><em><span class="koboSpan" id="kobo.493.1" xmlns="http://www.w3.org/1999/xhtml">The Product does not exist.</span></em><span class="koboSpan" id="kobo.494.1" xmlns="http://www.w3.org/1999/xhtml">”.Here’s the resulting flow of this change:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.495.1" xmlns="http://www.w3.org/1999/xhtml">The client calls the API.</span></li>
<li><span class="koboSpan" id="kobo.496.1" xmlns="http://www.w3.org/1999/xhtml">The validation middleware calls the validator.</span></li>
<li><span class="koboSpan" id="kobo.497.1" xmlns="http://www.w3.org/1999/xhtml">The validator fetches the record from the database and validates its existence.</span></li>
<li><span class="koboSpan" id="kobo.498.1" xmlns="http://www.w3.org/1999/xhtml">If the product does not exist, the request is short-circuited here and returned to the client. </span><span class="koboSpan" id="kobo.498.2" xmlns="http://www.w3.org/1999/xhtml">Otherwise, it continues to the </span><code><span class="koboSpan" id="kobo.499.1" xmlns="http://www.w3.org/1999/xhtml">AddItemHandler</span></code><span class="koboSpan" id="kobo.500.1" xmlns="http://www.w3.org/1999/xhtml"> class.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.501.1" xmlns="http://www.w3.org/1999/xhtml">With this in place, we covered all new scenarios from this project. </span><span class="koboSpan" id="kobo.501.2" xmlns="http://www.w3.org/1999/xhtml">We also explored how the aggregator connects the modules together and how easy it is to keep our modules independent.Next, we get the BFF back into the project and explore how to transition our modular monolith to a microservices architecture.</span></p>
</section>
</section>
<section class="level2" data-number="21.7" id="transitioning-to-microservices">
<h2 data-number="21.7"><span class="koboSpan" id="kobo.502.1" xmlns="http://www.w3.org/1999/xhtml">Transitioning to Microservices</span></h2>
<p><span class="koboSpan" id="kobo.503.1" xmlns="http://www.w3.org/1999/xhtml">You don’t have to transition your monolith to microservices; deploying a monolith is fine if it fits your needs. </span><span class="koboSpan" id="kobo.503.2" xmlns="http://www.w3.org/1999/xhtml">However, if ever you need to, you could shield your aggregator with a gateway or a reverse proxy so you can extract modules into their own microservices and reroute the requests without impacting the clients. </span><span class="koboSpan" id="kobo.503.3" xmlns="http://www.w3.org/1999/xhtml">This would also allow you to gradually transfer the traffic to the new service while keeping the monolith intact in case of an unexpected failure.In a modular monolith, the aggregator registers most dependencies, so when migrating, you must also migrate this shared setup. </span><span class="koboSpan" id="kobo.503.4" xmlns="http://www.w3.org/1999/xhtml">One way to not duplicate code would be to create and reference a shared assembly containing those registrations. </span><span class="koboSpan" id="kobo.503.5" xmlns="http://www.w3.org/1999/xhtml">This makes it easier to manage the dependencies and shared configurations, but it is also coupling between the microservices and the aggregator. </span><span class="koboSpan" id="kobo.503.6" xmlns="http://www.w3.org/1999/xhtml">Leveraging the code of this shared assembly is even easier when the microservices are part of the same mono-repo; you can reference the project directly without managing a NuGet package. </span><span class="koboSpan" id="kobo.503.7" xmlns="http://www.w3.org/1999/xhtml">Yet, when you update the library, it updates all microservices and the monolith, voiding the deployment independence of each application.Once again, consider keeping the monolith intact versus the operational complexity that deploying microservices would bring.In the solution, the </span><code><span class="koboSpan" id="kobo.504.1" xmlns="http://www.w3.org/1999/xhtml">REPR.BFF</span></code><span class="koboSpan" id="kobo.505.1" xmlns="http://www.w3.org/1999/xhtml"> project is a migration of </span><em><span class="koboSpan" id="kobo.506.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 19</span></em><span class="koboSpan" id="kobo.507.1" xmlns="http://www.w3.org/1999/xhtml"> code. </span><span class="koboSpan" id="kobo.507.2" xmlns="http://www.w3.org/1999/xhtml">The code and the logic are almost the same. </span><span class="koboSpan" id="kobo.507.3" xmlns="http://www.w3.org/1999/xhtml">It leverages the </span><code><span class="koboSpan" id="kobo.508.1" xmlns="http://www.w3.org/1999/xhtml">REPR.API.HttpClient</span></code><span class="koboSpan" id="kobo.509.1" xmlns="http://www.w3.org/1999/xhtml"> project and configures the downstream base addresses in its </span><code><span class="koboSpan" id="kobo.510.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.Development.json</span></code><span class="koboSpan" id="kobo.511.1" xmlns="http://www.w3.org/1999/xhtml"> file. </span><span class="koboSpan" id="kobo.511.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.512.1" xmlns="http://www.w3.org/1999/xhtml">REPR.BFF.http</span></code><span class="koboSpan" id="kobo.513.1" xmlns="http://www.w3.org/1999/xhtml"> file at the root of the project contains a few requests to test the application.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.514.1" xmlns="http://www.w3.org/1999/xhtml">The code is available on GitHub: </span><a href="https://adpg.link/bn1F"><span class="koboSpan" id="kobo.515.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/bn1F</span></a><span class="koboSpan" id="kobo.516.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.516.2" xmlns="http://www.w3.org/1999/xhtml">I suggest playing with the live application, which will yield a better result than copying the code in the book a second time. </span><span class="koboSpan" id="kobo.516.3" xmlns="http://www.w3.org/1999/xhtml">The relationships between the projects are also more evident in Visual Studio than written in a book. </span><span class="koboSpan" id="kobo.516.4" xmlns="http://www.w3.org/1999/xhtml">Feel free to refactor the projects, add tests, or add features. </span><span class="koboSpan" id="kobo.516.5" xmlns="http://www.w3.org/1999/xhtml">The best way to learn is to practice!</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.517.1" xmlns="http://www.w3.org/1999/xhtml">Next, let’s have a look at challenges and pitfalls.</span></p>
</section>
<section class="level2" data-number="21.8" id="challenges-and-pitfalls">
<h2 data-number="21.8"><span class="koboSpan" id="kobo.518.1" xmlns="http://www.w3.org/1999/xhtml">Challenges and Pitfalls</span></h2>
<p><span class="koboSpan" id="kobo.519.1" xmlns="http://www.w3.org/1999/xhtml">It is a misconception that monoliths are only suitable for small projects or small teams. </span><span class="koboSpan" id="kobo.519.2" xmlns="http://www.w3.org/1999/xhtml">A well-built monolith can go a long way, which is what a modular structure and a good analysis bring. </span><span class="koboSpan" id="kobo.519.3" xmlns="http://www.w3.org/1999/xhtml">Modular Monoliths can be very powerful and work well for different sizes of projects. </span><span class="koboSpan" id="kobo.519.4" xmlns="http://www.w3.org/1999/xhtml">It is essential to consider the pros and cons of each approach when selecting the application pattern for a project. </span><span class="koboSpan" id="kobo.519.5" xmlns="http://www.w3.org/1999/xhtml">Maybe a cloud-native, serverless, microservices application is what your next project needs, but perhaps a well-designed Modular Monolith would achieve the same performance at a tremendously lower cost.To help you make those decisions, here are some potential challenges and how to avoid or mitigate them:</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.520.1" xmlns="http://www.w3.org/1999/xhtml">Too much complexity within a module:</span></strong><span class="koboSpan" id="kobo.521.1" xmlns="http://www.w3.org/1999/xhtml"> One risk is making the modules too complex. </span><span class="koboSpan" id="kobo.521.2" xmlns="http://www.w3.org/1999/xhtml">Like any piece of code, it becomes harder to manage a module if it does too many things. </span><span class="koboSpan" id="kobo.521.3" xmlns="http://www.w3.org/1999/xhtml">Moreover, the bigger the piece of software, the more chance the shiny initial design starts to bleed into a big ball of mud. </span><span class="koboSpan" id="kobo.521.4" xmlns="http://www.w3.org/1999/xhtml">We can avoid this by keeping each module focused on a specific part of the domain and by applying the SRP.</span></li>
<li><strong><span class="koboSpan" id="kobo.522.1" xmlns="http://www.w3.org/1999/xhtml">Poorly defined module boundaries:</span></strong><span class="koboSpan" id="kobo.523.1" xmlns="http://www.w3.org/1999/xhtml"> If the boundaries between modules are unclear, it can create problems. </span><span class="koboSpan" id="kobo.523.2" xmlns="http://www.w3.org/1999/xhtml">For example, if two modules do similar things, it can confuse developers and lead to one part of the system depending on the wrong module. </span><span class="koboSpan" id="kobo.523.3" xmlns="http://www.w3.org/1999/xhtml">Another example is when two modules that should be part of the same bounded context are separated. </span><span class="koboSpan" id="kobo.523.4" xmlns="http://www.w3.org/1999/xhtml">In that case, the chances are that the two modules will interact a lot with each other, creating chattiness and significantly increasing the coupling between them. </span><span class="koboSpan" id="kobo.523.5" xmlns="http://www.w3.org/1999/xhtml">We avoid this with good planning, domain analysis, and ensuring each module has a specific job (SRP).</span></li>
<li><strong><span class="koboSpan" id="kobo.524.1" xmlns="http://www.w3.org/1999/xhtml">Scaling:</span></strong><span class="koboSpan" id="kobo.525.1" xmlns="http://www.w3.org/1999/xhtml"> Even though Modular Monoliths are easier to manage, they carry the monolith issues when they must scale up. </span><span class="koboSpan" id="kobo.525.2" xmlns="http://www.w3.org/1999/xhtml">We must deploy the whole application, so we can't scale modules independently. </span><span class="koboSpan" id="kobo.525.3" xmlns="http://www.w3.org/1999/xhtml">Moreover, even if modules own their data, they probably share one database, which must also be scaled as a whole. </span><span class="koboSpan" id="kobo.525.4" xmlns="http://www.w3.org/1999/xhtml">If scaling the whole system is impossible, we can migrate specific modules to microservices. </span><span class="koboSpan" id="kobo.525.5" xmlns="http://www.w3.org/1999/xhtml">We can also extract in-memory services to distributed ones, like using a distributed cache instead of a memory cache, leveraging a cloud-based event broker instead of an in-memory one, or even having compute or data-intensive modules start using their own database so they partially scale independently. </span><span class="koboSpan" id="kobo.525.6" xmlns="http://www.w3.org/1999/xhtml">However, these solutions make the deployment and the infrastructure more complex, gradually moving towards complex infrastructure, which defeats the monolith’s benefits.</span></li>
<li><strong><span class="koboSpan" id="kobo.526.1" xmlns="http://www.w3.org/1999/xhtml">Eventual consistency:</span></strong><span class="koboSpan" id="kobo.527.1" xmlns="http://www.w3.org/1999/xhtml"> Keeping data in sync between modules can be challenging. </span><span class="koboSpan" id="kobo.527.2" xmlns="http://www.w3.org/1999/xhtml">We can handle this using event-driven architecture. </span><span class="koboSpan" id="kobo.527.3" xmlns="http://www.w3.org/1999/xhtml">Using an in-memory message broker is low-latency and high-fidelity (no network involved), which is a good first step towards learning and dealing with eventual consistency and breaking the monolith into microservices (if the transition is ever needed). </span><span class="koboSpan" id="kobo.527.4" xmlns="http://www.w3.org/1999/xhtml">However, a more resilient transport is recommended for production, so the system resists to failures, increasing the synchronization latency. </span><span class="koboSpan" id="kobo.527.5" xmlns="http://www.w3.org/1999/xhtml">You do not have to use events if you prefer to remove this complexity; a well-designed relational database can do the trick.</span></li>
<li><strong><span class="koboSpan" id="kobo.528.1" xmlns="http://www.w3.org/1999/xhtml">Transition to microservices:</span></strong><span class="koboSpan" id="kobo.529.1" xmlns="http://www.w3.org/1999/xhtml"> Moving an application to microservices architecture after the fact can be a significant undertaking. </span><span class="koboSpan" id="kobo.529.2" xmlns="http://www.w3.org/1999/xhtml">However, starting with an event-powered Modular Monolith should make the journey less painful.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.530.1" xmlns="http://www.w3.org/1999/xhtml">While Modular Monoliths offer many benefits, they can also pose challenges. </span><span class="koboSpan" id="kobo.530.2" xmlns="http://www.w3.org/1999/xhtml">The key is to plan well, keep things simple, and be ready to adapt as the program evolves.</span></p>
</section>
<section class="level2" data-number="21.9" id="conclusion-35">
<h2 data-number="21.9"><span class="koboSpan" id="kobo.531.1" xmlns="http://www.w3.org/1999/xhtml">Conclusion</span></h2>
<p><span class="koboSpan" id="kobo.532.1" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we learned about the Modular Monolith architectural style, which blends the simplicity of monolithic architectures with the flexibility of microservices. </span><span class="koboSpan" id="kobo.532.2" xmlns="http://www.w3.org/1999/xhtml">This architectural style organizes software applications into distinct, loosely coupled modules, each responsible for a specific business capability. </span><span class="koboSpan" id="kobo.532.3" xmlns="http://www.w3.org/1999/xhtml">Unlike microservices, we deploy these modules as a single unit, like a monolith. </span><span class="koboSpan" id="kobo.532.4" xmlns="http://www.w3.org/1999/xhtml">We discussed the benefits of Modular Monoliths, including easier overall management, sound development and testing experiences, cost-effectiveness, and a simplified deployment model.We saw that a Modular Monolith comprises modules, a module aggregator, and an inter-module communication infrastructure—event-driven in this case.We learned that analyzing the domain, designing the modules, and identifying the interactions between modules before starting the development improves the chances of success of the product.We touched on transitioning from a Modular Monolith to a microservices architecture, which involves extracting modules into separate microservices and rerouting requests.We also highlighted the importance of knowing potential challenges and pitfalls. </span><span class="koboSpan" id="kobo.532.5" xmlns="http://www.w3.org/1999/xhtml">These include module complexity, poorly defined module boundaries, scaling limitations, and eventual consistency caused by an asynchronous communication model.</span></p>
</section>
<section class="level2" data-number="21.10" id="questions-19">
<h2 data-number="21.10"><span class="koboSpan" id="kobo.533.1" xmlns="http://www.w3.org/1999/xhtml">Questions</span></h2>
<p><span class="koboSpan" id="kobo.534.1" xmlns="http://www.w3.org/1999/xhtml">Let’s take a look at a few practice questions:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.535.1" xmlns="http://www.w3.org/1999/xhtml">What are the core principles of a Modular Monolith?</span></li>
<li><span class="koboSpan" id="kobo.536.1" xmlns="http://www.w3.org/1999/xhtml">What are the advantages of Modular Monoliths?</span></li>
<li><span class="koboSpan" id="kobo.537.1" xmlns="http://www.w3.org/1999/xhtml">What are traditional Monoliths?</span></li>
<li><span class="koboSpan" id="kobo.538.1" xmlns="http://www.w3.org/1999/xhtml">Are poorly defined module boundaries indeed beneficial to a Modular Monolith?</span></li>
<li><span class="koboSpan" id="kobo.539.1" xmlns="http://www.w3.org/1999/xhtml">Is it true that transitioning an application to microservices architecture can be a significant undertaking?</span></li>
</ol>
</section>
<section class="level2" data-number="21.11" id="further-reading-17">
<h2 data-number="21.11"><span class="koboSpan" id="kobo.540.1" xmlns="http://www.w3.org/1999/xhtml">Further reading</span></h2>
<p><span class="koboSpan" id="kobo.541.1" xmlns="http://www.w3.org/1999/xhtml">Here is a link to build upon what we learned in the chapter:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.542.1" xmlns="http://www.w3.org/1999/xhtml">Microservices Aggregation (Modular Monolith): </span><a href="https://adpg.link/zznM"><span class="koboSpan" id="kobo.543.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/zznM</span></a></li>
<li><span class="koboSpan" id="kobo.544.1" xmlns="http://www.w3.org/1999/xhtml">When (modular) monolith is the better way to build software: </span><a href="https://adpg.link/KBGB"><span class="koboSpan" id="kobo.545.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/KBGB</span></a></li>
<li><span class="koboSpan" id="kobo.546.1" xmlns="http://www.w3.org/1999/xhtml">Source code: </span><a href="https://adpg.link/gyds"><span class="koboSpan" id="kobo.547.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/gyds</span></a></li>
</ul>
</section>
<section class="level2" data-number="21.12" id="an-end-is-simply-a-new-beginning">
<h2 data-number="21.12"><span class="koboSpan" id="kobo.548.1" xmlns="http://www.w3.org/1999/xhtml">An end is simply a new beginning</span></h2>
<p><span class="koboSpan" id="kobo.549.1" xmlns="http://www.w3.org/1999/xhtml">This may be the end of the book, but it is also the continuation of your journey into software architecture and design. </span><span class="koboSpan" id="kobo.549.2" xmlns="http://www.w3.org/1999/xhtml">I hope you found this to be a refreshing view of design patterns and how to design SOLID apps.Depending on your goals and current situation, you may want to explore one or more application-scale design patterns in more depth, start your next personal project, start a business, apply for a new job, or all of those. </span><span class="koboSpan" id="kobo.549.3" xmlns="http://www.w3.org/1999/xhtml">No matter your goals, keep in mind that designing software is technical but also an art. </span><span class="koboSpan" id="kobo.549.4" xmlns="http://www.w3.org/1999/xhtml">There is rarely one way to implement a feature but multiple acceptable ways. </span><span class="koboSpan" id="kobo.549.5" xmlns="http://www.w3.org/1999/xhtml">Every decision has trade-offs, and experience is your best friend, so keep programming, learn from your mistakes, become better, and continue. </span><span class="koboSpan" id="kobo.549.6" xmlns="http://www.w3.org/1999/xhtml">The path to mastery is a never-ending continuous learning loop. </span><span class="koboSpan" id="kobo.549.7" xmlns="http://www.w3.org/1999/xhtml">Remember that we are all born knowing next to nothing, so not knowing something is expected; we need to learn. </span><span class="koboSpan" id="kobo.549.8" xmlns="http://www.w3.org/1999/xhtml">Please ask questions, read, experiment, learn, and share your knowledge with others. </span><span class="koboSpan" id="kobo.549.9" xmlns="http://www.w3.org/1999/xhtml">Explaining a concept to someone is extremely rewarding and reinforces your own learning and knowledge.Now that this book is complete, you may find interesting articles on my blog (</span><a href="https://adpg.link/blog"><span class="koboSpan" id="kobo.550.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/blog</span></a><span class="koboSpan" id="kobo.551.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.551.2" xmlns="http://www.w3.org/1999/xhtml">Feel free to reach out on Discord, Twitter </span><code><span class="koboSpan" id="kobo.552.1" xmlns="http://www.w3.org/1999/xhtml">@CarlHugoM</span></code><span class="koboSpan" id="kobo.553.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><a href="https://adpg.link/twit"><span class="koboSpan" id="kobo.554.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/twit</span></a><span class="koboSpan" id="kobo.555.1" xmlns="http://www.w3.org/1999/xhtml">), or LinkedIn (</span><a href="https://adpg.link/edin"><span class="koboSpan" id="kobo.556.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/edin</span></a><span class="koboSpan" id="kobo.557.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.557.2" xmlns="http://www.w3.org/1999/xhtml">I hope you found the book educational and approachable and that you learned many things. </span><span class="koboSpan" id="kobo.557.3" xmlns="http://www.w3.org/1999/xhtml">I wish you success in your career.</span></p>
</section>
<section class="level2" data-number="21.13" id="answers-16">
<h2 data-number="21.13"><span class="koboSpan" id="kobo.558.1" xmlns="http://www.w3.org/1999/xhtml">Answers</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.559.1" xmlns="http://www.w3.org/1999/xhtml">We must treat each module as a microservice and deploy the application as a single unit—a monolith.</span></li>
<li><span class="koboSpan" id="kobo.560.1" xmlns="http://www.w3.org/1999/xhtml">A few moving parts make the application simpler. </span><span class="koboSpan" id="kobo.560.2" xmlns="http://www.w3.org/1999/xhtml">Each module is independent, making modules loosely coupled. </span><span class="koboSpan" id="kobo.560.3" xmlns="http://www.w3.org/1999/xhtml">Its simple deployment model leads to cost-effective hosting and ease of deployment.</span></li>
<li><span class="koboSpan" id="kobo.561.1" xmlns="http://www.w3.org/1999/xhtml">Traditional monolithic architectures build the application as a single, indivisible unit, often resulting in tightly coupled functionalities.</span></li>
<li><span class="koboSpan" id="kobo.562.1" xmlns="http://www.w3.org/1999/xhtml">False. </span><span class="koboSpan" id="kobo.562.2" xmlns="http://www.w3.org/1999/xhtml">Poorly defined module boundaries hinder the health of the application.</span></li>
<li><span class="koboSpan" id="kobo.563.1" xmlns="http://www.w3.org/1999/xhtml">True. </span><span class="koboSpan" id="kobo.563.2" xmlns="http://www.w3.org/1999/xhtml">Even if a well-conceived Modular Monolith can help, the transition will be a journey.</span></li>
</ol>
</section>
</section>
</body>
</html>
