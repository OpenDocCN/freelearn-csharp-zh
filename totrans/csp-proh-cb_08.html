<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Code Contracts"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Code Contracts</h1></div></div></div><p>This chapter will introduce you to code contracts. This is a very powerful technology and one that will enable<a class="indexterm" id="id522"/> you to secure your code from unnecessary errors. This is especially true when you are writing a class that is shared between several developers. Code contracts allow you to inspect and handle data passed to your method under contract. If the contract fails its validation, you can take decisive action within your method to handle this eventuality. This chapter will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Downloading, installing, and integrating code contracts into Visual Studio</li><li class="listitem" style="list-style-type: disc">Creating code contract preconditions</li><li class="listitem" style="list-style-type: disc">Creating code contract postconditions</li><li class="listitem" style="list-style-type: disc">Creating code contract invariant</li><li class="listitem" style="list-style-type: disc">Creating code contract <code class="literal">Assert</code> and <code class="literal">Assume</code> methods</li><li class="listitem" style="list-style-type: disc">Creating code contract <code class="literal">ForAll</code> method</li><li class="listitem" style="list-style-type: disc">Creating code contract <code class="literal">ValueAtReturn</code> method</li><li class="listitem" style="list-style-type: disc">Creating code contract <code class="literal">Result</code> method</li><li class="listitem" style="list-style-type: disc">Using code contracts on abstract classes</li><li class="listitem" style="list-style-type: disc">Using contract abbreviator methods</li><li class="listitem" style="list-style-type: disc">Creating tests using IntelliTest</li><li class="listitem" style="list-style-type: disc">Using code contracts in extension methods</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec56"/>Introduction</h1></div></div></div><p>You might be wondering what code contracts are exactly. To explain it in layman's terms, a code contract is a definition that you add to your methods. It tells the compilers that the method under contract will always adhere to specific conditions. An example of this is that the method will never return a null value to the calling code or that the method will always expect a parameter greater than a specific value. If any of these conditions are not met, your code can emit an exception, and the developer integrating with your class will be prompted to refine their calling code. On the flip side, when a developer calls your class, they can be sure that the method under contract will always behave in a specific way and never deviate from it.</p><p>Code contracts really <a class="indexterm" id="id523"/>stand out when working within a team of developers, but implementing this technology in a single-developer solution will only improve your code.</p></div></div>
<div class="section" title="Downloading, installing, and integrating code contracts into Visual Studio"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec57"/>Downloading, installing, and integrating code contracts into Visual Studio</h1></div></div></div><p>Before you can use <a class="indexterm" id="id524"/>code contracts in your applications, you need to<a class="indexterm" id="id525"/> download and install them. The easiest way of doing this is via extensions and updates. After the installation is complete, you will need to<a class="indexterm" id="id526"/> define a few settings for the code <a class="indexterm" id="id527"/>contracts to start functioning against the code they are implemented in. Let's have a look at the following recipe.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec132"/>Getting ready</h2></div></div></div><p>First, we will create a new class and add it to our Visual Studio project. We will then get the Code Contracts installer and install it for our project.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec133"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new class by right-clicking on your solution and selecting <span class="strong"><strong>Add</strong></span> and then <span class="strong"><strong>New Project</strong></span> from the context menu:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_01.jpg"/></div></li><li class="listitem">From the<a class="indexterm" id="id528"/> <span class="strong"><strong>Add New Project</strong></span> dialog screen, select <a class="indexterm" id="id529"/><span class="strong"><strong>Class Library</strong></span> from the installed<a class="indexterm" id="id530"/> templates and call your class <code class="literal">Chapter8</code>:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_02.jpg"/></div></li><li class="listitem">Your new class<a class="indexterm" id="id531"/> library will be added to your solution <a class="indexterm" id="id532"/>with a default name of <code class="literal">Class1.cs</code>, which we renamed to <code class="literal">Recipes.cs</code> in order to distinguish the code properly. You can, however, rename your class to whatever<a class="indexterm" id="id533"/> you like.</li><li class="listitem">To rename your class, simply click on the class name in <span class="strong"><strong>Solution Explorer</strong></span> and select <span class="strong"><strong>Rename</strong></span> from the context menu:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_03.jpg"/></div></li><li class="listitem">Visual Studio <a class="indexterm" id="id534"/>will ask you to confirm a rename <a class="indexterm" id="id535"/>of all references to<a class="indexterm" id="id536"/> the code element <span class="strong"><strong>Class1</strong></span> in the project. Just click on <span class="strong"><strong>Yes</strong></span>:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_04.jpg"/></div></li><li class="listitem">Next, click <a class="indexterm" id="id537"/>on the <span class="strong"><strong>Tools</strong></span> menu and select <a class="indexterm" id="id538"/><span class="strong"><strong>Extensions and Updates…</strong></span>:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_05.jpg"/></div></li><li class="listitem">You will see the <a class="indexterm" id="id539"/><span class="strong"><strong>Extensions and Updates</strong></span> window appear. Be sure to click on the <span class="strong"><strong>Visual Studio Gallery</strong></span> on the left-hand side and type <code class="literal">Code Contracts</code> as the search term. If you<a class="indexterm" id="id540"/> have not got the Code Contracts installer, you will see a download button<a class="indexterm" id="id541"/> appear on the <span class="strong"><strong>Code Contracts for .NET</strong></span> result. Click on it to download and install code contracts:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_06.jpg"/></div></li><li class="listitem">After code<a class="indexterm" id="id542"/> contracts have been installed, you might need to restart Visual Studio. After doing this, right-click on the <code class="literal">Chapter8</code> project and select <span class="strong"><strong>Properties</strong></span> from the context menu:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_07.jpg"/></div></li><li class="listitem">You will <a class="indexterm" id="id543"/>notice that a new <span class="strong"><strong>Code Contracts</strong></span> tab has been added to the properties page for your <code class="literal">Chapter8</code> project. Click<a class="indexterm" id="id544"/> on this tab and make sure that <span class="strong"><strong>Perform Runtime Contract Checking</strong></span> is checked. Then, save your<a class="indexterm" id="id545"/> changes and close the properties page:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_08.jpg"/></div></li><li class="listitem">Finally, add a reference to your <code class="literal">Chapter8</code> project in the console application created earlier. Do<a class="indexterm" id="id546"/> this by expanding <a class="indexterm" id="id547"/>your console application project and right-clicking on the <span class="strong"><strong>References</strong></span> item. Select <span class="strong"><strong>Add Reference</strong></span> from the context menu:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_09.jpg"/></div></li><li class="listitem">Make sure that you<a class="indexterm" id="id548"/> have selected <code class="literal">Chapter8</code> in the project references section and click on <span class="strong"><strong>OK</strong></span>:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_10.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec134"/>How it works…</h2></div></div></div><p>You have now installed<a class="indexterm" id="id549"/> and configured the minimum requirements<a class="indexterm" id="id550"/> to enable code contracts in your <code class="literal">Chapter8</code> class. You can now go ahead and build your solution to make sure that<a class="indexterm" id="id551"/> everything builds successfully.</p></div></div>
<div class="section" title="Creating code contract preconditions"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec58"/>Creating code contract preconditions</h1></div></div></div><p>Preconditions allow<a class="indexterm" id="id552"/> you to control exactly what the parameters need to look like before they are used in your method. This means that you can assume a lot<a class="indexterm" id="id553"/> of things about the data being sent to your method by the calling code. You can, for example, specify that a parameter should never be null or that a value must always be within a specific value range. Dates can be checked, and objects can be verified and vetted.</p><p>You have complete control over the data coming in to your method. It gives you the peace of mind to use that data once it has passed your contract without having to do additional checks.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec135"/>Getting ready</h2></div></div></div><p>Be sure that you have installed code contracts and that you have configured the settings correctly in the project properties, as described in the previous recipe.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec136"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In your <code class="literal">Recipes</code> class, create a new method called <code class="literal">ValueGreaterThanZero()</code> and have it take an integer as a parameter:<div class="informalexample"><pre class="programlisting">public static class Recipes
{
    public static void ValueGreaterThanZero(int iNonZeroValue)
    {
           
    }
}</pre></div></li><li class="listitem">In the <code class="literal">ValueGreaterThanZero()</code> method, type the start of the <code class="literal">Contract</code> declaration, and <a class="indexterm" id="id554"/>you will notice that the code is <a class="indexterm" id="id555"/>underlined with a red squiggly line. Hold down <span class="emphasis"><em>Crtl</em></span> + <span class="emphasis"><em>.</em></span> (period) to bring up the suggestions for potential fixes. Click on the suggestion to add the <code class="literal">using</code> statement for the code contracts to your class:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_11.jpg"/></div></li><li class="listitem">When you have done that, continue entering the precondition. Define that the parameter value must be greater than zero:<div class="informalexample"><pre class="programlisting">public static void ValueGreaterThanZero(int iNonZeroValue)
{
    Contract.Requires(iNonZeroValue &gt;= 1, "Parameter iNonZeroValue not greater than zero");
}</pre></div></li><li class="listitem">If you go back to the console application, add the following <code class="literal">using</code> statements:<div class="informalexample"><pre class="programlisting">using static System.Console;
using static Chapter8.Recipes;</pre></div></li><li class="listitem">Since we have<a class="indexterm" id="id556"/> created a static class and brought it into <a class="indexterm" id="id557"/>scope with the <code class="literal">using</code> statement, you can just call the method name in the <code class="literal">Recipes</code> class directly. To see how code contracts work, pass a zero parameter to the method:<div class="informalexample"><pre class="programlisting">try
{
    ValueGreaterThanZero(0);
}
catch (Exception ex)
{
    WriteLine(ex.Message);
    ReadLine();
}</pre></div></li><li class="listitem">Finally, run your console application and see the exception generated:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_12.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec137"/>How it works…</h2></div></div></div><p>The code contract has inspected the precondition and determined that the parameter value passed to the method under<a class="indexterm" id="id558"/> contract failed the precondition check. An exception is thrown and output to the console window.</p></div></div>
<div class="section" title="Creating code contract postconditions"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec59"/>Creating code contract postconditions</h1></div></div></div><p>Just as code contract <a class="indexterm" id="id559"/>preconditions control what information is passed to the method under contract, code contract postconditions control what information the method under contract returns to the calling code. You can, therefore, specify that the method will never return a null value or an empty dataset, for example. The actual <a class="indexterm" id="id560"/>condition does not matter; this is something that will change on a case-by-case basis. The important thing to remember here is that this code contract allows you to have more control over the data returned by your code.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec138"/>Getting ready</h2></div></div></div><p>Assume that the method under contract needs to ensure that the value returned will always be greater than zero. Using a code contract postcondition, we can easily enforce this rule.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec139"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before you start, make sure that you have added the following <code class="literal">using</code> statement to the top of your <code class="literal">Recipes</code> class:<div class="informalexample"><pre class="programlisting">using System.Diagnostics.Contracts;</pre></div></li><li class="listitem">In the <code class="literal">Recipes</code> class, add a method called <code class="literal">NeverReturnZero()</code> and pass an integer parameter to this method:<div class="informalexample"><pre class="programlisting">public static class Recipes
{
    public static int NeverReturnZero(int iNonZeroValue)
    {
           
    }
}</pre></div></li><li class="listitem">Inside the method, add your postcondition contract. As one could expect, the method in the contract class is called <code class="literal">Ensures</code>. This is quite descriptive of its function. The code contract ensures that a specific method result is never returned. You can see this in the signature of the <code class="literal">Contract.Ensures</code> method. The postcondition, therefore, ensures that the result of this method will never be zero:<div class="informalexample"><pre class="programlisting">public static int NeverReturnZero(int iNonZeroValue)
{
    Contract.Ensures(Contract.Result&lt;int&gt;() &gt; 0, "The value returned was not greater than zero");
            
    return iNonZeroValue - 1;
}</pre></div></li><li class="listitem">Go back to the console application, and add the following <code class="literal">using</code> statements:<div class="informalexample"><pre class="programlisting">using static System.Console;
using static Chapter8.Recipes;</pre></div></li><li class="listitem">Since you have <a class="indexterm" id="id561"/>created a static class and brought it into scope with the <code class="literal">using</code> statement, you can just call the method name in the <code class="literal">Recipes</code> class directly. Pass the <code class="literal">NeverReturnZero()</code> method a value of <code class="literal">1</code>:<div class="informalexample"><pre class="programlisting">try
{
    NeverReturnZero(1);
}
catch (Exception ex)
{
    WriteLine(ex.Message);
    ReadLine();
}</pre></div></li><li class="listitem">Finally, run your console application and review the output in the console window:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_13.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec140"/>How it works…</h2></div></div></div><p>When the value of <code class="literal">1</code> was<a class="indexterm" id="id562"/> passed to the method under contract, it resulted in a return value of zero being returned. We forced this by subtracting <code class="literal">1</code> from the parameter passed to the method. As the method ensures non-zero values, an exception was thrown with the message we defined.</p></div></div>
<div class="section" title="Creating code contract invariant"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec60"/>Creating code contract invariant</h1></div></div></div><p>Something that is<a class="indexterm" id="id563"/> defined as invariant tells us that it will never change. It will always be the same, no matter what. This brings up a vast array of use cases if we consider this in the context of code contracts. The invariant code contract is basically used to validate the internal state of a class. So, what do we mean by the "internal state?" Well, the<a class="indexterm" id="id564"/> properties of the class give that class a specific state. Let's assume that we wanted to guarantee that the properties of the class we are using only accept specific values, thereby assuring the internal state of that class. This is where the code contract invariant comes into play.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec141"/>Getting ready</h2></div></div></div><p>You can understand the use of the invariant better with the use of the following example. Assume that the class needs to store dates. We can't ever store a date in the past though. Any date used in the class must be a current or future date.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec142"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before you go on, ensure that you have added the code contracts <code class="literal">using</code> statement to the top of your <code class="literal">Recipes.cs</code> class file:<div class="informalexample"><pre class="programlisting">using System.Diagnostics.Contracts;</pre></div></li><li class="listitem">Next, we will add a new class called <code class="literal">InvariantClassState</code> to the <code class="literal">Recipes.cs</code> class file. This is so that we can create an instance class and not a static class:<div class="informalexample"><pre class="programlisting">public class InvariantClassState
{
    
}</pre></div></li><li class="listitem">Add the following <code class="literal">private</code> properties to your <code class="literal">InvariantClassState</code> class that will accept integer values for the year, month, and day:<div class="informalexample"><pre class="programlisting">private int _Year { get; set; }
private int _Month { get; set; }
private int _Day { get; set; }</pre></div></li><li class="listitem">We will now add a constructor to our <code class="literal">InvariantClassState</code> class. The constructor will accept parameters to set the properties created earlier:<div class="informalexample"><pre class="programlisting">public InvariantClassState(int year, int month, int day)
{
    _Year = year;
    _Month = month;
    _Day = day;
}</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note30"/>Note</h3><p>If you create <code class="literal">public</code> properties, it is always a good practice to create them with <code class="literal">private</code> setters such as <code class="literal">public int Value { get; private set; }</code>.</p></div></div></li><li class="listitem">The next method we need to add is the contract invariant method. You can call this method any name you like, and in this example, it is called <code class="literal">Invariants()</code>. You will read many developers stating that a commonly accepted practice is to call this method <code class="literal">ObjectInvariant()</code>. The naming of this method, however, has no impact on the invariant code contract. You will notice that we <a class="indexterm" id="id565"/>decorate this method with <code class="literal">[ContractInvariantMethod]</code>, and it is this that defines this method (whatever the name) as the<a class="indexterm" id="id566"/> invariant code contract. Another important thing to remember is that the invariant code contract method must be a <code class="literal">void</code> method and be specified as a <code class="literal">private</code> method.<p>Inside our code contract invariant method, we now specify which properties are invariant. In other words, those properties that can never be any other value than what we specify inside this code contract invariant method. For starters, we will specify that the year value cannot be in the past. We will also ensure that the month value is a valid value between <code class="literal">1</code> and <code class="literal">12</code>. Finally, we will specify that the day value cannot be a value outside the days contained in the month supplied or a value less than <code class="literal">1</code>:</p><div class="informalexample"><pre class="programlisting">[ContractInvariantMethod]
private void Invariants()
{
    Contract.Invariant(this._Year &gt;= DateTime.Now.Year);
    Contract.Invariant(this._Month &lt;= 12);
    Contract.Invariant(this._Month &gt;= 1);
    Contract.Invariant(this._Day &gt;= 1);
    Contract.Invariant(this._Day &lt;= DateTime.DaysInMonth(_Year, _Month);
}</pre></div></li><li class="listitem">You can further extend the <code class="literal">Contract.Invariant</code> methods by supplying an exception message. Your <code class="literal">Invariants()</code> method will then look like this:<div class="informalexample"><pre class="programlisting">[ContractInvariantMethod]
private void Invariants()
{
    Contract.Invariant(this._Year &gt;= DateTime.Now.Year, "The supplied year is in the past");
    Contract.Invariant(this._Month &lt;= 12, $"The value {_Month} is not a valid Month value");
    Contract.Invariant(this._Month &gt;= 1, $"The value {_Month} is not a valid Month value");
    Contract.Invariant(this._Day &gt;= 1, $"The value {_Day} is not a valid calendar value");
    Contract.Invariant(this._Day &lt;= DateTime.DaysInMonth(_Year, _Month), $"The month given does not contain {_Day} days");
}</pre></div></li><li class="listitem">Finally, add another<a class="indexterm" id="id567"/> method that returns the date formatted as month/day/year:<div class="informalexample"><pre class="programlisting">public string ReturnGivenMonthDayYearDate()
{            
    return $"{_Month}/{_Day}/{_Year}";
}</pre></div></li><li class="listitem">When you <a class="indexterm" id="id568"/>are finished, your <code class="literal">InvariantClassState</code> class will look like this:<div class="informalexample"><pre class="programlisting">public class InvariantClassState
{
    private int _Year { get; set; }
    private int _Month { get; set; }
    private int _Day { get; set; }

    public InvariantClassState(int year, int month, int day)
    {
        _Year = year;
        _Month = month;
        _Day = day;
    }

    [ContractInvariantMethod]
    private void Invariants()
    {
        Contract.Invariant(this._Year &gt;= DateTime.Now.Year, "The supplied year is in the past");
        Contract.Invariant(this._Month &lt;= 12, $"The value {_Month} is not a valid Month value");
        Contract.Invariant(this._Month &gt;= 1, $"The value {_Month} is not a valid Month value");
        Contract.Invariant(this._Day &gt;= 1, $"The value {_Day} is not a valid calendar value");
        Contract.Invariant(this._Day &lt;= DateTime.DaysInMonth(_Year, _Month), $"The month given does not contain {_Day} days");
    }

    public string ReturnGivenMonthDayYearDate()
    {            
        return $"{_Month}/{_Day}/{_Year}";
    }
}</pre></div></li><li class="listitem">Head back to the<a class="indexterm" id="id569"/> console application and add the following <code class="literal">using</code> statement to your console application <code class="literal">Program.cs</code> file:<div class="informalexample"><pre class="programlisting">using Chapter8;</pre></div></li><li class="listitem">We will now add <a class="indexterm" id="id570"/>a new instance of our <code class="literal">InvariantStateClass</code> class and pass the values to the constructor. First, pass the current year less than <code class="literal">1</code> to the constructor. This will result in the last year being passed to the constructor:<div class="informalexample"><pre class="programlisting">try
{
    InvariantClassState oInv = new InvariantClassState(DateTime.Now.Year - 1, 13, 32);
    string returnedDate = oInv.ReturnGivenMonthDayYearDate();
    WriteLine(returnedDate);
}
catch (Exception ex)
{
    WriteLine(ex.Message);                
}
ReadLine();</pre></div></li><li class="listitem">Running your console application will result in the code contract invariant throwing an exception because the year passed to the constructor is in the past:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_14.jpg"/></div></li><li class="listitem">Let's modify our code by passing a valid year value to the constructor, but keep the rest of the parameter values the same:<div class="informalexample"><pre class="programlisting">try
{
    InvariantClassState oInv = new InvariantClassState(DateTime.Now.Year, 13, 32);
    string returnedDate = oInv.ReturnGivenMonthDayYearDate();

    WriteLine(returnedDate);
}
catch (Exception ex)
{
    WriteLine(ex.Message);                
}
ReadLine();</pre></div></li><li class="listitem">Running the <a class="indexterm" id="id571"/>console application will again result in an<a class="indexterm" id="id572"/> exception message stating that the month value cannot be greater then <code class="literal">12</code>:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_15.jpg"/></div></li><li class="listitem">Once again, modify the parameters passed to the method and supply a valid year and month value, but pass an invalid day value:<div class="informalexample"><pre class="programlisting">try
{
    InvariantClassState oInv = new InvariantClassState(DateTime.Now.Year, 11, 32);
    string returnedDate = oInv.ReturnGivenMonthDayYearDate();

    WriteLine(returnedDate);
}
catch (Exception ex)
{
    WriteLine(ex.Message);                
}
ReadLine();</pre></div></li><li class="listitem">Running the console<a class="indexterm" id="id573"/> application again will result in the code contract invariant throwing an exception because the day is clearly wrong. No month contains 32 days:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_16.jpg"/></div></li><li class="listitem">Modify the<a class="indexterm" id="id574"/> parameters passed to the constructor again, and this time, add valid values for year, month, and day:<div class="informalexample"><pre class="programlisting">try
{
    InvariantClassState oInv = new InvariantClassState(DateTime.Now.Year, 11, 25);
    string returnedDate = oInv.ReturnGivenMonthDayYearDate();

    WriteLine(returnedDate);
}
catch (Exception ex)
{
    WriteLine(ex.Message);                
}
ReadLine();</pre></div></li><li class="listitem">Because November 25, 2016 is a valid date (because the current year is 2016), the formatted date is returned to the console application window:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_17.jpg"/></div></li><li class="listitem">Let's mix things up<a class="indexterm" id="id575"/> a little by passing 29 February, 2017 to the constructor:<div class="informalexample"><pre class="programlisting">try
{
    InvariantClassState oInv = new InvariantClassState(DateTime.Now.Year + 1, 2, 29);
    string returnedDate = oInv.ReturnGivenMonthDayYearDate();

    WriteLine(returnedDate);
}
catch (Exception ex)
{
    WriteLine(ex.Message);                
}
ReadLine();</pre></div></li><li class="listitem">Again, the<a class="indexterm" id="id576"/> code contract invariant method throws an exception because 2017 is not a leap year:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_18.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec143"/>How it works…</h2></div></div></div><p>The code contract invariant method is a simple yet effective way to ensure that the state of your class is not modified. You can then assume that the properties you use inside your class are always correct and will never contain unexpected values. We like to think of the code contract invariant as a<a class="indexterm" id="id577"/> type of immutable (which it isn't). Strings are immutable, which means that the original value is never modified when the value changes. A new space in memory is always created when you change the value of a<a class="indexterm" id="id578"/> string. Similarly, this reminds me of the properties defined as invariant. These property values can never change to values other than those defined by our code contract invariant method.</p></div></div>
<div class="section" title="Creating code contract Assert and Assume methods"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec61"/>Creating code contract Assert and Assume methods</h1></div></div></div><p>The code <a class="indexterm" id="id579"/>contract <code class="literal">Assert</code> and <code class="literal">Assume</code> methods might seem confusing at first, but both <a class="indexterm" id="id580"/>provide a specific function. Where the previous code contract conditions had to appear at the beginning of the methods they<a class="indexterm" id="id581"/> were defined in, the <code class="literal">Assert</code> method can be placed somewhere<a class="indexterm" id="id582"/> inside a method. This means that it will have an effect on the code at that specific time in the compilation. If you, for example, perform a calculation somewhere in your method under <a class="indexterm" id="id583"/>contract and you need to check<a class="indexterm" id="id584"/> the value calculated, you can use <code class="literal">Assert</code> to perform a check in place to ascertain whether the calculated value passes the contract.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note31"/>Note</h3><p>Don't confuse <code class="literal">Debug.Assert</code> with <code class="literal">Contract.Assert</code>. They aren't the same thing. <code class="literal">Debug.Assert</code> will only have an effect if your code is run in the <span class="strong"><strong>Debug</strong></span> mode. <code class="literal">Contract.Assert</code> will run in the <span class="strong"><strong>Debug</strong></span> and <span class="strong"><strong>Release</strong></span> modes.</p></div></div><p>With <code class="literal">Contract.Assume</code>, however, we are telling the code contract that it needs to assume that the condition it needs to check is true. This is only applicable when the static checker is switched on, and this will become clearer in this recipe.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec144"/>Getting ready</h2></div></div></div><p>We will use the same method under contract to illustrate the use of <code class="literal">Assert</code> and <code class="literal">Assume</code> methods with the static checker switched on.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec145"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before you go on, ensure that you have added the code contracts <code class="literal">using</code> statement to the top of your <code class="literal">Recipes.cs</code> class file:<div class="informalexample"><pre class="programlisting">using System.Diagnostics.Contracts;</pre></div></li><li class="listitem">Add a method <a class="indexterm" id="id585"/>called <code class="literal">ValueIsValid()</code> to the class, which accepts two integer parameters:<div class="informalexample"><pre class="programlisting">public static int ValueIsValid(int valueForCalc, int valueToDivide)
{
    
}</pre></div></li><li class="listitem">To this method, add a<a class="indexterm" id="id586"/> calculation (it appears first in the method before the contract) that subtracts <code class="literal">1</code> from the <code class="literal">valueForCalc</code> parameter. The <code class="literal">Contract.Assert</code> method is placed after the calculation to check the value of the calculated value. We want to ensure that the value is not zero:<div class="informalexample"><pre class="programlisting">public static int ValueIsValid(int valueForCalc, int valueToDivide)
{
    int calculatedVal = valueForCalc - 1;
    Contract.Assert(calculatedVal &gt;= 1, "Calculated value will result in divide by zero exception.");
    return valueToDivide / calculatedVal;
}</pre></div></li><li class="listitem">In the console application, add the relevant <code class="literal">using</code> statement to the <code class="literal">Program.cs</code> class to<a class="indexterm" id="id587"/> bring the static class into scope:<div class="informalexample"><pre class="programlisting">using static Chapter8.Recipes;</pre></div></li><li class="listitem">Call the <code class="literal">ValueIsValid()</code> method by passing two integer values to it. As you can see, the<a class="indexterm" id="id588"/> first parameter will result in a zero value being calculated inside the method under contract:<div class="informalexample"><pre class="programlisting">try
{
    int calcVal = ValueIsValid(1, 9);
}
catch (Exception ex)
{
    WriteLine(ex.Message);
    ReadLine();
}</pre></div></li><li class="listitem">Run your console application and inspect the output window. We can see that the <code class="literal">Assert</code> contract <a class="indexterm" id="id589"/>correctly threw an exception because the calculated value was zero:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_19.jpg"/></div></li><li class="listitem">However, what if we<a class="indexterm" id="id590"/> want our code to be checked when we build our application? This is<a class="indexterm" id="id591"/> where the static checker <a class="indexterm" id="id592"/>comes into play. Right-click on the <code class="literal">Chapter8</code> project and select <span class="strong"><strong>Properties</strong></span>:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_20.jpg"/></div></li><li class="listitem">Click on the <a class="indexterm" id="id593"/><span class="strong"><strong>Code Contracts</strong></span> tab and select the checkbox next to<a class="indexterm" id="id594"/> <span class="strong"><strong>Perform Static Contract Checking</strong></span>. Also, uncheck the <span class="strong"><strong>Check in background</strong></span> box and select <span class="strong"><strong>Fail build on warnings</strong></span>. Moreover, set <span class="strong"><strong>Warning Level</strong></span> to <span class="strong"><strong>hi</strong></span>:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_21.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note32"/>Note</h3><p>We assume<a class="indexterm" id="id595"/> that the developers of Code Contracts<a class="indexterm" id="id596"/> meant to make the warning level between low<a class="indexterm" id="id597"/> and high. "Hi" is probably a typo in the code.</p></div></div></li><li class="listitem">Save your code <a class="indexterm" id="id598"/>contract settings and run your console application. You will notice that your build fails:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_22.jpg"/></div></li><li class="listitem">If we have a<a class="indexterm" id="id599"/> look at the <code class="literal">ValueIsValid()</code> method, we can see that the static checker has<a class="indexterm" id="id600"/> identified that the method under contract<a class="indexterm" id="id601"/> needs an additional <a class="indexterm" id="id602"/>contract defined. The static checker has identified that we need to add <code class="literal">Contract.Requires</code> to our method to check whether the <code class="literal">valueForCalc</code> parameter is greater than zero:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_23.jpg"/></div></li><li class="listitem">If we had to correct this, we would add <code class="literal">Contract.Requires</code> to the method as follows:<div class="informalexample"><pre class="programlisting">public static int ValueIsValid(int valueForCalc, int valueToDivide)
{
    Contract.Requires((valueForCalc - 1) &gt;= 1);
    int calculatedVal = valueForCalc - 1;
    Contract.Assert(calculatedVal &gt;= 1, "Calculated value will result in divide by zero exception.");
    return valueToDivide / calculatedVal;
}</pre></div></li><li class="listitem">For now, let's ignore the recommendation of the static checker and, instead, add <code class="literal">Contract.Assume</code> to our method. Here, we are telling the static checker to assume that the value will never be zero after the calculation is done on the <code class="literal">valueForCalc</code> parameter:<div class="informalexample"><pre class="programlisting">public static int ValueIsValid(int valueForCalc, int valueToDivide)
{
    Contract.Assume((valueForCalc - 1) &gt;= 1);
    int calculatedVal = valueForCalc - 1; 
    Contract.Assert(calculatedVal &gt;= 1, "Calculated value will result in divide by zero exception.");
    return valueToDivide / calculatedVal; 
}</pre></div></li><li class="listitem">If we run our<a class="indexterm" id="id603"/> console application again, we<a class="indexterm" id="id604"/> will get a clean build, because<a class="indexterm" id="id605"/> the static checker assumes that you<a class="indexterm" id="id606"/> know best and that the value will never equal zero after the calculation. If, however, the calculated value turns out to be zero, <code class="literal">Assume</code> still checks the value at runtime and will throw an exception if the value equals zero:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_24.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec146"/>How it works…</h2></div></div></div><p>You might be wondering what the use of <code class="literal">Assume</code> in code contracts is. As it turns out, this is quite useful when working with code that you have no control over. If you implement code that you can't edit or that does not contain code contracts, you can tell the static checker to ignore specific portions of the code that produce errors based on the check it does.</p></div></div>
<div class="section" title="Creating code contract ForAll method"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec62"/>Creating code contract ForAll method</h1></div></div></div><p>If this code contract<a class="indexterm" id="id607"/> sounds like it is validating some or the other collection, then you would be correct. The code contract <code class="literal">ForAll</code> will perform validation of <code class="literal">IEnumerable</code> collections. This is very handy, because as a developer, you do not need to <a class="indexterm" id="id608"/>do any kind of iteration over the collection and writing validation logic. This contract does it for you.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec147"/>Getting ready</h2></div></div></div><p>We will create a simple list of integers and populate the list with values. Our code contract will validate that the list does not contain any zero values.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec148"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before you go on, ensure that you have added the code contracts <code class="literal">using</code> statement to the top of your <code class="literal">Recipes.cs</code> class file:<div class="informalexample"><pre class="programlisting">using System.Diagnostics.Contracts;</pre></div></li><li class="listitem">Add a method called <code class="literal">ValidateList()</code> to your class and pass a <code class="literal">List&lt;int&gt;</code> collection to it:<div class="informalexample"><pre class="programlisting">public static void ValidateList(List&lt;int&gt; lstValues)
{
    
}</pre></div></li><li class="listitem">Inside the <code class="literal">ValidateList()</code> method, add the <code class="literal">Contract.ForAll</code> contract. Interestingly, you will notice that we are using <code class="literal">Contract.Assert</code> here to check whether this list passes our contract conditions. The <code class="literal">Contract.ForAll</code> will use a lambda expression to check that none of the values contained in our list of integers equals zero:<div class="informalexample"><pre class="programlisting">public static void ValidateList(List&lt;int&gt; lstValues)
{
    Contract.Assert(Contract.ForAll(lstValues, n =&gt; n != 0), "Zero values are not allowed");
}</pre></div></li><li class="listitem">In the console application, add the relevant <code class="literal">using</code> statement to the <code class="literal">Program.cs</code> class to bring the static class into scope:<div class="informalexample"><pre class="programlisting">using static Chapter8.Recipes;</pre></div></li><li class="listitem">You can then add a simple list of integers containing at least one zero value and pass it to the <code class="literal">ValidateList()</code> method:<div class="informalexample"><pre class="programlisting">try
{
    List&lt;int&gt; intList = new List&lt;int&gt;();
    int[] arr;
    intList.AddRange(arr = new int[] { 1, 3, 2, 6, 0, 5});
    ValidateList(intList);
}
catch (Exception ex)
{
    WriteLine(ex.Message);
    ReadLine();
}</pre></div></li><li class="listitem">Run the<a class="indexterm" id="id609"/> console application and inspect the results in<a class="indexterm" id="id610"/> the output:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_25.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec149"/>How it works…</h2></div></div></div><p>We can see that the <code class="literal">ForAll</code> contract has worked exactly as we had expected. This is an extremely useful code contract to use, especially since you need not add copious amounts of boilerplate code to check the collection for various invalid values.</p></div></div>
<div class="section" title="Creating code contract ValueAtReturn method"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec63"/>Creating code contract ValueAtReturn method</h1></div></div></div><p>The best <a class="indexterm" id="id611"/>example we can think of when using the code <a class="indexterm" id="id612"/>contract <code class="literal">ValueAtReturn</code> is <code class="literal">out</code> parameters. Personally, I do not use <code class="literal">out</code> parameters often, but there are times when you need to use them. Code contracts make provision for this, and you can check the value at the time it is returned.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec150"/>Getting ready</h2></div></div></div><p>We will create a simple method that subtracts a value from a parameter. The <code class="literal">out</code> parameter will be validated by the code contract, and the result will be output to the console window.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec151"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before you go<a class="indexterm" id="id613"/> on, ensure that you have added the code contracts <code class="literal">using</code> statement to the top of your <code class="literal">Recipes.cs</code> class file:<div class="informalexample"><pre class="programlisting">using System.Diagnostics.Contracts;</pre></div></li><li class="listitem">In the <code class="literal">Recipes</code> class, create a new method called <code class="literal">ValidOutValue()</code> and pass an <code class="literal">out</code> parameter called <code class="literal">secureValue</code> to it:<div class="informalexample"><pre class="programlisting">public static void ValidOutValue(out int secureValue)
{
    
}</pre></div></li><li class="listitem">Finally, add <code class="literal">Contract.ValueAtReturn</code> to the method. Interestingly, you will note that<a class="indexterm" id="id614"/> this needs to be contained in <code class="literal">Contract.Ensures</code>. This actually makes sense, because the code contract ensures that the value that we will return will adhere to a specific condition:<div class="informalexample"><pre class="programlisting">public static void ValidOutValue(out int secureValue)
{
    Contract.Ensures(Contract.ValueAtReturn&lt;int&gt;(out secureValue) &gt;= 1, "The secure value is less or equal to zero");
    secureValue = secureValue - 10;
}</pre></div></li><li class="listitem">In the console application, add the relevant <code class="literal">using</code> statement to the <code class="literal">Program.cs</code> class to bring the static class into scope:<div class="informalexample"><pre class="programlisting">using static Chapter8.Recipes;</pre></div></li><li class="listitem">Then, add some code to call the <code class="literal">ValidOutValue()</code> method and pass an <code class="literal">out</code> parameter to it:<div class="informalexample"><pre class="programlisting">try
{
    int valueToCheck = 5;
    ValidOutValue(out valueToCheck);
    WriteLine("The value is not zero");
}
catch (Exception ex)
{
    WriteLine(ex.Message);
}
ReadLine();</pre></div></li><li class="listitem">Run the console application and inspect the results in the output window:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_26.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec152"/>How it works…</h2></div></div></div><p>We can see<a class="indexterm" id="id615"/> that the <code class="literal">out</code> parameter has been successfully validated. As<a class="indexterm" id="id616"/> soon as the condition was not met, the code contract threw an exception that we were able to catch.</p></div></div>
<div class="section" title="Creating code contract Result method"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec64"/>Creating code contract Result method</h1></div></div></div><p>Sometimes, we simply <a class="indexterm" id="id617"/>want a way to validate the result of a method. We want to be able to check what is returned and validate it against some or the other condition. It is here that the <a class="indexterm" id="id618"/>code contract <code class="literal">Result</code> can be used. It will inspect the value returned by the method under contract against the contract specified, and then it will succeed or fail.</p><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec153"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before you go on, ensure that you have added the code contracts <code class="literal">using</code> statement to the top of your <code class="literal">Recipes.cs</code> class file:<div class="informalexample"><pre class="programlisting">using System.Diagnostics.Contracts;</pre></div></li><li class="listitem">In the <code class="literal">Recipes</code> class, add a new method called <code class="literal">ValidateResult()</code> that takes two integer values as parameters:<div class="informalexample"><pre class="programlisting">public static int ValidateResult(int value1, int value2)
{
    
}</pre></div></li><li class="listitem">To this method, add the <a class="indexterm" id="id619"/>code contract <code class="literal">Result</code> that checks the resultant value of the method. It has to be mentioned that the code contract <code class="literal">Result</code> can never be used in a <code class="literal">void</code> method. This is obvious, because the very purpose of this code contract is to examine and validate the result of a method. You will also notice that the code contract <code class="literal">Result</code> method is used in conjunction with the <code class="literal">Contract.Ensures</code> method. The format of <code class="literal">Contract.Result</code> is made up of the return type <code class="literal">&lt;int&gt;()</code> and the condition <code class="literal">&gt;= 0</code> that the return value needs to adhere to:<div class="informalexample"><pre class="programlisting">public static int ValidateResult(int value1, int value2)
{
    Contract.Ensures(Contract.Result&lt;int&gt;() &gt;= 0, "Negative result not allowed");
    return value1 - value2;
}</pre></div></li><li class="listitem">In the console<a class="indexterm" id="id620"/> application, add the relevant <code class="literal">using</code> statement to the <code class="literal">Program.cs</code> class to bring the static class into scope:<div class="informalexample"><pre class="programlisting">using static Chapter8.Recipes;</pre></div></li><li class="listitem">Add the call to the static method under contract and pass to it parameters that will cause the code contract to throw an exception. In this case, we are passing <code class="literal">10</code> and <code class="literal">23</code>, which will result in a negative result being returned from the <code class="literal">ValidateResult()</code> method:<div class="informalexample"><pre class="programlisting">try
{
    WriteLine(ValidateResult(10, 23));
}
catch (Exception ex)
{
    WriteLine(ex.Message);
}
ReadLine();</pre></div></li><li class="listitem">Finally, run the console application and inspect the result returned to the console output window:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_27.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec154"/>How it works…</h2></div></div></div><p>You will see that the code <a class="indexterm" id="id621"/>contract has inspected the resultant value of the<a class="indexterm" id="id622"/> <code class="literal">ValidateResult()</code> method and found that it contravenes the contract. An exception is then thrown and displayed in the console window.</p></div></div>
<div class="section" title="Using code contracts on abstract classes"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec65"/>Using code contracts on abstract classes</h1></div></div></div><p>If you use abstract classes in <a class="indexterm" id="id623"/>your code, you will know that being able to control how they are used with code contracts will result in more robust code. But how <a class="indexterm" id="id624"/>exactly can we use code contracts with abstract classes? Especially since abstract classes are supposed to contain no implementation? Well, it is definitely possible, and here is how we do it.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec155"/>Getting ready</h2></div></div></div><p>If you have not worked with abstract classes before, we advise you to first read <a class="link" href="ch02.html" title="Chapter 2. Classes and Generics">Chapter 2</a>, <span class="emphasis"><em>Classes and Generics</em></span>, to familiarise yourself with how abstract classes are used and created.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec156"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before you go on, ensure that you have added the code contracts <code class="literal">using</code> statement to the top of your <code class="literal">Recipes.cs</code> class file:<div class="informalexample"><pre class="programlisting">using System.Diagnostics.Contracts;</pre></div></li><li class="listitem">Create an abstract class called <code class="literal">Shape</code> that defines two methods called <code class="literal">Length()</code> and <code class="literal">Width()</code> which each take an integer value as a parameter. Remember that abstract classes contain no implementation:<div class="informalexample"><pre class="programlisting">public abstract class Shape
{
    public abstract void Length(int value);
    public abstract void Width(int value);
}</pre></div></li><li class="listitem">Create <a class="indexterm" id="id625"/>another abstract class called <code class="literal">ShapeContract</code> that inherits the <code class="literal">Shape</code> abstract class. It is here that our code contracts will reside:<div class="informalexample"><pre class="programlisting">public abstract class ShapeContract : Shape
{
    
}</pre></div></li><li class="listitem">Override the <code class="literal">Length()</code> and <code class="literal">Width()</code> methods of the <code class="literal">Shape</code> abstract class and ensure that they<a class="indexterm" id="id626"/> require a non-zero parameter:<div class="informalexample"><pre class="programlisting">public abstract class ShapeContract : Shape
{
    public override void Length(int value)
    {
        Contract.Requires(value &gt; 0, "Length must be greater than zero");
    }

    public override void Width(int value)
    {
        Contract.Requires(value &gt; 0, "Width must be greater than zero");
    }
}</pre></div></li><li class="listitem">We now need to associate the <code class="literal">ShapeContract</code> contract class to the <code class="literal">Shape</code> abstract class. We will do this via the use of attributes. Add the following attribute to the top of your <code class="literal">Shape</code> abstract class:<div class="informalexample"><pre class="programlisting">[ContractClass(typeof(ShapeContract))]</pre></div></li><li class="listitem">After doing this, your <code class="literal">Shape</code> abstract class will look like this:<div class="informalexample"><pre class="programlisting">[ContractClass(typeof(ShapeContract))]
public abstract class Shape
{
    public abstract void Length(int value);
    public abstract void Width(int value);
}</pre></div></li><li class="listitem">We also need to associate the <code class="literal">Shape</code> abstract class to the <code class="literal">ShapeContract</code> abstract class<a class="indexterm" id="id627"/> as a means of telling the compiler which class the contracts need to act upon. We will do this by adding the following attribute to the top of the <code class="literal">ShapeContract</code> class:<div class="informalexample"><pre class="programlisting">[ContractClassFor(typeof(Shape))]</pre></div></li><li class="listitem">When you<a class="indexterm" id="id628"/> have done this, your <code class="literal">ShapeContract</code> class will look like this:<div class="informalexample"><pre class="programlisting">[ContractClassFor(typeof(Shape))]
public abstract class ShapeContract : Shape
{
    public override void Length(int value)
    {
        Contract.Requires(value &gt; 0, "Length must be greater than zero");
    }

    public override void Width(int value)
    {
        Contract.Requires(value &gt; 0, "Width must be greater than zero");
    }
}</pre></div></li><li class="listitem">We are now ready to implement the <code class="literal">Shape</code> abstract class. Create a new class called <code class="literal">Rectangle</code> and inherit the <code class="literal">Shape</code> abstract class:<div class="informalexample"><pre class="programlisting">public class Rectangle : Shape
{
        
}</pre></div></li><li class="listitem">You will notice that Visual Studio underlines the <code class="literal">Rectangle</code> class with a red squiggly line. This is because no implementation of the <code class="literal">Shape</code> class exists yet. Hover your mouse cursor over the red squiggly line and look at the lightbulb pop-up suggestion provided by Visual Studio:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_28.jpg"/></div></li><li class="listitem">By holding down <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>.</em></span> (period), you will see the suggested fixes that you can implement to <a class="indexterm" id="id629"/>correct the error that Visual <a class="indexterm" id="id630"/>Studio is warning you about. In this instance, there is only a single fix that Visual Studio suggests we implement, which is to implement the abstract class:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_29.jpg"/></div></li><li class="listitem">After you have clicked on the <span class="strong"><strong>Implement Abstract Class</strong></span> suggestion in the lightbulb suggestion, Visual Studio will insert the implementation of the <code class="literal">Shape</code> abstract class. You will notice that the methods inserted for you still don't contain any implementation and will throw <code class="literal">NotImplementedException</code> if you don't add any implementation to the <code class="literal">Length() </code>and <code class="literal">Width()</code> methods:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_30.jpg"/></div></li><li class="listitem">To add implementation to our <code class="literal">Rectangle</code> class, create two properties for the <code class="literal">Length()</code> and <code class="literal">Width()</code> methods<a class="indexterm" id="id631"/> and set<a class="indexterm" id="id632"/> these properties equal to the value of the supplied parameter value:<div class="informalexample"><pre class="programlisting">public class Rectangle : Shape
{
    private int _length { get; set; }
    private int _width { get; set; }
    public override void Length(int value)
    {
        _length = value;
    }

    public override void Width(int value)
    {
        _width = value;
    }
}</pre></div></li><li class="listitem">In the console application, add the relevant <code class="literal">using</code> statement to the <code class="literal">Program.cs</code> class to bring the <code class="literal">Chapter8</code> class into scope:<div class="informalexample"><pre class="programlisting">using Chapter8;</pre></div></li><li class="listitem">Create a new instance of the <code class="literal">Rectangle</code> class and pass some values to the <code class="literal">Length()</code> and <code class="literal">Width()</code> methods of the <code class="literal">Rectangle</code> class:<div class="informalexample"><pre class="programlisting">try
{
    Rectangle oRectangle = new Rectangle();
    oRectangle.Length(0);
    oRectangle.Width(1);
}
catch (Exception ex)
{
    WriteLine(ex.Message);
}
ReadLine();</pre></div></li><li class="listitem">Finally, run the<a class="indexterm" id="id633"/> console application and inspect the output window:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_31.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec157"/>How it works…</h2></div></div></div><p>As we have added a zero value to the <code class="literal">Length()</code> method, the code contract on the abstract class has correctly<a class="indexterm" id="id634"/> thrown an exception. Being able to implement code contracts on abstract classes allows developers to create better code, especially when working in teams where you need to convey implementation limitations based on certain business rules.</p></div></div>
<div class="section" title="Using contract abbreviator methods"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec66"/>Using contract abbreviator methods</h1></div></div></div><p>Abbreviator methods are a <a class="indexterm" id="id635"/>great addition to the features of code contracts. They allow us to create a single abbreviator method that contains often used or grouped code contracts. This means that we can simplify our code and make it more readable.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec158"/>Getting ready</h2></div></div></div><p>We will create two methods with the same code contract requirements. We will then simplify the methods under contract by implementing an abbreviator method to contain the code contracts.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec159"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before you go on, ensure that you have added the code contracts <code class="literal">using</code> statement to the top of your <code class="literal">Recipes.cs</code> class file:<div class="informalexample"><pre class="programlisting">using System.Diagnostics.Contracts;</pre></div></li><li class="listitem">Consider the following methods before you add them. We have two methods here, and each method requires that the parameter passed to it is not equal to zero and that the<a class="indexterm" id="id636"/> result is also not zero. The implementation within each method is different, but the code contracts applied are identical. To avoid a situation where code contracts are unnecessarily repeated, we can use abbreviator methods:<div class="informalexample"><pre class="programlisting">public static int MethodOne(int value)
{
    Contract.Requires(value &gt; 0, "Parameter must be greater than zero");
    Contract.Ensures(Contract.Result&lt;int&gt;() &gt; 0, "Method result must be greater than zero");

    return value - 1;
}

public static int MethodTwo(int value)
{
    Contract.Requires(value &gt; 0, "Parameter must be greater than zero");
    Contract.Ensures(Contract.Result&lt;int&gt;() &gt; 0, "Method result must be greater than zero");

    return (value * 10) - 10;
}</pre></div></li><li class="listitem">Add a new method called <code class="literal">StandardMethodContract()</code> to your <code class="literal">Recipes</code> class. This method's name can be anything you like, but the signature needs to match the methods it abbreviates. Inside this method, add the required code contracts defined earlier in <code class="literal">MethodOne()</code> and <code class="literal">MethodTwo()</code>:<div class="informalexample"><pre class="programlisting">private static void StandardMethodContract(int value)
{
    Contract.Requires(value &gt; 0, "Parameter must be greater than zero");
    Contract.Ensures(Contract.Result&lt;int&gt;() &gt;= 1, "Method result must be greater than zero");
}</pre></div></li><li class="listitem">Add the following attribute to the top of the <code class="literal">StandardMethodContract()</code> method to identify it as an abbreviator method:<div class="informalexample"><pre class="programlisting">[ContractAbbreviator]</pre></div></li><li class="listitem">Once you have done this, your abbreviator method should look like this:<div class="informalexample"><pre class="programlisting">[ContractAbbreviator]
private static void StandardMethodContract(int value)
{
    Contract.Requires(value &gt; 0, "Parameter must be greater than zero");
    Contract.Ensures(Contract.Result&lt;int&gt;() &gt;= 1, "Method result must be greater than zero");
}</pre></div></li><li class="listitem">You can now go ahead and simplify <code class="literal">MethodOne()</code> and <code class="literal">MethodTwo()</code> by simply referencing the abbreviator method in place of the code contracts:<div class="informalexample"><pre class="programlisting">public static int MethodOne(int value)
{
    StandardMethodContract(value);

    return value - 1;
}

public static int MethodTwo(int value)
{
    StandardMethodContract(value);

    return (value * 10) - 10;
}</pre></div></li><li class="listitem">In the console<a class="indexterm" id="id637"/> application, add the relevant <code class="literal">using</code> statement to the <code class="literal">Program.cs</code> class to bring the static class into scope:<div class="informalexample"><pre class="programlisting">using static Chapter8.Recipes;</pre></div></li><li class="listitem">First, call the two methods using the following parameters:<div class="informalexample"><pre class="programlisting">try
{
    MethodOne(0);
    MethodTwo(1);                
}
catch (Exception ex)
{
    WriteLine(ex.Message);
}
ReadLine();</pre></div></li><li class="listitem">If you run your console application, you will notice that the code contract throws an exception in the abbreviator contract, telling us that the supplied parameter can't be zero:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_32.jpg"/></div></li><li class="listitem">Then, modify <a class="indexterm" id="id638"/>your calling code and pass a valid value for <code class="literal">MethodOne()</code>, but leave the call to <code class="literal">MethodTwo()</code> as is. Run your console application again:<div class="informalexample"><pre class="programlisting">try
{
    MethodOne(200);
    MethodTwo(1);                
}
catch (Exception ex)
{
    WriteLine(ex.Message);
}
ReadLine();</pre></div></li><li class="listitem">This time, you will see that the code contract in the abbreviator method throws an exception on the return value that can't be zero:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_33.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec160"/>How it works…</h2></div></div></div><p>Abbreviator methods allow us to create more readable code and to group often used code contracts in a common <a class="indexterm" id="id639"/>method decorated with the <code class="literal">[ContractAbbreviator]</code> attribute. Abbreviator methods are a powerful feature of code contracts that developers can utilize to produce better code.</p></div></div>
<div class="section" title="Creating tests using IntelliTest"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec67"/>Creating tests using IntelliTest</h1></div></div></div><p>IntelliTest allows <a class="indexterm" id="id640"/>developers to create and run tests against their code contracts. This allows developers to create the most robust code possible by creating additional code<a class="indexterm" id="id641"/> contracts to pass the test failures reported by IntelliTest. One thing to note, however, is that IntelliTest is included in the Visual Studio Enterprise only.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec161"/>Getting ready</h2></div></div></div><p>You will need to use Visual Studio Enterprise 2015 to be able to create and run IntelliTests.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec162"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before you go on, ensure that you have added the code contracts <code class="literal">using</code> statement to the top of your <code class="literal">Recipes.cs</code> class file:<div class="informalexample"><pre class="programlisting">using System.Diagnostics.Contracts;</pre></div></li><li class="listitem">Add a new class called <code class="literal">CodeContractTests</code> to your <code class="literal">Recipes.cs</code> file:<div class="informalexample"><pre class="programlisting">public class CodeContractTests
{    

}</pre></div></li><li class="listitem">Then, add a method called <code class="literal">Calculate()</code> to the <code class="literal">CodeContractTests</code> class and pass two integer values as parameters to the <code class="literal">Calculate()</code> method. Inside the <code class="literal">Calculate()</code> method, add a code contract to ensure that the result from this method is never equal to zero:<div class="informalexample"><pre class="programlisting">public class CodeContractTests
{
    public int Calculate(int valueOne, int valueTwo)
    {
        Contract.Ensures(Contract.Result&lt;int&gt;() &gt;= 1, "");

        return valueOne / valueTwo;
    }
}</pre></div></li><li class="listitem">Select the <code class="literal">Calculate()</code> method and<a class="indexterm" id="id642"/> right-click on it. From the context menu, click on the <a class="indexterm" id="id643"/><span class="strong"><strong>Create IntelliTest</strong></span> menu item:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_34.jpg"/></div></li><li class="listitem">Visual Studio will then show the <span class="strong"><strong>Create IntelliTest</strong></span> window. Here, you can define <a class="indexterm" id="id644"/>several settings for your IntelliTest. One thing to<a class="indexterm" id="id645"/> note is that you can use a different test framework than <span class="strong"><strong>MSTest</strong></span>. For our purposes, however, we will use <span class="strong"><strong>MSTest</strong></span> and keep the rest of the settings set to their defaults:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_35.jpg"/></div></li><li class="listitem">When you click on the <span class="strong"><strong>OK</strong></span> button, Visual Studio will continue to create a new test project for you:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_36.jpg"/></div></li><li class="listitem">When the project creation is complete, you will see the new test project created in the<a class="indexterm" id="id646"/> <span class="strong"><strong>Solution Explorer</strong></span>. In this case, because <a class="indexterm" id="id647"/>we kept the default settings in the <span class="strong"><strong>Create IntelliTest</strong></span> window, our new test project will be called <code class="literal">Chapter8.Tests</code>:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_37.jpg"/></div></li><li class="listitem">Go ahead and expand the <code class="literal">Chapter8.Tests</code> project and then click on the <code class="literal">CodeContractTestsTest.cs</code> file created for you. You will see the following code created for you by Visual Studio:<div class="informalexample"><pre class="programlisting">/// &lt;summary&gt;This class contains parameterized unit tests for CodeContractTests&lt;/summary&gt;
[PexClass(typeof(CodeContractTests))]
[PexAllowedExceptionFromTypeUnderTest(typeof(InvalidOperati onException))]
[PexAllowedExceptionFromTypeUnderTest(typeof(ArgumentExcept ion), AcceptExceptionSubtypes = true)]
[TestClass]
public partial class CodeContractTestsTest
{
    /// &lt;summary&gt;Test stub for Calculate(Int32, Int32)&lt;/summary&gt;
    [PexMethod]
    public int CalculateTest(
        [PexAssumeUnderTest]CodeContractTests target,
        int valueOne,
        int valueTwo
    )
    {
        int result = target.Calculate(valueOne, valueTwo);
        return result;
        // TODO: add assertions to method CodeContractTestsTest.CalculateTest (CodeContractTests, Int32, Int32)
    }
}</pre></div></li><li class="listitem">Back in<a class="indexterm" id="id648"/> the <code class="literal">CodeContractTests</code> class, right-click <a class="indexterm" id="id649"/>on the <code class="literal">Calculate()</code> method and select <span class="strong"><strong>Run IntelliTest</strong></span> from the context menu:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_38.jpg"/></div></li><li class="listitem">IntelliTest will jump into <a class="indexterm" id="id650"/>action and open the <span class="strong"><strong>IntelliTest Exploration Results</strong></span> window:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_39.jpg"/></div></li><li class="listitem">From the test results we ran for the <code class="literal">Calculate()</code> method, we can see that we have three failed<a class="indexterm" id="id651"/> tests and one successful test. The test failures reported are <code class="literal">DivideByZeroException</code>, <code class="literal">ContractException</code>, and <code class="literal">OverflowException</code>. Clicking on individual test failures allows you to view the test details as well as the <span class="strong"><strong>Stack trace</strong></span>:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_40.jpg"/></div></li><li class="listitem">Let's modify the <code class="literal">Calculate()</code> method by adding the following additional code contracts:<div class="informalexample"><pre class="programlisting">public int Calculate(int valueOne, int valueTwo)
{
    Contract.Requires(valueOne &gt; 0, "Parameter must be greater than zero");
    Contract.Requires(valueTwo &gt; 0, "Parameter must be greater than zero");
    Contract.Requires(valueOne &gt; valueTwo, "Parameter values will result in value &lt;= 0");
    Contract.Ensures(Contract.Result&lt;int&gt;() &gt;= 1, "");

    return valueOne / valueTwo;
}</pre></div></li><li class="listitem">From the<a class="indexterm" id="id652"/> additional code contracts, we can see that by requiring the <code class="literal">valueTwo</code> parameter to be greater than zero, we have resolved the <code class="literal">DivideByZeroException</code>. We can also see that the code contract that requires <code class="literal">valueOne</code> is always greater than <code class="literal">valueTwo</code>. Thus, we<a class="indexterm" id="id653"/> have resolved the <code class="literal">ContractException</code>. Finally, by requiring that both parameters be greater than zero, we have automatically resolved the <code class="literal">OverflowException</code>:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_41.jpg"/></div></li><li class="listitem">Right-click on the <code class="literal">Calculate()</code> method and run the IntelliTest again. This time, you will see that all the tests have passed, and our method under contract is now ready for use in production code:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_42.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec163"/>How it works…</h2></div></div></div><p>IntelliTest allows <a class="indexterm" id="id654"/>developers to quickly and efficiently create tests for your code<a class="indexterm" id="id655"/> contracts with a few clicks of your mouse.</p></div></div>
<div class="section" title="Using code contracts in extension methods"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec68"/>Using code contracts in extension methods</h1></div></div></div><p>The previous recipes illustrated how a<a class="indexterm" id="id656"/> developer might create various code contracts to secure your code from unexpected input and output, but let's look at how a developer could leverage code contracts. The idea of extension methods<a class="indexterm" id="id657"/> come to mind, where we create code that can be used throughout your project to perform actions that are often used.</p><p>Let's use the code contract <code class="literal">ForAll</code> method. This has an impact on a collection, so naturally, its use in extension methods leads us to a possible implementation. In this recipe, we will create an extension method that uses a code contract to validate the list we have just created.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec164"/>Getting ready</h2></div></div></div><p>We will create a <a class="indexterm" id="id658"/>static class for our extension method and then use the <code class="literal">ForAll</code> code contract to validate the <code class="literal">List</code> collection.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec165"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before you go on, ensure that you have added the code contracts <code class="literal">using</code> statement to the top of your <code class="literal">Recipes.cs</code> class file:<div class="informalexample"><pre class="programlisting">using System.Diagnostics.Contracts;</pre></div></li><li class="listitem">Create a new static class called <code class="literal">ExtensionMethods</code> and add it to your <code class="literal">Recipes.cs</code> class file:<div class="informalexample"><pre class="programlisting">public static class ExtensionMethods
{
    
}</pre></div></li><li class="listitem">Next, add an <a class="indexterm" id="id659"/>extension method called <code class="literal">ContainsInvalidValue()</code> that takes the given list of anonymous type <code class="literal">T</code> and an invalid value to check as type <code class="literal">T</code> as parameters:<div class="informalexample"><pre class="programlisting">public static bool ContainsInvalidValue&lt;T&gt;(this List&lt;T&gt; value, T invalidValue)
{    

}</pre></div></li><li class="listitem">Inside our extension method, add code contract <code class="literal">ForAll</code> wrapped in a <code class="literal">try</code> <code class="literal">catch</code> statement that checks the existence of the given parameter in the list:<div class="informalexample"><pre class="programlisting">try
{
    Contract.Assert(Contract.ForAll(value, n =&gt; !value.Contains(invalidValue)), "Zero values are not allowed");
    return false;
}
catch 
{
    return true;
}</pre></div></li><li class="listitem">Once you have added all the code to your extension method, it should look like this:<div class="informalexample"><pre class="programlisting">public static class ExtensionMethods
{
    public static bool ContainsInvalidValue&lt;T&gt;(this List&lt;T&gt; value, T invalidValue)
    {
        try
        {
            Contract.Assert(Contract.ForAll(value, n =&gt; !value.Contains(invalidValue)), "Zero values are not allowed");
            return false;
        }
        catch 
        {
            return true;
        }
    }
}</pre></div></li><li class="listitem">In the console<a class="indexterm" id="id660"/> application, add the relevant <code class="literal">using</code> statement to the <code class="literal">Program.cs</code> class to bring the <code class="literal">Chapter8</code> class into scope:<div class="informalexample"><pre class="programlisting">using Chapter8;</pre></div></li><li class="listitem">As we did earlier, create<a class="indexterm" id="id661"/> a simple list, but this time, call the extension method that is exposed via the static extension methods class on the list. We will now be able to directly validate our list via the use of extension methods and code contracts:<div class="informalexample"><pre class="programlisting">List&lt;int&gt; intList = new List&lt;int&gt;();
int[] arr;
intList.AddRange(arr = new int[] { 1, 3, 2, 6, 0, 5 });

if (intList.ContainsInvalidValue(4)) 
    WriteLine("Invalid integer Value");
else
    WriteLine("Valid integer List");</pre></div></li><li class="listitem">Running the application will result in the following output:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_43.jpg"/></div></li><li class="listitem">As we are using an<a class="indexterm" id="id662"/> anonymous type here, we can easily call this extension method on lists containing different types. Here<a class="indexterm" id="id663"/> is an example of an implementation on a list of strings:<div class="informalexample"><pre class="programlisting">List&lt;string&gt; strList = new List&lt;string&gt;();
string[] arr2;
strList.AddRange(arr2 = new string[] { "S", "A", "Z" });

if (strList.ContainsInvalidValue("G"))
    WriteLine("Invalid string Value");
else
    WriteLine("Valid string List");</pre></div></li><li class="listitem">Running the application again will result in the following output:<div class="mediaobject"><img alt="How to do it…" src="graphics/B05391_08_44.jpg"/></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec166"/>How it works…</h2></div></div></div><p>We can see that using<a class="indexterm" id="id664"/> code contracts along with other powerful<a class="indexterm" id="id665"/> features of C# allows us to utilize very powerful code checking and validation techniques. The extension methods can be used throughout your project to perform frequent validation or other code logic specific to your project.</p></div></div></body></html>