<html><head></head><body><div class="chapter" title="Chapter&#xA0;12.&#xA0;ASP.NET Core Identity">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch12"/>&#13;
 Chapter 12. ASP.NET Core Identity</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>Security is essential to all types of applications, including web applications. Would you use Facebook if anyone could update your status by impersonating you? If that were possible, then no one would come back to Facebook. From this example, we can see that security is not so much a feature as it is a necessity for all applications.</p>&#13;
<p>In this chapter, we are going to learn about the following topics:</p>&#13;
<div class="itemizedlist">&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">Authentication and authorization</li>&#13;
<li class="listitem">ASP.NET Identity</li>&#13;
<li class="listitem">How to implement security in an ASP.NET Core application using ASP.NET Identity with Entity Framework</li>&#13;
</ul>&#13;
</div>&#13;
<p>When we talk about the security of an application, we primarily want to prevent any unauthorized access, meaning that only the people who have access to the information should be able to access it—nothing more, nothing less.</p>&#13;
<p>Before proceeding further, I would like to clarify some of the core concepts regarding security.</p>&#13;
<div class="section" title="Authentication">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch12lvl1sec77"/>&#13;
 Authentication</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>Authentication is the process of validating whether the user has access to the system. In any application, users will be authenticated first. This can be achieved by asking the user to enter their user ID and password.</p>&#13;
</div>&#13;
</div>&#13;

<div class="section" title="Authorization">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch12lvl1sec78"/>&#13;
 Authorization</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>Authorization is the process where we verify whether the user has access to the requested resource. They might have legitimate access to the system, but they might not have access to the requested resource as they do not have the required access. For example, only the admin user can access the configuration page of the application, whereas normal users should not be allowed to use this page.</p>&#13;
<p>ASP.NET Identity provides several features for securing the application.</p>&#13;
<p>Let us consider the following simple scenario where the user tries to access the <span class="strong">&#13;
<strong>Secure Page</strong>&#13;
</span>&#13;
 , a page to which only authorized people should have access. As the user is not logged in, they will be redirected to the <span class="strong">&#13;
<strong>Login Page</strong>&#13;
</span>&#13;
 so that we can authenticate and authorize the user. Upon successful authentication, the user is redirected to the <span class="strong">&#13;
<strong>Secure Page</strong>&#13;
</span>&#13;
 . If for any reason, we can not authenticate and authorize the user, we can redirect them to the <span class="strong">&#13;
<strong>"Access denied" Page</strong>&#13;
</span>&#13;
 :</p>&#13;
<div class="mediaobject"><img src="Image00230.jpg" alt="Authorization"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>ASP.NET Core Identity is a membership system that enables you to secure the application easily, and which has features such as adding login functionality to your application. The following are the steps that we need to follow in order to use <span class="strong">&#13;
<strong>ASP.NET Identity</strong>&#13;
</span>&#13;
 (with Entity Framework) for our application:</p>&#13;
<div class="orderedlist">&#13;
<ol class="orderedlist arabic">&#13;
<li class="listitem" value="1">Add the relevant dependencies to the <code class="literal">project.json</code>&#13;
 file.</li>&#13;
<li class="listitem" value="2">Create an <code class="literal">appsettings.json</code>&#13;
 file and store the database connection string.</li>&#13;
<li class="listitem" value="3">Create an <code class="literal">ApplicationUser</code>&#13;
 class and <code class="literal">ApplicationDbContext</code>&#13;
 class.</li>&#13;
<li class="listitem" value="4">Configure the application to use ASP.NET Identity.</li>&#13;
<li class="listitem" value="5">Create ViewModels for registration and login.</li>&#13;
<li class="listitem" value="6">Create the necessary controller and associated action methods and Views.</li>&#13;
</ol>&#13;
<div style="height:10px; width: 1px"/>&#13;
</div>&#13;
</div>&#13;

<div class="section" title="Adding the relevant dependencies to the project.json file">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch12lvl1sec79"/>&#13;
 Adding the relevant dependencies to the project.json file</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>If you want to use ASP.NET Identity with Entity Framework in your application, you need to add the following dependencies:</p>&#13;
<pre class="programlisting">"EntityFramework.Commands": "7.0.0-rc1-final", 
    "EntityFramework.MicrosoftSqlServer": "7.0.0-rc1-final", 
    "Microsoft.AspNet.Authentication.Cookies": "1.0.0-rc1-final", 
</pre>&#13;
<p>Create an <code class="literal">appsettings.json</code>&#13;
 file and store the database connection string.</p>&#13;
<p>Create a file with the name <code class="literal">appsettings.json</code>&#13;
 at the root level of the project, as shown in the following screenshot:</p>&#13;
<div class="mediaobject"><img src="Image00231.jpg" alt="Adding the relevant dependencies to the project.json file"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>Store the following connection string in <code class="literal">appsettings.json</code>&#13;
 . This connection string will be used by ASP.NET Identity to store the data in relevant tables:</p>&#13;
<pre class="programlisting">{ 
  "Data": { 
    "DefaultConnection": { 
      "ConnectionString": "Server=(localdb)\\mssqllocaldb;Database=aspnet_security;Trusted_Connection=True;MultipleActiveResultSets=true" 
   } 
  } 
} 
</pre>&#13;
<div class="section" title="Adding ApplicationUser and ApplicationDbContext classes">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h2 class="title"><a id="ch12lvl2sec81"/>&#13;
 Adding ApplicationUser and ApplicationDbContext classes</h2>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>Create a <span class="strong">&#13;
<strong>Models</strong>&#13;
</span>&#13;
 folder and a couple of files—<span class="strong">&#13;
<strong>ApplicationDbContext.cs</strong>&#13;
</span>&#13;
 and <span class="strong">&#13;
<strong>ApplicationUser.cs—</strong>&#13;
</span>&#13;
 as shown in the following screenshot:</p>&#13;
<div class="mediaobject"><img src="Image00232.jpg" alt="Adding ApplicationUser and ApplicationDbContext classes"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>The <code class="literal">ApplicationUser</code>&#13;
 class inherits from the <code class="literal">IdentityUser</code>&#13;
 class (available at the <code class="literal">AspNet.Identity.EntityFramework6</code>&#13;
 namespace) as follows:</p>&#13;
<pre class="programlisting">public class ApplicationUser : IdentityUser 
{
..  
} 
</pre>&#13;
<p>You can add properties to the user as per the needs of your application. I have not added any properties as I would like to keep things simple to show the features of ASP.NET Identity.</p>&#13;
<p>The <code class="literal">ApplicationDbContext</code>&#13;
 class inherits from the <code class="literal">IdentityDbContext</code>&#13;
 class of <code class="literal">ApplicationUser</code>&#13;
 . In the constructor method, we pass the <code class="literal">connectionstring</code>&#13;
 , which is eventually passed to the base class.</p>&#13;
<p>Even the <code class="literal">OnModelCreating</code>&#13;
 method is overridden. If you want to change any table names (to be generated by Identity), you can do so as follows:</p>&#13;
<pre class="programlisting">public class ApplicationDbContext : IdentityDbContext&lt;ApplicationUser&gt; 
    { 
        public ApplicationDbContext(string nameOrConnectionString) : base(nameOrConnectionString) { } 
 
        protected override void OnModelCreating(DbModelBuilder modelBuilder) 
        { 
            base.OnModelCreating(modelBuilder);             
        } 
    } 
</pre>&#13;
<p>Once we create the <code class="literal">Models</code>&#13;
 file, we need to configure the application and services. You can configure these in <code class="literal">Configure</code>&#13;
 and <code class="literal">ConfigureServices</code>&#13;
 , which are found in the <code class="literal">Startup</code>&#13;
 class.</p>&#13;
</div>&#13;
</div>&#13;

<div class="section" title="Configuring the application to use Identity">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch12lvl1sec80"/>&#13;
 Configuring the application to use Identity</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>In order to use Identity, we just need to add the following line in the <code class="literal">Configure</code>&#13;
 method of the <code class="literal">Startup</code>&#13;
 class:</p>&#13;
<pre class="programlisting">app.UseIdentity(); 
</pre>&#13;
<p>The complete <code class="literal">Configure</code>&#13;
 method is shown in the following code, along with the call of the <code class="literal">UseIdentity</code>&#13;
 method, which is <code class="literal">app.UseIdentity()</code>&#13;
 :</p>&#13;
<pre class="programlisting">public void Configure(IApplicationBuilder app, IHostingEnvironment env,  ILoggerFactory loggerFactory) 
        { 
            loggerFactory.AddConsole(Configuration.GetSection("Logging")); 
            loggerFactory.AddDebug(); 
 
            if (env.IsDevelopment()) 
            { 
                app.UseBrowserLink(); 
                app.UseDeveloperExceptionPage(); 
                app.UseDatabaseErrorPage(); 
            } 
            else 
            { 
                app.UseExceptionHandler("/Home/Error"); 
 
                 
 
            app.UseIISPlatformHandler(options =&gt; options.AuthenticationDescriptions.Clear()); 
 
            app.UseStaticFiles(); 
 
            app.UseIdentity(); 
 
            // To configure external authentication please see http://go.microsoft.com/fwlink/?LinkID=532715 
 
            app.UseMvc(routes =&gt; 
            { 
                routes.MapRoute( 
                    name: "default", 
                    template: "{controller=Home}/{action=Index}/{id?}"); 
            }); 
        } 
</pre>&#13;
<p>In the <code class="literal">ConfigureServices</code>&#13;
 method, we will make the following changes:</p>&#13;
<div class="itemizedlist">&#13;
<ul class="itemizedlist">&#13;
<li class="listitem">We will add the <code class="literal">ApplicationDbContext</code>&#13;
 class with the connection string taken from the <code class="literal">appsettings.json</code>&#13;
 file</li>&#13;
<li class="listitem">We will add Identity with <code class="literal">UserStore</code>&#13;
 and <code class="literal">RoleStore</code>&#13;
</li>&#13;
<li class="listitem">Finally, we will ask ASP.NET Core to return <code class="literal">AuthMessageSender</code>&#13;
 whenever we ask for the <code class="literal">IEmailSender</code>&#13;
 and <code class="literal">ISMSSender</code>&#13;
 classes<pre class="programlisting">public void ConfigureServices(IServiceCollection services 
{ 
// Add framework services. 
 
            services.AddScoped&lt;ApplicationDbContext&gt;(f =&gt; { 
                return new ApplicationDbContext(Configuration["Data:DefaultConnection:ConnectionString"]); 
            }); 
     
            services.AddIdentity&lt;ApplicationUser, IdentityRole&gt;() 
                .AddUserStore&lt;UserStore&lt;ApplicationUser, ApplicationDbContext&gt;&gt;() 
                .AddRoleStore&lt;RoleStore&lt;ApplicationDbContext&gt;&gt;() 
                .AddDefaultTokenProviders(); 
 
            services.AddMvc(); 
 
            // Add application services. 
            services.AddTransient&lt;IEmailSender, AuthMessageSender&gt;(); 
            services.AddTransient&lt;ISmsSender, AuthMessageSender&gt;(); 
        } 
</pre>&#13;
</li>&#13;
</ul>&#13;
</div>&#13;
</div>&#13;

<div class="section" title="Creating ViewModels">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch12lvl1sec81"/>&#13;
 Creating ViewModels</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>Next, we will be creating several ViewModels that we will be using in our Views model.</p>&#13;
<p>To start with, we will create a <code class="literal">RegisterViewModel</code>&#13;
 class that contains three properties—<code class="literal">Email</code>&#13;
 , <code class="literal">Password</code>&#13;
 , and <code class="literal">ConfirmPassword</code>&#13;
 . We decorate the properties with appropriate attributes so that we can use client-side validation using an unobtrusive jQuery validation. We are making all the fields required as follows:</p>&#13;
<pre class="programlisting">public class RegisterViewModel 
    { 
        [Required] 
        [EmailAddress] 
        [Display(Name = "Email")] 
        public string Email { get; set; } 
 
        [Required] 
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} characters long.", MinimumLength = 6)] 
        [DataType(DataType.Password)] 
        [Display(Name = "Password")] 
        public string Password { get; set; } 
 
        [DataType(DataType.Password)] 
        [Display(Name = "Confirm password")] 
        [Compare("Password", ErrorMessage = "The password and confirmation password do not match.")] 
        public string ConfirmPassword { get; set; } 
    } 
</pre>&#13;
<p>Now, we can create the <code class="literal">LoginViewModel model</code>&#13;
 , which the user can use to log in to your application. There is an additional property, <code class="literal">RememberMe</code>&#13;
 , which, when checked, will enable you to log in without having to enter the password again:</p>&#13;
<pre class="programlisting">public class LoginViewModel 
    { 
        [Required] 
        [EmailAddress] 
        public string Email { get; set; } 
 
        [Required] 
        [DataType(DataType.Password)] 
        public string Password { get; set; } 
 
        [Display(Name = "Remember me?")] 
        public bool RememberMe { get; set; } 
    } 
</pre>&#13;
</div>&#13;

<div class="section" title="Creating Controllers and associated action methods">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch12lvl1sec82"/>&#13;
 Creating Controllers and associated action methods</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>Now we need to create an <code class="literal">AccountController</code>&#13;
 class, where we will define the action methods for authentication and authorization:</p>&#13;
<pre class="programlisting">public class AccountController : Controller 
    { 
        private readonly UserManager&lt;ApplicationUser&gt; _userManager; 
        private readonly SignInManager&lt;ApplicationUser&gt; _signInManager; 
        private readonly IEmailSender _emailSender; 
        private readonly ISmsSender _smsSender; 
        private readonly ILogger _logger; 
 
        public AccountController( 
            UserManager&lt;ApplicationUser&gt; userManager, 
            SignInManager&lt;ApplicationUser&gt; signInManager, 
            IEmailSender emailSender, 
            ISmsSender smsSender, 
            ILoggerFactory loggerFactory) 
        { 
            _userManager = userManager; 
            _signInManager = signInManager; 
            _emailSender = emailSender; 
            _smsSender = smsSender; 
            _logger = loggerFactory.CreateLogger&lt;AccountController&gt;(); 
        } 
    } 
</pre>&#13;
<p>In the preceding code, we are using services provided by different components. <code class="literal">UserManager</code>&#13;
 and <code class="literal">SignInManager</code>&#13;
 are provided by ASP.NET Identity. The <code class="literal">IEmailSender</code>&#13;
 and <code class="literal">ISmsSender</code>&#13;
 are custom classes that we have written which will be used for sending e-mails and SMS messages. We will look more at e-mail and SMS later in this chapter. Logging is provided by the Microsoft Logging extension. The following is a simple login <code class="literal">HTTPGET</code>&#13;
 method. It simply stores the URL from where the <code class="literal">Login</code>&#13;
 method is accessed and returns the login page:</p>&#13;
<pre class="programlisting">[HttpGet] 
        [AllowAnonymous] 
        public IActionResult Login(string returnUrl = null) 
        { 
            ViewData["ReturnUrl"] = returnUrl; 
            return View(); 
        } 
</pre>&#13;
</div>&#13;

<div class="section" title="Creating Views">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch12lvl1sec83"/>&#13;
 Creating Views</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>Now, we will create respective View page for the login. In this View page, we are just showing the following details:</p>&#13;
<pre class="programlisting">@using System.Collections.Generic 
@using Microsoft.AspNet.Http 
@using Microsoft.AspNet.Http.Authentication 
@using AspNet.Identity.EntityFramework6 
 
@model LoginViewModel 
@inject SignInManager&lt;ApplicationUser&gt; SignInManager 
 
@{ 
    ViewData["Title"] = "Log in"; 
} 
 
&lt;h2&gt;@ViewData["Title"].&lt;/h2&gt; 
&lt;div class="row"&gt; 
    &lt;div class="col-md-8"&gt; 
        &lt;section&gt; 
            &lt;form asp-controller="Account" asp-action="Login" asp-route-returnurl="@ViewData["ReturnUrl"]" method="post" class="form-horizontal" role="form"&gt; 
                &lt;h4&gt;Use a local account to log in.&lt;/h4&gt; 
                &lt;hr /&gt; 
                &lt;div asp-validation-summary="ValidationSummary.All" class="text-danger"&gt;&lt;/div&gt; 
                &lt;div class="form-group"&gt; 
                    &lt;label asp-for="Email" class="col-md-2 control-label"&gt;&lt;/label&gt; 
                    &lt;div class="col-md-10"&gt; 
                        &lt;input asp-for="Email" class="form-control" /&gt; 
                        &lt;span asp-validation-for="Email" class="text-danger"&gt;&lt;/span&gt; 
                    &lt;/div&gt; 
                &lt;/div&gt; 
                &lt;div class="form-group"&gt; 
                    &lt;label asp-for="Password" class="col-md-2 control-label"&gt;&lt;/label&gt; 
                    &lt;div class="col-md-10"&gt; 
                        &lt;input asp-for="Password" class="form-control" /&gt; 
                        &lt;span asp-validation-for="Password" class="text-danger"&gt;&lt;/span&gt; 
                    &lt;/div&gt; 
                &lt;/div&gt; 
                &lt;div class="form-group"&gt; 
                    &lt;div class="col-md-offset-2 col-md-10"&gt; 
                        &lt;div class="checkbox"&gt; 
                            &lt;input asp-for="RememberMe" /&gt; 
                            &lt;label asp-for="RememberMe"&gt;&lt;/label&gt; 
                        &lt;/div&gt; 
                    &lt;/div&gt; 
                &lt;/div&gt; 
                &lt;div class="form-group"&gt; 
                    &lt;div class="col-md-offset-2 col-md-10"&gt; 
                        &lt;button type="submit" class="btn btn-default"&gt;Log in&lt;/button&gt; 
                    &lt;/div&gt; 
                &lt;/div&gt; 
                &lt;p&gt; 
                    &lt;a asp-action="Register"&gt;Register as a new user?&lt;/a&gt; 
                &lt;/p&gt; 
                &lt;p&gt; 
                    &lt;a asp-action="ForgotPassword"&gt;Forgot your password?&lt;/a&gt; 
                &lt;/p&gt; 
            &lt;/form&gt; 
        &lt;/section&gt; 
    &lt;/div&gt; 
     
&lt;/div&gt; 
 
@section Scripts { 
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); } 
} 
</pre>&#13;
<div class="mediaobject"><img src="Image00233.jpg" alt="Creating Views"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>When the user logs into the application for the first time, they might not have any login credentials, so our application should provide a feature that they can use to create a login for themselves. We will create a simple <code class="literal">Register</code>&#13;
 action method that will just return a View with which the user can register themselves:</p>&#13;
<pre class="programlisting">[HttpGet] 
[AllowAnonymous] 
public IActionResult Register() 
{ 
    return View(); 
} 
</pre>&#13;
<p>We will also create the corresponding View that contains input controls for e-mail, password, password confirmation, and a <code class="literal">Register</code>&#13;
 button:</p>&#13;
<pre class="programlisting">@model RegisterViewModel 
@{ 
    ViewData["Title"] = "Register"; 
} 
 
&lt;h2&gt;@ViewData["Title"].&lt;/h2&gt; 
 
&lt;form asp-controller="Account" asp-action="Register" method="post" class="form-horizontal" role="form"&gt; 
    &lt;h4&gt;Create a new account.&lt;/h4&gt; 
    &lt;hr /&gt; 
    &lt;div asp-validation-summary="ValidationSummary.All" class="text-danger"&gt;&lt;/div&gt; 
    &lt;div class="form-group"&gt; 
        &lt;label asp-for="Email" class="col-md-2 control-label"&gt;&lt;/label&gt; 
        &lt;div class="col-md-10"&gt; 
            &lt;input asp-for="Email" class="form-control" /&gt; 
            &lt;span asp-validation-for="Email" class="text-danger"&gt;&lt;/span&gt; 
        &lt;/div&gt; 
    &lt;/div&gt; 
    &lt;div class="form-group"&gt; 
        &lt;label asp-for="Password" class="col-md-2 control-label"&gt;&lt;/label&gt; 
        &lt;div class="col-md-10"&gt; 
            &lt;input asp-for="Password" class="form-control" /&gt; 
            &lt;span asp-validation-for="Password" class="text-danger"&gt;&lt;/span&gt; 
        &lt;/div&gt; 
    &lt;/div&gt; 
    &lt;div class="form-group"&gt; 
        &lt;label asp-for="ConfirmPassword" class="col-md-2 control-label"&gt;&lt;/label&gt; 
        &lt;div class="col-md-10"&gt; 
            &lt;input asp-for="ConfirmPassword" class="form-control" /&gt; 
            &lt;span asp-validation-for="ConfirmPassword" class="text-danger"&gt;&lt;/span&gt; 
        &lt;/div&gt; 
    &lt;/div&gt; 
    &lt;div class="form-group"&gt; 
        &lt;div class="col-md-offset-2 col-md-10"&gt; 
            &lt;button type="submit" class="btn btn-default"&gt;Register&lt;/button&gt; 
        &lt;/div&gt; 
    &lt;/div&gt; 
&lt;/form&gt; 
 
@section Scripts { 
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); } 
} 
</pre>&#13;
<p>The following is the corresponding <code class="literal">POST</code>&#13;
 action method for registration. Here, the program checks whether the model is valid, and, if it is valid, it will create an <code class="literal">ApplicationUser</code>&#13;
 object using the model data and call the Identity API (the <code class="literal">CreateAsync</code>&#13;
 method). If it can create the <code class="literal">user</code>&#13;
 variable, the user will log in using that user ID and be redirected to the <code class="literal">Home</code>&#13;
 page:</p>&#13;
<pre class="programlisting">[HttpPost] 
        [AllowAnonymous] 
        [ValidateAntiForgeryToken] 
        public async Task&lt;IActionResult&gt; Register(RegisterViewModel model) 
        { 
            if (ModelState.IsValid) 
            { 
                var user = new ApplicationUser { UserName = model.Email,  Email = model.Email }; 
                var result = await _userManager.CreateAsync(user,  model.Password); 
                if (result.Succeeded) 
                { 
                    await _signInManager.SignInAsync(user, isPersistent:  false); 
                    return RedirectToAction(nameof(HomeController.Index),  "Home"); 
                } 
                AddErrors(result); 
            } 
             
            return View(model); 
        } 
</pre>&#13;
<p>The log-out functionality is pretty simple. It just needs to call the <code class="literal">SignoutAsync</code>&#13;
 method of Identity API and be redirected to the <code class="literal">Index</code>&#13;
 page:</p>&#13;
<pre class="programlisting">[HttpPost] 
        [ValidateAntiForgeryToken] 
        public async Task&lt;IActionResult&gt; LogOff() 
        { 
            await _signInManager.SignOutAsync(); 
            _logger.LogInformation(4, "User logged out."); 
            return RedirectToAction(nameof(HomeController.Index), "Home"); 
       } 
</pre>&#13;
<p>Coming back to the log-in functionality, the following is the respective action method. We are calling the <code class="literal">PasswordSignInAsync</code>&#13;
 method of Identity API. Upon a successful login, we redirect the URL from where the log-in functionality is accessed:</p>&#13;
<pre class="programlisting">[HttpPost] 
        [AllowAnonymous] 
        [ValidateAntiForgeryToken] 
        public async Task&lt;IActionResult&gt; Login(LoginViewModel model, string returnUrl = null) 
        { 
            ViewData["ReturnUrl"] = returnUrl; 
            if (ModelState.IsValid) 
            { 
                var result = await _signInManager.PasswordSignInAsync(model.Email, model.Password, model.RememberMe, lockoutOnFailure: false); 
                if (result.Succeeded) 
                { 
                    return RedirectToLocal(returnUrl); 
                } 
                 
            } 
            // If there is any error, display the form again 
            return View(model); 
        } 
</pre>&#13;
</div>&#13;

<div class="section" title="E-mail and SMS services">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch12lvl1sec84"/>&#13;
 E-mail and SMS services</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>If you want to add e-mail and SMS services to your application's authentication capabilities, you can do so by creating the interfaces and classes shown here: </p>&#13;
<pre class="programlisting">public interface IEmailSender
{
        Task SendEmailAsync(string email, string subject, string message)
  }
  public interface ISmsSender
    {
        Task SendSmsAsync(string number, string message);
    }
public class AuthMessageSender : IEmailSender, ISmsSender
    {
        public Task SendEmailAsync(string email, string subject, string message)
        {
            // We can plug in our email service here to send an email.
            return Task.FromResult(0);
        }
        public Task SendSmsAsync(string number, string message)
        {
            // We can plug in our SMS service here to send a text message.
            return Task.FromResult(0);
        }
    }</pre>&#13;
</div>&#13;

<div class="section" title="Securing an action method in a Controller">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch12lvl1sec85"/>&#13;
 Securing an action method in a Controller</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>For the sake of explanation, let us assume that the <span class="strong">&#13;
<strong>About</strong>&#13;
</span>&#13;
 page is a secure page and only authenticated users should be able to access it.</p>&#13;
<p>We just have to decorate the <code class="literal">About</code>&#13;
 action method in the <code class="literal">Home</code>&#13;
 controller with an<code class="literal">[Authorize]</code>&#13;
 attribute:</p>&#13;
<pre class="programlisting">[Authorize] 
        public IActionResult About() 
        { 
            ViewData["Message"] = "This is my about page"; 
            return View(); 
        } 
</pre>&#13;
<p>Making the preceding change will redirect the user to the log-in page when the user tries to access the log-in page without logging in to the application:</p>&#13;
<div class="mediaobject"><img src="Image00234.jpg" alt="Securing an action method in a Controller"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>In the following screenshot, you will notice an additional query parameter, <code class="literal">ReturnURL,</code>&#13;
 in the URL. This <code class="literal">ReturnURL</code>&#13;
 parameter will redirect the application to that specific page (the value passed in the <code class="literal">ReturnURL</code>&#13;
 parameter—<span class="strong">&#13;
<strong>Home</strong>&#13;
</span>&#13;
 /<span class="strong">&#13;
<strong>About</strong>&#13;
</span>&#13;
 in our case).</p>&#13;
<p>Once you log in, you'll be redirected to the page that you requested earlier:</p>&#13;
<div class="mediaobject"><img src="Image00235.jpg" alt="Securing an action method in a Controller"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>When you register a new user, the details of the user will be stored in the relevant tables created by ASP.NET Identity.</p>&#13;
<p>Open the SQL Server Object Explorer window by selecting the option <span class="strong">&#13;
<strong>View</strong>&#13;
</span>&#13;
 | <span class="strong">&#13;
<strong>SQL Server Object Explorer</strong>&#13;
</span>&#13;
 , as shown in the following screenshot:</p>&#13;
<div class="mediaobject"><img src="Image00236.jpg" alt="Securing an action method in a Controller"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>Once you select the <span class="strong">&#13;
<strong>SQL Server Object Explorer</strong>&#13;
</span>&#13;
 option, you will see a window similar to the following screenshot. ASP.NET Identity creates a database for us by using Entity Framework and the connection string that we provided earlier in the <code class="literal">appsettings.json</code>&#13;
 package.</p>&#13;
<p>ASP.NET Identity creates several tables to maintain identity-related information and the database migration history of Entity Framework. As we are using ASP.NET Identity at the basic level, none of the identity-related tables will get populated, apart from <span class="strong">&#13;
<strong>dbo.AspNetUsers</strong>&#13;
</span>&#13;
 .:</p>&#13;
<div class="mediaobject"><img src="Image00237.jpg" alt="Securing an action method in a Controller"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>You can right-click on the <span class="strong">&#13;
<strong>dbo.AspNetUsers</strong>&#13;
</span>&#13;
 table and select <span class="strong">&#13;
<strong>View Data</strong>&#13;
</span>&#13;
 to see the data:</p>&#13;
<div class="mediaobject"><img src="Image00238.jpg" alt="Securing an action method in a Controller"/>&#13;
</div>&#13;
<p style="clear:both; height: 1em;"/>&#13;
<p>As only one user has been registered in our application, only one row has been created. Please note that the hashed password (marked by ASP.NET Identity for us) and no blank passwords will get stored in the table.</p>&#13;
</div>&#13;

<h1>读累了记得休息一会哦~</h1>
<p> </p>
<p><strong>公众号：古德猫宁李</strong></p>
<ul>
<li>电子书搜索下载</li>
<li>书单分享</li>
<li>书友学习交流</li>

<p> </p>
</ul>
<p><strong>网站：</strong><a href="https://www.chenjin5.com">沉金书屋 https://www.chenjin5.com</a></p>
<ul>
<li>电子书搜索下载</li>
<li>电子书打包资源分享</li>
<li>学习资源分享</li>

</ul>

<div class="section" title="Summary">&#13;
<div class="titlepage">&#13;
<div>&#13;
<div>&#13;
<h1 class="title"><a id="ch12lvl1sec86"/>&#13;
 Summary</h1>&#13;
</div>&#13;
</div>&#13;
</div>&#13;
<p>In this chapter, we learned about authentication and authorization. We also learned how to implement ASP.NET Identity in an ASP.NET Core application by following a step-by-step process. We also discussed the tables involved in ASP.NET Identity and learned how to see the data created by ASP.NET Identity.</p>&#13;
</div>&#13;
</body></html>