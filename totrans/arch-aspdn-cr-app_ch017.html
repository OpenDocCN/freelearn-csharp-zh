<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="packt" name="generator"/>
<title>16 Mediator and CQRS Design Patterns</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<link href="../styles/stylesheet2.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body>
<section class="level1 pkt" data-number="17" id="mediator-and-cqrs-design-patterns">
<h1 data-number="17"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">16 Mediator and CQRS Design Patterns</span></h1>
<section class="level2" data-number="17.1" id="before-you-begin-join-our-book-community-on-discord-15">
<h2 data-number="17.1"><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Before you begin: Join our book community on Discord</span></h2>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">Give your feedback straight to the author himself and chat to other early readers on our Discord server (find the "architecting-aspnet-core-apps-3e" channel under EARLY ACCESS SUBSCRIPTION).</span></p>
<p><a href="https://packt.link/EarlyAccess"><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">https://packt.link/EarlyAccess</span></a></p>
<p><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Qr code Description automatically generated" src="../media/file98.png" style="width:10em"/></span></p>
<p><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">This chapter covers the building blocks of the next chapter, which is about </span><strong><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">Vertical Slice Architecture</span></strong><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.8.2" xmlns="http://www.w3.org/1999/xhtml">We begin with a quick overview of Vertical Slice Architecture to give you an idea of the end goal. </span><span class="koboSpan" id="kobo.8.3" xmlns="http://www.w3.org/1999/xhtml">Then, we explore the </span><strong><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">Mediator</span></strong><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml"> design pattern, which plays the role of the middleman between the components of our application. </span><span class="koboSpan" id="kobo.10.2" xmlns="http://www.w3.org/1999/xhtml">That leads us to the </span><strong><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml">Command Query Responsibility Segregation</span></strong><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><strong><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">CQRS</span></strong><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml">) pattern, which describes how to divide our logic into commands and queries. </span><span class="koboSpan" id="kobo.14.2" xmlns="http://www.w3.org/1999/xhtml">Finally, we consolidate our learning by exploring MediatR, an open-source implementation of the Mediator design pattern, and send queries and commands through it to demonstrate how the concepts we have studied so far come to life in real-world application development.In this chapter, we cover the following topics:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">A high-level overview of Vertical Slice Architecture</span></li>
<li><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml">Implementing the Mediator pattern</span></li>
<li><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">Implementing the CQS pattern</span></li>
<li><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">Code smell – Marker Interfaces</span></li>
<li><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml">Using MediatR as a mediator</span></li>
</ul>
<p><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">Let’s begin with the end goal.</span></p>
</section>
<section class="level2" data-number="17.2" id="a-high-level-overview-of-vertical-slice-architecture">
<h2 data-number="17.2"><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">A high-level overview of Vertical Slice Architecture</span></h2>
<p><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">Before starting, let’s look at the end goal of this chapter and the next. </span><span class="koboSpan" id="kobo.22.2" xmlns="http://www.w3.org/1999/xhtml">This way, it should be easier to follow the progress toward that goal throughout the chapter.As we covered in </span><em><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 14</span></em><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">Layering and Clean Architecture</span></em><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">, a layer groups classes together based on shared responsibilities. </span><span class="koboSpan" id="kobo.26.2" xmlns="http://www.w3.org/1999/xhtml">So, classes containing data access code are part of the data access layer (or infrastructure). </span><span class="koboSpan" id="kobo.26.3" xmlns="http://www.w3.org/1999/xhtml">People represent layers using horizontal slices in diagrams like this:</span></p>
<figure>
<span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.1: Diagram representing layers as horizontal slices" src="../media/file99.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.1: Diagram representing layers as horizontal slices</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml">The “vertical slice” in “Vertical Slice Architecture” comes from that; a vertical slice represents the part of each layer that creates a specific feature. </span><span class="koboSpan" id="kobo.29.2" xmlns="http://www.w3.org/1999/xhtml">So, instead of dividing the application into layers, we divide it into features. </span><span class="koboSpan" id="kobo.29.3" xmlns="http://www.w3.org/1999/xhtml">A feature manages its data access code, domain logic, and possibly even presentation code. </span><span class="koboSpan" id="kobo.29.4" xmlns="http://www.w3.org/1999/xhtml">The key is to loosely couple the features from one another and keep each feature’s components close together. </span><span class="koboSpan" id="kobo.29.5" xmlns="http://www.w3.org/1999/xhtml">In a layered application, when we add, update, or remove a feature, we must change one or more layers, which too often translates to “all layers.”On the other hand, with vertical slices, we keep features isolated, allowing us to design them independently. </span><span class="koboSpan" id="kobo.29.6" xmlns="http://www.w3.org/1999/xhtml">From a layering perspective, this is like flipping your way of thinking about software to a 90° angle:</span></p>
<figure>
<span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.2: Diagram representing a vertical slice crossing all layers" src="../media/file100.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.2: Diagram representing a vertical slice crossing all layers</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml">Vertical Slice Architecture does not dictate the use of </span><strong><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">CQRS</span></strong><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">, the </span><strong><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">Mediator</span></strong><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml"> pattern, or </span><strong><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">MediatR</span></strong><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">, but these tools and patterns flow very well together, as we see in the next chapter. </span><span class="koboSpan" id="kobo.38.2" xmlns="http://www.w3.org/1999/xhtml">Nonetheless, these are just tools and patterns that you can use or change in your implementation using different techniques; it does not matter and does not change the concept.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml">We explore additional ways of building feature-oriented applications in </span><em><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 18</span></em><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml">Request-EndPoint-Response (REPR)</span></em><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><em><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 20</span></em><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml">Modular Monolith</span></em><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml">The goal is to encapsulate features together, use CQRS to divide the application into requests (commands and queries), and use MediatR as the mediator of that CQRS pipeline, decoupling the pieces from one another.You now know the plan. </span><span class="koboSpan" id="kobo.48.2" xmlns="http://www.w3.org/1999/xhtml">We explore Vertical Slice Architecture later. </span><span class="koboSpan" id="kobo.48.3" xmlns="http://www.w3.org/1999/xhtml">Meanwhile, let’s begin with the Mediator design pattern.</span></p>
</section>
<section class="level2" data-number="17.3" id="implementing-the-mediator-pattern">
<h2 data-number="17.3"><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">Implementing the Mediator pattern</span></h2>
<p><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml">Mediator</span></strong><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml"> pattern is another GoF design pattern that controls how objects interact with one another (making it a behavioral pattern).</span></p>
<section class="level3" data-number="17.3.1" id="goal-15">
<h3 data-number="17.3.1"><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml">Goal</span></h3>
<p><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml">The mediator’s role is to manage the communication between objects (colleagues). </span><span class="koboSpan" id="kobo.54.2" xmlns="http://www.w3.org/1999/xhtml">Those colleagues should not communicate together directly but use the mediator instead. </span><span class="koboSpan" id="kobo.54.3" xmlns="http://www.w3.org/1999/xhtml">The mediator helps break tight coupling between these colleagues.</span><strong><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml">A mediator is a middleman who relays messages between colleagues</span></strong><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</section>
<section class="level3" data-number="17.3.2" id="design-15">
<h3 data-number="17.3.2"><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml">Design</span></h3>
<p><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start with some UML diagrams. </span><span class="koboSpan" id="kobo.58.2" xmlns="http://www.w3.org/1999/xhtml">From a very high level, the Mediator pattern is composed of a mediator and colleagues:</span></p>
<figure>
<span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.3: Class diagram representing the Mediator pattern" src="../media/file101.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.3: Class diagram representing the Mediator pattern</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml">When an object in the system wants to send a message to one or more colleagues, it uses the mediator. </span><span class="koboSpan" id="kobo.61.2" xmlns="http://www.w3.org/1999/xhtml">Here is an example of how it works:</span></p>
<figure>
<span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.4: Sequence diagram of a mediator relaying messages to colleagues" src="../media/file102.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.4: Sequence diagram of a mediator relaying messages to colleagues</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">That is also valid for colleagues; a colleague must also use the mediator if they need to talk to each other, as depicted in the following class diagram:</span></p>
<figure>
<span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.5: Class diagram representing the Mediator pattern including colleagues’ collaboration" src="../media/file103.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.5: Class diagram representing the Mediator pattern including colleagues’ collaboration</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">In this diagram, </span><code><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml">ConcreteColleague1</span></code><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml"> is a colleague but also the consumer of the mediator. </span><span class="koboSpan" id="kobo.69.2" xmlns="http://www.w3.org/1999/xhtml">For example, that colleague could send a message to another colleague using the mediator, like this:</span></p>
<figure>
<span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.6: Sequence diagram representing colleague1 communicating with colleague2 through the mediator" src="../media/file104.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.6: Sequence diagram representing colleague1 communicating with colleague2 through the mediator</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">From a mediator standpoint, its implementation most likely contains a collection of colleagues to communicate with, like this:</span></p>
<figure>
<span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.7: Class diagram representing a simple hypothetical concrete mediator implementation" src="../media/file105.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.7: Class diagram representing a simple hypothetical concrete mediator implementation</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have explored some UML diagrams, let’s look at some code.</span></p>
</section>
<section class="level3" data-number="17.3.3" id="project-mediator-imediator">
<h3 data-number="17.3.3"><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">Project – Mediator (IMediator)</span></h3>
<p><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml">The Mediator project consists of a simplified chat system using the Mediator pattern. </span><span class="koboSpan" id="kobo.77.2" xmlns="http://www.w3.org/1999/xhtml">Let’s start with the interfaces:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml">namespace Mediator;
public interface IMediator
{
    void Send(Message message);
}
public interface IColleague
{
    string Name { get; }
    void ReceiveMessage(Message message);
}
public record class Message(IColleague Sender, string Content);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml">The system is composed of the following:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml"> interface represents a mediator that can send messages to colleagues.</span></li>
<li><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml">IColleague</span></code><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml"> interface represents a colleague that can receive messages. </span><span class="koboSpan" id="kobo.85.2" xmlns="http://www.w3.org/1999/xhtml">It also has a </span><code><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml"> property so we can output meaningful values.</span></li>
<li><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml">Message</span></code><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml"> class represents a message sent by an </span><code><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml">IColleague</span></code><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml"> implementation.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml">Next, we implement the </span><code><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml"> interface in the </span><code><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml">ConcreteMediator</span></code><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml"> class, which broadcasts the messages to all </span><code><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">IColleague</span></code><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml"> instances:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml">public class ConcreteMediator : IMediator
{
    private readonly List&lt;IColleague&gt; _colleagues;
    public ConcreteMediator(params IColleague[] colleagues)
    {
        ArgumentNullException.ThrowIfNull(colleagues);
        _colleagues = new List&lt;IColleague&gt;(colleagues);
    }
    public void Send(Message message)
    {
        foreach (var colleague in _colleagues)
        {
            colleague.ReceiveMessage(message);
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">That mediator is simple; it forwards all the messages it receives to every colleague it knows. </span><span class="koboSpan" id="kobo.101.2" xmlns="http://www.w3.org/1999/xhtml">The last part of the pattern is the </span><code><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml">ConcreteColleague</span></code><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml"> class which lets an instance of the </span><code><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">IMessageWriter&lt;TMessage&gt;</span></code><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml"> interface output the messages (we explore that interface next):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml">public class ConcreteColleague : IColleague
{
    private readonly IMessageWriter&lt;Message&gt; _messageWriter;
    public ConcreteColleague(string name, IMessageWriter&lt;Message&gt; messageWriter)
    {
        Name = name ?? </span><span class="koboSpan" id="kobo.106.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(name));
        _messageWriter = messageWriter ?? </span><span class="koboSpan" id="kobo.106.3" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(messageWriter));
    }
    public string Name { get; }
    public void ReceiveMessage(Message message)
    {
        _messageWriter.Write(message);
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml">That class could hardly be simpler: it takes a name and an </span><code><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml">IMessageWriter&lt;TMessage&gt;</span></code><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml"> implementation when created, then it stores a reference for future use.The </span><code><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml">IMessageWriter&lt;TMessage&gt;</span></code><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml"> interface serves as a presenter and controls how the messages are displayed. </span><span class="koboSpan" id="kobo.111.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml">IMessageWriter&lt;TMessage&gt;</span></code><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml"> interface is unrelated to the Mediator pattern. </span><span class="koboSpan" id="kobo.113.2" xmlns="http://www.w3.org/1999/xhtml">Nevertheless, it is a way to manage how a </span><code><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml">ConcreteColleague</span></code><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml"> object outputs the messages without coupling it with a specific target. </span><span class="koboSpan" id="kobo.115.2" xmlns="http://www.w3.org/1999/xhtml">Here is the code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml">namespace Mediator;
public interface IMessageWriter&lt;Tmessage&gt;
{
    void Write(Tmessage message);
} </span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml">The consumer of the system is an integration test defined in the </span><code><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml">MediatorTest</span></code><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.119.2" xmlns="http://www.w3.org/1999/xhtml">The test uses the chat system and asserts the output using a custom implementation of the </span><code><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">IMessageWriter</span></code><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.121.2" xmlns="http://www.w3.org/1999/xhtml">Let’s start by analyzing the test:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml">namespace Mediator;
public class MediatorTest
{
    [Fact]
    public void Send_a_message_to_all_colleagues()
    {
        // Arrange
        var (millerWriter, miller) = CreateConcreteColleague("Miller");
        var (orazioWriter, orazio) = CreateConcreteColleague("Orazio");
        var (fletcherWriter, fletcher) = CreateConcreteColleague("Fletcher");</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">The test starts by defining three colleagues with their own </span><code><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">TestMessageWriter</span></code><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml"> implementation (names were randomly generated).</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">        var mediator = new ConcreteMediator(miller, orazio, fletcher);
        var expectedOutput = @"[Miller]: Hey everyone!
</span><span class="koboSpan" id="kobo.126.2" xmlns="http://www.w3.org/1999/xhtml">[Orazio]: What's up Miller?
</span><span class="koboSpan" id="kobo.126.3" xmlns="http://www.w3.org/1999/xhtml">[Fletcher]: Hey Miller!
</span><span class="koboSpan" id="kobo.126.4" xmlns="http://www.w3.org/1999/xhtml">";</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml">In the second part of the preceding </span><code><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml">Arrange</span></code><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml"> block, we create the subject under test (</span><code><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml">mediator</span></code><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">) and register the three colleagues. </span><span class="koboSpan" id="kobo.131.2" xmlns="http://www.w3.org/1999/xhtml">At the end of that </span><code><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml">Arrange</span></code><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml"> block, we also define the expected output of our test. </span><span class="koboSpan" id="kobo.133.2" xmlns="http://www.w3.org/1999/xhtml">It is important to note that we control the output from the </span><code><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml">TestMessageWriter</span></code><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml"> implementation (defined at the end of the </span><code><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml">MediatorTest</span></code><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml"> class). </span><span class="koboSpan" id="kobo.137.2" xmlns="http://www.w3.org/1999/xhtml">Next is the </span><code><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml">Act</span></code><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml"> block:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml">        // Act
        mediator.Send(new Message(
            Sender: miller,
            Content: "Hey everyone!"
        </span><span class="koboSpan" id="kobo.140.2" xmlns="http://www.w3.org/1999/xhtml">));
        mediator.Send(new Message(
            Sender: orazio,
            Content: "What's up Miller?"
        </span><span class="koboSpan" id="kobo.140.3" xmlns="http://www.w3.org/1999/xhtml">));
        mediator.Send(new Message(
            Sender: fletcher,
            Content: "Hey Miller!"
        </span><span class="koboSpan" id="kobo.140.4" xmlns="http://www.w3.org/1999/xhtml">)); </span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding </span><code><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml">Act</span></code><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml"> block, we send three messages through the </span><code><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml">mediator</span></code><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml"> instance. </span><span class="koboSpan" id="kobo.145.2" xmlns="http://www.w3.org/1999/xhtml">Next is the </span><code><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">Assert</span></code><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml"> block:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">        // Assert
        Assert.Equal(expectedOutput, millerWriter.Output.ToString());
        Assert.Equal(expectedOutput, orazioWriter.Output.ToString());
        Assert.Equal(expectedOutput, fletcherWriter.Output.ToString());
    }</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml">In the </span><code><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml">Assert</span></code><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml"> block, we ensure that all colleagues receive the messages.</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml">    private static (TestMessageWriter, ConcreteColleague) CreateConcreteColleague(string name)
    {
        var messageWriter = new TestMessageWriter();
        var concreateColleague = new ConcreteColleague(name, messageWriter);
        return (messageWriter, concreateColleague);
    }</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml">CreateConcreteColleague</span></code><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml"> method is a helper method that encapsulates the creation of the colleagues, enabling us to write the one-liner declaration used in the </span><code><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml">Arrange</span></code><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml"> section of the test. </span><span class="koboSpan" id="kobo.157.2" xmlns="http://www.w3.org/1999/xhtml">Next, we look at the </span><code><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">IMessageWriter</span></code><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml"> implementation:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml">    private class TestMessageWriter : IMessageWriter&lt;Message&gt;
    {
        public StringBuilder Output { get; } = new StringBuilder();
        public void Write(Message message)
        {
            Output.AppendLine($"[{message.Sender.Name}]: {message.Content}");
        }
    }
} // Closing the MediatorTest class</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml">Finally, the </span><code><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">TestMessageWriter</span></code><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml"> class writes the messages into </span><code><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml">StringBuilder</span></code><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml">, making it easy to assert the output. </span><span class="koboSpan" id="kobo.165.2" xmlns="http://www.w3.org/1999/xhtml">If we were to build a GUI for that, we could write an implementation of </span><code><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml">IMessageWriter&lt;Message&gt;</span></code><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml"> that writes to that GUI; in the case of a web UI, it could use </span><strong><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml">SignalR</span></strong><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml"> or write to the response stream directly, for example.To summarize the sample:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml">The consumer (the unit test) sends messages to colleagues through the mediator.</span></li>
<li><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml">TestMessageWriter</span></code><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml"> class writes those messages to a </span><code><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml">StringBuilder</span></code><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml"> instance. </span><span class="koboSpan" id="kobo.175.2" xmlns="http://www.w3.org/1999/xhtml">Each colleague has its own instance of the </span><code><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml">TestMessageWriter</span></code><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml"> class.</span></li>
<li><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">The code asserts that all colleagues received the expected messages.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml">This example illustrates that the Mediator pattern allows us to break the direct coupling between colleagues. </span><span class="koboSpan" id="kobo.179.2" xmlns="http://www.w3.org/1999/xhtml">The messages reached colleagues without them knowing about each other.Colleagues should communicate through the mediator, so the Mediator pattern would not be complete without that. </span><span class="koboSpan" id="kobo.179.3" xmlns="http://www.w3.org/1999/xhtml">Let’s implement a more advanced chatroom to tackle this concept.</span></p>
</section>
<section class="level3" data-number="17.3.4" id="project-mediator-ichatroom">
<h3 data-number="17.3.4"><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">Project – Mediator (IChatRoom)</span></h3>
<p><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml">In the previous code sample, we named the classes after the Mediator pattern actors, as shown in </span><em><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml">Figure 14.7</span></em><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.183.2" xmlns="http://www.w3.org/1999/xhtml">While this example is very similar, it uses domain-specific names instead and implements a few more methods to manage the system showing a more tangible implementation. </span><span class="koboSpan" id="kobo.183.3" xmlns="http://www.w3.org/1999/xhtml">Let’s start with the abstractions:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">namespace Mediator;
public interface IChatRoom
{
    void Join(IParticipant participant);
    void Send(ChatMessage message);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml"> interface is the mediator, and it defines two methods instead of one:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml">Join</span></code><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml">, which allows </span><code><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml"> to join </span><code><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><code><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml">Send</span></code><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml">, which sends a message to the others.</span></li>
</ul>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml">public interface IParticipant
{
    string Name { get; }
    void Send(string message);
    void ReceiveMessage(ChatMessage message);
    void ChatRoomJoined(IChatRoom chatRoom);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml"> interface is the colleague and also has a few more methods:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml">Send</span></code><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml">, to send messages.</span></li>
<li><code><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml">ReceiveMessage</span></code><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml">, to receive messages from the other </span><code><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml"> objects.</span></li>
<li><code><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoomJoined</span></code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml">, to confirm that the </span><code><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml"> object has successfully joined a chatroom.</span></li>
</ul>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml">public record class ChatMessage(IParticipant Sender, string Content);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">ChatMessage</span></code><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml"> class is the same as the previous </span><code><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml">Message</span></code><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml"> class, but it references </span><code><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml"> instead of </span><code><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml">IColleague</span></code><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml">.Let’s now look at the </span><code><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml"> implementation:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml">public class User : IParticipant
{
    private IChatRoom? </span><span class="koboSpan" id="kobo.222.2" xmlns="http://www.w3.org/1999/xhtml">_chatRoom;
    private readonly IMessageWriter&lt;ChatMessage&gt; _messageWriter;
    public User(IMessageWriter&lt;ChatMessage&gt; messageWriter, string name)
    {
        _messageWriter = messageWriter ?? </span><span class="koboSpan" id="kobo.222.3" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(messageWriter));
        Name = name ?? </span><span class="koboSpan" id="kobo.222.4" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(name));
    }
    public string Name { get; }
    public void ChatRoomJoined(IChatRoom chatRoom)
    {
        _chatRoom = chatRoom;
    }
    public void ReceiveMessage(ChatMessage message)
    {
        _messageWriter.Write(message);
    }
    public void Send(string message)
    {
        if (_chatRoom == null)
        {
            throw new ChatRoomNotJoinedException();
        }
        _chatRoom.Send(new ChatMessage(this, message));
    }
}
public class ChatRoomNotJoinedException : Exception
{
    public ChatRoomNotJoinedException()
        : base("You must join a chat room before sending a message.")
    { }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">User</span></code><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml"> class represents our default </span><code><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.227.2" xmlns="http://www.w3.org/1999/xhtml">A </span><code><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml">User</span></code><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml"> instance can chat in only one </span><code><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.231.2" xmlns="http://www.w3.org/1999/xhtml">THe program can set the chat room by calling the </span><code><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoomJoined</span></code><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.233.2" xmlns="http://www.w3.org/1999/xhtml">When it receives a message, it delegates it to its </span><code><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml">IMessageWriter&lt;ChatMessage&gt;</span></code><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.235.2" xmlns="http://www.w3.org/1999/xhtml">Finally, a </span><code><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml">User</span></code><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml"> instance can send a message through the mediator (</span><code><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom)</span></code><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.239.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml">Send</span></code><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml"> method throws a </span><code><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoomNotJoinedException</span></code><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml"> to enforce that the </span><code><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml">User</span></code><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml"> instance must join a chat room before sending messages (code-wise: the </span><code><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml">_chatRoom</span></code><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml"> field must not be </span><code><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml">null</span></code><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml">).We could create a </span><code><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">Moderator</span></code><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">Administrator</span></code><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">SystemAlerts</span></code><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">, or any other </span><code><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml"> implementation as we see fit, but not in this sample. </span><span class="koboSpan" id="kobo.257.2" xmlns="http://www.w3.org/1999/xhtml">I am leaving that to you to experiment with the Mediator pattern.Now let’s look at the </span><code><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoom</span></code><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml"> class (the mediator):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">public class ChatRoom : IChatRoom
{
    private readonly List&lt;IParticipant&gt; _participants = new();
    public void Join(IParticipant participant)
    {
        _participants.Add(participant);
        participant.ChatRoomJoined(this);
        Send(new ChatMessage(participant, "Has joined the channel"));
    }
    public void Send(ChatMessage message)
    {
        _participants.ForEach(participant 
            =&gt; participant.ReceiveMessage(message));
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoom</span></code><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml"> class is slimmer than the </span><code><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">User</span></code><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.265.2" xmlns="http://www.w3.org/1999/xhtml">It allows participants to join and sends chat messages to registered participants. </span><span class="koboSpan" id="kobo.265.3" xmlns="http://www.w3.org/1999/xhtml">When joining a </span><code><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoom</span></code><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml">, it keeps a reference on the </span><code><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml">, tells that </span><code><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml"> that it has successfully joined then sends a </span><code><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml">ChatMessage</span></code><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml"> to all participants announcing the newcomer.With those few pieces, we have a Mediator implementation. </span><span class="koboSpan" id="kobo.273.2" xmlns="http://www.w3.org/1999/xhtml">Before moving to the next section, let’s look at the </span><code><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml">Consumer</span></code><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml"> instance of </span><code><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml">, which is another integration test. </span><span class="koboSpan" id="kobo.277.2" xmlns="http://www.w3.org/1999/xhtml">Let’s start with the skeleton of the class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml">namespace Mediator;
public class ChatRoomTest
{
    [Fact]
    public void ChatRoom_participants_should_send_and_receive_messages()
    {
        // Arrange, Act, Assert blocks here
    }
    private (TestMessageWriter, User) CreateTestUser(string name)
    {
        var writer = new TestMessageWriter();
        var user = new User(writer, name);
        return (writer, user);
    }
    private class TestMessageWriter : IMessageWriter&lt;ChatMessage&gt;
    {
        public StringBuilder Output { get; } = new StringBuilder();
        public void Write(ChatMessage message)
        {
            Output.AppendLine($"[{message.Sender.Name}]: {message.Content}");
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we have the following pieces:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml">The test case is an empty placeholder that we are about to look into.</span></li>
<li><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">CreateTestUser</span></code><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml"> method helps simplify the </span><code><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">Arrange</span></code><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml"> section of the test case, similar to before.</span></li>
<li><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml">TestMessageWriter</span></code><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml"> implementation is similar to the previous example, accumulating messages in a </span><code><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml">StringBuilder</span></code><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml"> instance.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml">As a reference, the </span><code><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml">IMessageWriter</span></code><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml"> interface is the same as the previous project:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml">public interface IMessageWriter&lt;TMessage&gt;
{
    void Write(TMessage message);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">Now, let’s explore the test case, starting with the </span><code><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">Arrange</span></code><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml"> block, where we create four users with their respective </span><code><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml">TestMessageWriter</span></code><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml"> instances (names were also randomly generated):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml">// Arrange
var (kingChat, king) = CreateTestUser("King");
var (kelleyChat, kelley) = CreateTestUser("Kelley");
var (daveenChat, daveen) = CreateTestUser("Daveen");
var (rutterChat, _) = CreateTestUser("Rutter");
var chatroom = new ChatRoom();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">Then, in the </span><code><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml">Act</span></code><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml"> block, our test users join the </span><code><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml">chatroom</span></code><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml"> instance and send messages:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">// Act
chatroom.Join(king);
chatroom.Join(kelley);
king.Send("Hey!");
kelley.Send("What's up King?");
chatroom.Join(daveen);
king.Send("Everything is great, I joined the CrazyChatRoom!");
daveen.Send("Hey King!");
king.Send("Hey Daveen");</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml">Then in the Assert block, Rutter did not join the chatroom, so we expect no message:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml">// Assert
Assert.Empty(rutterChat.Output.ToString());</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml">Since King is the first to join the channel, we expect him to receive all messages:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">Assert.Equal(@"[King]: Has joined the channel
[Kelley]: Has joined the channel
[King]: Hey!
</span><span class="koboSpan" id="kobo.310.2" xmlns="http://www.w3.org/1999/xhtml">[Kelley]: What's up King?
</span><span class="koboSpan" id="kobo.310.3" xmlns="http://www.w3.org/1999/xhtml">[Daveen]: Has joined the channel
[King]: Everything is great, I joined the CrazyChatRoom!
</span><span class="koboSpan" id="kobo.310.4" xmlns="http://www.w3.org/1999/xhtml">[Daveen]: Hey King!
</span><span class="koboSpan" id="kobo.310.5" xmlns="http://www.w3.org/1999/xhtml">[King]: Hey Daveen
", kingChat.Output.ToString());</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml">Kelley was the second user to join the chatroom, so the output contains almost all messages except the line saying </span><code><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml">[King]: Has joined the channel</span></code><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml">:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml">Assert.Equal(@"[Kelley]: Has joined the channel
[King]: Hey!
</span><span class="koboSpan" id="kobo.314.2" xmlns="http://www.w3.org/1999/xhtml">[Kelley]: What's up King?
</span><span class="koboSpan" id="kobo.314.3" xmlns="http://www.w3.org/1999/xhtml">[Daveen]: Has joined the channel
[King]: Everything is great, I joined the CrazyChatRoom!
</span><span class="koboSpan" id="kobo.314.4" xmlns="http://www.w3.org/1999/xhtml">[Daveen]: Hey King!
</span><span class="koboSpan" id="kobo.314.5" xmlns="http://www.w3.org/1999/xhtml">[King]: Hey Daveen
", kelleyChat.Output.ToString());</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml">Daveen joined after King and Kelley exchanged a few words, so we expect the conversation to be shorter:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml">Assert.Equal(@"[Daveen]: Has joined the channel
[King]: Everything is great, I joined the CrazyChatRoom!
</span><span class="koboSpan" id="kobo.316.2" xmlns="http://www.w3.org/1999/xhtml">[Daveen]: Hey King!
</span><span class="koboSpan" id="kobo.316.3" xmlns="http://www.w3.org/1999/xhtml">[King]: Hey Daveen
", daveenChat.Output.ToString());</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml">To summarize the test case, we have four users. </span><span class="koboSpan" id="kobo.317.2" xmlns="http://www.w3.org/1999/xhtml">Three of them joined the same chatroom at a different time and chatted a little. </span><span class="koboSpan" id="kobo.317.3" xmlns="http://www.w3.org/1999/xhtml">The output is different for everyone since the time you join matters. </span><span class="koboSpan" id="kobo.317.4" xmlns="http://www.w3.org/1999/xhtml">All participants are loosely coupled, thanks to the Mediator pattern, allowing us to extend the system without impacting the existing pieces. </span><span class="koboSpan" id="kobo.317.5" xmlns="http://www.w3.org/1999/xhtml">Leveraging the Mediator pattern helps us create maintainable systems; many small pieces are easier to manage and test than a large component handling all the logic.</span></p>
</section>
<section class="level3" data-number="17.3.5" id="conclusion-23">
<h3 data-number="17.3.5"><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml">Conclusion</span></h3>
<p><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml">As we explored in the two preceding projects, a </span><strong><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml">mediator</span></strong><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml"> allows us to decouple the components of our system. </span><strong><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml">The mediator is the middleman between colleagues</span></strong><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml">, and it served us well in the small chatroom samples where each colleague can talk to the others without knowing how and without knowing them.Now let’s see how the Mediator pattern can help us follow the </span><strong><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml">SOLID</span></strong><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml"> principles:</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml">S</span></strong><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml">: The mediator extracts the communication responsibility from colleagues.</span></li>
<li><strong><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml">O</span></strong><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml">: With a mediator relaying the messages, we can create new colleagues and change the existing colleagues’ behaviors without impacting the others. </span><span class="koboSpan" id="kobo.329.2" xmlns="http://www.w3.org/1999/xhtml">If we need a new colleague, we can register one with the mediator.</span></li>
<li><strong><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml">L</span></strong><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml">: N/A</span></li>
<li><strong><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml">I</span></strong><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml">: The Mediator pattern divides the system into multiple small interfaces (</span><code><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml">IColleague</span></code><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml">).</span></li>
<li><strong><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">D</span></strong><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml">: All actors of the Mediator pattern solely depend on other interfaces. </span><span class="koboSpan" id="kobo.339.2" xmlns="http://www.w3.org/1999/xhtml">We can implement a new mediator and reuse the existing colleagues’ implementations if we need new mediation behavior because of the dependency inversion.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml">Next, we explore CQRS, which allows us to separate commands and queries, leading to a more maintainable application. </span><span class="koboSpan" id="kobo.340.2" xmlns="http://www.w3.org/1999/xhtml">After all, all operations are queries or commands, no matter how we call them.</span></p>
</section>
</section>
<section class="level2" data-number="17.4" id="implementing-the-cqs-pattern">
<h2 data-number="17.4"><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml">Implementing the CQS pattern</span></h2>
<p><strong><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml">Command-Query Separation (CQS)</span></strong><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml"> is a subset of the </span><strong><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml">Command Query Responsibility Segregation (CQRS)</span></strong><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml"> pattern.Here’s the high-level difference between the two:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml">With CQS, we divide operations into commands and queries.</span></li>
<li><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml">With CQRS, we apply the concept to the system level. </span><span class="koboSpan" id="kobo.347.2" xmlns="http://www.w3.org/1999/xhtml">We separate models for reading and for writing, potentially leading to a distributed system.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we stick with CQS and tackle CQRS in </span><em><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 18</span></em><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml">Introduction to Microservices Architecture</span></em><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<section class="level3" data-number="17.4.1" id="goal-16">
<h3 data-number="17.4.1"><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">Goal</span></h3>
<p><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml">The goal is to divide all operations (or requests) into two categories: commands and queries.</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml">A command mutates the state of an application.</span></strong><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml"> For example, creating, updating, and deleting an entity are commands. </span><span class="koboSpan" id="kobo.356.2" xmlns="http://www.w3.org/1999/xhtml">In theory, a command should not return a value. </span><span class="koboSpan" id="kobo.356.3" xmlns="http://www.w3.org/1999/xhtml">In practice, they often do, especially for optimization purposes.</span></li>
<li><strong><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml">A query reads the state of the application but never changes it.</span></strong><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml"> For example, reading an order, reading your order history, and retrieving your user profile are queries.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml">Dividing operations into mutator requests (write/command) and accessor requests (read/query) creates a clear separation of concerns, leading us toward the SRP.</span></p>
</section>
<section class="level3" data-number="17.4.2" id="design-16">
<h3 data-number="17.4.2"><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml">Design</span></h3>
<p><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml">There is no definite design for this, but for us, the flow of a command should look like the following:</span></p>
<figure>
<span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.8: Sequence diagram representing the abstract flow of a command" src="../media/file106.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.8: Sequence diagram representing the abstract flow of a command</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml">The consumer creates a command object and sends it to a command handler, applying the mutation to the application. </span><span class="koboSpan" id="kobo.364.2" xmlns="http://www.w3.org/1999/xhtml">I called it </span><code><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml">Entities</span></code><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml"> in this case, but it could have sent a SQL </span><code><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml">UPDATE</span></code><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml"> command to a database or a web API call over HTTP; the implementation details do not matter.The concept is the same for a query, but it returns a value instead. </span><span class="koboSpan" id="kobo.368.2" xmlns="http://www.w3.org/1999/xhtml">Very importantly, the query must not change the state of the application. </span><span class="koboSpan" id="kobo.368.3" xmlns="http://www.w3.org/1999/xhtml">A query should only read data, like this:</span></p>
<figure>
<span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.9: Sequence diagram representing the abstract flow of a query" src="../media/file107.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.9: Sequence diagram representing the abstract flow of a query</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml">Like the command, the consumer creates a query object and sends it to a handler, which then executes some logic to retrieve and return the requested data. </span><span class="koboSpan" id="kobo.371.2" xmlns="http://www.w3.org/1999/xhtml">We can replace </span><code><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml">Entities</span></code><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml"> with anything the handler needs to query the data.Enough talk—let’s look at the CQS project.</span></p>
</section>
<section class="level3" data-number="17.4.3" id="project-cqs">
<h3 data-number="17.4.3"><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml">Project – CQS</span></h3>
<p><strong><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></strong><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">: We need to build an improved version of our chat system. </span><span class="koboSpan" id="kobo.376.2" xmlns="http://www.w3.org/1999/xhtml">The old system worked so well that we need to scale it up. </span><span class="koboSpan" id="kobo.376.3" xmlns="http://www.w3.org/1999/xhtml">The mediator was of help to us, so we kept that part, and we picked the CQS pattern to help us with this new, improved design. </span><span class="koboSpan" id="kobo.376.4" xmlns="http://www.w3.org/1999/xhtml">A participant was limited to a single chatroom in the past, but now a participant must be able to chat in multiple rooms simultaneously.The new system is composed of three commands and two queries:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml">A participant must be able to join a chatroom.</span></li>
<li><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml">A participant must be able to leave a chatroom.</span></li>
<li><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml">A participant must be able to send a message into a chatroom.</span></li>
<li><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml">A participant must be able to obtain the list of participants that joined a chatroom.</span></li>
<li><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">A participant must be able to retrieve the existing messages from a chatroom.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml">The first three are commands, and the last two are queries. </span><span class="koboSpan" id="kobo.382.2" xmlns="http://www.w3.org/1999/xhtml">The system is backed by the following mediator that makes heavy use of C# generics:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml">public interface IMediator
{
    TReturn Send&lt;TQuery, TReturn&gt;(TQuery query)
        where TQuery : IQuery&lt;TReturn&gt;;
    void Send&lt;TCommand&gt;(TCommand command)
        where TCommand : ICommand;
    void Register&lt;TCommand&gt;(ICommandHandler&lt;TCommand&gt; commandHandler)
        where TCommand : ICommand;
    void Register&lt;TQuery, TReturn&gt;(IQueryHandler&lt;TQuery, TReturn&gt; commandHandler)
        where TQuery : IQuery&lt;TReturn&gt;;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml">If you are not familiar with generics, this might look daunting, but that code is way simpler than it looks. </span><span class="koboSpan" id="kobo.384.2" xmlns="http://www.w3.org/1999/xhtml">Next, the </span><code><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml">ICommand</span></code><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml"> interface is empty, which we could have avoided, but it helps describe our intent. </span><span class="koboSpan" id="kobo.386.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml">ICommandHandler</span></code><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml"> interface defines the contract a class must implement to handle a command. </span><span class="koboSpan" id="kobo.388.2" xmlns="http://www.w3.org/1999/xhtml">That interface defines a </span><code><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml">Handle</span></code><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml"> method that takes the command as a parameter. </span><span class="koboSpan" id="kobo.390.2" xmlns="http://www.w3.org/1999/xhtml">The generic parameter </span><code><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml">TCommand</span></code><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml"> represents the type of command the class implementing the interface can handle. </span><span class="koboSpan" id="kobo.392.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml">public interface ICommand { }
public interface ICommandHandler&lt;TCommand&gt; 
    where TCommand : ICommand
{
    void Handle(TCommand command);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">IQuery&lt;TReturn&gt;</span></code><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml"> interface is similar to the </span><code><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml">ICommand</span></code><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml"> interface but has a </span><code><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml">TReturn</span></code><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml"> generic parameter indicating the query's return type. </span><span class="koboSpan" id="kobo.400.2" xmlns="http://www.w3.org/1999/xhtml">The IQueryHandler interface is also very similar, but its </span><code><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml">Handle</span></code><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml"> method takes an object of type </span><code><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml">TQuery</span></code><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml"> as a parameter and returns a </span><code><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml">TReturn</span></code><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml"> type. </span><span class="koboSpan" id="kobo.406.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml">public interface IQuery&lt;TReturn&gt; { }
public interface IQueryHandler&lt;TQuery, TReturn&gt;
    where TQuery : IQuery&lt;TReturn&gt;
{
    TReturn Handle(TQuery query);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml"> interface allows registering command and query handlers using its </span><code><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml">Register</span></code><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml"> methods. </span><span class="koboSpan" id="kobo.412.2" xmlns="http://www.w3.org/1999/xhtml">It also supports sending commands and queries through its </span><code><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml">Send</span></code><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml"> methods. </span><span class="koboSpan" id="kobo.414.2" xmlns="http://www.w3.org/1999/xhtml">Then we have the </span><code><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml">ChatMessage</span></code><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml"> class, which is similar to the last two samples (with an added creation date):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml">public record class ChatMessage(IParticipant Sender, string Message)
{
    public DateTime Date { get; } = DateTime.UtcNow;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">Next is the updated </span><code><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml"> interface:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml">public interface IParticipant
{
    string Name { get; }
    void Join(IChatRoom chatRoom);
    void Leave(IChatRoom chatRoom);
    void SendMessageTo(IChatRoom chatRoom, string message);
    void NewMessageReceivedFrom(IChatRoom chatRoom, ChatMessage message);
    IEnumerable&lt;IParticipant&gt; ListParticipantsOf(IChatRoom chatRoom);
    IEnumerable&lt;ChatMessage&gt; ListMessagesOf(IChatRoom chatRoom);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">All methods of the </span><code><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml"> interface accept an </span><code><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml"> parameter to support multiple chatrooms. </span><span class="koboSpan" id="kobo.426.2" xmlns="http://www.w3.org/1999/xhtml">The updated </span><code><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml"> interface has a name and a few basic operations to meet the requirement of a chatroom, like adding and removing participants:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml">public interface IChatRoom
{
    string Name { get; }
    void Add(IParticipant participant);
    void Remove(IParticipant participant);
    IEnumerable&lt;IParticipant&gt; ListParticipants();
    void Add(ChatMessage message);
    IEnumerable&lt;ChatMessage&gt; ListMessages();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml">Before going into commands and the chat itself, let’s take a peek at the </span><code><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">Mediator</span></code><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml">public class Mediator : IMediator
{
    private readonly HandlerDictionary _handlers = new();
    public void Register&lt;TCommand&gt;(ICommandHandler&lt;TCommand&gt; commandHandler)
        where TCommand : ICommand
    {
        _handlers.AddHandler(commandHandler);
    }
    public void Register&lt;TQuery, TReturn&gt; (IQueryHandler&lt;TQuery, TReturn&gt; commandHandler)
        where TQuery : IQuery&lt;TReturn&gt;
    {
        _handlers.AddHandler(commandHandler);
    }
    public TReturn Send&lt;TQuery, TReturn&gt;(TQuery query)
        where TQuery : IQuery&lt;TReturn&gt;
    {
        var handler = _handlers.Find&lt;TQuery, TReturn&gt;();
        return handler.Handle(query);
    }
    public void Send&lt;TCommand&gt;(TCommand command)
        where TCommand : ICommand
    {
        var handlers = _handlers.FindAll&lt;TCommand&gt;();
        foreach (var handler in handlers)
        {
            handler.Handle(command);
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml">Mediator</span></code><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml"> class supports registering commands and queries as well as sending a query to a handler or sending a command to zero or more handlers.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml">I omitted the implementation of </span><code><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml">HandlerDictionary</span></code><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml"> because it does not add value to the example, it is just an implementation detail, but it would have added unnecessary complexity. </span><span class="koboSpan" id="kobo.439.2" xmlns="http://www.w3.org/1999/xhtml">It is available on GitHub: </span><a href="https://adpg.link/2Lsm"><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/2Lsm</span></a><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml">Now to the commands. </span><span class="koboSpan" id="kobo.442.2" xmlns="http://www.w3.org/1999/xhtml">I grouped the commands and the handlers together to keep it organized and readable, but you could use another way to organize yours. </span><span class="koboSpan" id="kobo.442.3" xmlns="http://www.w3.org/1999/xhtml">Moreover, since this is a small project, all the commands are in the same file, which would not be viable for something bigger. </span><span class="koboSpan" id="kobo.442.4" xmlns="http://www.w3.org/1999/xhtml">Remember, we are playing LEGO blocks, this chapter covers the CQS pieces, but you can always use them with bigger pieces like Clean Architecture or other types of architecture.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml">We cover ways to organize commands and queries in subsequent chapters.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start with the </span><code><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">JoinChatRoom</span></code><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml"> feature:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml">public class JoinChatRoom
{
    public record class Command(IChatRoom ChatRoom, IParticipant Requester) : ICommand;
    public class Handler : ICommandHandler&lt;Command&gt;
    {
        public void Handle(Command command)
        {
            command.ChatRoom.Add(command.Requester);
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml"> class represents the command itself, a data structure that carries the command data. </span><span class="koboSpan" id="kobo.450.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml"> class handles that type of command. </span><span class="koboSpan" id="kobo.452.2" xmlns="http://www.w3.org/1999/xhtml">When executed, it adds the specified </span><code><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml"> to the specified </span><code><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml">, using the </span><code><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoom</span></code><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml">Requester</span></code><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml"> properties (highlighted line). </span><span class="koboSpan" id="kobo.460.2" xmlns="http://www.w3.org/1999/xhtml">Next feature:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml">public class LeaveChatRoom
{
    public record class Command(IChatRoom ChatRoom, IParticipant Requester) : ICommand;
    public class Handler : ICommandHandler&lt;Command&gt;
    {
        public void Handle(Command command)
        {
            command.ChatRoom.Remove(command.Requester);
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">That code represents the exact opposite of the </span><code><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml">JoinChatRoom</span></code><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml"> command, the </span><code><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml">LeaveChatRoom</span></code><span class="koboSpan" id="kobo.466.1" xmlns="http://www.w3.org/1999/xhtml"> handler removes an </span><code><span class="koboSpan" id="kobo.467.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.468.1" xmlns="http://www.w3.org/1999/xhtml"> from the specified </span><code><span class="koboSpan" id="kobo.469.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.470.1" xmlns="http://www.w3.org/1999/xhtml"> (highlighted line).</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.471.1" xmlns="http://www.w3.org/1999/xhtml">Nesting the classes like this allows reusing the class name </span><code><span class="koboSpan" id="kobo.472.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.473.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.474.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.475.1" xmlns="http://www.w3.org/1999/xhtml"> for each feature.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.476.1" xmlns="http://www.w3.org/1999/xhtml">To the next feature:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.477.1" xmlns="http://www.w3.org/1999/xhtml">public class SendChatMessage
{
    public record class Command(IChatRoom ChatRoom, ChatMessage Message) : ICommand;
    public class Handler : ICommandHandler&lt;Command&gt;
    {
        public void Handle(Command command)
        {
            command.ChatRoom.Add(command.Message);
            var participants = command.ChatRoom.ListParticipants();
            foreach (var participant in participants)
            {
                participant.NewMessageReceivedFrom(
                    command.ChatRoom, 
                    command.Message
                );
            }
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.478.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.479.1" xmlns="http://www.w3.org/1999/xhtml">SendChatMessage</span></code><span class="koboSpan" id="kobo.480.1" xmlns="http://www.w3.org/1999/xhtml"> feature, on the other hand, handles two things (highlighted lines):</span></p>
<ul>
<li><span class="koboSpan" id="kobo.481.1" xmlns="http://www.w3.org/1999/xhtml">It adds the specified </span><code><span class="koboSpan" id="kobo.482.1" xmlns="http://www.w3.org/1999/xhtml">Message</span></code><span class="koboSpan" id="kobo.483.1" xmlns="http://www.w3.org/1999/xhtml"> to </span><code><span class="koboSpan" id="kobo.484.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.485.1" xmlns="http://www.w3.org/1999/xhtml"> (now only a data structure that keeps track of users and past messages).</span></li>
<li><span class="koboSpan" id="kobo.486.1" xmlns="http://www.w3.org/1999/xhtml">It also sends the specified </span><code><span class="koboSpan" id="kobo.487.1" xmlns="http://www.w3.org/1999/xhtml">Message</span></code><span class="koboSpan" id="kobo.488.1" xmlns="http://www.w3.org/1999/xhtml"> to all </span><code><span class="koboSpan" id="kobo.489.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.490.1" xmlns="http://www.w3.org/1999/xhtml"> instances that joined that </span><code><span class="koboSpan" id="kobo.491.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.492.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.493.1" xmlns="http://www.w3.org/1999/xhtml">We are starting to see many smaller pieces interacting with each other to create a more developed system. </span><span class="koboSpan" id="kobo.493.2" xmlns="http://www.w3.org/1999/xhtml">But we are not done; let’s look at the two queries, then the chat implementation:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.494.1" xmlns="http://www.w3.org/1999/xhtml">public class ListParticipants
{
    public record class Query(IChatRoom ChatRoom, IParticipant Requester) : IQuery&lt;IEnumerable&lt;IParticipant&gt;&gt;;
    public class Handler : IQueryHandler&lt;Query, IEnumerable&lt;IParticipant&gt;&gt;
    {
        public IEnumerable&lt;IParticipant&gt; Handle(Query query)
        {
            return query.ChatRoom.ListParticipants();
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.495.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.496.1" xmlns="http://www.w3.org/1999/xhtml">ListParticipants</span></code><span class="koboSpan" id="kobo.497.1" xmlns="http://www.w3.org/1999/xhtml"> handler uses the specified </span><code><span class="koboSpan" id="kobo.498.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.499.1" xmlns="http://www.w3.org/1999/xhtml"> and returns its participants (highlighted line). </span><span class="koboSpan" id="kobo.499.2" xmlns="http://www.w3.org/1999/xhtml">Now, to the last query:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.500.1" xmlns="http://www.w3.org/1999/xhtml">public class ListMessages
{
    public record class Query(IChatRoom ChatRoom, IParticipant Requester) : IQuery&lt;IEnumerable&lt;ChatMessage&gt;&gt;;
    public class Handler : IQueryHandler&lt;Query, IEnumerable&lt;ChatMessage&gt;&gt;
    {
        public IEnumerable&lt;ChatMessage&gt; Handle(Query query)
        {
            return query.ChatRoom.ListMessages();
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.501.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.502.1" xmlns="http://www.w3.org/1999/xhtml">ListMessages</span></code><span class="koboSpan" id="kobo.503.1" xmlns="http://www.w3.org/1999/xhtml"> handler uses the specified </span><code><span class="koboSpan" id="kobo.504.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.505.1" xmlns="http://www.w3.org/1999/xhtml"> instance to return its messages.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.506.1" xmlns="http://www.w3.org/1999/xhtml">Because all commands and queries reference </span><code><span class="koboSpan" id="kobo.507.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.508.1" xmlns="http://www.w3.org/1999/xhtml">, we could enforce rules such as “</span><code><span class="koboSpan" id="kobo.509.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.510.1" xmlns="http://www.w3.org/1999/xhtml"> must join a channel before sending messages,” for example. </span><span class="koboSpan" id="kobo.510.2" xmlns="http://www.w3.org/1999/xhtml">I decided to omit these details to keep the code simple, but feel free to add those features if you want to.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.511.1" xmlns="http://www.w3.org/1999/xhtml">Next, let’s take a look at the </span><code><span class="koboSpan" id="kobo.512.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoom</span></code><span class="koboSpan" id="kobo.513.1" xmlns="http://www.w3.org/1999/xhtml"> class, which is a simple data structure that holds the state of a chatroom:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.514.1" xmlns="http://www.w3.org/1999/xhtml">public class ChatRoom : IChatRoom
{
    private readonly List&lt;IParticipant&gt; _participants = new List&lt;IParticipant&gt;();
    private readonly List&lt;ChatMessage&gt; _chatMessages = new List&lt;ChatMessage&gt;();
    public ChatRoom(string name)
    {
        Name = name ?? </span><span class="koboSpan" id="kobo.514.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(name));
    }
    public string Name { get; }
    public void Add(IParticipant participant)
    {
        _participants.Add(participant);
    }
    public void Add(ChatMessage message)
    {
        _chatMessages.Add(message);
    }
    public IEnumerable&lt;ChatMessage&gt; ListMessages()
    {
        return _chatMessages.AsReadOnly();
    }
    public IEnumerable&lt;IParticipant&gt; ListParticipants()
    {
        return _participants.AsReadOnly();
    }
    public void Remove(IParticipant participant)
    {
        _participants.Remove(participant);
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.515.1" xmlns="http://www.w3.org/1999/xhtml">If we take a second look at the </span><code><span class="koboSpan" id="kobo.516.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoom</span></code><span class="koboSpan" id="kobo.517.1" xmlns="http://www.w3.org/1999/xhtml"> class, it has a </span><code><span class="koboSpan" id="kobo.518.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.519.1" xmlns="http://www.w3.org/1999/xhtml"> property. </span><span class="koboSpan" id="kobo.519.2" xmlns="http://www.w3.org/1999/xhtml">It contains a list of </span><code><span class="koboSpan" id="kobo.520.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.521.1" xmlns="http://www.w3.org/1999/xhtml"> instances and a list of </span><code><span class="koboSpan" id="kobo.522.1" xmlns="http://www.w3.org/1999/xhtml">ChatMessage</span></code><span class="koboSpan" id="kobo.523.1" xmlns="http://www.w3.org/1999/xhtml"> instances. </span><span class="koboSpan" id="kobo.523.2" xmlns="http://www.w3.org/1999/xhtml">Both </span><code><span class="koboSpan" id="kobo.524.1" xmlns="http://www.w3.org/1999/xhtml">ListMessages()</span></code><span class="koboSpan" id="kobo.525.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.526.1" xmlns="http://www.w3.org/1999/xhtml">ListParticipants()</span></code><span class="koboSpan" id="kobo.527.1" xmlns="http://www.w3.org/1999/xhtml"> return the list </span><code><span class="koboSpan" id="kobo.528.1" xmlns="http://www.w3.org/1999/xhtml">AsReadOnly()</span></code><span class="koboSpan" id="kobo.529.1" xmlns="http://www.w3.org/1999/xhtml">, so a clever programmer cannot mutate the state of </span><code><span class="koboSpan" id="kobo.530.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoom</span></code><span class="koboSpan" id="kobo.531.1" xmlns="http://www.w3.org/1999/xhtml"> from the outside. </span><span class="koboSpan" id="kobo.531.2" xmlns="http://www.w3.org/1999/xhtml">That’s it; the new </span><code><span class="koboSpan" id="kobo.532.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoom</span></code><span class="koboSpan" id="kobo.533.1" xmlns="http://www.w3.org/1999/xhtml"> class is a façade over its underlying dependencies.Finally, the </span><code><span class="koboSpan" id="kobo.534.1" xmlns="http://www.w3.org/1999/xhtml">Participant</span></code><span class="koboSpan" id="kobo.535.1" xmlns="http://www.w3.org/1999/xhtml"> class is probably the most exciting part of this system because it is the one that makes heavy use of our Mediator and CQS:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.536.1" xmlns="http://www.w3.org/1999/xhtml">public class Participant : IParticipant
{
    private readonly IMediator _mediator;
    private readonly IMessageWriter _messageWriter;
    public Participant(IMediator mediator, string name, IMessageWriter messageWriter)
    {
        _mediator = mediator ?? </span><span class="koboSpan" id="kobo.536.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(mediator));
        Name = name ?? </span><span class="koboSpan" id="kobo.536.3" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(name));
        _messageWriter = messageWriter ?? </span><span class="koboSpan" id="kobo.536.4" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(messageWriter));
    }
    public string Name { get; }
    public void Join(IChatRoom chatRoom)
    {
        _mediator.Send(new JoinChatRoom.Command(chatRoom, this));
    }
    public void Leave(IChatRoom chatRoom)
    {
        _mediator.Send(new LeaveChatRoom.Command(chatRoom, this));
    }
    public IEnumerable&lt;ChatMessage&gt; ListMessagesOf(IChatRoom chatRoom)
    {
        return _mediator.Send&lt;ListMessages.Query, IEnumerable&lt;ChatMessage&gt;&gt;(new ListMessages.Query(chatRoom, this));
    }
    public IEnumerable&lt;IParticipant&gt; ListParticipantsOf(IChatRoom chatRoom)
    {
        return _mediator.Send&lt;ListParticipants.Query, IEnumerable&lt;IParticipant&gt;&gt;(new ListParticipants.Query(chatRoom, this));
    }
    public void NewMessageReceivedFrom(IChatRoom chatRoom, ChatMessage message)
    {
        _messageWriter.Write(chatRoom, message);
    }
    public void SendMessageTo(IChatRoom chatRoom, string message)
    {
        _mediator.Send(new SendChatMessage.Command (chatRoom, new ChatMessage(this, message)));
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.537.1" xmlns="http://www.w3.org/1999/xhtml">Every method of the </span><code><span class="koboSpan" id="kobo.538.1" xmlns="http://www.w3.org/1999/xhtml">Participant</span></code><span class="koboSpan" id="kobo.539.1" xmlns="http://www.w3.org/1999/xhtml"> class, apart from </span><code><span class="koboSpan" id="kobo.540.1" xmlns="http://www.w3.org/1999/xhtml">NewMessageReceivedFrom</span></code><span class="koboSpan" id="kobo.541.1" xmlns="http://www.w3.org/1999/xhtml">, sends a command or a query through the </span><code><span class="koboSpan" id="kobo.542.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.543.1" xmlns="http://www.w3.org/1999/xhtml"> interface, breaking the tight coupling between the participants and the system’s operations (that is, the commands and queries). </span><span class="koboSpan" id="kobo.543.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.544.1" xmlns="http://www.w3.org/1999/xhtml">Participant</span></code><span class="koboSpan" id="kobo.545.1" xmlns="http://www.w3.org/1999/xhtml"> class is also a simple façade over its underlying dependencies, delegating most of the work to the mediator.Now that we have covered the numerous tiny pieces let’s look at how everything works together. </span><span class="koboSpan" id="kobo.545.2" xmlns="http://www.w3.org/1999/xhtml">I grouped several test cases that share the following setup code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.546.1" xmlns="http://www.w3.org/1999/xhtml">public class ChatRoomTest
{
    private readonly IMediator _mediator = new Mediator();
    private readonly TestMessageWriter _reagenMessageWriter = new();
    private readonly TestMessageWriter _garnerMessageWriter = new();
    private readonly TestMessageWriter _corneliaMessageWriter = new();
    private readonly IChatRoom _room1 = new ChatRoom("Room 1");
    private readonly IChatRoom _room2 = new ChatRoom("Room 2");
    private readonly IParticipant _reagen;
    private readonly IParticipant _garner;
    private readonly IParticipant _cornelia;
    public ChatRoomTest()
    {
        _mediator.Register(new JoinChatRoom.Handler());
        _mediator.Register(new LeaveChatRoom.Handler());
        _mediator.Register(new SendChatMessage.Handler());
        _mediator.Register(new ListParticipants.Handler());
        _mediator.Register(new ListMessages.Handler());
        _reagen = new Participant(_mediator, "Reagen", _reagenMessageWriter);
        _garner = new Participant(_mediator, "Garner", _garnerMessageWriter);
        _cornelia = new Participant(_mediator, "Cornelia", _corneliaMessageWriter);
    }
    // Omited test cases and helpers
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.547.1" xmlns="http://www.w3.org/1999/xhtml">The test program setup is composed of the following:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.548.1" xmlns="http://www.w3.org/1999/xhtml">One </span><code><span class="koboSpan" id="kobo.549.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.550.1" xmlns="http://www.w3.org/1999/xhtml"> field initialized with a </span><code><span class="koboSpan" id="kobo.551.1" xmlns="http://www.w3.org/1999/xhtml">Mediator</span></code><span class="koboSpan" id="kobo.552.1" xmlns="http://www.w3.org/1999/xhtml"> instance, which enables all colleagues to interact with each other.</span></li>
<li><span class="koboSpan" id="kobo.553.1" xmlns="http://www.w3.org/1999/xhtml">Two </span><code><span class="koboSpan" id="kobo.554.1" xmlns="http://www.w3.org/1999/xhtml">IChatRoom</span></code><span class="koboSpan" id="kobo.555.1" xmlns="http://www.w3.org/1999/xhtml"> fields initialized with </span><code><span class="koboSpan" id="kobo.556.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoom</span></code><span class="koboSpan" id="kobo.557.1" xmlns="http://www.w3.org/1999/xhtml"> instances.</span></li>
<li><span class="koboSpan" id="kobo.558.1" xmlns="http://www.w3.org/1999/xhtml">Three </span><code><span class="koboSpan" id="kobo.559.1" xmlns="http://www.w3.org/1999/xhtml">IParticipant</span></code><span class="koboSpan" id="kobo.560.1" xmlns="http://www.w3.org/1999/xhtml"> uninitialized fields, later initialized with </span><code><span class="koboSpan" id="kobo.561.1" xmlns="http://www.w3.org/1999/xhtml">Participant</span></code><span class="koboSpan" id="kobo.562.1" xmlns="http://www.w3.org/1999/xhtml"> instances.</span></li>
<li><span class="koboSpan" id="kobo.563.1" xmlns="http://www.w3.org/1999/xhtml">Three </span><code><span class="koboSpan" id="kobo.564.1" xmlns="http://www.w3.org/1999/xhtml">TestMessageWriter</span></code><span class="koboSpan" id="kobo.565.1" xmlns="http://www.w3.org/1999/xhtml"> instances, one per participant.</span></li>
<li><span class="koboSpan" id="kobo.566.1" xmlns="http://www.w3.org/1999/xhtml">The constructor registers all handlers with the </span><code><span class="koboSpan" id="kobo.567.1" xmlns="http://www.w3.org/1999/xhtml">Mediator</span></code><span class="koboSpan" id="kobo.568.1" xmlns="http://www.w3.org/1999/xhtml"> instance so it knows how to handle commands and queries. </span><span class="koboSpan" id="kobo.568.2" xmlns="http://www.w3.org/1999/xhtml">It also creates the participants.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.569.1" xmlns="http://www.w3.org/1999/xhtml">Once again, the names of the participants are randomly generated.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.570.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.571.1" xmlns="http://www.w3.org/1999/xhtml">TestMessageWriter</span></code><span class="koboSpan" id="kobo.572.1" xmlns="http://www.w3.org/1999/xhtml"> implementation is a little different and accumulates the data in a list of tuples (</span><code><span class="koboSpan" id="kobo.573.1" xmlns="http://www.w3.org/1999/xhtml">List&lt;(IChatRoom, ChatMessage)&gt;</span></code><span class="koboSpan" id="kobo.574.1" xmlns="http://www.w3.org/1999/xhtml">) to assess what the participants send:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.575.1" xmlns="http://www.w3.org/1999/xhtml">private class TestMessageWriter : IMessageWriter
{
    public List&lt;(IChatRoom chatRoom, ChatMessage message)&gt; Output { get; } = new();
    public void Write(IChatRoom chatRoom, ChatMessage message)
    {
        Output.Add((chatRoom, message));
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.576.1" xmlns="http://www.w3.org/1999/xhtml">Here is the first test case:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.577.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void A_participant_should_be_able_to_list_the_participants_that_joined_a_chatroom()
{
    _reagen.Join(_room1);
    _reagen.Join(_room2);
    _garner.Join(_room1);
    _cornelia.Join(_room2);
    var room1Participants = _reagen.ListParticipantsOf(_room1);
    Assert.Collection(room1Participants,
        p =&gt; Assert.Same(_reagen, p),
        p =&gt; Assert.Same(_garner, p)
    );
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.578.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding test case, Reagen and Garner join Room 1, while Reagen and Cornelia join Room 2. </span><span class="koboSpan" id="kobo.578.2" xmlns="http://www.w3.org/1999/xhtml">Then Reagen requests the list of participants from Room 1, which outputs Reagen and Garner. </span><span class="koboSpan" id="kobo.578.3" xmlns="http://www.w3.org/1999/xhtml">Under the hood, it uses commands and queries through a mediator, breaking tight coupling between the colleagues. </span><span class="koboSpan" id="kobo.578.4" xmlns="http://www.w3.org/1999/xhtml">Here is a sequence diagram representing what happens when a participant joins a chatroom:</span></p>
<figure>
<span class="koboSpan" id="kobo.579.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.10: Sequence diagram representing the flow of a participant (p) joining a chatroom (c)" src="../media/file108.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.580.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.10: Sequence diagram representing the flow of a participant (p) joining a chatroom (c)</span></figcaption>
</figure>
<ol>
<li><span class="koboSpan" id="kobo.581.1" xmlns="http://www.w3.org/1999/xhtml">The participant (</span><code><span class="koboSpan" id="kobo.582.1" xmlns="http://www.w3.org/1999/xhtml">p</span></code><span class="koboSpan" id="kobo.583.1" xmlns="http://www.w3.org/1999/xhtml">) creates a </span><code><span class="koboSpan" id="kobo.584.1" xmlns="http://www.w3.org/1999/xhtml">JoinChatRoom</span></code><span class="koboSpan" id="kobo.585.1" xmlns="http://www.w3.org/1999/xhtml"> command (</span><code><span class="koboSpan" id="kobo.586.1" xmlns="http://www.w3.org/1999/xhtml">joinCmd</span></code><span class="koboSpan" id="kobo.587.1" xmlns="http://www.w3.org/1999/xhtml">).</span></li>
<li><code><span class="koboSpan" id="kobo.588.1" xmlns="http://www.w3.org/1999/xhtml">p</span></code><span class="koboSpan" id="kobo.589.1" xmlns="http://www.w3.org/1999/xhtml"> sends </span><code><span class="koboSpan" id="kobo.590.1" xmlns="http://www.w3.org/1999/xhtml">joinCmd</span></code><span class="koboSpan" id="kobo.591.1" xmlns="http://www.w3.org/1999/xhtml"> through the mediator (</span><code><span class="koboSpan" id="kobo.592.1" xmlns="http://www.w3.org/1999/xhtml">m</span></code><span class="koboSpan" id="kobo.593.1" xmlns="http://www.w3.org/1999/xhtml">).</span></li>
<li><code><span class="koboSpan" id="kobo.594.1" xmlns="http://www.w3.org/1999/xhtml">m</span></code><span class="koboSpan" id="kobo.595.1" xmlns="http://www.w3.org/1999/xhtml"> finds and dispatches </span><code><span class="koboSpan" id="kobo.596.1" xmlns="http://www.w3.org/1999/xhtml">joinCmd</span></code><span class="koboSpan" id="kobo.597.1" xmlns="http://www.w3.org/1999/xhtml"> to its handler (</span><code><span class="koboSpan" id="kobo.598.1" xmlns="http://www.w3.org/1999/xhtml">handler</span></code><span class="koboSpan" id="kobo.599.1" xmlns="http://www.w3.org/1999/xhtml">).</span></li>
<li><code><span class="koboSpan" id="kobo.600.1" xmlns="http://www.w3.org/1999/xhtml">handler</span></code><span class="koboSpan" id="kobo.601.1" xmlns="http://www.w3.org/1999/xhtml"> executes the logic (adds </span><code><span class="koboSpan" id="kobo.602.1" xmlns="http://www.w3.org/1999/xhtml">p</span></code><span class="koboSpan" id="kobo.603.1" xmlns="http://www.w3.org/1999/xhtml"> to the chatroom).</span></li>
<li><code><span class="koboSpan" id="kobo.604.1" xmlns="http://www.w3.org/1999/xhtml">joinCmd</span></code><span class="koboSpan" id="kobo.605.1" xmlns="http://www.w3.org/1999/xhtml"> ceases to exist afterward; commands are ephemeral.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.606.1" xmlns="http://www.w3.org/1999/xhtml">That means </span><code><span class="koboSpan" id="kobo.607.1" xmlns="http://www.w3.org/1999/xhtml">Participant</span></code><span class="koboSpan" id="kobo.608.1" xmlns="http://www.w3.org/1999/xhtml"> never interacts directly with </span><code><span class="koboSpan" id="kobo.609.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoom</span></code><span class="koboSpan" id="kobo.610.1" xmlns="http://www.w3.org/1999/xhtml"> or other participants.Then a similar workflow happens when a participant requests the list of participants of a chatroom:</span></p>
<figure>
<span class="koboSpan" id="kobo.611.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.11: Sequence diagram representing the flow of a participant (p) requesting the list of participants of a chatroom (c)" src="../media/file109.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.612.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.11: Sequence diagram representing the flow of a participant (p) requesting the list of participants of a chatroom (c)</span></figcaption>
</figure>
<ol>
<li><code><span class="koboSpan" id="kobo.613.1" xmlns="http://www.w3.org/1999/xhtml">Participant</span></code><span class="koboSpan" id="kobo.614.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><code><span class="koboSpan" id="kobo.615.1" xmlns="http://www.w3.org/1999/xhtml">p</span></code><span class="koboSpan" id="kobo.616.1" xmlns="http://www.w3.org/1999/xhtml">) creates a </span><code><span class="koboSpan" id="kobo.617.1" xmlns="http://www.w3.org/1999/xhtml">ListParticipants</span></code><span class="koboSpan" id="kobo.618.1" xmlns="http://www.w3.org/1999/xhtml"> query (</span><code><span class="koboSpan" id="kobo.619.1" xmlns="http://www.w3.org/1999/xhtml">listQuery</span></code><span class="koboSpan" id="kobo.620.1" xmlns="http://www.w3.org/1999/xhtml">).</span></li>
<li><code><span class="koboSpan" id="kobo.621.1" xmlns="http://www.w3.org/1999/xhtml">p</span></code><span class="koboSpan" id="kobo.622.1" xmlns="http://www.w3.org/1999/xhtml"> sends </span><code><span class="koboSpan" id="kobo.623.1" xmlns="http://www.w3.org/1999/xhtml">listQuery</span></code><span class="koboSpan" id="kobo.624.1" xmlns="http://www.w3.org/1999/xhtml"> through the mediator (</span><code><span class="koboSpan" id="kobo.625.1" xmlns="http://www.w3.org/1999/xhtml">m</span></code><span class="koboSpan" id="kobo.626.1" xmlns="http://www.w3.org/1999/xhtml">).</span></li>
<li><code><span class="koboSpan" id="kobo.627.1" xmlns="http://www.w3.org/1999/xhtml">m</span></code><span class="koboSpan" id="kobo.628.1" xmlns="http://www.w3.org/1999/xhtml"> finds and dispatches the query to its handler (</span><code><span class="koboSpan" id="kobo.629.1" xmlns="http://www.w3.org/1999/xhtml">handler</span></code><span class="koboSpan" id="kobo.630.1" xmlns="http://www.w3.org/1999/xhtml">).</span></li>
<li><code><span class="koboSpan" id="kobo.631.1" xmlns="http://www.w3.org/1999/xhtml">handler</span></code><span class="koboSpan" id="kobo.632.1" xmlns="http://www.w3.org/1999/xhtml"> executes the logic (lists the participants of the chatroom).</span></li>
<li><code><span class="koboSpan" id="kobo.633.1" xmlns="http://www.w3.org/1999/xhtml">listQuery</span></code><span class="koboSpan" id="kobo.634.1" xmlns="http://www.w3.org/1999/xhtml"> ceases to exist afterward; queries are also ephemeral.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.635.1" xmlns="http://www.w3.org/1999/xhtml">Once again, </span><code><span class="koboSpan" id="kobo.636.1" xmlns="http://www.w3.org/1999/xhtml">Participant</span></code><span class="koboSpan" id="kobo.637.1" xmlns="http://www.w3.org/1999/xhtml"> does not interact directly with </span><code><span class="koboSpan" id="kobo.638.1" xmlns="http://www.w3.org/1999/xhtml">ChatRoom</span></code><span class="koboSpan" id="kobo.639.1" xmlns="http://www.w3.org/1999/xhtml">.Here is another test case where </span><code><span class="koboSpan" id="kobo.640.1" xmlns="http://www.w3.org/1999/xhtml">Participant</span></code><span class="koboSpan" id="kobo.641.1" xmlns="http://www.w3.org/1999/xhtml"> sends a message to a chatroom, and another </span><code><span class="koboSpan" id="kobo.642.1" xmlns="http://www.w3.org/1999/xhtml">Participant</span></code><span class="koboSpan" id="kobo.643.1" xmlns="http://www.w3.org/1999/xhtml"> receives it:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.644.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void A_participant_should_receive_new_messages()
{
    _reagen.Join(_room1);
    _garner.Join(_room1);
    _garner.Join(_room2);
    _reagen.SendMessageTo(_room1, "Hello!");
    Assert.Collection(_garnerMessageWriter.Output,
    line =&gt;
    {
        Assert.Equal(_room1, line.chatRoom);
        Assert.Equal(_reagen, line.message.Sender);
        Assert.Equal("Hello!", line.message.Message);
    }
  );
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.645.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding test case, Reagen joins Room 1 while Garner joins Rooms 1 and 2. </span><span class="koboSpan" id="kobo.645.2" xmlns="http://www.w3.org/1999/xhtml">Then Reagen sends a message to Room 1, and we verify that Garner received it once.The </span><code><span class="koboSpan" id="kobo.646.1" xmlns="http://www.w3.org/1999/xhtml">SendMessageTo</span></code><span class="koboSpan" id="kobo.647.1" xmlns="http://www.w3.org/1999/xhtml"> workflow is very similar to the other one that we saw but with a more complex command handler:</span></p>
<figure>
<span class="koboSpan" id="kobo.648.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 16.12: Sequence diagram representing the flow of a participant (p) sending a message (msg)to a chatroom (c)" src="../media/file110.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.649.1" xmlns="http://www.w3.org/1999/xhtml">Figure 16.12: Sequence diagram representing the flow of a participant (p) sending a message (msg)to a chatroom (c)</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.650.1" xmlns="http://www.w3.org/1999/xhtml">From that diagram, we can observe that we pushed the logic to the </span><code><span class="koboSpan" id="kobo.651.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.652.1" xmlns="http://www.w3.org/1999/xhtml"> class of the </span><code><span class="koboSpan" id="kobo.653.1" xmlns="http://www.w3.org/1999/xhtml">SendChatMessage</span></code><span class="koboSpan" id="kobo.654.1" xmlns="http://www.w3.org/1999/xhtml"> feature. </span><span class="koboSpan" id="kobo.654.2" xmlns="http://www.w3.org/1999/xhtml">All the other actors work together with limited to no knowledge of each other.This demonstrates how CQS works with a mediator:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.655.1" xmlns="http://www.w3.org/1999/xhtml">A consumer (the participant in this case) creates a command (or a query).</span></li>
<li><span class="koboSpan" id="kobo.656.1" xmlns="http://www.w3.org/1999/xhtml">The consumer sends that command through the mediator.</span></li>
<li><span class="koboSpan" id="kobo.657.1" xmlns="http://www.w3.org/1999/xhtml">The mediator sends that command to one or more handlers, each executing their piece of logic for that command.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.658.1" xmlns="http://www.w3.org/1999/xhtml">You can explore the other test cases to familiarize yourself with the program and the concepts.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.659.1" xmlns="http://www.w3.org/1999/xhtml">You can debug the tests in Visual Studio; use breakpoints combined with </span><em><span class="koboSpan" id="kobo.660.1" xmlns="http://www.w3.org/1999/xhtml">Step Into (F11)</span></em><span class="koboSpan" id="kobo.661.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><em><span class="koboSpan" id="kobo.662.1" xmlns="http://www.w3.org/1999/xhtml">Step Over (F10)</span></em><span class="koboSpan" id="kobo.663.1" xmlns="http://www.w3.org/1999/xhtml"> to explore the sample.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.664.1" xmlns="http://www.w3.org/1999/xhtml">I also created a </span><code><span class="koboSpan" id="kobo.665.1" xmlns="http://www.w3.org/1999/xhtml">ChatModerator</span></code><span class="koboSpan" id="kobo.666.1" xmlns="http://www.w3.org/1999/xhtml"> instance that sends a message in a “moderator chatroom” when a message contains a word from the </span><code><span class="koboSpan" id="kobo.667.1" xmlns="http://www.w3.org/1999/xhtml">badWords</span></code><span class="koboSpan" id="kobo.668.1" xmlns="http://www.w3.org/1999/xhtml"> collection. </span><span class="koboSpan" id="kobo.668.2" xmlns="http://www.w3.org/1999/xhtml">That test case executes multiple handlers for each </span><code><span class="koboSpan" id="kobo.669.1" xmlns="http://www.w3.org/1999/xhtml">SendChatMessage.Command</span></code><span class="koboSpan" id="kobo.670.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.670.2" xmlns="http://www.w3.org/1999/xhtml">I’ll leave you to explore these other test cases yourself so we don’t wander astray from our goal.</span></p>
</section>
<section class="level3" data-number="17.4.4" id="conclusion-24">
<h3 data-number="17.4.4"><span class="koboSpan" id="kobo.671.1" xmlns="http://www.w3.org/1999/xhtml">Conclusion</span></h3>
<p><span class="koboSpan" id="kobo.672.1" xmlns="http://www.w3.org/1999/xhtml">The CQS and CQRS patterns suggest dividing the operations of a program into </span><strong><span class="koboSpan" id="kobo.673.1" xmlns="http://www.w3.org/1999/xhtml">commands</span></strong><span class="koboSpan" id="kobo.674.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><strong><span class="koboSpan" id="kobo.675.1" xmlns="http://www.w3.org/1999/xhtml">queries</span></strong><span class="koboSpan" id="kobo.676.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.676.2" xmlns="http://www.w3.org/1999/xhtml">A command mutates data, and a query fetches data. </span><span class="koboSpan" id="kobo.676.3" xmlns="http://www.w3.org/1999/xhtml">We can apply the </span><strong><span class="koboSpan" id="kobo.677.1" xmlns="http://www.w3.org/1999/xhtml">Mediator</span></strong><span class="koboSpan" id="kobo.678.1" xmlns="http://www.w3.org/1999/xhtml"> pattern to break the tight coupling between the pieces of a program using CQS, like sending commands and queries.Dividing the program this way helps separate the different pieces and focus on the commands and queries that travel from a consumer through the mediator to one or more handlers. </span><span class="koboSpan" id="kobo.678.2" xmlns="http://www.w3.org/1999/xhtml">The data contract of commands and queries becomes the program’s backbone, trimming down the coupling between objects and tying them to those thin data structures instead, leaving the central piece (the mediator) to manage the links between them.On the other hand, you may find the codebase more intimidating when using CQS due to the multiple classes. </span><span class="koboSpan" id="kobo.678.3" xmlns="http://www.w3.org/1999/xhtml">It adds some complexity, especially for a small program like this. </span><span class="koboSpan" id="kobo.678.4" xmlns="http://www.w3.org/1999/xhtml">However, each type does less (having a single responsibility), making it easier to test than a more sizable class with many responsibilities.Now let’s see how CQRS can help us follow the </span><strong><span class="koboSpan" id="kobo.679.1" xmlns="http://www.w3.org/1999/xhtml">SOLID</span></strong><span class="koboSpan" id="kobo.680.1" xmlns="http://www.w3.org/1999/xhtml"> principles:</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.681.1" xmlns="http://www.w3.org/1999/xhtml">S</span></strong><span class="koboSpan" id="kobo.682.1" xmlns="http://www.w3.org/1999/xhtml">: Dividing an application into commands, queries, and handlers takes us toward encapsulating single responsibilities into different classes.</span></li>
<li><strong><span class="koboSpan" id="kobo.683.1" xmlns="http://www.w3.org/1999/xhtml">O</span></strong><span class="koboSpan" id="kobo.684.1" xmlns="http://www.w3.org/1999/xhtml">: CQS helps extend the software without modifying the existing code, such as adding handlers and creating new commands.</span></li>
<li><strong><span class="koboSpan" id="kobo.685.1" xmlns="http://www.w3.org/1999/xhtml">L</span></strong><span class="koboSpan" id="kobo.686.1" xmlns="http://www.w3.org/1999/xhtml">: N/A</span></li>
<li><strong><span class="koboSpan" id="kobo.687.1" xmlns="http://www.w3.org/1999/xhtml">I</span></strong><span class="koboSpan" id="kobo.688.1" xmlns="http://www.w3.org/1999/xhtml">: CQS makes it easier to create multiple small interfaces with a clear distinction between commands, queries, and their respective handlers.</span></li>
<li><strong><span class="koboSpan" id="kobo.689.1" xmlns="http://www.w3.org/1999/xhtml">D</span></strong><span class="koboSpan" id="kobo.690.1" xmlns="http://www.w3.org/1999/xhtml">: N/A</span></li>
</ul>
<p><span class="koboSpan" id="kobo.691.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have explored CQRS, CQS, and the Mediator pattern, we explore the Marker Interfaces.</span></p>
</section>
</section>
<section class="level2" data-number="17.5" id="code-smell-marker-interfaces">
<h2 data-number="17.5"><span class="koboSpan" id="kobo.692.1" xmlns="http://www.w3.org/1999/xhtml">Code smell – Marker Interfaces</span></h2>
<p><span class="koboSpan" id="kobo.693.1" xmlns="http://www.w3.org/1999/xhtml">We used the empty </span><code><span class="koboSpan" id="kobo.694.1" xmlns="http://www.w3.org/1999/xhtml">ICommand</span></code><span class="koboSpan" id="kobo.695.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.696.1" xmlns="http://www.w3.org/1999/xhtml">IQuery&lt;TReturn&gt;</span></code><span class="koboSpan" id="kobo.697.1" xmlns="http://www.w3.org/1999/xhtml"> interfaces in the code samples to make the code more explicit and self-descriptive. </span><span class="koboSpan" id="kobo.697.2" xmlns="http://www.w3.org/1999/xhtml">Empty interfaces are a sign that something may be wrong: a code smell. </span><span class="koboSpan" id="kobo.697.3" xmlns="http://www.w3.org/1999/xhtml">We call those </span><strong><span class="koboSpan" id="kobo.698.1" xmlns="http://www.w3.org/1999/xhtml">marker interfaces</span></strong><span class="koboSpan" id="kobo.699.1" xmlns="http://www.w3.org/1999/xhtml">.In our case, they help identify commands and queries but are empty and add nothing. </span><span class="koboSpan" id="kobo.699.2" xmlns="http://www.w3.org/1999/xhtml">We could discard them without any impact on our system. </span><span class="koboSpan" id="kobo.699.3" xmlns="http://www.w3.org/1999/xhtml">On the other hand, we are not performing magic tricks or violating any principles, so they don’t harm but help define the intent. </span><span class="koboSpan" id="kobo.699.4" xmlns="http://www.w3.org/1999/xhtml">Moreover, we could leverage them to make the code more dynamic, like leveraging dependency injection to register handlers. </span><span class="koboSpan" id="kobo.699.5" xmlns="http://www.w3.org/1999/xhtml">Furthermore, I designed those interfaces this way as a bridge to the next project.Back to the marker interfaces, here are two types of marker interfaces that are code smells in C#:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.700.1" xmlns="http://www.w3.org/1999/xhtml">Metadata</span></li>
<li><span class="koboSpan" id="kobo.701.1" xmlns="http://www.w3.org/1999/xhtml">Dependency identifier</span></li>
</ul>
<section class="level3" data-number="17.5.1" id="metadata-1">
<h3 data-number="17.5.1"><span class="koboSpan" id="kobo.702.1" xmlns="http://www.w3.org/1999/xhtml">Metadata</span></h3>
<p><span class="koboSpan" id="kobo.703.1" xmlns="http://www.w3.org/1999/xhtml">Markers can be used to define metadata. </span><span class="koboSpan" id="kobo.703.2" xmlns="http://www.w3.org/1999/xhtml">A class “implements” the empty interface, and some consumer does something with it later. </span><span class="koboSpan" id="kobo.703.3" xmlns="http://www.w3.org/1999/xhtml">It could be an assembly scanning for specific types, a choice of strategy, or something else.Instead of creating marker interfaces to add metadata, try to use custom attributes. </span><span class="koboSpan" id="kobo.703.4" xmlns="http://www.w3.org/1999/xhtml">The idea behind attributes is to add metadata to classes and their members. </span><span class="koboSpan" id="kobo.703.5" xmlns="http://www.w3.org/1999/xhtml">On the other hand, interfaces exist to create a contract, and they should define at least one member; empty contracts are like a blank sheet.In a real-world scenario, you may want to consider the cost of one versus the other. </span><span class="koboSpan" id="kobo.703.6" xmlns="http://www.w3.org/1999/xhtml">Markers are very cheap to implement but can violate architectural principles. </span><span class="koboSpan" id="kobo.703.7" xmlns="http://www.w3.org/1999/xhtml">Attributes can be as cheap to implement if the mechanism is already implemented or supported by the framework but can cost much more than a marker interface, depending on the scenario. </span><span class="koboSpan" id="kobo.703.8" xmlns="http://www.w3.org/1999/xhtml">Before deciding, I recommend you evaluate the cost of both options.</span></p>
</section>
<section class="level3" data-number="17.5.2" id="dependency-identifier">
<h3 data-number="17.5.2"><span class="koboSpan" id="kobo.704.1" xmlns="http://www.w3.org/1999/xhtml">Dependency identifier</span></h3>
<p><span class="koboSpan" id="kobo.705.1" xmlns="http://www.w3.org/1999/xhtml">If you need markers to inject some specific dependency in a particular class, you are most likely cheating the </span><strong><span class="koboSpan" id="kobo.706.1" xmlns="http://www.w3.org/1999/xhtml">Inversion of Control</span></strong><span class="koboSpan" id="kobo.707.1" xmlns="http://www.w3.org/1999/xhtml"> principle. </span><span class="koboSpan" id="kobo.707.2" xmlns="http://www.w3.org/1999/xhtml">Instead, you should find a way to achieve the same goal using dependency injection, such as by contextually injecting your dependencies.Let’s start with the following interface:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.708.1" xmlns="http://www.w3.org/1999/xhtml">public interface IStrategy
{
    string Execute();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.709.1" xmlns="http://www.w3.org/1999/xhtml">In our program, we have two implementations and two markers, one for each implementation:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.710.1" xmlns="http://www.w3.org/1999/xhtml">public interface IStrategyA : IStrategy { }
public interface IStrategyB : IStrategy { }
public class StrategyA : IStrategyA
{
    public string Execute() =&gt; "StrategyA";
}
public class StrategyB : IStrategyB
{
    public string Execute() =&gt; "StrategyB";
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.711.1" xmlns="http://www.w3.org/1999/xhtml">The code is barebones, but all the building blocks are there:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.712.1" xmlns="http://www.w3.org/1999/xhtml">StrategyA</span></code><span class="koboSpan" id="kobo.713.1" xmlns="http://www.w3.org/1999/xhtml"> implements </span><code><span class="koboSpan" id="kobo.714.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyA</span></code><span class="koboSpan" id="kobo.715.1" xmlns="http://www.w3.org/1999/xhtml">, which inherits from </span><code><span class="koboSpan" id="kobo.716.1" xmlns="http://www.w3.org/1999/xhtml">IStrategy</span></code><span class="koboSpan" id="kobo.717.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><code><span class="koboSpan" id="kobo.718.1" xmlns="http://www.w3.org/1999/xhtml">StrategyB</span></code><span class="koboSpan" id="kobo.719.1" xmlns="http://www.w3.org/1999/xhtml"> implements </span><code><span class="koboSpan" id="kobo.720.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyB</span></code><span class="koboSpan" id="kobo.721.1" xmlns="http://www.w3.org/1999/xhtml">, which inherits from </span><code><span class="koboSpan" id="kobo.722.1" xmlns="http://www.w3.org/1999/xhtml">IStrategy</span></code><span class="koboSpan" id="kobo.723.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><span class="koboSpan" id="kobo.724.1" xmlns="http://www.w3.org/1999/xhtml">Both </span><code><span class="koboSpan" id="kobo.725.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyA</span></code><span class="koboSpan" id="kobo.726.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.727.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyB</span></code><span class="koboSpan" id="kobo.728.1" xmlns="http://www.w3.org/1999/xhtml"> are empty marker interfaces.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.729.1" xmlns="http://www.w3.org/1999/xhtml">Now, the consumer needs to use both strategies, so instead of controlling dependencies from the composition root, the consumer requests the markers:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.730.1" xmlns="http://www.w3.org/1999/xhtml">public class Consumer
{
    public IStrategyA StrategyA { get; }
    public IStrategyB StrategyB { get; }
    public Consumer(IStrategyA strategyA, IStrategyB strategyB)
    {
        StrategyA = strategyA ?? </span><span class="koboSpan" id="kobo.730.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(strategyA));
        StrategyB = strategyB ?? </span><span class="koboSpan" id="kobo.730.3" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(strategyB));
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.731.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.732.1" xmlns="http://www.w3.org/1999/xhtml">Consumer</span></code><span class="koboSpan" id="kobo.733.1" xmlns="http://www.w3.org/1999/xhtml"> class exposes the strategies through properties to assert its composition later. </span><span class="koboSpan" id="kobo.733.2" xmlns="http://www.w3.org/1999/xhtml">Let’s test that out by building a dependency tree, simulating the composition root, and then asserting the value of the consumer properties:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.734.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void ConsumerTest()
{
    // Arrange
    var serviceProvider = new ServiceCollection()
        .AddSingleton&lt;IStrategyA, StrategyA&gt;()
        .AddSingleton&lt;IStrategyB, StrategyB&gt;()
        .AddSingleton&lt;Consumer&gt;()
        .BuildServiceProvider();
    // Act
    var consumer = serviceProvider.GetRequiredService&lt;Consumer&gt;();
    // Assert
    Assert.IsType&lt;StrategyA&gt;(consumer.StrategyA);
    Assert.IsType&lt;StrategyB&gt;(consumer.StrategyB);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.735.1" xmlns="http://www.w3.org/1999/xhtml">Both properties are of the expected type, but that is not the problem. </span><span class="koboSpan" id="kobo.735.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.736.1" xmlns="http://www.w3.org/1999/xhtml">Consumer</span></code><span class="koboSpan" id="kobo.737.1" xmlns="http://www.w3.org/1999/xhtml"> class controls what dependencies to use and when to use them by injecting markers A and B instead of two </span><code><span class="koboSpan" id="kobo.738.1" xmlns="http://www.w3.org/1999/xhtml">IStrategy</span></code><span class="koboSpan" id="kobo.739.1" xmlns="http://www.w3.org/1999/xhtml"> instances. </span><span class="koboSpan" id="kobo.739.2" xmlns="http://www.w3.org/1999/xhtml">Due to that, we cannot control the dependency tree from the composition root. </span><span class="koboSpan" id="kobo.739.3" xmlns="http://www.w3.org/1999/xhtml">For example, we cannot change </span><code><span class="koboSpan" id="kobo.740.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyA</span></code><span class="koboSpan" id="kobo.741.1" xmlns="http://www.w3.org/1999/xhtml"> to </span><code><span class="koboSpan" id="kobo.742.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyB</span></code><span class="koboSpan" id="kobo.743.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.744.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyB</span></code><span class="koboSpan" id="kobo.745.1" xmlns="http://www.w3.org/1999/xhtml"> to </span><code><span class="koboSpan" id="kobo.746.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyA</span></code><span class="koboSpan" id="kobo.747.1" xmlns="http://www.w3.org/1999/xhtml">, nor inject two </span><code><span class="koboSpan" id="kobo.748.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyB</span></code><span class="koboSpan" id="kobo.749.1" xmlns="http://www.w3.org/1999/xhtml"> instances or two </span><code><span class="koboSpan" id="kobo.750.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyA</span></code><span class="koboSpan" id="kobo.751.1" xmlns="http://www.w3.org/1999/xhtml"> instances, nor even create an </span><code><span class="koboSpan" id="kobo.752.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyC</span></code><span class="koboSpan" id="kobo.753.1" xmlns="http://www.w3.org/1999/xhtml"> interface to replace </span><code><span class="koboSpan" id="kobo.754.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyA</span></code><span class="koboSpan" id="kobo.755.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.756.1" xmlns="http://www.w3.org/1999/xhtml">IStrategyB</span></code><span class="koboSpan" id="kobo.757.1" xmlns="http://www.w3.org/1999/xhtml">.How do we fix this? </span><span class="koboSpan" id="kobo.757.2" xmlns="http://www.w3.org/1999/xhtml">Let’s start by deleting our markers and injecting two </span><code><span class="koboSpan" id="kobo.758.1" xmlns="http://www.w3.org/1999/xhtml">IStrategy</span></code><span class="koboSpan" id="kobo.759.1" xmlns="http://www.w3.org/1999/xhtml"> instances instead (the changes are highlighted). </span><span class="koboSpan" id="kobo.759.2" xmlns="http://www.w3.org/1999/xhtml">After doing that, we end up with the following object structure:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.760.1" xmlns="http://www.w3.org/1999/xhtml">public class StrategyA : IStrategy
{
    public string Execute() =&gt; "StrategyA";
}
public class StrategyB : IStrategy
{
    public string Execute() =&gt; "StrategyB";
}
public class Consumer
{
    public IStrategy StrategyA { get; }
    public IStrategy StrategyB { get; }
    public Consumer(IStrategy strategyA, IStrategy strategyB)
    {
        StrategyA = strategyA ?? </span><span class="koboSpan" id="kobo.760.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(strategyA));
        StrategyB = strategyB ?? </span><span class="koboSpan" id="kobo.760.3" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(strategyB));
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.761.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.762.1" xmlns="http://www.w3.org/1999/xhtml">Consumer</span></code><span class="koboSpan" id="kobo.763.1" xmlns="http://www.w3.org/1999/xhtml"> class no longer controls the narrative with the new implementation, and the composition responsibility falls back to the composition root. </span><span class="koboSpan" id="kobo.763.2" xmlns="http://www.w3.org/1999/xhtml">Unfortunately, there is no way to do contextual injections using the default dependency injection container, and I don’t want to get into a third-party library for this. </span><span class="koboSpan" id="kobo.763.3" xmlns="http://www.w3.org/1999/xhtml">But all is not lost yet; we can use a factory to help ASP.NET Core build the </span><code><span class="koboSpan" id="kobo.764.1" xmlns="http://www.w3.org/1999/xhtml">Consumer</span></code><span class="koboSpan" id="kobo.765.1" xmlns="http://www.w3.org/1999/xhtml"> instance, like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.766.1" xmlns="http://www.w3.org/1999/xhtml">// Arrange
var serviceProvider = new ServiceCollection()
    .AddSingleton&lt;StrategyA&gt;()
    .AddSingleton&lt;StrategyB&gt;()
    .AddSingleton(serviceProvider =&gt;
    {
        var strategyA = serviceProvider.GetRequiredService&lt;StrategyA&gt;();
        var strategyB = serviceProvider.GetRequiredService&lt;StrategyB&gt;();
        return new Consumer(strategyA, strategyB);
    })
    .BuildServiceProvider();
// Act
var consumer = serviceProvider.GetRequiredService&lt;Consumer&gt;();
// Assert
Assert.IsType&lt;StrategyA&gt;(consumer.StrategyA);
Assert.IsType&lt;StrategyB&gt;(consumer.StrategyB);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.767.1" xmlns="http://www.w3.org/1999/xhtml">From this point forward, we control the program’s composition, and we can swap A with B or do anything else that we want to, as long as the implementation respects the </span><code><span class="koboSpan" id="kobo.768.1" xmlns="http://www.w3.org/1999/xhtml">IStrategy</span></code><span class="koboSpan" id="kobo.769.1" xmlns="http://www.w3.org/1999/xhtml"> contract.To conclude, using markers instead of doing contextual injection breaks the inversion of control principle, making the consumer control its dependencies. </span><span class="koboSpan" id="kobo.769.2" xmlns="http://www.w3.org/1999/xhtml">That’s very close to using the </span><code><span class="koboSpan" id="kobo.770.1" xmlns="http://www.w3.org/1999/xhtml">new</span></code><span class="koboSpan" id="kobo.771.1" xmlns="http://www.w3.org/1999/xhtml"> keyword to instantiate objects. </span><span class="koboSpan" id="kobo.771.2" xmlns="http://www.w3.org/1999/xhtml">Inverting the dependency control back is easy, even using the default container.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.772.1" xmlns="http://www.w3.org/1999/xhtml">If you need to inject dependencies contextually, I started an open source project in 2020 that does that. </span><span class="koboSpan" id="kobo.772.2" xmlns="http://www.w3.org/1999/xhtml">Multiple other third-party libraries add features or replace the default IoC container altogether if needed. </span><span class="koboSpan" id="kobo.772.3" xmlns="http://www.w3.org/1999/xhtml">See the </span><em><span class="koboSpan" id="kobo.773.1" xmlns="http://www.w3.org/1999/xhtml">Further reading</span></em><span class="koboSpan" id="kobo.774.1" xmlns="http://www.w3.org/1999/xhtml"> section.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.775.1" xmlns="http://www.w3.org/1999/xhtml">Next, we start the last part of this chapter. </span><span class="koboSpan" id="kobo.775.2" xmlns="http://www.w3.org/1999/xhtml">It showcases an open-source tool that can help us build CQS-oriented applications.</span></p>
</section>
</section>
<section class="level2" data-number="17.6" id="using-mediatr-as-a-mediator">
<h2 data-number="17.6"><span class="koboSpan" id="kobo.776.1" xmlns="http://www.w3.org/1999/xhtml">Using MediatR as a mediator</span></h2>
<p><span class="koboSpan" id="kobo.777.1" xmlns="http://www.w3.org/1999/xhtml">In this section, we are exploring MediatR, an open-source mediator implementation.What is MediatR? </span><span class="koboSpan" id="kobo.777.2" xmlns="http://www.w3.org/1999/xhtml">Let’s start with its maker’s description from its GitHub repository, which brands it as this:</span></p>
<blockquote>
<em><span class="koboSpan" id="kobo.778.1" xmlns="http://www.w3.org/1999/xhtml">“Simple, unambitious mediator implementation in .NET”</span></em>
</blockquote>
<p><span class="koboSpan" id="kobo.779.1" xmlns="http://www.w3.org/1999/xhtml">MediatR is a simple but very powerful tool doing in-process communication through messaging. </span><span class="koboSpan" id="kobo.779.2" xmlns="http://www.w3.org/1999/xhtml">It supports a request/response flow through commands, queries, notifications, and events, synchronously and asynchronously.We can install the NuGet package using the .NET CLI: </span><code><span class="koboSpan" id="kobo.780.1" xmlns="http://www.w3.org/1999/xhtml">dotnet add package MediatR</span></code><span class="koboSpan" id="kobo.781.1" xmlns="http://www.w3.org/1999/xhtml">.Now that I have quickly introduced the tool, we are going to explore the migration of our Clean Architecture sample but instead use MediatR to dispatch the </span><code><span class="koboSpan" id="kobo.782.1" xmlns="http://www.w3.org/1999/xhtml">StocksController</span></code><span class="koboSpan" id="kobo.783.1" xmlns="http://www.w3.org/1999/xhtml"> requests to the core use cases. </span><span class="koboSpan" id="kobo.783.2" xmlns="http://www.w3.org/1999/xhtml">We use a similar pattern with MediatR than what we built in the CQS project.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.784.1" xmlns="http://www.w3.org/1999/xhtml">Why migrate our Clean Architecture sample? </span><span class="koboSpan" id="kobo.784.2" xmlns="http://www.w3.org/1999/xhtml">The primary reason we are building the same project using different models is for ease of comparison. </span><span class="koboSpan" id="kobo.784.3" xmlns="http://www.w3.org/1999/xhtml">It is much easier to compare the changes of the same features than if we were building completely different projects.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.785.1" xmlns="http://www.w3.org/1999/xhtml">What are the advantages of using MediatR in this case? </span><span class="koboSpan" id="kobo.785.2" xmlns="http://www.w3.org/1999/xhtml">It allows us to organize the code around use cases (vertically) instead of services (horizontally), leading to more cohesive features. </span><span class="koboSpan" id="kobo.785.3" xmlns="http://www.w3.org/1999/xhtml">We remove the service layer (the </span><code><span class="koboSpan" id="kobo.786.1" xmlns="http://www.w3.org/1999/xhtml">StockService</span></code><span class="koboSpan" id="kobo.787.1" xmlns="http://www.w3.org/1999/xhtml"> class) and replace it with multiple use cases (features) instead (the </span><code><span class="koboSpan" id="kobo.788.1" xmlns="http://www.w3.org/1999/xhtml">AddStocks</span></code><span class="koboSpan" id="kobo.789.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.790.1" xmlns="http://www.w3.org/1999/xhtml">RemoveStock</span></code><span class="koboSpan" id="kobo.791.1" xmlns="http://www.w3.org/1999/xhtml"> classes). </span><span class="koboSpan" id="kobo.791.2" xmlns="http://www.w3.org/1999/xhtml">MediatR also enables a pipeline we can extend by programming behaviors. </span><span class="koboSpan" id="kobo.791.3" xmlns="http://www.w3.org/1999/xhtml">Those extensibility points allow us to manage cross-cutting concerns, such as requests validation centrally, without impacting the consumers and use cases. </span><span class="koboSpan" id="kobo.791.4" xmlns="http://www.w3.org/1999/xhtml">We explore request validation in </span><em><span class="koboSpan" id="kobo.792.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 17</span></em><span class="koboSpan" id="kobo.793.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.794.1" xmlns="http://www.w3.org/1999/xhtml">Getting Started with Vertical Slice Architecture</span></em><span class="koboSpan" id="kobo.795.1" xmlns="http://www.w3.org/1999/xhtml">.Let’s jump into the code now to see how it works.</span></p>
<section class="level3" data-number="17.6.1" id="project-clean-architecture-with-mediatr">
<h3 data-number="17.6.1"><span class="koboSpan" id="kobo.796.1" xmlns="http://www.w3.org/1999/xhtml">Project – Clean Architecture with MediatR</span></h3>
<p><strong><span class="koboSpan" id="kobo.797.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></strong><span class="koboSpan" id="kobo.798.1" xmlns="http://www.w3.org/1999/xhtml">: We want to break some more of the coupling in the Clean Architecture project we built in </span><em><span class="koboSpan" id="kobo.799.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 14</span></em><span class="koboSpan" id="kobo.800.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.801.1" xmlns="http://www.w3.org/1999/xhtml">Understanding Layering</span></em><span class="koboSpan" id="kobo.802.1" xmlns="http://www.w3.org/1999/xhtml">, by leveraging the </span><strong><span class="koboSpan" id="kobo.803.1" xmlns="http://www.w3.org/1999/xhtml">Mediator</span></strong><span class="koboSpan" id="kobo.804.1" xmlns="http://www.w3.org/1999/xhtml"> pattern and a </span><strong><span class="koboSpan" id="kobo.805.1" xmlns="http://www.w3.org/1999/xhtml">CQS</span></strong><span class="koboSpan" id="kobo.806.1" xmlns="http://www.w3.org/1999/xhtml"> approach.The clean architecture solution was already solid, but MediatR will pave the way to more good things later. </span><span class="koboSpan" id="kobo.806.2" xmlns="http://www.w3.org/1999/xhtml">The only “major” change is the replacement of the </span><code><span class="koboSpan" id="kobo.807.1" xmlns="http://www.w3.org/1999/xhtml">StockService</span></code><span class="koboSpan" id="kobo.808.1" xmlns="http://www.w3.org/1999/xhtml"> with two feature objects, </span><code><span class="koboSpan" id="kobo.809.1" xmlns="http://www.w3.org/1999/xhtml">AddStocks</span></code><span class="koboSpan" id="kobo.810.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.811.1" xmlns="http://www.w3.org/1999/xhtml">RemoveStocks</span></code><span class="koboSpan" id="kobo.812.1" xmlns="http://www.w3.org/1999/xhtml">, which we explore soon.First, we must install the </span><code><span class="koboSpan" id="kobo.813.1" xmlns="http://www.w3.org/1999/xhtml">MediatR</span></code><span class="koboSpan" id="kobo.814.1" xmlns="http://www.w3.org/1999/xhtml"> NuGet package in the </span><code><span class="koboSpan" id="kobo.815.1" xmlns="http://www.w3.org/1999/xhtml">Core</span></code><span class="koboSpan" id="kobo.816.1" xmlns="http://www.w3.org/1999/xhtml"> project, where the features will live. </span><span class="koboSpan" id="kobo.816.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, it will transiently cascade to the </span><code><span class="koboSpan" id="kobo.817.1" xmlns="http://www.w3.org/1999/xhtml">Web</span></code><span class="koboSpan" id="kobo.818.1" xmlns="http://www.w3.org/1999/xhtml"> project, allowing us to register MediatR with the IoC container. </span><span class="koboSpan" id="kobo.818.2" xmlns="http://www.w3.org/1999/xhtml">In the </span><code><span class="koboSpan" id="kobo.819.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.820.1" xmlns="http://www.w3.org/1999/xhtml"> file, we can register MediatR like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.821.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services
    // Core Layer
    .AddMediatR(cfg =&gt; cfg.RegisterServicesFromAssemblyContaining&lt;NotEnoughStockException&gt;())
;</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.822.1" xmlns="http://www.w3.org/1999/xhtml">That code scans the Core assembly for MediatR-compatible pieces and registers them with the IoC Container. </span><span class="koboSpan" id="kobo.822.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.823.1" xmlns="http://www.w3.org/1999/xhtml">NotEnoughStockException</span></code><span class="koboSpan" id="kobo.824.1" xmlns="http://www.w3.org/1999/xhtml"> class is part of the core project.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.825.1" xmlns="http://www.w3.org/1999/xhtml">I picked the </span><code><span class="koboSpan" id="kobo.826.1" xmlns="http://www.w3.org/1999/xhtml">NotEnoughStockException</span></code><span class="koboSpan" id="kobo.827.1" xmlns="http://www.w3.org/1999/xhtml"> class but could have chosen any class from the </span><code><span class="koboSpan" id="kobo.828.1" xmlns="http://www.w3.org/1999/xhtml">Core</span></code><span class="koboSpan" id="kobo.829.1" xmlns="http://www.w3.org/1999/xhtml"> assembly. </span><span class="koboSpan" id="kobo.829.2" xmlns="http://www.w3.org/1999/xhtml">There are more registration options.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.830.1" xmlns="http://www.w3.org/1999/xhtml">MediatR exposes the following types of messages (as of version 12):</span></p>
<ul>
<li><em><span class="koboSpan" id="kobo.831.1" xmlns="http://www.w3.org/1999/xhtml">Request/response</span></em><span class="koboSpan" id="kobo.832.1" xmlns="http://www.w3.org/1999/xhtml"> that has one handler; perfect for commands and queries.</span></li>
<li><em><span class="koboSpan" id="kobo.833.1" xmlns="http://www.w3.org/1999/xhtml">Notifications</span></em><span class="koboSpan" id="kobo.834.1" xmlns="http://www.w3.org/1999/xhtml"> that support multiple handlers; perfect for an event-based model applying the Publish-Subscribe pattern where a notification represents an event.</span></li>
<li><em><span class="koboSpan" id="kobo.835.1" xmlns="http://www.w3.org/1999/xhtml">Request/response streams</span></em><span class="koboSpan" id="kobo.836.1" xmlns="http://www.w3.org/1999/xhtml"> that are similar to request/response but stream the response through the </span><code><span class="koboSpan" id="kobo.837.1" xmlns="http://www.w3.org/1999/xhtml">IAsyncEnumerable&lt;T&gt;</span></code><span class="koboSpan" id="kobo.838.1" xmlns="http://www.w3.org/1999/xhtml"> interface.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.839.1" xmlns="http://www.w3.org/1999/xhtml">We cover the Publish-Subscribe pattern in </span><em><span class="koboSpan" id="kobo.840.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 19</span></em><span class="koboSpan" id="kobo.841.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.842.1" xmlns="http://www.w3.org/1999/xhtml">Introduction to Microservices Architecture</span></em><span class="koboSpan" id="kobo.843.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.844.1" xmlns="http://www.w3.org/1999/xhtml">Now that everything we need related to MediatR is “magically” registered, we can look at the use cases that replace the </span><code><span class="koboSpan" id="kobo.845.1" xmlns="http://www.w3.org/1999/xhtml">StockService</span></code><span class="koboSpan" id="kobo.846.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.846.2" xmlns="http://www.w3.org/1999/xhtml">Let’s have a look at the updated </span><code><span class="koboSpan" id="kobo.847.1" xmlns="http://www.w3.org/1999/xhtml">AddStocks</span></code><span class="koboSpan" id="kobo.848.1" xmlns="http://www.w3.org/1999/xhtml"> code first:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.849.1" xmlns="http://www.w3.org/1999/xhtml">namespace Core.UseCases;
public class AddStocks
{
    public class Command : IRequest&lt;int&gt;
    {
        public int ProductId { get; set; }
        public int Amount { get; set; }
    }
    public class Handler : IRequestHandler&lt;Command, int&gt;
    {
        private readonly IProductRepository _productRepository;
        public Handler(IProductRepository productRepository)
        {
            _productRepository = productRepository ?? </span><span class="koboSpan" id="kobo.849.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(productRepository));
        }
        public async Task&lt;int&gt; Handle(Command request, CancellationToken cancellationToken)
        {
            var product = await _productRepository.FindByIdAsync(request.ProductId, cancellationToken);
            if (product == null)
            {
                throw new ProductNotFoundException(request.ProductId);
            }
            product.AddStock(request.Amount);
            await _productRepository.UpdateAsync(product, cancellationToken);
            return product.QuantityInStock;
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.850.1" xmlns="http://www.w3.org/1999/xhtml">Since we covered both use cases in the previous chapters and the changes are very similar, we will analyze both together, after the </span><code><span class="koboSpan" id="kobo.851.1" xmlns="http://www.w3.org/1999/xhtml">RemoveStocks</span></code><span class="koboSpan" id="kobo.852.1" xmlns="http://www.w3.org/1999/xhtml"> use case code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.853.1" xmlns="http://www.w3.org/1999/xhtml">namespace Core.UseCases;
public class RemoveStocks
{
    public class Command : IRequest&lt;int&gt;
    {
        public int ProductId { get; set; }
        public int Amount { get; set; }
    }
    public class Handler : IRequestHandler&lt;Command, int&gt;
    {
        private readonly IProductRepository _productRepository;
        public Handler(IProductRepository productRepository)
        {
            _productRepository = productRepository ?? </span><span class="koboSpan" id="kobo.853.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(productRepository));
        }
        public async Task&lt;int&gt; Handle(Command request, CancellationToken cancellationToken)
        {
            var product = await _productRepository.FindByIdAsync(request.ProductId, cancellationToken);
            if (product == null)
            {
                throw new ProductNotFoundException(request.ProductId);
            }
            product.RemoveStock(request.Amount);
            await _productRepository.UpdateAsync(product, cancellationToken);
            return product.QuantityInStock;
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.854.1" xmlns="http://www.w3.org/1999/xhtml">As you may have noticed in the code, I chose the same pattern to build the commands as I did with the CQS sample, so we have a class per use case containing two nested classes: </span><code><span class="koboSpan" id="kobo.855.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.856.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.857.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.858.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.858.2" xmlns="http://www.w3.org/1999/xhtml">This structure makes for very clean code when you have a 1-on-1 relationship between the command class and its handler.Using the MediatR request/response model, the command (or query) becomes a request and must implement the </span><code><span class="koboSpan" id="kobo.859.1" xmlns="http://www.w3.org/1999/xhtml">IRequest&lt;TResponse&gt;</span></code><span class="koboSpan" id="kobo.860.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.860.2" xmlns="http://www.w3.org/1999/xhtml">The handlers must implement the </span><code><span class="koboSpan" id="kobo.861.1" xmlns="http://www.w3.org/1999/xhtml">IRequestHandler&lt;TRequest, TResponse&gt;</span></code><span class="koboSpan" id="kobo.862.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.862.2" xmlns="http://www.w3.org/1999/xhtml">Instead, we could implement the </span><code><span class="koboSpan" id="kobo.863.1" xmlns="http://www.w3.org/1999/xhtml">IRequest</span></code><span class="koboSpan" id="kobo.864.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.865.1" xmlns="http://www.w3.org/1999/xhtml">IRequestHandler&lt;TRequest&gt;</span></code><span class="koboSpan" id="kobo.866.1" xmlns="http://www.w3.org/1999/xhtml"> interfaces for a command that returns nothing (</span><code><span class="koboSpan" id="kobo.867.1" xmlns="http://www.w3.org/1999/xhtml">void</span></code><span class="koboSpan" id="kobo.868.1" xmlns="http://www.w3.org/1999/xhtml">).</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.869.1" xmlns="http://www.w3.org/1999/xhtml">More options are part of MediatR, and the documentation is complete enough to dig deeper yourself.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.870.1" xmlns="http://www.w3.org/1999/xhtml">Let’s analyze the anatomy of the </span><code><span class="koboSpan" id="kobo.871.1" xmlns="http://www.w3.org/1999/xhtml">AddStocks</span></code><span class="koboSpan" id="kobo.872.1" xmlns="http://www.w3.org/1999/xhtml"> use case. </span><span class="koboSpan" id="kobo.872.2" xmlns="http://www.w3.org/1999/xhtml">Here is the old code as a reference:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.873.1" xmlns="http://www.w3.org/1999/xhtml">namespace Core.Services;
public class StockService
{
    private readonly IProductRepository _repository;
    // Omitted constructor
    public async Task&lt;int&gt; AddStockAsync(int productId, int amount, CancellationToken cancellationToken)
    {
        var product = await _repository.FindByIdAsync(productId, cancellationToken);
        if (product == null)
        {
            throw new ProductNotFoundException(productId);
        }
        product.AddStock(amount);
        await _repository.UpdateAsync(product, cancellationToken);
        return product.QuantityInStock;
    }
    // Omitted RemoveStockAsync method
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.874.1" xmlns="http://www.w3.org/1999/xhtml">The first difference is that we moved the loose parameters (highlighted) into the </span><code><span class="koboSpan" id="kobo.875.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.876.1" xmlns="http://www.w3.org/1999/xhtml"> class, which encapsulates the whole request:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.877.1" xmlns="http://www.w3.org/1999/xhtml">public class Command : IRequest&lt;int&gt;
{
    public int ProductId { get; set; }
    public int Amount { get; set; }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.878.1" xmlns="http://www.w3.org/1999/xhtml">Then the </span><code><span class="koboSpan" id="kobo.879.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.880.1" xmlns="http://www.w3.org/1999/xhtml"> class specifies the handler’s expected return value by implementing the </span><code><span class="koboSpan" id="kobo.881.1" xmlns="http://www.w3.org/1999/xhtml">IRequest&lt;TResponse&gt;</span></code><span class="koboSpan" id="kobo.882.1" xmlns="http://www.w3.org/1999/xhtml"> interface, where </span><code><span class="koboSpan" id="kobo.883.1" xmlns="http://www.w3.org/1999/xhtml">TResponse</span></code><span class="koboSpan" id="kobo.884.1" xmlns="http://www.w3.org/1999/xhtml"> is an </span><code><span class="koboSpan" id="kobo.885.1" xmlns="http://www.w3.org/1999/xhtml">int</span></code><span class="koboSpan" id="kobo.886.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.886.2" xmlns="http://www.w3.org/1999/xhtml">That gives us a typed response when sending the request through MediatR. </span><span class="koboSpan" id="kobo.886.3" xmlns="http://www.w3.org/1999/xhtml">This is not “pure CQS” because the command handler returns an integer representing the updated </span><code><span class="koboSpan" id="kobo.887.1" xmlns="http://www.w3.org/1999/xhtml">QuantityInStock</span></code><span class="koboSpan" id="kobo.888.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.888.2" xmlns="http://www.w3.org/1999/xhtml">However, we could call that optimization since executing one command and one query would be overkill for this scenario (possibly leading to two database calls instead of one).I’ll skip the </span><code><span class="koboSpan" id="kobo.889.1" xmlns="http://www.w3.org/1999/xhtml">RemoveStocks</span></code><span class="koboSpan" id="kobo.890.1" xmlns="http://www.w3.org/1999/xhtml"> use case to avoid repeating myself, as it follows the same pattern. </span><span class="koboSpan" id="kobo.890.2" xmlns="http://www.w3.org/1999/xhtml">Instead, let’s look at the consumption of those use cases. </span><span class="koboSpan" id="kobo.890.3" xmlns="http://www.w3.org/1999/xhtml">I omitted the exception handling to keep the code streamlined and because </span><code><span class="koboSpan" id="kobo.891.1" xmlns="http://www.w3.org/1999/xhtml">try</span></code><span class="koboSpan" id="kobo.892.1" xmlns="http://www.w3.org/1999/xhtml">/</span><code><span class="koboSpan" id="kobo.893.1" xmlns="http://www.w3.org/1999/xhtml">catch</span></code><span class="koboSpan" id="kobo.894.1" xmlns="http://www.w3.org/1999/xhtml"> blocks would only add noise to the code in this case and hinder our study of the pattern:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.895.1" xmlns="http://www.w3.org/1999/xhtml">app.MapPost("/products/{productId:int}/add-stocks", async (
    int productId, 
    AddStocks.Command command, 
    IMediator mediator, 
    CancellationToken cancellationToken) =&gt;
{
    command.ProductId = productId;
    var quantityInStock = await mediator.Send(command, cancellationToken);
    var stockLevel = new StockLevel(quantityInStock);
    return Results.Ok(stockLevel);
});
app.MapPost("/products/{productId:int}/remove-stocks", async (
    int productId, 
    RemoveStocks.Command command, 
    IMediator mediator, 
    CancellationToken cancellationToken) =&gt;
{
    command.ProductId = productId;
    var quantityInStock = await mediator.Send(command, cancellationToken);
    var stockLevel = new StockLevel(quantityInStock);
    return Results.Ok(stockLevel);
});
// Omitted code
public record class StockLevel(int QuantityInStock);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.896.1" xmlns="http://www.w3.org/1999/xhtml">In both delegates, we inject an </span><code><span class="koboSpan" id="kobo.897.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.898.1" xmlns="http://www.w3.org/1999/xhtml"> and a command object (highlighted). </span><span class="koboSpan" id="kobo.898.2" xmlns="http://www.w3.org/1999/xhtml">We also let ASP.NET Core inject a </span><code><span class="koboSpan" id="kobo.899.1" xmlns="http://www.w3.org/1999/xhtml">CancellationToken</span></code><span class="koboSpan" id="kobo.900.1" xmlns="http://www.w3.org/1999/xhtml">, which we pass to MediatR. </span><span class="koboSpan" id="kobo.900.2" xmlns="http://www.w3.org/1999/xhtml">The model binder loads the data from the HTTP request into the objects that we send using the </span><code><span class="koboSpan" id="kobo.901.1" xmlns="http://www.w3.org/1999/xhtml">Send</span></code><span class="koboSpan" id="kobo.902.1" xmlns="http://www.w3.org/1999/xhtml"> method of the </span><code><span class="koboSpan" id="kobo.903.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.904.1" xmlns="http://www.w3.org/1999/xhtml"> interface (highlighted). </span><span class="koboSpan" id="kobo.904.2" xmlns="http://www.w3.org/1999/xhtml">Then we map the result into the </span><code><span class="koboSpan" id="kobo.905.1" xmlns="http://www.w3.org/1999/xhtml">StockLevel</span></code><span class="koboSpan" id="kobo.906.1" xmlns="http://www.w3.org/1999/xhtml"> DTO before returning its value and an HTTP status code of </span><code><span class="koboSpan" id="kobo.907.1" xmlns="http://www.w3.org/1999/xhtml">200</span></code> <code><span class="koboSpan" id="kobo.908.1" xmlns="http://www.w3.org/1999/xhtml">OK</span></code><span class="koboSpan" id="kobo.909.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.909.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.910.1" xmlns="http://www.w3.org/1999/xhtml">StockLevel</span></code><span class="koboSpan" id="kobo.911.1" xmlns="http://www.w3.org/1999/xhtml"> record class is the same as before.This example contains almost the same code as our CQS example, but we used MediatR instead of manually programming the pieces.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.912.1" xmlns="http://www.w3.org/1999/xhtml">The default model binder cannot load data from multiple sources. </span><span class="koboSpan" id="kobo.912.2" xmlns="http://www.w3.org/1999/xhtml">Because of that, we must inject </span><code><span class="koboSpan" id="kobo.913.1" xmlns="http://www.w3.org/1999/xhtml">productId</span></code><span class="koboSpan" id="kobo.914.1" xmlns="http://www.w3.org/1999/xhtml"> and assign its value to the </span><code><span class="koboSpan" id="kobo.915.1" xmlns="http://www.w3.org/1999/xhtml">command.ProductId</span></code><span class="koboSpan" id="kobo.916.1" xmlns="http://www.w3.org/1999/xhtml"> property manually. </span><span class="koboSpan" id="kobo.916.2" xmlns="http://www.w3.org/1999/xhtml">Even if both values could be taken from the body, the resource identifier of that endpoint would become less exhaustive (no </span><code><span class="koboSpan" id="kobo.917.1" xmlns="http://www.w3.org/1999/xhtml">productId</span></code><span class="koboSpan" id="kobo.918.1" xmlns="http://www.w3.org/1999/xhtml"> in the URI).</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.919.1" xmlns="http://www.w3.org/1999/xhtml">With MVC, we could create a custom model binder.</span></p>
</blockquote>
<blockquote>
<p><span class="koboSpan" id="kobo.920.1" xmlns="http://www.w3.org/1999/xhtml">With minimal APIs, we could create a static </span><code><span class="koboSpan" id="kobo.921.1" xmlns="http://www.w3.org/1999/xhtml">BindAsync</span></code><span class="koboSpan" id="kobo.922.1" xmlns="http://www.w3.org/1999/xhtml"> method to manually do the model binding, which is not very extensible and would tightly couple the </span><code><span class="koboSpan" id="kobo.923.1" xmlns="http://www.w3.org/1999/xhtml">Core</span></code><span class="koboSpan" id="kobo.924.1" xmlns="http://www.w3.org/1999/xhtml"> assembly with the </span><code><span class="koboSpan" id="kobo.925.1" xmlns="http://www.w3.org/1999/xhtml">HttpContext</span></code><span class="koboSpan" id="kobo.926.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.926.2" xmlns="http://www.w3.org/1999/xhtml">I suppose we will need to wait for .NET 9+ to get improvements into that field.</span></p>
</blockquote>
<blockquote>
<p><span class="koboSpan" id="kobo.927.1" xmlns="http://www.w3.org/1999/xhtml">I’ve left a few links in the </span><em><span class="koboSpan" id="kobo.928.1" xmlns="http://www.w3.org/1999/xhtml">further reading</span></em><span class="koboSpan" id="kobo.929.1" xmlns="http://www.w3.org/1999/xhtml"> section relating to this.</span></p>
</blockquote>
</blockquote>
</section>
<section class="level3" data-number="17.6.2" id="conclusion-25">
<h3 data-number="17.6.2"><span class="koboSpan" id="kobo.930.1" xmlns="http://www.w3.org/1999/xhtml">Conclusion</span></h3>
<p><span class="koboSpan" id="kobo.931.1" xmlns="http://www.w3.org/1999/xhtml">With MediatR, we packed the power of a CQS-inspired pipeline with the Mediator pattern into a Clean Architecture application. </span><span class="koboSpan" id="kobo.931.2" xmlns="http://www.w3.org/1999/xhtml">We broke the coupling between the request delegates and the use case handler (previously a service). </span><span class="koboSpan" id="kobo.931.3" xmlns="http://www.w3.org/1999/xhtml">A simple DTO, such as a command object, makes endpoints and controllers unaware of the handlers, leaving MediatR as the middleman between the commands and their handlers. </span><span class="koboSpan" id="kobo.931.4" xmlns="http://www.w3.org/1999/xhtml">Due to that, the handlers could change along the way without impacting the endpoint.Moreover, we could configure more interaction between the command and the handler with </span><code><span class="koboSpan" id="kobo.932.1" xmlns="http://www.w3.org/1999/xhtml">IRequestPreProcessor</span></code><span class="koboSpan" id="kobo.933.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.934.1" xmlns="http://www.w3.org/1999/xhtml">IRequestPostProcessor</span></code><span class="koboSpan" id="kobo.935.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.936.1" xmlns="http://www.w3.org/1999/xhtml">IRequestExceptionHandler</span></code><span class="koboSpan" id="kobo.937.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.937.2" xmlns="http://www.w3.org/1999/xhtml">These allow us to extend the MediatR request pipeline with cross-cutting concerns like validation and error handling.MediatR helps us follow the SOLID principles the same way as the Mediator and CQS patterns combined. </span><span class="koboSpan" id="kobo.937.3" xmlns="http://www.w3.org/1999/xhtml">The only drawback of the overall design, which has nothing to do with MediatR, is that we used the commands as the DTOs. </span><span class="koboSpan" id="kobo.937.4" xmlns="http://www.w3.org/1999/xhtml">We could create custom DTOs and map them to command objects. </span><span class="koboSpan" id="kobo.937.5" xmlns="http://www.w3.org/1999/xhtml">However, you will understand in the next chapter where I was heading with this transitory design.</span></p>
</section>
</section>
<section class="level2" data-number="17.7" id="summary-15">
<h2 data-number="17.7"><span class="koboSpan" id="kobo.938.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.939.1" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we looked at the Mediator pattern, which allows us to cut the ties between collaborators, mediating the communication between them. </span><span class="koboSpan" id="kobo.939.2" xmlns="http://www.w3.org/1999/xhtml">Then we studied the CQS pattern, which advises the division of software behaviors into commands and queries. </span><span class="koboSpan" id="kobo.939.3" xmlns="http://www.w3.org/1999/xhtml">Those two patterns are tools that cut tight coupling between components.Afterward, we updated a Clean Architecture project to use MediatR, an open-source generic mediator that is CQS-oriented. </span><span class="koboSpan" id="kobo.939.4" xmlns="http://www.w3.org/1999/xhtml">There are many more possible uses than we explored, but this is still a great start. </span><span class="koboSpan" id="kobo.939.5" xmlns="http://www.w3.org/1999/xhtml">This concludes another chapter exploring techniques to break tight coupling and divide systems into smaller parts.All those building blocks lead us to the next chapter, where we piece those patterns and tools together to explore the Vertical Slice Architecture.</span></p>
</section>
<section class="level2" data-number="17.8" id="questions-15">
<h2 data-number="17.8"><span class="koboSpan" id="kobo.940.1" xmlns="http://www.w3.org/1999/xhtml">Questions</span></h2>
<p><span class="koboSpan" id="kobo.941.1" xmlns="http://www.w3.org/1999/xhtml">Let’s take a look at a few practice questions:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.942.1" xmlns="http://www.w3.org/1999/xhtml">What does the CQS stand for, and what is the purpose of this design pattern?</span></li>
<li><span class="koboSpan" id="kobo.943.1" xmlns="http://www.w3.org/1999/xhtml">Can we use a mediator inside a colleague to call another colleague?</span></li>
<li><span class="koboSpan" id="kobo.944.1" xmlns="http://www.w3.org/1999/xhtml">In CQS, can a command return a value?</span></li>
<li><span class="koboSpan" id="kobo.945.1" xmlns="http://www.w3.org/1999/xhtml">How much does MediatR cost?</span></li>
<li><span class="koboSpan" id="kobo.946.1" xmlns="http://www.w3.org/1999/xhtml">Imagine a design with a marker interface to add metadata to some classes. </span><span class="koboSpan" id="kobo.946.2" xmlns="http://www.w3.org/1999/xhtml">Do you think you should review that design?</span></li>
</ol>
</section>
<section class="level2" data-number="17.9" id="further-reading-13">
<h2 data-number="17.9"><span class="koboSpan" id="kobo.947.1" xmlns="http://www.w3.org/1999/xhtml">Further reading</span></h2>
<p><span class="koboSpan" id="kobo.948.1" xmlns="http://www.w3.org/1999/xhtml">Here are a few links to build on what we have learned in the chapter:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.949.1" xmlns="http://www.w3.org/1999/xhtml">MediatR: </span><a href="https://adpg.link/ZQap"><span class="koboSpan" id="kobo.950.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/ZQap</span></a></li>
<li><span class="koboSpan" id="kobo.951.1" xmlns="http://www.w3.org/1999/xhtml">To get rid of setting </span><code><span class="koboSpan" id="kobo.952.1" xmlns="http://www.w3.org/1999/xhtml">ProductId</span></code><span class="koboSpan" id="kobo.953.1" xmlns="http://www.w3.org/1999/xhtml"> manually in the Clean Architecture with MediatR project, you can use the open-source project </span><code><span class="koboSpan" id="kobo.954.1" xmlns="http://www.w3.org/1999/xhtml">HybridModelBinding</span></code><span class="koboSpan" id="kobo.955.1" xmlns="http://www.w3.org/1999/xhtml"> or read the official documentation about custom model binding and implement your own:</span></li>
</ul>
<ol>
<li><span class="koboSpan" id="kobo.956.1" xmlns="http://www.w3.org/1999/xhtml">Custom Model Binding in ASP.NET Core: </span><a href="https://adpg.link/65pb"><span class="koboSpan" id="kobo.957.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/65pb</span></a></li>
<li><span class="koboSpan" id="kobo.958.1" xmlns="http://www.w3.org/1999/xhtml">Damian Edward’s MinimalApis.Extensions project on GitHub: </span><a href="https://adpg.link/M6zS"><span class="koboSpan" id="kobo.959.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/M6zS</span></a></li>
</ol>
<ul>
<li><code><span class="koboSpan" id="kobo.960.1" xmlns="http://www.w3.org/1999/xhtml">ForEvolve.DependencyInjection</span></code><span class="koboSpan" id="kobo.961.1" xmlns="http://www.w3.org/1999/xhtml"> is an open-source project that adds support for contextual dependency injection and more: </span><a href="https://adpg.link/myW8"><span class="koboSpan" id="kobo.962.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/myW8</span></a></li>
</ul>
</section>
<section class="level2" data-number="17.10" id="answers-12">
<h2 data-number="17.10"><span class="koboSpan" id="kobo.963.1" xmlns="http://www.w3.org/1999/xhtml">Answers</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.964.1" xmlns="http://www.w3.org/1999/xhtml">CQS stands for Command-Query Separation. </span><span class="koboSpan" id="kobo.964.2" xmlns="http://www.w3.org/1999/xhtml">It's a software design principle that separates operations that change the state of an object (commands) from those that return data (queries). </span><span class="koboSpan" id="kobo.964.3" xmlns="http://www.w3.org/1999/xhtml">This helps in minimizing side effects and preventing unexpected changes in program behavior.</span></li>
<li><span class="koboSpan" id="kobo.965.1" xmlns="http://www.w3.org/1999/xhtml">Yes, you can. </span><span class="koboSpan" id="kobo.965.2" xmlns="http://www.w3.org/1999/xhtml">The goal of the Mediator pattern is to mediate communication between colleagues.</span></li>
<li><span class="koboSpan" id="kobo.966.1" xmlns="http://www.w3.org/1999/xhtml">In the original sense of CQS: no, a command can’t return a value. </span><span class="koboSpan" id="kobo.966.2" xmlns="http://www.w3.org/1999/xhtml">The idea is that a query reads data while commands mutate data. </span><span class="koboSpan" id="kobo.966.3" xmlns="http://www.w3.org/1999/xhtml">A command can return a value in a looser sense of CQS. </span><span class="koboSpan" id="kobo.966.4" xmlns="http://www.w3.org/1999/xhtml">For example, nothing stops a create command from returning the created entity partially or totally. </span><span class="koboSpan" id="kobo.966.5" xmlns="http://www.w3.org/1999/xhtml">You can always trade a bit of modularity for a bit of performance.</span></li>
<li><span class="koboSpan" id="kobo.967.1" xmlns="http://www.w3.org/1999/xhtml">MediatR is a free, open-source project licensed under Apache License 2.0.</span></li>
<li><span class="koboSpan" id="kobo.968.1" xmlns="http://www.w3.org/1999/xhtml">Yes, you should. </span><span class="koboSpan" id="kobo.968.2" xmlns="http://www.w3.org/1999/xhtml">Using Marker Interfaces to add metadata is generally wrong. </span><span class="koboSpan" id="kobo.968.3" xmlns="http://www.w3.org/1999/xhtml">Nevertheless, you should analyze each use case individually, considering the pros and cons before jumping to a conclusion.</span></li>
</ol>
</section>
</section>
</body>
</html>
