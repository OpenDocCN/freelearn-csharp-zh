<html><head></head><body>
<div id="_idContainer111">
<h1 class="chapter-number" id="_idParaDest-162"><a id="_idTextAnchor161"/><span class="koboSpan" id="kobo.1.1">7</span></h1>
<h1 id="_idParaDest-163"><a id="_idTextAnchor162"/><span class="koboSpan" id="kobo.2.1">Test-Driven Development</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Let’s continue our discussion of testing and ensuring the quality of our software processes by going in-depth with </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">Test-Driven Development.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">While this is a book about refactoring and Test-Driven Development is primarily intended for future development and bug fixing, it has some key lessons to teach us in software quality and the same tools Visual Studio provides to support Test-Driven Development can help immensely in the </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">refactoring process.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">In this chapter, we’ll cover the following </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">main topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.9.1">What is </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">Test-Driven Development?</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Test-Driven Development with </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">Visual Studio</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">When to use </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">Test-Driven Development</span></span></li>
</ul>
<h1 id="_idParaDest-164"><a id="_idTextAnchor163"/><span class="koboSpan" id="kobo.15.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.16.1">The starting code for this chapter is available from GitHub at </span><a href="https://github.com/PacktPublishing/Refactoring-with-CSharp"><span class="koboSpan" id="kobo.17.1">https://github.com/PacktPublishing/Refactoring-with-CSharp</span></a><span class="koboSpan" id="kobo.18.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.19.1">Chapter07/Ch7BeginningCode</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.20.1"> folder.</span></span></p>
<h1 id="_idParaDest-165"><a id="_idTextAnchor164"/><span class="koboSpan" id="kobo.21.1">What is Test-Driven Development?</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.22.1">Test-driven Development</span></strong><span class="koboSpan" id="kobo.23.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.24.1">TDD</span></strong><span class="koboSpan" id="kobo.25.1">) is the </span><a id="_idIndexMarker422"/><span class="koboSpan" id="kobo.26.1">process of writing your tests </span><em class="italic"><span class="koboSpan" id="kobo.27.1">before</span></em><span class="koboSpan" id="kobo.28.1"> you write your code for a new feature or to implement a </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">new fix.</span></span></p>
<p><span class="koboSpan" id="kobo.30.1">Under TDD, you first write a test for the feature you’re trying to implement or a test to reproduce the bug you’re about to fix. </span><span class="koboSpan" id="kobo.30.2">You do this in the most ideal way possible, which may even involve classes or methods that don’t exist at the start of </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">your test.</span></span></p>
<p><span class="koboSpan" id="kobo.32.1">Next, you do the minimum amount of work needed to make your code successfully compile. </span><span class="koboSpan" id="kobo.32.2">This isn’t to say that it runs perfectly or does the thing it is trying to do, in fact, you’re trying to start out with a red failing test that indicates your feature or fix </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">doesn’t work.</span></span></p>
<p><span class="koboSpan" id="kobo.34.1">This</span><a id="_idIndexMarker423"/><span class="koboSpan" id="kobo.35.1"> makes sense when you consider that at this point you haven’t implemented the new feature or made the fix to the code. </span><span class="koboSpan" id="kobo.35.2">So, the test </span><em class="italic"><span class="koboSpan" id="kobo.36.1">should</span></em><span class="koboSpan" id="kobo.37.1"> be a </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">failing test.</span></span></p>
<p><span class="koboSpan" id="kobo.39.1">Next, you write the minimum amount of code required to make your test pass. </span><span class="koboSpan" id="kobo.39.2">In this step, you are doing what you need to do to meet the specific requirement you are trying to address. </span><span class="koboSpan" id="kobo.39.3">Once you are finished, your test should turn into a green </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">passing test.</span></span></p>
<p><span class="koboSpan" id="kobo.41.1">After that, you refactor the code you added to implement your feature or fix and you refactor your test code as well; taking care to continue to run your unit tests to ensure you haven’t </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">broken anything.</span></span></p>
<p><span class="koboSpan" id="kobo.43.1">Once you’re satisfied with the state of your new code and your test, you look at the next requirement on the current work item you’re working on, write a test for that, and repeat the process until you have </span><a id="_idIndexMarker424"/><span class="koboSpan" id="kobo.44.1">met all requirements. </span><span class="koboSpan" id="kobo.44.2">This process is illustrated in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.45.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.46.1">.1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer101">
<span class="koboSpan" id="kobo.48.1"><img alt="Figure 7.1 – The Test-Driven Development Cycle" src="image/B21324_07_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.49.1">Figure 7.1 – The Test-Driven Development Cycle</span></p>
<p><span class="koboSpan" id="kobo.50.1">Because you start with a failing red test, move on to a green passing test, and then refactor your code before starting again with a new requirement, TDD is sometimes referred to as </span><strong class="bold"><span class="koboSpan" id="kobo.51.1">Red / Green / </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.52.1">Refactor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.54.1">This process </span><a id="_idIndexMarker425"/><span class="koboSpan" id="kobo.55.1">has a few </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">key benefits:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.57.1">You can be confident your code addresses the problem by starting with </span><span class="No-Break"><span class="koboSpan" id="kobo.58.1">a test.</span></span></li>
<li><span class="koboSpan" id="kobo.59.1">Code written in this way is guaranteed to be covered by </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">your tests.</span></span></li>
<li><span class="koboSpan" id="kobo.61.1">When you start with how your code should be called by others, it tends to lead to more</span><a id="_idIndexMarker426"/><span class="koboSpan" id="kobo.62.1"> intuitive class designs for others to </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">use later.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.64.1">This process, and its results, make a lot more sense with a practical example. </span><span class="koboSpan" id="kobo.64.2">So, let’s jump into some code and implement a new feature for Cloudy </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">Skies Airlines.</span></span></p>
<h1 id="_idParaDest-166"><a id="_idTextAnchor165"/><span class="koboSpan" id="kobo.66.1">Test-Driven Development with Visual Studio</span></h1>
<p><span class="koboSpan" id="kobo.67.1">We’re starting</span><a id="_idIndexMarker427"/><span class="koboSpan" id="kobo.68.1"> this chapter with a nearly empty console project and a supporting xUnit test project that has already been linked to the main project as shown in </span><a href="B21324_06.xhtml#_idTextAnchor133"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.69.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.70.1">. </span><span class="koboSpan" id="kobo.70.2">The structure of this project can be seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.71.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.72.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer102">
<span class="koboSpan" id="kobo.74.1"><img alt="Figure 7.2 – Solution Explorer showing only a few files" src="image/B21324_07_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.75.1">Figure 7.2 – Solution Explorer showing only a few files</span></p>
<p><span class="koboSpan" id="kobo.76.1">Over the course of the rest of this section, we’re going to add a new class to track frequent flier miles for Cloudy </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">Skies Airlines.</span></span></p>
<p><span class="koboSpan" id="kobo.78.1">The requirements</span><a id="_idIndexMarker428"/><span class="koboSpan" id="kobo.79.1"> we’ll be addressing (in </span><span class="No-Break"><span class="koboSpan" id="kobo.80.1">order) are:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.81.1">When a new Frequent Flier Account is created it should start with a starting balance of </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1">100 miles.</span></span></li>
<li><span class="koboSpan" id="kobo.83.1">You should be able to add miles to the frequent </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">flier account.</span></span></li>
<li><span class="koboSpan" id="kobo.85.1">You should be able to mark miles as redeemed as long as this wouldn’t result in a </span><span class="No-Break"><span class="koboSpan" id="kobo.86.1">negative balance.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.87.1">These are not complex requirements, but they should serve as a starting point for briefly </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">exploring TDD.</span></span></p>
<p><span class="koboSpan" id="kobo.89.1">We’ll start with the starting </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">balance requirement.</span></span></p>
<h2 id="_idParaDest-167"><a id="_idTextAnchor166"/><span class="koboSpan" id="kobo.91.1">Setting the starting balance</span></h2>
<p><span class="koboSpan" id="kobo.92.1">Our first</span><a id="_idIndexMarker429"/><span class="koboSpan" id="kobo.93.1"> requirement involves the account starting with 100 miles </span><span class="No-Break"><span class="koboSpan" id="kobo.94.1">already registered.</span></span></p>
<p><span class="koboSpan" id="kobo.95.1">Under the guidance of TDD, we should start with a failing test. </span><span class="koboSpan" id="kobo.95.2">Thankfully, we already have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.96.1">MilesTrackerTests.cs</span></strong><span class="koboSpan" id="kobo.97.1"> file, so that gives us a good place </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">to start.</span></span></p>
<p><span class="koboSpan" id="kobo.99.1">However, we have no classes in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.100.1">Chapter7</span></strong><span class="koboSpan" id="kobo.101.1"> project to represent the mileage tracker, which poses a problem for us in writing the arrange section of our </span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">first test.</span></span></p>
<p><span class="koboSpan" id="kobo.103.1">While there’s a temptation to “cheat” a bit by creating the class now, let’s follow a strictly TDD approach and write the test code in the way we’d prefer to interact with the class, knowing that the class doesn’t exist yet and this will cause some compiler errors for us in </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">a moment.</span></span></p>
<p><span class="koboSpan" id="kobo.105.1">Such a test might look </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.107.1">
[Fact]
public void NewAccountShouldHaveStartingBalance() {
  // Arrange
  int expectedMiles = 100;
  // Act
  </span><strong class="bold"><span class="koboSpan" id="kobo.108.1">MileageTracker tracker = new();</span></strong><span class="koboSpan" id="kobo.109.1">
  // Assert
  Assert.Equal(expectedMiles, </span><strong class="bold"><span class="koboSpan" id="kobo.110.1">tracker.Balance</span></strong><span class="koboSpan" id="kobo.111.1">);
}</span></pre>
<p><span class="koboSpan" id="kobo.112.1">This test sets an expected starting mileage variable, tries to instantiate a </span><strong class="source-inline"><span class="koboSpan" id="kobo.113.1">MileageTracker</span></strong><span class="koboSpan" id="kobo.114.1">, and then asserts that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.115.1">Balance</span></strong><span class="koboSpan" id="kobo.116.1"> property on this new tracker should be the </span><span class="No-Break"><span class="koboSpan" id="kobo.117.1">expected amount.</span></span></p>
<p><span class="koboSpan" id="kobo.118.1">This is a simple, concise, and readable test with a couple of tiny problems: </span><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">MileageTracker</span></strong><span class="koboSpan" id="kobo.120.1"> and its </span><strong class="source-inline"><span class="koboSpan" id="kobo.121.1">Balance</span></strong><span class="koboSpan" id="kobo.122.1"> property don’t exist in our code yet, meaning our code </span><span class="No-Break"><span class="koboSpan" id="kobo.123.1">won’t compile.</span></span></p>
<h3><span class="koboSpan" id="kobo.124.1">Generating classes</span></h3>
<p><span class="koboSpan" id="kobo.125.1">These </span><a id="_idIndexMarker430"/><span class="koboSpan" id="kobo.126.1">compiler issues when creating new classes and new properties are normal and to be expected when coding under TDD. </span><span class="koboSpan" id="kobo.126.2">Thankfully Visual Studio has a Quick Actions refactoring available </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">for us.</span></span></p>
<p><span class="koboSpan" id="kobo.128.1">Select the </span><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">MileageTracker</span></strong><span class="koboSpan" id="kobo.130.1"> in your act section and open the Quick Actions menu. </span><span class="koboSpan" id="kobo.130.2">From there note the various options to generate this Type as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.131.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.132.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer103">
<span class="koboSpan" id="kobo.134.1"><img alt="Figure 7.3 – Quick Actions to generate a new Type" src="image/B21324_07_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.135.1">Figure 7.3 – Quick Actions to generate a new Type</span></p>
<p><span class="koboSpan" id="kobo.136.1">These options, as shown here, are great, but most of them would create the new class inside the test project which is not what we want. </span><span class="koboSpan" id="kobo.136.2">Since we want to customize the new type being created, select </span><strong class="bold"><span class="koboSpan" id="kobo.137.1">Generate </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.138.1">new type…</span></strong></span></p>
<p><span class="koboSpan" id="kobo.139.1">This will open the </span><strong class="bold"><span class="koboSpan" id="kobo.140.1">Generate Type </span></strong><span class="koboSpan" id="kobo.141.1">dialog allowing you to select the type, name, and location of the new type being generated. </span><span class="koboSpan" id="kobo.141.2">Change the </span><strong class="bold"><span class="koboSpan" id="kobo.142.1">Project</span></strong><span class="koboSpan" id="kobo.143.1"> to </span><em class="italic"><span class="koboSpan" id="kobo.144.1">Chapter7</span></em><span class="koboSpan" id="kobo.145.1"> and choose to create a new file as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.146.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.147.1">.4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer104">
<span class="koboSpan" id="kobo.149.1"><img alt="Figure 7.4 – Generating a new class in the Chapter7 project" src="image/B21324_07_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.150.1">Figure 7.4 – Generating a new class in the Chapter7 project</span></p>
<p><span class="koboSpan" id="kobo.151.1">Next, click </span><strong class="bold"><span class="koboSpan" id="kobo.152.1">OK</span></strong><span class="koboSpan" id="kobo.153.1"> and Visual Studio will generate this class and add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.154.1">MileageTracker.cs</span></strong><span class="koboSpan" id="kobo.155.1"> file to the </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">main project.</span></span></p>
<p><span class="koboSpan" id="kobo.157.1">This </span><a id="_idIndexMarker431"/><span class="koboSpan" id="kobo.158.1">class is boring at present with nothing in it, but we’ll add to it in a moment as we work on the next </span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">compiler error.</span></span></p>
<h3><span class="koboSpan" id="kobo.160.1">Generating members</span></h3>
<p><span class="koboSpan" id="kobo.161.1">Going back</span><a id="_idIndexMarker432"/><span class="koboSpan" id="kobo.162.1"> to our test, the </span><em class="italic"><span class="koboSpan" id="kobo.163.1">act</span></em><span class="koboSpan" id="kobo.164.1"> section now has no issues, but we still have a compiler error on the reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">Balance</span></strong><span class="koboSpan" id="kobo.166.1"> in the </span><em class="italic"><span class="koboSpan" id="kobo.167.1">Assert</span></em><span class="koboSpan" id="kobo.168.1"> section as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.169.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.170.1">.5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer105">
<span class="koboSpan" id="kobo.172.1"><img alt="Figure 7.5 – The C# Compiler pointing out that MileageTracker has Balance property" src="image/B21324_07_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.173.1">Figure 7.5 – The C# Compiler pointing out that MileageTracker has Balance property</span></p>
<p><span class="koboSpan" id="kobo.174.1">Thankfully, Visual Studio gives us tools to generate properties. </span><span class="koboSpan" id="kobo.174.2">Let’s do that now so our code will at </span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">least compile.</span></span></p>
<p><span class="koboSpan" id="kobo.176.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.177.1">Balance</span></strong><span class="koboSpan" id="kobo.178.1"> and then open the </span><strong class="bold"><span class="koboSpan" id="kobo.179.1">Quick Actions</span></strong><span class="koboSpan" id="kobo.180.1"> menu and choose </span><strong class="bold"><span class="koboSpan" id="kobo.181.1">Generate property ‘Balance’</span></strong><span class="koboSpan" id="kobo.182.1"> as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.183.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.184.1">.6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.185.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer106">
<span class="koboSpan" id="kobo.186.1"><img alt="Figure 7.6 – Generating a new property" src="image/B21324_07_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.187.1">Figure 7.6 – Generating a new property</span></p>
<p><span class="koboSpan" id="kobo.188.1">Doing so causes Balance to be defined. </span><span class="koboSpan" id="kobo.188.2">If you hold down </span><em class="italic"><span class="koboSpan" id="kobo.189.1">Ctrl</span></em><span class="koboSpan" id="kobo.190.1"> and click on </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">Balance</span></strong><span class="koboSpan" id="kobo.192.1">, it will navigate you to </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">MileageTracker.cs</span></strong><span class="koboSpan" id="kobo.194.1"> and we’ll see how the class </span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">is defined:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.196.1">
public class MileageTracker {
  public IEnumerable&lt;object&gt; Balance { get; set; }
}</span></pre>
<p><span class="koboSpan" id="kobo.197.1">Here, Visual Studio</span><a id="_idIndexMarker433"/><span class="koboSpan" id="kobo.198.1"> had to guess what property type </span><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">Balance</span></strong><span class="koboSpan" id="kobo.200.1"> was and it guessed horribly wrong. </span><span class="koboSpan" id="kobo.200.2">Since this will otherwise cause compiler errors, change </span><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">Balance</span></strong><span class="koboSpan" id="kobo.202.1"> to </span><span class="No-Break"><span class="koboSpan" id="kobo.203.1">an </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">int</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.206.1">
public class MileageTracker {
  public </span><strong class="bold"><span class="koboSpan" id="kobo.207.1">int</span></strong><span class="koboSpan" id="kobo.208.1"> Balance { get; set; }
}</span></pre>
<p><span class="koboSpan" id="kobo.209.1">With that change, the code should now compile, but let’s make one more change before we run </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">our tests.</span></span></p>
<p><span class="koboSpan" id="kobo.211.1">Remember that TDD requires us to write the minimum amount of code to do what we’re trying to do? </span><span class="koboSpan" id="kobo.211.2">Technically, Visual Studio has violated this principle by generating both a getter and a setter for our Balance property. </span><span class="koboSpan" id="kobo.211.3">In this test, we only need to get the </span><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">Balance</span></strong><span class="koboSpan" id="kobo.213.1"> and not set it via this property. </span><span class="koboSpan" id="kobo.213.2">So, let’s protect that </span><strong class="source-inline"><span class="koboSpan" id="kobo.214.1">Balance</span></strong><span class="koboSpan" id="kobo.215.1"> by removing </span><span class="No-Break"><span class="koboSpan" id="kobo.216.1">the setter:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.217.1">
public class MileageTracker {
  public int Balance </span><strong class="bold"><span class="koboSpan" id="kobo.218.1">{ get; }</span></strong><span class="koboSpan" id="kobo.219.1">
}</span></pre>
<p><span class="koboSpan" id="kobo.220.1">With this bit of added encapsulation in hand and our code compiling, let’s run our test. </span><span class="koboSpan" id="kobo.220.2">When you do so, you should see the test fail stating that it expected </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">Balance</span></strong><span class="koboSpan" id="kobo.222.1"> to be 100 but it actually was 0 as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.223.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.224.1">.7</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.225.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer107">
<span class="koboSpan" id="kobo.226.1"><img alt="Figure 7.7 – Our first failing test" src="image/B21324_07_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.227.1">Figure 7.7 – Our first failing test</span></p>
<p><span class="koboSpan" id="kobo.228.1">Under TDD, this is exactly what we’d want. </span><span class="koboSpan" id="kobo.228.2">We did the minimum amount of work to get an ideal test to </span><a id="_idIndexMarker434"/><span class="koboSpan" id="kobo.229.1">compile, and that test failed because we hadn’t fully implemented </span><span class="No-Break"><span class="koboSpan" id="kobo.230.1">the feature.</span></span></p>
<h3><span class="koboSpan" id="kobo.231.1">Moving from red to green and onto refactoring</span></h3>
<p><span class="koboSpan" id="kobo.232.1">Let’s implement</span><a id="_idIndexMarker435"/><span class="koboSpan" id="kobo.233.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.234.1">feature now.</span></span></p>
<p><span class="koboSpan" id="kobo.235.1">While we know that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">MileageTracker</span></strong><span class="koboSpan" id="kobo.237.1"> will need some additional things later, let’s implement this feature by writing the minimum amount of </span><span class="No-Break"><span class="koboSpan" id="kobo.238.1">code possible:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.239.1">
public class MileageTracker {
  public int Balance { get; } </span><strong class="bold"><span class="koboSpan" id="kobo.240.1">= 100</span></strong><span class="koboSpan" id="kobo.241.1">;
}</span></pre>
<p><span class="koboSpan" id="kobo.242.1">This now defaults new </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">MileageTracker</span></strong><span class="koboSpan" id="kobo.244.1"> instances to have a starting balance of 100, which meets our needs and causes our test to turn green and pass </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">when re-run.</span></span></p>
<p><span class="koboSpan" id="kobo.246.1">With a green test, we now look for opportunities to refactor. </span><span class="koboSpan" id="kobo.246.2">While our test code is minimal, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">MileageTracker</span></strong><span class="koboSpan" id="kobo.248.1"> does </span><a id="_idIndexMarker436"/><span class="koboSpan" id="kobo.249.1">have a </span><strong class="bold"><span class="koboSpan" id="kobo.250.1">magic number</span></strong><span class="koboSpan" id="kobo.251.1"> in it. </span><span class="koboSpan" id="kobo.251.2">Magic numbers are </span><strong class="bold"><span class="koboSpan" id="kobo.252.1">code smells</span></strong><span class="koboSpan" id="kobo.253.1"> that </span><a id="_idIndexMarker437"/><span class="koboSpan" id="kobo.254.1">represent some sort of undocumented business or </span><span class="No-Break"><span class="koboSpan" id="kobo.255.1">technical requirement.</span></span></p>
<p><span class="koboSpan" id="kobo.256.1">Let’s fix it by introducing </span><span class="No-Break"><span class="koboSpan" id="kobo.257.1">a constant:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.258.1">
public class MileageTracker {
    </span><strong class="bold"><span class="koboSpan" id="kobo.259.1">private const int SignUpBonus = 100;</span></strong><span class="koboSpan" id="kobo.260.1">
    public int Balance { get; } = </span><strong class="bold"><span class="koboSpan" id="kobo.261.1">SignUpBonus</span></strong><span class="koboSpan" id="kobo.262.1">;
}</span></pre>
<p><span class="koboSpan" id="kobo.263.1">This code </span><a id="_idIndexMarker438"/><span class="koboSpan" id="kobo.264.1">is now easier for others to understand, removing the </span><span class="No-Break"><span class="koboSpan" id="kobo.265.1">code smell.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.266.1">Naming</span></p>
<p class="callout"><span class="koboSpan" id="kobo.267.1">Naming things in software engineering is hard. </span><span class="koboSpan" id="kobo.267.2">It’s possible the name that occurred to you for this class or the </span><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">SignUpBonus</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.269.1">const</span></strong><span class="koboSpan" id="kobo.270.1"> I introduced was different than the names I picked. </span><span class="koboSpan" id="kobo.270.2">That’s fine. </span><span class="koboSpan" id="kobo.270.3">What’s most important about a name is that it </span><em class="italic"><span class="koboSpan" id="kobo.271.1">communicates intent</span></em><span class="koboSpan" id="kobo.272.1"> to other developers and is not confused with something else in the system. </span><span class="koboSpan" id="kobo.272.2">While the name </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">StartingBalance</span></strong><span class="koboSpan" id="kobo.274.1"> would have been fine for my const, I chose </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">SignUpBonus</span></strong><span class="koboSpan" id="kobo.276.1"> because I thought it more clearly documented the business case for the </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">starting balance.</span></span></p>
<p><span class="koboSpan" id="kobo.278.1">Running the tests again results in a green passing test once more and there are no other obvious targets for refactoring, so we move on to the </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">next requirement.</span></span></p>
<h2 id="_idParaDest-168"><a id="_idTextAnchor167"/><span class="koboSpan" id="kobo.280.1">Adding miles and generating methods</span></h2>
<p><span class="koboSpan" id="kobo.281.1">Our next requirement is </span><em class="italic"><span class="koboSpan" id="kobo.282.1">You should be able to add miles to the frequent </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.283.1">flier account</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.284.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.285.1">Let’s go back </span><a id="_idIndexMarker439"/><span class="koboSpan" id="kobo.286.1">to our tests and add a new test for this requirement. </span><span class="koboSpan" id="kobo.286.2">Here we’ll again choose the most intuitive syntax and then make the code </span><a id="_idIndexMarker440"/><span class="koboSpan" id="kobo.287.1">compile and test </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">pass later:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.289.1">
[Fact]
public void AddMileageShouldIncreaseBalance() {
  // Arrange
  MileageTracker tracker = new();
  // Act
  </span><strong class="bold"><span class="koboSpan" id="kobo.290.1">tracker.AddMiles(50);</span></strong><span class="koboSpan" id="kobo.291.1">
  // Assert
  Assert.Equal(150, tracker.Balance);
}</span></pre>
<p><span class="koboSpan" id="kobo.292.1">This test instantiates a </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">MileageTracker</span></strong><span class="koboSpan" id="kobo.294.1">, then tries to add 50 miles using a not-yet-created </span><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">AddMiles</span></strong><span class="koboSpan" id="kobo.296.1"> method before verifying that the balance is 150 (100 starting miles plus the 50 we </span><span class="No-Break"><span class="koboSpan" id="kobo.297.1">just added).</span></span></p>
<p><span class="koboSpan" id="kobo.298.1">Of course, there is no </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">AddMiles</span></strong><span class="koboSpan" id="kobo.300.1"> method in </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">MileageTracker</span></strong><span class="koboSpan" id="kobo.302.1">. </span><span class="koboSpan" id="kobo.302.2">Let’s add one by selecting </span><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">AddMiles</span></strong><span class="koboSpan" id="kobo.304.1"> and then choosing </span><strong class="bold"><span class="koboSpan" id="kobo.305.1">Generate method ‘AddMiles’ </span></strong><span class="koboSpan" id="kobo.306.1">from the </span><strong class="bold"><span class="koboSpan" id="kobo.307.1">Quick Actions</span></strong><span class="koboSpan" id="kobo.308.1"> menu as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.309.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.310.1">.8</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer108">
<span class="koboSpan" id="kobo.312.1"><img alt="Figure 7.8 – Adding a new method" src="image/B21324_07_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.313.1">Figure 7.8 – Adding a new method</span></p>
<p><span class="koboSpan" id="kobo.314.1">Adding this method causes it to be created with the </span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">following implementation:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.316.1">
public void AddMiles(int v) {
  throw new NotImplementedException();
}</span></pre>
<p><span class="koboSpan" id="kobo.317.1">Obviously, this </span><a id="_idIndexMarker441"/><span class="koboSpan" id="kobo.318.1">is not what the method should do. </span><span class="koboSpan" id="kobo.318.2">However, let’s follow strict TDD and move through the motions one step at </span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">a time.</span></span></p>
<p><span class="koboSpan" id="kobo.320.1">Since our code now compiles, we can run the test and verify that it fails </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">as expected.</span></span></p>
<p><span class="koboSpan" id="kobo.322.1">Once we’re </span><a id="_idIndexMarker442"/><span class="koboSpan" id="kobo.323.1">confident we have a test that can detect failing code we write only the minimum amount of code required to get the test to pass. </span><span class="koboSpan" id="kobo.323.2">This ensures that our tests are sufficient for finding actual problems with the </span><span class="No-Break"><span class="koboSpan" id="kobo.324.1">code later.</span></span></p>
<p><span class="koboSpan" id="kobo.325.1">A passing implementation of </span><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">AddMiles</span></strong><span class="koboSpan" id="kobo.327.1"> might look </span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.329.1">
public class MileageTracker {
    private const int SignUpBonus = 100;
    public int Balance { get; set; } = SignUpBonus;
</span><strong class="bold"><span class="koboSpan" id="kobo.330.1">    public void AddMiles(int miles) {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.331.1">      Balance += miles;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.332.1">    }</span></strong><span class="koboSpan" id="kobo.333.1">
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.334.1">As you can see, the code now compiles and results in green tests. </span><span class="koboSpan" id="kobo.334.2">This means we should move on to refactoring our code </span><span class="No-Break"><span class="koboSpan" id="kobo.335.1">as needed.</span></span></p>
<p><span class="koboSpan" id="kobo.336.1">The test code is still clean and the only refactoring I can see to apply here might be to use the </span><a id="_idIndexMarker443"/><span class="koboSpan" id="kobo.337.1">expression-bodied members that we covered in </span><a href="B21324_04.xhtml#_idTextAnchor072"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.338.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.339.1">. </span><span class="koboSpan" id="kobo.339.2">However, I’m going to leave the </span><a id="_idIndexMarker444"/><span class="koboSpan" id="kobo.340.1">code in its current form as the class is still </span><span class="No-Break"><span class="koboSpan" id="kobo.341.1">very minimal.</span></span></p>
<p><span class="koboSpan" id="kobo.342.1">With that requirement complete, let’s move on to our final requirement around </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">redeeming miles.</span></span></p>
<h2 id="_idParaDest-169"><a id="_idTextAnchor168"/><span class="koboSpan" id="kobo.344.1">Redeeming miles and refactoring tests</span></h2>
<p><span class="koboSpan" id="kobo.345.1">Our final</span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.346.1"> requirement is </span><em class="italic"><span class="koboSpan" id="kobo.347.1">You should be able to mark miles as redeemed if this wouldn’t cause a negative balance</span></em><span class="koboSpan" id="kobo.348.1">. </span><span class="koboSpan" id="kobo.348.2">This is a bit more </span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.349.1">complex than the last requirement as it has a condition attached </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">to it.</span></span></p>
<p><span class="koboSpan" id="kobo.351.1">As we did before, let’s start by writing </span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">a test:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.353.1">
[Fact]
public void RedeemMileageShouldDecreaseBalance() {
    // Arrange
    MileageTracker tracker = new();
    tracker.AddMiles(900);
    // Act
    </span><strong class="bold"><span class="koboSpan" id="kobo.354.1">tracker.RedeemMiles(250);</span></strong><span class="koboSpan" id="kobo.355.1">
    // Assert
    Assert.Equal(750, tracker.Balance);
}</span></pre>
<p><span class="koboSpan" id="kobo.356.1">This test should look very similar to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">AddMiles</span></strong><span class="koboSpan" id="kobo.358.1"> test earlier, except it calls out to a new </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.359.1">RedeemMiles</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.360.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.361.1">Let’s use the </span><em class="italic"><span class="koboSpan" id="kobo.362.1">generate method</span></em><span class="koboSpan" id="kobo.363.1"> refactoring shown earlier to generate that empty </span><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">RedeemMiles</span></strong><span class="koboSpan" id="kobo.365.1"> method and allow the code </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">to compile.</span></span></p>
<p><span class="koboSpan" id="kobo.367.1">This should result in a red failing test as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.368.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.369.1">.9</span></em><span class="koboSpan" id="kobo.370.1"> due to the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">throw new NotImplementedException</span></strong><span class="koboSpan" id="kobo.372.1"> line in </span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">that method:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer109">
<span class="koboSpan" id="kobo.374.1"><img alt="Figure 7.9 – The remove mileage test failing due to an Exception being thrown" src="image/B21324_07_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.375.1">Figure 7.9 – The remove mileage test failing due to an Exception being thrown</span></p>
<p><span class="koboSpan" id="kobo.376.1">However, moving</span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.377.1"> from red to green is again trivial </span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.378.1">here by mirroring what we did </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">AddMiles</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.382.1">
public class MileageTracker {
    private const int SignUpBonus = 100;
    public int Balance { get; set; } = SignUpBonus;
    public void AddMiles(int miles) {
      Balance += miles;
    }
</span><strong class="bold"><span class="koboSpan" id="kobo.383.1">    public void RedeemMiles(int miles) {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.384.1">      Balance -= miles;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.385.1">    }</span></strong><span class="koboSpan" id="kobo.386.1">
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.387.1">This gets our test to pass and so we move on to looking for refactoring options. </span><span class="koboSpan" id="kobo.387.2">This code isn’t bad, so we continue to look for the </span><span class="No-Break"><span class="koboSpan" id="kobo.388.1">next requirement.</span></span></p>
<p><span class="koboSpan" id="kobo.389.1">In this case, we haven’t fully met the requirement we were trying to solve because we don’t cover trying to redeem more miles than are in an account. </span><span class="koboSpan" id="kobo.389.2">Let’s write a new test for </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">that scenario:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.391.1">
[Fact]
public void RedeemMileageShouldPreventNegativeBalance() {
    // Arrange
    MileageTracker tracker = new();
    </span><strong class="bold"><span class="koboSpan" id="kobo.392.1">int startingBalance = tracker.Balance;</span></strong><span class="koboSpan" id="kobo.393.1">
    // Act
    </span><strong class="bold"><span class="koboSpan" id="kobo.394.1">tracker.RedeemMiles(2500);</span></strong><span class="koboSpan" id="kobo.395.1">
    // Assert
    Assert.Equal(</span><strong class="bold"><span class="koboSpan" id="kobo.396.1">startingBalance</span></strong><span class="koboSpan" id="kobo.397.1">, tracker.Balance);
}</span></pre>
<p><span class="koboSpan" id="kobo.398.1">This </span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.399.1">test creates an account and takes note of its starting balance. </span><span class="koboSpan" id="kobo.399.2">The test then attempts to withdraw more miles than accounts </span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.400.1">start with and verifies that the ending balance is equal to the </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">starting balance.</span></span></p>
<p><span class="koboSpan" id="kobo.402.1">This doesn’t rely on any new methods in the tracker. </span><span class="koboSpan" id="kobo.402.2">As a result, our code compiles without changes. </span><span class="koboSpan" id="kobo.402.3">However, running this test results in a failure stating that balance was expected to be 100 but was -</span><span class="No-Break"><span class="koboSpan" id="kobo.403.1">2400 instead.</span></span></p>
<p><span class="koboSpan" id="kobo.404.1">With a red test in hand, let’s modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">RedeemMiles</span></strong><span class="koboSpan" id="kobo.406.1"> method to make the </span><span class="No-Break"><span class="koboSpan" id="kobo.407.1">test green:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.408.1">
public void RedeemMiles(int miles) {
  </span><strong class="bold"><span class="koboSpan" id="kobo.409.1">if (Balance &gt;= miles) {</span></strong><span class="koboSpan" id="kobo.410.1">
    Balance -= miles;
  </span><strong class="bold"><span class="koboSpan" id="kobo.411.1">}</span></strong><span class="koboSpan" id="kobo.412.1">
}</span></pre>
<p><span class="koboSpan" id="kobo.413.1">Now, we check to make sure we have enough miles to fulfill the request and only reduce the mileage if that condition </span><span class="No-Break"><span class="koboSpan" id="kobo.414.1">is met.</span></span></p>
<p><span class="koboSpan" id="kobo.415.1">Running the tests again results in a full set of passing tests as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.416.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.417.1">.10</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.418.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer110">
<span class="koboSpan" id="kobo.419.1"><img alt="Figure 7.10 – Four passing tests around mileage" src="image/B21324_07_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.420.1">Figure 7.10 – Four passing tests around mileage</span></p>
<p><span class="koboSpan" id="kobo.421.1">With a </span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.422.1">passing test in hand, we now look at</span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.423.1"> refactoring. </span><span class="koboSpan" id="kobo.423.2">Since the </span><strong class="source-inline"><span class="koboSpan" id="kobo.424.1">MileageTracker</span></strong><span class="koboSpan" id="kobo.425.1"> is succinct and clear, we’ll move on to looking at </span><span class="No-Break"><span class="koboSpan" id="kobo.426.1">our tests.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.427.1">What about exceptions?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.428.1">Right now </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">RedeemMiles</span></strong><span class="koboSpan" id="kobo.430.1"> will silently fail if you request more miles than desired, which might raise some alarm bells for you as a developer. </span><span class="koboSpan" id="kobo.430.2">In a real-world application, you’d probably want this method to either return a bool indicating if the redemption was successful or to throw an exception if the redemption was not possible. </span><span class="koboSpan" id="kobo.430.3">Both of these scenarios could be handled in TDD as additional requirements to implement, such as “If we try to redeem more miles than possible, an </span><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">InvalidOperationException</span></strong><span class="koboSpan" id="kobo.432.1"> should </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">be thrown”.</span></span></p>
<p><span class="koboSpan" id="kobo.434.1">Looking at our tests, we do see that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.435.1">RemoveMileageShouldDecreaseBalance</span></strong><span class="koboSpan" id="kobo.436.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1">RemoveMileageShouldPreventNegativeBalance</span></strong><span class="koboSpan" id="kobo.438.1"> do </span><span class="No-Break"><span class="koboSpan" id="kobo.439.1">similar things.</span></span></p>
<p><span class="koboSpan" id="kobo.440.1">Due to the duplication between tests, we should combine these into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">Theory</span></strong><span class="koboSpan" id="kobo.442.1"> with </span><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">InlineData</span></strong><span class="koboSpan" id="kobo.444.1"> lines representing individual test cases. </span><span class="koboSpan" id="kobo.444.2">This would look something like </span><span class="No-Break"><span class="koboSpan" id="kobo.445.1">the following:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.446.1">[Theory]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.447.1">[InlineData(900, 250, 750)]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.448.1">[InlineData(0, 2500, 100)]</span></strong><span class="koboSpan" id="kobo.449.1">
public void RedeemMileageShouldResultInCorrectBalance(
  </span><strong class="bold"><span class="koboSpan" id="kobo.450.1">int addAmount, int redeemAmount, int expectedBalance</span></strong><span class="koboSpan" id="kobo.451.1">) {
    // Arrange
    MileageTracker tracker = new();
    tracker.AddMiles(</span><strong class="bold"><span class="koboSpan" id="kobo.452.1">addAmount</span></strong><span class="koboSpan" id="kobo.453.1">);
    // Act
    tracker.RedeemMiles(</span><strong class="bold"><span class="koboSpan" id="kobo.454.1">redeemAmount</span></strong><span class="koboSpan" id="kobo.455.1">);
    // Assert
    Assert.Equal(</span><strong class="bold"><span class="koboSpan" id="kobo.456.1">expectedBalance</span></strong><span class="koboSpan" id="kobo.457.1">, tracker.Balance);
}</span></pre>
<p><span class="koboSpan" id="kobo.458.1">This </span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.459.1">form allows many tests to add an initial </span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.460.1">amount to the balance, redeem some number of miles, and then verify the result matches the expected balance. </span><span class="koboSpan" id="kobo.460.2">This also lets us easily add new scenarios as we </span><span class="No-Break"><span class="koboSpan" id="kobo.461.1">identify them.</span></span></p>
<p><span class="koboSpan" id="kobo.462.1">However, the name of the method is less meaningful than the more specific names we could use with individual </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">Fact</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.464.1"> tests.</span></span></p>
<p><span class="koboSpan" id="kobo.465.1">With passing tests and refactoring complete, we now move on to either the next requirement in this feature or the next work item in our queue. </span><span class="koboSpan" id="kobo.465.2">Let’s close the chapter by talking about TDD at a high level and when it’s right to use in </span><span class="No-Break"><span class="koboSpan" id="kobo.466.1">your projects.</span></span></p>
<h1 id="_idParaDest-170"><a id="_idTextAnchor169"/><span class="koboSpan" id="kobo.467.1">When to use Test-Driven Development</span></h1>
<p><span class="koboSpan" id="kobo.468.1">TDD is not</span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.469.1"> always a good match for every task. </span><span class="koboSpan" id="kobo.469.2">Some tasks, such as highly visual user interface design may not fit into the TDD workflow very well, while others such as fixing an error observed in production or adding a new special case to a calculation are almost ideal </span><span class="No-Break"><span class="koboSpan" id="kobo.470.1">for TDD.</span></span></p>
<p><span class="koboSpan" id="kobo.471.1">Using TDD results in code that is generally easier to understand, has perfect or near-perfect code coverage on tests, and encourages refactoring along </span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">the way.</span></span></p>
<p><span class="koboSpan" id="kobo.473.1">Many developers follow TDD but don’t follow it as strictly as outlined in this chapter. </span><span class="koboSpan" id="kobo.473.2">For example, instead of just generating a method, they may go ahead and implement the method and write additional argument validation code not required by their </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">specific test.</span></span></p>
<p><span class="koboSpan" id="kobo.475.1">Such </span><a id="_idIndexMarker456"/><span class="koboSpan" id="kobo.476.1">deviations from TDD are common and often acceptable, though they usually result in a few pieces of code being added that don’t have </span><span class="No-Break"><span class="koboSpan" id="kobo.477.1">supporting tests.</span></span></p>
<p><span class="koboSpan" id="kobo.478.1">Ultimately, it’s up to you and your team to determine what works best for you and the work that you do, but I can tell you that projects I work on where TDD is possible tend to rapidly reach better quality levels, encourage more refactoring, and have better </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">long-term success.</span></span></p>
<h1 id="_idParaDest-171"><a id="_idTextAnchor170"/><span class="koboSpan" id="kobo.480.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.481.1">In this chapter, we covered Test-Driven Development (TDD) and showed how its process involves writing only the minimum possible amount of code to get to a failing test – make that test pass with the minimum amount of code needed – then, refactor all code as needed before moving on to the next requirement or </span><span class="No-Break"><span class="koboSpan" id="kobo.482.1">work item.</span></span></p>
<p><span class="koboSpan" id="kobo.483.1">We also saw how Visual Studio has Quick Actions that allow you to generate types, properties, and methods and support your efforts in </span><span class="No-Break"><span class="koboSpan" id="kobo.484.1">following TDD.</span></span></p>
<p><span class="koboSpan" id="kobo.485.1">In the next chapter, we’ll talk about anti-patterns that can lead to unmaintainable code and SOLID principles that help your code be robust </span><span class="No-Break"><span class="koboSpan" id="kobo.486.1">and maintainable.</span></span></p>
<h1 id="_idParaDest-172"><a id="_idTextAnchor171"/><span class="koboSpan" id="kobo.487.1">Questions</span></h1>
<ol>
<li><span class="koboSpan" id="kobo.488.1">What areas of your code would be a good fit for </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">using TDD?</span></span></li>
<li><span class="koboSpan" id="kobo.490.1">What areas might be harder to apply </span><span class="No-Break"><span class="koboSpan" id="kobo.491.1">TDD to?</span></span></li>
</ol>
<h1 id="_idParaDest-173"><a id="_idTextAnchor172"/><span class="koboSpan" id="kobo.492.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.493.1">You can find more information about materials discussed in this chapter at </span><span class="No-Break"><span class="koboSpan" id="kobo.494.1">this URL:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.495.1">Test-Driven Development </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.496.1">Walkthrough:</span></em></span><span class="No-Break"> </span><a href="https://learn.microsoft.com/en-us/visualstudio/test/quick-start-test-driven-development-with-test-explorer"><span class="No-Break"><span class="koboSpan" id="kobo.497.1">https://learn.microsoft.com/en-us/visualstudio/test/quick-start-test-driven-development-with-test-explorer</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.498.1">Is TDD </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.499.1">Dead?</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.500.1">: </span></span><a href="https://martinfowler.com/articles/is-tdd-dead/"><span class="No-Break"><span class="koboSpan" id="kobo.501.1">https://martinfowler.com/articles/is-tdd-dead/</span></span></a></li>
</ul>
</div>
</body></html>