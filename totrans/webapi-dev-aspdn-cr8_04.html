<html><head></head><body>
<div id="_idContainer040">
<h1 class="chapter-number" id="_idParaDest-86"><a id="_idTextAnchor170"/><span class="koboSpan" id="kobo.1.1">4</span></h1>
<h1 id="_idParaDest-87"><a id="_idTextAnchor171"/><span class="koboSpan" id="kobo.2.1">ASP.NET Core Fundamentals (Part 2)</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In </span><a href="B18971_03.xhtml#_idTextAnchor130"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.4.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.5.1">, we learned about three important components in ASP.NET Core: routing, configuration, and environment. </span><span class="koboSpan" id="kobo.5.2">Next, let’s continue to explore the other components in </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">ASP.NET Core.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">following topics:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.9.1">Logging</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.10.1">Middleware</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.11.1">ASP.NET Core provides a flexible logging API that works with many logging providers. </span><span class="koboSpan" id="kobo.11.2">We can send and store the logs in various destinations, such as the console, text files, Azure Application Insights, and so on. </span><span class="koboSpan" id="kobo.11.3">When the application has issues, logs can help us find out what is going on. </span><span class="koboSpan" id="kobo.11.4">Logging belongs to a bigger</span><a id="_idIndexMarker351"/><span class="koboSpan" id="kobo.12.1"> topic called </span><em class="italic"><span class="koboSpan" id="kobo.13.1">observability</span></em><span class="koboSpan" id="kobo.14.1">, which is a set of practices that help us understand the state of the application. </span><span class="koboSpan" id="kobo.14.2">In this chapter, we will learn how to use the logging API in </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">ASP.NET Core.</span></span></p>
<p><span class="koboSpan" id="kobo.16.1">Middleware is a</span><a id="_idIndexMarker352"/><span class="koboSpan" id="kobo.17.1"> component that can be plugged into the request pipeline to handle requests and responses. </span><span class="koboSpan" id="kobo.17.2">It is one of the most important improvements in ASP.NET Core compared to the traditional ASP.NET framework. </span><span class="koboSpan" id="kobo.17.3">The request pipeline is a chain of middleware components, and each of these components can do something with the request or response, or pass it to the next middleware component in the pipeline. </span><span class="koboSpan" id="kobo.17.4">In this chapter, we will learn how to use built-in middleware components and how to develop custom </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">middleware components.</span></span></p>
<p><span class="koboSpan" id="kobo.19.1">By the end of this chapter, you will be able to use the logging API to log messages, set up log levels, and configure log providers. </span><span class="koboSpan" id="kobo.19.2">Additionally, you will be able to develop custom middleware components to process requests </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">and responses.</span></span></p>
<h1 id="_idParaDest-88"><a id="_idTextAnchor172"/><span class="koboSpan" id="kobo.21.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.22.1">The code examples in this chapter can be found at </span><a href="https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8/tree/main/samples/chapter4"><span class="koboSpan" id="kobo.23.1">https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8/tree/main/samples/chapter4</span></a><span class="koboSpan" id="kobo.24.1">. </span><span class="koboSpan" id="kobo.24.2">You can use VS 2022 or VS Code to open </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">the solutions</span><a id="_idTextAnchor173"/><span class="koboSpan" id="kobo.26.1">.</span></span></p>
<h1 id="_idParaDest-89"><a id="_idTextAnchor174"/><span class="koboSpan" id="kobo.27.1">Logging</span></h1>
<p><span class="koboSpan" id="kobo.28.1">Logging is</span><a id="_idIndexMarker353"/><span class="koboSpan" id="kobo.29.1"> an important part of any application. </span><span class="koboSpan" id="kobo.29.2">A well-designed logging system can capture data that helps you diagnose problems and monitor the application in production. </span><span class="koboSpan" id="kobo.29.3">Logging gives you insight into how, when, where, and why significant system events occurred so that you know how the application is performing and how users are interacting with it. </span><span class="koboSpan" id="kobo.29.4">Logging may help you to identify security weaknesses or potential attacks. </span><span class="koboSpan" id="kobo.29.5">Logging can also help you audit </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">users activities.</span></span></p>
<p><span class="koboSpan" id="kobo.31.1">Logging should not impact the performance of the application. </span><span class="koboSpan" id="kobo.31.2">It should be fast and efficient. </span><span class="koboSpan" id="kobo.31.3">It should not affect any logic of the application. </span><span class="koboSpan" id="kobo.31.4">When you add logging to an application, you should consider the </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">following points:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.33.1">What information should </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">be logged?</span></span></li>
<li><span class="koboSpan" id="kobo.35.1">What format should log messages </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">be in?</span></span></li>
<li><span class="koboSpan" id="kobo.37.1">Where should log messages </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">be sent?</span></span></li>
<li><span class="koboSpan" id="kobo.39.1">How long should log messages </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">be kept?</span></span></li>
<li><span class="koboSpan" id="kobo.41.1">How to make sure log messages won’t impact the performance of </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">the application?</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.43.1">In this section, we will discuss how to use the logging system in </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">ASP.NET Core.</span></span></p>
<p><span class="koboSpan" id="kobo.45.1">Let's create a new project to learn how to use the logging API. </span><span class="koboSpan" id="kobo.45.2">Create a new ASP.NET Core web API project named </span><strong class="source-inline"><span class="koboSpan" id="kobo.46.1">LoggingDemo</span></strong><span class="koboSpan" id="kobo.47.1"> using the </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.49.1">
dotnet new webapi -n LoggingDemo -controllers</span></pre> <p><span class="koboSpan" id="kobo.50.1">You can also download the source code named </span><strong class="source-inline"><span class="koboSpan" id="kobo.51.1">LoggingDemo</span></strong><span class="koboSpan" id="kobo.52.1"> from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.53.1">samples/chapter4</span></strong><span class="koboSpan" id="kobo.54.1"> folder in the chapter’s </span><span class="No-Break"><span class="koboSpan" id="kobo.55.1">GitHub repositor</span><a id="_idTextAnchor175"/><span class="koboSpan" id="kobo.56.1">y.</span></span></p>
<h2 id="_idParaDest-90"><a id="_idTextAnchor176"/><span class="koboSpan" id="kobo.57.1">Using built-in logging providers</span></h2>
<p><span class="koboSpan" id="kobo.58.1">ASP.NET Core</span><a id="_idIndexMarker354"/><span class="koboSpan" id="kobo.59.1"> supports a logging API that works with</span><a id="_idIndexMarker355"/><span class="koboSpan" id="kobo.60.1"> various logging providers, including built-in logging providers and third-party logging providers. </span><span class="koboSpan" id="kobo.60.2">The default ASP.NET Core web API template has the following logging </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">providers registered:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.62.1">Console </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">logging provider</span></span></li>
<li><span class="koboSpan" id="kobo.64.1">Debug </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">logging provider</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.66.1">EventSource</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.67.1">logging provider</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.68.1">EventLog</span></strong><span class="koboSpan" id="kobo.69.1"> logging provider (</span><span class="No-Break"><span class="koboSpan" id="kobo.70.1">Windows only)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.71.1">To </span><a id="_idIndexMarker356"/><span class="koboSpan" id="kobo.72.1">clearly see how these logging providers work, let’s remove all the pre-registered logging providers and then add the console</span><a id="_idIndexMarker357"/><span class="koboSpan" id="kobo.73.1"> logging provider. </span><span class="koboSpan" id="kobo.73.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.74.1">Program.cs</span></strong><span class="koboSpan" id="kobo.75.1"> file and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.76.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.77.1">
var builder = WebApplication.CreateBuilder(args);builder.Logging.ClearProviders();
builder.Logging.AddConsole();</span></pre>
<p><span class="koboSpan" id="kobo.78.1">Now, only the console logging provider is enabled. </span><span class="koboSpan" id="kobo.78.2">Let's use the console logging provider to output log messages. </span><span class="koboSpan" id="kobo.78.3">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.79.1">WeatherForecastController.cs</span></strong><span class="koboSpan" id="kobo.80.1"> file; you can see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.81.1">ILogger&lt;WeatherForecastController&gt;</span></strong><span class="koboSpan" id="kobo.82.1"> interface is injected into the </span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">constructor already:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.84.1">
private readonly ILogger&lt;WeatherForecastController&gt; _logger;public WeatherForecastController(ILogger&lt;WeatherForecastController&gt; logger
{
    _logger = logger;
}</span></pre>
<p><span class="koboSpan" id="kobo.85.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.86.1">WeatherForecastController.cs</span></strong><span class="koboSpan" id="kobo.87.1"> file in the project. </span><span class="koboSpan" id="kobo.87.2">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.88.1">Get()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.89.1"> method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.90.1">
[HttpGet(Name = "GetWeatherForecast")]public IEnumerable&lt;WeatherForecast&gt; Get()
{
    _logger.Log(LogLevel.Information, "This is a logging message.");
    // Omitted for brevity
}</span></pre>
<p><span class="koboSpan" id="kobo.91.1">Run the application using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">dotnet run</span></strong><span class="koboSpan" id="kobo.93.1"> command. </span><span class="koboSpan" id="kobo.93.2">Request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.94.1">/WeatherForecast</span></strong><span class="koboSpan" id="kobo.95.1"> endpoint using the browser. </span><span class="koboSpan" id="kobo.95.2">You can see the log message in </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">the console:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.97.1">
info: LoggingDemo.WeatherForecastController[0]      This is a logging message.</span></pre>
<p><span class="koboSpan" id="kobo.98.1">If you run </span><a id="_idIndexMarker358"/><span class="koboSpan" id="kobo.99.1">the application in VS 2022 and run the</span><a id="_idIndexMarker359"/><span class="koboSpan" id="kobo.100.1"> application using the </span><em class="italic"><span class="koboSpan" id="kobo.101.1">F5</span></em><span class="koboSpan" id="kobo.102.1"> key, you can see a log message in the console window, but you cannot see it in the </span><strong class="bold"><span class="koboSpan" id="kobo.103.1">Output</span></strong><span class="koboSpan" id="kobo.104.1"> window of </span><span class="No-Break"><span class="koboSpan" id="kobo.105.1">VS 2022:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer032">
<span class="koboSpan" id="kobo.106.1"><img alt="Figure 4.1 – The Output window for debug messages in VS 2022" src="image/B18971_04_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.107.1">Figure 4.1 – The Output window for debug messages in VS 2022</span></p>
<p><span class="koboSpan" id="kobo.108.1">To send logging messages to the </span><strong class="bold"><span class="koboSpan" id="kobo.109.1">Output</span></strong><span class="koboSpan" id="kobo.110.1"> window, we need to enable the </span><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">Debug</span></strong><span class="koboSpan" id="kobo.112.1"> logging provider. </span><span class="koboSpan" id="kobo.112.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.113.1">Program.cs</span></strong><span class="koboSpan" id="kobo.114.1"> file and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.115.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.116.1">
builder.Logging.ClearProviders();builder.Logging.AddConsole();
builder.Logging.AddDebug();</span></pre>
<p><span class="koboSpan" id="kobo.117.1">Press </span><em class="italic"><span class="koboSpan" id="kobo.118.1">F5</span></em><span class="koboSpan" id="kobo.119.1"> to run the application in VS 2022 again. </span><span class="koboSpan" id="kobo.119.2">Now, you can see the log message in the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.120.1">Output</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.121.1"> window:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer033">
<span class="koboSpan" id="kobo.122.1"><img alt="Figure 4.2 – Debug logging messages in VS 2022" src="image/B18971_04_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.123.1">Figure 4.2 – Debug logging messages in VS 2022</span></p>
<p><span class="koboSpan" id="kobo.124.1">So, if want to add more </span><a id="_idIndexMarker360"/><span class="koboSpan" id="kobo.125.1">other logging providers, we </span><a id="_idIndexMarker361"/><span class="koboSpan" id="kobo.126.1">can call the extension methods of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">ILoggingBuilder</span></strong><span class="koboSpan" id="kobo.128.1"> interface. </span><span class="koboSpan" id="kobo.128.2">Some third-party logging providers also provide the extension methods of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">ILoggingBuilder</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.130.1"> interface.</span></span></p>
<p><span class="koboSpan" id="kobo.131.1">For example, if we need to write the log messages to the Windows event log, we can add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.132.1">EventLog</span></strong><span class="koboSpan" id="kobo.133.1"> logging provider. </span><span class="koboSpan" id="kobo.133.2">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.134.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.135.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.136.1">
builder.Logging.AddEventLog();</span></pre> <p><span class="koboSpan" id="kobo.137.1">Test the application and we should be able to see the log messages in the Windows </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">event log.</span></span></p>
<p><span class="koboSpan" id="kobo.139.1">Wait – why can’t we see it in the </span><span class="No-Break"><span class="koboSpan" id="kobo.140.1">event log?</span></span></p>
<p><span class="koboSpan" id="kobo.141.1">This is a specific scenario for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.142.1">EventLog</span></strong><span class="koboSpan" id="kobo.143.1"> logging provider. </span><span class="koboSpan" id="kobo.143.2">Because it is a Windows-only logging provider, it does not inherit the default logging provider settings. </span><span class="koboSpan" id="kobo.143.3">We need to specify the logging level in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.145.1"> file. </span><span class="koboSpan" id="kobo.145.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">appsettings.Development.json</span></strong><span class="koboSpan" id="kobo.147.1"> file and update the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.148.1">Logging</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.149.1"> section:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.150.1">
{  "Logging": {
    "LogLevel": {
      "Default": "Trace",
      "Microsoft.AspNetCore": "Warning"
    },
    "EventLog": {
      "LogLevel": {
        "Default": "Information"
      }
    }
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.151.1">We need </span><a id="_idIndexMarker362"/><span class="koboSpan" id="kobo.152.1">to add an </span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">EventLog</span></strong><span class="koboSpan" id="kobo.154.1"> section to specify the logging level for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">EventLog</span></strong><span class="koboSpan" id="kobo.156.1"> logging provider. </span><span class="koboSpan" id="kobo.156.2">If it is not specified, the default logging level is </span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">Warning</span></strong><span class="koboSpan" id="kobo.158.1">, which is higher than </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">Information</span></strong><span class="koboSpan" id="kobo.160.1">. </span><span class="koboSpan" id="kobo.160.2">This would result in us </span><a id="_idIndexMarker363"/><span class="koboSpan" id="kobo.161.1">not being able to see </span><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">Information</span></strong><span class="koboSpan" id="kobo.163.1"> logging messages. </span><span class="koboSpan" id="kobo.163.2">Run the application again, and now we can see the log messages in the </span><span class="No-Break"><span class="koboSpan" id="kobo.164.1">event log:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer034">
<span class="koboSpan" id="kobo.165.1"><img alt="Figure 4.3 – Event log on Windows" src="image/B18971_04_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.166.1">Figure 4.3 – Event log on Windows</span></p>
<p><span class="koboSpan" id="kobo.167.1">We just introduced a new term – </span><strong class="bold"><span class="koboSpan" id="kobo.168.1">logging level</span></strong><span class="koboSpan" id="kobo.169.1">. </span><span class="koboSpan" id="kobo.169.2">Wh</span><a id="_idTextAnchor177"/><span class="koboSpan" id="kobo.170.1">at </span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">is it?</span></span></p>
<h2 id="_idParaDest-91"><a id="_idTextAnchor178"/><span class="koboSpan" id="kobo.172.1">Logging levels</span></h2>
<p><span class="koboSpan" id="kobo.173.1">In the preceding </span><a id="_idIndexMarker364"/><span class="koboSpan" id="kobo.174.1">example, we used a </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">Log</span></strong><span class="koboSpan" id="kobo.176.1"> method that accepts a </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">LogLevel</span></strong><span class="koboSpan" id="kobo.178.1"> parameter. </span><span class="koboSpan" id="kobo.178.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">LogLevel</span></strong><span class="koboSpan" id="kobo.180.1"> parameter indicates the severity of the log message. </span><span class="koboSpan" id="kobo.180.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">LogLevel</span></strong><span class="koboSpan" id="kobo.182.1"> parameter can be one of the </span><span class="No-Break"><span class="koboSpan" id="kobo.183.1">following values:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-4">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<thead>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.184.1">Level</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.185.1">Value</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.186.1">Description</span></strong></span></p>
</td>
</tr>
</thead>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">Trace</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">0</span></strong></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.189.1">Used for the most detailed messages. </span><span class="koboSpan" id="kobo.189.2">These messages may contain sensitive application data. </span><span class="koboSpan" id="kobo.189.3">These messages are disabled by default and should never be enabled in a </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">production environment.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">Debug</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.192.1">1</span></strong></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.193.1">Used for debugging information and development. </span><span class="koboSpan" id="kobo.193.2">Use with caution in production because of the high volume. </span><span class="koboSpan" id="kobo.193.3">Normally, these logs should not have a </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">long-term value.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">Information</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.196.1">2</span></strong></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.197.1">Used for tracking the general flow of the application. </span><span class="koboSpan" id="kobo.197.2">These logs should have a </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">long-term value.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">Warning</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.200.1">3</span></strong></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.201.1">Used to indicate potential problems or unexpected events. </span><span class="koboSpan" id="kobo.201.2">These issues typically do not cause the application </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">to fail.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">Error</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">4</span></strong></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.205.1">Used to indicate failures in the current operation or request and not an application-wide failure. </span><span class="koboSpan" id="kobo.205.2">These errors and exceptions cannot </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">be handled.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">Critical</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">5</span></strong></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.209.1">Used to indicate critical failures that require immediate attention; for example, data </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">loss scenarios.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">None</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">6</span></strong></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.213.1">Used to specify a logging category that should not </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">write messages.</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.215.1">Table 4.1 – Logging levels</span></p>
<p><span class="koboSpan" id="kobo.216.1">To simplify the method call, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">ILogger&lt;TCategoryName&gt;</span></strong><span class="koboSpan" id="kobo.218.1"> interface provides the following extension methods to log messages for different </span><span class="No-Break"><span class="koboSpan" id="kobo.219.1">logging levels:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">LogTrace()</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">LogDebug()</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.222.1">LogInformation()</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.223.1">LogWarning()</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.224.1">LogError()</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">LogCritical()</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.226.1">You can</span><a id="_idIndexMarker365"/><span class="koboSpan" id="kobo.227.1"> use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.228.1">LogInformation()</span></strong><span class="koboSpan" id="kobo.229.1"> method to replace the </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">Log()</span></strong><span class="koboSpan" id="kobo.231.1"> method in the </span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">preceding example:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.233.1">
_logger.LogInformation("This is a logging message.");</span></pre> <p><span class="koboSpan" id="kobo.234.1">You will see the same log message in the </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">console window.</span></span></p>
<p><span class="koboSpan" id="kobo.236.1">Let’s add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.237.1">LogTrace()</span></strong><span class="koboSpan" id="kobo.238.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.239.1">WeatherForecastController.cs</span></strong><span class="koboSpan" id="kobo.240.1"> file, which will send a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">Trace</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.242.1"> log:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.243.1">
_logger.LogTrace("This is a trace message");</span></pre> <p><span class="koboSpan" id="kobo.244.1">Run the application using </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">dotnet run</span></strong><span class="koboSpan" id="kobo.246.1"> and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">WeatherForecast</span></strong><span class="koboSpan" id="kobo.248.1"> endpoint again. </span><span class="koboSpan" id="kobo.248.2">You will not see the trace message in the console window. </span><span class="koboSpan" id="kobo.248.3">Why? </span><span class="koboSpan" id="kobo.248.4">Because the trace message is disabled by default. </span><span class="koboSpan" id="kobo.248.5">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.250.1"> file; we can find the </span><span class="No-Break"><span class="koboSpan" id="kobo.251.1">following configuration:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.252.1">
"Logging": {  "LogLevel": {
    "Default": "Information",
    "Microsoft.AspNetCore": "Warning"
  }
},</span></pre>
<p><span class="koboSpan" id="kobo.253.1">Based on the configuration, the default logging level is </span><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">Information</span></strong><span class="koboSpan" id="kobo.255.1">. </span><span class="koboSpan" id="kobo.255.2">Look back at the logging level table we introduced before. </span><span class="koboSpan" id="kobo.255.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.256.1">Trace</span></strong><span class="koboSpan" id="kobo.257.1"> logging level is 0, which is less than the </span><strong class="source-inline"><span class="koboSpan" id="kobo.258.1">Information</span></strong><span class="koboSpan" id="kobo.259.1"> logging level. </span><span class="koboSpan" id="kobo.259.2">So, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">Trace</span></strong><span class="koboSpan" id="kobo.261.1"> logging level will not output by default. </span><span class="koboSpan" id="kobo.261.2">To enable the </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">Trace</span></strong><span class="koboSpan" id="kobo.263.1"> logging level, we need to change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">Default</span></strong><span class="koboSpan" id="kobo.265.1"> logging level to </span><strong class="source-inline"><span class="koboSpan" id="kobo.266.1">Trace</span></strong><span class="koboSpan" id="kobo.267.1">. </span><span class="koboSpan" id="kobo.267.2">But there is another question – should we enable </span><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">Trace</span></strong><span class="koboSpan" id="kobo.269.1"> logging for </span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">all environments?</span></span></p>
<p><span class="koboSpan" id="kobo.271.1">The</span><a id="_idIndexMarker366"/><span class="koboSpan" id="kobo.272.1"> answer is </span><em class="italic"><span class="koboSpan" id="kobo.273.1">it depends</span></em><span class="koboSpan" id="kobo.274.1">. </span><span class="koboSpan" id="kobo.274.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">Trace</span></strong><span class="koboSpan" id="kobo.276.1"> logging level is used for the most detailed messages, which means it may contain sensitive application data. </span><span class="koboSpan" id="kobo.276.2">We can enable </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">Trace</span></strong><span class="koboSpan" id="kobo.278.1"> logging in the development environment, but we may not want to enable it in the production environment. </span><span class="koboSpan" id="kobo.278.2">To achieve this, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">appsettings.Development.json</span></strong><span class="koboSpan" id="kobo.280.1"> file to override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.282.1"> file. </span><span class="koboSpan" id="kobo.282.2">That is what we learned in </span><a href="B18971_03.xhtml#_idTextAnchor130"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.283.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.284.1">. </span><span class="koboSpan" id="kobo.284.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">appsettings.Development.json</span></strong><span class="koboSpan" id="kobo.286.1"> file and update the following configuration to enable the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">Trace</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.288.1"> log:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.289.1">
"Logging": {  "LogLevel": {
    "Default": "Trace",
    "Microsoft.AspNetCore": "Warning"
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.290.1">Now, run the application again. </span><span class="koboSpan" id="kobo.290.2">You should be able to see a trace message in the console window for the </span><span class="No-Break"><span class="koboSpan" id="kobo.291.1">development environment.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.292.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.293.1">To specify the logging level for the production environment, we can add an </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">appsettings.Production.json</span></strong><span class="koboSpan" id="kobo.295.1"> file, and then override the settings for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">Logging</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.297.1"> section.</span></span></p>
<p><span class="koboSpan" id="kobo.298.1">Keep in mind that the logging levels such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">Trace</span></strong><span class="koboSpan" id="kobo.300.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">Debug</span></strong><span class="koboSpan" id="kobo.302.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">Information</span></strong><span class="koboSpan" id="kobo.304.1"> will produce a lot of log messages. </span><span class="koboSpan" id="kobo.304.2">If we need to enable them in the production environment for troubleshooting, we need to be careful. </span><span class="koboSpan" id="kobo.304.3">Think about where we want to store </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">logging messages.</span></span></p>
<p><span class="koboSpan" id="kobo.306.1">You may notice that in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.308.1"> file, there is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">Microsoft.AspNetCore</span></strong><span class="koboSpan" id="kobo.310.1"> logging section. </span><span class="koboSpan" id="kobo.310.2">It is used to control the logging level for the ASP.NET Core framework. </span><span class="koboSpan" id="kobo.310.3">ASP.NET Core uses the category name to differentiate logging </span><a id="_idIndexMarker367"/><span class="koboSpan" id="kobo.311.1">messages produced from the framework and the application. </span><span class="koboSpan" id="kobo.311.2">Check the code where we inject the </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">ILogger</span></strong><span class="koboSpan" id="kobo.313.1"> service into </span><span class="No-Break"><span class="koboSpan" id="kobo.314.1">the controller:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.315.1">
public WeatherForecastController(ILogger&lt;WeatherForecastController&gt; logger){
    _logger = logger;
}</span></pre>
<p><span class="koboSpan" id="kobo.316.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">ILogger&lt;TCategoryName&gt;</span></strong><span class="koboSpan" id="kobo.318.1"> interface is defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.319.1">Microsoft.Extensions.Logging</span></strong><span class="koboSpan" id="kobo.320.1"> namespace. </span><span class="koboSpan" id="kobo.320.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.321.1">TCategoryName</span></strong><span class="koboSpan" id="kobo.322.1"> type parameter is used to categorize log messages. </span><span class="koboSpan" id="kobo.322.2">You can use any string values for the category name, but using the class name as the logging category name is a </span><span class="No-Break"><span class="koboSpan" id="kobo.323.1">common practice.</span></span></p>
<h2 id="_idParaDest-92"><a id="_idTextAnchor179"/><span class="koboSpan" id="kobo.324.1">Logging parameters</span></h2>
<p><span class="koboSpan" id="kobo.325.1">These </span><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">Log{LOG LEVEL}()</span></strong><span class="koboSpan" id="kobo.327.1"> methods have some overloads, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">the following:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.329.1">Log{LOG LEVEL}(string? </span><span class="koboSpan" id="kobo.329.2">message, params </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">object?[] args)</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">Log{LOG LEVEL}(EventId eventId, string? </span><span class="koboSpan" id="kobo.331.2">message, params </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">object?[] args)</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">Log{LOG LEVEL}(Exception exception, string message, params </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">object[] args)</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.335.1">Log{LOG LEVEL}(EventId eventId, Exception? </span><span class="koboSpan" id="kobo.335.2">exception, string? </span><span class="koboSpan" id="kobo.335.3">message, params </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">object?[] args)</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.337.1">The </span><a id="_idIndexMarker368"/><span class="koboSpan" id="kobo.338.1">parameters of these methods are set </span><span class="No-Break"><span class="koboSpan" id="kobo.339.1">out here:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.340.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">eventId</span></strong><span class="koboSpan" id="kobo.342.1"> parameter is used to identify the </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">log message</span></span></li>
<li><span class="koboSpan" id="kobo.344.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">message</span></strong><span class="koboSpan" id="kobo.346.1"> parameter is used as a </span><span class="No-Break"><span class="koboSpan" id="kobo.347.1">format string</span></span></li>
<li><span class="koboSpan" id="kobo.348.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">args</span></strong><span class="koboSpan" id="kobo.350.1"> parameter is used to pass arguments for the </span><span class="No-Break"><span class="koboSpan" id="kobo.351.1">format string</span></span></li>
<li><span class="koboSpan" id="kobo.352.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">exception</span></strong><span class="koboSpan" id="kobo.354.1"> parameter is used to pass the </span><span class="No-Break"><span class="koboSpan" id="kobo.355.1">exception object</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.356.1">For example, we can define an </span><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">EventIds</span></strong><span class="koboSpan" id="kobo.358.1"> class to identify log messages, </span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">like so:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.360.1">
 public class EventIds{
    public const int LoginEvent = 2000;
    public const int LogoutEvent = 2001;
    public const int FileUploadEvent = 2002;
    public const int FileDownloadEvent = 2003;
    public const int UserRegistrationEvent = 2004;
    public const int PasswordChangeEvent = 2005;
    // Omitted for brevity
}</span></pre>
<p><span class="koboSpan" id="kobo.361.1">Then, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">eventId</span></strong><span class="koboSpan" id="kobo.363.1"> parameter to identify </span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">log messages:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.365.1">
_logger.LogInformation(EventIds.LoginEvent, "This is a logging message with event id.");</span></pre> <p><span class="koboSpan" id="kobo.366.1">Some </span><a id="_idIndexMarker369"/><span class="koboSpan" id="kobo.367.1">logging providers can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">eventId</span></strong><span class="koboSpan" id="kobo.369.1"> parameter to filter </span><span class="No-Break"><span class="koboSpan" id="kobo.370.1">log messages.</span></span></p>
<p><span class="koboSpan" id="kobo.371.1">We have introduced how to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">message</span></strong><span class="koboSpan" id="kobo.373.1"> parameter. </span><span class="koboSpan" id="kobo.373.2">You can use a plain string as the message, or you can use a format string and use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">args</span></strong><span class="koboSpan" id="kobo.375.1"> parameter to pass arguments for the format string. </span><span class="koboSpan" id="kobo.375.2">Here is an example that uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">message</span></strong><span class="koboSpan" id="kobo.377.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">args</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.379.1"> parameters:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.380.1">
_logger.LogInformation("This is a logging message with args: Today is {Week}. </span><span class="koboSpan" id="kobo.380.2">It is {Time}.", DateTime.Now.DayOfWeek, DateTime.Now.ToLongTimeString());</span></pre> <p><span class="koboSpan" id="kobo.381.1">If an exception occurs, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.382.1">LogError()</span></strong><span class="koboSpan" id="kobo.383.1"> method with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.384.1">exception</span></strong><span class="koboSpan" id="kobo.385.1"> parameter to log </span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">the exception:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.387.1">
try{
    // Omitted for brevity
}
catch (Exception ex)
{
    _logger.LogError(ex, "This is a logging message with exception.");
}</span></pre>
<p><span class="koboSpan" id="kobo.388.1">When </span><a id="_idIndexMarker370"/><span class="koboSpan" id="kobo.389.1">using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">LogError()</span></strong><span class="koboSpan" id="kobo.391.1"> method to log an exception, it is important to pass the exception object to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">exception</span></strong><span class="koboSpan" id="kobo.393.1"> parameter. </span><span class="koboSpan" id="kobo.393.2">This is essential in order to preserve stack trace information; simply logging the exception message is </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">not suffic</span><a id="_idTextAnchor180"/><span class="koboSpan" id="kobo.395.1">ient.</span></span></p>
<h2 id="_idParaDest-93"><a id="_idTextAnchor181"/><span class="koboSpan" id="kobo.396.1">Using third-party logging providers</span></h2>
<p><span class="koboSpan" id="kobo.397.1">The </span><a id="_idIndexMarker371"/><span class="koboSpan" id="kobo.398.1">logging system in ASP.NET Core is designed </span><a id="_idIndexMarker372"/><span class="koboSpan" id="kobo.399.1">to be extensible. </span><span class="koboSpan" id="kobo.399.2">The default logging providers, including the console logging provider and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">Debug</span></strong><span class="koboSpan" id="kobo.401.1"> logging provider, can output logging messages in the console window or debug window, which is convenient for development. </span><span class="koboSpan" id="kobo.401.2">But in the production environment, we may want to send log messages to a file, a database, or a remote logging service. </span><span class="koboSpan" id="kobo.401.3">We can use third-party logging providers to </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">achieve this.</span></span></p>
<p><span class="koboSpan" id="kobo.403.1">There are many third-party logging frameworks or libraries that work with ASP.NET Core, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.404.1">the following:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table002-3">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<thead>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.405.1">Logging provider</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.406.1">Website</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.407.1">GitHub repo</span></strong></span></p>
</td>
</tr>
</thead>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">Serilog</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://serilog.net/"><span class="No-Break"><span class="koboSpan" id="kobo.409.1">https://serilog.net/</span></span></a></p>
</td>
<td class="No-Table-Style">
<p><a href="https://github.com/serilog/serilog-aspnetcore"><span class="No-Break"><span class="koboSpan" id="kobo.410.1">https://github.com/serilog/serilog-aspnetcore</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">NLog</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://nlog-project.org/"><span class="No-Break"><span class="koboSpan" id="kobo.412.1">https://nlog-project.org/</span></span></a></p>
</td>
<td class="No-Table-Style">
<p><a href="https://github.com/NLog/NLog.Extensions.Logging"><span class="No-Break"><span class="koboSpan" id="kobo.413.1">https://github.com/NLog/NLog.Extensions.Logging</span></span></a></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">log4net</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><a href="https://logging.apache.org/log4net/"><span class="No-Break"><span class="koboSpan" id="kobo.415.1">https://logging.apache.org/log4net/</span></span></a></p>
</td>
<td class="No-Table-Style">
<p><a href="https://github.com/huorswords/Microsoft.Extensions.Logging.Log4Net.AspNetCore"><span class="No-Break"><span class="koboSpan" id="kobo.416.1">https://github.com/huorswords/Microsoft.Extensions.Logging.Log4Net.AspNetCore</span></span></a></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.417.1">Table 4.2 – Third-party logging providers</span></p>
<p><span class="koboSpan" id="kobo.418.1">Some other</span><a id="_idIndexMarker373"/><span class="koboSpan" id="kobo.419.1"> platforms provide rich features for collecting and analyzing the log messages, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.420.1">the following:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.421.1">Exceptionless</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.422.1"> (</span></span><a href="https://exceptionless.com/"><span class="No-Break"><span class="koboSpan" id="kobo.423.1">https://exceptionless.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.424.1">)</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.425.1">ELK </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.426.1">Stack</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.427.1"> (</span></span><a href="https://www.elastic.co/elastic-stack/"><span class="No-Break"><span class="koboSpan" id="kobo.428.1">https://www.elastic.co/elastic-stack/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.429.1">)</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.430.1">Sumo </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.431.1">Logic</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.432.1"> (</span></span><a href="https://www.sumologic.com/"><span class="No-Break"><span class="koboSpan" id="kobo.433.1">https://www.sumologic.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.434.1">)</span></span></li>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.435.1">Seq</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.436.1"> (</span></span><a href="https://datalust.co/seq"><span class="No-Break"><span class="koboSpan" id="kobo.437.1">https://datalust.co/seq</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.438.1">)</span></span></li>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.439.1">Sentry</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.440.1"> (</span></span><a href="https://sentry.io"><span class="No-Break"><span class="koboSpan" id="kobo.441.1">https://sentry.io</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.442.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.443.1">These</span><a id="_idIndexMarker374"/><span class="koboSpan" id="kobo.444.1"> platforms can provide a dashboard to view log messages. </span><span class="koboSpan" id="kobo.444.2">Technically, they are not just logging providers but also platforms for observability that contain logging, tracing, metrics, and </span><span class="No-Break"><span class="koboSpan" id="kobo.445.1">so on.</span></span></p>
<p><span class="koboSpan" id="kobo.446.1">Let’s start with a simple example. </span><span class="koboSpan" id="kobo.446.2">How can we print logging messages to </span><span class="No-Break"><span class="koboSpan" id="kobo.447.1">a file?</span></span></p>
<p><span class="koboSpan" id="kobo.448.1">We can use </span><strong class="bold"><span class="koboSpan" id="kobo.449.1">Serilog</span></strong><span class="koboSpan" id="kobo.450.1"> to</span><a id="_idIndexMarker375"/><span class="koboSpan" id="kobo.451.1"> write the log messages to a file. </span><span class="koboSpan" id="kobo.451.2">Serilog is a popular logging framework that works with .NET. </span><span class="koboSpan" id="kobo.451.3">It provides a standard logging API and a rich set of sinks that write log events to storage in various formats. </span><span class="koboSpan" id="kobo.451.4">These sinks target a variety of destinations, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.452.1">the following:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.453.1">File</span></span></li>
<li><span class="koboSpan" id="kobo.454.1">Azure </span><span class="No-Break"><span class="koboSpan" id="kobo.455.1">Application Insights</span></span></li>
<li><span class="koboSpan" id="kobo.456.1">Azure </span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">Blob Storage</span></span></li>
<li><span class="koboSpan" id="kobo.458.1">Azure </span><span class="No-Break"><span class="koboSpan" id="kobo.459.1">Cosmos DB</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.460.1">Amazon CloudWatch</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.461.1">Amazon DynamoDB</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.462.1">Amazon Kinesis</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.463.1">Exceptionless</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.464.1">Elasticsearch</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.465.1">Sumo Logic</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.466.1">Email</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.467.1">PostgreSQL</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.468.1">RabbitMQ</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.469.1">Serilog </span><a id="_idIndexMarker376"/><span class="koboSpan" id="kobo.470.1">provides a </span><strong class="source-inline"><span class="koboSpan" id="kobo.471.1">Serilog.AspNetCore</span></strong><span class="koboSpan" id="kobo.472.1"> NuGet </span><a id="_idIndexMarker377"/><span class="koboSpan" id="kobo.473.1">package that integrates with ASP.NET Core. </span><span class="koboSpan" id="kobo.473.2">It has a set of extension methods to configure the logging system. </span><span class="koboSpan" id="kobo.473.3">To use it, install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">Serilog.AspNetCore</span></strong><span class="koboSpan" id="kobo.475.1"> NuGet package by running </span><span class="No-Break"><span class="koboSpan" id="kobo.476.1">this command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.477.1">
dotnet add package Serilog.AspNetCore</span></pre> <p><span class="koboSpan" id="kobo.478.1">Next, let’s use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">Serilog.Sinks.File</span></strong><span class="koboSpan" id="kobo.480.1"> sink to write log messages to a file. </span><span class="koboSpan" id="kobo.480.2">Install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">Serilog.Sinks.File</span></strong><span class="koboSpan" id="kobo.482.1"> NuGet package with </span><span class="No-Break"><span class="koboSpan" id="kobo.483.1">this command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.484.1">
dotnet add package Serilog.Sinks.File</span></pre> <p><span class="koboSpan" id="kobo.485.1">Then, update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">Program.cs</span></strong><span class="koboSpan" id="kobo.487.1"> file to configure the </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">logging system:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.489.1">
using Serilog;var builder = WebApplication.CreateBuilder(args);
builder.Logging.ClearProviders();
var logger = new LoggerConfiguration().WriteTo.File(Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "logs/log.txt"), rollingInterval: RollingInterval.Day, retainedFileCountLimit: 90).CreateLogger();
builder.Logging.AddSerilog(logger);</span></pre>
<p><span class="koboSpan" id="kobo.490.1">In the preceding code, we first clear the default logging providers. </span><span class="koboSpan" id="kobo.490.2">Then, we create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.491.1">Serilog.ILogger</span></strong><span class="koboSpan" id="kobo.492.1"> instance and add it to the logging system. </span><span class="koboSpan" id="kobo.492.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.493.1">WriteTo.File</span></strong><span class="koboSpan" id="kobo.494.1"> method is used to configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">Serilog.Sinks.File</span></strong><span class="koboSpan" id="kobo.496.1"> sink. </span><span class="koboSpan" id="kobo.496.2">It will write log messages to a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.497.1">log.txt</span></strong><span class="koboSpan" id="kobo.498.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.499.1">logs</span></strong><span class="koboSpan" id="kobo.500.1"> folder. </span><span class="koboSpan" id="kobo.500.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.501.1">rollingInterval</span></strong><span class="koboSpan" id="kobo.502.1"> parameter is used to specify the rolling interval. </span><span class="koboSpan" id="kobo.502.2">In the current example, we set it up as daily. </span><span class="koboSpan" id="kobo.502.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.503.1">retainedFileCountLimit</span></strong><span class="koboSpan" id="kobo.504.1"> parameter is used to specify the maximum number of log files to keep. </span><span class="koboSpan" id="kobo.504.2">In this case, we have kept the number of files to 90. </span><span class="koboSpan" id="kobo.504.3">Then, we call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.505.1">CreateLogger</span></strong><span class="koboSpan" id="kobo.506.1"> method to create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.507.1">Serilog.ILogger</span></strong><span class="koboSpan" id="kobo.508.1"> instance. </span><span class="koboSpan" id="kobo.508.2">Finally, we call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.509.1">AddSerilog()</span></strong><span class="koboSpan" id="kobo.510.1"> method to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.511.1">Serilog.ILogger</span></strong><span class="koboSpan" id="kobo.512.1"> instance to the </span><span class="No-Break"><span class="koboSpan" id="kobo.513.1">logging system.</span></span></p>
<p><span class="koboSpan" id="kobo.514.1">There’s no</span><a id="_idIndexMarker378"/><span class="koboSpan" id="kobo.515.1"> need to change the code that uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.516.1">ILogger</span></strong><span class="koboSpan" id="kobo.517.1"> service. </span><span class="koboSpan" id="kobo.517.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.518.1">ILogger</span></strong><span class="koboSpan" id="kobo.519.1"> service is still injected into the controller. </span><span class="koboSpan" id="kobo.519.2">The </span><a id="_idIndexMarker379"/><span class="koboSpan" id="kobo.520.1">only difference is that log messages will be written to a file instead of the </span><span class="No-Break"><span class="koboSpan" id="kobo.521.1">console window.</span></span></p>
<p><span class="koboSpan" id="kobo.522.1">Run the application again and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">/WeatherForecast</span></strong><span class="koboSpan" id="kobo.524.1"> endpoint. </span><span class="koboSpan" id="kobo.524.2">You should be able to see log messages in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">logs/log.txt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.526.1"> file.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.527.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.528.1">If you write logging messages to a file, please make sure that there is enough disk space and that proper retention policies are set. </span><span class="koboSpan" id="kobo.528.2">Otherwise, the disk space may get exhausted. </span><span class="koboSpan" id="kobo.528.3">Also, it is recommended to use some professional logging systems for monitoring in the production environment. </span><span class="koboSpan" id="kobo.528.4">For example, if your application is deployed in Azure, you can easily integrate it with Azure Application Insights. </span><span class="koboSpan" id="kobo.528.5">Storing logging messages in a text file is not easy to manage </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">and analyze.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.530.1">If the amount of logging messages is huge, consider sending them to a message queue, such as RabbitMQ, and then have a separate process to consume the messages and write them to a database. </span><span class="koboSpan" id="kobo.530.2">Keep in mind that the logging system should not be a bottleneck for the application. </span><span class="koboSpan" id="kobo.530.3">Do not use asynchronous methods for logging because logging should be fast, and frequently switching between threads may cause </span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">performance i</span><a id="_idTextAnchor182"/><span class="koboSpan" id="kobo.532.1">ssues.</span></span></p>
<p><span class="koboSpan" id="kobo.533.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.534.1">LoggingDemo</span></strong><span class="koboSpan" id="kobo.535.1"> project, we have already configured the logging system to write log messages to a file. </span><span class="koboSpan" id="kobo.535.2">You can check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.536.1">Program.cs</span></strong><span class="koboSpan" id="kobo.537.1"> file to see how it works. </span><span class="koboSpan" id="kobo.537.2">Serilog provides a rich set of sinks, and it supports various configurations as well. </span><span class="koboSpan" id="kobo.537.3">You can find more </span><a id="_idIndexMarker380"/><span class="koboSpan" id="kobo.538.1">provided sinks </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">here: </span></span><a href="https://github.com/serilog/serilog/wiki/Provided-Sinks"><span class="No-Break"><span class="koboSpan" id="kobo.540.1">https://github.com/serilog/serilog/wiki/Provided</span><span id="_idTextAnchor183"/><span class="koboSpan" id="kobo.541.1">-Sinks</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.542.1">.</span></span></p>
<h2 id="_idParaDest-94"><a id="_idTextAnchor184"/><span class="koboSpan" id="kobo.543.1">Structured logging</span></h2>
<p><span class="koboSpan" id="kobo.544.1">In the </span><em class="italic"><span class="koboSpan" id="kobo.545.1">Logging parameters</span></em><span class="koboSpan" id="kobo.546.1"> section, we showed how we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">args</span></strong><span class="koboSpan" id="kobo.548.1"> parameter to format</span><a id="_idIndexMarker381"/><span class="koboSpan" id="kobo.549.1"> a message string. </span><span class="koboSpan" id="kobo.549.2">You may wonder if we can use string concatenation to achieve the same outcome; for example, </span><span class="No-Break"><span class="koboSpan" id="kobo.550.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.551.1">
logger.LogInformation($"This is a logging message with string concatenation: Today is {DateTime.Now.DayOfWeek}. </span><span class="koboSpan" id="kobo.551.2">It is {DateTime.Now.ToLongTimeString()}.");</span></pre> <p><span class="koboSpan" id="kobo.552.1">The answer</span><a id="_idIndexMarker382"/><span class="koboSpan" id="kobo.553.1"> is yes and no. </span><span class="koboSpan" id="kobo.553.2">If you do not care about the values of the parameters, it does seem to work. </span><span class="koboSpan" id="kobo.553.3">However, a modern way to handle logs is to use </span><strong class="bold"><span class="koboSpan" id="kobo.554.1">structured logging</span></strong><span class="koboSpan" id="kobo.555.1"> instead of a plain string message. </span><span class="koboSpan" id="kobo.555.2">Structured logging is a way to log messages in a structured format. </span><span class="koboSpan" id="kobo.555.3">Parameters such as the day of the week are identified and structured so that a system can process them, which means we can perform special operations on them, such as filtering, searching, and so on. </span><span class="koboSpan" id="kobo.555.4">Let’s dive into </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">the details.</span></span></p>
<p><span class="koboSpan" id="kobo.557.1">Serilog efficiently supports structured logging when you use </span><strong class="source-inline"><span class="koboSpan" id="kobo.558.1">args</span></strong><span class="koboSpan" id="kobo.559.1"> parameters instead of string concatenation. </span><span class="koboSpan" id="kobo.559.2">Let’s update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.560.1">Program.cs</span></strong><span class="koboSpan" id="kobo.561.1"> file to send logs to the console window in a </span><span class="No-Break"><span class="koboSpan" id="kobo.562.1">structured format:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.563.1">
var logger = new LoggerConfiguration()    .WriteTo.File(Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "logs/log.txt"), rollingInterval: RollingInterval.Day, retainedFileCountLimit: 90)
    .WriteTo.Console(new JsonFormatter())
    .CreateLogger();
builder.Logging.AddSerilog(logger);</span></pre>
<p><span class="koboSpan" id="kobo.564.1">Serilog supports multiple sinks in the same logging pipeline. </span><span class="koboSpan" id="kobo.564.2">In the preceding code, we add the console sink after the file sink. </span><span class="koboSpan" id="kobo.564.3">The console sink is automatically installed with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">Serilog.AspNetCore</span></strong><span class="koboSpan" id="kobo.566.1"> NuGet package, so you do not need to manually install it. </span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">JsonFormatter</span></strong><span class="koboSpan" id="kobo.568.1"> is used to format log messages in JSON format. </span><span class="koboSpan" id="kobo.568.2">You can also specify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">formatter</span></strong><span class="koboSpan" id="kobo.570.1"> type for the </span><span class="No-Break"><span class="koboSpan" id="kobo.571.1">file sink.</span></span></p>
<p><span class="koboSpan" id="kobo.572.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">LoggingController</span></strong><span class="koboSpan" id="kobo.574.1"> file, add a new action method to compare the structured logs and string </span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">concatenation logs:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.576.1">
[HttpGet][Route("structured-logging")]
public ActionResult StructuredLoggingSample()
{
    logger.LogInformation("This is a logging message with args: Today is {Week}. </span><span class="koboSpan" id="kobo.576.2">It is {Time}.", DateTime.Now.DayOfWeek, DateTime.Now.ToLongTimeString());
    logger.LogInformation($"This is a logging message with string concatenation: Today is {DateTime.Now.DayOfWeek}. </span><span class="koboSpan" id="kobo.576.3">It is {DateTime.Now.ToLongTimeString()}.");
    return Ok("This is to test the difference between structured logging and string concatenation.");
}</span></pre>
<p><span class="koboSpan" id="kobo.577.1">Run</span><a id="_idIndexMarker383"/><span class="koboSpan" id="kobo.578.1"> the </span><a id="_idIndexMarker384"/><span class="koboSpan" id="kobo.579.1">application again and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.580.1">api/Logging/structured-logging</span></strong><span class="koboSpan" id="kobo.581.1"> endpoint. </span><span class="koboSpan" id="kobo.581.2">You should be able to see log messages in the console window in </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">JSON format.</span></span></p>
<p><span class="koboSpan" id="kobo.583.1">Log messages with structured logging look </span><span class="No-Break"><span class="koboSpan" id="kobo.584.1">like this:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.585.1">
{   "Timestamp":"2022-11-22T09:59:44.6590391+13:00",
   "Level":"Information",
   "MessageTemplate":"This is a logging message with args: Today is {Week}. </span><span class="koboSpan" id="kobo.585.2">It is {Time}.",
   "Properties":{
      "Week":"Tuesday",
      "Time":"9:59:44 AM",
      "SourceContext":"LoggingDemo.Controllers.LoggingController",
      "ActionId":"9fdba8d6-8997-4cba-a9e1-0cefe36cabd1",
      "ActionName":"LoggingDemo.Controllers.LoggingController.StructuredLoggingSample (LoggingDemo)",
      "RequestId":"0HMMC0D2M1GC4:00000001",
      "RequestPath":"/api/Logging/structured-logging",
      "ConnectionId":"0HMMC0D2M1GC4"
   }
}</span></pre>
<p><span class="koboSpan" id="kobo.586.1">Log</span><a id="_idIndexMarker385"/><span class="koboSpan" id="kobo.587.1"> messages </span><a id="_idIndexMarker386"/><span class="koboSpan" id="kobo.588.1">with string concatenation look </span><span class="No-Break"><span class="koboSpan" id="kobo.589.1">like this:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.590.1">
{   "Timestamp":"2022-11-22T09:59:44.6597035+13:00",
   "Level":"Information",
   "MessageTemplate":"This is a logging message with string concatenation: Today is Tuesday. </span><span class="koboSpan" id="kobo.590.2">It is 9:59:44 AM.",
   "Properties":{
      "SourceContext":"LoggingDemo.Controllers.LoggingController",
      "ActionId":"9fdba8d6-8997-4cba-a9e1-0cefe36cabd1",
      "ActionName":"LoggingDemo.Controllers.LoggingController.StructuredLoggingSample (LoggingDemo)",
      "RequestId":"0HMMC0D2M1GC4:00000001",
      "RequestPath":"/api/Logging/structured-logging",
      "ConnectionId":"0HMMC0D2M1GC4"
   }
}</span></pre>
<p><span class="koboSpan" id="kobo.591.1">Note that the structured logging has </span><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">Week</span></strong><span class="koboSpan" id="kobo.593.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">Time</span></strong><span class="koboSpan" id="kobo.595.1"> properties, while the string concatenation does not. </span><span class="koboSpan" id="kobo.595.2">Structured logging is more flexible and easier to process. </span><span class="koboSpan" id="kobo.595.3">Therefore, structured logging</span><a id="_idIndexMarker387"/><span class="koboSpan" id="kobo.596.1"> is recommended instead of </span><span class="No-Break"><span class="koboSpan" id="kobo.597.1">string concatenation.</span></span></p>
<p><span class="koboSpan" id="kobo.598.1">A great </span><a id="_idIndexMarker388"/><span class="koboSpan" id="kobo.599.1">tool to </span><a id="_idIndexMarker389"/><span class="koboSpan" id="kobo.600.1">analyze structured logging messages is Seq (</span><a href="https://datalust.co/seq"><span class="koboSpan" id="kobo.601.1">https://datalust.co/seq</span></a><span class="koboSpan" id="kobo.602.1">). </span><span class="koboSpan" id="kobo.602.2">Seq is </span><a id="_idIndexMarker390"/><span class="koboSpan" id="kobo.603.1">a powerful log management tool that creates the visibility you need to quickly identify and diagnose problems in your applications. </span><span class="koboSpan" id="kobo.603.2">It is a commercial product, but it provides a free trial. </span><span class="koboSpan" id="kobo.603.3">You can download it </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">here: </span></span><a href="https://datalust.co/download"><span class="No-Break"><span class="koboSpan" id="kobo.605.1">https://datalust.co/download</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.606.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.607.1">Install it on your local machine. </span><span class="koboSpan" id="kobo.607.2">When you see the following window, please take note of the </span><strong class="bold"><span class="koboSpan" id="kobo.608.1">Listen URI</span></strong><span class="koboSpan" id="kobo.609.1"> value. </span><span class="koboSpan" id="kobo.609.2">We will configure it for Serilog later. </span><span class="koboSpan" id="kobo.609.3">It uses the default </span><span class="No-Break"><span class="koboSpan" id="kobo.610.1">port </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.611.1">5341</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.612.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer035">
<span class="koboSpan" id="kobo.613.1"><img alt="Figure 4.4 – Installing Seq" src="image/B18971_04_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.614.1">Figure 4.4 – Installing Seq</span></p>
<p><span class="koboSpan" id="kobo.615.1">Next, we need to configure Serilog to send log messages to Seq. </span><span class="koboSpan" id="kobo.615.2">Serilog has a sink for Seq, so we</span><a id="_idIndexMarker391"/><span class="koboSpan" id="kobo.616.1"> can easily</span><a id="_idIndexMarker392"/><span class="koboSpan" id="kobo.617.1"> install it using the </span><span class="No-Break"><span class="koboSpan" id="kobo.618.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.619.1">
dotnet add package Serilog.Sinks.Seq</span></pre> <p><span class="koboSpan" id="kobo.620.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">Program.cs</span></strong><span class="koboSpan" id="kobo.622.1"> file, update the logging configuration to send log messages </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">to Seq:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.624.1">
var logger = new LoggerConfiguration()    .WriteTo.File(formatter: new JsonFormatter(), Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "logs/log.txt"), rollingInterval: RollingInterval.Day, retainedFileCountLimit: 90)
    .WriteTo.Console(new JsonFormatter())
    .WriteTo.Seq("http://localhost:5341")
    .CreateLogger();</span></pre>
<p><span class="koboSpan" id="kobo.625.1">Run the</span><a id="_idIndexMarker393"/><span class="koboSpan" id="kobo.626.1"> application again and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.627.1">api/Logging/structured-logging</span></strong><span class="koboSpan" id="kobo.628.1"> endpoint. </span><span class="koboSpan" id="kobo.628.2">You should be able to see log messages </span><span class="No-Break"><span class="koboSpan" id="kobo.629.1">in Seq:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer036">
<span class="koboSpan" id="kobo.630.1"><img alt="Figure 4.5 – Structured logging in Seq" src="image/B18971_04_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.631.1">Figure 4.5 – Structured logging in Seq</span></p>
<p><span class="koboSpan" id="kobo.632.1">We can search the </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">Week</span></strong><span class="koboSpan" id="kobo.634.1"> property to filter log messages, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.635.1">following figure:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer037">
<span class="koboSpan" id="kobo.636.1"><img alt="Figure 4.6 – Filtering structured logs in Seq" src="image/B18971_04_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.637.1">Figure 4.6 – Filtering structured logs in Seq</span></p>
<p><span class="koboSpan" id="kobo.638.1">Now, we</span><a id="_idIndexMarker394"/><span class="koboSpan" id="kobo.639.1"> understand</span><a id="_idIndexMarker395"/><span class="koboSpan" id="kobo.640.1"> why structured logging is more powerful than string concatenation when you send logs. </span><span class="koboSpan" id="kobo.640.2">Serilog provides many powerful features for logging, such as enrichers. </span><span class="koboSpan" id="kobo.640.3">You can find more information about Serilog on</span><a id="_idIndexMarker396"/><span class="koboSpan" id="kobo.641.1"> its official </span><span class="No-Break"><span class="koboSpan" id="kobo.642.1">website: </span></span><a href="https://serilog.net/"><span class="No-Break"><span class="koboSpan" id="kobo.643.1">https://serilog.net/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.644.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.645.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.646.1">Seq is a </span><a id="_idIndexMarker397"/><span class="koboSpan" id="kobo.647.1">good choice for local development. </span><span class="koboSpan" id="kobo.647.2">However, you may need to purchase a license for your critical applications and services for better support, or you may want to use another logging system. </span><span class="koboSpan" id="kobo.647.3">Please carefully consider your requirements before you choose a logging system. </span><span class="koboSpan" id="kobo.647.4">Don’t forget that we can use configurations to switch between different logging systems for </span><span class="No-Break"><span class="koboSpan" id="kobo.648.1">different environments.</span></span></p>
<h2 id="_idParaDest-95"><a id="_idTextAnchor185"/><span class="koboSpan" id="kobo.649.1">What should/shouldn’t we log?</span></h2>
<p><span class="koboSpan" id="kobo.650.1">Logging is a</span><a id="_idIndexMarker398"/><span class="koboSpan" id="kobo.651.1"> powerful tool to help us diagnose problems, monitor an application, audit a system, and so on. </span><span class="koboSpan" id="kobo.651.2">But logging is not free. </span><span class="koboSpan" id="kobo.651.3">It consumes resources and may slow down applications. </span><span class="koboSpan" id="kobo.651.4">Depending on the purpose of logging, we may need to log different information. </span><span class="koboSpan" id="kobo.651.5">Generally, there are some scenarios that we </span><span class="No-Break"><span class="koboSpan" id="kobo.652.1">should log:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.653.1">Input/output validation errors, such as invalid input parameters or invalid </span><span class="No-Break"><span class="koboSpan" id="kobo.654.1">response data</span></span></li>
<li><span class="koboSpan" id="kobo.655.1">Authentication and </span><span class="No-Break"><span class="koboSpan" id="kobo.656.1">authorization failures</span></span></li>
<li><span class="koboSpan" id="kobo.657.1">Application errors, exceptions, and warnings, such as database connection errors, network errors, and </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">so on</span></span></li>
<li><span class="koboSpan" id="kobo.659.1">Application startup </span><span class="No-Break"><span class="koboSpan" id="kobo.660.1">and shutdown</span></span></li>
<li><span class="koboSpan" id="kobo.661.1">High-risk operations, such as deleting a record from the database, changing a user’s password, transferring money, and </span><span class="No-Break"><span class="koboSpan" id="kobo.662.1">so on</span></span></li>
<li><span class="koboSpan" id="kobo.663.1">Legal compliance, such as auditing, terms of service, personal data consent, and </span><span class="No-Break"><span class="koboSpan" id="kobo.664.1">so on</span></span></li>
<li><span class="koboSpan" id="kobo.665.1">Critical business events, such as a new order being placed, a new user being registered, and </span><span class="No-Break"><span class="koboSpan" id="kobo.666.1">so on</span></span></li>
<li><span class="koboSpan" id="kobo.667.1">Any suspicious activities, such as brute-force attacks, account lockouts, and </span><span class="No-Break"><span class="koboSpan" id="kobo.668.1">so on</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.669.1">What information</span><a id="_idIndexMarker399"/><span class="koboSpan" id="kobo.670.1"> should we log? </span><span class="koboSpan" id="kobo.670.2">If the information in the log message is not sufficient to diagnose the problem, it would be useless. </span><span class="koboSpan" id="kobo.670.3">Generally, we should log the </span><span class="No-Break"><span class="koboSpan" id="kobo.671.1">following information:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.672.1">When</span></strong><span class="koboSpan" id="kobo.673.1">: What time did the </span><span class="No-Break"><span class="koboSpan" id="kobo.674.1">event happen?</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.675.1">Where</span></strong><span class="koboSpan" id="kobo.676.1">: What is the application name and version? </span><span class="koboSpan" id="kobo.676.2">What is the hostname or IP address? </span><span class="koboSpan" id="kobo.676.3">What is the module or </span><span class="No-Break"><span class="koboSpan" id="kobo.677.1">component name?</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.678.1">Who</span></strong><span class="koboSpan" id="kobo.679.1">: Which user or client is involved in the event? </span><span class="koboSpan" id="kobo.679.2">What is the username, request ID, or </span><span class="No-Break"><span class="koboSpan" id="kobo.680.1">client ID?</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.681.1">What</span></strong><span class="koboSpan" id="kobo.682.1">: What is the event? </span><span class="koboSpan" id="kobo.682.2">What severity level does the event have? </span><span class="koboSpan" id="kobo.682.3">What is the error message or stack trace? </span><span class="koboSpan" id="kobo.682.4">Any other </span><span class="No-Break"><span class="koboSpan" id="kobo.683.1">descriptive information?</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.684.1">We may need to include more information based on the requirements. </span><span class="koboSpan" id="kobo.684.2">For example, for web API applications, we also need to log the request path, HTTP method, headers, status code, and so on. </span><span class="koboSpan" id="kobo.684.3">For database applications, we may need to log the SQL statement, parameters, and </span><span class="No-Break"><span class="koboSpan" id="kobo.685.1">so on.</span></span></p>
<p><span class="koboSpan" id="kobo.686.1">There is some information that we should </span><span class="No-Break"><span class="koboSpan" id="kobo.687.1">not log:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.688.1">Application </span><span class="No-Break"><span class="koboSpan" id="kobo.689.1">source code</span></span></li>
<li><span class="koboSpan" id="kobo.690.1">Sensitive application information, such as application secrets, passwords, encryption keys, database connection strings, and </span><span class="No-Break"><span class="koboSpan" id="kobo.691.1">so on</span></span></li>
<li><span class="koboSpan" id="kobo.692.1">Sensitive </span><a id="_idIndexMarker400"/><span class="koboSpan" id="kobo.693.1">user information, such as </span><strong class="bold"><span class="koboSpan" id="kobo.694.1">personally identifiable information</span></strong><span class="koboSpan" id="kobo.695.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.696.1">PII</span></strong><span class="koboSpan" id="kobo.697.1">); for </span><a id="_idIndexMarker401"/><span class="koboSpan" id="kobo.698.1">example, health status, government identification, and </span><span class="No-Break"><span class="koboSpan" id="kobo.699.1">so on</span></span></li>
<li><span class="koboSpan" id="kobo.700.1">Bank account information, credit card information, and </span><span class="No-Break"><span class="koboSpan" id="kobo.701.1">so on</span></span></li>
<li><span class="koboSpan" id="kobo.702.1">Information that users do not consent </span><span class="No-Break"><span class="koboSpan" id="kobo.703.1">to share</span></span></li>
<li><span class="koboSpan" id="kobo.704.1">Any other information that may violate the law </span><span class="No-Break"><span class="koboSpan" id="kobo.705.1">or regulations</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.706.1">We have explained the basics of logging in ASP.NET Core. </span><span class="koboSpan" id="kobo.706.2">Next, we will learn another important component of ASP.NET </span><span class="No-Break"><span class="koboSpan" id="kobo.707.1">Core: middleware.</span></span></p>
<h1 id="_idParaDest-96"><a id="_idTextAnchor186"/><span class="koboSpan" id="kobo.708.1">Middleware</span></h1>
<p><span class="koboSpan" id="kobo.709.1">In this section, we </span><a id="_idIndexMarker402"/><span class="koboSpan" id="kobo.710.1">will introduce middleware, which is one of the most important improvements in </span><span class="No-Break"><span class="koboSpan" id="kobo.711.1">ASP.NET Core.</span></span></p>
<p><span class="koboSpan" id="kobo.712.1">To follow this section, you can run the following command to create a new ASP.NET Core web </span><span class="No-Break"><span class="koboSpan" id="kobo.713.1">API project:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.714.1">
dotnet new webapi -n MiddlewareDemo -controllers</span></pre> <p><span class="koboSpan" id="kobo.715.1">You can download the example project named </span><strong class="source-inline"><span class="koboSpan" id="kobo.716.1">MiddlewareDemo</span></strong><span class="koboSpan" id="kobo.717.1"> from the ch</span><a id="_idTextAnchor187"/><span class="koboSpan" id="kobo.718.1">apter’s </span><span class="No-Break"><span class="koboSpan" id="kobo.719.1">GitHub repository.</span></span></p>
<h2 id="_idParaDest-97"><a id="_idTextAnchor188"/><span class="koboSpan" id="kobo.720.1">What is middleware?</span></h2>
<p><span class="koboSpan" id="kobo.721.1">ASP.NET Core is a middleware-based framework. </span><span class="koboSpan" id="kobo.721.2">An ASP.NET Core application is built upon a set of middleware components. </span><span class="koboSpan" id="kobo.721.3">Middleware is a software component that is responsible for handling requests and responses. </span><span class="koboSpan" id="kobo.721.4">Multiple middleware components form a pipeline to process requests and generate responses. </span><span class="koboSpan" id="kobo.721.5">In this pipeline, each middleware component can perform a specific task, such as authentication, authorization, logging, and so on. </span><span class="koboSpan" id="kobo.721.6">Then, it passes the request to the next middleware component in the pipeline. </span><span class="koboSpan" id="kobo.721.7">It is a huge improvement over the traditional ASP.NET framework, which is based on the HTTP module and HTTP handler. </span><span class="koboSpan" id="kobo.721.8">In this way, the ASP.NET Core framework is more flexible and extensible. </span><span class="koboSpan" id="kobo.721.9">You can add or remove middleware components as needed. </span><span class="koboSpan" id="kobo.721.10">You can also write your own </span><span class="No-Break"><span class="koboSpan" id="kobo.722.1">middleware components.</span></span></p>
<p><span class="koboSpan" id="kobo.723.1">The following diagram shows a</span><a id="_idIndexMarker403"/> <span class="No-Break"><span class="koboSpan" id="kobo.724.1">middleware pipeline:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer038">
<span class="koboSpan" id="kobo.725.1"><img alt="Figure 4.7 – Middleware pipeline" src="image/B18971_04_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.726.1">Figure 4.7 – Middleware pipeline</span></p>
<p><span class="koboSpan" id="kobo.727.1">A middleware component can perform tasks before and after the next middleware component in the pipeline. </span><span class="koboSpan" id="kobo.727.2">It can also choose whether to pass the request to the next middleware component or stop processing the request and gen</span><a id="_idTextAnchor189"/><span class="koboSpan" id="kobo.728.1">erate a </span><span class="No-Break"><span class="koboSpan" id="kobo.729.1">response directly.</span></span></p>
<h3><span class="koboSpan" id="kobo.730.1">Creating simple middleware</span></h3>
<p><span class="koboSpan" id="kobo.731.1">Let's </span><a id="_idIndexMarker404"/><span class="koboSpan" id="kobo.732.1">see an example. </span><span class="koboSpan" id="kobo.732.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.733.1">MiddlewareDemo</span></strong><span class="koboSpan" id="kobo.734.1"> project in VS Code. </span><span class="koboSpan" id="kobo.734.2">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.735.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.736.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.737.1">
var app = builder.Build();app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello world!");
});</span></pre>
<p class="callout-heading"><span class="koboSpan" id="kobo.738.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.739.1">In the preceding code, </span><strong class="source-inline"><span class="koboSpan" id="kobo.740.1">builder.Build()</span></strong><span class="koboSpan" id="kobo.741.1"> returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.742.1">WebApplication</span></strong><span class="koboSpan" id="kobo.743.1"> instance. </span><span class="koboSpan" id="kobo.743.2">It is the host for the web API project, which is responsible for app startup and lifetime management. </span><span class="koboSpan" id="kobo.743.3">It also manages logging, DI, configuration, middleware, and </span><span class="No-Break"><span class="koboSpan" id="kobo.744.1">so on.</span></span></p>
<p><span class="koboSpan" id="kobo.745.1">Run the </span><a id="_idIndexMarker405"/><span class="koboSpan" id="kobo.746.1">application with </span><strong class="source-inline"><span class="koboSpan" id="kobo.747.1">dotnet run</span></strong><span class="koboSpan" id="kobo.748.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">dotnet watch</span></strong><span class="koboSpan" id="kobo.750.1">, and you will see all requests will return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.751.1">Hello world!</span></strong><span class="koboSpan" id="kobo.752.1"> response, regardless of the URL. </span><span class="koboSpan" id="kobo.752.2">This is because the </span><strong class="source-inline"><span class="koboSpan" id="kobo.753.1">app.Run()</span></strong><span class="koboSpan" id="kobo.754.1"> method handles all requests. </span><span class="koboSpan" id="kobo.754.2">In this case, the middleware short-circuits the pipeline and returns the response directly. </span><span class="koboSpan" id="kobo.754.3">We can also call it </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.755.1">terminal middleware</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.756.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.757.1">To use multiple middleware components, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">app.Use()</span></strong><span class="koboSpan" id="kobo.759.1"> method. </span><span class="koboSpan" id="kobo.759.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">app.Use()</span></strong><span class="koboSpan" id="kobo.761.1"> method adds a middleware component to the pipeline. </span><span class="koboSpan" id="kobo.761.2">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">Program.cs</span></strong><span class="koboSpan" id="kobo.763.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.764.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.765.1">
var app = builder.Build();app.Use(async (context, next) =&gt;
{
    var logger = app.Services.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;();
    logger.LogInformation($"Request Host: {context.Request.Host}");
    logger.LogInformation("My Middleware - Before");
    await next(context);
    logger.LogInformation("My Middleware - After");
    logger.LogInformation($"Response StatusCode: {context.Response.StatusCode}");
});</span></pre>
<p><span class="koboSpan" id="kobo.766.1">Run the application and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.767.1">/weatherforecast</span></strong><span class="koboSpan" id="kobo.768.1"> endpoint. </span><span class="koboSpan" id="kobo.768.2">You can see the following output in </span><span class="No-Break"><span class="koboSpan" id="kobo.769.1">the console:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.770.1">
info: Program[0]      Request Host: localhost:5170
info: Program[0]
      My Middleware - Before
info: Program[0]
      My Middleware - After
info: Program[0]
      Response StatusCode: 200</span></pre>
<p><span class="koboSpan" id="kobo.771.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.772.1">WebApplication</span></strong><span class="koboSpan" id="kobo.773.1"> instance uses an </span><strong class="source-inline"><span class="koboSpan" id="kobo.774.1">app.Use()</span></strong><span class="koboSpan" id="kobo.775.1"> method to add a simple middleware </span><a id="_idIndexMarker406"/><span class="koboSpan" id="kobo.776.1">component to the pipeline. </span><span class="koboSpan" id="kobo.776.2">The middleware component is an anonymous function that takes two parameters: </span><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">context</span></strong><span class="koboSpan" id="kobo.778.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.779.1">next</span></strong><span class="koboSpan" id="kobo.780.1">. </span><span class="koboSpan" id="kobo.780.2">Let’s take a closer look </span><span class="No-Break"><span class="koboSpan" id="kobo.781.1">at these:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.782.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">context</span></strong><span class="koboSpan" id="kobo.784.1"> parameter is an instance of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.785.1">HttpContext</span></strong><span class="koboSpan" id="kobo.786.1"> class that contains request and </span><span class="No-Break"><span class="koboSpan" id="kobo.787.1">response information</span></span></li>
<li><span class="koboSpan" id="kobo.788.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.789.1">next</span></strong><span class="koboSpan" id="kobo.790.1"> parameter is a delegate that is used to pass the request to the next middleware component in </span><span class="No-Break"><span class="koboSpan" id="kobo.791.1">the pipeline</span></span></li>
<li><span class="koboSpan" id="kobo.792.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.793.1">await next()</span></strong><span class="koboSpan" id="kobo.794.1"> statement passes the request to the next middleware component in </span><span class="No-Break"><span class="koboSpan" id="kobo.795.1">the pipeline</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.796.1">This middleware does not do anything with the request and response. </span><span class="koboSpan" id="kobo.796.2">It only outputs some information to the console. </span><span class="koboSpan" id="kobo.796.3">Let us add another middleware component to the pipeline. </span><span class="koboSpan" id="kobo.796.4">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.797.1">Program.cs</span></strong><span class="koboSpan" id="kobo.798.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.799.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.800.1">
var app = builder.Build();app.Use(async (context, next) =&gt;
{
    var logger = app.Services.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;();
    logger.LogInformation($"ClientName HttpHeader in Middleware 1: {context.Request.Headers["ClientName"]}");
    logger.LogInformation($"Add a ClientName HttpHeader in Middleware 1");
    context.Request.Headers.TryAdd("ClientName", "Windows");
    logger.LogInformation("My Middleware 1 - Before");
    await next(context);
    logger.LogInformation("My Middleware 1 - After");
    logger.LogInformation($"Response StatusCode in Middleware 1: {context.Response.StatusCode}");
});
app.Use(async (context, next) =&gt;
{
    var logger = app.Services.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;();
    logger.LogInformation($"ClientName HttpHeader in Middleware 2: {context.Request.Headers["ClientName"]}");
    logger.LogInformation("My Middleware 2 - Before");
    context.Response.StatusCode = StatusCodes.Status202Accepted;
    await next(context);
    logger.LogInformation("My Middleware 2 - After");
    logger.LogInformation($"Response StatusCode in Middleware 2: {context.Response.StatusCode}");
});</span></pre>
<p><span class="koboSpan" id="kobo.801.1">In this example, we add two middleware components to the pipeline. </span><span class="koboSpan" id="kobo.801.2">The first middleware</span><a id="_idIndexMarker407"/><span class="koboSpan" id="kobo.802.1"> component adds a </span><strong class="source-inline"><span class="koboSpan" id="kobo.803.1">ClientName</span></strong><span class="koboSpan" id="kobo.804.1"> HTTP header to the request. </span><span class="koboSpan" id="kobo.804.2">The second middleware component sets the response status code to </span><strong class="source-inline"><span class="koboSpan" id="kobo.805.1">202 Accepted</span></strong><span class="koboSpan" id="kobo.806.1">. </span><span class="koboSpan" id="kobo.806.2">Run the application and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.807.1">/weatherforecast</span></strong><span class="koboSpan" id="kobo.808.1"> URL. </span><span class="koboSpan" id="kobo.808.2">You will see the following output in </span><span class="No-Break"><span class="koboSpan" id="kobo.809.1">the console:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.810.1">
info: Program[0]      ClientName HttpHeader in Middleware 1:
info: Program[0]
      Add a ClientName HttpHeader in Middleware 1
info: Program[0]
      My Middleware 1 - Before
info: Program[0]
      ClientName HttpHeader in Middleware 2: Windows
info: Program[0]
      My Middleware 2 - Before
info: Program[0]
      My Middleware 2 - After
info: Program[0]
      Response StatusCode in Middleware 2: 202
info: Program[0]
      My Middleware 1 - After
info: Program[0]
      Response StatusCode in Middleware 1: 202</span></pre>
<p><span class="koboSpan" id="kobo.811.1">Note the </span><span class="No-Break"><span class="koboSpan" id="kobo.812.1">following points:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.813.1">The original request does not contain the </span><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">ClientName</span></strong><span class="koboSpan" id="kobo.815.1"> HTTP header. </span><span class="koboSpan" id="kobo.815.2">So, the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.816.1">ClientName</span></strong><span class="koboSpan" id="kobo.817.1"> HTTP header in </span><strong class="source-inline"><span class="koboSpan" id="kobo.818.1">Middleware 1</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.819.1">is empty.</span></span></li>
<li><span class="koboSpan" id="kobo.820.1">Before </span><strong class="source-inline"><span class="koboSpan" id="kobo.821.1">Middleware 1</span></strong><span class="koboSpan" id="kobo.822.1"> passes the request to </span><strong class="source-inline"><span class="koboSpan" id="kobo.823.1">Middleware 2</span></strong><span class="koboSpan" id="kobo.824.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.825.1">Middleware 1</span></strong><span class="koboSpan" id="kobo.826.1"> adds the </span><strong class="source-inline"><span class="koboSpan" id="kobo.827.1">ClientName</span></strong><span class="koboSpan" id="kobo.828.1"> HTTP header to </span><span class="No-Break"><span class="koboSpan" id="kobo.829.1">the request.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.830.1">Middleware 1</span></strong><span class="koboSpan" id="kobo.831.1"> does not output </span><strong class="source-inline"><span class="koboSpan" id="kobo.832.1">My Middleware 1 - After</span></strong><span class="koboSpan" id="kobo.833.1"> to the console after its </span><strong class="source-inline"><span class="koboSpan" id="kobo.834.1">await next(context);</span></strong><span class="koboSpan" id="kobo.835.1"> code. </span><span class="koboSpan" id="kobo.835.2">Instead, </span><strong class="source-inline"><span class="koboSpan" id="kobo.836.1">Middleware 2</span></strong><span class="koboSpan" id="kobo.837.1"> outputs the </span><strong class="source-inline"><span class="koboSpan" id="kobo.838.1">ClientName</span></strong><span class="koboSpan" id="kobo.839.1"> HTTP header value to </span><span class="No-Break"><span class="koboSpan" id="kobo.840.1">the console.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.841.1">Middleware 2</span></strong><span class="koboSpan" id="kobo.842.1"> changes the response status code to </span><strong class="source-inline"><span class="koboSpan" id="kobo.843.1">202 Accepted</span></strong><span class="koboSpan" id="kobo.844.1">. </span><span class="koboSpan" id="kobo.844.2">The response will be passed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.845.1">Middleware 1</span></strong><span class="koboSpan" id="kobo.846.1">. </span><span class="koboSpan" id="kobo.846.2">Then, </span><strong class="source-inline"><span class="koboSpan" id="kobo.847.1">Middleware 1</span></strong><span class="koboSpan" id="kobo.848.1"> outputs </span><strong class="source-inline"><span class="koboSpan" id="kobo.849.1">My Middleware 1 - After</span></strong><span class="koboSpan" id="kobo.850.1"> with the new response </span><span class="No-Break"><span class="koboSpan" id="kobo.851.1">status code.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.852.1">That indicates</span><a id="_idIndexMarker408"/><span class="koboSpan" id="kobo.853.1"> how middleware c</span><a id="_idTextAnchor190"/><span class="koboSpan" id="kobo.854.1">omponents work in </span><span class="No-Break"><span class="koboSpan" id="kobo.855.1">the pipeline.</span></span></p>
<h3><span class="koboSpan" id="kobo.856.1">How to assemble middleware components</span></h3>
<p><span class="koboSpan" id="kobo.857.1">Besides</span><a id="_idIndexMarker409"/><span class="koboSpan" id="kobo.858.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.859.1">app.Use()</span></strong><span class="koboSpan" id="kobo.860.1"> method, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.861.1">WebApplication</span></strong><span class="koboSpan" id="kobo.862.1"> class also provides </span><strong class="source-inline"><span class="koboSpan" id="kobo.863.1">Map()</span></strong><span class="koboSpan" id="kobo.864.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.865.1">MapWhen()</span></strong><span class="koboSpan" id="kobo.866.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.867.1">UseWhen()</span></strong><span class="koboSpan" id="kobo.868.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.869.1">Run()</span></strong><span class="koboSpan" id="kobo.870.1"> methods to add middleware components to a pipeline. </span><span class="koboSpan" id="kobo.870.2">The following table shows the differences between </span><span class="No-Break"><span class="koboSpan" id="kobo.871.1">these methods:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table003-3">
<colgroup>
<col/>
<col/>
</colgroup>
<thead>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.872.1">Method</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.873.1">Description</span></strong></span></p>
</td>
</tr>
</thead>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.874.1">app.Map()</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.875.1">Maps a request path to a sub-request pipeline. </span><span class="koboSpan" id="kobo.875.2">The middleware component is only executed when the request path matches the </span><span class="No-Break"><span class="koboSpan" id="kobo.876.1">specified path.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.877.1">app.MapWhen()</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.878.1">Runs a sub-request pipeline when a given predicate </span><span class="No-Break"><span class="koboSpan" id="kobo.879.1">is matched.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.880.1">app.Use()</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.881.1">Adds an inline delegate to the application’s </span><span class="No-Break"><span class="koboSpan" id="kobo.882.1">request pipeline.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.883.1">app.UseWhen()</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.884.1">Adds an inline delegate to the application’s request pipeline when a given predicate is matched. </span><span class="koboSpan" id="kobo.884.2">It is rejoined to the main pipeline if it does not short-circuit or contain </span><span class="No-Break"><span class="koboSpan" id="kobo.885.1">terminal middleware.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.886.1">app.Run()</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.887.1">Adds a terminal middleware component to the pipeline. </span><span class="koboSpan" id="kobo.887.2">It prevents further middleware components from </span><span class="No-Break"><span class="koboSpan" id="kobo.888.1">processing requests.</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.889.1">Table 4.3 –  The differences between the app.Map(), app.MapWhen(), app.Use(), app.UseWhen(), and app.Run() methods</span></p>
<p><span class="koboSpan" id="kobo.890.1">To handle a</span><a id="_idIndexMarker410"/><span class="koboSpan" id="kobo.891.1"> request, we use </span><strong class="source-inline"><span class="koboSpan" id="kobo.892.1">app.Map()</span></strong><span class="koboSpan" id="kobo.893.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.894.1">app.MapWhen()</span></strong><span class="koboSpan" id="kobo.895.1"> to configure which request path (or predicate) should be handled by which middleware component. </span><span class="koboSpan" id="kobo.895.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.896.1">app.Use()</span></strong><span class="koboSpan" id="kobo.897.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.898.1">app.Run()</span></strong><span class="koboSpan" id="kobo.899.1"> methods are used to add middleware components to the pipeline. </span><span class="koboSpan" id="kobo.899.2">One pipeline can have multiple </span><strong class="source-inline"><span class="koboSpan" id="kobo.900.1">app.Use()</span></strong><span class="koboSpan" id="kobo.901.1"> methods. </span><span class="koboSpan" id="kobo.901.2">But only one </span><strong class="source-inline"><span class="koboSpan" id="kobo.902.1">app.Run()</span></strong><span class="koboSpan" id="kobo.903.1"> method is allowed in one pipeline, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.904.1">app.Run()</span></strong><span class="koboSpan" id="kobo.905.1"> method must be the last method in the pipeline. </span><span class="koboSpan" id="kobo.905.2">The following diagram illustrates </span><span class="No-Break"><span class="koboSpan" id="kobo.906.1">the process:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer039">
<span class="koboSpan" id="kobo.907.1"><img alt="Figure 4.8 – The relationship between the app.Map(), app.Use(), and app.Run() methods" src="image/B18971_04_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.908.1">Figure 4.8 – The relationship between the app.Map(), app.Use(), and app.Run() methods</span></p>
<p><span class="koboSpan" id="kobo.909.1">Let’s see an example. </span><span class="koboSpan" id="kobo.909.2">We will develop a lottery application that allows users to call an API to check </span><a id="_idIndexMarker411"/><span class="koboSpan" id="kobo.910.1">whether they get the lucky number. </span><span class="koboSpan" id="kobo.910.2">Lucky numbers are generated randomly. </span><span class="koboSpan" id="kobo.910.3">We will add a couple of middleware components to </span><span class="No-Break"><span class="koboSpan" id="kobo.911.1">the pipeline.</span></span></p>
<p><span class="koboSpan" id="kobo.912.1">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">Program.cs</span></strong><span class="koboSpan" id="kobo.914.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.915.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.916.1">
app.Map("/lottery", app =&gt;{
    var random = new Random();
    var luckyNumber = random.Next(1, 6);
    app.UseWhen(context =&gt; context.Request.QueryString.Value == $"?{luckyNumber.ToString()}", app =&gt;
    {
        app.Run(async context =&gt;
        {
            await context.Response.WriteAsync($"You win! </span><span class="koboSpan" id="kobo.916.2">You got the lucky number {luckyNumber}!");
        });
    });
    app.UseWhen(context =&gt; string.IsNullOrWhiteSpace(context.Request.QueryString.Value), app =&gt;
    {
        app.Use(async (context, next) =&gt;
        {
            var number = random.Next(1, 6);
            context.Request.Headers.TryAdd("number", number.ToString());
            await next(context);
        });
        app.UseWhen(context =&gt; context.Request.Headers["number"] == luckyNumber.ToString(), app =&gt;
        {
            app.Run(async context =&gt;
            {
                await context.Response.WriteAsync($"You win! </span><span class="koboSpan" id="kobo.916.3">You got the lucky number {luckyNumber}!");
            });
        });
    });
    app.Run(async context =&gt;
    {
        var number = "";
        if (context.Request.QueryString.HasValue)
        {
            number = context.Request.QueryString.Value?.Replace("?", "");
        }
        else
        {
            number = context.Request.Headers["number"];
        }
        await context.Response.WriteAsync($"Your number is {number}. </span><span class="koboSpan" id="kobo.916.4">Try again!");
    });
});
app.Run(async context =&gt;
{
    await context.Response.WriteAsync($"Use the /lottery URL to play. </span><span class="koboSpan" id="kobo.916.5">You can choose your number with the format /lottery?1.");
});</span></pre>
<p><span class="koboSpan" id="kobo.917.1">This is a fun lottery program. </span><span class="koboSpan" id="kobo.917.2">Let’s see how it </span><span class="No-Break"><span class="koboSpan" id="kobo.918.1">is configured:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.919.1">First, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.920.1">app.Map()</span></strong><span class="koboSpan" id="kobo.921.1"> method to map the </span><strong class="source-inline"><span class="koboSpan" id="kobo.922.1">/lottery</span></strong><span class="koboSpan" id="kobo.923.1"> request path to a sub-request pipeline. </span><span class="koboSpan" id="kobo.923.2">In this part, there are a couple of things </span><span class="No-Break"><span class="koboSpan" id="kobo.924.1">to do:</span></span><ol><li class="upper-roman"><span class="koboSpan" id="kobo.925.1">We use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.926.1">Random</span></strong><span class="koboSpan" id="kobo.927.1"> instance to generate a lucky number. </span><span class="koboSpan" id="kobo.927.2">Note that this number is generated only once when the </span><span class="No-Break"><span class="koboSpan" id="kobo.928.1">application starts.</span></span></li><li class="upper-roman"><span class="koboSpan" id="kobo.929.1">Next, we add a middleware component to the pipeline using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.930.1">app.UseWhen()</span></strong><span class="koboSpan" id="kobo.931.1"> method. </span><span class="koboSpan" id="kobo.931.2">This middleware works only when the request has a query string. </span><span class="koboSpan" id="kobo.931.3">If the query string is the same as the lucky number, it uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.932.1">app.Run()</span></strong><span class="koboSpan" id="kobo.933.1"> to write the response. </span><span class="koboSpan" id="kobo.933.2">This branch </span><span class="No-Break"><span class="koboSpan" id="kobo.934.1">is done.</span></span></li><li class="upper-roman"><span class="koboSpan" id="kobo.935.1">Next, we </span><a id="_idIndexMarker412"/><span class="koboSpan" id="kobo.936.1">add another middleware component when the request does not have a query string. </span><span class="koboSpan" id="kobo.936.2">This middleware consists of two </span><span class="No-Break"><span class="koboSpan" id="kobo.937.1">sub-middleware components:</span></span><ul><li><span class="koboSpan" id="kobo.938.1">The first one generates a random number and adds it to the HTTP header, then passes it to the </span><span class="No-Break"><span class="koboSpan" id="kobo.939.1">second sub-middleware.</span></span></li><li><span class="koboSpan" id="kobo.940.1">The second one uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.941.1">app.UseWhen()</span></strong><span class="koboSpan" id="kobo.942.1"> to check the HTTP headers of the request. </span><span class="koboSpan" id="kobo.942.2">If the HTTP header contains the lucky number, it uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.943.1">app.Run()</span></strong><span class="koboSpan" id="kobo.944.1"> to write the response. </span><span class="koboSpan" id="kobo.944.2">This branch is done. </span><span class="koboSpan" id="kobo.944.3">This part shows how we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.945.1">app.UseWhen()</span></strong><span class="koboSpan" id="kobo.946.1"> method to rejoin a middleware component to the </span><span class="No-Break"><span class="koboSpan" id="kobo.947.1">main pipeline.</span></span></li></ul></li><li class="upper-roman"><span class="koboSpan" id="kobo.948.1">Next, we add a middleware component to the pipeline using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.949.1">app.Run()</span></strong><span class="koboSpan" id="kobo.950.1"> method. </span><span class="koboSpan" id="kobo.950.2">This middleware component is used to handle all other requests for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.951.1">/lottery</span></strong><span class="koboSpan" id="kobo.952.1"> URL. </span><span class="koboSpan" id="kobo.952.2">It writes the response to the client and shows the number that the client has chosen. </span><span class="koboSpan" id="kobo.952.3">Note that if the user already got the lucky number, this part will not </span><span class="No-Break"><span class="koboSpan" id="kobo.953.1">be executed.</span></span></li></ol></li>
<li><span class="koboSpan" id="kobo.954.1">At the end of the program, we have another middleware component using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.955.1">app.Run()</span></strong><span class="koboSpan" id="kobo.956.1"> method. </span><span class="koboSpan" id="kobo.956.2">This middleware component is used to handle all other requests. </span><span class="koboSpan" id="kobo.956.3">It shows how to play </span><span class="No-Break"><span class="koboSpan" id="kobo.957.1">the game.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.958.1">Run the application and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.959.1">/lottery</span></strong><span class="koboSpan" id="kobo.960.1"> endpoint a couple of times. </span><span class="koboSpan" id="kobo.960.2">Sometimes, you will see you win the lottery. </span><span class="koboSpan" id="kobo.960.3">Or, you can include a query string in the URL, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.961.1">/lottery?1</span></strong><span class="koboSpan" id="kobo.962.1">. </span><span class="koboSpan" id="kobo.962.2">You should be able to notice that the lucky number is the same for all requests. </span><span class="koboSpan" id="kobo.962.3">If you restart the application, the lucky number may change, because it is generated randomly when the </span><span class="No-Break"><span class="koboSpan" id="kobo.963.1">application starts.</span></span></p>
<p><span class="koboSpan" id="kobo.964.1">There are a</span><a id="_idIndexMarker413"/><span class="koboSpan" id="kobo.965.1"> couple of things </span><span class="No-Break"><span class="koboSpan" id="kobo.966.1">to note:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.967.1">A middleware component is initialized only once when the </span><span class="No-Break"><span class="koboSpan" id="kobo.968.1">application starts.</span></span></li>
<li><span class="koboSpan" id="kobo.969.1">You can mix the </span><strong class="source-inline"><span class="koboSpan" id="kobo.970.1">app.Map()</span></strong><span class="koboSpan" id="kobo.971.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.972.1">app.MapWhen()</span></strong><span class="koboSpan" id="kobo.973.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.974.1">app.Use()</span></strong><span class="koboSpan" id="kobo.975.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.976.1">app.UseWhen()</span></strong><span class="koboSpan" id="kobo.977.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.978.1">app.Run()</span></strong><span class="koboSpan" id="kobo.979.1"> methods in one pipeline. </span><span class="koboSpan" id="kobo.979.2">But be careful to use them in the </span><span class="No-Break"><span class="koboSpan" id="kobo.980.1">right order.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.981.1">app.Run()</span></strong><span class="koboSpan" id="kobo.982.1"> must be the last method in </span><span class="No-Break"><span class="koboSpan" id="kobo.983.1">a pipeline.</span></span></li>
<li><span class="koboSpan" id="kobo.984.1">You cannot change the response after </span><strong class="source-inline"><span class="koboSpan" id="kobo.985.1">await next();</span></strong><span class="koboSpan" id="kobo.986.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.987.1">await next.Invoke();</span></strong><span class="koboSpan" id="kobo.988.1"> is called because it may cause a protocol violation or corrupt the response body format. </span><span class="koboSpan" id="kobo.988.2">For example, if the response has been sent to the client, if you change the headers or the status code, it will throw an exception. </span><span class="koboSpan" id="kobo.988.3">If you want to change the response, please do so before </span><strong class="source-inline"><span class="koboSpan" id="kobo.989.1">await next();</span></strong><span class="koboSpan" id="kobo.990.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.991.1">await next.Invoke();</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.992.1">is called.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.993.1">You may wonder what the difference between </span><strong class="source-inline"><span class="koboSpan" id="kobo.994.1">app.MapWhen()</span></strong><span class="koboSpan" id="kobo.995.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.996.1">app.UseWhen()</span></strong><span class="koboSpan" id="kobo.997.1"> is. </span><span class="koboSpan" id="kobo.997.2">Both of them are used to configure a conditional middleware execution. </span><span class="koboSpan" id="kobo.997.3">The differences are </span><span class="No-Break"><span class="koboSpan" id="kobo.998.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.999.1">app.MapWhen()</span></strong><span class="koboSpan" id="kobo.1000.1">: Used to branch the request pipeline based on the </span><span class="No-Break"><span class="koboSpan" id="kobo.1001.1">given predicate</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1002.1">app.UseWhen()</span></strong><span class="koboSpan" id="kobo.1003.1">: Used to conditionally add a branch in the request pipeline that is rejoined to the main pipeline if it does not short-circuit or contain a </span><span class="No-Break"><span class="koboSpan" id="kobo.1004.1">terminal middleware</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1005.1">To clarify the difference, update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1006.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1007.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1008.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1009.1">
app.UseWhen(context =&gt; context.Request.Query.ContainsKey("branch"), app =&gt;{
    app.Use(async (context, next) =&gt;
    {
        var logger = app.ApplicationServices.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;();
        logger.LogInformation($"From UseWhen(): Branch used = {context.Request.Query["branch"]}");
        await next();
    });
});
app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello world!");
});</span></pre>
<p><span class="koboSpan" id="kobo.1010.1">Run the </span><a id="_idIndexMarker414"/><span class="koboSpan" id="kobo.1011.1">application using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1012.1">dotnet run</span></strong><span class="koboSpan" id="kobo.1013.1"> and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1014.1">http://localhost:5170/?branch=1</span></strong><span class="koboSpan" id="kobo.1015.1"> URL. </span><span class="koboSpan" id="kobo.1015.2">You will see the console window outputs the </span><span class="No-Break"><span class="koboSpan" id="kobo.1016.1">following message:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1017.1">
info: Program[0]      From UseWhen(): Branch used = 1</span></pre>
<p><span class="koboSpan" id="kobo.1018.1">And the response is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1019.1">Hello world!</span></strong><span class="koboSpan" id="kobo.1020.1">. </span><span class="koboSpan" id="kobo.1020.2">If you request any other URL, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1021.1">http://localhost:5170/test</span></strong><span class="koboSpan" id="kobo.1022.1">, you will still see a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1023.1">Hello world!</span></strong><span class="koboSpan" id="kobo.1024.1"> response. </span><span class="koboSpan" id="kobo.1024.2">But you will not see the console window that outputs the log message. </span><span class="koboSpan" id="kobo.1024.3">That says </span><strong class="source-inline"><span class="koboSpan" id="kobo.1025.1">app.UseWhen()</span></strong><span class="koboSpan" id="kobo.1026.1"> only works when the predicate is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1027.1">true</span></strong><span class="koboSpan" id="kobo.1028.1">. </span><span class="koboSpan" id="kobo.1028.2">If the predicate is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1029.1">false</span></strong><span class="koboSpan" id="kobo.1030.1">, the pipeline will continue to execute the next </span><span class="No-Break"><span class="koboSpan" id="kobo.1031.1">middleware component.</span></span></p>
<p><span class="koboSpan" id="kobo.1032.1">Next, let us try to change </span><strong class="source-inline"><span class="koboSpan" id="kobo.1033.1">app.UseWhen()</span></strong><span class="koboSpan" id="kobo.1034.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1035.1">app.MapWhen()</span></strong><span class="koboSpan" id="kobo.1036.1">. </span><span class="koboSpan" id="kobo.1036.2">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1037.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1038.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1039.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1040.1">
app.MapWhen(context =&gt; context.Request.Query.ContainsKey("branch"), app =&gt;{
    app.Use(async (context, next) =&gt;
    {
        var logger = app.ApplicationServices.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;();
        logger.LogInformation($"From MapWhen(): Branch used = {context.Request.Query["branch"]}");
        await next();
    });
});</span></pre>
<p><span class="koboSpan" id="kobo.1041.1">Run the application and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1042.1">http://localhost:5170/?branch=1</span></strong><span class="koboSpan" id="kobo.1043.1"> URL again. </span><span class="koboSpan" id="kobo.1043.2">You will see a log message in the console window, but it returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1044.1">404</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1045.1">error! </span><span class="koboSpan" id="kobo.1045.2">Why?</span></span></p>
<p><span class="koboSpan" id="kobo.1046.1">That is</span><a id="_idIndexMarker415"/><span class="koboSpan" id="kobo.1047.1"> because the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1048.1">app.MapWhen()</span></strong><span class="koboSpan" id="kobo.1049.1"> method is used to branch the request pipeline based on the given predicate. </span><span class="koboSpan" id="kobo.1049.2">If the predicate is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1050.1">true</span></strong><span class="koboSpan" id="kobo.1051.1">, the request pipeline will be branched to the sub-pipeline defined in this </span><strong class="source-inline"><span class="koboSpan" id="kobo.1052.1">app.MapWhen()</span></strong><span class="koboSpan" id="kobo.1053.1"> method. </span><span class="koboSpan" id="kobo.1053.2">But when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1054.1">next()</span></strong><span class="koboSpan" id="kobo.1055.1"> method is called, it does not have a next middleware component to execute, even though there is an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1056.1">app.Run()</span></strong><span class="koboSpan" id="kobo.1057.1"> method defined at the end of the program. </span><span class="koboSpan" id="kobo.1057.2">So, it returns a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1058.1">404</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1059.1"> error.</span></span></p>
<p><span class="koboSpan" id="kobo.1060.1">To make it work, we need to add another </span><strong class="source-inline"><span class="koboSpan" id="kobo.1061.1">app.Run()</span></strong><span class="koboSpan" id="kobo.1062.1"> method to the sub-pipeline. </span><span class="koboSpan" id="kobo.1062.2">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1063.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1064.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1065.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1066.1">
app.MapWhen(context =&gt; context.Request.Query.ContainsKey("branch"), app =&gt;{
    app.Use(async (context, next) =&gt;
    {
        var logger = app.ApplicationServices.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;();
        logger.LogInformation($"From MapWhen(): Branch used = {context.Request.Query["branch"]}");
        await next();
    });
    app.Run(async context =&gt;
    {
       var branchVer = context.Request.Query["branch"];
       await context.Response.WriteAsync($"Branch used = {branchVer}");
    });
});</span></pre>
<p><span class="koboSpan" id="kobo.1067.1">Now, run the application again and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1068.1">http://localhost:5170/?branch=1</span></strong><span class="koboSpan" id="kobo.1069.1"> URL. </span><span class="koboSpan" id="kobo.1069.2">You can see the logging message is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1070.1">From MapWhen(): Branch used = 1</span></strong><span class="koboSpan" id="kobo.1071.1">, and the response is returned </span><span class="No-Break"><span class="koboSpan" id="kobo.1072.1">as expected.</span></span></p>
<p><span class="koboSpan" id="kobo.1073.1">The middleware </span><a id="_idIndexMarker416"/><span class="koboSpan" id="kobo.1074.1">mechanism is very powerful. </span><span class="koboSpan" id="kobo.1074.2">It makes the ASP.NET Core application incredibly flexible. </span><span class="koboSpan" id="kobo.1074.3">But it may cause issues if you make incorrect orders. </span><span class="koboSpan" id="kobo.1074.4">Please use </span><span class="No-Break"><span class="koboSpan" id="kobo.1075.1">it wisely.</span></span></p>
<p><span class="koboSpan" id="kobo.1076.1">In this section, we introduced how to apply middleware components using delegate methods. </span><span class="koboSpan" id="kobo.1076.2">ASP.NET Core provides a lot of built-in middleware components to simplify development. </span><span class="koboSpan" id="kobo.1076.3">In the next section, we will explore some of the built-in </span><span class="No-Break"><span class="koboSpan" id="kobo.1077.1">middleware compon</span><a id="_idTextAnchor191"/><span class="koboSpan" id="kobo.1078.1">ents.</span></span></p>
<h2 id="_idParaDest-98"><a id="_idTextAnchor192"/><span class="koboSpan" id="kobo.1079.1">Built-in middleware</span></h2>
<p><span class="koboSpan" id="kobo.1080.1">ASP.NET Core framework</span><a id="_idIndexMarker417"/><span class="koboSpan" id="kobo.1081.1"> provides a lot of built-in middleware </span><a id="_idIndexMarker418"/><span class="koboSpan" id="kobo.1082.1">components. </span><span class="koboSpan" id="kobo.1082.2">Check the code of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1083.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1084.1"> file. </span><span class="koboSpan" id="kobo.1084.2">You can find </span><a id="_idIndexMarker419"/><span class="koboSpan" id="kobo.1085.1">some code </span><span class="No-Break"><span class="koboSpan" id="kobo.1086.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1087.1">
if (app.Environment.IsDevelopment()){
    app.UseSwagger();
    app.UseSwaggerUI();
}
app.UseHttpsRedirection();
app.UseAuthorization();</span></pre>
<p><span class="koboSpan" id="kobo.1088.1">There are </span><a id="_idIndexMarker420"/><span class="koboSpan" id="kobo.1089.1">some middleware components to enable Swagger, HTTPS redirection, authorization, and so on. </span><span class="koboSpan" id="kobo.1089.2">You can find a full list of built-in middleware components </span><span class="No-Break"><span class="koboSpan" id="kobo.1090.1">here: </span></span><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-8.0#built-in-middleware"><span class="No-Break"><span class="koboSpan" id="kobo.1091.1">https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-8.0#built-in-middleware</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1092.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1093.1">Here are some common built-in middleware components. </span><span class="koboSpan" id="kobo.1093.2">Note the </span><strong class="bold"><span class="koboSpan" id="kobo.1094.1">Order</span></strong><span class="koboSpan" id="kobo.1095.1"> column. </span><span class="koboSpan" id="kobo.1095.2">Some middleware components must be called in a specific order. </span><span class="koboSpan" id="kobo.1095.3">Some middleware may terminate </span><span class="No-Break"><span class="koboSpan" id="kobo.1096.1">the requests:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table004-1">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<thead>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1097.1">Middleware</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1098.1">Description</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1099.1">Order</span></strong></span></p>
</td>
</tr>
</thead>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.1100.1">Authentication</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1101.1">Enables </span><span class="No-Break"><span class="koboSpan" id="kobo.1102.1">authentication support.</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1103.1">Before </span><strong class="source-inline"><span class="koboSpan" id="kobo.1104.1">HttpContext.User</span></strong><span class="koboSpan" id="kobo.1105.1"> is needed. </span><span class="koboSpan" id="kobo.1105.2">Terminal for </span><span class="No-Break"><span class="koboSpan" id="kobo.1106.1">OAuth callbacks.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.1107.1">Authorization</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1108.1">Enables </span><span class="No-Break"><span class="koboSpan" id="kobo.1109.1">authorization support.</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1110.1">Immediately after the </span><span class="No-Break"><span class="koboSpan" id="kobo.1111.1">Authentication middleware.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.1112.1">CORS</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1113.1">Configures </span><strong class="bold"><span class="koboSpan" id="kobo.1114.1">cross-origin resource </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1115.1">sharing</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1116.1"> (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1117.1">CORS</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1118.1">).</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1119.1">Before components that use CORS. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1120.1">UseCors</span></strong><span class="koboSpan" id="kobo.1121.1"> currently must go </span><span class="No-Break"><span class="koboSpan" id="kobo.1122.1">before </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1123.1">UseResponseCaching</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1124.1">.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.1125.1">Health Check</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1126.1">Checks the health status of the application and </span><span class="No-Break"><span class="koboSpan" id="kobo.1127.1">its dependencies.</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1128.1">Terminal if a request matches a health </span><span class="No-Break"><span class="koboSpan" id="kobo.1129.1">check endpoint.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.1130.1">HTTPS Redirection</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1131.1">Redirects all HTTP requests </span><span class="No-Break"><span class="koboSpan" id="kobo.1132.1">to HTTPS.</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1133.1">Before components that consume </span><span class="No-Break"><span class="koboSpan" id="kobo.1134.1">the URL.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.1135.1">Response Caching</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1136.1">Enables </span><span class="No-Break"><span class="koboSpan" id="kobo.1137.1">response cache.</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1138.1">Before components that require caching. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1139.1">UseCors</span></strong><span class="koboSpan" id="kobo.1140.1"> must come </span><span class="No-Break"><span class="koboSpan" id="kobo.1141.1">before </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1142.1">UseResponseCaching</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1143.1">.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.1144.1">Endpoint Routing</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1145.1">Defines and constrains </span><span class="No-Break"><span class="koboSpan" id="kobo.1146.1">request routes.</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1147.1">Terminal for </span><span class="No-Break"><span class="koboSpan" id="kobo.1148.1">matching routes.</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1149.1">Table 4.4 – Common built-in middleware components</span></p>
<p><span class="koboSpan" id="kobo.1150.1">We will not cover all the </span><a id="_idIndexMarker421"/><span class="koboSpan" id="kobo.1151.1">built-in middleware components in this book. </span><span class="koboSpan" id="kobo.1151.2">But we will introduce some of them in the following sub-sections, such as rate-limiting, request timeouts, short-circuits, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1152.1">so on</span><a id="_idTextAnchor193"/><span class="koboSpan" id="kobo.1153.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.1154.1">Using the rate-limiting middleware</span></h3>
<p><span class="koboSpan" id="kobo.1155.1">The </span><a id="_idIndexMarker422"/><span class="koboSpan" id="kobo.1156.1">rate-limiting middleware is a new built-in middleware </span><a id="_idIndexMarker423"/><span class="koboSpan" id="kobo.1157.1">provided in ASP.NET Core 7. </span><span class="koboSpan" id="kobo.1157.2">It is used to limit the </span><a id="_idIndexMarker424"/><span class="koboSpan" id="kobo.1158.1">number of requests that a client can make in a given time window. </span><span class="koboSpan" id="kobo.1158.2">It is very useful </span><a id="_idIndexMarker425"/><span class="koboSpan" id="kobo.1159.1">to prevent </span><strong class="bold"><span class="koboSpan" id="kobo.1160.1">distributed denial-of-service</span></strong><span class="koboSpan" id="kobo.1161.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1162.1">DDoS</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1163.1">) attacks.</span></span></p>
<p><span class="koboSpan" id="kobo.1164.1">The</span><a id="_idIndexMarker426"/><span class="koboSpan" id="kobo.1165.1"> rate-limiting middleware defines </span><span class="No-Break"><span class="koboSpan" id="kobo.1166.1">four policies:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1167.1">Fixed window</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1168.1">Sliding window</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1169.1">Token bucket</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.1170.1">Concurrency</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1171.1">This section is just to introduce how to use the middleware, so we will not cover details of the policies. </span><span class="koboSpan" id="kobo.1171.2">We will use the fixed window policy in this section. </span><span class="koboSpan" id="kobo.1171.3">This policy uses a fixed time window to limit the number of requests. </span><span class="koboSpan" id="kobo.1171.4">For example, we can limit the number of requests to 10 per 10 seconds. </span><span class="koboSpan" id="kobo.1171.5">When the time window expires, a new time window starts, and</span><a id="_idIndexMarker427"/><span class="koboSpan" id="kobo.1172.1"> the counter is reset </span><span class="No-Break"><span class="koboSpan" id="kobo.1173.1">to 0.</span></span></p>
<p><span class="koboSpan" id="kobo.1174.1">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1175.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1176.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1177.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1178.1">
builder.Services.AddRateLimiter(_ =&gt;    _.AddFixedWindowLimiter(policyName: "fixed", options =&gt;
        {
            options.PermitLimit = 5;
            options.Window = TimeSpan.FromSeconds(10);
            options.QueueProcessingOrder = QueueProcessingOrder.OldestFirst;
            options.QueueLimit = 2;
        }));
// Omitted for brevity
app.UseRateLimiter();
app.MapGet("/rate-limiting-mini", () =&gt; Results.Ok($"Hello {DateTime.Now.Ticks.ToString()}")).RequireRateLimiting("fixed");</span></pre>
<p><span class="koboSpan" id="kobo.1179.1">The </span><a id="_idIndexMarker428"/><span class="koboSpan" id="kobo.1180.1">preceding code adds the rate-limiting middleware to a minimal API request pipeline. </span><span class="koboSpan" id="kobo.1180.2">It creates a fixed window policy named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1181.1">fixed</span></strong><span class="koboSpan" id="kobo.1182.1">. </span><span class="koboSpan" id="kobo.1182.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1183.1">options</span></strong><span class="koboSpan" id="kobo.1184.1"> property means a maximum of 5 requests per each 10-second window </span><span class="No-Break"><span class="koboSpan" id="kobo.1185.1">are allowed.</span></span></p>
<p><span class="koboSpan" id="kobo.1186.1">Run the application and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1187.1">http://localhost:5170/rate-limiting-mini</span></strong><span class="koboSpan" id="kobo.1188.1"> URL 10 times. </span><span class="koboSpan" id="kobo.1188.2">You will see the response is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1189.1">Hello 638005...</span></strong><span class="koboSpan" id="kobo.1190.1">. </span><span class="koboSpan" id="kobo.1190.2">But the sixth request will be pending until the time window expires. </span><span class="koboSpan" id="kobo.1190.3">You can try other policies if you want. </span><span class="koboSpan" id="kobo.1190.4">To practice more, you can move the configuration for the policy to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1191.1">appsettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1192.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.1193.1">To apply this rate-limiting middleware to a controller-based API, we need to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1194.1">EnableRateLimiting</span></strong><span class="koboSpan" id="kobo.1195.1"> attribute</span><a id="_idIndexMarker429"/><span class="koboSpan" id="kobo.1196.1"> to the controller or action, </span><span class="No-Break"><span class="koboSpan" id="kobo.1197.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1198.1">
[HttpGet("rate-limiting")][EnableRateLimiting(policyName: "fixed")]
public ActionResult RateLimitingDemo()
{
    return Ok($"Hello {DateTime.Now.Ticks.ToString()}");
}</span></pre>
<p><span class="koboSpan" id="kobo.1199.1"> Next, we </span><a id="_idIndexMarker430"/><span class="koboSpan" id="kobo.1200.1">will introduce another built-in middleware component: the request </span><span class="No-Break"><span class="koboSpan" id="kobo.1201.1">timeout middleware.</span></span></p>
<h3><span class="koboSpan" id="kobo.1202.1">Using the request timeouts middleware</span></h3>
<p><span class="koboSpan" id="kobo.1203.1">ASP.NET Core 8 introduces</span><a id="_idIndexMarker431"/><span class="koboSpan" id="kobo.1204.1"> the </span><a id="_idIndexMarker432"/><span class="koboSpan" id="kobo.1205.1">request timeout middleware, which allows developers to set a timeout for an endpoint. </span><span class="koboSpan" id="kobo.1205.2">If the request is not completed within the allotted time, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1206.1">HttpContext.RequestAborted</span></strong><span class="koboSpan" id="kobo.1207.1"> cancellation token is triggered, allowing the application to handle the timeout request. </span><span class="koboSpan" id="kobo.1207.2">This feature helps to prevent the application from being blocked by </span><span class="No-Break"><span class="koboSpan" id="kobo.1208.1">long-running requests.</span></span></p>
<p><span class="koboSpan" id="kobo.1209.1">To apply the</span><a id="_idIndexMarker433"/><span class="koboSpan" id="kobo.1210.1"> request timeout middleware to the ASP.NET Core web API project, update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1211.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1212.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1213.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1214.1">
builder.Services.AddRequestTimeouts(); // Omitted for brevity
 app.UseRequestTimeouts();</span></pre>
<p><span class="koboSpan" id="kobo.1215.1">The request timeout middleware can be used for a specific endpoint. </span><span class="koboSpan" id="kobo.1215.2">To do this, we need to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1216.1">EnableRequestTimeout</span></strong><span class="koboSpan" id="kobo.1217.1"> attribute to the controller or action, </span><span class="No-Break"><span class="koboSpan" id="kobo.1218.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1219.1">
[HttpGet("request-timeout")] [RequestTimeout(5000)]
 public async Task&lt;ActionResult&gt; RequestTimeoutDemo()
 {
     var delay = _random.Next(1, 10);
     logger.LogInformation($"Delaying for {delay} seconds");
     try
     {
         await Task.Delay(TimeSpan.FromSeconds(delay), Request.HttpContext.RequestAborted);
     }
     catch
     {
         logger.LogWarning("The request timed out");
         return StatusCode(StatusCodes.Status503ServiceUnavailable, "The request timed out");
     }
     return Ok($"Hello! </span><span class="koboSpan" id="kobo.1219.2">The task is complete in {delay} seconds");
 }</span></pre>
<p><span class="koboSpan" id="kobo.1220.1">In the </span><a id="_idIndexMarker434"/><span class="koboSpan" id="kobo.1221.1">preceding code, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1222.1">RequestTimeout</span></strong><span class="koboSpan" id="kobo.1223.1"> attribute to set the timeout to 5 seconds. </span><span class="koboSpan" id="kobo.1223.2">In the action method, we </span><a id="_idIndexMarker435"/><span class="koboSpan" id="kobo.1224.1">use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1225.1">Task.Delay()</span></strong><span class="koboSpan" id="kobo.1226.1"> method to simulate a long-running task. </span><span class="koboSpan" id="kobo.1226.2">The delay time is generated randomly. </span><span class="koboSpan" id="kobo.1226.3">If the request is not completed within 5 seconds, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1227.1">Request.HttpContext.RequestAborted</span></strong><span class="koboSpan" id="kobo.1228.1"> cancellation token is triggered. </span><span class="koboSpan" id="kobo.1228.2">Then, we can handle the timeout request in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1229.1">catch</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1230.1"> block.</span></span></p>
<p><span class="koboSpan" id="kobo.1231.1">Run the application using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1232.1">dotnet run</span></strong><span class="koboSpan" id="kobo.1233.1"> command and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1234.1">/api/request-timeout</span></strong><span class="koboSpan" id="kobo.1235.1"> endpoint a few times. </span><span class="koboSpan" id="kobo.1235.2">Sometimes, you will get a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1236.1">503</span></strong><span class="koboSpan" id="kobo.1237.1"> response. </span><span class="koboSpan" id="kobo.1237.2">Note that the request timeout middleware does not work in the debug mode. </span><span class="koboSpan" id="kobo.1237.3">To test this middleware, please ensure that the debugger is not attached to </span><span class="No-Break"><span class="koboSpan" id="kobo.1238.1">the application.</span></span></p>
<p><span class="koboSpan" id="kobo.1239.1">Similarly, if you </span><a id="_idIndexMarker436"/><span class="koboSpan" id="kobo.1240.1">want to apply this middleware to a minimal API, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1241.1">WithRequestTimeout</span></strong><span class="koboSpan" id="kobo.1242.1"> method, </span><span class="No-Break"><span class="koboSpan" id="kobo.1243.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1244.1">
app.MapGet("/request-timeout-mini", async (HttpContext context, ILogger&lt;Program&gt; logger) =&gt; {
     // Omited for brevity
 }).WithRequestTimeout(TimeSpan.FromSeconds(5));</span></pre>
<p><span class="koboSpan" id="kobo.1245.1">The timeout</span><a id="_idIndexMarker437"/><span class="koboSpan" id="kobo.1246.1"> configuration can be configured with a policy. </span><span class="koboSpan" id="kobo.1246.2">Then, we can apply the policy to the controller or action. </span><span class="koboSpan" id="kobo.1246.3">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1247.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1248.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1249.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1250.1">
builder.Services.AddRequestTimeouts(option =&gt; {
     option.DefaultPolicy = new RequestTimeoutPolicy { Timeout = TimeSpan.FromSeconds(5) };
     option.AddPolicy("ShortTimeoutPolicy", TimeSpan.FromSeconds(2));
     option.AddPolicy("LongTimeoutPolicy", TimeSpan.FromSeconds(10));
 });</span></pre>
<p><span class="koboSpan" id="kobo.1251.1">The preceding code defines three timeout policies. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1252.1">DefaultPolicy</span></strong><span class="koboSpan" id="kobo.1253.1"> is used when no policy is specified. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1254.1">ShortTimeoutPolicy</span></strong><span class="koboSpan" id="kobo.1255.1"> is used for short-running requests with a timeout of 2 seconds, while </span><strong class="source-inline"><span class="koboSpan" id="kobo.1256.1">LongTimeoutPolicy</span></strong><span class="koboSpan" id="kobo.1257.1"> is used for long-running requests with a timeout of 10 seconds. </span><span class="koboSpan" id="kobo.1257.2">To apply the policy to the controller or action, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1258.1">EnableRequestTimeout</span></strong><span class="koboSpan" id="kobo.1259.1"> attribute can be used </span><span class="No-Break"><span class="koboSpan" id="kobo.1260.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1261.1">
[HttpGet("request-timeout-short")] [RequestTimeout("ShortTimeoutPolicy")]
 public async Task&lt;ActionResult&gt; RequestTimeoutShortDemo()</span></pre>
<p><span class="koboSpan" id="kobo.1262.1">If the action method does not specify a policy, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1263.1">DefaultPolicy</span></strong><span class="koboSpan" id="kobo.1264.1"> will </span><span class="No-Break"><span class="koboSpan" id="kobo.1265.1">be used.</span></span></p>
<h3><span class="koboSpan" id="kobo.1266.1">Using the short-circuit middleware</span></h3>
<p><span class="koboSpan" id="kobo.1267.1">The short-circuit middleware</span><a id="_idIndexMarker438"/><span class="koboSpan" id="kobo.1268.1"> is another new middleware component introduced in ASP.NET Core 8. </span><span class="koboSpan" id="kobo.1268.2">This</span><a id="_idIndexMarker439"/><span class="koboSpan" id="kobo.1269.1"> middleware is used to short-circuit a request when it is not necessary to continue processing the request. </span><span class="koboSpan" id="kobo.1269.2">For example, web robots may request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1270.1">/robots.txt</span></strong><span class="koboSpan" id="kobo.1271.1"> file to check if the website allows crawling. </span><span class="koboSpan" id="kobo.1271.2">As a web API application, we do not need to process this request. </span><span class="koboSpan" id="kobo.1271.3">However, the execution of the request pipeline will still continue. </span><span class="koboSpan" id="kobo.1271.4">The short-circuit middleware can be used to short-circuit the request and return a </span><span class="No-Break"><span class="koboSpan" id="kobo.1272.1">response directly.</span></span></p>
<p><span class="koboSpan" id="kobo.1273.1">To apply the </span><a id="_idIndexMarker440"/><span class="koboSpan" id="kobo.1274.1">short-circuit middleware to a specific endpoint, add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1275.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1276.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1277.1">
app.MapGet("robots.txt", () =&gt; Results.Content("User-agent: *\nDisallow: /", "text/plain")).ShortCircuit();</span></pre> <p><span class="koboSpan" id="kobo.1278.1">The preceding code uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1279.1">ShortCircuit()</span></strong><span class="koboSpan" id="kobo.1280.1"> method to short-circuit the request. </span><span class="koboSpan" id="kobo.1280.2">If the request path is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1281.1">/robots.txt</span></strong><span class="koboSpan" id="kobo.1282.1">, it will return a text/plain </span><span class="No-Break"><span class="koboSpan" id="kobo.1283.1">response directly.</span></span></p>
<p><span class="koboSpan" id="kobo.1284.1">Another way to use the short-circuit middleware is to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1285.1">MapShortCircuit</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1286.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1287.1">
app.MapShortCircuit((int)HttpStatusCode.NotFound, "robots.txt", "favicon.ico");</span></pre> <p><span class="koboSpan" id="kobo.1288.1">In this example, when a request is made to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1289.1">/robots.txt</span></strong><span class="koboSpan" id="kobo.1290.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1291.1">/favicon.ico</span></strong><span class="koboSpan" id="kobo.1292.1">, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1293.1">404 Not Found</span></strong><span class="koboSpan" id="kobo.1294.1"> response will be returned directly. </span><span class="koboSpan" id="kobo.1294.2">This ensures that the server is not burdened with </span><span class="No-Break"><span class="koboSpan" id="kobo.1295.1">unnecessary requests.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1296.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1297.1">The short-circuit middleware should be placed at the start of the pipeline to prevent other middleware components from processing the request unnecessarily. </span><span class="koboSpan" id="kobo.1297.2">This will ensure that the request is handled in the most </span><span class="No-Break"><span class="koboSpan" id="kobo.1298.1">efficient manner.</span></span></p>
<p><span class="koboSpan" id="kobo.1299.1">ASP.NET Core provides a wide range of built-in middleware components. </span><span class="koboSpan" id="kobo.1299.2">These components use extension methods such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1300.1">AddXXX()</span></strong><span class="koboSpan" id="kobo.1301.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1302.1">UseXXX()</span></strong><span class="koboSpan" id="kobo.1303.1"> to add middleware</span><a id="_idIndexMarker441"/><span class="koboSpan" id="kobo.1304.1"> components to the pipeline. </span><span class="koboSpan" id="kobo.1304.2">In the following section, we will explore how to create a custom middleware component and apply it to the pipeline using </span><a id="_idTextAnchor194"/><span class="koboSpan" id="kobo.1305.1">an </span><span class="No-Break"><span class="koboSpan" id="kobo.1306.1">extension method.</span></span></p>
<h2 id="_idParaDest-99"><a id="_idTextAnchor195"/><span class="koboSpan" id="kobo.1307.1">Creating a custom middleware component</span></h2>
<p><span class="koboSpan" id="kobo.1308.1">If the </span><a id="_idIndexMarker442"/><span class="koboSpan" id="kobo.1309.1">built-in middleware cannot meet </span><a id="_idIndexMarker443"/><span class="koboSpan" id="kobo.1310.1">your requirements, you can create your own middleware components. </span><span class="koboSpan" id="kobo.1310.2">A custom middleware component does not have to derive from a base class or an interface. </span><span class="koboSpan" id="kobo.1310.3">But a middleware class does need to follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1311.1">some conventions:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1312.1">It must have a public constructor that accepts a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1313.1">RequestDelegate</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1314.1"> parameter.</span></span></li>
<li><span class="koboSpan" id="kobo.1315.1">It must have a public method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1316.1">Invoke()</span></strong><span class="koboSpan" id="kobo.1317.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1318.1">InvokeAsync()</span></strong><span class="koboSpan" id="kobo.1319.1"> that accepts a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1320.1">HttpContext</span></strong><span class="koboSpan" id="kobo.1321.1"> parameter and returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1322.1">Task</span></strong><span class="koboSpan" id="kobo.1323.1">. </span><span class="koboSpan" id="kobo.1323.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1324.1">HttpContent</span></strong><span class="koboSpan" id="kobo.1325.1"> parameter must be the </span><span class="No-Break"><span class="koboSpan" id="kobo.1326.1">first parameter.</span></span></li>
<li><span class="koboSpan" id="kobo.1327.1">It can use DI to inject </span><span class="No-Break"><span class="koboSpan" id="kobo.1328.1">additional dependencies.</span></span></li>
<li><span class="koboSpan" id="kobo.1329.1">An extension method is needed to add the middleware to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1330.1">IApplicationBuilder</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1331.1"> instance.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1332.1">Consider this scenario. </span><span class="koboSpan" id="kobo.1332.2">For better tracking, we want to use the concept of correlation ID in the application. </span><span class="koboSpan" id="kobo.1332.3">The correlation ID is a unique identifier for each request. </span><span class="koboSpan" id="kobo.1332.4">It is used to track the request through the application, especially in a microservice architecture. </span><span class="koboSpan" id="kobo.1332.5">ASP.NET Core provides a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1333.1">HttpContext.TraceIdentifier</span></strong><span class="koboSpan" id="kobo.1334.1"> property to store the unique identifier. </span><span class="koboSpan" id="kobo.1334.2">By default, Kestrel generates the ID using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1335.1">{ConnectionId}:{Request number}</span></strong><span class="koboSpan" id="kobo.1336.1"> format; for </span><span class="No-Break"><span class="koboSpan" id="kobo.1337.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1338.1">0HML6LNF87PBV:00000001</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1339.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1340.1">If we have multiple services, such as </span><em class="italic"><span class="koboSpan" id="kobo.1341.1">Service A</span></em><span class="koboSpan" id="kobo.1342.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.1343.1">Service B</span></em><span class="koboSpan" id="kobo.1344.1">, when the client calls </span><em class="italic"><span class="koboSpan" id="kobo.1345.1">Service A</span></em><span class="koboSpan" id="kobo.1346.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1347.1">Service A</span></em><span class="koboSpan" id="kobo.1348.1"> will generate a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1349.1">TraceIdentifier</span></strong><span class="koboSpan" id="kobo.1350.1"> instance for the current request, then </span><em class="italic"><span class="koboSpan" id="kobo.1351.1">Service A</span></em><span class="koboSpan" id="kobo.1352.1"> will call </span><em class="italic"><span class="koboSpan" id="kobo.1353.1">Service B</span></em><span class="koboSpan" id="kobo.1354.1">, and </span><em class="italic"><span class="koboSpan" id="kobo.1355.1">Service B</span></em><span class="koboSpan" id="kobo.1356.1"> will generate another </span><strong class="source-inline"><span class="koboSpan" id="kobo.1357.1">TraceIdentifier</span></strong><span class="koboSpan" id="kobo.1358.1"> instance. </span><span class="koboSpan" id="kobo.1358.2">It is hard to track the request through multiple services. </span><span class="koboSpan" id="kobo.1358.3">We need to use the same </span><strong class="source-inline"><span class="koboSpan" id="kobo.1359.1">TraceIdentifier</span></strong><span class="koboSpan" id="kobo.1360.1"> instance for the request to </span><span class="No-Break"><span class="koboSpan" id="kobo.1361.1">be tracked.</span></span></p>
<p><span class="koboSpan" id="kobo.1362.1">The idea is to generate a correlation ID for each request chain. </span><span class="koboSpan" id="kobo.1362.2">Then, set it in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1363.1">X-Correlation-Id</span></strong><span class="koboSpan" id="kobo.1364.1"> header for request/response as well. </span><span class="koboSpan" id="kobo.1364.2">When we call </span><em class="italic"><span class="koboSpan" id="kobo.1365.1">Service B</span></em><span class="koboSpan" id="kobo.1366.1"> from </span><em class="italic"><span class="koboSpan" id="kobo.1367.1">Service A</span></em><span class="koboSpan" id="kobo.1368.1">, attach the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1369.1">X-Correlation-Id</span></strong><span class="koboSpan" id="kobo.1370.1"> header to the HTTP request headers so that we can attach the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1371.1">X-Correlation-Id</span></strong><span class="koboSpan" id="kobo.1372.1"> value in the logs for future diagnostics. </span><span class="koboSpan" id="kobo.1372.2">To do this, we</span><a id="_idIndexMarker444"/><span class="koboSpan" id="kobo.1373.1"> need to create a custom middleware</span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.1374.1"> component. </span><span class="koboSpan" id="kobo.1374.2">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1375.1">CorrelationIdMiddleware</span></strong><span class="koboSpan" id="kobo.1376.1"> in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1377.1">project folder:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1378.1">
public class CorrelationIdMiddleware(RequestDelegate next, ILogger&lt;CorrelationIdMiddleware&gt; logger){    private const string CorrelationIdHeaderName = "X-Correlation-Id";
    public async Task InvokeAsync(HttpContext context)
    {
        var correlationId = context.Request.Headers[CorrelationIdHeaderName].FirstOrDefault();
        if (string.IsNullOrEmpty(correlationId))
        {
            correlationId = Guid.NewGuid().ToString();
        }
        context.Request.Headers.TryAdd(CorrelationIdHeaderName, correlationId);
        // Log the correlation ID
        logger.LogInformation("Request path: {RequestPath}. </span><span class="koboSpan" id="kobo.1378.2">CorrelationId: {CorrelationId}", context.Request.Path, correlationId);
        context.Response.Headers.TryAdd(CorrelationIdHeaderName, correlationId);
        await next(context);
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.1379.1">In the </span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.1380.1">preceding code, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1381.1">CorrelationIdMiddleware</span></strong><span class="koboSpan" id="kobo.1382.1"> class has a public constructor that accepts a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1383.1">RequestDelegate</span></strong><span class="koboSpan" id="kobo.1384.1"> parameter. </span><span class="koboSpan" id="kobo.1384.2">It also has a public method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1385.1">InvokeAsync()</span></strong><span class="koboSpan" id="kobo.1386.1"> that accepts a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1387.1">HttpContext</span></strong><span class="koboSpan" id="kobo.1388.1"> parameter and returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1389.1">Task</span></strong><span class="koboSpan" id="kobo.1390.1"> instance. </span><span class="koboSpan" id="kobo.1390.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1391.1">InvokeAsync()</span></strong><span class="koboSpan" id="kobo.1392.1"> method is the entry point of the middleware. </span><span class="koboSpan" id="kobo.1392.2">It gets the correlation ID from the request header. </span><span class="koboSpan" id="kobo.1392.3">If it is not found, it generates a new one. </span><span class="koboSpan" id="kobo.1392.4">Then, it sets the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1393.1">HttpContext.TraceIdentifier</span></strong><span class="koboSpan" id="kobo.1394.1"> property and adds</span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.1395.1"> the correlation ID to the response header. </span><span class="koboSpan" id="kobo.1395.2">Finally, it calls the next middleware component in the pipeline. </span><span class="koboSpan" id="kobo.1395.3">It also uses a logger via DI to log the </span><span class="No-Break"><span class="koboSpan" id="kobo.1396.1">correlation ID.</span></span></p>
<p><span class="koboSpan" id="kobo.1397.1">Next, add a new extension method to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1398.1">IApplicationBuilder</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1399.1"> instance:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1400.1">
public static class CorrelationIdMiddlewareExtensions{
    public static IApplicationBuilder UseCorrelationId(this IApplicationBuilder builder)
    {
        return builder.UseMiddleware&lt;CorrelationIdMiddleware&gt;();
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.1401.1">Now, we can apply the correlation ID middleware in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1402.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1403.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1404.1">
app.UseCorrelationId();</span></pre> <p><span class="koboSpan" id="kobo.1405.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1406.1">WeatherForecastController.cs</span></strong><span class="koboSpan" id="kobo.1407.1"> file and add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1408.1">Get()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1409.1"> method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1410.1">
[HttpGet(Name = "GetWeatherForecast")]public IEnumerable&lt;WeatherForecast&gt; Get()
{
    // Get the "X-Correlation-Id" header from the request
    var correlationId = Request.Headers["X-Correlation-Id"].FirstOrDefault();
    // Log the correlation ID
    _logger.LogInformation("Handling the request. </span><span class="koboSpan" id="kobo.1410.2">CorrelationId: {CorrelationId}", correlationId);
    // Call another service with the same "X-Correlation-Id" header when you set up the HttpClient
    //var httpContent = new StringContent("Hello world!");
    //httpContent.Headers.Add("X-Correlation-Id", correlationId);
    // Omitted for brevity</span></pre>
<p><span class="koboSpan" id="kobo.1411.1">Run the</span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.1412.1"> application and request the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1413.1">http://localhost:5170/WeatherForecast</span></strong><span class="koboSpan" id="kobo.1414.1"> URL. </span><span class="koboSpan" id="kobo.1414.2">You will see the response </span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.1415.1">header contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1416.1">X-Correlation-Id</span></strong><span class="koboSpan" id="kobo.1417.1"> property, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1418.1">shown next:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1419.1">
content-type: application/json; charset=utf-8date: Wed,05 Oct 2022 08:17:55 GMT
server: Kestrel
transfer-encoding: chunked
x-correlation-id: de67a42b-fd95-4ba1-bd2a-28a54c878d4a</span></pre>
<p><span class="koboSpan" id="kobo.1420.1">You can also see the correlation ID in the log, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.1421.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1422.1">
MiddlewareDemo.CorrelationIdMiddleware: Information: Request path: /WeatherForecast. </span><span class="koboSpan" id="kobo.1422.2">CorrelationId: 795bf955-50a1-4d71-a90d-f859e636775a...
</span><span class="koboSpan" id="kobo.1422.3">MiddlewareDemo.Controllers.WeatherForecastController: Information: Handling the request. </span><span class="koboSpan" id="kobo.1422.4">CorrelationId: 795bf955-50a1-4d71-a90d-f859e636775a</span></pre>
<p><span class="koboSpan" id="kobo.1423.1">In this way, we can use the correlation ID to track the request through multiple services, especially in a </span><span class="No-Break"><span class="koboSpan" id="kobo.1424.1">microservice architecture.</span></span></p>
<p><span class="koboSpan" id="kobo.1425.1">We did not </span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.1426.1">call any other services in this example. </span><span class="koboSpan" id="kobo.1426.2">You can have a try yourself. </span><span class="koboSpan" id="kobo.1426.3">Create another service and call it from the current service. </span><span class="koboSpan" id="kobo.1426.4">Apply the same correlation ID middleware in another service. </span><span class="koboSpan" id="kobo.1426.5">It can get the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1427.1">X-Correlation-Id</span></strong><span class="koboSpan" id="kobo.1428.1"> header from the request headers and continue to use it. </span><span class="koboSpan" id="kobo.1428.2">Then, you will see the same correlation ID is used for</span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.1429.1"> each request chain in </span><span class="No-Break"><span class="koboSpan" id="kobo.1430.1">both services.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1431.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1432.1">The preceding example is purely for demonstration purposes. </span><span class="koboSpan" id="kobo.1432.2">Microsoft provides a NuGet package called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1433.1">Microsoft.AspNetCore.HeaderPropagation</span></strong><span class="koboSpan" id="kobo.1434.1"> that can be used to propagate headers to downstream services. </span><span class="koboSpan" id="kobo.1434.2">You can find the sample code here: </span><a href="https://github.com/dotnet/aspnetcore/tree/main/src/Middleware/HeaderPropagation/samples/HeaderPropagationSample"><span class="koboSpan" id="kobo.1435.1">https://github.com/dotnet/aspnetcore/tree/main/src/Middleware/HeaderPropagation/samples/HeaderPropagationSample</span></a><span class="koboSpan" id="kobo.1436.1">. </span><span class="koboSpan" id="kobo.1436.2">You can also check </span><a href="B18971_16.xhtml#_idTextAnchor671"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1437.1">Chapter 16</span></em></span></a><span class="koboSpan" id="kobo.1438.1"> to learn more about the distribute</span><a id="_idTextAnchor196"/><span class="koboSpan" id="kobo.1439.1">d tracing </span><span class="No-Break"><span class="koboSpan" id="kobo.1440.1">using OpenTelemetry.</span></span></p>
<h1 id="_idParaDest-100"><a id="_idTextAnchor197"/><span class="koboSpan" id="kobo.1441.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1442.1">In this chapter, we learned about the logging framework in ASP.NET Core, and introduced a third-party logging framework, Serilog, to help us write logs to different sinks, such as files, console, and Seq, which is a tool that analyzes logs using structured logging. </span><span class="koboSpan" id="kobo.1442.2">We also learned what middleware is, how to use the built-in middleware components, and how to create a custom </span><span class="No-Break"><span class="koboSpan" id="kobo.1443.1">middleware component.</span></span></p>
<p><span class="koboSpan" id="kobo.1444.1">It is time to implement some real business logic in the next chapter. </span><span class="koboSpan" id="kobo.1444.2">We will introduce </span><strong class="bold"><span class="koboSpan" id="kobo.1445.1">Entity Framework Core</span></strong><span class="koboSpan" id="kobo.1446.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1447.1">EF Core</span></strong><span class="koboSpan" id="kobo.1448.1">), a powerful </span><strong class="bold"><span class="koboSpan" id="kobo.1449.1">object-relational mapper</span></strong><span class="koboSpan" id="kobo.1450.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1451.1">ORM</span></strong><span class="koboSpan" id="kobo.1452.1">) framework, to help us access </span><span class="No-Break"><span class="koboSpan" id="kobo.1453.1">the database.</span></span></p>
</div>
</body></html>