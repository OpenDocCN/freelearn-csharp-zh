<html><head></head><body>
		<div id="_idContainer086">
			<h1 id="_idParaDest-66" class="chapter-number"><a id="_idTextAnchor068"/>5</h1>
			<h1 id="_idParaDest-67"><a id="_idTextAnchor069"/>Input/Output and File Handling</h1>
			<p>In the previous chapter, we laid out the<a id="_idIndexMarker123"/> foundations of <strong class="bold">Bookmarkr</strong>, our CLI application for managing bookmarks. We started with a basic console application, and we leveraged the <strong class="source-inline">System.CommandLine</strong> library to infuse CLI capabilities into <span class="No-Break">the application.</span></p>
			<p>For now, our CLI application only contains one command (<strong class="source-inline">link</strong>), which allows for managing bookmarks by adding new ones or listing, updating, or removing <span class="No-Break">existing ones.</span></p>
			<p>With this chapter, we are working toward <span class="No-Break">two goals:</span></p>
			<ol>
				<li>To go a bit deeper with options to further control input values for our CLI applicationâ€™s <span class="No-Break">command options.</span></li>
				<li>To see how to handle input and output files in a CLI application. This might be handy for import and export operations, making it easier to back up and restore our applicationâ€™s data and share it with <span class="No-Break">other applications.</span></li>
			</ol>
			<p>Specifically, weâ€™ll cover the following <span class="No-Break">main topics:</span></p>
			<ul>
				<li>Controlling input values for an option, determining when to use required versus non-required options, setting default values for options, controlling the set of allowed values for an option, and validating <span class="No-Break">input values</span></li>
				<li>Working with files passed as parameters to the CLI application, both as input and output files, which will be useful for adding import and export capabilities to our <span class="No-Break">CLI application</span></li>
			</ul>
			<h1 id="_idParaDest-68"><a id="_idTextAnchor070"/>Technical requirements</h1>
			<p>The code for this chapter can be found in the GitHub repository accompanying this <span class="No-Break">book, </span><a href="https://github.com/PacktPublishing/Building-CLI-Applications-with-C-Sharp-and-.NET/tree/main/Chapter05"><span class="No-Break">https://github.com/PacktPublishing/Building-CLI-Applications-with-C-Sharp-and-.NET/tree/main/Chapter05</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-69"><a id="_idTextAnchor071"/>Controlling input values for an option</h1>
			<p>Parameters are at the<a id="_idIndexMarker124"/> heart of any application. They allow users to indicate what command they want to execute and provide values to the input parameters. This is why, in this section and its subsections, we will cover the subtleties of dealing with <span class="No-Break">these parameters.</span></p>
			<h2 id="_idParaDest-70"><a id="_idTextAnchor072"/>Required versus non-required options</h2>
			<p>In its current<a id="_idIndexMarker125"/> state, adding a new bookmark requires both the name and the URL to be provided, which is, obviously, what <span class="No-Break">we want.</span></p>
			<p>This means that if we call the <strong class="source-inline">link add</strong> command without passing one of these options or their values, we should get an error such as <span class="No-Break">the following:</span></p>
			<div>
				<div id="_idContainer066" class="IMG---Figure">
					<img src="image/B22400_05_01.jpg" alt="Figure 5.1 â€“ The name and URL for a bookmark should be required"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.1 â€“ The name and URL for a bookmark should be required</p>
			<p>However, if we run the<a id="_idIndexMarker126"/> program without passing these two options, we currently get the <span class="No-Break">following result:</span></p>
			<p class="IMG---Figure"><a id="_idTextAnchor073"/></p>
			<div>
				<div id="_idContainer067" class="IMG---Figure">
					<img src="image/B22400_05_02.jpg" alt="Figure 5.2 â€“ The name and URL for the added bookmark are currently optional"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.2 â€“ The name and URL for the added bookmark are currently optional</p>
			<p>Notice how a new <a id="_idIndexMarker127"/>bookmark with no name and no URL is added to the collection of bookmarks. This is clearly not what <span class="No-Break">we want!</span></p>
			<p>Fortunately, the <strong class="source-inline">Option</strong> class provides a Boolean value to specify whether it should be required <span class="No-Break">or optional.</span></p>
			<p>To make the name and URL options required, letâ€™s set their respective <strong class="source-inline">IsRequired</strong> property <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">true</strong></span><span class="No-Break">:</span></p>
			<pre class="source-code">
nameOption.IsRequired = true;
urlOption.IsRequired = true;</pre>			<p>If we now run the<a id="_idIndexMarker128"/> program without passing in an option or its value, we get an <span class="No-Break">error message:</span></p>
			<div>
				<div id="_idContainer068" class="IMG---Figure">
					<img src="image/B22400_05_03.jpg" alt="Figure 5.3 â€“ The name and URL for the added bookmark are now required"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.3 â€“ The name and URL for the added bookmark are now required</p>
			<p>Also note that the help menu clearly states that these two options <span class="No-Break">are required.</span></p>
			<p>So far, we have two required options. Letâ€™s add an <span class="No-Break">optional one.</span></p>
			<p>When an option is not required (i.e., optional), the application should not return an error if we donâ€™t pass that option or <span class="No-Break">its value.</span></p>
			<p>Letâ€™s take an <span class="No-Break">illustrative example.</span></p>
			<p>Letâ€™s say we want to classify our bookmarks by category. By doing so, we can imagine that we may want to list only the bookmarks that belong to a <span class="No-Break">specific category.</span></p>
			<p>For that matter, we<a id="_idIndexMarker129"/> will first add a <strong class="source-inline">Category</strong> property to the <strong class="source-inline">Bookmark</strong> class, <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
public class Bookmark
{
Â Â Â Â public required string Name { get; set; }
Â Â Â Â public required string Url { get; set; }
Â Â Â Â public required string Category { get; set; }
}</pre>			<p>Then, we will add an option for the category and pass it to the <span class="No-Break"><strong class="source-inline">add</strong></span><span class="No-Break"> command:</span></p>
			<pre class="source-code">
var categoryOption = new Option&lt;string&gt;(
Â Â Â Â Â ["--category", "-c"],
Â Â Â Â Â "The category to which the bookmark is associated"
);
var addLinkCommand = new Command("add", "Add a new bookmark link")
{
Â Â Â Â Â nameOption,
Â Â Â Â Â urlOption,
Â Â Â Â Â categoryOption
};</pre>			<p>Next, we update the handler method and its association with <span class="No-Break">the command:</span></p>
			<pre class="source-code">
addLinkCommand.SetHandler(OnHandleAddLinkCommand, nameOption, urlOption, categoryOption);
static void OnHandleAddLinkCommand(string name, string url, string category)
{
Â Â Â Â Â service.AddLink(name, url, category);
}</pre>			<p>Finally, do not forget to update <strong class="source-inline">BookmarkService</strong> so it handles the <strong class="source-inline">Category</strong> <span class="No-Break">property accordingly.</span></p>
			<p>Now, if we execute <a id="_idIndexMarker130"/>the application without passing the category, no error <span class="No-Break">is returned:</span></p>
			<div>
				<div id="_idContainer069" class="IMG---Figure">
					<img src="image/B22400_05_04.jpg" alt="Figure 5.4 â€“ The Category option is optional"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.4 â€“ The Category option is optional</p>
			<p>And, of course, if we pass a category, it works <span class="No-Break">too.</span><span class="No-Break"> ðŸ˜Š</span></p>
			<div>
				<div id="_idContainer070" class="IMG---Figure">
					<img src="image/B22400_05_05.jpg" alt="Figure 5.5 â€“ Assigning a category to the newly added bookmark"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.5 â€“ Assigning a category to the newly added bookmark</p>
			<p>However, since<a id="_idIndexMarker131"/> the category is now optional, if we donâ€™t pass it, what would its <span class="No-Break">value be?</span></p>
			<p class="callout-heading">Double or single dash?</p>
			<p class="callout">You might be wondering when we should use double versus single dashes. Do we even have to <span class="No-Break">use both?</span></p>
			<p class="callout">The answer is no! You only use both if you want to provide both a long and a short form for passing in an option, but you can definitely opt for only one of <span class="No-Break">these options.</span></p>
			<p class="callout">For example, while <strong class="source-inline">--set-max-concurrent-requests</strong> might be more self-explanatory to someone new to your CLI, if they often use your CLI application, having to type this long form again and again may become frustrating. Thatâ€™s why a short form, such as <strong class="source-inline">-m</strong>, will be <span class="No-Break">more appropriate.</span></p>
			<p class="callout">In the real world, you will notice that users who are just starting to use your CLI application will rely on long-form options and gradually transition to short forms as they become more experienced with your <span class="No-Break">CLI application.</span></p>
			<p class="callout">So, for example, a junior user of Bookmarkr will prefer <span class="No-Break">this syntax:</span></p>
			<p class="callout"><strong class="source-inline">bookmarkr link add --name "Packt Publishing" --</strong><span class="No-Break"><strong class="source-inline">url "https://packtpub.com"</strong></span></p>
			<p class="callout">An experienced<a id="_idIndexMarker132"/> user, on the other hand, is likely to prefer <span class="No-Break">this syntax:</span></p>
			<p class="callout"><strong class="source-inline">bookmarkr link add -n "Packt Publishing" -</strong><span class="No-Break"><strong class="source-inline">u "https://packtpub.com"</strong></span></p>
			<h2 id="_idParaDest-71"><a id="_idTextAnchor074"/>What about arguments?</h2>
			<p>Ah! I can see that youâ€™ve learned<a id="_idIndexMarker133"/> about arguments. Arguments are instances of the <strong class="source-inline">Argument</strong> class, and they represent required parameters that are essential to the execution of <span class="No-Break">a command.</span></p>
			<p>But waitâ€¦ why not use arguments instead of options for <span class="No-Break">required parameters?</span></p>
			<p>You could, of course! But I donâ€™t like these because they are <em class="italic">positional</em> parameters and not <em class="italic">named</em> parameters. This means that only their position instructs the user about their purpose, which, to me, sacrifices the readability of the <span class="No-Break">CLI request.</span></p>
			<p>To illustrate my point, here is what the call to the <strong class="source-inline">link add</strong> command would look like if it relied on arguments rather <span class="No-Break">than parameters:</span></p>
			<pre class="console">
$ bookmarkr link add 'Packt Publishing' 'https://packtpub.com' 'Great tech books'</pre>			<p>See how this is way less readable than our previous request (which relies <span class="No-Break">on options)?</span></p>
			<p>Thatâ€™s why I donâ€™t like arguments and prefer to use options, specifying which ones are required and <a id="_idIndexMarker134"/>which ones <span class="No-Break">are optional.</span></p>
			<p>So, letâ€™s get back to <span class="No-Break">exploring options.</span></p>
			<h2 id="_idParaDest-72"><a id="_idTextAnchor075"/>Setting a default value for an option</h2>
			<p>Well, as you <a id="_idIndexMarker135"/>may have guessed, the default value for an option will be (by default) the default value for its data type (are you still <span class="No-Break">with me?).</span></p>
			<p>Since the <strong class="source-inline">Category</strong> option is of type <strong class="source-inline">string</strong>, its default value is <strong class="source-inline">null</strong>. However, the <strong class="source-inline">Option</strong> class allows us to define a <span class="No-Break">default value.</span></p>
			<p>Letâ€™s set the default value for the <strong class="source-inline">Category</strong> option to <strong class="source-inline">"Read later"</strong>. This can be done by calling the <strong class="source-inline">SetDefaultValue</strong> method and passing in the <span class="No-Break">default value:</span></p>
			<pre class="source-code">
categoryOption.SetDefaultValue("Read later");</pre>			<p>If we run the program without providing a value for the <strong class="source-inline">Category</strong> option, we can see that its default value <span class="No-Break">is used:</span></p>
			<div>
				<div id="_idContainer071" class="IMG---Figure">
					<img src="image/B22400_05_06.jpg" alt="Figure 5.6 â€“ Using the default value for the category option"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.6 â€“ Using the default value for the category option</p>
			<p>However, if we do<a id="_idIndexMarker136"/> provide a value for the category, we can see that this value is <span class="No-Break">actually used:</span></p>
			<div>
				<div id="_idContainer072" class="IMG---Figure">
					<img src="image/B22400_05_07.jpg" alt="Figure 5.7 â€“ Using the provided value for the category option"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.7 â€“ Using the provided value for the category option</p>
			<h3>Should we provide default values for required options?</h3>
			<p>No, we should not! This <a id="_idIndexMarker137"/>is because if we do that, a required option will no longer behave as a required one but rather as an <span class="No-Break">optional one.</span></p>
			<p>Why? Because if we do not provide a value for it, the default value will <span class="No-Break">be used.</span></p>
			<p>This is why default values should only be used with <span class="No-Break">optional options.</span></p>
			<p>Note that in the previous example, the user can specify any string value for the <strong class="source-inline">Category</strong> option. But what if we wanted to control the set of allowed values? This is where the <strong class="source-inline">FromAmong</strong> method <span class="No-Break">comes in.</span></p>
			<h2 id="_idParaDest-73"><a id="_idTextAnchor076"/>Controlling the allowed values for an option</h2>
			<p>Letâ€™s pretend for a<a id="_idIndexMarker138"/> moment that we only allow a set of categories in our application. Yes, in real life, we would allow users to create as many categories as they want, but this will serve our purpose of explaining how to only allow a specific set of values for <span class="No-Break">an option.</span></p>
			<p>Letâ€™s say we allow the <span class="No-Break">following categories:</span></p>
			<ul>
				<li>Read later (which serves as the <span class="No-Break">default one)</span></li>
				<li><span class="No-Break">Tech books</span></li>
				<li><span class="No-Break">Cooking</span></li>
				<li><span class="No-Break">Social media</span></li>
			</ul>
			<p>We will do this by passing these values to the <strong class="source-inline">FromAmong</strong> method <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
categoryOption.FromAmong("Read later", "Tech books", "Cooking", "Social media");</pre>			<p>If we run the application by passing in an allowed category, everything <span class="No-Break">works fine:</span></p>
			<div>
				<div id="_idContainer073" class="IMG---Figure">
					<img src="image/B22400_05_08.jpg" alt="Figure 5.8 â€“ Passing in an allowed value for the category"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.8 â€“ Passing in an allowed value for the category</p>
			<p>However, if we do <a id="_idIndexMarker139"/>pass an unallocated category value, we will get an <span class="No-Break">error message:</span></p>
			<div>
				<div id="_idContainer074" class="IMG---Figure">
					<img src="image/B22400_05_09.jpg" alt="Figure 5.9 â€“ Passing in an unallowed value for the category"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.9 â€“ Passing in an unallowed value for the category</p>
			<p>Notice that the <a id="_idIndexMarker140"/>error message indicates the allowed values. We can also see the allowed values from the <span class="No-Break">help menu:</span></p>
			<div>
				<div id="_idContainer075" class="IMG---Figure">
					<img src="image/B22400_05_10.jpg" alt="Figure 5.10 â€“ Seeing the allowed values in the help menu"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.10 â€“ Seeing the allowed values in the help menu</p>
			<p>Using <strong class="source-inline">FromAmong</strong> can be particularly useful for ensuring data integrity and guiding user input, especially in scenarios where options need to conform to a predefined set of <span class="No-Break">valid values.</span></p>
			<p>Okay, so letâ€™s recap. Our CLI application has required and optional parameters. It specifies a default value for its optional parameter, along with allowed values. However, we are missing something, something important. Can you guess what <span class="No-Break">it is?</span></p>
			<p>Yes, exactly, the ability <a id="_idIndexMarker141"/>to ensure that the provided value for a specific parameter <span class="No-Break">is valid.</span></p>
			<h2 id="_idParaDest-74"><a id="_idTextAnchor077"/>Validating input values</h2>
			<p>When adding a <a id="_idIndexMarker142"/>new bookmark, we need to pass a URL for it. But, until now, we havenâ€™t checked whether the provided value is indeed a valid URL. Letâ€™s <span class="No-Break">fix this.</span></p>
			<p>The <strong class="source-inline">Option</strong> class allows us to configure a validator function. We will then add a validator method for <strong class="source-inline">urlOption</strong> to ensure it only gets <span class="No-Break">valid URLs.</span></p>
			<p>This can be achieved by calling the <strong class="source-inline">AddValidator</strong> method, <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
urlOption.AddValidator(result =&gt;
{
Â Â Â Â if (result.Tokens.Count == 0)
Â Â Â Â {
Â Â Â Â Â Â Â Â result.ErrorMessage = "The URL is required";
Â Â Â Â }
Â Â Â Â else if (!Uri.TryCreate(result.Tokens[0].Value, UriKind.Absolute, 
Â Â Â Â out _))
Â Â Â Â {
Â Â Â Â Â Â Â Â result.ErrorMessage = "The URL is invalid";
Â Â Â Â }
});</pre>			<p>In the preceding code snippet, the <strong class="source-inline">AddValidator</strong> method uses an inline delegate to ensure that the value provided to <strong class="source-inline">urlOption</strong> is valid. In this case, it ensures that it is actually present (thatâ€™s what the <strong class="source-inline">if</strong> section is checking) and that it is a valid URL (thatâ€™s what the <strong class="source-inline">else if</strong> section <span class="No-Break">is checking).</span></p>
			<p>So now, if we execute the <a id="_idIndexMarker143"/>program with both an invalid and a valid URL, we can see that it behaves <span class="No-Break">as expected:</span></p>
			<div>
				<div id="_idContainer076" class="IMG---Figure">
					<img src="image/B22400_05_11.jpg" alt="Figure 5.11 â€“ Validating the input value for the URL option"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.11 â€“ Validating the input value for the URL option</p>
			<p class="callout-heading">More advanced validation</p>
			<p class="callout">Validation could be more advanced than that. Our application is intended to collect bookmarks from everywhere on the web. However, if you would like to restrict its usage to, letâ€™s say, your organization only, you may want to check (in your validation process) that the bookmarked URLs are only referring to your corporate domain and dismiss <span class="No-Break">everything else.</span></p>
			<p>Perfect! So now, Bookmarkr allows us to manage bookmarks, ensuring that only valid information can be passed to (and stored in) the <span class="No-Break">CLI application.</span></p>
			<p>However, up to this point, we can still only add one bookmark at a time. Wouldnâ€™t it be nice if we could provide a set of names and URLs as part of the same request and have Bookmarkr add them in <span class="No-Break">one go?</span></p>
			<p><strong class="source-inline">System.CommandLine</strong> has <a id="_idIndexMarker144"/>a feature that allows us to do just <span class="No-Break">that </span><span class="No-Break">ðŸ˜‰</span><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-75"><a id="_idTextAnchor078"/>Adding multiple elements in one go</h2>
			<p>Letâ€™s try passing in<a id="_idIndexMarker145"/> multiple names and URLs to the same request, such <span class="No-Break">as this:</span></p>
			<pre class="source-code">
dotnet run link add --name 'Packt Publishing' --url 'https://packtpub.com/' --name 'Audi cars' --url 'https://audi.ca'</pre>			<p>But if we do this, we will get the <span class="No-Break">following error:</span></p>
			<div>
				<div id="_idContainer077" class="IMG---Figure">
					<img src="image/B22400_05_12.jpg" alt="Figure 5.12 â€“ Name and URL options expect only one value by default"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.12 â€“ Name and URL options expect only one value by default</p>
			<p>This is due to the arity of <span class="No-Break">these options.</span></p>
			<p><strong class="bold">What is an </strong><span class="No-Break"><strong class="bold">arity, anyway?</strong></span></p>
			<p>The arity<a id="_idIndexMarker146"/> of an option represents the number of values that can be passed if that option is specified. It is expressed with a minimum value and a <span class="No-Break">maximum value.</span></p>
			<p>This is of great importance if your CLI application supports bulk operations through one or many of its commands. In our example, we want to perform a bulk operation for adding multiple bookmarks at the <span class="No-Break">same time.</span></p>
			<p>In the case of an option of type <strong class="source-inline">string</strong>, the minimum and maximum values are both set to <strong class="source-inline">1</strong>, which means that if we specify the option, we must provide <span class="No-Break">a value.</span></p>
			<p>A Boolean option will have a minimum value of <strong class="source-inline">0</strong> and a maximum value of <strong class="source-inline">1</strong> since we donâ€™t need to pass in a value as both these syntaxes <span class="No-Break">are valid:</span></p>
			<pre class="source-code">
--force
-- force true</pre>			<p>In the same way, a list <a id="_idIndexMarker147"/>of elements has a minimum arity of 1 and a maximum of (by <span class="No-Break">default) 100,000.</span></p>
			<p>In order to specify the arity of an option, <strong class="source-inline">System.CommandLine</strong> provides an enumeration named <strong class="source-inline">ArgumentArity</strong>, which has <span class="No-Break">these values:</span></p>
			<ul>
				<li><strong class="source-inline">Zero</strong>, meaning no values are allowed. So, <strong class="source-inline">--force</strong> would be valid but not <strong class="source-inline">--</strong><span class="No-Break"><strong class="source-inline">force true</strong></span><span class="No-Break">.</span></li>
				<li><strong class="source-inline">ZeroOrOne</strong>, meaning a minimum of zero and a maximum of one value <span class="No-Break">is allowed.</span></li>
				<li><strong class="source-inline">ZeroOrMore</strong>, meaning either zero, one, or many values <span class="No-Break">are allowed.</span></li>
				<li><strong class="source-inline">ExactlyOne</strong>, meaning a minimum of one and a maximum of one value is allowed. This is the case for our string options, name, <span class="No-Break">and URL.</span></li>
				<li><strong class="source-inline">OneOrMore</strong>, meaning either one or multiple values <span class="No-Break">are allowed.</span></li>
			</ul>
			<p>To set the arity of an option, we can then use one of the values provided by the <strong class="source-inline">ArgumentArity</strong> enumeration, <span class="No-Break">like this:</span></p>
			<pre class="source-code">
nameOption.Arity = ArgumentArity.OneOrMore;</pre>			<p>So now, we should be able to provide multiple values for a given option. Letâ€™s <span class="No-Break">try this:</span></p>
			<div>
				<div id="_idContainer078" class="IMG---Figure">
					<img src="image/B22400_05_13.jpg" alt="Figure 5.13 â€“ Failing to provide multiple values for a given option"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.13 â€“ Failing to provide multiple values for a given option</p>
			<p>Oops, this is not what we <span class="No-Break">expected, right?</span></p>
			<p>The problem <a id="_idIndexMarker148"/>here is that even though <strong class="source-inline">nameOption</strong> can accept more than one value, it is not clear to the program how to convert those values into a single string. This is why the error message is referring to a custom binder (so it is told how to perform such <span class="No-Break">a conversion).</span></p>
			<p>In order to fix this problem, we need to tell the program to treat each of these inputs as a separate argument. This is done by setting the <strong class="source-inline">AllowMultipleArgumentsPerToken</strong> property to <strong class="source-inline">true</strong>, <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
nameOption.AllowMultipleArgumentsPerToken = true;</pre>			<p>Also, letâ€™s get rid of the arity for a moment by commenting out the corresponding line <span class="No-Break">of code.</span></p>
			<p>Now, if we run the program, we can see that the error is gone but we are still not getting the <span class="No-Break">expected resultâ€¦</span></p>
			<div>
				<div id="_idContainer079" class="IMG---Figure">
					<img src="image/B22400_05_14.jpg" alt="Figure 5.14 â€“ nameOption is now accepting multiple values"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.14 â€“ nameOption is now accepting multiple values</p>
			<p>Notice how only the last pair of names and URLs were considered and added to the list <span class="No-Break">of bookmarks.</span></p>
			<p>What happened, in fact, is that <strong class="source-inline">System.CommandLine</strong> noticed that we have two occurrences of the name and URL, so the last ones have overridden the first ones and only those last ones were actually passed to the <strong class="source-inline">Handler</strong> method. This is why we only get one bookmark added with the information of the last pair of names and <span class="No-Break">URL values.</span></p>
			<p>But what if we <a id="_idIndexMarker149"/>want to be able to pass a list of names and URLs and have the <strong class="source-inline">Handler</strong> method add as many bookmarks as the number of name and <span class="No-Break">URL pairs?</span></p>
			<p>To do this, we need two things. First, letâ€™s uncomment the lines of code that set the arities for <strong class="source-inline">nameOption</strong>, <strong class="source-inline">urlOption</strong>, <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">categoryOption</strong></span><span class="No-Break">.</span></p>
			<p>Next, letâ€™s change the declaration of the name, URL, and category options along with the validator and the signature of the <strong class="source-inline">Handler</strong> method so that they accept a list of strings rather than a <span class="No-Break">single string:</span></p>
			<pre class="source-code">
var nameOption = new Option&lt;string[]&gt;(
Â Â Â Â ["--name", "-n"], // equivalent to new string[] { "--name", "-n" }
Â Â Â Â Â "The name of the bookmark"
);
nameOption.IsRequired = true;
nameOption.Arity = ArgumentArity.OneOrMore;
nameOption.AllowMultipleArgumentsPerToken = true;
var urlOption = new Option&lt;string[]&gt;(
Â Â Â Â ["--url", "-u"],
Â Â Â Â "The URL of the bookmark"
);
urlOption.IsRequired = true;
urlOption.Arity = ArgumentArity.OneOrMore;
urlOption.AllowMultipleArgumentsPerToken = true;
urlOption.AddValidator(result =&gt;
{
Â Â Â Â foreach (var token in result.Tokens)
Â Â Â Â {
Â Â Â Â Â Â Â Â if (string.IsNullOrWhiteSpace(token.Value))
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â result.ErrorMessage = "URL cannot be empty";
Â Â Â Â Â Â Â Â Â Â Â Â break;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â else if (!Uri.TryCreate(token.Value, UriKind.Absolute, out _))
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â result.ErrorMessage = $"Invalid URL: {token.Value}";
Â Â Â Â Â Â Â Â Â Â Â Â break;
Â Â Â Â Â Â Â Â }
Â Â Â Â }
});
var categoryOption = new Option&lt;string[]&gt;(
Â Â Â Â ["--category", "-c"],
Â Â Â Â "The category to which the bookmark is associated"
);
categoryOption.Arity = ArgumentArity.OneOrMore;
categoryOption.AllowMultipleArgumentsPerToken = true;
categoryOption.SetDefaultValue("Read later");
categoryOption.FromAmong("Read later", "Tech books", "Cooking", "Social media");
categoryOption.AddCompletions("Read later", "Tech books", "Cooking", "Social media");
static void OnHandleAddLinkCommand(string[] names, string[] urls, string[] categories)
{
Â Â Â Â service.AddLinks(names, urls, categories);
Â Â Â Â service.ListAll();
}</pre>			<p>Now, if we run <a id="_idIndexMarker150"/>the program, things work (finally) as <span class="No-Break">expected! </span><span class="No-Break">ðŸ˜Š</span></p>
			<div>
				<div id="_idContainer080" class="IMG---Figure">
					<img src="image/B22400_05_15.jpg" alt="Figure 5.15 â€“ Bookmarkr accepts a list of bookmarks"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.15 â€“ Bookmarkr accepts a list of bookmarks</p>
			<p>Since each option accepts multiple values, letâ€™s take a look at whether we can simplify the following <span class="No-Break">CLI request:</span></p>
			<pre class="console">
$ dotnet run link add --name 'Packt Publishing' --url 'https://packtpub.com/' --category 'Tech books' --name 'Audi cars' --url 'https://audi.ca' --category 'Read later'</pre>			<p>Weâ€™ll simplify it <span class="No-Break">as follows:</span></p>
			<pre class="console">
$ dotnet run link add --name 'Packt Publishing' 'Audi cars' --url 'https://packtpub.com/' 'https://audi.ca' --category 'Tech books' 'Read later'</pre>			<p>Notice that we <a id="_idIndexMarker151"/>only need to specify <strong class="source-inline">--name</strong>, <strong class="source-inline">--url</strong>, and <strong class="source-inline">--</strong><span class="No-Break"><strong class="source-inline">category</strong></span><span class="No-Break"> once.</span></p>
			<p>Since both CLI requests are equivalent, they lead to the <span class="No-Break">same result:</span></p>
			<div>
				<div id="_idContainer081" class="IMG---Figure">
					<img src="image/B22400_05_16.jpg" alt="Figure 5.16 â€“ Simplified CLI request"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.16 â€“ Simplified CLI request</p>
			<p>Excellent! This works <span class="No-Break">just great!</span></p>
			<p>Butâ€¦ typing a list of names, URLs, and categories might quickly become tedious as the <span class="No-Break">list grows.</span></p>
			<p>Wouldnâ€™t it be nice if we could simply provide the path to a file as a parameter that contains all the names, URLs, and categories and let the application read that file and create the <span class="No-Break">bookmarks accordingly?</span></p>
			<p>In the same<a id="_idIndexMarker152"/> way, wouldnâ€™t it be nice if we could specify the path to an output file to store all the bookmarks our CLI application <span class="No-Break">is holding?</span></p>
			<h1 id="_idParaDest-76"><a id="_idTextAnchor079"/>Working with files passed in as options values</h1>
			<p>Files <a id="_idIndexMarker153"/>can be provided as options values to serve as input or <span class="No-Break">output parameters.</span></p>
			<p>As an input parameter, a fileâ€™s content can be read to import data into the CLI application. In our case, we could import bookmarks from other browsers, such as Chrome or Firefox, <span class="No-Break">into Bookmarkr.</span></p>
			<p>As an output parameter, a file can be created to export the data that is held by Bookmarkr, which in turn can be imported into other browsers, such as Chrome <span class="No-Break">or Firefox.</span></p>
			<p>Together, these two capabilities can enable backup and restore but also data sharing and <span class="No-Break">exchange scenarios.</span></p>
			<p>Letâ€™s build these features<a id="_idIndexMarker154"/> <span class="No-Break">into Bookmarkr!</span></p>
			<p class="callout-heading">Important note</p>
			<p class="callout">Browsers, such as Chrome or Firefox, have their own proprietary structure to import and <span class="No-Break">export bookmarks.</span></p>
			<p class="callout">We wonâ€™t be performing parsing or conversion to these formats for the sake of simplicity. Our goal is to focus on working with input and output files as part of a CLI application. We will, however, import and export bookmarks in <span class="No-Break">JSON format.</span></p>
			<p>Letâ€™s begin with the <span class="No-Break"><strong class="source-inline">export</strong></span><span class="No-Break"> command.</span></p>
			<p>This command is meant to take all bookmarks managed by Bookmarkr and save them in a JSON file whose path is specified as a value to the <strong class="source-inline">--file</strong> option. This option is, of <span class="No-Break">course, required.</span></p>
			<p>First, we will need to create an option of type <strong class="source-inline">FileInfo</strong>, and it will <span class="No-Break">be required:</span></p>
			<pre class="source-code">
var outputfileOption = new Option&lt;FileInfo&gt;(
Â Â Â Â ["--file", "-f"],
Â Â Â Â "The output file that will store the bookmarks"
)
{
Â Â Â Â IsRequired = true
};</pre>			<p>Next, we will need to create a new command and add it to the <span class="No-Break"><strong class="source-inline">root</strong></span><span class="No-Break"> command:</span></p>
			<pre class="source-code">
var exportCommand = new Command("export", "Exports all bookmarks to a file")
{
Â Â Â Â outputfileOption
};
rootCommand.AddCommand(exportCommand);</pre>			<p>Then, we need to set a <strong class="source-inline">Handler</strong> method for the <span class="No-Break"><strong class="source-inline">export</strong></span><span class="No-Break"> command:</span></p>
			<pre class="source-code">
exportCommand.SetHandler(OnExportCommand, outputfileOption);
static void OnExportCommand(FileInfo outputfile)
{
Â Â Â Â var bookmarks = service.GetAll();
Â Â Â Â string json = JsonSerializer.Serialize(bookmarks, new 
Â Â Â Â JsonSerializerOptions { WriteIndented = true });
Â Â Â Â File.WriteAllText(outputfile.FullName, json);
}</pre>			<p>The <strong class="source-inline">Handler</strong> method calls <strong class="source-inline">BookmarkService</strong> to get the list of all bookmarks, then converts them to JSON and saves that JSON content into the provided<a id="_idIndexMarker155"/> file. If the file already exists, it <span class="No-Break">is overwritten.</span></p>
			<p>Note that youâ€™ll need to import this namespace for the code <span class="No-Break">to compile:</span></p>
			<pre class="source-code">
using System.Text.Json;</pre>			<p>Now, letâ€™s try it and see whether it works <span class="No-Break">as expected!</span></p>
			<div>
				<div id="_idContainer082" class="IMG---Figure">
					<img src="image/B22400_05_17.jpg" alt="Figure 5.17 â€“ Exporting all bookmarks"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.17 â€“ Exporting all bookmarks</p>
			<p>Perfect! This is exactly what <span class="No-Break">we expected!</span></p>
			<p>But how can we ensure that the provided file has a <span class="No-Break">valid name?</span></p>
			<p>We could certainly create a validator<a id="_idIndexMarker156"/> method to check this, but <strong class="source-inline">System.CommandLine</strong> already provides an extension method for that matter (and I wanted to let you <span class="No-Break">know </span><span class="No-Break">ðŸ˜‰</span><span class="No-Break">):</span></p>
			<pre class="source-code">
outputfileOption.LegalFileNamesOnly();</pre>			<p>Letâ€™s try calling the <strong class="source-inline">export</strong> command with an <span class="No-Break">invalid file:</span></p>
			<div>
				<div id="_idContainer083" class="IMG---Figure">
					<img src="image/B22400_05_18.jpg" alt="Figure 5.18 â€“ Handling invalid files"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.18 â€“ Handling invalid files</p>
			<p>See? That error has been raised<a id="_idIndexMarker157"/> because of the call to the <span class="No-Break"><strong class="source-inline">LegalFileNamesOnly</strong></span><span class="No-Break"> method.</span></p>
			<p>Okay! Now letâ€™s move on to adding the <span class="No-Break"><strong class="source-inline">import</strong></span><span class="No-Break"> command!</span></p>
			<p>As a reminder, the syntax to import bookmark data from an existing file is <span class="No-Break">as follows:</span></p>
			<pre class="console">
$ bookmarkr import --file &lt;path to the input file&gt;</pre>			<p>Since many of the steps involved are very similar to the ones we followed to create the <strong class="source-inline">export</strong> command, letâ€™s just share the code here and discuss <span class="No-Break">the differences:</span></p>
			<pre class="source-code">
var inputfileOption = new Option&lt;FileInfo&gt;(
Â Â Â Â ["--file", "-f"],
Â Â Â Â "The input file that contains the bookmarks to be imported"
)
{
Â Â Â Â IsRequired = true
};
inputfileOption.LegalFileNamesOnly();
inputfileOption.ExistingOnly();
var importCommand = new Command("import", "Imports all bookmarks from a file")
{
Â Â Â Â inputfileOption
};
rootCommand.AddCommand(importCommand);
importCommand.SetHandler(OnImportCommand, inputfileOption);
static void OnImportCommand(FileInfo inputfile)
{
Â Â Â Â string json = File.ReadAllText(inputfile.FullName);
Â Â Â Â List&lt;Bookmark&gt; bookmarks = JsonSerializer.
Â Â Â Â Deserialize&lt;List&lt;Bookmark&gt;&gt;(json) ?? new List&lt;Bookmark&gt;();
Â Â Â Â service.Import(bookmarks);
}</pre>			<p>The main difference is the call to the <strong class="source-inline">ExistingOnly</strong> method. This method ensures that <strong class="source-inline">inputfileOption</strong> will only accept values corresponding to existing files, otherwise an error <span class="No-Break">is raised.</span></p>
			<p>The other difference is how the <strong class="source-inline">OnImportCommand</strong> handler method operates: it reads the content of the file, converts it from JSON to a list of items of type <strong class="source-inline">Bookmark</strong>, and then<a id="_idIndexMarker158"/> passes it to <strong class="source-inline">BookmarkService</strong> to add these items to the list of bookmarks it manages (by calling its <span class="No-Break"><strong class="source-inline">Import</strong></span><span class="No-Break"> method).</span></p>
			<p>Now, letâ€™s try <span class="No-Break">this code!</span></p>
			<div>
				<div id="_idContainer084" class="IMG---Figure">
					<img src="image/B22400_05_19.jpg" alt="Figure 5.19 â€“ Importing bookmarks from a file"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.19 â€“ Importing bookmarks from a file</p>
			<p>What happens if the file <span class="No-Break">doesnâ€™t exist?</span></p>
			<div>
				<div id="_idContainer085" class="IMG---Figure">
					<img src="image/B22400_05_20.jpg" alt="Figure 5.20 â€“ Handling a non-existent file"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.20 â€“ Handling a non-existent file</p>
			<p>Once <a id="_idIndexMarker159"/>again, we can see that we are getting the expected <span class="No-Break">result! </span><span class="No-Break">ðŸ˜Š</span></p>
			<p>And thatâ€™s a wrap! You now know how to work with input and output files in your CLI applications. Congratulations! Letâ€™s now conclude <span class="No-Break">this chapter.</span></p>
			<h1 id="_idParaDest-77"><a id="_idTextAnchor080"/>Summary</h1>
			<p>In this chapter, we improved our CLI application, Bookmarkr, by adding better control for the input values for its commandâ€™s options (by explicitly indicating what options are required, setting default values where appropriate, designing validators to ensure the input values comply with the expected type, format, or range of values, and enabling auto-completion to make things simpler for <span class="No-Break">the user).</span></p>
			<p>We also added the ability to import and export application data from and to a file. This makes it easier to back up and restore data and even share <span class="No-Break">it offline.</span></p>
			<p>In the upcoming chapter, we will see how to implement a very important feature in every application: logging and <span class="No-Break">error handling.</span></p>
			<h1 id="_idParaDest-78"><a id="_idTextAnchor081"/>Your turn!</h1>
			<p>Following along with the provided code is a great way to learn <span class="No-Break">through practice.</span></p>
			<p>A better way is by challenging yourself to achieve tasks. Hence, I challenge you to improve the Bookmarkr application by adding the <span class="No-Break">following features.</span></p>
			<h2 id="_idParaDest-79"><a id="_idTextAnchor082"/>Task #1 â€“ validating the format and the ability to access the input file</h2>
			<p> As a reminder, the syntax to import bookmark data from an existing file is <span class="No-Break">as follows:</span></p>
			<pre class="console">
$ bookmarkr import --file &lt;path to the input file&gt;</pre>			<p>If the input file cannot be accessed, or if its data is not in the expected format, then the application should display a corresponding error message to the user. Otherwise, the application should import all the bookmarks from the input file and display a success message to the user indicating how many bookmarks have <span class="No-Break">been imported.</span></p>
			<h2 id="_idParaDest-80"><a id="_idTextAnchor083"/>Task #2 â€“ merging existing links from the input file</h2>
			<p>When importing bookmarks from an existing file, it is possible that some of them already exist in the bookmarks held by <span class="No-Break">the application.</span></p>
			<p>In such a situation, it is a best practice for a CLI application to provide the user with an option to control whether they want to merge those existing links or simply discard them and not <span class="No-Break">import them.</span></p>
			<p>In this task, I challenge you to implement this best practice by adding an optional <strong class="source-inline">--merge</strong> option to the <span class="No-Break"><strong class="source-inline">import</strong></span><span class="No-Break"> command.</span></p>
			<p>Hence, the syntax for the <strong class="source-inline">import</strong> command with the <strong class="source-inline">--merge</strong> option will be <span class="No-Break">as follows:</span></p>
			<pre class="console">
$ bookmarkr import --file &lt;path to the input file&gt; --merge</pre>			<p>When the <strong class="source-inline">--merge</strong> option is specified, the expected behavior of the <strong class="source-inline">import</strong> command is that for each bookmark in the provided input file, the <span class="No-Break">following apply:</span></p>
			<ul>
				<li>If its URL already exists in the list of bookmarks held by the application, the name of the existing bookmark should be updated with the name corresponding to this URL in the <span class="No-Break">input file</span></li>
				<li>Otherwise, the bookmark should simply be added to the list of bookmarks held by <span class="No-Break">the application</span></li>
			</ul>
		</div>
	</body></html>