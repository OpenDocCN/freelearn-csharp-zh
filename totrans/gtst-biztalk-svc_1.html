<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Hello BizTalk Services</h1></div></div></div><p>As companies build and extend their IT information assets, there is a need to integrate applications to exchange data. While a point-to-point application integration using custom code is possible, it does not address large-scale application integrations without duplication of data and the complexity of managing such an integration. BizTalk is a de facto choice for message-based integration for on-premises systems and for services on Azure for both applications and businesses.</p><p>In this book, we're going to introduce you to BizTalk Services, Microsoft's new integration middleware hosted on Windows Azure. This book assumes that you already understand the need for integration and the many benefits of using specialist integration software as opposed to building custom point-to-point integration solutions. We will look at why cloud-hosted integration services are so compelling and the scenarios in which these services make most sense. Prior knowledge of BizTalk Server is not expected, though it will help you to quickly understand certain topics within the book. We will assume you are a professional developer, an architect, or a solution designer familiar with the challenges of integrating heterogeneous systems and applications. The book also assumes familiarity of the Microsoft developer toolset, specifically .NET, Visual Studio, and SQL.</p><p>In this chapter, we will start to answer some fundamental questions around what BizTalk Services is and how it can help you to build integration solutions. Specifically, the following topics will be discussed:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The business and technical drivers for BizTalk Services on Azure</li><li class="listitem" style="list-style-type: disc">Concepts and architecture of BizTalk Services</li><li class="listitem" style="list-style-type: disc">Using BizTalk Services to realize a simple purchase order scenario</li></ul></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Background</h1></div></div></div><p>First<a id="id0" class="indexterm"/> though, some background is necessary. At the <strong>Professional </strong><a id="id1" class="indexterm"/>
<strong>Developers Conference</strong> (<strong>PDC</strong>) 2008, Microsoft unveiled Windows Azure—a new operating system designed for the cloud. Over the subsequent years, Windows Azure has become Microsoft's de facto cloud platform covering services, media, websites, mobile applications, and more. While BizTalk Server has been an established product for over ten years (and eight releases), cloud adoption has been driving connected systems across different services and Line-of-Business applications. To meet the growing demand for cloud-based integration, the Microsoft BizTalk team released the first version of BizTalk Services, named Service Bus EAI and EDI Labs Community Technology Preview (CTP) on December 17, 2011. The goal was for customers to be <a id="id2" class="indexterm"/>able to sign up in a shared environment and set up simple XML/EDI flows without worrying about installation and maintenance. The capabilities were rich enough to enable simple point-to-point integration scenarios; on April 9th of the following year, the CTP was refreshed, incorporating feedback from customers by providing additional capabilities.</p><p>The CTP environment was hosted on a publicly shared service, and therefore had restrictions on running users' custom code. Integration is rarely straightforward, and the ability for developers to write custom code and deploy it as part of their integration solutions was a key requirement. Customers had also needed guarantees around performance and Service Level Agreements (SLAs). Hosting user assemblies as part of the cloud services became a reality by switching to per tenant deployment. Thus, the cloud offering known as BizTalk Services was born on June 3, 2013. Like many Azure services, BizTalk Services is expected to be updated at a regular cadence. The latest update as of this writing was on February 20, 2014. This technology is opening up new integration possibilities; with Microsoft's on-going investments, it will be on par with the capabilities of its on-premises cousin, BizTalk Server, in the near future.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Business drivers</h1></div></div></div><p>There are <a id="id3" class="indexterm"/>many tangible benefits of building solutions <a id="id4" class="indexterm"/>on Azure today. A few of these include the ability to scale up/down the platform based on predictable or dynamic shifts in application load and throughput requirements without worrying about the hardware procurement time and setup, the ability to pay as you go with expense incurred as an Operational Expenditure (OpEx) instead of a Capital Expenditure (CapEx), and the increase in reach for certain integration scenarios.</p><p>Specific to <a id="id5" class="indexterm"/>integration on Azure, there are four factors that drive adoption:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Focus on business operations, not IT</strong>: There are business benefits in terms of reduced cost by leveraging platforms running under economy of scale, making it cheaper for customers to obtain them with higher quality of services. The need of the hour is to simplify IT deployment and management and focus on business services instead of configuring software or hardware.</li><li class="listitem" style="list-style-type: disc"><strong>Simplicity of managing externally facing services</strong>: Enterprises typically offer services across geographic and organizational boundaries. Many of these<a id="id6" class="indexterm"/> services require making changes to the corporate firewall to allow or deny the applications. This process is an IT nightmare for many organizations. With Azure integration services such<a id="id7" class="indexterm"/> as B2B, which inherently require<a id="id8" class="indexterm"/> external communication, all this could be moved to the cloud and the necessary access and control policies could then be centralized for all internal services. This also enables self-service configuration changes to the application, thereby dramatically improving responsiveness to business changes.</li><li class="listitem" style="list-style-type: disc"><strong>Greenfield cloud applications</strong>: The proliferation of mobile devices, such as smartphones and tablets as well as Point-of-Sale (POS) systems, has given rise to services that are inherently cloud based. Think of a POS that transmits daily transaction logs to its backend Line-of-Business systems or an RFID service that transmits information about each item in a shopping cart purchased in a retail store to an inventory application. As new services are being rolled out, organizations want to be able to develop and deploy these services with shorter time-to-market using Azure.</li><li class="listitem" style="list-style-type: disc">Another factor to consider for the cloud is to leverage existing on-premises investments. Businesses have invested in a variety of on-premises systems, including traditional ERP as well as legacy mainframes and other bespoke systems that literally run the business.</li></ul></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Technical drivers</h1></div></div></div><p>The primary<a id="id9" class="indexterm"/> technical goal for BizTalk<a id="id10" class="indexterm"/> Services is to reduce the impedance mismatch between source and destination systems that are exchanging information. Such impedance can be at different levels:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Transport protocol impedance</strong>: The source might send messages over one transport (say FTP) and the destination may only accept messages over another transport (say POP3). It could also be the case that messages are sent from one LOB to another, for example, one end is sending messages from the Sales Force adapter while the other end is accepting messages via the SAP adapter. BizTalk Services provides the notion of adapters to resolve this impedance.</li><li class="listitem" style="list-style-type: disc"><strong>Application protocol impedance</strong>: The source might send EDIFACT messages while the destination may only accept messages in XML. BizTalk Services provides native support to protocols such as X12, EDIFACT, and flat files to resolve this impedance.</li><li class="listitem" style="list-style-type: disc"><strong>Format impedance</strong>: The source might send messages in one XML format while the<a id="id11" class="indexterm"/> destination may only accept messages in another XML format. BizTalk Services provides transforms to resolve this impedance.</li><li class="listitem" style="list-style-type: disc"><strong>Timing impedance</strong>: The source can send messages any time of the day, but the destination only accepts messages between 4 and 7 P.M. The source can send messages twice as fast as the destination can process them.</li><li class="listitem" style="list-style-type: disc"><strong>Size impedance</strong>: The source can send messages of any size, but the destination can accept messages of 1 MB at most.</li></ul></div><p>BizTalk<a id="id12" class="indexterm"/> Services provides connectivity to Service Bus, batching and debatching to resolve the last two impedances.</p></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Core scenarios</h1></div></div></div><p>The <a id="id13" class="indexterm"/>aforementioned drivers have resulted in three core <a id="id14" class="indexterm"/>scenarios for BizTalk Services:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Enterprise Application Integration</strong>: These are primarily messaging scenarios with flat file or XML-based data that are between two or more applications, atleast one of which is running in the cloud. A good example would be a travel portal connected to the ticketing systems of multiple airlines.</li><li class="listitem" style="list-style-type: disc"><strong>Business-to-Business Integration</strong>: These are messaging scenarios with structured flat file/XML between two organizations. An example would be an IT company procuring hardware from vendors such as HP, Dell, or Lenovo.</li><li class="listitem" style="list-style-type: disc"><strong>Connectivity with Hybrid Applications</strong>: These are messaging scenarios between Azure and on-premises applications. An example here would be connecting a Salesforce application to a SAP application running in your internal IT environment.</li></ul></div><p>We will look at these scenarios in detail in separate chapters of this book.</p></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Concepts</h1></div></div></div><p>The following figure illustrates a basic integration flow from an FTP source to a LOB destination. BizTalk Services, represented by the middle box, is a sequence of processing steps.</p><div><img src="img/7401EN_01_01.jpg" alt="Concepts"/><div><p>Role of BizTalk Services</p></div></div><p>BizTalk <a id="id15" class="indexterm"/>Services introduces several key concepts to facilitate building integration solutions on Azure:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Bridge</strong>: A bridge<a id="id16" class="indexterm"/> is a unit of processing in BizTalk Services<a id="id17" class="indexterm"/> that can address impedance mismatch. It contains three units: one or more source locations (for example, FTP) to read messages from, a pipeline to process the message, and one or more destinations (for example, Queue) to write the processed messages. The pipeline is divided into distinct processing units called stages, each with its own function (for example, a stage in a pipeline can validate a message against a schema). A series of stages represents the bridge pattern or bridge template. Out of the-box, BizTalk Services v1 ships with three templates: XML, EDI, and AS2.</li><li class="listitem" style="list-style-type: disc"><strong>Adapter</strong>: An adapter<a id="id18" class="indexterm"/> is the transport medium<a id="id19" class="indexterm"/> that can send messages (to a destination) or receive messages (from a source) and pass them to the pipeline in a bridge; for example, Line-of-Business adapters such as SAP and Oracle EBS or transport adapters such as FTP and SFTP.</li><li class="listitem" style="list-style-type: disc"><strong>Transform</strong>: A transform<a id="id20" class="indexterm"/> converts a message from <a id="id21" class="indexterm"/>one format into another, aiding structural conversion. Transforms contain operations that can perform commonly used transformations like string operations, loop constructs, list operations, and arithmetic and logical expressions.</li><li class="listitem" style="list-style-type: disc"><strong>Application protocol</strong>: A protocol <a id="id22" class="indexterm"/>defines<a id="id23" class="indexterm"/> the message format and processing semantics such as the requirement to send and correlate acknowledgements of messages.</li><li class="listitem" style="list-style-type: disc"><strong>Route</strong>: A route<a id="id24" class="indexterm"/> defines the destination endpoint<a id="id25" class="indexterm"/> where the message will be sent based on the specified criteria. The route criteria are evaluated based on SQL-92 expression syntax.</li><li class="listitem" style="list-style-type: disc"><strong>Batching</strong>: The aggregation of messages based on selection criteria is termed batching. The release (sending) of a batch is governed by size, count, or time, or a combination of these parameters.</li><li class="listitem" style="list-style-type: disc"><strong>Promoted properties</strong>: Promoted properties are name-value pairs, where the name is user-defined and the value is derived from the message header, message body, or<a id="id26" class="indexterm"/> from the context within the bridge. Promoted properties are commonly used in batching and routing to specify their criteria.</li><li class="listitem" style="list-style-type: disc"><strong>Artifact</strong>: An artifact<a id="id27" class="indexterm"/> is anything that aids in<a id="id28" class="indexterm"/> the processing of the message in the bridge. XML schemas, maps, custom assemblies, and certificates are the artifacts used in XML and EDI bridges. In BizTalk Services, each artifact is stored in the artifact store and is addressable by a unique URL.</li></ul></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec13"/>Life cycle and architecture</h1></div></div></div><p>Unlike most other Azure services deployments, BizTalk Services provisions dedicated <a id="id29" class="indexterm"/>resources for storage and compute instances that are isolated<a id="id30" class="indexterm"/> across tenants. This means that no two deployments have anything in common between them. The advantage is that you can write any custom code and be assured that you cannot impact the performance or availability of other deployments. This dedicated deployment also offers isolation of data at the storage level, thus increasing the privacy of data and SLA of the service.</p><p>Broadly categorizing, there are three steps to go through before you can have an active usable deployment. The first is to provision the service using standard Azure tools, including the Azure portal to create the service; the second is to deploy the necessary artifacts and configuration outlined in the <em>BizTalk Services concepts</em> section using Visual Studio and the BizTalk Services portal; and the third is sending or receiving the messages.</p><p>The architecture of BizTalk Services contains three key components:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Provisioning services</strong>: This is a set of Microsoft services that manage the lifecycle of a BizTalk Services deployment as well as monitor its health. It also includes components to bill the end user based on usage of BizTalk Services. The <a id="id31" class="indexterm"/>management <a id="id32" class="indexterm"/>interface to the service is exposed via the <strong>Red Dog Front End</strong> (<strong>RDFE</strong>)<a id="id33" class="indexterm"/> public API. The Azure Management Portal or PowerShell scripts from the user go via the RDFE API. Using the service, you can scale up/down your deployment as well as back up and restore deployment across datacenters.<div><div><h3 class="title"><a id="note02"/>Note</h3><p>Red Dog<a id="id34" class="indexterm"/> was the <a id="id35" class="indexterm"/>original codename for Azure, with the "FE" being the publicly accessible frontend that users directly interact with either via the Azure portal or service management APIs.</p></div></div></li><li class="listitem" style="list-style-type: disc"><strong>Per tenant BizTalk Services</strong>: This is the per tenant deployment that is created<a id="id36" class="indexterm"/> in the user's Azure subscription. A BizTalk <a id="id37" class="indexterm"/>Services deployment is identified by the deployment name and is accessible using the URL secured by the Access Control Service (ACS). All artifacts such as bridges and schemas are added into the deployment with a URL which is a sub-path of the deployment URL. For example, a bridge is added under <code class="literal">&lt;deployment URL&gt;/default/&lt;bridgeName&gt;</code>. Here default is the namespace name where the artifacts are grouped into.</li><li class="listitem" style="list-style-type: disc"><strong>Per tenant dependencies</strong>: These dependencies are the Azure services required <a id="id38" class="indexterm"/>for tracking, troubleshooting, and security. For<a id="id39" class="indexterm"/> example, BizTalk Services provides a tracking store, which is an Azure SQL database where the processing status of messages, along with related properties, are stored as the messages pass through a bridge. The information from the tracking store is shown in the BizTalk Services portal tracking view. Archiving and monitoring is stored in Azure storage blobs and tables. Archived messages are stored in blob containers based on the date of the archive. The storage also contains the Azure table WADLogsTable, where tracing information for a bridge can be obtained. Finally, Access Control Service regulates access to all endpoints in the deployment. During deployment creation, the provisioning service uses the Management Service credentials to programmatically access ACS to create a relying party for the BizTalk Services deployment, add rule groups for Send, Listen, and Manage claims, and create the service identity with the necessary passwords for directly talking to ACS for deployment of the artifacts. The interaction between these components is illustrated in the following figure:<div><img src="img/7401EN_01_02.jpg" alt="Life cycle and architecture"/><div><p>Block diagram of BizTalk Services shared and per tenant services</p></div></div></li></ul></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec14"/>Personas and tools</h1></div></div></div><p>BizTalk Services provides different user experiences for different personas to facilitate an optimized, task-based approach. The principal personas are:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Persona</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Primary Tools</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<img src="img/7401EN_01_03.jpg" alt="Personas and tools"/>
<p>Developer</p>
</td><td style="text-align: left" valign="top">
<p>Someone who<a id="id40" class="indexterm"/> creates integration<a id="id41" class="indexterm"/> solutions and artifacts, such as transforms and schemas</p>
</td><td style="text-align: left" valign="top">
<p>Visual Studio</p>
</td></tr><tr><td style="text-align: left" valign="top">
<img src="img/7401EN_01_03.jpg" alt="Personas and tools"/>
<p>IT Pro</p>
</td><td style="text-align: left" valign="top">
<p>Someone who <a id="id42" class="indexterm"/>manages <a id="id43" class="indexterm"/>the environment, including tasks such as deployment, setup, and configuration</p>
</td><td style="text-align: left" valign="top">
<p>Azure Portal and dashboard</p>
</td></tr><tr><td style="text-align: left" valign="top">
<img src="img/7401EN_01_03.jpg" alt="Personas and tools"/>
<p>Partner Administrator</p>
</td><td style="text-align: left" valign="top">
<p>Someone<a id="id44" class="indexterm"/> who sets up and<a id="id45" class="indexterm"/> manages trading partners</p>
</td><td style="text-align: left" valign="top">
<p>Trading partner/BizTalk portal</p>
</td></tr></tbody></table></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Developer</h2></div></div></div><p>A developer<a id="id46" class="indexterm"/> will typically focus on creating solutions using<a id="id47" class="indexterm"/> Visual Studio. BizTalk Services VS 2012 project templates are provided to enable rapid creation of both EAI and EDI solutions. These provide a graphical work surface on which to create and configure bridges to facilitate communication between an enterprise and its trading partners. Additionally, sophisticated tools are provided, including a graphical mapping interface and schema editors.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec09"/>IT Pro</h2></div></div></div><p>The Windows<a id="id48" class="indexterm"/> Azure Platform Management Portal provides <a id="id49" class="indexterm"/>access to create the BizTalk Services deployment and management tasks as well as at-a-glance status information providing details on the overall health of all deployments and accounts. In addition to services deployment, the Windows Azure Platform Management Portal provides an interface for provisioning Azure SQL databases, mobile services, Service Bus entities, and so on.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec10"/>Partner Administrator</h2></div></div></div><p>The <a id="id50" class="indexterm"/>Partner Administrator persona uses the BizTalk<a id="id51" class="indexterm"/> Services portal for a number of management functions such as the creation and administration of trading partners, configuration of agreements including required transformations, routing and acknowledgements, tracking of messages, and exception processing.</p><p>The BizTalk Services portal enables the creation of trading partners and agreements between them. This enables the setting up and management of the protocols used to exchange data (for example, X12 and AS2) and the message formats to use together with transformation and routing capabilities. In this way, trading partners can be onboarded and configured quickly and easily by non-IT personnel without the use of developer tools such as Visual Studio, all through the web-based portal.</p><p>In addition, the management portal also provides the ability to set and view tracking data on message flows, including both contextual details (sender, message type, and so on) as well as the<a id="id52" class="indexterm"/> message bodies themselves. The ability to<a id="id53" class="indexterm"/> archive and export message data is also provided as part of the service.</p><p>Additionally, RESTful APIs are implemented to provide full fidelity with the portal, enabling activities to be scripted and deployment to be automated. Additionally, integration with customer systems and tools such as SharePoint for tracking data, visualization, or on-premises storage is also possible using this API.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec15"/>Deployment considerations</h1></div></div></div><p>You will <a id="id54" class="indexterm"/>need to consider the BizTalk Services edition required for your production use as well as the environment for test and/or staging purposes. This depends on decision points such as:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Expected message load on the target system</li><li class="listitem" style="list-style-type: disc">Capabilities that are required now versus 6 months down the line</li><li class="listitem" style="list-style-type: disc">IT requirements around compliance, security, and DR</li></ul></div><p>The list of capabilities across different editions is outlined in the Windows Azure documentation<a id="id55" class="indexterm"/> page at <a class="ulink" href="http://www.windowsazure.com/en-us/documentation/articles/biztalk-editions-feature-chart">http://www.windowsazure.com/en-us/documentation/articles/biztalk-editions-feature-chart</a>.</p><div><div><h3 class="title"><a id="note03"/>Note</h3><p><strong>Note on BizTalk Services editions and signup</strong></p><p>BizTalk Services is currently available in four editions: Developer, Basic, Standard, and Premium, each with varying capabilities and prices. You can sign up for BizTalk Services from the Azure portal. The Developer SKU contains all features needed to try and evaluate without worrying about production readiness. We use the Developer edition for all examples in this book.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec16"/>Provisioning BizTalk Services</h1></div></div></div><p>BizTalk <a id="id56" class="indexterm"/>Services deployment can be created using the Windows Azure Management Portal or using PowerShell. We will use the former in this example.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Certificates and ACS</h2></div></div></div><p>Certificates<a id="id57" class="indexterm"/> are required for communication<a id="id58" class="indexterm"/> using SSL, and Access Control Service is used to secure<a id="id59" class="indexterm"/> the endpoints of the BizTalk Services<a id="id60" class="indexterm"/> deployment. First, you need to know whether you need a custom domain for the BizTalk Services deployment. In the case of test or developer deployments, the answer is mostly no. A BizTalk Services deployment will autogenerate a self-signed certificate with an expiry of close to 5 years. The ACS required for deployment will also be autocreated. Certificate and Access Control Service details are required for sending messages to bridges and agreements and can be retrieved from the Dashboard page post deployment.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec12"/>Storage requirements</h2></div></div></div><p>You <a id="id61" class="indexterm"/>need to create an Azure <a id="id62" class="indexterm"/>SQL database for tracking data. It is recommended to use the Business edition with the appropriate size; for test purposes, you can start with the 1 GB Web edition. You also need to pass the storage account credentials to archive message data. It is recommended that you create a new Azure SQL database and Storage account for use with BizTalk Services only.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec13"/>The BizTalk Services create wizard</h2></div></div></div><p>Now<a id="id63" class="indexterm"/> that we have the security <a id="id64" class="indexterm"/>and storage details figured out, let us create a BizTalk Services deployment from the Azure Management Portal:</p><div><ol class="orderedlist arabic"><li class="listitem">From the Management portal, navigate to <strong>New</strong> | <strong>App Services</strong> | <strong>BizTalk Service</strong> | <strong>Custom Create</strong>.</li><li class="listitem">Enter a unique name for the deployment, keeping the following values—<strong>EDITION</strong>: <strong>Developer</strong>, <strong>REGION</strong>: <strong>East US</strong>, <strong>TRACKING DATABASE</strong>: <strong>Create a new SQL Database instance</strong>.</li><li class="listitem">In the next page, retain the default database name, choose the SQL server, and enter the server login name and password.<div><div><h3 class="title"><a id="note04"/>Note</h3><p>As of writing this book, there can be six SQL server instances per Azure subscription.</p></div></div></li><li class="listitem">In the next page, choose the storage account for archiving and monitoring information.</li><li class="listitem">Deploy the solution.</li></ol></div><div><img src="img/7401EN_01_04.jpg" alt="The BizTalk Services create wizard"/><div><p>The BizTalk Services create wizard from Windows Azure Management Portal</p></div></div><p>The<a id="id65" class="indexterm"/> deployment takes roughly 30 minutes<a id="id66" class="indexterm"/> to complete. After completion, you will see the status of the deployment as Active. Navigate to the deployment dashboard page; click on <strong>CONNECTION INFORMATION</strong> and note down the ACS credentials and download the deployment SSL certificate. The SSL certificate needs to be installed on the client machine where the Visual Studio SDK will be used.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec14"/>BizTalk portal registration</h2></div></div></div><p>We have <a id="id67" class="indexterm"/>one step remaining, and <a id="id68" class="indexterm"/>that is to configure the BizTalk Services Management portal to view agreements, bridges, and their tracking data. For this, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Click on <strong>Manage</strong> from the Dashboard screen.</li><li class="listitem">This will launch <code class="literal">&lt;mydeployment&gt;.portal.biztalk.windows.net</code>, where the BizTalk Portal is hosted.</li><li class="listitem">Some of the fields, such as the user's live ID and deployment name, will be auto-populated.</li><li class="listitem">Enter<a id="id69" class="indexterm"/> the <strong>ACS Issuer name</strong> and <strong>ACS Issuer secret</strong> noted in the previous step and click <a id="id70" class="indexterm"/>on <strong>Register</strong>.</li></ol></div><div><img src="img/7401EN_01_05.jpg" alt="BizTalk portal registration"/><div><p>BizTalk Services Portal registration</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec17"/>Creating your first BizTalk Services solution</h1></div></div></div><p>Let <a id="id71" class="indexterm"/>us put things into action and use the deployment created earlier to address a real-world multichannel sales scenario.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec15"/>Scenario description</h2></div></div></div><p>A trader, Northwind, manages an e-commerce website for online customer purchases. They also receive bulk orders from event firms and corporates for their goods. Northwind needs to develop a solution to validate an order and route the request to the right inventory location for delivery of the goods. The incoming request is an XML file with the order details. The request from event firms and corporates is over FTP, while e-commerce website requests are over HTTP. Post processing of the order, if the customer location is inside the US, then the request are forwarded to a relay service at a US address. For all <a id="id72" class="indexterm"/>other locations, the order needs to go to the central site and is sent to a Service Bus Queue at IntlAddress with the location as a promoted property.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec16"/>Prerequisites</h2></div></div></div><p>Before<a id="id73" class="indexterm"/> we start, we need to set up the client machine to connect to the deployment created earlier by performing the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Install the certificate downloaded from the deployment on your client box to the trusted root store. This authenticates any SSL traffic that is between your client and the integration solution on Azure.</li><li class="listitem">Download<a id="id74" class="indexterm"/> and install the BizTalk Services SDK (<a class="ulink" href="https://go.microsoft.com/fwLink/?LinkID=313230">https://go.microsoft.com/fwLink/?LinkID=313230</a>) so the developer project experience lights up in Visual Studio 2012.</li><li class="listitem">Download the BizTalk Services EAI tools' Message Sender and Message Receiver samples from the MSDN Code Gallery available at <a class="ulink" href="http://code.msdn.microsoft.com/windowsazure">http://code.msdn.microsoft.com/windowsazure</a>.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec17"/>Realizing the solution</h2></div></div></div><p>We will break down the implementation details into defining the incoming format and creating the bridge, including transports to process incoming messages and the creation of the target endpoints, relay, and Service Bus Queue.</p><div><div><div><div><h3 class="title"><a id="ch01lvl3sec01"/>Creating a BizTalk Services project</h3></div></div></div><p>You <a id="id75" class="indexterm"/>can create a new <a id="id76" class="indexterm"/>BizTalk Services project in Visual Studio 2012.</p><div><img src="img/7401EN_01_06.jpg" alt="Creating a BizTalk Services project"/><div><p>BizTalk Services project in Visual Studio</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec02"/>Creating the Order schema</h3></div></div></div><p>From <a id="id77" class="indexterm"/>within your project, right-click<a id="id78" class="indexterm"/> on the project name, click on <strong>Add</strong> | <strong>New Item</strong>, and add a new <strong>Flat File Schema</strong>.</p><div><img src="img/7401EN_01_07.jpg" alt="Creating the Order schema"/><div><p>Add Flat File Schema into BizTalk Services project</p></div></div><p>Add the following nodes to the schema so that the structure looks as follows:</p><div><img src="img/7401EN_01_08.jpg" alt="Creating the Order schema"/><div><p>Flat File Schema structure</p></div></div><p>For <a id="id79" class="indexterm"/>each of the records in the XSD file, make <a id="id80" class="indexterm"/>sure that the delimiters are added correctly:</p><div><pre class="programlisting">&lt;b:recordInfo structure="delimited" child_delimiter_type="char" child_delimiter="," child_order="postfix" preserve_delimiter_for_empty_data="true" suppress_trailing_delimiters="false" sequence_number="4" /&gt;</pre></div><p>You can validate the schema by running it with an instance file. The <strong>Validate Instance</strong> command is available by right-clicking on the created schema file in the Solution Explorer. Add the following flat file and XML instances in two separate files, use the <strong>Validate Instance</strong> command<a id="id81" class="indexterm"/>, and verify that the schema validates those instances. For each command run, ensure that the schema properties window has the right <strong>Validate Instance Input Type</strong> (XML in this case):</p><div><pre class="programlisting">OrderId|PaymentType|OrderDate|Code,Qty,Price,|Name,Email,Phone,|Recipient,Number,Street,City,State,Country,Pincode,|

&lt;ns0:Order &gt;
  &lt;OrderId&gt;MyOrder&lt;/OrderId&gt;
  &lt;PaymentType&gt;CreditCard&lt;/PaymentType&gt;
  &lt;OrderDate&gt;09-08-2013 22:50:00&lt;/OrderDate&gt;
  &lt;Product&gt;
    &lt;Code&gt;100&lt;/Code&gt;
    &lt;Qty&gt;1&lt;/Qty&gt;
    &lt;Price&gt;500&lt;/Price&gt;
  &lt;/Product&gt;
  &lt;Customer&gt;
    &lt;Name&gt;Karthik&lt;/Name&gt;
    &lt;Email&gt;user@hotmail.com&lt;/Email&gt;
    &lt;Phone&gt;1-111-1111&lt;/Phone&gt;
  &lt;/Customer&gt;
  &lt;ShippingAddress&gt;
    &lt;Recipient&gt;Jon&lt;/Recipient&gt;
    &lt;Number&gt;Building 1&lt;/Number&gt;
    &lt;Street&gt;One Redmond Way&lt;/Street&gt;
    &lt;City&gt;Redmond&lt;/City&gt;
    &lt;State&gt;Washington&lt;/State&gt;
    &lt;Country&gt;US&lt;/Country&gt;
    &lt;Pincode&gt;98052&lt;/Pincode&gt;
  &lt;/ShippingAddress&gt;
&lt;/ns0:Order&gt;</pre></div><div><div><h3 class="title"><a id="tip02"/>Tip</h3><p><strong>Downloading the example code</strong></p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec03"/>Creating the BizTalk Services solution</h3></div></div></div><p>Open <a id="id82" class="indexterm"/>the bridge configuration surface (usually the <code class="literal">MessageFlowItinerary.bcs</code> file). The Visual Studio Toolbox should show the following entities:</p><div><img src="img/7401EN_01_09.jpg" alt="Creating the BizTalk Services solution"/><div><p>Visual Studio Toolbox for BizTalk Services project</p></div></div><p>Use the <a id="id83" class="indexterm"/>VS toolbox to drag-and-drop <strong>FTP Source</strong>, <strong>Xml One-Way Bridge</strong>, <strong>One-Way Relay Endpoint</strong>, and <strong>Queue</strong> and connect them using the <strong>Connector</strong>, as shown in the following figure:</p><div><img src="img/7401EN_01_10.jpg" alt="Creating the BizTalk Services solution"/><div><p>Bridge message flow in BizTalk Services project</p></div></div><p>Configure the following in the message flow:</p><div><ol class="orderedlist arabic"><li class="listitem">Select the<a id="id84" class="indexterm"/> FTP server and configure the address, username, and password correctly.</li><li class="listitem">Double-click on the bridge to open the <strong>Xml One-Way Bridge</strong> configuration:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the <strong>Message Types</strong> block, add the <code class="literal">OrderFF.xsd</code> instance created earlier.<div><img src="img/7401EN_01_11.jpg" alt="Creating the BizTalk Services solution"/><div><p>Bridge configuration</p></div></div></li><li class="listitem" style="list-style-type: disc">In the <a id="id85" class="indexterm"/>first Enrich stage, add an XPath Type property reading from <code class="literal">/*[local-name()='Order' and namespace-uri()='http://BizTalkServicesOrderSample.OrderFF']/*[local-name()='ShippingAddress' and namespace-uri()='']/*[local-name()='Country' and namespace-uri()='']</code> and writing to the location as a string. The XPath value can be obtained by opening the schema in VS, clicking on the relevant record, and copying the XPath value from the record properties window.</li></ul></div><div><img src="img/7401EN_01_12.jpg" alt="Creating the BizTalk Services solution"/><div><p>Promote property configuration in the Enrich stage of the bridge</p></div></div></li><li class="listitem">In<a id="id86" class="indexterm"/> the parent <code class="literal">MessageFlowitinerary.bcs</code> view, click on the route link from <strong>OrderProcessingBridge</strong> to <strong>USAddressRelay</strong> and set the filter condition as <strong>location='US'</strong>; for the other link, set the location to <code class="literal">US</code>.<div><img src="img/7401EN_01_13.jpg" alt="Creating the BizTalk Services solution"/><div><p>Route properties for the message flow</p></div></div></li><li class="listitem">Edit the Queue <code class="literal">.config</code> file under <code class="literal">MessageFlowitinerary.bcs</code> and update the <code class="literal">&lt;tokenProvider&gt;</code> and the <code class="literal">&lt;endpoint&gt;</code> details with the Service Bus information.</li><li class="listitem">Edit the<a id="id87" class="indexterm"/> Relay Service <code class="literal">.config</code> file under <code class="literal">MessageFlowitinerary.bcs</code> and update the <code class="literal">&lt;endpoint&gt;</code> details with the Service Bus relay information.</li><li class="listitem">Build and deploy the solution.</li><li class="listitem">If the deployment was successful, point your browser to <code class="literal">https://&lt;yourdeployment&gt;/default/OrderProcessingBridge</code>; you should see a 401 HTTP Error code stating a manage claim is required for this operation.</li></ol></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec18"/>Verifying the solution</h1></div></div></div><p>We need <a id="id88" class="indexterm"/>to test sending two kinds of messages: one from the corporates and the other coming from the website:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Load the MessageReceiver sample in VS and build the solution. From the output bin folder, run the following in a command prompt window:<div><pre class="programlisting">MessageReceiver.exe ServiceBusNS owner issuerkey USAddressRelay OneWayRelay</pre></div><p>Here, <code class="literal">ServiceBusNS</code> is the namespace where the relay is running and <code class="literal">MyRelayTestSvc1</code> is the endpoint information configured in the bridge configuration.</p></li><li class="listitem" style="list-style-type: disc">Load another MessageReceiver in a new command window.<div><pre class="programlisting">MessageReceiver.exe ServiceBusNS owner issuerkey IntlAddressQueue Queue</pre></div><p>Here, <code class="literal">ServiceBusNS</code> is the namespace where the Queue has been precreated and <code class="literal">IntlAddressQueue</code> is the endpoint information configured with the bridge.</p></li><li class="listitem" style="list-style-type: disc">Load the MessageSender sample in VS and build the solution. <code class="literal">&lt;yourdeployment&gt;</code> is the URL where BizTalk Services was provisioned earlier.<div><pre class="programlisting">MessageSender.exe BizTalkSvcACS owner issuerkey https://&lt;yourdeployment&gt;/default/OrderProcessingBridge instance.xml application/xml</pre></div><p>Here, <code class="literal">BizTalkSvcACS </code>is the namespace of the BizTalk Service deployment ACS, <code class="literal">owner</code> and <code class="literal">issuerkey</code> are the ACS credentials of that namespace, and <code class="literal">instance.xml</code> is the <code class="literal">OrderFF.xsd</code> instance in XML format.</p></li><li class="listitem" style="list-style-type: disc">The output is observed in the MessageReceiver of the relay.</li><li class="listitem" style="list-style-type: disc">Edit <code class="literal">instance.xml</code> with <code class="literal">location=EU</code> and run the <code class="literal">MessageSender</code> command again. This time the output will be observed in the MessageReceiver of the Queue.</li><li class="listitem" style="list-style-type: disc">Drop a flat file in FTP with <code class="literal">location=US</code> and observe the output in the relay service window.</li><li class="listitem" style="list-style-type: disc">Drop a flat file in FTP with <code class="literal">location=EU</code> and observe the output in the message receive queue.</li></ul></div><p>Northwind <a id="id89" class="indexterm"/>can now process both flat files and XML orders from either HTTP or FTP endpoints. You can delete the bridge from the BizTalk Services portal Bridge view or by using PowerShell.</p></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec19"/>Summary</h1></div></div></div><p>In this chapter, we have introduced the basics of BizTalk Services and the concepts, architecture, personas, and tools available to build an integration solution. We also exercised all the concepts learned through a simple order processing scenario with BizTalk Services and Service Bus relay and queues. The example can be further extended to include transforms, routing to other bridges like EDI, custom code, and so on. In the next chapter, we'll look at some of the BizTalk Services capabilities in more detail.</p></div></body></html>