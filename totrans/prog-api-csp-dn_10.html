<html><head></head><body>
  <div><h1 class="chapter-number" id="_idParaDest-136">
    <a id="_idTextAnchor136">
    </a>
    
     10
    
   </h1>
   <h1 id="_idParaDest-137">
    <a id="_idTextAnchor137">
    </a>
    
     Deploying to Azure
    
   </h1>
   <p>
    
     In this chapter, we will explore
    
    <strong class="bold">
     
      Continuous Integration and Continuous Deployment
     
    </strong>
    
     (
    
    <strong class="bold">
     
      CI/CD
     
    </strong>
    
     ) on Azure.
    
    
     These are critical skills for enterprise development and ensure that bugs are caught early in the process, especially when working with a team.
    
    
     The earlier integration issues are surfaced, the less expensive they are
    
    
     
      to fix.
     
    
   </p>
   <p>
    
     Among the skills that we will review are creating an Azure project, creating a pipeline, and configuring the pipeline
    
    
     
      for CI/CD.
     
    
   </p>
   <p>
    
     This chapter will build on the skills you developed in
    
    <a href="B21998_06.xhtml#_idTextAnchor077">
     
      <em class="italic">
       
        Chapter 6
       
      </em>
     
    </a>
    
     and walk you through setting up CI/CD step
    
    
     
      by step.
     
    
   </p>
   <p>
    
     We will cover the following topics in
    
    
     
      this chapter:
     
    
   </p>
   <ul>
    <li>
     
      Using tests to ensure
     
     
      
       code quality
      
     
    </li>
    <li>
     
      Deploying
     
     
      
       from DevOps
      
     
    </li>
    <li>
     
      Deploying
     
     
      
       to Azure
      
     
    </li>
   </ul>
   <h1 id="_idParaDest-138">
    <a id="_idTextAnchor138">
    </a>
    
     Technical requirements
    
   </h1>
   <p>
    
     For this chapter, you’ll need
    
    
     
      the following:
     
    
   </p>
   <ul>
    <li>
     
      
       Visual Studio
      
     
    </li>
    <li>
     
      The
     
     <strong class="source-inline">
      
       Azure.Data.Tables
      
     </strong>
     
      
       NuGet package
      
     
    </li>
   </ul>
   <h1 id="_idParaDest-139">
    <a id="_idTextAnchor139">
    </a>
    
     Getting started
    
   </h1>
   <p>
    
     At the end of
    
    <a href="B21998_06.xhtml#_idTextAnchor077">
     
      <em class="italic">
       
        Chapter 6
       
      </em>
     
    </a>
    
     , you saw how easy it is to deploy to Azure directly from Visual Studio.
    
    
     This is fine for testing scenarios and one-off experiments or proofs of concept, but in a production scenario, this one project may be part of a much
    
    
     
      larger system.
     
    
   </p>
   <p>
    
     Setting up a series of “gates” (checks) before publishing to production can be advantageous for many reasons.
    
    
     Note that there are many types of release gates.
    
    
     The most
    
    <a id="_idIndexMarker281">
    </a>
    
     common (and important) are
    
    <strong class="bold">
     
      Pull Requests
     
    </strong>
    
     (
    
    <strong class="bold">
     
      PRs
     
    </strong>
    
     ), unit tests, integration tests, and
    
    
     
      end-to-end tests.
     
    
   </p>
   <h2 id="_idParaDest-140">
    <a id="_idTextAnchor140">
    </a>
    
     Using tests to ensure code quality
    
   </h2>
   <p>
    
     There are many
    
    <a id="_idIndexMarker282">
    </a>
    
     kinds of tests that you might run against your code.
    
    
     Among the most important are
    
    
     
      the following:
     
    
   </p>
   <ul>
    <li>
     
      
       Unit tests
      
     
    </li>
    <li>
     
      
       Integration tests
      
     
    </li>
    <li>
     
      
       Automated tests
      
     
    </li>
   </ul>
   <p>
    
     Unit tests cover one
    
    <a id="_idIndexMarker283">
    </a>
    
     section of your code that does one thing.
    
    
     For example, many unit tests have a 1:1 correspondence with methods, but not always.
    
    
     Think functionality rather than code.
    
    
     However, they must run extremely fast so that you run them after every code change.
    
    
     This allows you to code with confidence, knowing that if anything breaks, you know that something went wrong and where the problem
    
    
     
      is located.
     
    
   </p>
   <p>
    
     Integration tests are run
    
    <a id="_idIndexMarker284">
    </a>
    
     less often, typically after completing a discreet set of functionality to make sure that what you’ve created fits together with what is already in place.
    
    
     Finally, end-to-end tests ensure that the entire set of scenarios works as expected.
    
    
     This is, typically, where professional QA people run their tests.
    
    
     As programmers, it is almost impossible to run thorough end-to-end tests on our own code: we see what we expect to see, and we run what we expect the user to run.
    
    
     QA professionals can create a suite of tests to ensure that the program works well with good data but also with bad or corrupted data and when the user does something we
    
    
     
      didn’t expect.
     
    
   </p>
   <p>
    
     Fortunately, you can
    
    <a id="_idIndexMarker285">
    </a>
    
     automate all of these tests, checking various levels of the code to ensure nothing has regressed.
    
    
     While we won’t be looking at all of the advanced scenarios that Azure DevOps provides for us, we will be setting up a standard build and release pipeline that you can use to automate your deployments.
    
    
     In short, we will set up CI that will automate what we just did when we manually published
    
    
     
      to Azure.
     
    
   </p>
   <h3>
    
     Manual versus automated implementation
    
   </h3>
   <p>
    
     Going a little deeper, let’s compare DevOps (continuous delivery) and publishing through Visual Studio manually.
    
    
     You can have automated builds whenever a new commit has been
    
    <a id="_idIndexMarker286">
    </a>
    
     pushed to master.
    
    
     Along with automated builds on a branch, you can have builds checked with PRs.
    
    
     PRs have the benefit of another skilled programmer checking and testing your code before it is merged in.
    
    
     The fact is that automated tests can only go so far.
    
    
     PRs are also a good place to determine and test which environments your code requires (e.g., Windows,
    
    
     
      Linux, etc.).
     
    
   </p>
   <h2 id="_idParaDest-141">
    <a id="_idTextAnchor141">
    </a>
    
     Using the same binaries
    
   </h2>
   <p>
    
     It is highly
    
    <a id="_idIndexMarker287">
    </a>
    
     advantageous to deploy exactly the same binaries to your lower environments, such as your local computer, and then promote these same binaries to production.
    
    
     Though C# and .NET do have deterministic builds, the other parts of your deployed package or container may not.
    
    
     If something does go wrong after deployment, DevOps provides the ability to immediately roll back your deployed artifact.
    
    
     A history of these deployments is kept for each environment
    
    
     
      as well.
     
    
   </p>
   <p>
    
     While DevOps is superior in a lot of scenarios, it can be somewhat more difficult when debugging build failures.
    
    
     Each step of the build pipeline is logged for you to look at and diagnose later; however, that is sometimes easier said than done.
    
    
     Additionally, the more concurrent pipeline builds there are, the more difficult it may be to figure out what went wrong in the case of a failure.
    
    
     Compounding this, the larger the team gets, the more queueing of builds
    
    
     
      may happen.
     
    
   </p>
   <p>
    
     With that in place, we are ready to deploy
    
    
     
      to DevOps.
     
    
   </p>
   <p class="callout-heading">
    
     Tip
    
   </p>
   <p class="callout">
    
     The number of concurrent executing pipelines and the execution minutes per month is limited in the free version of DevOps.
    
    
     You can, of course, subscribe to increase
    
    
     
      these restrictions.
     
    
   </p>
   <h1 id="_idParaDest-142">
    <a id="_idTextAnchor142">
    </a>
    
     Deploying from DevOps
    
   </h1>
   <p>
    
     We’ll now be walking
    
    <a id="_idIndexMarker288">
    </a>
    
     through deploying from DevOps instead of our local Visual Studio.
    
    
     The first step is to create your DevOps project, as shown in
    
    
     <em class="italic">
      
       Figure 10
      
     </em>
    
    
     <em class="italic">
      
       .1
      
     </em>
    
    
     
      :
     
    
   </p>
   <div><div><img alt="Figure 10.1 – DevOps opening page" src="img/B21988_10_1.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 10.1 – DevOps opening page
    
   </p>
   <p>
    
     To create the project, we’ll use the wizard.
    
    
     (The first time, the wizard will probably come up immediately, otherwise click to bring up the wizard.) Here are
    
    
     
      the steps:
     
    
   </p>
   <ol>
    <li>
     
      Go
     
     
      
       to
      
     
     <a href="http://dev.Azure.com">
      
       
        dev.Azure.com
       
      
     </a>
     
      
       .
      
     
    </li>
    <li>
     
      Click on
     
     <strong class="bold">
      
       Start free
      
     </strong>
     
      (even if you already have
     
     
      
       an account).
      
     
    </li>
    <li>
     
      If it redirects you, enter
     
     <strong class="source-inline">
      
       dev.azure.com
      
     </strong>
     
      in the
     
     
      
       address box.
      
     
    </li>
    <li>
     
      Click
     
     <strong class="bold">
      
       New Project
      
     </strong>
     
      in the
     
     
      
       upper right.
      
     
    </li>
    <li>
     
      Enter a name and description and
     
     
      
       choose
      
     
     
      <strong class="bold">
       
        private
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Click on
     
     <strong class="bold">
      
       Advanced
      
     </strong>
     
      and make sure the version control is set
     
     
      
       to
      
     
     
      <strong class="bold">
       
        Git
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      
       Click
      
     
     
      <strong class="bold">
       
        Create
       
      </strong>
     
     
      
       .
      
     
    </li>
   </ol>
   <p>
    
     Let’s now import a bit
    
    
     
      of code.
     
    
   </p>
   <h2 id="_idParaDest-143">
    <a id="_idTextAnchor143">
    </a>
    
     Importing sample code
    
   </h2>
   <p>
    
     Before we can
    
    <a id="_idIndexMarker289">
    </a>
    
     deploy to Azure, we need to have a repository with the code we want to deploy.
    
    
     Clone the code for
    
    <a href="B21998_06.xhtml#_idTextAnchor077">
     
      <em class="italic">
       
        Chapter 6
       
      </em>
     
    </a>
    
     from
    
    <a href="https://github.com/PacktPublishing/Programming-APIs-with-C-Sharp-and-.NET/tree/main/Chapter06">
     
      https://github.com/PacktPublishing/Programming-APIs-with-C-Sharp-and-.NET/tree/main/Chapter06
     
    </a>
    
     and copy or move it into another folder so that it is no longer associated with the cloned repo.
    
    
     Open the solution in Visual Studio.
    
    
     Now we want to use Visual Studio to create a repository in our new DevOps project.
    
    
     Here are
    
    
     
      the steps:
     
    
   </p>
   <ol>
    <li>
     
      Open the
     
     
      <strong class="bold">
       
        GitChanges
       
      </strong>
     
     
      
       view.
      
     
    </li>
    <li>
     
      Click
     
     <strong class="bold">
      
       Create
      
     </strong>
     
      <strong class="bold">
       
        Git Repository
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Select
     
     <strong class="bold">
      
       Azure DevOps
      
     </strong>
     
      , as shown in
     
     
      <em class="italic">
       
        Figure 10
       
      </em>
     
     <em class="italic">
      
       .2
      
     </em>
     
      , and click on
     
     <strong class="bold">
      
       Create
      
     </strong>
     
      <strong class="bold">
       
        and Push
       
      </strong>
     
     
      
       .
      
     
    </li>
   </ol>
   <div><div><img alt="Figure 10.2 – Create a Git repository" src="img/B21988_10_2.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 10.2 – Create a Git repository
    
   </p>
   <p>
    
     With that in
    
    <a id="_idIndexMarker290">
    </a>
    
     place, we are ready to create the actual
    
    
     
      build pipeline.
     
    
   </p>
   <h2 id="_idParaDest-144">
    <a id="_idTextAnchor144">
    </a>
    
     Creating the build pipeline
    
   </h2>
   <p>
    
     Now that you
    
    <a id="_idIndexMarker291">
    </a>
    
     have your code in an Azure repository, you can create the build pipeline.
    
    
     To do so, take the
    
    
     
      following steps:
     
    
   </p>
   <ol>
    <li>
     
      Click on
     
     <strong class="bold">
      
       Create Pipeline
      
     </strong>
     
      , as shown in
     
     
      <em class="italic">
       
        Figure 10
       
      </em>
     
     
      <em class="italic">
       
        .3
       
      </em>
     
     
      
       :
      
     
    </li>
   </ol>
   <div><div><img alt="Figure 10.3 – Create Pipeline" src="img/B21988_10_3.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 10.3 – Create Pipeline
    
   </p>
   <p class="list-inset">
    
     You should see a wizard that will walk you through creating
    
    
     
      your pipeline.
     
    
   </p>
   <p class="list-inset">
    
     The first step asks
    
    <a id="_idIndexMarker292">
    </a>
    
     where your code is.
    
    
     DevOps supports a few different code repositories, including Azure Repos, Bitbucket, GitHub, GitHub Enterprise, other generic Git repositories,
    
    
     
      and Subversion.
     
    
   </p>
   <p class="callout-heading">
    
     Note
    
   </p>
   <p class="callout">
    
     There are two different ways to build your pipelines.
    
    
     The first is through YAML files, which can be in your repository
    
    <a id="_idIndexMarker293">
    </a>
    
     alongside your code, which has the added benefit of being versioned.
    
    
     The second supported way to build your pipelines is the way we’ll
    
    
     
      be taking.
     
    
   </p>
   <ol>
    <li value="2">
     
      Click on
     
     <strong class="bold">
      
       Use the classic editor
      
     </strong>
     
      , which will give us a much more in-depth UI to create a pipeline
     
     
      
       without YAML
      
     
    </li>
    <li>
     
      Choose your repository in the next dropdown and then select the default branch, as shown in
     
     
      <em class="italic">
       
        Figure 10
       
      </em>
     
     
      <em class="italic">
       
        .4
       
      </em>
     
     
      
       :
      
     
    </li>
   </ol>
   <div><div><img alt="Figure 10.4 – Select a source" src="img/B21988_10_4.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 10.4 – Select a source
    
   </p>
   <ol>
    <li value="4">
     
      Click
     
     <strong class="bold">
      
       Continue
      
     </strong>
     
      and you will
     
     <a id="_idIndexMarker294">
     </a>
     
      see a screen that asks you to select a template for your project.
     
     
      A number of standard ones are displayed by default but there are many others available.
     
     
      Since we are building and deploying an Azure function, scroll down to where it lists
     
     <strong class="bold">
      
       Azure Functions for .NET
      
     </strong>
     
      , as shown in
     
     
      <em class="italic">
       
        Figure 10
       
      </em>
     
     <em class="italic">
      
       .5
      
     </em>
     
      , and
     
     
      
       click
      
     
     
      <strong class="bold">
       
        Apply
       
      </strong>
     
     
      
       .
      
     
    </li>
   </ol>
   <div><div><img alt="Figure 10.5 – Azure Functions for .NET" src="img/B21988_10_5.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 10.5 – Azure Functions for .NET
    
   </p>
   <p class="list-inset">
    
     This takes you to
    
    <a id="_idIndexMarker295">
    </a>
    
     an editor for your pipeline.
    
    
     You should see various tabs, including
    
    <strong class="bold">
     
      Tasks
     
    </strong>
    
     ,
    
    <strong class="bold">
     
      Variable
     
    </strong>
    
     ,
    
    <strong class="bold">
     
      Triggers
     
    </strong>
    
     ,
    
    <strong class="bold">
     
      Options
     
    </strong>
    
     ,
    
    
     
      and
     
    
    
     <strong class="bold">
      
       History
      
     </strong>
    
    
     
      .
     
    
   </p>
   <ol>
    <li value="5">
     
      The pipeline item under the
     
     <strong class="bold">
      
       Tasks
      
     </strong>
     
      tab should be selected by default.
     
     
      If not, select it.
     
     
      In either case, click it and then rename your pipeline to whatever you
     
     
      
       would like.
      
     
     <p class="list-inset">
      
       The agent pool allows you to select from Microsoft-hosted build machines or, if you have custom private agents set up, you can also select those.
      
      
       We will not be covering private agents in
      
      
       
        this book.
       
      
     </p>
    </li>
    <li>
     
      Select
     
     <strong class="bold">
      
       Azure Pipelines
      
     </strong>
     
      for the agent pool, and select
     
     <strong class="bold">
      
       ubuntu latest
      
     </strong>
     
      for
     
     <strong class="bold">
      
       Agent Specification
      
     </strong>
     
      , as shown in
     
     
      <em class="italic">
       
        Figure 10
       
      </em>
     
     
      <em class="italic">
       
        .6
       
      </em>
     
     
      
       .
      
     
    </li>
   </ol>
   <p class="callout-heading">
    
     Note
    
   </p>
   <p class="callout">
    
     Although leaving the agent specification as Windows may work, we find it prevents a number of issues when you match your agent specification to the resource type that you created in Azure.
    
    
     In our case, we made a Linux
    
    
     
      Azure function.
     
    
   </p>
   <div><div><img alt="Figure 10.6 – Pipeline setup" src="img/B21988_10_6.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 10.6 – Pipeline setup
    
   </p>
   <ol>
    <li value="7">
     
      Select
     
     <strong class="bold">
      
       Get Sources
      
     </strong>
     
      under the
     
     <strong class="bold">
      
       Tasks
      
     </strong>
     
      tab.
     
     
      This should already be filled out for you with a number of defaults, including
     
     <a id="_idIndexMarker296">
     </a>
     
      your default branch to build from.
     
     
      The defaults for
     
     <strong class="bold">
      
       Agent job 1
      
     </strong>
     
      under the
     
     <strong class="bold">
      
       Get sources
      
     </strong>
     
      item should be fine and can be retained as is.
     
     
      Click on
     
     <strong class="bold">
      
       Build Project
      
     </strong>
     
      under
     
     <strong class="bold">
      
       Agent job 1
      
     </strong>
     
      to select the actual task that is used to build the published output, as shown in
     
     
      <em class="italic">
       
        Figure 10
       
      </em>
     
     
      <em class="italic">
       
        .7
       
      </em>
     
     
      
       .
      
     
    </li>
   </ol>
   <div><div><img alt="Figure 10.7 – Get sources" src="img/B21988_10_7.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 10.7 – Get sources
    
   </p>
   <p class="list-inset">
    
     The default task should be
    
    <strong class="bold">
     
      Build Project  .NET Core
     
    </strong>
    
     .
    
    
     You can build a number of different types
    
    <a id="_idIndexMarker297">
    </a>
    
     of assemblies, including console, libraries, ASP.NET Core, and, in our case, Azure Functions.
    
    
     As of the time of writing, task version 2 is currently supported and is
    
    
     
      the default.
     
    
   </p>
   <ol>
    <li value="8">
     
      Change the display name to something more descriptive, such as
     
     
      <strong class="source-inline">
       
        Publish Project
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Select
     
     <strong class="bold">
      
       publish
      
     </strong>
     
      from the
     
     <strong class="bold">
      
       Command
      
     </strong>
     
      dropdown.
     
     
      Uncheck
     
     <strong class="bold">
      
       Publish web projects
      
     </strong>
     
      .
     
     
      Though our Azure function is an API and could be considered a web project in a different context, we do not need this particular functionality for what we are doing.
     
     
      Leave the arguments
     
     
      
       as is.
      
     
    </li>
    <li>
     
      Ensure that
     
     <strong class="bold">
      
       Zip published projects
      
     </strong>
     
      and
     
     <strong class="bold">
      
       Add project’s folder name to publish path
      
     </strong>
     
      are
     
     
      
       both
      
     
     
      <a id="_idIndexMarker298">
      </a>
     
     
      
       checked.
      
     
    </li>
    <li>
     
      In the
     
     <strong class="bold">
      
       Arguments
      
     </strong>
     
      text box, change
     
     <strong class="source-inline">
      
       publish_output
      
     </strong>
     
      to
     
     <strong class="source-inline">
      
       $(build.artifactstagingdirectory)
      
     </strong>
     
      , as shown in
     
     
      <em class="italic">
       
        Figure 10
       
      </em>
     
     
      <em class="italic">
       
        .8
       
      </em>
     
     
      
       .
      
     
    </li>
   </ol>
   <div><div><img alt="Figure 10.8 – Publish Project" src="img/B21988_10_8.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 10.8 – Publish Project
    
   </p>
   <p class="list-inset">
    
     You can explore the other
    
    <strong class="bold">
     
      Advanced
     
    </strong>
    
     ,
    
    <strong class="bold">
     
      Control Options
     
    </strong>
    
     , and
    
    <strong class="bold">
     
      Output Variables
     
    </strong>
    
     expanders but the defaults should
    
    
     
      be fine.
     
    
   </p>
   <ol>
    <li value="12">
     
      Right-click on
     
     <strong class="bold">
      
       Archive Files
      
     </strong>
     
      and choose
     
     
      <strong class="bold">
       
        Remove Task
       
      </strong>
     
     
      
       .
      
     
    </li>
   </ol>
   <p>
    
     You are now ready to publish that artifact
    
    
     
      to DevOps.
     
    
   </p>
   <h2 id="_idParaDest-145">
    <a id="_idTextAnchor145">
    </a>
    
     Publishing an artifact
    
   </h2>
   <p>
    
     To publish the artifact, follow
    
    
     
      these steps:
     
    
   </p>
   <ol>
    <li>
     
      Click on
     
     <strong class="bold">
      
       Publish Artifact: Drop
      
     </strong>
     
      on the
     
     
      
       left side.
      
     
     <p class="list-inset">
      
       This is what uploads
      
      <a id="_idIndexMarker299">
      </a>
      
       your newly zipped output folder to DevOps’s artifact storage for further release later.
      
      
       The defaults in this section should
      
      
       
        be fine.
       
      
     </p>
    </li>
    <li>
     
      Click on the
     
     <strong class="bold">
      
       Triggers
      
     </strong>
     
      tab.
     
     
      Check the
     
     <strong class="bold">
      
       Enable continuous integration
      
     </strong>
     
      box, and ensure that
     
     <strong class="bold">
      
       Include
      
     </strong>
     
      is selected for the master branch.
     
     
      This is what triggers builds on every push
     
     
      
       to master.
      
     
    </li>
    <li>
     
      Click
     
     <strong class="bold">
      
       Save &amp; queue
      
     </strong>
     
      under the
     
     <strong class="bold">
      
       Save &amp; queue
      
     </strong>
     
      dropdown (to the right of
     
     
      
       the tabs).
      
     
    </li>
    <li>
     
      When the
     
     <strong class="bold">
      
       Run pipeline
      
     </strong>
     
      dialog box appears, fill in a comment just like you would when committing code, and click
     
     <strong class="bold">
      
       Save
      
     </strong>
     
      
       and
      
     
     
      <strong class="bold">
       
        Run
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Click on the
     
     <strong class="bold">
      
       Pipelines
      
     </strong>
     
      tab on the far left, which will bring you back to the list
     
     
      
       of pipelines.
      
     
     <p class="list-inset">
      
       The pipeline that you named should show, and the icon should be blue on your screen indicating that it is executing the build pipeline.
      
      
       If it is finished, or after a minute or so, it will
      
      
       
        turn green.
       
      
     </p>
    </li>
    <li>
     
      Click on the larger list item to go to the list of the builds for that pipeline, or the text of the commit message to go directly to those
     
     
      
       build details.
      
     
    </li>
   </ol>
   <p>
    
     On the
    
    <strong class="bold">
     
      Summary
     
    </strong>
    
     tab, you should see a variety of information, including the build number, branch, commit, number of artifacts published, and list of jobs.
    
    
     Next to the
    
    <strong class="bold">
     
      Summary
     
    </strong>
    
     tab may be other tabs.
    
    
     These can be added by other plugins.
    
    
     Clicking on the job indicated by the green check displays the individual steps that the agent used to build your artifact.
    
    
     All standard out (console output) is captured and saved for use in the debugging build errors.
    
    
     Usually, build errors will be prominent and direct you to the location of
    
    
     
      the error.
     
    
   </p>
   <h1 id="_idParaDest-146">
    <a id="_idTextAnchor146">
    </a>
    
     Deploying your artifact to Azure
    
   </h1>
   <p>
    
     Now that your
    
    <a id="_idIndexMarker300">
    </a>
    
     artifact is built and zipped, we’ll deploy it
    
    
     
      to Azure:
     
    
   </p>
   <ol>
    <li>
     
      Click on the
     
     <strong class="bold">
      
       Releases
      
     </strong>
     
      subsection under
     
     <strong class="bold">
      
       Pipelines
      
     </strong>
     
      on the left.
     
     
      Click on
     
     <strong class="bold">
      
       New Release Pipeline
      
     </strong>
     
      .
     
     
      Once again, a familiar
     
     <strong class="bold">
      
       Select a Template
      
     </strong>
     
      screen should
     
     
      
       be shown.
      
     
    </li>
    <li>
     
      You can scroll down or search for
     
     <strong class="bold">
      
       Functions
      
     </strong>
     
      in the list, select the one that says
     
     <strong class="bold">
      
       Deploy a Function App to Azure Functions
      
     </strong>
     
      , and
     
     
      
       click
      
     
     
      <strong class="bold">
       
        Apply
       
      </strong>
     
     
      
       .
      
     
     <p class="list-inset">
      
       You should now see a stage pop out named
      
      <strong class="bold">
       
        Stage one
       
      </strong>
      
       .
      
      
       This entire section can be customized with different business workflows according to your needs.
      
      
       For this exercise, we will have a
      
      
       
        single environment.
       
      
     </p>
    </li>
    <li>
     
      Change the stage name to
     
     <strong class="source-inline">
      
       Production
      
     </strong>
     
      .
     
     
      Click on
     
     <strong class="bold">
      
       Add an Artifact
      
     </strong>
     
      .
     
     
      Select the source of the artifact, which in our case is a build artifact – which may already
     
     
      
       be selected.
      
     
    </li>
    <li>
     
      Select your project and then your source build pipeline.
     
     
      Leave the latest as the default version and your source alias should already be pre-populated.
     
     
      
       Click
      
     
     
      <strong class="bold">
       
        Add
       
      </strong>
     
     
      
       .
      
     
    </li>
   </ol>
   <p>
    
     One of the most powerful opportunities when deploying to Azure is CD.
    
    
     Every time your code is checked in and approved, a version is created
    
    
     
      and deployed.
     
    
   </p>
   <h2 id="_idParaDest-147">
    <a id="_idTextAnchor147">
    </a>
    
     Continuous deployment
    
   </h2>
   <p>
    
     Your artifact
    
    <a id="_idIndexMarker301">
    </a>
    
     name should now be in the
    
    <strong class="bold">
     
      Artifact
     
    </strong>
    
     section.
    
    
     Take the
    
    
     
      following steps:
     
    
   </p>
   <ol>
    <li>
     
      Select the lightning bolt icon on the artifact to show the
     
     
      
       CD triggers.
      
     
    </li>
    <li>
     
      Enable the CD.
     
     
      This is how we automate the creation of a release after the build
     
     
      
       is completed.
      
     
    </li>
    <li>
     
      Click on the lightning bolt icon on the production stage.
     
     
      This is also part of the automatic deployment configuration.
     
     <strong class="bold">
      
       After Release
      
     </strong>
     
      should be selected by default; however, if you do not
     
     <a id="_idIndexMarker302">
     </a>
     
      want the release pipeline to automatically start, then select
     
     
      <strong class="bold">
       
        Manual Only
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Next, click on the
     
     <strong class="bold">
      
       1 Job, 1 Task
      
     </strong>
     
      label with the red icon, or you can select the
     
     <strong class="bold">
      
       Tasks
      
     </strong>
     
      tab.
     
     
      This should look similar to the build pipeline that we created earlier.
     
     
      There should be a few items highlighted in red indicating that they
     
     
      
       need attention.
      
     
    </li>
    <li>
     
      Select your Azure subscription from that drop-down list.
     
     
      If there is an
     
     <strong class="bold">
      
       Authorize
      
     </strong>
     
      button,
     
     
      
       click it.
      
     
    </li>
    <li>
     
      Select
     
     <strong class="bold">
      
       Function App on Linux
      
     </strong>
     
      for your app type, and then under the
     
     <strong class="bold">
      
       App service name
      
     </strong>
     
      dropdown, you should see all of the available Linux Azure functions.
     
     
      Please note that if the resource was created recently, it may not show
     
     
      
       up immediately.
      
     
    </li>
    <li>
     
      Click on
     
     <strong class="bold">
      
       Run On Agent
      
     </strong>
     
      and use the same agent settings that we did in the build pipeline:
     
     <strong class="bold">
      
       Azure Pipelines
      
     </strong>
     
      for the agent pool and
     
     <strong class="bold">
      
       ubuntu latest
      
     </strong>
     
      for the agent specification.
     
     
      The rest of the defaults will
     
     
      
       be fine.
      
     
    </li>
    <li>
     
      Finally, click on
     
     <strong class="bold">
      
       Deploy Azure Function App
      
     </strong>
     
      .
     
     
      You can change the display name to something more descriptive if you’d like.
     
     
      Notice that the Azure subscription app type and Azure Functions app name are grayed out.
     
     
      These should match the ones we selected when we selected the
     
     
      
       production stage.
      
     
    </li>
    <li>
     
      Click on the triple dots under the package or folder label and then navigate down to the artifact ZIP that was built, as shown in
     
     
      <em class="italic">
       
        Figure 10
       
      </em>
     
     
      <em class="italic">
       
        .9
       
      </em>
     
     
      
       .
      
     
    </li>
   </ol>
   <div><div><img alt="Figure 10.9 – Select a file or folder" src="img/B21988_10_9.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 10.9 – Select a file or folder
    
   </p>
   <ol>
    <li value="10">
     
      For the runtime stack, select
     
     <strong class="bold">
      
       .NET isolated 8.0
      
     </strong>
     
      and leave
     
     <strong class="bold">
      
       Start with
      
     </strong>
     
      <strong class="bold">
       
        Command
       
      </strong>
     
     
      
       blank.
      
     
    </li>
    <li>
     
      Expand the application and configuration settings and click on the triple dots next to the app
     
     <a id="_idIndexMarker303">
     </a>
     
      settings.
     
     
      This may look familiar to you because this is where we are going to set up the application settings as we did in
     
     <a href="B21998_06.xhtml#_idTextAnchor077">
      
       <em class="italic">
        
         Chapter 6
        
       </em>
      
     </a>
     
      
       .
      
     
    </li>
    <li>
     
      Click on
     
     <strong class="bold">
      
       Add
      
     </strong>
     
      and use the same name that we used in Azure before:
     
     <strong class="source-inline">
      
       MyReturnProperty
      
     </strong>
     
      .
     
     
      For the value, and keeping with the consistency of what we have seen before, you can use something such as
     
     <em class="italic">
      
       my value from DevOps
      
     </em>
     
      .
     
     
      (If you have spaces in this value, be sure to put it all in
     
     
      
       double quotes.)
      
     
    </li>
    <li>
     
      Click
     
     <strong class="bold">
      
       Ok
      
     </strong>
     
      .
     
     
      The name-value pairs should be joined together into a single string in the
     
     
      
       app settings.
      
     
    </li>
    <li>
     
      Next, click on
     
     <strong class="bold">
      
       Save
      
     </strong>
     
      , and fill out the comment if you want.
     
     
      You can leave the folder as a slash, or if you know you will have a lot of release pipelines in the future you can
     
     <a id="_idIndexMarker304">
     </a>
     
      organize them into folders here.
     
     
      Then,
     
     
      
       click
      
     
     
      <strong class="bold">
       
        Ok
       
      </strong>
     
     
      
       .
      
     
    </li>
   </ol>
   <p>
    
     We’re not quite done.
    
    
     We must test the release pipeline to ensure that everything works
    
    
     
      as expected.
     
    
   </p>
   <h2 id="_idParaDest-148">
    <a id="_idTextAnchor148">
    </a>
    
     Testing the release pipeline
    
   </h2>
   <p>
    
     Now, let’s test our
    
    <a id="_idIndexMarker305">
    </a>
    
     
      release pipeline:
     
    
   </p>
   <ol>
    <li>
     
      Click on
     
     <strong class="bold">
      
       Create release
      
     </strong>
     
      in the upper right-hand corner.
     
     
      You should see the
     
     <strong class="bold">
      
       Create New Release
      
     </strong>
     
      flyout.
     
     
      You can do temporary one-off adjustments on the manual or automated settings for
     
     <a id="_idIndexMarker306">
     </a>
     
      each of the stages.
     
     
      You may want to create the release, but not necessarily actually push it out to production.
     
     
      You should see the artifact that was created in the build pipeline along with a
     
     
      
       proper version.
      
     
    </li>
    <li>
     
      Click
     
     <strong class="bold">
      
       Create
      
     </strong>
     
      .
     
     
      Since we left the stage set to automated, it should automatically begin releasing.
     
     
      Click on the newly created release and you should see a blue in-progress icon, or green if it has
     
     
      
       already succeeded.
      
     
    </li>
    <li>
     
      You can click on a stage to show logging information under
     
     <strong class="bold">
      
       Summary
      
     </strong>
     
      along with what commits were made in this new release.
     
     
      Back in the production stage, you can click on logs, which will bring you to the log view of the
     
     
      
       release pipeline.
      
     
    </li>
   </ol>
   <p class="callout-heading">
    
     Note
    
   </p>
   <p class="callout">
    
     For demonstration purposes, disable authorization by going to the authentication section in your function application resource and clicking on the
    
    <strong class="bold">
     
      Edit Text
     
    </strong>
    
     link (by the
    
    <strong class="bold">
     
      Authentication settings
     
    </strong>
    
     header).
    
    
     Select
    
    <strong class="bold">
     
      Disable
     
    </strong>
    
     .
    
    
     Click
    
    <strong class="bold">
     
      Save
     
    </strong>
    
     .
    
    
     (Be sure to re-enable this when you are
    
    
     
      finished testing.)
     
    
   </p>
   <p>
    
     Once the release has finished, navigate to the
    
    <strong class="bold">
     
      Function1
     
    </strong>
    
     URL we were using in
    
    <a href="B21998_06.xhtml#_idTextAnchor077">
     
      <em class="italic">
       
        Chapter 6
       
      </em>
     
    </a>
    
     , or refresh if it is still open in the browser.
    
    
     It should now display the settings that we configured in the release pipeline:
    
    <em class="italic">
     
      my value
     
    </em>
    
     <em class="italic">
      
       from DevOps
      
     </em>
    
    
     
      .
     
    
   </p>
   <h2 id="_idParaDest-149">
    <a id="_idTextAnchor149">
    </a>
    
     End-to-end testing
    
   </h2>
   <p>
    
     Let’s test to make
    
    <a id="_idIndexMarker307">
    </a>
    
     sure it is
    
    
     
      all working:
     
    
   </p>
   <ol>
    <li>
     
      Go back to Visual Studio and make a small edit (e.g.,
     
     
      
       a comment).
      
     
    </li>
    <li>
     
      Commit, and then push
     
     <a id="_idIndexMarker308">
     </a>
     
      that to the master branch.
     
     
      Back in DevOps, go to the
     
     <strong class="bold">
      
       Pipelines
      
     </strong>
     
      section and you should see that that pipeline is already building.
     
     
      Wait for it to complete, then navigate to the release pipeline.
     
     
      You should see that a brand-new release was created immediately after the build succeeded and should now either be running or perhaps even
     
     
      
       completed already.
      
     
    </li>
   </ol>
   <p>
    
     Congratulations!
    
    
     You have set up a pipeline that automatically deploys an Azure function HTTP trigger on every commit to the
    
    
     
      master branch!
     
    
   </p>
   <p>
    <em class="italic">
     
      Piece
     
    </em>
    
     <em class="italic">
      
       of cake!
      
     </em>
    
   </p>
   <h1 id="_idParaDest-150">
    <a id="_idTextAnchor150">
    </a>
    
     Summary
    
   </h1>
   <p>
    
     In this chapter, we focused on deploying our Azure function
    
    
     
      using CI/CD.
     
    
   </p>
   <p>
    
     We saw how to set up the pipeline and connect it to our function.
    
    
     We also saw how to enable deployment to fire every time code is pushed to the
    
    
     
      master branch.
     
    
   </p>
   <h1 id="_idParaDest-151">
    <a id="_idTextAnchor151">
    </a>
    
     You try it
    
   </h1>
   <p>
    
     Create a simple Azure function.
    
    
     Next, create a new pipeline that automatically deploys that Azure function on every commit to the master branch.
    
    
     Take your time; there are a lot
    
    
     
      of steps.
     
    
   </p>
   <h1 id="_idParaDest-152">
    <a id="_idTextAnchor152">
    </a>
    
     Congratulations!
    
   </h1>
   <p>
    
     You have worked your way through creating APIs and seen how to migrate your work to Azure.
    
    
     You have conquered many advanced topics and are ready to implement enterprise APIs.
    
    
     Thank you for hanging in there with us, and be sure to let us know what you liked (and didn’t!) about this book.
    
    
     Finally, if you have the time, please leave a review on Amazon.
    
    
     You know what they say: if you liked it, tell Amazon; if not,
    
    
     
      tell us!
     
    
   </p>
   <p>
    
     In the next and final chapter, we briefly point you to additional resources.
    
    
     We hope they are helpful as you
    
    
     
      go forward.
     
    
   </p>
  </div>
 </body></html>