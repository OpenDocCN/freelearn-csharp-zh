<html><head></head><body>
		<div><h1 id="_idParaDest-86"><em class="italic"><a id="_idTextAnchor156"/>Chapter 10</em>: Customizing ASP.NET Core Identity</h1>
			<p>In this tenth chapter, we are going to learn how to customize ASP.NET Core Identity. Security is one of the most important aspects of an application. Microsoft ships ASP.NET Core Identity as part of the ASP.NET Core framework to add authentication and user management to ASP.NET Core applications. </p>
			<p>In this chapter, you will learn how to customize the basic implementation of the ASP.NET Core Identity UI and how to add custom information to <strong class="bold">IdentityUser</strong>. We'll cover the following points:</p>
			<ul>
				<li>Introducing ASP.Net Core Identity</li>
				<li>Customizing IdentityUser</li>
				<li>Customizing the Identity views </li>
			</ul>
			<p>The topics of this chapter relate to the MVC layer of the ASP.NET Core architecture:</p>
			<div><div><img src="img/Figure_10.1_B17996.jpg" alt="Figure 10.1 – ASP.NET Core architecture"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.1 – ASP.NET Core architecture</p>
			<h1 id="_idParaDest-87"><a id="_idTextAnchor157"/>Technical requirements</h1>
			<p>To follow the exercises in this chapter, you will need to create an ASP.NET Core MVC application. Open your console, shell, or Bash terminal and change to your working directory. Use the following command to create a new MVC application:</p>
			<pre>dotnet new mvc -n AuthSample -o AuthSample --auth Individual</pre>
			<p>Now, open the project in Visual Studio by double-clicking the project file, or open it in Visual Studio Code by typing the following command in the already-open console:</p>
			<pre>cd AuthSample
code .</pre>
			<p>All of the code samples for this chapter can be found in the GitHub repo for this book: <a href="https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter10">https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter10</a>.</p>
			<h1 id="_idParaDest-88">I<a id="_idTextAnchor158"/><a id="_idTextAnchor159"/>ntroducing ASP.NET Core Identity</h1>
			<p>An <code>writer</code> tells the application that the identity is allowed to write something. Identities can be nested as well. A user can be part of a group, and a group can be part of another group, and so forth.</p>
			<p>ASP.NET Core Identity is a framework that structures this concept in .NET objects to help you store and read the user information.  The framework also provides a mechanism to add a login form, a registration form, session handling, and so on. It also helps you to store the credentials in an encrypted and secure way.</p>
			<p>ASP.NET Core Identity provides multiple ways to authenticate your users:</p>
			<ul>
				<li><strong class="bold">Individual</strong>: The application manages the identities on its own. It has a database where user information <a id="_idIndexMarker146"/>is stored and manages the login, logout, registration, and so on on its own.</li>
				<li><strong class="bold">IndividualB2C</strong>: Manages the user data on its own, but gets it from Azure B2C.</li>
				<li><strong class="bold">SingleOrg</strong>: The identities get managed by Azure <strong class="bold">Active Directory</strong> (<strong class="bold">AD</strong>); the login, logout, and so <a id="_idIndexMarker147"/>on are done by Azure AD. The application just gets a ready-to-use identity from the web server.</li>
				<li><strong class="bold">MultiOrg</strong>: Same as the previous but enabled for multiple Azure AD organizations.</li>
				<li><strong class="bold">Windows</strong>: This means the classical Windows authentication, which is only available if <a id="_idIndexMarker148"/>the application is hosted with IIS. The user also gets a ready-to-use identity from the web server.</li>
			</ul>
			<p>This chapter is not about the different ways to authenticate because this topic would fill an entire book.</p>
			<p>Let's explore an application with <strong class="bold">individual</strong> authentication enabled.</p>
			<p>As you might remember from the technical requirements, the <code>--auth</code> flag is used to create the <a id="_idIndexMarker149"/>application. It is set to <code>Individual</code> to create an ASP.NET Core MVC application with individual authentication enabled. This means it comes with a database to store the users. The <code>--auth</code> flag adds all the relevant code and dependencies to enable authentication in your freshly created application.</p>
			<div><div><img src="img/Figure_10.2_B17996.jpg" alt="Figure 10.2 – Layout reference for the ASP.NET Identity UI"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.2 – Layout reference for the ASP.NET Identity UI</p>
			<p>The <code>--auth</code> flag creates an area called <code>Identity</code> that contains a <code>_ViewStart.cshtml</code> file, which references the <code>_Layout.cshtml</code> file of the new project. The actual login <a id="_idIndexMarker150"/>or register screens are provided in a compiled library that is referenced to this project.</p>
			<p>The AUTHSAMPLE contains a <code>Data</code> folder that contains an Entity Framework Core DbContext, as well as a database migration to create and update the database that is used here.</p>
			<p>All the other parts, except <code>Program.cs</code>, are completely the same as in regular MVC applications.</p>
			<p>If you created the application using the .NET CLI as shown in the technical requirements, a <strong class="bold">SQLite</strong> database is used. If you used Visual <a id="_idIndexMarker151"/>Studio to create this application, SQL Server is used to store the user data.</p>
			<p>Before starting the application, call the following command in the terminal:</p>
			<pre>dotnet ef database update</pre>
			<p>This will create and update the database.</p>
			<p>If it doesn't work, you might need to install the Entity Framework tool in the .NET CLI first:</p>
			<pre>dotnet tool install -g dotnet-ef</pre>
			<p>Then, call the following:</p>
			<pre>dotnet watch</pre>
			<p>The application will now <a id="_idIndexMarker152"/>start up in watch mode with hot-reload enabled. It will also open a browser window and call the application:</p>
			<div><div><img src="img/Figure_10.3_B17996.jpg" alt="Figure 10.3 – AuthSample home page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.3 – AuthSample home page</p>
			<p>As you can see, there is a menu on the upper right-hand side with the <strong class="bold">Register</strong> and <strong class="bold">Login</strong> options for this application. A click on the <strong class="bold">Login</strong> link takes you to the following login screen:</p>
			<div><div><img src="img/Figure_10.4_B17996.jpg" alt="Figure 10.4 – Login screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.4 – Login screen</p>
			<p>As mentioned, this view comes from a compiled Razor library that provides the necessary view to the Identity area. We automatically get this UI from the framework.</p>
			<p>As the last thing in this section, we should have a quick look into <code>Program.cs</code>, which also differs <a id="_idIndexMarker153"/>from the files we saw in the last chapters.</p>
			<p>In the upper section, where the services are registered, there are lines of code to register <code>DbContext</code> as well as database exception pages:</p>
			<pre>var connectionString = builder.Configuration
    .GetConnectionString("DefaultConnection");
builder.Services.AddDbContext&lt;ApplicationDbContext&gt;(
    options =&gt; options.UseSqlite(connectionString));
builder.Services.AddDatabaseDeveloperPageExceptionFilter();
builder.Services.AddDefaultIdentity&lt;IdentityUser&gt;(
    options =&gt; options.SignIn.RequireConfirmedAccount = 
        true)
    .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();</pre>
			<p>There is also a registration for default identity that adds the <code>EntityFramework</code> store. It is also <a id="_idIndexMarker154"/>configured to only allow confirmed accounts, which means you as a user need to confirm your email address before you are allowed to log in.</p>
			<p>In the lower section, where the middleware is used, we see that the authentication and authorization is used:</p>
			<pre>app.UseAuthentication();
app.UseAuthorization();</pre>
			<p>These two middleware enable authentication and authorization. The first tries to recognize the user by reading the authentication cookie. It also adds all the relevant information to the Identity object. </p>
			<p>What you might need to do is to extend the user profile by adding some more properties to the user. Let's see how to do so in the next section.</p>
			<h1 id="_idParaDest-89"><a id="_idTextAnchor160"/>Customizing IdentityUser</h1>
			<p><code>IdentityUser</code> has the following fields: <code>Id</code>, <code>Username</code>, <code>Password</code>, <code>Email</code>, and <code>Phonenumber</code>. </p>
			<p>Since the display <a id="_idIndexMarker155"/>name might differ from the username, we should add a <code>Name</code> property. Say we would like to send birthday wishes to the user; so, we would like to know their date of birth.</p>
			<p>To do so, a file called <code>WebAppUser.cs</code> is added to the <code>Data</code> folder that contains the following lines:</p>
			<pre>using Microsoft.AspNetCore.Identity;
namespace AuthSample.Data;
public class WebAppUser : IdentityUser
{
    [PersonalData]
    public string? Name { get; set; }
    [PersonalData]
    public DateTime DOB { get; set; }
}</pre>
			<p>As shown here, <code>WebAppUser</code> derives from <code>IdentityUser</code> and extends it with the two already-mentioned properties.</p>
			<p>In <code>Program.cs</code>, we need to modify the service registration to use the new <code>WebAppUser</code>:</p>
			<pre>builder.Services.AddDefaultIdentity&lt;WebAppUser&gt;</pre>
			<p>We also need to change <code>DbContext</code> in a way to use this <code>WebAppUser</code>, by changing the base class:</p>
			<pre>public class ApplicationDbContext : 
     IdentityDbContext&lt;WebAppUser, IdentityRole, string&gt;</pre>
			<p>You might need <a id="_idIndexMarker156"/>to add a <code>using</code> statement to <code>Microsoft.AspNetCore.Identity</code>.</p>
			<p>That's it for the first step. We now need to update the database:</p>
			<pre>dotnet ef migrations add CustomUserData
dotnet ef database update</pre>
			<p>Once you have <code>IdentityUser</code> extended with the custom properties, you can start to use this in the user profile. This needs some customization in the ASP.NET Core Identity UI.</p>
			<h1 id="_idParaDest-90"><a id="_idTextAnchor161"/>Customizing the Identity views</h1>
			<p>Even if the ASP.NET Core Identity views come from a compiled Razor library, you can customize those views to add <a id="_idIndexMarker157"/>more fields or change the layout. To do so, you just need to override the given views with custom ones in the predefined folder structure within the area.</p>
			<p>As mentioned, there is already an area called <code>Identity</code> in the project. Inside this area, there is a <code>Pages</code> folder. Here, a new folder called <code>Account</code> needs to be created, to match the route of the <strong class="bold">Register</strong> page.</p>
			<p>If this is done, place a new Razor page called <code>Register.cshtml</code> inside this folder and put the following content inside just to see whether the overriding of views is working:</p>
			<pre>@page
@{
}
&lt;h1&gt;Hello Register Form&lt;/h1&gt; </pre>
			<p>If you now run the app and click on <strong class="bold">Register</strong> in the upper left-hand corner, you will see the following page:</p>
			<div><div><img src="img/Figure_10.5_B17996.jpg" alt="Figure 10.5 – Register page"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.5 – Register page</p>
			<p>It is working.</p>
			<p>Actually, you don't need to override the views on your own. There is a code generator available to <a id="_idIndexMarker158"/>scaffold the views you'd like to override.</p>
			<p>Install the code generator by calling this command:</p>
			<pre>dotnet tool install -g dotnet-aspnet-codegenerator</pre>
			<p>If not already done, you also need to install the following packages in your project:</p>
			<pre>dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design
dotnet add package Microsoft.EntityFrameworkCore.Design
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore
dotnet add package Microsoft.AspNetCore.Identity.UI
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
dotnet add package Microsoft.EntityFrameworkCore.Tools</pre>
			<p>To learn what the code generator can do, run the following command:</p>
			<pre>dotnet aspnet-codegenerator identity -h</pre>
			<p>You can scaffold the entire Identity UI as well as specific pages. If you don't specify pages of the default UI, all pages will be generated in your project. To see which pages you can generate, type the following command:</p>
			<pre>dotnet aspnet-codegenerator identity -lf</pre>
			<p>The idea for the first <a id="_idIndexMarker159"/>change is to let the user fill in the name property on the registration page.</p>
			<p>So, let's scaffold the <strong class="bold">Register</strong> page:</p>
			<pre>dotnet aspnet-codegenerator identity -dc AuthSample.Data.ApplicationDbContext --files "Account.Register" -sqlite</pre>
			<p>This command tells the code generator to use the already-existing <code>ApplicationDbContext</code> and <code>Sqlite</code>. If you don't specify this, it will either create a new <code>DbContext</code> or register the existing <code>DbContext</code> to use with SQL Server instead of SQLite. </p>
			<p>If all is done right, the code generator should only add the <code>Register.cshtml</code> page as well as some infrastructure files:</p>
			<div><div><img src="img/Figure_10.6_B17996.jpg" alt="Figure 10.6 – Files added by the code generator"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.6 – Files added by the code generator</p>
			<p>The code generator also knows that the project is using a custom <code>WebAppUser</code> instead of <code>IdentityUser</code>, which means <code>WebAppUser</code> is used in the generated code.</p>
			<p>Now, you should change <code>Register.cshtml</code> to add the display name to the form. Add the following <a id="_idIndexMarker160"/>lines right before the form elements for the email field on line 15 and thereafter:</p>
			<pre>&lt;div class="form-floating"&gt;
    &lt;input asp-for="Input.Name" class="form-control" 
        autocomplete="name" aria-required="true" /&gt;
    &lt;label asp-for="Input.Name"&gt;&lt;/label&gt;
    &lt;span asp-validation-for="Input.Name"
        class="text-danger"&gt;&lt;/span&gt;
&lt;/div&gt;</pre>
			<p>Also, <code>Regiser.cshtml.cs</code> need to be changed. The <code>ImportModel</code> class needs the <code>Name</code> property:</p>
			<pre>public class InputModel
{
    [Required]
    [Display(Name = "Display name")]
    public string Name { get; set; }</pre>
			<p>In the <code>PostAsync</code> method, assign the <code>Name</code> property to the newly created user:</p>
			<pre>var user = CreateUser();
user.Name = Input.Name;</pre>
			<p>That's it.</p>
			<p>After starting the application, you will see the following registration form:</p>
			<div><div><img src="img/Figure_10.7_B17996.jpg" alt="Figure 10.7 – Registration form&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.7 – Registration form</p>
			<p>Try it out and you will see that it is working.</p>
			<p>Since the user might <a id="_idIndexMarker161"/>need to update the name, we also need to change the view on the profile page. Here, the date of birth also needs to be added:</p>
			<pre>dotnet aspnet-codegenerator identity -dc AuthSample.Data.ApplicationDbContext --files "Account.Manage.Index" -sqlite</pre>
			<p>Open the newly created <code>Index.cshtml.cs</code> that is located in the <code>/Areas/Identity/Pages/Account/Manage/</code> folder and place the following properties inside the <code>InputModel</code> class:</p>
			<pre>public class InputModel
{
    [Required]
    [Display(Name = "Display name")]
    public string Name { get; set; }
    [Display(Name = "Date of birth")]
    public DateTime DOB { get; set; }</pre>
			<p>You can now use these properties in the corresponding <code>Index.cshtml</code>. The next snippet needs to be placed between the validation summary and the username:</p>
			<pre>&lt;div class="form-floating"&gt;
    &lt;input asp-for="Input.Name" class="form-control" 
        autocomplete="name" aria-required="true" /&gt;
    &lt;label asp-for="Input.Name"&gt;&lt;/label&gt;
    &lt;span asp-validation-for="Input.Name" 
        class="text-danger"&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class="form-floating"&gt;
    &lt;input asp-for="Input.DOB" class="form-control" 
         type="date"/&gt;
    &lt;label asp-for="Input.DOB" class="form-label"&gt;&lt;/label&gt;
&lt;/div&gt;</pre>
			<p>This would be <a id="_idIndexMarker162"/>enough to display the fields, but there are some more changes needed to fill the form with saved data. Within the <code>LoadAsync</code> method, the instantiation of <code>InputModel</code> needs to be extended with the new properties:</p>
			<pre>Input = new InputModel
{
    PhoneNumber = phoneNumber,
    Name = user.Name,
    DOB = user.DOB
};</pre>
			<p>The changed values also need to get saved when the user saves the form. Place the next snippet right before the third-from-last line of the <code>OnPostAsync</code> method:</p>
			<pre>user.Name = Input.Name;
user.DOB = Input.DOB;
await _userManager.UpdateAsync(user);</pre>
			<p>This sets the <a id="_idIndexMarker163"/>values of <code>InputModel</code> to the <code>WebAppUser</code> properties and saves the changes in the database.</p>
			<p>Let's try it out by calling <code>dotnet watch</code> in the terminal.</p>
			<p>The profile page will now look similar to this:</p>
			<div><div><img src="img/Figure_10.8_B17996.jpg" alt="Figure 10.8 – Manage your account page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.8 – Manage your account page</p>
			<p>You can now change the display name and add your date of birth.</p>
			<p>If the user provides <a id="_idIndexMarker164"/>a display name, they might show it in the upper left-hand corner after the login.</p>
			<p>Open the <code>_LoginPartial.cshtml</code> that is in the <code>Views/Shared</code> folder and replace the first four lines with the following code snippet:</p>
			<pre>@using Microsoft.AspNetCore.Identity
@using AuthSample.Data
@inject SignInManager&lt;WebAppUser&gt; SignInManager
@inject UserManager&lt;WebAppUser&gt; UserManager
@{
 var user = await @UserManager.GetUserAsync(User);
}</pre>
			<p>This changes the generic type argument of <code>SignInManager</code> and <code>UserManager</code> from the <code>IdentityUser</code> type to the <code>WebAppUser</code> type. Inside the code block, the current <code>WebAppUser</code> is loaded via <code>UserManager</code> by passing the current user in.</p>
			<p>Now, the output of the username on line 12 needs to be changed to write the display name:</p>
			<pre>Hello @user?.Name!</pre>
			<p>When <code>dotnet watch</code> is still running, the application running in the browser should already be updated. Maybe you <a id="_idIndexMarker165"/>need to log in again. You should now see the display name in the upper right-hand corner:</p>
			<div><div><img src="img/Figure_10.9_B17996.jpg" alt="Figure 10.9 – Display name&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.9 – Display name</p>
			<p>That's it.</p>
			<h1 id="_idParaDest-91"><a id="_idTextAnchor162"/>Summary</h1>
			<p>In this chapter, you learned how to extend ASP.NET Core Identity to enhance the user object by adding additional properties. You also learned how to enhance the Identity UI to load, save, and update the values of the new user properties.</p>
			<p>But how would you manage roles for the users of your application?</p>
			<p>This is what you will learn in the next chapter, about configuring identity management.</p>
		</div>
	</body></html>