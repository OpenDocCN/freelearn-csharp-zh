<html><head></head><body>
  <div><h1 class="chapterNumber">13</h1>
    <h1 class="chapterTitle" id="_idParaDest-474">Building Efficient Microservices Using gRPC</h1>
    <p class="normal">In this chapter, you will be introduced to gRPC, which enables a developer to build services that can communicate highly efficiently across most platforms.</p>
    <p class="normal">However, web browsers do not have full support for programmatic access to all features of HTTP/2, which is required by gRPC. This makes gRPC most useful for implementing intermediate tier-to-tier services and microservices because they must perform a lot of communication between multiple microservices to achieve a complete task. Improving the efficiency of that communication is vital to the success of the scalability and performance of microservices. </p>
    <p class="normal">A modular monolithic, two-tier, client-to-service style service is inherently more efficient because the communication between modules is in-process and there is only one layer of network communication between the whole service and the clients.</p>
    <p class="normal">Microservice architecture has more tiers, and therefore more layers of network communication between the many microservices. It becomes more important to have highly efficient communication between those layers, and gRPC is designed to be ultra-efficient for network communication, as shown in <em class="italic">Figure 13.1</em>:</p>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_01.png"/></figure>
    <p class="packt_figref">Figure 13.1: Comparing a two-tier modular monolithic service with multi-tier microservices</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: It has been fashionable in the past decade or so to assume that microservices are best for all scenarios, and so for a new system to immediately be implemented using cool microservices rather than as a traditional monolith. More recently, there has been a pushback against this assumption. The industry seems to be settling on the recommendation to start by implementing a system as a modular monolith. Only later, if necessary, should you break the modules apart into actual microservices. As well as being inherently slower due to the extra network communication between microservices, you also need to consider whether the extra coordination and complexity of deployments and orchestration of microservices is worth it.</p>
    </div>
    <p class="normal">This chapter will cover the following topics:</p>
    <ul>
      <li class="bulletList">Understanding gRPC</li>
      <li class="bulletList">Building a gRPC service and client</li>
      <li class="bulletList">Implementing gRPC for an EF Core model</li>
      <li class="bulletList">Taking gRPC further</li>
      <li class="bulletList">Handling dates, times, and decimal numbers</li>
      <li class="bulletList">Implementing interceptors and handling faults</li>
      <li class="bulletList">Implementing gRPC JSON transcoding</li>
    </ul>
    <h1 class="heading-1" id="_idParaDest-475">Understanding gRPC</h1>
    <p class="normal">gRPC is a modern, open-source, high-performance <strong class="keyWord">Remote Procedure Call</strong> (<strong class="keyWord">RPC</strong>) framework that can run in any <a id="_idIndexMarker1404"/>environment. An <a id="_idIndexMarker1405"/>RPC is when one computer calls a procedure in another process or on another computer over a network as if it were calling a local procedure. It is an example of a client-server architecture.</p>
    <div><p class="normal">You can learn more about RPCs at the following link: <a href="https://en.wikipedia.org/wiki/Remote_procedure_call">https://en.wikipedia.org/wiki/Remote_procedure_call</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-476">How gRPC works</h2>
    <p class="normal">A gRPC service developer defines a service interface for the methods that can be called remotely, including defining the<a id="_idIndexMarker1406"/> method parameters and return types. The service implements this interface and runs a gRPC server to handle client calls.</p>
    <p class="normal">On the client, a strongly typed gRPC client provides the same methods as on the server.</p>
    <h2 class="heading-2" id="_idParaDest-477">Defining gRPC contracts with .proto files</h2>
    <p class="normal">gRPC uses contract-first API development that supports language-agnostic implementations. A <strong class="keyWord">contract</strong> in this case is <a id="_idIndexMarker1407"/>an agreement that a service will expose a defined list of methods with specified parameters and return types<a id="_idIndexMarker1408"/> that implement a prescribed behavior. A client that wishes to call the service can be certain that the service will continue to conform to the contract over time. For example, although new methods might be added, existing ones will never change or be removed.</p>
    <p class="normal">You write the contracts using <code class="inlineCode">.proto</code> files that have their own language syntax and then use tools to convert them into various languages like C#. The <code class="inlineCode">.proto</code> files are used by both the server and client to exchange messages in the correct format.</p>
    <p class="normal">Here’s an example <code class="inlineCode">.proto</code> file using <code class="inlineCode">proto3</code> syntax to define a message request that uses a custom <code class="inlineCode">enum</code>:</p>
    <pre class="programlisting code"><code class="hljs-code">// Setting the syntax must be first non-comment line.
syntax = "proto3"; // proto2 is the default.
/* When this .proto file is used in a .NET project, it will use the
   following C# namespace for the auto-generated code files. */
option csharp_namespace = "Northwind.Grpc.Service";
enum SearchType {
  SEARCHTYPE_UNSPECIFIED = 0;
  SEARCHTYPE_STARTSWITH = 1;
  SEARCHTYPE_CONTAINS = 2;
  SEARCHTYPE_ENDSWITH = 3;
}
message SearchRequest {
  string query = 1; // Fields must have order numbers.
  SearchType search_type = 2;
  int32 page = 3;
  int32 page_size = 4;
}
message SearchResponse {
  /* Message types can be nested and/or repeated to create the 
     equivalent of collections or arrays. */
  repeated SearchResult results = 1;
}
message SearchResult {
  string url = 1;
  string title = 2;
  repeated string authors = 3;
}
service Searcher {
  rpc PerformSearch (SearchRequest) returns (SearchResponse);
}
</code></pre>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: The Protobuf style<a id="_idIndexMarker1409"/> guide recommends using <a id="_idIndexMarker1410"/>all lowercase with underscores for field names, all uppercase with underscores for <code class="inlineCode">enum</code> values, and so on. The C# tooling will automatically convert to .NET styles in the auto-generated types it creates for you. You can read more recommendations at the following link: <a href="https://protobuf.dev/programming-guides/style/">https://protobuf.dev/programming-guides/style/</a>.</p>
    </div>
    <p class="normal">Fields must be given a unique number between 1 and 536,870,911. You cannot use the range 19,000 to 19,999 because<a id="_idIndexMarker1411"/> they are reserved for the Protocol Buffers implementation. These <a id="_idIndexMarker1412"/>numbers are used instead of the field name during serialization to save space in the binary format.</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Field numbers cannot be changed once you start using a message because they are tightly bound to the very efficient wire format used by gRPC. Changing a field number is the equivalent of deleting and creating a new field. You should also never reuse a field number. You can read about the consequences of misusing field numbers at the following link: <a href="https://protobuf.dev/programming-guides/proto3/#consequences">https://protobuf.dev/programming-guides/proto3/#consequences</a>.</p>
    </div>
    <p class="normal">Field data types cannot be null, so all number types default to zero (<code class="inlineCode">0</code>). Number and other field data types are shown in <em class="italic">Table 13.1</em>:</p>
    <table class="table-container" id="table001-9">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Type</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">string</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Text values. Defaults to an empty string.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">bool</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Boolean values. Defaults to <code class="inlineCode">false</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">int32</code>, <code class="inlineCode">int64</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Variable length encoded 32- and 64-bit integer values. Although they can be used for negative values, it is more efficient to use <code class="inlineCode">sint32</code> or <code class="inlineCode">sint64</code>. The C# equivalents to <code class="inlineCode">int</code> and <code class="inlineCode">long</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">sint32</code>, <code class="inlineCode">sint64</code>, <code class="inlineCode">uint32</code>, <code class="inlineCode">uint64</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Variable length encoded 32- and 64-bit signed and unsigned integer values. The C# equivalent to <code class="inlineCode">int</code> and <code class="inlineCode">long</code>, and <code class="inlineCode">uint</code> and <code class="inlineCode">ulong</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">fixed32</code>, <code class="inlineCode">fixed64</code>, <code class="inlineCode">sfixed32</code>, <code class="inlineCode">sfixed64</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Always four bytes for 32, or eight bytes for 64. The C# equivalent to <code class="inlineCode">uint</code> and <code class="inlineCode">ulong</code>, and <code class="inlineCode">int</code> and <code class="inlineCode">long</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">float</code>, <code class="inlineCode">double</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Floating point real numbers.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">bytes</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Maximum 2<sup class="superscript">32</sup> bytes (4,294,967,296). Use <code class="inlineCode">ByteString.CopyFrom(byte[] data)</code> to create a new instance. Use <code class="inlineCode">ToByteArray()</code> to get the byte array. Defaults to an empty <code class="inlineCode">ByteString</code> value.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 13.1: Number and other field data types in Protobuf</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: The official guide is found at the following link: <a href="https://protobuf.dev/programming-guides/proto3/">https://protobuf.dev/programming-guides/proto3/</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-478">gRPC benefits</h2>
    <p class="normal">gRPC minimizes network usage by using <strong class="keyWord">Protobuf</strong> binary serialization that is not human-readable, unlike JSON or XML used by<a id="_idIndexMarker1413"/> web services.</p>
    <p class="normal">gRPC requires HTTP/2, which provides significant performance benefits over earlier versions, like binary framing and compression, and multiplexing of HTTP/2 calls over a single connection.</p>
    <p class="normal">Binary framing means how the HTTP messages are transferred between the client and server. HTTP/1.x uses newline delimited plaintext. HTTP/2 splits communication into smaller messages (frames) that are encoded in binary format. Multiplexing means combining multiple messages from different sources into a single message to more efficiently use a shared resource like a network transport.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: If you are interested in more details about HTTP/2 and how it makes gRPC more efficient, you can read about it at the following link: <a href="https://grpc.io/blog/grpc-on-http2/">https://grpc.io/blog/grpc-on-http2/</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-479">gRPC limitations</h2>
    <p class="normal">The main limitation of gRPC is that it cannot be used in web browsers because no browser provides the level of control required to support a gRPC client. For example, browsers do not allow a caller<a id="_idIndexMarker1414"/> to require that HTTP/2 be used.</p>
    <p class="normal">Another limitation for developers is that due to the binary format of the messages, it is harder to diagnose and monitor issues. Many tools do not understand the format and cannot show messages in a human-readable format.</p>
    <p class="normal">There is an initiative called <strong class="keyWord">gRPC-Web</strong> that <a id="_idIndexMarker1415"/>adds an extra proxy layer, and the proxy forwards requests to the gRPC server. However, it only supports a subset of gRPC due to the listed limitations.</p>
    <h2 class="heading-2" id="_idParaDest-480">Types of gRPC methods</h2>
    <p class="normal">gRPC has four types of method.</p>
    <p class="normal">The first method is the most common:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Unary</strong> methods have structured request and response messages. A unary method completes <a id="_idIndexMarker1416"/>when the response message is returned. Unary methods should be chosen in all scenarios that do not require a stream.</li>
    </ul>
    <p class="normal">Streaming methods are used when a large amount of data must be exchanged, and they do so<a id="_idIndexMarker1417"/> by using a stream of bytes. They have the <code class="inlineCode">stream</code> keyword prefix for either an input parameter, an output parameter, or both.</p>
    <p class="normal">The three streaming methods are as follows:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Server streaming</strong> methods receive a request message from the client and return a stream. Multiple messages can be returned over the stream. A server <a id="_idIndexMarker1418"/>streaming call ends when the server side method returns, but the server side method could run until it receives a cancellation token from the client. </li>
      <li class="bulletList"><strong class="keyWord">Client streaming</strong> methods only receive a stream from the client without any message. The<a id="_idIndexMarker1419"/> server side method processes the stream until it is ready to return a response message. Once the server side method returns its message, the client streaming call is done.</li>
      <li class="bulletList"><strong class="keyWord">Bi-directional streaming</strong> methods only receive a stream from the client without any<a id="_idIndexMarker1420"/> message and only return data via a second stream. The call is done when the server side method returns. Once a bi-directional streaming method is called, the client and service can send messages to each other at any time.</li>
    </ul>
    <p class="normal">In this book, we will only look at the details of unary methods. If you would like the next edition to cover streaming methods, please let me know.</p>
    <h2 class="heading-2" id="_idParaDest-481">Microsoft’s gRPC packages</h2>
    <p class="normal">Microsoft has invested in building a set of packages for .NET to work with gRPC and, since May 2021, it is Microsoft’s <a id="_idIndexMarker1421"/>recommended implementation of gRPC for .NET.</p>
    <p class="normal">Microsoft’s gRPC for .NET includes:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">Grpc.AspNetCore</code> for hosting a gRPC service in ASP.NET Core.</li>
      <li class="bulletList"><code class="inlineCode">Grpc.Net.Client</code> for adding gRPC client support to any .NET project by building on <code class="inlineCode">HttpClient</code>.</li>
      <li class="bulletList"><code class="inlineCode">Grpc.Net.ClientFactory</code> for adding gRPC client support to any .NET code base by building on <code class="inlineCode">HttpClientFactory</code>.</li>
    </ul>
    <div><p class="normal">You can learn more <a id="_idIndexMarker1422"/>at the following link: <a href="https://github.com/grpc/grpc-dotnet">https://github.com/grpc/grpc-dotnet</a>.</p>
    </div>
    <h1 class="heading-1" id="_idParaDest-482">Building a gRPC service and client</h1>
    <p class="normal">Let’s see an example service<a id="_idIndexMarker1423"/> and client for sending and receiving simple messages.</p>
    <h2 class="heading-2" id="_idParaDest-483">Building a Hello World gRPC service</h2>
    <p class="normal">We will start by building the gRPC service <a id="_idIndexMarker1424"/>using one of the project templates provided as standard:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to create a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">ASP.NET Core gRPC Service </strong>/ <code class="inlineCode">grpc</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter13</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Grpc.Service</code></li>
          <li class="bulletList"><strong class="screenText">Enable Docker</strong>: Cleared.</li>
          <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared.</li>
          <li class="bulletList"><strong class="screenText">Enable native AOT publish</strong>: Selected.</li>
        </ul>
     
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Make sure to select <strong class="screenText">Enable native AOT publish</strong>. With .NET 8 and later, gRPC projects can be <strong class="keyWord">ahead-of-time</strong> (<strong class="keyWord">AOT</strong>) compiled for native platforms. This gives improved performance and a reduced start time, which is important for microservices that are frequently redeployed and spun up and down during scaling.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">In the <code class="inlineCode">Protos</code> folder, in <code class="inlineCode">greet.proto</code>, note that it defines a service named <code class="inlineCode">Greeter</code> with a method named <code class="inlineCode">SayHello</code> that exchanges messages named <code class="inlineCode">HelloRequest</code> and <code class="inlineCode">HelloReply</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">syntax = "proto3";
option csharp_namespace = "Northwind.Grpc.Service";
package greet;
// The greeting service definition.
service Greeter {
  // Sends a greeting
  rpc SayHello (HelloRequest) returns (HelloReply);
}
// The request message containing the user's name.
message HelloRequest {
  string name = 1;
}
// The response message containing the greetings.
message HelloReply {
  string message = 1;
}
</code></pre>
      
    <div><p class="normal">For working with <code class="inlineCode">.proto</code> files in Visual Studio Code, you can install the extension <strong class="screenText">vscode-proto3</strong> (<code class="inlineCode">zxh404.vscode-proto3</code>). For Rider, you can install the Protocol Buffers plugin from JetBrains, as shown at the following link: <a href="https://plugins.jetbrains.com/plugin/14004-protocol-buffers">https://plugins.jetbrains.com/plugin/14004-protocol-buffers</a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">In <code class="inlineCode">Northwind.Grpc.Service.csproj</code>, note that this project has native AOT publish enabled, the <code class="inlineCode">.proto</code> file is<a id="_idIndexMarker1425"/> registered for use on the server side, and the package reference for implementing a gRPC service hosted in ASP.NET Core, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;
  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;InvariantGlobalization&gt;true&lt;/InvariantGlobalization&gt;
<strong class="hljs-slc">    &lt;PublishAot&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/PublishAot&gt;</strong>
  &lt;/PropertyGroup&gt;
  &lt;ItemGroup&gt;
<strong class="hljs-slc">    &lt;Protobuf Include=</strong><strong class="hljs-string-slc">"Protos\greet.proto"</strong><strong class="hljs-slc"> GrpcServices=</strong><strong class="hljs-string-slc">"Server"</strong><strong class="hljs-slc"> /&gt;</strong>
  &lt;/ItemGroup&gt;
  &lt;ItemGroup&gt;
<strong class="hljs-slc">    &lt;PackageReference Include=</strong><strong class="hljs-string-slc">"Grpc.AspNetCore"</strong><strong class="hljs-slc"> Version=</strong><strong class="hljs-string-slc">"2.59.0"</strong><strong class="hljs-slc"> /&gt;</strong>
  &lt;/ItemGroup&gt;
&lt;/Project&gt;
</code></pre>
      
    <div><p class="normal">For JetBrains Rider, manually add <code class="inlineCode">&lt;PublishAot&gt;true&lt;/PublishAot&gt;</code> if it is missing.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Set invariant globalization to <code class="inlineCode">false</code>, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;InvariantGlobalization&gt;false&lt;/InvariantGlobalization&gt;
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Services</code> folder, in <code class="inlineCode">GreeterService.cs</code>, note that it inherits from a class named <code class="inlineCode">GreeterBase</code> and it asynchronously implements the <code class="inlineCode">Greeter</code> service contract by<a id="_idIndexMarker1426"/> having a <code class="inlineCode">SayHello</code> method that accepts a <code class="inlineCode">HelloRequest</code> input parameter and returns a <code class="inlineCode">HelloReply</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Grpc.Core;
using Northwind.Grpc.Service
namespace Northwind.Grpc.Service.Services
{
  public class GreeterService : Greeter.GreeterBase
  {
    private readonly ILogger&lt;GreeterService&gt; _logger;
    public GreeterService(ILogger&lt;GreeterService&gt; logger)
    {
      _logger = logger;
    }
    public override Task&lt;HelloReply&gt; SayHello(
      HelloRequest request, ServerCallContext context)
    {
      return Task.FromResult(new HelloReply
      {
        Message = "Hello " + request.Name
      });
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">If you are using Visual Studio 2022, in <strong class="screenText">Solution Explorer</strong>, click <strong class="screenText">Show All Files</strong>. If you are using JetBrains Rider, then hover over the <strong class="screenText">Solution</strong> pane and click the eyeball icon.</li>
      <li class="numberedList">In the <code class="inlineCode">obj\Debug\net8.0\Protos</code> folder, note the two class files named <code class="inlineCode">Greet.cs</code> and <code class="inlineCode">GreetGrpc.cs</code> that are <a id="_idIndexMarker1427"/>automatically generated from the <code class="inlineCode">greet.proto</code> file, as shown in <em class="italic">Figure 13.2</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_02.png"/></figure>
    <p class="packt_figref">Figure 13.2: The autogenerated class files from a .proto file for a gRPC service</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">In <code class="inlineCode">GreetGrpc.cs</code>, note the <code class="inlineCode">Greeter.GreeterBase</code> class that the <code class="inlineCode">GreeterService</code> class inherited from. You do not need to understand how this base class is implemented, but you should know it is what handles all the details of gRPC’s efficient communication.</li>
      <li class="numberedList">If you are using Visual Studio 2022, in <strong class="screenText">Solution Explorer</strong>, expand <strong class="screenText">Dependencies</strong>, expand <strong class="screenText">Packages</strong>, expand <strong class="screenText">Grpc.AspNetCore</strong>, and note that it has dependencies on Google’s <strong class="screenText">Google.Protobuf</strong> package, and Microsoft’s <strong class="screenText">Grpc.AspNetCore.Server.ClientFactory</strong> and <strong class="screenText">Grpc.Tools</strong> packages, as shown in <em class="italic">Figure 13.3</em>:
    <figure class="mediaobject"><img alt="" src="img/B19587_13_03.png"/></figure>
    <p class="packt_figref">Figure 13.3: The Grpc.AspNetCore package references the Grpc.Tools and Google.Protobuf packages</p>
    <div><p class="normal">The <code class="inlineCode">Grpc.Tools</code> package<a id="_idIndexMarker1428"/> generates the C# class files from the registered <code class="inlineCode">.proto</code> files, and those class files use types defined in Google’s package to implement the serialization to the Protobuf serialization format. The <code class="inlineCode">Grpc.AspNetCore.Server.ClientFactory</code> package includes both server side and client-side support for gRPC in a .NET project.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">In <code class="inlineCode">Program.cs</code>, in the section that configures services, note the call to add gRPC to the <code class="inlineCode">Services</code> collection, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddGrpc();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, in the section for configuring the HTTP pipeline, note the call to map the <code class="inlineCode">Greeter</code> service, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.MapGrpcService&lt;GreeterService&gt;();
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Properties</code> folder, open <code class="inlineCode">launchSettings.json</code> and modify the <code class="inlineCode">applicationUrl</code> setting to use port <code class="inlineCode">5131</code> for <code class="inlineCode">https</code> and port <code class="inlineCode">5132</code> for <code class="inlineCode">http</code>, as shown highlighted in<a id="_idIndexMarker1429"/> the following markup:
        <pre class="programlisting code"><code class="hljs-code">{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
<strong class="hljs-slc">      </strong><strong class="hljs-attr-slc">"</strong><strong class="hljs-attr-slc">applicationUrl"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"http://localhost:5132"</strong><strong class="hljs-punctuation-slc">,</strong>
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
<strong class="hljs-slc">      </strong><strong class="hljs-attr-slc">"applicationUrl"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"https://localhost:5131;http://localhost:5132"</strong><strong class="hljs-punctuation-slc">,</strong>
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.Grpc.Service</code> project.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-484">Project file item configuration</h2>
    <p class="normal">Before we continue, let’s quickly<a id="_idIndexMarker1430"/> review common project file item configuration syntax.</p>
    <p class="normal">Item configuration generated by Visual Studio 2022 commonly uses attributes for the item properties, as shown in the following markup:</p>
    <pre class="programlisting code"><code class="hljs-code">&lt;Protobuf Include="Protos\greet.proto" GrpcServices="Client" /&gt;
</code></pre>
    <p class="normal">Properties not explicitly set will have their default values.</p>
    <p class="normal">Item configuration generated by other tools like JetBrains Rider commonly uses child elements for the item properties, as shown in the following markup:</p>
    <pre class="programlisting code"><code class="hljs-code">&lt;Protobuf&gt;
  &lt;Include&gt;Protos\greet.proto&lt;/Include&gt;
  &lt;GrpcServices&gt;Client&lt;/&gt;
  &lt;Access&gt;Public&lt;/Access&gt;
  &lt;ProtoCompile&gt;True&lt;/ProtoCompile&gt;
  &lt;CompileOutputs&gt;True&lt;/CompileOutputs&gt;
  &lt;OutputDir&gt;obj\Debug\net8.0\&lt;/OutputDir&gt;
  &lt;Generator&gt;MSBuild:Compile&lt;/Generator&gt;
&lt;Protobuf&gt;
</code></pre>
    <p class="normal">They both usually <a id="_idIndexMarker1431"/>achieve the same ends. The first is more concise and recommended for use.</p>
    <h2 class="heading-2" id="_idParaDest-485">Building a Hello World gRPC client</h2>
    <p class="normal">We will add an<a id="_idIndexMarker1432"/> ASP.NET Core MVC website project and then add the gRPC client packages to enable it to call the gRPC service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to add a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">ASP.NET Core Web App (Model-View-Controller) </strong>/ <code class="inlineCode">mvc</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter13</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Grpc.Client.Mvc</code></li>
          <li class="bulletList"><strong class="screenText">Authentication type</strong>: None.</li>
          <li class="bulletList"><strong class="screenText">Configure for HTTPS</strong>: Selected.</li>
          <li class="bulletList"><strong class="screenText">Enable Docker</strong>: Cleared.</li>
          <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared.</li>
        </ul>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, treat warnings as errors, add package references for Microsoft’s gRPC client factory and tools, and Google’s .NET library for Protocol Buffers, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference Include="Google.Protobuf" Version="3.24.4" /&gt;
  &lt;PackageReference Include="Grpc.Net.ClientFactory" Version="2.57.0" /&gt;
  &lt;PackageReference Include="Grpc.Tools" Version="2.58.0"&gt;
    &lt;PrivateAssets&gt;all&lt;/PrivateAssets&gt;
    &lt;IncludeAssets&gt;runtime; build; native; contentfiles; 
      analyzers; buildtransitive&lt;/IncludeAssets&gt;
  &lt;/PackageReference&gt;
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: The <code class="inlineCode">Grpc.Net.ClientFactory</code> package references the <code class="inlineCode">Grpc.Net.Client</code> package that implements client-side support for gRPC in a .NET project, but it does not reference other packages like <code class="inlineCode">Grpc.Tools</code> or <code class="inlineCode">Google.Protobuf</code>. We must reference those packages explicitly. The <code class="inlineCode">Grpc.Tools</code> package is only used during development, so it is marked as <code class="inlineCode">PrivateAssets=all</code> to ensure that the tools are not published with the production website.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">In the <code class="inlineCode">Properties</code> folder, open <code class="inlineCode">launchSettings.json</code>, and for the <code class="inlineCode">https</code> profile, modify the <code class="inlineCode">applicationUrl</code> setting to use ports <code class="inlineCode">5133</code> for <code class="inlineCode">https</code> and <code class="inlineCode">5134</code> for <code class="inlineCode">http</code>, as <a id="_idIndexMarker1433"/>shown highlighted in the following partial markup:
        <pre class="programlisting code"><code class="hljs-code">"profiles": {
  ...
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"https"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">{</strong>
    "commandName": "Project",
    "dotnetRunMessages": true,
    "launchBrowser": true,
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"applicationUrl"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"https://localhost:5133;http://localhost:5134"</strong><strong class="hljs-punctuation-slc">,</strong>
    "environmentVariables": {
      "ASPNETCORE_ENVIRONMENT": "Development"
    }
</code></pre>
      </li>
      <li class="numberedList">Copy the <code class="inlineCode">Protos</code> folder from the <code class="inlineCode">Northwind.Grpc.Service</code> project/folder to the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project/folder.
    <div><p class="normal">In Visual Studio 2022, you can drag and drop to copy. In Visual Studio Code or JetBrains Rider, drag and drop while holding the <em class="keystroke">Ctrl</em> or <em class="keystroke">Cmd</em> key.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, in the <code class="inlineCode">Protos</code> folder, in <code class="inlineCode">greet.proto</code>, modify the namespace to match the namespace for the current project so that the automatically generated classes will be in the same namespace, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">option csharp_namespace = "Northwind.Grpc.Client.Mvc";
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project file, add or modify the item group that registers<a id="_idIndexMarker1434"/> the <code class="inlineCode">.proto</code> file to indicate that it is being used on the client side, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;Protobuf Include="Protos\greet.proto" GrpcServices="<strong class="hljs-string-slc">Client</strong>" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal">Visual Studio 2022 will have created the item group for you, but it will set <code class="inlineCode">GrpcServices</code> to <code class="inlineCode">Server</code> by default, so you must manually change that to <code class="inlineCode">Client</code>. For other code editors, you might have to create the whole <code class="inlineCode">&lt;ItemGroup&gt;</code> manually. JetBrains Rider has more configuration but you can ignore it.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Build the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project to ensure that the automatically generated classes are created.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, in the <code class="inlineCode">obj\Debug\net8.0\Protos</code> folder, in <code class="inlineCode">GreetGrpc.cs</code>, note the <code class="inlineCode">Greeter.GreeterClient</code> class, as partially shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public static partial class Greeter
{ 
  ...
  public partial class GreeterClient : grpc::ClientBase&lt;GreeterClient&gt;
  {
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, import the namespace for <code class="inlineCode">Greeter.GreeterClient</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.Grpc.Client.Mvc; // To use Greeter.GreeterClient.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, in the section for configuring services, write a statement to add the <code class="inlineCode">GreeterClient</code> as a named gRPC client that will be communicating with a service that is<a id="_idIndexMarker1435"/> listening on port <code class="inlineCode">5131</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddGrpcClient&lt;Greeter.GreeterClient&gt;("Greeter",
  options =&gt;
  {
    options.Address = new Uri("https://localhost:5131");
  });
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Models</code> folder, add a new class named <code class="inlineCode">HomeIndexViewModel.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">HomeIndexViewModel.cs</code>, define a class to store a greeting and an error message, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.Grpc.Client.Mvc.Models;
public class HomeIndexViewModel
{
  public string? Greeting { get; set; }  
  public string? ErrorMessage { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Controllers</code> folder, in <code class="inlineCode">HomeController.cs</code>, import the namespace to work with the gRPC client factory, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Grpc.Net.ClientFactory; // To use GrpcClientFactory.
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Controller</code> class, declare a field to store a <code class="inlineCode">Greeter Client</code> instance and set it by using the client factory in the constructor, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">public class HomeController : Controller
{
  private readonly ILogger&lt;HomeController&gt; _logger;
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> Greeter.GreeterClient _greeterClient;</strong>
  public HomeController(ILogger&lt;HomeController&gt; logger<strong class="hljs-params-slc">,</strong>
<strong class="hljs-params-slc">    GrpcClientFactory factory</strong>)
  {
    _logger = logger;
    _<strong class="hljs-slc">greeterClient = factory.CreateClient&lt;Greeter.GreeterClient&gt;(</strong><strong class="hljs-string-slc">"Greeter"</strong><strong class="hljs-slc">);</strong>
  }
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Index</code> action method, make the method asynchronous, add a <code class="inlineCode">string</code> parameter named <code class="inlineCode">name</code> with a default value of <code class="inlineCode">Henrietta</code>, and then add statements to use the gRPC client to call the <code class="inlineCode">SayHelloAsync</code> method, passing a <code class="inlineCode">HelloRequest</code> object and storing the <code class="inlineCode">HelloReply</code> response in <code class="inlineCode">ViewData</code>, while catching <a id="_idIndexMarker1436"/>any exceptions, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">public <strong class="hljs-keyword-slc">async</strong><strong class="hljs-function-slc"> Task&lt;</strong>IActionResult<strong class="hljs-function-slc">&gt;</strong> Index(<strong class="hljs-built_in-slc">string</strong><strong class="hljs-params-slc"> name = </strong><strong class="hljs-string-slc">"Henrietta"</strong>)
{
<strong class="hljs-slc">  HomeIndexViewModel model = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">();</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">try</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    HelloReply reply = </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> _greeterClient.SayHelloAsync(</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> HelloRequest { Name = name });</strong>
<strong class="hljs-slc">    model.Greeting = </strong><strong class="hljs-string-slc">"Greeting from gRPC service: "</strong><strong class="hljs-slc"> + reply.Message;</strong>
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">catch</strong><strong class="hljs-slc"> (Exception ex)</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    _logger.LogWarning(</strong><strong class="hljs-string-slc">$"Northwind.Grpc.Service is not responding."</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">    model.ErrorMessage = ex.Message;</strong>
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc"> </strong> return View(model);
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Views/Home</code>, in <code class="inlineCode">Index.cshtml</code>, after the <strong class="screenText">Welcome</strong> heading, remove the existing <code class="inlineCode">&lt;p&gt;</code> element and then add markup to render a form for the visitor to enter their name, and then if they submit and the gRPC service responds, to output the greeting, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">@using Northwind.Grpc.Client.Mvc.Models</strong>
<strong class="hljs-slc">@model HomeIndexViewModel</strong>
@{
  ViewData["Title"] = "Home Page";
}
&lt;div class="text-center"&gt;
  &lt;h1 class="display-4"&gt;Welcome&lt;/h1&gt;
<strong class="hljs-slc">  &lt;div </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc">=</strong><strong class="hljs-string-slc">"alert alert-secondary"</strong><strong class="hljs-slc">&gt;</strong>
<strong class="hljs-slc">    &lt;form&gt;</strong>
<strong class="hljs-slc">      &lt;input name=</strong><strong class="hljs-string-slc">"name"</strong><strong class="hljs-slc"> placeholder=</strong><strong class="hljs-string-slc">"Enter your name"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">      &lt;input type=</strong><strong class="hljs-string-slc">"submit"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">    &lt;/form&gt;</strong>
<strong class="hljs-slc">  &lt;/div&gt;</strong>
<strong class="hljs-slc">  @if (Model.Greeting </strong><strong class="hljs-keyword-slc">is</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">not</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    &lt;p </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc">=</strong><strong class="hljs-string-slc">"alert alert-primary"</strong><strong class="hljs-slc">&gt;@Model.Greeting&lt;/p&gt;</strong>
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc">  @if (Model.ErrorMessage </strong><strong class="hljs-keyword-slc">is</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">not</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    &lt;p </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc">=</strong><strong class="hljs-string-slc">"alert alert-danger"</strong><strong class="hljs-slc">&gt;@Model.ErrorMessage&lt;/p&gt;</strong>
<strong class="hljs-slc">  }</strong>
&lt;/div&gt;
</code></pre>
        <div><p class="normal">If you clean a gRPC project, then<a id="_idIndexMarker1437"/> you will lose the automatically generated types and see compile errors. To recreate them, simply make any change to a <code class="inlineCode">.proto</code> file or close and reopen the project/solution.</p>
        </div>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-486">Testing a gRPC service and client</h2>
    <p class="normal">Now we can start the<a id="_idIndexMarker1438"/> gRPC service and see if the MVC website can call it successfully:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start the <code class="inlineCode">Northwind.Grpc.Service</code> project without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project.</li>
      <li class="numberedList">If necessary, start a browser and navigate to the home page: <code class="inlineCode">https://localhost:5133/</code>.</li>
      <li class="numberedList">Note the greeting on the home page, as shown in <em class="italic">Figure 13.4</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_04.png"/></figure>
    <p class="packt_figref">Figure 13.4: Home page after calling the gRPC service to get a greeting</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">View the<a id="_idIndexMarker1439"/> command prompt or terminal for the ASP.NET Core MVC project and note the info messages that indicate an HTTP/2 <code class="inlineCode">POST</code> was processed by the <code class="inlineCode">greet.Greeter/SayHello</code> endpoint in about 41ms, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: System.Net.Http.HttpClient.Greeter.LogicalHandler[100]
      Start processing HTTP request POST https://localhost:5131/greet.Greeter/SayHello
info: System.Net.Http.HttpClient.Greeter.ClientHandler[100]
      Sending HTTP request POST https://localhost:5131/greet.Greeter/SayHello
info: System.Net.Http.HttpClient.Greeter.ClientHandler[101]
      Received HTTP response headers after 60.5352ms - 200
info: System.Net.Http.HttpClient.Greeter.LogicalHandler[101]
      End processing HTTP request after 69.1623ms - 200
</code></pre>
      </li>
      <li class="numberedList">Enter and submit your own name on the page.</li>
      <li class="numberedList">Close the browser and shut down the web servers.</li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-487">Implementing gRPC for an EF Core model</h1>
    <p class="normal">Now we will add a service for<a id="_idIndexMarker1440"/> working with the Northwind database to the gRPC project.</p>
    <h2 class="heading-2" id="_idParaDest-488">Implementing the gRPC service</h2>
    <p class="normal">We will reference the EF Core model that you created in <em class="chapterRef">Chapter 3</em>, <em class="italic">Building Entity Models for SQL Server Using EF Core</em>, then define a contract for the gRPC service using a <code class="inlineCode">.proto</code> file, and finally implement the service.</p>
    <p class="normal">We will start with the <code class="inlineCode">Shippers</code> table<a id="_idIndexMarker1441"/> because it is simple. Each shipper only has three properties, an <code class="inlineCode">int</code> and two <code class="inlineCode">string</code> values, and there are only three records in the table. Let’s go:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Grpc.Service</code> project, add a project reference to the Northwind database context project, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\..\Chapter03\Northwind.Common.DataContext
.SqlServer\Northwind.Common.DataContext.SqlServer.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal">The <code class="inlineCode">Include</code> path must not have a line break.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">At the command prompt or terminal, build the <code class="inlineCode">Northwind.Grpc.Service</code> project, as shown in the following command: <code class="inlineCode">dotnet build</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Grpc.Service</code> project, in the <code class="inlineCode">Protos</code> folder, add a new file (the item template is named <strong class="screenText">Protocol Buffer File</strong> in Visual Studio 2022) named <code class="inlineCode">shipper.proto</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">syntax = "proto3";
option csharp_namespace = "Northwind.Grpc.Service";
package shipper;
service Shipper {
  rpc GetShipper (ShipperRequest) returns (ShipperReply);
}
message ShipperRequest {
  int32 shipper_id = 1;
}
message ShipperReply {
  int32 shipper_id = 1;
  string company_name = 2;
  string phone = 3;
}
</code></pre>
      </li>
      <li class="numberedList">Open the project file and add an entry to include the <code class="inlineCode">shipper.proto</code> file, as shown highlighted<a id="_idIndexMarker1442"/> in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;Protobuf Include="Protos\greet.proto" GrpcServices="Server" /&gt;
<strong class="hljs-slc">  &lt;Protobuf Include=</strong><strong class="hljs-string-slc">"Protos\shipper.proto"</strong><strong class="hljs-slc"> GrpcServices=</strong><strong class="hljs-string-slc">"Server"</strong><strong class="hljs-slc"> /&gt;</strong>
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.Grpc.Service</code> project.</li>
      <li class="numberedList">In the <code class="inlineCode">Services</code> folder, add a new class file named <code class="inlineCode">ShipperService.cs</code>, and modify its contents to define a shipper service that uses the Northwind database context to return shippers, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Grpc.Core; // To use ServerCallContext.
using Northwind.EntityModels; // To use NorthwindContext.
using ShipperEntity = Northwind.EntityModels.Shipper;
namespace Northwind.Grpc.Service.Services;
public class ShipperService : Shipper.ShipperBase
{
  private readonly ILogger&lt;ShipperService&gt; _logger;
  private readonly NorthwindContext _db;
  public ShipperService(ILogger&lt;ShipperService&gt; logger,
    NorthwindContext context)
  {
    _logger = logger;
    _db = context;
  }
  public override async Task&lt;ShipperReply?&gt; GetShipper(
    ShipperRequest request, ServerCallContext context)
  {
    ShipperEntity? shipper = await _db.Shippers
      .FindAsync(request.ShipperId);
    return shipper is null ? null : ToShipperReply(shipper);
  }
  // A mapping method to convert from a Shipper in the
  // entity model to a gRPC ShipperReply.
  private ShipperReply ToShipperReply(ShipperEntity shipper)
  {
    return new ShipperReply
    {
      ShipperId = shipper.ShipperId,
      CompanyName = shipper.CompanyName,
      Phone = shipper.Phone
    };
  }
}
</code></pre>
      
    <div><p class="normal">The <code class="inlineCode">.proto</code> file generates classes that represent the messages sent to and from a gRPC service. We therefore cannot use the entity classes defined for the EF Core model. We need a helper method like <code class="inlineCode">ToShipperReply</code> that can map an instance of an entity class to an instance of the <code class="inlineCode">.proto</code>-generated classes like <code class="inlineCode">ShipperReply</code>. This could be a good use for AutoMapper, although in this case, the mapping is simple enough to hand-code.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">In <code class="inlineCode">Program.cs</code>, import <a id="_idIndexMarker1443"/>the namespace for the Northwind database context, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels; // To use AddNorthwindContext method.
</code></pre>
      </li>
      <li class="numberedList">In the section that configures services, add a call to register the Northwind database context, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddNorthwindContext();
</code></pre>
      </li>
      <li class="numberedList">In the section that configures the HTTP pipeline, after the call to register <code class="inlineCode">GreeterService</code>, add a statement to register <code class="inlineCode">ShipperService</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.MapGrpcService&lt;ShipperService&gt;();
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-489">Implementing the gRPC client</h2>
    <p class="normal">Now we can add client capabilities to the<a id="_idIndexMarker1444"/> Northwind MVC website:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Copy the <code class="inlineCode">shipper.proto</code> file from the <code class="inlineCode">Protos</code> folder in the <code class="inlineCode">Northwind.Grpc.Service</code> project to the <code class="inlineCode">Protos</code> folder in the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, in <code class="inlineCode">shipper.proto</code>, modify the namespace to match the namespace for the current project so that the automatically generated classes will be in the same namespace, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">option csharp_namespace = "Northwind.Grpc.<strong class="hljs-string-slc">Client.Mvc</strong>";
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project file, modify or add the entry to register the <code class="inlineCode">.proto</code> file as being used on the client side, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;Protobuf Include="Protos\greet.proto" GrpcServices="Client" /&gt;
  &lt;Protobuf Include="Protos\shipper.proto" GrpcServices="<strong class="hljs-string-slc">Client</strong>" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal">If you are using a code editor like JetBrains Rider that adds extra configuration, I recommend that you simplify the elements as shown in the preceding markup. If you do not, then you might get errors later in this coding task.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project file, in <code class="inlineCode">Program.cs</code>, add a statement to register the <code class="inlineCode">ShipperClient</code> class to connect to the gRPC service listening on port <code class="inlineCode">5131</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddGrpcClient&lt;Shipper.ShipperClient&gt;("Shipper",
  options =&gt;
  {
    options.Address = new Uri("https://localhost:5131");
  });
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Models</code> folder, in <code class="inlineCode">HomeIndexViewModel.cs</code>, add a property to store a summary of a shipper, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public string? ShipperSummary { get; set; }
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Controllers</code> folder, in <code class="inlineCode">HomeController.cs</code>, declare a field to store a shipper client instance and set it by using the client factory in the constructor, as <a id="_idIndexMarker1445"/>shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">public class HomeController : Controller
{
  private readonly ILogger&lt;HomeController&gt; _logger;
  private readonly Greeter.GreeterClient _greeterClient;
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> Shipper.ShipperClient _shipperClient;</strong>
  public HomeController(ILogger&lt;HomeController&gt; logger,
    GrpcClientFactory factory)
  {
    _logger = logger;
    _greeterClient = factory.CreateClient&lt;Greeter.GreeterClient&gt;("Greeter");
    _<strong class="hljs-slc">shipperClient = factory.CreateClient&lt;Shipper.ShipperClient&gt;(</strong><strong class="hljs-string-slc">"Shipper"</strong><strong class="hljs-slc">);</strong>
  }
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">HomeController.cs</code>, in the <code class="inlineCode">Index</code> action method, add a parameter named <code class="inlineCode">id</code> and statements to call the <code class="inlineCode">Shipper</code> gRPC service to get a shipper with the matching <code class="inlineCode">ShipperId</code>, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">public async Task&lt;IActionResult&gt; Index(
  string name = "Henrietta"<strong class="hljs-params-slc">, </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-params-slc"> id = </strong><strong class="hljs-number-slc">1</strong>)
{
  HomeIndexViewModel model = new();
  try
  {
    HelloReply reply = await greeterClient.SayHelloAsync(
      new HelloRequest { Name = name });
    model.Greeting = "Greeting from gRPC service: " + reply.Message;
<strong class="hljs-slc">    ShipperReply shipperReply = </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> _shipperClient.GetShipperAsync(</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> ShipperRequest { ShipperId = id });</strong>
<strong class="hljs-slc">    model.ShipperSummary = </strong><strong class="hljs-string-slc">"Shipper from gRPC service: "</strong><strong class="hljs-slc"> + </strong>
<strong class="hljs-slc">      </strong><strong class="hljs-string-slc">$"ID: </strong><strong class="hljs-subst-slc">{shipperReply.ShipperId}</strong><strong class="hljs-string-slc">, Name: </strong><strong class="hljs-subst-slc">{shipperReply.CompanyName}</strong><strong class="hljs-string-slc">,"</strong><strong class="hljs-slc"> </strong>
<strong class="hljs-slc">      + </strong><strong class="hljs-string-slc">$" Phone: </strong><strong class="hljs-subst-slc">{shipperReply.Phone}</strong><strong class="hljs-string-slc">."</strong><strong class="hljs-slc">;</strong>
  }
  catch (Exception ex)
  {
    _logger.LogWarning($"Northwind.Grpc.Service is not responding.");
    model.ErrorMessage = ex.Message;
  }
  return View();
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Views/Home</code>, in <code class="inlineCode">Index.cshtml</code>, add code to render a form for the visitor to enter a shipper ID, and render<a id="_idIndexMarker1446"/> the shipper details after the greeting, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">@using Northwind.Grpc.Client.Mvc.Models
@model HomeIndexViewModel
@{
  ViewData["Title"] = "Home Page";
}
&lt;div class="text-center"&gt;
  &lt;h1 class="display-4"&gt;Welcome&lt;/h1&gt;
  &lt;div class="alert alert-secondary"&gt;
    &lt;form&gt;
      &lt;input name="name" placeholder="Enter your name" /&gt;
      &lt;input type="submit" /&gt;
    &lt;/form&gt;
<strong class="hljs-slc">    </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">form</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">input</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">name</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"id"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">placeholder</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">Enter a shipper id"</strong><strong class="hljs-tag-slc"> /&gt;</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">input</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">type</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"submit"</strong><strong class="hljs-tag-slc"> /&gt;</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">form</strong><strong class="hljs-tag-slc">&gt;</strong>
  &lt;/div&gt;
  @if (Model.Greeting is not null)
  {
    &lt;p class="alert alert-primary"&gt;@Model.Greeting&lt;/p&gt;
  }
  @if (Model.ErrorMessage is not null)
  {
    &lt;p class="alert alert-danger"&gt;@Model.ErrorMessage&lt;/p&gt;
  }
<strong class="hljs-slc">  @if (Model.ShipperSummary is not null)</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"alert alert-primary"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">@Model.ShipperSummary</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">  }</strong>
&lt;/div&gt;
</code></pre>
      </li>
      <li class="numberedList">If your database server is <a id="_idIndexMarker1447"/>not running, for example, because you are hosting it in Docker, a virtual machine, or in the cloud, then make sure to start it.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Service</code> project without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project.</li>
      <li class="numberedList">If necessary, start a browser and navigate to the MVC website home page: <code class="inlineCode">https://localhost:5133/</code>.</li>
      <li class="numberedList">Note that an exception is thrown in the gRPC service because the <code class="inlineCode">GetShipper</code> method uses EF Core, which is attempting to dynamically compile a LINQ query, and that is not supported with native AOT compilation, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">fail: Grpc.AspNetCore.Server.ServerCallHandler[6]
      Error when executing service method 'GetShipper'.
      System.PlatformNotSupportedException: Dynamic code generation is not supported on this platform.
         at System.Reflection.Emit.AssemblyBuilder.ThrowDynamicCodeNotSupported()
...
         at Microsoft.EntityFrameworkCore.Storage.Database.CompileQuery[TResult](Expression query, Boolean async)
...
         at Northwind.Grpc.Service.Services.ShipperService.GetShipper(ShipperRequest request, ServerCallContext context) in C:\apps-services-net8\Chapter13\Northwind.Grpc.Service\Services\ShipperService.cs:line 22
...
</code></pre>
      </li>
      <li class="numberedList">Close the browser and shut down the web servers.</li>
      <li class="numberedList">In the project file, comment <a id="_idIndexMarker1448"/>out the publish AOT option, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;!--&lt;PublishAot&gt;true&lt;/PublishAot&gt;--&gt;
</code></pre>
      
    <div><p class="normal">You might be wondering what the point was of enabling AOT when we created the project and chose to implement parts of the service using EF Core, if we were just going to have to disable AOT later. Two reasons: I want you to see the error so you recognize it if you try to do similar with your own gRPC projects, and we <em class="italic">will</em> be able to use EF Core in the future with .NET 9 or .NET 10.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="16">Start the <code class="inlineCode">Northwind.Grpc.Service</code> project without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project.</li>
      <li class="numberedList">Note the shipper information on the services page, as shown in <em class="italic">Figure 13.5</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_05.png"/></figure>
    <p class="packt_figref">Figure 13.5: Home page after calling the gRPC service to get a shipper</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="19">There are three shippers in the Northwind database with IDs of 1, 2, and 3. Try entering their IDs to<a id="_idIndexMarker1449"/> ensure they can all be retrieved, and try entering an ID that does not exist, like 4.</li>
      <li class="numberedList">Close the browser and shut down the web servers.</li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-490">Taking gRPC further</h1>
    <p class="normal">Now let’s look at some more advanced topics like native AOT compilation support, getting metadata, adding deadlines, handling dates, times, and decimal types, adding interceptors, and handling exceptions and transient faults.</p>
    <h2 class="heading-2" id="_idParaDest-491">Improving a gRPC service with native AOT publish</h2>
    <p class="normal">.NET 8 introduces gRPC support for <a id="_idIndexMarker1450"/>native AOT. But as you have just seen, it is not (yet) compatible with some parts of .NET like EF Core.</p>
    <p class="normal">Let’s change our gRPC service to<a id="_idIndexMarker1451"/> use the SQL client instead of EF Core. We will leave most of the EF Core code in the project so you can switch back if you want in the future, for example, if you upgrade to EF Core 9 and it supports native AOT:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Grpc.Service</code> project, uncomment out the option to publish AOT and add a package reference for the SQL client, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;PackageReference Include="Microsoft.Data.SqlClient" Version="5.1.2" /&gt;
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Services</code> folder, in <code class="inlineCode">ShipperService.cs</code>, import namespaces for working with <code class="inlineCode">SqlClient</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Data.SqlClient; // To use SqlConnection and so on.
using System.Data; // To use CommandType.
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">GetShipper</code> method, comment out the statements to get the shipper from the Northwind data context, and replace it with code to get the shipper using <code class="inlineCode">SqlClient</code>, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">public override async Task&lt;ShipperReply?&gt; GetShipper(
  ShipperRequest request, ServerCallContext context)
{
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// We cannot use EF Core in a native AOT compiled project.</strong>
  <strong class="hljs-comment-slc">//</strong> ShipperEntity? shipper = await _db.Shippers
  <strong class="hljs-comment-slc">//</strong>   .FindAsync(request.ShipperId);
<strong class="hljs-slc">  SqlConnectionStringBuilder builder = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">();</strong>
<strong class="hljs-slc">  builder.InitialCatalog = </strong><strong class="hljs-string-slc">"Northwind"</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">  builder.MultipleActiveResultSets = </strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">  builder.Encrypt = </strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">  builder.TrustServerCertificate = </strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">  builder.ConnectTimeout = </strong><strong class="hljs-number-slc">10</strong><strong class="hljs-slc">; </strong><strong class="hljs-comment-slc">// Default is 30 seconds.</strong>
<strong class="hljs-slc">  builder.DataSource = </strong><strong class="hljs-string-slc">"."</strong><strong class="hljs-slc">; </strong><strong class="hljs-comment-slc">// To use local SQL Server.</strong>
<strong class="hljs-slc">  builder.IntegratedSecurity = </strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">/*</strong>
<strong class="hljs-comment-slc">  // To use SQL Server Authentication:</strong>
<strong class="hljs-comment-slc">  builder.UserID = Environment.GetEnvironmentVariable("MY_SQL_USR");</strong>
<strong class="hljs-comment-slc">  builder.Password = Environment.GetEnvironmentVariable("MY_SQL_PWD");</strong>
<strong class="hljs-comment-slc">  builder.PersistSecurityInfo = false;</strong>
<strong class="hljs-comment-slc">  */</strong>
<strong class="hljs-slc">  SqlConnection connection = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">(builder.ConnectionString);</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> connection.OpenAsync();</strong>
<strong class="hljs-slc">  SqlCommand cmd = connection.CreateCommand();</strong>
<strong class="hljs-slc">  cmd.CommandType = CommandType.Text;</strong>
<strong class="hljs-slc">  cmd.CommandText = </strong><strong class="hljs-string-slc">"SELECT ShipperId, CompanyName, Phone"</strong>
<strong class="hljs-slc">    + </strong><strong class="hljs-string-slc">" FROM Shippers WHERE ShipperId = @id"</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">  cmd.Parameters.AddWithValue(</strong><strong class="hljs-string-slc">"id"</strong><strong class="hljs-slc">, request.ShipperId);</strong>
<strong class="hljs-slc">  SqlDataReader r = </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> cmd.ExecuteReaderAsync(</strong>
<strong class="hljs-slc">    CommandBehavior.SingleRow);</strong>
<strong class="hljs-slc">  ShipperReply? shipper = </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// Read the expected single row.</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (</strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> r.ReadAsync())</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    shipper = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">()</strong>
<strong class="hljs-slc">    {</strong>
<strong class="hljs-slc">      ShipperId = r.GetInt32(</strong><strong class="hljs-string-slc">"ShipperId"</strong><strong class="hljs-slc">),</strong>
<strong class="hljs-slc">      CompanyName = r.GetString(</strong><strong class="hljs-string-slc">"CompanyName"</strong><strong class="hljs-slc">),</strong>
<strong class="hljs-slc">      Phone = r.GetString(</strong><strong class="hljs-string-slc">"Phone"</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    };</strong>
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> r.CloseAsync();</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> shipper;</strong>
}
</code></pre>
      </li>
      <li class="numberedList">Double-check that you have re-enabled the publish AOT option.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, we could alter a statement to use the slim builder for the web application, as <a id="_idIndexMarker1452"/>shown in <a id="_idIndexMarker1453"/>the following code:
        <pre class="programlisting code"><code class="hljs-code">// Use the slim builder to reduce the size of the application
// when using the publish AOT project option.
// var builder = WebApplication.CreateSlimBuilder(args);
</code></pre>
      
    <div><p class="normal">The <code class="inlineCode">CreateSlimBuilder</code> method does not include support for HTTPS or HTTP/3, although you can add those back in yourself if you need them. If we switch to the slim builder, then we must also switch from using HTTPS to HTTP to communicate with the gRPC service. In this task, we will continue to use the “full fat” builder so we can continue to use HTTPS.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">In the <code class="inlineCode">Northwind.Grpc.Service</code> project file, add an element to emit compiler-generated files, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;PropertyGroup&gt;
  &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
  ...
<strong class="hljs-slc">  &lt;EmitCompilerGeneratedFiles&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/EmitCompilerGeneratedFiles&gt;</strong>
&lt;/PropertyGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.Grpc.Service</code> project.</li>
      <li class="numberedList">If you are using Visual Studio 2022, toggle <strong class="screenText">Show All Files</strong> in <strong class="screenText">Solution Explorer</strong>. If you are using JetBrains Rider, hover over and then click the eyeball icon.</li>
      <li class="numberedList">Expand the <code class="inlineCode">obj\Debug\net8.0\generated</code> folder, and then note the folders and files that have been<a id="_idIndexMarker1454"/> created by the source generators for AOT and JSON serialization, as shown in <em class="italic">Figure 13.6</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_06.png"/></figure>
    <p class="packt_figref">Figure 13.6: Folders and files created by source generators in an AOT gRPC project</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">At the command<a id="_idIndexMarker1455"/> prompt or terminal, publish the gRPC service using native AOT, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet publish
</code></pre>
      </li>
      <li class="numberedList">Note the message about generating native code and trim warnings for packages like <code class="inlineCode">Microsoft.Data.SqlClient</code>, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">Generating native code
...
C:\Users\markj\.nuget\packages\microsoft.data.sqlclient\5.1.1\runtimes\win\lib\net6.0\Microsoft.Data.SqlClient.dll : warning IL2104: Assembly 'Microsoft
.Data.SqlClient' produced trim warnings. For more information see https://aka.ms/dotnet-illink/libraries [C:\apps-services-net8\Chapter13\Northwind.Grpc.Service\Northwind.Grpc.Service.csproj]
...
</code></pre>
      </li>
      <li class="numberedList">Start <strong class="screenText">File Explorer</strong> and open the <code class="inlineCode">bin\Release\net8.0\win-x64\publish</code> folder and note the EXE file is about 45 MB. This and the <code class="inlineCode">Microsoft.Data.SqlClient.SNI.dll</code> file are the only files that need to be deployed onto another Windows computer for the web service to work. The <code class="inlineCode">appsettings.json</code> files are only needed to override configuration if needed. The PDB files are only needed if debugging and, anyway, two of them are only because we left the EF Core code in the project for reference to make it easier to switch back to<a id="_idIndexMarker1456"/> non-AOT publishing.</li>
      <li class="numberedList">Open the <code class="inlineCode">bin\Release\net8.0\win-x64\publish</code> folder at the command prompt or <a id="_idIndexMarker1457"/>terminal.</li>
      <li class="numberedList">At the command prompt or terminal, run <code class="inlineCode">Northwind.Grpc.Service.exe</code> and explicitly specify the URL with the port number to use, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">Northwind.Grpc.Service.exe --urls "https://localhost:5131"
</code></pre>
      </li>
    </ol>
    <div><p class="normal">The <code class="inlineCode">launchSettings.json</code> file is only used by code editors like Visual Studio 2022 so the ports specified there are ignored and not deployed with the service in production.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="15">Start the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project.</li>
      <li class="numberedList">Note the web page shows the shipper with an ID of 1 and that you can search for the other shippers.</li>
      <li class="numberedList">Close the browser and shut down the web servers.</li>
    </ol>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn more about gRPC and native AOT at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/grpc/native-aot">https://learn.microsoft.com/en-us/aspnet/core/grpc/native-aot</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-492">Getting request and response metadata</h2>
    <p class="normal">Formally defined request and response messages as part of a contract are not the only mechanisms to pass data between a client and service using gRPC. You can also use metadata sent as headers and trailers. Both are simple dictionaries that are passed along with the messages.</p>
    <p class="normal">Let’s see how you can <a id="_idIndexMarker1458"/>get metadata about a gRPC call:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, in the <code class="inlineCode">Controllers</code> folder, in <code class="inlineCode">HomeController.cs</code>, import the namespace to use the <code class="inlineCode">AsyncUnaryCall&lt;T&gt;</code> class, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Grpc.Core; // To use AsyncUnaryCall&lt;T&gt;.
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Index</code> method, comment out the statement that makes the call to the gRPC shipper service. Add statements that get the underlying <code class="inlineCode">AsyncUnaryCall&lt;T&gt;</code> object, then use it to get the headers, output them to the log, and then get the response, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-comment-slc">//</strong> ShipperReply shipperReply = await _shipperClient.GetShipperAsync(
<strong class="hljs-comment-slc">//</strong>   new ShipperRequest { ShipperId = id });
<strong class="hljs-comment-slc">// The same call as above but not awaited.</strong>
<strong class="hljs-slc">AsyncUnaryCall&lt;ShipperReply&gt; shipperCall = _shipperClient.GetShipperAsync(</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> ShipperRequest { ShipperId = id });</strong>
<strong class="hljs-slc">Metadata metadata = </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> shipperCall.ResponseHeadersAsync;</strong>
<strong class="hljs-keyword-slc">foreach</strong><strong class="hljs-slc"> (Metadata.Entry entry </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> metadata)</strong>
<strong class="hljs-slc">{</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// Not really critical, just doing this to make it easier to see.</strong>
<strong class="hljs-slc">  _logger.LogCritical(</strong><strong class="hljs-string-slc">$"Key: </strong><strong class="hljs-subst-slc">{entry.Key}</strong><strong class="hljs-string-slc">, Value: </strong><strong class="hljs-subst-slc">{entry.Value}</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">}</strong>
<strong class="hljs-slc">ShipperReply shipperReply = </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> shipperCall.ResponseAsync;</strong>
ViewData["shipper"] = "Shipper from gRPC service: " + 
  $"ID: {shipperReply.ShipperId}, Name: {shipperReply.CompanyName},"
  + $" Phone: {shipperReply.Phone}.";
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Service</code> project without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project.</li>
      <li class="numberedList">If necessary, start a browser and navigate to the home page: <code class="inlineCode">https://localhost:5133/</code>.</li>
      <li class="numberedList">Note the client successfully making <code class="inlineCode">POST</code> requests to the gRPC <code class="inlineCode">Greeter</code> and <code class="inlineCode">Shipper</code> services<a id="_idIndexMarker1459"/> and the red critical messages outputting the two entries in the gRPC metadata for the call to <code class="inlineCode">GetShipper</code>, with keys of <code class="inlineCode">date</code> and <code class="inlineCode">server</code>, as shown in <em class="italic">Figure 13.7</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_07.png"/></figure>
    <p class="packt_figref">Figure 13.7: Logging metadata from a gRPC call</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Close the browser and shut down the web servers.</li>
    </ol>
    <div><p class="normal">The trailers equivalent of the <code class="inlineCode">ResponseHeadersAsync</code> property is the <code class="inlineCode">GetTrailers</code> method. It has a return value of <code class="inlineCode">Metadata</code> that contains the dictionary of trailers. Trailers are accessible at the end of a call.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-493">Adding a deadline for higher reliability</h2>
    <p class="normal">Setting a deadline for a gRPC call is<a id="_idIndexMarker1460"/> recommended practice because it controls the upper limit of how long a gRPC call can run. It prevents gRPC services from potentially consuming too many server resources.</p>
    <p class="normal">The deadline information is sent to the service, so the service has an opportunity to give up its work once the deadline has passed instead of continuing forever. Even if the server completes its work within the deadline, the client may give up before the response arrives at the client because the deadline has passed due to the overhead of communication.</p>
    <p class="normal">Let’s see an example:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Grpc.Service</code> project, in the <code class="inlineCode">Services</code> folder, in <code class="inlineCode">ShipperService.cs</code>, in the <code class="inlineCode">GetShipper</code> method, add statements to log the deadline and to pause for five seconds, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">public override async Task&lt;ShipperReply&gt; GetShipper(
  ShipperRequest request, ServerCallContext context)
{
<strong class="hljs-slc">  _logger.LogCritical(</strong><strong class="hljs-string-slc">$"This request has a deadline of </strong><strong class="hljs-subst-slc">{</strong>
<strong class="hljs-subst-slc">    context.Deadline:T}</strong><strong class="hljs-string-slc">. It is now </strong><strong class="hljs-subst-slc">{DateTime.UtcNow:T}</strong><strong class="hljs-string-slc">."</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> Task.Delay(TimeSpan.FromSeconds(</strong><strong class="hljs-number-slc">5</strong><strong class="hljs-slc">));</strong>
  ...
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Grpc.Service</code> project, in <code class="inlineCode">appsettings.Development.json</code>, modify the logging level for ASP.NET Core from the default of <code class="inlineCode">Warning</code> to <code class="inlineCode">Information</code>, as shown highlighted in the following configuration:
        <pre class="programlisting code"><code class="hljs-code">{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "<strong class="hljs-string-slc">Information</strong>"
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, in the <code class="inlineCode">Controllers</code> folder, in <code class="inlineCode">HomeController.cs</code>, in the <code class="inlineCode">Index</code> method, set a deadline of three seconds when calling the <code class="inlineCode">GetShipperAsync</code> method, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">AsyncUnaryCall&lt;ShipperReply&gt; shipperCall = shipperClient.GetShipperAsync(
  new ShipperRequest { ShipperId = id }<strong class="hljs-slc">,</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// Deadline must be a UTC DateTime.</strong>
  <strong class="hljs-slc">deadline: DateTime.UtcNow.AddSeconds(</strong><strong class="hljs-number-slc">3</strong><strong class="hljs-slc">)</strong>);
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">HomeController.cs</code>, in the <code class="inlineCode">Index</code> method, before the existing <code class="inlineCode">catch</code> block, add a <code class="inlineCode">catch</code> block<a id="_idIndexMarker1461"/> for an <code class="inlineCode">RpcException</code> when the exception’s status code matches the code for deadline exceeded, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">catch</strong><strong class="hljs-slc"> (RpcException rpcex) </strong><strong class="hljs-keyword-slc">when</strong><strong class="hljs-slc"> (rpcex.StatusCode == </strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">global</strong><strong class="hljs-slc">::Grpc.Core.StatusCode.DeadlineExceeded)</strong>
<strong class="hljs-slc">{</strong>
<strong class="hljs-slc">  _logger.LogWarning(</strong><strong class="hljs-string-slc">"Northwind.Grpc.Service deadline exceeded."</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">  model.ErrorMessage = rpcex.Message;</strong>
<strong class="hljs-slc">}</strong>
catch (Exception ex)
{
  _logger.LogWarning($"Northwind.Grpc.Service is not responding.");
  model.ErrorMessage = ex.Message;
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, in <code class="inlineCode">appsettings.Development.json</code>, modify the logging level for ASP.NET Core from the default of <code class="inlineCode">Warning</code> to <code class="inlineCode">Information</code>, as shown highlighted in the following configuration:
        <pre class="programlisting code"><code class="hljs-code">{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "<strong class="hljs-string-slc">Information</strong>"
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Service</code> project without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project.</li>
      <li class="numberedList">If necessary, start a browser and navigate to the home page: <code class="inlineCode">https://localhost:5133/</code>.</li>
      <li class="numberedList">At the command <a id="_idIndexMarker1462"/>prompt or terminal for the gRPC service, note the request has a three-second deadline, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">crit: Northwind.Grpc.Service.Services.ShipperService[0]
      This request has a deadline of 14:56:30. It is now 14:56:27.
</code></pre>
      </li>
      <li class="numberedList">In the browser, note that after three seconds, the home page shows a deadline exceeded exception, as shown in <em class="italic">Figure 13.8</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_08.png"/></figure>
    <p class="packt_figref">Figure 13.8: A deadline has been exceeded</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="11">At the command prompt or terminal for the ASP.NET Core MVC client, note the logs that start at the<a id="_idIndexMarker1463"/> point where a request is made to the <code class="inlineCode">GetShipper</code> method on the gRPC service, but the deadline is exceeded, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: System.Net.Http.HttpClient.Shipper.LogicalHandler[100]
      Start processing HTTP request POST https://localhost:5131/shipper.Shipper/GetShipper
info: System.Net.Http.HttpClient.Shipper.ClientHandler[100]
      Sending HTTP request POST https://localhost:5131/shipper.Shipper/GetShipper
warn: Grpc.Net.Client.Internal.GrpcCall[7]
      gRPC call deadline exceeded.
info: Grpc.Net.Client.Internal.GrpcCall[3]
      Call failed with gRPC error status. Status code: 'DeadlineExceeded', Message: ''.
</code></pre>
      </li>
      <li class="numberedList">Close the browser and shut down the web servers.</li>
      <li class="numberedList">In <code class="inlineCode">ShipperService.cs</code>, comment out the statement that causes a five-second delay, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-comment-slc">//</strong> await Task.Delay(TimeSpan.FromSeconds(5));
</code></pre>
      </li>
    </ol>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: The default is no deadline. Always set a deadline in the client call. In your service implementation, get the deadline and use it to automatically abandon the work if it is exceeded. Pass the cancellation token to any asynchronous calls so that work completes quickly on the server and frees up resources.</p>
    </div>
    <h1 class="heading-1" id="_idParaDest-494">Handling dates, times, and decimal numbers</h1>
    <p class="normal">You might have noted that there<a id="_idIndexMarker1464"/> are no date/time types built into gRPC. To store these values, you must use well-known type extensions, for example, <code class="inlineCode">google.protobuf.Timestamp</code> (equivalent to <code class="inlineCode">DateTimeOffset</code>) and <code class="inlineCode">google.protobuf.Duration</code> (equivalent to <code class="inlineCode">TimeSpan</code>).</p>
    <p class="normal">To use them as field types in a message, they must be imported, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">syntax = "proto3";
import "google/protobuf/duration.proto";  
import "google/protobuf/timestamp.proto";
message Employee {
  int32 employeeId = 1;
  google.protobuf.Timestamp birth_date = 2;
  google.protobuf.Duration earned_vacation_time = 3;
  ...
}
</code></pre>
    <p class="normal">The class generated will not use .NET types directly. Instead, there are intermediate types, as shown in the <a id="_idIndexMarker1465"/>following code:</p>
    <pre class="programlisting code"><code class="hljs-code">public class Employee
{
  public int EmployeeId;
  public Timestamp BirthDate;
  public Duration EarnedVacationTime;
}
</code></pre>
    <p class="normal">There are conversion methods on the types <code class="inlineCode">FromDateTimeOffset</code>, <code class="inlineCode">ToDateTimeOffset</code>, <code class="inlineCode">FromTimeSpan</code>, and <code class="inlineCode">ToTimeSpan</code>, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">Employee employee = new()
{
  EmployeeId = 1,
  BirthDate = Timestamp.FromDateTimeOffset(new DateTimeOffset(
    year: 1998, month: 11, day: 30, hour: 0, minute: 0, second: 0,
    offset: TimeSpan.FromHours(-5)),
  EarnedVacationTime = Duration.FromTimeSpan(TimeSpan.FromDays(15))
};
DateTimeOffset when = employee.BirthDate.ToDateTimeOffset();
TimeSpan daysoff = employee.EarnedVacationTime.ToTimeSpan();
</code></pre>
    <p class="normal">gRPC also does not natively support <code class="inlineCode">decimal</code> values. In the future, that support might be added, but for now, you must create a custom message to represent it. If you choose to do this, then keep in mind that developers on other platforms will have to understand your custom format and implement their own handling for it.</p>
    <h2 class="heading-2" id="_idParaDest-495">Defining a custom decimal type and using date/time types</h2>
    <p class="normal">Let’s add gRPC services for working with <a id="_idIndexMarker1466"/>products (which have a <code class="inlineCode">UnitPrice</code> property<a id="_idIndexMarker1467"/> that is a <code class="inlineCode">decimal</code>) and employees (which have <code class="inlineCode">HireDate</code> properties that are <code class="inlineCode">DateTime</code> values):</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Grpc.Service</code> project, in the <code class="inlineCode">Protos</code> folder, add a new file named <code class="inlineCode">decimal.proto</code>, and add statements to define a message format for safely storing a <code class="inlineCode">decimal</code> value, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">syntax = "proto3";
option csharp_namespace = "Northwind.Grpc.Service";
package decimal;
// Example: 12345.6789 -&gt; { units = 12345, nanos = 678900000 }
message DecimalValue {
    // To store the whole units part of the amount.
    int64 units = 1;
    // To store the nano units of the amount (10^-9).
    // Must be same sign as units.
    sfixed32 nanos = 2;
}
</code></pre>
      </li>
      <li class="numberedList">Add a new file named <code class="inlineCode">product.proto</code>, and add statements to define messages and service methods to get one product, all products, or products that cost a minimum price, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">syntax = "proto3";
option csharp_namespace = "Northwind.Grpc.Service";
import "Protos/decimal.proto";
package product;
service Product {
  rpc GetProduct (ProductRequest) returns (ProductReply);
  rpc GetProducts (ProductsRequest) returns (ProductsReply);
  rpc GetProductsMinimumPrice (ProductsMinimumPriceRequest) 
      returns (ProductsReply);
}
message ProductRequest {
  int32 product_id = 1;
}
message ProductsRequest {
}
message ProductsMinimumPriceRequest {
  decimal.DecimalValue minimum_price = 1;
}
message ProductReply {
  int32 product_id = 1;
  string product_name = 2;
  int32 supplier_id = 3;
  int32 category_id = 4;
  string quantity_per_unit = 5;
  decimal.DecimalValue unit_price = 6;
  int32 units_in_stock = 7;
  int32 units_on_order = 8;
  int32 reorder_level = 9;
  bool discontinued = 10;
}
message ProductsReply {
  repeated ProductReply products = 1;
}
</code></pre>
      </li>
      <li class="numberedList">Add a new file named <code class="inlineCode">employee.proto</code>, and modify it to define messages and service methods<a id="_idIndexMarker1468"/> to get one employee or all employees, and note we<a id="_idIndexMarker1469"/> must import the Google extension for <code class="inlineCode">timestamp.proto</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">syntax = "proto3";
option csharp_namespace = "Northwind.Grpc.Service";
import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";
package employee;
service Employee {
  rpc GetEmployee (EmployeeRequest) returns (EmployeeReply);
  rpc GetEmployees (EmployeesRequest) returns (EmployeesReply);
}
message EmployeeRequest {
  int32 employee_id = 1;
}
message EmployeesRequest {
}
message EmployeeReply {
  int32 employee_id = 1;
  string last_name = 2;
  string first_name = 3;
  string title = 4;
  string title_of_courtesy = 5;
  google.protobuf.Timestamp birth_date = 6;
  google.protobuf.Timestamp hire_date = 7;
  string address = 8;
  string city = 9;
  string region = 10;
  string postal_code = 11;
  string country = 12;
  string home_phone = 13;
  string extension = 14;
  bytes photo = 15;
  string notes = 16;
  int32 reports_to = 17;
  string photo_path = 18;
}
message EmployeesReply {
  repeated EmployeeReply employees = 1;
}
</code></pre>
      </li>
      <li class="numberedList">In the project file, add <a id="_idIndexMarker1470"/>elements to tell the gRPC tool to process the<a id="_idIndexMarker1471"/> new <code class="inlineCode">.proto</code> files, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;Protobuf Include="Protos\greet.proto" GrpcServices="Server" /&gt;
  &lt;Protobuf Include="Protos\shipper.proto" GrpcServices="Server" /&gt;
<strong class="hljs-slc">  &lt;Protobuf Include=</strong><strong class="hljs-string-slc">"Protos\decimal.proto"</strong><strong class="hljs-slc"> GrpcServices=</strong><strong class="hljs-string-slc">"Server"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;Protobuf Include=</strong><strong class="hljs-string-slc">"Protos\product.proto"</strong><strong class="hljs-slc"> GrpcServices=</strong><strong class="hljs-string-slc">"Server"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;Protobuf Include=</strong><strong class="hljs-string-slc">"Protos\employee.proto"</strong><strong class="hljs-slc"> GrpcServices=</strong><strong class="hljs-string-slc">"Server"</strong><strong class="hljs-slc"> /&gt;</strong>
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Rebuild the project to <a id="_idIndexMarker1472"/>make sure the gRPC tool has created the <a id="_idIndexMarker1473"/>C# classes in the <code class="inlineCode">obj\Debug\net8.0\Protos</code> folder, as shown in <em class="italic">Figure</em> <em class="italic">13.9</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_09.png"/></figure>
    <p class="packt_figref">Figure 13.9: gRPC tool-generated classes for a custom decimal type with a Units property</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">In the <code class="inlineCode">Northwind.Grpc.Service</code> project, add a new folder named <code class="inlineCode">Converters</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">Converters</code> folder, add a new class file named <code class="inlineCode">DecimalValue.Converters.cs</code>, and modify its contents to extend the partial class created by the gRPC tools with a constructor and a pair of operators to convert between our custom <code class="inlineCode">DecimalValue</code> type and the built-in .NET <code class="inlineCode">decimal</code> type, as shown<a id="_idIndexMarker1474"/> in the following<a id="_idIndexMarker1475"/> code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.Grpc.Service;
// This will merge with the DecimalValue type generated by the
// gRPC tools in the obj\Debug\net8.0\Protos\Decimal.cs file.
public partial class DecimalValue
{
  private const decimal NanoFactor = 1_000_000_000;
  public DecimalValue(long units, int nanos)
  {
    Units = units;
    Nanos = nanos;
  }
  public static implicit operator decimal(DecimalValue grpcDecimal)
  {
    return grpcDecimal.Units + (grpcDecimal.Nanos / NanoFactor);
  }
  public static implicit operator DecimalValue(decimal value)
  {
    long units = decimal.ToInt64(value);
    int nanos = decimal.ToInt32((value - units) * NanoFactor);
    return new DecimalValue(units, nanos);
  }
}
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-496">Implementing the product and employee gRPC services</h2>
    <p class="normal">Now we need to<a id="_idIndexMarker1476"/> implement and register the services:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Grpc.Service</code> project, in the <code class="inlineCode">Services</code> folder, add a new class file named <code class="inlineCode">ProductService.cs</code> and modify its content to implement the products service. I will leave this as an optional exercise for you, or you can copy the code from the following link: <a href="https://github.com/markjprice/apps-services-net8/blob/main/code/Chapter13/Northwind.Grpc.Service/Services/ProductService.cs">https://github.com/markjprice/apps-services-net8/blob/main/code/Chapter13/Northwind.Grpc.Service/Services/ProductService.cs</a>.</li>
      <li class="numberedList">In the <code class="inlineCode">Services</code> folder, add a new class file named <code class="inlineCode">EmployeeService.cs</code> and modify its content to implement the products service. I will leave this as an optional exercise<a id="_idIndexMarker1477"/> for you, or you can copy the code from the following link: <a href="https://github.com/markjprice/apps-services-net8/blob/main/code/Chapter13/Northwind.Grpc.Service/Services/EmployeeService.cs">https://github.com/markjprice/apps-services-net8/blob/main/code/Chapter13/Northwind.Grpc.Service/Services/EmployeeService.cs</a>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, register the two new services, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.MapGrpcService&lt;ProductService&gt;();
app.MapGrpcService&lt;EmployeeService&gt;();
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-497">Adding product and employee gRPC clients</h2>
    <p class="normal">Next, we need to add clients to the<a id="_idIndexMarker1478"/> MVC project to call the two new gRPC services:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, copy the three <code class="inlineCode">.proto</code> files from the service project to the MVC project <code class="inlineCode">Protos</code> folder.</li>
      <li class="numberedList">In the three <code class="inlineCode">.proto</code> files, modify the namespace, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">option csharp_namespace = "Northwind.Grpc.Client.Mvc";
</code></pre>
      </li>
      <li class="numberedList">In the project file, register the three files to create client-side representations, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;Protobuf Include="Protos\greet.proto" GrpcServices="Client" /&gt;
  &lt;Protobuf Include="Protos\shipper.proto" GrpcServices="Client" /&gt;
<strong class="hljs-slc">  &lt;Protobuf Include=</strong><strong class="hljs-string-slc">"Protos\decimal.proto"</strong><strong class="hljs-slc"> GrpcServices=</strong><strong class="hljs-string-slc">"Client"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;Protobuf Include=</strong><strong class="hljs-string-slc">"Protos\employee.proto"</strong><strong class="hljs-slc"> GrpcServices=</strong><strong class="hljs-string-slc">"Client"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;Protobuf Include=</strong><strong class="hljs-string-slc">"Protos\product.proto"</strong><strong class="hljs-slc"> GrpcServices=</strong><strong class="hljs-string-slc">"Client"</strong><strong class="hljs-slc"> /&gt;</strong>
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal">If you are using a code editor like JetBrains Rider that adds extra configuration, I recommend that you simplify the elements as shown in the preceding markup. If you do not, then you might get errors later in this coding task.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Copy the <code class="inlineCode">Converters</code> folder<a id="_idIndexMarker1479"/> from the gRPC project to the MVC project.</li>
      <li class="numberedList">In the <code class="inlineCode">Converters</code> folder, in <code class="inlineCode">DecimalValue.Converters.cs</code>, modify the namespace to use the client, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.Grpc.<strong class="hljs-title-slc">Client.Mvc</strong>;
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, in <code class="inlineCode">Program.cs</code>, add statements to register clients for the two new services, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddGrpcClient&lt;Product.ProductClient&gt;("Product",
  options =&gt;
  {
    options.Address = new Uri("https://localhost:5131");
  });
builder.Services.AddGrpcClient&lt;Employee.EmployeeClient&gt;("Employee",
  options =&gt;
  {
    options.Address = new Uri("https://localhost:5131");
  });
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Controllers</code> folder, in <code class="inlineCode">HomeController.cs</code>, add two fields for the two new clients and set them in the constructor. (Hint: follow the same pattern as for greeter and shipper.)</li>
      <li class="numberedList">In <code class="inlineCode">HomeController.cs</code>, add two action methods for products and employees, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public async Task&lt;IActionResult&gt; Products(decimal minimumPrice = 0M)
{
  ProductsReply reply = await _productClient.GetProductsMinimumPriceAsync(
    new ProductsMinimumPriceRequest() { MinimumPrice = minimumPrice });
  return View(reply.Products);
}
public async Task&lt;IActionResult&gt; Employees()
{
  EmployeesReply reply = await _employeeClient.GetEmployeesAsync(
    new EmployeesRequest());
  return View(reply.Employees);
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Views\Shared</code> folder, in <code class="inlineCode">_Layout.cshtml</code>, after the menu item for navigating to the <a id="_idIndexMarker1480"/>home page, add menu items for navigating to products and employees, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;li class="nav-item"&gt;
  &lt;a class="nav-link text-dark" asp-area="" asp-controller="Home" asp-action="Index"&gt;Home&lt;/a&gt;
&lt;/li&gt;
<strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"nav-item"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"nav-link text-dark"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">asp-area</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">""</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">asp-controller</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"Home"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">asp-action</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"Products"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Products</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"nav-item"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">nav-link text-dark"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">asp-area</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">""</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">asp-controller</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"Home"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">asp-action</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"Employees"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Employees</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc">&gt;</strong>
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Views\Home</code> folder, add a new Razor View file named <code class="inlineCode">Products.cshtml</code>, and modify it to show a table of products, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">@using Google.Protobuf.Collections
@using Northwind.Grpc.Client.Mvc
@model RepeatedField&lt;ProductReply&gt;
@{
  ViewData["Title"] = "Products";
  decimal price = 0;
}
&lt;h1&gt;@ViewData["Title"]&lt;/h1&gt;
&lt;table class="table table-primary table-bordered"&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Product ID&lt;/th&gt;
      &lt;th&gt;Product Name&lt;/th&gt;
      &lt;th&gt;Unit Price&lt;/th&gt;
      &lt;th&gt;Units In Stock&lt;/th&gt;
      &lt;th&gt;Units On Order&lt;/th&gt;
      &lt;th&gt;Reorder Level&lt;/th&gt;
      &lt;th&gt;Discontinued&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    @foreach (ProductReply p in Model)
    {
      &lt;tr&gt;
        &lt;td&gt;@p.ProductId&lt;/td&gt;
        &lt;td&gt;@p.ProductName&lt;/td&gt;
        @{ price = p.UnitPrice; }
        &lt;td&gt;@price.ToString("C")&lt;/td&gt;
        &lt;td&gt;@p.UnitsInStock&lt;/td&gt;
        &lt;td&gt;@p.UnitsOnOrder&lt;/td&gt;
        &lt;td&gt;@p.ReorderLevel&lt;/td&gt;
        &lt;td&gt;@p.Discontinued&lt;/td&gt;
      &lt;/tr&gt;
    }
  &lt;/tbody&gt;
&lt;/table&gt;
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Views\Home</code> folder, add a new Razor View file named <code class="inlineCode">Employees.cshtml</code>, and <a id="_idIndexMarker1481"/>modify it to show a table of employees, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">@using Google.Protobuf.Collections
@using Northwind.Grpc.Client.Mvc
@model RepeatedField&lt;EmployeeReply&gt;
@{
  ViewData["Title"] = "Employees";
}
&lt;h1&gt;@ViewData["Title"]&lt;/h1&gt;
&lt;table class="table table-primary table-bordered"&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Employee ID&lt;/th&gt;
      &lt;th&gt;Full Name&lt;/th&gt;
      &lt;th&gt;Job Title&lt;/th&gt;
      &lt;th&gt;Address&lt;/th&gt;
      &lt;th&gt;Birth Date&lt;/th&gt;
      &lt;th&gt;Photo&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    @foreach (EmployeeReply e in Model)
    {
      &lt;tr&gt;
        &lt;td&gt;@e.EmployeeId&lt;/td&gt;
        &lt;td&gt;@e.TitleOfCourtesy @e.FirstName @e.LastName&lt;/td&gt;
        &lt;td&gt;@e.Title&lt;/td&gt;
        &lt;td&gt;@e.Address&lt;br /&gt;@e.City&lt;br /&gt;@e.Region&lt;br /&gt;
            @e.PostalCode&lt;br /&gt;@e.Country&lt;/td&gt;
        &lt;td&gt;@e.BirthDate.ToDateTimeOffset().ToString("D")&lt;/td&gt;
        &lt;td&gt;&lt;img src="data:image/jpg;base64,
          @Convert.ToBase64String(e.Photo.ToByteArray())" /&gt;
        &lt;/td&gt;
      &lt;/tr&gt;
    }
  &lt;/tbody&gt;
&lt;/table&gt;
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-498">Testing decimal, date, and bytes handling</h2>
    <p class="normal">Finally, we can test the specialized type<a id="_idIndexMarker1482"/> handling we implemented:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start the <code class="inlineCode">Northwind.Grpc.Service</code> project without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project.</li>
      <li class="numberedList">On the home page, in the top navigation bar, click <strong class="screenText">Products</strong>, and note all products are included in the table, as shown in <em class="italic">Figure 13.10</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_10.png"/></figure>
    <p class="packt_figref">Figure 13.10: Products including unit prices that use a custom decimal implementation</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Enter a minimum <a id="_idIndexMarker1483"/>price such as <code class="inlineCode">100</code>, click <strong class="screenText">Filter Products</strong>, and note that only products with a unit price of that amount or more are included in the table.</li>
      <li class="numberedList">In the top navigation bar, click <strong class="screenText">Employees</strong>, and note employees and their birth dates and photos are included in the table, as shown in <em class="italic">Figure 13.11</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_11.png"/></figure>
    <p class="packt_figref">Figure 13.11: Employees including birth dates and photos using timestamp and bytes</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Close the browser <a id="_idIndexMarker1484"/>and shut down the web servers.</li>
    </ol>
    <p class="normal">You’ve now seen how to use gRPC to build several services that work with data. Now let’s see some more advanced features of gRPC.</p>
    <h1 class="heading-1" id="_idParaDest-499">Implementing interceptors and handling faults</h1>
    <p class="normal">gRPC interceptors are a way to perform additional processing during requests and responses and they can be injected at the client or service. They are often used for logging, monitoring, and validation.</p>
    <h2 class="heading-2" id="_idParaDest-500">Adding a client-side interceptor</h2>
    <p class="normal">Let’s add a client-side gRPC interceptor<a id="_idIndexMarker1485"/> for logging:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, add a new folder named <code class="inlineCode">Interceptors</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">Interceptors</code> folder, add a new class file named <code class="inlineCode">ClientLoggingInterceptor.cs</code>, and then add statements to define an interceptor, as shown in<a id="_idIndexMarker1486"/> the following code:
        <pre class="programlisting code"><code class="hljs-code">using Grpc.Core.Interceptors; // To use Interceptor and so on.
using Grpc.Core; // To use AsyncUnaryCall&lt;T&gt;.
namespace Northwind.Grpc.Client.Mvc.Interceptors;
public class ClientLoggingInterceptor : Interceptor
{
  private readonly ILogger _logger;
  public ClientLoggingInterceptor(ILoggerFactory loggerFactory)
  {
    _logger = loggerFactory.CreateLogger&lt;ClientLoggingInterceptor&gt;();
  }
  public override AsyncUnaryCall&lt;TResponse&gt; 
    AsyncUnaryCall&lt;TRequest, TResponse&gt;(TRequest request,
    ClientInterceptorContext&lt;TRequest, TResponse&gt; context,
    AsyncUnaryCallContinuation&lt;TRequest, TResponse&gt; continuation)
  {
    _logger.LogWarning("Starting call. Type: {0}. Method: {1}.",
      context.Method.Type, context.Method.Name);
    return continuation(request, context);
  }
}
</code></pre>
      
    <div><p class="normal">Interceptors form a pipeline, so in your interceptor, you must call the next interceptor in the pipeline, represented by the <code class="inlineCode">continuation</code> delegate, and pass it the <code class="inlineCode">request</code> and <code class="inlineCode">context</code>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, in <code class="inlineCode">Program.cs</code>, before any of the calls to add gRPC services, add a call to register the interceptor as a singleton service, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">// Register the interceptor before attaching it to a gRPC client.
builder.Services.AddSingleton&lt;ClientLoggingInterceptor&gt;();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, at the end of the statement to register the product client, add the interceptor, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddGrpcClient&lt;Product.ProductClient&gt;("Product",
  options =&gt;
  {
    options.Address = new Uri("https://localhost:5131");
  })
  <strong class="hljs-slc">.AddInterceptor&lt;ClientLoggingInterceptor&gt;()</strong>;
</code></pre>
        <div><p class="normal">You can attach the logging interceptor to as many clients as you want.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Start the <code class="inlineCode">Northwind.Grpc.Service</code> project without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project.</li>
      <li class="numberedList">On the home page, in the top navigation bar, click <strong class="screenText">Products</strong>.</li>
      <li class="numberedList">In the MVC website <a id="_idIndexMarker1487"/>project command prompt or terminal, note the warning, which will be distinct from information messages as it is yellow-on-black by default, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">warn: Northwind.Grpc.Client.Mvc.Interceptors.ClientLoggingInterceptor[0]
      Starting call. Type: Unary. Method: GetProductsMinimumPrice.
</code></pre>
      </li>
      <li class="numberedList">Close the browser and shut down the web servers.</li>
    </ol>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You might be thinking, “Interceptors sound a lot like ASP.NET Core middleware!” You can read a useful comparison at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/grpc/interceptors#grpc-interceptors-versus-middleware">https://learn.microsoft.com/en-us/aspnet/core/grpc/interceptors#grpc-interceptors-versus-middleware</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-501">Exception and transient fault handling</h2>
    <p class="normal">gRPC has built-in support to automatically retry failed calls, which is a good way to handle transient faults like <a id="_idIndexMarker1488"/>temporary network disconnects and down or busy services.</p>
    <p class="normal">In the client, an <code class="inlineCode">RpcException</code> could be thrown that includes details of the error.</p>
    <p class="normal">First, let’s add a transient fault to the gRPC service and see how the client handles it:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Grpc.Service</code> project, in the <code class="inlineCode">Services</code> folder, in <code class="inlineCode">GreeterService.cs</code>, modify the <code class="inlineCode">SayHello</code> method to wait for one second and then, randomly, one in three times it should work but two in three times throw a service unavailable exception, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public override <strong class="hljs-keyword-slc">async</strong> Task&lt;HelloReply&gt; SayHello(
  HelloRequest request, ServerCallContext context)
{
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> Task.Delay(</strong><strong class="hljs-number-slc">1000</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (Random.Shared.Next(</strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">, </strong><strong class="hljs-number-slc">4</strong><strong class="hljs-slc">) == </strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">  {</strong>
    return new HelloReply
    {
      Message = "Hello " + request.Name
    };
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">else</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-keyword-slc">throw</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> RpcException(</strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> Status(StatusCode.Unavailable,</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-string-slc">"Service is temporarily unavailable. Try again later."</strong><strong class="hljs-slc">));</strong>
<strong class="hljs-slc">  }</strong>
}
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Service</code> project without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project.</li>
      <li class="numberedList">On the home page, note the exception, as shown in <em class="italic">Figure 13.12</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_12.png"/></figure>
    <p class="packt_figref">Figure 13.12: Service is unavailable exception</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">If you don’t get an exception, refresh the page until you do.</li>
      <li class="numberedList">Close the browser and shut down the web servers.</li>
    </ol>
    <p class="normal">Now, let’s see how to add transient fault handling to the MVC website client:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project, in <code class="inlineCode">Program.cs</code>, before adding the greeter client to the services collection, add statements to define a <code class="inlineCode">MethodConfig</code> with a retry<a id="_idIndexMarker1489"/> policy that retries up to five times for status codes indicating an unavailable service, and then after configuring the greeter client address, apply the <code class="inlineCode">method config</code>, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">MethodConfig configForAllMethods = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">() </strong>
<strong class="hljs-slc">{</strong>
<strong class="hljs-slc">  Names = { MethodName.Default },</strong>
<strong class="hljs-slc">  RetryPolicy = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> RetryPolicy</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    MaxAttempts = </strong><strong class="hljs-number-slc">5</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">    InitialBackoff = TimeSpan.FromSeconds(</strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">),</strong>
<strong class="hljs-slc">    MaxBackoff = TimeSpan.FromSeconds(</strong><strong class="hljs-number-slc">5</strong><strong class="hljs-slc">),</strong>
<strong class="hljs-slc">    BackoffMultiplier = </strong><strong class="hljs-number-slc">1.5</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">    RetryableStatusCodes = { StatusCode.Unavailable }</strong>
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc">};</strong>
builder.Services.AddGrpcClient&lt;Greeter.GreeterClient&gt;("Greeter",
  options =&gt;
  {
    options.Address = new Uri("https://localhost:5131");
  })
<strong class="hljs-slc">  .ConfigureChannel(channel =&gt;</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    channel.ServiceConfig = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> ServiceConfig</strong>
<strong class="hljs-slc">    {</strong>
<strong class="hljs-slc">      MethodConfigs = { configForAllMethods }</strong>
<strong class="hljs-slc">    };</strong>
<strong class="hljs-slc">  })</strong>;
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Service</code> project without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Grpc.Client.Mvc</code> project.</li>
      <li class="numberedList">On the home page, note the home page might take a few seconds to appear, but eventually, it <a id="_idIndexMarker1490"/>will successfully appear with the <code class="inlineCode">Hello Henrietta</code> message from the gRPC service, and if you review the gRPC service output, it will include multiple attempts to call <code class="inlineCode">SayHello</code> before finally working, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Microsoft.AspNetCore.Hosting.Diagnostics[1]
      Request starting HTTP/2 POST https://localhost:5131/greet.Greeter/SayHello - application/grpc -
info: Microsoft.AspNetCore.Routing.EndpointMiddleware[0]
      Executing endpoint 'gRPC - /greet.Greeter/SayHello'
info: Grpc.AspNetCore.Server.ServerCallHandler[7]
      Error status code 'Unavailable' with detail 'Service is temporarily unavailable. Try again later.' raised.
info: Microsoft.AspNetCore.Routing.EndpointMiddleware[1]
      Executed endpoint 'gRPC - /greet.Greeter/SayHello'
info: Microsoft.AspNetCore.Hosting.Diagnostics[2]
      Request finished HTTP/2 POST https://localhost:5131/greet.Greeter/SayHello - 200 0 application/grpc 1039.4626ms
info: Microsoft.AspNetCore.Hosting.Diagnostics[1]
      Request starting HTTP/2 POST https://localhost:5131/greet.Greeter/SayHello - application/grpc -
info: Microsoft.AspNetCore.Routing.EndpointMiddleware[0]
      Executing endpoint 'gRPC - /greet.Greeter/SayHello'
info: Grpc.AspNetCore.Server.ServerCallHandler[7]
      Error status code 'Unavailable' with detail 'Service is temporarily unavailable. Try again later.' raised.
info: Microsoft.AspNetCore.Routing.EndpointMiddleware[1]
      Executed endpoint 'gRPC - /greet.Greeter/SayHello'
info: Microsoft.AspNetCore.Hosting.Diagnostics[2]
      Request finished HTTP/2 POST https://localhost:5131/greet.Greeter/SayHello - 200 0 application/grpc 1008.1375ms
info: Microsoft.AspNetCore.Hosting.Diagnostics[1]
      Request starting HTTP/2 POST https://localhost:5131/greet.Greeter/SayHello - application/grpc -
info: Microsoft.AspNetCore.Routing.EndpointMiddleware[0]
      Executing endpoint 'gRPC - /greet.Greeter/SayHello'
info: Microsoft.AspNetCore.Routing.EndpointMiddleware[1]
      Executed endpoint 'gRPC - /greet.Greeter/SayHello'
info: Microsoft.AspNetCore.Hosting.Diagnostics[2]
      Request finished HTTP/2 POST https://localhost:5131/greet.Greeter/SayHello - 200 - application/grpc 1016.4590ms
</code></pre>
      </li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-502">Implementing gRPC JSON transcoding</h1>
    <p class="normal">JSON is the most popular format for services that return data to a browser or mobile device. It would be great if we<a id="_idIndexMarker1491"/> could create a gRPC service and magically make it callable via non-HTTP/2 using JSON. </p>
    <p class="normal">Thankfully, there is a solution.</p>
    <p class="normal">Microsoft has a technology they call <strong class="keyWord">gRPC JSON transcoding</strong>. It is an ASP.NET Core extension that creates HTTP endpoints with JSON for gRPC services, based on Google’s <code class="inlineCode">HttpRule</code> class for their gRPC transcoding.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can read about Google’s <code class="inlineCode">HttpRule</code> class at the following link: <a href="https://cloud.google.com/dotnet/docs/reference/Google.Api.CommonProtos/latest/Google.Api.HttpRule">https://cloud.google.com/dotnet/docs/reference/Google.Api.CommonProtos/latest/Google.Api.HttpRule</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-503">Enabling gRPC JSON transcoding</h2>
    <p class="normal">Let’s see how to enable<a id="_idIndexMarker1492"/> gRPC JSON transcoding in our gRPC service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Grpc.Service</code> project, add a package reference for gRPC JSON transcoding, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference Include="Grpc.AspNetCore" Version="2.59.0" /&gt;
  &lt;PackageReference Include="Microsoft.Data.SqlClient" Version="5.1.2" /&gt;
<strong class="hljs-slc">  &lt;PackageReference Include=</strong><strong class="hljs-string-slc">"Microsoft.AspNetCore.Grpc.JsonTranscoding"</strong><strong class="hljs-slc"> </strong>
<strong class="hljs-slc">                    Version=</strong><strong class="hljs-string-slc">"8.0.0"</strong><strong class="hljs-slc"> /&gt;</strong>
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.Grpc.Service</code> project to restore packages.</li>
      <li class="numberedList">In <code class="inlineCode">appsettings.json</code>, modify the <code class="inlineCode">Protocols</code> option to enable HTTP/1.1 as well as HTTP/2, as shown highlighted<a id="_idIndexMarker1493"/> in the following markup:
        <pre class="programlisting code"><code class="hljs-code">{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Kestrel": {
    "EndpointDefaults": {
      "Protocols": "<strong class="hljs-string-slc">Http1AndHttp2</strong>"
    }
  }
}
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: By default, a gRPC project will be configured to only allow HTTP/2 requests. To support clients like <code class="inlineCode">.http</code> files in your code editor, or Unity, enable both HTTP/1.1 and HTTP/2. Allowing HTTP/1.1 and HTTP/2 on the same port requires TLS for protocol negotiation, which is another good reason to leave HTTPS enabled in a gRPC service and therefore not use <code class="inlineCode">CreateSlimBuilder</code>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">In <code class="inlineCode">Program.cs</code>, add a call to add JSON transcoding after the call to add gRPC, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddGrpc()<strong class="hljs-slc">.AddJsonTranscoding()</strong>;
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Grpc.Service</code> project/folder, add a folder named <code class="inlineCode">google</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">google</code> folder, add a folder named <code class="inlineCode">api</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">api</code> folder, add two <code class="inlineCode">.proto</code> files named <code class="inlineCode">http.proto</code> and <code class="inlineCode">annotations.proto</code>.</li>
      <li class="numberedList">Copy and paste the raw contents for the two files from the files found at the following link: <a href="https://github.com/dotnet/aspnetcore/tree/main/src/Grpc/JsonTranscoding/test/testassets/Sandbox/google/api">https://github.com/dotnet/aspnetcore/tree/main/src/Grpc/JsonTranscoding/test/testassets/Sandbox/google/api</a>.</li>
      <li class="numberedList">In the <code class="inlineCode">Protos</code> folder, in <code class="inlineCode">employee.proto</code>, import the annotations <code class="inlineCode">.proto</code> file, and use it to add an<a id="_idIndexMarker1494"/> option to expose an endpoint to make an HTTP request to the <code class="inlineCode">GetEmployee</code> method, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">syntax = "proto3";
option csharp_namespace = "Northwind.Grpc.Service";
import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";
<strong class="hljs-slc">import </strong><strong class="hljs-string-slc">"google/api/annotations.proto"</strong><strong class="hljs-slc">;</strong>
package employee;
service Employee {
  rpc GetEmployee (EmployeeRequest) returns (EmployeeReply) <strong class="hljs-slc">{</strong>
<strong class="hljs-slc">    option (google.api.http) = {</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">: </strong><strong class="hljs-string-slc">"/v1/employee/{employee_id}"</strong>
<strong class="hljs-slc">    };</strong>
<strong class="hljs-slc">  }</strong>;
  rpc GetEmployees (EmployeesRequest) returns (EmployeesReply);
}
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-504">Testing gRPC JSON transcoding</h2>
    <p class="normal">Now we can start the gRPC <a id="_idIndexMarker1495"/>service and call it directly from any browser:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start the <code class="inlineCode">Northwind.Grpc.Service</code> project.</li>
      <li class="numberedList">Start any browser, show the developer tools, and click the <strong class="screenText">Network</strong> tab to start recording network traffic.</li>
      <li class="numberedList">Navigate to a URL to make a <code class="inlineCode">GET</code> request that will call the <code class="inlineCode">GetEmployee</code> method, <code class="inlineCode">https://localhost:5131/v1/employee/1</code>, and note the JSON response returned by the gRPC service, as shown in <em class="italic">Figure 13.13</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_13_13.png"/></figure>
    <p class="packt_figref">Figure 13.13: Making an HTTP 1.1 GET request to a gRPC service and receiving a response in JSON</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">In your code editor, in <a id="_idIndexMarker1496"/>the <code class="inlineCode">HttpRequests</code> folder, create a new file named <code class="inlineCode">grpc-json-transcoding.http</code>, and add statements to make requests for employees using HTTP/1.1, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">### Configure a variable for the gRPC service base address.
@base_address = https://localhost:5131/
### Get Nancy Davolio.
GET {{base_address}}v1/employee/1
### Get Andrew Fuller Davolio.
GET {{base_address}}v1/employee/2
</code></pre>
      </li>
      <li class="numberedList">Send both requests, confirm the responses are correct, and then review the gRPC service command prompt or terminal to confirm that the requests were made using HTTP/1.1, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Microsoft.AspNetCore.Hosting.Diagnostics[1]
      Request starting HTTP/1.1 GET https://localhost:5131/v1/employee/2 - - -
info: Microsoft.AspNetCore.Routing.EndpointMiddleware[0]
      Executing endpoint 'gRPC - /v1/employee/{employee_id}'
info: Microsoft.AspNetCore.Routing.EndpointMiddleware[1]
      Executed endpoint 'gRPC - /v1/employee/{employee_id}'
info: Microsoft.AspNetCore.Hosting.Diagnostics[2]
      Request finished HTTP/1.1 GET https://localhost:5131/v1/employee/2 - 200 - application/json;+charset=utf-8 7.9328ms
</code></pre>
      </li>
      <li class="numberedList">Close the <code class="inlineCode">.http</code> file, close <a id="_idIndexMarker1497"/>the browser, and shut down the web server.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-505">Comparing with gRPC-Web</h2>
    <p class="normal"><strong class="keyWord">gRPC-Web</strong> is an alternative to gRPC JSON transcoding to allow gRPC services to be called from a browser. gRPC-Web achieves <a id="_idIndexMarker1498"/>this by executing a gRPC-Web client inside the browser. This has the advantage that the communications between the browser and gRPC service use Protobuf and therefore get all the performance and scalability benefits of true gRPC communication.</p>
    <p class="normal">As you have seen, gRPC JSON transcoding allows browsers to call gRPC services as if they were HTTP APIs with JSON. The browser needs to know nothing about gRPC. The gRPC service is responsible for converting those HTTP API calls into calls to the actual gRPC service implementation.</p>
    <p class="normal">To simplify and summarize:</p>
    <ul>
      <li class="bulletList">gRPC JSON transcoding happens on the server side.</li>
      <li class="bulletList">gRPC-Web happens on the client side.</li>
    </ul>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Add gRPC JSON transcoding support to all your gRPC services hosted in ASP.NET Core. This provides the best of both worlds. Clients that cannot use gRPC natively can call the Web API. Clients that can use gRPC natively can call it directly.</p>
    </div>
    <h1 class="heading-1" id="_idParaDest-506">Practicing and exploring</h1>
    <p class="normal">Test your knowledge and understanding by answering some questions, getting some hands-on practice, and exploring this chapter’s topics with deeper research.</p>
    <h2 class="heading-2" id="_idParaDest-507">Exercise 13.1 – Test your knowledge</h2>
    <p class="normal">Answer the following questions:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">What are three benefits of gRPC that make it a good choice for implementing services?</li>
      <li class="numberedList">How are contracts defined in gRPC?</li>
      <li class="numberedList">Which of the following .NET types require extensions to be imported: <code class="inlineCode">int</code>, <code class="inlineCode">double</code>, or <code class="inlineCode">DateTime</code>?</li>
      <li class="numberedList">Why should you set a deadline when calling a gRPC method?</li>
      <li class="numberedList">What are the benefits of enabling gRPC JSON transcoding to a gRPC service hosted in ASP.NET Core?</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-508">Exercise 13.2 – Compare gRPC services with HTTP APIs</h2>
    <p class="normal">Review the article found at the following link:</p>
    <p class="normal"><a href="https://learn.microsoft.com/en-us/aspnet/core/grpc/comparison">https://learn.microsoft.com/en-us/aspnet/core/grpc/comparison</a></p>
    <h2 class="heading-2" id="_idParaDest-509">Exercise 13.3 – Explore topics</h2>
    <p class="normal">Use the links on the following page to learn more details about the topics covered in this chapter:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-13---building-efficient-microservices-using-grpc">https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-13---building-efficient-microservices-using-grpc</a></p>
    <h1 class="heading-1" id="_idParaDest-510">Summary</h1>
    <p class="normal">In this chapter, you:</p>
    <ul>
      <li class="bulletList">Learned about some concepts of gRPC services, how they work, and their benefits.</li>
      <li class="bulletList">Implemented a simple gRPC service.</li>
      <li class="bulletList">Implemented a gRPC service that uses an EF Core model that cannot yet use AOT publish.</li>
      <li class="bulletList">Implemented a gRPC service that uses <code class="inlineCode">SqlClient</code> libraries that can use AOT publish and are therefore smaller and faster.</li>
      <li class="bulletList">Learned how to set deadlines and read metadata sent as headers and trailers.</li>
      <li class="bulletList">Implemented a custom <code class="inlineCode">decimal</code> type and used extended date/time types.</li>
      <li class="bulletList">Implemented a client-side interceptor.</li>
      <li class="bulletList">Extended a gRPC service with support for being called as an HTTP service with JSON, to support clients that cannot work with gRPC natively.</li>
    </ul>
    <p class="normal">In the next chapter, you will review how to build website user interfaces using ASP.NET Core MVC.</p>
  </div>
</body></html>