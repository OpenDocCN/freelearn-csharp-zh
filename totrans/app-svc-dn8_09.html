<html><head></head><body>
  <div><h1 class="chapterNumber">9</h1>
    <h1 class="chapterTitle" id="_idParaDest-342">Caching, Queuing, and Resilient Background Services</h1>
    <p class="normal">In this chapter, you will be introduced to multiple technologies and techniques that will improve the scalability and reliability of your services, no matter what service technology you choose to implement them with.</p>
    <p class="normal">This chapter will cover the following topics:</p>
    <ul>
      <li class="bulletList">Understanding service architecture</li>
      <li class="bulletList">Caching with ASP.NET Core</li>
      <li class="bulletList">Fault tolerance with Polly</li>
      <li class="bulletList">Queuing with RabbitMQ</li>
      <li class="bulletList">Implementing long-running background services</li>
    </ul>
    <h1 class="heading-1" id="_idParaDest-343">Understanding service architecture</h1>
    <p class="normal">In <em class="chapterRef">Chapter 8</em>, <em class="italic">Building and Securing Web Services Using Minimal APIs</em>, you learned how to build a web service using ASP.NET Core Minimal APIs. Before looking at alternative technologies to <a id="_idIndexMarker858"/>build services, it is worth taking a step back and reviewing service architecture and what causes bottlenecks in service performance and scalability.</p>
    <h2 class="heading-2" id="_idParaDest-344">What parts of a system are slowest?</h2>
    <p class="normal">Traditionally, the <a id="_idIndexMarker859"/>slowest parts of a system are:</p>
    <ul>
      <li class="bulletList">The network (slowest)</li>
      <li class="bulletList">The disk</li>
      <li class="bulletList">Memory</li>
      <li class="bulletList">CPU cache memory (fastest)</li>
    </ul>
    <p class="normal">Each step can be 5 to 10 times slower than the next.</p>
    <p class="normal">However, networks are much faster than they used to be, and systems often run within remote data centers. Imagine your service needs some data. Is it faster to read from the local server disk or to<a id="_idIndexMarker860"/> make a call to another server?</p>
    <ul>
      <li class="bulletList">Server-to-server call within the same data center: 500,000 nanoseconds (ns)</li>
      <li class="bulletList">Disk seek: 10,000,000 ns</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-345">Numbers every (developer) should know</h2>
    <p class="normal">Jeff Dean, a Google Fellow, quotes<a id="_idIndexMarker861"/> in his presentations the actual times in nanoseconds (ns) for various technologies to access or read data. They are shown in <em class="italic">Table 9.1</em>, and I have added a column to scale the numbers to be more comprehensible to a human:</p>
    <table class="table-container" id="table001-7">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Technology</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Actual</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Humanized</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">CPU cycle</p>
          </td>
          <td class="table-cell">
            <p class="normal">0.1 ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">1 second</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">L1 cache reference</p>
          </td>
          <td class="table-cell">
            <p class="normal">½ ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">5 seconds</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">L2 cache reference</p>
          </td>
          <td class="table-cell">
            <p class="normal">5 ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">1 minute</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Mutex lock/unlock</p>
          </td>
          <td class="table-cell">
            <p class="normal">25 ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">4 minutes</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Main memory reference</p>
          </td>
          <td class="table-cell">
            <p class="normal">100 ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">¼ hour</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Send 1K byte over 1 Gbps network</p>
          </td>
          <td class="table-cell">
            <p class="normal">10,000 ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">28 hours</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Read 1 MB sequentially from memory</p>
          </td>
          <td class="table-cell">
            <p class="normal">250,000 ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">29 days</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Round trip within same datacenter</p>
          </td>
          <td class="table-cell">
            <p class="normal">500,000 ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">2 months</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Read 1 MB sequentially from SSD</p>
          </td>
          <td class="table-cell">
            <p class="normal">1,000,000 ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">4 months</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Disk seek</p>
          </td>
          <td class="table-cell">
            <p class="normal">10,000,000 ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">3¼ years</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Read 1 MB sequentially from disk</p>
          </td>
          <td class="table-cell">
            <p class="normal">20,000,000 ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">6¼ years</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Send packet CA-&gt;Netherlands-&gt;CA</p>
          </td>
          <td class="table-cell">
            <p class="normal">150,000,000 ns</p>
          </td>
          <td class="table-cell">
            <p class="normal">47½ years</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 9.1: Nanosecond times for various technologies to access or read data</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: <em class="italic">Designs, Lessons, and Advice from Building Large Distributed Systems</em>, by Jeff Dean, <a href="http://www.cs.cornell.edu/projects/ladis2009/talks/dean-keynote-ladis2009.pdf">http://www.cs.cornell.edu/projects/ladis2009/talks/dean-keynote-ladis2009.pdf</a>.</p>
    </div>
    <p class="normal">The point is not to debate if reading from drives or SSDs is faster or not than network calls. It is more about being aware of the differences between getting data that’s close and data that’s far away. The orders of magnitude are comparatively massive.</p>
    <p class="normal">For example, if a CPU needs to<a id="_idIndexMarker862"/> process some data and it is already in the L1 cache, then it takes the equivalent of 1 second. If it needs to read the data from memory, it takes the equivalent of a quarter of an hour. If it needs to fetch that data from a server in the same data center, it takes the equivalent of 2 months. And if it is in California and the data is in the Netherlands, it takes the equivalent of 47½ years!</p>
    <p class="normal">This is why caching is so important. Caching is about temporarily storing data as close to where it will be needed as possible.</p>
    <h1 class="heading-1" id="_idParaDest-346">Caching with ASP.NET Core</h1>
    <p class="normal">Caching can <a id="_idIndexMarker863"/>enable our systems to copy some data from a remote data center to a local data center, or from a server or disk to memory. Caches store data as key-value pairs.</p>
    <p class="normal">However, one of the<a id="_idIndexMarker864"/> hardest parts of caching is getting the balance right between storing enough data and keeping it fresh. The more data we copy, the more resources we use. And we need to consider how we will keep the copies synchronized with the original data.</p>
    <h2 class="heading-2" id="_idParaDest-347">General caching guidelines</h2>
    <p class="normal">Caching works best <a id="_idIndexMarker865"/>with data that costs a lot to generate and does not change often.</p>
    <p class="normal">Follow these guidelines when caching:</p>
    <ul>
      <li class="bulletList">Your code should never depend on cached data. It should always be able to get the data from the original source when the data is not found in the cache.</li>
      <li class="bulletList">Wherever you cache data (in-memory or in a database) it is a limited resource, so deliberately limit the amount of data cached and for how long by implementing expirations and size limits. You should monitor cache hits (when data is successfully found in the cache) to obtain the right balance for your specific scenarios.</li>
    </ul>
    <p class="normal">In the coding tasks in this section, you will implement all of these guidelines.</p>
    <p class="normal">Let’s start by reviewing the <a id="_idIndexMarker866"/>caching technologies built-in to ASP.NET Core.</p>
    <h2 class="heading-2" id="_idParaDest-348">Building a controller-based Web API service</h2>
    <p class="normal">To explore<a id="_idIndexMarker867"/> various caching technologies, let’s build <a id="_idIndexMarker868"/>a basic web service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to create a new Web API controller-based project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">ASP.NET Core Web API</strong> / <code class="inlineCode">webapi --use-controllers</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter09</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.WebApi.Service</code></li>
          <li class="bulletList"><strong class="screenText">Authentication type</strong>: <strong class="screenText">None</strong></li>
          <li class="bulletList"><strong class="screenText">Configure for HTTPS</strong>: Selected</li>
          <li class="bulletList"><strong class="screenText">Enable Docker</strong>: Cleared</li>
          <li class="bulletList"><strong class="screenText">Use controllers</strong>: Selected</li>
          <li class="bulletList"><strong class="screenText">Enable OpenAPI support</strong>: Selected</li>
          <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared</li>
        </ul>
      
    <div><p class="normal">Make sure to select the <strong class="screenText">Use controllers</strong> checkbox or specify the <code class="inlineCode">--use-controllers</code> or <code class="inlineCode">-controllers</code> switch. We will not use minimal APIs, which is the default way a Web API is implemented using the .NET 8 project templates. If you use JetBrains Rider, you might want to use the <code class="inlineCode">dotnet new</code> command until Rider supports a <strong class="screenText">Use controllers</strong> option.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Add a project reference to the Northwind database context project for the SQL Server that you created in <em class="chapterRef">Chapter 3</em>, <em class="italic">Building Entity Models for SQL Server Using EF Core</em>, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\..\Chapter03\Northwind.Common.DataContext
.SqlServer\Northwind.Common.DataContext.SqlServer.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal">The path cannot have a line break. If you did not complete the task of creating the class libraries in <em class="chapterRef">Chapter 3</em>, then download the solution projects from the GitHub repository.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">In the project<a id="_idIndexMarker869"/> file, change invariant globalization to <code class="inlineCode">false</code>, and treat warnings as errors, as shown<a id="_idIndexMarker870"/> in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;
  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;InvariantGlobalization&gt;<strong class="hljs-literal-slc">false</strong>&lt;/InvariantGlobalization&gt;
<strong class="hljs-slc">    &lt;TreatWarningsAsErrors&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/TreatWarningsAsErrors&gt;</strong>
  &lt;/PropertyGroup&gt;
</code></pre>
        <div><p class="normal">Explicitly setting invariant globalization to <code class="inlineCode">true</code> is new in the ASP.NET Core Web API project template with .NET 8. It is designed to make a web service non-culture-specific so that it can be deployed anywhere in the world and have the same behavior. By setting this property to <code class="inlineCode">false</code>, the web service will default to the culture of the current computer it is hosted on. You can read more about invariant globalization mode at the following link: <a href="https://github.com/dotnet/runtime/blob/main/docs/design/features/globalization-invariant-mode.md">https://github.com/dotnet/runtime/blob/main/docs/design/features/globalization-invariant-mode.md</a>.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">At the command prompt or terminal, build the <code class="inlineCode">Northwind.WebApi.Service</code> project to make sure the entity model class library projects outside the current solution are properly compiled, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet build
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Properties</code> folder, in <code class="inlineCode">launchSettings.json</code>, modify the <code class="inlineCode">applicationUrl</code> of <a id="_idIndexMarker871"/>the profile named <code class="inlineCode">https</code> to use port <code class="inlineCode">5091</code> for <code class="inlineCode">https</code> and port <code class="inlineCode">5092</code> for <code class="inlineCode">http</code>, as <a id="_idIndexMarker872"/>highlighted in the following configuration:
        <pre class="programlisting code"><code class="hljs-code">"profiles": {
  ...
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"</strong><strong class="hljs-attr-slc">https"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">{</strong>
    "commandName": "Project",
    "dotnetRunMessages": true,
    "launchBrowser": true,
    "launchUrl": "swagger",
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"applicationUrl"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"https://localhost:5091;http://localhost:5092"</strong><strong class="hljs-punctuation-slc">,</strong>
    "environmentVariables": {
      "ASPNETCORE_ENVIRONMENT": "Development"
    }
</code></pre>
      
    <div><p class="normal">Visual Studio 2022 and JetBrains Rider will read this settings file and automatically run a web browser if <code class="inlineCode">launchBrowser</code> is <code class="inlineCode">true</code>, and then navigate to the <code class="inlineCode">applicationUrl</code> and <code class="inlineCode">launchUrl</code>. Visual Studio Code and <code class="inlineCode">dotnet run</code> will not, so you will need to run a web browser and navigate manually to <a href="https://localhost:5091/swagger">https://localhost:5091/swagger</a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Delete the file named <code class="inlineCode">WeatherForecast.cs</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">Controllers</code> folder, delete the file named <code class="inlineCode">WeatherForecastController.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, import the namespace to add the <code class="inlineCode">NorthwindContext</code> to configured services, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> Northwind.EntityModels; </strong><strong class="hljs-comment-slc">// To use the AddNorthwindContext method.</strong>
var builder = WebApplication.CreateBuilder(args);
// Add services to the container.
<strong class="hljs-slc">builder.Services.AddNorthwindContext();</strong>
builder.Services.AddControllers();
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Controllers</code> folder, add a new class file named <code class="inlineCode">ProductsController.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">ProductsController.cs</code>, modify its contents to define a controller-based Web API to work with products in the Northwind database, as we did for minimal APIs, as <a id="_idIndexMarker873"/>shown in<a id="_idIndexMarker874"/> the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.AspNetCore.Mvc; // To use [HttpGet] and so on.
using Northwind.EntityModels; // To use NorthwindContext, Product.
namespace Northwind.WebApi.Service.Controllers;
[Route("api/products")]
[ApiController]
public class ProductsController : ControllerBase
{
  private int pageSize = 10;
  private readonly ILogger&lt;ProductsController&gt; _logger;
  private readonly NorthwindContext _db;
  public ProductsController(ILogger&lt;ProductsController&gt; logger, 
    NorthwindContext context)
  {
    _logger = logger;
    _db = context;
  }
  // GET: api/products
  [HttpGet]
  [Produces(typeof(Product[]))]
  public IEnumerable&lt;Product&gt; Get(int? page)
  {
    return _db.Products
      .Where(p =&gt; p.UnitsInStock &gt; 0 &amp;&amp; !p.Discontinued)
      .OrderBy(product =&gt; product.ProductId)
      .Skip(((page ?? 1) - 1) * pageSize)
      .Take(pageSize);
  }
  // GET: api/products/outofstock
  [HttpGet]
  [Route("outofstock")]
  [Produces(typeof(Product[]))]
  public IEnumerable&lt;Product&gt; GetOutOfStockProducts()
  {
    return _db.Products
      .Where(p =&gt; p.UnitsInStock == 0 &amp;&amp; !p.Discontinued);
  }
  // GET: api/products/discontinued
  [HttpGet]
  [Route("discontinued")]
  [Produces(typeof(Product[]))]
  public IEnumerable&lt;Product&gt; GetDiscontinuedProducts()
  {
    return _db.Products
      .Where(product =&gt; product.Discontinued);
  }
  // GET api/products/5
  [HttpGet("{id:int}")]
  public async ValueTask&lt;Product?&gt; Get(int id)
  {
    return await _db.Products.FindAsync(id);
  }
  // GET api/products/cha
  [HttpGet("{name}")]
  public IEnumerable&lt;Product&gt; Get(string name)
  {
    return _db.Products.Where(p =&gt; p.ProductName.Contains(name));
  }
  // POST api/products
  [HttpPost]
  public async Task&lt;IActionResult&gt; Post([FromBody] Product product)
  {
    _db.Products.Add(product);
    await _db.SaveChangesAsync();
    return Created($"api/products/{product.ProductId}", product);
  }
  // PUT api/products/5
  [HttpPut("{id}")]
  public async Task&lt;IActionResult&gt; Put(int id, [FromBody] Product product)
  {
    Product? foundProduct = await _db.Products.FindAsync(id);
    if (foundProduct is null) return NotFound();
    foundProduct.ProductName = product.ProductName;
    foundProduct.CategoryId = product.CategoryId;
    foundProduct.SupplierId = product.SupplierId;
    foundProduct.QuantityPerUnit = product.QuantityPerUnit;
    foundProduct.UnitsInStock = product.UnitsInStock;
    foundProduct.UnitsOnOrder = product.UnitsOnOrder;
    foundProduct.ReorderLevel = product.ReorderLevel;
    foundProduct.UnitPrice = product.UnitPrice;
    foundProduct.Discontinued = product.Discontinued;
    await _db.SaveChangesAsync();
    return NoContent();
  }
  // DELETE api/products/5
  [HttpDelete("{id}")]
  public async Task&lt;IActionResult&gt; Delete(int id)
  {
    if (await _db.Products.FindAsync(id) is Product product)
    {
      _db.Products.Remove(product);
      await _db.SaveChangesAsync();
      return NoContent();
    }
    return NotFound();
  }
}
</code></pre>
      </li>
      <li class="numberedList">If your database server is not running, for example, because you are hosting it in Docker, a virtual machine, or the cloud, then make sure to start it.</li>
      <li class="numberedList">Start the web service project using the <code class="inlineCode">https</code> profile without debugging.<ul>
          <li class="bulletList">If you are using Visual Studio 2022, then select the <strong class="screenText">https</strong> profile in the drop-down list, and then navigate to <strong class="screenText">Debug</strong> | <strong class="screenText">Start Without Debugging</strong> or press <em class="keystroke">Ctrl</em> + <em class="keystroke">F5</em>. A web browser should navigate to the Swagger documentation web page automatically.</li>
          <li class="bulletList">If you are using Visual Studio Code, then enter the command <code class="inlineCode">dotnet run --launch-profile https</code>, manually start a web browser, and navigate to the Swagger documentation web page: <a href="https://localhost:5091/swagger">https://localhost:5091/swagger</a>.</li>
        </ul>
      
    <div><p class="normal">On Windows, if prompted to do so, you will have to set the Windows Defender Firewall to allow<a id="_idIndexMarker875"/> access to your local web service.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="13">Use Swagger to test <a id="_idIndexMarker876"/>the various endpoints, and note the SQL statements logged to the output as you do so, for example:<ul>
          <li class="bulletList">Get the first page of 10 products.</li>
          <li class="bulletList">Get the 6th page of 10 products.</li>
          <li class="bulletList">Get the product with an ID of 77.</li>
          <li class="bulletList">Get the single out-of-stock product.</li>
          <li class="bulletList">Get the seven discontinued products.</li>
          <li class="bulletList">Get products whose names start with <code class="inlineCode">cha</code>.</li>
          <li class="bulletList">Create (<code class="inlineCode">POST</code>), update (<code class="inlineCode">PUT</code>), and delete a product. For hints about how to perform these tests, read the following link: <a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/ch09-swagger-tests.md">https://github.com/markjprice/apps-services-net8/blob/main/docs/ch09-swagger-tests.md</a>.</li>
        </ul>
      </li>
    </ol>
    <div><p class="normal">If you completed <em class="chapterRef">Chapter 8</em>, <em class="italic">Building and Securing Web Services Using Minimal APIs</em>, then instead of manually using Swagger, you can use the <code class="inlineCode">.http</code> files we created to test the minimal API web service. Just change the port from <code class="inlineCode">5081</code> to <code class="inlineCode">5091</code>.</p>
    </div>
    <p class="normal">Now that we have a basic<a id="_idIndexMarker877"/> web service, we can start activating caching in it.</p>
    <h2 class="heading-2" id="_idParaDest-349">Caching objects using in-memory caching</h2>
    <p class="normal">The <code class="inlineCode">IMemoryCache</code> interface represents a cache that uses local server memory. If you have multiple servers<a id="_idIndexMarker878"/> hosting your service or website, then you must enable “sticky sessions.” This means that an incoming request from a client or visitor will be directed to the same server as previous <a id="_idIndexMarker879"/>requests from that client or visitor, allowing the request to find the correct cached data in that server’s memory.</p>
    <p class="normal">The <code class="inlineCode">Microsoft.Extensions.Caching.Memory</code> package has a modern implementation of <code class="inlineCode">IMemoryCache</code>. Avoid the older <code class="inlineCode">System.Runtime.Caching</code>.</p>
    <p class="normal">Sizes are defined using custom units. If you store simple <code class="inlineCode">string</code> values, then you could use the length of the string. If you don’t know the size, you could just use 1 unit for each entry to simply limit the number of entries.</p>
    <p class="normal">When you add an object to a cache, you should set an expiration. There are two types, absolute and sliding, and you can set one or the other, both, or neither:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Absolute expiration</strong>: This is a<a id="_idIndexMarker880"/> fixed date/time, for example, 1am on December 24, 2023. When the date/time is reached, the object is evicted. To use this, set the <code class="inlineCode">AbsoluteExpiration</code> property of a cache entry to a <code class="inlineCode">DateTime</code> value. Choose this if you need to guarantee that at some point the data in the cache will be refreshed.</li>
      <li class="bulletList"><strong class="keyWord">Sliding expiration</strong>: This is <a id="_idIndexMarker881"/>a time span, for example, 20 seconds. When the time span expires, the object is evicted. However, whenever an object is read from the cache, its expiration is reset for another 20 seconds. This is <a id="_idIndexMarker882"/>why it is described as <em class="italic">sliding</em>. A common<a id="_idIndexMarker883"/> duration for a <strong class="keyWord">Content Management System</strong> (<strong class="keyWord">CMS</strong>), where content like a web page is loaded from a database, is 12 hours. Content frequently viewed by visitors, like the home page, is then likely to remain in memory. To use this, set the <code class="inlineCode">SlidingExpiration</code> property of a cache entry to a <code class="inlineCode">TimeSpan</code> value. Choose this if it is acceptable for data to potentially never be refreshed. A good CMS will have an additional mechanism to reliably force a refresh when new content is published, but this functionality is not built into .NET caching.</li>
      <li class="bulletList"><strong class="keyWord">Both expirations</strong>: If you only set a sliding expiration, an object may stay in the cache forever, so you might also want to set the <code class="inlineCode">AbsoluteExpirationRelativeToNow</code> property to a <code class="inlineCode">TimeSpan</code> further in the future, after which the object should definitely be evicted. Choose this if you want the best of both worlds.</li>
      <li class="bulletList"><strong class="keyWord">Never</strong>: You can set a cache entry to have a priority of <code class="inlineCode">CacheItemPriority.NeverRemove</code>.</li>
    </ul>
    <p class="normal">You can also configure a method to call back to when an object is evicted from the cache. This allows you to <a id="_idIndexMarker884"/>execute some business logic to decide if you want to add the object back into the <a id="_idIndexMarker885"/>cache, perhaps after refreshing it from the original data source. You do this by calling the <code class="inlineCode">RegisterPostEvictionCallback</code> method.</p>
    <p class="normal">Let’s explore the in-memory cache:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.Service</code> project, in <code class="inlineCode">Program.cs</code>, import the namespace to work with the in-memory cache, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Extensions.Caching.Memory; // To use IMemoryCache and so on.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after the call to <code class="inlineCode">CreateBuilder</code>, in the section for configuring services, register an implementation for the in-memory cache, configured to store a maximum of 50 products, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddSingleton&lt;IMemoryCache&gt;(new MemoryCache(
  new MemoryCacheOptions
  {
    TrackStatistics = true,
    SizeLimit = 50 // Products.
  }));
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">ProductsController.cs</code>, import the namespace to work with the in-memory cache, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Extensions.Caching.Memory; // To use IMemoryCache.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">ProductsController.cs</code>, declare some fields to store the in-memory cache and a key<a id="_idIndexMarker886"/> for the out-of-stock products, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> IMemoryCache _memoryCache;</strong>
<strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">const</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc"> OutOfStockProductsKey = </strong><strong class="hljs-string-slc">"OOSP"</strong><strong class="hljs-slc">;</strong>
public ProductsController(ILogger&lt;ProductsController&gt; logger, 
  NorthwindContext context<strong class="hljs-params-slc">,</strong>
<strong class="hljs-params-slc">  IMemoryCache memoryCache</strong>)
{
  _logger = logger;
  _db = context;
<strong class="hljs-slc">  _memoryCache = memoryCache;</strong>
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">ProductsController.cs</code>, in the <code class="inlineCode">GetOutOfStockProducts</code> action method, add statements to try to get the cached out-of-stock products, and if they are not cached, get <a id="_idIndexMarker887"/>them from the database and set them in the cache, using a sliding expiration of five seconds, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">// GET: api/products/outofstock
[HttpGet]
[Route("outofstock")]
[Produces(typeof(Product[]))]
public IEnumerable&lt;Product&gt; GetOutOfStockProducts()
{
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// Try to get the cached value.</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (!_memoryCache.TryGetValue(OutOfStockProductsKey,</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-keyword-slc">out</strong><strong class="hljs-slc"> Product[]? cachedValue))</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-comment-slc">// If the cached value is not found, get the value from the database.</strong>
<strong class="hljs-slc">    cachedValue = _db.Products</strong>
<strong class="hljs-slc">      .Where(p =&gt; p.UnitsInStock == </strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc"> &amp;&amp; !p.Discontinued)</strong>
<strong class="hljs-slc">      .ToArray();</strong>
<strong class="hljs-slc">    MemoryCacheEntryOptions cacheEntryOptions = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">()</strong>
<strong class="hljs-slc">    {</strong>
<strong class="hljs-slc">      SlidingExpiration = TimeSpan.FromSeconds(</strong><strong class="hljs-number-slc">5</strong><strong class="hljs-slc">),</strong>
<strong class="hljs-slc">      Size = cachedValue?.Length</strong>
<strong class="hljs-slc">    };</strong>
<strong class="hljs-slc">    _memoryCache.Set(OutOfStockProductsKey, cachedValue, cacheEntryOptions);</strong>
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc">  MemoryCacheStatistics? stats = _memoryCache.GetCurrentStatistics();</strong>
<strong class="hljs-slc">  _logger.LogInformation(</strong><strong class="hljs-string-slc">"Memory cache. Total hits: {stats?</strong>
<strong class="hljs-string-slc">    .TotalHits}. Estimated size: {stats?.CurrentEstimatedSize}."</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> cachedValue ?? Enumerable.Empty&lt;Product&gt;();</strong>
}
</code></pre>
      </li>
      <li class="numberedList">Start the web service project using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Arrange the windows so that you can see the command prompt or terminal at the same<a id="_idIndexMarker888"/> time as the web page.</li>
      <li class="numberedList">On the Swagger web page, click <strong class="screenText">GET /api/product/outofstock</strong> to expand that section.</li>
      <li class="numberedList">Click the <strong class="screenText">Try it out</strong> button.</li>
      <li class="numberedList">Click the <strong class="screenText">Execute</strong> button, and note in the output that EF Core executes a SQL statement to get<a id="_idIndexMarker889"/> the products, the total hit counter is zero, and one product has now been cached, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Northwind.WebApi.Service.Controllers.ProductsController[0]
      Memory cache. Total hits: 0. Estimated size: 1.
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Execute</strong> within five seconds, and continue to click it a few more times: <ul>
          <li class="bulletList">Note that EF Core does not need to re-execute the SQL statement because the products are cached, and if something reads them within a five-second sliding expiration, they will stay in memory forever.</li>
          <li class="bulletList">Note the total hit counter for the cache increments each time the out-of-stock products are found in the cache, as shown in the following output:
            <pre class="programlisting con"><code class="hljs-con">info: Northwind.WebApi.Service.Controllers.ProductsController[0]
      Memory cache. Total hits: 1. Estimated size: 1.
info: Northwind.WebApi.Service.Controllers.ProductsController[0]
      Memory cache. Total hits: 2. Estimated size: 1.
info: Northwind.WebApi.Service.Controllers.ProductsController[0]
      Memory cache. Total hits: 3. Estimated size: 1.
</code></pre>
          </li>
        </ul>
      </li>
      <li class="numberedList">Wait at least five seconds.</li>
      <li class="numberedList">Click <strong class="screenText">Execute</strong>, and note in the output that EF Core executes a SQL statement to get the products<a id="_idIndexMarker890"/> because they have not been read within the five-second sliding expiration window.</li>
      <li class="numberedList">Close <a id="_idIndexMarker891"/>the browser and shut down the web server.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-350">Caching objects using distributed caching</h2>
    <p class="normal">Distributed caches have<a id="_idIndexMarker892"/> benefits over in-memory caches. Cached objects:</p>
    <ul>
      <li class="bulletList">Are consistent across requests to multiple servers.</li>
      <li class="bulletList">Survive server restarts and service deployments.</li>
      <li class="bulletList">Do not waste<a id="_idIndexMarker893"/> local server memory.</li>
      <li class="bulletList">Are stored in a shared area, so in a server farm scenario with multiple servers, you do not need to enable sticky sessions.</li>
    </ul>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> A disadvantage of distributed caches is that in-memory caches can store any object, but a distributed cache can only store <code class="inlineCode">byte</code> arrays. Your object needs to be serialized and sent across a network to the remote cache.</p>
    </div>
    <p class="normal">Microsoft provides the <code class="inlineCode">IDistributedCache</code> interface with pre-defined methods to manipulate items in any distributed cache implementation. The methods are:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">Set</code> or <code class="inlineCode">SetAsync</code>: To store an object in the cache.</li>
      <li class="bulletList"><code class="inlineCode">Get</code> or <code class="inlineCode">GetAsync</code>: To retrieve an object from the cache.</li>
      <li class="bulletList"><code class="inlineCode">Remove</code> or <code class="inlineCode">RemoveAsync</code>: To remove an object from the cache.</li>
      <li class="bulletList"><code class="inlineCode">Refresh</code> or <code class="inlineCode">RefreshAsync</code>: To reset the sliding expiration for an object in the cache.</li>
    </ul>
    <p class="normal">There are many implementations<a id="_idIndexMarker894"/> of distributed caching to choose from, including the following:</p>
    <ul>
      <li class="bulletList">SQL Server: <a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/distributed#distributed-sql-server-cache">https://learn.microsoft.com/en-us/aspnet/core/performance/caching/distributed#distributed-sql-server-cache</a></li>
      <li class="bulletList">Redis: <a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/distributed#distributed-redis-cache">https://learn.microsoft.com/en-us/aspnet/core/performance/caching/distributed#distributed-redis-cache</a></li>
      <li class="bulletList">NCache: <a href="http://www.alachisoft.com/ncache/aspnet-core-idistributedcache-ncache.html">http://www.alachisoft.com/ncache/aspnet-core-idistributedcache-ncache.html</a></li>
    </ul>
    <p class="normal">We will use the <strong class="keyWord">Distributed Memory Cache</strong>, which<a id="_idIndexMarker895"/> is a Microsoft built-in implementation of <code class="inlineCode">IDistributedCache</code> that stores items in memory on the server where the service runs. </p>
    <p class="normal">It is not an actual distributed cache, but it is useful for scenarios like unit testing, where you want to remove the dependency on yet another external service, or while learning, as we are doing in this book. </p>
    <p class="normal">Later, you only need to <a id="_idIndexMarker896"/>change the configured distributed cache, not the service implementation code that uses it, because all interactions go through the registered <code class="inlineCode">IDistributedCache</code> implementation.</p>
    <p class="normal">Let’s go!</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.Service</code> project, in <code class="inlineCode">Program.cs</code>, after the call to <code class="inlineCode">CreateBuilder</code>, in the section for configuring services, register the implementation for the distributed memory cache, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddDistributedMemoryCache();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">ProductsController.cs</code>, import the namespace for working with a distributed cache implementation and serialized JSON, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Extensions.Caching.Distributed; // To use IDistributedCache.
using System.Text.Json; // To use JsonSerializer.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">ProductsController.cs</code>, declare some fields to store the distributed cache implementation<a id="_idIndexMarker897"/> and an item key for discontinued products, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">private readonly IMemoryCache _memoryCache;
private const string OutOfStockProductsKey = "OOSP";
<strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> IDistributedCache _distributedCache;</strong>
<strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">const</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc"> DiscontinuedProductsKey = </strong><strong class="hljs-string-slc">"DISCP"</strong><strong class="hljs-slc">;</strong>
public ProductsController(ILogger&lt;ProductsController&gt; logger,
  NorthwindContext context,
  IMemoryCache memoryCache<strong class="hljs-params-slc">,</strong>
<strong class="hljs-params-slc">  IDistributedCache distributedCache</strong><strong class="hljs-function-slc">)</strong>
{
  _logger = logger;
  _db = context;
  _memoryCache = memoryCache;
<strong class="hljs-slc">  _distributedCache = distributedCache;</strong>
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">ProductsController.cs</code>, define a <code class="inlineCode">private</code> method to get the discontinued products <a id="_idIndexMarker898"/>from the database, and set them in the distributed cache, using a sliding expiration of 5 seconds and an absolute expiration of 20 seconds, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">private Product[]? GetDiscontinuedProductsFromDatabase()
{
  Product[]? cachedValue = _db.Products
    .Where(product =&gt; product.Discontinued)
    .ToArray();
  DistributedCacheEntryOptions cacheEntryOptions = new()
  {
    // Allow readers to reset the cache entry's lifetime.
    SlidingExpiration = TimeSpan.FromSeconds(5),
    // Set an absolute expiration time for the cache entry.
    AbsoluteExpirationRelativeToNow = TimeSpan.FromSeconds(20),
  };
  byte[]? cachedValueBytes = 
    JsonSerializer.SerializeToUtf8Bytes(cachedValue);
  _distributedCache.Set(DiscontinuedProductsKey,
    cachedValueBytes, cacheEntryOptions);
  return cachedValue;
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">ProductsController.cs</code>, in the <code class="inlineCode">GetDiscontinuedProducts</code> action method, add <a id="_idIndexMarker899"/>statements to try to get the cached discontinued products, and if not cached, get them from the database. If a <code class="inlineCode">byte</code> array is found in the cache, try to deserialize it<a id="_idIndexMarker900"/> into products, but if that fails too, get the products from the database, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">// GET: api/products/discontinued
[HttpGet]
[Route("discontinued")]
[Produces(typeof(Product[]))]
public IEnumerable&lt;Product&gt; GetDiscontinuedProducts()
{
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// Try to get the cached value.</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-built_in-slc">byte</strong><strong class="hljs-slc">[]? cachedValueBytes = _distributedCache.Get(DiscontinuedProductsKey);</strong>
<strong class="hljs-slc">  Product[]? cachedValue = </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (cachedValueBytes </strong><strong class="hljs-keyword-slc">is</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    cachedValue = GetDiscontinuedProductsFromDatabase();</strong>
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">else</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    cachedValue = JsonSerializer</strong>
<strong class="hljs-slc">      .Deserialize&lt;Product[]?&gt;(cachedValueBytes);</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (cachedValue </strong><strong class="hljs-keyword-slc">is</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    {</strong>
<strong class="hljs-slc">      cachedValue = GetDiscontinuedProductsFromDatabase();</strong>
<strong class="hljs-slc">    }</strong>
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> cachedValue ?? Enumerable.Empty&lt;Product&gt;();</strong>
}
</code></pre>
      
    <div><p class="normal">Unlike the in-memory cache that can store any live object, objects stored in distributed cache implementations must be serialized into <code class="inlineCode">byte</code> arrays because they need to be transmittable across networks.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Start the web<a id="_idIndexMarker901"/> service project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Arrange the windows so that you can see the command prompt or terminal at the same time as the web page.</li>
      <li class="numberedList">On the Swagger web page, click <strong class="screenText">GET /api/product/discontinued</strong> to expand that section.</li>
      <li class="numberedList">Click the <strong class="screenText">Try it out</strong> button.</li>
      <li class="numberedList">Click the <strong class="screenText">Execute</strong> button, and note in the output that EF Core executes a SQL statement <a id="_idIndexMarker902"/>to get the products.</li>
      <li class="numberedList">Click <strong class="screenText">Execute</strong> within five seconds, continue to click it a few more times, and note that EF Core does not need to re-execute the SQL statement because the products are cached. If something reads them within a five-second sliding expiration, they will stay in memory forever.</li>
      <li class="numberedList">Wait at least five seconds.</li>
      <li class="numberedList">Click <strong class="screenText">Execute</strong>, and note in the output that EF Core executes a SQL statement to get the products because they have not been read within the five-second sliding expiration window.</li>
      <li class="numberedList">Continue to click <strong class="screenText">Execute</strong> repeatedly, and note that after 20 seconds, EF Core must <a id="_idIndexMarker903"/>execute a SQL statement to refresh the products.</li>
      <li class="numberedList">Close the browser and shut down the web server.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-351">A new abstraction for distributed caching</h2>
    <p class="normal">The ASP.NET Core team is<a id="_idIndexMarker904"/> working on adding a new abstraction for distributed caching to make it easier to use. It is not expected to be ready for .NET 8. It might be included in a point release, like 8.1, but more likely will be built-in with .NET 9.</p>
    <p class="normal">Some <code class="inlineCode">GetAsync</code> extension methods and supporting methods have been written by Marc Gravell. He maintains the most popular package to integrate .NET with Redis, so he has a lot of experience with distributed caching. </p>
    <p class="normal">While we wait for an official implementation, you can read or download the source code to his extensions at the following link: <a href="https://github.com/mgravell/DistributedCacheDemo/blob/main/DistributedCacheExtensions.cs">https://github.com/mgravell/DistributedCacheDemo/blob/main/DistributedCacheExtensions.cs</a>. The file is only 137 lines long, so it is easy to add to your own projects straight away.</p>
    <p class="normal">The main difference in the new extension methods is that you do not need to call the <code class="inlineCode">Set</code> or <code class="inlineCode">SetAsync</code> methods anymore because they are abstracted away inside the new <code class="inlineCode">GetAsync</code> methods, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">// IDistributedCache methods.
objectFromDatabase = GetFromDatabase(...);
cache.Set(key: "ITEM_KEY", value: objectFromDatabase, options: ...);
dataFromCache = cache.Get(key: "ITEM_KEY");
// New extension methods.
dataFromCache = await cache.GetAsync(key: "ITEM_KEY",
  getMethod: GetFromDatabase(...), options: ..., cancellation: ...);
</code></pre>
    <p class="normal">Also, note that the new extension methods are all asynchronous and generic, with a type <code class="inlineCode">T</code> that will be serialized as JSON by default, but this can be overridden to use alternatives like the<a id="_idIndexMarker905"/> binary format protobuf.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn more about the plans for these new extension methods at the following link: <a href="https://devblogs.microsoft.com/dotnet/caching-abstraction-improvements-in-aspnetcore/">https://devblogs.microsoft.com/dotnet/caching-abstraction-improvements-in-aspnetcore/</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-352">Caching web responses using HTTP caching</h2>
    <p class="normal">In-memory and <a id="_idIndexMarker906"/>distributed caching work with any type of app or service, using any transport technology, because all the magic <a id="_idIndexMarker907"/>happens on the server.</p>
    <p class="normal">Response aka HTTP <a id="_idIndexMarker908"/>caching is tied to HTTP GET requests and responses because it is based on HTTP headers. Therefore, it only works with apps and services that use HTTP as their transport technology, like web services built using Web APIs, minimal APIs, and OData.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can<a id="_idIndexMarker909"/> read the official standard for HTTP caching at the following link: <a href="https://www.rfc-editor.org/rfc/rfc9111">https://www.rfc-editor.org/rfc/rfc9111</a>.</p>
    </div>
    <p class="normal">Requirements for HTTP aka response caching include the following:</p>
    <ul>
      <li class="bulletList">The request must be a <code class="inlineCode">GET</code> or <code class="inlineCode">HEAD</code> one. <code class="inlineCode">POST</code>, <code class="inlineCode">PUT</code>, and <code class="inlineCode">DELETE</code> requests, and so on, are never cached by HTTP caching.</li>
      <li class="bulletList">The response must have a <code class="inlineCode">200 OK</code> status code.</li>
      <li class="bulletList">If the request has an <code class="inlineCode">Authorization</code> header, then the response is not cached.</li>
      <li class="bulletList">If the request has a <code class="inlineCode">Vary</code> header, then the response is not cached when the values are not valid or <code class="inlineCode">*</code>.</li>
    </ul>
    <p class="normal">The web server sets<a id="_idIndexMarker910"/> response caching headers, and then intermediate proxies and clients should respect the headers to tell them how they should cache the responses.</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Response aka HTTP caching is not typically useful for web user interfaces because web browsers often set request headers that prevent HTTP caching. For web user interfaces, output caching is better suited, and we will cover that in <em class="chapterRef">Chapter 14</em>, <em class="italic">Building Web User Interfaces Using ASP.NET Core</em>.</p>
    </div>
    <p class="normal">The <code class="inlineCode">Cache-Control</code> HTTP <a id="_idIndexMarker911"/>header for requests and responses has some common directives, as shown in <em class="italic">Table 9.2</em>:</p>
    <table class="table-container" id="table002-7">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Directive</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">public</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Clients and intermediaries can cache this response.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">private</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Only a client should cache this response. </p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">max-age</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">The client does not accept responses older than the specified number of seconds.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">no-cache</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">A client request is asking for a non-cached response. A server is telling the client and intermediaries not the cache the response.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">no-store</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">A cache must not store the request or response.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 9.2: Common Cache-Control HTTP header directives</p>
    <p class="normal">As well as <code class="inlineCode">Cache-Control</code>, there <a id="_idIndexMarker912"/>are other headers that might affect caching, as shown in <em class="italic">Table 9.3</em>:</p>
    <table class="table-container" id="table003-6">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Header</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Age</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Estimated number of seconds old the response is.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Expires</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">An absolute date/time after which the response should be considered expired.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Vary</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">All fields must match for a cached response to be sent. Otherwise, a fresh response is sent. For example, a query string of <code class="inlineCode">color</code>.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 9.3: Common HTTP headers for caching</p>
    <p class="normal">For example, a client could ask for a fresh list of discontinued products, and the service should not use any cached version, as shown in the following HTTP response:</p>
    <pre class="programlisting code"><code class="hljs-code">GET api/products/discontinued
Cache-Control: no-cache
</code></pre>
    <p class="normal">A service could return some products as a JSON array, with a header to say that intermediaries should <a id="_idIndexMarker913"/>not cache the response but clients can, as shown in the following HTTP response:</p>
    <pre class="programlisting code"><code class="hljs-code">content-type: application/json; charset=utf-8 
date: Fri,09 Jun 2023 06:05:13 GMT 
server: Kestrel 
cache-control: private
[
  {
    "productId": 5,
    "productName": "Chef Anton's Gumbo Mix",
    ...
</code></pre>
    <p class="normal">Decorate a controller or <a id="_idIndexMarker914"/>method with the <code class="inlineCode">[ResponseCache]</code> attribute to control <a id="_idIndexMarker915"/>caching responses from the server (code to control caching requests has to go in the client code). This attribute has common parameters, as shown in <em class="italic">Table 9.4</em>:</p>
    <table class="table-container" id="table004-6">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Property</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Duration</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">How long to cache in seconds.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Location</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Where the response can be cached. <code class="inlineCode">Any</code> (<code class="inlineCode">cache-control:</code> <code class="inlineCode">public</code>), <code class="inlineCode">Client</code> (<code class="inlineCode">cache-control:</code> <code class="inlineCode">private</code>), <code class="inlineCode">None</code> (<code class="inlineCode">cache-control:</code> <code class="inlineCode">no-cache</code>).</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">NoStore</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Sets <code class="inlineCode">cache-control:</code> <code class="inlineCode">no-store</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">VaryByHeader</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Sets the <code class="inlineCode">Vary</code> header.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">VaryByQueryKeys</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Query keys to vary by.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 9.4: Common parameters of the [ResponseCache] attribute</p>
    <p class="normal">Let’s apply response caching to the web service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.Service</code> project, in <code class="inlineCode">Program.cs</code>, after the call to add the distributed memory cache, add a statement to add response caching middleware as a dependency service, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddResponseCaching();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after the call to use HTTPS redirection, add a statement to use response caching middleware, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.UseResponseCaching();
</code></pre>
        <div><p class="normal"><strong class="keyWord">Good Practice</strong>: If using CORS middleware, then <code class="inlineCode">UseCors</code> must be called before <code class="inlineCode">UseResponseCaching</code>.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">In <code class="inlineCode">ProductsController.cs</code>, decorate <a id="_idIndexMarker916"/>the <code class="inlineCode">Get</code> method with an <code class="inlineCode">int id</code> parameter<a id="_idIndexMarker917"/> with the <code class="inlineCode">[ResponseCache]</code> attribute, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">// GET api/products/5
[HttpGet("{id:int}")]
<strong class="hljs-slc">[</strong><strong class="hljs-meta-slc">ResponseCache(Duration = 5, // Cache-Control: max-age=5</strong>
<strong class="hljs-meta-slc">  Location = ResponseCacheLocation.Any, // Cache-Control: public</strong>
<strong class="hljs-meta-slc">  VaryByHeader = </strong><strong class="hljs-string-slc">"User-Agent"</strong><strong class="hljs-meta-slc"> // Vary: User-Agent</strong>
<strong class="hljs-meta-slc">  )</strong><strong class="hljs-slc">]</strong>
public async ValueTask&lt;Product?&gt; Get(int id)
{
  return await _db.Products.FindAsync(id);
}
</code></pre>
      
    <div><p class="normal">The <code class="inlineCode">[ResponseCache]</code> attribute can be applied to Razor Pages, MVC controller classes, and MVC action methods for both web services and websites.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Start the web service<a id="_idIndexMarker918"/> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">In the <code class="inlineCode">HttpRequests</code> folder, open the <code class="inlineCode">webapi-get-products.http</code> file.</li>
      <li class="numberedList">Modify the base address to use port <code class="inlineCode">5091</code>, and then send the request for a specific product, like <code class="inlineCode">77</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">GET {{base_address}}77
</code></pre>
      </li>
      <li class="numberedList">Note that the<a id="_idIndexMarker919"/> response includes headers to control caching, as highlighted in the following output:
        <pre class="programlisting con"><code class="hljs-con">Response time: 89 ms
Status code: OK (200)
Alt-Svc: h3=":5091"; ma=86400
Transfer-Encoding: chunked
<strong class="hljs-con-slc">Vary: User-Agent</strong>
<strong class="hljs-con-slc">Cache-Control: public, max-age=5</strong>
Date: Fri, 09 Jun 2023 06:26:45 GMT
Server: Kestrel
Content-Type: application/json; charset=utf-8
Content-Length: 270
------------------------------------------------
Content:
{
  "productId": 77,
  "productName": "Original Frankfurter grüne Soße",
  "supplierId": 12,
  "categoryId": 2,
  "quantityPerUnit": "12 boxes",
  "unitPrice": 85.0,
  "unitsInStock": 32,
  "unitsOnOrder": 0,
  "reorderLevel": 15,
  "discontinued": false,
  "category": null,
  "orderDetails": [],
  "supplier": null
}
</code></pre>
      </li>
      <li class="numberedList">Close the browser and shut down the web server.</li>
    </ol>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Response caching should only be enabled for anonymous requests. Authenticated requests<a id="_idIndexMarker920"/> and responses should not be cached.</p>
    </div>
    <p class="normal">Caching is one of the best<a id="_idIndexMarker921"/> ways to improve the<a id="_idIndexMarker922"/> performance and scalability of your services. Next, we will learn how to improve a service’s resilience when inevitable failures occur.</p>
    <h1 class="heading-1" id="_idParaDest-353">Fault tolerance with Polly</h1>
    <p class="normal">Polly is <em class="italic">“a .NET resilience and transient-fault-handling library that allows developers to express policies such as Retry, Circuit Breaker, Timeout, Bulkhead Isolation, and Fallback in a fluent and thread-safe manner,”</em> as stated on the official Polly GitHub repository, which can be found at the following link: <a href="https://github.com/App-vNext/Polly">https://github.com/App-vNext/Polly</a>.</p>
    <p class="normal">Transient faults are<a id="_idIndexMarker923"/> errors caused by temporary conditions, such as <a id="_idIndexMarker924"/>temporary service unavailability or network connectivity issues. It is essential to handle transient faults in distributed systems, or they can become almost unusable.</p>
    <h2 class="heading-2" id="_idParaDest-354">Understanding retry and circuit breaker patterns</h2>
    <p class="normal">The <strong class="keyWord">Retry</strong> pattern <a id="_idIndexMarker925"/>enables clients to automatically retry<a id="_idIndexMarker926"/> a failed action with the expectation that the fault will succeed if retried after a short delay. Be careful, because if you implement the Retry pattern naively, then it can make the problem worse! </p>
    <p class="normal">For example, if you set a fixed time between retries, then all the clients who received a fault will attempt to retry at the same time, overloading the service. To avoid this issue, retries are often set with an exponentially increasing time between retries, or they might use jitter (aka randomizer) algorithms.</p>
    <p class="normal">The <strong class="keyWord">Circuit Breaker</strong> pattern <a id="_idIndexMarker927"/>prevents calls when a threshold<a id="_idIndexMarker928"/> of faults is reached. In effect, it is a way for a service to detect if a fault is <em class="italic">not</em> transient, or not transient enough to keep retrying.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: There is a nice summary table of resilience policies for Polly on its GitHub repository: <a href="https://github.com/App-vNext/Polly#resilience-policies">https://github.com/App-vNext/Polly#resilience-policies</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-355">Defining and executing policies</h2>
    <p class="normal">In any type of .NET project that <a id="_idIndexMarker929"/>calls any unreliable code, you <a id="_idIndexMarker930"/>can reference the Polly package and then define a policy using the <code class="inlineCode">Policy</code> class. Polly is not used in the unreliable code or service itself. It is used by any clients that call the code or service.</p>
    <p class="normal">For example, you might need to call two methods that might throw arithmetic or custom exceptions, and you want to automatically retry up to three times, so you define a policy to handle this, as <a id="_idIndexMarker931"/>shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">RetryPolicy policy = Policy
  .Handle&lt;CustomException&gt;().Or&lt;ArithmeticException&gt;()
  .Retry(3);
</code></pre>
    <p class="normal">Then, you can use that policy to execute the methods, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">policy.Execute(() =&gt; GetProducts());
policy.Execute(() =&gt; GetCustomers());
</code></pre>
    <p class="normal">Each call to <code class="inlineCode">Execute</code> gets its<a id="_idIndexMarker932"/> own counter for retries, so if the call to <code class="inlineCode">GetProducts</code> needs two retries, the call to <code class="inlineCode">GetCustomers</code> still has a full three retries of its own.</p>
    <p class="normal">For unlimited retries, you can call the <code class="inlineCode">RetryForever</code> method, but this is not recommended.</p>
    <p class="normal">For asynchronous methods, there are matching asynchronous methods; for example, instead of <code class="inlineCode">Retry</code>, use <code class="inlineCode">RetryAsync</code>.</p>
    <p class="normal">To execute some statements when a retry occurs, for example, to log information, the <code class="inlineCode">Retry</code> method can have a callback, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">RetryPolicy policy = Policy
  .Handle&lt;CustomException&gt;().Or&lt;ArithmeticException&gt;()
  .Retry(3, onRetry: (exception, retryCount) =&gt;
  {
      // Log the current retry count and exception information.
  });
</code></pre>
    <h2 class="heading-2" id="_idParaDest-356">Defining wait intervals between retries</h2>
    <p class="normal">Instead of<a id="_idIndexMarker933"/> immediately retrying after<a id="_idIndexMarker934"/> a fault, it is good practice to wait a moment before retrying.</p>
    <p class="normal">For example, to wait and retry, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">RetryPolicy policy = Policy
  .Handle&lt;CustomException&gt;().Or&lt;ArithmeticException&gt;()
  .WaitAndRetry(new[]
  {
    TimeSpan.FromSeconds(1), // 1 second between 1st and 2nd try.
    TimeSpan.FromSeconds(2), // 2 seconds between 2nd and 3rd try.
    TimeSpan.FromSeconds(5) // 5 seconds between 3rd and 4th try.
  });
</code></pre>
    <p class="normal">Instead of hardcoded delay values, you<a id="_idIndexMarker935"/> can also define a function to generate them, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">RetryPolicy policy = Policy
  .Handle&lt;CustomException&gt;().Or&lt;ArithmeticException&gt;()
  .WaitAndRetry(3, retryAttempt =&gt; 
    TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)));
//  2 ^ 1 = 2 seconds then
//  2 ^ 2 = 4 seconds then
//  2 ^ 3 = 8 seconds then
</code></pre>
    <p class="normal">However, if we pass an array of fixed delays, even if they are calculated, imagine what happens when a fault <a id="_idIndexMarker936"/>occurs in a busy web service. All the clients receive an exception, they all wait for the first second, and they all attempt to recall the web service one second later. This causes floods that could make the situation worse!</p>
    <p class="normal">Jittering is the idea of adding small amounts of randomization to time delays. There are many implementations that you can find online, and the best is built-in with an extra Polly package. We will use it to generate time delays in our example project.</p>
    <h2 class="heading-2" id="_idParaDest-357">Applying policies to HTTP clients</h2>
    <p class="normal">When calling a web<a id="_idIndexMarker937"/> service, it’s a good practice to define an HTTP client factory and register it in a <a id="_idIndexMarker938"/>dependency services collection.</p>
    <p class="normal">In this scenario, you will not call the methods that might throw an exception yourself. Instead, you must define a<a id="_idIndexMarker939"/> policy and then attach it to a registered HTTP client, so that it automatically follows that policy.</p>
    <p class="normal">To do so, we will use an extension class named <code class="inlineCode">HttpPolicyExtensions</code> to create policies specifically for common HTTP requests and failures, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">AsyncRetryPolicy&lt;HttpResponseMessage&gt; retryPolicy = HttpPolicyExtensions
  // Handle network failures, 408 and 5xx status codes.
  .HandleTransientHttpError()
  // Define the policy using all the same options as before.
  .RetryAsync(3);
</code></pre>
    <p class="normal">To attach the policy to an HTTP client, call the <code class="inlineCode">AddPolicyHandler</code> extension method after defining the factory. You <a id="_idIndexMarker940"/>will see how to do this in practice later in this section.</p>
    <h2 class="heading-2" id="_idParaDest-358">Adding random faults to the web service</h2>
    <p class="normal">First, let’s add random faults to the <a id="_idIndexMarker941"/>web service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.Service</code> project, in <code class="inlineCode">ProductsController.cs</code>, in the <code class="inlineCode">Get</code> action method that has a <code class="inlineCode">name</code> parameter, add statements to randomly throw an exception two-thirds of the time, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">// GET api/products/cha
[HttpGet("{name}")]
public IEnumerable&lt;Product&gt; Get(string name)
{
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// Works correctly 1 out of 3 times.</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (Random.Shared.Next(</strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">, </strong><strong class="hljs-number-slc">4</strong><strong class="hljs-slc">) == </strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">  {</strong>
    return _db.Products.Where(p =&gt; p.ProductName.Contains(name));
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// Throws an exception at all other times.</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">throw</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> Exception(</strong><strong class="hljs-string-slc">"Randomized fault."</strong><strong class="hljs-slc">);</strong>
}
</code></pre>
      </li>
      <li class="numberedList">Build the project.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-359">Building an MVC project to call the faulty web service</h2>
    <p class="normal">Next, let’s create <a id="_idIndexMarker942"/>an ASP.NET Core MVC client that calls the randomly faulty web service endpoint. Initially, it will just receive the exception if the web service throws an exception. Later, we will add<a id="_idIndexMarker943"/> transient fault handling using Polly:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to add a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">ASP.NET Core Web App (Model-View-Controller) </strong>/ <code class="inlineCode">mvc</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter09</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.WebApi.Client.Mvc</code></li>
          <li class="bulletList">Other Visual Studio 2022 options:<ul>
              <li class="bulletList"><strong class="screenText">Authentication Type</strong>: <strong class="screenText">None</strong>.</li>
              <li class="bulletList"><strong class="screenText">Configure for HTTPS</strong>: Selected.</li>
              <li class="bulletList"><strong class="screenText">Enable Docker</strong>: Cleared.</li>
              <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared.</li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project, in the <code class="inlineCode">Properties</code> folder, in <code class="inlineCode">launchSettings.json</code>, change<a id="_idIndexMarker944"/> the <code class="inlineCode">applicationUrl</code> for the <code class="inlineCode">https</code> profile to use port <code class="inlineCode">5093</code> for <code class="inlineCode">https</code> and <code class="inlineCode">5094</code> for <code class="inlineCode">http</code>, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">"applicationUrl": "https://localhost:5093;http://localhost:5094",
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project file, treat warnings as errors, and add a reference to the entity models project so that we can use the <code class="inlineCode">Product</code> class, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\..\Chapter03\Northwind.Common.EntityModels .SqlServer\Northwind.Common.EntityModels.SqlServer.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project at the command prompt or terminal by entering the following command: <code class="inlineCode">dotnet build</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project, in <code class="inlineCode">Program.cs</code>, import the namespace to work <a id="_idIndexMarker945"/>with HTTP headers, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using System.Net.Http.Headers; // To use MediaTypeWithQualityHeaderValue.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, before calling the <code class="inlineCode">builder.Build()</code>, add statements to configure an HTTP <a id="_idIndexMarker946"/>client factory to call the web service, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddHttpClient(name: "Northwind.WebApi.Service",
  configureClient: options =&gt;
  {
    options.BaseAddress = new("https://localhost:5091/");
    options.DefaultRequestHeaders.Accept.Add(
      new MediaTypeWithQualityHeaderValue(
        "application/json", 1.0));
  });
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Models</code> folder, add a new class file named <code class="inlineCode">HomeProductsViewModel.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">HomeProductsViewModel.cs</code>, define a class to store information needed in the view, like the partial product name the visitor wants to search for, a sequence of products, and an error message, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels; // To use Product.
namespace Northwind.WebApi.Client.Mvc.Models;
public class HomeProductsViewModel
{
  public string? NameContains { get; set; }
  public Uri? BaseAddress { get; set; }
  public IEnumerable&lt;Product&gt;? Products { get; set; }
  public string? ErrorMessage { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Controllers</code> folder, in <code class="inlineCode">HomeController.cs</code>, import the namespace for the entity models, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels; // To use Product.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">HomeController.cs</code>, add statements<a id="_idIndexMarker947"/> to store the registered HTTP client factory in a private <code class="inlineCode">readonly</code> field, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">private readonly ILogger&lt;HomeController&gt; _logger;
<strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> IHttpClientFactory _httpClientFactory;</strong>
public HomeController(ILogger&lt;HomeController&gt; logger,
  <strong class="hljs-params-slc">IHttpClientFactory httpClientFactory</strong>)
{
  _logger = logger;
<strong class="hljs-slc">  _httpClientFactory = httpClientFactory;</strong>
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">HomeController.cs</code>, add an asynchronous action method named <code class="inlineCode">Products</code>, which will use the HTTP factory to request products whose name contains a value <a id="_idIndexMarker948"/>entered as an optional <code class="inlineCode">name</code> parameter, in a custom MVC route, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">[Route("home/products/{name?}")]
public async Task&lt;IActionResult&gt; Products(string? name = "cha")
{
  HomeProductsViewModel model = new();
  HttpClient client = _httpClientFactory.CreateClient(
    name: "Northwind.WebApi.Service");
  model.NameContains = name;
  model.BaseAddress = client.BaseAddress;
  HttpRequestMessage request = new(
    method: HttpMethod.Get, 
    requestUri: $"api/products/{name}");
  HttpResponseMessage response = await client.SendAsync(request);
  if (response.IsSuccessStatusCode)
  {
    model.Products = await response.Content
      .ReadFromJsonAsync&lt;IEnumerable&lt;Product&gt;&gt;();
  }
  else
  {
    model.Products = Enumerable.Empty&lt;Product&gt;();
    string content = await response.Content.ReadAsStringAsync();
    // Use the range operator .. to start from zero and 
    // go to the first carriage return.
    string exceptionMessage = content[..content.IndexOf("\r")];
    model.ErrorMessage = string.Format("{0}: {1}:",
      response.ReasonPhrase, exceptionMessage);
  }
  return View(model);
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Views/Home</code> folder, add <a id="_idIndexMarker949"/>a new file named <code class="inlineCode">Products.cshtml</code>. (The Visual Studio 2022 <a id="_idIndexMarker950"/>project item template is named <strong class="screenText">Razor View - Empty</strong>. The JetBrains Rider project item template is named <strong class="screenText">Razor MVC View</strong>.)</li>
      <li class="numberedList">In <code class="inlineCode">Products.cshtml</code>, modify its contents to output a table of products that match part of a product name entered in a textbox, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">@using Northwind.EntityModels
@model HomeProductsViewModel
@{
  ViewData["Title"] = "Products using Polly";
}
&lt;div class="text-center"&gt;
  &lt;h1 class="display-4"&gt;@ViewData["Title"]&lt;/h1&gt;
  &lt;div class="alert alert-info"&gt;
    &lt;p&gt;
      This page calls a web service endpoint that will randomly fail two out of three times. It will use Polly to retry the call automatically.
    &lt;/p&gt;
  &lt;/div&gt;
  @if (Model is not null)
  {
    if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
      &lt;div class="alert alert-danger"&gt;
        @Model.ErrorMessage
      &lt;/div&gt;
    }
    &lt;form action="/home/products"&gt;
      &lt;input name="name" placeholder="Enter part of a product name" 
        value="@Model.NameContains" /&gt;
      &lt;input type="submit" value="Get Products" /&gt;
      @if (!string.IsNullOrWhiteSpace(Model.NameContains))
      {
      &lt;p&gt;
        Searched for product names that start with:
        &lt;span class="badge bg-primary rounded-pill"&gt;
          @Model.NameContains&lt;/span&gt;
      &lt;/p&gt;
      }
    &lt;/form&gt;
    &lt;div&gt;
      @if (Model.Products is not null)
      {
        &lt;table class="table"&gt;
          &lt;thead&gt;
            &lt;tr&gt;
              &lt;th scope="col"&gt;Product Name&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody&gt;
            @if (Model.Products.Any())
            {
              @foreach (Product p in Model.Products)
              {
                &lt;tr&gt;
                  &lt;td&gt;
                    &lt;a href=
"@(Model.BaseAddress)api/products/@p.ProductId"&gt;
@p.ProductName&lt;/a&gt;
                  &lt;/td&gt;
                &lt;/tr&gt;
              }
            }
            else
            {
              &lt;tr&gt;&lt;td&gt;0 products found.&lt;/td&gt;&lt;/tr&gt;
            }
          &lt;/tbody&gt;
        &lt;/table&gt;
      }
    &lt;/div&gt;
  }
&lt;/div&gt;
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Views/Home</code>, in <code class="inlineCode">Index.cshtml</code>, add code to define a link to the products page, as shown in <a id="_idIndexMarker951"/>the following <a id="_idIndexMarker952"/>markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;p&gt;&lt;a href="home/products"&gt;Search for products by name&lt;/a&gt;&lt;/p&gt;
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Service</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project, using the <code class="inlineCode">https</code> profile without debugging.
    <div><p class="normal">If you are using Visual Studio Code, then the web browser will not start automatically. Start Chrome, and then navigate to <code class="inlineCode">https://localhost:5093</code>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="17">On the home page, click <strong class="screenText">Search for products by name</strong>.</li>
      <li class="numberedList">If the search works, you will see the successful results shown in <em class="italic">Figure 9.1</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_09_01.png"/></figure>
    <p class="packt_figref">Figure 9.1: A successful call to the faulty random web service</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="19">fails, you will <a id="_idIndexMarker953"/>see an error message, as<a id="_idIndexMarker954"/> shown in <em class="italic">Figure 9.2</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_09_02.png"/></figure>
    <p class="packt_figref">Figure 9.2: A successful call to the faulty random web service</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="20">In the command prompt or terminal, when a fault occurs you will see the exception, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">fail: Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddleware[1]
      An unhandled exception has occurred while executing the request.
      System.Exception: Randomized fault.
</code></pre>
      </li>
      <li class="numberedList">Enter different partial<a id="_idIndexMarker955"/> names and click <strong class="screenText">Get Products</strong> until you have seen both a successful search and a failed search.</li>
      <li class="numberedList">Close the<a id="_idIndexMarker956"/> browsers and shut down the web servers.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-360">Implementing the Retry pattern for transient fault handling</h2>
    <p class="normal">Now that we have a web service and MVC client with random faults, let’s add transient fault handling by using the<a id="_idIndexMarker957"/> Retry pattern:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project file, globally and statically import the <code class="inlineCode">System.Console</code> class, and add a package reference for the Microsoft package to integrate Polly with ASP.NET Core (which has a dependency on the <code class="inlineCode">Polly</code> package), and for a library to add jittering to retry time spans, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference Include="Microsoft.Extensions.Http.Polly" 
                    Version="8.0.0" /&gt;
  &lt;PackageReference Include="Polly.Contrib.WaitAndRetry" 
                    Version="1.1.1" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project to restore packages.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, import common Polly namespaces to work with ASP.NET Core, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Polly; // To use AddTransientHttpErrorPolicy method.
using Polly.Contrib.WaitAndRetry; // To use Backoff.
using Polly.Extensions.Http; // To use HttpPolicyExtensions.
using Polly.Retry; // To use AsyncRetryPolicy&lt;T&gt;
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, before the statement to add an HTTP client to services, add statements to generate five jittered and exponentially increasing time-span values, output them to the console, use them to define an asynchronous wait and retry policy, and then add the retry policy to the HTTP client factory, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-comment-slc">// Create five jittered delays, starting with about 1 second.</strong>
<strong class="hljs-slc">IEnumerable&lt;TimeSpan&gt; delays = Backoff.DecorrelatedJitterBackoffV2(</strong>
<strong class="hljs-slc">  medianFirstRetryDelay: TimeSpan.FromSeconds(</strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">), retryCount: </strong><strong class="hljs-number-slc">5</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">WriteLine(</strong><strong class="hljs-string-slc">"Jittered delays for Polly retries:"</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-keyword-slc">foreach</strong><strong class="hljs-slc"> (TimeSpan item </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> delays)</strong>
<strong class="hljs-slc">{</strong>
<strong class="hljs-slc">  WriteLine(</strong><strong class="hljs-string-slc">$"  </strong><strong class="hljs-subst-slc">{item.TotalSeconds:N2}</strong><strong class="hljs-string-slc"> seconds."</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">}</strong>
<strong class="hljs-slc">AsyncRetryPolicy&lt;HttpResponseMessage&gt; retryPolicy = HttpPolicyExtensions</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// Handle network failures, 408 and 5xx status codes.</strong>
<strong class="hljs-slc">  .HandleTransientHttpError().WaitAndRetryAsync(delays);</strong>
builder.Services.AddHttpClient(name: "Northwind.WebApi.Service",
  configureClient: options =&gt;
  {
    options.BaseAddress = new("https://localhost:5091/");
    options.DefaultRequestHeaders.Accept.Add(
      new MediaTypeWithQualityHeaderValue(
        "application/json", 1.0));
  })
  <strong class="hljs-slc">.AddPolicyHandler(retryPolicy)</strong>;
</code></pre>
      </li>
      <li class="numberedList">If your database server is not running (for example, because you are hosting it in Docker, a virtual<a id="_idIndexMarker958"/> machine, or in the cloud), then make sure to start it.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Service</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">In the command prompt or terminal for the MVC project, note the jittered time spans, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Jittered delays for Polly retries:
  1.38 seconds.
  0.15 seconds.
  2.65 seconds.
  3.06 seconds.
  6.46 seconds.
</code></pre>
      
    <div><p class="normal">Your five delays will be different, but they should start at about 1 second and increase from that.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">Arrange the web service command prompt or terminal and the MVC website browser so <a id="_idIndexMarker959"/>that you can see both side by side.</li>
      <li class="numberedList">On the home page, click <strong class="screenText">Search for products by name</strong>.</li>
      <li class="numberedList">Note that the MVC website might have to make multiple requests before showing the page, which will take up to about 15 seconds. For example, when I ran my projects, the MVC web site made four requests that failed before succeeding on the fifth attempt. You will see the exceptions logged in the web service output.</li>
      <li class="numberedList">Enter a partial product name, click <strong class="screenText">Get Products</strong>, and note that the web page will likely appear successfully again, even if one or more requests must be made beforehand.</li>
      <li class="numberedList">It is possible that you could exceed the maximum of five requests, in which case you will see the error message as before.</li>
    </ol>
    <div><p class="normal">Microsoft has created their own packages that wrap Polly to make it even easier to use. They are the <code class="inlineCode">Microsoft.Extensions.Http.Resilience</code> and <code class="inlineCode">Microsoft.Extensions.Resilience</code> packages. You can learn about this at the following link: <a href="https://devblogs.microsoft.com/dotnet/building-resilient-cloud-services-with-dotnet-8/">https://devblogs.microsoft.com/dotnet/building-resilient-cloud-services-with-dotnet-8/</a></p>
    </div>
    <p class="normal">Now that you’ve seen two techniques that improve services, caching, and handling transient faults, let’s look a third powerful technique, queuing.</p>
    <h1 class="heading-1" id="_idParaDest-361">Queuing with RabbitMQ</h1>
    <p class="normal">Queuing can improve<a id="_idIndexMarker960"/> the scalability of your service, just as it can in the physical world. When too many clients all need to call a service at once, we can use a queue to smooth out the load.</p>
    <p class="normal">There are many queuing systems available for all the major development platforms. One of the most popular is RabbitMQ. It <a id="_idIndexMarker961"/>implements the <strong class="keyWord">Advanced Message Queuing Protocol</strong> (<strong class="keyWord">AMQP</strong>). </p>
    <p class="normal">With AMQP, messages are<a id="_idIndexMarker962"/> published to exchanges, which then distribute message copies to queues using rules named bindings. Then a broker can deliver the messages to consumers subscribed to a queue (sometimes called a topic) or a consumer can read from a queue when they want.</p>
    <p class="normal">Since networks and systems often fail, AMQP uses message acknowledgments to tell the broker when a consumer has successfully processed a message, and only then does the broker remove the message from the queue.</p>
    <p class="normal">RabbitMQ supports four types of exchange:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Direct</strong>: A direct exchange <a id="_idIndexMarker963"/>delivers messages based on a message routing key. Multiple queues can be bound to the exchange, but messages are only delivered to a queue if they have a matching routing key. They are mostly used for unicast messages. The default (empty name) exchange is a direct exchange. It is pre-bound with a routing key that is the same name as the queue. This is the type we will use in this book. </li>
      <li class="bulletList"><strong class="keyWord">Fanout</strong>: A fanout <a id="_idIndexMarker964"/>exchange delivers messages to all queues that are bound to it, and the routing key is ignored. These are good for broadcasting messages.</li>
      <li class="bulletList"><strong class="keyWord">Topic</strong>: A topic <a id="_idIndexMarker965"/>exchange delivers messages based on a routing key and criteria defined in the binding between the exchange and a queue. They are used for the publish/subscribe pattern, where there are many consumers but they want to receive different messages, based on factors like geographic location, registered interests, and so on.</li>
      <li class="bulletList"><strong class="keyWord">Headers</strong>: A headers <a id="_idIndexMarker966"/>exchange delivers messages based on multiple attributes in a message header instead of a routing key.</li>
    </ul>
    <p class="normal">The RabbitMQ API uses the following types:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">IConnection</code>: This represents an AMQP connection.</li>
      <li class="bulletList"><code class="inlineCode">ConnectionFactory</code>: This creates <code class="inlineCode">IConnection</code> instances. It has default values for common properties designed to work with the Docker image. For example, <code class="inlineCode">UserName</code> is <code class="inlineCode">guest</code>, <code class="inlineCode">Password</code> is <code class="inlineCode">guest</code>, <code class="inlineCode">VirtualHost</code> is <code class="inlineCode">/</code>, <code class="inlineCode">HostName</code> is <code class="inlineCode">localhost</code>, and <code class="inlineCode">Port</code> is <code class="inlineCode">5672</code>.</li>
      <li class="bulletList"><code class="inlineCode">IModel</code>: This represents the AMQP channel and has methods to perform common tasks, like declaring a queue with <code class="inlineCode">QueueDeclare</code> or sending a message using <code class="inlineCode">BasicPublish</code>.</li>
      <li class="bulletList"><code class="inlineCode">IBasicConsumer</code>: This represents a message consumer.</li>
      <li class="bulletList"><code class="inlineCode">EventBasicConsumer</code>: This is an implementation of a message consumer that integrates with the .NET event system, making it easy for a client app to process a message as soon as it is sent and received.</li>
    </ul>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Queuing systems can get complicated fast. In this book, we will cover the basics, but if you decide to implement any queuing system in production, then you will want to learn much more about how to implement them deeply.</p>
    </div>
    <p class="normal">You can install <a id="_idIndexMarker967"/>RabbitMQ locally on your computer, but for maximum ease of use, I recommend using a Docker image.</p>
    <div><p class="normal">To install RabbitMQ on your computer, read the instructions at the following link for your operating system: <a href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-362">Setting up RabbitMQ using Docker</h2>
    <p class="normal">The Docker image we <a id="_idIndexMarker968"/>will use has RabbitMQ version 3.12.0 and is designed<a id="_idIndexMarker969"/> to be used as a throwaway container, where you simply start the container and your project can start using it with the default configuration.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can read more about the Docker image at the following link: <a href="https://registry.hub.docker.com/_/rabbitmq/">https://registry.hub.docker.com/_/rabbitmq/</a>.</p>
    </div>
    <p class="normal">Let’s get started with RabbitMQ in a Docker container:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Install <strong class="screenText">Docker </strong>from the following link: <a href="https://docs.docker.com/engine/install/">https://docs.docker.com/engine/install/</a>.</li>
      <li class="numberedList">Start <strong class="screenText">Docker</strong>.</li>
      <li class="numberedList">At the command prompt or terminal, pull down the latest container image for RabbitMQ on Docker and run it, opening ports <code class="inlineCode">5672</code> and <code class="inlineCode">15672</code> to the container, which are used by default by AMQP, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.12-management
</code></pre>
      </li>
      <li class="numberedList">Note that the first time <a id="_idIndexMarker970"/>you run this command, the RabbitMQ image will not be found on<a id="_idIndexMarker971"/> your local computer, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Unable to find image 'rabbitmq:3.12-management' locally
</code></pre>
      </li>
      <li class="numberedList">Note that the image will then be downloaded automatically, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">3.12-management: Pulling from library/rabbitmq
99803d4b97f3: Pull complete
8fb904ec525a: Pull complete
ba4d114a87c0: Pull complete
c869b027f1e1: Pull complete
729c8b3166a8: Pull complete
7de098b90abf: Pull complete
4f206ad5199f: Pull complete
1f40437d763f: Pull complete
f4cbf27a2d68: Pull complete
5a4db5ea38b2: Pull complete
99886074092c: Pull complete
Digest: sha256:da98d468cf2236171da94e34953619ddd01b5db155ee326b653675d1e5017f0f
Status: Downloaded newer image for rabbitmq:3.12-management
</code></pre>
      </li>
      <li class="numberedList">Note that RabbitMQ runs on Erlang, and its copyright and license information is displayed when the container starts up, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">2023-06-11 14:03:22.785019+00:00 [info] &lt;0.230.0&gt;  Starting RabbitMQ 3.12.0 on Erlang 25.3.2.2 [jit]
2023-06-11 14:03:22.785019+00:00 [info] &lt;0.230.0&gt;  Copyright (c) 2007-2023 VMware, Inc. or its affiliates.
2023-06-11 14:03:22.785019+00:00 [info] &lt;0.230.0&gt;  Licensed under the MPL 2.0. Website: https://rabbitmq.com
  ##  ##      RabbitMQ 3.12.0
  ##  ##
  ##########  Copyright (c) 2007-2023 VMware, Inc. or its affiliates.
  ######  ##
  ##########  Licensed under the MPL 2.0. Website: https://rabbitmq.com
</code></pre>
      </li>
      <li class="numberedList">Note the <a id="_idIndexMarker972"/>RabbitMQ service listens on port <code class="inlineCode">5672</code> and<a id="_idIndexMarker973"/> has started four plugins, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">2023-06-11 14:03:27.574844+00:00 [info] &lt;0.744.0&gt; started TCP listener on [::]:5672
 completed with 4 plugins.
2023-06-11 14:03:27.659139+00:00 [info] &lt;0.599.0&gt; Server startup complete; 4 plugins started.
2023-06-11 14:03:27.659139+00:00 [info] &lt;0.599.0&gt;  * rabbitmq_prometheus
2023-06-11 14:03:27.659139+00:00 [info] &lt;0.599.0&gt;  * rabbitmq_management
2023-06-11 14:03:27.659139+00:00 [info] &lt;0.599.0&gt;  * rabbitmq_web_dispatch
2023-06-11 14:03:27.659139+00:00 [info] &lt;0.599.0&gt;  * rabbitmq_management_agent
</code></pre>
      </li>
      <li class="numberedList">Leave the command prompt or terminal running.</li>
      <li class="numberedList">Optionally, in <strong class="screenText">Docker Desktop</strong>, note that a container for RabbitMQ runs and listens on ports <code class="inlineCode">5672</code> (the actual queue service) and <code class="inlineCode">15672</code> (its management service), as shown in <em class="italic">Figure 9.3</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_09_03.png"/></figure>
    <p class="packt_figref">Figure 9.3: RabbitMQ running in a Docker container</p>
    <h2 class="heading-2" id="_idParaDest-363">Sending messages to a queue using an MVC website</h2>
    <p class="normal">Now that we have the<a id="_idIndexMarker974"/> RabbitMQ system running, we can add the RabbitMQ client package to the MVC website project so that it can send messages to a queue.</p>
    <p class="normal">But first, let’s create a class library to define models we will use with the queue:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to create a new class library project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Class Library</strong> / <code class="inlineCode">classlib</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter09</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Queue.Models</code></li>
        </ul>
      </li>
      <li class="numberedList">Add a project reference to the Northwind entity models project for SQL Server that you created in <em class="chapterRef">Chapter 3</em>, <em class="italic">Building Entity Models for SQL Server Using EF Core</em>, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\..\Chapter03\Northwind.Common.EntityModels
.SqlServer\Northwind.Common.EntityModels.SqlServer.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">At the command prompt or terminal, build the project to make sure the entity model class library projects outside the current solution are properly compiled, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet build
</code></pre>
      </li>
      <li class="numberedList">Delete the file named <code class="inlineCode">Class1.cs</code>.</li>
      <li class="numberedList">Add a new file named <code class="inlineCode">ProductQueueMessage.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">ProductQueueMessage.cs</code>, define a class that will represent a message in a queue with a <a id="_idIndexMarker975"/>simple plain text property and a complex <code class="inlineCode">Product</code> entity model type as a second property, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels; // To use Product.
namespace Northwind.Queue.Models;
public class ProductQueueMessage
{
  public string? Text { get; set; }
  public Product Product { get; set; } = null!;
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project file, add a reference to the queue models project so that we can use the <code class="inlineCode">ProductQueueMessage</code> class, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include=
  "..\Northwind.Queue.Models\Northwind.Queue.Models.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project file, add a package reference for RabbitMQ clients, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;PackageReference Include="RabbitMQ.Client" Version="6.7.0" /&gt;
</code></pre>
      
    <div><p class="normal">You can check the latest package version at the following link: <a href="https://www.nuget.org/packages/RabbitMQ.Client/">https://www.nuget.org/packages/RabbitMQ.Client/</a></p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">Build the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project.</li>
      <li class="numberedList">In the <code class="inlineCode">Models</code> folder, add a new class file named <code class="inlineCode">HomeSendMessageViewModel.cs</code>.</li>
      <li class="numberedList">Define a class to represent the information that needs to be displayed in a view for sending a message including a couple of properties for showing message to the <a id="_idIndexMarker976"/>visitor when a message is successfully sent and when an error occurs, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.Queue.Models; // To use ProductQueueMessage.
namespace Northwind.WebApi.Client.Mvc.Models;
public class HomeSendMessageViewModel
{
  public string? Info { get; set; }
  public string? Error { get; set; }
  public ProductQueueMessage? Message { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Views\Home</code>, in <code class="inlineCode">Index.cshtml</code>, add a link to a page that will let the visitor send a message to a queue, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;p&gt;&lt;a href="home/sendmessage"&gt;Send a message&lt;/a&gt;&lt;/p&gt;
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">HomeControllers.cs</code>, import namespaces to work with RabbitMQ and serialize JSON, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using RabbitMQ.Client; // To use ConnectionFactory and so on.
using System.Text.Json; // To use JsonSerializer.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">HomeControllers.cs</code>, add statements to define an action method that responds to a <code class="inlineCode">GET</code> request by showing a web form to send a message, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public IActionResult SendMessage()
{
  return View();
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">HomeControllers.cs</code>, add statements to define an action method that responds to a <code class="inlineCode">POST</code> request by sending a message from information in the form, as shown in the<a id="_idIndexMarker977"/> following code:
        <pre class="programlisting code"><code class="hljs-code">// POST: home/sendmessage
// Body: message=Hello&amp;productId=1
[HttpPost]
public async Task&lt;IActionResult&gt; SendMessage(
  string? message, int? productId)
{
  HomeSendMessageViewModel model = new();
  model.Message = new();
  if (message is null || productId is null)
  {
    model.Error = "Please enter a message and a product ID.";
    return View(model);
  }
  model.Message.Text = message;
  model.Message.Product = new() { ProductId = productId.Value };
  HttpClient client = _httpClientFactory.CreateClient(
    name: "Northwind.WebApi.Service");
  HttpRequestMessage request = new(
    method: HttpMethod.Get,
    requestUri: $"api/products/{productId}");
  HttpResponseMessage response = await client.SendAsync(request);
  if (response.IsSuccessStatusCode)
  {
    Product? product = await response.Content.ReadFromJsonAsync&lt;Product&gt;();
    if (product is not null)
    {
      model.Message.Product = product;
    }
  }
  // Create a RabbitMQ factory.
  ConnectionFactory factory = new() { HostName = "localhost" };
  using IConnection connection = factory.CreateConnection();
  using IModel channel = connection.CreateModel();
  string queueNameAndRoutingKey = "product";
  // If the queue does not exist, it will be created.
  // If the Docker container is restarted, the queue will be lost.
  // The queue can be shared with multiple consumers.
  // The queue will not be deleted when the last message is consumer.
  channel.QueueDeclare(queue: queueNameAndRoutingKey, durable: false, 
    exclusive: false, autoDelete: false, arguments: null);
  byte[] body = JsonSerializer.SerializeToUtf8Bytes(model.Message);
  // The exchange is empty because we are using the default exchange.
  channel.BasicPublish(exchange: string.Empty, 
    routingKey: queueNameAndRoutingKey, 
    basicProperties: null, body: body);
  model.Info = "Message sent to queue successfully.";
  return View(model);
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Views\Home</code>, add a<a id="_idIndexMarker978"/> new empty Razor View named <code class="inlineCode">SendMessage.cshtml</code>.</li>
      <li class="numberedList">Define a web page with a form to send a message, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">@model HomeSendMessageViewModel
@{
  ViewData["Title"] = "Send a Message";
}
&lt;div class="text-center"&gt;
  &lt;h1 class="display-4"&gt;@ViewData["Title"]&lt;/h1&gt;
  @if (Model is not null)
  {
    if (Model.Error is not null)
    {
      &lt;div class="alert alert-danger"&gt;
        &lt;h2&gt;Error&lt;/h2&gt;
        &lt;p&gt;@Model.Error&lt;/p&gt;
      &lt;/div&gt;
    }
    if (Model.Info is not null)
    {
      &lt;div class="alert alert-info"&gt;
        &lt;h2&gt;Information&lt;/h2&gt;
        &lt;p&gt;@Model.Info&lt;/p&gt;
      &lt;/div&gt;
    }
  }
  &lt;form asp-controller="Home" asp-action="SendMessage" method="post"&gt;
    &lt;div&gt;
      &lt;label for="message"&gt;Message&lt;/label&gt;
      &lt;input id="message" name="message" /&gt;
    &lt;/div&gt;
    &lt;div&gt;
      &lt;label for="productId"&gt;Product ID&lt;/label&gt;
      &lt;input id="productId" name="productId" /&gt;
    &lt;/div&gt;
    &lt;input type="submit" value="Send" /&gt;"
  &lt;/form&gt;
&lt;/div&gt;
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-364">Consuming message from a queue using a console app</h2>
    <p class="normal">Finally, we can create a <a id="_idIndexMarker979"/>console app that will process messages from the queue:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to create a new console app project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Console App</strong> / <code class="inlineCode">console</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter09</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Queue.Consumer</code></li>
        </ul>
      </li>
      <li class="numberedList">Treat warnings as errors, add a package reference for RabbitMQ, add project references to the Northwind entity models project and the queue message models<a id="_idIndexMarker980"/> project, and statically and globally import the <code class="inlineCode">System.Console</code> class, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;Project Sdk="Microsoft.NET.Sdk"&gt;
  &lt;PropertyGroup&gt;
    &lt;OutputType&gt;Exe&lt;/OutputType&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
<strong class="hljs-slc">    &lt;TreatWarningsAsErrors&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/TreatWarningsAsErrors&gt;</strong>
  &lt;/PropertyGroup&gt;
<strong class="hljs-slc">  &lt;ItemGroup&gt;</strong>
<strong class="hljs-slc">    &lt;PackageReference Include=</strong><strong class="hljs-string-slc">"RabbitMQ.Client"</strong><strong class="hljs-slc"> Version=</strong><strong class="hljs-string-slc">"6.7.0"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong>
<strong class="hljs-slc">  &lt;ItemGroup&gt;</strong>
<strong class="hljs-slc">    &lt;ProjectReference Include=</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-string-slc">"..\..\Chapter03\Northwind.Common.EntityModels.SqlServer\</strong>
<strong class="hljs-string-slc">      Northwind.Common.EntityModels.SqlServer.csproj"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">    &lt;ProjectReference Include=</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-string-slc">"..\Northwind.Queue.Models\Northwind.Queue.Models.csproj"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong>
<strong class="hljs-slc">  &lt;ItemGroup&gt;</strong>
<strong class="hljs-slc">    &lt;Using Include=</strong><strong class="hljs-string-slc">"System.Console"</strong><strong class="hljs-slc"> Static=</strong><strong class="hljs-string-slc">"true"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong>
&lt;/Project&gt;
</code></pre>
      </li>
      <li class="numberedList">At the command prompt or terminal, build the project, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet build
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, delete<a id="_idIndexMarker981"/> any existing statements, and then add statements to read messages from the <code class="inlineCode">product</code> queue, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.Queue.Models; // To use ProductQueueMessage.
using RabbitMQ.Client; // To use ConnectionFactory.
using RabbitMQ.Client.Events; // To use EventingBasicConsumer.
using System.Text.Json; // To use JsonSerializer.
string queueName = "product";
ConnectionFactory factory = new () { HostName = "localhost" };
using IConnection connection = factory.CreateConnection();
using IModel channel = connection.CreateModel();
WriteLine("Declaring queue...");
QueueDeclareOk response = channel.QueueDeclare(
  queue: queueName,
  durable: false,
  exclusive: false,
  autoDelete: false,
  arguments: null);
WriteLine("Queue name: {response.QueueName}, Message count: {
  response.MessageCount}, Consumer count: {response.ConsumerCount}.");
WriteLine("Waiting for messages...");
EventingBasicConsumer consumer = new(channel);
consumer.Received += (model, args) =&gt;
{
  byte[] body = args.Body.ToArray();
  ProductQueueMessage? message = JsonSerializer
    .Deserialize&lt;ProductQueueMessage&gt;(body);
  if (message is not null)
  {
    WriteLine("Received product. Id: {message.Product.ProductId
      }, Name: { message.Product.ProductName}, Message: {
      message.Text}");
  }
  else
  {
    WriteLine($"Received unknown: {args.Body.ToArray()}.");
  }
};
// Start consuming as messages arrive in the queue.
channel.BasicConsume(queue: queueName,
  autoAck: true,
  consumer: consumer);
WriteLine("&gt;&gt;&gt; Press Enter to stop consuming and quit. &lt;&lt;&lt;");
ReadLine();
</code></pre>
      </li>
      <li class="numberedList">If your database <a id="_idIndexMarker982"/>server is not running (for example, because you are hosting it in Docker, a virtual machine, or in the cloud), then make sure to start it.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Service</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Queue.Consumer</code> console app project with or without debugging:<ul>
          <li class="bulletList">Optionally, you can configure your solution to start up all three projects at once, as shown for Visual Studio 2022 in <em class="italic">Figure 9.4</em>:</li>
        </ul>
      
    <figure class="mediaobject"><img alt="" src="img/B19587_09_04.png"/></figure>
    <p class="packt_figref">Figure 9.4: Configuring three startup projects to test message queues</p></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">Arrange the console app and the<a id="_idIndexMarker983"/> MVC web page so that you can see both, then click <strong class="screenText">Send a message</strong>, and enter a simple text message and a valid product ID (1 to 77), as shown in <em class="italic">Figure 9.5</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_09_05.png"/></figure>
    <p class="packt_figref">Figure 9.5: An ASP.NET Core MVC website sending a message to a queue</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">Click <strong class="screenText">Send</strong>, and note<a id="_idIndexMarker984"/> the message that appears in the console app, as shown in <em class="italic">Figure 9.6</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_09_06.png"/></figure>
    <p class="packt_figref">Figure 9.6: A console app consuming a message from the queue</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="11">In the command <a id="_idIndexMarker985"/>prompt or terminal for Docker, press <em class="keystroke">Ctrl</em> + <em class="keystroke">C</em> to shut down the container, and note the result, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">2023-06-11 17:42:31.006172+00:00 [info] &lt;0.744.0&gt; stopped TCP listener on [::]:5672
2023-06-11 17:42:31.008574+00:00 [info] &lt;0.1552.0&gt; Closing all connections in vhost '/' on node 'rabbit@e9014dbbe5f5' because the vhost is stopping
2023-06-11 17:42:31.017407+00:00 [info] &lt;0.557.0&gt; Stopping message store for directory '/var/lib/rabbitmq/mnesia/rabbit@e9014dbbe5f5/msg_stores/vhosts/628WB79CIFDYO9LJI6DKMI09L/msg_store_persistent'
2023-06-11 17:42:31.024661+00:00 [info] &lt;0.557.0&gt; Message store for directory '/var/lib/rabbitmq/mnesia/rabbit@e9014dbbe5f5/msg_stores/vhosts/628WB79CIFDYO9LJI6DKMI09L/msg_store_persistent' is stopped
2023-06-11 17:42:31.024937+00:00 [info] &lt;0.553.0&gt; Stopping message store for directory '/var/lib/rabbitmq/mnesia/rabbit@e9014dbbe5f5/msg_stores/vhosts/628WB79CIFDYO9LJI6DKMI09L/msg_store_transient'
2023-06-11 17:42:31.031218+00:00 [info] &lt;0.553.0&gt; Message store for directory '/var/lib/rabbitmq/mnesia/rabbit@e9014dbbe5f5/msg_stores/vhosts/628WB79CIFDYO9LJI6DKMI09L/msg_store_transient' is stopped
2023-06-11 17:42:31.037584+00:00 [info] &lt;0.489.0&gt; Management plugin: to stop collect_statistics.
</code></pre>
      </li>
      <li class="numberedList">In <strong class="screenText">Docker Desktop</strong>, note the container is gone from the list, but the image remains for quicker use next time.</li>
    </ol>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can read more about using RabbitMQ with .NET at the following link: <a href="https://www.rabbitmq.com/dotnet-api-guide.html">https://www.rabbitmq.com/dotnet-api-guide.html</a>.</p>
    </div>
    <p class="normal">The combination of caching, queuing, and<a id="_idIndexMarker986"/> handling transient faults goes a long way to making your services more resilient, scalable, and <a id="_idIndexMarker987"/>performant. In the last section of this chapter, we will look at long-running background services.</p>
    <h1 class="heading-1" id="_idParaDest-365">Implementing long-running background services</h1>
    <p class="normal">It is common to need long-running<a id="_idIndexMarker988"/> background services to perform operations like:</p>
    <ul>
      <li class="bulletList">Performing a task on a regular timed schedule.</li>
      <li class="bulletList">Processing queued messages.</li>
      <li class="bulletList">Performing intense work like building AI and ML models or processing video and images.</li>
    </ul>
    <p class="normal">In the distant past, on the Windows operating system, to have some code running in the background meant building a <strong class="keyWord">Windows Service</strong>. For example, the database engine of SQL Server is implemented as a Windows Service. With the move to cross-platform, .NET needs a cross-platform solution to run code in the background.</p>
    <p class="normal">Background services often do not have a user interface, although they might provide one for the configuration and<a id="_idIndexMarker989"/> management of the service.</p>
    <h2 class="heading-2" id="_idParaDest-366">Building a worker service</h2>
    <p class="normal">Now, let’s build a worker <a id="_idIndexMarker990"/>service project <a id="_idIndexMarker991"/>so that we can see how we would host a long-running background service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to add a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Worker Service </strong>/ <code class="inlineCode">worker</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter09</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Background.Workers</code></li>
          <li class="bulletList"><strong class="screenText">Enable Docker</strong>: Cleared</li>
          <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared</li>
          <li class="bulletList"><strong class="screenText">Enable native AOT publish</strong>: Cleared</li>
        </ul>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Background.Workers</code> project file, note that the .NET SDK is <code class="inlineCode">Microsoft.NET.Sdk.Worker</code>, and then make the following changes, as highlighted in the following markup:<ul>
          <li class="bulletList">Treat warnings as errors.</li>
          <li class="bulletList">Add a package reference for RabbitMQ.</li>
          <li class="bulletList">Add references to the entity models and queue models projects:
            <pre class="programlisting code"><code class="hljs-code">&lt;Project Sdk="<strong class="hljs-string-slc">Microsoft.NET.Sdk.Worker</strong>"&gt;
  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;UserSecretsId&gt;dotnet-Northwind.Background.Workers-66434cdf-0fdd-4993-a399-ec9581b4b914&lt;/UserSecretsId&gt;
<strong class="hljs-slc">    &lt;TreatWarningsAsErrors&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/TreatWarningsAsErrors&gt;</strong>
  &lt;/PropertyGroup&gt;
  &lt;ItemGroup&gt;
    &lt;PackageReference Include="Microsoft.Extensions.Hosting" 
                      Version="8.0.0" /&gt;
<strong class="hljs-slc">    &lt;PackageReference Include=</strong><strong class="hljs-string-slc">"RabbitMQ.Client"</strong><strong class="hljs-slc"> Version=</strong><strong class="hljs-string-slc">"6.7.0"</strong><strong class="hljs-slc"> /&gt;</strong>
  &lt;/ItemGroup&gt;
<strong class="hljs-slc">  &lt;ItemGroup&gt;</strong>
<strong class="hljs-slc">    &lt;ProjectReference Include=</strong>
<strong class="hljs-string-slc">"..\..\Chapter03\Northwind.Common.EntityModels</strong>
<strong class="hljs-string-slc">.SqlServer\Northwind.Common.EntityModels.SqlServer.csproj"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">    &lt;ProjectReference Include=</strong>
<strong class="hljs-string-slc">"..\Northwind.Queue.Models\Northwind.Queue.Models.csproj"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong>
&lt;/Project&gt;
</code></pre>
          </li>
        </ul>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.Background.Workers</code> project at the command prompt or terminal by entering the following command: <code class="inlineCode">dotnet build</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, note<a id="_idIndexMarker992"/> that the initialization statements are like an ASP.NET Core project, and that it registers a hosted service named <code class="inlineCode">Worker</code> and then runs the host, as shown in<a id="_idIndexMarker993"/> the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.Background.Workers;
var builder = Host.CreateApplicationBuilder(args);
builder.Services.AddHostedService&lt;Worker&gt;();
var host = builder.Build();
host.Run();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Worker.cs</code>, note that the <code class="inlineCode">Worker</code> class inherits from <code class="inlineCode">BackgroundService</code> and implements its <code class="inlineCode">ExecuteAsync</code> method by looping until a cancellation is requested, logging the current date/time, and then pausing for one second, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.Background.Workers
{
  public class Worker : BackgroundService
  {
    private readonly ILogger&lt;Worker&gt; _logger;
    public Worker(ILogger&lt;Worker&gt; logger)
    {
      _logger = logger;
    }
    protected override async Task ExecuteAsync(
      CancellationToken stoppingToken)
    {
      while (!stoppingToken.IsCancellationRequested)
      {
        _logger.LogInformation("Worker running at: {time}", 
          DateTimeOffset.Now);
        await Task.Delay(1000, stoppingToken);
      }
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Start the project <a id="_idIndexMarker994"/>without debugging, note<a id="_idIndexMarker995"/> the current time is output once per second, and then press <em class="keystroke">Ctrl</em> + <em class="keystroke">C</em> to shut down the worker service, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Northwind.Queue.Worker.Worker[0]
      Worker running at: 06/12/2023 08:25:02 +01:00
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\apps-services-net8\Chapter09\Northwind.Queue.Worker
info: Northwind.Queue.Worker.Worker[0]
      Worker running at: 06/12/2023 08:25:03 +01:00
info: Northwind.Queue.Worker.Worker[0]
      Worker running at: 06/12/2023 08:25:04 +01:00
info: Northwind.Queue.Worker.Worker[0]
      Worker running at: 06/12/2023 08:25:05 +01:00
info: Microsoft.Hosting.Lifetime[0]
      Application is shutting down...
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-367">Processing queued message using a worker service</h2>
    <p class="normal">Now, we can do some useful <a id="_idIndexMarker996"/>work, like reading messages from a RabbitMQ queue:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Rename <code class="inlineCode">Worker.cs</code> to <code class="inlineCode">QueueWorker.cs</code> and the <code class="inlineCode">Worker</code> class to <code class="inlineCode">QueueWorker</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, change the<a id="_idIndexMarker997"/> hosted service class name from <code class="inlineCode">Worker</code> to <code class="inlineCode">QueueWorker</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddHostedService&lt;QueueWorker&gt;();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">QueueWorker.cs</code>, import namespaces to work with RabbitMQ queues and implement a queue processor, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> Northwind.Queue.Models; </strong><strong class="hljs-comment-slc">// To use ProductQueueMessage.</strong>
<strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> RabbitMQ.Client; </strong><strong class="hljs-comment-slc">// To use ConnectionFactory.</strong>
<strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> RabbitMQ.Client.Events; </strong><strong class="hljs-comment-slc">// To use EventingBasicConsumer.</strong>
<strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> System.Text.Json; </strong><strong class="hljs-comment-slc">// To use JsonSerializer.</strong>
namespace Northwind.Background.Workers;
public class <strong class="hljs-title-slc">Queue</strong>Worker : BackgroundService
{
  private readonly ILogger&lt;QueueWorker&gt; _logger;
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// RabbitMQ objects.</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">const</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc"> queueNameAndRoutingKey = </strong><strong class="hljs-string-slc">"product"</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> ConnectionFactory _factory;</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> IConnection _connection;</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> IModel _channel;</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> EventingBasicConsumer _consumer;</strong>
  public QueueWorker(ILogger&lt;QueueWorker&gt; logger)
  {
    _logger = logger;
<strong class="hljs-slc">    _factory = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">() { HostName = </strong><strong class="hljs-string-slc">"localhost"</strong><strong class="hljs-slc"> };</strong>
<strong class="hljs-slc">    _connection = _factory.CreateConnection();</strong>
<strong class="hljs-slc">    _channel = _connection.CreateModel();</strong>
<strong class="hljs-slc">    _consumer = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">(_channel);</strong>
<strong class="hljs-slc">    _channel.QueueDeclare(queue: queueNameAndRoutingKey, durable: </strong><strong class="hljs-literal-slc">false</strong><strong class="hljs-slc">, </strong>
<strong class="hljs-slc">      exclusive: </strong><strong class="hljs-literal-slc">false</strong><strong class="hljs-slc">, autoDelete: </strong><strong class="hljs-literal-slc">false</strong><strong class="hljs-slc">, arguments: </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">    _consumer = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">(_channel);</strong>
<strong class="hljs-slc">    _consumer.Received += (model, args) =&gt;</strong>
<strong class="hljs-slc">    {</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-built_in-slc">byte</strong><strong class="hljs-slc">[] body = args.Body.ToArray();</strong>
<strong class="hljs-slc">      ProductQueueMessage? message = JsonSerializer</strong>
<strong class="hljs-slc">        .Deserialize&lt;ProductQueueMessage&gt;(body);</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (message </strong><strong class="hljs-keyword-slc">is</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">not</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">      {</strong>
<strong class="hljs-slc">        _logger.LogInformation(</strong><strong class="hljs-string-slc">$"Received product. Id: </strong><strong class="hljs-subst-slc">{</strong>
<strong class="hljs-subst-slc">         </strong> <strong class="hljs-subst-slc">message.Product.ProductId}</strong><strong class="hljs-string-slc">, Name: </strong><strong class="hljs-subst-slc">{message.Product</strong>
<strong class="hljs-subst-slc">          .ProductName}</strong><strong class="hljs-string-slc">, Message: </strong><strong class="hljs-subst-slc">{message.Text}</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">      }</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-keyword-slc">else</strong>
<strong class="hljs-slc">      {</strong>
<strong class="hljs-slc">        _logger.LogInformation(</strong><strong class="hljs-string-slc">"Received unknown: {0}."</strong><strong class="hljs-slc">, </strong>
<strong class="hljs-slc">          args.Body.ToArray());</strong>
<strong class="hljs-slc">      }</strong>
<strong class="hljs-slc">    };</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-comment-slc">// Start consuming as messages arrive in the queue.</strong>
<strong class="hljs-slc">    _channel.BasicConsume(queue: queueNameAndRoutingKey,</strong>
<strong class="hljs-slc">      autoAck: </strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">, consumer: _consumer);</strong>
  }
  protected override async Task ExecuteAsync(
    CancellationToken stoppingToken)
  {
    while (!stoppingToken.IsCancellationRequested)
    {
      _logger.LogInformation("Worker running at: {time}", 
        DateTimeOffset.Now);
      await Task.Delay(3000, stoppingToken);
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Start the RabbitMQ container, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.12-management
</code></pre>
      </li>
      <li class="numberedList">Wait for the messages to say it is ready for clients to connect on port <code class="inlineCode">5672</code>, as shown in the following <a id="_idIndexMarker998"/>output:
        <pre class="programlisting con"><code class="hljs-con">2023-06-12 08:50:16.591574+00:00 [info] &lt;0.599.0&gt; Ready to start client connection listeners
2023-06-12 08:50:16.593090+00:00 [info] &lt;0.744.0&gt; started TCP listener on [::]:5672
</code></pre>
      </li>
      <li class="numberedList">Leave the command prompt or terminal running.</li>
      <li class="numberedList">If your database server is not running (for example, because you are hosting it in Docker, a<a id="_idIndexMarker999"/> virtual machine, or in the cloud), then make sure to start it.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Service</code> project without debugging so that we can query for products in the Northwind database.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project without debugging so that we can send messages to the RabbitMQ queue.</li>
      <li class="numberedList">In the MVC website, click <strong class="screenText">Send a message</strong>, and then enter a message of <code class="inlineCode">apples</code> and a product ID of <code class="inlineCode">1</code>.</li>
      <li class="numberedList">Repeat for <code class="inlineCode">bananas</code> and <code class="inlineCode">2</code>, and <code class="inlineCode">cherries</code> and <code class="inlineCode">3</code>.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Background.Workers</code> project without debugging, and note the three messages are processed from the queue, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Northwind.Background.Workers.QueueWorker[0]
      Queue product is waiting for messages.
info: Northwind.Background.Workers.QueueWorker[0]
      Worker running at: 06/12/2023 09:58:59 +01:00
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\apps-services-net8\Chapter09\Northwind.Queue.Worker
info: Northwind.Background.Workers.QueueWorker[0]
      Received product. Id: 1, Name: Chai, Message: apples
info: Northwind.Background.Workers.QueueWorker[0]
      Received product. Id: 2, Name: Chang, Message: bananas
info: Northwind.Background.Workers.QueueWorker [0]
      Received product. Id: 3, Name: Aniseed Syrup, Message: cherries
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-368">Executing code on a timed schedule</h2>
    <p class="normal">Another common use of <a id="_idIndexMarker1000"/>worker services is to implement timed events. A timer-based background service can use the <code class="inlineCode">System.Threading.Timer</code> class that triggers the <code class="inlineCode">DoWork</code> method.</p>
    <p class="normal">Let’s add another service to the background worker project:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Background.Workers</code> project, add a new class named <code class="inlineCode">TimerWorker.cs</code>.</li>
      <li class="numberedList">Modify the class, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.Background.Workers;
public class TimerWorker : IHostedService, IAsyncDisposable
{
  private readonly ILogger&lt;TimerWorker&gt; _logger;
  private int _executionCount = 0;
  private Timer? _timer;
  private int _seconds = 5;
  public TimerWorker(ILogger&lt;TimerWorker&gt; logger)
  {
    _logger = logger;
  }
  private void DoWork(object? state)
  {
    int count = Interlocked.Increment(ref _executionCount);
    _logger.LogInformation(
        "{0} is working, execution count: {1:#,0}",
        nameof(TimerWorker), count);
  }
  public Task StartAsync(CancellationToken cancellationToken)
  {
    _logger.LogInformation("{0} is running.", nameof(TimerWorker));
    _timer = new Timer(callback: DoWork, state: null, 
      dueTime: TimeSpan.Zero, 
      period: TimeSpan.FromSeconds(_seconds));
    return Task.CompletedTask;
  }
  public Task StopAsync(CancellationToken cancellationToken)
  {
    _logger.LogInformation("{0} is stopping.", nameof(TimerWorker));
    _timer?.Change(dueTime: Timeout.Infinite, period: 0);
    return Task.CompletedTask;
  }
  public async ValueTask DisposeAsync()
  {
    if (_timer is IAsyncDisposable asyncTimer)
    {
      await asyncTimer.DisposeAsync();
    }
    _timer = null;
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, add a statement to register<a id="_idIndexMarker1001"/> the timer worker service, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddHostedService&lt;TimerWorker&gt;();
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Background.Workers</code> project without debugging, and note the initialization<a id="_idIndexMarker1002"/> of both workers, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Northwind.Background.Workers.QueueWorker[0]
      Worker running at: 06/12/2023 12:58:25 +01:00
info: Northwind.Background.Workers.TimerWorker[0]
      TimerWorker is running.
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\apps-services-net8\Chapter09\Northwind.Background.Workers
</code></pre>
      </li>
      <li class="numberedList">Leave the background workers running for at least 10 seconds, and note the queue worker writes to the log every second and the timer worker writes to the log every five seconds, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Northwind.Background.Workers.TimerWorker[0]
      TimerWorker is working, execution count: 1
info: Northwind.Background.Workers.QueueWorker[0]
      Worker running at: 06/12/2023 12:58:26 +01:00
info: Northwind.Background.Workers.QueueWorker[0]
      Worker running at: 06/12/2023 12:58:27 +01:00
info: Northwind.Background.Workers.QueueWorker[0]
      Worker running at: 06/12/2023 12:58:28 +01:00
info: Northwind.Background.Workers.QueueWorker[0]
      Worker running at: 06/12/2023 12:58:29 +01:00
info: Northwind.Background.Workers.TimerWorker[0]
      TimerWorker is working, execution count: 2
</code></pre>
      </li>
      <li class="numberedList">Press <em class="keystroke">Ctrl</em> + <em class="keystroke">C</em> to shut down the background workers, and note the clean shutdown of the timer worker, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Microsoft.Hosting.Lifetime[0]
      Application is shutting down...
info: Northwind.Background.Workers.TimerWorker[0]
      TimerWorker is stopping.
</code></pre>
      </li>
    </ol>
    <p class="normal">If we wanted to use the timer background service to have more flexibility, instead of running it at a regular interval like five seconds, we could have it run a scheduled task check every second, and only if a task has reached its scheduled time does it then run that task. We need somewhere<a id="_idIndexMarker1003"/> to define tasks and when they are scheduled to run. Although you can build this infrastructure yourself, it is easier to use a third-party library like <strong class="keyWord">Hangfire</strong>.</p>
    <h2 class="heading-2" id="_idParaDest-369">Building a website to host Hangfire</h2>
    <p class="normal">Hangfire is open source <a id="_idIndexMarker1004"/>and free for commercial<a id="_idIndexMarker1005"/> use. It supports the following patterns of use:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Fire-and-forget</strong>: Jobs that are <a id="_idIndexMarker1006"/>executed once and started immediately.</li>
      <li class="bulletList"><strong class="keyWord">Delayed</strong>: Jobs that are<a id="_idIndexMarker1007"/> executed once but at a date and time in the future.</li>
      <li class="bulletList"><strong class="keyWord">Recurring</strong>: Jobs that<a id="_idIndexMarker1008"/> are executed repeatedly at a regular CRON schedule.</li>
      <li class="bulletList"><strong class="keyWord">Continuation</strong>: Jobs that <a id="_idIndexMarker1009"/>are executed on completion of a parent job.</li>
      <li class="bulletList"><strong class="keyWord">Batches</strong>: Jobs that<a id="_idIndexMarker1010"/> are transactional. These are only available in the paid version.</li>
    </ul>
    <p class="normal">Hangfire has persistent storage and can be configured to use:</p>
    <ul>
      <li class="bulletList">SQL Server</li>
      <li class="bulletList">Redis</li>
      <li class="bulletList">In-memory</li>
      <li class="bulletList">Community-developed storage</li>
    </ul>
    <p class="normal">Let’s set up an empty ASP.NET Core project to host Hangfire:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to create a new Web API controller-based project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">ASP.NET Core Empty</strong> / <code class="inlineCode">web</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter09</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Background.Hangfire</code></li>
          <li class="bulletList"><strong class="screenText">Configure for HTTPS</strong>: Selected.</li>
          <li class="bulletList"><strong class="screenText">Enable Docker</strong>: Cleared.</li>
          <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared.</li>
        </ul>
      </li>
      <li class="numberedList">In the project file, treat warnings as errors, and add package references to work with Hangfire and persist its data to SQL Server, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference Include="Hangfire.Core" Version="1.8.6" /&gt;
  &lt;PackageReference Include="Hangfire.SqlServer" Version="1.8.6" /&gt;
  &lt;PackageReference Include="Hangfire.AspNetCore" Version="1.8.6" /&gt;
  &lt;PackageReference Include="Microsoft.Data.SqlClient" Version="5.1.2" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the project to<a id="_idIndexMarker1011"/> restore packages.</li>
      <li class="numberedList">In the <code class="inlineCode">Properties</code> folder, in <code class="inlineCode">launchSettings.json</code>, modify the <code class="inlineCode">applicationUrl</code> of the <a id="_idIndexMarker1012"/>profile named <code class="inlineCode">https</code> to use port <code class="inlineCode">5095</code> for <code class="inlineCode">https</code> and port <code class="inlineCode">5096</code> for <code class="inlineCode">http</code>, as highlighted in the following configuration:
        <pre class="programlisting code"><code class="hljs-code">"profiles": {
  ...
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"https"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">{</strong>
    "commandName": "Project",
    "dotnetRunMessages": true,
    "launchBrowser": true,
    "launchUrl": "swagger",
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"applicationUrl"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"https://localhost:5095;http://localhost:5096"</strong><strong class="hljs-punctuation-slc">,</strong>
    "environmentVariables": {
      "ASPNETCORE_ENVIRONMENT": "Development"
    }
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">appsettings.Development.json</code>, add an entry to set the Hangfire log level to <code class="inlineCode">Information</code>, as highlighted in the following JSON:
        <pre class="programlisting code"><code class="hljs-code">{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"<strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-attr-slc">"Hangfire"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">Information"</strong>
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Create a SQL Server database named <code class="inlineCode">Northwind.HangfireDb</code>:<ul>
          <li class="bulletList">If you are using <a id="_idIndexMarker1013"/>Visual Studio 2022, navigate to <strong class="screenText">View</strong> | <strong class="screenText">Server Explorer</strong>, right-click <strong class="screenText">Data Connections</strong>, choose <strong class="screenText">Create New SQL Server database…</strong>, enter connection information and the database name, and then click <strong class="screenText">OK</strong>.</li>
          <li class="bulletList">If you are using Visual Studio Code, navigate to <strong class="screenText">SQL</strong> <strong class="screenText">Server</strong>, right-click and choose <strong class="screenText">New Query</strong>, enter connection information, and then in the query window, enter the following SQL command and execute it:
            <pre class="programlisting code"><code class="hljs-code">USE master
GO
CREATE DATABASE [Northwind.HangfireDb]
GO
</code></pre>
          </li>
        </ul>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, delete the existing statements, and then add statements to configure Hangfire to<a id="_idIndexMarker1014"/> use SQL Server and to enable Hangfire Dashboard, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Data.SqlClient; // To use SqlConnectionStringBuilder.
using Hangfire; // To use GlobalConfiguration.
SqlConnectionStringBuilder connection = new();
connection.InitialCatalog = "Northwind.HangfireDb";
connection.MultipleActiveResultSets = true;
connection.Encrypt = true;
connection.TrustServerCertificate = true;
connection.ConnectTimeout = 5; // Default is 30 seconds.
connection.DataSource = "."; // To use local SQL Server.
// To use Windows Integrated authentication.
connection.IntegratedSecurity = true;
/*
// To use SQL Server authentication.
builder.UserID = "sa";
builder.Password = "123456";
builder.PersistSecurityInfo = false;
*/
var builder = WebApplication.CreateBuilder(args);
builder.Services.AddHangfire(config =&gt; config
  .SetDataCompatibilityLevel(CompatibilityLevel.Version_180)
  .UseSimpleAssemblyNameTypeSerializer()
  .UseRecommendedSerializerSettings()
  .UseSqlServerStorage(connection.ConnectionString));
builder.Services.AddHangfireServer();
var app = builder.Build();
app.UseHangfireDashboard();
app.MapGet("/", () =&gt; 
  "Navigate to /hangfire to see the Hangfire Dashboard.");
app.MapHangfireDashboard();
app.Run();
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Background.Hangfire</code> project <a id="_idIndexMarker1015"/>without debugging, and note the messages <a id="_idIndexMarker1016"/>written to the console, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Hangfire.SqlServer.SqlServerObjectsInstaller[0]
      Start installing Hangfire SQL objects...
info: Hangfire.SqlServer.SqlServerObjectsInstaller[0]
      Hangfire SQL objects installed.
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:5095
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5096
info: Hangfire.BackgroundJobServer[0]
      Starting Hangfire Server using job storage: 'SQL Server: .@Northwind.HangfireDb'
info: Hangfire.BackgroundJobServer[0]
      Using the following options for SQL Server job storage: Queue poll interval: 00:00:00.
info: Hangfire.BackgroundJobServer[0]
      Using the following options for Hangfire Server:
          Worker count: 20
          Listening queues: 'default'
          Shutdown timeout: 00:00:15
          Schedule polling interval: 00:00:15
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\apps-services-net8\Chapter09\Northwind.Background.Hangfire
info: Hangfire.Server.BackgroundServerProcess[0]
      Server desktop-j1pqhr7:14120:c8ea792b successfully announced in 140.4628 ms
info: Hangfire.Server.BackgroundServerProcess[0]
      Server desktop-j1pqhr7:14120:c8ea792b is starting the registered dispatchers: ServerWatchdog, ServerJobCancellationWatcher, ExpirationManager, CountersAggregator, SqlServerHeartbeatProcess, Worker, DelayedJobScheduler, RecurringJobScheduler...
info: Hangfire.Server.BackgroundServerProcess[0]
      Server desktop-j1pqhr7:14120:c8ea792b all the dispatchers started
</code></pre>
      </li>
      <li class="numberedList">In the browser, note<a id="_idIndexMarker1017"/> the plain<a id="_idIndexMarker1018"/> text message, and then in the address bar, append <code class="inlineCode">hangfire</code>, and note the <strong class="screenText">Hangfire Dashboard</strong> user interface, as shown in <em class="italic">Figure 9.7</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_09_07.png"/></figure>
    <p class="packt_figref">Figure 9.7: Hangfire Dashboard user interface</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">Close the browser window, and<a id="_idIndexMarker1019"/> at the command prompt or terminal for the Hangfire service, press <em class="keystroke">Ctrl</em> + <em class="keystroke">C</em> to cleanly shut down the server, and note the<a id="_idIndexMarker1020"/> messages, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Microsoft.Hosting.Lifetime[0]
      Application is shutting down...
info: Hangfire.Server.BackgroundServerProcess[0]
      Server desktop-j1pqhr7:14120:c8ea792b caught stopping signal...
info: Hangfire.Server.BackgroundServerProcess[0]
      Server desktop-j1pqhr7:14120:c8ea792b All dispatchers stopped
info: Hangfire.Server.BackgroundServerProcess[0]
      Server desktop-j1pqhr7:14120:c8ea792b successfully reported itself as stopped in 2.8874 ms
info: Hangfire.Server.BackgroundServerProcess[0]
      Server desktop-j1pqhr7:14120:c8ea792b has been stopped in total 19.6204 ms
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-370">Scheduling jobs using Hangfire</h2>
    <p class="normal">Next, we will allow a<a id="_idIndexMarker1021"/> client to schedule a job (in this case, just writing a message to the console a specified number of seconds in the future) by <code class="inlineCode">POST</code>ing to the web service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Background.Hangfire</code> project, add a new class file named <code class="inlineCode">WriteMessageJobDetail.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">WriteMessageJobDetail.cs</code>, define a class to represent a scheduled job, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.Background.Models;
public class WriteMessageJobDetail
{
  public string? Message { get; set; }
  public int Seconds { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Background.Hangfire</code> project, add a new class file named <code class="inlineCode">Program.Methods.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.Methods.cs</code>, extend the partial <code class="inlineCode">Program</code> class with a method to write a message to the console in green color, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using static System.Console;
partial class Program
{
  public static void WriteMessage(string? message)
  {
    ConsoleColor previousColor = ForegroundColor;
    ForegroundColor = ConsoleColor.Green;
    WriteLine(message);
    ForegroundColor = previousColor;
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, import namespaces to work with the job, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.Background.Models; // To use WriteMessageJobDetail.
using Microsoft.AspNetCore.Mvc; // To use [FromBody].
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after the statement to map a <code class="inlineCode">GET</code> request, map a <code class="inlineCode">POST</code> request to the relative path <code class="inlineCode">/schedulejob</code>, get the job details from the body of the <code class="inlineCode">POST</code> request, and use it to schedule a background job, using Hangfire to run at the specified<a id="_idIndexMarker1022"/> time in seconds in the future, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.MapPost("/schedulejob", ([FromBody] WriteMessageJobDetail job) =&gt;
  {
    BackgroundJob.Schedule(
      methodCall: () =&gt; WriteMessage(job.Message),
      enqueueAt: DateTimeOffset.UtcNow + 
        TimeSpan.FromSeconds(job.Seconds));
  });
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.Background.Hangfire</code> project without debugging.</li>
      <li class="numberedList">In the command prompt or terminal, confirm that all the dispatchers started, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Hangfire.Server.BackgroundServerProcess[0]
      Server desktop-j1pqhr7:13916:9f1851b5 all the dispatchers started
</code></pre>
      </li>
      <li class="numberedList">In the browser, navigate to <code class="inlineCode">/hangfire </code>to view Hangfire Dashboard.</li>
      <li class="numberedList">In your code editor, in the <code class="inlineCode">HttpRequests</code> folder, create a file named <code class="inlineCode">hangfire-schedule-job.http</code>.</li>
      <li class="numberedList">In <code class="inlineCode">hangfire-schedule-job.http</code>, add statements to make a <code class="inlineCode">POST</code> request to the Hangfire service, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">### Configure a variable for the Hangfire web service base address.
@base_address = https://localhost:5095/
POST {{base_address}}schedulejob
Content-Type: application/json
{
  "message": "Hangfire is awesome!",
  "seconds": 30
}
</code></pre>
      </li>
      <li class="numberedList">Send the request, and<a id="_idIndexMarker1023"/> note the successful response, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">HTTP/1.1 200 OK
Content-Length: 0
Connection: close
Date: Mon, 12 Jun 2023 16:04:20 GMT
Server: Kestrel
Alt-Svc: h3=":5095"; ma=86400
</code></pre>
      </li>
      <li class="numberedList">In the browser, in <strong class="screenText">Hangfire Dashboard</strong>, click <strong class="screenText">Jobs</strong> in the top menu click <strong class="screenText">Jobs</strong>, in the left side menu, and then note there is one scheduled job, as shown in <em class="italic">Figure 9.8</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_09_08.png"/></figure>
    <p class="packt_figref">Figure 9.8: Scheduled jobs in Hangfire</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="14">Wait until 30<a id="_idIndexMarker1024"/> seconds have passed, and then in the left -side menu, click <strong class="screenText">Succeeded</strong>, and note the job has succeeded, as shown in <em class="italic">Figure 9.9</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_09_09.png"/></figure>
    <p class="packt_figref">Figure 9.9: Succeeded jobs in Hangfire</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="15">At the command prompt or terminal, note the message that was written to the console, as<a id="_idIndexMarker1025"/> shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Hangfire is awesome!
</code></pre>
      </li>
      <li class="numberedList">Close the browser and shut down the server.</li>
    </ol>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can<a id="_idIndexMarker1026"/> read more about Hangfire at the following link: <a href="https://www.hangfire.io/">https://www.hangfire.io/</a>.</p>
    </div>
    <h1 class="heading-1" id="_idParaDest-371">Practicing and exploring</h1>
    <p class="normal">Test your knowledge and understanding by answering some questions, getting some hands-on practice, and exploring this chapter’s topics with deeper research.</p>
    <h2 class="heading-2" id="_idParaDest-372">Exercise 9.1 – Test your knowledge</h2>
    <p class="normal">Answer the following questions:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">How much longer does it take to read 1 MB of data from SSD compared to memory?</li>
      <li class="numberedList">What is the difference between absolute and sliding expirations?</li>
      <li class="numberedList">What unit of measurement is used by <code class="inlineCode">Size</code> for the in-memory cache?</li>
      <li class="numberedList">You have written the following statement to get information about in-memory caching but <code class="inlineCode">stats</code> is <code class="inlineCode">null</code>. What must you do to fix this issue?
        <pre class="programlisting code"><code class="hljs-code">MemoryCacheStatistics? stats = _memoryCache.GetCurrentStatistics();
</code></pre>
      </li>
      <li class="numberedList">What data types can be stored in (a) an in-memory cache, and (b) a distributed cache?</li>
      <li class="numberedList">What are the differences between the Retry and Circuit Breaker patterns?</li>
      <li class="numberedList">When using the RabbitMQ default direct exchange, what must the routing key be for a queue named <code class="inlineCode">product</code>?</li>
      <li class="numberedList">What is the difference between a fanout and a topic exchange?</li>
      <li class="numberedList">What port does RabbitMQ listen on by default?</li>
      <li class="numberedList">When inheriting from the <code class="inlineCode">BackgroundService</code> class, what method must you override that is called automatically by the host to run your service?</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-373">Exercise 9.2 – Explore topics</h2>
    <p class="normal">Use the links on the following page to learn more details about the topics covered in this chapter:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-9---caching-queuing-and-resilient-background-services">https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-9---caching-queuing-and-resilient-background-services</a></p>
    <h2 class="heading-2" id="_idParaDest-374">Exercise 9.3 – Replace the Distributed Memory Cache with another distributed cache implementation</h2>
    <p class="normal">In this chapter, we used the Distributed Memory Cache implementation to explore how to use a distributed cache. </p>
    <p class="normal">As an optional exercise, register for an Azure account if you have not already, create an <strong class="screenText">Azure Cache for Redis</strong> resource, and change your web service project configuration to use it.</p>
    <p class="normal">In the <code class="inlineCode">Northwind.WebApi.Service</code>, you will need to reference the Redis package, comment out the previously registered distributed cache implementation, and then call the extension method to register Redis as the distributed cache implementation:</p>
    <pre class="programlisting code"><code class="hljs-code">// builder.Services.AddDistributedMemoryCache();
builder.Services.AddStackExchangeRedisCache(options =&gt;
{
  options.Configuration = builder.Configuration
    .GetConnectionString("MyRedisConStr");
  options.InstanceName = "SampleInstance";
});
</code></pre>
    <p class="normal">Read more at the following links:</p>
    <ul>
      <li class="bulletList">Azure Cache for Redis: <a href="https://azure.microsoft.com/en-us/products/cache/">https://azure.microsoft.com/en-us/products/cache/</a>.</li>
      <li class="bulletList">Redis NuGet package: <a href="https://www.nuget.org/packages/Microsoft.Extensions.Caching.StackExchangeRedis">https://www.nuget.org/packages/Microsoft.Extensions.Caching.StackExchangeRedis</a>.</li>
      <li class="bulletList">Redis with .NET: <a href="https://docs.redis.com/latest/rs/references/client_references/client_csharp">https://docs.redis.com/latest/rs/references/client_references/client_csharp</a>.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-375">Exercise 9.4 – Replace Hangfire with Quartz.NET</h2>
    <p class="normal"><strong class="keyWord">Quartz.NET</strong> is a similar library to Hangfire. Read the official documentation, and then create a project named <code class="inlineCode">Northwind.Background.Quartz</code> that implements the same functionality as <code class="inlineCode">Northwind.Background.Hangfire</code>:</p>
    <p class="normal"><a href="https://www.quartz-scheduler.net/">https://www.quartz-scheduler.net/</a></p>
    <h2 class="heading-2" id="_idParaDest-376">Exercise 9.5 – Review the Reliable Web App pattern</h2>
    <p class="normal">The <strong class="keyWord">Reliable Web App</strong> (<strong class="keyWord">RWA</strong>) pattern is a set of best practices with prescriptive guidance that helps developers successfully migrate an on-premises web project to the cloud. It includes a reference implementation and shows how to make the most of Azure cloud services to modernize mission-critical workloads in a reliable, secure, high-performance, cost-efficient manner using modern design, development, and operational practices:</p>
    <p class="normal"><a href="https://learn.microsoft.com/en-us/azure/architecture/web-apps/guides/reliable-web-app/dotnet/plan-implementation">https://learn.microsoft.com/en-us/azure/architecture/web-apps/guides/reliable-web-app/dotnet/plan-implementation</a></p>
    <p class="normal">A collection of videos about the RWA pattern for .NET are at the following link:</p>
    <p class="normal"><a href="https://www.youtube.com/playlist?list=PLI7iePan8aH54gIDJquV61dE3ENyaDi3Q">https://www.youtube.com/playlist?list=PLI7iePan8aH54gIDJquV61dE3ENyaDi3Q</a></p>
    <h1 class="heading-1" id="_idParaDest-377">Summary</h1>
    <p class="normal">In this chapter, you learned:</p>
    <ul>
      <li class="bulletList">About service architecture and how different parts of a system can affect performance.</li>
      <li class="bulletList">How to cache data closer to the action, using in-memory and distributed caching.</li>
      <li class="bulletList">How to control HTTP caching for clients and intermediaries.</li>
      <li class="bulletList">How to implement fault tolerance using Polly.</li>
      <li class="bulletList">How to implement queuing using RabbitMQ.</li>
      <li class="bulletList">How to implement long-running background services using <code class="inlineCode">BackgroundService</code> and Hangfire.</li>
    </ul>
    <p class="normal">In the next chapter, you will learn how to use Azure Functions to implement nano services, aka serverless services.</p>
    <h1 class="heading-1" id="_idParaDest-378">Learn more on Discord</h1>
    <p class="normal">To join the Discord community for this book – where you can share feedback, ask questions to the author, and learn about new releases – follow the QR code below:</p>
    <p class="normal"><a href="https://packt.link/apps_and_services_dotnet8">https://packt.link/apps_and_services_dotnet8</a></p>
    <p class="normal"><img alt="" src="img/QR_Code3048220001028652625.png"/></p>
  </div>
</body></html>