<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Preparing Xamarin.Android Apps for Distribution</h1></div></div></div><p>In this chapter, we will discuss activities related to preparing a Xamarin.Android app for distribution and look at the various options for distributing apps. Many of the activities we will discuss are an integral part of any Android app deployment. However, in this chapter, we will try to narrow the scope of our coverage to aspects that are unique to developing with Xamarin.Android. We will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">App profiling</li><li class="listitem" style="list-style-type: disc">Android Build settings for distributing apps</li><li class="listitem" style="list-style-type: disc">App distribution options</li></ul></div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec65"/>Preparing for a release APK</h1></div></div></div><p>Prior to publishing a signed APK file for release, there are a number of activities that need to be completed. The following sections discuss topics that should be considered prior to producing a release APK.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec97"/>Profiling Xamarin.Android apps</h2></div></div></div><p>The <a class="indexterm" id="id808"/>Xamarin.Android Business license provides limited support to profile Android apps. Profiling <a class="indexterm" id="id809"/>can be a very effective way to identify memory leaks and process bottlenecks.</p><div><div><h3 class="title"><a id="tip17"/>Tip</h3><p>We will not cover profiling within this book, but the following link provides an overview of using the profiling capabilities of Xamarin.Android: <a class="ulink" href="http://docs.xamarin.com/guides/android/deployment,_testing,_and_metrics/profiling">http://docs.xamarin.com/guides/android/deployment,_testing,_and_metrics/profiling</a>.</p></div></div><p>In addition to using the tools provided with Xamarin.Android, traditional Android profiling tools <a class="indexterm" id="id810"/>such as Traceview and <a class="indexterm" id="id811"/><code class="literal">dmtracedump</code> can be used. You can find more information at <a class="ulink" href="http://developer.android.com/tools/debugging/debugging-tracing.html">http://developer.android.com/tools/debugging/debugging-tracing.html</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec98"/>Disabling debug</h2></div></div></div><p>When <a class="indexterm" id="id812"/>developing a Xamarin.Android app, Xamarin Studio supports debugging with the use of <strong>Java Debug Wire Protocol</strong> (<strong>JDWP</strong>). This feature needs to be disabled in release builds as it poses a security risk. You <a class="indexterm" id="id813"/>have two different ways to accomplish this:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Changing the settings in <code class="literal">AndroidManifest.xml</code></li><li class="listitem" style="list-style-type: disc">Changing the settings in <code class="literal">AssemblyInfo.cs</code></li></ul></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec70"/>Changing the settings in AndroidManifest.xml</h3></div></div></div><p>The first <a class="indexterm" id="id814"/>method can be <a class="indexterm" id="id815"/>done by using the following listing, which shows you how to turn off JDWP debugging from the <code class="literal">AndroidManifest.xml</code> file:</p><div><pre class="programlisting">    &lt;application .. .
        android:debuggable="false" .. .
    &lt;/application&gt;</pre></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec71"/>Changing the settings in AssemblyInfo.cs</h3></div></div></div><p>The <a class="indexterm" id="id816"/>alternative method is done by disabling JDWP through <code class="literal">AssemblyInfo.cs</code>. This has the advantage of being based <a class="indexterm" id="id817"/>on the currently selected configuration. The following listing shows how to use a conditional directive to turn JDWP debugging off:</p><div><pre class="programlisting">    #if RELEASE
    [assembly: Application(Debuggable=false)]
    #else
    [assembly: Application(Debuggable=true)]
    #endif</pre></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec99"/>Android Application (AndroidManifest.xml) settings</h2></div></div></div><p>By <a class="indexterm" id="id818"/>the time you start considering deployment of your app, you will have already established most of the settings needed in <code class="literal">AndroidManifest.xml</code>. However, you will need to update the version information. Keep in mind, the version number is used by the Android <a class="indexterm" id="id819"/>platform during the installation process to determine whether an APK is an update to an existing app. A version name is a free-form text and can be used to track app versions in any manner desired. This can be accomplished by opening the <strong>Project Options</strong> dialog box and navigating to <strong>Build</strong> | <strong>Android Application</strong>, or by double-clicking on <code class="literal">NationalParks/Properties/AndroidManifest.xml</code>. The following screenshot depicts the <strong>Android Application</strong> settings dialog box:</p><div><img alt="Android Application (AndroidManifest.xml) settings" src="img/0838OT_10_01.jpg"/></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec100"/>Linker Options</h2></div></div></div><p>During a <a class="indexterm" id="id820"/>build, Xamarin.Android <a class="indexterm" id="id821"/>performs static analysis of the assemblies that make up an app and attempts to eliminate type and member instances that are not needed. The settings that control this process can be viewed and set in the <strong>Project Options</strong> dialog box under the <strong>Android Build</strong> section, as shown in the following screenshot:</p><div><img alt="Linker Options" src="img/0838OT_10_03.jpg"/></div><p>Xamarin.Android supports the same linker options as Xamarin.iOS. When viewing and adjusting the <strong>Linker Options</strong> settings, be sure to first select <strong>Release</strong> from the <strong>Configuration</strong> drop-down box. The following linking options are available:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Don't link</strong>: This option disables the linker and ensures that all referenced assemblies <a class="indexterm" id="id822"/>are included without modification. This is the default setting for builds that target the iOS Simulator. This eliminates the time-consuming process of linking, and deploying a large file to the simulator is relatively quick.</li><li class="listitem" style="list-style-type: disc"><strong>Link SDK assemblies only</strong>: This option tells the linker to operate only on the SDK <a class="indexterm" id="id823"/>assemblies; those assemblies that ship with Xamarin.iOS. This is the default setting <a class="indexterm" id="id824"/>for builds that target a device.</li><li class="listitem" style="list-style-type: disc"><strong>Link all assemblies</strong>: This <a class="indexterm" id="id825"/>option tells the linker to operate on the entire app, as well as all referenced assemblies. This allows the linker to use a larger set of optimizations and results in the smallest possible application. However, when the linker runs in this mode, there is a greater chance that it might break portions of your code due to false <a class="indexterm" id="id826"/>assumptions made by the static analysis process. In particular, the use of reflection and serialization can trip up the static analysis.</li></ul></div><p>The following table shows how the APK file size varies based on the linker setting:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom"> </th><th style="text-align: left" valign="bottom">
<p>File linking version</p>
</th><th style="text-align: left" valign="bottom">
<p>PCL version</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<strong>Don't link</strong>
</p>
</td><td style="text-align: left" valign="top">
<p>26.4 MB</p>
</td><td style="text-align: left" valign="top">
<p>27.5 MB</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<strong>Link SDK assemblies only</strong>
</p>
</td><td style="text-align: left" valign="top">
<p>4.3 MB</p>
</td><td style="text-align: left" valign="top">
<p>4.3 MB</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<strong>Link all assemblies</strong>
</p>
</td><td style="text-align: left" valign="top">
<p>4.1 MB</p>
</td><td style="text-align: left" valign="top">
<p>4.2 MB</p>
</td></tr></tbody></table></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec72"/>Overriding the linker</h3></div></div></div><p>In some cases, the linking option can have negative side effects, such as important types and/or <a class="indexterm" id="id827"/>members being accidentally eliminated. It is important for an application that has been compiled and linked in release mode to be thoroughly tested before distribution in order to identify such issues. In some situations, you should conduct tests beyond the initial developer's testing, and this should be conducted using an APK file produced in release mode.</p><p>In the event that you encounter any runtime exceptions related to missing types or trouble locating specific methods, you can make use of one of the following methods to give explicit instructions to the linker.</p><div><div><div><div><h4 class="title"><a id="ch10lvl4sec35"/>Preserving code with attributes</h4></div></div></div><p>If you <a class="indexterm" id="id828"/>determine from testing that the linking <a class="indexterm" id="id829"/>is removing classes or methods needed by your app, you can explicitly tell the linker to always include them by using the <code class="literal">Preserve</code> attribute on a class and/or method.</p><p>To preserve the entire type, use the following command:</p><div><pre class="programlisting">[Preserve (AllMembers = true)]</pre></div><p>To preserve a single member, use the following command:</p><div><pre class="programlisting">[Preserve (Conditional=true)]</pre></div></div><div><div><div><div><h4 class="title"><a id="ch10lvl4sec36"/>Preserving code with custom linker files</h4></div></div></div><p>There are <a class="indexterm" id="id830"/>times when you might not have access to the source code, but still need to preserve specific types and/or members. This can be accomplished with a custom linker file. The following example <a class="indexterm" id="id831"/>instructs the linker to always include specific members for a type:</p><div><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;linker&gt;
  &lt;assembly fullname="Mono.Android"&gt;
    &lt;type fullname="Android.Widget.AdapterView"&gt;
      &lt;method name="GetGetAdapterHandler"/&gt;
      &lt;method name="GetSetAdapter_Landroid_widget_Adapter_Handler"/&gt;
    &lt;/type&gt;
  &lt;/assembly&gt;
&lt;/linker&gt;</pre></div><p>You can add a custom-linking file to a project by adding a simple XML file and populating it with similar content to the previous example; it does not really matter where you place it in the project structure. After adding the file to the project, select the file, open the <strong>Properties</strong> pad, and choose <strong>LinkDescription</strong> for <strong>Build action</strong>, as shown in the following screenshot:</p><div><img alt="Preserving code with custom linker files" src="img/0838OT_10_02.jpg"/></div></div><div><div><div><div><h4 class="title"><a id="ch10lvl4sec37"/>Skipping assemblies</h4></div></div></div><p>You can also <a class="indexterm" id="id832"/>instruct the linker to skip entire assemblies so that all the types and members will be retained. This can be accomplished in the following two ways:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using a <a class="indexterm" id="id833"/>command-line option <code class="literal">linkskip</code>, for example, <code class="literal">--linkskip=someassembly</code></li><li class="listitem" style="list-style-type: disc">Using the <code class="literal">AndroidLinkSkip</code> MSBuild property, as follows:<div><pre class="programlisting">&lt;PropertyGroup&gt;
    &lt;AndroidLinkSkip&gt;Assembly1;Assembly2&lt;/AndroidLinkSkip&gt;
&lt;/PropertyGroup&gt;</pre></div></li></ul></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec101"/>Supported ABIs</h2></div></div></div><p>Android <a class="indexterm" id="id834"/>supports a number of different CPU architectures. The Android platform defines a set of <strong>Application Binary Interfaces</strong> (<strong>ABI</strong>) that corresponds to different CPU architectures. By default, Xamarin.Android assumes that armeabi-v7a is appropriate for most circumstances. To support additional architectures, check each option that applies on the <strong>Project Options</strong> <a class="indexterm" id="id835"/>dialog box under the <strong>Android Build</strong> section.</p><div><img alt="Supported ABIs" src="img/0838OT_10_04.jpg"/></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec66"/>Publishing a release APK</h1></div></div></div><p>Now that you <a class="indexterm" id="id836"/>have adjusted the setting needed to produce a release build, you are ready to publish the actual APK. When we say publish, we simply mean to produce an APK that can be uploaded to the Google Play Store. The following sections <a class="indexterm" id="id837"/>discuss the steps of producing a signed APK from within Xamarin Studio.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec102"/>Keystores</h2></div></div></div><p>A keystore is a <a class="indexterm" id="id838"/>database of security certificates created and managed by the keytool program from the Java SDK. You can create the keystore <a class="indexterm" id="id839"/>outside of Xamarin Studio using the keytool command or from within Xamarin Studio that provides a UI that interfaces with the keytool command. The next section takes you through the steps to publish an APK and create a new keystore from within Xamarin Studio.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec103"/>Publishing from Xamarin.Android</h2></div></div></div><p>The following <a class="indexterm" id="id840"/>steps guide <a class="indexterm" id="id841"/>you through the creation of a new keystore as a part of the process of creating a signed APK:</p><div><ol class="orderedlist arabic"><li class="listitem">In the <strong>Configuration</strong> drop-down box, select <strong>Release</strong>.</li><li class="listitem">Navigate to <strong>Project</strong> | <strong>Publish Android Application</strong> from the main menu; note the <strong>Keystore selection</strong> page of the <strong>Publish Android Application</strong> wizard, as shown in the following screenshot:<p> </p><div><img alt="Publishing from Xamarin.Android" src="img/0838OT_10_05.jpg"/></div><p>
</p></li><li class="listitem">Select <strong>Create new keystore</strong>, select a location including a filename for the keystore, and enter the password and confirm it. The example keystore is in the project folder <a class="indexterm" id="id842"/>named <code class="literal">NationalParks.keystore</code> and the password is <code class="literal">nationalparks</code>.</li><li class="listitem">Select <a class="indexterm" id="id843"/><strong>Forward</strong>; you will see the <strong>Key creation</strong> page of the <strong>Publish Android Application</strong> wizard, as shown in the following screenshot:<p> </p><div><img alt="Publishing from Xamarin.Android" src="img/0838OT_10_06.jpg"/></div><p>
</p></li><li class="listitem">Enter <a class="indexterm" id="id844"/>all the relevant information. This example uses <code class="literal">nationalparks</code> for the <strong>Alias</strong> <a class="indexterm" id="id845"/>field and <strong>Password</strong>.</li><li class="listitem">Select <strong>Forward</strong>; you will see the <strong>Select destination</strong> page of the <strong>Publish Android Application</strong> wizard, as shown in the following screenshot:<div><img alt="Publishing from Xamarin.Android" src="img/0838OT_10_07.jpg"/></div></li><li class="listitem">Select the required <strong>Target directory</strong> option and click on <strong>Create</strong>. Xamarin Studio <a class="indexterm" id="id846"/>will compile the app for release and generate a signed APK file. You should see the <a class="indexterm" id="id847"/>following in the <strong>Publishing package</strong> pad:<div><img alt="Publishing from Xamarin.Android" src="img/0838OT_10_08.jpg"/></div></li></ol></div><p>The resulting <a class="indexterm" id="id848"/>APK is ready for final <a class="indexterm" id="id849"/>testing and potential distribution. Be sure to secure and back up your keystore as it is critical to distributing future versions.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec104"/>Republishing from Xamarin.Android</h2></div></div></div><p>Subsequent <a class="indexterm" id="id850"/>publications <a class="indexterm" id="id851"/>of an app should always use the original keystore. To accomplish this, simply select <strong>Use existing keystore</strong> on the <strong>Keystore selection</strong> page of the <strong>Publish Android Application</strong> wizard.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec105"/>Publishing from Visual Studio</h2></div></div></div><p>Publishing a <a class="indexterm" id="id852"/>signed APK from within Visual Studio <a class="indexterm" id="id853"/>essentially follows the same process. To do so, simply navigate to <strong>Tools</strong> | <strong>Publish Android Application</strong> <a class="indexterm" id="id854"/>from the main menu.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec67"/>App distribution options</h1></div></div></div><p>Distributing <a class="indexterm" id="id855"/>Xamarin.Android apps is no different from any other Android app. They can be distributed through all the normal channels, app stores, e-mail attachments, website links, thumb drive, and so on.</p></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec68"/>Summary</h1></div></div></div><p>In this chapter, we have reviewed activities related to preparing for distribution of an app and the process to actually produce a signed release APK file.</p><p>This chapter completes our book on Xamarin Essentials. We have tried to provide a productive approach for experienced mobile developers to quickly come up to speed on developing apps using the Xamarin platform. We have reviewed the Xamarin architecture, developed functional apps for both iOS and Android, and looked at how to maximize Xamarin's value by sharing code across mobile platforms using several different approaches and frameworks. You are now ready to put Xamarin to work.</p><p>I hope you have found this book a useful resource and that it has generated some excitement in you about developing great mobile apps with Xamarin.</p></div></body></html>