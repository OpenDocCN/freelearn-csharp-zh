<html><head></head><body>
  <div id="_idContainer050">
   <h1 class="chapter-number" id="_idParaDest-104">
    <a id="_idTextAnchor132">
    </a>
    <span class="koboSpan" id="kobo.1.1">
     8
    </span>
   </h1>
   <h1 id="_idParaDest-105">
    <a id="_idTextAnchor133">
    </a>
    <span class="koboSpan" id="kobo.2.1">
     Integrating Minimal APIs with Data Sources
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.3.1">
     Despite us working with minimal APIs, an API would have to be even more minimal not to work with an external state, which is not to say that it doesn’t happen.
    </span>
    <span class="koboSpan" id="kobo.3.2">
     For example, an API might be in place to simply perform a calculation or validate data, which, on their own, are not necessarily use cases that require some kind of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.4.1">
      managed data.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.5.1">
     However, it is fair to say that a wide range of production APIs have some element of
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.6.1">
      create, read, update, delete
     </span>
    </strong>
    <span class="koboSpan" id="kobo.7.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.8.1">
      CRUD
     </span>
    </strong>
    <span class="koboSpan" id="kobo.9.1">
     ) functionality.
    </span>
    <span class="koboSpan" id="kobo.9.2">
     In the examples shown in previous chapters, such as the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.10.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.11.1">
     API and the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.12.1">
      Todo Item
     </span>
    </strong>
    <span class="koboSpan" id="kobo.13.1">
     API, we have referred to entities or objects, all
    </span>
    <a id="_idIndexMarker275">
    </a>
    <span class="koboSpan" id="kobo.14.1">
     of which would be potentially created, updated, deleted, or retrieved.
    </span>
    <span class="koboSpan" id="kobo.14.2">
     The examples we explored stored these domain objects in memory, meaning that they would disappear with the application when it is stopped.
    </span>
    <span class="koboSpan" id="kobo.14.3">
     It is now time to move that data into an external data source, where it can be persisted and managed separately from the minimal APIs
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.15.1">
      we write.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.16.1">
     We will explore two fundamental methods of moving data between data sources in this book.
    </span>
    <span class="koboSpan" id="kobo.16.2">
     Firstly, in this chapter, we will explore direct database connections with the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.17.1">
      SqlConnection
     </span>
    </strong>
    <span class="koboSpan" id="kobo.18.1">
     type in addition to MongoDB Driver for SQL and NoSQL database types, respectively.
    </span>
    <span class="koboSpan" id="kobo.18.2">
     The next chapter will cover the second
    </span>
    <a id="_idIndexMarker276">
    </a>
    <span class="koboSpan" id="kobo.19.1">
     method, which is
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.20.1">
      object-relational mapping
     </span>
    </strong>
    <span class="koboSpan" id="kobo.21.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.22.1">
      ORM
     </span>
    </strong>
    <span class="koboSpan" id="kobo.23.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.23.2">
     Each method has its own
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.24.1">
      configuration requirements.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.25.1">
     In this chapter, we’re going to cover the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.26.1">
      main topics:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.27.1">
      Understanding data integration in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.28.1">
       minimal APIs
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.29.1">
      Connecting to SQL Server
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.30.1">
       with
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.31.1">
        SQLConnection
       </span>
      </strong>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.32.1">
      Connecting to a NoSQL database with a
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.33.1">
       MongoDB Driver
      </span>
     </span>
    </li>
   </ul>
   <h1 id="_idParaDest-106">
    <a id="_idTextAnchor134">
    </a>
    <span class="koboSpan" id="kobo.34.1">
     Technical requirements
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.35.1">
     This chapter is quite hands-on, using several different technologies.
    </span>
    <span class="koboSpan" id="kobo.35.2">
     As a result, you will need the following to be installed on
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.36.1">
      your machine:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.37.1">
      Visual
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.38.1">
       Studio 2022
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.39.1">
      Microsoft SQL Server 2022
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.40.1">
       Developer Edition
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.41.1">
      Microsoft SQL Server
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.42.1">
       Management Studio
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.43.1">
      MongoDB
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.44.1">
       Community Server
      </span>
     </span>
    </li>
    <li>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.45.1">
       MongoDB Compass
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.46.1">
     You will need to download and install all of the listed software.
    </span>
    <span class="koboSpan" id="kobo.46.2">
     Installation for all products is wizard-based, so follow each of the wizards until you have
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.47.1">
      them installed.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.48.1">
     You might already have Visual Studio 2022 installed if you have been following along with the code examples in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.49.1">
      previous chapters.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.50.1">
     If you have been using Visual Studio Code, it is recommended that you now switch to Visual
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.51.1">
      Studio 2022.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.52.1">
     Alternatively, you can host your SQL and MongoDB servers on a cloud platform, such as Microsoft Azure or
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.53.1">
      Amazon Web Services
     </span>
    </strong>
    <span class="koboSpan" id="kobo.54.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.55.1">
      AWS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.56.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.56.2">
     Please note that the configuration and deployment of these data sources in the cloud are outside of the scope of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.57.1">
      this book.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.58.1">
     The code for this chapter is available in the GitHub repository
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.59.1">
      at:
     </span>
    </span>
    <a href="https://github.com/PacktPublishing/Minimal-APIs-in-ASP.NET-9">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.60.1">
       https://github.com/PacktPublishing/Minimal-APIs-in-ASP.NET-9
      </span>
     </span>
    </a>
   </p>
   <h1 id="_idParaDest-107">
    <a id="_idTextAnchor135">
    </a>
    <span class="koboSpan" id="kobo.61.1">
     Understanding data integration in minimal APIs
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.62.1">
     In the first chapter, we defined
    </span>
    <a id="_idIndexMarker277">
    </a>
    <span class="koboSpan" id="kobo.63.1">
     APIs and their purpose.
    </span>
    <span class="koboSpan" id="kobo.63.2">
     It is worth reiterating this definition in relation to data sources.
    </span>
    <span class="koboSpan" id="kobo.63.3">
     APIs act as a gateway to a system, offering programmatic access to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.64.1">
      that system.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.65.1">
     In many cases, the objective of a client connecting to a system via an API is to work with data.
    </span>
    <span class="koboSpan" id="kobo.65.2">
     That data has to be stored somewhere – preferably a source separate from the API itself so that it can be externally managed
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.66.1">
      and persistent.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.67.1">
     minimal APIs offer various connection methods to data sources.
    </span>
    <span class="koboSpan" id="kobo.67.2">
     For the purposes of this chapter, we are
    </span>
    <a id="_idIndexMarker278">
    </a>
    <span class="koboSpan" id="kobo.68.1">
     going to focus on the
    </span>
    <a id="_idIndexMarker279">
    </a>
    <span class="koboSpan" id="kobo.69.1">
     most common persistent data storage types, those being
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.70.1">
      SQL
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.71.1">
      and
     </span>
    </span>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.72.1">
       NoSQL
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.73.1">
      .
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.74.1">
     SQL versus NoSQL
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.75.1">
     It’s highly
    </span>
    <a id="_idIndexMarker280">
    </a>
    <span class="koboSpan" id="kobo.76.1">
     likely that as a reader of this book, you are at least somewhat familiar with SQL and
    </span>
    <a id="_idIndexMarker281">
    </a>
    <span class="koboSpan" id="kobo.77.1">
     NoSQL, but by way of a brief primer, SQL databases are relational databases, meaning that data is stored in a collection of tables, with records represented by rows and columns in each table.
    </span>
    <span class="koboSpan" id="kobo.77.2">
     NoSQL is less structured than SQL in that the data can be stored in various formats, including documents, key-value pairs, column families, or graphs.
    </span>
    <span class="koboSpan" id="kobo.77.3">
     Data is stored in these various formats in collections
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.78.1">
      of entities.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.79.1">
     There are many SQL and NoSQL
    </span>
    <a id="_idIndexMarker282">
    </a>
    <span class="koboSpan" id="kobo.80.1">
     products to
    </span>
    <a id="_idIndexMarker283">
    </a>
    <span class="koboSpan" id="kobo.81.1">
     choose from, with
    </span>
    <a id="_idIndexMarker284">
    </a>
    <span class="koboSpan" id="kobo.82.1">
     the mainstream ones outlined in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.83.1">
       Table 8.1
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.84.1">
      :
     </span>
    </span>
   </p>
   <table class="No-Table-Style _idGenTablePara-1" id="table001-2">
    <colgroup>
     <col/>
     <col/>
    </colgroup>
    <tbody>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="bold">
          <span class="koboSpan" id="kobo.85.1">
           Relational Databases
          </span>
         </strong>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <strong class="bold">
          <span class="koboSpan" id="kobo.86.1">
           NoSQL Databases
          </span>
         </strong>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.87.1">
          MySQL
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.88.1">
         Mongo DB (
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.89.1">
          document store)
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.90.1">
          PostgreSQL
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.91.1">
         Cassandra (column
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.92.1">
          family store)
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.93.1">
         Microsoft
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.94.1">
          SQL Server
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.95.1">
         Redis (
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.96.1">
          key-value store)
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.97.1">
          Oracle Database
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.98.1">
         DynamoDB (
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.99.1">
          key-value store)
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.100.1">
          SQLite
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.101.1">
         CouchDB (
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.102.1">
          document store)
         </span>
        </span>
       </p>
      </td>
     </tr>
     <tr class="No-Table-Style">
      <td class="No-Table-Style">
       <p>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.103.1">
          MariaDB
         </span>
        </span>
       </p>
      </td>
      <td class="No-Table-Style">
       <p>
        <span class="koboSpan" id="kobo.104.1">
         Cosmos DB (
        </span>
        <span class="No-Break">
         <span class="koboSpan" id="kobo.105.1">
          multi-model database)
         </span>
        </span>
       </p>
      </td>
     </tr>
    </tbody>
   </table>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.106.1">
     Table 8.1: Examples of mainstream database platforms
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.107.1">
     Regardless
    </span>
    <a id="_idIndexMarker285">
    </a>
    <span class="koboSpan" id="kobo.108.1">
     of whether the data stores are SQL- or NoSQL-based, there are numerous ways that minimal APIs can access them, with different design patterns that can be adopted to ensure the consistency and integrity of the data being managed between the database and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.109.1">
      the API.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.110.1">
     We’re going to start exploring data sources via minimal APIs with a direct connection to a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.111.1">
      SQL database.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.112.1">
     Depending on your use case, the data connection method you choose is really important for optimal performance and security resilience, as is the way you manage connection lifetimes, the way queries are written, and how you pass parameters into commands
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.113.1">
      and queries.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.114.1">
     Direct SQL commands offer a lot of flexibility, as they act in the same way as they would if you had a database IDE open and you were writing queries in them.
    </span>
    <span class="koboSpan" id="kobo.114.2">
     A connection is initiated to a database, a query or command is executed, and then the connection is
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.115.1">
      disposed
     </span>
    </span>
    <span class="No-Break">
     <a id="_idIndexMarker286">
     </a>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.116.1">
      of.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.117.1">
     Let us start by exploring direct connection methods.
    </span>
    <span class="koboSpan" id="kobo.117.2">
     We will continue to use the example of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.118.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.119.1">
     API, first connecting to a Microsoft SQL database, and then connecting to a MongoDB
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.120.1">
      instance (NoSQL).
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-108">
    <a id="_idTextAnchor136">
    </a>
    <span class="koboSpan" id="kobo.121.1">
     Connecting to and integrating with SQL databases
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.122.1">
     We will start with an
    </span>
    <a id="_idIndexMarker287">
    </a>
    <span class="koboSpan" id="kobo.123.1">
     example that uses Microsoft SQL.
    </span>
    <span class="koboSpan" id="kobo.123.2">
     First, open SQL Server Management Studio and create a database called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.124.1">
      MyCompany
     </span>
    </strong>
    <span class="koboSpan" id="kobo.125.1">
     , with one
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.126.1">
      table,
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.127.1">
       Employees
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.128.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.129.1">
     You can use the SQL script in the following code block to create the table with the relevant columns and data types for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.130.1">
      this example:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.131.1">
CREATE TABLE dbo.Employees
    (
    Id int NOT NULL IDENTITY (1, 1),
    Name varchar(MAX) NOT NULL,
    Salary decimal(10, 2) NOT NULL,
    Address varchar(MAX) NOT NULL,
    City varchar(50) NOT NULL,
    Region varchar(50) NOT NULL,
    Country varchar(50) NOT NULL,
    Phone varchar(200) NOT NULL,
    PostalCode varchar(10) NOT NULL
    )</span></pre>
   <p>
    <span class="koboSpan" id="kobo.132.1">
     In the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.133.1">
      Employees
     </span>
    </strong>
    <span class="koboSpan" id="kobo.134.1">
     table, we have set the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.135.1">
      Id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.136.1">
     column as an identity column, meaning that it will be populated by SQL Server on insertion of any record, with the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.137.1">
      Id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.138.1">
     value incrementing by
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.139.1">
      1
     </span>
    </strong>
    <span class="koboSpan" id="kobo.140.1">
     on
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.141.1">
      each insertion.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.142.1">
     We now have
    </span>
    <a id="_idIndexMarker288">
    </a>
    <span class="koboSpan" id="kobo.143.1">
     everything we need to set up a connection to the database from our minimal
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.144.1">
      API project.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.145.1">
     Let us go back into the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.146.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.147.1">
     API and set up the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.148.1">
      database connection.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-109">
    <a id="_idTextAnchor137">
    </a>
    <span class="koboSpan" id="kobo.149.1">
     Configuring the connection to the database and retrieving records
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.150.1">
     SQL databases use a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.151.1">
      connection string
     </span>
    </strong>
    <span class="koboSpan" id="kobo.152.1">
     to
    </span>
    <a id="_idIndexMarker289">
    </a>
    <span class="koboSpan" id="kobo.153.1">
     allow access from a code base.
    </span>
    <span class="koboSpan" id="kobo.153.2">
     In this case, I am using Windows Authentication with my local SQL server, so I can use a simple connection string that assumes the currently logged-in Windows user is able to access my SQL server.
    </span>
    <span class="koboSpan" id="kobo.153.3">
     Alternatively, if you are using a SQL server, you will need to generate a slightly different connection string.
    </span>
    <span class="koboSpan" id="kobo.153.4">
     The simplest way to form the connection string
    </span>
    <a id="_idIndexMarker290">
    </a>
    <span class="koboSpan" id="kobo.154.1">
     is to use the guides for Microsoft SQL servers found at
    </span>
    <a href="https://connectionstrings.com">
     <span class="koboSpan" id="kobo.155.1">
      https://connectionstrings.com
     </span>
    </a>
    <span class="koboSpan" id="kobo.156.1">
     , where (based on your authentication type) you can generate the appropriate string.
    </span>
    <span class="koboSpan" id="kobo.156.2">
     The following code shows some simple examples of connection strings for each
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.157.1">
      authentication type:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.158.1">
//Windows Auth (Trusted Connection)
Server=myServerAddress;
Database=myDataBase;
Trusted_Connection=True;
// SQL Server Authentication
Server=myServerAddress;
Database=myDataBase;
User Id=myUsername;
Password=myPassword;</span></pre>
   <p>
    <span class="koboSpan" id="kobo.159.1">
     Now that we have a
    </span>
    <a id="_idIndexMarker291">
    </a>
    <span class="koboSpan" id="kobo.160.1">
     connection string, we can store it somewhere within the API where it can be easily retrieved.
    </span>
    <span class="koboSpan" id="kobo.160.2">
     A good place to do this would be in a configuration file, which is, by default, offered to us in the form
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.161.1">
      of
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.162.1">
       appsettings.json
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.163.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.164.1">
     Open
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.165.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.166.1">
     and add your connection string as shown (I am using SQL authentication in my JSON example, but you will need to add your Windows Authentication connection string
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.167.1">
      if appropriate):
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.168.1">
{
  "ConnectionStrings": {
      "DefaultConnection":
          "Server=localhost;Database=MyCompany;
          User Id=your_user;Password=your_password;"
  }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.169.1">
     Your
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.170.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.171.1">
     file may
    </span>
    <a id="_idIndexMarker292">
    </a>
    <span class="koboSpan" id="kobo.172.1">
     have extra template values when you create your project.
    </span>
    <span class="koboSpan" id="kobo.172.2">
     For simplicity, when following this example, it might be best to overwrite the content of the existing
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.173.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.174.1">
     file with the example content shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.175.1">
      preceding code.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.176.1">
     Next, we will create a service that will manage the interactions with the database.
    </span>
    <span class="koboSpan" id="kobo.176.2">
     This service will be injected into our API endpoints using dependency injection (see
    </span>
    <a href="B20968_07.xhtml#_idTextAnchor119">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.177.1">
        Chapter 7
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.178.1">
     for more details on
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.179.1">
      dependency injection).
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.180.1">
     We will register the service as
    </span>
    <a id="_idIndexMarker293">
    </a>
    <span class="koboSpan" id="kobo.181.1">
     a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.182.1">
      singleton
     </span>
    </strong>
    <span class="koboSpan" id="kobo.183.1">
     .
    </span>
    <span class="koboSpan" id="kobo.183.2">
     Doing this allows us to cleanly specify that there should only be one instance of the service, meaning that any requests coming into the API will share that service.
    </span>
    <span class="koboSpan" id="kobo.183.3">
     Let us first get started with the creation of this database service by creating a new interface called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.184.1">
      IDatabaseService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.185.1">
     .
    </span>
    <span class="koboSpan" id="kobo.185.2">
     This interface will lay out the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.186.1">
      contract
     </span>
    </strong>
    <span class="koboSpan" id="kobo.187.1">
     for
    </span>
    <a id="_idIndexMarker294">
    </a>
    <span class="koboSpan" id="kobo.188.1">
     any services that are created for the purposes of speaking to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.189.1">
      a database:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.190.1">
public interface IDatabaseService
{
    Task&lt;IEnumerable&lt;Employee&gt;&gt; GetEmployeesAsync();
    Task AddEmployeeAsync(Employee employee);
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.191.1">
     Don’t worry if you see an error at this point stating that
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.192.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.193.1">
     isn’t a known type.
    </span>
    <span class="koboSpan" id="kobo.193.2">
     When it is created later, this error
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.194.1">
      will clear.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.195.1">
     We can now create our service
    </span>
    <a id="_idIndexMarker295">
    </a>
    <span class="koboSpan" id="kobo.196.1">
     in the form of a concrete class that implements
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.197.1">
      IDatabaseService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.198.1">
     .
    </span>
    <span class="koboSpan" id="kobo.198.2">
     Create the class, calling
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.199.1">
      it
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.200.1">
       SQLService
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.201.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.202.1">
     Once the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.203.1">
      SQLService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.204.1">
     class has been created, add a constructor that receives
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.205.1">
      IConfiguration
     </span>
    </strong>
    <span class="koboSpan" id="kobo.206.1">
     as a parameter, saving its value to a local
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.207.1">
       readonly
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.208.1">
      field.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.209.1">
     More on IConfiguration
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.210.1">
      IConfiguration
     </span>
    </strong>
    <span class="koboSpan" id="kobo.211.1">
     is already registered for dependency injection in an ASP.NET application.
    </span>
    <span class="koboSpan" id="kobo.211.2">
     It represents the content
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.212.1">
      of
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.213.1">
       appsettings.json
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.214.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.215.1">
     This field will contain the connection string, and will allow it to be referenced in all queries and commands executed by the service, as
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.216.1">
      shown here:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.217.1">
public class SqlService : IDatabaseService
{
    private readonly string _connectionString;
    public SqlService(IConfiguration configuration)
    {
        _connectionString =
             configuration.GetConnectionString(
                 "DefaultConnection"
             );
    }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.218.1">
     Next, we’re going to finish off this service by adding the ability to add and retrieve employee records from
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.219.1">
      the database.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.220.1">
     We will use the same
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.221.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.222.1">
     class that we added in the examples from previous chapters.
    </span>
    <span class="koboSpan" id="kobo.222.2">
     As a convenient reminder, this code block shows the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.223.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.224.1">
     class that will act as the model for the
    </span>
    <a id="_idIndexMarker296">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.225.1">
      database records:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.226.1">
    public class Employee
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public decimal Salary { get; set; }
        public string Address { get; set; }
        public string City { get; set; }
        public string Region { get; set; }
        public string PostalCode { get; set; }
        public string Country { get; set; }
        public string Phone { get; set; }
    }</span></pre>
   <p>
    <span class="koboSpan" id="kobo.227.1">
     You will be seeing errors by now (in the Visual Studio error list, and in the form of red lines under the code) stating that the class does not fully implement the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.228.1">
      IDatabaseService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.229.1">
     interface.
    </span>
    <span class="koboSpan" id="kobo.229.2">
     We should add the two functions specified in the interface to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.230.1">
      SqlService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.231.1">
     class to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.232.1">
      correct this.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.233.1">
     Let’s start with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.234.1">
      GetEmployeesAsync()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.235.1">
     .
    </span>
    <span class="koboSpan" id="kobo.235.2">
     The aim of this function is to return a list containing all the employees in the database.
    </span>
    <span class="koboSpan" id="kobo.235.3">
     Start by creating the function definition and, in the body, instantiate a new
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.236.1">
       Employee
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.237.1">
      list:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.238.1">
public async Task&lt;IEnumerable&lt;Employee&gt;&gt;
    GetEmployeesAsync()
{
    var employees = new List&lt;Employee&gt;();
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.239.1">
     Before going further, make sure you add the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.240.1">
      Microsoft.Data.SqlClient
     </span>
    </strong>
    <span class="koboSpan" id="kobo.241.1">
     NuGet package, as this will be required.
    </span>
    <span class="koboSpan" id="kobo.241.2">
     You can do this by going to
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.242.1">
      Tools
     </span>
    </strong>
    <span class="koboSpan" id="kobo.243.1">
     |
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.244.1">
      Manage NuGet Packages
     </span>
    </strong>
    <span class="koboSpan" id="kobo.245.1">
     |
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.246.1">
      Package Manager Console
     </span>
    </strong>
    <span class="koboSpan" id="kobo.247.1">
     , and then typing
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.248.1">
      the following:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.249.1">
dotnet add package Microsoft.Data.SqlClient</span></pre>
   <p>
    <span class="koboSpan" id="kobo.250.1">
     Next, we will open a new
    </span>
    <a id="_idIndexMarker297">
    </a>
    <span class="koboSpan" id="kobo.251.1">
     connection to SQL Server using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.252.1">
      SqlConnection
     </span>
    </strong>
    <span class="koboSpan" id="kobo.253.1">
     .
    </span>
    <span class="koboSpan" id="kobo.253.2">
     By wrapping the instance in a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.254.1">
      using
     </span>
    </strong>
    <span class="koboSpan" id="kobo.255.1">
     statement, we are ensuring that once the control flow ha
    </span>
    <a id="_idTextAnchor138">
    </a>
    <span class="koboSpan" id="kobo.256.1">
     s exited the body of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.257.1">
      using
     </span>
    </strong>
    <span class="koboSpan" id="kobo.258.1">
     statement, the connection is automatically disposed of, thanks to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.259.1">
      SqlConnection
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.260.1">
      implementing
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.261.1">
       IDisposable
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.262.1">
      :
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.263.1">
using (var connection = new
    SqlConnection(_connectionString))
{
    await connection.OpenAsync();
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.264.1">
     At this point, you have a connection open that will be automatically disposed of.
    </span>
    <span class="koboSpan" id="kobo.264.2">
     This is good because we’re responsibly managing the use of an
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.265.1">
      external resource.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.266.1">
     Next, inside the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.267.1">
      using
     </span>
    </strong>
    <span class="koboSpan" id="kobo.268.1">
     statement, another
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.269.1">
      using
     </span>
    </strong>
    <span class="koboSpan" id="kobo.270.1">
     statement is added, but this time, for the creation of a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.271.1">
      SqlCommand
     </span>
    </strong>
    <span class="koboSpan" id="kobo.272.1">
     object.
    </span>
    <span class="koboSpan" id="kobo.272.2">
     This
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.273.1">
      SqlCommand
     </span>
    </strong>
    <span class="koboSpan" id="kobo.274.1">
     object represents the query we wish to execute, targeting the connection we now
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.275.1">
      have open:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.276.1">
using (var command = new
    SqlCommand("SELECT * FROM Employees", connection))
{
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.277.1">
     Following this, we nest another
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.278.1">
      using
     </span>
    </strong>
    <span class="koboSpan" id="kobo.279.1">
     statement inside this one.
    </span>
    <span class="koboSpan" id="kobo.279.2">
     This creates
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.280.1">
      SqlDataReader
     </span>
    </strong>
    <span class="koboSpan" id="kobo.281.1">
     , reading
    </span>
    <a id="_idIndexMarker298">
    </a>
    <span class="koboSpan" id="kobo.282.1">
     any returned rows from the query in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.283.1">
      SqlCommand
     </span>
    </strong>
    <span class="koboSpan" id="kobo.284.1">
     , creating a new
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.285.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.286.1">
     instance for each record, and adding it to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.287.1">
      the list:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.288.1">
using (var reader = await command.ExecuteReaderAsync())
{
    while (await reader.ReadAsync())
    {
        var employee = new Employee
        {
            Id = reader.GetInt32(0),
            Name = reader.GetString(1),
            Salary = reader.GetDecimal(2),
            Address = reader.GetString(3),
            City = reader.GetString(4),
            Region = reader.GetString(5),
            PostalCode = reader.GetString(6),
            Country = reader.GetString(7),
            Phone = reader.GetString(8)
        };
        employees.Add(employee);
    }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.289.1">
     Finally, we can finish the function by returning the list of type
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.290.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.291.1">
     , meaning the finished function looks like
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.292.1">
      the following:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.293.1">
public async Task&lt;IEnumerable&lt;Employee&gt;&gt;
    GetEmployeesAsync()
{
    var employees = new List&lt;Employee&gt;();
    using (var connection = new
        SqlConnection(_connectionString))
    {
        await connection.OpenAsync();
        using (var command = new SqlCommand(
            "SELECT * FROM Employees", connection))
        {
            using (var reader = await
                command.ExecuteReaderAsync())
            {
                while (await reader.ReadAsync())
                {
                    var employee = new Employee
                    {
                        Id = reader.GetInt32(0),
                        Name = reader.GetString(1),
                        Salary = reader.GetDecimal(2),
                        Address = reader.GetString(3),
                        City = reader.GetString(4),
                        Region = reader.GetString(5),
                        PostalCode = reader.GetString(6),
                        Country = reader.GetString(7),
                        Phone = reader.GetString(8)
                    };
                    employees.Add(employee);
                }
            }
        }
    }
    return employees;
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.294.1">
     Take a look
    </span>
    <a id="_idIndexMarker299">
    </a>
    <span class="koboSpan" id="kobo.295.1">
     at the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.296.1">
      SqlCommand
     </span>
    </strong>
    <span class="koboSpan" id="kobo.297.1">
     usage in the previous code.
    </span>
    <span class="koboSpan" id="kobo.297.2">
     Notice how we don’t build the SQL command string using concatenation, passing in the values from
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.298.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.299.1">
     as part of the string being put together.
    </span>
    <span class="koboSpan" id="kobo.299.2">
     Instead, the best practice is to use SQL parameters.
    </span>
    <span class="koboSpan" id="kobo.299.3">
     Parameterized queries allow us to guard against a security vulnerability called
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.300.1">
      SQL injection.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.301.1">
     In a SQL injection attack, a malicious value is passed in as a value, which can alter the originally intended behavior of a command.
    </span>
    <span class="koboSpan" id="kobo.301.2">
     By passing in parameters, we avoid this, with parameters represented by the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.302.1">
      @
     </span>
    </strong>
    <span class="koboSpan" id="kobo.303.1">
     character in the command string and added to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.304.1">
      SqlCommand
     </span>
    </strong>
    <span class="koboSpan" id="kobo.305.1">
     after the string is formed (we see this in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.306.1">
      next section).
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-110">
    <a id="_idTextAnchor139">
    </a>
    <span class="koboSpan" id="kobo.307.1">
     Inserting Employee records
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.308.1">
     We have now
    </span>
    <a id="_idIndexMarker300">
    </a>
    <span class="koboSpan" id="kobo.309.1">
     completed our first connection to SQL with a transaction.
    </span>
    <span class="koboSpan" id="kobo.309.2">
     Armed with this knowledge, we can also create the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.310.1">
      AddEmployeeAsync()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.311.1">
     function.
    </span>
    <span class="koboSpan" id="kobo.311.2">
     The connection method is the same but the command is different, with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.312.1">
      INSERT
     </span>
    </strong>
    <span class="koboSpan" id="kobo.313.1">
     being used instead
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.314.1">
      of
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.315.1">
       SELECT
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.316.1">
      :
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.317.1">
public async Task AddEmployeeAsync(Employee employee)
{
    using (var connection = new
        SqlConnection(_connectionString))
    {
        await connection.OpenAsync();
        using (var command = new SqlCommand(
            "INSERT INTO Employees (Name, Salary, " +
            Address, City, Region, Country, Phone, " +
            PostalCode) VALUES (@Name, @Salary, " +
            @Address, @City, @Region, @Country, " +
            @Phone, @PostalCode)", " +
            connection))
        {
            command.Parameters.AddWithValue(
                "@Name", employee.Name);
            command.Parameters.AddWithValue(
                "@Salary", employee.Salary);
            command.Parameters.AddWithValue(
                "@Address", employee.Address);
            command.Parameters.AddWithValue(
                "@City", employee.City);
            command.Parameters.AddWithValue(
                "@Region", employee.Region);
            command.Parameters.AddWithValue(
                "@Country", employee.Country);
            command.Parameters.AddWithValue(
                "@Phone", employee.Phone);
            command.Parameters.AddWithValue(
                "@PostalCode", employee.PostalCode);
            await command.ExecuteNonQueryAsync();
        }
    }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.318.1">
     Let us now turn our attention to the minimal
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.319.1">
      API endpoints.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-111">
    <a id="_idTextAnchor140">
    </a>
    <span class="koboSpan" id="kobo.320.1">
     Executing database transactions from API endpoints
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.321.1">
     These endpoints will need to have
    </span>
    <a id="_idIndexMarker301">
    </a>
    <span class="koboSpan" id="kobo.322.1">
     the SQL service
    </span>
    <a id="_idIndexMarker302">
    </a>
    <span class="koboSpan" id="kobo.323.1">
     injected into them in order for them to be used in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.324.1">
      endpoint body.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.325.1">
     Go back to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.326.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.327.1">
     and register the service as
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.328.1">
      a singleton:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.329.1">
var builder = WebApplication.CreateBuilder(args);
builder.Services.AddSingleton&lt;IDatabaseService,
SqlLService&gt;(); var app = builder.Build();</span></pre>
   <p>
    <span class="koboSpan" id="kobo.330.1">
     Because we have created a service for managing interaction with the SQL server and we have made it easily available through dependency injection, getting and creating employees from minimal API endpoints is very easy.
    </span>
    <span class="koboSpan" id="kobo.330.2">
     Simply add a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.331.1">
      GET
     </span>
    </strong>
    <span class="koboSpan" id="kobo.332.1">
     endpoint for retrieval and a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.333.1">
      POST
     </span>
    </strong>
    <span class="koboSpan" id="kobo.334.1">
     endpoint for creation, adding calls to the appropriate functions we created
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.335.1">
      in
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.336.1">
       SqlService
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.337.1">
      :
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.338.1">
app.MapGet(
    "/employees",
    async (IDatabaseService dbService) =&gt;
{
    var employees = await dbService.GetEmployeesAsync();
    return Results.Ok(employees);
});
app.MapPost(
    "/employees",
    async (IDatabaseService dbService,
           Employee employee) =&gt;
{
    await dbService.AddEmployeeAsync(employee);
    return Results.Created(
        $"/employees/{employee.Id}", employee);
});</span></pre>
   <p>
    <span class="koboSpan" id="kobo.339.1">
     Give the new
    </span>
    <a id="_idIndexMarker303">
    </a>
    <span class="koboSpan" id="kobo.340.1">
     endpoints a try.
    </span>
    <span class="koboSpan" id="kobo.340.2">
     If successful, you
    </span>
    <a id="_idIndexMarker304">
    </a>
    <span class="koboSpan" id="kobo.341.1">
     should be able to retrieve the employees in the data source as a list or add new employees via
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.342.1">
      the API.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.343.1">
     As alluded to earlier in the chapter, because we have created an interface, we should be able to swap out the service for one that uses a different data source without having to change the endpoint.
    </span>
    <span class="koboSpan" id="kobo.343.2">
     This leads us nicely to an example of a database connection to a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.344.1">
      NoSQL database.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-112">
    <a id="_idTextAnchor141">
    </a>
    <span class="koboSpan" id="kobo.345.1">
     Connecting to MongoDB
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.346.1">
     For demonstrative purposes, we will connect
    </span>
    <a id="_idIndexMarker305">
    </a>
    <span class="koboSpan" id="kobo.347.1">
     to
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.348.1">
      MongoDB
     </span>
    </strong>
    <span class="koboSpan" id="kobo.349.1">
     , a widely used NoSQL
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.350.1">
      database platform.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.351.1">
     Before we create the service, we should first add some data to a MongoDB database.
    </span>
    <span class="koboSpan" id="kobo.351.2">
     As per the technical requirements, you
    </span>
    <a id="_idIndexMarker306">
    </a>
    <span class="koboSpan" id="kobo.352.1">
     should have installed a MongoDB server, along with
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.353.1">
      MongoDB Compass
     </span>
    </strong>
    <span class="koboSpan" id="kobo.354.1">
     , a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.355.1">
      graphical user interface
     </span>
    </strong>
    <span class="koboSpan" id="kobo.356.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.357.1">
      GUI
     </span>
    </strong>
    <span class="koboSpan" id="kobo.358.1">
     )
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.359.1">
      for
     </span>
    </span>
    <span class="No-Break">
     <a id="_idIndexMarker307">
     </a>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.360.1">
      MongoDB.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.361.1">
     Start by opening
    </span>
    <a id="_idIndexMarker308">
    </a>
    <span class="koboSpan" id="kobo.362.1">
     MongoDB Compass and creating a connection to your installed MongoDB server instance.
    </span>
    <span class="koboSpan" id="kobo.362.2">
     If you’ve installed MongoDB locally without modifying the installation, you should be able to just
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.363.1">
      click
     </span>
    </span>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.364.1">
       Connect
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.365.1">
      :
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer046">
     <span class="koboSpan" id="kobo.366.1">
      <img alt="Figure 8.1: Creating a new MongoDB connection" src="image/B20968_08_01.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.367.1">
     Figure 8.1: Creating a new MongoDB connection
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.368.1">
     Once connected, you
    </span>
    <a id="_idIndexMarker309">
    </a>
    <span class="koboSpan" id="kobo.369.1">
     will be able to see the existing databases on
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.370.1">
      your server:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer047">
     <span class="koboSpan" id="kobo.371.1">
      <img alt="Figure 8.2: View of existing MongoDB connections" src="image/B20968_08_02.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.372.1">
     Figure 8.2: View of existing MongoDB connections
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.373.1">
     In the navigation
    </span>
    <a id="_idIndexMarker310">
    </a>
    <span class="koboSpan" id="kobo.374.1">
     bar on the left-hand side, click the plus icon to add a new database.
    </span>
    <span class="koboSpan" id="kobo.374.2">
     Once again, we will call the database
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.375.1">
      MyCompany
     </span>
    </strong>
    <span class="koboSpan" id="kobo.376.1">
     .
    </span>
    <span class="koboSpan" id="kobo.376.2">
     Compass will also require you to create a collection.
    </span>
    <span class="koboSpan" id="kobo.376.3">
     Just as we created an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.377.1">
      Employees
     </span>
    </strong>
    <span class="koboSpan" id="kobo.378.1">
     table in our SQL database, we will create an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.379.1">
      Employees
     </span>
    </strong>
    <span class="koboSpan" id="kobo.380.1">
     collection
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.381.1">
      in MongoDB:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer048">
     <span class="koboSpan" id="kobo.382.1">
      <img alt="Figure 8.3: MongoDB Database creation in Compass" src="image/B20968_08_03.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.383.1">
     Figure 8.3: MongoDB Database creation in Compass
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.384.1">
     Notice how we haven’t
    </span>
    <a id="_idIndexMarker311">
    </a>
    <span class="koboSpan" id="kobo.385.1">
     been specified a schema for the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.386.1">
      Employees
     </span>
    </strong>
    <span class="koboSpan" id="kobo.387.1">
     collection.
    </span>
    <span class="koboSpan" id="kobo.387.2">
     This is because the collection is document-based.
    </span>
    <span class="koboSpan" id="kobo.387.3">
     We can import data in JSON format, which mirrors the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.388.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.389.1">
     class in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.390.1">
      our API.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.391.1">
     Create a couple of fake employees and save them to a local JSON file.
    </span>
    <span class="koboSpan" id="kobo.391.2">
     Here is some example JSON to get
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.392.1">
      you started:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.393.1">
[
    {
        "Id": 1,
        "Name": "John Doe",
        "Salary": 55000.75,
        "Address": "123 Elm Street",
        "City": "Springfield",
        "Region": "IL",
        "PostalCode": "62701",
        "Country": "USA",
        "Phone": "555-1234"
    },
    {
        "Id": 2,
        "Name": "Jane Smith",
        "Salary": 62000.50,
        "Address": "456 Oak Avenue",
        "City": "Metropolis",
        "Region": "NY",
        "PostalCode": "10001",
        "Country": "USA",
        "Phone": "555-5678"
    }
]</span></pre>
   <p>
    <span class="koboSpan" id="kobo.394.1">
     Once you’ve saved the
    </span>
    <a id="_idIndexMarker312">
    </a>
    <span class="koboSpan" id="kobo.395.1">
     JSON file, you can import it into the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.396.1">
      Employees
     </span>
    </strong>
    <span class="koboSpan" id="kobo.397.1">
     collection in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.398.1">
      MongoDB Compass:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer049">
     <span class="koboSpan" id="kobo.399.1">
      <img alt="Figure 8.4: Importing data into a MongoDB database in Compass" src="image/B20968_08_04.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.400.1">
     Figure 8.4: Importing data into a MongoDB database in Compass
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.401.1">
     Our MongoDB collection is now set up with example data.
    </span>
    <span class="koboSpan" id="kobo.401.2">
     Let us turn our attention back to the minimal API, where we will write a new service to interact with this
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.402.1">
      NoSQL database.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.403.1">
     First, we’ll need to
    </span>
    <a id="_idIndexMarker313">
    </a>
    <span class="koboSpan" id="kobo.404.1">
     install the MongoDB driver in order to support interactions with a MongoDB database.
    </span>
    <span class="koboSpan" id="kobo.404.2">
     You can do this via the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.405.1">
      Package Manager Console
     </span>
    </strong>
    <span class="koboSpan" id="kobo.406.1">
     in
    </span>
    <a id="_idIndexMarker314">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.407.1">
      Visual Studio:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.408.1">
dotnet add package MongoDB.Driver</span></pre>
   <p>
    <span class="koboSpan" id="kobo.409.1">
     Create a new class called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.410.1">
      MongoDbService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.411.1">
     , implementing the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.412.1">
      IDatabaseService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.413.1">
     interface.
    </span>
    <span class="koboSpan" id="kobo.413.2">
     Make sure you reference
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.414.1">
      MongoDB.Bson
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.415.1">
      and
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.416.1">
       MongoDB.Driver
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.417.1">
      :
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.418.1">
using MongoDB.Bson;
using MongoDB.Driver;
using System.Collections.Generic;
using System.Threading.Tasks;
public class MongoDbService : IDatabaseService
{
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.419.1">
     Next, we will create a constructor that, as before, receives an injected
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.420.1">
      IConfiguration
     </span>
    </strong>
    <span class="koboSpan" id="kobo.421.1">
     object containing the database connection string, before initiating the connection with an instance
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.422.1">
      of
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.423.1">
       MongoClient
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.424.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.425.1">
     Following this, a reference
    </span>
    <a id="_idIndexMarker315">
    </a>
    <span class="koboSpan" id="kobo.426.1">
     to the collection of type,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.427.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.428.1">
     can be retrieved and stored in a
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.429.1">
       private
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.430.1">
      field:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.431.1">
private readonly IMongoCollection&lt;Employee&gt;
    _employeesCollection;
    public MongoDbService(IConfiguration configuration)
    {
        var connectionString =
            configuration.GetConnectionString(
                "MongoDbConnection");
        var mongoClient = new
            MongoClient(connectionString);
        var mongoDatabase =
            mongoClient.GetDatabase("MyCompany");
        _employeesCollection =
            mongoDatabase.GetCollection&lt;Employee&gt;(
                "Employees");
    }</span></pre>
   <p>
    <span class="koboSpan" id="kobo.432.1">
     Next, complete the implementation of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.433.1">
      IDatabaseService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.434.1">
     interface by adding the required functions.
    </span>
    <span class="koboSpan" id="kobo.434.2">
     These functions can simply utilize the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.435.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.436.1">
     collection for querying and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.437.1">
      inserting records:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.438.1">
public async Task&lt;IEnumerable&lt;Employee&gt;&gt;
    GetEmployeesAsync()
    {
        return await _employeesCollection
            .Find(new BsonDocument())
            .ToListAsync();
    }
    public async Task AddEmployeeAsync(Employee employee)
    {
        await _employeesCollection
            .InsertOneAsync(employee);
    }</span></pre>
   <p>
    <span class="koboSpan" id="kobo.439.1">
     The connection string
    </span>
    <a id="_idIndexMarker316">
    </a>
    <span class="koboSpan" id="kobo.440.1">
     needs to be changed to point to the MongoDB server and database.
    </span>
    <span class="koboSpan" id="kobo.440.2">
     MongoDB connection strings are fairly simple in format.
    </span>
    <span class="koboSpan" id="kobo.440.3">
     By default, the server should be running on port
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.441.1">
      27017
     </span>
    </strong>
    <span class="koboSpan" id="kobo.442.1">
     .
    </span>
    <span class="koboSpan" id="kobo.442.2">
     Here is how a default connection string would look for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.443.1">
      this configuration:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.444.1">
mongodb://localhost:27017/MyCompany</span></pre>
   <p>
    <span class="koboSpan" id="kobo.445.1">
     This connection string can then be added to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.446.1">
      ConnectionStrings
     </span>
    </strong>
    <span class="koboSpan" id="kobo.447.1">
     object in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.448.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.449.1">
     .
    </span>
    <span class="koboSpan" id="kobo.449.2">
     We should also add a Boolean flag to the JSON that allows us to specify whether MongoDB should be used, or whether the default SQL connection should
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.450.1">
      be adopted.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.451.1">
     Once complete, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.452.1">
      ConnectionStrings
     </span>
    </strong>
    <span class="koboSpan" id="kobo.453.1">
     section of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.454.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.455.1">
     should look like the example
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.456.1">
      shown here:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.457.1">
"UseMongoDB": true,
"ConnectionStrings": {
    "DefaultConnection":
        "Server=.\\SQLEXPRESS;Database=MyCompany;
        Trusted_Connection=True;
        TrustServerCertificate=True;",
    "MongoDbConnection":
        "mongodb://localhost:27017/MyCompany"
  }</span></pre>
   <p>
    <span class="koboSpan" id="kobo.458.1">
     Having added a new data source connection string and an option to switch from the default source to MongoDB, we must register the new
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.459.1">
      MongoDbService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.460.1">
     class for dependency injection.
    </span>
    <span class="koboSpan" id="kobo.460.2">
     We will, however, also need to specify a new rule for how the dependency is resolved depending on whether the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.461.1">
      UseMongoDB
     </span>
    </strong>
    <span class="koboSpan" id="kobo.462.1">
     flag is enabled
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.463.1">
      or not.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.464.1">
     Back in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.465.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.466.1">
     , register the new
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.467.1">
       MongoDbService
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.468.1">
      class
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.469.1">
builder.Services.AddSingleton&lt;MongoDbService&gt;();</span></pre>
   <p>
    <span class="koboSpan" id="kobo.470.1">
     Next, add the following singleton
    </span>
    <a id="_idIndexMarker317">
    </a>
    <span class="koboSpan" id="kobo.471.1">
     registration for
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.472.1">
      IDatabaseService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.473.1">
     , along with logic that checks the MongoDB flag in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.474.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.475.1">
     before resolving the correct database service to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.476.1">
      be used:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.477.1">
builder.Services.AddSingleton&lt;IDatabaseService&gt;(sp =&gt;
{
    var config = sp.GetRequiredService&lt;IConfiguration&gt;();
    var useMongoDB = config.GetValue&lt;bool&gt;("UseMongoDB");
    if (useMongoDB)
    {
        return sp.GetRequiredService&lt;MongoDbService&gt;();
    }
    else
    {
        return sp.GetRequiredService&lt;SqlService&gt;();
    }
});</span></pre>
   <p>
    <span class="koboSpan" id="kobo.478.1">
     You might not have realized it yet if you haven’t run the code, but we have
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.479.1">
      a problem.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.480.1">
     The aim of using an interface for
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.481.1">
      IDatabaseService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.482.1">
     was to ensure that we could easily switch between data sources by modifying a Boolean flag
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.483.1">
      in
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.484.1">
       appsettings.json
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.485.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.486.1">
     This would be fine if the data
    </span>
    <a id="_idIndexMarker318">
    </a>
    <span class="koboSpan" id="kobo.487.1">
     structures in the two data sources had identical schemas.
    </span>
    <span class="koboSpan" id="kobo.487.2">
     Unfortunately, they don’t because, in SQL Server,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.488.1">
      Id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.489.1">
     is an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.490.1">
      int
     </span>
    </strong>
    <span class="koboSpan" id="kobo.491.1">
     type, whereas, in MongoDB, the equivilent identifier is called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.492.1">
      _id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.493.1">
     and its data type is
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.494.1">
      a string.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.495.1">
     This means that as it exists currently,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.496.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.497.1">
     is interchangeable between the two sources.
    </span>
    <span class="koboSpan" id="kobo.497.2">
     This means that if we switch to MongoDB and try to deserialize data to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.498.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.499.1">
     , it will fail with
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.500.1">
      FormatException
     </span>
    </strong>
    <span class="koboSpan" id="kobo.501.1">
     due to the differing
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.502.1">
      data type.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.503.1">
     To fix this, we should create separate models for different data sources.
    </span>
    <span class="koboSpan" id="kobo.503.2">
     This sounds like it goes against the idea of having a flexible system, but we can still ensure that we don’t have to modify existing endpoints for different data sources by using
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.504.1">
      another interface.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.505.1">
     Create a new interface called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.506.1">
      IEmployee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.507.1">
     .
    </span>
    <span class="koboSpan" id="kobo.507.2">
     It does not require any fields at
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.508.1">
      the moment:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.509.1">
public interface IEmployee
{
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.510.1">
     We can use this interface to represent an employee model generically, regardless of whether it is a SQL Server model or a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.511.1">
      MongoDB model.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.512.1">
     Create a new model called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.513.1">
      EmployeeMongoDb
     </span>
    </strong>
    <span class="koboSpan" id="kobo.514.1">
     and set it up as
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.515.1">
      shown here:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.516.1">
using MongoDB.Bson;
using MongoDB.Bson.Serialization.Attributes;
{
    public class EmployeeMongoDb : IEmployee
    {
        [BsonId]
        [BsonRepresentation(
            MongoDB.Bson.BsonType.ObjectId)]
        public string Id { get; set; }
        public string Name { get; set; }
        public decimal Salary { get; set; }
        public string Address { get; set; }
        public string City { get; set; }
        public string Region { get; set; }
        public string PostalCode { get; set; }
        public string Country { get; set; }
        public string Phone { get; set; }
    }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.517.1">
     By adding the attributes shown
    </span>
    <a id="_idIndexMarker319">
    </a>
    <span class="koboSpan" id="kobo.518.1">
     in the previous code to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.519.1">
      Id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.520.1">
     field, we are mapping
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.521.1">
      Id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.522.1">
     to the string-based
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.523.1">
      _id
     </span>
    </strong>
    <span class="koboSpan" id="kobo.524.1">
     field in the MongoDB collection.
    </span>
    <span class="koboSpan" id="kobo.524.2">
     We have also
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.525.1">
      implemented
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.526.1">
       IEmployee
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.527.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.528.1">
     We will treat
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.529.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.530.1">
     as the default model, seeing as SQL Server is the default connection string in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.531.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.532.1">
     .
    </span>
    <span class="koboSpan" id="kobo.532.2">
     Ensure that it also
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.533.1">
      implements
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.534.1">
       IEmployee
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.535.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.536.1">
     Now, we must change any area in the MongoDB service or SQL service that returns a concrete class to instead return
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.537.1">
      IEmployee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.538.1">
     .
    </span>
    <span class="koboSpan" id="kobo.538.2">
     You’ll also need to change any code that receives
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.539.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.540.1">
     as an argument.
    </span>
    <span class="koboSpan" id="kobo.540.2">
     This then requires the service to cast
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.541.1">
      IEmployee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.542.1">
     to a compatible concrete implementation, such as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.543.1">
      EmployeeMongoDb
     </span>
    </strong>
    <span class="koboSpan" id="kobo.544.1">
     for the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.545.1">
       MongoDb
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.546.1">
      service.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.547.1">
     Changes to both
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.548.1">
      SqlServerService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.549.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.550.1">
      MongoDbService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.551.1">
     can be seen in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.552.1">
      following code:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.553.1">
private readonly IMongoCollection&lt;EmployeeMongoDb&gt;
    _employeesCollection;
public MongoDbService(IConfiguration configuration)
{
    var connectionString =
        configuration.GetConnectionString(
            "MongoDbConnection");
    var mongoClient = new MongoClient(connectionString);
    var mongoDatabase =
        mongoClient.GetDatabase("MyCompany");
    _employeesCollection =
        mongoDatabase.GetCollection&lt;EmployeeMongoDb&gt;(
            "Employees");
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.554.1">
     Continuing the previous code, we
    </span>
    <a id="_idIndexMarker320">
    </a>
    <span class="koboSpan" id="kobo.555.1">
     add the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.556.1">
      GetEmployeesAsync()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.557.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.558.1">
      AddEmployeeAsync()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.559.1">
     methods using MongoDB.
    </span>
    <span class="koboSpan" id="kobo.559.2">
     Notice how, in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.560.1">
      AddEmployeeAsync()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.561.1">
     method, we can still take in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.562.1">
      IEmployee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.563.1">
     but then simply convert it to an
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.564.1">
      EmployeeMongoDb
     </span>
    </strong>
    <span class="koboSpan" id="kobo.565.1">
     object so that MongoDB can take care of generating a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.566.1">
      string
     </span>
    </strong>
    <span class="koboSpan" id="kobo.567.1">
     ID, unlike the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.568.1">
      int
     </span>
    </strong>
    <span class="koboSpan" id="kobo.569.1">
     ID used in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.570.1">
      SQL Server:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.571.1">
public async Task&lt;IEnumerable&lt;IEmployee&gt;&gt;
    GetEmployeesAsync()
{
    var result = await _employeesCollection
        .Find(new BsonDocument())
        .ToListAsync();
    return result;
}
public async Task AddEmployeeAsync(IEmployee employee)
{
    var employeeToAdd = new EmployeeMongoDb
{
    Name = employee.Name,
    Salary = employee.Salary,
    Address = employee.Address,
    City = employee.City,
    Region = employee.Region,
    PostalCode = employee.PostalCode,
    Country = employee.Country,
    Phone = employee.Phone
};
    await _employeesCollection
        .InsertOneAsync(employeeToAdd);
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.572.1">
     The following method
    </span>
    <a id="_idIndexMarker321">
    </a>
    <span class="koboSpan" id="kobo.573.1">
     shows the same code using
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.574.1">
      SQL Server:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.575.1">
// GetEmployeesAsync only needs the return type to be
// changed
public async Task&lt;IEnumerable&lt;IEmployee&gt;&gt;
    GetEmployeesAsync()
public async Task AddEmployeeAsync(IEmployee employee)
{
    var employeeToAdd = (Employee)employee;
    using (var connection = new
        SqlConnection(_connectionString))
    {
        await connection.OpenAsync();
        using (var command = new SqlCommand(
            "INSERT INTO Employees (Name, Salary, " +
            Address, City, Region, Country, Phone, " +
            PostalCode) VALUES (@Name, @Salary, " +
            @Address, @City, @Region, @Country, " +
            @Phone, @PostalCode)", " +
            connection))
        {
            command.Parameters.AddWithValue(
                "@Name", employeeToAdd.Name);
            command.Parameters.AddWithValue(
                "@Salary", employeeToAdd.Salary);
            command.Parameters.AddWithValue(
                "@Address", employeeToAdd.Address);
            command.Parameters.AddWithValue(
                "@City", employeeToAdd.City);
            command.Parameters.AddWithValue(
                "@Region", employeeToAdd.Region);
            command.Parameters.AddWithValue(
                "@Country", employeeToAdd.Country);
            command.Parameters.AddWithValue(
                "@Phone", employeeToAdd.Phone);
            command.Parameters.AddWithValue(
                "@PostalCode", employeeToAdd.PostalCode);
            await command.ExecuteNonQueryAsync();
        }
    }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.576.1">
     Because
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.577.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.578.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.579.1">
      EmployeeMongoDb
     </span>
    </strong>
    <span class="koboSpan" id="kobo.580.1">
     both implement
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.581.1">
      IEmployee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.582.1">
     , the endpoint logic no longer has to change.
    </span>
    <span class="koboSpan" id="kobo.582.2">
     We are preserving genericness at the highest level of abstraction, while dealing with more concrete classes lower down the abstraction layer within
    </span>
    <a id="_idIndexMarker322">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.583.1">
      the services.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.584.1">
     Open-closed principle
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.585.1">
     The changes we have made using interfaces help us adhere to the open-closed principle, where we aim to allow new data sources to be added in the future without having to alter the original code base invasively.
    </span>
    <span class="koboSpan" id="kobo.585.2">
     We will discuss this principle in more detail in
    </span>
    <a href="B20968_13.xhtml#_idTextAnchor183">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.586.1">
        Chapter 13
       </span>
      </em>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.587.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.588.1">
     This was quite an intense chapter, so let’s review what we’ve covered before
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.589.1">
      moving on.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-113">
    <a id="_idTextAnchor142">
    </a>
    <span class="koboSpan" id="kobo.590.1">
     Summary
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.591.1">
     In this chapter, we have covered some basic examples of direct communication with a database from minimal
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.592.1">
      API endpoints.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.593.1">
     We started by defining the different kinds of databases, with examples of various SQL- and NoSQL-based
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.594.1">
      database platforms.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.595.1">
     Following this, we talked about how using services with dependency injection can allow minimal API projects to seamlessly provide minimal API endpoints with interoperability with our chosen
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.596.1">
      data source.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.597.1">
     We created a service that interacts with a SQL Server database, using
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.598.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.599.1">
     to define the specific properties of our data source for use in the service.
    </span>
    <span class="koboSpan" id="kobo.599.2">
     We leveraged the functionality of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.600.1">
      SqlConnection
     </span>
    </strong>
    <span class="koboSpan" id="kobo.601.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.602.1">
      SqlCommand
     </span>
    </strong>
    <span class="koboSpan" id="kobo.603.1">
     to execute commands and queries against the SQL Server database containing relational
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.604.1">
      employee data.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.605.1">
     Next, we created a counterpart service that interacts with MongoDB, demonstrating the differences between
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.606.1">
      SqlCommand
     </span>
    </strong>
    <span class="koboSpan" id="kobo.607.1">
     and the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.608.1">
      MongoDB driver.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.609.1">
     Finally, we modified the project using interfaces to make differing data source models interchangeable, while preserving the generic style of the API
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.610.1">
      endpoint code.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.611.1">
     In the next chapter, we will take our exploration of data sources further by implementing two ORMs within the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.612.1">
      Employee
     </span>
    </strong>
    <span class="koboSpan" id="kobo.613.1">
     API – Dapper and Entity
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.614.1">
      Framework Core.
     </span>
    </span>
   </p>
  </div>
 </body></html>