<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Tracking and Troubleshooting"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Tracking and Troubleshooting</h1></div></div></div><p>In the last few chapters, we looked at the artifacts used in building a BizTalk Services solution. By now, you must be wondering how to track the message flow or, still better, how to troubleshoot if things didn't go as expected. In this chapter, we will look at the tools and common patterns to troubleshoot issues in BizTalk Services.</p><p>Specifically, we will focus on troubleshooting the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Sources and destinations</li><li class="listitem" style="list-style-type: disc">Schemas and transforms</li><li class="listitem" style="list-style-type: disc">EAI bridges with custom code</li><li class="listitem" style="list-style-type: disc">B2B agreements</li><li class="listitem" style="list-style-type: disc">Hybrid connectivity</li></ul></div><div class="section" title="Messages and errors"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec59"/>Messages and errors</h1></div></div></div><p>First, let's quickly summarize the basics. Bridges are message channels that don't persist messages. This means any failure in the message processing will be returned as an HTTP error to the caller in the case of EAI bridges, and the message will be pushed to the suspend endpoint in the case of B2B bridges. The suspend endpoint is important in the case of B2B as the error in configuration or message structure cannot be sent back to the business partner, but is meant for consumption by the IT operator. This means in both EAI and B2B scenarios, all retries and resubmissions of messages post failures have to be done outside the bridge.</p><p>Errors can occur in any of the following three scenarios:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Errors during deployment time</strong></span>: This scenario includes all the errors associated <a id="id401" class="indexterm"/>with provisioning of the BizTalk Service <a id="id402" class="indexterm"/>deployment. In most cases, the error is self-explanatory and is shown in the Windows Azure Management Portal or sent back via the RDFE API. It is important to note that a BizTalk Service deployment name is unique. Custom domain merely serves to wrap a DNS name around the BizTalk Service deployment URL. The certificate of the domain needs to be uploaded in the Trusted Root Certification Authorities certificate store on the machine accessing the deployment. The storage<a id="id403" class="indexterm"/> and the Azure SQL<a id="id404" class="indexterm"/> Database used for tracking and archiving cannot be reused or deleted while the deployment is active.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Errors during design time</strong></span>: This <a id="id405" class="indexterm"/>scenario includes all<a id="id406" class="indexterm"/> the errors during adding/updating/deleting a bridge, deploying a VS project, or adding/updating/deleting an agreement from the BizTalk Services Portal. These errors surface in the <span class="strong"><strong>Output</strong></span> window or the <span class="strong"><strong>Error List</strong></span> window in Visual Studio for the EAI scenarios and in the status bar of the BizTalk Services Portal for the B2B scenarios, respectively.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Errors during runtime</strong></span>: This scenario includes all the errors during the actual <a id="id407" class="indexterm"/>flow<a id="id408" class="indexterm"/> of messages between two applications or partners. This scenario can be further broken down into four subcategories:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Errors when the message is sent to an endpoint external to BizTalk Services is faulty.</li><li class="listitem" style="list-style-type: disc">Errors when the message is expected to be received from an endpoint external to BizTalk Services is faulty.</li><li class="listitem" style="list-style-type: disc">Errors when the message is malformed and does not conform to the schemas configured in the bridge.</li><li class="listitem" style="list-style-type: disc">Errors when components such as the bridge, transform, source, or hybrid destination in BizTalk Services do not function as expected. This usually classifies a bug in the product.</li></ul></div></li></ul></div><p>We will focus on runtime errors and the first three subcategories in particular. If tracking is enabled, tracking records are logged in the Windows Azure SQL Database. Tracking enables us to store interesting properties related to the message—from the header, body, or through lookup from another data source. Archiving persists the message data in a raw form in the case of EDI scenarios. For the EAI scenarios, archiving is possible by adding custom code as outlined in <a class="link" href="ch04.html" title="Chapter 4. Enterprise Application Integration">Chapter 4</a>, <span class="emphasis"><em>Enterprise Application Integration</em></span>. Data written into the Tracking and Archiving stores is carried out on a <span class="emphasis"><em>best effort</em></span> basis, that is, if there is an error during the write operation to these stores, tracking and archiving will be skipped and message processing will continue in the bridge. The exception to this case is when the archiving of the AS2 messages is enabled with the <span class="strong"><strong>Enable NRR</strong></span> option turned on in the AS2 agreement <span class="strong"><strong>General Settings</strong></span> page. In these cases, the message processing fails if tracking/archiving cannot be completed successfully.</p></div></div>
<div class="section" title="Data for troubleshooting"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec60"/>Data for troubleshooting</h1></div></div></div><p>In this section, we'll explore the different kinds of data available to troubleshoot issues.</p><div class="section" title="Tracking"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec45"/>Tracking</h2></div></div></div><p>Every <a id="id409" class="indexterm"/>message that flows through the bridge is associated <a id="id410" class="indexterm"/>with a promoted property known as the <span class="strong"><strong>Request ID</strong></span>, which is a GUID value on each incoming message. If the message is split into submessages, each submessage gets its own tracking ID, which is also a GUID. If the Request ID is the same as the tracking ID, the message flows without debatching. The bridge endpoint URI and timestamp should point to the bridge and timing of the message. Tracking can be enabled from the bridge properties in VS and from an agreement's <span class="strong"><strong>General Settings</strong></span> page in the BizTalk Services Portal.</p><p>The BizTalk Services Portal exposes the tracking data in a user-friendly way. There are three tabs that reflect the messages processed in the deployment. They are explained as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>MESSAGES</strong></span>: This tab contains all the messages from sources, bridges, and agreements with errors or information-type entries. Each tracking entry details the message's incoming URL, its Request ID and tracking ID, whether the processing was an error or a success, the stage where the track record was emitted, and the date and time when it occurred. Use this view for tracking all the EAI and B2B messages passing through bridges and agreements.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>PROTOCOL</strong></span>: This tab lists the track records for B2B interactions. The view is also categorized into the EDI and AS2 protocol levels. EDI calls out a message status for X12 and EDIFACT records with sender, receiver, message type (such as PO), acknowledgments such as technical acknowledgment and functional acknowledgment, Request ID, ID of the interchanged envelope to correlate with the track records of batching, and the date and time when this record was written. The AS2 records contain similar information, except that the acknowledgment reflects the <span class="strong"><strong>Message Disposition Notification</strong></span> (<span class="strong"><strong>MDN</strong></span>)<a id="id411" class="indexterm"/> status. Use this view to track all the B2B protocol stage-specific tracking entries.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>BATCHING</strong></span>: Finally, the <span class="strong"><strong>BATCHING</strong></span> tab tracks the list of ongoing and completed batches along with the individual message information. The view tracks the batch name, the agreement for which the batch is configured, and the sender and receiver of the batching transaction. The entry also shows the size, count, and time when the transaction was received using which the customer can relate to the expected release criteria of the batch. Use this view to track all the messages in a batch.</li></ul></div><p>Each of the tabs also has a <span class="strong"><strong>Search</strong></span> option, which can help filter the result by date range, message type, status, sender, or receiver.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>Without searching for any option, the search option displays all the track records sorted by the latest date. This can also be used to refresh the page during testing.</p></div></div><p>The<a id="id412" class="indexterm"/> <span class="strong"><strong>Tracking</strong></span> view is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7401EN_07_01.jpg" alt="Tracking"/><div class="caption"><p> Tracking view in the BizTalk Services Portal</p></div></div><p>In some<a id="id413" class="indexterm"/> cases, it is required that you access the data directly from the Azure SQL Database tables. A common use case might be to build a notification system based on tracking events. The Azure SQL Database tracking tables used in tracking are as follows (note that none of these tables are supported or documented from Microsoft for issuing direct T-SQL queries):</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Table</p>
</th><th style="text-align: left" valign="bottom">
<p>Data</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>[dbo].[PipelineTrackRecords]</p>
</td><td style="text-align: left" valign="top">
<p>Bridges tracking records</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>[dbo].[SourceTrackRecords]</p>
</td><td style="text-align: left" valign="top">
<p>Sources tracking records</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>[dbo].[EndpointAddressMap]</p>
</td><td style="text-align: left" valign="top">
<p>Stores<a id="id414" class="indexterm"/> the URL of a bridge or a source and maps<a id="id415" class="indexterm"/> the address to the Pipeline and Source track records using a foreign key reference, EndpointAddressID</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>[dbo].[TrackRecordMessageProperties]</p>
</td><td style="text-align: left" valign="top">
<p>Name and value pair of promoted properties of the message</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>[dbo].AS2*, [dbo].Batch*, [dbo].Functional*, [dbo].Interchange*, [dbo].TransactionSet* records</p>
</td><td style="text-align: left" valign="top">
<p>EDI tracking records for AS2, MDN, batching, Interchange, Group, Transaction set records, and functional or technical acknowledgments</p>
</td></tr></tbody></table></div></div><div class="section" title="Traces and logfiles"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec46"/>Traces and logfiles</h2></div></div></div><p>Besides<a id="id416" class="indexterm"/> tracking, trace statements are also recorded in the Azure <a id="id417" class="indexterm"/>tables as a message flows through a bridge. Traces are useful to look for <a id="id418" class="indexterm"/>exceptions when the time period of the message failure<a id="id419" class="indexterm"/> is known. The information from tracing can supplement the tracking information from the BizTalk Services Portal. These traces are similar to the <span class="strong"><strong>Event Trace Log</strong></span> (<span class="strong"><strong>ETL</strong></span>) traces, except that the<a id="id420" class="indexterm"/> BizTalk Services traces are text based and stored in the Azure tables.</p><p>For each deployment, traces are logged on the Azure table named <span class="strong"><strong>WADLogsTable</strong></span> created in the storage account specified while provisioning the BizTalk Services deployment. You can use a tool such as <span class="strong"><strong>Azure Storage Explorer</strong></span> from <a class="ulink" href="http://azurestorageexplorer.codeplex.com">azurestorageexplorer.codeplex.com</a> or one of the commercial tools such as CloudBerry to connect to that Azure storage account and view the data in the table.</p><p>The following three fields<a id="id421" class="indexterm"/> in WADLogsTable are interesting:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Timestamp</strong></span>: The date and time when the traces were logged.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Message</strong></span>: Information, exception, or error message with a component or activity information.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Level</strong></span>: Trace level varying among Fatal (1), Errors (2), Warnings (3), and Informational (4). The errors in level 2 are accompanied by the exception stack trace.</li></ul></div><p>Traces are extremely useful when troubleshooting custom code configured with bridges. As there can be hundreds of entries in a few minutes, you can filter the data in the table using one of the following commands in the <span class="strong"><strong>Azure Storage Explorer</strong></span> tool:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Timestamp gt datetime'2013-12-07T16:00:00'</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">Level = 2</code></li></ul></div><p>Note that the spacing as well as the casing is important in filtering the data.</p><p>In the case <a id="id422" class="indexterm"/>of the BizTalk Adapter Service, logfiles can be <a id="id423" class="indexterm"/>written<a id="id424" class="indexterm"/> by adding log interceptors<a id="id425" class="indexterm"/> in the service <code class="literal">.config</code> file. To troubleshoot the hybrid connectivity runtime, edit <code class="literal">web.config</code> in <code class="literal">C:\Program Files\Microsoft BizTalk Adapter Service\BAServiceRuntime</code>. The exact entries that must be added to generate logfiles are outlined in the <span class="emphasis"><em>Troubleshooting hybrid connectivity</em></span> section.</p></div><div class="section" title="Performance counters"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec47"/>Performance counters</h2></div></div></div><p>You <a id="id426" class="indexterm"/>can use performance counters to<a id="id427" class="indexterm"/> assess the health of the system. Performance counters pertaining to the BizTalk Services deployment are stored in the storage account of the deployment and can be viewed from the Azure Management Portal's <span class="strong"><strong>MONITOR</strong></span> tab as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7401EN_07_02.jpg" alt="Performance counters"/><div class="caption"><p>Performance counters in monitoring view of Azure Management Portal</p></div></div><p>The following<a id="id428" class="indexterm"/> performance counters are available for each deployment:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Performance counter name</p>
</th><th style="text-align: left" valign="bottom">
<p>Unit</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>CPU Usage</strong></span></p>
</td><td style="text-align: left" valign="top">
<p>%</p>
</td><td style="text-align: left" valign="top">
<p>Average CPU usage of all instances servicing the runtime messages</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>Failures at Source</strong></span></p>
</td><td style="text-align: left" valign="top">
<p>count</p>
</td><td style="text-align: left" valign="top">
<p>Count of messages that failed in the sources</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>Failures in Process</strong></span></p>
</td><td style="text-align: left" valign="top">
<p>count</p>
</td><td style="text-align: left" valign="top">
<p>Count of messages that failed during pipeline processing</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>Messages in Process</strong></span></p>
</td><td style="text-align: left" valign="top">
<p>count</p>
</td><td style="text-align: left" valign="top">
<p>Count of messages currently in process by the deployment</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>Messages Processed</strong></span></p>
</td><td style="text-align: left" valign="top">
<p>count</p>
</td><td style="text-align: left" valign="top">
<p>Count of messages successfully processed by the deployment</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>Messages Received</strong></span></p>
</td><td style="text-align: left" valign="top">
<p>count</p>
</td><td style="text-align: left" valign="top">
<p>Count of messages received by the pipelines</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>Messages Sent</strong></span></p>
</td><td style="text-align: left" valign="top">
<p>count</p>
</td><td style="text-align: left" valign="top">
<p>Count of messages sent or routed from each pipeline</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>Processing Latency</strong></span></p>
</td><td style="text-align: left" valign="top">
<p>milliseconds</p>
</td><td style="text-align: left" valign="top">
<p>Average time taken <a id="id429" class="indexterm"/>to process a message from the validate stage to route for one-way bridges</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><span class="strong"><strong>Round Trip Latency</strong></span></p>
</td><td style="text-align: left" valign="top">
<p>milliseconds</p>
</td><td style="text-align: left" valign="top">
<p>Average time taken to process a message round trip in two-way bridges</p>
</td></tr></tbody></table></div><p>These<a id="id430" class="indexterm"/> counters can be useful to make configuration <a id="id431" class="indexterm"/>changes to the deployment. For example, if <span class="strong"><strong>Messages Received</strong></span> is trending higher and this correlates with an increase in <span class="strong"><strong>Failures in Process</strong></span> and a corresponding increase in <span class="strong"><strong>Processing Latency</strong></span>, then the system may not be scaling up with the incoming rate. The IT administrator could plan scaling the deployment and look for changes in the performance counters.</p></div></div>
<div class="section" title="Troubleshooting sources and destinations"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec61"/>Troubleshooting sources and destinations</h1></div></div></div><p>Sources<a id="id432" class="indexterm"/> can be one of the following: HTTP, FTP(s), SFTP, or Service <a id="id433" class="indexterm"/>Bus Queue and Topic. If the source endpoint is HTTP, it is common to see HTTP error codes on the client side sending the message, as shown in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Error scenario</p>
</th><th style="text-align: left" valign="bottom">
<p>HTTP error code</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Message to a nonexistent endpoint or wrong URL</p>
</td><td style="text-align: left" valign="top">
<p>400, 500</p>
</td><td style="text-align: left" valign="top">
<p>Bad Request, Internal Server Error, or Namespace cannot be resolved</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Endpoint with malformed message headers</p>
</td><td style="text-align: left" valign="top">
<p>401</p>
</td><td style="text-align: left" valign="top">
<p>Authentication failed or Unauthorized request</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Endpoint with malformed message body</p>
</td><td style="text-align: left" valign="top">
<p>500</p>
</td><td style="text-align: left" valign="top">
<p>Internal Server Error; see tracking or trace entries for more information</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Destination endpoint down</p>
</td><td style="text-align: left" valign="top">
<p>500</p>
</td><td style="text-align: left" valign="top">
<p>Internal Server Error</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Destination with incorrect credentials</p>
</td><td style="text-align: left" valign="top">
<p>500</p>
</td><td style="text-align: left" valign="top">
<p>Internal Server Error</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Bridge destination is configured for HTTP relay but receiver is listening on HTTPS</p>
</td><td style="text-align: left" valign="top">
<p>500</p>
</td><td style="text-align: left" valign="top">
<p>Internal Server Error</p>
</td></tr></tbody></table></div><p>In the <a id="id434" class="indexterm"/>case of FTP as source, if there are errors during the processing <a id="id435" class="indexterm"/>or at the destination, the message will not be deleted from the source. The polling interval would increase and the system would autoretry the submission of the message.</p><p>The following screenshots show the increase in the <span class="strong"><strong>NewPollInterval</strong></span> field as seen in the <span class="strong"><strong>PORTAL TRACKING</strong></span> view for the source name, <span class="strong"><strong>Poll Error</strong></span>. Note that the poll interval increases by 1.5 times the current poll value for each new iteration. The next set of poll intervals would be around 227, 341, 512, and 768 seconds.</p><div class="mediaobject"><img src="graphics/7401EN_07_03.jpg" alt="Troubleshooting sources and destinations"/><div class="caption"><p>Tracking entries indicating exponential poll over an FTP source</p></div></div><p>Some <a id="id436" class="indexterm"/>error scenarios while using FTP are as shown in the<a id="id437" class="indexterm"/> following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Error scenario</p>
</th><th style="text-align: left" valign="bottom">
<p>HTTP error code</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Wrong FTP URL or incorrect username or password</p>
</td><td style="text-align: left" valign="top">
<p>503</p>
</td><td style="text-align: left" valign="top">
<p>Failed to connect to FTP server and/or not logged in</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Redeploy FTP while the existing service is active</p>
</td><td style="text-align: left" valign="top">
<p>400</p>
</td><td style="text-align: left" valign="top">
<p>One or more resources are in the started state; you can stop the source using <code class="literal">PSCmdlet</code></p>
</td></tr></tbody></table></div><p>You can fix the issue based on the error message and use <code class="literal">PSCmdlet</code> <code class="literal">Stop-AzureBizTalkBridgeSource</code> and <code class="literal">Start-AzureBizTalkBridgeSource</code> to stop and start the source respectively. The following screenshot shows the execution of <code class="literal">Get-AzureBizTalkBridgeSource</code> to check the status of a source endpoint:</p><div class="mediaobject"><img src="graphics/7401EN_07_04.jpg" alt="Troubleshooting sources and destinations"/><div class="caption"><p>Getting source status using PSCmdlet</p></div></div></div>
<div class="section" title="Troubleshooting schemas and transforms"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec62"/>Troubleshooting schemas and transforms</h1></div></div></div><p>Issues in schemas <a id="id438" class="indexterm"/>surface when a message fails validation<a id="id439" class="indexterm"/> against a schema. If the validation fails, say due to extra tags, then a tracking record is added for the XML validation stage, thus reporting an error.</p><p>If the tracking entry indicates a schema validation error, the easiest way to test the schema is to generate a test message. For EAI/B2B schemas, Visual Studio provides a handy utility to generate an instance of the schema. After the schema is added to the project, right-click on the schema and choose <span class="strong"><strong>Generate Instance</strong></span> of the file. From the <span class="strong"><strong>Properties</strong></span> window of the schema, you can generate an instance in native (for flat file) or the XML format, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7401EN_07_05.jpg" alt="Troubleshooting schemas and transforms"/><div class="caption"><p>Generating an instance of a schema from Visual Studio</p></div></div><p>Similar to<a id="id440" class="indexterm"/> schemas, transforms can generate erroneous output due to<a id="id441" class="indexterm"/> incorrect mapping, or one of the functoids can fault against a particular input. Transforms also support testing with sample data in Visual Studio. Maps can be tested by right-clicking on the map and choosing <span class="strong"><strong>Test Map</strong></span>, as shown in the following screenshot. Any errors during testing are indicated as transform runtime exceptions in the VS <span class="strong"><strong>Error List</strong></span> window. If there are no errors, the output from the transform is indicated in the <span class="strong"><strong>Output</strong></span> tab. If there are errors after the map is deployed during runtime, error tracking records with <code class="literal">xmlTransform</code> can be seen in the <span class="strong"><strong>Tracking</strong></span> view.</p><div class="mediaobject"><img src="graphics/7401EN_07_06.jpg" alt="Troubleshooting schemas and transforms"/><div class="caption"><p>Test Map functionality from Visual Studio</p></div></div></div>
<div class="section" title="Troubleshooting bridges"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec63"/>Troubleshooting bridges</h1></div></div></div><p>Earlier, we<a id="id442" class="indexterm"/> saw how to troubleshoot two stages of bridges, namely the schema validation stage and the transform stage. While using custom code inside a bridge, things can get difficult if the message processing runs into errors. It is recommended that you use <code class="literal">IMessageInspectorContext.Tracer</code> to log the <code class="literal">System.Diagnostics.TraceEventType</code> error as part of the custom code. These statements would be surfaced in the WADLogsTable mentioned earlier.</p></div>
<div class="section" title="Troubleshooting agreements"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec64"/>Troubleshooting agreements</h1></div></div></div><p>Agreements<a id="id443" class="indexterm"/> can either be a transport-level agreement, such as AS2, or a protocol-level agreement, such as X12 or EDIFACT. In B2B scenarios with X12 and EDIFACT agreements, it can happen that the transport status returned to the client sending the message is an HTTP 200 OK, but the message landed in the suspend endpoint. This can happen if there are protocol-level errors. Such errors would be indicated by the acknowledgment message.</p><p>Some sample scenarios are shown in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Configuration</p>
</th><th style="text-align: left" valign="bottom">
<p>Scenario</p>
</th><th style="text-align: left" valign="bottom">
<p>Outcome</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>AS2 standalone receive with sync MDN</p>
</td><td style="text-align: left" valign="top">
<p>Incorrect configuration, for example, certificate incorrect</p>
</td><td style="text-align: left" valign="top">
<p>HTTP 400 with error MDN</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>AS2 standalone receive with async MDN</p>
</td><td style="text-align: left" valign="top">
<p>Incorrect configuration, for example, certificate incorrect</p>
</td><td style="text-align: left" valign="top">
<p>HTTP 200 OK for async and MDN with error</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>AS2 standalone send</p>
</td><td style="text-align: left" valign="top">
<p>Incorrect configuration, for example, certificate incorrect</p>
</td><td style="text-align: left" valign="top">
<p>HTTP 500, AS2 Message Sender Activity error</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>X12 or <a id="id444" class="indexterm"/>EDIFACT standalone receive</p>
</td><td style="text-align: left" valign="top">
<p>Identities mismatch in the incoming message</p>
</td><td style="text-align: left" valign="top">
<p>HTTP 200 for a client may indicate success, but see the <span class="strong"><strong>Tracking</strong></span> view if the message has ended up in the suspend destination with the error, NACK, to be sent back if configured</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>X12 or EDIFACT standalone send</p>
</td><td style="text-align: left" valign="top">
<p>Schema not found</p>
</td><td style="text-align: left" valign="top">
<p>HTTP 200 for a client may indicate success, but see the <span class="strong"><strong>Tracking</strong></span> view if the message has ended up in the suspend destination with the error, NACK, to be sent back if configured</p>
</td></tr></tbody></table></div></div>
<div class="section" title="Troubleshooting hybrid connectivity"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec65"/>Troubleshooting hybrid connectivity</h1></div></div></div><p>Finally, we <a id="id445" class="indexterm"/>wrap up our discussion by looking at troubleshooting hybrid connectivity. Primarily, this involves looking at the BizTalk Adapter Service, which was introduced in <a class="link" href="ch04.html" title="Chapter 4. Enterprise Application Integration">Chapter 4</a>, <span class="emphasis"><em>Enterprise Application Integration</em></span>.</p><p>To troubleshoot the hybrid connectivity runtime, add the following snippet to <code class="literal">web.config</code> in <code class="literal">C:\Program Files\Microsoft BizTalk Adapter Service\BAServiceRuntime</code> with administrator access:</p><div class="informalexample"><pre class="programlisting">&lt;system.diagnostics&gt;
  &lt;sources&gt;
    &lt;source name= "Microsoft.ApplicationServer.Integration.BAService.Runtime" switchValue="All"&gt;
&lt;!-- Use Critical, Error, Warning, Verbose, All, Information to adjust the log level --&gt;
      &lt;listeners&gt;
        &lt;add name="BAServiceRuntimeTrace" /&gt;
      &lt;/listeners&gt;
    &lt;/source&gt;
  &lt;/sources&gt;
  &lt;trace autoflush="true" /&gt;
    &lt;sharedListeners&gt;
      &lt;add name="BAServiceRuntimeTrace" type= "System.Diagnostics.XmlWriterTraceListener" initializeData= "C:\logs\RuntimeTraceFile.xml" /&gt;
    &lt;/sharedListeners&gt;
&lt;/system.diagnostics&gt;
...
&lt;system.serviceModel&gt;
...
  &lt;diagnostics&gt;
    &lt;messageLogging
      logEntireMessage="true"
      logMalformedMessages="true"
      logMessagesAtServiceLevel="true"
      logMessagesAtTransportLevel="true"
      maxMessagesToLog="3000"
      maxSizeOfMessageToLog="2000"/&gt;
  &lt;/diagnostics&gt;
&lt;/system.serviceModel&gt;
&lt;/configuration&gt;</pre></div><p>The listener <a id="id446" class="indexterm"/>configures the traces to be output to an XML file in the user's folder specified in the configuration. Post messaging, we can look at the trace log file to check for errors with the Line of Business access or service configuration issues.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec66"/>Summary</h1></div></div></div><p>In this chapter, we have looked at the ways to collect data to troubleshoot BizTalk Services. This helps in maintaining the health of the service. We also looked at the error scenarios of the key components in BizTalk Services and ways to troubleshoot them.</p><p>Troubleshooting is as much an art as it is a science and usually involves a methodical approach to identify and fix a problem. In the next and final chapter, we will look at migration and also capabilities that could be added in the Integration platform.</p></div></body></html>