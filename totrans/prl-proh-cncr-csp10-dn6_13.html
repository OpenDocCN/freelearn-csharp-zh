<html><head></head><body>
<div><div><h1 id="_idParaDest-159"><em class="italic"><a id="_idTextAnchor158"/>Chapter 10</em>: Debugging Multithreaded Applications with Visual Studio</h1>
<p>Visual Studio 2022 is the latest version of Visual Studio on Mac and Windows. In this chapter, we are going to learn how to leverage the power of Visual Studio when debugging multithreaded .NET applications. </p>
<p>Visual Studio provides several extremely useful tools for developers who need to debug parallel and concurrent .NET applications. This chapter will explore the tools in detail through concrete examples.</p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Introducing multithreaded debugging</li>
<li>Debugging threads and processes</li>
<li>Switching and flagging threads</li>
<li>Debugging a parallel application</li>
</ul>
<p>By the end of this chapter, you will have the tools and knowledge you need to debug threading issues in your parallel and concurrent C# code.</p>
<h1 id="_idParaDest-160"><a id="_idTextAnchor159"/>Technical requirements</h1>
<p>To follow along with the examples in this chapter, the following software is recommended for Windows developers:</p>
<ul>
<li>Visual Studio 2022 version 17.2 or later</li>
<li>.NET 6</li>
<li>To complete any WinForms or WPF samples, you will need to install the .NET desktop development workload for Visual Studio. These projects will run only on Windows.</li>
</ul>
<p>All the code examples for this chapter can be found on GitHub at <a href="https://github.com/PacktPublishing/Parallel-Programming-and-Concurrency-with-C-sharp-10-and-.NET-6/tree/main/chapter10">https://github.com/PacktPublishing/Parallel-Programming-and-Concurrency-with-C-sharp-10-and-.NET-6/tree/main/chapter10</a>.</p>
<p class="callout-heading">Note</p>
<p class="callout">The concepts and tools in this chapter only work with Visual Studio on Windows. If you are building .NET applications on a Mac, the <strong class="bold">Rider</strong> IDE from JetBrains provides several tools for multithreaded debugging – a <strong class="bold">Threads</strong> pane, a <strong class="bold">Frames</strong> view to view frames on a selected thread, and a <strong class="bold">Parallel Stacks</strong> pane. Visual Studio for Mac doesn’t have this kind of support for debugging multithreaded applications yet. You can read more about JetBrains Rider’s multithreaded debugging in their documentation: https://www.jetbrains.com/help/rider/Debugging_Multithreaded_Applications.xhtml. Debugging on a Mac is beyond the scope of this chapter.</p>
<p>Let’s get started by learning some basics of multithreaded debugging with Visual Studio 2022.</p>
<h1 id="_idParaDest-161"><a id="_idTextAnchor160"/>Introducing multithreaded debugging</h1>
<p>Debugging is a<a id="_idIndexMarker518"/> key component of every .NET developer’s skillset. Nobody ever writes bug-free code and introducing multithreaded constructs to your project <a id="_idIndexMarker519"/>only increases the chances of introducing bugs. As .NET and C# have added more support for parallel programming and concurrency, Visual Studio has added more debugging features to support those constructs.</p>
<p>Today, Visual Studio <a id="_idIndexMarker520"/>provides the following multithreaded <a id="_idIndexMarker521"/>debugging features for the modern .NET developer:</p>
<ul>
<li><strong class="bold">Threads</strong>: This window shows a list of the threads that are used by your application while debugging. It also indicates which thread is active when it stopped at a breakpoint in your code.</li>
<li><strong class="bold">Parallel Stacks</strong>: This window allows developers to visualize the call stacks for each thread in their application in a single view. Selecting a thread in the window will display call stack information for the selected thread in the <strong class="bold">Call Stack</strong> window.</li>
<li><strong class="bold">Parallel Watch</strong>: This window works like the <strong class="bold">Watch</strong> window, except that you can see the value of a watch expression on each active thread in the application.</li>
<li><strong class="bold">Debug Location</strong>: This toolbar allows you to narrow your focus while debugging multithreaded applications. It has fields to select a <strong class="bold">Process</strong>, <strong class="bold">Thread</strong>, and <strong class="bold">Stack Frame</strong>. There are also buttons on the toolbar so that you can <strong class="bold">Flag</strong> and <strong class="bold">Unflag</strong> threads to be monitored.</li>
<li><strong class="bold">Tasks</strong>: This<a id="_idIndexMarker522"/> window displays each running task in the application and provides information about the thread that is running the task, the state of the task, and its call stack. You can also see the starting point for each task (the method or delegate that was passed to the task to be run).</li>
<li><strong class="bold">Attach to Process</strong>: This window allows you to attach the Visual Studio debugger to a process on the local machine or a remote machine. <strong class="bold">Remote debugging</strong> can <a id="_idIndexMarker523"/>be useful when working with multithreaded UI applications. It allows developers to debug their applications on systems with different numbers of processor cores than what’s on their machines. They can also attach to a remote process running on a system running other processes that will be present in a production environment.</li>
<li><strong class="bold">GPU Threads</strong>: This window displays information about threads running on the GPU. This is used for C++ applications and is beyond the scope of this book. To learn more, you can read the documentation from Microsoft: <a href="https://docs.microsoft.com/visualstudio/debugger/how-to-use-the-gpu-threads-window">https://docs.microsoft.com/visualstudio/debugger/how-to-use-the-gpu-threads-window</a>.</li>
</ul>
<p>In the sections ahead, we will use these debugging tools to step through multithreaded code in projects from some of the previous chapters of this book. Let’s start by learning about the <strong class="bold">Threads</strong> and <strong class="bold">Attach to Process</strong> windows and the <strong class="bold">Debug Location</strong> toolbar.</p>
<h1 id="_idParaDest-162"><a id="_idTextAnchor161"/>Debugging threads and processes</h1>
<p>In this <a id="_idIndexMarker524"/>section, we are going to debug <strong class="bold">BackgroundPingConsoleApp</strong> from <a href="B18552_01_ePub.xhtml#_idTextAnchor014"><em class="italic">Chapter 1</em></a>. You can use your <a id="_idIndexMarker525"/>completed project from <a href="B18552_01_ePub.xhtml#_idTextAnchor014"><em class="italic">Chapter 1</em></a> or get the project from this chapter’s GitHub repository: <a href="https://github.com/PacktPublishing/Parallel-Programming-and-Concurrency-with-C-sharp-10-and-.NET-6/tree/main/chapter10">https://github.com/PacktPublishing/Parallel-Programming-and-Concurrency-with-C-sharp-10-and-.NET-6/tree/main/chapter10</a>. We will debug the application and discover some of the features of the <strong class="bold">Debug Location</strong> toolbar and the <strong class="bold">Threads</strong> window as we go.</p>
<h2 id="_idParaDest-163"><a id="_idTextAnchor162"/>Debugging a project with multiple threads</h2>
<p>The <a id="_idIndexMarker526"/>project we’ll be working this is a simple one<a id="_idIndexMarker527"/> that creates one background<a id="_idIndexMarker528"/> thread to check whether the network is available.</p>
<p class="callout-heading">Note</p>
<p class="callout">The examples in this chapter will be run in the <strong class="bold">Debug</strong> configuration in Visual Studio. When you compile and run a .NET project, you can choose to run a <strong class="bold">Debug</strong> or <strong class="bold">Release</strong> build. While debugging, you will want to select <strong class="bold">Debug</strong> mode so that the project compiles w the symbolic debug information. This is not included in a <strong class="bold">Release</strong> build. For more information about build configurations, check out Microsoft Docs: https://docs.microsoft.com/visualstudio/ide/understanding-build-configurations.</p>
<p>Let’s get started with our debugging example:</p>
<ol>
<li>Start by opening <code>Program.cs</code> in the C# editor.</li>
<li>Set a breakpoint on the <code>Thread.Sleep(100)</code> statement inside the <code>while</code> loop.</li>
<li>Select <strong class="bold">View</strong> | <strong class="bold">Toolbars</strong> | <strong class="bold">Debug Location</strong> to display the <strong class="bold">Debug Location</strong> toolbar:</li>
</ol>
<div><div><img alt="Figure 10.1 – The Debug Location toolbar in Visual Studio " height="41" src="img/Figure_10.1_B18552.jpg" width="1265"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.1 – The Debug Location toolbar in Visual Studio</p>
<p>We will be using this toolbar when we start debugging. All the fields are disabled when there is no active debugging session in Visual Studio.</p>
<ol>
<li value="4">Start <a id="_idIndexMarker529"/>debugging the project. When Visual Studio<a id="_idIndexMarker530"/> breaks at your <a id="_idIndexMarker531"/>breakpoint, notice the state of the <strong class="bold">Debug Location</strong> toolbar:</li>
</ol>
<div><div><img alt="Figure 10.2 – Debugging with the Debug Location toolbar " height="590" src="img/Figure_10.2_B18552.jpg" width="1262"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.2 – Debugging with the Debug Location toolbar</p>
<p>The toolbar provides several dropdown controls to select the <strong class="bold">Process</strong>, <strong class="bold">Thread</strong>, and <strong class="bold">Stack Frame</strong> properties in scope. The <strong class="bold">Process</strong> dropdown will only contain a single process unless you explicitly debug multiple processes with the <strong class="bold">Attach to Process</strong> window. You can also set up multiple startup projects in Visual Studio to achieve this.</p>
<p>The <strong class="bold">Threads</strong> dropdown contains all the threads that belong to the selected process. The selected thread in this control is the background thread we created because the breakpoint was added within the code executed by that background thread.</p>
<p>The <strong class="bold">Stack Frame</strong> dropdown<a id="_idIndexMarker532"/> contains the list of frames in the current thread’s call stack.</p>
<p>There<a id="_idIndexMarker533"/> is a <strong class="bold">Toggle Current Thread Flagged State</strong> button to the right of the <strong class="bold">Threads</strong> dropdown. We will learn about <a id="_idIndexMarker534"/>flagging threads later in the <em class="italic">Switching and flagging threads</em> section.</p>
<ol>
<li value="5">Next, select <strong class="bold">Debug</strong> | <strong class="bold">Windows</strong> | <strong class="bold">Threads</strong> to open the <strong class="bold">Threads</strong> window:</li>
</ol>
<div><div><img alt="Figure 10.3 – Debugging with the Threads window active " height="754" src="img/Figure_10.3_B18552.jpg" width="1263"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.3 – Debugging with the Threads window active</p>
<p>By default, the <strong class="bold">Threads</strong> window will open in the lower-left panel with the <strong class="bold">Output</strong>, <strong class="bold">Locals</strong>, and <strong class="bold">Watch</strong> debugging windows.</p>
<ol>
<li value="6">Finally, expand the <strong class="bold">Threads</strong> window <a id="_idIndexMarker535"/>so that we <a id="_idIndexMarker536"/>can explore <a id="_idIndexMarker537"/>and discuss its features:</li>
</ol>
<div><div><img alt="Figure 10.4 – Taking a closer look at the Threads window " height="426" src="img/Figure_10.4_B18552.jpg" width="1263"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.4 – Taking a closer look at the Threads window</p>
<h2 id="_idParaDest-164"><a id="_idTextAnchor163"/>Exploring the Threads window</h2>
<p>The <strong class="bold">Threads</strong> window<a id="_idIndexMarker538"/> provides quite a bit of useful information in a small window. We will start by discussing <a id="_idIndexMarker539"/>the data that’s displayed for each thread in the list:</p>
<ul>
<li><strong class="bold">Process ID</strong>: By default, the list of threads is grouped by <strong class="bold">Process ID</strong>. This grouping can be controlled by the <strong class="bold">Group by</strong> dropdown in the window’s toolbar. The <strong class="bold">Process ID</strong> grouping also displays the number of threads in its group. This can be useful when working with a large number of threads.</li>
<li><strong class="bold">ID</strong>: This is the ID for each thread in the list</li>
<li><code>Thread.ManagedThreadId</code> property of each thread</li>
<li><strong class="bold">Category</strong>: This describes the type of thread (<strong class="bold">Main Thread</strong>, <strong class="bold">Worker Thread</strong>, and so on)</li>
<li><code>Thread.Name</code> property of each thread. If a thread has no name, then <strong class="bold">&lt;No Name&gt;</strong> will be displayed in this field.</li>
<li><strong class="bold">Location</strong>: This field contains the current stack frame of each thread in its call stack. You can click the dropdown in this field to display the full call stack for the thread.</li>
</ul>
<p>Some additional fields <a id="_idIndexMarker540"/>are hidden by default. You can hide or show columns by selecting the <strong class="bold">Columns</strong> button in the <strong class="bold">Threads</strong> window toolbar. Select or unselect the columns you would like to show or hide. These are the columns that are hidden initially:</p>
<ul>
<li><strong class="bold">Priority</strong>: This displays the priority assigned to the thread by the system</li>
<li><strong class="bold">Affinity Mask</strong>: The affinity mask determines which processors a thread can run on. This is determined by the system</li>
<li><strong class="bold">Suspended Count</strong>: This value is used by the system to decide whether the thread can be run</li>
<li><strong class="bold">Process Name</strong>: This is the name of the process that the thread belongs to</li>
<li><strong class="bold">Process ID</strong>: This is the ID of the process that the thread belongs to</li>
<li><strong class="bold">Transport Qualifier</strong>: This identifies the machine that is connected to the debugger. This is useful for remote debugging</li>
</ul>
<p>Now, let’s review the toolbar items available in the <strong class="bold">Threads</strong> window:</p>
<ul>
<li><strong class="bold">Search</strong>: This allows you to search for threads. You can toggle the <strong class="bold">Include call stacks in search</strong> button on if you want the search results to encompass all call stack information</li>
<li><strong class="bold">Flag</strong>: With this dropdown button, you can select either <strong class="bold">Flag Just My Code</strong> or <strong class="bold">Flag Custom Module Selection</strong></li>
<li><strong class="bold">Group by</strong>: This dropdown allows you to group threads by different fields. By default, they are grouped by <strong class="bold">Process ID</strong></li>
<li><strong class="bold">Columns</strong>: This opens the <strong class="bold">Columns</strong> selection window so that you can customize the columns displayed in the <strong class="bold">Threads</strong> window</li>
<li><strong class="bold">Expand/Collapse callstacks</strong>: These two buttons expand or collapse the call stack in the <strong class="bold">Location</strong> column</li>
<li><strong class="bold">Expand/Collapse groups</strong>: These two buttons expand or collapse the thread groupings</li>
<li><strong class="bold">Freeze Threads</strong>: This freezes all selected threads in the window</li>
<li><strong class="bold">Thaw Threads</strong>: This unfreezes all selected threads in the window</li>
</ul>
<p>Let’s try the <code>Anon</code> in the <strong class="bold">Search</strong> field to find the thread whose call stack contains our anonymous method:</p>
<div><div><img alt="Figure 10.5 – Searching in the Threads window " height="363" src="img/Figure_10.5_B18552.jpg" width="1264"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.5 – Searching in the Threads window</p>
<p>The <strong class="bold">Threads</strong> window should now only contain the row for our <strong class="bold">Worker Thread</strong> with the <strong class="bold">Anon</strong> part of <strong class="bold">AnonymousMethod</strong> highlighted in <em class="italic">yellow</em>. </p>
<p>Now that you have some familiarity with the <strong class="bold">Threads</strong> window, let’s learn how to use it to switch and flag threads.</p>
<h1 id="_idParaDest-165"><a id="_idTextAnchor164"/>Switching and flagging threads</h1>
<p>The <strong class="bold">Threads</strong> window<a id="_idIndexMarker542"/> provides so much power when debugging a multithreaded application. We touched on some of these features in the previous section. In this section, we will learn how to switch threads, flag threads, and freeze or thaw a thread. Let’s start by switching between threads in our <strong class="bold">BackgroundPingConsoleApp</strong> project.</p>
<h2 id="_idParaDest-166"><a id="_idTextAnchor165"/>Switching threads</h2>
<p>You can<a id="_idIndexMarker543"/> switch context to a different thread by using the context menu in the <code>Console.ReadLine()</code> statement. This is where the main thread is waiting for the user to press any key in the console:</p>
<div><div><img alt="Figure 10.6 – Switching threads in the Visual Studio debugger " height="466" src="img/Figure_10.6_B18552.jpg" width="1264"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.6 – Switching threads in the Visual Studio debugger</p>
<p>You can see how this function could be extremely useful when debugging a parallel operation with half a dozen active threads or more. Next, we will learn how to keep an eye on a specific thread with the <strong class="bold">Flag Thread</strong> feature.</p>
<h2 id="_idParaDest-167"><a id="_idTextAnchor166"/>Flagging threads</h2>
<p>In this section, you <a id="_idIndexMarker544"/>will learn how to narrow your field of view while debugging in the <strong class="bold">Threads</strong> window. By only flagging the threads that we care about, we can reduce the clutter in the window. Here’s how to flag threads:</p>
<ol>
<li value="1">If you aren’t still debugging the <strong class="bold">BackgroundPingConsoleApp</strong> project, start debugging it now and wait for it to stop at the breakpoint.</li>
<li>While<a id="_idIndexMarker545"/> the debugger is paused in the application, right-click the <strong class="bold">Main Thread</strong> row and select <strong class="bold">Flag</strong>. The flag icon should now be colored <em class="italic">orange</em> in that row.</li>
<li>Do the same for the row containing <strong class="bold">Worker Thread</strong> with <strong class="bold">AnonymousMethod</strong> in the call stack</li>
<li>Next, click the <strong class="bold">Show Flagged Threads Only</strong> button in the window’s toolbar:</li>
</ol>
<div><div><img alt="Figure 10.7 – Showing flagged threads only in the Threads window " height="295" src="img/Figure_10.7_B18552.jpg" width="1262"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.7 – Showing flagged threads only in the Threads window</p>
<p>This makes it simpler to track only the threads that are important to our current debugging session. You can click the button again to toggle the button off and view all threads. It is also possible to flag threads in the <strong class="bold">Parallel Watch</strong> and <strong class="bold">Parallel Stacks</strong> windows. Their flagged state will persist across all of these windows and the <strong class="bold">Debug Location</strong> toolbar.</p>
<p>There’s an even easier way to flag these two threads in our application. These are the only two threads that are part of our application’s code. So, we can use the <strong class="bold">Flag Just My Code</strong> button in the toolbar to flag them.</p>
<ol>
<li value="1">Unselect the <strong class="bold">Show Flagged Threads Only</strong> toolbar button</li>
<li>Right-click one of the flagged rows in the window and select <strong class="bold">Unflag All</strong></li>
<li>Now, click <strong class="bold">Flag Just My Code</strong> in the toolbar. The same two threads will be flagged again:</li>
</ol>
<div><div><img alt="Figure 10.8 – Flagging only the threads that belong to our code " height="388" src="img/Figure_10.8_B18552.jpg" width="1263"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.8 – Flagging only the threads that belong to our code</p>
<p>This is much<a id="_idIndexMarker546"/> easier than selecting threads one by one in the list. It may not always be as obvious which threads are part of our code. In the next section, we will learn how to freeze a thread.</p>
<h2 id="_idParaDest-168"><a id="_idTextAnchor167"/>Freezing threads</h2>
<p>Freezing or <a id="_idIndexMarker547"/>thawing a thread in the <code>SuspendThread</code> or <code>ResumeThread</code> Windows functions. If a frozen thread is not executing any code yet, it will never start unless it is thawed. If a thread is currently executing, it will pause when the <strong class="bold">Freeze</strong> thread is called in Visual Studio.</p>
<p>Let’s try freezing and thawing the worker thread in our <strong class="bold">BackgroundPingConsoleApp</strong> project to see what happens in the debugger:</p>
<ol>
<li value="1">Before running the application, add new breakpoints at the <code>while</code> <code>(true)</code> and <code>Console.ReadKey()</code> statements. Keep the existing breakpoint at <code>Thread.Sleep(100)</code></li>
<li>Start debugging the application</li>
<li>When the debugger breaks on the <code>while (true)</code> line, right-click the worker thread that contains <strong class="bold">AnonymousMethod</strong> and select <strong class="bold">Freeze</strong></li>
<li>Continue debugging; it should break on the <code>Console.ReadKey()</code> line instead of <code>Thread.Sleep(100)</code>. This is because the worker thread is not currently running:</li>
</ol>
<div><div><img alt="Figure 10.9 – Freezing a worker thread in the Threads window " height="422" src="img/Figure_10.9_B18552.jpg" width="1263"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.9 – Freezing a worker thread in the Threads window</p>
<ol>
<li value="5">Right-click the worker thread again and select <strong class="bold">Thaw</strong></li>
<li>Now, continue debugging again. Visual Studio breaks on the <code>Thread.Sleep(100)</code> line inside the anonymous method.</li>
</ol>
<p>This <a id="_idIndexMarker548"/>shows how the functions of the <strong class="bold">Threads</strong> window could be extremely useful while debugging a multithreaded application.</p>
<p>Now that we have learned how to debug our multithreaded application by switching, freezing, and flagging threads with the <strong class="bold">Threads</strong> window, let’s learn how we can leverage additional features such as the <strong class="bold">Parallel Stacks</strong> and <strong class="bold">Parallel Watch</strong> windows while debugging.</p>
<h1 id="_idParaDest-169"><a id="_idTextAnchor168"/>Debugging a parallel application</h1>
<p>Visual Studio <a id="_idIndexMarker549"/>provides several windows for parallel debugging. While the <code>Task</code> objects in our applications.</p>
<p>We will start our tour of these features with the <strong class="bold">Parallel Stacks</strong> window.</p>
<h2 id="_idParaDest-170"><a id="_idTextAnchor169"/>Using the Parallel Stacks window</h2>
<p>The <strong class="bold">Parallel Stacks</strong> window<a id="_idIndexMarker550"/> provides<a id="_idIndexMarker551"/> a visual representation of the threads or tasks in the application. These are two distinct views in the window. You can switch between them by selecting <strong class="bold">Threads</strong> or <strong class="bold">Tasks</strong> in the <strong class="bold">View</strong> dropdown box. The following screenshot shows an example of the <strong class="bold">Threads</strong> view <a id="_idIndexMarker552"/>while debugging the <strong class="bold">BackgroundPingConsoleApp</strong> project:</p>
<div><div><img alt="Figure 10.10 – Viewing the Parallel Stacks window in the Threads view " height="730" src="img/Figure_10.10_B18552.jpg" width="1334"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.10 – Viewing the Parallel Stacks window in the Threads view</p>
<p>The <strong class="bold">Parallel Stacks</strong> window contains a toolbar with the following items from left to right. You can follow along by examining the tooltips for the toolbar items in the window in Visual Studio:</p>
<ul>
<li><strong class="bold">Search</strong>: This allows the same type of search functionality that is available in the <strong class="bold">Threads</strong> window. It has the <strong class="bold">Find Previous</strong> and <strong class="bold">Find Next</strong> buttons to the right of the <strong class="bold">Search</strong> field.</li>
<li><strong class="bold">View</strong>: This dropdown switches between the <strong class="bold">Threads</strong> and <strong class="bold">Tasks</strong> views</li>
<li><strong class="bold">Show Only Flagged</strong>: This toggle will hide any threads that are not flagged</li>
<li><strong class="bold">Toggle Method View</strong>: This will switch to a view of the currently selected method and its call stack</li>
<li><strong class="bold">Auto Scroll to Current Stack Frame</strong>: This will scroll the current stack frame into view in the diagram while stepping through the debugger. This option is toggled on by default.</li>
<li><strong class="bold">Toggle Zoom Control</strong>: This hides or shows the zoom control on the diagram’s surface. This option is turned on by default.</li>
<li><strong class="bold">Reverse Layout</strong>: This option mirrors the layout of the current view</li>
<li><code>.png</code> file</li>
</ul>
<p>To examine<a id="_idIndexMarker553"/> the <code>Task</code> objects. Let’s work with the <strong class="bold">Tasks</strong> view by opening a project from a previous chapter in the book:</p>
<ol>
<li value="1">Open your <strong class="bold">TaskSamples</strong> project from <a href="B18552_05_ePub.xhtml#_idTextAnchor082"><em class="italic">Chapter 5</em></a>, or get a copy of this project from this chapter’s source code on GitHub: <a href="https://github.com/PacktPublishing/Parallel-Programming-and-Concurrency-with-C-sharp-10-and-.NET-6/tree/main/chapter10">https://github.com/PacktPublishing/Parallel-Programming-and-Concurrency-with-C-sharp-10-and-.NET-6/tree/main/chapter10</a>.</li>
<li>Open <code>Examples.cs</code> and set a breakpoint on the first line of the <code>ProcessOrders</code> method.</li>
<li>Start debugging. When the debugger stops on the breakpoint, select <strong class="bold">Debug</strong> |<strong class="bold"> Windows</strong> | <strong class="bold">Parallel Stacks</strong>.</li>
<li>Switch to the <strong class="bold">Tasks</strong> view in the <strong class="bold">Parallel Stacks</strong> window:</li>
</ol>
<div><div><img alt="Figure 10.11 – The Parallel Stacks window in the Tasks view " height="584" src="img/Figure_10.11_B18552.jpg" width="1338"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.11 – The Parallel Stacks window in the Tasks view</p>
<p>No tasks<a id="_idIndexMarker554"/> have been started yet, so there isn’t much to see here. There is a single <strong class="bold">Async Logical Stack</strong> block that looks like it is ready to start analyzing some async work.</p>
<ol>
<li value="5">Add a breakpoint on the <code>Tasks.WaitAll</code> statement and click <strong class="bold">Continue</strong></li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">It is possible to configure breakpoints in Visual Studio by right-clicking on the breakpoint you want to modify and clicking <code>ThreadId</code> or <code>ThreadName</code> values. This will ensure that the debugger will only stop on the current breakpoint when the desired thread(s) are executing that line of code. To read more about breakpoint conditions and filters, check out this article on Microsoft Docs: <a href="https://docs.microsoft.com/visualstudio/debugger/using-breakpoints#set-a-filter-condition">https://docs.microsoft.com/visualstudio/debugger/using-breakpoints#set-a-filter-condition</a>.</p>
<ol>
<li value="6">Now, examine the <strong class="bold">Parallel Stacks</strong> window again:</li>
</ol>
<div><div><img alt="Figure 10.12 – The Parallel Stacks window while tasks are active " height="1076" src="img/Figure_10.12_B18552.jpg" width="1395"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.12 – The Parallel Stacks window while tasks are active</p>
<p class="callout-heading">Note</p>
<p class="callout">It can be challenging to catch the tasks in this window while they are still executing if they are fast-running methods. You may have to run the application several times to hit this breakpoint if one or more of the <code>Task</code> objects has not been completed yet.</p>
<p>In this <a id="_idIndexMarker555"/>case, the <strong class="bold">Parallel Stacks</strong> window has captured the execution of one running task and another preparing to run. There are some differences between this <strong class="bold">Tasks</strong> view and some of the thread analysis we have done in this chapter:</p>
<ul>
<li>Only actively running tasks are shown in the <strong class="bold">Tasks</strong> view</li>
<li>The <strong class="bold">Tasks</strong> view’s stack attempts to display only the relevant call stack information. Stack frames may be trimmed from the top and bottom if they are not relevant. If you need to see the entire call stack, switch back to the <strong class="bold">Threads</strong> view.</li>
<li>A separate block is displayed for each active task in the <strong class="bold">Tasks</strong> view, even if they are assigned to the same thread.</li>
</ul>
<p>You can hover<a id="_idIndexMarker556"/> over a line in a task’s call stack to view more information about its thread and stack frame:</p>
<div><div><img alt="Figure 12.13 – Viewing more information about a call stack frame " height="611" src="img/Figure_10.13_B18552.jpg" width="1264"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.13 – Viewing more information about a call stack frame</p>
<p>If you want to pivot the <strong class="bold">Tasks</strong> view to a particular method, you can use the <strong class="bold">Toggle Method View</strong> button:</p>
<ol>
<li value="1">Start a new debugging session in the <strong class="bold">TaskSamples</strong> project</li>
<li>Set a new breakpoint on the <code>return orders</code> statement in the <code>PrepareOrders</code> method</li>
<li>Click <code>PrepareOrders</code> method.</li>
<li>Click <a id="_idIndexMarker557"/>the <code>PrepareOrders</code> method to get more call stack and thread information:</li>
</ol>
<div><div><img alt="Figure 10.14 – Leveraging the Method View area of the Parallel Stacks window " height="341" src="img/Figure_10.14_B18552.jpg" width="1263"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.14 – Leveraging the Method View area of the Parallel Stacks window</p>
<p>Next, we will learn how to view the state of variables across different threads by using the <strong class="bold">Parallel Watch</strong> window.</p>
<h2 id="_idParaDest-171"><a id="_idTextAnchor170"/>Using the Parallel Watch window</h2>
<p>The <strong class="bold">Parallel Watch</strong> window <a id="_idIndexMarker558"/>is similar<a id="_idIndexMarker559"/> to the <strong class="bold">Watch</strong> window in Visual Studio, but it displays additional information about the value of the watched expression across the threads with access to the data in the expression.</p>
<p>In this example, we will modify the <code>Examples</code> class in the <strong class="bold">TaskSamples</strong> project to add a state that will be available to multiple threads:</p>
<ol>
<li value="1">Start by adding a private variable to the <code>Examples</code> class:<pre>private List&lt;Order&gt; _sharedOrders;</pre></li>
<li>Add a line to <code>ProcessOrders</code> to assign orders to <code>_sharedOrders</code>:<pre>private List&lt;Order&gt; PrepareOrders(List&lt;Order&gt; orders)
{
    // TODO: Prepare orders here
    <strong class="bold">_sharedOrders = orders;</strong>
    return orders;
}</pre></li>
<li>Keep the breakpoints from the previous example and start debugging. Continue until the debugger breaks on the <code>return orders</code> statement inside <code>ProcessOrders</code>.</li>
<li>Select <strong class="bold">Debug</strong> | <strong class="bold">Windows</strong> | <strong class="bold">Parallel Watch 1</strong> to open the <strong class="bold">Parallel Watch 1</strong> window. You <a id="_idIndexMarker560"/>can open up to four <strong class="bold">Parallel Watch</strong> windows to separate your watched expressions.</li>
<li>In the <code>_sharedOrders</code> private variable:</li>
</ol>
<div><div><img alt="Figure 10.15 – Adding a watched expression in Parallel Watch 1 window " height="475" src="img/Figure_10.15_B18552.jpg" width="1261"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.15 – Adding a watched expression in Parallel Watch 1 window</p>
<p>The window indicates that <code>_sharedOrders</code> in scope and that the count of orders in the variable is <code>0</code>.</p>
<ol>
<li value="6">Right-click on <strong class="bold">Main Thread</strong> in the <strong class="bold">Threads</strong> window and select <strong class="bold">Switch to Thread</strong>. In the <strong class="bold">Parallel Watch 1</strong> window, a task is no longer in scope, so the header label has<a id="_idIndexMarker561"/> changed from <strong class="bold">Task</strong> to <strong class="bold">Thread</strong>, and the <strong class="bold">ID</strong> property of <strong class="bold">Main Thread</strong> will be displayed:</li>
</ol>
<div><div><img alt="Figure 10.16 – Viewing the watched variable on Main Thread " height="514" src="img/Figure_10.16_B18552.jpg" width="1360"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.16 – Viewing the watched variable on Main Thread</p>
<ol>
<li value="7">Finally, select <strong class="bold">Debug</strong> | <strong class="bold">Windows</strong> | <strong class="bold">Tasks</strong> to open the <strong class="bold">Tasks</strong> window:</li>
</ol>
<div><div><img alt="Figure 10.17 – Viewing the Tasks window while debugging " height="341" src="img/Figure_10.17_B18552.jpg" width="1264"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.17 – Viewing the Tasks window while debugging</p>
<p>The <strong class="bold">Tasks</strong> window will show information about the tasks in scope in the debugging session. The following columns are displayed in the window:</p>
<ul>
<li><strong class="bold">Flag</strong>: An icon indicating whether the current task has been flagged. You can click this field to flag or unflag a task.</li>
<li><strong class="bold">ID</strong>: The ID of the task</li>
<li><code>Task.Status</code> properties of the task</li>
<li><strong class="bold">Start Time (sec)</strong>: This indicates how many seconds into the debugging session the task started</li>
<li><strong class="bold">Duration (sec)</strong>: This indicates how long the task has been running</li>
<li><strong class="bold">Location</strong>: This shows the call stack’s position for the task on the thread</li>
<li><strong class="bold">Task</strong>: The<a id="_idIndexMarker562"/> initial method where the task started. Any parameters that have been passed will also be shown in this field.</li>
</ul>
<p>Several other hidden fields can be shown by right-clicking in the window and selecting <strong class="bold">Columns</strong>:</p>
<div><div><img alt="Figure 10.18 – Adding or removing columns from the Tasks window " height="714" src="img/Figure_10.18_B18552.jpg" width="1024"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.18 – Adding or removing columns from the Tasks window</p>
<p>You can sort and group the tasks in the <strong class="bold">Tasks</strong> window similar to how the <strong class="bold">Threads</strong> window<a id="_idIndexMarker563"/> works. The difference is that the <strong class="bold">Tasks</strong> window does not have a toolbar. All operations are performed with the right-click context menu.</p>
<p>The other tool you can use while debugging parallel .NET code is the <strong class="bold">Debug Location</strong> toolbar. If it is not already displayed in Visual Studio, you can open it by going to <strong class="bold">View</strong> | <strong class="bold">Toolbars</strong> | <strong class="bold">Debug Location</strong>. While you’re debugging, the toolbar functionality lights up:</p>
<div><div><img alt="Figure 10.19 – Viewing the Debug Location toolbar while debugging  " height="91" src="img/Figure_10.19_B18552.jpg" width="1265"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.19 – Viewing the Debug Location toolbar while debugging </p>
<p>From the toolbar, you can select the active <strong class="bold">Process</strong>, <strong class="bold">Thread</strong>, and <strong class="bold">Stack Frame</strong>. It’s also easy to toggle the flagged state of the currently selected thread.</p>
<p>That completes our tour of the debug windows available to .NET parallel programmers. Let’s wrap up by reviewing everything we learned in this chapter.</p>
<h1 id="_idParaDest-172"><a id="_idTextAnchor171"/>Summary</h1>
<p>In this chapter, we learned about the Visual Studio features available to multithreaded application developers. We started by working with threads in the <code>Thread</code> objects. </p>
<p>Next, we learned how to switch, flag, and freeze our threads while debugging. Finally, we looked at some of the advanced debugging tools for developers who are using <code>Task</code> objects or <code>async</code>/<code>await</code> in their code. The <strong class="bold">Parallel Stacks</strong> and <strong class="bold">Parallel Watch</strong> windows take task debugging to the next level. Finally, we took a quick look at the <strong class="bold">Tasks</strong> window and the <strong class="bold">Debug Location</strong> toolbar.</p>
<p>In the next chapter, <a href="B18552_11_ePub.xhtml#_idTextAnchor173"><em class="italic">Chapter 11</em></a>, we will dive deeper into the different methods available to cancel concurrent and parallel work with .NET.</p>
<h1 id="_idParaDest-173"><a id="_idTextAnchor172"/>Questions</h1>
<ol>
<li value="1">How can you debug multiple processes in Visual Studio?</li>
<li>What is the default grouping of threads in the <strong class="bold">Threads</strong> window?</li>
<li>How can you add more columns to the <strong class="bold">Tasks</strong> or <strong class="bold">Threads</strong> window?</li>
<li>Which debug window displays a visual representation of the current threads or tasks?</li>
<li>What file format can you export from the <strong class="bold">Parallel Stacks</strong> window?</li>
<li>How many <strong class="bold">Parallel Watch</strong> windows can you open?</li>
<li>Which Visual Studio toolbar provides information about the processes and threads you are currently debugging?</li>
<li>How can you filter the <strong class="bold">Threads</strong> window to only show the threads that have been created for your code?</li>
</ol>
</div>
</div>
</body></html>