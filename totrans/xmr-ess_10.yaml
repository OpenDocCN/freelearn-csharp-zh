- en: Chapter 10. Preparing Xamarin.Android Apps for Distribution
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, we will discuss activities related to preparing a Xamarin.Android
    app for distribution and look at the various options for distributing apps. Many
    of the activities we will discuss are an integral part of any Android app deployment.
    However, in this chapter, we will try to narrow the scope of our coverage to aspects
    that are unique to developing with Xamarin.Android. We will cover the following
    topics:'
  prefs: []
  type: TYPE_NORMAL
- en: App profiling
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Android Build settings for distributing apps
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: App distribution options
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Preparing for a release APK
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Prior to publishing a signed APK file for release, there are a number of activities
    that need to be completed. The following sections discuss topics that should be
    considered prior to producing a release APK.
  prefs: []
  type: TYPE_NORMAL
- en: Profiling Xamarin.Android apps
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The Xamarin.Android Business license provides limited support to profile Android
    apps. Profiling can be a very effective way to identify memory leaks and process
    bottlenecks.
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'We will not cover profiling within this book, but the following link provides
    an overview of using the profiling capabilities of Xamarin.Android: [http://docs.xamarin.com/guides/android/deployment,_testing,_and_metrics/profiling](http://docs.xamarin.com/guides/android/deployment,_testing,_and_metrics/profiling).'
  prefs: []
  type: TYPE_NORMAL
- en: In addition to using the tools provided with Xamarin.Android, traditional Android
    profiling tools such as Traceview and `dmtracedump` can be used. You can find
    more information at [http://developer.android.com/tools/debugging/debugging-tracing.html](http://developer.android.com/tools/debugging/debugging-tracing.html).
  prefs: []
  type: TYPE_NORMAL
- en: Disabling debug
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'When developing a Xamarin.Android app, Xamarin Studio supports debugging with
    the use of **Java Debug Wire Protocol** (**JDWP**). This feature needs to be disabled
    in release builds as it poses a security risk. You have two different ways to
    accomplish this:'
  prefs: []
  type: TYPE_NORMAL
- en: Changing the settings in `AndroidManifest.xml`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Changing the settings in `AssemblyInfo.cs`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Changing the settings in AndroidManifest.xml
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The first method can be done by using the following listing, which shows you
    how to turn off JDWP debugging from the `AndroidManifest.xml` file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: Changing the settings in AssemblyInfo.cs
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The alternative method is done by disabling JDWP through `AssemblyInfo.cs`.
    This has the advantage of being based on the currently selected configuration.
    The following listing shows how to use a conditional directive to turn JDWP debugging
    off:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: Android Application (AndroidManifest.xml) settings
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'By the time you start considering deployment of your app, you will have already
    established most of the settings needed in `AndroidManifest.xml`. However, you
    will need to update the version information. Keep in mind, the version number
    is used by the Android platform during the installation process to determine whether
    an APK is an update to an existing app. A version name is a free-form text and
    can be used to track app versions in any manner desired. This can be accomplished
    by opening the **Project Options** dialog box and navigating to **Build** | **Android
    Application**, or by double-clicking on `NationalParks/Properties/AndroidManifest.xml`.
    The following screenshot depicts the **Android Application** settings dialog box:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Android Application (AndroidManifest.xml) settings](img/0838OT_10_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Linker Options
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'During a build, Xamarin.Android performs static analysis of the assemblies
    that make up an app and attempts to eliminate type and member instances that are
    not needed. The settings that control this process can be viewed and set in the
    **Project Options** dialog box under the **Android Build** section, as shown in
    the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Linker Options](img/0838OT_10_03.jpg)'
  prefs: []
  type: TYPE_IMG
- en: 'Xamarin.Android supports the same linker options as Xamarin.iOS. When viewing
    and adjusting the **Linker Options** settings, be sure to first select **Release**
    from the **Configuration** drop-down box. The following linking options are available:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Don''t link**: This option disables the linker and ensures that all referenced
    assemblies are included without modification. This is the default setting for
    builds that target the iOS Simulator. This eliminates the time-consuming process
    of linking, and deploying a large file to the simulator is relatively quick.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Link SDK assemblies only**: This option tells the linker to operate only
    on the SDK assemblies; those assemblies that ship with Xamarin.iOS. This is the
    default setting for builds that target a device.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Link all assemblies**: This option tells the linker to operate on the entire
    app, as well as all referenced assemblies. This allows the linker to use a larger
    set of optimizations and results in the smallest possible application. However,
    when the linker runs in this mode, there is a greater chance that it might break
    portions of your code due to false assumptions made by the static analysis process.
    In particular, the use of reflection and serialization can trip up the static
    analysis.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The following table shows how the APK file size varies based on the linker
    setting:'
  prefs: []
  type: TYPE_NORMAL
- en: '|   | File linking version | PCL version |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| **Don''t link** | 26.4 MB | 27.5 MB |'
  prefs: []
  type: TYPE_TB
- en: '| **Link SDK assemblies only** | 4.3 MB | 4.3 MB |'
  prefs: []
  type: TYPE_TB
- en: '| **Link all assemblies** | 4.1 MB | 4.2 MB |'
  prefs: []
  type: TYPE_TB
- en: Overriding the linker
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In some cases, the linking option can have negative side effects, such as important
    types and/or members being accidentally eliminated. It is important for an application
    that has been compiled and linked in release mode to be thoroughly tested before
    distribution in order to identify such issues. In some situations, you should
    conduct tests beyond the initial developer's testing, and this should be conducted
    using an APK file produced in release mode.
  prefs: []
  type: TYPE_NORMAL
- en: In the event that you encounter any runtime exceptions related to missing types
    or trouble locating specific methods, you can make use of one of the following
    methods to give explicit instructions to the linker.
  prefs: []
  type: TYPE_NORMAL
- en: Preserving code with attributes
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: If you determine from testing that the linking is removing classes or methods
    needed by your app, you can explicitly tell the linker to always include them
    by using the `Preserve` attribute on a class and/or method.
  prefs: []
  type: TYPE_NORMAL
- en: 'To preserve the entire type, use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'To preserve a single member, use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: Preserving code with custom linker files
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'There are times when you might not have access to the source code, but still
    need to preserve specific types and/or members. This can be accomplished with
    a custom linker file. The following example instructs the linker to always include
    specific members for a type:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'You can add a custom-linking file to a project by adding a simple XML file
    and populating it with similar content to the previous example; it does not really
    matter where you place it in the project structure. After adding the file to the
    project, select the file, open the **Properties** pad, and choose **LinkDescription**
    for **Build action**, as shown in the following screenshot:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Preserving code with custom linker files](img/0838OT_10_02.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Skipping assemblies
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'You can also instruct the linker to skip entire assemblies so that all the
    types and members will be retained. This can be accomplished in the following
    two ways:'
  prefs: []
  type: TYPE_NORMAL
- en: Using a command-line option `linkskip`, for example, `--linkskip=someassembly`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Using the `AndroidLinkSkip` MSBuild property, as follows:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Supported ABIs
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Android supports a number of different CPU architectures. The Android platform
    defines a set of **Application Binary Interfaces** (**ABI**) that corresponds
    to different CPU architectures. By default, Xamarin.Android assumes that armeabi-v7a
    is appropriate for most circumstances. To support additional architectures, check
    each option that applies on the **Project Options** dialog box under the **Android
    Build** section.
  prefs: []
  type: TYPE_NORMAL
- en: '![Supported ABIs](img/0838OT_10_04.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Publishing a release APK
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now that you have adjusted the setting needed to produce a release build, you
    are ready to publish the actual APK. When we say publish, we simply mean to produce
    an APK that can be uploaded to the Google Play Store. The following sections discuss
    the steps of producing a signed APK from within Xamarin Studio.
  prefs: []
  type: TYPE_NORMAL
- en: Keystores
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: A keystore is a database of security certificates created and managed by the
    keytool program from the Java SDK. You can create the keystore outside of Xamarin
    Studio using the keytool command or from within Xamarin Studio that provides a
    UI that interfaces with the keytool command. The next section takes you through
    the steps to publish an APK and create a new keystore from within Xamarin Studio.
  prefs: []
  type: TYPE_NORMAL
- en: Publishing from Xamarin.Android
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The following steps guide you through the creation of a new keystore as a part
    of the process of creating a signed APK:'
  prefs: []
  type: TYPE_NORMAL
- en: In the **Configuration** drop-down box, select **Release**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Navigate to **Project** | **Publish Android Application** from the main menu;
    note the **Keystore selection** page of the **Publish Android Application** wizard,
    as shown in the following screenshot:![Publishing from Xamarin.Android](img/0838OT_10_05.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Select **Create new keystore**, select a location including a filename for the
    keystore, and enter the password and confirm it. The example keystore is in the
    project folder named `NationalParks.keystore` and the password is `nationalparks`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Select **Forward**; you will see the **Key creation** page of the **Publish
    Android Application** wizard, as shown in the following screenshot:![Publishing
    from Xamarin.Android](img/0838OT_10_06.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Enter all the relevant information. This example uses `nationalparks` for the
    **Alias** field and **Password**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Select **Forward**; you will see the **Select destination** page of the **Publish
    Android Application** wizard, as shown in the following screenshot:![Publishing
    from Xamarin.Android](img/0838OT_10_07.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Select the required **Target directory** option and click on **Create**. Xamarin
    Studio will compile the app for release and generate a signed APK file. You should
    see the following in the **Publishing package** pad:![Publishing from Xamarin.Android](img/0838OT_10_08.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The resulting APK is ready for final testing and potential distribution. Be
    sure to secure and back up your keystore as it is critical to distributing future
    versions.
  prefs: []
  type: TYPE_NORMAL
- en: Republishing from Xamarin.Android
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Subsequent publications of an app should always use the original keystore. To
    accomplish this, simply select **Use existing keystore** on the **Keystore selection**
    page of the **Publish Android Application** wizard.
  prefs: []
  type: TYPE_NORMAL
- en: Publishing from Visual Studio
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Publishing a signed APK from within Visual Studio essentially follows the same
    process. To do so, simply navigate to **Tools** | **Publish Android Application**
    from the main menu.
  prefs: []
  type: TYPE_NORMAL
- en: App distribution options
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Distributing Xamarin.Android apps is no different from any other Android app.
    They can be distributed through all the normal channels, app stores, e-mail attachments,
    website links, thumb drive, and so on.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we have reviewed activities related to preparing for distribution
    of an app and the process to actually produce a signed release APK file.
  prefs: []
  type: TYPE_NORMAL
- en: This chapter completes our book on Xamarin Essentials. We have tried to provide
    a productive approach for experienced mobile developers to quickly come up to
    speed on developing apps using the Xamarin platform. We have reviewed the Xamarin
    architecture, developed functional apps for both iOS and Android, and looked at
    how to maximize Xamarin's value by sharing code across mobile platforms using
    several different approaches and frameworks. You are now ready to put Xamarin
    to work.
  prefs: []
  type: TYPE_NORMAL
- en: I hope you have found this book a useful resource and that it has generated
    some excitement in you about developing great mobile apps with Xamarin.
  prefs: []
  type: TYPE_NORMAL
