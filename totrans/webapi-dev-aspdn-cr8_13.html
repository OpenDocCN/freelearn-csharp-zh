<html><head></head><body>
<div id="_idContainer109">
<h1 class="chapter-number" id="_idParaDest-280"><a id="_idTextAnchor537"/><span class="koboSpan" id="kobo.1.1">13</span></h1>
<h1 id="_idParaDest-281"><a id="_idTextAnchor538"/><span class="koboSpan" id="kobo.2.1">Getting Started with SignalR</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In </span><a href="B18971_01.xhtml#_idTextAnchor012"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.4.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.5.1">, we introduced the concept of real-time web APIs. </span><span class="koboSpan" id="kobo.5.2">Various technologies can be used to implement real-time web APIs, such as gRPC streaming, long polling, </span><strong class="bold"><span class="koboSpan" id="kobo.6.1">Server-Sent Events</span></strong><span class="koboSpan" id="kobo.7.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.8.1">SSE</span></strong><span class="koboSpan" id="kobo.9.1">), WebSockets, and so on. </span><span class="koboSpan" id="kobo.9.2">Microsoft provides an open-source library called SignalR to simplify the implementation of real-time web APIs. </span><span class="koboSpan" id="kobo.9.3">In this chapter, we will introduce the basics of SignalR and how to use SignalR to implement real-time </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">web APIs.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1">We will cover the following topics in </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.13.1">Recap of real-time </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">web APIs</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Setting </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">up SignalR</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Building </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">SignalR clients</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">Using authentication and authorization </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">in SignalR</span></span></li>
<li><span class="koboSpan" id="kobo.21.1">Managing users </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">and groups</span></span></li>
<li><span class="koboSpan" id="kobo.23.1">Sending messages from </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">other services</span></span></li>
<li><span class="koboSpan" id="kobo.25.1">Configuring SignalR hubs </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">and clients</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.27.1">By the end of this chapter, you will be able to use SignalR to implement real-time </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">web APIs.</span></span></p>
<h1 id="_idParaDest-282"><a id="_idTextAnchor539"/><span class="koboSpan" id="kobo.29.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.30.1">To follow the steps in this chapter, you can download the source code from the GitHub repository at </span><a href="https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8/tree/main/samples/chapter13"><span class="koboSpan" id="kobo.31.1">https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8/tree/main/samples/chapter13</span></a><span class="koboSpan" id="kobo.32.1">. </span><span class="koboSpan" id="kobo.32.2">You can use VS 2022 or VS Code to open </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">the solutions.</span></span></p>
<p><span class="koboSpan" id="kobo.34.1">You also need to install the </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">following software:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.36.1">Node.js</span></strong><span class="koboSpan" id="kobo.37.1">: Node.js is a JavaScript runtime built on Chrome’s V8 JavaScript engine. </span><span class="koboSpan" id="kobo.37.2">You can download the latest version of Node.js from </span><a href="https://nodejs.org/en/"><span class="koboSpan" id="kobo.38.1">https://nodejs.org/en/</span></a><span class="koboSpan" id="kobo.39.1">. </span><span class="koboSpan" id="kobo.39.2">We will use it to install the required packages for the </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">TypeScript client.</span></span></li>
</ul>
<h1 id="_idParaDest-283"><a id="_idTextAnchor540"/><span class="koboSpan" id="kobo.41.1">Recap of real-time web APIs</span></h1>
<p><span class="koboSpan" id="kobo.42.1">We introduced a</span><a id="_idIndexMarker1389"/><span class="koboSpan" id="kobo.43.1"> few technologies that can be used to implement real-time web APIs in </span><a href="B18971_01.xhtml#_idTextAnchor012"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.44.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.45.1">. </span><span class="koboSpan" id="kobo.45.2">Each technology has its pros and cons. </span><span class="koboSpan" id="kobo.45.3">To simplify the implementation of real-time web APIs, Microsoft provides SignalR, which supports multiple transports, such as WebSockets, SSE, and long polling. </span><span class="koboSpan" id="kobo.45.4">SignalR will automatically choose the best transport based on the client’s capabilities. </span><span class="koboSpan" id="kobo.45.5">On top of that, SignalR </span><a id="_idIndexMarker1390"/><span class="koboSpan" id="kobo.46.1">provides a simple programming model to implement real-time web APIs. </span><span class="koboSpan" id="kobo.46.2">Developers do not need to worry about the underlying transport details; instead, they can focus on the </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">business logic.</span></span></p>
<p><span class="koboSpan" id="kobo.48.1">SignalR was first introduced for ASP.NET in 2013. </span><span class="koboSpan" id="kobo.48.2">As of now, SignalR has been rewritten for ASP.NET Core and is included in the ASP.NET Core framework. </span><span class="koboSpan" id="kobo.48.3">So, there are two different versions of SignalR: one for ASP.NET and one for ASP.NET Core. </span><span class="koboSpan" id="kobo.48.4">If you are using ASP.NET Core, you do not need to install any additional packages to use SignalR. </span><span class="koboSpan" id="kobo.48.5">There are also some differences between the ASP.NET version and the ASP.NET Core version of SignalR. </span><span class="koboSpan" id="kobo.48.6">For example, ASP.NET Core SignalR does not support Microsoft Internet Explorer. </span><span class="koboSpan" id="kobo.48.7">However, most modern applications are targeting modern browsers, so this should not be a big issue. </span><span class="koboSpan" id="kobo.48.8">In this chapter, we will focus on the ASP.NET Core version </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">of SignalR.</span></span></p>
<p><span class="koboSpan" id="kobo.50.1">Unlike REST APIs, SignalR clients need to install a SignalR client library to communicate with SignalR servers. </span><span class="koboSpan" id="kobo.50.2">SignalR provides a couple of client libraries for </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">different platforms:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.52.1">JavaScript client</span></strong><span class="koboSpan" id="kobo.53.1">: This</span><a id="_idIndexMarker1391"/><span class="koboSpan" id="kobo.54.1"> is the most used client library because it can be used in both browsers and </span><span class="No-Break"><span class="koboSpan" id="kobo.55.1">Node.js applications</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.56.1">.NET client</span></strong><span class="koboSpan" id="kobo.57.1">: This </span><a id="_idIndexMarker1392"/><span class="koboSpan" id="kobo.58.1">client can be used for .NET applications, such as</span><a id="_idIndexMarker1393"/><span class="koboSpan" id="kobo.59.1"> Xamarin, </span><strong class="bold"><span class="koboSpan" id="kobo.60.1">Windows Presentation Foundation</span></strong><span class="koboSpan" id="kobo.61.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.62.1">WPF</span></strong><span class="koboSpan" id="kobo.63.1">), </span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">and Blazor</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.65.1">Java client</span></strong><span class="koboSpan" id="kobo.66.1">: This</span><a id="_idIndexMarker1394"/><span class="koboSpan" id="kobo.67.1"> client supports Java 8 </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">and later</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.69.1">Other clients, such as the C++ client and Swift client, are not officially supported </span><span class="No-Break"><span class="koboSpan" id="kobo.70.1">by Microsoft.</span></span></p>
<p><span class="koboSpan" id="kobo.71.1">SignalR is a </span><a id="_idIndexMarker1395"/><span class="koboSpan" id="kobo.72.1">good choice for building real-time web APIs. </span><span class="koboSpan" id="kobo.72.2">For example, you can use SignalR to build a chat application, a real-time dashboard, voting applications, whiteboard applications, and so on. </span><span class="koboSpan" id="kobo.72.3">SignalR can push data to specific clients or groups of clients. </span><span class="koboSpan" id="kobo.72.4">It automatically manages connections between clients and servers. </span><span class="koboSpan" id="kobo.72.5">In the next section, we will introduce the basics of SignalR and build a simple </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">chat applic</span><a id="_idTextAnchor541"/><span class="koboSpan" id="kobo.74.1">ation.</span></span></p>
<h1 id="_idParaDest-284"><a id="_idTextAnchor542"/><span class="koboSpan" id="kobo.75.1">Setting up SignalR</span></h1>
<p><span class="koboSpan" id="kobo.76.1">In this </span><a id="_idIndexMarker1396"/><span class="koboSpan" id="kobo.77.1">section, we will build a simple chat application using SignalR. </span><span class="koboSpan" id="kobo.77.2">The chat application will allow users to send messages to a public chat room. </span><span class="koboSpan" id="kobo.77.3">The messages will be broadcast to all connected clients. </span><span class="koboSpan" id="kobo.77.4">This application contains </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">four projects:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.79.1">ChatApp.Server</span></strong><span class="koboSpan" id="kobo.80.1">: This is the ASP.NET Core web API project that provides a </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">SignalR hub</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.82.1">ChatApp.TypeScriptClient</span></strong><span class="koboSpan" id="kobo.83.1">: This is a client application written </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">in TypeScript</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.85.1">ChatApp.BlazorClient</span></strong><span class="koboSpan" id="kobo.86.1">: This is a client application written in Blazor, which is a web framework for building client-side </span><a id="_idIndexMarker1397"/><span class="koboSpan" id="kobo.87.1">applications </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">using C#</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.89.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.90.1">The code of this sample is based on the official SignalR sample provided by Microsoft. </span><span class="koboSpan" id="kobo.90.2">You can find the original source code at </span><a href="https://github.com/aspnet/SignalR-samples/tree/main/ChatSample"><span class="koboSpan" id="kobo.91.1">https://github.com/aspnet/SignalR-samples/tree/main/ChatSample</span></a><span class="koboSpan" id="kobo.92.1">. </span><span class="koboSpan" id="kobo.92.2">We added the Blazor and MAUI clients to </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">the sample.</span></span></p>
<p><span class="koboSpan" id="kobo.94.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">ChatApp.Server</span></strong><span class="koboSpan" id="kobo.96.1"> application is a </span><a id="_idIndexMarker1398"/><span class="koboSpan" id="kobo.97.1">simple ASP.NET Core web API application that is used to provide a SignalR hub. </span><span class="koboSpan" id="kobo.97.2">A SignalR hub is a class to manage connections between clients and servers. </span><span class="koboSpan" id="kobo.97.3">It is a high-level abstraction for SignalR real-time communication. </span><span class="koboSpan" id="kobo.97.4">A SignalR hub can be used to send messages to clients and receive messages from clients. </span><span class="koboSpan" id="kobo.97.5">A SignalR hub can also manage users and groups of clients. </span><span class="koboSpan" id="kobo.97.6">In ASP.NET Core SignalR, a hub is defined as a middleware component, so we can easily add it to the ASP.NET </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">Core pipeline.</span></span></p>
<p><span class="koboSpan" id="kobo.99.1">A SignalR hub has a </span><strong class="source-inline"><span class="koboSpan" id="kobo.100.1">Clients</span></strong><span class="koboSpan" id="kobo.101.1"> property to manage connections between the server and the client. </span><span class="koboSpan" id="kobo.101.2">When </span><a id="_idIndexMarker1399"/><span class="koboSpan" id="kobo.102.1">a user connects to the SignalR hub, a new connection</span><a id="_idIndexMarker1400"/><span class="koboSpan" id="kobo.103.1"> is created. </span><span class="koboSpan" id="kobo.103.2">One user can have multiple connections. </span><span class="koboSpan" id="kobo.103.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.104.1">Clients</span></strong><span class="koboSpan" id="kobo.105.1"> property has some methods to </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">manage connections:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.107.1">All</span></strong><span class="koboSpan" id="kobo.108.1"> is used to call a method on all </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">connected clients.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.110.1">Caller</span></strong><span class="koboSpan" id="kobo.111.1"> is used to call a method on </span><span class="No-Break"><span class="koboSpan" id="kobo.112.1">the caller.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.113.1">Others</span></strong><span class="koboSpan" id="kobo.114.1"> is used to call a method on all connected clients except </span><span class="No-Break"><span class="koboSpan" id="kobo.115.1">the caller.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">Client</span></strong><span class="koboSpan" id="kobo.117.1"> is used to call a method on a </span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">specific client.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">Clients</span></strong><span class="koboSpan" id="kobo.120.1"> is used to call a method on specific </span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">connected clients.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">Group</span></strong><span class="koboSpan" id="kobo.123.1"> is used to call a method on a group </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">of clients.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">Groups</span></strong><span class="koboSpan" id="kobo.126.1"> is used to call a method on multiple groups </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">of clients.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.128.1">User</span></strong><span class="koboSpan" id="kobo.129.1"> is used to call a method on a specific user. </span><span class="koboSpan" id="kobo.129.2">Note that one user may have </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">multiple connections.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.131.1">Users</span></strong><span class="koboSpan" id="kobo.132.1"> is used to call a method on specified users, including </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">all connections.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.134.1">AllExcept</span></strong><span class="koboSpan" id="kobo.135.1"> is used to call a method on all connected clients except </span><span class="No-Break"><span class="koboSpan" id="kobo.136.1">specified clients.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.137.1">GroupExcept</span></strong><span class="koboSpan" id="kobo.138.1"> is used to call a method on a group of clients except </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">specified clients.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.140.1">OthersInGroup</span></strong><span class="koboSpan" id="kobo.141.1"> is used to call a method on all clients in a group except </span><span class="No-Break"><span class="koboSpan" id="kobo.142.1">the caller.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.143.1">We will explore some of these methods in the following sections. </span><span class="koboSpan" id="kobo.143.2">You can find the complete code of the sample in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">chapter13/v1</span></strong><span class="koboSpan" id="kobo.145.1"> folder of the </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">GitHub repository.</span></span></p>
<p><span class="koboSpan" id="kobo.147.1">Next, follow</span><a id="_idIndexMarker1401"/><span class="koboSpan" id="kobo.148.1"> these steps to create a new solution and set up a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">ChatApp.Server</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.150.1"> project:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.151.1">Create a new solution called </span><strong class="source-inline"><span class="koboSpan" id="kobo.152.1">ChatApp</span></strong><span class="koboSpan" id="kobo.153.1"> using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.154.1">dotnet new </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">sln</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.156.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.157.1">dotnet new sln -n ChatApp</span></strong></pre></li> <li><span class="koboSpan" id="kobo.158.1">Create a new ASP.NET Core web API project called </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">ChatApp.Server</span></strong><span class="koboSpan" id="kobo.160.1"> using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">dotnet new webapi</span></strong><span class="koboSpan" id="kobo.162.1"> command and add it to </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">the solution:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.164.1">dotnet new webapi -n ChatApp.Server</span></strong><strong class="bold"><span class="koboSpan" id="kobo.165.1">dotnet sln add ChatApp.Server</span></strong></pre></li> <li><span class="koboSpan" id="kobo.166.1">Add the SignalR middleware component to the ASP.NET Core web API pipeline. </span><span class="koboSpan" id="kobo.166.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">Program.cs</span></strong><span class="koboSpan" id="kobo.168.1"> file and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.169.1">following code:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.170.1">builder.Services.AddSignalR();</span></strong></pre></li> <li><span class="koboSpan" id="kobo.171.1">Create a SignalR hub class. </span><span class="koboSpan" id="kobo.171.2">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.172.1">Hubs</span></strong><span class="koboSpan" id="kobo.173.1"> in the project and add a new class </span><span class="No-Break"><span class="koboSpan" id="kobo.174.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">ChatHub</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.177.1">
namespace ChatApp.Server.Hubs;public class ChatHub : Hub{    public Task SendMessage(string user, string message)    {        return Clients.All.SendAsync("ReceiveMessage", username, message);    }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.178.1">The preceding code creates a new SignalR hub class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">ChatHub</span></strong><span class="koboSpan" id="kobo.180.1"> that inherits from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">Hub</span></strong><span class="koboSpan" id="kobo.182.1"> class. </span><span class="koboSpan" id="kobo.182.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.183.1">ChatHub</span></strong><span class="koboSpan" id="kobo.184.1"> class contains a method called </span><strong class="source-inline"><span class="koboSpan" id="kobo.185.1">SendMessage()</span></strong><span class="koboSpan" id="kobo.186.1">, which is used to send a message to all connected clients. </span><span class="koboSpan" id="kobo.186.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">SendMessage()</span></strong><span class="koboSpan" id="kobo.188.1"> method takes two parameters, </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">user</span></strong><span class="koboSpan" id="kobo.190.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">message</span></strong><span class="koboSpan" id="kobo.192.1">, which are used to identify the username and the message. </span><span class="koboSpan" id="kobo.192.2">This method uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">Clients.All.SendAsync()</span></strong><span class="koboSpan" id="kobo.194.1"> method to broadcast the message to all connected clients when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">SendMessage()</span></strong><span class="koboSpan" id="kobo.196.1"> method is invoked by clients. </span><span class="koboSpan" id="kobo.196.2">Note the first parameter of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.197.1">SendAsync()</span></strong><span class="koboSpan" id="kobo.198.1"> method (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">ReceiveMessage()</span></strong><span class="koboSpan" id="kobo.200.1">) is the name of the method for clients to receive </span><span class="No-Break"><span class="koboSpan" id="kobo.201.1">the message.</span></span></p></li> <li><span class="koboSpan" id="kobo.202.1">Next, we</span><a id="_idIndexMarker1402"/><span class="koboSpan" id="kobo.203.1"> need to map the SignalR hub to a URL. </span><span class="koboSpan" id="kobo.203.2">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.205.1"> file:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.206.1">app.MapHub&lt;ChatHub&gt;("/chatHub");</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.207.1">You need to add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">using ChatApp.Server.Hubs;</span></strong><span class="koboSpan" id="kobo.209.1"> statement to the top of </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">the file.</span></span></p></li> <li><span class="koboSpan" id="kobo.211.1">Check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">launchSettings.json</span></strong><span class="koboSpan" id="kobo.213.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.214.1">Properties</span></strong><span class="koboSpan" id="kobo.215.1"> folder. </span><span class="koboSpan" id="kobo.215.2">The default </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">launchSettings.json</span></strong><span class="koboSpan" id="kobo.217.1"> file contains </span><strong class="source-inline"><span class="koboSpan" id="kobo.218.1">http</span></strong><span class="koboSpan" id="kobo.219.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">https</span></strong><span class="koboSpan" id="kobo.221.1"> URLs. </span><span class="koboSpan" id="kobo.221.2">By default, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.222.1">dotnet run</span></strong><span class="koboSpan" id="kobo.223.1"> command will use the first </span><strong class="source-inline"><span class="koboSpan" id="kobo.224.1">http</span></strong><span class="koboSpan" id="kobo.225.1"> profile. </span><span class="koboSpan" id="kobo.225.2">We can specify for the launch profile to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.226.1">https</span></strong><span class="koboSpan" id="kobo.227.1"> URL. </span><span class="koboSpan" id="kobo.227.2">Use the following command to run </span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">the application:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.229.1">dotnet run --launch-profile https</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.230.1">The preceding command will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.231.1">https</span></strong><span class="koboSpan" id="kobo.232.1"> URL to run the application. </span><span class="koboSpan" id="kobo.232.2">Take note of the URL (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">https://localhost:7159</span></strong><span class="koboSpan" id="kobo.234.1">). </span><span class="koboSpan" id="kobo.234.2">We will use it in the </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">next section.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.236.1">The SignalR hub is now ready for use. </span><span class="koboSpan" id="kobo.236.2">To test it, however, a client must install a SignalR client library in order to communicate with the hub. </span><span class="koboSpan" id="kobo.236.3">In the following section, we will construct </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">client </span><a id="_idTextAnchor543"/><span class="koboSpan" id="kobo.238.1">applications.</span></span></p>
<h1 id="_idParaDest-285"><a id="_idTextAnchor544"/><span class="koboSpan" id="kobo.239.1">Building SignalR clients</span></h1>
<p><span class="koboSpan" id="kobo.240.1">This section</span><a id="_idIndexMarker1403"/><span class="koboSpan" id="kobo.241.1"> will demonstrate how to use SignalR in different platforms by building three SignalR clients that consume the same SignalR hub provided by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.242.1">ChatApp.Server</span></strong><span class="koboSpan" id="kobo.243.1"> application. </span><span class="koboSpan" id="kobo.243.2">The code for SignalR is largely the same across platforms, making it easy to learn and implement in your own applications. </span><span class="koboSpan" id="kobo.243.3">As such, you can refer to any of these applications to gain an understanding of how to consume a SignalR service in your </span><span class="No-Break"><span class="koboSpan" id="kobo.244.1">client</span><a id="_idTextAnchor545"/><span class="koboSpan" id="kobo.245.1"> applications.</span></span></p>
<h2 id="_idParaDest-286"><a id="_idTextAnchor546"/><span class="koboSpan" id="kobo.246.1">Building a TypeScript client</span></h2>
<p><span class="koboSpan" id="kobo.247.1">The</span><a id="_idIndexMarker1404"/><span class="koboSpan" id="kobo.248.1"> first client we will build is a TypeScript client. </span><span class="koboSpan" id="kobo.248.2">This application is just a normal HTML page that uses the SignalR JavaScript </span><a id="_idIndexMarker1405"/><span class="koboSpan" id="kobo.249.1">client library to communicate with the SignalR hub. </span><span class="koboSpan" id="kobo.249.2">TypeScript is a superset of JavaScript that provides static typing and other features to help developers write better JavaScript code. </span><span class="koboSpan" id="kobo.249.3">TypeScript code is compiled into JavaScript code, so it can run in any JavaScript runtime, such as browsers and Node.js. </span><span class="koboSpan" id="kobo.249.4">To learn more about TypeScript, you can visit the </span><a id="_idIndexMarker1406"/><span class="koboSpan" id="kobo.250.1">official website </span><span class="No-Break"><span class="koboSpan" id="kobo.251.1">at </span></span><a href="https://www.typescriptlang.org/"><span class="No-Break"><span class="koboSpan" id="kobo.252.1">https://www.typescriptlang.org/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.253.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.254.1">To use TypeScript in the application, we need to install it. </span><span class="koboSpan" id="kobo.254.2">You can do so using the </span><span class="No-Break"><span class="koboSpan" id="kobo.255.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.256.1">
npm install -g typescript</span></pre> <p><span class="koboSpan" id="kobo.257.1">After installing TypeScript, you can use the following command to check </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">the version:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.259.1">
tsc -v</span></pre> <p><span class="koboSpan" id="kobo.260.1">If you see the version number, it means that TypeScript is </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">installed successfully.</span></span></p>
<p><span class="koboSpan" id="kobo.262.1">Next, follow these steps to create a </span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">TypeScript client:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.264.1">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">ChatApp.TypeScriptClient</span></strong><span class="koboSpan" id="kobo.266.1"> in the solution folder. </span><span class="koboSpan" id="kobo.266.2">Then, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">src</span></strong><span class="koboSpan" id="kobo.268.1"> folder in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">ChatApp.TypeScriptClient</span></strong><span class="koboSpan" id="kobo.270.1"> folder. </span><span class="koboSpan" id="kobo.270.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">src</span></strong><span class="koboSpan" id="kobo.272.1"> folder is used to store the source code of the </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">TypeScript client.</span></span></li>
<li><span class="koboSpan" id="kobo.274.1">Create a new file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">index.html</span></strong><span class="koboSpan" id="kobo.276.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">src</span></strong><span class="koboSpan" id="kobo.278.1"> folder and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.280.1">
&lt;!DOCTYPE html&gt;&lt;html lang="en"&gt;&lt;head&gt;    &lt;meta charset="UTF-8"&gt;    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;    &lt;title&gt;Chat App&lt;/title&gt;&lt;/head&gt;&lt;body&gt;    &lt;div id="divChat"&gt;        &lt;label for="txtUsername"&gt;User Name&lt;/label&gt;        &lt;input type="text" id="txtUsername" /&gt;        &lt;label for="txtMessage"&gt;Message&lt;/label&gt;        &lt;input type="text" id="txtMessage" /&gt;        &lt;button id="btnSend"&gt;Send&lt;/button&gt;        &lt;ul id="messages"&gt;&lt;/ul&gt;    &lt;/div&gt;&lt;/body&gt;&lt;/html&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.281.1">The </span><a id="_idIndexMarker1407"/><span class="koboSpan" id="kobo.282.1">preceding code creates a simple HTML </span><a id="_idIndexMarker1408"/><span class="koboSpan" id="kobo.283.1">page that contains a textbox and a button. </span><span class="koboSpan" id="kobo.283.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">ul</span></strong><span class="koboSpan" id="kobo.285.1"> element is used to </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">display messages.</span></span></p></li> <li><span class="koboSpan" id="kobo.287.1">Create a new file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">tsconfig.json</span></strong><span class="koboSpan" id="kobo.289.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">ChatApp.TypeScriptClient</span></strong><span class="koboSpan" id="kobo.291.1"> folder and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.292.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.293.1">
{  "compilerOptions": {    "noEmitOnError": true,    "noImplicitAny": true,    "sourceMap": true,    "target": "es6",    "moduleResolution":"node"  },  "files": ["src/app.ts"],  "compileOnSave": true}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.294.1">The</span><a id="_idIndexMarker1409"/><span class="koboSpan" id="kobo.295.1"> preceding code is the configuration</span><a id="_idIndexMarker1410"/><span class="koboSpan" id="kobo.296.1"> file for the TypeScript compiler. </span><span class="koboSpan" id="kobo.296.2">It specifies the target version of JavaScript, the module system, and other options. </span><span class="koboSpan" id="kobo.296.3">It also specifies the TypeScript files to compile, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.297.1">app.ts</span></strong><span class="koboSpan" id="kobo.298.1">. </span><span class="koboSpan" id="kobo.298.2">We will create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">app.ts</span></strong><span class="koboSpan" id="kobo.300.1"> file in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.301.1">step 6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.303.1">Next, we need to set up </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">npm</span></strong><span class="koboSpan" id="kobo.305.1"> so that we can install the required packages. </span><span class="koboSpan" id="kobo.305.2">Use the following command to </span><span class="No-Break"><span class="koboSpan" id="kobo.306.1">initialize </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">npm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.308.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.309.1">npm init -y</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.310.1">This command creates a </span><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">package.json</span></strong><span class="koboSpan" id="kobo.312.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">ChatApp.TypeScriptClient</span></strong><span class="koboSpan" id="kobo.314.1"> folder. </span><span class="koboSpan" id="kobo.314.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">package.json</span></strong><span class="koboSpan" id="kobo.316.1"> file is used to manage the dependencies of the project. </span><span class="koboSpan" id="kobo.316.2">It also contains other information about the project, such as the name, version, description, and </span><span class="No-Break"><span class="koboSpan" id="kobo.317.1">so on.</span></span></p></li> <li><span class="koboSpan" id="kobo.318.1">Next, we need to install the required packages. </span><span class="koboSpan" id="kobo.318.2">Use the following command to install the </span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">required packages:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.320.1">npm install @microsoft/signalr @types/node</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.321.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">@microsoft/signalr</span></strong><span class="koboSpan" id="kobo.323.1"> package is the official SignalR JavaScript client library. </span><span class="koboSpan" id="kobo.323.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">@types/node</span></strong><span class="koboSpan" id="kobo.325.1"> package is used to provide type definitions </span><span class="No-Break"><span class="koboSpan" id="kobo.326.1">for Node.js.</span></span></p></li> <li><span class="koboSpan" id="kobo.327.1">Create a new</span><a id="_idIndexMarker1411"/><span class="koboSpan" id="kobo.328.1"> file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.329.1">app.ts</span></strong><span class="koboSpan" id="kobo.330.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">src</span></strong><span class="koboSpan" id="kobo.332.1"> folder and </span><a id="_idIndexMarker1412"/><span class="koboSpan" id="kobo.333.1">add the </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.335.1">
import * as signalR from "@microsoft/signalr";const txtUsername: HTMLInputElement = document.getElementById(  "txtUsername") as HTMLInputElement;const txtMessage: HTMLInputElement = document.getElementById(  "txtMessage") as HTMLInputElement;const btnSend: HTMLButtonElement = document.getElementById(  "btnSend") as HTMLButtonElement;btnSend.disabled = true;const connection = new signalR.HubConnectionBuilder()  .withUrl("https://localhost:7159/chatHub")  .build();connection.on("ReceiveMessage", (username: string, message: string) =&gt; {  const li = document.createElement("li");  li.textContent = `${username}: ${message}`;  const messageList = document.getElementById("messages");  messageList.appendChild(li);  messageList.scrollTop = messageList.scrollHeight;});connection  .start()  .then(() =&gt; (btnSend.disabled = false))  .catch((err) =&gt; console.error(err.toString()));txtMessage.addEventListener("keyup", (event) =&gt; {  if (event.key === "Enter") {    sendMessage();  }});btnSend.addEventListener("click", sendMessage);function sendMessage() {  connection    .invoke("SendMessage", txtUsername.value, txtMessage.value)    .catch((err) =&gt; console.error(err.toString()))    .then(() =&gt; (txtMessage.value = ""));}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.336.1">The preceding code creates a SignalR connection to the SignalR hub. </span><span class="koboSpan" id="kobo.336.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">connection</span></strong><span class="koboSpan" id="kobo.338.1"> object is used to send messages to the SignalR hub and receive messages from the SignalR hub. </span><span class="koboSpan" id="kobo.338.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">withURL()</span></strong><span class="koboSpan" id="kobo.340.1"> method is used to specify the URL of the SignalR hub. </span><span class="koboSpan" id="kobo.340.2">In this case, we use </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">https://localhost:7159/chatHub</span></strong><span class="koboSpan" id="kobo.342.1"> as the URL. </span><span class="koboSpan" id="kobo.342.2">If your SignalR hub is hosted on a different URL, you need to change </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">it accordingly.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.344.1">When</span><a id="_idIndexMarker1413"/><span class="koboSpan" id="kobo.345.1"> the page is loaded, the </span><strong class="bold"><span class="koboSpan" id="kobo.346.1">Send</span></strong><span class="koboSpan" id="kobo.347.1"> button is</span><a id="_idIndexMarker1414"/><span class="koboSpan" id="kobo.348.1"> disabled, then it will be enabled when the connection is established. </span><span class="koboSpan" id="kobo.348.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">connection</span></strong><span class="koboSpan" id="kobo.350.1"> object has a couple of methods used in </span><span class="No-Break"><span class="koboSpan" id="kobo.351.1">this sample:</span></span></p><ul><li><strong class="bold"><span class="koboSpan" id="kobo.352.1">The start method</span></strong><span class="koboSpan" id="kobo.353.1">: This</span><a id="_idIndexMarker1415"/><span class="koboSpan" id="kobo.354.1"> is used to start </span><span class="No-Break"><span class="koboSpan" id="kobo.355.1">the connection.</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.356.1">The on method</span></strong><span class="koboSpan" id="kobo.357.1">: This</span><a id="_idIndexMarker1416"/><span class="koboSpan" id="kobo.358.1"> method is used to receive messages from the SignalR hub. </span><span class="koboSpan" id="kobo.358.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.359.1">on()</span></strong><span class="koboSpan" id="kobo.360.1"> method takes two parameters: the first parameter is the name of the method, which is </span><strong class="source-inline"><span class="koboSpan" id="kobo.361.1">RecieveMessage()</span></strong><span class="koboSpan" id="kobo.362.1">, as we defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">ChatHub</span></strong><span class="koboSpan" id="kobo.364.1"> class, and the second parameter is a callback function that is called when the message </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">is received.</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.366.1">The invoke method</span></strong><span class="koboSpan" id="kobo.367.1">: The </span><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">invoke()</span></strong><span class="koboSpan" id="kobo.369.1"> method is called when the user clicks the </span><strong class="bold"><span class="koboSpan" id="kobo.370.1">Send</span></strong><span class="koboSpan" id="kobo.371.1"> button</span><a id="_idIndexMarker1417"/><span class="koboSpan" id="kobo.372.1"> or presses the </span><em class="italic"><span class="koboSpan" id="kobo.373.1">Enter</span></em><span class="koboSpan" id="kobo.374.1"> key. </span><span class="koboSpan" id="kobo.374.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">invoke()</span></strong><span class="koboSpan" id="kobo.376.1"> method takes three parameters: the first parameter is the name of the method we want to invoke on the SignalR hub, which is </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">SendMessage()</span></strong><span class="koboSpan" id="kobo.378.1">, as we defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">ChatHub</span></strong><span class="koboSpan" id="kobo.380.1"> class, the second parameter is the username, and the third parameter is </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">the message.</span></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.382.1">Make sure to use the correct method names. </span><span class="koboSpan" id="kobo.382.2">Otherwise, the client will not be able to communicate with the </span><span class="No-Break"><span class="koboSpan" id="kobo.383.1">SignalR hub.</span></span></p></li> <li><span class="koboSpan" id="kobo.384.1">Next, we need to compile the TypeScript code to JavaScript code. </span><span class="koboSpan" id="kobo.384.2">We will use Gulp to automate the compilation process. </span><span class="koboSpan" id="kobo.384.3">If you prefer to use other tools, such as Webpack, you can use them as well. </span><span class="koboSpan" id="kobo.384.4">Use the following command to install </span><span class="No-Break"><span class="koboSpan" id="kobo.385.1">Gulp globally:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.386.1">npm install -g gulp</span></strong></pre></li> <li><span class="koboSpan" id="kobo.387.1">Install </span><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">gulp</span></strong><span class="koboSpan" id="kobo.389.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">gulp-typescript</span></strong><span class="koboSpan" id="kobo.391.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.392.1">the project:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.393.1">npm install --save-dev gulp gulp-typescript browserify vinyl-source-stream vinyl-buffer gulp-sourcemaps tsify</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.394.1">These packages </span><a id="_idIndexMarker1418"/><span class="koboSpan" id="kobo.395.1">are used to compile the TypeScript code to JavaScript code, generate a bundle file, and generate source map files. </span><span class="koboSpan" id="kobo.395.2">The bundle file is used to load the SignalR JavaScript client library so that the client can use it to communicate with the SignalR hub. </span><span class="koboSpan" id="kobo.395.3">The source map files are used to map the JavaScript </span><a id="_idIndexMarker1419"/><span class="koboSpan" id="kobo.396.1">code to the original TypeScript code. </span><span class="koboSpan" id="kobo.396.2">This is useful when debugging the application. </span><span class="koboSpan" id="kobo.396.3">We will not cover the details of frontend development in this chapter as the focus of this chapter is SignalR. </span><span class="koboSpan" id="kobo.396.4">If you want to learn more about these packages, you can visit the official websites of </span><span class="No-Break"><span class="koboSpan" id="kobo.397.1">these packages.</span></span></p></li> <li><span class="koboSpan" id="kobo.398.1">Create a new file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.399.1">gulpfile.js</span></strong><span class="koboSpan" id="kobo.400.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">ChatApp.TypeScriptClient</span></strong><span class="koboSpan" id="kobo.402.1"> folder and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.403.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.404.1">
const gulp = require('gulp');const browserify = require('browserify');const source = require('vinyl-source-stream');const buffer = require('vinyl-buffer');const sourcemaps = require('gulp-sourcemaps');const tsify = require('tsify');// Bundle TypeScript with SignalRgulp.task('bundle', () =&gt; {  return browserify({    basedir: '.',    debug: true,    entries: ['src/app.ts'], // Replace with your TypeScript entry file    cache: {},    packageCache: {},  })    .plugin(tsify)    .bundle()    .pipe(source('bundle.js'))    .pipe(buffer())    .pipe(sourcemaps.init({ loadMaps: true }))    .pipe(sourcemaps.write('./'))    .pipe(gulp.dest('dist'));});// Copy HTMLgulp.task('copy-html', () =&gt; {  return gulp.src('src/**/*.html')    .pipe(gulp.dest('dist'));});// Main build taskgulp.task('default', gulp.series('bundle', 'copy-html'));</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.405.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">gulp</span></strong><span class="koboSpan" id="kobo.407.1"> configuration file defines some tasks that are used to compile TypeScript code to JavaScript and generate a bundle file. </span><span class="koboSpan" id="kobo.407.2">Additionally, it copies HTML files to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">dist</span></strong><span class="koboSpan" id="kobo.409.1"> folder, which is used to store the compiled JavaScript code and HTML files. </span><span class="koboSpan" id="kobo.409.2">If desired, the folder name can be changed. </span><span class="koboSpan" id="kobo.409.3">The bundle file loads the SignalR JavaScript client library </span><a id="_idIndexMarker1420"/><span class="koboSpan" id="kobo.410.1">and the compiled </span><span class="No-Break"><span class="koboSpan" id="kobo.411.1">JavaScript code.</span></span></p></li> <li><span class="koboSpan" id="kobo.412.1">Add a</span><a id="_idIndexMarker1421"/><span class="koboSpan" id="kobo.413.1"> script to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">package.json</span></strong><span class="koboSpan" id="kobo.415.1"> file to run </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">gulp</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.417.1"> tasks:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.418.1">
"scripts": {  "gulp": "gulp"}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.419.1"> The complete </span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">package.json</span></strong><span class="koboSpan" id="kobo.421.1"> file should look </span><span class="No-Break"><span class="koboSpan" id="kobo.422.1">like this:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.423.1">{  "name": "chatapp.typescriptclient",  "version": "1.0.0",  "description": "",  "main": "index.js",  "scripts": {    "gulp": "gulp"  },  "keywords": [],  "author": "",  "license": "ISC",  "dependencies": {    "@microsoft/signalr": "^8.0.0",    "@types/node": "^20.9.0"  },  "devDependencies": {    "@microsoft/signalr": "^8.0.0",    "browserify": "^17.0.0",    "gulp": "^4.0.2",    "gulp-sourcemaps": "^3.0.0",    "gulp-typescript": "^6.0.0-alpha.1",    "tsify": "^5.0.4",    "vinyl-buffer": "^1.0.1",    "vinyl-source-stream": "^2.0.0"  }}</span></pre></li> <li><span class="koboSpan" id="kobo.424.1">Next, update </span><a id="_idIndexMarker1422"/><span class="koboSpan" id="kobo.425.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">index.html</span></strong><span class="koboSpan" id="kobo.427.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">src</span></strong><span class="koboSpan" id="kobo.429.1"> folder to load the </span><span class="No-Break"><span class="koboSpan" id="kobo.430.1">bundle file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.431.1">
&lt;!-- Omitted --&gt;    &lt;script src="bundle.js"&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.432.1">Run the</span><a id="_idIndexMarker1423"/><span class="koboSpan" id="kobo.433.1"> following command to compile the TypeScript code and copy the HTML files to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">dist</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.435.1"> folder:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.436.1">npm run gulp</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.437.1">This command will compile the TypeScript code and generate a bundle file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.438.1">dist</span></strong><span class="koboSpan" id="kobo.439.1"> folder. </span><span class="koboSpan" id="kobo.439.2">It will also copy the HTML files to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.440.1">dist</span></strong><span class="koboSpan" id="kobo.441.1"> folder. </span><span class="koboSpan" id="kobo.441.2">If the command is executed successfully, you should see three files in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">dist</span></strong><span class="koboSpan" id="kobo.443.1"> folder: </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">bundle.js</span></strong><span class="koboSpan" id="kobo.445.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">bundle.js.map</span></strong><span class="koboSpan" id="kobo.447.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">index.html</span></strong><span class="koboSpan" id="kobo.449.1">. </span><span class="koboSpan" id="kobo.449.2">In the next sections, if you make any changes to the TypeScript code, you need to run this command again to compile the </span><span class="No-Break"><span class="koboSpan" id="kobo.450.1">TypeScript code.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.451.1">The </span><a id="_idIndexMarker1424"/><span class="koboSpan" id="kobo.452.1">development of the TypeScript client is now complete. </span><span class="koboSpan" id="kobo.452.2">To test it, we need to run a web server to host the HTML page. </span><span class="koboSpan" id="kobo.452.3">VS Code has some extensions that can be used to run a web server. </span><span class="koboSpan" id="kobo.452.4">For example, you can use the </span><strong class="bold"><span class="koboSpan" id="kobo.453.1">Live Preview</span></strong><span class="koboSpan" id="kobo.454.1"> extension. </span><span class="koboSpan" id="kobo.454.2">Once you install this extension, you can right-click the </span><strong class="source-inline"><span class="koboSpan" id="kobo.455.1">index.html</span></strong><span class="koboSpan" id="kobo.456.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.457.1">dist</span></strong><span class="koboSpan" id="kobo.458.1"> folder and select the </span><strong class="bold"><span class="koboSpan" id="kobo.459.1">Show Preview</span></strong><span class="koboSpan" id="kobo.460.1"> menu to run the web server. </span><span class="koboSpan" id="kobo.460.2">You</span><a id="_idIndexMarker1425"/><span class="koboSpan" id="kobo.461.1"> will see VS Code opens a new tab and displays the HTML page, as </span><span class="No-Break"><span class="koboSpan" id="kobo.462.1">shown next:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer095">
<span class="koboSpan" id="kobo.463.1"><img alt="Figure 13.1 – Running the TypeScript client in VS Code" src="image/B18971_13_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.464.1">Figure 13.1 – Running the TypeScript client in VS Code</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.465.1">You can also try some other tools, such </span><span class="No-Break"><span class="koboSpan" id="kobo.466.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.467.1">http-server</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.468.1">.</span></span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.469.1">Now, start the SignalR server by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.470.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.471.1">dotnet run --launch-profile https</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.472.1">Copy the URL of the HTML page and open it in a browser. </span><span class="koboSpan" id="kobo.472.2">The default URL of the </span><strong class="bold"><span class="koboSpan" id="kobo.473.1">Live Preview</span></strong><span class="koboSpan" id="kobo.474.1"> web server is </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">http://127.0.0.1:3000</span></strong><span class="koboSpan" id="kobo.476.1">. </span><span class="koboSpan" id="kobo.476.2">However, you may find that the </span><strong class="bold"><span class="koboSpan" id="kobo.477.1">Send</span></strong><span class="koboSpan" id="kobo.478.1"> button is disabled. </span><span class="koboSpan" id="kobo.478.2">Press the </span><em class="italic"><span class="koboSpan" id="kobo.479.1">F12</span></em><span class="koboSpan" id="kobo.480.1"> key to open the developer tools and check the console. </span><span class="koboSpan" id="kobo.480.2">You should see an error message, as </span><span class="No-Break"><span class="koboSpan" id="kobo.481.1">shown next:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.482.1">Access to fetch at 'https://localhost:7159/chatHub/negotiate?negotiateVersion=1' from origin 'http://127.0.0.1:3000' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource. </span><span class="koboSpan" id="kobo.482.2">If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.483.1">This</span><a id="_idIndexMarker1426"/><span class="koboSpan" id="kobo.484.1"> error message indicates that the client cannot connect to the SignalR hub because of the </span><strong class="bold"><span class="koboSpan" id="kobo.485.1">cross-origin resource sharing</span></strong><span class="koboSpan" id="kobo.486.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.487.1">CORS</span></strong><span class="koboSpan" id="kobo.488.1">) policy. </span><span class="koboSpan" id="kobo.488.2">If</span><a id="_idIndexMarker1427"/><span class="koboSpan" id="kobo.489.1"> a web page makes requests to a different domain, this request is a cross-origin request. </span><span class="koboSpan" id="kobo.489.2">The browser will block cross-origin requests by default. </span><span class="koboSpan" id="kobo.489.3">This is a security feature called the</span><a id="_idIndexMarker1428"/><span class="koboSpan" id="kobo.490.1"> same-origin policy. </span><span class="koboSpan" id="kobo.490.2">This</span><a id="_idIndexMarker1429"/><span class="koboSpan" id="kobo.491.1"> can help prevent </span><strong class="bold"><span class="koboSpan" id="kobo.492.1">cross-site scripting</span></strong><span class="koboSpan" id="kobo.493.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.494.1">XSS</span></strong><span class="koboSpan" id="kobo.495.1">) attacks. </span><span class="koboSpan" id="kobo.495.2">In this case, the URL of the client is different from the URL of the SignalR hub, so the browser will block the request </span><span class="No-Break"><span class="koboSpan" id="kobo.496.1">by default.</span></span></p></li> <li><span class="koboSpan" id="kobo.497.1">To allow </span><a id="_idIndexMarker1430"/><span class="koboSpan" id="kobo.498.1">cross-origin requests, we need to add the CORS middleware component to the web API application. </span><span class="koboSpan" id="kobo.498.2">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.499.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.500.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.501.1">
// Enable CORSvar corsPolicy = new CorsPolicyBuilder()    .AllowAnyHeader()    .AllowAnyMethod()    .AllowCredentials()    .WithOrigins("http://127.0.0.1:3000")    .Build();builder.Services.AddCors(options =&gt;{    options.AddPolicy("CorsPolicy", corsPolicy);});</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.502.1">The preceding code allows cross-origin requests from </span><strong class="source-inline"><span class="koboSpan" id="kobo.503.1">http://127.0.0.1:3000</span></strong><span class="koboSpan" id="kobo.504.1">, which is the URL of the </span><strong class="bold"><span class="koboSpan" id="kobo.505.1">Live Preview</span></strong><span class="koboSpan" id="kobo.506.1"> web server. </span><span class="koboSpan" id="kobo.506.2">You can change it to the URL of your web server if you are using a different web server. </span><span class="koboSpan" id="kobo.506.3">Note that this example is a very basic configuration that does not </span><a id="_idIndexMarker1431"/><span class="koboSpan" id="kobo.507.1">restrict any HTTP headers or HTTP methods. </span><span class="koboSpan" id="kobo.507.2">In a real-world application, you may need to restrict HTTP requests to improve the security of the application. </span><span class="koboSpan" id="kobo.507.3">For more details about CORS, you can refer to the official documentation </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">at </span></span><a href="https://learn.microsoft.com/en-us/aspnet/core/security/cors"><span class="No-Break"><span class="koboSpan" id="kobo.509.1">https://learn.microsoft.com/en-us/aspnet/core/security/cors</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.510.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.511.1">Restart</span><a id="_idIndexMarker1432"/><span class="koboSpan" id="kobo.512.1"> the SignalR server and refresh the web page. </span><span class="koboSpan" id="kobo.512.2">You should see the </span><strong class="bold"><span class="koboSpan" id="kobo.513.1">Send</span></strong><span class="koboSpan" id="kobo.514.1"> button is enabled. </span><span class="koboSpan" id="kobo.514.2">Enter a username and a message and click the </span><strong class="bold"><span class="koboSpan" id="kobo.515.1">Send</span></strong><span class="koboSpan" id="kobo.516.1"> button. </span><span class="koboSpan" id="kobo.516.2">You should see the message displayed in a list, as </span><span class="No-Break"><span class="koboSpan" id="kobo.517.1">shown next:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer096">
<span class="koboSpan" id="kobo.518.1"><img alt="Figure 13.2 – Sending a message from the TypeScript client" src="image/B18971_13_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.519.1">Figure 13.2 – Sending a message from the TypeScript client</span></p>
<ol>
<li value="16"><span class="koboSpan" id="kobo.520.1">Open another browser tab and enter the same URL. </span><span class="koboSpan" id="kobo.520.2">Enter a different username and a message and click the </span><strong class="bold"><span class="koboSpan" id="kobo.521.1">Send</span></strong><span class="koboSpan" id="kobo.522.1"> button. </span><span class="koboSpan" id="kobo.522.2">You should see the message displayed in both browser tabs, as </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">shown next:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer097">
<span class="koboSpan" id="kobo.524.1"><img alt="Figure 13.3 – Sending a message from another browser tab" src="image/B18971_13_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.525.1">Figure 13.3 – Sending a message from another browser tab</span></p>
<p><span class="koboSpan" id="kobo.526.1">The TypeScript client is now complete. </span><span class="koboSpan" id="kobo.526.2">This is a very simple client that does not use any JavaScript frameworks. </span><span class="koboSpan" id="kobo.526.3">The world of frontend development is changing rapidly. </span><span class="koboSpan" id="kobo.526.4">If you encounter any issues when testing the sample code, you can use any other JavaScript frameworks you like, such as React, Angular, or Vue.js. </span><span class="koboSpan" id="kobo.526.5">The code for SignalR is largely the s</span><a id="_idTextAnchor547"/><span class="koboSpan" id="kobo.527.1">ame for different </span><span class="No-Break"><span class="koboSpan" id="kobo.528.1">JavaScript frameworks.</span></span></p>
<h2 id="_idParaDest-287"><a id="_idTextAnchor548"/><span class="koboSpan" id="kobo.529.1">Building a Blazor client</span></h2>
<p><span class="koboSpan" id="kobo.530.1">The </span><a id="_idIndexMarker1433"/><span class="koboSpan" id="kobo.531.1">second client we will build is a Blazor client. </span><span class="koboSpan" id="kobo.531.2">Blazor is a </span><a id="_idIndexMarker1434"/><span class="koboSpan" id="kobo.532.1">web framework for building client-side applications using C#. </span><span class="koboSpan" id="kobo.532.2">Blazor was first introduced as a part of ASP.NET Core 3.0 in 2018. </span><span class="koboSpan" id="kobo.532.3">Blazor supports different </span><span class="No-Break"><span class="koboSpan" id="kobo.533.1">hosting models:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.534.1">Blazor Server</span></strong><span class="koboSpan" id="kobo.535.1">: In</span><a id="_idIndexMarker1435"/><span class="koboSpan" id="kobo.536.1"> this hosting model, the Blazor application is hosted on an ASP.NET Core server. </span><span class="koboSpan" id="kobo.536.2">Remote clients connect to the server using SignalR. </span><span class="koboSpan" id="kobo.536.3">The server is responsible for handling user interactions and updating the UI over a SignalR connection. </span><span class="koboSpan" id="kobo.536.4">The application can use the full power of the .NET ecosystem and all ASP.NET Core features. </span><span class="koboSpan" id="kobo.536.5">This hosting model also allows the client to download a small amount of code, meaning the application loads fast, but it requires a persistent connection to the server. </span><span class="koboSpan" id="kobo.536.6">If the SignalR connection is lost, the application will </span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">not work.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.538.1">Blazor WebAssembly</span></strong><span class="koboSpan" id="kobo.539.1">: This</span><a id="_idIndexMarker1436"/><span class="koboSpan" id="kobo.540.1"> hosting model runs the Blazor application on a WebAssembly .NET runtime in the browser. </span><span class="koboSpan" id="kobo.540.2">The Blazor application is downloaded to the client, which means that this model requires a larger download size than the Blazor Server model. </span><span class="koboSpan" id="kobo.540.3">When a Blazor WebAssembly application is hosted within an ASP.NET Core application, it is called </span><em class="italic"><span class="koboSpan" id="kobo.541.1">hosted Blazor WebAssembly</span></em><span class="koboSpan" id="kobo.542.1">. </span><span class="koboSpan" id="kobo.542.2">The hosted Blazor WebAssembly application can share code with the ASP.NET Core application. </span><span class="koboSpan" id="kobo.542.3">When a Blazor WebAssembly application is hosted in a static website without server-side code, it is called </span><em class="italic"><span class="koboSpan" id="kobo.543.1">standalone Blazor WebAssembly</span></em><span class="koboSpan" id="kobo.544.1">. </span><span class="koboSpan" id="kobo.544.2">A standalone Blazor WebAssembly application acts like a pure client-side application, such as a React application, so it can be </span><a id="_idIndexMarker1437"/><span class="koboSpan" id="kobo.545.1">hosted on any web server</span><a id="_idIndexMarker1438"/><span class="koboSpan" id="kobo.546.1"> or a </span><strong class="bold"><span class="koboSpan" id="kobo.547.1">content delivery network</span></strong><span class="koboSpan" id="kobo.548.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.549.1">CDN</span></strong><span class="koboSpan" id="kobo.550.1">). </span><span class="koboSpan" id="kobo.550.2">Blazor WebAssembly applications can work offline, but the performance depends on the </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">client’s hardware.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.552.1">Blazor Hybrid</span></strong><span class="koboSpan" id="kobo.553.1">: This </span><a id="_idIndexMarker1439"/><span class="koboSpan" id="kobo.554.1">model allows a Blazor application to</span><a id="_idIndexMarker1440"/><span class="koboSpan" id="kobo.555.1"> run in a .NET native app framework, such as WPF, Windows Forms, and MAUI. </span><span class="koboSpan" id="kobo.555.2">This model combines the power of the web and native applications, and it can use the full power of the .NET platform. </span><span class="koboSpan" id="kobo.555.3">It is suitable for building cross-platform applications because the Blazor code can be shared across different platforms. </span><span class="koboSpan" id="kobo.555.4">However, it is still required to package the application for </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">different platforms.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.557.1">In this sample application, we will use standalone Blazor WebAssembly to build the client application because a web-based application is one of the most seen scenarios. </span><span class="koboSpan" id="kobo.557.2">But it is also possible to use similar code for other hosting models. </span><span class="koboSpan" id="kobo.557.3">ASP.NET Core 8 brings some improvements to Blazor. </span><span class="koboSpan" id="kobo.557.4">To learn more about Blazor, you can visit the official website </span><span class="No-Break"><span class="koboSpan" id="kobo.558.1">at </span></span><a href="https://learn.microsoft.com/en-us/aspnet/core/blazor/"><span class="No-Break"><span class="koboSpan" id="kobo.559.1">https://learn.microsoft.com/en-us/aspnet/core/blazor/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.560.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.561.1">To create a </span><a id="_idIndexMarker1441"/><span class="koboSpan" id="kobo.562.1">Blazor WebAssembly application, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.563.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.564.1">Navigate to the root folder of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">ChatApp.sln</span></strong><span class="koboSpan" id="kobo.566.1"> solution. </span><span class="koboSpan" id="kobo.566.2">Create a new Blazor WebAssembly application called </span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">ChatApp.BlazorClient</span></strong><span class="koboSpan" id="kobo.568.1"> and add the project to the solution using the </span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.570.1">dotnet new blazorwasm -n ChatApp.BlazorClient</span></strong><strong class="bold"><span class="koboSpan" id="kobo.571.1">dotnet sln add ChatApp.BlazorClient</span></strong></pre></li> <li><span class="koboSpan" id="kobo.572.1">Navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">ChatApp.BlazorClient</span></strong><span class="koboSpan" id="kobo.574.1"> folder and run the following command to install the SignalR </span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">client library:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.576.1">dotnet add package Microsoft.AspNetCore.SignalR.Client</span></strong></pre></li> <li><span class="koboSpan" id="kobo.577.1">Add the following code after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">page</span></strong><span class="koboSpan" id="kobo.579.1"> directive in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.580.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">Components/Pages/Home.razor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.582.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.583.1">
@using Microsoft.AspNetCore.SignalR.Client@implements IAsyncDisposable</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.584.1">This </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">using</span></strong><span class="koboSpan" id="kobo.586.1"> statement imports the SignalR client library to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">Home</span></strong><span class="koboSpan" id="kobo.588.1"> component. </span><span class="koboSpan" id="kobo.588.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">implements IAsyncDisposable</span></strong><span class="koboSpan" id="kobo.590.1"> statement indicates that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">Home</span></strong><span class="koboSpan" id="kobo.592.1"> component implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.593.1">IAsyncDisposable</span></strong><span class="koboSpan" id="kobo.594.1"> interface. </span><span class="koboSpan" id="kobo.594.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">IAsyncDisposable</span></strong><span class="koboSpan" id="kobo.596.1"> interface is used to dispose of resources asynchronously. </span><span class="koboSpan" id="kobo.596.2">We </span><a id="_idIndexMarker1442"/><span class="koboSpan" id="kobo.597.1">will use it to dispose of the SignalR connection when the component is no longer </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">in use.</span></span></p></li> <li><span class="koboSpan" id="kobo.599.1">Add the</span><a id="_idIndexMarker1443"/><span class="koboSpan" id="kobo.600.1"> following code to the end of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.601.1">Home.razor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.602.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.603.1">
@code {    private HubConnection? </span><span class="koboSpan" id="kobo.603.2">_hubConnection;    private readonly List&lt;string&gt; _messages = new ();    private string? </span><span class="koboSpan" id="kobo.603.3">_username;    private string? </span><span class="koboSpan" id="kobo.603.4">_message;    private bool IsConnected =&gt; _hubConnection?.State == HubConnectionState.Connected;    protected override async Task OnInitializedAsync()    {        _hubConnection = new HubConnectionBuilder()        .WithUrl("https://localhost:7159/chatHub")        .Build();        _hubConnection.On&lt;string, string&gt;("ReceiveMessage", (username, message) =&gt;        {            var encodedMessage = $"{username}: {message}";            _messages.Add(encodedMessage);            StateHasChanged();        });        await _hubConnection.StartAsync();    }    private async Task SendMessage()    {        if (_hubConnection != null &amp;&amp; IsConnected)        {            await _hubConnection!.InvokeAsync("SendMessage", _username, _message);            _message = string.Empty;        }    }    public async ValueTask DisposeAsync()    {        if (_hubConnection is not null)        {            await _hubConnection.DisposeAsync();        }    }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.604.1">Blazor utilizes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.605.1">@code</span></strong><span class="koboSpan" id="kobo.606.1"> directive to incorporate C# code into components. </span><span class="koboSpan" id="kobo.606.2">In this instance, we</span><a id="_idIndexMarker1444"/><span class="koboSpan" id="kobo.607.1"> have defined a few fields and methods for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.608.1">Home</span></strong><span class="koboSpan" id="kobo.609.1"> component. </span><span class="koboSpan" id="kobo.609.2">If you compare this code to its TypeScript counterpart, you will find that the logic is very similar. </span><span class="koboSpan" id="kobo.609.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.610.1">OnInitializedAsync()</span></strong><span class="koboSpan" id="kobo.611.1"> method</span><a id="_idIndexMarker1445"/><span class="koboSpan" id="kobo.612.1"> is used to set up a SignalR connection, while the </span><strong class="source-inline"><span class="koboSpan" id="kobo.613.1">SendMessage()</span></strong><span class="koboSpan" id="kobo.614.1"> method is used to invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.615.1">SendMessage()</span></strong><span class="koboSpan" id="kobo.616.1"> method of the SignalR hub to send a message. </span><span class="koboSpan" id="kobo.616.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.617.1">DisposeAsync()</span></strong><span class="koboSpan" id="kobo.618.1"> method is used to dispose of the SignalR connection when the component is no longer in use. </span><span class="koboSpan" id="kobo.618.2">Additionally, the </span><strong class="bold"><span class="koboSpan" id="kobo.619.1">Send</span></strong><span class="koboSpan" id="kobo.620.1"> button is enabled when a SignalR connection is established. </span><span class="koboSpan" id="kobo.620.2">Lastly, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">StateHasChanged()</span></strong><span class="koboSpan" id="kobo.622.1"> method is used to notify the component to re-render </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">the UI.</span></span></p></li> <li><span class="koboSpan" id="kobo.624.1">Next, we need to bind these fields to the UI. </span><span class="koboSpan" id="kobo.624.2">Add the following code before the </span><strong class="source-inline"><span class="koboSpan" id="kobo.625.1">@</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.626.1">code</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.627.1"> directive:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.628.1">
&lt;div id="username-group"&gt;    &lt;label&gt;User Name&lt;/label&gt;    &lt;input type="text" @bind="_username" /&gt;&lt;/div&gt;&lt;div id="message-group"&gt;    &lt;label&gt;Message&lt;/label&gt;    &lt;input type="text" @bind="_message" /&gt;&lt;/div&gt;&lt;input type="button" value="Send" @onclick="SendMessage" disabled="@(!IsConnected)" /&gt;&lt;ul&gt;    @foreach (var message in _messages)    {        &lt;li&gt;@message&lt;/li&gt;    }&lt;/ul&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.629.1">Blazor</span><a id="_idIndexMarker1446"/><span class="koboSpan" id="kobo.630.1"> uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.631.1">@</span></strong><span class="koboSpan" id="kobo.632.1"> symbol to indicate a C# expression. </span><span class="koboSpan" id="kobo.632.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">@bind</span></strong><span class="koboSpan" id="kobo.634.1"> directive is used to bind the value of the input element to the specified field. </span><span class="koboSpan" id="kobo.634.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.635.1">@onclick</span></strong><span class="koboSpan" id="kobo.636.1"> directive is used to bind the click event to the specified method. </span><span class="koboSpan" id="kobo.636.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.637.1">@foreach</span></strong><span class="koboSpan" id="kobo.638.1"> directive is used to iterate over the messages</span><a id="_idIndexMarker1447"/><span class="koboSpan" id="kobo.639.1"> and display them in a list. </span><span class="koboSpan" id="kobo.639.2">If you are familiar with any modern JavaScript frameworks, such as React, Angular, or Vue.js, you will find some similarities between Blazor and </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">these frameworks.</span></span></p></li> <li><span class="koboSpan" id="kobo.641.1">Next, we need to configure the CORS policy for the SignalR server so that the Blazor client can connect to the SignalR hub. </span><span class="koboSpan" id="kobo.641.2">Check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.642.1">launchSettings.json</span></strong><span class="koboSpan" id="kobo.643.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.644.1">Properties</span></strong><span class="koboSpan" id="kobo.645.1"> folder. </span><span class="koboSpan" id="kobo.645.2">Similar to the SignalR server application, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.646.1">http</span></strong><span class="koboSpan" id="kobo.647.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.648.1">https</span></strong><span class="koboSpan" id="kobo.649.1"> profile to run the Blazor client application. </span><span class="koboSpan" id="kobo.649.2">We will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">https</span></strong><span class="koboSpan" id="kobo.651.1"> file in this case. </span><span class="koboSpan" id="kobo.651.2">For example, the URL of the sample code uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.652.1">https://localhost:7093</span></strong><span class="koboSpan" id="kobo.653.1"> to run the Blazor client application on the HTTPS profile. </span><span class="koboSpan" id="kobo.653.2">We need to update the CORS policy in the SignalR server. </span><span class="koboSpan" id="kobo.653.3">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">Program.cs</span></strong><span class="koboSpan" id="kobo.655.1"> file of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.656.1">ChatApp.Server</span></strong><span class="koboSpan" id="kobo.657.1"> project, as </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">shown next:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.659.1">
var corsPolicy = new CorsPolicyBuilder()    .AllowAnyHeader()    .AllowAnyMethod()    .AllowCredentials()    .WithOrigins("http://127.0.0.1:3000", "https://localhost:7093")    .Build();</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.660.1">Now, the SignalR server can accept cross-origin requests from the Blazor </span><span class="No-Break"><span class="koboSpan" id="kobo.661.1">client application.</span></span></p></li> <li><span class="koboSpan" id="kobo.662.1">Run the SignalR server application and the Blazor client application in separate terminals using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.663.1">dotnet run --launch-profile https</span></strong><span class="koboSpan" id="kobo.664.1"> command. </span><span class="koboSpan" id="kobo.664.2">You can test the Blazor client application by opening the </span><strong class="source-inline"><span class="koboSpan" id="kobo.665.1">https://localhost:7093</span></strong><span class="koboSpan" id="kobo.666.1"> URL in the browser. </span><span class="koboSpan" id="kobo.666.2">The Blazor client can chat with the TypeScript client, as </span><span class="No-Break"><span class="koboSpan" id="kobo.667.1">shown next:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer098">
<span class="koboSpan" id="kobo.668.1"><img alt="Figure 13.4 – Chatting between the Blazor client and the TypeScript client" src="image/B18971_13_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.669.1">Figure 13.4 – Chatting between the Blazor client and the TypeScript client</span></p>
<p><span class="koboSpan" id="kobo.670.1">SignalR provides</span><a id="_idIndexMarker1448"/><span class="koboSpan" id="kobo.671.1"> the convenience of real-time communication. </span><span class="koboSpan" id="kobo.671.2">Developers do not need to operate the </span><a id="_idIndexMarker1449"/><span class="koboSpan" id="kobo.672.1">underlying transport details; instead, they can use the SignalR </span><strong class="source-inline"><span class="koboSpan" id="kobo.673.1">Hub</span></strong><span class="koboSpan" id="kobo.674.1"> class to send and receive messages easily. </span><span class="koboSpan" id="kobo.674.2">In the next </span><a id="_idTextAnchor549"/><span class="koboSpan" id="kobo.675.1">section, we will explore more features of a </span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">SignalR hub.</span></span></p>
<h1 id="_idParaDest-288"><a id="_idTextAnchor550"/><span class="koboSpan" id="kobo.677.1">Using authentication and authorization in SignalR</span></h1>
<p><span class="koboSpan" id="kobo.678.1">In the</span><a id="_idIndexMarker1450"/><span class="koboSpan" id="kobo.679.1"> previous</span><a id="_idIndexMarker1451"/><span class="koboSpan" id="kobo.680.1"> section, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">Hub</span></strong><span class="koboSpan" id="kobo.682.1"> class to implement a simple chat app. </span><span class="koboSpan" id="kobo.682.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.683.1">Clients.All.SendAsync</span></strong><span class="koboSpan" id="kobo.684.1"> method is used to send a message to all connected clients. </span><span class="koboSpan" id="kobo.684.2">Sometimes, we </span><a id="_idIndexMarker1452"/><span class="koboSpan" id="kobo.685.1">may want to send a message to a specific client </span><a id="_idIndexMarker1453"/><span class="koboSpan" id="kobo.686.1">or a group of clients. </span><span class="koboSpan" id="kobo.686.2">To manage users and groups, we need to know the identity of the user. </span><span class="koboSpan" id="kobo.686.3">In this section, we will explore how to use authentication and authorization </span><span class="No-Break"><span class="koboSpan" id="kobo.687.1">in SignalR.</span></span></p>
<p><span class="koboSpan" id="kobo.688.1">By default, SignalR uses a </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">ClaimTypes.NameIdentifier</span></strong><span class="koboSpan" id="kobo.690.1"> claim to differentiate users. </span><span class="koboSpan" id="kobo.690.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.691.1">ClaimTypes.NameIdentifier</span></strong><span class="koboSpan" id="kobo.692.1"> claim is used to uniquely identify a user. </span><span class="koboSpan" id="kobo.692.2">We introduced claim-based authorization in </span><a href="B18971_08.xhtml#_idTextAnchor307"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.693.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.694.1">, so we will follow the steps from that chapter to add authentication and authorization to the SignalR server application. </span><span class="koboSpan" id="kobo.694.2">If you are not familiar with ASP.NET Core authentication and authorization, you can refer to </span><a href="B18971_08.xhtml#_idTextAnchor307"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.695.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.696.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.697.1">more details.</span></span></p>
<p><span class="koboSpan" id="kobo.698.1">You can find the complete code of the</span><a id="_idTextAnchor551"/><span class="koboSpan" id="kobo.699.1"> sample in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.700.1">chapter13/v2</span></strong><span class="koboSpan" id="kobo.701.1"> folder of the </span><span class="No-Break"><span class="koboSpan" id="kobo.702.1">GitHub repository.</span></span></p>
<h2 id="_idParaDest-289"><a id="_idTextAnchor552"/><span class="koboSpan" id="kobo.703.1">Adding authentication and authorization to the SignalR server</span></h2>
<p><span class="koboSpan" id="kobo.704.1">To add </span><a id="_idIndexMarker1454"/><span class="koboSpan" id="kobo.705.1">authentication and authorization to the SignalR server, follow</span><a id="_idIndexMarker1455"/> <span class="No-Break"><span class="koboSpan" id="kobo.706.1">these </span></span><span class="No-Break"><a id="_idIndexMarker1456"/></span><span class="No-Break"><span class="koboSpan" id="kobo.707.1">steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.708.1">Install the </span><a id="_idIndexMarker1457"/><span class="koboSpan" id="kobo.709.1">required packages using the </span><span class="No-Break"><span class="koboSpan" id="kobo.710.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.711.1">dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore</span></strong><strong class="bold"><span class="koboSpan" id="kobo.712.1">dotnet add package Microsoft.EntityFrameworkCore.SqlServer</span></strong><strong class="bold"><span class="koboSpan" id="kobo.713.1">dotnet add package Microsoft.EntityFrameworkCore.Tools</span></strong><strong class="bold"><span class="koboSpan" id="kobo.714.1">dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer</span></strong></pre></li> <li><span class="koboSpan" id="kobo.715.1">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.716.1">Data</span></strong><span class="koboSpan" id="kobo.717.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">ChatApp.Server</span></strong><span class="koboSpan" id="kobo.719.1"> project. </span><span class="koboSpan" id="kobo.719.2">Then, create a new class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">AppbContext</span></strong><span class="koboSpan" id="kobo.721.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.722.1">Data</span></strong><span class="koboSpan" id="kobo.723.1"> folder. </span><span class="koboSpan" id="kobo.723.2">As we introduced </span><strong class="source-inline"><span class="koboSpan" id="kobo.724.1">DbContext</span></strong><span class="koboSpan" id="kobo.725.1"> in previous chapters, we will not show the code here. </span><span class="koboSpan" id="kobo.725.2">You can find the code in the </span><span class="No-Break"><span class="koboSpan" id="kobo.726.1">sample application.</span></span></li>
<li><span class="koboSpan" id="kobo.727.1">Add a connection string in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.728.1">appsettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.729.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.730.1">
"ConnectionStrings": {  "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=ChatAppDb;Trusted_Connection=True;MultipleActiveResultSets=true"}</span></pre></li> <li><span class="koboSpan" id="kobo.731.1">Add configurations for JWT tokens in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.732.1">appsettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.733.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.734.1">
"JwtConfig": {  "ValidAudiences": "http://localhost:7159",  "ValidIssuer": "http://localhost:7159",  "Secret": "c1708c6d-7c94-466e-aca3-e09dcd1c2042"}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.735.1">We will </span><a id="_idIndexMarker1458"/><span class="koboSpan" id="kobo.736.1">use the same SignalR server as </span><a id="_idIndexMarker1459"/><span class="koboSpan" id="kobo.737.1">the authentication server. </span><span class="koboSpan" id="kobo.737.2">So, we will use the URL of the SignalR server as the audience and issuer. </span><span class="koboSpan" id="kobo.737.3">If you use a different authentication server, you need to change the audience and </span><span class="No-Break"><span class="koboSpan" id="kobo.738.1">issuer accordingly.</span></span></p></li> <li><span class="koboSpan" id="kobo.739.1">SignalR needs an </span><strong class="source-inline"><span class="koboSpan" id="kobo.740.1">IUserIdProvider</span></strong><span class="koboSpan" id="kobo.741.1"> interface to get the user ID. </span><span class="koboSpan" id="kobo.741.2">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.742.1">Services</span></strong><span class="koboSpan" id="kobo.743.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.744.1">ChatApp.Server</span></strong><span class="koboSpan" id="kobo.745.1"> project. </span><span class="koboSpan" id="kobo.745.2">Then, create a new class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.746.1">NameUserIdProvider</span></strong><span class="koboSpan" id="kobo.747.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.748.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.749.1"> folder:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.750.1">
using Microsoft.AspNetCore.SignalR;namespace ChatApp.Server.Services;public class NameUserIdProvider : IUserIdProvider{    public string GetUserId(HubConnectionContext connection)    {        return connection.User?.Identity?.Name ?? </span><span class="koboSpan" id="kobo.750.2">string.Empty;    }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.751.1">The preceding code implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.752.1">IUserIdProvider</span></strong><span class="koboSpan" id="kobo.753.1"> interface. </span><span class="koboSpan" id="kobo.753.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.754.1">GetUserId</span></strong><span class="koboSpan" id="kobo.755.1"> method returns the user ID of the current user. </span><span class="koboSpan" id="kobo.755.2">In this case, we use the username as the user ID. </span><span class="koboSpan" id="kobo.755.3">You can use any other unique value as the user ID. </span><span class="koboSpan" id="kobo.755.4">For</span><a id="_idIndexMarker1460"/><span class="koboSpan" id="kobo.756.1"> example, if you want to use the email </span><a id="_idIndexMarker1461"/><span class="koboSpan" id="kobo.757.1">address as the user ID, you can create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">EmailBasedUserIdProvider</span></strong><span class="koboSpan" id="kobo.759.1"> class </span><span class="No-Break"><span class="koboSpan" id="kobo.760.1">as follows:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.761.1">using System.Security.Claims;using Microsoft.AspNetCore.SignalR;namespace ChatApp.Server.Services;public class EmailBasedUserIdProvider : IUserIdProvider{    public string GetUserId(HubConnectionContext connection)    {        return connection.User?.Claims.FirstOrDefault(c =&gt; c.Type == ClaimTypes.Email)?.Value ??    string.Empty;    }}</span></pre></li> <li><span class="koboSpan" id="kobo.762.1">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.763.1">Program.cs</span></strong><span class="koboSpan" id="kobo.764.1"> file to add authentication and authorization, </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.766.1">
builder.Services.AddDbContext&lt;AppDbContext&gt;();builder.Services.AddIdentityCore&lt;IdentityUser&gt;()    .AddEntityFrameworkStores&lt;AppDbContext&gt;()    .AddDefaultTokenProviders();builder.Services.AddAuthentication(options =&gt;{    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;    options.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;}).AddJwtBearer(options =&gt;{    var secret = builder.Configuration["JwtConfig:Secret"];    var issuer = builder.Configuration["JwtConfig:ValidIssuer"];    var audience = builder.Configuration["JwtConfig:ValidAudiences"];    if (secret is null || issuer is null || audience is null)    {        throw new ApplicationException("Jwt is not set in the configuration");    }    options.SaveToken = true;    options.RequireHttpsMetadata = false;    options.TokenValidationParameters = new TokenValidationParameters()    {        ValidateIssuer = true,        ValidateAudience = true,        ValidAudience = audience,        ValidIssuer = issuer,        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secret))    };    // Hook the SignalR event to check for the token in the query string    options.Events = new JwtBearerEvents    {        OnMessageReceived = context =&gt;        {            var accessToken = context.Request.Query["access_token"];            var path = context.HttpContext.Request.Path;            if (!string.IsNullOrEmpty(accessToken) &amp;&amp; path.StartsWithSegments("/chatHub"))            {                context.Token = accessToken;            }            return Task.CompletedTask;        }    };});// Use the name-based user ID providerbuilder.Services.AddSingleton&lt;IUserIdProvider, NameUserIdProvider&gt;();</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.767.1">The </span><a id="_idIndexMarker1462"/><span class="koboSpan" id="kobo.768.1">preceding code is similar to the code in </span><a href="B18971_08.xhtml#_idTextAnchor307"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.769.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.770.1">. </span><span class="koboSpan" id="kobo.770.2">A difference is that we configured the </span><strong class="source-inline"><span class="koboSpan" id="kobo.771.1">options.Events</span></strong><span class="koboSpan" id="kobo.772.1"> property of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.773.1">JwtBearerOptions</span></strong><span class="koboSpan" id="kobo.774.1"> object. </span><span class="koboSpan" id="kobo.774.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.775.1">OnMessageReceived</span></strong><span class="koboSpan" id="kobo.776.1"> event is used to check the token in the query string. </span><span class="koboSpan" id="kobo.776.2">The reason is that WebSocket APIs and SSE do not support the standard </span><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">Authorization</span></strong><span class="koboSpan" id="kobo.778.1"> header, so it is required to attach the token to the query string. </span><span class="koboSpan" id="kobo.778.2">If the </span><a id="_idIndexMarker1463"/><span class="koboSpan" id="kobo.779.1">token is found in the query string, it will be used to authenticate </span><span class="No-Break"><span class="koboSpan" id="kobo.780.1">the user.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.781.1">We also added the </span><strong class="source-inline"><span class="koboSpan" id="kobo.782.1">IUserIdProvider</span></strong><span class="koboSpan" id="kobo.783.1"> service to the </span><strong class="bold"><span class="koboSpan" id="kobo.784.1">DI</span></strong><span class="koboSpan" id="kobo.785.1"> container. </span><span class="koboSpan" id="kobo.785.2">In </span><a id="_idIndexMarker1464"/><span class="koboSpan" id="kobo.786.1">this case, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.787.1">NameUserIdProvider</span></strong><span class="koboSpan" id="kobo.788.1"> class we created earlier. </span><span class="koboSpan" id="kobo.788.2">If you want to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.789.1">EmailBasedUserIdProvider</span></strong><span class="koboSpan" id="kobo.790.1"> class, you need to change the code accordingly. </span><span class="koboSpan" id="kobo.790.2">Note that you must not use both at the </span><span class="No-Break"><span class="koboSpan" id="kobo.791.1">same time.</span></span></p></li> <li><span class="koboSpan" id="kobo.792.1">Create a database and run migrations using the </span><span class="No-Break"><span class="koboSpan" id="kobo.793.1">following commands:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.794.1">dotnet ef migrations add InitialDb</span></strong><strong class="bold"><span class="koboSpan" id="kobo.795.1">dotnet ef database update</span></strong></pre></li> <li><span class="koboSpan" id="kobo.796.1">Next, we need to add an </span><strong class="source-inline"><span class="koboSpan" id="kobo.797.1">Authorize</span></strong><span class="koboSpan" id="kobo.798.1"> attribute to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.799.1">ChatHub</span></strong><span class="koboSpan" id="kobo.800.1"> class, as </span><span class="No-Break"><span class="koboSpan" id="kobo.801.1">shown next:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.802.1">
[Authorize]public class ChatHub : Hub{    // Omitted for brevity}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.803.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.804.1">Authorize</span></strong><span class="koboSpan" id="kobo.805.1"> attribute can be applied to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.806.1">Hub</span></strong><span class="koboSpan" id="kobo.807.1"> class or methods of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.808.1">Hub</span></strong><span class="koboSpan" id="kobo.809.1"> class. </span><span class="koboSpan" id="kobo.809.2">It also supports policy-based authorization. </span><span class="koboSpan" id="kobo.809.3">For example, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.810.1">Authorize(Policy = "Admin")</span></strong><span class="koboSpan" id="kobo.811.1"> attribute to restrict access to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">ChatHub</span></strong><span class="koboSpan" id="kobo.813.1"> class </span><span class="No-Break"><span class="koboSpan" id="kobo.814.1">to administrators.</span></span></p></li> <li><span class="koboSpan" id="kobo.815.1">Run</span><a id="_idIndexMarker1465"/><span class="koboSpan" id="kobo.816.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.817.1">ChatApp.Server</span></strong><span class="koboSpan" id="kobo.818.1"> application, as well as any other client applications. </span><span class="koboSpan" id="kobo.818.2">Unfortunately, the TypeScript </span><a id="_idIndexMarker1466"/><span class="koboSpan" id="kobo.819.1">and Blazor clients will not be able to connect to the SignalR hub due to the need for user authen</span><a id="_idTextAnchor553"/><span class="koboSpan" id="kobo.820.1">tication. </span><span class="koboSpan" id="kobo.820.2">To access the SignalR hub, we need to authenticate </span><span class="No-Break"><span class="koboSpan" id="kobo.821.1">the clients.</span></span></li>
</ol>
<h2 id="_idParaDest-290"><a id="_idTextAnchor554"/><span class="koboSpan" id="kobo.822.1">Adding a login endpoint</span></h2>
<p><span class="koboSpan" id="kobo.823.1">To </span><a id="_idIndexMarker1467"/><span class="koboSpan" id="kobo.824.1">authenticate the clients, we need to provide a login endpoint. </span><span class="koboSpan" id="kobo.824.2">We</span><a id="_idIndexMarker1468"/><span class="koboSpan" id="kobo.825.1"> implemented a login endpoint in </span><a href="B18971_08.xhtml#_idTextAnchor307"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.826.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.827.1">. </span><span class="koboSpan" id="kobo.827.2">You can follow the steps in </span><a href="B18971_08.xhtml#_idTextAnchor307"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.828.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.829.1"> to implement the login endpoint or copy the code from the sample application. </span><span class="koboSpan" id="kobo.829.2">You need to create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.830.1">AccountController</span></strong><span class="koboSpan" id="kobo.831.1"> class that contains register and login endpoints. </span><span class="koboSpan" id="kobo.831.2">You also need to add some models, such as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.832.1">LoginModel</span></strong><span class="koboSpan" id="kobo.833.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.834.1">AddOrUpdateUserModel</span></strong><span class="koboSpan" id="kobo.835.1"> classes. </span><span class="koboSpan" id="kobo.835.2">With these classes, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.836.1">account/register</span></strong><span class="koboSpan" id="kobo.837.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.838.1">account/login</span></strong><span class="koboSpan" id="kobo.839.1"> endpoints to register and log </span><span class="No-Break"><span class="koboSpan" id="kobo.840.1">in users.</span></span></p>
<p><span class="koboSpan" id="kobo.841.1">One thing to note here is that when generating a JWT token, we need to add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.842.1">ClaimTypes.NameIdentifier</span></strong><span class="koboSpan" id="kobo.843.1"> claim to the token. </span><span class="koboSpan" id="kobo.843.2">SignalR uses this claim to identify the user. </span><span class="koboSpan" id="kobo.843.3">The following code shows how to add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.844.1">ClaimTypes.NameIdentifier</span></strong><span class="koboSpan" id="kobo.845.1"> claim to </span><span class="No-Break"><span class="koboSpan" id="kobo.846.1">the token:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.847.1">
var tokenDescriptor = new SecurityTokenDescriptor{
    Subject = new ClaimsIdentity(new[]
    {
        // SignalR requires the NameIdentifier claim to map the user to the connection
        new Claim(ClaimTypes.NameIdentifier, userName),
        new Claim(ClaimTypes.Name, userName),
        // If you use the email-based user ID provider, you need to add the email claim from the database
    }),
    Expires = DateTime.UtcNow.AddDays(1),
    Issuer = issuer,
    Audience = audience,
    SigningCredentials = new SigningCredentials(signingKey, SecurityAlgorithms.HmacSha256Signature)
};</span></pre>
<p><span class="koboSpan" id="kobo.848.1">Now, we</span><a id="_idIndexMarker1469"/><span class="koboSpan" id="kobo.849.1"> need to create some users for testing. </span><span class="koboSpan" id="kobo.849.2">Run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.850.1">ChatApp.Server</span></strong><span class="koboSpan" id="kobo.851.1"> application and send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.852.1">POST</span></strong><span class="koboSpan" id="kobo.853.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.854.1">account/register</span></strong><span class="koboSpan" id="kobo.855.1"> endpoint</span><a id="_idIndexMarker1470"/><span class="koboSpan" id="kobo.856.1"> using Postman or any other HTTP client. </span><span class="koboSpan" id="kobo.856.2">The following code shows how to create a user using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.857.1">account/register</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.858.1"> endpoint:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.859.1">
{  "userName": "user1",
  "email": "user1@example.com",
  "password": "Passw0rd!"
</span><span class="koboSpan" id="kobo.859.2">}</span></pre>
<p><span class="koboSpan" id="kobo.860.1">Create more users such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.861.1">user2</span><a id="_idTextAnchor555"/></strong><span class="koboSpan" id="kobo.862.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.863.1">user3</span></strong><span class="koboSpan" id="kobo.864.1">, and so on. </span><span class="koboSpan" id="kobo.864.2">We will use these users to test the </span><strong class="source-inline"><span class="koboSpan" id="kobo.865.1">Groups</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.866.1">feature later.</span></span></p>
<h2 id="_idParaDest-291"><a id="_idTextAnchor556"/><span class="koboSpan" id="kobo.867.1">Authenticating the TypeScript client</span></h2>
<p><span class="koboSpan" id="kobo.868.1">Now, we </span><a id="_idIndexMarker1471"/><span class="koboSpan" id="kobo.869.1">can</span><a id="_idIndexMarker1472"/><span class="koboSpan" id="kobo.870.1"> authenticate the TypeScript client. </span><span class="koboSpan" id="kobo.870.2">To do so, we need to update the UI to allow the user to enter the username and password. </span><span class="koboSpan" id="kobo.870.3">We also need to update the TypeScript code to send the username and password to the login endpoint. </span><span class="koboSpan" id="kobo.870.4">Follow these steps to update the </span><span class="No-Break"><span class="koboSpan" id="kobo.871.1">TypeScript client:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.872.1">Update the HTML content in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.873.1">&lt;body&gt;</span></strong><span class="koboSpan" id="kobo.874.1"> element </span><span class="No-Break"><span class="koboSpan" id="kobo.875.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.876.1">
&lt;body&gt;    &lt;div id="divLogin"&gt;        &lt;label for="txtUsername"&gt;User Name&lt;/label&gt;        &lt;input type="text" id="txtUsername" /&gt;        &lt;label for="txtPassword"&gt;Password&lt;/label&gt;        &lt;input type="password" id="txtPassword" /&gt;        &lt;button id="btnLogin"&gt;Login&lt;/button&gt;    &lt;/div&gt;    &lt;div id="divChat"&gt;        &lt;label&gt;User Name&lt;/label&gt;        &lt;label id="lblUsername" &gt;&lt;/label&gt;        &lt;label for="txtMessage"&gt;Message&lt;/label&gt;        &lt;input type="text" id="txtMessage" /&gt;        &lt;button id="btnSend"&gt;Send&lt;/button&gt;        &lt;ul id="messages"&gt;&lt;/ul&gt;    &lt;/div&gt;    &lt;script type="module" src="bundle.js"&gt;&lt;/script&gt;&lt;/body&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.877.1">The </span><a id="_idIndexMarker1473"/><span class="koboSpan" id="kobo.878.1">preceding code adds a login form to the </span><a id="_idIndexMarker1474"/><span class="koboSpan" id="kobo.879.1">HTML page. </span><span class="koboSpan" id="kobo.879.2">The login form contains a username textbox, a password textbox, and a login button. </span><span class="koboSpan" id="kobo.879.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.880.1">divChat</span></strong><span class="koboSpan" id="kobo.881.1"> element now has a </span><strong class="source-inline"><span class="koboSpan" id="kobo.882.1">lblUsername</span></strong><span class="koboSpan" id="kobo.883.1"> element to display the username. </span><span class="koboSpan" id="kobo.883.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.884.1">divChat</span></strong><span class="koboSpan" id="kobo.885.1"> element is hidden by default. </span><span class="koboSpan" id="kobo.885.2">We will show it after the user </span><span class="No-Break"><span class="koboSpan" id="kobo.886.1">is </span></span><span class="No-Break"><a id="_idIndexMarker1475"/></span><span class="No-Break"><span class="koboSpan" id="kobo.887.1">authenticated.</span></span></p></li> <li><span class="koboSpan" id="kobo.888.1">Update</span><a id="_idIndexMarker1476"/><span class="koboSpan" id="kobo.889.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.890.1">app.ts</span></strong><span class="koboSpan" id="kobo.891.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.892.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.893.1">
import * as signalR from "@microsoft/signalr";divChat.style.display = "none";btnSend.disabled = true;btnLogin.addEventListener("click", login);let connection: signalR.HubConnection = null;async function login() {  const username = txtUsername.value;  const password = txtPassword.value;  if (username &amp;&amp; password) {    try {      // Use the Fetch API to login      const response = await fetch("https://localhost:7159/account/login", {        method: "POST",        headers: { "Content-Type": "application/json" },        body: JSON.stringify({ username, password }),      });      const json = await response.json();      localStorage.setItem("token", json.token);      localStorage.setItem("username", username);      txtUsername.value = "";      txtPassword.value = "";      lblUsername.textContent = username;      divLogin.style.display = "none";      divChat.style.display = "block";      txtMessage.focus();      // Start the SignalR connection      connection = new signalR.HubConnectionBuilder()        .withUrl("https://localhost:7159/chatHub", {          accessTokenFactory: () =&gt; {           var localToken = localStorage.getItem("token");           // You can add logic to check if the token is valid or expired           return localToken;         },        })        .build();      connection.on("ReceiveMessage", (username: string, message: string) =&gt; {        const li = document.createElement("li");        li.textContent = `${username}: ${message}`;        const messageList = document.getElementById("messages");        messageList.appendChild(li);        messageList.scrollTop = messageList.scrollHeight;      });      await connection.start();      btnSend.disabled = false;    } catch (err) {      console.error(err.toString());    }  }}txtMessage.addEventListener("keyup", (event) =&gt; {  if (event.key === "Enter") {    sendMessage();  }});btnSend.addEventListener("click", sendMessage);function sendMessage() {  connection    .invoke("SendMessage", lblUsername.textContent, txtMessage.value)    .catch((err) =&gt; console.error(err.toString()))    .then(() =&gt; (txtMessage.value = ""));}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.894.1">Some codes are omitted. </span><span class="koboSpan" id="kobo.894.2">You can find the full code from the books </span><span class="No-Break"><span class="koboSpan" id="kobo.895.1">GitHub repository.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.896.1">In the</span><a id="_idIndexMarker1477"/><span class="koboSpan" id="kobo.897.1"> preceding code, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.898.1">fetch</span></strong><span class="koboSpan" id="kobo.899.1"> API to send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.900.1">POST</span></strong><span class="koboSpan" id="kobo.901.1"> request to the login endpoint. </span><span class="koboSpan" id="kobo.901.2">The login endpoint returns</span><a id="_idIndexMarker1478"/><span class="koboSpan" id="kobo.902.1"> a JWT token if the user is authenticated. </span><span class="koboSpan" id="kobo.902.2">Then, we store the token in the local storage and show the username in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.903.1">divChat</span></strong><span class="koboSpan" id="kobo.904.1"> element. </span><span class="koboSpan" id="kobo.904.2">We also adjusted the creation of the SignalR connection. </span><span class="koboSpan" id="kobo.904.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.905.1">accessTokenFactory</span></strong><span class="koboSpan" id="kobo.906.1"> property is used to get the token from the local storage. </span><span class="koboSpan" id="kobo.906.2">You can add some logic to check whether the token is valid or expired. </span><span class="koboSpan" id="kobo.906.3">If the token is expired, you can redirect the user to the login page or use the </span><strong class="bold"><span class="koboSpan" id="kobo.907.1">Refresh</span></strong><span class="koboSpan" id="kobo.908.1"> token to get a </span><span class="No-Break"><span class="koboSpan" id="kobo.909.1">new token.</span></span></p></li> <li><span class="koboSpan" id="kobo.910.1">Run the following command to compile the TypeScript code and copy the HTML files to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.911.1">dist</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.912.1"> folder:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.913.1">npm run gulp</span></strong></pre></li> <li><span class="koboSpan" id="kobo.914.1">Use the </span><strong class="bold"><span class="koboSpan" id="kobo.915.1">Live Preview</span></strong><span class="koboSpan" id="kobo.916.1"> extension to run the web server. </span><span class="koboSpan" id="kobo.916.2">Run the SignalR server application as well. </span><span class="koboSpan" id="kobo.916.3">You will see a login form, as </span><span class="No-Break"><span class="koboSpan" id="kobo.917.1">shown next:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer099">
<span class="koboSpan" id="kobo.918.1"><img alt="Figure 13.5 – The login form" src="image/B18971_13_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.919.1">Figure 13.5 – The login form</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.920.1">Use the username and password you created earlier to log in. </span><span class="koboSpan" id="kobo.920.2">You should see a chat form, as </span><span class="No-Break"><span class="koboSpan" id="kobo.921.1">shown next:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer100">
<span class="koboSpan" id="kobo.922.1"><img alt="Figure 13.6 – Authenticated chat" src="image/B18971_13_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.923.1">Figure 13.6 – Authenticated chat</span></p>
<p><span class="koboSpan" id="kobo.924.1">Now, th</span><a id="_idTextAnchor557"/><span class="koboSpan" id="kobo.925.1">e</span><a id="_idIndexMarker1479"/><span class="koboSpan" id="kobo.926.1"> TypeScript</span><a id="_idIndexMarker1480"/><span class="koboSpan" id="kobo.927.1"> client is authenticated. </span><span class="koboSpan" id="kobo.927.2">Next, we will authenticate the </span><span class="No-Break"><span class="koboSpan" id="kobo.928.1">Blazor client.</span></span></p>
<h2 id="_idParaDest-292"><a id="_idTextAnchor558"/><span class="koboSpan" id="kobo.929.1">Authenticating the Blazor client</span></h2>
<p><span class="koboSpan" id="kobo.930.1">The </span><a id="_idIndexMarker1481"/><span class="koboSpan" id="kobo.931.1">code to </span><a id="_idIndexMarker1482"/><span class="koboSpan" id="kobo.932.1">authenticate the Blazor client is very similar to the TypeScript client, so we will not list all the code here. </span><span class="koboSpan" id="kobo.932.2">You can find the code in the sample application. </span><span class="koboSpan" id="kobo.932.3">The following code shows how to log in and set a token to the </span><span class="No-Break"><span class="koboSpan" id="kobo.933.1">SignalR connection:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.934.1">
@inject HttpClient Httpprivate async Task Login()
{
    if (!string.IsNullOrWhiteSpace(_username) &amp;&amp; !string.IsNullOrWhiteSpace(_password))
    {
        var response = await Http.PostAsJsonAsync("Account/login", new { Username = _username, Password = _password });
        if (response.IsSuccessStatusCode)
        {
            var jsonString = await response.Content.ReadAsStringAsync();
            var data = System.Text.Json.JsonSerializer.Deserialize&lt;Dictionary&lt;string, string&gt;&gt;(jsonString);
            _token = data["token"];
            if (string.IsNullOrWhiteSpace(_token))
            {
                throw new Exception("Invalid token.");
            }
            else
            {
                _showLogin = false;
                _showChat = true;
                StateHasChanged();
                // Set the token to the hub connection.
</span><span class="koboSpan" id="kobo.934.2">                _hubConnection = new HubConnectionBuilder()
                .WithUrl("https://localhost:7159/chatHub", options =&gt;
                {
                    options.AccessTokenProvider = () =&gt; Task.FromResult&lt;string?&gt;(_token);
                })
                .Build();
                _hubConnection.On&lt;string, string&gt;("ReceiveMessage", (username, message) =&gt;
                {
                    var encodedMessage = $"{username}: {message}";
                    _messages.Add(encodedMessage);
                    StateHasChanged();
                });
                await _hubConnection.StartAsync();
            }
        }
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.935.1">In the</span><a id="_idIndexMarker1483"/><span class="koboSpan" id="kobo.936.1"> preceding code, we inject </span><strong class="source-inline"><span class="koboSpan" id="kobo.937.1">HttpClient</span></strong><span class="koboSpan" id="kobo.938.1"> to send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.939.1">POST</span></strong><span class="koboSpan" id="kobo.940.1"> request to the login endpoint. </span><span class="koboSpan" id="kobo.940.2">Then, we set a token to the SignalR </span><a id="_idIndexMarker1484"/><span class="koboSpan" id="kobo.941.1">connection. </span><span class="koboSpan" id="kobo.941.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.942.1">AccessTokenProvider</span></strong><span class="koboSpan" id="kobo.943.1"> property is used to get the token from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.944.1">_token</span></strong><span class="koboSpan" id="kobo.945.1"> field. </span><span class="koboSpan" id="kobo.945.2">Similar to the TypeScript client, you can add some logic to check whether the token is valid </span><span class="No-Break"><span class="koboSpan" id="kobo.946.1">or expired.</span></span></p>
<p><span class="koboSpan" id="kobo.947.1">Run the three applications. </span><span class="koboSpan" id="kobo.947.2">You can use different usernames to log in to the two clients and send messages. </span><span class="koboSpan" id="kobo.947.3">You should see messages are displayed in both clients, as </span><span class="No-Break"><span class="koboSpan" id="kobo.948.1">shown next:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer101">
<span class="koboSpan" id="kobo.949.1"><img alt="Figure 13.7 – Authenticated chat for different users" src="image/B18971_13_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.950.1">Figure 13.7 – Authenticated chat for different users</span></p>
<p><a id="_idTextAnchor559"/><span class="koboSpan" id="kobo.951.1">The clients now</span><a id="_idIndexMarker1485"/><span class="koboSpan" id="kobo.952.1"> support authentication. </span><span class="koboSpan" id="kobo.952.2">Next, we will add </span><a id="_idIndexMarker1486"/><span class="koboSpan" id="kobo.953.1">more features to the </span><span class="No-Break"><span class="koboSpan" id="kobo.954.1">chat app.</span></span></p>
<h1 id="_idParaDest-293"><a id="_idTextAnchor560"/><span class="koboSpan" id="kobo.955.1">Managing users and groups</span></h1>
<p><span class="koboSpan" id="kobo.956.1">In the</span><a id="_idIndexMarker1487"/><span class="koboSpan" id="kobo.957.1"> previous section, we implemented basic authentication and authorization for the SignalR server. </span><span class="koboSpan" id="kobo.957.2">We also updated clients to authenticate users. </span><span class="koboSpan" id="kobo.957.3">In this section, we will explore how to manage users and groups in SignalR. </span><span class="koboSpan" id="kobo.957.4">We want to add features to the chat app to enable </span><span class="No-Break"><span class="koboSpan" id="kobo.958.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.959.1">Allow users to know who is connected to the </span><span class="No-Break"><span class="koboSpan" id="kobo.960.1">chat app</span></span></li>
<li><span class="koboSpan" id="kobo.961.1">Allow users to send a message to a </span><span class="No-Break"><span class="koboSpan" id="kobo.962.1">specific user</span></span></li>
<li><span class="koboSpan" id="kobo.963.1">Allow users to </span><span class="No-Break"><span class="koboSpan" id="kobo.964.1">join groups</span></span></li>
<li><span class="koboSpan" id="kobo.965.1">Allow users to send a message to a </span><span class="No-Break"><span class="koboSpan" id="kobo.966.1">specific group</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.967.1">You can find the complete code of the samp</span><a id="_idTextAnchor561"/><span class="koboSpan" id="kobo.968.1">le in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.969.1">chapter13/v3</span></strong><span class="koboSpan" id="kobo.970.1"> folder of the GitHub repository. </span><span class="koboSpan" id="kobo.970.2">Let’s start with the </span><span class="No-Break"><span class="koboSpan" id="kobo.971.1">first feature.</span></span></p>
<h2 id="_idParaDest-294"><a id="_idTextAnchor562"/><span class="koboSpan" id="kobo.972.1">Managing events in SignalR</span></h2>
<p><span class="koboSpan" id="kobo.973.1">SignalR provides</span><a id="_idIndexMarker1488"/><span class="koboSpan" id="kobo.974.1"> events to notify clients when a user connects or disconnects. </span><span class="koboSpan" id="kobo.974.2">We can override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.975.1">OnConnectedAsync()</span></strong><span class="koboSpan" id="kobo.976.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.977.1">OnDisconnectedAsync()</span></strong><span class="koboSpan" id="kobo.978.1"> methods to handle these events. </span><span class="koboSpan" id="kobo.978.2">The following code shows how to override the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.979.1">OnConnectedAsync()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.980.1"> method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.981.1">
public override async Task OnConnectedAsync(){
    await Clients.All.SendAsync("UserConnected", Context.User.Identity.Name);
    await base.OnConnectedAsync();
}</span></pre>
<p><span class="koboSpan" id="kobo.982.1">When a </span><a id="_idIndexMarker1489"/><span class="koboSpan" id="kobo.983.1">client connects to the SignalR hub, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.984.1">OnConnectedAsync()</span></strong><span class="koboSpan" id="kobo.985.1"> method will be called. </span><span class="koboSpan" id="kobo.985.2">In this case, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.986.1">Clients.All.SendAsync()</span></strong><span class="koboSpan" id="kobo.987.1"> method to send a message to all connected clients. </span><span class="koboSpan" id="kobo.987.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.988.1">Context.User.Identity.Name</span></strong><span class="koboSpan" id="kobo.989.1"> property is used to get the username of the </span><span class="No-Break"><span class="koboSpan" id="kobo.990.1">current user.</span></span></p>
<p><span class="koboSpan" id="kobo.991.1">The following code shows how to override the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.992.1">OnDisconnectAsync()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.993.1"> method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.994.1">
public override async Task OnDisconnectedAsync(Exception? </span><span class="koboSpan" id="kobo.994.2">exception){
    await Clients.All.SendAsync("UserDisconnected", Context.User.Identity.Name);
    await base.OnDisconnectedAsync(exception);
}</span></pre>
<p><span class="koboSpan" id="kobo.995.1">Then, we can update the TypeScript client to handle the </span><strong class="source-inline"><span class="koboSpan" id="kobo.996.1">UserConnected</span></strong><span class="koboSpan" id="kobo.997.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.998.1">UserDisconnected</span></strong><span class="koboSpan" id="kobo.999.1"> events. </span><span class="koboSpan" id="kobo.999.2">The following code shows how to handle the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1000.1">UserConnected</span></strong><span class="koboSpan" id="kobo.1001.1"> event in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1002.1">TypeScript client:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1003.1">
connection.on("UserConnected", (username: string) =&gt; {  const li = document.createElement("li");
  li.textContent = `${username} connected`;
  const messageList = document.getElementById("messages");
  messageList.appendChild(li);
  messageList.scrollTop = messageList.scrollHeight;
});
connection.on("UserDisconnected", (username: string) =&gt; {
  const li = document.createElement("li");
  li.textContent = `${username} disconnected`;
  const messageList = document.getElementById("messages");
  messageList.appendChild(li);
  messageList.scrollTop = messageList.scrollHeight;
});</span></pre>
<p><span class="koboSpan" id="kobo.1004.1">The code </span><a id="_idIndexMarker1490"/><span class="koboSpan" id="kobo.1005.1">in the Blazor client is </span><span class="No-Break"><span class="koboSpan" id="kobo.1006.1">very similar:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1007.1">
_hubConnection.On&lt;string&gt;("UserConnected", (username) =&gt;{
    var encodedMessage = $"{username} connected.";
    _messages.Add(encodedMessage);
    StateHasChanged();
});
_hubConnection.On&lt;string&gt;("UserDisconnected", (username) =&gt;
{
    var encodedMessage = $"{username} disconnected.";
    _messages.Add(encodedMessage);
    StateHasChanged();
});</span></pre>
<p><span class="koboSpan" id="kobo.1008.1">Now, we can run the SignalR server and the two clients. </span><span class="koboSpan" id="kobo.1008.2">You should see the user’s connected and disconnected messages in the chat window. </span><span class="koboSpan" id="kobo.1008.3">If you refresh the page or close the browser tab, you should see a user-disconnected message, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1009.1">shown next:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer102">
<span class="koboSpan" id="kobo.1010.1"><img alt="Figure 13.8 – User-connected and -disconnec﻿ted messages" src="image/B18971_13_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1011.1">Figure 13.8 – User-connected and -disconnec</span><a id="_idTextAnchor563"/><span class="koboSpan" id="kobo.1012.1">ted messages</span></p>
<p><span class="koboSpan" id="kobo.1013.1">Next, we will </span><a id="_idIndexMarker1491"/><span class="koboSpan" id="kobo.1014.1">add a feature to allow users to send a message to a </span><span class="No-Break"><span class="koboSpan" id="kobo.1015.1">specific user.</span></span></p>
<h2 id="_idParaDest-295"><a id="_idTextAnchor564"/><span class="koboSpan" id="kobo.1016.1">Sending a message to a specific user</span></h2>
<p><span class="koboSpan" id="kobo.1017.1">The </span><a id="_idIndexMarker1492"/><span class="koboSpan" id="kobo.1018.1">next feature we want to add is to allow users to send a message to a specific user. </span><span class="koboSpan" id="kobo.1018.2">To do so, we need to know to whom the message is sent. </span><span class="koboSpan" id="kobo.1018.3">SignalR uses a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1019.1">ClaimTypes.NameIdentifier</span></strong><span class="koboSpan" id="kobo.1020.1"> claim to differentiate users. </span><span class="koboSpan" id="kobo.1020.2">To simplify the code, we will pass the username as the </span><span class="No-Break"><span class="koboSpan" id="kobo.1021.1">target user:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1022.1">
public Task SendMessageToUser(string user, string toUser, string message){
    return Clients.User(toUser).SendAsync("ReceiveMessage", user, message);
}</span></pre>
<p><span class="koboSpan" id="kobo.1023.1">The preceding code uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1024.1">Clients.User(user)</span></strong><span class="koboSpan" id="kobo.1025.1"> method to find the connection of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1026.1">specified user.</span></span></p>
<p><span class="koboSpan" id="kobo.1027.1">Next, update the TypeScript client to add a textbox to enter the target username. </span><span class="koboSpan" id="kobo.1027.2">The following code shows how to update the HTML content for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1028.1">divChat</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1029.1"> element:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1030.1">
&lt;label for="txtToUser"&gt;To&lt;/label&gt;&lt;input type="text" id="txtToUser" /&gt;</span></pre>
<p><span class="koboSpan" id="kobo.1031.1">Then, we can </span><a id="_idIndexMarker1493"/><span class="koboSpan" id="kobo.1032.1">invoke this method from the TypeScript client </span><span class="No-Break"><span class="koboSpan" id="kobo.1033.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1034.1">
function sendMessage() {  // If the txtToUser field is not empty, send the message to the user
  if (txtToUser.value) {
    connection
      .invoke("SendMessageToUser", lblUsername.textContent, txtToUser.value, txtMessage.value)
      .catch((err) =&gt; console.error(err.toString()))
      .then(() =&gt; (txtMessage.value = ""));
  } else {
    connection
      .invoke("SendMessage", lblUsername.textContent, txtMessage.value)
      .catch((err) =&gt; console.error(err.toString()))
      .then(() =&gt; (txtMessage.value = ""));
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.1035.1">In the preceding code, when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1036.1">txtToUser</span></strong><span class="koboSpan" id="kobo.1037.1"> field is not empty, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1038.1">SendMessageToUser()</span></strong><span class="koboSpan" id="kobo.1039.1"> method to send a message to a specified user. </span><span class="koboSpan" id="kobo.1039.2">Otherwise, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1040.1">SendMessage()</span></strong><span class="koboSpan" id="kobo.1041.1"> method to send a message to all </span><span class="No-Break"><span class="koboSpan" id="kobo.1042.1">connected users.</span></span></p>
<p><span class="koboSpan" id="kobo.1043.1">The code in the Blazor client is </span><span class="No-Break"><span class="koboSpan" id="kobo.1044.1">very similar:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1045.1">
private async Task SendMessage(){
    if (_hubConnection != null &amp;&amp; IsConnected)
    {
        if (!string.IsNullOrWhiteSpace(_toUser))
        {
            await _hubConnection.InvokeAsync("SendMessageToUser", _username, _toUser, _message);
        }
        else
        {
            await _hubConnection.InvokeAsync("SendMessage", _username, _message);
        }
        _message = string.Empty;
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.1046.1">Please refer to the sample application for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1047.1">complete code.</span></span></p>
<p><span class="koboSpan" id="kobo.1048.1">Run</span><a id="_idIndexMarker1494"/><span class="koboSpan" id="kobo.1049.1"> the three applications. </span><span class="koboSpan" id="kobo.1049.2">This time, we need to open three browser tabs for testing. </span><span class="koboSpan" id="kobo.1049.3">Use three different usernames to log in to the three clients. </span><span class="koboSpan" id="kobo.1049.4">Then, we can send a message to a specific user, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1050.1">shown next:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer103">
<span class="koboSpan" id="kobo.1051.1"><img alt="Figure 13.9 – Sending a message to a specific user" src="image/B18971_13_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1052.1">Figure 13.9 – Sending a message to a specific user</span></p>
<p><span class="koboSpan" id="kobo.1053.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1054.1">Figure 13</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1055.1">.9</span></em><span class="koboSpan" id="kobo.1056.1">, we sent a message to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1057.1">user1</span></strong><span class="koboSpan" id="kobo.1058.1"> user from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1059.1">user2</span></strong><span class="koboSpan" id="kobo.1060.1">. </span><span class="koboSpan" id="kobo.1060.2">You can see that the message is displayed in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1061.1">user1</span></strong><span class="koboSpan" id="kobo.1062.1"> browser tab but not in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1063.1">user3</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1064.1">browser tab.</span></span></p>
<p><span class="koboSpan" id="kobo.1065.1">You can try</span><a id="_idIndexMarker1495"/><span class="koboSpan" id="kobo.1066.1"> to log in to the same username in different browser tabs. </span><span class="koboSpan" id="kobo.1066.2">You will find that both browser tabs will receive the message. </span><span class="koboSpan" id="kobo.1066.3">This is because SignalR uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1067.1">ClaimTypes.NameIdentifier</span></strong><span class="koboSpan" id="kobo.1068.1"> claim to differentiate users. </span><span class="koboSpan" id="kobo.1068.2">Each browser tab has a different SignalR</span><a id="_idTextAnchor565"/><span class="koboSpan" id="kobo.1069.1"> connection, but they use the same username. </span><span class="koboSpan" id="kobo.1069.2">Therefore, SignalR will treat them as the </span><span class="No-Break"><span class="koboSpan" id="kobo.1070.1">same user.</span></span></p>
<h2 id="_idParaDest-296"><a id="_idTextAnchor566"/><span class="koboSpan" id="kobo.1071.1">Using strongly typed hubs</span></h2>
<p><span class="koboSpan" id="kobo.1072.1">So far, we have </span><a id="_idIndexMarker1496"/><span class="koboSpan" id="kobo.1073.1">added a couple of methods to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1074.1">ChatHub</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1075.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1076.1">
public Task SendMessage(string user, string message){
    await Clients.All.SendAsync("ReceiveMessage", user, message);
}
public Task SendMessageToUser(string user, string toUser, string message)
{
    return Clients.User(toUser).SendAsync("ReceiveMessage", user, message);
}
public override async Task OnConnectedAsync()
{
    await Clients.All.SendAsync("UserConnected", Context.User.Identity.Name);
    await base.OnConnectedAsync();
}
public override async Task OnDisconnectedAsync(Exception? </span><span class="koboSpan" id="kobo.1076.2">exception)
{
    await Clients.All.SendAsync("UserDisconnected", Context.User.Identity.Name);
    await base.OnDisconnectedAsync(exception);
}</span></pre>
<p><span class="koboSpan" id="kobo.1077.1">Each </span><a id="_idIndexMarker1497"/><span class="koboSpan" id="kobo.1078.1">method calls the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1079.1">SendAsync()</span></strong><span class="koboSpan" id="kobo.1080.1"> method with a string parameter. </span><span class="koboSpan" id="kobo.1080.2">The string parameter is the name of the method to be invoked on the client. </span><span class="koboSpan" id="kobo.1080.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1081.1">SendAsync()</span></strong><span class="koboSpan" id="kobo.1082.1"> method is a dynamic method, but it is not type-safe. </span><span class="koboSpan" id="kobo.1082.2">If we misspell the method name, the compiler will not report any error. </span><span class="koboSpan" id="kobo.1082.3">To improve type safety, we can use strongly </span><span class="No-Break"><span class="koboSpan" id="kobo.1083.1">typed hubs.</span></span></p>
<p><span class="koboSpan" id="kobo.1084.1">To use strongly typed hubs, we need to define a hub interface that contains client methods. </span><span class="koboSpan" id="kobo.1084.2">The following code shows how to define a </span><span class="No-Break"><span class="koboSpan" id="kobo.1085.1">hub interface:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1086.1">
public interface IChatClient{
    Task ReceiveMessage(string user, string message);
    Task UserConnected(string user);
    Task UserDisconnected(string user);
}</span></pre>
<p><span class="koboSpan" id="kobo.1087.1">Then, we can update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1088.1">ChatHub</span></strong><span class="koboSpan" id="kobo.1089.1"> class to implement the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1090.1">IChatClient</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1091.1"> interface:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1092.1">
public class ChatHub : Hub&lt;IChatClient&gt;{
    public Task SendMessage(string user, string message)
    {
        return Clients.All.ReceiveMessage(user, message);
    }
    public Task SendMessageToUser(string user, string toUser, string message)
    {
        return Clients.User(toUser).ReceiveMessage(user, message);
    }
    public override async Task OnConnectedAsync()
    {
        await Clients.All.UserConnected(Context.User.Identity.Name);
        await base.OnConnectedAsync();
    }
    public override async Task OnDisconnectedAsync(Exception? </span><span class="koboSpan" id="kobo.1092.2">exception)
    {
        await Clients.All.UserDisconnected(Context.User.Identity.Name);
        await base.OnDisconnectedAsync(exception);
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.1093.1">In the </span><a id="_idIndexMarker1498"/><span class="koboSpan" id="kobo.1094.1">preceding code, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1095.1">SendAsync()</span></strong><span class="koboSpan" id="kobo.1096.1"> method is no longer used. </span><span class="koboSpan" id="kobo.1096.2">Instead, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1097.1">RecieveMessage()</span></strong><span class="koboSpan" id="kobo.1098.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1099.1">UserConnected()</span></strong><span class="koboSpan" id="kobo.1100.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1101.1">UserDisconnected()</span></strong><span class="koboSpan" id="kobo.1102.1"> methods defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1103.1">IChatClient</span></strong><span class="koboSpan" id="kobo.1104.1"> interface. </span><span class="koboSpan" id="kobo.1104.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1105.1">Hub</span></strong><span class="koboSpan" id="kobo.1106.1"> class is generic, so we need to specify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1107.1">IChatClient</span></strong><span class="koboSpan" id="kobo.1108.1"> interface as the generic type argument. </span><span class="koboSpan" id="kobo.1108.2">Now, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1109.1">ChatHub</span></strong><span class="koboSpan" id="kobo.1110.1"> class is strongly typed. </span><span class="koboSpan" id="kobo.1110.2">Note that if you use a strongly typed hub, the</span><a id="_idTextAnchor567"/> <strong class="source-inline"><span class="koboSpan" id="kobo.1111.1">SendAsync()</span></strong><span class="koboSpan" id="kobo.1112.1"> method is no </span><span class="No-Break"><span class="koboSpan" id="kobo.1113.1">longer available.</span></span></p>
<p><span class="koboSpan" id="kobo.1114.1">Next, we will add a feature to allow users to </span><span class="No-Break"><span class="koboSpan" id="kobo.1115.1">join groups.</span></span></p>
<h2 id="_idParaDest-297"><a id="_idTextAnchor568"/><span class="koboSpan" id="kobo.1116.1">Joining groups</span></h2>
<p><span class="koboSpan" id="kobo.1117.1">SignalR allows</span><a id="_idIndexMarker1499"/><span class="koboSpan" id="kobo.1118.1"> users to join groups. </span><span class="koboSpan" id="kobo.1118.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1119.1">Hub</span></strong><span class="koboSpan" id="kobo.1120.1"> class has a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1121.1">Groups</span></strong><span class="koboSpan" id="kobo.1122.1"> property to manage groups. </span><span class="koboSpan" id="kobo.1122.2">The type of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1123.1">Groups</span></strong><span class="koboSpan" id="kobo.1124.1"> property is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1125.1">IGroupManager</span></strong><span class="koboSpan" id="kobo.1126.1"> interface, which provides methods such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1127.1">AddToGroupAsync()</span></strong><span class="koboSpan" id="kobo.1128.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1129.1">RemoveFromGroupAsync()</span></strong><span class="koboSpan" id="kobo.1130.1">, and so on. </span><span class="koboSpan" id="kobo.1130.2">The following code shows how to add a user to a group and remove a user from </span><span class="No-Break"><span class="koboSpan" id="kobo.1131.1">a group:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1132.1">
public async Task AddToGroup(string user, string group){
    await Groups.AddToGroupAsync(Context.ConnectionId, group);
    await Clients.Group(group).ReceiveMessage(Context.User.Identity.Name,
        $"{user} has joined the group {group}. </span><span class="koboSpan" id="kobo.1132.2">Connection Id: {Context.ConnectionId}");
}
public async Task RemoveFromGroup(string user, string group)
{
    await Groups.RemoveFromGroupAsync(Context.ConnectionId, group);
    await Clients.Group(group).ReceiveMessage(Context.User.Identity.Name,
                   $"{user} has left the group {group}. </span><span class="koboSpan" id="kobo.1132.3">Connection Id: {Context.ConnectionId}");
}</span></pre>
<p><span class="koboSpan" id="kobo.1133.1">In the preceding code, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1134.1">Groups</span></strong><span class="koboSpan" id="kobo.1135.1"> property to manage groups. </span><span class="koboSpan" id="kobo.1135.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1136.1">Context.ConnectionId</span></strong><span class="koboSpan" id="kobo.1137.1"> property is used to get the connection ID of the current user. </span><span class="koboSpan" id="kobo.1137.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1138.1">Clients.Group</span></strong><span class="koboSpan" id="kobo.1139.1"> method is used to send a message to all users in the specified group so that they can know who has joined or left </span><span class="No-Break"><span class="koboSpan" id="kobo.1140.1">the group.</span></span></p>
<p><span class="koboSpan" id="kobo.1141.1">Next, we </span><a id="_idIndexMarker1500"/><span class="koboSpan" id="kobo.1142.1">need to update the UI to allow a user to enter the group name. </span><span class="koboSpan" id="kobo.1142.2">Add the following code to the HTML content for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1143.1">divChat</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1144.1"> element:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1145.1">
&lt;label id="lblToGroup"&gt;Group&lt;/label&gt;&lt;input type="text" id="txtToGroup" /&gt;
&lt;button id="btnJoinGroup"&gt;Join Group&lt;/button&gt;
&lt;button id="btnLeaveGroup"&gt;Leave Group&lt;/button&gt;</span></pre>
<p><span class="koboSpan" id="kobo.1146.1">Update the TypeScript code to handle </span><strong class="source-inline"><span class="koboSpan" id="kobo.1147.1">JoinGroup</span></strong><span class="koboSpan" id="kobo.1148.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1149.1">LeaveGroup</span></strong><span class="koboSpan" id="kobo.1150.1"> events. </span><span class="koboSpan" id="kobo.1150.2">The following code shows how to handle the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1151.1">JoinGroup</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1152.1"> event:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1153.1">
btnJoinGroup.addEventListener("click", joinGroup);btnLeaveGroup.addEventListener("click", leaveGroup);
function joinGroup() {
  if (txtToGroup.value) {
    connection
      .invoke("AddToGroup", lblUsername.textContent, txtToGroup.value)
      .catch((err) =&gt; console.error(err.toString()))
      .then(() =&gt; {
        btnJoinGroup.disabled = true;
        btnJoinGroup.style.display = "none";
        btnLeaveGroup.disabled = false;
        btnLeaveGroup.style.display = "inline";
        txtToGroup.readOnly = true;
      });
  }
}
function leaveGroup() {
  if (txtToGroup.value) {
    connection
      .invoke("RemoveFromGroup", lblUsername.textContent, txtToGroup.value)
      .catch((err) =&gt; console.error(err.toString()))
      .then(() =&gt; {
        btnJoinGroup.disabled = false;
        btnJoinGroup.style.display = "inline";
        btnLeaveGroup.disabled = true;
        btnLeaveGroup.style.display = "none";
        txtToGroup.readOnly = false;
      });
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.1154.1">The</span><a id="_idIndexMarker1501"/><span class="koboSpan" id="kobo.1155.1"> preceding code shows two event handlers for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1156.1">JoinGroup</span></strong><span class="koboSpan" id="kobo.1157.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1158.1">LeaveGroup</span></strong><span class="koboSpan" id="kobo.1159.1"> events, which invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1160.1">AddToGroup()</span></strong><span class="koboSpan" id="kobo.1161.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1162.1">RemoveFromGroup()</span></strong><span class="koboSpan" id="kobo.1163.1"> methods on the SignalR </span><span class="No-Break"><span class="koboSpan" id="kobo.1164.1">hub respectively.</span></span></p>
<p><span class="koboSpan" id="kobo.1165.1">The code in the Blazor client is very similar. </span><span class="koboSpan" id="kobo.1165.2">We will not list the code here. </span><span class="koboSpan" id="kobo.1165.3">You can find the code in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1166.1">sample application.</span></span></p>
<p><span class="koboSpan" id="kobo.1167.1">Now, the client should be able to join and leave groups. </span><span class="koboSpan" id="kobo.1167.2">When a user joins or leaves a group, the other users in the group will receive a message, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1168.1">shown next:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer104">
<span class="koboSpan" id="kobo.1169.1"><img alt="Figure 13.10 – Joining and leaving groups" src="image/B18971_13_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1170.1">Figure 13.10 – Joining and leaving groups</span></p>
<p><span class="koboSpan" id="kobo.1171.1">In </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1172.1">Figure 13</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1173.1">.10</span></em><span class="koboSpan" id="kobo.1174.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1175.1">user3</span></strong><span class="koboSpan" id="kobo.1176.1"> joined </span><strong class="source-inline"><span class="koboSpan" id="kobo.1177.1">group1</span></strong><span class="koboSpan" id="kobo.1178.1"> and then left </span><strong class="source-inline"><span class="koboSpan" id="kobo.1179.1">group1</span></strong><span class="koboSpan" id="kobo.1180.1">. </span><span class="koboSpan" id="kobo.1180.2">You can see that the other </span><a id="_idIndexMarker1502"/><span class="koboSpan" id="kobo.1181.1">users in  </span><strong class="source-inline"><span class="koboSpan" id="kobo.1182.1">grou</span><a id="_idTextAnchor569"/><span class="koboSpan" id="kobo.1183.1">p1</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1184.1">received messages.</span></span></p>
<p><span class="koboSpan" id="kobo.1185.1">Next, we will add a feature to allow users to send a message to a </span><span class="No-Break"><span class="koboSpan" id="kobo.1186.1">specific group.</span></span></p>
<h2 id="_idParaDest-298"><a id="_idTextAnchor570"/><span class="koboSpan" id="kobo.1187.1">Sending a message to a group</span></h2>
<p><span class="koboSpan" id="kobo.1188.1">The code</span><a id="_idIndexMarker1503"/><span class="koboSpan" id="kobo.1189.1"> to send a message to a group is very similar to the code to send a message to a specific user. </span><span class="koboSpan" id="kobo.1189.2">The following code shows how to send a message to a group in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1190.1">ChatHub</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1191.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1192.1">
public async Task SendMessageToGroup(string user, string group, string message){
    await Clients.Group(group).ReceiveMessage(user, message);
}</span></pre>
<p><span class="koboSpan" id="kobo.1193.1">The preceding code uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.1194.1">Clients.Group(group)</span></strong><span class="koboSpan" id="kobo.1195.1"> to find connections of the users in the specified group. </span><span class="koboSpan" id="kobo.1195.2">Then, it uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1196.1">ReceiveMessage()</span></strong><span class="koboSpan" id="kobo.1197.1"> method defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1198.1">IChatClient</span></strong><span class="koboSpan" id="kobo.1199.1"> interface to send a message to users in </span><span class="No-Break"><span class="koboSpan" id="kobo.1200.1">the group.</span></span></p>
<p><span class="koboSpan" id="kobo.1201.1">The</span><a id="_idIndexMarker1504"/><span class="koboSpan" id="kobo.1202.1"> Blazor client can invoke this method </span><span class="No-Break"><span class="koboSpan" id="kobo.1203.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1204.1">
private async Task SendMessage(){
    if (_hubConnection != null &amp;&amp; IsConnected)
    {
        if (!string.IsNullOrWhiteSpace(_group) &amp;&amp; _isJoinedGroup)
        {
            await _hubConnection.InvokeAsync("SendMessageToGroup", _username, _group, _message);
        }
        // Omitted for brevity
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.1205.1">We will not list the code for the TypeScript client here. </span><span class="koboSpan" id="kobo.1205.2">You can find the code in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1206.1">sample application.</span></span></p>
<p><span class="koboSpan" id="kobo.1207.1">Now, the client should be able to send a message to a specific group. </span><span class="koboSpan" id="kobo.1207.2">The following figure shows how to send a message to </span><span class="No-Break"><span class="koboSpan" id="kobo.1208.1">a group:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer105">
<span class="koboSpan" id="kobo.1209.1"><img alt="Figure 13.11 – Sending a message to a group" src="image/B18971_13_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1210.1">Figure 13.11 – Sending a message to a group</span></p>
<p><span class="koboSpan" id="kobo.1211.1">You will see a </span><a id="_idIndexMarker1505"/><span class="koboSpan" id="kobo.1212.1">message displayed for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1213.1">user1</span></strong><span class="koboSpan" id="kobo.1214.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1215.1">user3</span></strong><span class="koboSpan" id="kobo.1216.1"> as</span><a id="_idTextAnchor571"/><span class="koboSpan" id="kobo.1217.1"> they are in the same group. </span><span class="koboSpan" id="kobo.1217.2">But </span><strong class="source-inline"><span class="koboSpan" id="kobo.1218.1">user2</span></strong><span class="koboSpan" id="kobo.1219.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1220.1">user4</span></strong><span class="koboSpan" id="kobo.1221.1"> will not see the message because they are not </span><span class="No-Break"><span class="koboSpan" id="kobo.1222.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1223.1">group1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1224.1">.</span></span></p>
<h1 id="_idParaDest-299"><a id="_idTextAnchor572"/><span class="koboSpan" id="kobo.1225.1">Sending messages from other services</span></h1>
<p><span class="koboSpan" id="kobo.1226.1">So far, we have</span><a id="_idIndexMarker1506"/><span class="koboSpan" id="kobo.1227.1"> implemented a chat app that allows users to send messages to other users or groups. </span><span class="koboSpan" id="kobo.1227.2">Sometimes, we need to send messages from other places. </span><span class="koboSpan" id="kobo.1227.3">For example, when an event occurs, we may need to send a message to notify the users. </span><span class="koboSpan" id="kobo.1227.4">In this section, we will explore how to send messages from other services. </span><span class="koboSpan" id="kobo.1227.5">You can find the complete code of the sample in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1228.1">chapter13/v4</span></strong><span class="koboSpan" id="kobo.1229.1"> folder of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1230.1">GitHub repository.</span></span></p>
<p><span class="koboSpan" id="kobo.1231.1">We will add a REST API endpoint to allow other systems to send messages to the SignalR hub. </span><span class="koboSpan" id="kobo.1231.2">Follow these steps to add a REST API endpoint in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1232.1">ChatApp.Server</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1233.1"> application:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1234.1">Create the following models in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1235.1">Models</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1236.1"> folder:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1237.1">
public class SendToAllMessageModel{    public string FromUser { get; set; } = string.Empty;    public string Message { get; set; } = string.Empty;}public class SendToUserMessageModel{    public string FromUser { get; set; } = string.Empty;    public string ToUser { get; set; } = string.Empty;    public string Message { get; set; } = string.Empty;}public class SendToGroupMessageModel{    public string FromUser { get; set; } = string.Empty;    public string GroupName { get; set; } = string.Empty;    public string Message { get; set; } = string.Empty;}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1238.1">These </span><a id="_idIndexMarker1507"/><span class="koboSpan" id="kobo.1239.1">models are used to send messages to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1240.1">SignalR hub.</span></span></p></li> <li><span class="koboSpan" id="kobo.1241.1">Create a new controller or use the existing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1242.1">AccountController</span></strong><span class="koboSpan" id="kobo.1243.1"> class in the sample application. </span><span class="koboSpan" id="kobo.1243.2">We will create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1244.1">ChatController</span></strong><span class="koboSpan" id="kobo.1245.1"> class in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1246.1">Controllers</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1247.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.1248.1">Inject the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1249.1">IHubContext&lt;ChatHub</span></strong><span class="koboSpan" id="kobo.1250.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1251.1">IChatClient&gt;</span></strong><span class="koboSpan" id="kobo.1252.1"> service into the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1253.1">ChatController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1254.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1255.1">
[Route("api/[controller]")][ApiController]public class ChatController(IHubContext&lt;ChatHub, IChatClient&gt; hubContext) : ControllerBase{}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1256.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1257.1">IHubContext&lt;ChatHub, IChatClient&gt;</span></strong><span class="koboSpan" id="kobo.1258.1"> service is used to send messages </span><a id="_idIndexMarker1508"/><span class="koboSpan" id="kobo.1259.1">to clients. </span><span class="koboSpan" id="kobo.1259.2">In this example, we use a strongly typed hub. </span><span class="koboSpan" id="kobo.1259.3">You can also inject the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1260.1">IHubContext&lt;ChatHub&gt;</span></strong><span class="koboSpan" id="kobo.1261.1"> service if you use a normal </span><span class="No-Break"><span class="koboSpan" id="kobo.1262.1">SignalR hub.</span></span></p></li> <li><span class="koboSpan" id="kobo.1263.1">Add the following actions to send messages to all users, a specific user, and a </span><span class="No-Break"><span class="koboSpan" id="kobo.1264.1">specific group:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1265.1">
 [HttpPost("/all")] public async Task&lt;IActionResult&gt; SendToAllMessage([FromBody] SendToAllMessageModel model) {     if (ModelState.IsValid)     {         await hubContext.Clients.All.ReceiveMessage(model.FromUser, model.Message);         return Ok();     }     return BadRequest(ModelState); } [HttpPost("/user")] public async Task&lt;IActionResult&gt; SendToUserMessage([FromBody] SendToUserMessageModel model) {     if (ModelState.IsValid)     {         await hubContext.Clients.User(model.ToUser).ReceiveMessage(model.FromUser, model.Message);         return Ok();     }     return BadRequest(ModelState); } [HttpPost("/group")] public async Task&lt;IActionResult&gt; SendToGroupMessage([FromBody] SendToGroupMessageModel model) {     if (ModelState.IsValid)     {         await hubContext.Clients.Group(model.GroupName).ReceiveMessage(model.FromUser, model.Message);         return Ok();     }     return BadRequest(ModelState); }</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1266.1">The </span><a id="_idIndexMarker1509"/><span class="koboSpan" id="kobo.1267.1">preceding code uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1268.1">hubContext.Clients</span></strong><span class="koboSpan" id="kobo.1269.1"> property to send messages to clients. </span><span class="koboSpan" id="kobo.1269.2">Note that this endpoint is not authenticated. </span><span class="koboSpan" id="kobo.1269.3">You can add authentication and authorization to this endpoint </span><span class="No-Break"><span class="koboSpan" id="kobo.1270.1">if required.</span></span></p><ul><li><span class="koboSpan" id="kobo.1271.1">Run the three applications. </span><span class="koboSpan" id="kobo.1271.2">Use different users to log in and join the group. </span><span class="koboSpan" id="kobo.1271.3">Then, you can test the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1272.1">chat/all</span></strong><span class="koboSpan" id="kobo.1273.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1274.1">chat/user</span></strong><span class="koboSpan" id="kobo.1275.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1276.1">chat/group</span></strong><span class="koboSpan" id="kobo.1277.1"> endpoints using Postman or any other </span><span class="No-Break"><span class="koboSpan" id="kobo.1278.1">HTTP client.</span></span></li></ul></li> </ol>
<p><span class="koboSpan" id="kobo.1279.1">This is how to </span><a id="_idTextAnchor573"/><span class="koboSpan" id="kobo.1280.1">send messages from external services. </span><span class="koboSpan" id="kobo.1280.2">In the next section, we will explore how to manage </span><span class="No-Break"><span class="koboSpan" id="kobo.1281.1">SignalR connections.</span></span></p>
<h1 id="_idParaDest-300"><a id="_idTextAnchor574"/><span class="koboSpan" id="kobo.1282.1">Configuring SignalR hubs and clients</span></h1>
<p><span class="koboSpan" id="kobo.1283.1">SignalR provides a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1284.1">HubOptions</span></strong><span class="koboSpan" id="kobo.1285.1"> class to configure SignalR hubs. </span><span class="koboSpan" id="kobo.1285.2">Also, SignalR clients</span><a id="_idIndexMarker1510"/><span class="koboSpan" id="kobo.1286.1"> have some configuration options. </span><span class="koboSpan" id="kobo.1286.2">In this section, we will explore how to configure SignalR hubs </span><a id="_idTextAnchor575"/><span class="koboSpan" id="kobo.1287.1">and clients. </span><span class="koboSpan" id="kobo.1287.2">You can find the complete code of the sample in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1288.1">chapter13/v5</span></strong><span class="koboSpan" id="kobo.1289.1"> folder of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1290.1">GitHub repository.</span></span></p>
<h2 id="_idParaDest-301"><a id="_idTextAnchor576"/><span class="koboSpan" id="kobo.1291.1">Configuring SignalR hubs</span></h2>
<p><span class="koboSpan" id="kobo.1292.1">Here are some of </span><a id="_idIndexMarker1511"/><span class="koboSpan" id="kobo.1293.1">the configuration options for </span><span class="No-Break"><span class="koboSpan" id="kobo.1294.1">SignalR hubs:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1295.1">KeepAliveInterval</span></strong><span class="koboSpan" id="kobo.1296.1">: This property determines the interval at which a keep-alive message is sent to clients. </span><span class="koboSpan" id="kobo.1296.2">If a client does not receive a message from the server within this period of time, it will send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1297.1">ping</span></strong><span class="koboSpan" id="kobo.1298.1"> message to the server in order to maintain the connection. </span><span class="koboSpan" id="kobo.1298.2">When changing this value, it is important to also adjust the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1299.1">serverTimeoutInMilliseconds</span></strong><span class="koboSpan" id="kobo.1300.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1301.1">ServerTimeout</span></strong><span class="koboSpan" id="kobo.1302.1"> option in the client. </span><span class="koboSpan" id="kobo.1302.2">For best results, it is recommended to set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1303.1">serverTimeoutInMilliseconds</span></strong><span class="koboSpan" id="kobo.1304.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1305.1">ServerTimeout</span></strong><span class="koboSpan" id="kobo.1306.1"> option to a value that is double the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1307.1">KeepAliveInterval</span></strong><span class="koboSpan" id="kobo.1308.1"> property. </span><span class="koboSpan" id="kobo.1308.2">The default value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1309.1">KeepAliveInterval</span></strong><span class="koboSpan" id="kobo.1310.1"> is </span><span class="No-Break"><span class="koboSpan" id="kobo.1311.1">15 seconds.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1312.1">ClientTimeoutInterval</span></strong><span class="koboSpan" id="kobo.1313.1">: This property determines the interval at which the server will consider the client disconnected if it has not received a message from the client. </span><span class="koboSpan" id="kobo.1313.2">It is recommended to set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1314.1">ClientTimeoutInterval</span></strong><span class="koboSpan" id="kobo.1315.1"> to a value that is double the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1316.1">KeepAliveInterval</span></strong><span class="koboSpan" id="kobo.1317.1"> property. </span><span class="koboSpan" id="kobo.1317.2">The default value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1318.1">ClientTimeoutInterval</span></strong><span class="koboSpan" id="kobo.1319.1"> is </span><span class="No-Break"><span class="koboSpan" id="kobo.1320.1">30 seconds.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1321.1">EnableDetailedErrors</span></strong><span class="koboSpan" id="kobo.1322.1">: This </span><a id="_idIndexMarker1512"/><span class="koboSpan" id="kobo.1323.1">property determines whether detailed error messages are sent to the client. </span><span class="koboSpan" id="kobo.1323.2">The default value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1324.1">EnableDetailedErrors</span></strong><span class="koboSpan" id="kobo.1325.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1326.1">false</span></strong><span class="koboSpan" id="kobo.1327.1"> as error messages may contain </span><span class="No-Break"><span class="koboSpan" id="kobo.1328.1">sensitive information.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1329.1">MaximumReceiveMessageSize</span></strong><span class="koboSpan" id="kobo.1330.1">: This property determines the maximum size of a message that the server will accept. </span><span class="koboSpan" id="kobo.1330.2">The default value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1331.1">MaximumReceiveMessageSize</span></strong><span class="koboSpan" id="kobo.1332.1"> is 32 KB. </span><span class="koboSpan" id="kobo.1332.2">Do not set this value to a very large value as it may cause </span><strong class="bold"><span class="koboSpan" id="kobo.1333.1">denial-of-service</span></strong><span class="koboSpan" id="kobo.1334.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1335.1">DoS</span></strong><span class="koboSpan" id="kobo.1336.1">) attacks</span><a id="_idIndexMarker1513"/><span class="koboSpan" id="kobo.1337.1"> and consume a lot </span><span class="No-Break"><span class="koboSpan" id="kobo.1338.1">of memory.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1339.1">MaximumParallelInvocationsPerClient</span></strong><span class="koboSpan" id="kobo.1340.1">: This property determines the maximum number of hub method invocations that can be executed in parallel per client. </span><span class="koboSpan" id="kobo.1340.2">The default value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1341.1">MaximumParallelInvocationsPerClient</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1342.1">is 1.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1343.1">StreamBufferCapacity</span></strong><span class="koboSpan" id="kobo.1344.1">: This property determines the maximum number of items that can be buffered in a client upload stream. </span><span class="koboSpan" id="kobo.1344.2">The default value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1345.1">StreamBufferCapacity</span></strong><span class="koboSpan" id="kobo.1346.1"> is 10. </span><span class="koboSpan" id="kobo.1346.2">We will introduce streaming in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1347.1">next section.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1348.1">There are two ways to configure SignalR hubs. </span><span class="koboSpan" id="kobo.1348.2">The first way is to provide a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1349.1">HubOptions</span></strong><span class="koboSpan" id="kobo.1350.1"> object </span><a id="_idIndexMarker1514"/><span class="koboSpan" id="kobo.1351.1">to all hubs. </span><span class="koboSpan" id="kobo.1351.2">The following code shows how to configure the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1352.1">ChatHub</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1353.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1354.1">
builder.Services.AddSignalR(options =&gt;{
    options.KeepAliveInterval = TimeSpan.FromSeconds(10);
    options.ClientTimeoutInterval = TimeSpan.FromSeconds(20);
    options.EnableDetailedErrors = true;
});</span></pre>
<p><span class="koboSpan" id="kobo.1355.1">The second way is to configure the SignalR hubs for each hub. </span><span class="koboSpan" id="kobo.1355.2">The following code shows how to configure the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1356.1">ChatHub</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1357.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1358.1">
builder.Services.AddSignalR().AddHubOptions&lt;ChatHub&gt;(options =&gt;{
    options.KeepAliveInterval = TimeSpan.FromSeconds(10);
    options.ClientTimeoutInterval = TimeSpan.FromSeconds(20);
    options.EnableDetailedErrors = true;
});</span></pre>
<p><span class="koboSpan" id="kobo.1359.1">The preceding code is useful if you have multiple hubs and you want to configure </span><span class="No-Break"><span class="koboSpan" id="kobo.1360.1">them differently.</span></span></p>
<p><span class="koboSpan" id="kobo.1361.1">Note that if you change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1362.1">KeepAliveInterval</span></strong><span class="koboSpan" id="kobo.1363.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1364.1">ClientTimeoutInterval</span></strong><span class="koboSpan" id="kobo.1365.1"> property of the SignalR hub, you need to update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1366.1">serverTimeoutInMilliseconds</span></strong><span class="koboSpan" id="kobo.1367.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1368.1">ServerTimeout</span></strong><span class="koboSpan" id="kobo.1369.1"> option in the clients as well. </span><span class="koboSpan" id="kobo.1369.2">The following code shows how to configure the </span><span class="No-Break"><span class="koboSpan" id="kobo.1370.1">TypeScript client:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1371.1">
connection = new signalR.HubConnectionBuilder()  .withUrl("https://localhost:7159/chatHub", {
    // Omitted for brevity
  })
  .build();
// The following configuration must match the configuration in the server project
connection.keepAliveIntervalInMilliseconds = 10000;
connection.serverTimeoutInMilliseconds = 20000;</span></pre>
<p><span class="koboSpan" id="kobo.1372.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1373.1">HubConnection</span></strong><span class="koboSpan" id="kobo.1374.1"> object has the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1375.1">keepAliveIntervalInMilliseconds</span></strong><span class="koboSpan" id="kobo.1376.1"> property and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1377.1">serverTimeoutInMilliseconds</span></strong><span class="koboSpan" id="kobo.1378.1"> property, which can be used to match the </span><a id="_idIndexMarker1515"/><span class="koboSpan" id="kobo.1379.1">configuration in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1380.1">server project.</span></span></p>
<p><span class="koboSpan" id="kobo.1381.1">Similarly, you can configure the Blazor client </span><span class="No-Break"><span class="koboSpan" id="kobo.1382.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1383.1">
_hubConnection = new HubConnectionBuilder()    .WithUrl("https://localhost:7159/chatHub", options =&gt;
    {
        // Omitted for brevity
    })
    .Build();
_hubConnection.KeepAliveInterval = TimeSpan.FromSeconds(10);
_hubConnection.ServerTimeout = TimeSpan.FromSeconds(20);
You can also configure these properties on the HubConnectionBuilder object as shown below:
_hubConnection = new HubConnectionBuilder()
    .WithUrl("https://localhost:7159/chatHub", options =&gt;
    {
        // Omitted for brevity
    })
    .WithKeepAliveInterval(TimeSpan.FromSeconds(10))
    .WithServerTimeout(TimeSpan.FromSeconds(20))
    .Build();</span></pre>
<p><span class="koboSpan" id="kobo.1384.1">Make sure that </span><a id="_idIndexMarker1516"/><span class="koboSpan" id="kobo.1385.1">the v</span><a id="_idTextAnchor577"/><span class="koboSpan" id="kobo.1386.1">alues of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1387.1">KeepAliveInterval</span></strong><span class="koboSpan" id="kobo.1388.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1389.1">ClientTimeout/ServerTimeout</span></strong><span class="koboSpan" id="kobo.1390.1"> properties are the same in the server and </span><span class="No-Break"><span class="koboSpan" id="kobo.1391.1">the client.</span></span></p>
<h2 id="_idParaDest-302"><a id="_idTextAnchor578"/><span class="koboSpan" id="kobo.1392.1">HTTP configuration options</span></h2>
<p><span class="koboSpan" id="kobo.1393.1">SignalR</span><a id="_idIndexMarker1517"/><span class="koboSpan" id="kobo.1394.1"> can automatically negotiate the transport protocol with the client. </span><span class="koboSpan" id="kobo.1394.2">The default transport protocol is WebSockets. </span><span class="koboSpan" id="kobo.1394.3">If the client does not support WebSockets, SignalR will use SSE or long polling. </span><span class="koboSpan" id="kobo.1394.4">You can configure HTTP options for SignalR. </span><span class="koboSpan" id="kobo.1394.5">The following code shows how to configure HTTP options for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1395.1">ChatHub</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1396.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1397.1">
app.MapHub&lt;ChatHub&gt;("/chatHub", options =&gt;{
    options.Transports = HttpTransportType.WebSockets | HttpTransportType.LongPolling;
    options.WebSockets.CloseTimeout = TimeSpan.FromSeconds(10);
    options.LongPolling.PollTimeout = TimeSpan.FromSeconds(120);
});</span></pre>
<p><span class="koboSpan" id="kobo.1398.1">The preceding code configures HTTP options for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1399.1">ChatHub</span></strong><span class="koboSpan" id="kobo.1400.1"> class using a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1401.1">HttpConnectionDispatcherOptions</span></strong><span class="koboSpan" id="kobo.1402.1"> object. </span><span class="koboSpan" id="kobo.1402.2">In this sample, we configured the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1403.1">Transports</span></strong><span class="koboSpan" id="kobo.1404.1"> property to use WebSockets and long polling, but not SSE. </span><span class="koboSpan" id="kobo.1404.2">In addition, we configured the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1405.1">CloseTimeout</span></strong><span class="koboSpan" id="kobo.1406.1"> property of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1407.1">WebSockets</span></strong><span class="koboSpan" id="kobo.1408.1"> property to 10 seconds, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1409.1">PollTimeout</span></strong><span class="koboSpan" id="kobo.1410.1"> property of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1411.1">LongPolling</span></strong><span class="koboSpan" id="kobo.1412.1"> property to 120 seconds. </span><span class="koboSpan" id="kobo.1412.2">The default value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1413.1">CloseTimeout</span></strong><span class="koboSpan" id="kobo.1414.1"> property is 5 seconds, meaning that after the server closes, the connection will be terminated if clients cannot close the connection within 5 seconds. </span><span class="koboSpan" id="kobo.1414.2">The default value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1415.1">PollTimeout</span></strong><span class="koboSpan" id="kobo.1416.1"> property is 90 seconds, meaning that the server will terminate a poll request after waiting for 90 seconds and then create a new </span><span class="No-Break"><span class="koboSpan" id="kobo.1417.1">poll request.</span></span></p>
<p><span class="koboSpan" id="kobo.1418.1">The allowed transports can be configured in the client as well. </span><span class="koboSpan" id="kobo.1418.2">We can configure the TypeScript client </span><span class="No-Break"><span class="koboSpan" id="kobo.1419.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1420.1">
connection = new signalR.HubConnectionBuilder()  .withUrl("https://localhost:7159/chatHub", {
    transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.LongPolling,
  })
  .build();</span></pre>
<p><span class="koboSpan" id="kobo.1421.1">The following</span><a id="_idIndexMarker1518"/><span class="koboSpan" id="kobo.1422.1"> code shows how to configure the </span><span class="No-Break"><span class="koboSpan" id="kobo.1423.1">Blazor client:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1424.1">
_hubConnection = new HubConnectionBuilder()    .WithUrl("https://localhost:7159/chatHub", options =&gt;
    {
        options.Transports = HttpTransportType.WebSockets | HttpTransportType.LongPolling;
    })
    .Build();</span></pre>
<p><span class="koboSpan" id="kobo.1425.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1426.1">HttpTransportTyp</span><a id="_idTextAnchor579"/><span class="koboSpan" id="kobo.1427.1">e</span></strong><span class="koboSpan" id="kobo.1428.1"> enum has a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1429.1">FlagsAttribute</span></strong><span class="koboSpan" id="kobo.1430.1"> attribute, so you can use the bitwise </span><strong class="source-inline"><span class="koboSpan" id="kobo.1431.1">OR</span></strong><span class="koboSpan" id="kobo.1432.1"> operator to combine multiple </span><span class="No-Break"><span class="koboSpan" id="kobo.1433.1">transport protocols.</span></span></p>
<h2 id="_idParaDest-303"><a id="_idTextAnchor580"/><span class="koboSpan" id="kobo.1434.1">Automatically reconnecting</span></h2>
<p><span class="koboSpan" id="kobo.1435.1">Sometimes, due</span><a id="_idIndexMarker1519"/><span class="koboSpan" id="kobo.1436.1"> to network issues, the SignalR connection may be disconnected. </span><span class="koboSpan" id="kobo.1436.2">For example, if the user’s device is switched from Wi-Fi to cellular, or if the user’s device is in a tunnel, the SignalR connection may be disconnected. </span><span class="koboSpan" id="kobo.1436.3">In this case, we want the client to automatically reconnect to </span><span class="No-Break"><span class="koboSpan" id="kobo.1437.1">the server:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1438.1">SignalR allows the client to automatically reconnect to the server if the connection is dropped. </span><span class="koboSpan" id="kobo.1438.2">The following code shows how to configure the TypeScript client to automatically reconnect to </span><span class="No-Break"><span class="koboSpan" id="kobo.1439.1">the server:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1440.1">
connection = new signalR.HubConnectionBuilder()  .withUrl("https://localhost:7159/chatHub", {    // Omitted for brevity  })  .withAutomaticReconnect()  .build();</span></pre></li> <li><span class="koboSpan" id="kobo.1441.1">Similarly, you </span><a id="_idIndexMarker1520"/><span class="koboSpan" id="kobo.1442.1">can configure the Blazor client </span><span class="No-Break"><span class="koboSpan" id="kobo.1443.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1444.1">
_hubConnection = new HubConnectionBuilder()    .WithUrl("https://localhost:7159/chatHub", options =&gt;    {        // Omittted for brevity    })    .WithAutomaticReconnect()    .Build();</span></pre></li> <li><span class="koboSpan" id="kobo.1445.1">By default, when the connection is dropped, the client will try to reconnect to the SignalR server in 0, 2, 10, and 30 seconds. </span><span class="koboSpan" id="kobo.1445.2">You can configure the retry policy </span><span class="No-Break"><span class="koboSpan" id="kobo.1446.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1447.1">
connection = new signalR.HubConnectionBuilder()  .withUrl("https://localhost:7159/chatHub", {    // Omittted for brevity  })  .withAutomaticReconnect([0, 5, 20])  .build();</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1448.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1449.1">withAutomaticReconnect()</span></strong><span class="koboSpan" id="kobo.1450.1"> method accepts an array of numbers to configure the delay duration in milliseconds. </span><span class="koboSpan" id="kobo.1450.2">In the preceding code, the client will try to reconnect to the server in 0, 5, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1451.1">20 seconds.</span></span></p></li> <li><span class="koboSpan" id="kobo.1452.1">In the</span><a id="_idIndexMarker1521"/><span class="koboSpan" id="kobo.1453.1"> Blazor client, you can configure the retry policy </span><span class="No-Break"><span class="koboSpan" id="kobo.1454.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1455.1">
_hubConnection = new HubConnectionBuilder()    .WithUrl("https://localhost:7159/chatHub", options =&gt;    {        // Omitted for brevity    })    .WithAutomaticReconnect(new[] { TimeSpan.FromSeconds(0), TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(20) })    .Build();</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1456.1">The preceding code configures the same retry policy as the </span><span class="No-Break"><span class="koboSpan" id="kobo.1457.1">TypeScript client.</span></span></p></li> <li><span class="koboSpan" id="kobo.1458.1">To test the automatic reconnect feature, we can add a label to show the connection status. </span><span class="koboSpan" id="kobo.1458.2">Add the following code to the HTML content for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1459.1">divChat</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1460.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1461.1">
&lt;div class="form-group mb-3"&gt;  &lt;label&gt;Status&lt;/label&gt;  &lt;label id="lblStatus"&gt;&lt;/label&gt;&lt;/div&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.1462.1">Then, update the TypeScript code to show the </span><span class="No-Break"><span class="koboSpan" id="kobo.1463.1">connection status:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1464.1">
connection.onclose(() =&gt; {  lblStatus.textContent = "Disconnected.";});connection.onreconnecting((error) =&gt; {  lblStatus.textContent = `${error} Reconnecting...`;});connection.onreconnected((connectionId) =&gt; {  lblStatus.textContent = `Connected. </span><span class="koboSpan" id="kobo.1464.2">${connectionId}`;});await connection.start();lblStatus.textContent = `Connected. </span><span class="koboSpan" id="kobo.1464.3">${connection.connectionId}`;</span></pre></li> <li><span class="koboSpan" id="kobo.1465.1">We can </span><a id="_idIndexMarker1522"/><span class="koboSpan" id="kobo.1466.1">also enable debug logging to see the connection status. </span><span class="koboSpan" id="kobo.1466.2">The following code shows how to </span><span class="No-Break"><span class="koboSpan" id="kobo.1467.1">do this:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1468.1">
connection = new signalR.HubConnectionBuilder()  .withUrl("https://localhost:7159/chatHub", {    // Omitted for brevity  })  .configureLogging(signalR.LogLevel.Debug)  // Omitted for brevity</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1469.1">You can find the complete code in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1470.1">sample application.</span></span></p></li> <li><span class="koboSpan" id="kobo.1471.1">Run the SignalR server and the TypeScript client. </span><span class="koboSpan" id="kobo.1471.2">Press </span><em class="italic"><span class="koboSpan" id="kobo.1472.1">F12</span></em><span class="koboSpan" id="kobo.1473.1"> to open the developer tools for the TypeScript client. </span><span class="koboSpan" id="kobo.1473.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.1474.1">Network</span></strong><span class="koboSpan" id="kobo.1475.1"> tab, and you can change network conditions to simulate network issues. </span><span class="koboSpan" id="kobo.1475.2">For example, you can change the network to </span><strong class="bold"><span class="koboSpan" id="kobo.1476.1">Offline</span></strong><span class="koboSpan" id="kobo.1477.1"> to simulate network disconnection, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1478.1">shown next:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer106">
<span class="koboSpan" id="kobo.1479.1"><img alt="Figure 13.12 – Simulating network disconnection in Chrome developer tools" src="image/B18971_13_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1480.1">Figure 13.12 – Simulating network disconnection in Chrome developer tools</span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.1481.1">After </span><a id="_idIndexMarker1523"/><span class="koboSpan" id="kobo.1482.1">you change the network to </span><strong class="bold"><span class="koboSpan" id="kobo.1483.1">Offline</span></strong><span class="koboSpan" id="kobo.1484.1">, wait for a few seconds (depending on the timeout configuration), and you should see the client automatically reconnect to the server, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1485.1">shown next:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer107">
<span class="koboSpan" id="kobo.1486.1"><img alt="Figure 13.13 – The client automatically reconnects to the server" src="image/B18971_13_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1487.1">Figure 13.13 – The client automatically reconnects to the server</span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.1488.1">Change the network back to Online, and you should see that the client reconnects to the server, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1489.1">shown next:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer108">
<span class="koboSpan" id="kobo.1490.1"><img alt="Figure 13.14 – The client reconnects to the server after the network is back online" src="image/B18971_13_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1491.1">Figure 13.14 – The client reconnects to the server after the network is back online</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1492.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1493.1">If the client fails to reconnect to the server after trying four times, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1494.1">onclose</span></strong><span class="koboSpan" id="kobo.1495.1"> event will be triggered. </span><span class="koboSpan" id="kobo.1495.2">You can add the event handler for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1496.1">onclose</span></strong><span class="koboSpan" id="kobo.1497.1"> event to handle the connection close event. </span><span class="koboSpan" id="kobo.1497.2">For example, you can notify the user that the connection is closed and ask the user to refresh the page or manually reconnect to </span><span class="No-Break"><span class="koboSpan" id="kobo.1498.1">the server.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1499.1">SignalR in</span><a id="_idIndexMarker1524"/><span class="koboSpan" id="kobo.1500.1"> ASP.NET Core 8.0 supports stateful reconnect, allowing the server to temporarily store messages when the client is disconnected. </span><span class="koboSpan" id="kobo.1500.2">Upon reconnection, the client will use the same connection ID, and the server will replay any messages that were sent while the client was disconnected. </span><span class="koboSpan" id="kobo.1500.3">This ensures that the client’s state is maintained and that no messages </span><span class="No-Break"><span class="koboSpan" id="kobo.1501.1">are lost.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.1502.1">To enable stateful reconnect, we need to configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1503.1">AllowStatefulReconnects</span></strong><span class="koboSpan" id="kobo.1504.1"> option for the SignalR hub endpoint </span><span class="No-Break"><span class="koboSpan" id="kobo.1505.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1506.1">
app.MapHub&lt;ChatHub&gt;("/chatHub", options =&gt;{    // Omitted for brevity    options.AllowStatefulReconnects = true;});</span></pre></li> <li><span class="koboSpan" id="kobo.1507.1">By default, the maximum buffer size of the stateful reconnect is 100,000 bytes. </span><span class="koboSpan" id="kobo.1507.2">You can change the buffer size </span><span class="No-Break"><span class="koboSpan" id="kobo.1508.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1509.1">
builder.Services.AddSignalR(options =&gt;{    // Omitted for brevity    options.StatefulReconnectBufferSize = 200000;});</span></pre></li> <li><span class="koboSpan" id="kobo.1510.1">Then, we </span><a id="_idIndexMarker1525"/><span class="koboSpan" id="kobo.1511.1">can configure the TypeScript client to use the stateful reconnect </span><span class="No-Break"><span class="koboSpan" id="kobo.1512.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1513.1">
connection = new signalR.HubConnectionBuilder()  .withUrl("https://localhost:7159/chatHub", {    // Omitted for brevity  })  .withAutomaticReconnect()  .withStatefulReconnect({ bufferSize: 200000 })  .build();</span></pre></li> <li><span class="koboSpan" id="kobo.1514.1">Similarly, you can configure the Blazor client </span><span class="No-Break"><span class="koboSpan" id="kobo.1515.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1516.1">
_hubConnection = new HubConnectionBuilder()    .WithUrl("https://localhost:7159/chatHub", options =&gt;    {        // Omitted for brevity    })    .WithAutomaticReconnect()    .WithStatefulReconnect()    .Build();</span></pre></li> <li><span class="koboSpan" id="kobo.1517.1">To configure</span><a id="_idIndexMarker1526"/><span class="koboSpan" id="kobo.1518.1"> the buffer size of the Blazor client, you can configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1519.1">HubConnectionOptions</span></strong><span class="koboSpan" id="kobo.1520.1"> object </span><span class="No-Break"><span class="koboSpan" id="kobo.1521.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1522.1">
var builder = new HubConnectionBuilder()    .WithUrl("https://localhost:7159/chatHub", options =&gt;    {        // Omitted for brevity    })    .WithAutomaticReconnect()    .WithStatefulReconnect();builder.Services.Configure&lt;HubConnectionOptions&gt;(options =&gt;{    options.StatefulReconnectBufferSize = 200000;});_hubConnection = builder.Build();</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1523.1">Besides the automatic reconnect feature, you can also manually reconnect to the SignalR server if the conn</span><a id="_idTextAnchor581"/><span class="koboSpan" id="kobo.1524.1">ection is dropped. </span><span class="koboSpan" id="kobo.1524.2">You can add an event handler for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1525.1">onclose</span></strong><span class="koboSpan" id="kobo.1526.1"> event or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1527.1">Closed</span></strong><span class="koboSpan" id="kobo.1528.1"> event to handle the connection </span><span class="No-Break"><span class="koboSpan" id="kobo.1529.1">close event.</span></span></p>
<h2 id="_idParaDest-304"><a id="_idTextAnchor582"/><span class="koboSpan" id="kobo.1530.1">Scaling SignalR</span></h2>
<p><span class="koboSpan" id="kobo.1531.1">So far, we have</span><a id="_idIndexMarker1527"/><span class="koboSpan" id="kobo.1532.1"> implemented a chat app that allows users to send messages to other users or groups. </span><span class="koboSpan" id="kobo.1532.2">We have also explored how to manage SignalR connections. </span><span class="koboSpan" id="kobo.1532.3">You can also use a similar approach to build a real-time notification system, a real-time dashboard, and so on. </span><span class="koboSpan" id="kobo.1532.4">However, the application can only run on a single server. </span><span class="koboSpan" id="kobo.1532.5">If we want to scale the application, for example, using a load balancer to distribute requests to multiple servers, server </span><em class="italic"><span class="koboSpan" id="kobo.1533.1">A</span></em><span class="koboSpan" id="kobo.1534.1"> does not know the connections on </span><span class="No-Break"><span class="koboSpan" id="kobo.1535.1">server </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1536.1">B</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1537.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1538.1">SignalR requires a </span><a id="_idIndexMarker1528"/><span class="koboSpan" id="kobo.1539.1">persistent connection between the client and the server. </span><span class="koboSpan" id="kobo.1539.2">That means requests from the same client must be routed to the same server. </span><span class="koboSpan" id="kobo.1539.3">This is called </span><em class="italic"><span class="koboSpan" id="kobo.1540.1">sticky sessions</span></em><span class="koboSpan" id="kobo.1541.1"> or </span><em class="italic"><span class="koboSpan" id="kobo.1542.1">session affinity</span></em><span class="koboSpan" id="kobo.1543.1">. </span><span class="koboSpan" id="kobo.1543.2">This is required if you have multiple SignalR servers. </span><span class="koboSpan" id="kobo.1543.3">Besides this requirement, there are some other considerations when you </span><span class="No-Break"><span class="koboSpan" id="kobo.1544.1">scale SignalR:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1545.1">If you host the application in Azure, you can use Azure SignalR Service. </span><span class="koboSpan" id="kobo.1545.2">Azure SignalR Service is a fully managed service that helps you scale the SignalR application without worrying about the infrastructure. </span><span class="koboSpan" id="kobo.1545.3">With Azure SignalR Service, you do not need to use sticky sessions as all clients connect to Azure SignalR Service. </span><span class="koboSpan" id="kobo.1545.4">This service takes on the responsibility of managing connections and freeing up resources on the SignalR servers. </span><span class="koboSpan" id="kobo.1545.5">For more information, please refer </span><span class="No-Break"><span class="koboSpan" id="kobo.1546.1">to </span></span><a href="https://learn.microsoft.com/en-us/azure/azure-signalr/signalr-overview"><span class="No-Break"><span class="koboSpan" id="kobo.1547.1">https://learn.microsoft.com/en-us/azure/azure-signalr/signalr-overview</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1548.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1549.1">If you host the application on your own infrastructure or other cloud providers, you can use Redis backplane to synchronize the connections. </span><span class="koboSpan" id="kobo.1549.2">The Redis backplane is a Redis server that uses the pub/sub feature to forward messages to other SignalR servers. </span><span class="koboSpan" id="kobo.1549.3">However, this approach requires sticky sessions for most cases, and the SignalR application instances require additional resources to manage connections. </span><span class="koboSpan" id="kobo.1549.4">There are some other SignalR backplane providers, such as SQL Server, NCache, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1550.1">so on.</span></span><a id="_idTextAnchor583"/></li>
</ul>
<p><span class="koboSpan" id="kobo.1551.1">We will not cover details of how to scale SignalR in this book. </span><span class="koboSpan" id="kobo.1551.2">You can find more information in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1552.1">official documentation.</span></span></p>
<h1 id="_idParaDest-305"><a id="_idTextAnchor584"/><span class="koboSpan" id="kobo.1553.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1554.1">SignalR is a powerful library that simplifies the process of building real-time web applications. </span><span class="koboSpan" id="kobo.1554.2">In this chapter, we explored how to use SignalR to build a chat app. </span><span class="koboSpan" id="kobo.1554.3">We introduced basic concepts of SignalR, such as hubs, clients, and connections. </span><span class="koboSpan" id="kobo.1554.4">We created clients using TypeScript and Blazor, which demonstrated how to use both TypeScript and .NET to build SignalR clients. </span><span class="koboSpan" id="kobo.1554.5">We also discussed how to send messages to a specific user or group and how to secure SignalR connections using JWT authentication. </span><span class="koboSpan" id="kobo.1554.6">Additionally, we explored how to configure SignalR hubs and clients, such as configuring the keep-alive interval, configuring HTTP options, and configuring the automatic </span><span class="No-Break"><span class="koboSpan" id="kobo.1555.1">reconnect feature.</span></span></p>
<p><span class="koboSpan" id="kobo.1556.1">Although we have covered a lot of features, there is still more to explore, such as streaming. </span><span class="koboSpan" id="kobo.1556.2">For more information, please refer to the official documentation: </span><a href="https://learn.microsoft.com/en-us/aspnet/core/signalr/introduction"><span class="koboSpan" id="kobo.1557.1">https://learn.microsoft.com/en-us/aspnet/core/signalr/introduction</span></a><span class="koboSpan" id="kobo.1558.1">. </span><span class="koboSpan" id="kobo.1558.2">In the next chapter, we will explore how to deploy ASP.NET </span><span class="No-Break"><span class="koboSpan" id="kobo.1559.1">Core applications.</span></span></p>
</div>
</body></html>