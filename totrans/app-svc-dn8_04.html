<html><head></head><body>
  <div class="Basic-Text-Frame" id="_idContainer156">
    <h1 class="chapterNumber">4</h1>
    <h1 class="chapterTitle" id="_idParaDest-165">Managing NoSQL Data Using Azure Cosmos DB</h1>
    <p class="normal">This chapter is about managing NoSQL data by using Azure Cosmos DB. You will learn about some of the key concepts of Cosmos DB like its APIs, ways to model your data, and throughput provisioning, which influences costs. You will create some Cosmos DB resources using the local emulator and in the Azure cloud. Then you will learn how to work with more traditional data using the Core (SQL) API.</p>
    <p class="normal">In an optional online-only section, you can learn how to work with graph data using the Gremlin API.</p>
    <p class="normal">This chapter will cover the following topics:</p>
    <ul>
      <li class="bulletList">Understanding NoSQL databases</li>
      <li class="bulletList">Creating Cosmos DB resources</li>
      <li class="bulletList">Manipulating data with the Core (SQL) API</li>
      <li class="bulletList">Exploring server-side programming</li>
      <li class="bulletList">Cleaning up Azure resources</li>
    </ul>
    <h1 class="heading-1" id="_idParaDest-166">Understanding NoSQL databases</h1>
    <p class="normal">Two of the <a id="_idIndexMarker324"/>most common places to store data are in a <strong class="keyWord">Relational Database Management System</strong> (<strong class="keyWord">RDBMS</strong>) such as SQL Server, PostgreSQL, MySQL, and SQLite, or in a <strong class="keyWord">NoSQL</strong> database such as Azure Cosmos DB, Redis, MongoDB, and Apache Cassandra.</p>
    <p class="normal">Relational databases were invented in the 1970s. They are queried with <strong class="keyWord">Structured Query Language </strong>(<strong class="keyWord">SQL</strong>). At<a id="_idIndexMarker325"/> the time, data storage costs were high, so they reduced data duplication as much as possible via a process known as <em class="italic">normalization</em>. Data is stored in tabular structures with rows and columns that are tricky to refactor once in production. They can be difficult and expensive to scale.</p>
    <p class="normal">NoSQL databases <a id="_idIndexMarker326"/>do not just mean “no SQL;” they can also mean “not only SQL.” They were invented in the 2000s, after the internet and the web had become popular and adopted much of the learning from that era of software. </p>
    <p class="normal">They are designed for massive scalability and high performance, and to make programming easier by providing maximum flexibility and allowing schema changes at any time because they do not enforce a structure.</p>
    <h2 class="heading-2" id="_idParaDest-167">Cosmos DB and its APIs</h2>
    <p class="normal">Azure<a id="_idIndexMarker327"/> Cosmos DB is<a id="_idIndexMarker328"/> a NoSQL data store<a id="_idIndexMarker329"/> that supports multiple APIs. Its native API is SQL-based. It also supports alternative APIs like MongoDB, Cassandra, and Gremlin.</p>
    <p class="normal">Azure Cosmos DB stores<a id="_idIndexMarker330"/> data in <strong class="keyWord">atom-record-sequence </strong>(<strong class="keyWord">ARS</strong>) format. You interact with this data via an API that you choose when you create the database:</p>
    <ul>
      <li class="bulletList">The <strong class="keyWord">API for MongoDB</strong> supports<a id="_idIndexMarker331"/> recent MongoDB wire protocol versions, which allow existing clients to work with the data as if they are interacting with an actual MongoDB database. Tools like <code class="inlineCode">mongodump</code> and <code class="inlineCode">mongorestore</code> can be used to move any existing data into Azure Cosmos DB. You can check the latest MongoDB support at the following link: <a href="https://learn.microsoft.com/en-us/azure/cosmos-db/mongodb/mongodb-introduction#how-the-api-works"><span class="url">https://learn.microsoft.com/en-us/azure/cosmos-db/mongodb/mongodb-introduction#how-the-api-works</span></a>.</li>
      <li class="bulletList">The <strong class="keyWord">API for Cassandra</strong> supports <a id="_idIndexMarker332"/>the <strong class="keyWord">Cassandra Query Language</strong> (<strong class="keyWord">CQL</strong>) wire <a id="_idIndexMarker333"/>protocol version 4, which allows existing clients to work with the data as if they are interacting with an actual Cassandra database.</li>
      <li class="bulletList">For a new project, sometimes known as a “green field” project, Microsoft recommends<a id="_idIndexMarker334"/> the <strong class="keyWord">Core (SQL) API</strong>.</li>
      <li class="bulletList">For existing projects that use alternative APIs, you could choose to use the appropriate API so that your clients and tools do not need to be updated while gaining the benefits of data stored in Azure Cosmos DB. This reduces migration costs.</li>
      <li class="bulletList">If the <a id="_idIndexMarker335"/>relationships between data items have metadata that needs analyzing, then using the <strong class="keyWord">Gremlin API for Cosmos DB</strong> to treat Cosmos DB as a graph data store is a good choice.</li>
    </ul>
    <div class="packt_tip">
      <p class="normal"><strong class="keyWord">Good Practice</strong>: If you are unsure which API to choose, select Core (SQL) as the default.</p>
    </div>
    <p class="normal">In this book, we will first use the native Core (SQL) API for Cosmos DB. This allows the developer to query JSON documents using a language like SQL. The Core (SQL) API uses JSON’s type system and JavaScript’s function system. </p>
    <h2 class="heading-2" id="_idParaDest-168">Document modeling</h2>
    <p class="normal">A<a id="_idIndexMarker336"/> typical JSON document representing a product from the Northwind database, the example database that we used in <em class="chapterRef">Chapter 2</em>, <em class="italic">Managing Relational Data Using SQL Server</em>, when stored in Azure Cosmos DB might look like the following:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"productId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"productName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Chai"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"supplier"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"supplierId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"companyName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Exotic Liquids"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"contactName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Charlotte Cooper"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Address"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"</span><span class="hljs-string">49 Gilbert St."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"City"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"London"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Country"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"UK"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Phone"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(171) 555-2222"</span>
  <span class="hljs-punctuation">},</span>
  <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"categoryId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"categoryName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Beverages"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Soft drinks, coffees, teas, beers, and ales"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"image"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://myaccount.blob.core.windows.net/categories/beverages.png"</span>
  <span class="hljs-punctuation">},</span>
  <span class="hljs-attr">"quantityPerUnit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10 boxes x 20 bags"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitPrice"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18.0000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitsInStock"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">39</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitsOnOrder"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"reorderLevel"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"discontinued"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span>
<span class="hljs-punctuation">}</span>
</code></pre>
    <p class="normal">Unlike<a id="_idIndexMarker337"/> with a relational database model, it is common to <strong class="keyWord">embed</strong> related data, which involves duplicating data such as the category and supplier information across multiple products. This is good practice if the related data is bounded.</p>
    <p class="normal">For example, for a product, there will only ever be one supplier and one category, so those relationships are bounded to one, which means limited to one each. If we were modeling a category and decided to embed its related products, then that could be poor practice because having all the product details as an array would be unbounded. Instead, we might choose to only store a unique identifier for each product and reference the product details stored elsewhere. </p>
    <p class="normal">You should also consider how frequently the related data is updated. The more frequently it needs to be updated, the more you should avoid embedding it. If related data is unbounded but infrequently updated, then embedding might still be a good choice.</p>
    <p class="normal">Deliberately <a id="_idIndexMarker338"/>but carefully <strong class="keyWord">denormalizing</strong> parts of your data model implies that you will need to execute fewer queries and updates for common operations, reducing costs both in money and performance.</p>
    <p class="normal">Use embedding (denormalized data) when:</p>
    <ul>
      <li class="bulletList">The relationships are contained, like property owned by a person, or the children of a parent.</li>
      <li class="bulletList">The relationships are one-to-one or one-to-few, i.e., the related data is bounded.</li>
      <li class="bulletList">The related data needs infrequent updates.</li>
      <li class="bulletList">The related data often or always needs to be included in query results.</li>
    </ul>
    <div class="packt_tip">
      <p class="normal"><strong class="keyWord">Good Practice</strong>: Denormalized data models provide better read performance but worse write performance.</p>
    </div>
    <p class="normal">Imagine that you want to model an article and its comments on a popular news website. The comments are unbounded and, for an engaging article, would frequently be added to, especially during the hours or days after it is published while it is topical news. Or imagine an investor with stock they trade. The current price of that stock would be frequently updated.</p>
    <p class="normal">In these <a id="_idIndexMarker339"/>scenarios, you would want to <strong class="keyWord">normalize</strong> the related data either wholly or partially. For example, you could choose to embed the most liked comments that will be shown at the top of the list directly under the article. Other comments could be stored separately and referenced using their primary keys. You could choose to embed stock information for long-term investments that are held for many years, like the price the investment was purchased at and the price on the first day of each month since then (but not the live current price), but reference stock information for short-term investments for day trading.</p>
    <p class="normal">Use referencing (normalized data) when:</p>
    <ul>
      <li class="bulletList">The relationships are one-to-many or many-to-many and unbounded.</li>
      <li class="bulletList">The related data needs frequent updates.</li>
    </ul>
    <div class="packt_tip">
      <p class="normal"><strong class="keyWord">Good Practice</strong>: Normalized data models require more queries, which worsens read performance but provides better write performance.</p>
    </div>
    <div class="note">
      <p class="normal">You can read more <a id="_idIndexMarker340"/>about modeling documents in Azure Cosmos DB at the following link: <a href="https://learn.microsoft.com/en-us/azure/cosmos-db/sql/modeling-data"><span class="url">https://learn.microsoft.com/en-us/azure/cosmos-db/sql/modeling-data</span></a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-169">Consistency levels</h2>
    <p class="normal">Azure Cosmos DB<a id="_idIndexMarker341"/> is distributed globally and scales elastically. It relies on replication to provide low latency and high availability all over the world. To achieve this, you must accept and choose tradeoffs.</p>
    <p class="normal">To ease the life of a programmer, you want total consistency of data. If data is modified anywhere in the world, then any subsequent read operation should see that change. The best consistency is <a id="_idIndexMarker342"/>known as <strong class="keyWord">linearizability</strong>. Linearizability increases the latency of write operations and reduces the availability of read operations because it must wait for replication to occur globally. </p>
    <p class="normal">A more relaxed consistency level improves latency and availability at the cost of potentially increased complexity for the programmer because data might be inconsistent.</p>
    <p class="normal">Most NoSQL databases only offer two levels of consistency: strong and eventual. Azure Cosmos DB offers five to provide exactly the level of consistency that suits your project.</p>
    <p class="normal">You choose<a id="_idIndexMarker343"/> the level of data consistency, and this will be guaranteed <a id="_idIndexMarker344"/>by the <strong class="keyWord">Service-Level Agreement</strong> (<strong class="keyWord">SLA</strong>), as shown in the following, ordered from the strongest to the weakest:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Strong</strong> consistency<a id="_idIndexMarker345"/> guarantees linearizability across all regions globally. All other consistency levels are collectively known as “relaxed.” You might ask, “Why not set Strong consistency in all scenarios?” If you are familiar with relational databases, then you should be familiar with transaction isolation levels. These are similar conceptually to NoSQL consistency levels. The strongest level of transaction isolation level is <code class="inlineCode">SERIALIZABLE</code>. Weaker levels include <code class="inlineCode">READUNCOMMITTED</code> and <code class="inlineCode">REPEATABLE READ</code>. You would not want to use <code class="inlineCode">SERIALIZABLE</code> in all scenarios for the same reason you wouldn’t want to use Strong consistency in all scenarios. They both slow down operations, and sometimes, to an unacceptable point. Your users will complain about a lack of performance, or even an inability to perform a task at all. So, you need to look carefully at each task you are attempting and determine the minimal required level for that task. Some developers prefer to default to the strongest level and weaken it for scenarios that are “too slow.” Other developers prefer to default to the weakest level and strengthen it for scenarios that introduce too much inconsistency. As you become more familiar with NoSQL development, you will be able to judge quicker what level is best for different scenarios.</li>
      <li class="bulletList"><strong class="keyWord">Bounded staleness</strong> consistency<a id="_idIndexMarker346"/> guarantees the ability to read your own write within the write region, monotonic read within the region (meaning the values do not increase or decrease, like a monotone voice, and remain in a consistent order), and consistent prefix, and the staleness of read data is restricted to a specific number of versions for which the reads lag behind the writes within a specified time interval. For example, the time interval might be<a id="_idIndexMarker347"/> ten minutes and the number of versions might be three. That would mean that a maximum of three writes can be made in any ten-minute period before a read operation must reflect those changes.</li>
      <li class="bulletList"><strong class="keyWord">Session</strong> consistency<a id="_idIndexMarker348"/> guarantees the ability to read your own write within the write region, monotonic read, and consistent prefix.</li>
      <li class="bulletList"><strong class="keyWord">Consistent prefix</strong> consistency <a id="_idIndexMarker349"/>only guarantees the order that writes can then be read.</li>
      <li class="bulletList"><strong class="keyWord">Eventual</strong> consistency <a id="_idIndexMarker350"/>does not guarantee that the order of writes will match the order of reads. When writes pause, reads will eventually catch up as the replicas synchronize. It is<a id="_idIndexMarker351"/> possible for a client to read values older than the ones it read before. <strong class="keyWord">Probabilistic Bounded Staleness </strong>(<strong class="keyWord">PBS</strong>) is a measurement that shows how eventual your consistency is currently. You can monitor it in the Azure portal.<div class="note">
          <p class="normal">You can read more details <a id="_idIndexMarker352"/>about consistency levels at the following link: <a href="https://learn.microsoft.com/en-us/azure/cosmos-db/consistency-levels"><span class="url">https://learn.microsoft.com/en-us/azure/cosmos-db/consistency-levels</span></a>.</p>
        </div>
      </li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-170">Hierarchy of components</h2>
    <p class="normal">The<a id="_idIndexMarker353"/> hierarchy of components for Azure Cosmos DB is:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Account</strong>: You can create up to 50 accounts via the Azure portal.</li>
      <li class="bulletList"><strong class="keyWord">Database</strong>: You can have an unlimited number of databases per account. We will create a database named <code class="inlineCode">Northwind</code>.</li>
      <li class="bulletList"><strong class="keyWord">Container</strong>: You can have an unlimited number of containers per database. We will create a container named <code class="inlineCode">Products</code>.</li>
      <li class="bulletList"><strong class="keyWord">Partition</strong>: These are created and managed automatically within a container, and you can have an unlimited number. Partitions are either logical or physical. A <strong class="keyWord">logical partition</strong> contains <a id="_idIndexMarker354"/>items with the same partition key and defines the scope for transactions. Multiple logical partitions are <a id="_idIndexMarker355"/>mapped to a <strong class="keyWord">physical partition</strong>. Small containers may only need one physical partition. You should not concern yourself with physical partitions since you have no control over them. Focus on deciding what your partition key should be because that defines the items stored in a logical partition.</li>
      <li class="bulletList"><strong class="keyWord">Item</strong>: This is a stored entity in a container. We will add items that represent each product, like Chai tea.</li>
    </ul>
    <p class="normal">“Item” is a <a id="_idIndexMarker356"/>deliberately generic term and is used by the Core (SQL) API to refer to a JSON document but can also be used for the other APIs. The other APIs also have their own more specific terms:</p>
    <ul>
      <li class="bulletList">Cassandra uses <strong class="keyWord">row</strong>.</li>
      <li class="bulletList">MongoDB uses <strong class="keyWord">document</strong>.</li>
      <li class="bulletList">Graph databases like Gremlin use <strong class="keyWord">vertex</strong> and <strong class="keyWord">edge</strong>.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-171">Throughput provisioning</h2>
    <p class="normal">Throughput is <a id="_idIndexMarker357"/>measured as <strong class="keyWord">request units per second </strong>(<strong class="keyWord">RU/s</strong>). A single <strong class="keyWord">request unit </strong>(<strong class="keyWord">RU</strong>) is about<a id="_idIndexMarker358"/> the cost of performing a <code class="inlineCode">GET</code> request<a id="_idIndexMarker359"/> for a 1KB document using its unique identifier. Creating, updating, and deleting cost more RUs; for example, a query might cost 46.54 RUs, or a delete operation might cost 14.23 RUs.</p>
    <p class="normal">Throughput must be provisioned in advance, although you can scale up and down at any time in increments or decrements of 100 RU/s. You will be billed per hour.</p>
    <div class="note">
      <p class="normal">You can discover how much a request costs in RUs by getting the <code class="inlineCode">RequestCharge</code> property. You can learn more at the following link: <a href="https://learn.microsoft.com/en-us/azure/cosmos-db/sql/find-request-unit-charge"><span class="url">https://learn.microsoft.com/en-us/azure/cosmos-db/sql/find-request-unit-charge</span></a>. We will output this property in all the example code that we run in this chapter.</p>
    </div>
    <p class="normal">You must provision throughput to run CRUD operations (creates, reads, updates, and deletes). You must estimate throughput by calculating the number of operations you’ll need to support throughout the year. For example, a commerce website might need to expect much greater throughput at Thanksgiving in the US or Singles Day in China.</p>
    <p class="normal">Most throughput settings are applied at the container level, or you can do so at the database level and have the settings shared across all containers. Throughput is distributed equally among partitions.</p>
    <p class="normal">Once provisioned throughput is exhausted, Cosmos DB will start rate-limiting access requests, and your code will have to wait and retry later. Luckily, we will use the .NET SDK for Cosmos DB, which automatically reads the <code class="inlineCode">retry-after</code> response header and retries after that time limit.</p>
    <p class="normal">Using the Azure portal, you can provision between 400 RU/s and 250,000 RU/s. At the time of writing, the 400 RU/s minimum would cost about US$35 per month. You would then also need to add the cost of storage depending on how many GBs you want to store, for example, US$5 for a few GBs.</p>
    <div class="note">
      <p class="normal">The free tier of Cosmos DB allows up to 1,000 RU/s and 25 GB of storage. You can use a calculator at the following link: <a href="https://cosmos.azure.com/capacitycalculator/"><span class="url">https://cosmos.azure.com/capacitycalculator/</span></a>.</p>
    </div>
    <p class="normal">Factors<a id="_idIndexMarker360"/> that affect RUs:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Item size</strong>: A 2KB document costs twice as much as a 1KB document.</li>
      <li class="bulletList"><strong class="keyWord">Indexed properties</strong>: Indexing all item properties costs more than indexing a subset of properties.</li>
      <li class="bulletList"><strong class="keyWord">Consistency</strong>: Strict consistency costs twice as many RUs as looser consistency.</li>
      <li class="bulletList"><strong class="keyWord">Query complexity</strong>: The number of predicates (filters), the number of results, the number of custom functions, projections, the size of the dataset, and so on, all increase the cost in RUs.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-172">Partition strategies</h2>
    <p class="normal">A <a id="_idIndexMarker361"/>good partition strategy allows a Cosmos DB database to grow and efficiently run queries and transactions. A good partition strategy is about choosing a <a id="_idIndexMarker362"/>suitable <strong class="keyWord">partition key</strong>. It is set for a container and cannot be changed.</p>
    <p class="normal">The partition key should be chosen to evenly distribute operations across the database to avoid hot partitions, meaning a partition that handles more requests, so it is busier than other partitions. </p>
    <p class="normal">A property that will be unique for an item and will often be used to look up an item might be a good choice. For example, for US citizens, a person’s social security number. However, partition keys do not have to be unique. The partition key value will be combined with an item ID to uniquely identify an item.</p>
    <p class="normal">Partitions <a id="_idIndexMarker363"/>are automatically created by Cosmos DB when needed. There is no negative impact on your applications and services from the automatic creation and deletion of partitions. Each partition can grow up to a maximum of 20 GB. Cosmos DB will automatically split partitions when needed.</p>
    <p class="normal">A container should have a partition key that possesses these attributes:</p>
    <ul>
      <li class="bulletList">High cardinality so that items are distributed evenly across partitions.</li>
      <li class="bulletList">Evenly distributed requests across partitions.</li>
      <li class="bulletList">Evenly distributed storage across partitions.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-173">Data storage design</h2>
    <p class="normal">With<a id="_idIndexMarker364"/> relational databases, the schemas are rigid and inflexible. The Northwind database’s products are all food-related, so the schema might not change much. But if you are building a commerce system for a company that sells everything from clothes to electronic equipment to books, then a semi-structured data store like the following would be better:</p>
    <ul>
      <li class="bulletList">Clothing: Sizes like S, M L, XL; brand; color.</li>
      <li class="bulletList">Shoes: Sizes like 7, 8, 9; brand; color.</li>
      <li class="bulletList">Televisions: Sizes like 40”, 52”; screen technology like OLED, LCD; brand.</li>
      <li class="bulletList">Books: Number of pages; author; publisher.</li>
    </ul>
    <p class="normal">Being schema-less, Azure Cosmos DB can add new types of products with different structures and properties simply by adding a new product with that structure to a container. You will see examples of this in the code that you write later in this chapter.</p>
    <h2 class="heading-2" id="_idParaDest-174">Migrating data to Cosmos DB</h2>
    <p class="normal">The<a id="_idIndexMarker365"/> open-source <strong class="keyWord">Azure Cosmos DB Data Migration Tool</strong> can<a id="_idIndexMarker366"/> import data into Azure Cosmos DB from many different sources, including Azure Table Storage, SQL databases, MongoDB, text files in JSON and CSV formats, HBase, and more.</p>
    <div class="note">
      <p class="normal">We will not use this migration tool in this book, so if you think it will be useful to you, then you can learn how to use it at the following link: <a href="https://github.com/Azure/azure-documentdb-datamigrationtool"><span class="url">https://github.com/Azure/azure-documentdb-datamigrationtool</span></a>.</p>
    </div>
    <p class="normal">That’s quite enough theory. Now, let’s look at something more practical, how to create Cosmos DB resources so we can work with them in code.</p>
    <h1 class="heading-1" id="_idParaDest-175">Creating Cosmos DB resources</h1>
    <p class="normal">To see <a id="_idIndexMarker367"/>Azure Cosmos DB in action, first, we must create Cosmos DB resources. We can manually create them in the cloud using the Azure portal or programmatically create them using the Azure Cosmos DB .NET SDK. Azure Cosmos DB resources created in the cloud have a cost unless you use a trial or free account.</p>
    <p class="normal">You can also create Azure Cosmos DB resources locally using an emulator, which will cost you nothing. At the time of writing, the Azure Cosmos DB Emulator only supports Windows. If you want to use Linux or macOS, then you can try to use the Linux Emulator, which is currently in preview, or you could host the emulator in a Windows virtual machine.</p>
    <h2 class="heading-2" id="_idParaDest-176">Using an emulator on Windows to create Azure Cosmos DB resources </h2>
    <p class="normal">If you do not<a id="_idIndexMarker368"/> have a Windows computer, then just read through this section without completing the steps yourself, and then in the next section, you will use the Azure portal to create Azure Cosmos DB resources.</p>
    <p class="normal">Let’s use the Azure Cosmos DB Emulator on Windows to create Azure Cosmos DB resources like a database and container:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Download and install the latest version of the Azure Cosmos DB Emulator on your local Windows computer from the following link (direct to the MSI installer file): <a href="https://aka.ms/cosmosdb-emulator"><span class="url">https://aka.ms/cosmosdb-emulator</span></a>.
    <div class="note">
      <p class="normal">The most recent version of the emulator at the time of writing is 2.14.12, released on March 20, 2023. Earlier versions of the emulator are not supported by the developer team. If you have an older version installed, then remove it and install the latest.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Make <a id="_idIndexMarker369"/>sure the Azure Cosmos DB Emulator is running.</li>
      <li class="numberedList">The <strong class="screenText">Azure Cosmos DB Emulator</strong> user interface should start automatically, but if not, start your favorite browser and navigate to <code class="inlineCode">https://localhost:8081/_explorer/index.html</code>.</li>
      <li class="numberedList">Note that the Azure Cosmos DB emulator is running, hosted at <code class="inlineCode">localhost</code> on port <code class="inlineCode">8081</code>, with a <strong class="screenText">Primary Key</strong> that you will need to securely connect to the service, as shown in <em class="italic">Figure 4.1</em>:
    <figure class="mediaobject"><img alt="" src="../Images/B19587_04_01.png"/></figure>
    <p class="packt_figref">Figure 4.1: The Azure Cosmos DB Emulator user interface on Windows</p>
    <div class="note">
      <p class="normal">The default primary key for the emulator is the same value for everyone. You can specify your own key value by starting the emulator at the command line with the <code class="inlineCode">/key</code> switch. You can learn about starting the emulator at the command line at the following link: <a href="https://learn.microsoft.com/en-us/azure/cosmos-db/emulator-command-line-parameters"><span class="url">https://learn.microsoft.com/en-us/azure/cosmos-db/emulator-command-line-parameters</span></a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">In the navigation bar on the left, click <strong class="screenText">Explorer</strong>, and then click <strong class="screenText">New Container</strong>.</li>
      <li class="numberedList">Complete<a id="_idIndexMarker370"/> the following information:<ul>
          <li class="bulletList">For <strong class="screenText">Database id</strong>, select <strong class="screenText">Create new</strong> and enter <code class="inlineCode">Northwind</code>. </li>
          <li class="bulletList">Select the <strong class="screenText">Share throughput across containers</strong> check box.</li>
          <li class="bulletList">For <strong class="screenText">Database throughput</strong>, select <strong class="screenText">Autoscale</strong>. </li>
          <li class="bulletList">Set <strong class="screenText">Database max RU/s</strong> as <code class="inlineCode">4000</code>. This will use a minimum of 400 RU/s and autoscale up to 4,000 RU/s when needed.</li>
          <li class="bulletList">For <strong class="screenText">Container id</strong>, enter <code class="inlineCode">Products</code>.</li>
          <li class="bulletList">For <strong class="screenText">Partition key</strong>, enter <code class="inlineCode">/productId</code>.</li>
        </ul>
      </li>
      <li class="numberedList">Click <strong class="screenText">OK</strong>.</li>
      <li class="numberedList">In the tree on the left, expand the <strong class="screenText">Northwind</strong> database, expand the <strong class="screenText">Products</strong> container, and select <strong class="screenText">Items</strong>, as shown in <em class="italic">Figure 4.2</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_04_02.png"/></figure>
    <p class="packt_figref">Figure 4.2: The empty items in the Products container in the Northwind database</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">In the toolbar, click <strong class="screenText">New Item</strong>.</li>
      <li class="numberedList">Replace the contents of the editor window with a JSON document that represents a product named <code class="inlineCode">Chai</code>, as shown in the following JSON:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"productId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"productName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Chai"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"supplier"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"supplierId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"companyName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Exotic Liquids"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"contactName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Charlotte Cooper"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Address"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"49 Gilbert St."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"City"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"London"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Country"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"UK"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Phone"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(171) 555-2222"</span>
  <span class="hljs-punctuation">},</span>
  <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"</span><span class="hljs-attr">categoryId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"categoryName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Beverages"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Soft drinks, coffees, teas, beers, and ales"</span>
  <span class="hljs-punctuation">},</span>
  <span class="hljs-attr">"quantityPerUnit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10 boxes x 20 bags"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitPrice"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitsInStock"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">39</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitsOnOrder"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"reorderLevel"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"discontinued"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span>
<span class="hljs-punctuation">}</span>
</code></pre>
      </li>
      <li class="numberedList">In the<a id="_idIndexMarker371"/> toolbar, click <strong class="screenText">Save</strong>, and note the extra properties that are automatically added to any item, including <code class="inlineCode">id</code>, <code class="inlineCode">_etag</code>, and <code class="inlineCode">_ts</code>, as shown highlighted in the following JSON:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"productId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"productName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Chai"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"supplier"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"supplierId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
        ...
    <span class="hljs-attr">"reorderLevel"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"discontinued"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span>
<span class="code-highlight"><strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"id"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"2ad4c71d-d0e4-4ebd-a146-bcf052f8d7d6"</strong><strong class="hljs-punctuation-slc">,</strong></span>
<span class="code-highlight"><strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"_rid"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"bmAuAJ9o6I8BAAAAAAAAAA=="</strong><strong class="hljs-punctuation-slc">,</strong></span>
<span class="code-highlight"><strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"_self"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"dbs/bmAuAA==/colls/bmAuAJ9o6I8=/docs/bmAuAJ9o6I8BAAAAAAAAAA==/"</strong><strong class="hljs-punctuation-slc">,</strong></span>
<span class="code-highlight"><strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"_etag"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"\"00000000-0000-0000-8fc2-ec4d49ea01d8\""</strong><strong class="hljs-punctuation-slc">,</strong></span>
<span class="code-highlight"><strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"_attachments"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"attachments/"</strong><strong class="hljs-punctuation-slc">,</strong></span>
<span class="code-highlight"><strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"_ts"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-number-slc">1656952035</strong></span>
<span class="hljs-punctuation">}</span>
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">New Item</strong>.</li>
      <li class="numberedList">Replace the contents of the editor window with a JSON document that represents a product named <code class="inlineCode">Chang</code>, as shown in the following JSON:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"productId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"productName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Chang"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"supplier"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"supplierId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"companyName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Exotic Liquids"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"contactName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Charlotte Cooper"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Address"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"49 Gilbert St."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"City"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"London"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Country"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"UK"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"</span><span class="hljs-attr">Phone"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(171) 555-2222"</span>
  <span class="hljs-punctuation">},</span>
  <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"categoryId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"categoryName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Beverages"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Soft drinks, coffees, teas, beers, and ales"</span>
  <span class="hljs-punctuation">},</span>
  <span class="hljs-attr">"quantityPerUnit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"24 - 12 oz bottles"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitPrice"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitsInStock"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">17</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitsOnOrder"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">40</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"reorderLevel"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">25</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"discontinued"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span>
<span class="hljs-punctuation">}</span>
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Save</strong>.</li>
      <li class="numberedList">Click <strong class="screenText">New Item</strong>.</li>
      <li class="numberedList">Replace<a id="_idIndexMarker372"/> the contents of the editor window with a JSON document that represents a product named <code class="inlineCode">Aniseed Syrup</code>, as shown in the following JSON:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"productId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"productName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Aniseed Syrup"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"supplier"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"supplierId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"</span><span class="hljs-attr">companyName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Exotic Liquids"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"contactName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Charlotte Cooper"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Address"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"49 Gilbert St."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"City"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"London"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Country"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"UK"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Phone"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(171) 555-2222"</span>
  <span class="hljs-punctuation">},</span>
  <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"categoryId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"categoryName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Condiments"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Sweet and savory sauces, relishes, spreads, and seasonings"</span>
  <span class="hljs-punctuation">},</span>
  <span class="hljs-attr">"quantityPerUnit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12 - 550 ml bottles"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitPrice"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitsInStock"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">13</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"unitsOnOrder"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">70</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"reorderLevel"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">25</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"discontinued"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span>
<span class="hljs-punctuation">}</span>
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Save</strong>.</li>
      <li class="numberedList">Click <a id="_idIndexMarker373"/>the first item in the list and note that all the items have been automatically assigned GUID values for their <code class="inlineCode">id</code> properties, as shown in <em class="italic">Figure 4.3</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_04_03.png"/></figure>
    <p class="packt_figref">Figure 4.3: A saved JSON document item in the Azure Cosmos DB emulator</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="19">In the <a id="_idIndexMarker374"/>toolbar, click <strong class="screenText">New SQL Query</strong>, and note the default query text is <code class="inlineCode">SELECT * FROM c</code>.</li>
      <li class="numberedList">Modify the query text to return all products supplied by <code class="inlineCode">Exotic Liquids</code>; in the toolbar, click <strong class="screenText">Execute Query</strong>, and note that all three products are included in the array of results, as shown in <em class="italic">Figure 4.4</em> and in the following query:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> c <span class="hljs-keyword">WHERE</span> c.supplier.companyName <span class="hljs-operator">=</span> "Exotic Liquids"
</code></pre>
      
    <figure class="mediaobject"><img alt="" src="../Images/B19587_04_04.png"/></figure>
    <p class="packt_figref">Figure 4.4: A query to return all products supplied by Exotic Liquids</p>
    <div class="note">
      <p class="normal">Keywords are case-insensitive, so <code class="inlineCode">WHERE</code> is treated the same as <code class="inlineCode">Where</code> or <code class="inlineCode">where</code>. Property names are case-sensitive so <code class="inlineCode">CompanyName</code> is different from <code class="inlineCode">companyName</code>, and will return zero results.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="21">Modify <a id="_idIndexMarker375"/>the query text to return all products in category 2, as shown in the following query:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> c <span class="hljs-keyword">WHERE</span> c.category.categoryId <span class="hljs-operator">=</span> <span class="hljs-number">2</span>
</code></pre>
      </li>
      <li class="numberedList">Execute the query and note that one product is included in the array of results.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-177">Using the Azure portal to create Azure Cosmos DB resources</h2>
    <div class="note">
      <p class="normal">If you would prefer to only use the Azure Cosmos DB Emulator to avoid any costs, then feel free to skip this section, or just read through it without completing the steps yourself.</p>
    </div>
    <p class="normal">Now, let’s use the Azure portal to create Azure Cosmos DB resources like an account, database, and<a id="_idIndexMarker376"/> container in the cloud:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">If you do not have an Azure account, then you can sign up for one for free at the following link: <a href="https://azure.microsoft.com/free/"><span class="url">https://azure.microsoft.com/free/</span></a>.</li>
      <li class="numberedList">Navigate to the Azure portal and sign in: <a href="https://portal.azure.com/"><span class="url">https://portal.azure.com/</span></a>.</li>
      <li class="numberedList">In the Azure portal menu, click <strong class="screenText">+ Create a resource</strong>.</li>
      <li class="numberedList">On the <strong class="screenText">Create a resource</strong> page, search for, or click, <strong class="screenText">Azure Cosmos DB</strong>, and then on the <strong class="screenText">Azure Cosmos DB</strong> page, click <strong class="screenText">Create</strong>.</li>
      <li class="numberedList">On the <strong class="screenText">Which API best suits your workload?</strong> page, in the <strong class="screenText">Azure Cosmos DB for NoSQL</strong> box, note the description, <strong class="screenText">Azure Cosmos DB’s core, or native API for working with documents. Supports fast, flexible development with familiar SQL query language and client libraries for .NET, JavaScript, Python, and Java.</strong>, and then click the <strong class="screenText">Create</strong> button.</li>
      <li class="numberedList">On the <strong class="screenText">Basics</strong> tab:<ul>
          <li class="bulletList">Select your <strong class="screenText">Subscription</strong>. Mine is named <code class="inlineCode">Pay-As-You-Go</code>.</li>
          <li class="bulletList">Select a <strong class="screenText">Resource Group</strong> or create a new one. I used the name <code class="inlineCode">apps-services-book</code>.</li>
          <li class="bulletList">Enter an Azure Cosmos DB <strong class="screenText">Account Name</strong>. I used <code class="inlineCode">apps-services-book</code>.</li>
          <li class="bulletList">Select a <strong class="screenText">Location</strong>. I chose <strong class="screenText">(Europe) UK South</strong> as it is the closest to me.</li>
          <li class="bulletList">Set <strong class="screenText">Capacity mode</strong> to <strong class="screenText">Provisioned throughput</strong>.</li>
          <li class="bulletList">Set <strong class="screenText">Apply Free Tier Discount</strong> to <strong class="screenText">Do not apply</strong>. 
        <div class="packt_tip">
          <p class="normal"><strong class="keyWord">Good Practice</strong>: Only apply the free tier discount now if you want this account to be the <em class="italic">only</em> account within your subscription to be on the free tier. You might be better off saving this discount for another account that you might use for a real project, rather than a temporary learning account while reading this book. With Azure Cosmos DB free tier, you will get the first 1,000 RU/s and 25 GB of storage for free in an account. You can only enable a free tier on one account per subscription. Microsoft estimates this has a value of $64/month.</p>
        </div></li>
        </ul>
        <ul>
          <li class="bulletList">Select the <strong class="screenText">Limit total account throughput</strong> check box.</li>
        </ul>
      </li>
      <li class="numberedList">Click the <strong class="screenText">Next: Global Distribution</strong> button and review the options but leave them at their defaults.</li>
      <li class="numberedList">Click <a id="_idIndexMarker377"/>the <strong class="screenText">Next: Networking</strong> button and review the options but leave them at their defaults.</li>
      <li class="numberedList">Click the <strong class="screenText">Next: Backup Policy</strong> button and review the options but leave them at their defaults.</li>
      <li class="numberedList">Click the <strong class="screenText">Next: Encryption</strong> button and review the options but leave them at their defaults.</li>
      <li class="numberedList">Click the <strong class="screenText">Review + create</strong> button.</li>
      <li class="numberedList">Note the <strong class="screenText">Validation Success</strong> message, review the summary, and then click the <strong class="screenText">Create</strong> button.</li>
      <li class="numberedList">Wait for the deployment to complete. This will take a few minutes.</li>
      <li class="numberedList">Click the <strong class="screenText">Go to resource</strong> button. Note that you are probably directed to the <strong class="screenText">Quick Start</strong> page with steps to follow to create a container and so on, depending on if this is the first time that you have created an Azure Cosmos DB account.</li>
      <li class="numberedList">In the left navigation, click <strong class="screenText">Overview</strong>, and note the information about your Azure Cosmos DB account, as shown in <em class="italic">Figure 4.5</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_04_05.png"/></figure>
    <p class="packt_figref">Figure 4.5: Azure Cosmos DB account Overview page</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="16">In the navigation on the left, in the <strong class="screenText">Settings</strong> section, click <strong class="screenText">Keys</strong>, and note the <strong class="screenText">URI</strong> and <strong class="screenText">PRIMARY KEY</strong> needed to programmatically work with this Azure Cosmos DB account, as <a id="_idIndexMarker378"/>shown in <em class="italic">Figure 4.6</em>:
    <figure class="mediaobject"><img alt="" src="../Images/B19587_04_06.png"/></figure>
    <p class="packt_figref">Figure 4.6: Keys to programmatically work with the Azure Cosmos DB account</p>
    <div class="packt_tip">
      <p class="normal"><strong class="keyWord">Good Practice</strong>: Unlike the primary key that is shared by all developers of the Cosmos DB emulator, your Cosmos DB primary keys in Azure are unique and must be kept secret. I deleted the Cosmos DB account that I used to write this chapter so the keys in the screenshot above are useless.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="17">In the navigation on the left, click <strong class="screenText">Data Explorer</strong>, and if a video pops up, then close it.</li>
      <li class="numberedList">In the toolbar, click <strong class="screenText">New Container</strong>.</li>
      <li class="numberedList">Complete the steps listed in the emulator section, <em class="italic">Using an emulator on Windows to create Azure Cosmos DB resources</em>, starting at <em class="italic">step 6</em> where you fill in the information about the new container, and going up to the end of that section.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-178">Using a .NET app to create Azure Cosmos DB resources</h2>
    <p class="normal">Next, we <a id="_idIndexMarker379"/>will create a console app project for creating the same Azure Cosmos DB resources in either the local emulator or in the cloud, depending on which URI and primary key you choose to use:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to create a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Console App</strong> / <code class="inlineCode">console</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter04</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.CosmosDb.SqlApi</code></li>
        </ul>
      </li>
      <li class="numberedList">In the project file, treat warnings as errors, add a package reference for Azure Cosmos, add a project reference to the Northwind data context project that you created in <em class="chapterRef">Chapter 3</em>, <em class="italic">Building Entity Models for SQL Server Using EF Core</em>, and import the <code class="inlineCode">Console</code> class statically and globally, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;Project Sdk=<span class="hljs-string">"Microsoft.NET.Sdk"</span>&gt;
  &lt;PropertyGroup&gt;
    &lt;OutputType&gt;Exe&lt;/OutputType&gt;
    &lt;TargetFramework&gt;net8<span class="hljs-number">.0</span>&lt;/TargetFramework&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
<span class="code-highlight"><strong class="hljs-slc">    &lt;TreatWarningsAsErrors&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/TreatWarningsAsErrors&gt;</strong></span>
  &lt;/PropertyGroup&gt;
<span class="code-highlight"><strong class="hljs-slc">  &lt;ItemGroup&gt;</strong></span>
<span class="code-highlight"><strong class="hljs-slc">    &lt;PackageReference Include=</strong><strong class="hljs-string-slc">"Microsoft.Azure.Cosmos"</strong><strong class="hljs-slc"> Version=</strong><strong class="hljs-string-slc">"3.37.0"</strong><strong class="hljs-slc"> /&gt;</strong></span>
<span class="code-highlight"><strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong></span>
<span class="code-highlight"><strong class="hljs-slc">  &lt;ItemGroup&gt;</strong></span>
<span class="code-highlight"><strong class="hljs-slc">    &lt;ProjectReference Include=</strong><strong class="hljs-string-slc">"..\..\Chapter03\Northwind.Common.DataContext</strong></span>
<span class="code-highlight"><strong class="hljs-string-slc">.SqlServer\Northwind.Common.DataContext.SqlServer.csproj"</strong><strong class="hljs-slc"> /&gt;</strong></span>
<span class="code-highlight"><strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong></span>
<span class="code-highlight"><strong class="hljs-slc">  &lt;ItemGroup&gt;</strong></span>
<span class="code-highlight"><strong class="hljs-slc">    &lt;Using Include=</strong><strong class="hljs-string-slc">"System.Console"</strong><strong class="hljs-slc"> Static=</strong><strong class="hljs-string-slc">"true"</strong><strong class="hljs-slc"> /&gt;</strong></span>
<span class="code-highlight"><strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong></span>
&lt;/Project&gt;
</code></pre>
      </li>
      <li class="numberedList">Build<a id="_idIndexMarker380"/> the <code class="inlineCode">Northwind.CosmosDb.SqlApi</code> project at the command prompt or terminal using the following command: <code class="inlineCode">dotnet build</code>.
    <div class="packt_tip">
      <p class="normal"><strong class="keyWord">Warning!</strong> If you are using Visual Studio 2022 and you reference a project outside of the current solution, then using the <strong class="screenText">Build</strong> menu gives the following error:</p>
      <p class="normal"><code class="inlineCode">NU1105 Unable to find project information for 'C:\apps-services-net8\Chapter03\Northwind.Common.DataContext.SqlServer\Northwind.Common.DataContext.SqlServer.csproj'. If you are using Visual Studio, this may be because the project is unloaded or not part of the current solution.</code></p>
      <p class="normal">You must enter a <code class="inlineCode">dotnet build</code> command at the command prompt or terminal. In <strong class="screenText">Solution Explorer</strong>, you can right-click the project and select <strong class="screenText">Open in Terminal</strong>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Add a class file named <code class="inlineCode">Program.Helpers.cs</code>, delete any existing statements, and then add statements to define a partial <code class="inlineCode">Program</code> class with a method to output a section title to the console, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// This is defined in the default empty namespace, so it merges with</span>
<span class="hljs-comment">// the SDK-generated partial Program class.</span>
<span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
  <span class="hljs-keyword">static</span><span class="hljs-function"> </span><span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">SectionTitle</span><span class="hljs-function">(</span><span class="hljs-built_in">string</span><span class="hljs-params"> title</span><span class="hljs-function">)</span>
  {
    ConsoleColor previousColor = ForegroundColor;
    ForegroundColor = ConsoleColor.DarkYellow;
    WriteLine(<span class="hljs-string">"*"</span>);
    WriteLine(<span class="hljs-string">$"* </span><span class="hljs-subst">{title}</span><span class="hljs-string">"</span>);
    WriteLine(<span class="hljs-string">"</span><span class="hljs-string">*"</span>);
    ForegroundColor = previousColor;
  }
}
</code></pre>
      </li>
      <li class="numberedList">Add a class file named <code class="inlineCode">Program.Methods.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.Methods.cs</code>, add statements to import the namespace for working with Azure Cosmos. Then, define a method for the <code class="inlineCode">Program</code> class that<a id="_idIndexMarker381"/> creates a Cosmos client and uses it to create a database named <code class="inlineCode">Northwind</code> and a container named <code class="inlineCode">Products</code>, in either the local emulator or in the cloud, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">using</span> Microsoft.Azure.Cosmos; <span class="hljs-comment">// To use CosmosClient and so on.</span>
<span class="hljs-keyword">using</span> System.Net; <span class="hljs-comment">// To use HttpStatusCode.</span>
<span class="hljs-comment">// This is defined in the default empty namespace, so it merges with</span>
<span class="hljs-comment">// the SDK-generated partial Program class.</span>
<span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
  <span class="hljs-comment">// To use Azure Cosmos DB in the local emulator.</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> endpointUri = <span class="hljs-string">"https://localhost:8081/"</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> primaryKey = <span class="hljs-string">"C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHL M+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw=="</span>;
  <span class="hljs-comment">/* </span>
<span class="hljs-comment">  // To use Azure Cosmos DB in the cloud.</span>
<span class="hljs-comment">  private static string account = "apps-services-book"; // use your account</span>
<span class="hljs-comment">  private static string endpointUri = </span>
<span class="hljs-comment">    $"https://{account}.documents.azure.com:443/";</span>
<span class="hljs-comment">  private static string primaryKey = "LGrx7H...gZw=="; // use your key</span>
<span class="hljs-comment">  */</span>
  <span class="hljs-keyword">static</span><span class="hljs-function"> </span><span class="hljs-keyword">async</span><span class="hljs-function"> Task </span><span class="hljs-title">CreateCosmosResources</span><span class="hljs-function">()</span>
  {
    SectionTitle(<span class="hljs-string">"Creating Cosmos resources"</span>);
    <span class="hljs-keyword">try</span>
    {
      <span class="hljs-keyword">using</span> (CosmosClient client = <span class="hljs-keyword">new</span>(
        accountEndpoint: endpointUri,
        authKeyOrResourceToken: primaryKey))
      {
        DatabaseResponse dbResponse = <span class="hljs-keyword">await</span> client
          .CreateDatabaseIfNotExistsAsync(
            <span class="hljs-string">"Northwind"</span>, throughput: <span class="hljs-number">400</span> <span class="hljs-comment">/* RU/s */</span>);
        <span class="hljs-built_in">string</span> status = dbResponse.StatusCode <span class="hljs-keyword">switch</span>
        {
          HttpStatusCode.OK =&gt; <span class="hljs-string">"exists"</span>,
          HttpStatusCode.Created =&gt; <span class="hljs-string">"</span><span class="hljs-string">created"</span>,
          _ =&gt; <span class="hljs-string">"unknown"</span>
        };
        WriteLine(<span class="hljs-string">"Database Id: {0}, Status: {1}."</span>,
          arg0: dbResponse.Database.Id, arg1: status);
        IndexingPolicy indexingPolicy = <span class="hljs-keyword">new</span>()
        {
          IndexingMode = IndexingMode.Consistent,
          Automatic = <span class="hljs-literal">true</span>, <span class="hljs-comment">// Items are indexed unless explicitly excluded.</span>
          IncludedPaths = { <span class="hljs-keyword">new</span> IncludedPath { Path = <span class="hljs-string">"/*"</span> } }
        };
        ContainerProperties containerProperties = <span class="hljs-keyword">new</span>(<span class="hljs-string">"Products"</span>,
          partitionKeyPath: <span class="hljs-string">"</span><span class="hljs-string">/productId"</span>)
        {
          IndexingPolicy = indexingPolicy
        };
        ContainerResponse containerResponse = <span class="hljs-keyword">await</span> dbResponse.Database
          .CreateContainerIfNotExistsAsync(
            containerProperties, throughput: <span class="hljs-number">1000</span> <span class="hljs-comment">/* RU/s */</span>);
        status = dbResponse.StatusCode <span class="hljs-keyword">switch</span>
        {
          HttpStatusCode.OK =&gt; <span class="hljs-string">"exists"</span>,
          HttpStatusCode.Created =&gt; <span class="hljs-string">"created"</span>,
          _ =&gt; <span class="hljs-string">"unknown"</span>,
        };
        WriteLine(<span class="hljs-string">"Container Id: {0}, Status: {1}."</span>,
          arg0: containerResponse.Container.Id, arg1: status);
        Container container = containerResponse.Container;
        ContainerProperties properties = <span class="hljs-keyword">await</span> container.ReadContainerAsync();
        WriteLine(<span class="hljs-string">$"  PartitionKeyPath: </span><span class="hljs-subst">{properties.PartitionKeyPath}</span><span class="hljs-string">"</span>);
        WriteLine(<span class="hljs-string">$"  LastModified: </span><span class="hljs-subst">{properties.LastModified}</span><span class="hljs-string">"</span>);
        WriteLine(<span class="hljs-string">"  IndexingPolicy.IndexingMode: {0}"</span>,
          arg0: properties.IndexingPolicy.IndexingMode);
        WriteLine(<span class="hljs-string">"  IndexingPolicy.IncludedPaths: {0}"</span>,
          arg0: <span class="hljs-built_in">string</span>.Join(<span class="hljs-string">","</span>, properties.IndexingPolicy
            .IncludedPaths.Select(path =&gt; path.Path)));
        WriteLine(<span class="hljs-string">$"  IndexingPolicy: </span><span class="hljs-subst">{properties.IndexingPolicy}</span><span class="hljs-string">"</span>);
      }
    }
    <span class="hljs-keyword">catch</span> (HttpRequestException ex)
    {
      WriteLine(<span class="hljs-string">$"Error: </span><span class="hljs-subst">{ex.Message}</span><span class="hljs-string">"</span>);
      WriteLine(<span class="hljs-string">"Hint: If you are using the Azure Cosmos Emulator then please make sure that it is running."</span>);
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
      WriteLine(<span class="hljs-string">"Error: {0} says {1}"</span>,
        arg0: ex.GetType(),
        arg1: ex.Message);
    }
  }
}
</code></pre>
      
    <div class="note">
      <p class="normal">Note the following<a id="_idIndexMarker382"/> in the preceding code:</p>
      <ul>
        <li class="bulletList">When using the emulator, the <code class="inlineCode">endpointUri</code> and <code class="inlineCode">primaryKey</code> are the same for everyone.</li>
        <li class="bulletList">The constructor for a <code class="inlineCode">CosmosClient</code> requires the <code class="inlineCode">endpointUri</code> and <code class="inlineCode">primaryKey</code>. Never store your primary key in your source code and then check it in to a public Git repository! You should get it from an environment variable or other secure place like Azure Key Vault.</li>
        <li class="bulletList">When creating a database, you must specify a name and throughput in RUs per second.</li>
        <li class="bulletList">When<a id="_idIndexMarker383"/> creating a container, you must specify a name and partition key path, and you can optionally set an indexing policy and override the throughput, which defaults to the database throughput.</li>
        <li class="bulletList">The response to a request to create an Azure Cosmos DB resource includes an HTTP status code like <code class="inlineCode">200</code> <code class="inlineCode">OK</code> if the resource already exists, or <code class="inlineCode">201</code> <code class="inlineCode">Created</code> if the resource did not exist but has now been successfully created. The response also includes information about the resource like its <code class="inlineCode">Id</code>.</li>
      </ul>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">In <code class="inlineCode">Program.cs</code>, delete the existing statements and then add a statement to call the method to create Azure Cosmos resources, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">await</span> CreateCosmosResources();
</code></pre>
      </li>
      <li class="numberedList">Run the console app and note the results, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">*
* Creating Cosmos resources
*
Database Id: Northwind, Status: exists.
Container Id: Products, Status: exists.
  PartitionKeyPath: /productId
  LastModified: 04/07/2022 11:11:31
  IndexingPolicy.IndexingMode: Consistent
  IndexingPolicy.IncludedPaths: /*
</code></pre>
      </li>
      <li class="numberedList">In the Azure Cosmos DB Emulator or Azure portal, use <strong class="screenText">Data Explorer</strong> to delete the <code class="inlineCode">Northwind</code> database. (You must hover your mouse cursor over the database and then click the <strong class="screenText">…</strong> ellipsis button.) You will be prompted to enter its name to confirm deletion because this operation cannot be undone.
    <div class="note">
      <p class="normal">It is important to delete the <code class="inlineCode">Northwind</code> database at this point. Later in this chapter, you will programmatically add the 77 products from the SQL Server <code class="inlineCode">Northwind</code> database to the Cosmos DB <code class="inlineCode">Northwind</code> database. If you still have the three sample products in its <code class="inlineCode">Products</code> container, then you will have issues.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">Run the <a id="_idIndexMarker384"/>console app and note that because we have just deleted the database, the code we have executed has (re)created the database, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">*
* Creating Cosmos resources
*
Database Id: Northwind, Status: created.
Container Id: Products, Status: created.
  PartitionKeyPath: /productId
  LastModified: 04/07/2022 11:11:31
  IndexingPolicy.IndexingMode: Consistent
  IndexingPolicy.IncludedPaths: /*
</code></pre>
      </li>
    </ol>
    <div class="note">
      <p class="normal">You do not need to delete the database again because it will be empty of any products.</p>
    </div>
    <p class="normal">We now have a Cosmos DB database resource to work with, either in the local emulator or in the Azure cloud. Now, let’s learn how to perform CRUD operations on it using the SQL API.</p>
    <h1 class="heading-1" id="_idParaDest-179">Manipulating data with the Core (SQL) API</h1>
    <p class="normal">The most <a id="_idIndexMarker385"/>common API for working with data in Azure Cosmos DB is Core (SQL).</p>
    <div class="note">
      <p class="normal">The full documentation for the Core (SQL) API can be found at the following link: <a href="https://learn.microsoft.com/en-us/azure/cosmos-db/sql/"><span class="url">https://learn.microsoft.com/en-us/azure/cosmos-db/sql/</span></a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-180">Performing CRUD operations with the Cosmos SQL API</h2>
    <p class="normal">You can <a id="_idIndexMarker386"/>perform CRUD operations on JSON documents in Cosmos with the SQL API by calling the following most common overloads of methods on an instance of the <code class="inlineCode">Microsoft.Azure.Cosmos.Container</code> class:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">ReadItemAsync&lt;T&gt;(id, partitionKey)</code>: Where <code class="inlineCode">T</code> is the item type to get, <code class="inlineCode">id</code> is its unique identifier, and <code class="inlineCode">partitionKey</code> is its partition key value.</li>
      <li class="bulletList"><code class="inlineCode">ReadManyItemsAsync&lt;T&gt;(idsAndPartitionKeys)</code>: Where <code class="inlineCode">T</code> is the item type to get, and <code class="inlineCode">idsAndPartitionKeys</code> are the unique identifiers and partition key values of a read-only list of items to retrieve.</li>
      <li class="bulletList"><code class="inlineCode">CreateItemAsync(object)</code>: Where <code class="inlineCode">object</code> is an instance of the item type to insert.</li>
      <li class="bulletList"><code class="inlineCode">DeleteItemAsync&lt;T&gt;(id, partitionKey)</code>: Where <code class="inlineCode">T</code> is the item type to delete, <code class="inlineCode">id</code> is its unique identifier, and <code class="inlineCode">partitionKey</code> is its partition key value.</li>
      <li class="bulletList"><code class="inlineCode">PatchItemAsync&lt;T&gt;(id, partitionKey</code>, <code class="inlineCode">patchOperations)</code>: Where <code class="inlineCode">T</code> is the item type to update, <code class="inlineCode">id</code> is its unique identifier, <code class="inlineCode">partitionKey</code> is its partition key value, and <code class="inlineCode">patchOperations</code> is a read-only list of property changes.</li>
      <li class="bulletList"><code class="inlineCode">ReplaceItemAsync&lt;T&gt;(object</code>,<code class="inlineCode"> id)</code>: Where <code class="inlineCode">T</code> is the item type to replace, <code class="inlineCode">id</code> is its unique identifier, and <code class="inlineCode">object</code> is an instance of the item type to replace it with. </li>
      <li class="bulletList"><code class="inlineCode">UpsertItemAsync&lt;T&gt;(object</code>,<code class="inlineCode"> id)</code>: Where <code class="inlineCode">T</code> is the item type to either insert or replace, <code class="inlineCode">id</code> is its unique identifier, and <code class="inlineCode">object</code> is an instance of the item type to insert or replace the existing item with.</li>
    </ul>
    <div class="packt_tip">
      <p class="normal"><strong class="keyWord">Good Practice</strong>: Cosmos DB uses HTTP as its underlying communication protocol and so the “patch” and “replace” operations are implemented using <code class="inlineCode">PATCH</code> and <code class="inlineCode">PUT</code>. Just like those HTTP methods, <code class="inlineCode">PATCH</code> is more efficient because only the properties that need to change are sent in the request.</p>
    </div>
    <p class="normal">Each method<a id="_idIndexMarker387"/> returns a response that has the following common properties:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">Resource</code>: The item that was created/retrieved/updated/deleted.</li>
      <li class="bulletList"><code class="inlineCode">RequestCharge</code>: A <code class="inlineCode">double</code> value indicating the request charge measured in RUs.</li>
      <li class="bulletList"><code class="inlineCode">StatusCode</code>: An HTTP status code value; for example, <code class="inlineCode">404</code> when a <code class="inlineCode">ReadItemAsync&lt;T&gt;</code> request fails to find the item.</li>
      <li class="bulletList"><code class="inlineCode">Headers</code>: A dictionary of HTTP response headers.</li>
      <li class="bulletList"><code class="inlineCode">Diagnostics</code>: Useful information for diagnostics.</li>
      <li class="bulletList"><code class="inlineCode">ActivityId</code>: A GUID value that is useful for tracking this activity through multi-tiered services.</li>
    </ul>
    <p class="normal">Let’s copy all the products from the Northwind database in SQL Server to Cosmos.</p>
    <p class="normal">Since the <a id="_idIndexMarker388"/>entity classes in the EF Core for SQL Server class libraries are designed for the normalized data structure in the Northwind SQL database, we will create new classes to represent items in Cosmos that have embedded related data. They will use JSON casing conventions since they represent JSON documents:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.CosmosDb.SqlApi</code> project, add a new folder named <code class="inlineCode">Models</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">Models</code> folder, add a class file named <code class="inlineCode">CategoryCosmos.cs</code>.</li>
      <li class="numberedList">Modify its content to define a <code class="inlineCode">CategoryCosmos</code> class, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Northwind.CosmosDb.Items</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CategoryCosmos</span>
{
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> categoryId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> categoryName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">null</span>!;
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? description { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>
      
    <div class="note">
      <p class="normal">We must deliberately not follow usual .NET casing conventions because we cannot dynamically manipulate the serialization and the resulting JSON must use camel case.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">In the <code class="inlineCode">Models</code> folder, add a class file named <code class="inlineCode">SupplierCosmos.cs</code>, and modify its content to define a <code class="inlineCode">SupplierCosmos</code> class, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Northwind.CosmosDb.Items</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SupplierCosmos</span>
{
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> supplierId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> companyName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">null</span>!;
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? contactName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? contactTitle { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? address { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? city { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? region { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? postalCode { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? country { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? phone { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? fax { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? homePage { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>
      </li>
      <li class="numberedList">In<a id="_idIndexMarker389"/> the <code class="inlineCode">Models</code> folder, add a class file named <code class="inlineCode">ProductCosmos.cs</code>, and modify its content to define a <code class="inlineCode">ProductCosmos</code> class, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Northwind.CosmosDb.Items</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProductCosmos</span>
{
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">null</span>!;
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> productId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">null</span>!;
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> productName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">null</span>!;
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? quantityPerUnit { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">decimal</span>? unitPrice { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">short</span>? unitsInStock { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">short</span>? unitsOnOrder { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">short</span>? reorderLevel { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> discontinued { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> CategoryCosmos? category { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> SupplierCosmos? supplier { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>
      
    <div class="packt_tip">
      <p class="normal"><strong class="keyWord">Good Practice</strong>: All JSON document items in Cosmos must have an <code class="inlineCode">id</code> property. To control the value, it is good practice to explicitly define that property in the model. Otherwise, the system will assign a GUID value, as you saw earlier in this chapter when using the <strong class="screenText">Data Explorer</strong> to manually add a new item.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">In <code class="inlineCode">Program.Methods.cs</code>, add statements to import namespaces for the Northwind data context and entities types, the Northwind Cosmos types, and EF Core extensions, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">using</span> Northwind.EntityModels; <span class="hljs-comment">// To use NorthwindContext and so on.</span>
<span class="hljs-keyword">using</span> Northwind.CosmosDb.Items; <span class="hljs-comment">// To use ProductCosmos and so on.</span>
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore; <span class="hljs-comment">// To use Include extension method.</span>
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.Methods.cs</code>, add statements to define a method to get all the products in the Northwind SQL database, including their related category and <a id="_idIndexMarker390"/>supplier, and then insert them as new items in the <code class="inlineCode">Products</code> container in Cosmos, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">static</span><span class="hljs-function"> </span><span class="hljs-keyword">async</span><span class="hljs-function"> Task </span><span class="hljs-title">CreateProductItems</span><span class="hljs-function">()</span>
{
  SectionTitle(<span class="hljs-string">"Creating product items"</span>);
  <span class="hljs-built_in">double</span> totalCharge = <span class="hljs-number">0.0</span>;
  <span class="hljs-keyword">try</span>
  {
    <span class="hljs-keyword">using</span> (CosmosClient client = <span class="hljs-keyword">new</span>(
      accountEndpoint: endpointUri,
      authKeyOrResourceToken: primaryKey))
    {
      Container container = client.GetContainer(
        databaseId: <span class="hljs-string">"Northwind"</span>, containerId: <span class="hljs-string">"Products"</span>);
      <span class="hljs-keyword">using</span> (NorthwindContext db = <span class="hljs-keyword">new</span>())
      {
        <span class="hljs-keyword">if</span> (!db.Database.CanConnect())
        {
          WriteLine(<span class="hljs-string">"Cannot connect to the SQL Server database to "</span> +
            <span class="hljs-string">" read products using database connection string: "</span> +
            db.Database.GetConnectionString());
          <span class="hljs-keyword">return</span>;
        }
        ProductCosmos[] products = db.Products
          <span class="hljs-comment">// Get the related data for embedding.</span>
          .Include(p =&gt; p.Category)
          .Include(p =&gt; p.Supplier)
          <span class="hljs-comment">// Filter any products with null category or supplier</span>
          <span class="hljs-comment">// to avoid null warnings.</span>
          .Where(p =&gt; (p.Category != <span class="hljs-literal">null</span>) &amp;&amp; (p.Supplier != <span class="hljs-literal">null</span>))
          <span class="hljs-comment">// Project the EF Core entities into Cosmos JSON types.</span>
          .Select(p =&gt; <span class="hljs-keyword">new</span> ProductCosmos
          {
            id = p.ProductId.ToString(),
            productId = p.ProductId.ToString(),
            productName = p.ProductName,
            quantityPerUnit = p.QuantityPerUnit,
            <span class="hljs-comment">// If the related category is null, store null,</span>
            <span class="hljs-comment">// // else store the category mapped to Cosmos model.</span>
            category = p.Category == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : 
              <span class="hljs-keyword">new</span> CategoryCosmos
            {
              categoryId = p.Category.CategoryId,
              categoryName = p.Category.CategoryName,
              description = p.Category.Description
            },
            supplier = p.Supplier == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> :
              <span class="hljs-keyword">new</span> SupplierCosmos
            {
              supplierId = p.Supplier.SupplierId,
              companyName = p.Supplier.CompanyName,
              contactName = p.Supplier.ContactName,
              contactTitle = p.Supplier.ContactTitle,
              address = p.Supplier.Address,
              city = p.Supplier.City,
              country = p.Supplier.Country,
              postalCode = p.Supplier.PostalCode,
              region = p.Supplier.Region,
              phone = p.Supplier.Phone,
              fax = p.Supplier.Fax,
              homePage = p.Supplier.HomePage
            },
            unitPrice = p.UnitPrice,
            unitsInStock = p.UnitsInStock,
            reorderLevel = p.ReorderLevel,
            unitsOnOrder = p.UnitsOnOrder,
            discontinued = p.Discontinued,
          })
          .ToArray();
        <span class="hljs-keyword">foreach</span> (ProductCosmos product <span class="hljs-keyword">in</span> products)
        {
          <span class="hljs-keyword">try</span>
          {
            <span class="hljs-comment">// Try to read the item to see if it exists.</span>
            ItemResponse&lt;ProductCosmos&gt; productResponse =
              <span class="hljs-keyword">await</span> container.ReadItemAsync&lt;ProductCosmos&gt;(
              id: product.id, <span class="hljs-keyword">new</span> PartitionKey(product.productId));
            WriteLine(<span class="hljs-string">"Item with id: {0} exists. Query consumed {1} RUs."</span>,
              productResponse.Resource.id, productResponse.RequestCharge);
            totalCharge += productResponse.RequestCharge;
          }
          <span class="hljs-keyword">catch</span> (CosmosException ex) 
            <span class="hljs-keyword">when</span> (ex.StatusCode == HttpStatusCode.NotFound)
          {
            <span class="hljs-comment">// Create the item if it does not exist.</span>
            ItemResponse&lt;ProductCosmos&gt; productResponse =
              <span class="hljs-keyword">await</span> container.CreateItemAsync(product);
            WriteLine(<span class="hljs-string">"Created item with id: {0}. Insert consumed {1} RUs."</span>,
              productResponse.Resource.id, productResponse.RequestCharge);
            totalCharge += productResponse.RequestCharge;
          }
          <span class="hljs-keyword">catch</span> (Exception ex)
          {
            WriteLine(<span class="hljs-string">"Error: {0} says {1}"</span>,
              arg0: ex.GetType(),
              arg1: ex.Message);
          }
        }
      }
    }
  }
  <span class="hljs-keyword">catch</span> (HttpRequestException ex)
  {
    WriteLine(<span class="hljs-string">$"Error: </span><span class="hljs-subst">{ex.Message}</span><span class="hljs-string">"</span>);
    WriteLine(<span class="hljs-string">"Hint: If you are using the Azure Cosmos Emulator then please make sure it is running."</span>);
  }
  <span class="hljs-keyword">catch</span> (Exception ex)
  {
    WriteLine(<span class="hljs-string">"Error: {0} says {1}"</span>,
      arg0: ex.GetType(),
      arg1: ex.Message);
  }
  WriteLine(<span class="hljs-string">"Total requests charge: {0:N2} RUs"</span>, totalCharge);
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, comment<a id="_idIndexMarker391"/> out the call to create the Azure Cosmos resources, and then add a statement to call the method to insert all the products, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">await</span> CreateProductItems();
</code></pre>
      </li>
      <li class="numberedList">Run the console app and note the results, which should be 77 product items inserted, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">*
* Creating product items
*
Created item with id: 1. Insert consumed 14.29 RUs.
Created item with id: 2. Insert consumed 14.29 RUs.
Created item with id: 3. Insert consumed 14.29 RUs.
...
Created item with id: 76. Insert consumed 14.29 RUs.
Created item with id: 77. Insert consumed 14.48 RUs.
Total requests charge: 1,114.58 RUs
</code></pre>
      </li>
      <li class="numberedList">Run the console app again and note the results, which should show that the product items already exist, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">*
* Creating product items
*
Item with id: 1 exists. Query consumed 1 RUs.
Item with id: 2 exists. Query consumed 1 RUs.
Item with id: 3 exists. Query consumed 1 RUs.
...
Item with id: 76 exists. Query consumed 1 RUs.
Item with id: 77 exists. Query consumed 1 RUs.
Total requests charge: 77.00 RUs
</code></pre>
      </li>
      <li class="numberedList">In the <a id="_idIndexMarker392"/>Azure Cosmos DB Emulator or Azure portal <strong class="screenText">Data Explorer</strong>, confirm that there are 77 product items in the <code class="inlineCode">Products</code> container.</li>
      <li class="numberedList">In <code class="inlineCode">Program.Methods.cs</code>, add statements to define a method to list all the items in the <code class="inlineCode">Products</code> container, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">static</span><span class="hljs-function"> </span><span class="hljs-keyword">async</span><span class="hljs-function"> Task </span><span class="hljs-title">ListProductItems</span><span class="hljs-function">(</span><span class="hljs-built_in">string</span><span class="hljs-params"> sqlText = </span><span class="hljs-string">"SELECT * FROM c"</span><span class="hljs-function">)</span>
{
  SectionTitle(<span class="hljs-string">"Listing product items"</span>);
  <span class="hljs-keyword">try</span>
  {
    <span class="hljs-keyword">using</span> (CosmosClient client = <span class="hljs-keyword">new</span>(
      accountEndpoint: endpointUri,
      authKeyOrResourceToken: primaryKey))
    {
      Container container = client.GetContainer(
        databaseId: <span class="hljs-string">"Northwind"</span>, containerId: <span class="hljs-string">"</span><span class="hljs-string">Products"</span>);
      WriteLine(<span class="hljs-string">"Running query: {0}"</span>, sqlText);
      QueryDefinition query = <span class="hljs-keyword">new</span>(sqlText);
      <span class="hljs-keyword">using</span> FeedIterator&lt;ProductCosmos&gt; resultsIterator =
        container.GetItemQueryIterator&lt;ProductCosmos&gt;(query);
      <span class="hljs-keyword">if</span> (!resultsIterator.HasMoreResults)
      {
        WriteLine(<span class="hljs-string">"No results found."</span>);
      }
      <span class="hljs-keyword">while</span> (resultsIterator.HasMoreResults)
      {
        FeedResponse&lt;ProductCosmos&gt; products =
          <span class="hljs-keyword">await</span> resultsIterator.ReadNextAsync();
        WriteLine(<span class="hljs-string">"Status code: {0}, Request charge: {1} RUs."</span>,
          products.StatusCode, products.RequestCharge);
        WriteLine(<span class="hljs-string">$"</span><span class="hljs-subst">{products.Count}</span><span class="hljs-string"> products found."</span>);
        <span class="hljs-keyword">foreach</span> (ProductCosmos product <span class="hljs-keyword">in</span> products)
        {
          WriteLine(<span class="hljs-string">"id: {0}, productName: {1}, unitPrice: {2}"</span>,
            arg0: product.id, arg1: product.productName, 
            arg2: product.unitPrice.ToString());
        }
      }
    }
  }
  <span class="hljs-keyword">catch</span> (HttpRequestException ex)
  {
    WriteLine(<span class="hljs-string">$"Error: </span><span class="hljs-subst">{ex.Message}</span><span class="hljs-string">"</span>);
    WriteLine(<span class="hljs-string">"Hint: If you are using the Azure Cosmos Emulator then please make sure it is running."</span>);
  }
  <span class="hljs-keyword">catch</span> (Exception ex)
  {
    WriteLine(<span class="hljs-string">"Error: {0} says {1}"</span>,
      arg0: ex.GetType(),
      arg1: ex.Message);
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, add <a id="_idIndexMarker393"/>statements to import the namespaces to work with cultures and encodings, simulate French culture, comment out the call to create the product items, and then add a statement to call the method to list the product items, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">using</span> System.Globalization; <span class="hljs-comment">// To use CultureInfo.</span>
<span class="hljs-keyword">using</span> System.Text; <span class="hljs-comment">// To use Encoding.</span>
OutputEncoding = Encoding.UTF8; <span class="hljs-comment">// To enable Euro symbol output.</span>
<span class="hljs-comment">// Simulate French culture to test Euro currency symbol output.</span>
Thread.CurrentThread.CurrentCulture = CultureInfo.GetCultureInfo(<span class="hljs-string">"fr-FR"</span>);
<span class="hljs-comment">//await CreateCosmosResources();</span>
<span class="hljs-comment">//await CreateProductItems();</span>
<span class="hljs-keyword">await</span> ListProductItems();
</code></pre>
      </li>
      <li class="numberedList">Run the<a id="_idIndexMarker394"/> console app and note the results, which should be 77 product items, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">*
* Listing product items
*
Running query: SELECT * FROM c
Status code: OK, Request charge: 3.93 RUs.
77 products found.
id: 1, productName: Chai, unitPrice: 18,00 €
id: 2, productName: Chang, unitPrice: 19,00 €
id: 3, productName: Aniseed Syrup, unitPrice: 10,00 €
...
id: 76, productName: Lakkalikööri, unitPrice: 18,00 €
id: 77, productName: Original Frankfurter grüne Soße, unitPrice: 13,00 €
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.Methods.cs</code>, add statements to define a method to delete all the items in the <code class="inlineCode">Products</code> container, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">static</span><span class="hljs-function"> </span><span class="hljs-keyword">async</span><span class="hljs-function"> Task </span><span class="hljs-title">DeleteProductItems</span><span class="hljs-function">()</span>
{
  SectionTitle(<span class="hljs-string">"Deleting product items"</span>);
  <span class="hljs-built_in">double</span> totalCharge = <span class="hljs-number">0.0</span>;
  <span class="hljs-keyword">try</span>
  {
    <span class="hljs-keyword">using</span> (CosmosClient client = <span class="hljs-keyword">new</span>(
      accountEndpoint: endpointUri,
      authKeyOrResourceToken: primaryKey))
    {
      Container container = client.GetContainer(
        databaseId: <span class="hljs-string">"Northwind"</span>, containerId: <span class="hljs-string">"Products"</span>);
      <span class="hljs-built_in">string</span> sqlText = <span class="hljs-string">"SELECT * FROM c"</span>;
      WriteLine(<span class="hljs-string">"Running query: {0}"</span>, sqlText);
      QueryDefinition query = <span class="hljs-keyword">new</span>(sqlText);
      <span class="hljs-keyword">using</span> FeedIterator&lt;ProductCosmos&gt; resultsIterator =
        container.GetItemQueryIterator&lt;ProductCosmos&gt;(query);
      <span class="hljs-keyword">while</span> (resultsIterator.HasMoreResults)
      {
        FeedResponse&lt;ProductCosmos&gt; products =
          <span class="hljs-keyword">await</span> resultsIterator.ReadNextAsync();
        <span class="hljs-keyword">foreach</span> (ProductCosmos product <span class="hljs-keyword">in</span> products)
        {
          WriteLine(<span class="hljs-string">"Delete id: {0}, productName: {1}"</span>,
            arg0: product.id, arg1: product.productName);
          ItemResponse&lt;ProductCosmos&gt; response =
            <span class="hljs-keyword">await</span> container.DeleteItemAsync&lt;ProductCosmos&gt;(
            id: product.id, partitionKey: <span class="hljs-keyword">new</span>(product.id));
          WriteLine(<span class="hljs-string">"Status code: {0}, Request charge: {1} RUs."</span>,
            response.StatusCode, response.RequestCharge);
          totalCharge += response.RequestCharge;
        }
      }
    }
  }
  <span class="hljs-keyword">catch</span> (HttpRequestException ex)
  {
    WriteLine(<span class="hljs-string">$"Error: </span><span class="hljs-subst">{ex.Message}</span><span class="hljs-string">"</span>);
    WriteLine(<span class="hljs-string">"Hint: If you are using the Azure Cosmos Emulator then please make sure it is running."</span>);
  }
  <span class="hljs-keyword">catch</span> (Exception ex)
  {
    WriteLine(<span class="hljs-string">"Error: {0} says {1}"</span>,
      arg0: ex.GetType(),
      arg1: ex.Message);
  }
  WriteLine(<span class="hljs-string">"Total requests charge: {0:N2} RUs"</span>, totalCharge);
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, comment <a id="_idIndexMarker395"/>out the call to list the product items, and then add a statement to call the method to delete the product items, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">await</span> DeleteProductItems();
</code></pre>
      </li>
      <li class="numberedList">Run the console app and note the results, which should be 77 product items deleted, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">*
* Deleting product items
*
Running query: SELECT * FROM c
Delete id: 1, productName: Chai
Status code: NoContent, Request charge: 14.29 RUs.
...
Delete id: 77, productName: Original Frankfurter grüne Soße
Status code: NoContent, Request charge: 14.48 RUs.
Total requests charge: 1,128.87 RUs
</code></pre>
      </li>
      <li class="numberedList">In the Azure Cosmos DB Emulator or Azure portal <strong class="screenText">Data Explorer</strong>, confirm that the <code class="inlineCode">Products</code> container is empty.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-181">Understanding SQL queries</h2>
    <p class="normal">The following<a id="_idIndexMarker396"/> keywords and more are available when writing SQL queries for Azure Cosmos DB:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">SELECT</code> to select from item properties. Supports <code class="inlineCode">*</code> for all and <code class="inlineCode">TOP</code> for limiting the results to the first specific number of items.</li>
      <li class="bulletList"><code class="inlineCode">AS</code> to define aliases.</li>
      <li class="bulletList"><code class="inlineCode">FROM</code> to define the items to select from. Some of the previous queries used <code class="inlineCode">FROM c</code>, where <code class="inlineCode">c</code> is an implied alias for the items in the container. Since a SQL query is executed within the context of a container like <code class="inlineCode">Products</code>, you can use any alias you like, so <code class="inlineCode">FROM Items c</code> or <code class="inlineCode">FROM p</code> would work equally well.</li>
      <li class="bulletList"><code class="inlineCode">WHERE</code> to define a filter.</li>
      <li class="bulletList"><code class="inlineCode">LIKE</code> to use pattern matching. <code class="inlineCode">%</code> means zero, one, or more characters. <code class="inlineCode">_</code> means a single character. <code class="inlineCode">[a-f]</code> or <code class="inlineCode">[aeiou]</code> means a single character within the defined range or set. <code class="inlineCode">[^aeiou]</code> means not in the range or set.</li>
      <li class="bulletList"><code class="inlineCode">IN</code>, <code class="inlineCode">BETWEEN</code> are range and set filters.</li>
      <li class="bulletList"><code class="inlineCode">AND</code>, <code class="inlineCode">OR</code>, <code class="inlineCode">NOT</code> for Boolean logic.</li>
      <li class="bulletList"><code class="inlineCode">ORDER BY</code> to sort the results.</li>
      <li class="bulletList"><code class="inlineCode">DISTINCT</code> to remove duplicates.</li>
      <li class="bulletList"><code class="inlineCode">COUNT</code>, <code class="inlineCode">AVG</code>, <code class="inlineCode">SUM</code>, and other aggregate functions.</li>
    </ul>
    <p class="normal">To query <a id="_idIndexMarker397"/>the <code class="inlineCode">Products</code> container using the Core (SQL) API, you might write the following code:</p>
    <pre class="programlisting gen"><code class="hljs">SELECT p.id, p.productName, p.unitPrice FROM Items p
</code></pre>
    <p class="normal">Let’s try executing a SQL query against our product items:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Program.cs</code>, uncomment the call to (re)create the product items and modify the call to <code class="inlineCode">ListProductItems</code> to pass a SQL query that filters the products to only show the products in the Beverages category and only their ID, name, and unit price, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">//await CreateCosmosResources();</span>
<span class="hljs-keyword">await</span> CreateProductItems();
<span class="hljs-keyword">await</span> ListProductItems(<span class="hljs-string">"SELECT p.id, p.productName, p.unitPrice FROM Items p WHERE p.category.categoryName = 'Beverages'"</span>);
<span class="hljs-comment">//await DeleteProductItems();</span>
</code></pre>
      </li>
      <li class="numberedList">Run the console app and note the results, which should be the 12 product items in the Beverages category, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">*
* Listing product items
*
Running query: SELECT p.id, p.productName, p.unitPrice FROM Items p WHERE p.category.categoryName = 'Beverages'
Status code: OK, Request charge: 3.19 RUs.
12 products found.
id: 1, productName: Chai, unitPrice: 18
id: 2, productName: Chang, unitPrice: 19
id: 24, productName: Guaraná Fantástica, unitPrice: 4.5
id: 34, productName: Sasquatch Ale, unitPrice: 14
id: 35, productName: Steeleye Stout, unitPrice: 18
id: 38, productName: Côte de Blaye, unitPrice: 263.5
id: 39, productName: Chartreuse verte, unitPrice: 18
id: 43, productName: Ipoh Coffee, unitPrice: 46
id: 67, productName: Laughing Lumberjack Lager, unitPrice: 14
id: 70, productName: Outback Lager, unitPrice: 15
id: 75, productName: Rhönbräu Klosterbier, unitPrice: 7.75
id: 76, productName: Lakkalikööri, unitPrice: 18
</code></pre>
      </li>
      <li class="numberedList">In the <a id="_idIndexMarker398"/>Azure Cosmos DB Emulator or Azure portal <strong class="screenText">Data Explorer</strong>, create a new SQL query, use the same SQL text, and execute it, as shown in <em class="italic">Figure 4.7</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_04_07.png"/></figure>
    <p class="packt_figref">Figure 4.7: Executing a SQL query in Data Explorer</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Click <strong class="screenText">Query Stats</strong>, and <a id="_idIndexMarker399"/>note the request charge (3.19 RUs), the number of records (12), and the output document size (752 bytes), as shown in <em class="italic">Figure 4.8</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_04_08.png"/></figure>
    <p class="packt_figref">Figure 4.8: Query statistics in Data Explorer</p>
    <p class="normal">Other useful query statistics include:</p>
    <ul>
      <li class="bulletList">Index hit document count.</li>
      <li class="bulletList">Index lookup time.</li>
      <li class="bulletList">Document load time.</li>
      <li class="bulletList">Query engine execution time.</li>
      <li class="bulletList">Document write time.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-182">Exploring other SQL queries with Cosmos DB</h2>
    <p class="normal">Try <a id="_idIndexMarker400"/>executing the following queries:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">SELECT</span> p.id, p.productName, p.unitPrice <span class="hljs-keyword">FROM</span> Items p 
<span class="hljs-keyword">WHERE</span> p.unitPrice <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> p.category <span class="hljs-keyword">FROM</span> Items p
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> p.category.categoryName <span class="hljs-keyword">FROM</span> Items p
<span class="hljs-keyword">WHERE</span> p.discontinued <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
<span class="hljs-keyword">SELECT</span> p.productName, p.supplier.city <span class="hljs-keyword">FROM</span> Items p
<span class="hljs-keyword">WHERE</span> p.supplier.country <span class="hljs-operator">=</span> <span class="hljs-string">'Germany'</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(p.id) <span class="hljs-keyword">AS</span> HowManyProductsComeFromGermany <span class="hljs-keyword">FROM</span> Items p
<span class="hljs-keyword">WHERE</span> p.supplier.country <span class="hljs-operator">=</span> <span class="hljs-string">'Germany'</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">AVG</span>(p.unitPrice) <span class="hljs-keyword">AS</span> AverageUnitPrice <span class="hljs-keyword">FROM</span> Items p
</code></pre>
    <p class="normal">Although queries defined using strings are the most common way of working with Cosmos DB, you can also create permanently stored objects using server-side programming.</p>
    <h1 class="heading-1" id="_idParaDest-183">Exploring server-side programming</h1>
    <p class="normal">Azure Cosmos DB server-side <a id="_idIndexMarker401"/>programming consists of <strong class="keyWord">stored procedures</strong>, <strong class="keyWord">triggers</strong>, and <strong class="keyWord">user-defined functions </strong>(<strong class="keyWord">UDFs</strong>) written in JavaScript. </p>
    <h2 class="heading-2" id="_idParaDest-184">Implementing user-defined functions</h2>
    <p class="normal">UDFs can <a id="_idIndexMarker402"/>only be called from within a query, and they implement custom business logic like calculating tax.</p>
    <p class="normal">Let’s define a UDF to calculate the sales tax of products:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the Azure Cosmos DB Emulator or Azure portal <strong class="screenText">Data Explorer</strong>, create a new UDF, as shown in <em class="italic">Figure 4.9</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_04_09.png"/></figure>
    <p class="packt_figref">Figure 4.9: Creating a new UDF</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">For <a id="_idIndexMarker403"/>the <strong class="screenText">User Defined Function Id</strong>, enter <code class="inlineCode">salesTax</code>.</li>
      <li class="numberedList">For the <strong class="screenText">User Defined Function Body</strong>, enter JavaScript to define the <code class="inlineCode">salesTax</code> function, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-function">function </span><span class="hljs-title">salesTax</span><span class="hljs-function">(</span><span class="hljs-params">unitPrice</span><span class="hljs-function">)</span>{
    <span class="hljs-keyword">return</span> unitPrice * <span class="hljs-number">0.2</span>;
}
</code></pre>
      </li>
      <li class="numberedList">In the toolbar, click <strong class="screenText">Save</strong>.</li>
      <li class="numberedList">Create a new SQL query and enter SQL text to return the unit price and sales tax for products that cost more than 100, as shown in the following query:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">SELECT</span> p.unitPrice cost, udf.salesTax(p.unitPrice) <span class="hljs-keyword">AS</span> tax 
<span class="hljs-keyword">FROM</span> Items p <span class="hljs-keyword">WHERE</span> p.unitPrice <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>
</code></pre>
      
    <div class="note">
      <p class="normal">Note that <code class="inlineCode">AS</code> to alias an expression is optional. I prefer to specify <code class="inlineCode">AS</code> for improved legibility.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Click the <strong class="screenText">Save Query</strong> button.
    <div class="note">
      <p class="normal">If you are using cloud resources instead of the emulator, then for compliance reasons, Microsoft saves queries in a container in your Azure Cosmos account in a separate database called <strong class="screenText">___Cosmos</strong>. The estimated additional cost is $0.77 daily.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Execute <a id="_idIndexMarker404"/>the query and note the results, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">[
    {
        "cost": 123.79,
        "tax": 24.758000000000003
    },
    {
        "cost": 263.5,
        "tax": 52.7
    }
]
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-185">Implementing stored procedures</h2>
    <p class="normal">Stored procedures<a id="_idIndexMarker405"/> are the only<a id="_idIndexMarker406"/> way to ensure <strong class="keyWord">ACID</strong> (<strong class="keyWord">Atomic, Consistent, Isolated, Durable</strong>) transactions that combine multiple discrete activities into a single action that can be committed or rolled back. You cannot use client-side code to implement transactions. Server-side programming also provides improved performance since the code executes where the data is stored.</p>
    <p class="normal">We have just seen that you can define a UDF using the Data Explorer. We could define a stored procedure in a similar way, but let’s see how we would do it using code:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Program.Methods.cs</code>, import the namespace for working with server-side programming objects, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// To use StoredProcedureResponse and so on.</span>
<span class="hljs-keyword">using</span> Microsoft.Azure.Cosmos.Scripts;
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.Methods.cs</code>, add statements to define a method to create a stored procedure that can insert multiple products by chaining callback functions until all items in an array are inserted, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">static</span><span class="hljs-function"> </span><span class="hljs-keyword">async</span><span class="hljs-function"> Task </span><span class="hljs-title">CreateInsertProductStoredProcedure</span><span class="hljs-function">()</span>
{
  SectionTitle(<span class="hljs-string">"Creating the insertProduct stored procedure"</span>);
  <span class="hljs-keyword">try</span>
  {
    <span class="hljs-keyword">using</span> (CosmosClient client = <span class="hljs-keyword">new</span>(
      accountEndpoint: endpointUri,
      authKeyOrResourceToken: primaryKey))
    {
      Container container = client.GetContainer(
        databaseId: <span class="hljs-string">"Northwind"</span>, containerId: <span class="hljs-string">"Products"</span>);
      StoredProcedureResponse response = <span class="hljs-keyword">await</span> container
        .Scripts.CreateStoredProcedureAsync(<span class="hljs-keyword">new</span> StoredProcedureProperties
        {
          Id = <span class="hljs-string">"insertProduct"</span>,
          <span class="hljs-comment">// __ means getContext().getCollection().</span>
          Body = <span class="hljs-string">"""</span>
<span class="hljs-string">function insertProduct(product) {</span>
<span class="hljs-string">  if (!product) throw new Error(</span>
<span class="hljs-string">    "</span>product <span class="hljs-keyword">is</span> undefined <span class="hljs-keyword">or</span> <span class="hljs-literal">null</span>.<span class="hljs-string">");</span>
<span class="hljs-string">  tryInsert(product, callbackInsert);</span>
<span class="hljs-string">  function tryInsert(product, callbackFunction) {</span>
<span class="hljs-string">    var options = { disableAutomaticIdGeneration: false };</span>
<span class="hljs-string">    // __ is an alias for getContext().getCollection()</span>
<span class="hljs-string">    var isAccepted = __.createDocument(</span>
<span class="hljs-string">      __.getSelfLink(), product, options, callbackFunction);</span>
<span class="hljs-string">    if (!isAccepted) </span>
<span class="hljs-string">      getContext().getResponse().setBody(0);</span>
<span class="hljs-string">  }</span>
<span class="hljs-string">  function callbackInsert(err, item, options) {</span>
<span class="hljs-string">    if (err) throw err;</span>
<span class="hljs-string">    getContext().getResponse().setBody(1);</span>
<span class="hljs-string">  }</span>
<span class="hljs-string">}</span>
<span class="hljs-string">"""</span>
        });
      WriteLine(<span class="hljs-string">"Status code: {0}, Request charge: {1} RUs."</span>,
        response.StatusCode, response.RequestCharge);
    }
  }
  <span class="hljs-keyword">catch</span> (HttpRequestException ex)
  {
    WriteLine(<span class="hljs-string">$"Error: </span><span class="hljs-subst">{ex.Message}</span><span class="hljs-string">"</span>);
    WriteLine(<span class="hljs-string">"Hint: If you are using the Azure Cosmos Emulator then please make sure it is running."</span>);
  }
  <span class="hljs-keyword">catch</span> (Exception ex)
  {
    WriteLine(<span class="hljs-string">"Error: {0} says {1}"</span>,
      arg0: ex.GetType(),
      arg1: ex.Message);
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, comment<a id="_idIndexMarker407"/> out all the existing statements, and add a statement to run the new method, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">await</span> CreateInsertProductStoredProcedure();
</code></pre>
      </li>
      <li class="numberedList">Run the console app and note the results, which should be the successful creation of the stored procedure, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">*
* Creating the insertProduct stored procedure
*
Status code: Created, Request charge: 6.29 RUs.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.Methods.cs</code>, add statements to define a method to execute the stored procedure, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">static</span><span class="hljs-function"> </span><span class="hljs-keyword">async</span><span class="hljs-function"> Task </span><span class="hljs-title">ExecuteInsertProductStoredProcedure</span><span class="hljs-function">()</span>
{
  SectionTitle(<span class="hljs-string">"</span><span class="hljs-string">Executing the insertProduct stored procedure"</span>);
  <span class="hljs-keyword">try</span>
  {
    <span class="hljs-keyword">using</span> (CosmosClient client = <span class="hljs-keyword">new</span>(
      accountEndpoint: endpointUri,
      authKeyOrResourceToken: primaryKey))
    {
      Container container = client.GetContainer(
        databaseId: <span class="hljs-string">"Northwind"</span>, containerId: <span class="hljs-string">"Products"</span>);
      <span class="hljs-built_in">string</span> pid = <span class="hljs-string">"78"</span>;
      ProductCosmos product = <span class="hljs-keyword">new</span>()
      {
        id = pid, productId = pid,
        productName = <span class="hljs-string">"Barista's Chilli Jam"</span>,
        unitPrice = <span class="hljs-number">12</span>M, unitsInStock = <span class="hljs-number">10</span>
      };
      StoredProcedureExecuteResponse&lt;<span class="hljs-built_in">string</span>&gt; response = <span class="hljs-keyword">await</span> container.Scripts
        .ExecuteStoredProcedureAsync&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"insertProduct"</span>,
        <span class="hljs-keyword">new</span> PartitionKey(pid), <span class="hljs-keyword">new</span>[] { product });
      WriteLine(<span class="hljs-string">"Status code: {0}, Request charge: {1} RUs."</span>,
        response.StatusCode, response.RequestCharge);
    }
  }
  <span class="hljs-keyword">catch</span> (HttpRequestException ex)
  {
    WriteLine(<span class="hljs-string">$"Error: </span><span class="hljs-subst">{ex.Message}</span><span class="hljs-string">"</span>);
    WriteLine(<span class="hljs-string">"Hint: If you are using the Azure Cosmos Emulator then please make sure it is running."</span>);
  }
  <span class="hljs-keyword">catch</span> (Exception ex)
  {
    WriteLine(<span class="hljs-string">"Error: {0} says {1}"</span>,
      arg0: ex.GetType(),
      arg1: ex.Message);
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, comment out the statement to create the stored procedure, add a statement to <a id="_idIndexMarker408"/>execute the stored procedure, and then list products with a <code class="inlineCode">productId</code> of <code class="inlineCode">78</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">//await CreateInsertProductStoredProcedure();</span>
<span class="hljs-keyword">await</span> ExecuteInsertProductStoredProcedure();
<span class="hljs-keyword">await</span> ListProductItems(<span class="hljs-string">"SELECT p.id, p.productName, p.unitPrice FROM Items p WHERE p.productId = '78'"</span>);
</code></pre>
      </li>
      <li class="numberedList">Run the <a id="_idIndexMarker409"/>console app and note the results, which should be the successful execution of the stored procedure, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">*
* Executing the insertProduct stored procedure
*
Status code: OK, Request charge: 10.23 RUs.
*
* Listing product items
*
Running query: SELECT p.id, p.productName, p.unitPrice FROM Items p WHERE p.productId = '78'
Status code: OK, Request charge: 2.83 RUs.
1 products found.
id: 78, productName: Barista's Chilli Jam, unitPrice: €12.00
</code></pre>
      </li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-186">Cleaning up Azure resources</h1>
    <p class="normal">When<a id="_idIndexMarker410"/> you are done with an Azure Cosmos DB account, you must clean up the resources used, or you will incur costs for as long as those resources exist. You can delete resources individually or delete the resource group to delete the entire set of resources. If you delete an Azure Cosmos DB account, then all the databases and containers within it are also deleted:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the Azure portal, navigate to <strong class="screenText">All Resources</strong>.</li>
      <li class="numberedList">In your <code class="inlineCode">apps-services-book</code> resource group, click your Azure Cosmos DB account.</li>
      <li class="numberedList">Click <strong class="screenText">Overview</strong>, and then in the toolbar, click <strong class="screenText">Delete Account</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Confirm the Account Name</strong> box, enter your account name.</li>
      <li class="numberedList">Click the <strong class="screenText">Delete</strong> button.</li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-187">Practicing and exploring</h1>
    <p class="normal">Test your knowledge and understanding by answering some questions, getting some hands-on practice, and exploring this chapter’s topics with deeper research.</p>
    <h2 class="heading-2" id="_idParaDest-188">Exercise 4.1 – Test your knowledge</h2>
    <p class="normal">Answer the following questions:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">What are the five APIs supported by Azure Cosmos DB?</li>
      <li class="numberedList">At what level do you select the API: account, database, container, or partition?</li>
      <li class="numberedList">What does <em class="italic">embed</em> mean regarding data modeling with Cosmos DB?</li>
      <li class="numberedList">What is the unit of measurement for throughput for Cosmos DB and what does 1 unit represent?</li>
      <li class="numberedList">What package should you reference to programmatically work with Cosmos DB resources?</li>
      <li class="numberedList">What language do you use to write Cosmos DB Core (SQL) API user-defined functions and stored procedures?</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-189">Exercise 4.2 – Practice data modeling and partitioning</h2>
    <p class="normal">Microsoft documentation has an extensive example of modeling and partitioning Azure Cosmos DB:</p>
    <p class="normal"><a href="https://learn.microsoft.com/en-us/azure/cosmos-db/sql/how-to-model-partition-example"><span class="url">https://learn.microsoft.com/en-us/azure/cosmos-db/sql/how-to-model-partition-example</span></a></p>
    <h2 class="heading-2" id="_idParaDest-190">Exercise 4.3 – Explore topics</h2>
    <p class="normal">Use the links on the following page to learn more details about the topics covered in this chapter:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-4---managing-nosql-data-using-azure-cosmos-db"><span class="url">https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-4---managing-nosql-data-using-azure-cosmos-db</span></a></p>
    <h2 class="heading-2" id="_idParaDest-191">Exercise 4.4 – Download cheat sheets</h2>
    <p class="normal">Download query cheat sheets for the Azure Cosmos DB APIs and review them:</p>
    <p class="normal"><a href="https://learn.microsoft.com/en-us/azure/cosmos-db/sql/query-cheat-sheet"><span class="url">https://learn.microsoft.com/en-us/azure/cosmos-db/sql/query-cheat-sheet</span></a></p>
    <h2 class="heading-2" id="_idParaDest-192">Exercise 4.5 – Explore the Gremlin API for Cosmos DB</h2>
    <p class="normal">If you are interested, then I have written an optional online-only section where you explore the Azure Cosmos DB graph API that uses the Gremlin API, found at the following link:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/ch04-gremlin.md"><span class="url">https://github.com/markjprice/apps-services-net8/blob/main/docs/ch04-gremlin.md</span></a></p>
    <p class="normal">To gain more experience with the Gremlin graph API, you could read the following online book:</p>
    <p class="normal"><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html"><span class="url">https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html</span></a></p>
    <h2 class="heading-2" id="_idParaDest-193">Exercise 4.6 – Explore NoSQL databases</h2>
    <p class="normal">This chapter focused on Azure Cosmos DB. If you wish to learn more about NoSQL databases, such as MongoDB, and how to use them with EF Core, then I recommend the following links:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Use NoSQL databases as a persistence infrastructure</strong>: <a href="https://learn.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/nosql-database-persistence-infrastructure"><span class="url">https://learn.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/nosql-database-persistence-infrastructure</span></a></li>
      <li class="bulletList"><strong class="keyWord">Document Database Providers for Entity Framework Core</strong>: <a href="https://github.com/BlueshiftSoftware/EntityFrameworkCore"><span class="url">https://github.com/BlueshiftSoftware/EntityFrameworkCore</span></a></li>
    </ul>
    <h1 class="heading-1" id="_idParaDest-194">Summary</h1>
    <p class="normal">In this chapter, you learned:</p>
    <ul>
      <li class="bulletList">How to store flexibly structured data in Azure Cosmos DB.</li>
      <li class="bulletList">How to create Cosmos DB resources in the emulator and in the Azure cloud.</li>
      <li class="bulletList">How to manipulate data using the Cosmos SQL API.</li>
      <li class="bulletList">How to implement server-side programming in Cosmos DB using JavaScript.</li>
    </ul>
    <p class="normal">In the next chapter, you will use the <code class="inlineCode">Task</code> type to improve the performance of your applications.</p>
  </div>
</body></html>