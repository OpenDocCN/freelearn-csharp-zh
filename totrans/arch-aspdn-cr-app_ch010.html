<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="packt" name="generator"/>
<title>9 Options, Settings, and Configuration</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<link href="../styles/stylesheet2.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body>
<section class="level1 pkt" data-number="10" id="options-settings-and-configuration">
<h1 data-number="10"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">9 Options, Settings, and Configuration</span></h1>
<section class="level2" data-number="10.1" id="before-you-begin-join-our-book-community-on-discord-8">
<h2 data-number="10.1"><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Before you begin: Join our book community on Discord</span></h2>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">Give your feedback straight to the author himself and chat to other early readers on our Discord server (find the "architecting-aspnet-core-apps-3e" channel under EARLY ACCESS SUBSCRIPTION).</span></p>
<p><a href="https://packt.link/EarlyAccess"><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">https://packt.link/EarlyAccess</span></a></p>
<p><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Qr code Description automatically generated" src="../media/file44.png" style="width:10em"/></span></p>
<p><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">This chapter covers the .NET Options pattern, a building block of any application. </span><span class="koboSpan" id="kobo.6.2" xmlns="http://www.w3.org/1999/xhtml">.NET Core introduced new predefined mechanisms to enhance the usage of application settings available to ASP.NET Core applications. </span><span class="koboSpan" id="kobo.6.3" xmlns="http://www.w3.org/1999/xhtml">These allow us to divide our configuration into multiple smaller objects, configure them during various stages of the startup flow, validate them, and even watch for runtime changes with minimal effort.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">The new options system repurposed the </span><code><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml">ConfigurationManager</span></code><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml"> class as an internal piece. </span><span class="koboSpan" id="kobo.9.2" xmlns="http://www.w3.org/1999/xhtml">We no longer can use it as the old .NET Framework-era static methods are gone. </span><span class="koboSpan" id="kobo.9.3" xmlns="http://www.w3.org/1999/xhtml">The new patterns and mechanisms help avoid useless coupling, add flexibility to our designs, and are DI-native. </span><span class="koboSpan" id="kobo.9.4" xmlns="http://www.w3.org/1999/xhtml">The system is also simpler to extend.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml">The Options pattern goal is to use settings at runtime, allowing changes to the application to happen without changing the code. </span><span class="koboSpan" id="kobo.10.2" xmlns="http://www.w3.org/1999/xhtml">The settings could be as simple as a </span><code><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml">string</span></code><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">, a </span><code><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">bool</span></code><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml">, a database connection string, or a complex object that holds an entire subsystem’s configuration.This chapter delves into various tools and methodologies we can use for managing, injecting, and loading configurations and options into our ASP.NET Core applications. </span><span class="koboSpan" id="kobo.14.2" xmlns="http://www.w3.org/1999/xhtml">Our journey spans a broad spectrum of scenarios, covering everything from commonly encountered to more complex use cases.At the end of the chapter, you will know how to leverage the .NET options and settings infrastructure.In this chapter, we cover the following topics:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">Loading the configuration</span></li>
<li><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml">Learning the building blocks</span></li>
<li><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">Exploring common usage scenarios</span></li>
<li><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">Learning options configuration</span></li>
<li><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml">Validating our options objects</span></li>
<li><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">Validating options using FluentValidation</span></li>
<li><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">Injecting options objects directly—a workaround</span></li>
<li><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">Centralizing the configuration for easier management</span></li>
<li><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">Using the configuration-binding source generator</span></li>
<li><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">Using the options validation source generator</span></li>
<li><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">Using the options validation source generator</span></li>
</ul>
<p><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">Let’s get started!</span></p>
</section>
<section class="level2" data-number="10.2" id="loading-the-configuration">
<h2 data-number="10.2"><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml">Loading the configuration</span></h2>
<p><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">ASP.NET Core allows us to load settings from multiple sources seamlessly. </span><span class="koboSpan" id="kobo.28.2" xmlns="http://www.w3.org/1999/xhtml">We can customize these sources from the </span><code><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml">WebApplicationBuilder</span></code><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml">, or use the defaults set by calling the </span><code><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml">WebApplication.CreateBuilder(args)</span></code><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml"> method.The default sources, in order, are as follows:</span></p>
<ol>
<li><code><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code></li>
<li><code><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.{Environment}.json</span></code></li>
<li><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">User secrets; these are only loaded when the environment is </span><code><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">Development</span></code></li>
<li><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">Environment variables</span></li>
<li><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">Command-line arguments</span></li>
</ol>
<p><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml">The order is essential, as the last to be loaded overrides previous values. </span><span class="koboSpan" id="kobo.39.2" xmlns="http://www.w3.org/1999/xhtml">For example, you can set a value in </span><code><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml"> and override it in </span><code><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.Staging.json</span></code><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml"> by redefining the value in that file, user secrets, an environment variable or by passing it as a command-line argument when you run your application.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml">You can name your environments as you want, but by default, ASP.NET Core has built-in helper methods for </span><code><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">Development</span></code><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml">Staging</span></code><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">Production</span></code><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml">On top of the default providers, we can register other configuration sources out of the box, like </span><code><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml">AddIniFile</span></code><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml">AddInMemoryCollection</span></code><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml">AddXmlFile</span></code><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml">, for example. </span><span class="koboSpan" id="kobo.57.2" xmlns="http://www.w3.org/1999/xhtml">We can also load NuGet packages to install custom providers, like Azure KeyVault and Azure App Configuration, to centralize secrets and configuration management into the Azure cloud. </span><span class="koboSpan" id="kobo.57.3" xmlns="http://www.w3.org/1999/xhtml">The most interesting part of those configuration providers is that no matter the sources, it does not affect the consumption of the settings, only the composition root. </span><span class="koboSpan" id="kobo.57.4" xmlns="http://www.w3.org/1999/xhtml">This means we can start loading settings one way, then change our mind later or have different strategies for dev and prod, and none of that affects the codebase but the composition root.We explore a few building blocks next.</span></p>
</section>
<section class="level2" data-number="10.3" id="learning-the-building-blocks">
<h2 data-number="10.3"><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">Learning the building blocks</span></h2>
<p><span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml">There are four main interfaces to use settings: </span><code><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsFactory&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml">IOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.67.2" xmlns="http://www.w3.org/1999/xhtml">We must inject that dependency into a class to use the available settings. </span><code><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml"> is the type that represents the settings that we want to access.The framework returns an empty instance of your options class if you don’t configure it. </span><span class="koboSpan" id="kobo.69.2" xmlns="http://www.w3.org/1999/xhtml">We learn how to configure options properly in the next subsection; meanwhile, remember that using property initializers inside your options class can also be a great way to ensure certain defaults are used. </span><span class="koboSpan" id="kobo.69.3" xmlns="http://www.w3.org/1999/xhtml">You can also use constants to centralize those defaults somewhere in your codebase (making them easier to maintain). </span><span class="koboSpan" id="kobo.69.4" xmlns="http://www.w3.org/1999/xhtml">Nevertheless, proper configuration and validation are always preferred, but both combined can add a safety net. </span><span class="koboSpan" id="kobo.69.5" xmlns="http://www.w3.org/1999/xhtml">Don’t use initializers or constants for default values that change based on the environment (dev, staging, or production) or for secrets such as connection strings and passwords.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml">You should always keep secrets out of your Git history, whether it's out of the C# code or out of setting files. </span><span class="koboSpan" id="kobo.70.2" xmlns="http://www.w3.org/1999/xhtml">Use ASP.NET Core secrets locally and a secret store like Azure KeyVault for Staging and Production environments.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml">If we create the following class, since the default value of an </span><code><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">int</span></code><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml"> is </span><code><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">0</span></code><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml">, the default number of items to display per page would be 0, leading to an empty list.</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">public class MyListOption
{
    public int ItemsPerPage { get; set; }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml">However, we can configure this using a property initializer, as next:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml">public class MyListOption
{
    public int ItemsPerPage { get; set; } = 20;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml">The default number of items to display per page is now 20.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">In the source code for this chapter, I’ve included a few tests in the </span><code><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml">CommonScenarios.Tests</span></code><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml"> project that assert the lifetime of the different options interfaces. </span><span class="koboSpan" id="kobo.82.2" xmlns="http://www.w3.org/1999/xhtml">I haven’t included this code here for brevity, but it describes the behavior of the different options via unit tests. </span><span class="koboSpan" id="kobo.82.3" xmlns="http://www.w3.org/1999/xhtml">See </span><a href="https://adpg.link/AXa5"><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/AXa5</span></a><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml"> for more information.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml">The options served by each interface have different DI lifetimes and other features. </span><span class="koboSpan" id="kobo.85.2" xmlns="http://www.w3.org/1999/xhtml">The following table exposes some of those features:</span></p>
<table>
<tbody>
<tr class="odd">
<td><strong><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml">Interface</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml">Lifetime</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml">Support named options</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml">Support change notification</span></strong></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml">Singleton</span></td>
<td><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml">Yes</span></td>
<td><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml">Yes</span></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsFactory&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml">Transient</span></td>
<td><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml">Yes</span></td>
<td><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml">No</span></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml">Scoped</span></td>
<td><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml">Yes</span></td>
<td><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">No</span></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml">IOptions&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml">Singleton</span></td>
<td><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">No</span></td>
<td><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml">No</span></td>
</tr>
</tbody>
</table><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml">
Table 9.1: The different options interfaces, their DI lifetime, and support for other features.
</span><p><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml">Next, we explore those interfaces more in-depth.</span></p>
<section class="level3" data-number="10.3.1" id="ioptionsmonitortoptions">
<h3 data-number="10.3.1"><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor&lt;TOptions&gt;</span></h3>
<p><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml">This interface is the most versatile of them all:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml">It supports receiving notifications about reloading the configuration (like when the setting file changed).</span></li>
<li><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml">It supports caching.</span></li>
<li><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml">It supports named configuration (identifying multiple different </span><code><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml"> with a name).</span></li>
<li><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml">The injected </span><code><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml"> instance is always the same (</span><strong><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml">singleton lifetime</span></strong><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml">).</span></li>
<li><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">It supports unnamed default settings through its </span><code><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml"> property.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">If we only configure named options or no instance at all, the consumer will receive an empty </span><code><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml"> instance (</span><code><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">new TOptions()</span></code><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml">).</span></p>
</blockquote>
</section>
<section class="level3" data-number="10.3.2" id="ioptionsfactorytoptions">
<h3 data-number="10.3.2"><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsFactory&lt;TOptions&gt;</span></h3>
<p><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml">This interface is a factory, as we saw in </span><em><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 7</span></em><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml">Strategy, Abstract Factory, and Singleton</span></em><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml">, and in </span><em><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 8</span></em><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml">Dependency Injection</span></em><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml">, we use factories to create instances; this interface is no different.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml">Unless necessary, I suggest sticking with </span><code><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml"> instead.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml">How the factory works is simple: the container creates a new factory every time you ask for one (transient lifetime), and the factory creates a new options instance every time you call its </span><code><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml">Create(name)</span></code><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml"> method (</span><strong><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">transient lifetime</span></strong><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml">).To get the default instance (non-named options), you can use the </span><code><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">Options.DefaultName</span></code><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml"> field or pass an empty string; this is usually handled for you by the framework.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml">If we only configure named options or no instance at all, the consumer will receive an empty </span><code><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml"> instance (</span><code><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml">new TOptions()</span></code><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml">) after calling </span><code><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml">factory.Create(Options.DefaultName)</span></code><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</blockquote>
</section>
<section class="level3" data-number="10.3.3" id="ioptionssnapshottoptions">
<h3 data-number="10.3.3"><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot&lt;TOptions&gt;</span></h3>
<p><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">This interface is useful when you need a snapshot of the settings for the duration of an HTTP request.</span></p>
<ul>
<li><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml">The container creates only one instance per request (</span><strong><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml">scoped lifetime</span></strong><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml">).</span></li>
<li><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">It supports named configuration.</span></li>
<li><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml">It supports unnamed default settings through its </span><code><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml">CurrentValue</span></code><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml"> property.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml">If we only configure named options or no instance at all, the consumer will receive an empty </span><code><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml"> instance (</span><code><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml">new TOptions()</span></code><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml">).</span></p>
</blockquote>
</section>
<section class="level3" data-number="10.3.4" id="ioptionstoptions">
<h3 data-number="10.3.4"><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml">IOptions&lt;TOptions&gt;</span></h3>
<p><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml">This interface is the first that was added to ASP.NET Core.</span></p>
<ul>
<li><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml">It does not support advanced scenarios such as what snapshots and monitors do.</span></li>
<li><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml">Whenever you request an </span><code><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">IOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml"> instance, you get the same instance (</span><strong><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml">singleton lifetime</span></strong><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">).</span></li>
</ul>
<blockquote>
<p><code><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml">IOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml"> does not support named options, so you can only access the default instance.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml">Now that we looked at the building blocks, we dig into some code to explore leveraging those interfaces.</span></p>
</section>
</section>
<section class="level2" data-number="10.4" id="project-commonscenarios">
<h2 data-number="10.4"><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml">Project – CommonScenarios</span></h2>
<p><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml">This first example covers multiple basic use cases, such as injecting options, using named options, and storing options values in settings.Let’s start with the shared building block.</span></p>
<section class="level3" data-number="10.4.1" id="manual-configuration">
<h3 data-number="10.4.1"><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">Manual configuration</span></h3>
<p><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml">In the composition root, we can manually configure options, which is very useful for configuring ASP.NET Core MVC, the JSON serializer, other pieces of the framework, or our own handcrafted options.Here’s the first options class we use in the code, which contains only a </span><code><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml"> property:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml">namespace CommonScenarios;
public class MyOptions
{
    public string? </span><span class="koboSpan" id="kobo.188.2" xmlns="http://www.w3.org/1999/xhtml">Name { get; set; }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml">In the composition root, we can use the </span><code><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml">Configure</span></code><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml"> extension method that extends the </span><code><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml">IServiceCollection</span></code><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml"> interface to achieve this. </span><span class="koboSpan" id="kobo.193.2" xmlns="http://www.w3.org/1999/xhtml">Here’s how we can set the default options of the </span><code><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.Configure&lt;MyOptions&gt;(myOptions =&gt;
{
    myOptions.Name = "Default Option";
});</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml">With that code, if we inject that options instance into a class, the value of the </span><code><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml"> property will be </span><code><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml">Default Options</span></code><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml">.We explore loading settings from a non-hardcoded configuration source next.</span></p>
</section>
<section class="level3" data-number="10.4.2" id="using-the-settings-file">
<h3 data-number="10.4.2"><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml">Using the settings file</span></h3>
<p><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml">Loading configurations from a file is often more convenient than hardcoding the values in C#. </span><span class="koboSpan" id="kobo.203.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, the mechanism allows overriding the configurations using different sources, bringing even more advantages.To load </span><code><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml"> from the </span><code><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml"> file, we must first get the configuration section, then configure the options, like the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml">var defaultOptionsSection = builder.Configuration
    .GetSection("defaultOptions");
builder.Services
    .Configure&lt;MyOptions&gt;(defaultOptionsSection);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code loads the following data from the appsettings.json file:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml">{
  "defaultOptions": {
    "name": "Default Options"
  }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">defaultOptions</span></strong><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml"> section maps to objects with the same key in the JSON file (highlighted code). </span><span class="koboSpan" id="kobo.213.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml">name</span></code><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml"> property of the </span><code><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml">defaultOptions</span></code><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml"> section translates to the </span><code><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml"> property of the </span><code><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml"> class.That code does the same as the preceding hardcoded version. </span><span class="koboSpan" id="kobo.221.2" xmlns="http://www.w3.org/1999/xhtml">However, manually loading the section this way allows us to load a different section for different named options.Alternatively, we can also “bind” a configuration section to an existing object using the </span><code><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml">Bind</span></code><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml"> method like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">var options = new MyOptions();
builder.Configuration.GetSection("options1").Bind(options);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml">That code loads the settings and assigns them to the object’s properties, matching the settings key to the properties name. </span><span class="koboSpan" id="kobo.225.2" xmlns="http://www.w3.org/1999/xhtml">However, this does not add the object to the IoC container.To overcome this, if we do not want to register the dependency manually and don’t need the object, we can use the </span><code><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml">Bind</span></code><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml">BindConfiguration</span></code><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml"> methods from the </span><code><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml">OptionsBuilder&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.231.2" xmlns="http://www.w3.org/1999/xhtml">We create that object with the </span><code><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml">AddOptions</span></code><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml"> method, like for </span><code><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml">Bind</span></code><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml">:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.AddOptions&lt;MyOptions&gt;("Options3")
    .Bind(builder.Configuration.GetSection("options3"));</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code loads the </span><code><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml">options3</span></code><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml"> configuration section using the </span><code><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml">GetSection</span></code><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml"> method (highlighted), then the </span><code><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml">OptionsBuilder&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml"> binds that value to the name </span><code><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml">Options3</span></code><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml"> through the </span><code><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml">Bind</span></code><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.247.2" xmlns="http://www.w3.org/1999/xhtml">This registers a named instance of </span><code><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml"> with the container. </span><span class="koboSpan" id="kobo.249.2" xmlns="http://www.w3.org/1999/xhtml">We dig into named options later.Then again, we can skip the use of the </span><code><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">GetSection</span></code><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml"> method by using the </span><code><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">BindConfiguration</span></code><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml"> method instead, like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.AddOptions&lt;MyOptions&gt;("Options4")
    .BindConfiguration("options4");</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code loads the settings from the </span><code><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml">options4</span></code><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml"> section, then registers that new setting with the IoC container.These are just a subset of the different ways we can leverage the ASP.NET Core Options pattern and configuration system. </span><span class="koboSpan" id="kobo.257.2" xmlns="http://www.w3.org/1999/xhtml">Now that we know how to configure the options, it is time to use them.</span></p>
</section>
<section class="level3" data-number="10.4.3" id="injecting-options">
<h3 data-number="10.4.3"><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml">Injecting options</span></h3>
<p><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start by learning how to leverage the </span><code><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">IOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml"> interface, the first and simplest interface that came out of .NET Core.To try this out, let’s create an endpoint and inject the </span><code><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">IOptions&lt;MyOptions&gt;</span></code><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml"> interface as a parameter:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/my-options/",
    (IOptions&lt;MyOptions&gt; options) =&gt; options.Value
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, the </span><code><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml"> property returns the configured value, which is the following, serialized as JSON:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml">{
  "name": "Default Options"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml">And voilà! </span><span class="koboSpan" id="kobo.269.2" xmlns="http://www.w3.org/1999/xhtml">We can also use constructor injection or any other method we know to use the value of our options object.Next, we explore configuring multiple instances of the same options class.</span></p>
</section>
<section class="level3" data-number="10.4.4" id="named-options">
<h3 data-number="10.4.4"><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml">Named options</span></h3>
<p><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml">Now, let’s explore named options by configuring two more instances of the </span><code><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.273.2" xmlns="http://www.w3.org/1999/xhtml">The concept is to associate a configuration of the options with a name. </span><span class="koboSpan" id="kobo.273.3" xmlns="http://www.w3.org/1999/xhtml">Once that is done, we can request the configuration we need.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml">Unfortunately, the ways we explore named options and most online examples break the Inversion of Control principle.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml">Why? </span><span class="koboSpan" id="kobo.275.2" xmlns="http://www.w3.org/1999/xhtml">By injecting an interface that is directly tied to a lifetime, the consuming class controls that part of the dependency.</span></p>
</blockquote>
<blockquote>
<p><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml">Rest assured, we are revisiting this at the end of the chapter.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml">First, in the </span><code><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml"> file, let’s add the highlighted sections:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml">{
  "defaultOptions": {
    "name": "Default Options"
  },
  "options1": {
    "name": "Options 1"
  },
  "options2": {
    "name": "Options 2"
  }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have those configs, let’s configure them in the </span><code><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml"> file by adding the following lines:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.Configure&lt;MyOptions&gt;(
    "Options1",
    builder.Configuration.GetSection("options1")
);
builder.Services.Configure&lt;MyOptions&gt;(
    "Options2",
    builder.Configuration.GetSection("options2")
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, the highlighted strings represent the names of the options we are configuring. </span><span class="koboSpan" id="kobo.285.2" xmlns="http://www.w3.org/1999/xhtml">We associate each configuration section with a named instance.Now to consume those named options, we have multiple choices. </span><span class="koboSpan" id="kobo.285.3" xmlns="http://www.w3.org/1999/xhtml">We can inject an </span><code><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsFactory&lt;MyOptions&gt;</span></code><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor&lt;MyOptions&gt;</span></code><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml">, or an </span><code><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot&lt;MyOptions&gt;</span></code><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.291.2" xmlns="http://www.w3.org/1999/xhtml">The final choice depends on the lifetime the consumer of the options needs. </span><span class="koboSpan" id="kobo.291.3" xmlns="http://www.w3.org/1999/xhtml">However, in our case, we use all of them to ensure we explore them all.</span></p>
<section class="level4" data-number="10.4.4.1" id="ioptionsfactorymyoptions">
<h4 data-number="10.4.4.1"><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsFactory&lt;MyOptions&gt;</span></h4>
<p><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start with creating an endpoint where we inject a factory:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/factory/{name}",
    (string name, IOptionsFactory&lt;MyOptions&gt; factory)
        =&gt; factory.Create(name)
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">The factory interface forces us to pass in a name that is convenient for us. </span><span class="koboSpan" id="kobo.295.2" xmlns="http://www.w3.org/1999/xhtml">When we execute the program, the endpoint serves us the options based on the specified name. </span><span class="koboSpan" id="kobo.295.3" xmlns="http://www.w3.org/1999/xhtml">For example, when we send the following request:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">GET https://localhost:8001/factory/Options1</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml">The endpoint returns the following JSON:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml">{
  "name": "Options 1"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml">If we pass Options2 instead, we get the following JSON:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml">{
  "name": "Options 2"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">As simple as that, we can now choose between three different options. </span><span class="koboSpan" id="kobo.301.2" xmlns="http://www.w3.org/1999/xhtml">Of course, once again, we can leverage any other technique we know, like constructor injections.Let’s explore the next interface.</span></p>
</section>
<section class="level4" data-number="10.4.4.2" id="ioptionsmonitormyoptions">
<h4 data-number="10.4.4.2"><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor&lt;MyOptions&gt;</span></h4>
<p><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml">We use the </span><code><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor</span></code><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml"> interface similarly to the </span><code><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsFactory</span></code><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml"> interface when we need named options. </span><span class="koboSpan" id="kobo.307.2" xmlns="http://www.w3.org/1999/xhtml">So, let’s start by creating a similar endpoint:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/monitor/{name}",
    (string name, IOptionsMonitor&lt;MyOptions&gt; monitor)
        =&gt; monitor.Get(name)
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code is almost the same as the factory one, but the </span><code><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor</span></code><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml"> interface exposes a </span><code><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml">Get</span></code><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml"> method instead of a </span><code><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml">Create</span></code><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.315.2" xmlns="http://www.w3.org/1999/xhtml">This semantically expresses that the code is getting an options instance (singleton) instead of creating a new one (transient).Again, similarly, if we send the following request:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml">GET https://localhost:8001/monitor/Options2</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml">The server returns the following JSON:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml">{
  "name": "Options 2"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml">One difference is that we can access the default options as well; here’s how:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/monitor",
    (IOptionsMonitor&lt;MyOptions&gt; monitor)
        =&gt; monitor.CurrentValue
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, the </span><code><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml">CurrentValue</span></code><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml"> property returns the default options. </span><span class="koboSpan" id="kobo.323.2" xmlns="http://www.w3.org/1999/xhtml">So, when calling this endpoint, we should receive the following JSON:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml">{
  "name": "Default Options"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml">As simple as that, we can either access the default value or a named value. </span><span class="koboSpan" id="kobo.325.2" xmlns="http://www.w3.org/1999/xhtml">We explore one other scenario that the </span><code><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor</span></code><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml"> interface supports after we cover the </span><code><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot</span></code><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml"> interface next.</span></p>
</section>
<section class="level4" data-number="10.4.4.3" id="ioptionssnapshotmyoptions">
<h4 data-number="10.4.4.3"><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot&lt;MyOptions&gt;</span></h4>
<p><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot</span></code><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml"> interface inherits the </span><code><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml">IOptions</span></code><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml"> interface, contributing its </span><code><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml"> property, and also offers a </span><code><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">Get</span></code><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml"> method (scoped lifetime) that works like the </span><code><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor</span></code><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml"> interface.Let’s start with the first endpoint:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/snapshot",
    (IOptionsSnapshot&lt;MyOptions&gt; snapshot)
        =&gt; snapshot.Value
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml">It should be no surprise that the preceding endpoint returns the following default options:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml">{
  "name": "Default Options"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">Then the following parametrized endpoint returns the specified named options:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/snapshot/{name}",
    (string name, IOptionsSnapshot&lt;MyOptions&gt; snapshot)
        =&gt; snapshot.Get(name)
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml">Say we are passing the name </span><code><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">Options1</span></code><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml">, then the endpoint will return the following options:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">{
  "name": "Options 1"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml">And we are done. </span><span class="koboSpan" id="kobo.351.2" xmlns="http://www.w3.org/1999/xhtml">It is quite simple to use the options as .NET does most of the work for us. </span><span class="koboSpan" id="kobo.351.3" xmlns="http://www.w3.org/1999/xhtml">The same goes for configuring options classes.But wait, our exploration isn't over yet! </span><span class="koboSpan" id="kobo.351.4" xmlns="http://www.w3.org/1999/xhtml">Up next, we delve into the process of reloading options at runtime.</span></p>
</section>
</section>
<section class="level3" data-number="10.4.5" id="reloading-options-at-runtime">
<h3 data-number="10.4.5"><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">Reloading options at runtime</span></h3>
<p><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">A fascinating aspect of the ASP.NET Core options is that the system reloads the value of the options when someone updates a configuration file like </span><code><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.355.2" xmlns="http://www.w3.org/1999/xhtml">To try it out, you can:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml">Run the program.</span></li>
<li><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml">Query an endpoint using the request available in the </span><code><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml">CommonScenarios.http</span></code><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml"> file.</span></li>
<li><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml">Change the value of that option in the </span><code><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml"> file and save the file.</span></li>
<li><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml">Query the same endpoint again, and you should see the updated value.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml">This is an out-of-the-box feature. </span><span class="koboSpan" id="kobo.364.2" xmlns="http://www.w3.org/1999/xhtml">However, the system rebuilds the options instance, which does not update the references on the previous instance. </span><span class="koboSpan" id="kobo.364.3" xmlns="http://www.w3.org/1999/xhtml">The good news is that we can hook into the system and react to the changes.For most scenarios, we don’t need to manually check for change since the value of the </span><code><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml">CurrentValue</span></code><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml"> property gets updated. </span><span class="koboSpan" id="kobo.366.2" xmlns="http://www.w3.org/1999/xhtml">However, if you directly reference that value, this mechanism can be useful.In this scenario, we have a notification service that sends emails. </span><span class="koboSpan" id="kobo.366.3" xmlns="http://www.w3.org/1999/xhtml">The SMTP client’s configurations are settings. </span><span class="koboSpan" id="kobo.366.4" xmlns="http://www.w3.org/1999/xhtml">In this case, we only have the </span><code><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml">SenderEmailAddress</span></code><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml"> since sending actual emails is unnecessary. </span><span class="koboSpan" id="kobo.368.2" xmlns="http://www.w3.org/1999/xhtml">We are logging the notification in the console instead, allowing us to see the configuration changes appear live.Let’s start with the </span><code><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml">EmailOptions</span></code><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml">namespace CommonScenarios.Reload;
public class EmailOptions
{
    public string? </span><span class="koboSpan" id="kobo.371.2" xmlns="http://www.w3.org/1999/xhtml">SenderEmailAddress { get; set; }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml">Next, we have the </span><code><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml">NotificationService</span></code><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml"> class itself. </span><span class="koboSpan" id="kobo.374.2" xmlns="http://www.w3.org/1999/xhtml">Let’s start with its first iteration:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">namespace CommonScenarios.Reload;
public class NotificationService
{
    private EmailOptions _emailOptions;
    private readonly ILogger _logger;
    public NotificationService(IOptionsMonitor&lt;EmailOptions&gt; emailOptionsMonitor, ILogger&lt;NotificationService&gt; logger)
    {
        _logger = logger ?? </span><span class="koboSpan" id="kobo.375.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(logger));
        ArgumentNullException.ThrowIfNull(emailOptionsMonitor);
        _emailOptions = emailOptionsMonitor.CurrentValue;
    }
    public Task NotifyAsync(string to)
    {
        _logger.LogInformation(
            "Notification sent by '{SenderEmailAddress}' to '{to}'.", 
            _emailOptions.SenderEmailAddress, 
            to
        );
        return Task.CompletedTask;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, the class holds a reference on the </span><code><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml">EmailOptions</span></code><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml"> class upon creation (highlighted lines). </span><span class="koboSpan" id="kobo.378.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml">NotifyAsync</span></code><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml"> method writes an information message in the console and then returns.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">We explore logging in the next chapter.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml">Because the </span><code><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml">NotificationService</span></code><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml"> class has a singleton lifetime and references the options class itself, if we change the configuration, the value will not update since the system recreates a new instance with the updated configuration. </span><span class="koboSpan" id="kobo.384.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the service registration method:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml">public static WebApplicationBuilder AddNotificationService(
    this WebApplicationBuilder builder)
{
    builder.Services.Configure&lt;EmailOptions&gt;(builder.Configuration
        .GetSection(nameof(EmailOptions)));
    builder.Services.AddSingleton&lt;NotificationService&gt;();
    return builder;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml">How to fix this? </span><span class="koboSpan" id="kobo.386.2" xmlns="http://www.w3.org/1999/xhtml">In this case, we could fix the issue by referencing the </span><code><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor</span></code><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml"> interface instead of its </span><code><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml">CurrentValue</span></code><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml"> property. </span><span class="koboSpan" id="kobo.390.2" xmlns="http://www.w3.org/1999/xhtml">However, if you face a scenario where it’s impossible, we can tap into the </span><code><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml">OnChange</span></code><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml"> method of the </span><code><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor</span></code><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.394.2" xmlns="http://www.w3.org/1999/xhtml">In the constructor, we could add the following code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">emailOptionsMonitor.OnChange((options) =&gt;_emailOptions = options);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml">With that code, when the </span><code><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml"> file changes, the code updates the </span><code><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml">_emailOptions</span></code><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml"> field. </span><span class="koboSpan" id="kobo.400.2" xmlns="http://www.w3.org/1999/xhtml">As easy as this, we reactivated the reloading feature.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml">One more thing, the </span><code><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml">OnChange</span></code><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml"> method returns an </span><code><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml">IDisposable</span></code><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml"> we can dispose of to stop listening for changes. </span><span class="koboSpan" id="kobo.405.2" xmlns="http://www.w3.org/1999/xhtml">I implemented two additional methods in the source code: </span><code><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml">StartListeningForChanges</span></code><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">StopListeningForChanges</span></code><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml">, and three endpoints, one to send notifications, one to stop listening for changes, and one to start listening for changes again.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml">Now that we know how to use the options, let’s explore additional ways to configure them.</span></p>
</section>
</section>
<section class="level2" data-number="10.5" id="project-optionsconfiguration">
<h2 data-number="10.5"><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml">Project – OptionsConfiguration</span></h2>
<p><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have covered basic usage scenarios, let’s attack some more advanced possibilities, such as creating types to configure, initialize, and validate our options.We start by configuring options which happen in two phases:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml">The configuration phase.</span></li>
<li><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml">The post-configuration phase.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml">In a nutshell, the post-configuration phase happens later in the process. </span><span class="koboSpan" id="kobo.415.2" xmlns="http://www.w3.org/1999/xhtml">This is a good place to enforce that some values are configured a certain way or to override configuration, for example, in integration tests.To configure an options class, we have many options, starting with the following interfaces:</span></p>
<table>
<tbody>
<tr class="odd">
<td><strong><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml">Interface</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></strong></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureOptions&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">Configure the default </span><code><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml"> type.</span></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureNamedOptions&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml">Configure the default and named </span><code><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml"> type.</span></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml">IPostConfigureOptions&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml">Configure the default and named </span><code><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml"> type during the post-configuration phase.</span></td>
</tr>
</tbody>
</table><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml">
Table 9.2: interfaces to configure options classes.
</span><blockquote>
<p><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">If a configuration class implements both </span><code><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureOptions</span></code><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureNamedOptions</span></code><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml"> interfaces, the </span><code><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureNamedOptions</span></code><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml"> interface will take precedence, and the </span><code><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml">Configure</span></code><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml"> method of the </span><code><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureOptions</span></code><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml"> interface will not be executed.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml">You can configure the default instance using the </span><code><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml">Configure</span></code><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml"> method of the </span><code><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureNamedOptions</span></code><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml"> interface; the name of the options will be empty (equal to the member </span><code><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml">Options.DefaultName</span></code><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml">).</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">We can also leverage the following methods that extend the </span><code><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml">IServiceCollection</span></code><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml"> interface:</span></p>
<table>
<tbody>
<tr class="odd">
<td><strong><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml">Method</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></strong></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml">Configure&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml">Configure the default and named </span><code><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml"> type inline or from a configuration section.</span></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml">ConfigureAll&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml">Configure all options of type </span><code><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml"> inline.</span></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">PostConfigure&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml">Configure the default and named </span><code><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml"> type inline during the post-configuration phase.</span></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.466.1" xmlns="http://www.w3.org/1999/xhtml">PostConfigureAll&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.467.1" xmlns="http://www.w3.org/1999/xhtml">Configure all options of type </span><code><span class="koboSpan" id="kobo.468.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.469.1" xmlns="http://www.w3.org/1999/xhtml"> inline during the post-configuration phase.</span></td>
</tr>
</tbody>
</table><span class="koboSpan" id="kobo.470.1" xmlns="http://www.w3.org/1999/xhtml">
Table 9.3: configuration methods.
</span><p><span class="koboSpan" id="kobo.471.1" xmlns="http://www.w3.org/1999/xhtml">As we are about to see, the registration order is very important. </span><span class="koboSpan" id="kobo.471.2" xmlns="http://www.w3.org/1999/xhtml">The configurators are executed in order of registration. </span><span class="koboSpan" id="kobo.471.3" xmlns="http://www.w3.org/1999/xhtml">Each phase is independent of the other; thus, the sequence in which we arrange the configuration and post-configuration phases doesn't influence one another.First, we must lay out the groundwork for our little program.</span></p>
<section class="level3" data-number="10.5.1" id="creating-the-program">
<h3 data-number="10.5.1"><span class="koboSpan" id="kobo.472.1" xmlns="http://www.w3.org/1999/xhtml">Creating the program</span></h3>
<p><span class="koboSpan" id="kobo.473.1" xmlns="http://www.w3.org/1999/xhtml">After creating an empty web application, the first building block is to create the options class that we want to configure:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.474.1" xmlns="http://www.w3.org/1999/xhtml">namespace OptionsConfiguration;
public class ConfigureMeOptions
{
    public string? </span><span class="koboSpan" id="kobo.474.2" xmlns="http://www.w3.org/1999/xhtml">Title { get; set; }
    public IEnumerable&lt;string&gt; Lines { get; set; } = Enumerable.Empty&lt;string&gt;();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.475.1" xmlns="http://www.w3.org/1999/xhtml">We use the </span><code><span class="koboSpan" id="kobo.476.1" xmlns="http://www.w3.org/1999/xhtml">Lines</span></code><span class="koboSpan" id="kobo.477.1" xmlns="http://www.w3.org/1999/xhtml"> property as a trace bucket. </span><span class="koboSpan" id="kobo.477.2" xmlns="http://www.w3.org/1999/xhtml">We add lines to it to visually confirm the order that the configurators are executed.Next, we define application settings in the </span><code><span class="koboSpan" id="kobo.478.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.479.1" xmlns="http://www.w3.org/1999/xhtml"> file:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.480.1" xmlns="http://www.w3.org/1999/xhtml">{
  "configureMe": {
    "title": "Configure Me!",
    "lines": [
      "appsettings.json"
    ]
  }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.481.1" xmlns="http://www.w3.org/1999/xhtml">We use the configuration as a starting point. </span><span class="koboSpan" id="kobo.481.2" xmlns="http://www.w3.org/1999/xhtml">It defines the value of the </span><code><span class="koboSpan" id="kobo.482.1" xmlns="http://www.w3.org/1999/xhtml">Title</span></code><span class="koboSpan" id="kobo.483.1" xmlns="http://www.w3.org/1999/xhtml"> property and adds a first line to the </span><code><span class="koboSpan" id="kobo.484.1" xmlns="http://www.w3.org/1999/xhtml">Lines</span></code><span class="koboSpan" id="kobo.485.1" xmlns="http://www.w3.org/1999/xhtml"> property, allowing us to trace the order it is executed.Next, we need an endpoint to access the settings, serialize the result to a JSON string, and then write it to the response stream:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.486.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/configure-me",
    (IOptionsMonitor&lt;ConfigureMeOptions&gt; options) =&gt; new {
        DefaultInstance = options.CurrentValue,
        NamedInstance = options.Get(NamedInstance)
    }
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.487.1" xmlns="http://www.w3.org/1999/xhtml">By calling this endpoint, we can consult the values of the default and named instances we are about to create.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.488.1" xmlns="http://www.w3.org/1999/xhtml">ASP.NET Core configures the options when they are requested for the first time. </span><span class="koboSpan" id="kobo.488.2" xmlns="http://www.w3.org/1999/xhtml">In this case, both instances of the </span><code><span class="koboSpan" id="kobo.489.1" xmlns="http://www.w3.org/1999/xhtml">ConfigureMeOptions</span></code><span class="koboSpan" id="kobo.490.1" xmlns="http://www.w3.org/1999/xhtml"> class are configured when calling the </span><code><span class="koboSpan" id="kobo.491.1" xmlns="http://www.w3.org/1999/xhtml">/configure-me</span></code><span class="koboSpan" id="kobo.492.1" xmlns="http://www.w3.org/1999/xhtml"> endpoint for the first time.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.493.1" xmlns="http://www.w3.org/1999/xhtml">If we run the program now, we end up with two empty instances, so before doing that, we need to tell ASP.NET about the </span><code><span class="koboSpan" id="kobo.494.1" xmlns="http://www.w3.org/1999/xhtml">configureMe</span></code><span class="koboSpan" id="kobo.495.1" xmlns="http://www.w3.org/1999/xhtml"> configuration section we added to the </span><code><span class="koboSpan" id="kobo.496.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.497.1" xmlns="http://www.w3.org/1999/xhtml"> file.</span></p>
</section>
<section class="level3" data-number="10.5.2" id="configuring-the-options">
<h3 data-number="10.5.2"><span class="koboSpan" id="kobo.498.1" xmlns="http://www.w3.org/1999/xhtml">Configuring the options</span></h3>
<p><span class="koboSpan" id="kobo.499.1" xmlns="http://www.w3.org/1999/xhtml">We want two different options to test out many possibilities:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.500.1" xmlns="http://www.w3.org/1999/xhtml">A default options (unnamed)</span></li>
<li><span class="koboSpan" id="kobo.501.1" xmlns="http://www.w3.org/1999/xhtml">A named instance.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.502.1" xmlns="http://www.w3.org/1999/xhtml">To achieve this, we must add the following lines in the </span><code><span class="koboSpan" id="kobo.503.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.504.1" xmlns="http://www.w3.org/1999/xhtml"> file:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.505.1" xmlns="http://www.w3.org/1999/xhtml">const string NamedInstance = "MyNamedInstance";
builder.Services
    .Configure&lt;ConfigureMeOptions&gt;(builder.Configuration
        .GetSection("configureMe"))
    .Configure&lt;ConfigureMeOptions&gt;(NamedInstance, builder.Configuration
        .GetSection("configureMe"))
;</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.506.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code registers a default instance (highlighted code) and a named instance. </span><span class="koboSpan" id="kobo.506.2" xmlns="http://www.w3.org/1999/xhtml">Both use the </span><code><span class="koboSpan" id="kobo.507.1" xmlns="http://www.w3.org/1999/xhtml">configureMe</span></code><span class="koboSpan" id="kobo.508.1" xmlns="http://www.w3.org/1999/xhtml"> configuration sections and so start with the same initial values, as we can see when running the project:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.509.1" xmlns="http://www.w3.org/1999/xhtml">{
  "defaultInstance": {
    "title": "Configure Me!",
    "lines": [
      "appsettings.json"
    ]
  },
  "namedInstance": {
    "title": "Configure Me!",
    "lines": [
      "appsettings.json"
    ]
  }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.510.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.511.1" xmlns="http://www.w3.org/1999/xhtml">defaultInstance</span></code><span class="koboSpan" id="kobo.512.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.513.1" xmlns="http://www.w3.org/1999/xhtml">namedInstance</span></code><span class="koboSpan" id="kobo.514.1" xmlns="http://www.w3.org/1999/xhtml"> properties are self-explanatory and relate to their respective options instance.Now that we completed our building blocks, we are ready to explore the </span><code><span class="koboSpan" id="kobo.515.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.516.1" xmlns="http://www.w3.org/1999/xhtml"> interface.</span></p>
</section>
<section class="level3" data-number="10.5.3" id="implementing-a-configurator-object">
<h3 data-number="10.5.3"><span class="koboSpan" id="kobo.517.1" xmlns="http://www.w3.org/1999/xhtml">Implementing a configurator object</span></h3>
<p><span class="koboSpan" id="kobo.518.1" xmlns="http://www.w3.org/1999/xhtml">We can encapsulate the configuration logic into classes to apply the single responsibility principle (SRP). </span><span class="koboSpan" id="kobo.518.2" xmlns="http://www.w3.org/1999/xhtml">To do so, we must implement an interface and create the binding with the IoC container.First, we must create a class that we name </span><code><span class="koboSpan" id="kobo.519.1" xmlns="http://www.w3.org/1999/xhtml">ConfigureAllConfigureMeOptions</span></code><span class="koboSpan" id="kobo.520.1" xmlns="http://www.w3.org/1999/xhtml">, which configures all </span><code><span class="koboSpan" id="kobo.521.1" xmlns="http://www.w3.org/1999/xhtml">ConfigureMeOptions</span></code><span class="koboSpan" id="kobo.522.1" xmlns="http://www.w3.org/1999/xhtml"> instances; default and named:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.523.1" xmlns="http://www.w3.org/1999/xhtml">namespace OptionsConfiguration;
public class ConfigureAllConfigureMeOptions : IConfigureNamedOptions&lt;ConfigureMeOptions&gt;
{
    public void Configure(string? </span><span class="koboSpan" id="kobo.523.2" xmlns="http://www.w3.org/1999/xhtml">name, ConfigureMeOptions options)
    {
        options.Lines = options.Lines.Append(
            $"ConfigureAll:Configure name: {name}");
        if (name != Options.DefaultName)
        {
            options.Lines = options.Lines.Append(
                $"ConfigureAll:Configure Not Default: {name}");
        }
    }
    public void Configure(ConfigureMeOptions options)
        =&gt; Configure(Options.DefaultName, options);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.524.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we implement the interface (highlighted code), which contains two methods. </span><span class="koboSpan" id="kobo.524.2" xmlns="http://www.w3.org/1999/xhtml">The second </span><code><span class="koboSpan" id="kobo.525.1" xmlns="http://www.w3.org/1999/xhtml">Configure</span></code><span class="koboSpan" id="kobo.526.1" xmlns="http://www.w3.org/1999/xhtml"> method should never be called, but just in case, we can simply redirect the call to the other method if it happens. </span><span class="koboSpan" id="kobo.526.2" xmlns="http://www.w3.org/1999/xhtml">The body of the first </span><code><span class="koboSpan" id="kobo.527.1" xmlns="http://www.w3.org/1999/xhtml">Configure</span></code><span class="koboSpan" id="kobo.528.1" xmlns="http://www.w3.org/1999/xhtml"> method (highlighted) adds a line to all options and a second line when the options is not the default one.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.529.1" xmlns="http://www.w3.org/1999/xhtml">Instead of testing if the options is not the default one (</span><code><span class="koboSpan" id="kobo.530.1" xmlns="http://www.w3.org/1999/xhtml">name != Options.DefaultName</span></code><span class="koboSpan" id="kobo.531.1" xmlns="http://www.w3.org/1999/xhtml">), you can check for the options name or use a </span><code><span class="koboSpan" id="kobo.532.1" xmlns="http://www.w3.org/1999/xhtml">switch</span></code><span class="koboSpan" id="kobo.533.1" xmlns="http://www.w3.org/1999/xhtml"> to configure specific options by name.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.534.1" xmlns="http://www.w3.org/1999/xhtml">We can tell the IoC container about this code, so ASP.NET Core executes it like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.535.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.AddSingleton&lt;IConfigureOptions&lt;ConfigureMeOptions&gt;, ConfigureAllConfigureMeOptions&gt;();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.536.1" xmlns="http://www.w3.org/1999/xhtml">Now with this binding in place, ASP.NET Core will run our code the first time we request our endpoint. </span><span class="koboSpan" id="kobo.536.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the result:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.537.1" xmlns="http://www.w3.org/1999/xhtml">{
  "defaultInstance": {
    "title": "Configure Me!",
    "lines": [
      "appsettings.json",
      "ConfigureAll:Configure name: "
    ]
  },
  "namedInstance": {
    "title": "Configure Me!",
    "lines": [
      "appsettings.json",
      "ConfigureAll:Configure name: MyNamedInstance",
      "ConfigureAll:Configure Not Default: MyNamedInstance"
    ]
  }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.538.1" xmlns="http://www.w3.org/1999/xhtml">As we can see from that JSON output, the configurator ran and added the expected lines to each instance.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.539.1" xmlns="http://www.w3.org/1999/xhtml">It is important to note that you must bind the </span><code><span class="koboSpan" id="kobo.540.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.541.1" xmlns="http://www.w3.org/1999/xhtml"> to your configuration class even if you implemented the </span><code><span class="koboSpan" id="kobo.542.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureNamedOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.543.1" xmlns="http://www.w3.org/1999/xhtml"> interface.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.544.1" xmlns="http://www.w3.org/1999/xhtml">And voilà—we have a neat result that took almost no effort. </span><span class="koboSpan" id="kobo.544.2" xmlns="http://www.w3.org/1999/xhtml">This can lead to so many possibilities! </span><span class="koboSpan" id="kobo.544.3" xmlns="http://www.w3.org/1999/xhtml">Implementing </span><code><span class="koboSpan" id="kobo.545.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.546.1" xmlns="http://www.w3.org/1999/xhtml"> is probably the best way to configure the default values of an options class.Next, we add post-configuration to the mix!</span></p>
</section>
<section class="level3" data-number="10.5.4" id="adding-post-configuration">
<h3 data-number="10.5.4"><span class="koboSpan" id="kobo.547.1" xmlns="http://www.w3.org/1999/xhtml">Adding post-configuration</span></h3>
<p><span class="koboSpan" id="kobo.548.1" xmlns="http://www.w3.org/1999/xhtml">We must take a similar path to add post-configuration values but implement the </span><code><span class="koboSpan" id="kobo.549.1" xmlns="http://www.w3.org/1999/xhtml">IPostConfigureOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.550.1" xmlns="http://www.w3.org/1999/xhtml"> instead. </span><span class="koboSpan" id="kobo.550.2" xmlns="http://www.w3.org/1999/xhtml">To achieve this, we update the </span><code><span class="koboSpan" id="kobo.551.1" xmlns="http://www.w3.org/1999/xhtml">ConfigureAllConfigureMeOptions</span></code><span class="koboSpan" id="kobo.552.1" xmlns="http://www.w3.org/1999/xhtml"> class to implement that interface:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.553.1" xmlns="http://www.w3.org/1999/xhtml">namespace OptionsConfiguration;
public class ConfigureAllConfigureMeOptions :
    IPostConfigureOptions&lt;ConfigureMeOptions&gt;,
    IConfigureNamedOptions&lt;ConfigureMeOptions&gt;
{
    // Omitted previous code
    public void PostConfigure(string? </span><span class="koboSpan" id="kobo.553.2" xmlns="http://www.w3.org/1999/xhtml">name, ConfigureMeOptions options)
    {
        options.Lines = options.Lines.Append(
            $"ConfigureAll:PostConfigure name: {name}");
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.554.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we implemented the interface (highlighted lines). </span><span class="koboSpan" id="kobo.554.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.555.1" xmlns="http://www.w3.org/1999/xhtml">PostConfigure</span></code><span class="koboSpan" id="kobo.556.1" xmlns="http://www.w3.org/1999/xhtml"> method simply adds a line to the </span><code><span class="koboSpan" id="kobo.557.1" xmlns="http://www.w3.org/1999/xhtml">Lines</span></code><span class="koboSpan" id="kobo.558.1" xmlns="http://www.w3.org/1999/xhtml"> property. </span><span class="koboSpan" id="kobo.558.2" xmlns="http://www.w3.org/1999/xhtml">To register it with the IoC container, we must add the following line:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.559.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.AddSingleton&lt;IPostConfigureOptions&lt;ConfigureMeOptions&gt;, ConfigureAllConfigureMeOptions&gt;();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.560.1" xmlns="http://www.w3.org/1999/xhtml">The big difference is that this runs during the post-configuration phase, independent of the initial configuration phase. </span><span class="koboSpan" id="kobo.560.2" xmlns="http://www.w3.org/1999/xhtml">Executing the application now leads to the following result:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.561.1" xmlns="http://www.w3.org/1999/xhtml">{
  "defaultInstance": {
    "title": "Configure Me!",
    "lines": [
      "appsettings.json",
      "ConfigureAll:Configure name: ",
      "ConfigureAll:PostConfigure name: "
    ]
  },
  "namedInstance": {
    "title": "Configure Me!",
    "lines": [
      "appsettings.json",
      "ConfigureAll:Configure name: MyNamedInstance",
      "ConfigureAll:Configure Not Default: MyNamedInstance",
      "ConfigureAll:PostConfigure name: MyNamedInstance"
    ]
  }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.562.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding JSON, the highlighted lines represent our post-configuration code that was added at the end. </span><span class="koboSpan" id="kobo.562.2" xmlns="http://www.w3.org/1999/xhtml">You might tell yourself, of course, it’s the last line; it’s the last code we registered, which is a legitimate assumption. </span><span class="koboSpan" id="kobo.562.3" xmlns="http://www.w3.org/1999/xhtml">However, here’s the complete registration code, which clearly shows the </span><code><span class="koboSpan" id="kobo.563.1" xmlns="http://www.w3.org/1999/xhtml">IPostConfigureOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.564.1" xmlns="http://www.w3.org/1999/xhtml"> interface was registered first (highlighted), proving the post-configuration code runs last:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.565.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services
    .AddSingleton&lt;IPostConfigureOptions&lt;ConfigureMeOptions&gt;, ConfigureAllConfigureMeOptions&gt;()
    .Configure&lt;ConfigureMeOptions&gt;(builder.Configuration
        .GetSection("configureMe"))
    .Configure&lt;ConfigureMeOptions&gt;(NamedInstance, builder.Configuration
        .GetSection("configureMe"))
    .AddSingleton&lt;IConfigureOptions&lt;ConfigureMeOptions&gt;, ConfigureAllConfigureMeOptions&gt;()
;</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.566.1" xmlns="http://www.w3.org/1999/xhtml">Next, we create a second configuration class.</span></p>
</section>
<section class="level3" data-number="10.5.5" id="using-multiple-configurator-objects">
<h3 data-number="10.5.5"><span class="koboSpan" id="kobo.567.1" xmlns="http://www.w3.org/1999/xhtml">Using multiple configurator objects</span></h3>
<p><span class="koboSpan" id="kobo.568.1" xmlns="http://www.w3.org/1999/xhtml">A very interesting concept with the ASP.NET Core options pattern is that we can register as many configuration classes as we want. </span><span class="koboSpan" id="kobo.568.2" xmlns="http://www.w3.org/1999/xhtml">This creates many possibilities, including code from one or more assemblies configuring the same options class.Now that we know how this works, let’s add the </span><code><span class="koboSpan" id="kobo.569.1" xmlns="http://www.w3.org/1999/xhtml">ConfigureMoreConfigureMeOptions</span></code><span class="koboSpan" id="kobo.570.1" xmlns="http://www.w3.org/1999/xhtml"> class, which also adds a line to the </span><code><span class="koboSpan" id="kobo.571.1" xmlns="http://www.w3.org/1999/xhtml">Lines</span></code><span class="koboSpan" id="kobo.572.1" xmlns="http://www.w3.org/1999/xhtml"> property:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.573.1" xmlns="http://www.w3.org/1999/xhtml">namespace OptionsConfiguration;
public class ConfigureMoreConfigureMeOptions : IConfigureOptions&lt;ConfigureMeOptions&gt;
{
    public void Configure(ConfigureMeOptions options)
    {
        options.Lines = options.Lines.Append("ConfigureMore:Configure");
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.574.1" xmlns="http://www.w3.org/1999/xhtml">This time, we want that class only to augment the default instance, so it implements the </span><strong><span class="koboSpan" id="kobo.575.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureOptions&lt;TOptions&gt;</span></strong><span class="koboSpan" id="kobo.576.1" xmlns="http://www.w3.org/1999/xhtml"> interface (highlighted lines).Next, we must register the binding:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.577.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.AddSingleton&lt;IConfigureOptions&lt;ConfigureMeOptions&gt;, ConfigureMoreConfigureMeOptions&gt;();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.578.1" xmlns="http://www.w3.org/1999/xhtml">As we can see, it’s the same binding but pointing to the </span><code><span class="koboSpan" id="kobo.579.1" xmlns="http://www.w3.org/1999/xhtml">ConfigureMoreConfigureMeOptions</span></code><span class="koboSpan" id="kobo.580.1" xmlns="http://www.w3.org/1999/xhtml"> class instead of the </span><code><span class="koboSpan" id="kobo.581.1" xmlns="http://www.w3.org/1999/xhtml">ConfigureAllConfigureMeOptions</span></code><span class="koboSpan" id="kobo.582.1" xmlns="http://www.w3.org/1999/xhtml"> class.Executing the application and querying the endpoint outputs the following JSON:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.583.1" xmlns="http://www.w3.org/1999/xhtml">{
  "defaultInstance": {
    "title": "Configure Me!",
    "lines": [
      "appsettings.json",
      "ConfigureAll:Configure name: ",
      "ConfigureMore:Configure",
      "ConfigureAll:PostConfigure name: "
    ]
  },
  "namedInstance": {
    "title": "Configure Me!",
    "lines": [
      "appsettings.json",
      "ConfigureAll:Configure name: MyNamedInstance",
      "ConfigureAll:Configure Not Default: MyNamedInstance",
      "ConfigureAll:PostConfigure name: MyNamedInstance"
    ]
  }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.584.1" xmlns="http://www.w3.org/1999/xhtml">The preceding JSON shows the line our new class added to only the default instance (highlighted) before the post-configure option.The possibilities are great, right? </span><span class="koboSpan" id="kobo.584.2" xmlns="http://www.w3.org/1999/xhtml">The code can contribute configuration objects and register them in one of the two phases to configure options objects. </span><span class="koboSpan" id="kobo.584.3" xmlns="http://www.w3.org/1999/xhtml">Next, we explore a few more possibilities.</span></p>
</section>
<section class="level3" data-number="10.5.6" id="exploring-other-configuration-possibilities">
<h3 data-number="10.5.6"><span class="koboSpan" id="kobo.585.1" xmlns="http://www.w3.org/1999/xhtml">Exploring other configuration possibilities</span></h3>
<p><span class="koboSpan" id="kobo.586.1" xmlns="http://www.w3.org/1999/xhtml">We can mix those configuration classes with extension methods. </span><span class="koboSpan" id="kobo.586.2" xmlns="http://www.w3.org/1999/xhtml">For example:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.587.1" xmlns="http://www.w3.org/1999/xhtml">We can call the </span><code><span class="koboSpan" id="kobo.588.1" xmlns="http://www.w3.org/1999/xhtml">Configure</span></code><span class="koboSpan" id="kobo.589.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.590.1" xmlns="http://www.w3.org/1999/xhtml">PostConfigure</span></code><span class="koboSpan" id="kobo.591.1" xmlns="http://www.w3.org/1999/xhtml"> methods multiple times.</span></li>
<li><span class="koboSpan" id="kobo.592.1" xmlns="http://www.w3.org/1999/xhtml">We can call the </span><code><span class="koboSpan" id="kobo.593.1" xmlns="http://www.w3.org/1999/xhtml">ConfigureAll</span></code><span class="koboSpan" id="kobo.594.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.595.1" xmlns="http://www.w3.org/1999/xhtml">PostConfigureAll</span></code><span class="koboSpan" id="kobo.596.1" xmlns="http://www.w3.org/1999/xhtml"> methods to configure all the options of a given </span><code><span class="koboSpan" id="kobo.597.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.598.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.599.1" xmlns="http://www.w3.org/1999/xhtml">Here, we use the </span><code><span class="koboSpan" id="kobo.600.1" xmlns="http://www.w3.org/1999/xhtml">PostConfigure</span></code><span class="koboSpan" id="kobo.601.1" xmlns="http://www.w3.org/1999/xhtml"> method to demonstrate that. </span><span class="koboSpan" id="kobo.601.2" xmlns="http://www.w3.org/1999/xhtml">Let’s add the following two lines of code (highlighted):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.602.1" xmlns="http://www.w3.org/1999/xhtml">const string NamedInstance = "MyNamedInstance";
var builder = WebApplication.CreateBuilder(args);
builder.Services.PostConfigure&lt;ConfigureMeOptions&gt;(
    NamedInstance,
    x =&gt; x.Lines = x.Lines.Append("Inline PostConfigure Before")
);
builder.Services
    .AddSingleton&lt;IPostConfigureOptions&lt;ConfigureMeOptions&gt;, ConfigureAllConfigureMeOptions&gt;()
    .Configure&lt;ConfigureMeOptions&gt;(builder.Configuration
        .GetSection("configureMe"))
    .Configure&lt;ConfigureMeOptions&gt;(NamedInstance, builder.Configuration
        .GetSection("configureMe"))
    .AddSingleton&lt;IConfigureOptions&lt;ConfigureMeOptions&gt;, ConfigureAllConfigureMeOptions&gt;()
    //.AddSingleton&lt;IConfigureNamedOptions&lt;ConfigureMeOptions&gt;, ConfigureAllConfigureMeOptions&gt;()
    .AddSingleton&lt;IConfigureOptions&lt;ConfigureMeOptions&gt;, ConfigureMoreConfigureMeOptions&gt;()
;
builder.Services.PostConfigure&lt;ConfigureMeOptions&gt;(
    NamedInstance,
    x =&gt; x.Lines = x.Lines.Append("Inline PostConfigure After")
);
// ...</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.603.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code registers two configuration delegates that target our named instance. </span><span class="koboSpan" id="kobo.603.2" xmlns="http://www.w3.org/1999/xhtml">They both run in the post-configuration phase. </span><span class="koboSpan" id="kobo.603.3" xmlns="http://www.w3.org/1999/xhtml">So running the app and accessing the endpoint shows the order in which all lines are added:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.604.1" xmlns="http://www.w3.org/1999/xhtml">{
  "defaultInstance": {
    "title": "Configure Me!",
    "lines": [
      "appsettings.json",
      "ConfigureAll:Configure name: ",
      "ConfigureMore:Configure",
      "ConfigureAll:PostConfigure name: "
    ]
  },
  "namedInstance": {
    "title": "Configure Me!",
    "lines": [
      "appsettings.json",
      "ConfigureAll:Configure name: MyNamedInstance",
      "ConfigureAll:Configure Not Default: MyNamedInstance",
      "Inline PostConfigure Before",
      "ConfigureAll:PostConfigure name: MyNamedInstance",
      "Inline PostConfigure After"
    ]
  }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.605.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding JSON, we can see that the two highlighted lines are the ones we just added, loaded in order, and not applied to the default options.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.606.1" xmlns="http://www.w3.org/1999/xhtml">There is one more possibility, which comes from the validation API. </span><span class="koboSpan" id="kobo.606.2" xmlns="http://www.w3.org/1999/xhtml">This is most likely an unintended side effect, but it works nonetheless.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.607.1" xmlns="http://www.w3.org/1999/xhtml">The following code adds the </span><code><span class="koboSpan" id="kobo.608.1" xmlns="http://www.w3.org/1999/xhtml">"Inline Validate"</span></code><span class="koboSpan" id="kobo.609.1" xmlns="http://www.w3.org/1999/xhtml"> line after the post-configuration phase:</span></p>
</blockquote>
</blockquote>
<pre><code><span class="koboSpan" id="kobo.610.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.AddOptions&lt;ConfigureMeOptions&gt;().Validate(options =&gt;
{
    // Validate was not intended for this, but it works nonetheless...
    </span><span class="koboSpan" id="kobo.610.2" xmlns="http://www.w3.org/1999/xhtml">options.Lines = options.Lines.Append("Inline Validate");
    return true;
});</span></code></pre>
<blockquote>
<p><span class="koboSpan" id="kobo.611.1" xmlns="http://www.w3.org/1999/xhtml">On the separation of concerns aspect, we should stay away from this. </span><span class="koboSpan" id="kobo.611.2" xmlns="http://www.w3.org/1999/xhtml">However, knowing this may help you work around a post-configuration order issue one day.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.612.1" xmlns="http://www.w3.org/1999/xhtml">Now that we know the options interface types, their lifetimes, and many ways to configure their values, it is time to validate them and enforce a certain level of integrity in our programs.</span></p>
</section>
</section>
<section class="level2" data-number="10.6" id="project-optionsvalidation">
<h2 data-number="10.6"><span class="koboSpan" id="kobo.613.1" xmlns="http://www.w3.org/1999/xhtml">Project – OptionsValidation</span></h2>
<p><span class="koboSpan" id="kobo.614.1" xmlns="http://www.w3.org/1999/xhtml">Another feature that comes out of the box is options validation, which allows us to run validation code when a </span><code><span class="koboSpan" id="kobo.615.1" xmlns="http://www.w3.org/1999/xhtml">TOptions</span></code><span class="koboSpan" id="kobo.616.1" xmlns="http://www.w3.org/1999/xhtml"> object is created. </span><span class="koboSpan" id="kobo.616.2" xmlns="http://www.w3.org/1999/xhtml">The validation code is guaranteed to run the first time an option is created and does not account for subsequent options modifications. </span><span class="koboSpan" id="kobo.616.3" xmlns="http://www.w3.org/1999/xhtml">Depending on the lifetime of your options object, the validation may or may not run. </span><span class="koboSpan" id="kobo.616.4" xmlns="http://www.w3.org/1999/xhtml">For example:</span></p>
<table>
<tbody>
<tr class="odd">
<td><strong><span class="koboSpan" id="kobo.617.1" xmlns="http://www.w3.org/1999/xhtml">Interface</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.618.1" xmlns="http://www.w3.org/1999/xhtml">Lifetime</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.619.1" xmlns="http://www.w3.org/1999/xhtml">Validation</span></strong></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.620.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.621.1" xmlns="http://www.w3.org/1999/xhtml">Singleton</span></td>
<td><span class="koboSpan" id="kobo.622.1" xmlns="http://www.w3.org/1999/xhtml">Validate the options once.</span></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.623.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsFactory&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.624.1" xmlns="http://www.w3.org/1999/xhtml">Transient</span></td>
<td><span class="koboSpan" id="kobo.625.1" xmlns="http://www.w3.org/1999/xhtml">Validate the options every time the code calls the </span><code><span class="koboSpan" id="kobo.626.1" xmlns="http://www.w3.org/1999/xhtml">Create</span></code><span class="koboSpan" id="kobo.627.1" xmlns="http://www.w3.org/1999/xhtml"> method.</span></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.628.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.629.1" xmlns="http://www.w3.org/1999/xhtml">Scoped</span></td>
<td><span class="koboSpan" id="kobo.630.1" xmlns="http://www.w3.org/1999/xhtml">Validate the options once per HTTP request (per scope).</span></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.631.1" xmlns="http://www.w3.org/1999/xhtml">IOptions&lt;TOptions&gt;</span></code></td>
<td><span class="koboSpan" id="kobo.632.1" xmlns="http://www.w3.org/1999/xhtml">Singleton</span></td>
<td><span class="koboSpan" id="kobo.633.1" xmlns="http://www.w3.org/1999/xhtml">Validate the options once.</span></td>
</tr>
</tbody>
</table><span class="koboSpan" id="kobo.634.1" xmlns="http://www.w3.org/1999/xhtml">
Table 9.4: the effect of validation on options lifetime.
</span><blockquote>
<p><span class="koboSpan" id="kobo.635.1" xmlns="http://www.w3.org/1999/xhtml">I wrote three test cases in the </span><code><span class="koboSpan" id="kobo.636.1" xmlns="http://www.w3.org/1999/xhtml">ValidateLifetime.cs</span></code><span class="koboSpan" id="kobo.637.1" xmlns="http://www.w3.org/1999/xhtml"> file if you are interested to see this in action.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.638.1" xmlns="http://www.w3.org/1999/xhtml">We can create validation types to validate options classes. </span><span class="koboSpan" id="kobo.638.2" xmlns="http://www.w3.org/1999/xhtml">They must implement the </span><code><span class="koboSpan" id="kobo.639.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.640.1" xmlns="http://www.w3.org/1999/xhtml"> interface or use data annotations such as </span><code><span class="koboSpan" id="kobo.641.1" xmlns="http://www.w3.org/1999/xhtml">[Required]</span></code><span class="koboSpan" id="kobo.642.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.642.2" xmlns="http://www.w3.org/1999/xhtml">Implementing the interface works very similarly to the options configuration.First, let’s see how to force the validation when the program starts.</span></p>
<section class="level3" data-number="10.6.1" id="eager-validation">
<h3 data-number="10.6.1"><span class="koboSpan" id="kobo.643.1" xmlns="http://www.w3.org/1999/xhtml">Eager validation</span></h3>
<p><span class="koboSpan" id="kobo.644.1" xmlns="http://www.w3.org/1999/xhtml">Eager validation has been added to .NET 6 and allows catching incorrectly configured options at startup time in a fail-fast mindset.The </span><code><span class="koboSpan" id="kobo.645.1" xmlns="http://www.w3.org/1999/xhtml">Microsoft.Extensions.Hosting</span></code><span class="koboSpan" id="kobo.646.1" xmlns="http://www.w3.org/1999/xhtml"> assembly adds the </span><code><span class="koboSpan" id="kobo.647.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOnStart</span></code><span class="koboSpan" id="kobo.648.1" xmlns="http://www.w3.org/1999/xhtml"> extension method to the </span><code><span class="koboSpan" id="kobo.649.1" xmlns="http://www.w3.org/1999/xhtml">OptionsBuilder&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.650.1" xmlns="http://www.w3.org/1999/xhtml"> type.There are different ways of using this, including the following, which binds a configuration section to an options class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.651.1" xmlns="http://www.w3.org/1999/xhtml">services.AddOptions&lt;Options&gt;()
    .Configure(o =&gt; /* Omitted configuration code */)
    .ValidateOnStart()
;</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.652.1" xmlns="http://www.w3.org/1999/xhtml">The highlighted line is all we need to apply our validation rules during startup. </span><span class="koboSpan" id="kobo.652.2" xmlns="http://www.w3.org/1999/xhtml">I recommend using this as your new default so you know that options are misconfigured at startup time instead of later at runtime, limiting unexpected issues.Now that we know that, let’s look at how to configure options validation.</span></p>
</section>
<section class="level3" data-number="10.6.2" id="data-annotations">
<h3 data-number="10.6.2"><span class="koboSpan" id="kobo.653.1" xmlns="http://www.w3.org/1999/xhtml">Data annotations</span></h3>
<p><span class="koboSpan" id="kobo.654.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start by using </span><code><span class="koboSpan" id="kobo.655.1" xmlns="http://www.w3.org/1999/xhtml">System.ComponentModel.DataAnnotations</span></code><span class="koboSpan" id="kobo.656.1" xmlns="http://www.w3.org/1999/xhtml"> types to decorate our options with validation attributes. </span><span class="koboSpan" id="kobo.656.2" xmlns="http://www.w3.org/1999/xhtml">We activate this feature with the </span><code><span class="koboSpan" id="kobo.657.1" xmlns="http://www.w3.org/1999/xhtml">ValidateDataAnnotations</span></code><span class="koboSpan" id="kobo.658.1" xmlns="http://www.w3.org/1999/xhtml"> extension method. </span><span class="koboSpan" id="kobo.658.2" xmlns="http://www.w3.org/1999/xhtml">This also works with eager validation by chaining both methods.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.659.1" xmlns="http://www.w3.org/1999/xhtml">If you are unfamiliar with </span><code><span class="koboSpan" id="kobo.660.1" xmlns="http://www.w3.org/1999/xhtml">DataAnnotations</span></code><span class="koboSpan" id="kobo.661.1" xmlns="http://www.w3.org/1999/xhtml">, they are attributes used to validate EF Core and MVC model classes. </span><span class="koboSpan" id="kobo.661.2" xmlns="http://www.w3.org/1999/xhtml">Don’t worry, they are very explicit, so you should understand the code.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.662.1" xmlns="http://www.w3.org/1999/xhtml">To demonstrate this, let’s look at the skeleton of two small tests:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.663.1" xmlns="http://www.w3.org/1999/xhtml">using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Options;
using System.ComponentModel.DataAnnotations;
using Xunit;
namespace OptionsValidation;
public class ValidateOptionsWithDataAnnotations
{
    [Fact]
    public void Should_pass_validation() { /*omitted*/ }
    [Fact]
    public void Should_fail_validation() { /*omitted*/ }
    private class Options
    {
        [Required]
        public string? </span><span class="koboSpan" id="kobo.663.2" xmlns="http://www.w3.org/1999/xhtml">MyImportantProperty { get; set; }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.664.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code shows that the </span><code><span class="koboSpan" id="kobo.665.1" xmlns="http://www.w3.org/1999/xhtml">MyImportantProperty</span></code><span class="koboSpan" id="kobo.666.1" xmlns="http://www.w3.org/1999/xhtml"> property of the </span><code><span class="koboSpan" id="kobo.667.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.668.1" xmlns="http://www.w3.org/1999/xhtml"> class is required and cannot be </span><code><span class="koboSpan" id="kobo.669.1" xmlns="http://www.w3.org/1999/xhtml">null</span></code><span class="koboSpan" id="kobo.670.1" xmlns="http://www.w3.org/1999/xhtml"> (highlighted line). </span><span class="koboSpan" id="kobo.670.2" xmlns="http://www.w3.org/1999/xhtml">Next, we look at the test cases.The first test is expecting the validation to pass:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.671.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void Should_pass_validation()
{
    // Arrange
    var services = new ServiceCollection();
    services.AddOptions&lt;Options&gt;()
        .Configure(o =&gt; o.MyImportantProperty = "A value")
        .ValidateDataAnnotations()
        .ValidateOnStart() // eager validation 
    ;
    var serviceProvider = services.BuildServiceProvider();
    var options = serviceProvider
        .GetRequiredService&lt;IOptionsMonitor&lt;Options&gt;&gt;();
    // Act &amp; Assert
    Assert.Equal(
        "Some important value",
        options.CurrentValue.MyImportantProperty
    );
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.672.1" xmlns="http://www.w3.org/1999/xhtml">The test simulates the execution of a program where the IoC container creates the options class, and its consumer (the test) leverages it. </span><span class="koboSpan" id="kobo.672.2" xmlns="http://www.w3.org/1999/xhtml">The highlighted line sets the property to </span><code><span class="koboSpan" id="kobo.673.1" xmlns="http://www.w3.org/1999/xhtml">"A value"</span></code><span class="koboSpan" id="kobo.674.1" xmlns="http://www.w3.org/1999/xhtml">, making the validation pass. </span><span class="koboSpan" id="kobo.674.2" xmlns="http://www.w3.org/1999/xhtml">The code also enables eager validation (</span><code><span class="koboSpan" id="kobo.675.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOnStart</span></code><span class="koboSpan" id="kobo.676.1" xmlns="http://www.w3.org/1999/xhtml">) on top of the validation of data annotations (</span><code><span class="koboSpan" id="kobo.677.1" xmlns="http://www.w3.org/1999/xhtml">ValidateDataAnnotations</span></code><span class="koboSpan" id="kobo.678.1" xmlns="http://www.w3.org/1999/xhtml">).The second test is expecting the validation to fail:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.679.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void Should_fail_validation()
{
    // Arrange
    var services = new ServiceCollection();
    services.AddOptions&lt;Options&gt;()
        .ValidateDataAnnotations()
        .ValidateOnStart() // eager validation 
    ;
    var serviceProvider = services.BuildServiceProvider();
        // Act &amp; Assert
        var error = Assert.Throws&lt;OptionsValidationException&gt;(
            () =&gt; options.CurrentValue);
        Assert.Collection(error.Failures,
            f =&gt; Assert.Equal("DataAnnotation validation failed for 'Options' members: 'MyImportantProperty' with the error: 'The MyImportantProperty field is required.'.", f)
        );
    );
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.680.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, the </span><code><span class="koboSpan" id="kobo.681.1" xmlns="http://www.w3.org/1999/xhtml">MyImportantProperty</span></code><span class="koboSpan" id="kobo.682.1" xmlns="http://www.w3.org/1999/xhtml"> is never set (highlighted code), leading to the validation failing and throwing an </span><code><span class="koboSpan" id="kobo.683.1" xmlns="http://www.w3.org/1999/xhtml">OptionsValidationException</span></code><span class="koboSpan" id="kobo.684.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.684.2" xmlns="http://www.w3.org/1999/xhtml">The test simulates catching that exception.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.685.1" xmlns="http://www.w3.org/1999/xhtml">The eager validation does not work in the tests because it is not an ASP.NET Core program but xUnit test cases (Fascts).</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.686.1" xmlns="http://www.w3.org/1999/xhtml">That’s it—.NET does the job for us and validates our instance of the </span><code><span class="koboSpan" id="kobo.687.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.688.1" xmlns="http://www.w3.org/1999/xhtml"> class using the data annotation like you can do when using EF Core or MVC model.Next, we explore how to create validation classes to validate our options objects manually.</span></p>
</section>
<section class="level3" data-number="10.6.3" id="validation-types">
<h3 data-number="10.6.3"><span class="koboSpan" id="kobo.689.1" xmlns="http://www.w3.org/1999/xhtml">Validation types</span></h3>
<p><span class="koboSpan" id="kobo.690.1" xmlns="http://www.w3.org/1999/xhtml">To implement options validation types or options validators, we can create a class that implements one or more </span><code><span class="koboSpan" id="kobo.691.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.692.1" xmlns="http://www.w3.org/1999/xhtml"> interfaces. </span><span class="koboSpan" id="kobo.692.2" xmlns="http://www.w3.org/1999/xhtml">One type can validate multiple options, and multiple types can validate the same options, so the possible combinations should cover all use cases.Using a custom class is no harder than using data annotations. </span><span class="koboSpan" id="kobo.692.3" xmlns="http://www.w3.org/1999/xhtml">However, it allows us to remove the validation concerns from the options class and code more complex validation logic. </span><span class="koboSpan" id="kobo.692.4" xmlns="http://www.w3.org/1999/xhtml">You should pick the way that makes the most sense for your project.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.693.1" xmlns="http://www.w3.org/1999/xhtml">On top of personal preferences, say you use a third-party library with options. </span><span class="koboSpan" id="kobo.693.2" xmlns="http://www.w3.org/1999/xhtml">You load that library into your application and expect the configuration to be a certain way. </span><span class="koboSpan" id="kobo.693.3" xmlns="http://www.w3.org/1999/xhtml">You could create a class to validate that the options class provided by the library is configured appropriately for your application and even validate this at startup time.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.694.1" xmlns="http://www.w3.org/1999/xhtml">You can’t use data annotations for that because you don’t control the code. </span><span class="koboSpan" id="kobo.694.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, it is not a general validation that should apply to all consumers but specific validation for that one app.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.695.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start with the skeleton of the test class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.696.1" xmlns="http://www.w3.org/1999/xhtml">using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Options;
using Xunit;
namespace OptionsValidation;
public class ValidateOptionsWithTypes
{
    [Fact]
    public void Should_pass_validation() {}
    [Fact]
    public void Should_fail_validation() {}
    private class Options
    {
        public string? </span><span class="koboSpan" id="kobo.696.2" xmlns="http://www.w3.org/1999/xhtml">MyImportantProperty { get; set; }
    }
    private class OptionsValidator : IValidateOptions&lt;Options&gt;
    {
        public ValidateOptionsResult Validate(
            string name, Options options)
        {
            if (string.IsNullOrEmpty(options.MyImportantProperty))
            {
                return ValidateOptionsResult.Fail(
                    "'MyImportantProperty' is required.");
            }
            return ValidateOptionsResult.Success;
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.697.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we have the </span><code><span class="koboSpan" id="kobo.698.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.699.1" xmlns="http://www.w3.org/1999/xhtml"> class that is similar to the previous example but without the data annotation. </span><span class="koboSpan" id="kobo.699.2" xmlns="http://www.w3.org/1999/xhtml">The difference is that instead of using the </span><code><span class="koboSpan" id="kobo.700.1" xmlns="http://www.w3.org/1999/xhtml">[Required]</span></code><span class="koboSpan" id="kobo.701.1" xmlns="http://www.w3.org/1999/xhtml"> attribute, we created the </span><code><span class="koboSpan" id="kobo.702.1" xmlns="http://www.w3.org/1999/xhtml">OptionsValidator</span></code><span class="koboSpan" id="kobo.703.1" xmlns="http://www.w3.org/1999/xhtml"> class (highlighted) containing the validation logic.</span><code><span class="koboSpan" id="kobo.704.1" xmlns="http://www.w3.org/1999/xhtml">OptionsValidator</span></code><span class="koboSpan" id="kobo.705.1" xmlns="http://www.w3.org/1999/xhtml"> implements </span><code><span class="koboSpan" id="kobo.706.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;Options&gt;</span></code><span class="koboSpan" id="kobo.707.1" xmlns="http://www.w3.org/1999/xhtml">, which only contains a </span><code><span class="koboSpan" id="kobo.708.1" xmlns="http://www.w3.org/1999/xhtml">Validate</span></code><span class="koboSpan" id="kobo.709.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.709.2" xmlns="http://www.w3.org/1999/xhtml">This method allows named and default options to be validated. </span><span class="koboSpan" id="kobo.709.3" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.710.1" xmlns="http://www.w3.org/1999/xhtml">name</span></code><span class="koboSpan" id="kobo.711.1" xmlns="http://www.w3.org/1999/xhtml"> argument represents the options’ names. </span><span class="koboSpan" id="kobo.711.2" xmlns="http://www.w3.org/1999/xhtml">In our case, we implemented the required logic for all options. </span><span class="koboSpan" id="kobo.711.3" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.712.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResult</span></code><span class="koboSpan" id="kobo.713.1" xmlns="http://www.w3.org/1999/xhtml"> class exposes a few members to help us, such as the </span><code><span class="koboSpan" id="kobo.714.1" xmlns="http://www.w3.org/1999/xhtml">Success</span></code><span class="koboSpan" id="kobo.715.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.716.1" xmlns="http://www.w3.org/1999/xhtml">Skip</span></code><span class="koboSpan" id="kobo.717.1" xmlns="http://www.w3.org/1999/xhtml"> fields, and two </span><code><span class="koboSpan" id="kobo.718.1" xmlns="http://www.w3.org/1999/xhtml">Fail()</span></code><span class="koboSpan" id="kobo.719.1" xmlns="http://www.w3.org/1999/xhtml"> methods.</span><code><span class="koboSpan" id="kobo.720.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResult.Success</span></code><span class="koboSpan" id="kobo.721.1" xmlns="http://www.w3.org/1999/xhtml"> indicates success. </span><code><span class="koboSpan" id="kobo.722.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResult.Skip</span></code><span class="koboSpan" id="kobo.723.1" xmlns="http://www.w3.org/1999/xhtml"> indicates that the validator did not validate the options, most likely because it only validates certain named options but not the given one.The </span><code><span class="koboSpan" id="kobo.724.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResult.Fail(message)</span></code><span class="koboSpan" id="kobo.725.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.726.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResult.Fail(messages)</span></code><span class="koboSpan" id="kobo.727.1" xmlns="http://www.w3.org/1999/xhtml"> methods take a single message or a collection of messages as an argument.To make this work, we must make the validator available to the IoC container, as we did with the options configuration. </span><span class="koboSpan" id="kobo.727.2" xmlns="http://www.w3.org/1999/xhtml">We explore the two test cases next, which are very similar to the data annotation example.Here’s the first test case that passes the validation:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.728.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void Should_pass_validation()
{
    // Arrange
    var services = new ServiceCollection();
    services.AddSingleton&lt;IValidateOptions&lt;Options&gt;, OptionsValidator&gt;();
    services.AddOptions&lt;Options&gt;()
        .Configure(o =&gt; o.MyImportantProperty = "A value")
        .ValidateOnStart()
    ;
    var serviceProvider = services.BuildServiceProvider();
    // Act &amp; Assert
    var options = serviceProvider
        .GetRequiredService&lt;IOptionsMonitor&lt;Options&gt;&gt;();
    Assert.Equal(
        "A value",
        options.CurrentValue.MyImportantProperty
    );
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.729.1" xmlns="http://www.w3.org/1999/xhtml">The test case simulates an application that configures the </span><code><span class="koboSpan" id="kobo.730.1" xmlns="http://www.w3.org/1999/xhtml">MyImportantProperty</span></code><span class="koboSpan" id="kobo.731.1" xmlns="http://www.w3.org/1999/xhtml"> correctly, which passes validation. </span><span class="koboSpan" id="kobo.731.2" xmlns="http://www.w3.org/1999/xhtml">The highlighted line shows how to register the validator class. </span><span class="koboSpan" id="kobo.731.3" xmlns="http://www.w3.org/1999/xhtml">The rest is done by the framework when using the options class.Next, we explore a test that fails the validation:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.732.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void Should_fail_validation()
{
    // Arrange
    var services = new ServiceCollection();
    services.AddSingleton&lt;IValidateOptions&lt;Options&gt;, OptionsValidator&gt;();
    services.AddOptions&lt;Options&gt;().ValidateOnStart();
    var serviceProvider = services.BuildServiceProvider();
    // Act &amp; Assert
    var options = serviceProvider
        .GetRequiredService&lt;IOptionsMonitor&lt;Options&gt;&gt;();
    var error = Assert.Throws&lt;OptionsValidationException&gt;(
        () =&gt; options.CurrentValue);
    Assert.Collection(error.Failures,
        f =&gt; Assert.Equal("'MyImportantProperty' is required.", f)
    );
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.733.1" xmlns="http://www.w3.org/1999/xhtml">The test simulates a program where the </span><code><span class="koboSpan" id="kobo.734.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.735.1" xmlns="http://www.w3.org/1999/xhtml"> class is not configured appropriately. </span><span class="koboSpan" id="kobo.735.2" xmlns="http://www.w3.org/1999/xhtml">When accessing the options object, the framework builds the class and validates it, throwing an </span><code><span class="koboSpan" id="kobo.736.1" xmlns="http://www.w3.org/1999/xhtml">OptionsValidationException</span></code><span class="koboSpan" id="kobo.737.1" xmlns="http://www.w3.org/1999/xhtml"> because of the validation rules (highlighted lines).Using types to validate options is handy when you don’t want to use data annotations, can’t use data annotations, or need to implement certain logic that is easier within a method than with attributes.Next, we glance at how to leverage options with FluentValidation.</span></p>
</section>
</section>
<section class="level2" data-number="10.7" id="project-optionsvalidationfluentvalidation">
<h2 data-number="10.7"><span class="koboSpan" id="kobo.738.1" xmlns="http://www.w3.org/1999/xhtml">Project – OptionsValidationFluentValidation</span></h2>
<p><span class="koboSpan" id="kobo.739.1" xmlns="http://www.w3.org/1999/xhtml">In this project, we validate options classes using FluentValidation. </span><span class="koboSpan" id="kobo.739.2" xmlns="http://www.w3.org/1999/xhtml">FluentValidation is a popular open-source library that provides a validation framework different from data annotations. </span><span class="koboSpan" id="kobo.739.3" xmlns="http://www.w3.org/1999/xhtml">We explore FluentValidation more in </span><em><span class="koboSpan" id="kobo.740.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 15</span></em><span class="koboSpan" id="kobo.741.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.742.1" xmlns="http://www.w3.org/1999/xhtml">Getting Started with Vertical Slice Architecture</span></em><span class="koboSpan" id="kobo.743.1" xmlns="http://www.w3.org/1999/xhtml">, but that should not hinder you from following this example.Here, I want to show you how to leverage a few patterns we’ve learned so far to implement this ourselves with only a few lines of code. </span><span class="koboSpan" id="kobo.743.2" xmlns="http://www.w3.org/1999/xhtml">In this micro-project, we leverage:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.744.1" xmlns="http://www.w3.org/1999/xhtml">Dependency injection</span></li>
<li><span class="koboSpan" id="kobo.745.1" xmlns="http://www.w3.org/1999/xhtml">The Strategy design pattern</span></li>
<li><span class="koboSpan" id="kobo.746.1" xmlns="http://www.w3.org/1999/xhtml">The Options pattern</span></li>
<li><span class="koboSpan" id="kobo.747.1" xmlns="http://www.w3.org/1999/xhtml">Options validation: validation types</span></li>
<li><span class="koboSpan" id="kobo.748.1" xmlns="http://www.w3.org/1999/xhtml">Options validation: eager validation</span></li>
</ul>
<p><span class="koboSpan" id="kobo.749.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start with the options class itself:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.750.1" xmlns="http://www.w3.org/1999/xhtml">public class MyOptions
{
    public string? </span><span class="koboSpan" id="kobo.750.2" xmlns="http://www.w3.org/1999/xhtml">Name { get; set; }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.751.1" xmlns="http://www.w3.org/1999/xhtml">The options class is very thin, containing only a nullable </span><code><span class="koboSpan" id="kobo.752.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.753.1" xmlns="http://www.w3.org/1999/xhtml"> property. </span><span class="koboSpan" id="kobo.753.2" xmlns="http://www.w3.org/1999/xhtml">Next, let’s look at the FluentValidation validator, which validates that the </span><code><span class="koboSpan" id="kobo.754.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.755.1" xmlns="http://www.w3.org/1999/xhtml"> property is not empty:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.756.1" xmlns="http://www.w3.org/1999/xhtml">public class MyOptionsValidator : AbstractValidator&lt;MyOptions&gt;
{
    public MyOptionsValidator()
    {
        RuleFor(x =&gt; x.Name).NotEmpty();
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.757.1" xmlns="http://www.w3.org/1999/xhtml">If you have never used FluentValidation before, the </span><code><span class="koboSpan" id="kobo.758.1" xmlns="http://www.w3.org/1999/xhtml">AbstractValidator&lt;T&gt;</span></code><span class="koboSpan" id="kobo.759.1" xmlns="http://www.w3.org/1999/xhtml"> class implements the </span><code><span class="koboSpan" id="kobo.760.1" xmlns="http://www.w3.org/1999/xhtml">IValidator&lt;T&gt;</span></code><span class="koboSpan" id="kobo.761.1" xmlns="http://www.w3.org/1999/xhtml"> interface and adds utility methods like </span><code><span class="koboSpan" id="kobo.762.1" xmlns="http://www.w3.org/1999/xhtml">RuleFor</span></code><span class="koboSpan" id="kobo.763.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.763.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.764.1" xmlns="http://www.w3.org/1999/xhtml">MyOptionsValidator</span></code><span class="koboSpan" id="kobo.765.1" xmlns="http://www.w3.org/1999/xhtml"> class contains the validation rules.To make ASP.NET Core validate </span><code><span class="koboSpan" id="kobo.766.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.767.1" xmlns="http://www.w3.org/1999/xhtml"> instances using FluentValidation, we implement an </span><code><span class="koboSpan" id="kobo.768.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.769.1" xmlns="http://www.w3.org/1999/xhtml"> interface as we did in the previous example, inject our validator in it, and then leverage it to ensure the validity of </span><code><span class="koboSpan" id="kobo.770.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.771.1" xmlns="http://www.w3.org/1999/xhtml"> objects. </span><span class="koboSpan" id="kobo.771.2" xmlns="http://www.w3.org/1999/xhtml">This implementation of the </span><code><span class="koboSpan" id="kobo.772.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions</span></code><span class="koboSpan" id="kobo.773.1" xmlns="http://www.w3.org/1999/xhtml"> interface creates a bridge between the FluentValidation features and the ASP.NET Core options validation.Here is a generic implementation of such a class that could be reused for any type of options:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.774.1" xmlns="http://www.w3.org/1999/xhtml">public class FluentValidateOptions&lt;TOptions&gt; : IValidateOptions&lt;TOptions&gt;
    where TOptions : class
{
    private readonly IValidator&lt;TOptions&gt; _validator;
    public FluentValidateOptions(IValidator&lt;TOptions&gt; validator)
    {
        _validator = validator;
    }
    public ValidateOptionsResult Validate(string name, TOptions options)
    {
        var validationResult = _validator.Validate(options);
        if (validationResult.IsValid)
        {
            return ValidateOptionsResult.Success;
        }
        var errorMessages = validationResult.Errors.Select(x =&gt; x.ErrorMessage);
        return ValidateOptionsResult.Fail(errorMessages);
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.775.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, the </span><code><span class="koboSpan" id="kobo.776.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidateOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.777.1" xmlns="http://www.w3.org/1999/xhtml"> class adapts the </span><code><span class="koboSpan" id="kobo.778.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.779.1" xmlns="http://www.w3.org/1999/xhtml"> interface to the </span><code><span class="koboSpan" id="kobo.780.1" xmlns="http://www.w3.org/1999/xhtml">IValidator&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.781.1" xmlns="http://www.w3.org/1999/xhtml"> interface by leveraging FluentValidation in the </span><code><span class="koboSpan" id="kobo.782.1" xmlns="http://www.w3.org/1999/xhtml">Validate</span></code><span class="koboSpan" id="kobo.783.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.783.2" xmlns="http://www.w3.org/1999/xhtml">In a nutshell, we use the output of one system and make it an input of another system.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.784.1" xmlns="http://www.w3.org/1999/xhtml">This type of adaptation is known as the Adapter design pattern. </span><span class="koboSpan" id="kobo.784.2" xmlns="http://www.w3.org/1999/xhtml">We explore the Adapter pattern in the next chapter.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.785.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have all the building blocks, let’s have a look at the composition root:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.786.1" xmlns="http://www.w3.org/1999/xhtml">using FluentValidation;
using Microsoft.Extensions.Options;
var builder = WebApplication.CreateBuilder(args);
builder.Services
    .AddSingleton&lt;IValidator&lt;MyOptions&gt;, MyOptionsValidator&gt;()
    .AddSingleton&lt;IValidateOptions&lt;MyOptions&gt;, FluentValidateOptions&lt;MyOptions&gt;&gt;()
;
builder.Services
    .AddOptions&lt;MyOptions&gt;()
    .ValidateOnStart()
;
var app = builder.Build();
app.MapGet("/", () =&gt; "Hello World!");
app.Run();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.787.1" xmlns="http://www.w3.org/1999/xhtml">The highlighted code is the key to this system:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.788.1" xmlns="http://www.w3.org/1999/xhtml">It registers the FluentValidation </span><code><span class="koboSpan" id="kobo.789.1" xmlns="http://www.w3.org/1999/xhtml">MyOptionsValidator</span></code><span class="koboSpan" id="kobo.790.1" xmlns="http://www.w3.org/1999/xhtml"> that contains the validation rules.</span></li>
<li><span class="koboSpan" id="kobo.791.1" xmlns="http://www.w3.org/1999/xhtml">It registers the generic </span><code><span class="koboSpan" id="kobo.792.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidateOptions</span></code><span class="koboSpan" id="kobo.793.1" xmlns="http://www.w3.org/1999/xhtml"> instance, so .NET uses it to validate </span><code><span class="koboSpan" id="kobo.794.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.795.1" xmlns="http://www.w3.org/1999/xhtml"> class.</span></li>
<li><span class="koboSpan" id="kobo.796.1" xmlns="http://www.w3.org/1999/xhtml">Under the hood, The </span><code><span class="koboSpan" id="kobo.797.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidateOptions</span></code><span class="koboSpan" id="kobo.798.1" xmlns="http://www.w3.org/1999/xhtml"> class uses the </span><code><span class="koboSpan" id="kobo.799.1" xmlns="http://www.w3.org/1999/xhtml">MyOptionsValidator</span></code><span class="koboSpan" id="kobo.800.1" xmlns="http://www.w3.org/1999/xhtml"> to validate the options internally.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.801.1" xmlns="http://www.w3.org/1999/xhtml">When running the program, the console yields the following error, as expected:</span></p>
<div class="C0-SHConPACKT">
<pre><code><span class="koboSpan" id="kobo.802.1" xmlns="http://www.w3.org/1999/xhtml">Hosting failed to start
Unhandled exception. </span><span class="koboSpan" id="kobo.802.2" xmlns="http://www.w3.org/1999/xhtml">Microsoft.Extensions.Options.OptionsValidationException: 'Name' must not be empty.
</span><span class="koboSpan" id="kobo.802.3" xmlns="http://www.w3.org/1999/xhtml">[...]</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.803.1" xmlns="http://www.w3.org/1999/xhtml">This may look like a lot of trouble for a simple required field; however, the </span><code><span class="koboSpan" id="kobo.804.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidateOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.805.1" xmlns="http://www.w3.org/1999/xhtml"> is reusable. </span><span class="koboSpan" id="kobo.805.2" xmlns="http://www.w3.org/1999/xhtml">We could also scan one or more assemblies to register the validator with the IoC container automatically.Now that we’ve explored many ways to configure and validate options objects, it is time to look at a way to inject options classes directly, either by choice or to work around a library capability issue.</span></p>
</section>
<section class="level2" data-number="10.8" id="workaround-injecting-options-directly">
<h2 data-number="10.8"><span class="koboSpan" id="kobo.806.1" xmlns="http://www.w3.org/1999/xhtml">Workaround – Injecting options directly</span></h2>
<p><span class="koboSpan" id="kobo.807.1" xmlns="http://www.w3.org/1999/xhtml">The only negative point about the .NET Options pattern is that we must tie our code to the framework’s interfaces. </span><span class="koboSpan" id="kobo.807.2" xmlns="http://www.w3.org/1999/xhtml">We must inject an interface like </span><code><span class="koboSpan" id="kobo.808.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor&lt;Options&gt;</span></code><span class="koboSpan" id="kobo.809.1" xmlns="http://www.w3.org/1999/xhtml"> instead of the </span><code><span class="koboSpan" id="kobo.810.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.811.1" xmlns="http://www.w3.org/1999/xhtml"> class itself. </span><span class="koboSpan" id="kobo.811.2" xmlns="http://www.w3.org/1999/xhtml">By letting the consumers choose the interface, we let them control the lifetime of the options, which breaks the inversion of control, dependency inversion, and open/closed principles. </span><span class="koboSpan" id="kobo.811.3" xmlns="http://www.w3.org/1999/xhtml">We should move that responsibility out of the consumer up to the composition root.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.812.1" xmlns="http://www.w3.org/1999/xhtml">As we explored at the beginning of this chapter, the </span><code><span class="koboSpan" id="kobo.813.1" xmlns="http://www.w3.org/1999/xhtml">IOptions</span></code><span class="koboSpan" id="kobo.814.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.815.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsFactory</span></code><span class="koboSpan" id="kobo.816.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.817.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor</span></code><span class="koboSpan" id="kobo.818.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.819.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot</span></code><span class="koboSpan" id="kobo.820.1" xmlns="http://www.w3.org/1999/xhtml"> interfaces define the options object’s lifetime.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.821.1" xmlns="http://www.w3.org/1999/xhtml">In most cases, I prefer to inject </span><code><span class="koboSpan" id="kobo.822.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.823.1" xmlns="http://www.w3.org/1999/xhtml"> directly, controlling its lifetime from the composition root, instead of letting the class itself control its dependencies. </span><span class="koboSpan" id="kobo.823.2" xmlns="http://www.w3.org/1999/xhtml">I’m a little </span><em><span class="koboSpan" id="kobo.824.1" xmlns="http://www.w3.org/1999/xhtml">anti-control-freak</span></em><span class="koboSpan" id="kobo.825.1" xmlns="http://www.w3.org/1999/xhtml">, I know. </span><span class="koboSpan" id="kobo.825.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, writing tests using the </span><code><span class="koboSpan" id="kobo.826.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.827.1" xmlns="http://www.w3.org/1999/xhtml"> class directly over mocking an interface like </span><code><span class="koboSpan" id="kobo.828.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot</span></code><span class="koboSpan" id="kobo.829.1" xmlns="http://www.w3.org/1999/xhtml"> is easier.It just so happens that we can circumvent this easily with the following two parts trick:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.830.1" xmlns="http://www.w3.org/1999/xhtml">Set up the options class normally, as explored in this chapter.</span></li>
<li><span class="koboSpan" id="kobo.831.1" xmlns="http://www.w3.org/1999/xhtml">Create a dependency binding that instructs the container to inject the options class directly using the Options pattern.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.832.1" xmlns="http://www.w3.org/1999/xhtml">The xUnit test of the </span><code><span class="koboSpan" id="kobo.833.1" xmlns="http://www.w3.org/1999/xhtml">ByPassingInterfaces</span></code><span class="koboSpan" id="kobo.834.1" xmlns="http://www.w3.org/1999/xhtml"> class from the </span><code><span class="koboSpan" id="kobo.835.1" xmlns="http://www.w3.org/1999/xhtml">OptionsValidation</span></code><span class="koboSpan" id="kobo.836.1" xmlns="http://www.w3.org/1999/xhtml"> project demonstrates this. </span><span class="koboSpan" id="kobo.836.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the skeleton of that test class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.837.1" xmlns="http://www.w3.org/1999/xhtml">using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Options;
using Xunit;
namespace OptionsValidation;
public class ByPassingInterfaces
{
    [Fact]
    public void Should_support_any_scope() { /*...*/ }
    private class Options
    {
        public string? </span><span class="koboSpan" id="kobo.837.2" xmlns="http://www.w3.org/1999/xhtml">Name { get; set; }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.838.1" xmlns="http://www.w3.org/1999/xhtml">The preceding </span><code><span class="koboSpan" id="kobo.839.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.840.1" xmlns="http://www.w3.org/1999/xhtml"> class has only a </span><code><span class="koboSpan" id="kobo.841.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.842.1" xmlns="http://www.w3.org/1999/xhtml"> property. </span><span class="koboSpan" id="kobo.842.2" xmlns="http://www.w3.org/1999/xhtml">We are using it next to explore the workaround in the test case:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.843.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void Should_support_any_scope()
{
    // Arrange
    var services = new ServiceCollection();
    services.AddOptions&lt;Options&gt;()
        .Configure(o =&gt; o.Name = "John Doe");
    services.AddScoped(serviceProvider =&gt; {
        var snapshot = serviceProvider
            .GetRequiredService&lt;IOptionsSnapshot&lt;Options&gt;&gt;();
        return snapshot.Value;
    });
    var serviceProvider = services.BuildServiceProvider();
    // Act &amp; Assert
    using var scope1 = serviceProvider.CreateScope();
    var options1 = scope1.ServiceProvider.GetService&lt;Options&gt;();
    var options2 = scope1.ServiceProvider.GetService&lt;Options&gt;();
    Assert.Same(options1, options2);
    using var scope2 = serviceProvider.CreateScope();
    var options3 = scope2.ServiceProvider.GetService&lt;Options&gt;();
    Assert.NotSame(options2, options3);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.844.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code block, we registered the </span><code><span class="koboSpan" id="kobo.845.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.846.1" xmlns="http://www.w3.org/1999/xhtml"> class using a factory method. </span><span class="koboSpan" id="kobo.846.2" xmlns="http://www.w3.org/1999/xhtml">That way, we can inject the </span><code><span class="koboSpan" id="kobo.847.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.848.1" xmlns="http://www.w3.org/1999/xhtml"> class directly (with a scoped lifetime). </span><span class="koboSpan" id="kobo.848.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, the delegate now controls the </span><code><span class="koboSpan" id="kobo.849.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.850.1" xmlns="http://www.w3.org/1999/xhtml"> class's creation and lifetime (highlighted code).And voilà, this workaround allows us to inject </span><code><span class="koboSpan" id="kobo.851.1" xmlns="http://www.w3.org/1999/xhtml">Options</span></code><span class="koboSpan" id="kobo.852.1" xmlns="http://www.w3.org/1999/xhtml"> directly into our system without tying our classes with any .NET-specific options interface.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.853.1" xmlns="http://www.w3.org/1999/xhtml">Consuming options through the </span><code><span class="koboSpan" id="kobo.854.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.855.1" xmlns="http://www.w3.org/1999/xhtml"> interface results in a </span><em><span class="koboSpan" id="kobo.856.1" xmlns="http://www.w3.org/1999/xhtml">scoped</span></em><span class="koboSpan" id="kobo.857.1" xmlns="http://www.w3.org/1999/xhtml"> lifetime.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.858.1" xmlns="http://www.w3.org/1999/xhtml">The </span><em><span class="koboSpan" id="kobo.859.1" xmlns="http://www.w3.org/1999/xhtml">Act &amp; Assert</span></em><span class="koboSpan" id="kobo.860.1" xmlns="http://www.w3.org/1999/xhtml"> section of the test validates the correctness of the setup by creating two scopes and ensuring that each scope returns a different instance while returning the same instance within the scope. </span><span class="koboSpan" id="kobo.860.2" xmlns="http://www.w3.org/1999/xhtml">For example, both </span><code><span class="koboSpan" id="kobo.861.1" xmlns="http://www.w3.org/1999/xhtml">options1</span></code><span class="koboSpan" id="kobo.862.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.863.1" xmlns="http://www.w3.org/1999/xhtml">options2</span></code><span class="koboSpan" id="kobo.864.1" xmlns="http://www.w3.org/1999/xhtml"> come from </span><code><span class="koboSpan" id="kobo.865.1" xmlns="http://www.w3.org/1999/xhtml">scope1</span></code><span class="koboSpan" id="kobo.866.1" xmlns="http://www.w3.org/1999/xhtml">, so they should be the same. </span><span class="koboSpan" id="kobo.866.2" xmlns="http://www.w3.org/1999/xhtml">On the other hand, </span><code><span class="koboSpan" id="kobo.867.1" xmlns="http://www.w3.org/1999/xhtml">options3</span></code><span class="koboSpan" id="kobo.868.1" xmlns="http://www.w3.org/1999/xhtml"> comes from </span><code><span class="koboSpan" id="kobo.869.1" xmlns="http://www.w3.org/1999/xhtml">scope2</span></code><span class="koboSpan" id="kobo.870.1" xmlns="http://www.w3.org/1999/xhtml">, so it should be different than </span><code><span class="koboSpan" id="kobo.871.1" xmlns="http://www.w3.org/1999/xhtml">options1</span></code><span class="koboSpan" id="kobo.872.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.873.1" xmlns="http://www.w3.org/1999/xhtml">options2</span></code><span class="koboSpan" id="kobo.874.1" xmlns="http://www.w3.org/1999/xhtml">.This workaround also applies to existing systems that could benefit from the Options pattern without updating its code—assuming the system is dependency injection-ready. </span><span class="koboSpan" id="kobo.874.2" xmlns="http://www.w3.org/1999/xhtml">We can also use this trick to compile an assembly that does not depend on </span><code><span class="koboSpan" id="kobo.875.1" xmlns="http://www.w3.org/1999/xhtml">Microsoft.Extensions.Options</span></code><span class="koboSpan" id="kobo.876.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.876.2" xmlns="http://www.w3.org/1999/xhtml">By using this trick, we can set the lifetime of the options from the composition root, which is a more classic dependency injection-enabled flow. </span><span class="koboSpan" id="kobo.876.3" xmlns="http://www.w3.org/1999/xhtml">To change the lifetime, use a different interface, like </span><code><span class="koboSpan" id="kobo.877.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor</span></code><span class="koboSpan" id="kobo.878.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.879.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsFactory</span></code><span class="koboSpan" id="kobo.880.1" xmlns="http://www.w3.org/1999/xhtml">.Next, we explore a way to organize all this code.</span></p>
</section>
<section class="level2" data-number="10.9" id="project-centralizing-the-configuration">
<h2 data-number="10.9"><span class="koboSpan" id="kobo.881.1" xmlns="http://www.w3.org/1999/xhtml">Project – Centralizing the configuration</span></h2>
<p><span class="koboSpan" id="kobo.882.1" xmlns="http://www.w3.org/1999/xhtml">Creating classes and classes is very object-oriented and follows the single-responsibility principle, among others. </span><span class="koboSpan" id="kobo.882.2" xmlns="http://www.w3.org/1999/xhtml">However, dividing responsibilities into programming concerns is not always what leads to the easiest code to understand because it creates a lot of classes and files, often spread across multiple layers and more.An alternative is to regroup the initialization and validation with the options class itself, shifting the multiple responsibilities to a single one: an end-to-end options class.In this example, we explore </span><code><span class="koboSpan" id="kobo.883.1" xmlns="http://www.w3.org/1999/xhtml">ProxyOptions</span></code><span class="koboSpan" id="kobo.884.1" xmlns="http://www.w3.org/1999/xhtml"> class, which carries the name of the service and the time the proxy service should cache items in seconds. </span><span class="koboSpan" id="kobo.884.2" xmlns="http://www.w3.org/1999/xhtml">We want to set a default value for the </span><code><span class="koboSpan" id="kobo.885.1" xmlns="http://www.w3.org/1999/xhtml">CacheTimeInSeconds</span></code><span class="koboSpan" id="kobo.886.1" xmlns="http://www.w3.org/1999/xhtml"> property and validate that the </span><code><span class="koboSpan" id="kobo.887.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.888.1" xmlns="http://www.w3.org/1999/xhtml"> property is not empty.On the other hand, we don’t want the consumer of that class to have access to any other methods, like </span><code><span class="koboSpan" id="kobo.889.1" xmlns="http://www.w3.org/1999/xhtml">Configure</span></code><span class="koboSpan" id="kobo.890.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.891.1" xmlns="http://www.w3.org/1999/xhtml">Validate</span></code><span class="koboSpan" id="kobo.892.1" xmlns="http://www.w3.org/1999/xhtml">.To achieve this, we can implement the interfaces explicitly, hiding them from the </span><code><span class="koboSpan" id="kobo.893.1" xmlns="http://www.w3.org/1999/xhtml">ProxyOptions</span></code><span class="koboSpan" id="kobo.894.1" xmlns="http://www.w3.org/1999/xhtml"> but showing them to the consumers of the interfaces. </span><span class="koboSpan" id="kobo.894.2" xmlns="http://www.w3.org/1999/xhtml">For example, binding the </span><code><span class="koboSpan" id="kobo.895.1" xmlns="http://www.w3.org/1999/xhtml">ProxyOptions</span></code><span class="koboSpan" id="kobo.896.1" xmlns="http://www.w3.org/1999/xhtml"> class to the </span><code><span class="koboSpan" id="kobo.897.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;ProxyOptions&gt;</span></code><span class="koboSpan" id="kobo.898.1" xmlns="http://www.w3.org/1999/xhtml"> interface gives the consumer access to the </span><code><span class="koboSpan" id="kobo.899.1" xmlns="http://www.w3.org/1999/xhtml">Validate</span></code><span class="koboSpan" id="kobo.900.1" xmlns="http://www.w3.org/1999/xhtml"> method through the </span><code><span class="koboSpan" id="kobo.901.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;ProxyOptions&gt;</span></code><span class="koboSpan" id="kobo.902.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.902.2" xmlns="http://www.w3.org/1999/xhtml">Explaining this should be simpler in code; here’s the class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.903.1" xmlns="http://www.w3.org/1999/xhtml">using Microsoft.Extensions.Options;
namespace CentralizingConfiguration;
public class ProxyOptions : IConfigureOptions&lt;ProxyOptions&gt;, IValidateOptions&lt;ProxyOptions&gt;
{
    public static readonly int DefaultCacheTimeInSeconds = 60;
    public string? </span><span class="koboSpan" id="kobo.903.2" xmlns="http://www.w3.org/1999/xhtml">Name { get; set; }
    public int CacheTimeInSeconds { get; set; }
    void IConfigureOptions&lt;ProxyOptions&gt;.Configure(
        ProxyOptions options)
    {
        options.CacheTimeInSeconds = DefaultCacheTimeInSeconds;
    }
    ValidateOptionsResult IValidateOptions&lt;ProxyOptions&gt;.Validate(
        string? </span><span class="koboSpan" id="kobo.903.3" xmlns="http://www.w3.org/1999/xhtml">name, ProxyOptions options)
    {
        if (string.IsNullOrWhiteSpace(options.Name))
        {
            return ValidateOptionsResult.Fail(
                "The 'Name' property is required.");
        }
        return ValidateOptionsResult.Success;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.904.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code implements both </span><code><span class="koboSpan" id="kobo.905.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureOptions&lt;ProxyOptions&gt;</span></code><span class="koboSpan" id="kobo.906.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.907.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;ProxyOptions&gt;</span></code><span class="koboSpan" id="kobo.908.1" xmlns="http://www.w3.org/1999/xhtml"> interfaces explicitly (highlighted) by omitting the visibility modifier and prefixing the name of the method with the name of the interface, like the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.909.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResult IValidateOptions&lt;ProxyOptions&gt;.Validate(...)</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.910.1" xmlns="http://www.w3.org/1999/xhtml">Now, to leverage it, we must register it with the IoC container like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.911.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services
    .AddSingleton&lt;IConfigureOptions&lt;ProxyOptions&gt;, ProxyOptions&gt;()
    .AddSingleton&lt;IValidateOptions&lt;ProxyOptions&gt;, ProxyOptions&gt;()
    .AddSingleton(sp =&gt; sp
        .GetRequiredService&lt;IOptions&lt;ProxyOptions&gt;&gt;()
        .Value
    )
    .Configure&lt;ProxyOptions&gt;(options 
        =&gt; options.Name = "High-speed proxy")
    .AddOptions&lt;ProxyOptions&gt;()
    .ValidateOnStart()
;</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.912.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we combined many notions we explored, like:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.913.1" xmlns="http://www.w3.org/1999/xhtml">Registering the options class</span></li>
<li><span class="koboSpan" id="kobo.914.1" xmlns="http://www.w3.org/1999/xhtml">Using the workaround to access the </span><code><span class="koboSpan" id="kobo.915.1" xmlns="http://www.w3.org/1999/xhtml">ProxyOptions</span></code><span class="koboSpan" id="kobo.916.1" xmlns="http://www.w3.org/1999/xhtml"> class directly</span></li>
<li><span class="koboSpan" id="kobo.917.1" xmlns="http://www.w3.org/1999/xhtml">Configuring the options inline and through a configurator class</span></li>
<li><span class="koboSpan" id="kobo.918.1" xmlns="http://www.w3.org/1999/xhtml">Leverage a validation class</span></li>
<li><span class="koboSpan" id="kobo.919.1" xmlns="http://www.w3.org/1999/xhtml">Enforcing the validation by eager loading our options during the startup.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.920.1" xmlns="http://www.w3.org/1999/xhtml">If you comment out the highlighted line, the application will throw an exception on startup.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.921.1" xmlns="http://www.w3.org/1999/xhtml">The only endpoint defined in the application is the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.922.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet("/", (ProxyOptions options) =&gt; options);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.923.1" xmlns="http://www.w3.org/1999/xhtml">When we run the application, we get the following output:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.924.1" xmlns="http://www.w3.org/1999/xhtml">{
  "name": "High-speed proxy",
  "cacheTimeInSeconds": 60
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.925.1" xmlns="http://www.w3.org/1999/xhtml">As expected, the value of the </span><code><span class="koboSpan" id="kobo.926.1" xmlns="http://www.w3.org/1999/xhtml">cacheTimeInSeconds</span></code><span class="koboSpan" id="kobo.927.1" xmlns="http://www.w3.org/1999/xhtml"> property equals the value of the </span><code><span class="koboSpan" id="kobo.928.1" xmlns="http://www.w3.org/1999/xhtml">DefaultCacheTimeInSeconds</span></code><span class="koboSpan" id="kobo.929.1" xmlns="http://www.w3.org/1999/xhtml"> field, and the value of the </span><code><span class="koboSpan" id="kobo.930.1" xmlns="http://www.w3.org/1999/xhtml">name</span></code><span class="koboSpan" id="kobo.931.1" xmlns="http://www.w3.org/1999/xhtml"> property to what we configured in the </span><code><span class="koboSpan" id="kobo.932.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.933.1" xmlns="http://www.w3.org/1999/xhtml"> file.When using the IntelliSense feature inside your favorite IDE, I’m using Visual Studio 2022 here, we can see only the properties, no method:</span></p>
<figure>
<span class="koboSpan" id="kobo.934.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 9.1: VS IntelliSense not showing explicitly implemented interfaces members." src="../media/file45.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.935.1" xmlns="http://www.w3.org/1999/xhtml">Figure 9.1: VS IntelliSense not showing explicitly implemented interfaces members.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.936.1" xmlns="http://www.w3.org/1999/xhtml">That’s it; we are done with this organizational technique.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.937.1" xmlns="http://www.w3.org/1999/xhtml">To keep the composition cleaner, we could encapsulate the bindings in an extension method, and, even better, make that extension method register the whole proxy feature. </span><span class="koboSpan" id="kobo.937.2" xmlns="http://www.w3.org/1999/xhtml">For example, </span><code><span class="koboSpan" id="kobo.938.1" xmlns="http://www.w3.org/1999/xhtml">services.AddProxyService()</span></code><span class="koboSpan" id="kobo.939.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.940.1" xmlns="http://www.w3.org/1999/xhtml">I’ll let you practice this one on your own as we already explored this.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.941.1" xmlns="http://www.w3.org/1999/xhtml">Next, we explore code generators!</span></p>
</section>
<section class="level2" data-number="10.10" id="using-the-configuration-binding-source-generator">
<h2 data-number="10.10"><span class="koboSpan" id="kobo.942.1" xmlns="http://www.w3.org/1999/xhtml">Using the configuration-binding source generator</span></h2>
<p><span class="koboSpan" id="kobo.943.1" xmlns="http://www.w3.org/1999/xhtml">.NET 8 introduces a </span><strong><span class="koboSpan" id="kobo.944.1" xmlns="http://www.w3.org/1999/xhtml">configuration-binding source generator</span></strong><span class="koboSpan" id="kobo.945.1" xmlns="http://www.w3.org/1999/xhtml"> that provides an alternative to the default reflection-based implementation. </span><span class="koboSpan" id="kobo.945.2" xmlns="http://www.w3.org/1999/xhtml">In simple terms, the name of the options class properties and the settings keys are now hard-coded, accelerating the configuration retrieval.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.946.1" xmlns="http://www.w3.org/1999/xhtml">Beware, the settings keys are case-sensitive and map one-on-one with the C# class property name, unlike the non-generated code.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.947.1" xmlns="http://www.w3.org/1999/xhtml">Web applications using Native AOT deployment (ahead-of-time compilation to native code) or trimming self-contained deployments to ship only the bits in use now leverage this option by default.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.948.1" xmlns="http://www.w3.org/1999/xhtml">The native AOT deployment model compiles the code to a single runtime environment like Windows x64. </span><span class="koboSpan" id="kobo.948.2" xmlns="http://www.w3.org/1999/xhtml">It does not need the just-in-time (JIT) compiler since the code is already compiled to the native version of the targetted environment. </span><span class="koboSpan" id="kobo.948.3" xmlns="http://www.w3.org/1999/xhtml">AOT deployments are self-contained and do not need the .NET runtime to work.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.949.1" xmlns="http://www.w3.org/1999/xhtml">We can use the </span><code><span class="koboSpan" id="kobo.950.1" xmlns="http://www.w3.org/1999/xhtml">EnableConfigurationBindingGenerator</span></code><span class="koboSpan" id="kobo.951.1" xmlns="http://www.w3.org/1999/xhtml"> property in your </span><code><span class="koboSpan" id="kobo.952.1" xmlns="http://www.w3.org/1999/xhtml">csproj</span></code><span class="koboSpan" id="kobo.953.1" xmlns="http://www.w3.org/1999/xhtml"> file to manually activate or deactivate the generator:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.954.1" xmlns="http://www.w3.org/1999/xhtml">&lt;PropertyGroup&gt;
  &lt;EnableConfigurationBindingGenerator&gt;true&lt;/EnableConfigurationBindingGenerator&gt;
&lt;/PropertyGroup&gt;</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.955.1" xmlns="http://www.w3.org/1999/xhtml">Now that the generator is enabled, let’ see how this works. </span><span class="koboSpan" id="kobo.955.2" xmlns="http://www.w3.org/1999/xhtml">The generator looks for a few options, including the Configure and Bind methods. </span><span class="koboSpan" id="kobo.955.3" xmlns="http://www.w3.org/1999/xhtml">It then generates the binding code.</span></p>
<section class="level3" data-number="10.10.1" id="project-configurationgenerators-part-1">
<h3 data-number="10.10.1"><span class="koboSpan" id="kobo.956.1" xmlns="http://www.w3.org/1999/xhtml">Project – ConfigurationGenerators: Part 1</span></h3>
<p><span class="koboSpan" id="kobo.957.1" xmlns="http://www.w3.org/1999/xhtml">In this first part of the project, we create an options class and register it with the IoC container to consume it through an API endpoint.We use the following options class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.958.1" xmlns="http://www.w3.org/1999/xhtml">namespace ConfigurationGenerators;
public class MyOptions
{
    public string? </span><span class="koboSpan" id="kobo.958.2" xmlns="http://www.w3.org/1999/xhtml">Name { get; set; }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.959.1" xmlns="http://www.w3.org/1999/xhtml">In the </span><code><span class="koboSpan" id="kobo.960.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.961.1" xmlns="http://www.w3.org/1999/xhtml"> file, we can use the source generator like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.962.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services
    .AddOptions&lt;MyOptions&gt;()
    .BindConfiguration("MyOptions")
;</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.963.1" xmlns="http://www.w3.org/1999/xhtml">As you may have noticed, the preceding code is the same as we used before and does what you expect it to do, but the new source generator generates the code under the hood—no functional or usage changes.Let’s explore another source generator next.</span></p>
</section>
</section>
<section class="level2" data-number="10.11" id="using-the-options-validation-source-generator">
<h2 data-number="10.11"><span class="koboSpan" id="kobo.964.1" xmlns="http://www.w3.org/1999/xhtml">Using the options validation source generator</span></h2>
<p><span class="koboSpan" id="kobo.965.1" xmlns="http://www.w3.org/1999/xhtml">.NET 8 introduces the </span><strong><span class="koboSpan" id="kobo.966.1" xmlns="http://www.w3.org/1999/xhtml">options validation source generator</span></strong><span class="koboSpan" id="kobo.967.1" xmlns="http://www.w3.org/1999/xhtml">, which generates the validation code based on data annotations. </span><span class="koboSpan" id="kobo.967.2" xmlns="http://www.w3.org/1999/xhtml">The idea is similar to the configuration-binding source generator but for the validation code.To leverage the validation generator, we must add a reference on the </span><code><span class="koboSpan" id="kobo.968.1" xmlns="http://www.w3.org/1999/xhtml">Microsoft.Extensions.Options.DataAnnotations</span></code><span class="koboSpan" id="kobo.969.1" xmlns="http://www.w3.org/1999/xhtml"> package.Afterward, we must:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.970.1" xmlns="http://www.w3.org/1999/xhtml">Create an empty validator class.</span></li>
<li><span class="koboSpan" id="kobo.971.1" xmlns="http://www.w3.org/1999/xhtml">Ensure the class is </span><code><span class="koboSpan" id="kobo.972.1" xmlns="http://www.w3.org/1999/xhtml">partial</span></code><span class="koboSpan" id="kobo.973.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><span class="koboSpan" id="kobo.974.1" xmlns="http://www.w3.org/1999/xhtml">Implement the </span><code><span class="koboSpan" id="kobo.975.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.976.1" xmlns="http://www.w3.org/1999/xhtml"> interface (but not the methods).</span></li>
<li><span class="koboSpan" id="kobo.977.1" xmlns="http://www.w3.org/1999/xhtml">Decorate the validator class with the </span><code><span class="koboSpan" id="kobo.978.1" xmlns="http://www.w3.org/1999/xhtml">[OptionsValidator]</span></code><span class="koboSpan" id="kobo.979.1" xmlns="http://www.w3.org/1999/xhtml"> attribute.</span></li>
<li><span class="koboSpan" id="kobo.980.1" xmlns="http://www.w3.org/1999/xhtml">Register the validator class with the container.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.981.1" xmlns="http://www.w3.org/1999/xhtml">This procedure sounds complicated but is way simpler in code; let's look at that now.</span></p>
<section class="level3" data-number="10.11.1" id="project-configurationgenerators-part-2">
<h3 data-number="10.11.1"><span class="koboSpan" id="kobo.982.1" xmlns="http://www.w3.org/1999/xhtml">Project – ConfigurationGenerators: Part 2</span></h3>
<p><span class="koboSpan" id="kobo.983.1" xmlns="http://www.w3.org/1999/xhtml">In this second part of the project, we continue to build on the previous pieces and add validation to our </span><code><span class="koboSpan" id="kobo.984.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.985.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.985.2" xmlns="http://www.w3.org/1999/xhtml">Of course, we also want to test the new source generator.Here's the updated </span><code><span class="koboSpan" id="kobo.986.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.987.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.988.1" xmlns="http://www.w3.org/1999/xhtml">using System.ComponentModel.DataAnnotations;
namespace ConfigurationGenerators;
public class MyOptions
{
    [Required]
    public string? </span><span class="koboSpan" id="kobo.988.2" xmlns="http://www.w3.org/1999/xhtml">Name { get; set; }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.989.1" xmlns="http://www.w3.org/1999/xhtml">The highlighted line represents the changes. </span><span class="koboSpan" id="kobo.989.2" xmlns="http://www.w3.org/1999/xhtml">We want to ensure the </span><code><span class="koboSpan" id="kobo.990.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.991.1" xmlns="http://www.w3.org/1999/xhtml"> property is not empty.Now that we updated our options class, let's create the following validator class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.992.1" xmlns="http://www.w3.org/1999/xhtml">using Microsoft.Extensions.Options;
namespace ConfigurationGenerators;
[OptionsValidator]
public partial class MyOptionsValidator : IValidateOptions&lt;MyOptions&gt;
{
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.993.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code is an empty shell that prepares the class for the code generator. </span><span class="koboSpan" id="kobo.993.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.994.1" xmlns="http://www.w3.org/1999/xhtml">[OptionsValidator]</span></code><span class="koboSpan" id="kobo.995.1" xmlns="http://www.w3.org/1999/xhtml"> attribute represents the generator hook (a.k.a. </span><span class="koboSpan" id="kobo.995.2" xmlns="http://www.w3.org/1999/xhtml">that’s the flag the generator is looking for). </span><span class="koboSpan" id="kobo.995.3" xmlns="http://www.w3.org/1999/xhtml">And with this code, we are done with steps 1 to 4; simpler than English, right?Now, for the last step, we register our validator like normal:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.996.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.AddSingleton&lt;IValidateOptions&lt;MyOptions&gt;, MyOptionsValidator&gt;();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.997.1" xmlns="http://www.w3.org/1999/xhtml">To test this out, let's add a </span><code><span class="koboSpan" id="kobo.998.1" xmlns="http://www.w3.org/1999/xhtml">valid</span></code><span class="koboSpan" id="kobo.999.1" xmlns="http://www.w3.org/1999/xhtml"> named options instance bound to the following configuration section in the </span><code><span class="koboSpan" id="kobo.1000.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.1001.1" xmlns="http://www.w3.org/1999/xhtml"> file:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.1002.1" xmlns="http://www.w3.org/1999/xhtml">{
  "MyOptions": {
    "Name": "Options name"
  }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.1003.1" xmlns="http://www.w3.org/1999/xhtml">Here's how we bind it in the </span><code><span class="koboSpan" id="kobo.1004.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.1005.1" xmlns="http://www.w3.org/1999/xhtml"> file:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.1006.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services
    .AddOptions&lt;MyOptions&gt;("valid")
    .BindConfiguration("MyOptions")
    .ValidateOnStart()
;</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.1007.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code registers the </span><code><span class="koboSpan" id="kobo.1008.1" xmlns="http://www.w3.org/1999/xhtml">valid</span></code><span class="koboSpan" id="kobo.1009.1" xmlns="http://www.w3.org/1999/xhtml"> named options, binds it to the configuration section </span><code><span class="koboSpan" id="kobo.1010.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.1011.1" xmlns="http://www.w3.org/1999/xhtml">, and validates it when the application starts.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.1012.1" xmlns="http://www.w3.org/1999/xhtml">Other ways to register the named options also work. </span><span class="koboSpan" id="kobo.1012.2" xmlns="http://www.w3.org/1999/xhtml">I used this one for convenience purposes only.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.1013.1" xmlns="http://www.w3.org/1999/xhtml">If we were to inspect the content of the options at runtime, it would be what we expect; nothing is different from what we explored throughout the chapter:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.1014.1" xmlns="http://www.w3.org/1999/xhtml">{
  "name": "Options name"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.1015.1" xmlns="http://www.w3.org/1999/xhtml">At this point, the program should start.Next, to test this out, let's add another named options class, but an invalid one this time. </span><span class="koboSpan" id="kobo.1015.2" xmlns="http://www.w3.org/1999/xhtml">We won't change anything in the </span><code><span class="koboSpan" id="kobo.1016.1" xmlns="http://www.w3.org/1999/xhtml">appsettings.json</span></code><span class="koboSpan" id="kobo.1017.1" xmlns="http://www.w3.org/1999/xhtml"> file, and add the following registration code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.1018.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services
    .AddOptions&lt;MyOptions&gt;("invalid")
    .BindConfiguration("MissingSection")
    .ValidateOnStart() 
;</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.1019.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code binds a missing section to the </span><code><span class="koboSpan" id="kobo.1020.1" xmlns="http://www.w3.org/1999/xhtml">invalid</span></code><span class="koboSpan" id="kobo.1021.1" xmlns="http://www.w3.org/1999/xhtml"> named options, making the </span><code><span class="koboSpan" id="kobo.1022.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.1023.1" xmlns="http://www.w3.org/1999/xhtml"> property equal to </span><code><span class="koboSpan" id="kobo.1024.1" xmlns="http://www.w3.org/1999/xhtml">null</span></code><span class="koboSpan" id="kobo.1025.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1025.2" xmlns="http://www.w3.org/1999/xhtml">That object will not pass our validation because the </span><code><span class="koboSpan" id="kobo.1026.1" xmlns="http://www.w3.org/1999/xhtml">Name</span></code><span class="koboSpan" id="kobo.1027.1" xmlns="http://www.w3.org/1999/xhtml"> property is required.If we run the application now, we get the following message:</span></p>
<div class="C0-ConsolePACKT">
<pre><code><span class="koboSpan" id="kobo.1028.1" xmlns="http://www.w3.org/1999/xhtml">Hosting failed to start
Microsoft.Extensions.Options.OptionsValidationException: Name: The invalid.Name field is required.</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.1029.1" xmlns="http://www.w3.org/1999/xhtml">From that error, we know the validation works as expected. </span><span class="koboSpan" id="kobo.1029.2" xmlns="http://www.w3.org/1999/xhtml">It is not every day that we are happy when our application doesn’t start but this is one of those time.That's it for the code generation, it behaves the same, but the code under the hood is different, enabling technologies like AOT and trimming that do not support reflection-based mechanisms well. </span><span class="koboSpan" id="kobo.1029.3" xmlns="http://www.w3.org/1999/xhtml">Moreover, code generation should speed up the program execution because the behaviors are hard-coded instead of relying on a dynamic reflection-based approach.Next, let’s dig into another class introduced in .NET 8.</span></p>
</section>
</section>
<section class="level2" data-number="10.12" id="using-the-validateoptionsresultbuilder-class">
<h2 data-number="10.12"><span class="koboSpan" id="kobo.1030.1" xmlns="http://www.w3.org/1999/xhtml">Using the ValidateOptionsResultBuilder class</span></h2>
<p><span class="koboSpan" id="kobo.1031.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1032.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResultBuilder</span></code><span class="koboSpan" id="kobo.1033.1" xmlns="http://www.w3.org/1999/xhtml"> is a new type in .NET 8. </span><span class="koboSpan" id="kobo.1033.2" xmlns="http://www.w3.org/1999/xhtml">It allows to dynamically accumulate validation errors and create a </span><code><span class="koboSpan" id="kobo.1034.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResult</span></code><span class="koboSpan" id="kobo.1035.1" xmlns="http://www.w3.org/1999/xhtml"> object representing its current state.Its basic usage is straightforward, as we are about to see.</span></p>
<section class="level3" data-number="10.12.1" id="project---validateoptionsresultbuilder">
<h3 data-number="10.12.1"><span class="koboSpan" id="kobo.1036.1" xmlns="http://www.w3.org/1999/xhtml">Project - ValidateOptionsResultBuilder</span></h3>
<p><span class="koboSpan" id="kobo.1037.1" xmlns="http://www.w3.org/1999/xhtml">In this project, we are validating the </span><code><span class="koboSpan" id="kobo.1038.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.1039.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.1039.2" xmlns="http://www.w3.org/1999/xhtml">The type has multiple validation rules, and we want to ensure we are not stopping after the first rule fails validation so a consumer would know all the errors in one go. </span><span class="koboSpan" id="kobo.1039.3" xmlns="http://www.w3.org/1999/xhtml">To achieve this, we decided to use the </span><code><span class="koboSpan" id="kobo.1040.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResultBuilder</span></code><span class="koboSpan" id="kobo.1041.1" xmlns="http://www.w3.org/1999/xhtml"> class.Let's start with the options class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.1042.1" xmlns="http://www.w3.org/1999/xhtml">namespace ValidateOptionsResultBuilder;
public class MyOptions
{
    public string? </span><span class="koboSpan" id="kobo.1042.2" xmlns="http://www.w3.org/1999/xhtml">Prop1 { get; set; }
    public string? </span><span class="koboSpan" id="kobo.1042.3" xmlns="http://www.w3.org/1999/xhtml">Prop2 { get; set; }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.1043.1" xmlns="http://www.w3.org/1999/xhtml">Next, let's implement a validator class that enforces both properties are not empty:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.1044.1" xmlns="http://www.w3.org/1999/xhtml">using Microsoft.Extensions.Options;
namespace ValidateOptionsResultBuilder;
public class SimpleMyOptionsValidator : IValidateOptions&lt;MyOptions&gt;
{
    public ValidateOptionsResult Validate(string? </span><span class="koboSpan" id="kobo.1044.2" xmlns="http://www.w3.org/1999/xhtml">name, MyOptions options)
    {
        var builder = new Microsoft.Extensions.Options.ValidateOptionsResultBuilder();
        if (string.IsNullOrEmpty(options.Prop1))
        {
            builder.AddError(
                "The value cannot be empty.",
                nameof(options.Prop1)
            );
        }
        if (string.IsNullOrEmpty(options.Prop2))
        {
            builder.AddError(
                "The value cannot be empty.",
                nameof(options.Prop2)
            );
        }
        return builder.Build();
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.1045.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we create a </span><code><span class="koboSpan" id="kobo.1046.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResultBuilder</span></code><span class="koboSpan" id="kobo.1047.1" xmlns="http://www.w3.org/1999/xhtml"> object, add errors to it, then returns an instance of the </span><code><span class="koboSpan" id="kobo.1048.1" xmlns="http://www.w3.org/1999/xhtml">SimpleMyOptionsValidator</span></code><span class="koboSpan" id="kobo.1049.1" xmlns="http://www.w3.org/1999/xhtml"> class by leveraging its </span><code><span class="koboSpan" id="kobo.1050.1" xmlns="http://www.w3.org/1999/xhtml">Build</span></code><span class="koboSpan" id="kobo.1051.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.1051.2" xmlns="http://www.w3.org/1999/xhtml">The usage of the </span><code><span class="koboSpan" id="kobo.1052.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResultBuilder</span></code><span class="koboSpan" id="kobo.1053.1" xmlns="http://www.w3.org/1999/xhtml"> class is highlighted.Next, to test this out, we must register the options. </span><span class="koboSpan" id="kobo.1053.2" xmlns="http://www.w3.org/1999/xhtml">Let's also create an endpoint. </span><span class="koboSpan" id="kobo.1053.3" xmlns="http://www.w3.org/1999/xhtml">Here's the </span><code><span class="koboSpan" id="kobo.1054.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.1055.1" xmlns="http://www.w3.org/1999/xhtml"> file:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.1056.1" xmlns="http://www.w3.org/1999/xhtml">using ValidateOptionsResultBuilder;
using Microsoft.Extensions.Options;
var builder = WebApplication.CreateBuilder(args);
builder.Services
    .AddSingleton&lt;IValidateOptions&lt;MyOptions&gt;, SimpleMyOptionsValidator&gt;()
    .AddOptions&lt;MyOptions&gt;("simple")
    .BindConfiguration("SimpleMyOptions")
    .ValidateOnStart()
;
var app = builder.Build();
app.MapGet("/", (IOptionsFactory&lt;MyOptions&gt; factory) =&gt; new
{
    simple = factory.Create("simple")
});
app.Run();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.1057.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code is as normal as it can get after a whole chapter on the Options pattern. </span><span class="koboSpan" id="kobo.1057.2" xmlns="http://www.w3.org/1999/xhtml">We register our options class, the validator, and create an endpoint.When we call the endpoint, we get the following result:</span></p>
<div class="C0-ConsolePACKT">
<pre><code><span class="koboSpan" id="kobo.1058.1" xmlns="http://www.w3.org/1999/xhtml">Hosting failed to start
Microsoft.Extensions.Options.OptionsValidationException: Property Prop1: The value cannot be empty.; Property Prop2: The value cannot be empty.</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.1059.1" xmlns="http://www.w3.org/1999/xhtml">As expected, the application failed to start because the validation of the </span><code><span class="koboSpan" id="kobo.1060.1" xmlns="http://www.w3.org/1999/xhtml">MyOptions</span></code><span class="koboSpan" id="kobo.1061.1" xmlns="http://www.w3.org/1999/xhtml"> class failed. </span><span class="koboSpan" id="kobo.1061.2" xmlns="http://www.w3.org/1999/xhtml">One difference is that we have two combined error messages instead of one.As a reference, a validator doing the same without using the </span><code><span class="koboSpan" id="kobo.1062.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResultBuilder</span></code><span class="koboSpan" id="kobo.1063.1" xmlns="http://www.w3.org/1999/xhtml"> type would look like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.1064.1" xmlns="http://www.w3.org/1999/xhtml">using Microsoft.Extensions.Options;
namespace ValidateOptionsResultBuilder;
public class ClassicMyOptionsValidator : IValidateOptions&lt;MyOptions&gt;
{
    public ValidateOptionsResult Validate(string? </span><span class="koboSpan" id="kobo.1064.2" xmlns="http://www.w3.org/1999/xhtml">name, MyOptions options)
    {
        if (string.IsNullOrEmpty(options.Prop1))
        {
            return ValidateOptionsResult.Fail(
                $"Property {nameof(options.Prop1)}: The value cannot be empty."
            </span><span class="koboSpan" id="kobo.1064.3" xmlns="http://www.w3.org/1999/xhtml">);
        }
        if (string.IsNullOrEmpty(options.Prop2))
        {
            return ValidateOptionsResult.Fail(
                $"Property {nameof(options.Prop2)}: The value cannot be empty."
            </span><span class="koboSpan" id="kobo.1064.4" xmlns="http://www.w3.org/1999/xhtml">);
        }
        return ValidateOptionsResult.Success;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.1065.1" xmlns="http://www.w3.org/1999/xhtml">The highlighted code represents the standard process which get replaced by the use of the </span><code><span class="koboSpan" id="kobo.1066.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResultBuilder</span></code><span class="koboSpan" id="kobo.1067.1" xmlns="http://www.w3.org/1999/xhtml"> type in the </span><code><span class="koboSpan" id="kobo.1068.1" xmlns="http://www.w3.org/1999/xhtml">SimpleMyOptionsValidator</span></code><span class="koboSpan" id="kobo.1069.1" xmlns="http://www.w3.org/1999/xhtml"> class.This concludes our project. </span><span class="koboSpan" id="kobo.1069.2" xmlns="http://www.w3.org/1999/xhtml">Nothing very complex, yet it is a nice addition to help accumulate multiple error messages. </span><span class="koboSpan" id="kobo.1069.3" xmlns="http://www.w3.org/1999/xhtml">On top of that, the </span><code><span class="koboSpan" id="kobo.1070.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResultBuilder</span></code><span class="koboSpan" id="kobo.1071.1" xmlns="http://www.w3.org/1999/xhtml"> type can also accumulate </span><code><span class="koboSpan" id="kobo.1072.1" xmlns="http://www.w3.org/1999/xhtml">ValidationResult</span></code><span class="koboSpan" id="kobo.1073.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.1074.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResult</span></code><span class="koboSpan" id="kobo.1075.1" xmlns="http://www.w3.org/1999/xhtml"> objects which can lead to more complex systems like collecting results from multiple validators. </span><span class="koboSpan" id="kobo.1075.2" xmlns="http://www.w3.org/1999/xhtml">I’ll let you fiddle with this one.Let’s recap this chapter before jumping into ASP.NET Core logging.</span></p>
</section>
</section>
<section class="level2" data-number="10.13" id="summary-8">
<h2 data-number="10.13"><span class="koboSpan" id="kobo.1076.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.1077.1" xmlns="http://www.w3.org/1999/xhtml">This chapter explored the Options pattern, a powerful tool allowing us to configure our ASP.NET Core applications. </span><span class="koboSpan" id="kobo.1077.2" xmlns="http://www.w3.org/1999/xhtml">It enables us to change the application without altering the code. </span><span class="koboSpan" id="kobo.1077.3" xmlns="http://www.w3.org/1999/xhtml">The capability even allows the application to reload the options at runtime when a configuration file is updated without downtime. </span><span class="koboSpan" id="kobo.1077.4" xmlns="http://www.w3.org/1999/xhtml">We learned to load settings from multiple sources, with the last loaded source overriding previous values. </span><span class="koboSpan" id="kobo.1077.5" xmlns="http://www.w3.org/1999/xhtml">We discovered the following interfaces to access settings and learned that the choice of interface influences the lifetime of the options object:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.1078.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor&lt;TOptions&gt;</span></code></li>
<li><code><span class="koboSpan" id="kobo.1079.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsFactory&lt;TOptions&gt;</span></code></li>
<li><code><span class="koboSpan" id="kobo.1080.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot&lt;TOptions&gt;</span></code></li>
<li><code><span class="koboSpan" id="kobo.1081.1" xmlns="http://www.w3.org/1999/xhtml">IOptions&lt;TOptions&gt;</span></code></li>
</ul>
<p><span class="koboSpan" id="kobo.1082.1" xmlns="http://www.w3.org/1999/xhtml">We delved into manually configuring options in the composition root and loading them from a settings file. </span><span class="koboSpan" id="kobo.1082.2" xmlns="http://www.w3.org/1999/xhtml">We also learned how to inject options into a class and configure multiple instances of the same options type using named options. </span><span class="koboSpan" id="kobo.1082.3" xmlns="http://www.w3.org/1999/xhtml">We explored encapsulating the configuration logic into classes to apply the single responsibility principle (SRP). </span><span class="koboSpan" id="kobo.1082.4" xmlns="http://www.w3.org/1999/xhtml">We achieved this by implementing the following interfaces:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.1083.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureOptions&lt;TOptions&gt;</span></code></li>
<li><code><span class="koboSpan" id="kobo.1084.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureNamedOptions&lt;TOptions&gt;</span></code></li>
<li><code><span class="koboSpan" id="kobo.1085.1" xmlns="http://www.w3.org/1999/xhtml">IPostConfigureOptions&lt;TOptions&gt;</span></code></li>
</ul>
<p><span class="koboSpan" id="kobo.1086.1" xmlns="http://www.w3.org/1999/xhtml">We also learned that we could mix configuration classes with inline configurations using the </span><code><span class="koboSpan" id="kobo.1087.1" xmlns="http://www.w3.org/1999/xhtml">Configure</span></code><span class="koboSpan" id="kobo.1088.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.1089.1" xmlns="http://www.w3.org/1999/xhtml">PostConfigure</span></code><span class="koboSpan" id="kobo.1090.1" xmlns="http://www.w3.org/1999/xhtml"> methods and that the registration order of configurators is crucial as they are executed in order of registration.We also delved into options validation. </span><span class="koboSpan" id="kobo.1090.2" xmlns="http://www.w3.org/1999/xhtml">We learned that the frequency at which options objects are validated depends on the lifetime of the options interface used. </span><span class="koboSpan" id="kobo.1090.3" xmlns="http://www.w3.org/1999/xhtml">We also discovered the concept of eager validation, which allows us to catch incorrectly configured options classes at startup time. </span><span class="koboSpan" id="kobo.1090.4" xmlns="http://www.w3.org/1999/xhtml">We learned to use data annotations to decorate our options with validation attributes such as </span><code><span class="koboSpan" id="kobo.1091.1" xmlns="http://www.w3.org/1999/xhtml">[Required]</span></code><span class="koboSpan" id="kobo.1092.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1092.2" xmlns="http://www.w3.org/1999/xhtml">We can create validation classes to validate our options objects for more complex scenarios. </span><span class="koboSpan" id="kobo.1092.3" xmlns="http://www.w3.org/1999/xhtml">Those validation classes must implement the </span><code><span class="koboSpan" id="kobo.1093.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.1094.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.1094.2" xmlns="http://www.w3.org/1999/xhtml">We also learned how to bridge other validation frameworks like </span><em><span class="koboSpan" id="kobo.1095.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidation</span></em><span class="koboSpan" id="kobo.1096.1" xmlns="http://www.w3.org/1999/xhtml"> to complement the out-of-the-box functionalities or accommodate your taste for a different validation framework.We explored a workaround allowing us to inject options classes directly into their consumers. </span><span class="koboSpan" id="kobo.1096.2" xmlns="http://www.w3.org/1999/xhtml">Doing this allows us to control their lifetime from the composition root instead of letting the types consuming them control their lifetime. </span><span class="koboSpan" id="kobo.1096.3" xmlns="http://www.w3.org/1999/xhtml">This approach aligns better with dependency injection and Inversion of Control principles. </span><span class="koboSpan" id="kobo.1096.4" xmlns="http://www.w3.org/1999/xhtml">That also makes testing the classes easier.Finally, we looked at the .NET 8 code generators that change how the options are handled but do not impact how we use the Options pattern. </span><span class="koboSpan" id="kobo.1096.5" xmlns="http://www.w3.org/1999/xhtml">We also explored the </span><code><span class="koboSpan" id="kobo.1097.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResultBuilder</span></code><span class="koboSpan" id="kobo.1098.1" xmlns="http://www.w3.org/1999/xhtml"> type, also introduced in .NET 8.The Options pattern helps us adhere to the SOLID principles, as illustrated next:</span></p>
<ul>
<li><p><strong><span class="koboSpan" id="kobo.1099.1" xmlns="http://www.w3.org/1999/xhtml">S</span></strong><span class="koboSpan" id="kobo.1100.1" xmlns="http://www.w3.org/1999/xhtml">: The Options pattern divides managing settings into multiple pieces where each has a single responsibility. </span><span class="koboSpan" id="kobo.1100.2" xmlns="http://www.w3.org/1999/xhtml">Loading unmanaged settings into strongly typed classes is one responsibility, validating options using classes is another, and configuring options from multiple independent sources is one more.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.1101.1" xmlns="http://www.w3.org/1999/xhtml">On the other hand, I find data annotations validation to mix two responsibilities in the options class, bending this principle. </span><span class="koboSpan" id="kobo.1101.2" xmlns="http://www.w3.org/1999/xhtml">If you like data annotations, I don’t want to stop you from using them.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.1102.1" xmlns="http://www.w3.org/1999/xhtml">Data annotations can seem to improve development speed but make testing validation rules harder. </span><span class="koboSpan" id="kobo.1102.2" xmlns="http://www.w3.org/1999/xhtml">For example, testing a </span><code><span class="koboSpan" id="kobo.1103.1" xmlns="http://www.w3.org/1999/xhtml">Validate</span></code><span class="koboSpan" id="kobo.1104.1" xmlns="http://www.w3.org/1999/xhtml"> method that returns a </span><code><span class="koboSpan" id="kobo.1105.1" xmlns="http://www.w3.org/1999/xhtml">ValidateOptionsResult</span></code><span class="koboSpan" id="kobo.1106.1" xmlns="http://www.w3.org/1999/xhtml"> object is easier than attributes.</span></p>
</blockquote>
</blockquote></li>
<li><strong><span class="koboSpan" id="kobo.1107.1" xmlns="http://www.w3.org/1999/xhtml">O</span></strong><span class="koboSpan" id="kobo.1108.1" xmlns="http://www.w3.org/1999/xhtml">: The different </span><code><span class="koboSpan" id="kobo.1109.1" xmlns="http://www.w3.org/1999/xhtml">IOptions*&lt;Toptions&gt;</span></code><span class="koboSpan" id="kobo.1110.1" xmlns="http://www.w3.org/1999/xhtml"> interfaces break this principle by forcing the consumer to decide what lifetime and capabilities the options should have. </span><span class="koboSpan" id="kobo.1110.2" xmlns="http://www.w3.org/1999/xhtml">To change the lifetime of a dependency, we must update the consuming class when using those interfaces. </span><span class="koboSpan" id="kobo.1110.3" xmlns="http://www.w3.org/1999/xhtml">On the other hand, we explored an easy and flexible workaround that allows us to bypass this issue for many scenarios and inject the options directly, inverting the dependency flow again, leading to open/closed consumers.</span></li>
<li><strong><span class="koboSpan" id="kobo.1111.1" xmlns="http://www.w3.org/1999/xhtml">L</span></strong><span class="koboSpan" id="kobo.1112.1" xmlns="http://www.w3.org/1999/xhtml">: N/A</span></li>
<li><strong><span class="koboSpan" id="kobo.1113.1" xmlns="http://www.w3.org/1999/xhtml">I</span></strong><span class="koboSpan" id="kobo.1114.1" xmlns="http://www.w3.org/1999/xhtml">: The </span><code><span class="koboSpan" id="kobo.1115.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.1116.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.1117.1" xmlns="http://www.w3.org/1999/xhtml">IConfigureOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.1118.1" xmlns="http://www.w3.org/1999/xhtml"> interfaces are two good examples of segregating a system into smaller interfaces where each has a single purpose.</span></li>
<li><strong><span class="koboSpan" id="kobo.1119.1" xmlns="http://www.w3.org/1999/xhtml">D</span></strong><span class="koboSpan" id="kobo.1120.1" xmlns="http://www.w3.org/1999/xhtml">: The options framework is built around interfaces, allowing us to depend on abstractions.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.1121.1" xmlns="http://www.w3.org/1999/xhtml">Again, the </span><code><span class="koboSpan" id="kobo.1122.1" xmlns="http://www.w3.org/1999/xhtml">IOptions*&lt;Toptions&gt;</span></code><span class="koboSpan" id="kobo.1123.1" xmlns="http://www.w3.org/1999/xhtml"> interfaces are the exceptions to this. </span><span class="koboSpan" id="kobo.1123.2" xmlns="http://www.w3.org/1999/xhtml">Even if they are interfaces, they tie us to implementation details like the options lifetime. </span><span class="koboSpan" id="kobo.1123.3" xmlns="http://www.w3.org/1999/xhtml">In this case, I think it is more beneficial to inject the options object directly (a data contract) instead of those interfaces.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.1124.1" xmlns="http://www.w3.org/1999/xhtml">Next, we explore .NET logging, which is another very important aspect of building applications; good traceability can make all the difference when observing or debugging applications.</span></p>
</section>
<section class="level2" data-number="10.14" id="questions-8">
<h2 data-number="10.14"><span class="koboSpan" id="kobo.1125.1" xmlns="http://www.w3.org/1999/xhtml">Questions</span></h2>
<p><span class="koboSpan" id="kobo.1126.1" xmlns="http://www.w3.org/1999/xhtml">Let’s take a look at a few practice questions:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.1127.1" xmlns="http://www.w3.org/1999/xhtml">Name one interface we can use to inject a settings class.</span></li>
<li><span class="koboSpan" id="kobo.1128.1" xmlns="http://www.w3.org/1999/xhtml">Name the two phases the ASP.NET Core uses when configuring options.</span></li>
<li><span class="koboSpan" id="kobo.1129.1" xmlns="http://www.w3.org/1999/xhtml">How significant is the order in which we register configuration objects and inline delegates?</span></li>
<li><span class="koboSpan" id="kobo.1130.1" xmlns="http://www.w3.org/1999/xhtml">Can we register multiple configuration classes?</span></li>
<li><span class="koboSpan" id="kobo.1131.1" xmlns="http://www.w3.org/1999/xhtml">What is eager validation, and why should you use it?</span></li>
<li><span class="koboSpan" id="kobo.1132.1" xmlns="http://www.w3.org/1999/xhtml">What interface must we implement to create a validator class?</span></li>
</ol>
</section>
<section class="level2" data-number="10.15" id="further-reading-7">
<h2 data-number="10.15"><span class="koboSpan" id="kobo.1133.1" xmlns="http://www.w3.org/1999/xhtml">Further reading</span></h2>
<p><span class="koboSpan" id="kobo.1134.1" xmlns="http://www.w3.org/1999/xhtml">Here are some links to build upon what we learned in the chapter:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.1135.1" xmlns="http://www.w3.org/1999/xhtml">Options pattern in ASP.NET Core (official docs): </span><a href="https://adpg.link/RTGc"><span class="koboSpan" id="kobo.1136.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/RTGc</span></a></li>
<li><span class="koboSpan" id="kobo.1137.1" xmlns="http://www.w3.org/1999/xhtml">Quickstart: Create an ASP.NET Core app with Azure App Configuration: </span><a href="https://adpg.link/qhLV"><span class="koboSpan" id="kobo.1138.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/qhLV</span></a></li>
<li><span class="koboSpan" id="kobo.1139.1" xmlns="http://www.w3.org/1999/xhtml">Secret storage in the Production environment with Azure Key Vault: </span><a href="https://adpg.link/Y5D7"><span class="koboSpan" id="kobo.1140.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/Y5D7</span></a></li>
</ul>
</section>
<section class="level2" data-number="10.16" id="answers-5">
<h2 data-number="10.16"><span class="koboSpan" id="kobo.1141.1" xmlns="http://www.w3.org/1999/xhtml">Answers</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.1142.1" xmlns="http://www.w3.org/1999/xhtml">We can use one of the following interfaces: </span><code><span class="koboSpan" id="kobo.1143.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsMonitor&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.1144.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.1145.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsFactory&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.1146.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.1147.1" xmlns="http://www.w3.org/1999/xhtml">IOptionsSnapshot&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.1148.1" xmlns="http://www.w3.org/1999/xhtml">, or </span><code><span class="koboSpan" id="kobo.1149.1" xmlns="http://www.w3.org/1999/xhtml">IOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.1150.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><span class="koboSpan" id="kobo.1151.1" xmlns="http://www.w3.org/1999/xhtml">The configuration and the post-configuration phases.</span></li>
<li><span class="koboSpan" id="kobo.1152.1" xmlns="http://www.w3.org/1999/xhtml">Configurators are executed in the order of their registration, so their order is crucial.</span></li>
<li><span class="koboSpan" id="kobo.1153.1" xmlns="http://www.w3.org/1999/xhtml">Yes, we can register as many configuration classes as we want.</span></li>
<li><span class="koboSpan" id="kobo.1154.1" xmlns="http://www.w3.org/1999/xhtml">Eager validation allows catching incorrectly configured options at startup time, which can save you runtime issues.</span></li>
<li><span class="koboSpan" id="kobo.1155.1" xmlns="http://www.w3.org/1999/xhtml">We must implement the </span><code><span class="koboSpan" id="kobo.1156.1" xmlns="http://www.w3.org/1999/xhtml">IValidateOptions&lt;TOptions&gt;</span></code><span class="koboSpan" id="kobo.1157.1" xmlns="http://www.w3.org/1999/xhtml"> interface.</span></li>
</ol>
</section>
</section>
</body>
</html>
