# 前言

软件项目很快就会从绿色田野的乌托邦转变为充满遗留代码和技术债务的棕色田野荒地。每个工程师都会遇到由于现有技术债务而比预期更难的项目。本书涵盖了将现有代码重构为更易于维护形式的过程。

在《使用 C#重构》中，我们专注于使用现代 C#和 Visual Studio 功能以可持续的方式安全地偿还技术债务，同时继续为业务创造价值。

# 本书面向的对象

本书面向两种不同类型的读者。

第一种是职业生涯早期几年的初级和中级 C#开发者。本书将教你所需的编程技术和心态，以在职业生涯中取得进步。你将学习如何安全地重构你的代码，并找到改进代码整体结构的新方法。

第二种读者类型是处理特别棘手的代码库、项目或组织的软件工程师或工程经理。本书将帮助你提出重构的论点，确保你可以安全地进行重构，并提供所有或全无的重写方法的替代方案。

本书还介绍了一些你可能最近没有遇到或考虑过的库和语言特性。我希望这本书能给你带来新的视角、工具和技术，帮助你重构代码并构建更好的代码库。

# 本书涵盖的内容

*第一章*，*技术债务、代码异味和重构*，向读者介绍了技术债务的概念及其原因。本章涵盖了遗留代码及其对开发过程的影响，以及帮助你找到它的代码异味。本章以重构的概念结束，这是本书其余部分的重点。

*第二章*，*重构简介*，通过一个示例代码片段，逐步使用内置的重构和自定义操作来展示在 Visual Studio 中重构 C#代码的过程。

*第三章*，*重构代码流和迭代*，专注于重构单个代码行和代码块。我们关注程序流程控制、对象实例化、处理集合以及适当地使用 LINQ。

*第四章*，*方法级别的重构*，通过重构方法和构造函数到更易于维护的形式，扩展了上一章的范围。在类内保持一致性，构建小型、易于维护的方法是核心关注点。

*第五章*，*面向对象重构*，将之前重构章节中的思想应用于整个类级别。这展示了引入接口、继承、多态和其他类一般如何导致更好的代码模式和更易于维护的软件系统。

*第六章*，*单元测试*，作为 C#单元测试的入门介绍，快速从单元测试的概念过渡到如何使用 xUnit、NUnit 和 MSTest 编写单元测试的教程。我们还涵盖了参数化测试和单元测试最佳实践。

*第七章*，*测试驱动开发*，通过遵循 TDD 过程来改进代码和实施重构，向读者介绍了测试驱动开发和红/绿/重构。这里还讨论了代码生成快速操作。

*第八章*，*使用 SOLID 避免代码反模式*，关注了使代码好或坏的因素，以及 SOLID、DRY 和 KISS 等常见模式如何帮助使代码更能抵抗技术债务。

*第九章*，*高级单元测试*，涵盖了用于数据生成、模拟、固定现有行为以及通过 A/B 测试安全地做出更改的各种测试库。我们介绍了 Bogus、Fluent Assertions、Moq、NSubstitute、Scientist .NET、Shouldly 和 Snapper。

*第十章*，*防御性编码技术*，展示了 C#语言的各种功能，可以使代码更加可靠并抵抗缺陷。本章涵盖了可空性、验证、不可变性、记录类、模式匹配等。

*第十一章*，*使用 GitHub Copilot 进行 AI 辅助重构*，向读者介绍了 Visual Studio 中 GitHub Copilot Chat 的最新 AI 工具。本章展示了读者如何使用 GitHub Copilot Chat 生成代码、提供重构建议、编写草稿文档，甚至帮助测试代码。我们还强调了数据隐私问题以及保护公司知识产权的方法。

*第十二章*，*Visual Studio 中的代码分析*，通过展示代码分析配置文件如何帮助检测代码中的问题，突出了现代.NET 中内置的代码分析器。我们还探讨了代码指标，并使用这些指标优先考虑技术债务区域。本章最后探讨了 SonarCloud 和 NDepend 工具，这些工具可以帮助跟踪随时间推移的技术债务。

*第十三章*，*创建 Roslyn 分析器*，介绍了自定义 Roslyn 分析器，它可以检测代码中的问题。本章引导读者编写他们的第一个分析器，使用 RoslynTestKit 进行单元测试，并使用 Visual Studio 扩展进行部署。

*第十四章*，*使用 Roslyn 分析器重构代码*，展示了 Roslyn 分析器也可以修复它们检测到的问题。本章在前一章的基础上继续，通过扩展分析器提供代码修复功能。然后我们讨论了将分析器打包到 NuGet 包中并在 NuGet.org 或其他 NuGet 源上发布它们。

*第十五章*，*沟通技术债务*，介绍了以业务领导者能够理解的方式跟踪和报告技术债务的系统化过程。我们讨论了许多常见的重构障碍以及建立信任和透明度的文化，以便业务管理能够理解技术债务所代表的风险。

*第十六章*，*采用代码标准*，讨论了确定适合您开发团队的代码标准以及获得开发者认可的过程。本章涵盖了 Visual Studio 中的代码样式、代码清理配置文件以及共享 EditorConfig 文件以促进团队内一致的样式选择。

*第十七章*，*敏捷重构*，通过讨论敏捷环境中的重构以及敏捷可能对重构提出的独特挑战来结束本书。我们讨论了在敏捷冲刺中优先考虑和偿还技术债务的方法。本章还涵盖了更大的项目，如升级和重写，以及帮助这些大型项目成功的途径。

# 要充分利用本书

理想读者应熟悉 C#编程语言和 Visual Studio IDE。了解面向对象编程、类和 LINQ 将特别有帮助。

| **本书涵盖的软件/硬件** | **操作系统要求** |
| --- | --- |
| Visual Studio 2022 v17.8 或更高版本 | Windows |
| .NET 8 SDK |  |

本书适用于从 2022 年 v17.8 版 Visual Studio 的任何版本，包括 Visual Studio Community。您可以从[`visualstudio.microsoft.com/downloads/`](https://visualstudio.microsoft.com/downloads/)下载 Visual Studio。

您可以从[`dotnet.microsoft.com/en-us/download/dotnet/8.0`](https://dotnet.microsoft.com/en-us/download/dotnet/8.0)下载.NET 8 SDK 的最新版本。

**如果您使用的是本书的数字版，我们建议您亲自输入代码或从本书的 GitHub 仓库（下一节中提供链接）获取代码。这样做将帮助您避免与代码复制和粘贴相关的任何潜在错误**。

许多章节提供了逐步说明，您可以通过使用章节开头的代码来跟随这些说明，从而生成章节最终代码文件夹中的代码。您也可以在阅读本书的同时关注您正在使用的其他代码，并思考这些主题如何应用于该代码。然而，您可能希望在阅读了涵盖安全测试代码的章节之后，再对现实世界的代码库应用您的重构技术。

# 下载示例代码文件

您可以从 GitHub 下载本书的示例代码文件[`github.com/PacktPublishing/Refactoring-with-CSharp`](https://github.com/PacktPublishing/Refactoring-with-CSharp)。如果代码有更新，它将在 GitHub 仓库中更新。

我们还有其他来自我们丰富图书和视频目录的代码包，可在[`github.com/PacktPublishing/`](https://github.com/PacktPublishing/)找到。查看它们吧！

# 使用的约定

本书使用了多种文本约定。

`文本中的代码`：表示文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 昵称。以下是一个示例：“让我们再次看看之前的`IFlightUpdater`接口。”

代码块如下设置：

```cs
public interface IFlightRepository {
  FlightInfo AddFlight(FlightInfo flight);
  FlightInfo UpdateFlight(FlightInfo flight);
  void CancelFlight(FlightInfo flight);
  FlightInfo? FindFlight(string id);
  IEnumerable<FlightInfo> GetActiveFlights();
  IEnumerable<FlightInfo> GetPendingFlights();
  IEnumerable<FlightInfo> GetCompletedFlights();
}
```

当我们希望您注意代码块中的特定部分时，相关的行或项目将以粗体显示：

```cs
public interface IFlightUpdater {
  FlightInfo AddFlight(FlightInfo flight);
  FlightInfo UpdateFlight(FlightInfo flight);
  void CancelFlight(FlightInfo flight);
}
```

任何命令行输入或输出都应如下编写：

```cs
  Assert.Equal() Failure   Expected: 60   Actual: 50
```

**粗体**：表示新术语、重要单词或您在屏幕上看到的单词。例如，菜单或对话框中的单词以**粗体**显示。以下是一个示例：“点击**下一步**，然后为您的测试项目起一个有意义的名称，然后再次点击**下一步**。”

小贴士或重要提示

看起来是这样的。

# 联系我们

欢迎读者反馈。

**一般反馈**：如果您对本书的任何方面有疑问，请通过[customercare@packtpub.com](http://customercare@packtpub.com)给我们发邮件，并在邮件主题中提及书名。

**勘误**：尽管我们已经尽一切努力确保内容的准确性，但错误仍然可能发生。如果您在这本书中发现了错误，我们将不胜感激，如果您能向我们报告，我们将非常感谢。请访问[www.packtpub.com/support/errata](http://www.packtpub.com/support/errata)并填写表格。

**盗版**：如果您在互联网上以任何形式遇到我们作品的非法副本，如果您能提供位置地址或网站名称，我们将不胜感激。请通过[版权@packtpub.com](http://copyright@packtpub.com)与我们联系，并提供材料的链接。

**如果您有兴趣成为作者**：如果您在某个主题上具有专业知识，并且您有兴趣撰写或为本书做出贡献，请访问[authors.packtpub.com](http://authors.packtpub.com)。

# 分享您的想法

一旦您阅读了《使用 C#进行重构》，我们很乐意听听您的想法！[请点击此处直接进入此书的亚马逊评论页面并分享您的反馈](https://packt.link/r/1835089984)。

您的评论对我们和科技社区非常重要，并将帮助我们确保我们提供高质量的内容。

# 下载此书的免费 PDF 副本

感谢您购买此书！

您喜欢在路上阅读，但又无法随身携带您的印刷书籍吗？

您的电子书购买是否与您选择的设备不兼容？

别担心，现在每购买一本 Packt 书籍，您都可以免费获得该书的 DRM 免费 PDF 版本。

无论在哪里、什么设备上阅读，都可以搜索、复制和粘贴您最喜欢的技术书籍中的代码直接到您的应用程序中。

优惠远不止这些，您还可以获得独家折扣、时事通讯和每日邮箱中的优质免费内容。

按照以下简单步骤获取优惠：

1.  扫描二维码或访问以下链接

![二维码](img/B21324_QR_Free_PDF.jpg)

[`packt.link/free-ebook/9781835089989`](https://packt.link/free-ebook/9781835089989)

1.  提交您的购买证明

1.  就这些了！我们将直接将您的免费 PDF 和其他优惠发送到您的邮箱。

# 第一部分：在 Visual Studio 中使用 C#进行重构

在本书的第一部分，我们将讨论技术债务、代码异味和重构的本质。我们将专注于在 Visual Studio 中重构 C#代码的机械过程。

在本部分中，您将学习如何在不改变其功能的情况下安全地更改代码的形式。我们将涵盖高级概念，然后逐步重构单个代码行。之后，我们将扩展到重构整个方法，并了解它们是如何相互作用的。最后，我们将探讨一些面向对象的重构方法，这些方法可以通过改变类之间的交互来真正重塑您的代码。

这一部分的书既可以当作传统书籍阅读，也可以用作每个章节中找到的起始代码重构的逐步教程。

本部分包含以下章节：

+   *第一章*，*技术债务、代码异味和重构*

+   *第二章*，*重构简介*

+   *第三章*，*重构代码流程和迭代*

+   *第四章*，*方法级别的重构*

+   *第五章*，*面向对象的重构*
