- en: '*Chapter 10*: Customizing ASP.NET Core Identity'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this tenth chapter, we are going to learn how to customize ASP.NET Core Identity.
    Security is one of the most important aspects of an application. Microsoft ships
    ASP.NET Core Identity as part of the ASP.NET Core framework to add authentication
    and user management to ASP.NET Core applications.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, you will learn how to customize the basic implementation of
    the ASP.NET Core Identity UI and how to add custom information to **IdentityUser**.
    We''ll cover the following points:'
  prefs: []
  type: TYPE_NORMAL
- en: Introducing ASP.Net Core Identity
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Customizing IdentityUser
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Customizing the Identity views
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The topics of this chapter relate to the MVC layer of the ASP.NET Core architecture:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 10.1 – ASP.NET Core architecture](img/Figure_10.1_B17996.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 10.1 – ASP.NET Core architecture
  prefs: []
  type: TYPE_NORMAL
- en: Technical requirements
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'To follow the exercises in this chapter, you will need to create an ASP.NET
    Core MVC application. Open your console, shell, or Bash terminal and change to
    your working directory. Use the following command to create a new MVC application:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'Now, open the project in Visual Studio by double-clicking the project file,
    or open it in Visual Studio Code by typing the following command in the already-open
    console:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'All of the code samples for this chapter can be found in the GitHub repo for
    this book: [https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter10](https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter10).'
  prefs: []
  type: TYPE_NORMAL
- en: Introducing ASP.NET Core Identity
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: An `writer` tells the application that the identity is allowed to write something.
    Identities can be nested as well. A user can be part of a group, and a group can
    be part of another group, and so forth.
  prefs: []
  type: TYPE_NORMAL
- en: ASP.NET Core Identity is a framework that structures this concept in .NET objects
    to help you store and read the user information. The framework also provides a
    mechanism to add a login form, a registration form, session handling, and so on.
    It also helps you to store the credentials in an encrypted and secure way.
  prefs: []
  type: TYPE_NORMAL
- en: 'ASP.NET Core Identity provides multiple ways to authenticate your users:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Individual**: The application manages the identities on its own. It has a
    database where user information is stored and manages the login, logout, registration,
    and so on on its own.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**IndividualB2C**: Manages the user data on its own, but gets it from Azure
    B2C.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**SingleOrg**: The identities get managed by Azure **Active Directory** (**AD**);
    the login, logout, and so on are done by Azure AD. The application just gets a
    ready-to-use identity from the web server.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**MultiOrg**: Same as the previous but enabled for multiple Azure AD organizations.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Windows**: This means the classical Windows authentication, which is only
    available if the application is hosted with IIS. The user also gets a ready-to-use
    identity from the web server.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: This chapter is not about the different ways to authenticate because this topic
    would fill an entire book.
  prefs: []
  type: TYPE_NORMAL
- en: Let's explore an application with **individual** authentication enabled.
  prefs: []
  type: TYPE_NORMAL
- en: As you might remember from the technical requirements, the `--auth` flag is
    used to create the application. It is set to `Individual` to create an ASP.NET
    Core MVC application with individual authentication enabled. This means it comes
    with a database to store the users. The `--auth` flag adds all the relevant code
    and dependencies to enable authentication in your freshly created application.
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 10.2 – Layout reference for the ASP.NET Identity UI](img/Figure_10.2_B17996.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 10.2 – Layout reference for the ASP.NET Identity UI
  prefs: []
  type: TYPE_NORMAL
- en: The `--auth` flag creates an area called `Identity` that contains a `_ViewStart.cshtml`
    file, which references the `_Layout.cshtml` file of the new project. The actual
    login or register screens are provided in a compiled library that is referenced
    to this project.
  prefs: []
  type: TYPE_NORMAL
- en: The AUTHSAMPLE contains a `Data` folder that contains an Entity Framework Core
    DbContext, as well as a database migration to create and update the database that
    is used here.
  prefs: []
  type: TYPE_NORMAL
- en: All the other parts, except `Program.cs`, are completely the same as in regular
    MVC applications.
  prefs: []
  type: TYPE_NORMAL
- en: If you created the application using the .NET CLI as shown in the technical
    requirements, a **SQLite** database is used. If you used Visual Studio to create
    this application, SQL Server is used to store the user data.
  prefs: []
  type: TYPE_NORMAL
- en: 'Before starting the application, call the following command in the terminal:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: This will create and update the database.
  prefs: []
  type: TYPE_NORMAL
- en: 'If it doesn''t work, you might need to install the Entity Framework tool in
    the .NET CLI first:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'Then, call the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'The application will now start up in watch mode with hot-reload enabled. It
    will also open a browser window and call the application:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 10.3 – AuthSample home page'
  prefs: []
  type: TYPE_NORMAL
- en: '](img/Figure_10.3_B17996.jpg)'
  prefs: []
  type: TYPE_NORMAL
- en: Figure 10.3 – AuthSample home page
  prefs: []
  type: TYPE_NORMAL
- en: 'As you can see, there is a menu on the upper right-hand side with the **Register**
    and **Login** options for this application. A click on the **Login** link takes
    you to the following login screen:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 10.4 – Login screen'
  prefs: []
  type: TYPE_NORMAL
- en: '](img/Figure_10.4_B17996.jpg)'
  prefs: []
  type: TYPE_NORMAL
- en: Figure 10.4 – Login screen
  prefs: []
  type: TYPE_NORMAL
- en: As mentioned, this view comes from a compiled Razor library that provides the
    necessary view to the Identity area. We automatically get this UI from the framework.
  prefs: []
  type: TYPE_NORMAL
- en: As the last thing in this section, we should have a quick look into `Program.cs`,
    which also differs from the files we saw in the last chapters.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the upper section, where the services are registered, there are lines of
    code to register `DbContext` as well as database exception pages:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: There is also a registration for default identity that adds the `EntityFramework`
    store. It is also configured to only allow confirmed accounts, which means you
    as a user need to confirm your email address before you are allowed to log in.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the lower section, where the middleware is used, we see that the authentication
    and authorization is used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: These two middleware enable authentication and authorization. The first tries
    to recognize the user by reading the authentication cookie. It also adds all the
    relevant information to the Identity object.
  prefs: []
  type: TYPE_NORMAL
- en: What you might need to do is to extend the user profile by adding some more
    properties to the user. Let's see how to do so in the next section.
  prefs: []
  type: TYPE_NORMAL
- en: Customizing IdentityUser
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '`IdentityUser` has the following fields: `Id`, `Username`, `Password`, `Email`,
    and `Phonenumber`.'
  prefs: []
  type: TYPE_NORMAL
- en: Since the display name might differ from the username, we should add a `Name`
    property. Say we would like to send birthday wishes to the user; so, we would
    like to know their date of birth.
  prefs: []
  type: TYPE_NORMAL
- en: 'To do so, a file called `WebAppUser.cs` is added to the `Data` folder that
    contains the following lines:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: As shown here, `WebAppUser` derives from `IdentityUser` and extends it with
    the two already-mentioned properties.
  prefs: []
  type: TYPE_NORMAL
- en: 'In `Program.cs`, we need to modify the service registration to use the new
    `WebAppUser`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'We also need to change `DbContext` in a way to use this `WebAppUser`, by changing
    the base class:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: You might need to add a `using` statement to `Microsoft.AspNetCore.Identity`.
  prefs: []
  type: TYPE_NORMAL
- en: 'That''s it for the first step. We now need to update the database:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: Once you have `IdentityUser` extended with the custom properties, you can start
    to use this in the user profile. This needs some customization in the ASP.NET
    Core Identity UI.
  prefs: []
  type: TYPE_NORMAL
- en: Customizing the Identity views
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Even if the ASP.NET Core Identity views come from a compiled Razor library,
    you can customize those views to add more fields or change the layout. To do so,
    you just need to override the given views with custom ones in the predefined folder
    structure within the area.
  prefs: []
  type: TYPE_NORMAL
- en: As mentioned, there is already an area called `Identity` in the project. Inside
    this area, there is a `Pages` folder. Here, a new folder called `Account` needs
    to be created, to match the route of the **Register** page.
  prefs: []
  type: TYPE_NORMAL
- en: 'If this is done, place a new Razor page called `Register.cshtml` inside this
    folder and put the following content inside just to see whether the overriding
    of views is working:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'If you now run the app and click on **Register** in the upper left-hand corner,
    you will see the following page:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 10.5 – Register page](img/Figure_10.5_B17996.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 10.5 – Register page
  prefs: []
  type: TYPE_NORMAL
- en: It is working.
  prefs: []
  type: TYPE_NORMAL
- en: Actually, you don't need to override the views on your own. There is a code
    generator available to scaffold the views you'd like to override.
  prefs: []
  type: TYPE_NORMAL
- en: 'Install the code generator by calling this command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'If not already done, you also need to install the following packages in your
    project:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: 'To learn what the code generator can do, run the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'You can scaffold the entire Identity UI as well as specific pages. If you don''t
    specify pages of the default UI, all pages will be generated in your project.
    To see which pages you can generate, type the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: The idea for the first change is to let the user fill in the name property on
    the registration page.
  prefs: []
  type: TYPE_NORMAL
- en: 'So, let''s scaffold the **Register** page:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: This command tells the code generator to use the already-existing `ApplicationDbContext`
    and `Sqlite`. If you don't specify this, it will either create a new `DbContext`
    or register the existing `DbContext` to use with SQL Server instead of SQLite.
  prefs: []
  type: TYPE_NORMAL
- en: 'If all is done right, the code generator should only add the `Register.cshtml`
    page as well as some infrastructure files:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 10.6 – Files added by the code generator](img/Figure_10.6_B17996.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 10.6 – Files added by the code generator
  prefs: []
  type: TYPE_NORMAL
- en: The code generator also knows that the project is using a custom `WebAppUser`
    instead of `IdentityUser`, which means `WebAppUser` is used in the generated code.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now, you should change `Register.cshtml` to add the display name to the form.
    Add the following lines right before the form elements for the email field on
    line 15 and thereafter:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: 'Also, `Regiser.cshtml.cs` need to be changed. The `ImportModel` class needs
    the `Name` property:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: 'In the `PostAsync` method, assign the `Name` property to the newly created
    user:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: That's it.
  prefs: []
  type: TYPE_NORMAL
- en: 'After starting the application, you will see the following registration form:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 10.7 – Registration form'
  prefs: []
  type: TYPE_NORMAL
- en: '](img/Figure_10.7_B17996.jpg)'
  prefs: []
  type: TYPE_NORMAL
- en: Figure 10.7 – Registration form
  prefs: []
  type: TYPE_NORMAL
- en: Try it out and you will see that it is working.
  prefs: []
  type: TYPE_NORMAL
- en: 'Since the user might need to update the name, we also need to change the view
    on the profile page. Here, the date of birth also needs to be added:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: 'Open the newly created `Index.cshtml.cs` that is located in the `/Areas/Identity/Pages/Account/Manage/`
    folder and place the following properties inside the `InputModel` class:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: 'You can now use these properties in the corresponding `Index.cshtml`. The next
    snippet needs to be placed between the validation summary and the username:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: 'This would be enough to display the fields, but there are some more changes
    needed to fill the form with saved data. Within the `LoadAsync` method, the instantiation
    of `InputModel` needs to be extended with the new properties:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: 'The changed values also need to get saved when the user saves the form. Place
    the next snippet right before the third-from-last line of the `OnPostAsync` method:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: This sets the values of `InputModel` to the `WebAppUser` properties and saves
    the changes in the database.
  prefs: []
  type: TYPE_NORMAL
- en: Let's try it out by calling `dotnet watch` in the terminal.
  prefs: []
  type: TYPE_NORMAL
- en: 'The profile page will now look similar to this:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 10.8 – Manage your account page'
  prefs: []
  type: TYPE_NORMAL
- en: '](img/Figure_10.8_B17996.jpg)'
  prefs: []
  type: TYPE_NORMAL
- en: Figure 10.8 – Manage your account page
  prefs: []
  type: TYPE_NORMAL
- en: You can now change the display name and add your date of birth.
  prefs: []
  type: TYPE_NORMAL
- en: If the user provides a display name, they might show it in the upper left-hand
    corner after the login.
  prefs: []
  type: TYPE_NORMAL
- en: 'Open the `_LoginPartial.cshtml` that is in the `Views/Shared` folder and replace
    the first four lines with the following code snippet:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: This changes the generic type argument of `SignInManager` and `UserManager`
    from the `IdentityUser` type to the `WebAppUser` type. Inside the code block,
    the current `WebAppUser` is loaded via `UserManager` by passing the current user
    in.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now, the output of the username on line 12 needs to be changed to write the
    display name:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: 'When `dotnet watch` is still running, the application running in the browser
    should already be updated. Maybe you need to log in again. You should now see
    the display name in the upper right-hand corner:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 10.9 – Display name'
  prefs: []
  type: TYPE_NORMAL
- en: '](img/Figure_10.9_B17996.jpg)'
  prefs: []
  type: TYPE_NORMAL
- en: Figure 10.9 – Display name
  prefs: []
  type: TYPE_NORMAL
- en: That's it.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, you learned how to extend ASP.NET Core Identity to enhance
    the user object by adding additional properties. You also learned how to enhance
    the Identity UI to load, save, and update the values of the new user properties.
  prefs: []
  type: TYPE_NORMAL
- en: But how would you manage roles for the users of your application?
  prefs: []
  type: TYPE_NORMAL
- en: This is what you will learn in the next chapter, about configuring identity
    management.
  prefs: []
  type: TYPE_NORMAL
