<html><head></head><body>
  <div><h1 class="chapterNumber">2</h1>
    <h1 class="chapterTitle" id="_idParaDest-82">Managing Relational Data Using SQL Server</h1>
    <p class="normal">This chapter is about managing relational data stored in SQL Server, Azure SQL Database, or Azure SQL Edge. First, you will learn how to manage the data using native Transact-SQL statements. Next, you will learn how to manage data at a low level using ADO.NET libraries (<code class="inlineCode">Microsoft.Data.SqlClient</code>). Finally, you will use Dapper to make it easier to work with entity models.</p>
    <p class="normal">This chapter will cover the following topics:</p>
    <ul>
      <li class="bulletList">Understanding modern databases</li>
      <li class="bulletList">Managing data with Transact-SQL</li>
      <li class="bulletList">Managing SQL Server data with low-level APIs</li>
      <li class="bulletList">Managing SQL Server data with Dapper</li>
      <li class="bulletList">Cleaning up data resources</li>
    </ul>
    <h1 class="heading-1" id="_idParaDest-83">Understanding modern databases</h1>
    <p class="normal">Two <a id="_idIndexMarker115"/>of <a id="_idIndexMarker116"/>the <a id="_idIndexMarker117"/>most<a id="_idIndexMarker118"/> common places to<a id="_idIndexMarker119"/> store data are<a id="_idIndexMarker120"/> in a <strong class="keyWord">Relational Database Management System</strong> (<strong class="keyWord">RDBMS</strong>) such <a id="_idIndexMarker121"/>as <strong class="keyWord">SQL Server</strong>, <strong class="keyWord">PostgreSQL</strong>, <strong class="keyWord">MySQL</strong>, and <strong class="keyWord">SQLite</strong>, or<a id="_idIndexMarker122"/> in a <strong class="keyWord">NoSQL</strong> database <a id="_idIndexMarker123"/>such <a id="_idIndexMarker124"/>as <strong class="keyWord">Azure Cosmos DB</strong>, <strong class="keyWord">MongoDB</strong>, <strong class="keyWord">Redis</strong>, and <strong class="keyWord">Apache Cassandra</strong>.</p>
    <p class="normal">In this chapter, we will focus on the most popular RDBMS for Windows, which is SQL Server. This product is also available in a version for Linux. For cross-platform development, you can use either Azure SQL Database, which stores the data in the cloud, or Azure SQL Edge, which can run in a Docker container on Windows, macOS, or Linux, on both Intel and ARM architecture CPUs.</p>
    <h2 class="heading-2" id="_idParaDest-84">Using a sample relational database</h2>
    <p class="normal">To learn <a id="_idIndexMarker125"/>how to manage an RDBMS using .NET, it would be useful to have a sample one so that you can practice on a database that has a medium complexity and a decent number of sample records. </p>
    <p class="normal">Microsoft offers several sample databases, most of which are too complex for our needs, so instead, we will use a database that was first created in the early 1990s known as <strong class="keyWord">Northwind</strong>.</p>
    <p class="normal">Let’s take a minute to look at a diagram of the <a id="_idIndexMarker126"/>Northwind database and its eight most important tables. You can use the diagram in <em class="italic">Figure 2.1</em> to refer to as we write code and queries throughout this book:</p>
    <figure class="mediaobject"><img alt="" src="img/B19587_02_01.png"/></figure>
    <p class="packt_figref">Figure 2.1: The Northwind database tables and relationships</p>
    <p class="normal">Note that:</p>
    <ul>
      <li class="bulletList">Each <a id="_idIndexMarker127"/>category has a unique identifier, name, description, and picture. The picture is stored as a byte array in JPEG format.</li>
      <li class="bulletList">Each <a id="_idIndexMarker128"/>product has a unique identifier, name, unit price, number of units in stock, and other columns.</li>
      <li class="bulletList">Each product is associated with a category by storing the category’s unique identifier.</li>
      <li class="bulletList">The relationship between <code class="inlineCode">Categories</code> and <code class="inlineCode">Products</code> is one-to-many, meaning each category can have zero, one, or more products.</li>
      <li class="bulletList">Each product is supplied by a supplier company indicated by storing the supplier’s unique identifier.</li>
      <li class="bulletList">The quantity and unit price of a product is stored for each detail of an order.</li>
      <li class="bulletList">Each order is made by a customer, taken by an employee, and shipped by a shipping company.</li>
      <li class="bulletList">Each employee has a name, address, contact details, birth, and hire dates, a reference to their manager (except for the boss, whose <code class="inlineCode">ReportsTo</code> field is <code class="inlineCode">null</code>), and a photo stored as a byte array in JPEG format. The table has a one-to-many relationship to itself because one employee can manage many other employees.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-85">Connecting to a SQL Server database</h2>
    <p class="normal">To connect to a <a id="_idIndexMarker129"/>SQL Server database, we need to know multiple pieces of information, as <a id="_idIndexMarker130"/>shown in the following list:</p>
    <ul>
      <li class="bulletList">The name of the server (and the name of the instance if it has more than the default one). This can include the protocol, IP address, and port number if connecting over a network.</li>
      <li class="bulletList">The name of the database.</li>
      <li class="bulletList">Security information, such as the username and password, or if we should pass the currently logged-on user’s credentials automatically using Windows Authentication.</li>
    </ul>
    <p class="normal">We specify this information in a <strong class="keyWord">connection string</strong>.</p>
    <p class="normal">For backward compatibility, there are multiple possible keywords we can use in a SQL Server connection<a id="_idIndexMarker131"/> string for <a id="_idIndexMarker132"/>the various parameters, as shown in the following list:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">Data Source</code>, <code class="inlineCode">server</code>, or <code class="inlineCode">addr</code>: These keywords are the name of the server (and an optional instance). You can use a dot (<code class="inlineCode">.</code>) to mean the local server.</li>
      <li class="bulletList"><code class="inlineCode">Initial Catalog</code> or <code class="inlineCode">database</code>: These keywords are the name of the database that will be active initially. A SQL statement could change that using the command: <code class="inlineCode">USE &lt;databasename&gt;</code>.</li>
      <li class="bulletList"><code class="inlineCode">Integrated Security</code> or <code class="inlineCode">trusted_connection</code>: These keywords are set to <code class="inlineCode">true</code> or <code class="inlineCode">SSPI</code> to pass the thread’s current user credentials using Windows Authentication.</li>
      <li class="bulletList"><code class="inlineCode">User Id</code> and <code class="inlineCode">Password</code>: These keywords are used to authenticate with any edition of SQL Server. This is important for Azure SQL Database or Azure SQL Edge because they do not support Windows Authentication. The full edition of SQL Server on Windows supports both username with password and Windows Authentication.</li>
      <li class="bulletList"><code class="inlineCode">Authentication</code>: This keyword is used to authenticate by using Azure AD identities that can enable password-less authentication. Values can be <code class="inlineCode">Active Directory Integrated</code>, <code class="inlineCode">Active Directory Password</code>, and <code class="inlineCode">Sql Password</code>.</li>
      <li class="bulletList"><code class="inlineCode">Persist Security Info</code>: If set to <code class="inlineCode">false</code>, this keyword tells the connection to remove the <code class="inlineCode">Password</code> from the connection string after authenticating.</li>
      <li class="bulletList"><code class="inlineCode">Encrypt</code>: If set to <code class="inlineCode">true</code>, this keyword tells the connections to use SSL to encrypt transmissions between client and server.</li>
      <li class="bulletList"><code class="inlineCode">TrustServerCertificate</code>: Set to <code class="inlineCode">true</code> if hosting locally and you get the error “A connection was successfully established with the server, but then an error occurred during the login process. (provider: SSL Provider, error: 0 - The certificate chain was issued by an authority that is not trusted.)”.</li>
      <li class="bulletList"><code class="inlineCode">Connection Timeout</code>: This keyword defaults to 30 seconds.</li>
      <li class="bulletList"><code class="inlineCode">MultipleActiveResultSets</code>: This keyword is set to <code class="inlineCode">true</code> to enable a single connection to be used to work with multiple tables simultaneously to improve efficiency. It is used for lazy loading rows from related tables.</li>
    </ul>
    <p class="normal">As described in the list above, when you write code to connect to a SQL Server database, you<a id="_idIndexMarker133"/> need to know its server name. The server name depends on the edition and version<a id="_idIndexMarker134"/> of SQL Server that you will connect to, as shown in <em class="italic">Table 2.1</em>:</p>
    <table class="table-container" id="table001-1">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">SQL Server edition</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Server name \ Instance name</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">LocalDB 2012</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">(localdb)\v11.0</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">LocalDB 2016 or later</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">(localdb)\mssqllocaldb</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Express</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">.\sqlexpress</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Full/Developer (default instance)</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">.</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Full/Developer (named instance)</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">.\apps-services-book</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Azure SQL Edge (local Docker)</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">tcp:127.0.0.1,1433</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Azure SQL Database</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">tcp:[custom server name].database.windows.net,1433</code></p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 2.1: Server name examples for various editions of SQL Server</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Use a dot (.) as shorthand for the local computer name (localhost). Remember that server names for SQL Server can be made up of two parts: the name of the computer and the name of a SQL Server instance. You provide instance names during custom installation.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-86">Installing and setting up SQL Server locally</h2>
    <p class="normal">Microsoft <a id="_idIndexMarker135"/>offers various editions of its popular and capable SQL Server product <a id="_idIndexMarker136"/>for Windows, Linux, and Docker containers. If you have Windows, then you can use a free version that runs standalone, known as SQL Server Developer Edition. You can also use the Express edition or the free SQL Server LocalDB edition that can be installed with Visual Studio 2022 for Windows.</p>
    <p class="normal">If you do not have a Windows computer or if you want to use a cross-platform database system, then you<a id="_idIndexMarker137"/> can skip ahead to the topic <em class="italic">Setting up Azure SQL Database</em>, or the online-only section <em class="italic">Installing Azure SQL Edge in Docker</em> found at the following link:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/ch02-sql-edge.md">https://github.com/markjprice/apps-services-net8/blob/main/docs/ch02-sql-edge.md</a></p>
    <p class="normal">If you prefer to install SQL Server locally on Linux, then you will find instructions at the following link: <a href="https://learn.microsoft.com/en-us/sql/linux/sql-server-linux-setup">https://learn.microsoft.com/en-us/sql/linux/sql-server-linux-setup</a>.</p>
    <h3 class="heading-3" id="_idParaDest-87">Installing SQL Server Developer Edition for Windows</h3>
    <p class="normal">On Windows, if <a id="_idIndexMarker138"/>you want to use the full edition of SQL Server instead of the simplified LocalDB or Express editions, then you can find all SQL Server editions at the following link: <a href="https://www.microsoft.com/en-us/sql-server/sql-server-downloads">https://www.microsoft.com/en-us/sql-server/sql-server-downloads</a>.</p>
    <p class="normal">Take the following steps:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Download the <strong class="screenText">Developer</strong> edition.</li>
      <li class="numberedList">Run the installer.</li>
      <li class="numberedList">Select the <strong class="screenText">Custom</strong> installation type.</li>
      <li class="numberedList">Select a folder for the installation files and then click <strong class="screenText">Install</strong>.</li>
      <li class="numberedList">Wait for the 1.5 GB of installer files to download.</li>
      <li class="numberedList">In <strong class="screenText">SQL Server Installation Center</strong>, click <strong class="screenText">Installation</strong>, and then click <strong class="screenText">New SQL Server stand-alone installation or add features to an existing installation</strong>, as shown in <em class="italic">Figure 2.2</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_02_02.png"/></figure>
    <p class="packt_figref">Figure 2.2: Installing a new instance of SQL Server</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Select <strong class="screenText">Developer</strong> as the free edition and then click <strong class="screenText">Next</strong>.</li>
      <li class="numberedList">Accept the license terms and then click <strong class="screenText">Next</strong>.</li>
      <li class="numberedList">Review the <strong class="screenText">Microsoft Update</strong> options and then click <strong class="screenText">Next</strong>.</li>
      <li class="numberedList">Review<a id="_idIndexMarker139"/> the install rules, fix any issues although you might want to ignore any firewall warnings since you might not want to expose those ports anyway, and then click <strong class="screenText">Next</strong>.</li>
      <li class="numberedList">In <strong class="screenText">Feature Selection</strong>, select <strong class="screenText">Database Engine Services</strong>, and then click <strong class="screenText">Next</strong>.</li>
      <li class="numberedList">In <strong class="screenText">Azure Extension for SQL Server</strong>, you can turn this off.</li>
      <li class="numberedList">In <strong class="screenText">Instance Configuration</strong>, select <strong class="screenText">Default instance</strong>, and then click <strong class="screenText">Next</strong>. If you already have a default instance configured, then you could create a named instance, perhaps called <code class="inlineCode">apps-services-book</code>.</li>
      <li class="numberedList">In <strong class="screenText">Server Configuration</strong>, note the <strong class="screenText">SQL Server Database Engine</strong> is configured to start automatically. If not already set by default, then set the <strong class="screenText">SQL Server Browser</strong> to start automatically, and then click <strong class="screenText">Next</strong>.</li>
      <li class="numberedList">In <strong class="screenText">Database Engine Configuration</strong>, on the <strong class="screenText">Server Configuration</strong> tab, set <strong class="screenText">Authentication Mode</strong> to <strong class="screenText">Mixed</strong>, set the <strong class="screenText">sa</strong> account password to a strong password, click <strong class="screenText">Add Current User</strong>, and then click <strong class="screenText">Next</strong>.</li>
      <li class="numberedList">In <strong class="screenText">Ready to Install</strong>, review the actions that will be taken, and then click <strong class="screenText">Install</strong>.</li>
      <li class="numberedList">In <strong class="screenText">Complete</strong>, note the successful actions taken, and then click <strong class="screenText">Close</strong>.</li>
      <li class="numberedList">In <strong class="screenText">SQL Server Installation Center</strong>, in <strong class="screenText">Installation</strong>, click <strong class="screenText">Install SQL Server Management Tools</strong>.</li>
      <li class="numberedList">In the browser window, click to download the latest version of SSMS, as shown in <em class="italic">Figure 2.3</em>:
    <figure class="mediaobject"><img alt="" src="img/B19587_02_03.png"/></figure>
    <p class="packt_figref">Figure 2.3: Downloading SQL Server Management Studio (SSMS)</p>
    <div><p class="normal">The direct link to download SSMS is as follows: <a href="https://learn.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms">https://learn.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms</a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="20">Run <a id="_idIndexMarker140"/>the SSMS installer and click <strong class="screenText">Install</strong>.</li>
      <li class="numberedList">When the installer has finished, click <strong class="screenText">Restart</strong> if needed or <strong class="screenText">Close</strong>.</li>
    </ol>
    <div><p class="normal"><strong class="keyWord">Azure Data Studio </strong>(<strong class="keyWord">ADS</strong>) is automatically installed alongside SSMS. ADS is cross-platform and open-source, so you can use it to work with SQL Server databases on any desktop operating system.</p>
    </div>
    <h3 class="heading-3" id="_idParaDest-88">Visual Studio Code extension for working with SQL Server</h3>
    <p class="normal">There are many<a id="_idIndexMarker141"/> tools that make it easy to work with SQL Server. If you are using Visual Studio Code, then you can install the <strong class="screenText">SQL Server (mssql)</strong> <code class="inlineCode">ms-mssql.mssql</code> extension. If you install the extension, it adds a new view to the Primary Side Bar titled <strong class="screenText">SQL Server</strong>, as shown in <em class="italic">Figure 2.4</em>:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B19587_02_04.png"/></figure>
    <p class="packt_figref">Figure 2.4: SQL Server (mssql) extension for Visual Studio Code</p>
    <h3 class="heading-3" id="_idParaDest-89">Creating the Northwind sample database locally</h3>
    <p class="normal">Now<a id="_idIndexMarker142"/> we can run a database script to create the Northwind sample <a id="_idIndexMarker143"/>database locally on Windows using <strong class="keyWord">SQL Server Management Studio </strong>(<strong class="keyWord">SSMS</strong>):</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">If you have not previously downloaded or cloned the GitHub repository for this book, then do so now using the following link: <a href="https://github.com/markjprice/apps-services-net8/">https://github.com/markjprice/apps-services-net8/</a>.</li>
      <li class="numberedList">In your <code class="inlineCode">apps-services-net8</code> folder, create a folder named <code class="inlineCode">Chapter02</code>.</li>
      <li class="numberedList">Copy the script to create the Northwind database for SQL Server from the following path in your local Git repository: <code class="inlineCode">/scripts/sql-scripts/Northwind4SQLServer.sql</code> into the <code class="inlineCode">Chapter02</code> folder.</li>
      <li class="numberedList">Start <strong class="screenText">SQL Server Management Studio</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Connect to Server</strong> dialog, for <strong class="screenText">Server name</strong>, enter <code class="inlineCode">.</code> (a dot), meaning the local computer name, and then click <strong class="screenText">Connect</strong>.<div><p class="normal"><strong class="keyWord">Warning!</strong> If you had to create a named instance, like <code class="inlineCode">apps-services-book</code>, then enter <code class="inlineCode">.\apps-services-book</code>. If you see an error about the server certificate, then click the <strong class="screenText">Options &gt;&gt; </strong> button and select the <strong class="screenText">Trust server certificate</strong> check box.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Navigate to <strong class="screenText">File</strong> | <strong class="screenText">Open</strong> | <strong class="screenText">File...</strong>.</li>
      <li class="numberedList">Browse<a id="_idIndexMarker144"/> to select the <code class="inlineCode">Northwind4SQLServer.sql</code> file and then click <strong class="screenText">Open</strong>.</li>
      <li class="numberedList">In the toolbar, click <strong class="screenText">Execute</strong>, and note the <strong class="screenText">Command(s) completed successfully</strong> message.</li>
      <li class="numberedList">In <strong class="screenText">Object Explorer</strong>, expand the <strong class="screenText">Northwind</strong> database, and then expand <strong class="screenText">Tables</strong>.</li>
      <li class="numberedList">Right-click <strong class="screenText">Products</strong>, click <strong class="screenText">Select Top 1000 Rows</strong>, and note the returned results, as shown in <em class="italic">Figure 2.5</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B19587_02_05.png"/></figure>
    <p class="packt_figref">Figure 2.5: The Products table in SQL Server Management Studio</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="11">In the <strong class="screenText">Object Explorer</strong> toolbar, click the <strong class="screenText">Disconnect</strong> button.</li>
      <li class="numberedList">Exit <strong class="screenText">SQL Server Management Studio</strong>.</li>
    </ol>
    <div><p class="normal">We did not have to use <strong class="screenText">SQL Server Management Studio</strong> to execute the database script. We can also use tools in Visual Studio 2022, including the <strong class="screenText">SQL Server Object Explorer</strong> and <strong class="screenText">Server Explorer</strong>, or cross-platform tools like the Visual Studio Code extension for SQL Server, or <strong class="screenText">Azure Data Studio</strong>, which you can download and install separately from the following link: <a href="https://aka.ms/getazuredatastudio">https://aka.ms/getazuredatastudio</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-90">Setting up Azure SQL Database</h2>
    <p class="normal">If you do <a id="_idIndexMarker145"/>not have a Windows computer, then you can create a cloud-hosted instance of SQL Server. You will need an Azure account. You can sign up at the following link: <a href="https://signup.azure.com">https://signup.azure.com</a>. Next, you need to take the following steps:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Log in to your Azure account: <a href="https://portal.azure.com/">https://portal.azure.com/</a></li>
      <li class="numberedList">Navigate to <a href="https://portal.azure.com/#create/hub">https://portal.azure.com/#create/hub</a>.</li>
      <li class="numberedList">Search for <strong class="screenText">Resource group</strong> and then click the <strong class="screenText">Create</strong> button.</li>
      <li class="numberedList">Enter a resource group name of <code class="inlineCode">apps-services-book</code> and select a suitable region close to you, and then click the <strong class="screenText">Review + create</strong> button, as shown in <em class="italic">Figure 2.6</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_02_06.png"/></figure>
    <p class="packt_figref">Figure 2.6: Creating a resource group in the Azure portal</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Review your choices and then click the <strong class="screenText">Create</strong> button.</li>
      <li class="numberedList">Create another resource, search for <strong class="screenText">SQL Database</strong>, and click <strong class="screenText">Create</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Create SQL Database</strong> page, in the <strong class="screenText">Basics</strong> tab, for the <strong class="screenText">Database name</strong>, enter <code class="inlineCode">Northwind</code>, and select the resource group that you created before.</li>
      <li class="numberedList">In the <strong class="screenText">Server</strong> section, click <strong class="screenText">Create New</strong>.</li>
      <li class="numberedList">Enter<a id="_idIndexMarker146"/> the following details for the SQL Database server, as shown in <em class="italic">Figure 2.7</em>:<ul>
          <li class="bulletList"><strong class="screenText">Server name</strong>: <code class="inlineCode">apps-services-book-[your initials]</code> or something else entirely. The server name must be globally unique because it becomes part of a public URL.</li>
          <li class="bulletList"><strong class="screenText">Location</strong>: A region close to you. I chose <strong class="screenText">(Europe) UK South</strong>. Not all regions support all types of resources. You will see an error if the region you select does not support SQL Database server resources.</li>
          <li class="bulletList"><strong class="screenText">Authentication method</strong>: Use SQL authentication.</li>
          <li class="bulletList"><strong class="screenText">Server admin login</strong>: [Your email or another username], for example, I entered <code class="inlineCode">markjprice</code>.</li>
          <li class="bulletList"><strong class="screenText">Password</strong>/<strong class="screenText">Confirm password</strong>: [Enter a strong password].</li>
        </ul>
      </li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_02_07.png"/></figure>
    <p class="packt_figref">Figure 2.7: Entering the server details for a SQL Database instance</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">Click <strong class="screenText">OK</strong>.</li>
      <li class="numberedList">Leave <strong class="screenText">Want to use SQL elastic pool</strong> set to <strong class="screenText">No</strong>.</li>
      <li class="numberedList">For <strong class="screenText">Workload environment</strong>, select <strong class="screenText">Development</strong> (instead of <strong class="screenText">Production</strong>).</li>
      <li class="numberedList">In the <strong class="screenText">Create SQL Database</strong> page, in the <strong class="screenText">Compute + storage</strong> section, click <strong class="screenText">Configure database</strong>.</li>
      <li class="numberedList">For <strong class="screenText">Service tier</strong>, select <strong class="screenText">Basic (For less demanding workloads)</strong>. Note the maximum<a id="_idIndexMarker147"/> database size is 2 GB and the estimated cost is about $5 per month (or less than 1 cent per hour). You can delete the resources as soon as you have completed this chapter to reduce the cost further.</li>
      <li class="numberedList">Click <strong class="screenText">Apply</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Create SQL Database</strong> page, set <strong class="screenText">Backup storage redundancy</strong> to <strong class="screenText">Locally-redundant backup storage</strong>.</li>
      <li class="numberedList">Click the <strong class="screenText">Next : Networking</strong> button.</li>
      <li class="numberedList">In <a id="_idIndexMarker148"/>the <strong class="screenText">Network connectivity</strong> section, select <strong class="screenText">Public endpoint</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Firewall rules</strong> section, set <strong class="screenText">Add current client IP address</strong> to <strong class="screenText">Yes</strong>.</li>
      <li class="numberedList">Click the <strong class="screenText">Next : Security</strong> button.</li>
      <li class="numberedList">Review the options but leave them as the defaults.</li>
      <li class="numberedList">Click the <strong class="screenText">Next : Additional settings</strong> button.</li>
      <li class="numberedList">Review the options but leave them as the defaults.</li>
      <li class="numberedList">Click the <strong class="screenText">Review + create</strong> button.</li>
      <li class="numberedList">Click the <strong class="screenText">Create</strong> button.</li>
      <li class="numberedList">Wait for the deployment to complete, as shown in <em class="italic">Figure 2.8</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_02_08.png"/></figure>
    <p class="packt_figref">Figure 2.8: Deployment progress for SQL Database</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="27">When deployment has completed, click <strong class="screenText">Go to resource</strong>.</li>
      <li class="numberedList">Click <strong class="screenText">Overview</strong> and note the database details, as shown in <em class="italic">Figure 2.9</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_02_09.png"/></figure>
    <p class="packt_figref">Figure 2.9: SQL Database details</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="29">Click <strong class="screenText">See connection strings</strong> (or click <strong class="screenText">Connection strings</strong> in the left navigation).</li>
      <li class="numberedList">Copy the <strong class="screenText">ADO.NET (SQL authentication)</strong> connection string to your clipboard.</li>
      <li class="numberedList">Start <strong class="screenText">Notepad</strong> or<a id="_idIndexMarker149"/> your preferred plain text editor, paste the connection string, and add carriage returns after each semicolon to separate each part to make them easier to work with, as shown in the following text:
        <pre class="programlisting code"><code class="hljs-code">Server=tcp:apps-services-book.database.windows.net,1433;
Initial Catalog=Northwind;
Persist Security Info=False;
User ID=markjprice;
Password={your_password};
MultipleActiveResultSets=False;
Encrypt=True;
TrustServerCertificate=False;
Connection Timeout=30;
</code></pre>
      
    <div><p class="normal">Your <code class="inlineCode">Server</code> value will be different because the custom server name part, for example, <code class="inlineCode">apps-services-book</code>, is public and must be globally unique.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="32">Optionally, save<a id="_idIndexMarker150"/> the Notepad file for future reference.</li>
    </ol>
    <h3 class="heading-3" id="_idParaDest-91">JetBrains Rider tool window for working with SQL Server</h3>
    <p class="normal">If you use <a id="_idIndexMarker151"/>JetBrains Rider on any operating system, then you can use the following steps to connect with a SQL Server database:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In JetBrains Rider, select <strong class="screenText">View</strong> | <strong class="screenText">Tool Windows</strong> | <strong class="screenText">Database</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Database</strong> tool window, click <strong class="screenText">Connect to database...</strong>.</li>
      <li class="numberedList">Select the <strong class="screenText">Use connection string</strong> option button.</li>
      <li class="numberedList">Set the <strong class="screenText">Database type</strong> to <strong class="screenText">Microsoft SQL Server</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">String</strong> box, enter the database connection string.</li>
      <li class="numberedList">Change <code class="inlineCode">{your_password}</code> to the password you chose.</li>
      <li class="numberedList">Optionally, click <strong class="screenText">Test Connection</strong> and correct any errors if necessary. If you get an <strong class="screenText">Inconsistent language</strong> error, then you can ignore it as we are using SQL Server as the dialect.</li>
      <li class="numberedList">Click <strong class="screenText">Connect to Database</strong>.</li>
    </ol>
    <h3 class="heading-3" id="_idParaDest-92">Creating the Northwind sample database in the cloud</h3>
    <p class="normal">Now we can<a id="_idIndexMarker152"/> run a database script to create the Northwind sample database in the Azure SQL Database:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred database tool to connect to the SQL server in Azure:<ul>
          <li class="bulletList">In Visual Studio 2022, view <strong class="screenText">Server Explorer</strong>.</li>
          <li class="bulletList">On Windows, start <strong class="screenText">SQL Server Management Studio</strong>.</li>
          <li class="bulletList">In Visual Studio Code, view the <strong class="screenText">SQL Server</strong> tool.</li>
          <li class="bulletList">In JetBrains Rider, navigate to <strong class="screenText">View</strong> | <strong class="screenText">Tool Windows</strong> | <strong class="screenText">Database</strong>, and then click <strong class="screenText">Connect to database…</strong>.</li>
        </ul>
      </li>
      <li class="numberedList">Add a data connection, and fill in the dialog box with all the required connection string information, as shown in <em class="italic">Figure 2.10</em>:
    <figure class="mediaobject"><img alt="" src="img/B19587_02_10.png"/></figure>
    <p class="packt_figref">Figure 2.10: Connecting to your Azure SQL database from Visual Studio</p>
    <div><p class="normal">You might also be prompted to <strong class="screenText">Choose</strong> <strong class="screenText">Data Source</strong>. Choose <strong class="screenText">Microsoft SQL Server</strong>. You can select a checkbox to always use this selection.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Right-click<a id="_idIndexMarker153"/> the data connection and choose <strong class="screenText">New Query</strong>.
    <div><p class="normal">If you are using JetBrains Rider, then right-click the SQL Server, in the popup menu, select <strong class="screenText">SQL Scripts</strong> | <strong class="screenText">Run SQL Script…</strong>, and then select the <code class="inlineCode">Northwind4AzureSQLdatabase.sql</code> file.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Copy and paste the contents of the <code class="inlineCode">Northwind4AzureSQLdatabase.sql</code> file into the query window and execute it.<div><p class="normal">The main difference between the <code class="inlineCode">Northwind4SQLServer.sql</code> and <code class="inlineCode">Northwind4AzureSQLdatabase.sql</code> scripts is that the local SQL Server script will delete and recreate the Northwind database. The Azure SQL database script will not because the database needs to be created as an Azure resource. You can download SQL script files from the following link: <a href="https://github.com/markjprice/apps-services-net8/tree/main/scripts/sql-scripts">https://github.com/markjprice/apps-services-net8/tree/main/scripts/sql-scripts</a>.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Wait<a id="_idIndexMarker154"/> to see the <strong class="screenText">Command completed successfully</strong> message. This can take a few minutes.</li>
      <li class="numberedList">In <strong class="screenText">Server Explorer</strong>, right-click <strong class="screenText">Tables</strong> and select <strong class="screenText">Refresh</strong>, and note that 13 tables have been created, for example, <strong class="screenText">Categories</strong>, <strong class="screenText">Customers</strong>, and <strong class="screenText">Products</strong>. Also note that dozens of views and stored procedures have also been created.</li>
    </ol>
    <p class="normal">You now have a running Azure SQL database in the cloud that you can connect to from a .NET project.</p>
    <h1 class="heading-1" id="_idParaDest-93">Managing data with Transact-SQL</h1>
    <p class="normal"><strong class="keyWord">Transact-SQL </strong>(<strong class="keyWord">T-SQL</strong>) is <a id="_idIndexMarker155"/>SQL Server’s dialect of <strong class="keyWord">Structured Query Language </strong>(<strong class="keyWord">SQL</strong>). Some <a id="_idIndexMarker156"/>pronounce it <em class="italic">tee-sequel</em>, others <em class="italic">tee-es-queue-el</em>.</p>
    <p class="normal">Unlike C#, T-SQL is <a id="_idIndexMarker157"/>not case-sensitive; for example, you can use <code class="inlineCode">int</code> or <code class="inlineCode">INT</code> to specify the 32-bit integer data type, and you can use <code class="inlineCode">SELECT</code> or <code class="inlineCode">select</code> to start a query expression. Text data stored in SQL Server tables can be treated as case-sensitive or not, depending on the configuration.</p>
    <div><p class="normal">The complete reference for T-SQL is found at the following link: <a href="https://learn.microsoft.com/en-us/sql/t-sql/language-reference">https://learn.microsoft.com/en-us/sql/t-sql/language-reference</a>. From that documentation starting page, use the left side navigation to view topics like <strong class="keyWord">Data types</strong>, <strong class="keyWord">Queries</strong>, and <strong class="keyWord">Statements</strong>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-94">T-SQL data types</h2>
    <p class="normal">T-SQL has data types<a id="_idIndexMarker158"/> that are used for columns, variables, parameters, and so on, as shown in <em class="italic">Table 2.2</em>:</p>
    <table class="table-container" id="table002-1">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Category</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Examples</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Numbers</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">bigint</code>, <code class="inlineCode">bit</code>, <code class="inlineCode">decimal</code>, <code class="inlineCode">float</code>, <code class="inlineCode">int</code>, <code class="inlineCode">money</code>, <code class="inlineCode">numeric</code>, <code class="inlineCode">real</code>, <code class="inlineCode">smallint</code>, <code class="inlineCode">smallmoney</code>, <code class="inlineCode">tinyint</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Date and time</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">date</code>, <code class="inlineCode">datetime2</code>, <code class="inlineCode">datetime</code>, <code class="inlineCode">datetimeoffset</code>, <code class="inlineCode">smalldatetime</code>, <code class="inlineCode">time</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Text</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">char</code>, <code class="inlineCode">nchar</code>, <code class="inlineCode">ntext</code>, <code class="inlineCode">nvarchar</code>, <code class="inlineCode">text</code>, <code class="inlineCode">varchar</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Binary</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">binary</code>, <code class="inlineCode">image</code>, <code class="inlineCode">varbinary</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Other</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">cursor</code>, <code class="inlineCode">hierarchyid</code>, <code class="inlineCode">sql_variant</code>, <code class="inlineCode">table</code>, <code class="inlineCode">rowversion</code>, <code class="inlineCode">uniqueidentifier</code>, <code class="inlineCode">xml</code></p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 2.2: Categories of SQL Server data types</p>
    <div><p class="normal">There is an <code class="inlineCode">xml</code> data type but no JSON data type. Use <code class="inlineCode">nvarchar</code> to store JSON values. T-SQL also has support for spatial <code class="inlineCode">geometry</code> and <code class="inlineCode">geography</code> types.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-95">Documenting with comments</h2>
    <p class="normal">To<a id="_idIndexMarker159"/> comment out the rest of a line, use <code class="inlineCode">--</code>, which is the equivalent of <code class="inlineCode">//</code>.</p>
    <p class="normal">To comment out a block, use <code class="inlineCode">/*</code> at the start and <code class="inlineCode">*/</code> at the end, just like in C#.</p>
    <h2 class="heading-2" id="_idParaDest-96">Declaring variables</h2>
    <p class="normal">Local variable <a id="_idIndexMarker160"/>names are prefixed with <code class="inlineCode">@</code> and they are defined using <code class="inlineCode">SET</code>, <code class="inlineCode">SELECT</code>, or <code class="inlineCode">DECLARE</code>, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">DECLARE @WholeNumber INT; -- Declare a variable and specify its type.
SET @WholeNumber = 3; -- Set the variable to a literal value.
SET @WholeNumber = @WholeNumber + 1; -- Increment the variable.
SELECT @WholeNumber = COUNT(*) FROM Employees; -- Set to the number of employees.
SELECT @WholeNumber = EmployeeId FROM Employees WHERE FirstName = 'Janet';
</code></pre>
    <p class="normal">Global variables are prefixed with <code class="inlineCode">@@</code>. For example, <code class="inlineCode">@@ROWCOUNT</code> is a context-dependent value that returns the number of rows affected by a statement executed within the current scope, for example, the number of rows updated or deleted.</p>
    <h2 class="heading-2" id="_idParaDest-97">Specifying data types</h2>
    <p class="normal">Most <a id="_idIndexMarker161"/>types have a fixed size. For example, an <code class="inlineCode">int</code> uses four bytes, a <code class="inlineCode">smallint</code> uses two bytes, and a <code class="inlineCode">tinyint</code> uses one byte.</p>
    <p class="normal">For text and binary types, you can either specify a type prefixed with <code class="inlineCode">var</code> or <code class="inlineCode">nvar</code> (meaning variable size), which will automatically change its size based on its current value up to a maximum, as shown in the following example: <code class="inlineCode">varchar(40)</code>; or you can specify a fixed number of characters that will always be allocated, as shown in the following example: <code class="inlineCode">char(40)</code>.</p>
    <p class="normal">For text types, the <code class="inlineCode">n</code> prefix indicates Unicode, meaning it will use two bytes per character. Text types not prefixed with <code class="inlineCode">n</code> use one byte per character.</p>
    <h2 class="heading-2" id="_idParaDest-98">Controlling flow</h2>
    <p class="normal">T-SQL <a id="_idIndexMarker162"/>has similar flow control keywords as C#, for example, <code class="inlineCode">BREAK</code>, <code class="inlineCode">CONTINUE</code>, <code class="inlineCode">GOTO</code>, <code class="inlineCode">IF...ELSE</code>, <code class="inlineCode">CASE</code>, <code class="inlineCode">THROW</code>, <code class="inlineCode">TRY...CATCH</code>, <code class="inlineCode">WHILE</code>, and <code class="inlineCode">RETURN</code>. The main difference is the use of <code class="inlineCode">BEGIN</code> and <code class="inlineCode">END</code> to indicate the start and end of a block, the equivalent of curly braces in C#.</p>
    <h2 class="heading-2" id="_idParaDest-99">Operators</h2>
    <p class="normal">T-SQL has <a id="_idIndexMarker163"/>similar operators as C#, for example, <code class="inlineCode">=</code> (assignment), <code class="inlineCode">+</code>, <code class="inlineCode">-</code>, <code class="inlineCode">*</code>, <code class="inlineCode">/</code>, <code class="inlineCode">%</code>, <code class="inlineCode">&lt;</code>, <code class="inlineCode">&gt;</code>, <code class="inlineCode">&lt;=</code>, <code class="inlineCode">==</code>, <code class="inlineCode">!=</code>, <code class="inlineCode">&amp;</code>, <code class="inlineCode">|</code>, <code class="inlineCode">^</code>, and so on. It has logical operators like <code class="inlineCode">AND</code>, <code class="inlineCode">OR</code>, <code class="inlineCode">NOT</code>, and LINQ-like operators like <code class="inlineCode">ANY</code>, <code class="inlineCode">ALL</code>, <code class="inlineCode">SOME</code>, <code class="inlineCode">EXISTS</code>, <code class="inlineCode">BETWEEN</code>, and <code class="inlineCode">IN</code>.</p>
    <p class="normal"><code class="inlineCode">LIKE</code> is used for text pattern matching. The pattern can use <code class="inlineCode">%</code> for any number of characters. The pattern can use <code class="inlineCode">_</code> for a single character. The pattern can use <code class="inlineCode">[]</code> to specify a range and set of allowed characters, for example, <code class="inlineCode">[0-9A-Z.-,]</code>, which looks like a simplified regular expression syntax but keep in mind that it is <em class="italic">not</em> regular expression syntax.</p>
    <div><p class="normal">If a table or column name contains spaces, then you must surround the name in square brackets, like <code class="inlineCode">[Order Details]</code>. The SQL scripts to create the Northwind database include the command <code class="inlineCode">set quoted_identifier on</code>, so you can also use double quotes, like <code class="inlineCode">"Order Details"</code>. Single quotes are used for literal text, like <code class="inlineCode">'USA'</code>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-100">Data Manipulation Language (DML)</h2>
    <p class="normal">DML <a id="_idIndexMarker164"/>is used to query and change data.</p>
    <p class="normal">The most common statement in DML is <code class="inlineCode">SELECT</code>, which is used to retrieve data from one or more tables. <code class="inlineCode">SELECT</code> is extremely complicated because it is so powerful. This book is not about learning T-SQL, so the quickest way to get a feel for <code class="inlineCode">SELECT</code> is to see some examples, as shown in <em class="italic">Table 2.3</em>:</p>
    <table class="table-container" id="table003-1">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Example</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT * </code></p>
            <p class="normal"><code class="inlineCode">FROM Employees</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Get all columns of all the employees.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT FirstName, LastName </code></p>
            <p class="normal"><code class="inlineCode">FROM Employees</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Get the first and last name columns of all employees.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT emp.FirstName, emp.LastName </code></p>
            <p class="normal"><code class="inlineCode">FROM Employees AS emp</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Give an alias for the table name. Table name prefixes are not needed when there is only one table, but become useful to disambiguate when there are multiple tables that have columns with the same name, for example, <code class="inlineCode">Customers.CustomerId</code> and <code class="inlineCode">Orders.CustomerId</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT emp.FirstName, emp.LastName </code></p>
            <p class="normal"><code class="inlineCode">FROM Employees emp</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Give an alias for the table name without needing the <code class="inlineCode">AS</code> keyword.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT FirstName, LastName AS Surname </code></p>
            <p class="normal"><code class="inlineCode">FROM Employees</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Give an alias for the column name.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT FirstName, LastName </code></p>
            <p class="normal"><code class="inlineCode">FROM Employees</code></p>
            <p class="normal"><code class="inlineCode">WHERE Country = 'USA'</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Filter the results to only include employees in the USA.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT DISTINCT Country</code></p>
            <p class="normal"><code class="inlineCode">FROM Employees</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Get a list of countries used as values in the <code class="inlineCode">Country</code> column of the <code class="inlineCode">Employees</code> table without duplicates.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT UnitPrice * Quantity AS Subtotal</code></p>
            <p class="normal"><code class="inlineCode">FROM [Order Details]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Calculate a subtotal for each order detail row.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT OrderId, </code></p>
            <p class="normal"><code class="inlineCode"> SUM(UnitPrice * Quantity) AS Total</code></p>
            <p class="normal"><code class="inlineCode">FROM [Order Details]</code></p>
            <p class="normal"><code class="inlineCode">GROUP BY OrderId</code></p>
            <p class="normal"><code class="inlineCode">ORDER BY Total DESC</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Calculate a total for each order and sort with the largest order value at the top.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT CompanyName </code></p>
            <p class="normal"><code class="inlineCode">FROM Customers</code></p>
            <p class="normal"><code class="inlineCode">UNION</code></p>
            <p class="normal"><code class="inlineCode">SELECT CompanyName </code></p>
            <p class="normal"><code class="inlineCode">FROM Suppliers</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Return all the company names of all customers and suppliers.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT CategoryName, ProductName</code></p>
            <p class="normal"><code class="inlineCode">FROM Categories, Products</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Match <em class="italic">every</em> category with <em class="italic">every</em> product using a Cartesian join and output their names (not what you normally want!).</p>
            <p class="normal">616 rows (8 categories x 77 products).</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT CategoryName, ProductName</code></p>
            <p class="normal"><code class="inlineCode">FROM Categories c, Products p</code></p>
            <p class="normal"><code class="inlineCode">WHERE c.CategoryId = p.CategoryId</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Match each product with its category using a <code class="inlineCode">WHERE</code> clause for the <code class="inlineCode">CategoryId</code> column in each table and output the category name and product name.</p>
            <p class="normal">77 rows.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SELECT CategoryName, ProductName</code></p>
            <p class="normal"><code class="inlineCode">FROM Categories c</code></p>
            <p class="normal"><code class="inlineCode">INNER JOIN Products p</code></p>
            <p class="normal"><code class="inlineCode">ON c.CategoryId = p.CategoryId</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Match each product with its category using an <code class="inlineCode">INNER JOIN...ON</code> clause for the <code class="inlineCode">CategoryId</code> column in each table and output the category name and product name. This is a modern alternative syntax to using <code class="inlineCode">WHERE</code>, and it allows outer joins, which would also include non-matches.</p>
            <p class="normal">77 rows.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 2.3: Example SELECT statements with descriptions</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can read the full documentation for <code class="inlineCode">SELECT</code> at the following link: <a href="https://learn.microsoft.com/en-us/sql/t-sql/queries/select-transact-sql">https://learn.microsoft.com/en-us/sql/t-sql/queries/select-transact-sql</a>.</p>
    </div>
    <p class="normal">Use your <a id="_idIndexMarker165"/>favorite database querying tool, like Visual Studio’s <strong class="screenText">Server Explorer</strong> or Visual Studio Code’s <code class="inlineCode">mssql</code> extension, to connect to your Northwind database and try out some of the queries above, as shown in <em class="italic">Figure 2.11</em> and <em class="italic">Figure 2:12</em>:</p>
    <figure class="mediaobject"><img alt="" src="img/B19587_02_11.png"/></figure>
    <p class="packt_figref">Figure 2.11: Executing T-SQL queries using Visual Studio’s Server Explorer</p>
    <figure class="mediaobject"><img alt="" src="img/B19587_02_12.png"/></figure>
    <p class="packt_figref">Figure 2.12: Executing T-SQL queries using Visual Studio Code’s mssql extension</p>
    <h2 class="heading-2" id="_idParaDest-101">DML for adding, updating, and deleting data</h2>
    <p class="normal">DML statements<a id="_idIndexMarker166"/> for adding, updating, and <a id="_idIndexMarker167"/>deleting data<a id="_idIndexMarker168"/> include those shown in <em class="italic">Table 2.4</em>:</p>
    <table class="table-container" id="table004-1">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Example</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">INSERT Employees(FirstName, LastName)</code></p>
            <p class="normal"><code class="inlineCode">VALUES('Mark', 'Price')</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Add a new row to the <code class="inlineCode">Employees</code> table. The <code class="inlineCode">EmployeeId</code> primary key value is automatically assigned. Use <code class="inlineCode">@@IDENTITY</code> to get this value.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">UPDATE Employees</code></p>
            <p class="normal"><code class="inlineCode">SET Country = 'UK'</code></p>
            <p class="normal"><code class="inlineCode">WHERE FirstName = 'Mark' </code></p>
            <p class="normal"><code class="inlineCode"> AND LastName = 'Price'</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Update my employee row to set my <code class="inlineCode">Country</code> to <code class="inlineCode">UK</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">DELETE Employees</code></p>
            <p class="normal"><code class="inlineCode">WHERE FirstName = 'Mark' </code></p>
            <p class="normal"><code class="inlineCode"> AND LastName = 'Price'</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Delete my employee row.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">DELETE Employees</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Delete all rows in the <code class="inlineCode">Employees</code> table and record those deletions in the transaction log.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">TRUNCATE TABLE Employees</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Delete all rows in the <code class="inlineCode">Employees</code> table more efficiently because it does not log the individual row deletions.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 2.4: Example DML statements with descriptions</p>
    <div><p class="normal">The above examples use the <code class="inlineCode">Employees</code> table in the <code class="inlineCode">Northwind</code> database. That table has referential integrity constraints that would mean that, for example, deleting all rows in the table cannot happen because every employee has related data in other tables like <code class="inlineCode">Orders</code>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-102">Data Definition Language (DDL)</h2>
    <p class="normal">DDL statements<a id="_idIndexMarker169"/> change the structure of the database, including creating new objects like tables, functions, and stored procedures. The following table shows some examples of DDL statements to give you an idea, but the examples are simple and cannot be executed within the <a id="_idIndexMarker170"/>Northwind database, as shown in <em class="italic">Table 2.5</em>:</p>
    <table class="table-container" id="table005-1">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Example</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">CREATE TABLE dbo.Shippers (</code></p>
            <p class="normal"><code class="inlineCode"> ShipperId INT PRIMARY KEY CLUSTERED,</code></p>
            <p class="normal"><code class="inlineCode"> CompanyName NVARCHAR(40)</code></p>
            <p class="normal"><code class="inlineCode">);</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Create a table to store shippers.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">ALTER TABLE Shippers</code></p>
            <p class="normal"><code class="inlineCode">ADD Country NVARCHAR(40)</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Add a column to a table.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">CREATE NONCLUSTERED INDEX IX_Country</code></p>
            <p class="normal"><code class="inlineCode">ON Shippers(Country)</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Add a non-clustered index for a column in a table.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">CREATE INDEX IX_FullName</code></p>
            <p class="normal"><code class="inlineCode">ON Employees(LastName, FirstName DESC)</code></p>
            <p class="normal"><code class="inlineCode">WITH (DROP_EXISTING = ON)</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Change an aggregate index with multiple columns and control the sort order.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">DROP TABLE Employees</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Delete the <code class="inlineCode">Employees</code> table. If it does not exist, then this throws an error.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">DROP TABLE IF EXISTS Employees</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Delete the <code class="inlineCode">Employees</code> table if it already exists. This avoids the potential error from using the statement in the previous row.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">IF OBJECT_ID(N'Employees', N'U') </code></p>
            <p class="normal"><code class="inlineCode"> IS NOT NULL</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Check if a table exists. The <code class="inlineCode">N</code> prefix before a text literal means Unicode. <code class="inlineCode">'U'</code> means a user table as opposed to a system table.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 2.5: Example DDL statements with descriptions</p>
    <h1 class="heading-1" id="_idParaDest-103">Managing data with low-level APIs</h1>
    <p class="normal">The <code class="inlineCode">Microsoft.Data.SqlClient</code> package provides database connectivity to SQL Server for .NET applications. It <a id="_idIndexMarker171"/>is also known as the <strong class="keyWord">ADO.NET driver for SQL Server</strong> and<a id="_idIndexMarker172"/> Azure SQL Database.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can find the GitHub repository for ADO.NET at the following link: <a href="https://github.com/dotnet/SqlClient">https://github.com/dotnet/SqlClient</a>.</p>
    </div>
    <p class="normal">The <code class="inlineCode">Microsoft.Data.SqlClient</code> package supports the following .NET platforms:</p>
    <ul>
      <li class="bulletList">.NET Framework 4.6.2 and later.</li>
      <li class="bulletList">.NET Core 3.1 and later.</li>
      <li class="bulletList">.NET Standard 2.0 and later.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-104">Understanding the types in ADO.NET</h2>
    <p class="normal">ADO.NET <a id="_idIndexMarker173"/>defines abstract types that represent minimal objects for working with data, like <code class="inlineCode">DbConnection</code>, <code class="inlineCode">DbCommand</code>, and <code class="inlineCode">DbDataReader</code>. Database software manufacturers can inherit from and provide specific implementations that are optimized for and expose additional features for their database. Microsoft has done this for SQL Server. The most important types with their most used members are shown in <em class="italic">Table 2.6</em>:</p>
    <table class="table-container" id="table006-1">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Type</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Properties</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Methods</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SqlConnection</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">ConnectionString</code>, </p>
            <p class="normal"><code class="inlineCode">State</code>, </p>
            <p class="normal"><code class="inlineCode">ServerVersion</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Open</code>, <code class="inlineCode">Close</code>, </p>
            <p class="normal"><code class="inlineCode">CreateCommand</code>, </p>
            <p class="normal"><code class="inlineCode">RetrieveStatistics</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Manage the connection to the database.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SqlConnectionStringBuilder</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">InitialCatalog</code>,<code class="inlineCode"> DataSource</code>,<code class="inlineCode"> Encrypt</code>, <code class="inlineCode">UserID</code>, <code class="inlineCode">Password</code>, <code class="inlineCode">ConnectTimeout</code>, and so on</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Clear</code>,<code class="inlineCode"> ContainsKey</code>, <code class="inlineCode">Remove</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Build a valid connection string for a SQL Server database.</p>
            <p class="normal">After setting all the relevant individual properties, get the <code class="inlineCode">ConnectionString</code> property.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SqlCommand</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Connection, </code></p>
            <p class="normal"><code class="inlineCode">CommandType, </code></p>
            <p class="normal"><code class="inlineCode">CommandText, </code></p>
            <p class="normal"><code class="inlineCode">Parameters, </code></p>
            <p class="normal"><code class="inlineCode">Transaction</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">ExecuteReader</code>, </p>
            <p class="normal"><code class="inlineCode">ExecuteNonQuery</code>, </p>
            <p class="normal"><code class="inlineCode">ExecuteXmlReader</code>, </p>
            <p class="normal"><code class="inlineCode">CreateParameter</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Configure the command to execute.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SqlParameter</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">ParameterName</code>, </p>
            <p class="normal"><code class="inlineCode">Value</code>, <code class="inlineCode">DbType, </code></p>
            <p class="normal"><code class="inlineCode">SqlValue</code>, </p>
            <p class="normal"><code class="inlineCode">SqlDbType, </code></p>
            <p class="normal"><code class="inlineCode">Direction</code>, </p>
            <p class="normal"><code class="inlineCode">IsNullable</code></p>
          </td>
          <td class="table-cell"/>
          <td class="table-cell">
            <p class="normal">Configure a parameter for a command.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SqlDataReader</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">FieldCount</code>, </p>
            <p class="normal"><code class="inlineCode">HasRows</code>,</p>
            <p class="normal"><code class="inlineCode">IsClosed</code>, </p>
            <p class="normal"><code class="inlineCode">RecordsAffected</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Read</code>, <code class="inlineCode">Close</code>, </p>
            <p class="normal"><code class="inlineCode">GetOrdinal</code>, </p>
            <p class="normal"><code class="inlineCode">GetInt32</code>, <code class="inlineCode">GetString</code>, </p>
            <p class="normal"><code class="inlineCode">GetDecimal</code>,</p>
            <p class="normal"><code class="inlineCode">GetFieldValue&lt;T&gt;</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Process the result set from executing a query.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 2.6: Important types in ADO.NET SqlClient</p>
    <p class="normal"><code class="inlineCode">SqlConnection</code> has two useful events: <code class="inlineCode">StateChange</code> and <code class="inlineCode">InfoMessage</code>. </p>
    <p class="normal">All the <code class="inlineCode">ExecuteXxx</code> methods of <code class="inlineCode">SqlCommand</code> will execute any command. The one you use depends <a id="_idIndexMarker174"/>on what you expect to get back:</p>
    <ul>
      <li class="bulletList">If the command includes at least one <code class="inlineCode">SELECT</code> statement that returns a result set, then call <code class="inlineCode">ExecuteReader</code> to execute the command. This method returns a <code class="inlineCode">DbDataReader</code>-derived object for reading row-by-row through the result set.</li>
      <li class="bulletList">If the command does not include at least one <code class="inlineCode">SELECT</code> statement, then it is more efficient to call <code class="inlineCode">ExecuteNonQuery</code>. This method returns an integer for the number of rows affected.</li>
      <li class="bulletList">If the command includes at least one <code class="inlineCode">SELECT</code> statement that returns XML because it uses the <code class="inlineCode">AS XML</code> command, then call <code class="inlineCode">ExecuteXmlReader</code> to execute the command.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-110">Creating a console app for working with ADO.NET</h2>
    <p class="normal">First, we will create<a id="_idIndexMarker175"/> a console app project for working with ADO.NET:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to create a console app project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Console App</strong> / <code class="inlineCode">console</code>.</li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter02</code>.</li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Console.SqlClient</code>.</li>
          <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared.</li>
          <li class="bulletList"><strong class="screenText">Enable native AOT publish</strong>: Cleared.</li>
        </ul>
      
    <div><p class="normal"><strong class="keyWord">Good Practice:</strong> For all the projects that you create for this book, keep your root path short and avoid using <code class="inlineCode">#</code> in your folder and file names, or you might see compiler errors like <code class="inlineCode">RSG002: TargetPath not specified for additional file</code>. For example, do <em class="italic">not</em> use <code class="inlineCode">C:\My C# projects\</code> as your root path!</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">In the<a id="_idIndexMarker176"/> project file, treat warnings as errors, add a package reference for the latest version of <code class="inlineCode">Microsoft.Data.SqlClient</code>, and statically and globally import <code class="inlineCode">System.Console</code>, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;Project Sdk="Microsoft.NET.Sdk"&gt;
  &lt;PropertyGroup&gt;
    &lt;OutputType&gt;Exe&lt;/OutputType&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
<strong class="hljs-slc">    &lt;TreatWarningsAsErrors&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/TreatWarningsAsErrors&gt;</strong>
  &lt;/PropertyGroup&gt;
<strong class="hljs-slc">  &lt;ItemGroup&gt;</strong>
<strong class="hljs-slc">    &lt;PackageReference Include=</strong><strong class="hljs-string-slc">"Microsoft.Data.SqlClient"</strong><strong class="hljs-slc"> Version=</strong><strong class="hljs-string-slc">"5.1.2"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong>
<strong class="hljs-slc">  &lt;ItemGroup&gt;</strong>
<strong class="hljs-slc">    &lt;Using Include=</strong><strong class="hljs-string-slc">"System.Console"</strong><strong class="hljs-slc"> Static=</strong><strong class="hljs-string-slc">"true"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong>
&lt;/Project&gt;
</code></pre>
      
    <div><p class="normal">You can check the most recent version of the package at the following link: <a href="https://www.nuget.org/packages/Microsoft.Data.SqlClient#versions-body-tab">https://www.nuget.org/packages/Microsoft.Data.SqlClient#versions-body-tab</a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Build the project to restore the referenced package.</li>
      <li class="numberedList">Add <a id="_idIndexMarker177"/>a new class file named <code class="inlineCode">Program.Helpers.cs</code>, and modify its contents to define a method to configure the console to enable special characters like the Euro currency symbol and set the current culture, and a method that will output some text to the console in a specified color, with a default color of black, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using System.Globalization; // To use CultureInfo.
partial class Program
{
  private static void ConfigureConsole(string culture = "en-US",
    bool useComputerCulture = false)
  {
    // To enable Unicode characters like Euro symbol in the console.
    OutputEncoding = System.Text.Encoding.UTF8;
    if (!useComputerCulture)
    {
      CultureInfo.CurrentCulture = CultureInfo.GetCultureInfo(culture);
    }
    WriteLine($"CurrentCulture: {CultureInfo.CurrentCulture.DisplayName}");
  }
  private static void WriteLineInColor(string value, 
    ConsoleColor color = ConsoleColor.White)
  {
    ConsoleColor previousColor = ForegroundColor;
    ForegroundColor = color;
    WriteLine(value);
    ForegroundColor = previousColor;
  }
}
</code></pre>
      
    <div><p class="normal">The default foreground color in the preceding code is white because I have assumed that most readers will have a default background color of black. On my computer, I set the default background color of the console to white so that I can take screenshots for this book. Set whatever default color is best for your computer.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Add a <a id="_idIndexMarker178"/>new class file named <code class="inlineCode">Program.EventHandlers.cs</code>, and modify its contents to define methods that will act as event handlers for a database connection state change by showing the original and current states, and for when the database sends an <code class="inlineCode">InfoMessage</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Data.SqlClient; // To use SqlInfoMessageEventArgs.
using System.Data; // To use StateChangeEventArgs.
partial class Program
{
  private static void Connection_StateChange(
    object sender, StateChangeEventArgs e)
  {
    WriteLineInColor(
      $"State change from {e.OriginalState} to {e.CurrentState}.",
      ConsoleColor.DarkYellow);
  }
  private static void Connection_InfoMessage(
    object sender, SqlInfoMessageEventArgs e)
  {
    WriteLineInColor($"Info: {e.Message}.", ConsoleColor.DarkBlue);
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, delete the existing statements. Add statements to connect to SQL Server locally, to Azure SQL Database, or to SQL Edge, using either SQL authentication with a user ID and password or Windows Authentication without a user ID and password, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Data.SqlClient; // To use SqlConnection and so on.
ConfigureConsole();
#region Set up the connection string builder
SqlConnectionStringBuilder builder = new()
{
  InitialCatalog = "Northwind",
  MultipleActiveResultSets = true,
  Encrypt = true,
  TrustServerCertificate = true,
  ConnectTimeout = 10 // Default is 30 seconds.
};
WriteLine("Connect to:");
WriteLine("  1 - SQL Server on local machine");
WriteLine("  2 - Azure SQL Database");
WriteLine("  3 – Azure SQL Edge");
WriteLine();
Write("Press a key: ");
ConsoleKey key = ReadKey().Key;
WriteLine(); WriteLine();
switch (key)
{
  case ConsoleKey.D1 or ConsoleKey.NumPad1:
    builder.DataSource = ".";
    break;
  case ConsoleKey.D2 or ConsoleKey.NumPad2:
    builder.DataSource = 
      // Use your Azure SQL Database server name.
      "tcp:apps-services-book.database.windows.net,1433";
    break;
  case ConsoleKey.D3 or ConsoleKey.NumPad3:
    builder.DataSource = "tcp:127.0.0.1,1433";
    break;
  default:
    WriteLine("No data source selected.");
    return;
}
WriteLine("Authenticate using:");
WriteLine("  1 – Windows Integrated Security");
WriteLine("  2 – SQL Login, for example, sa");
WriteLine();
Write("Press a key: ");
key = ReadKey().Key;
WriteLine(); WriteLine();
if (key is ConsoleKey.D1 or ConsoleKey.NumPad1)
{
  builder.IntegratedSecurity = true;
}
else if (key is ConsoleKey.D2 or ConsoleKey.NumPad2)
{
  Write("Enter your SQL Server user ID: ");
  string? userId = ReadLine();
  if (string.IsNullOrWhiteSpace(userId))
  {
    WriteLine("User ID cannot be empty or null.");
    return;
  }
  builder.UserID = userId;
  Write("Enter your SQL Server password: ");
  string? password = ReadLine();
  if (string.IsNullOrWhiteSpace(password))
  {
    WriteLine("Password cannot be empty or null.");
    return;
  }
  builder.Password = password;
  builder.PersistSecurityInfo = false;
}
else
{
  WriteLine("No authentication selected.");
  return;
}
#endregion
#region Create and open the connection
SqlConnection connection = new(builder.ConnectionString);
WriteLine(connection.ConnectionString);
WriteLine();
connection.StateChange += Connection_StateChange;
connection.InfoMessage += Connection_InfoMessage;
try
{
  WriteLine("Opening connection. Please wait up to {0} seconds...", 
    builder.ConnectTimeout);
  WriteLine();
  connection.Open();
  WriteLine($"SQL Server version: {connection.ServerVersion}");
}
catch (SqlException ex)
{
  WriteLineInColor($"SQL exception: {ex.Message}", 
    ConsoleColor.Red);
  return;
}
#endregion
connection.Close();
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: In this coding task, we prompt the user to enter the password to connect to the database. In a real-world app you are more likely to store the password in an environment variable or secure storage like Azure Key Vault. You must definitely never store passwords in your source code!</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Run<a id="_idIndexMarker179"/> the console app, select options that work with your SQL Server setup, and note the results, including the state change event output written in dark yellow to make them easier to see, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Connect to:
  1 - SQL Server on local machine
  2 - Azure SQL Database
  3 - Azure SQL Edge
Press a key: 1
Authenticate using:
  1 - Windows Integrated Security
  2 - SQL Login, for example, sa
Press a key: 1
Data Source=.;Initial Catalog=Northwind;Integrated Security=True;Multiple Active Result Sets=True;Connect Timeout=10;Encrypt=True;Trust Server Certificate=True
Opening connection. Please wait up to 10 seconds...
State change from Closed to Open.
SQL Server version: 15.00.2101
State change from Open to Closed.
</code></pre>
      
    <div><p class="normal">The following steps show the experience when connecting to Azure SQL Database or Azure SQL Edge, which require a username and password. If you are connecting to a local SQL Server using Windows Integrated Security, then you will not need to enter a password.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">Run<a id="_idIndexMarker180"/> the console app, select choices that require a user ID and password, for example, with Azure SQL Database, and note the result, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Enter your SQL Server user ID: markjprice
Enter your SQL Server password: [censored]
Data Source=tcp:apps-services-book.database.windows.net,1433;Initial Catalog=Northwind;Persist Security Info=False;User ID=markjprice;Password=[censored];Multiple Active Result Sets=True;Connect Timeout=10;Encrypt=True;Trust Server Certificate=True
Opening connection. Please wait up to 10 seconds...
State change from Closed to Open.
SQL Server version: 12.00.5168
State change from Open to Closed.
</code></pre>
      </li>
      <li class="numberedList">Run the console app, select choices that require a user ID and password, enter a wrong password, and note the result, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Enter your SQL Server user ID: markjprice
Enter your SQL Server password: 123456
Data Source=tcp:apps-services-book.database.windows.net,1433;Initial Catalog=Northwind;Persist Security Info=False;User ID=markjprice;Password=123456;Multiple Active Result Sets=True;Connect Timeout=10;Encrypt=True;Trust Server Certificate=True
Opening connection. Please wait up to 10 seconds...
SQL exception: Login failed for user 'markjprice'.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, change the server name (the <code class="inlineCode">DataSource</code> property) to something wrong.</li>
      <li class="numberedList">Run the <a id="_idIndexMarker181"/>console app and note the result (depending on where your database is hosted, the exception message might be slightly different), as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">SQL exception: A network-related or instance-specific error occurred while establishing a connection to SQL Server. The server was not found or was not accessible. Verify that the instance name is correct and that SQL Server is configured to allow remote connections. (provider: TCP Provider, error: 0 - No such host is known.)
</code></pre>
      </li>
    </ol>
    <div><p class="normal">When opening a SQL Server connection, the default timeout is 30 seconds for server connection problems, so be patient! We changed the timeout to 10 seconds to avoid having to wait so long.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-111">Executing queries and working with data readers using ADO.NET</h2>
    <p class="normal">Now that <a id="_idIndexMarker182"/>we have a successful <a id="_idIndexMarker183"/>connection to the SQL Server database, we can run commands that retrieve rows from a table and process the results using a data reader:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Program.cs</code>, import the namespace for working with ADO.NET command types, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using System.Data; // To use CommandType.
</code></pre>
        <div><p class="normal"><strong class="keyWord">Good Practice</strong>: To save space in this book, I will use the names <code class="inlineCode">cmd</code> and <code class="inlineCode">r</code> to represent an SQL command and an SQL data reader. In your code, give variables proper word names like <code class="inlineCode">command</code> and <code class="inlineCode">reader</code>.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Before the statement that closes the connection, add statements to define a command that selects the ID, name, and price from the <code class="inlineCode">Products</code> table, executes it, and outputs the product IDs, names, and prices using a data reader, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">SqlCommand cmd = connection.CreateCommand();
cmd.CommandType = CommandType.Text;
cmd.CommandText = "SELECT ProductId, ProductName, UnitPrice FROM Products";
SqlDataReader r = cmd.ExecuteReader();
string horizontalLine = new string('-', 60);
WriteLine(horizontalLine);
WriteLine("| {0,5} | {1,-35} | {2,10} |", 
  arg0: "Id", arg1: "Name", arg2: "Price");
WriteLine(horizontalLine);
while (r.Read())
{
  WriteLine("| {0,5} | {1,-35} | {2,10:C} |",
    r.GetInt32("ProductId"), 
    r.GetString("ProductName"),
    r.GetDecimal("UnitPrice"));
}
WriteLine(horizontalLine);
r.Close();
</code></pre>
      
    <div><p class="normal">We format the unit price using the <code class="inlineCode">C</code> format, which uses the current culture to format currency values. The call to <code class="inlineCode">ConfigureConsole</code> sets the current culture to US English so the output for all readers uses <code class="inlineCode">$</code>. To test alternative cultures like French that use the Euro currency symbol, modify the call at the top of the <code class="inlineCode">Program.cs</code> file, as shown in the following code: <code class="inlineCode">ConfigureConsole("fr-FR");</code>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Run<a id="_idIndexMarker184"/> the console app <a id="_idIndexMarker185"/>and note the results, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">----------------------------------------------------------
|    Id | Name                                |    Price |
----------------------------------------------------------
|     1 | Chai                                |   $18.00 |
|     2 | Chang                               |   $19.00 |
...
|    76 | Lakkalikööri                        |   $18.00 |
|    77 | Original Frankfurter grüne Soße     |   $13.00 |
----------------------------------------------------------
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, modify the SQL statement to define a parameter for the unit price and use it to filter the results to products that cost more than that unit price, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">Write(</strong><strong class="hljs-string-slc">"Enter a unit price: "</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc">? priceText = ReadLine();</strong>
<strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc">(!</strong><strong class="hljs-built_in-slc">decimal</strong><strong class="hljs-slc">.TryParse(priceText, </strong><strong class="hljs-keyword-slc">out</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">decimal</strong><strong class="hljs-slc"> price))</strong>
<strong class="hljs-slc">{</strong>
<strong class="hljs-slc">  WriteLine(</strong><strong class="hljs-string-slc">"You must enter a valid unit price."</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">}</strong>
SqlCommand cmd = connection.CreateCommand();
cmd.CommandType = CommandType.Text;
cmd.CommandText = "SELECT ProductId, ProductName, UnitPrice FROM Products" 
<strong class="hljs-slc">  + </strong><strong class="hljs-string-slc">" WHERE UnitPrice &gt;= @minimumPrice</strong>";
<strong class="hljs-slc">cmd.Parameters.AddWithValue(</strong><strong class="hljs-string-slc">"minimumPrice"</strong><strong class="hljs-slc">, price);</strong>
</code></pre>
      </li>
      <li class="numberedList">Run the <a id="_idIndexMarker186"/>console app, enter a unit price like <code class="inlineCode">50</code>, and note the results, as shown in the following <a id="_idIndexMarker187"/>partial output:
        <pre class="programlisting con"><code class="hljs-con">Enter a unit price: 50
----------------------------------------------------------
|    Id | Name                                |    Price |
----------------------------------------------------------
|     9 | Mishi Kobe Niku                     |   $97.00 |
|    18 | Carnarvon Tigers                    |   $62.50 |
|    20 | Sir Rodney's Marmalade              |   $81.00 |
|    29 | Thüringer Rostbratwurst             |  $123.79 |
|    38 | Côte de Blaye                       |  $263.50 |
|    51 | Manjimup Dried Apples               |   $53.00 |
|    59 | Raclette Courdavault                |   $55.00 |
----------------------------------------------------------
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-112">Outputting statistics</h2>
    <p class="normal">An ADO.NET connection can <a id="_idIndexMarker188"/>track useful statistics during its lifetime, including those listed in <em class="italic">Table 2.7</em>:</p>
    <table class="table-container" id="table007-1">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Key</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">BuffersReceived</code>, <code class="inlineCode">BuffersSent</code>, <code class="inlineCode">BytesReceived</code>, <code class="inlineCode">BytesSent</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Data is transmitted as bytes stored in buffers.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">CursorOpens</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Cursors are an expensive operation because they require state on the server, and should be avoided when possible.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Prepares</code>, <code class="inlineCode">PreparedExecs</code>, <code class="inlineCode">UnpreparedExecs</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Number of prepares (compilations), executions of prepared commands, and executions of unprepared commands.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">SelectCount</code>, <code class="inlineCode">SelectRows</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Number of <code class="inlineCode">SELECT</code> statements and rows returned by <code class="inlineCode">SELECT</code> statements.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">ServerRoundtrips</code>, <code class="inlineCode">SumResultSets</code>, <code class="inlineCode">Transactions</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Number of server round trips, result sets, and transactions.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">ConnectionTime</code>, <code class="inlineCode">ExecutionTime</code>, <code class="inlineCode">NetworkServerTime</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Time in milliseconds spent connected, executing commands, or due to the network.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 2.7: Connection statistics that can be tracked</p>
    <p class="normal">Let’s enable this and<a id="_idIndexMarker189"/> output some of those statistics:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Program.Helpers.cs</code>, import the namespaces for working with ADO.NET and common collections, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Data.SqlClient; // To use SqlConnection.
using System.Collections; // To use IDictionary.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.Helpers.cs</code>, in the partial <code class="inlineCode">Program</code> class, add a method to output statistics about the current connection, with an array of string values to control which of the dozen or more statistics we want to output, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">private static void OutputStatistics(SqlConnection connection)
{
  // Remove all the string values to see all the statistics.
  string[] includeKeys = { 
    "BytesSent", "BytesReceived", "ConnectionTime", "SelectRows" 
  };
  IDictionary statistics = connection.RetrieveStatistics();
  foreach (object? key in statistics.Keys)
  {
    if (!includeKeys.Any() || includeKeys.Contains(key))
    {
      if (int.TryParse(statistics[key]?.ToString(), out int value))
      {
        WriteLineInColor($"{key}: {value:N0}", ConsoleColor.Cyan);
      }
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after <a id="_idIndexMarker190"/>writing the SQL Server version to the console, add a statement to enable statistics for the connection, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">WriteLine($"SQL Server version: {connection.ServerVersion}");
<strong class="hljs-slc">connection.StatisticsEnabled = </strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">;</strong>
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, before closing the connection, add a statement to output statistics for the connection, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">OutputStatistics(connection);</strong>
connection.Close();
</code></pre>
      </li>
      <li class="numberedList">Run the console app and note the statistics, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">BytesReceived: 3,888
BytesSent: 336
SelectRows: 77
ExecutionTime: 25
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-113">Working with ADO.NET asynchronously</h2>
    <p class="normal">You can improve the<a id="_idIndexMarker191"/> responsiveness of data access code by making it asynchronous. You will see more details of how asynchronous operations work in <em class="chapterRef">Chapter 5</em>,<em class="chapterRef"> </em><em class="italic">Multitasking and Concurrency</em>. For now, just enter the code as instructed.</p>
    <p class="normal">Let’s see how to change the statements to work asynchronously:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Program.cs</code>, change the statement to open the connection to make it asynchronous, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">await</strong> connection.Open<strong class="hljs-slc">Async</strong>();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, change the statement to execute the command to make it asynchronous, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">SqlDataReader r = <strong class="hljs-keyword-slc">await</strong> cmd.ExecuteReader<strong class="hljs-slc">Async</strong>();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, change <a id="_idIndexMarker192"/>the statements to read the next row and get the field values to make them asynchronous, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">while (<strong class="hljs-keyword-slc">await</strong> r.Read<strong class="hljs-slc">Async</strong>())
{
  WriteLine("| {0,5} | {1,-35} | {2,8:C} |",
    <strong class="hljs-keyword-slc">await</strong> r.Get<strong class="hljs-slc">FieldValueAsync&lt;</strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc">&gt;</strong>("ProductId"),
    <strong class="hljs-keyword-slc">await</strong> r.Get<strong class="hljs-slc">FieldValueAsync&lt;</strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc">&gt;</strong>("ProductName"),
    <strong class="hljs-keyword-slc">await</strong> r.Get<strong class="hljs-slc">FieldValueAsync&lt;</strong><strong class="hljs-built_in-slc">decimal</strong><strong class="hljs-slc">&gt;</strong>("UnitPrice"));
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, change the statements to close the data reader and connection to make them asynchronous, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">await</strong> r.Close<strong class="hljs-slc">Async</strong>();
<strong class="hljs-keyword-slc">await</strong> connection.Close<strong class="hljs-slc">Async</strong>();
</code></pre>
      </li>
      <li class="numberedList">Run the console app and confirm that it has the same results as before, but it would run better in a multithreaded system, for example, not blocking the user interface in a GUI app, and not blocking I/O threads in a website.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-114">Executing stored procedures using ADO.NET</h2>
    <p class="normal">If you <a id="_idIndexMarker193"/>need to execute the same query or another SQL statement multiple times, it is best to create a <strong class="keyWord">stored procedure</strong>, often with parameters, so that it can be precompiled and optimized. Stored procedure parameters have a direction to indicate if they are inputs, outputs, or return values.</p>
    <p class="normal">Let’s see an example that uses all three types of parameter direction. First, we will create the stored procedure in the database:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In your preferred database tool, connect to the <code class="inlineCode">Northwind</code> database.</li>
      <li class="numberedList">In your preferred database tool, add a new stored procedure:<ul>
          <li class="bulletList">If you are using <strong class="screenText">SQL Server Management Studio</strong>, then in <strong class="screenText">Object Explorer</strong>, navigate to <strong class="screenText">Databases</strong> | <strong class="screenText">Northwind</strong> | <strong class="screenText">Programmability</strong>, right-click <strong class="screenText">Stored Procedures</strong>, and select <strong class="screenText">New</strong> | <strong class="screenText">Stored Procedure</strong>.</li>
          <li class="bulletList">If you are using Visual Studio 2022, then in <strong class="screenText">Server Explorer</strong>, right-click <strong class="screenText">Stored Procedures</strong> and select <strong class="screenText">Add New Stored Procedure</strong>.</li>
          <li class="bulletList">If you are using Visual Studio Code, then in <strong class="screenText">SQL Server</strong>, right-click your connection profile and select <strong class="screenText">New Query</strong>.</li>
          <li class="bulletList">If you are using JetBrains Rider, then in the <strong class="screenText">Database</strong> toolbar, click the <strong class="screenText">Jump to Query Console…</strong> button, and then remove any existing statements. As well as the following SQL statements, start with a command to set the active database to Northwind: <code class="inlineCode">USE Northwind GO</code>. This should prevent JetBrains Rider from creating the stored procedure in the <code class="inlineCode">master</code> database!</li>
        </ul>
      </li>
      <li class="numberedList">Modify <a id="_idIndexMarker194"/>the SQL statements to define a stored procedure named <code class="inlineCode">GetExpensiveProducts</code> with two parameters, an input parameter for the minimum unit price and an output parameter for the row count of matching products, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">CREATE PROCEDURE [dbo].[GetExpensiveProducts]
  @price money,
  @count int OUT
AS
  PRINT 'Getting expensive products: ' + 
    TRIM(CAST(@price AS NVARCHAR(10)))
  SELECT @count = COUNT(*)
  FROM Products
	WHERE UnitPrice &gt;= @price
  SELECT * 
  FROM Products
  WHERE UnitPrice &gt;= @price
RETURN 0
</code></pre>
      
    <div><p class="normal">The stored procedure uses two <code class="inlineCode">SELECT</code> statements. The first sets the <code class="inlineCode">@count</code> output parameter to a count of the matching product rows. The second returns the matching product rows. It also calls the <code class="inlineCode">PRINT</code> command, which will raise the <code class="inlineCode">InfoMessage</code> event.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Right-click <a id="_idIndexMarker195"/>in the SQL statements and select <strong class="screenText">Execute</strong> or <strong class="screenText">Execute Query</strong>.</li>
      <li class="numberedList">Right-click <strong class="screenText">Stored Procedures</strong> and select <strong class="screenText">Refresh</strong>. In JetBrains Rider, it is named <strong class="screenText">routines</strong>.</li>
      <li class="numberedList">Expand <strong class="screenText">GetExpensiveProducts</strong> and note the <code class="inlineCode">@price money</code> input, <code class="inlineCode">@count int</code> input/output, and return value parameters, as shown in <strong class="screenText">SQL Server Management Studio</strong> in <em class="italic">Figure 2.13</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_02_13.png"/></figure>
    <p class="packt_figref">Figure 2.13: Parameters of the GetExpensiveProducts stored procedure </p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Close the SQL query without saving changes.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, add statements to allow the user to choose between running the text command and the stored procedure. Add statements defining the stored procedure and its parameters, and then execute the command, as shown <a id="_idIndexMarker196"/>highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">SqlCommand cmd = connection.CreateCommand();
<strong class="hljs-slc">WriteLine(</strong><strong class="hljs-string-slc">"Execute command using:"</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">WriteLine(</strong><strong class="hljs-string-slc">"  1 - Text"</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">WriteLine(</strong><strong class="hljs-string-slc">"  2 - Stored Procedure"</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">WriteLine();</strong>
<strong class="hljs-slc">Write(</strong><strong class="hljs-string-slc">"Press a key: "</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">key = ReadKey().Key;</strong>
<strong class="hljs-slc">WriteLine(); WriteLine();</strong>
<strong class="hljs-slc">SqlParameter p1, p2 = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">(), p3 = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">();</strong>
<strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (key </strong><strong class="hljs-keyword-slc">is</strong><strong class="hljs-slc"> ConsoleKey.D1 </strong><strong class="hljs-keyword-slc">or</strong><strong class="hljs-slc"> ConsoleKey.NumPad1)</strong>
<strong class="hljs-slc">{</strong>
  cmd.CommandType = CommandType.Text;
  cmd.CommandText = "SELECT ProductId, ProductName, UnitPrice FROM Products"
    + " WHERE UnitPrice &gt;= @minimumPrice";
  cmd.Parameters.AddWithValue("minimumPrice", price);
<strong class="hljs-slc">}</strong>
<strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (key </strong><strong class="hljs-keyword-slc">is</strong><strong class="hljs-slc"> ConsoleKey.D2 </strong><strong class="hljs-keyword-slc">or</strong><strong class="hljs-slc"> ConsoleKey.NumPad2)</strong>
<strong class="hljs-slc">{</strong>
<strong class="hljs-slc">  cmd.CommandType = CommandType.StoredProcedure;</strong>
<strong class="hljs-slc">  cmd.CommandText = </strong><strong class="hljs-string-slc">"GetExpensiveProducts"</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">  p1 = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">()</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    ParameterName = </strong><strong class="hljs-string-slc">"price"</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">    SqlDbType = SqlDbType.Money,</strong>
<strong class="hljs-slc">    SqlValue = price</strong>
<strong class="hljs-slc">  };</strong>
<strong class="hljs-slc">  p2 = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">()</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    Direction = ParameterDirection.Output,</strong>
<strong class="hljs-slc">    ParameterName = </strong><strong class="hljs-string-slc">"count"</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">    SqlDbType = SqlDbType.Int</strong>
<strong class="hljs-slc">  };</strong>
<strong class="hljs-slc">  p3 = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">()</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    Direction= ParameterDirection.ReturnValue,</strong>
<strong class="hljs-slc">    ParameterName = </strong><strong class="hljs-string-slc">"rv"</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">    SqlDbType = SqlDbType.Int</strong>
<strong class="hljs-slc">  };</strong>
<strong class="hljs-slc">  cmd.Parameters.AddRange(</strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">[] { p1, p2, p3 });</strong>
<strong class="hljs-slc">}</strong>
SqlDataReader r = await cmd.ExecuteReaderAsync();
</code></pre>
      </li>
      <li class="numberedList">After<a id="_idIndexMarker197"/> the statement that closes the data reader, add statements to output the output parameter and the return value, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">await r.CloseAsync();
<strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (key </strong><strong class="hljs-keyword-slc">is</strong><strong class="hljs-slc"> ConsoleKey.D2 </strong><strong class="hljs-keyword-slc">or</strong><strong class="hljs-slc"> ConsoleKey.NumPad2)</strong>
<strong class="hljs-slc">{</strong>
<strong class="hljs-slc">  WriteLine(</strong><strong class="hljs-string-slc">$"Output count: </strong><strong class="hljs-subst-slc">{p2.Value}</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">  WriteLine(</strong><strong class="hljs-string-slc">$"Return value: </strong><strong class="hljs-subst-slc">{p3.Value}</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">}</strong>
await connection.CloseAsync();
</code></pre>
      
    <div><p class="normal">If a stored procedure returns result sets as well as parameters, then the data reader for the result sets must be closed before the parameters can be read.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">Run the console app and note the results if the price entered is <code class="inlineCode">60</code>, and note the <code class="inlineCode">InfoMessage</code> event handler writes a message in dark blue, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Enter a unit price: 60
Execute command using:
  1 - Text
  2 - Stored Procedure
Press a key: 2
Info: Getting expensive products: 60.00.
----------------------------------------------------------
|    Id | Name                                |    Price |
----------------------------------------------------------
|     9 | Mishi Kobe Niku                     |   $97.00 |
|    18 | Carnarvon Tigers                    |   $62.50 |
|    20 | Sir Rodney's Marmalade              |   $81.00 |
|    29 | Thüringer Rostbratwurst             |  $123.79 |
|    38 | Côte de Blaye                       |  $263.50 |
----------------------------------------------------------
Output count: 5
Return value: 0
State change from Open to Closed.
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-115">Outputting streams with a data reader</h2>
    <p class="normal">In a real app or<a id="_idIndexMarker198"/> service, we would likely not output to the console. More likely, as we read each row with a data reader, we might output to a stream that writes HTML tags inside a web page, or text formats like XML and JSON for returning data from a service.</p>
    <p class="normal">Let’s add the ability to generate a JSON file:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Program.cs</code>, import the namespace for working efficiently with JSON and to statically import the <code class="inlineCode">Environment</code> and <code class="inlineCode">Path</code> classes, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using System.Text.Json; // To use Utf8JsonWriter, JsonSerializer.
using static System.Environment;
using static System.IO.Path;
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, before the <code class="inlineCode">while</code> statement that processes the data reader, add statements to define a file path for a JSON file, create a file stream, and start a JSON array, then in the <code class="inlineCode">while</code> block, write a JSON object that represents each product row, and finally, end the array and close the stream, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-comment-slc">// Define a file path to write to.</strong>
<strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc"> jsonPath = Combine(CurrentDirectory, </strong><strong class="hljs-string-slc">"products.json"</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> (FileStream jsonStream = File.Create(jsonPath))</strong>
<strong class="hljs-slc">{</strong>
<strong class="hljs-slc">  Utf8JsonWriter jsonWriter = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">(jsonStream);</strong>
<strong class="hljs-slc">  jsonWriter.WriteStartArray();</strong>
  while (await r.ReadAsync())
  {
    WriteLine("| {0,5} | {1,-35} | {2,10:C} |",
      await r.GetFieldValueAsync&lt;int&gt;("ProductId"),
      await r.GetFieldValueAsync&lt;string&gt;("ProductName"),
      await r.GetFieldValueAsync&lt;decimal&gt;("UnitPrice"));
<strong class="hljs-slc">    jsonWriter.WriteStartObject();</strong>
<strong class="hljs-slc">    jsonWriter.WriteNumber(</strong><strong class="hljs-string-slc">"productId"</strong><strong class="hljs-slc">, </strong>
<strong class="hljs-slc">      </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> r.GetFieldValueAsync&lt;</strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc">&gt;(</strong><strong class="hljs-string-slc">"ProductId"</strong><strong class="hljs-slc">));</strong>
<strong class="hljs-slc">    jsonWriter.WriteString(</strong><strong class="hljs-string-slc">"productName"</strong><strong class="hljs-slc">, </strong>
<strong class="hljs-slc">      </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> r.GetFieldValueAsync&lt;</strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc">&gt;(</strong><strong class="hljs-string-slc">"ProductName"</strong><strong class="hljs-slc">));</strong>
<strong class="hljs-slc">    jsonWriter.WriteNumber(</strong><strong class="hljs-string-slc">"unitPrice"</strong><strong class="hljs-slc">, </strong>
<strong class="hljs-slc">      </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> r.GetFieldValueAsync&lt;</strong><strong class="hljs-built_in-slc">decimal</strong><strong class="hljs-slc">&gt;(</strong><strong class="hljs-string-slc">"UnitPrice"</strong><strong class="hljs-slc">));</strong>
<strong class="hljs-slc">    jsonWriter.WriteEndObject();</strong>
  }
<strong class="hljs-slc">  jsonWriter.WriteEndArray();</strong>
<strong class="hljs-slc">  jsonWriter.Flush();</strong>
<strong class="hljs-slc">  jsonStream.Close();</strong>
<strong class="hljs-slc">}</strong>
<strong class="hljs-slc">WriteLineInColor(</strong><strong class="hljs-string-slc">$"Written to: </strong><strong class="hljs-subst-slc">{jsonPath}</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-slc">, ConsoleColor.DarkGreen);</strong>
</code></pre>
      </li>
      <li class="numberedList">Run <a id="_idIndexMarker199"/>the console app, enter a price of <code class="inlineCode">60</code>, and note the path to the JSON file, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Written to: C:\apps-services-net8\Chapter02\Northwind.Console.SqlClient\bin\Debug\net8.0\products.json
</code></pre>
      </li>
      <li class="numberedList">Open the <code class="inlineCode">products.json</code> file and note that the JSON is written with no whitespace, so it all appears on one line, as shown in the following file:
        <pre class="programlisting code"><code class="hljs-code">[{"productId":9,"productName":"Mishi Kobe Niku","unitPrice":97.0000},{"productId":18,"productName":"Carnarvon Tigers","unitPrice":62.5000},{"productId":20,"productName":"Sir Rodney\u0027s Marmalade","unitPrice":81.0000},{"productId":29,"productName":"Th\u00FCringer Rostbratwurst","unitPrice":123.7900},{"productId":38,"productName":"C\u00F4te de Blaye","unitPrice":263.5000}]
</code></pre>
      </li>
      <li class="numberedList">If you <a id="_idIndexMarker200"/>are using Visual Studio 2022, then you can right-click and select <strong class="screenText">Format Document</strong>, and note that it is now easier to read, as shown in <em class="italic">Figure 2.14</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_02_14.png"/></figure>
    <p class="packt_figref">Figure 2.14: The products.json file generated from a data reader</p>
    <h2 class="heading-2" id="_idParaDest-116">Generating objects with a data reader</h2>
    <p class="normal">For <a id="_idIndexMarker201"/>maximum flexibility, we likely want to convert the rows in a data reader into object instances stored in an array or collection. After that, we could serialize the object graph however we want. ADO.NET does not have a built-in ability to map a data reader row to an object, so we will have to do it manually.</p>
    <p class="normal">Let’s see an example:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Add a <a id="_idIndexMarker202"/>new class file named <code class="inlineCode">Product.cs</code>, and modify its contents to define a class to represent just the three columns we want from each row in the <code class="inlineCode">Products</code> table, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.Models;
public class Product
{
  public int ProductId { get; set; }
  public string? ProductName { get; set; }
  public decimal? UnitPrice { get; set; }
}
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: In this task, we will use this type only for read-only instances, so we could have used an immutable <code class="inlineCode">record</code>. But later we will need to change property values after the object is created, so we have to define a <code class="inlineCode">class</code> instead.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">At the top of <code class="inlineCode">Program.cs</code>, import the <code class="inlineCode">Northwind.Models</code> namespace so we can use <code class="inlineCode">Product</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, before creating the file stream, instantiate a list of products with an initial storage for 77 items (but this is not a limit) because when first created the Northwind database has 77 products, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">List&lt;Product&gt; products = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">(capacity: </strong><strong class="hljs-number-slc">77</strong><strong class="hljs-slc">);</strong>
await using (FileStream jsonStream = File.Create(jsonPath))
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">while</code> block, add statements to instantiate the <code class="inlineCode">Product</code> type per row in the data reader and add it to the list, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">while (await r.ReadAsync())
{
<strong class="hljs-slc">  Product product = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">()</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    ProductId = </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> r.GetFieldValueAsync&lt;</strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc">&gt;(</strong><strong class="hljs-string-slc">"ProductId"</strong><strong class="hljs-slc">),</strong>
<strong class="hljs-slc">    ProductName = </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> r.GetFieldValueAsync&lt;</strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc">&gt;(</strong><strong class="hljs-string-slc">"ProductName"</strong><strong class="hljs-slc">),</strong>
<strong class="hljs-slc">    UnitPrice = </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> r.GetFieldValueAsync&lt;</strong><strong class="hljs-built_in-slc">decimal</strong><strong class="hljs-slc">&gt;(</strong><strong class="hljs-string-slc">"UnitPrice"</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">  };</strong>
<strong class="hljs-slc">  products.Add(product);</strong>
  ...
}
</code></pre>
      </li>
      <li class="numberedList">Before <a id="_idIndexMarker203"/>closing the data reader, add a statement to use the static <code class="inlineCode">Serialize</code> method of the <code class="inlineCode">JsonSerializer</code> class to write the list of products to the console, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">WriteLineInColor(JsonSerializer.Serialize(products),</strong>
<strong class="hljs-slc">  ConsoleColor.Magenta);</strong>
await r.CloseAsync();
</code></pre>
      </li>
      <li class="numberedList">Run the console app, enter a price of <code class="inlineCode">60</code>, and note the JSON generated from the list of products, as shown in the following output:
        <pre class="programlisting code"><code class="hljs-code">Written to: C:\apps-services-net8\Chapter02\Northwind.Console.SqlClient\bin\Debug\net8.0\products.json
[{"ProductId":9,"ProductName":"Mishi Kobe Niku","UnitPrice":97.0000},{"ProductId":18,"ProductName":"Carnarvon Tigers","UnitPrice":62.5000},{"ProductId":20,"ProductName":"Sir Rodney\u0027s Marmalade","UnitPrice":81.0000},{"ProductId":29,"ProductName":"Th\u00FCringer Rostbratwurst","UnitPrice":123.7900},{"ProductId":38,"ProductName":"C\u00F4te de Blaye","UnitPrice":263.5000}]
</code></pre>
      </li>
    </ol>
    <p class="normal">Instead of manually instantiating objects, to simplify even more, we can use a simple <strong class="keyWord">object-relational mapper </strong>(<strong class="keyWord">ORM</strong>) like Dapper.</p>
    <h1 class="heading-1" id="_idParaDest-117">Managing data with Dapper</h1>
    <p class="normal">Dapper <a id="_idIndexMarker204"/>uses ADO.NET underneath when working<a id="_idIndexMarker205"/> with SQL Server. Because it is a higher-level technology, it is not as efficient as using ADO.NET directly, but it can be easier. Dapper is an alternative ORM to EF Core. It is more efficient because it extends the low-level ADO.NET <code class="inlineCode">IDbConnection</code> interface with very basic functionality without trying to be all things to all people.</p>
    <h2 class="heading-2" id="_idParaDest-118">Dapper connection extension methods</h2>
    <p class="normal">Dapper adds<a id="_idIndexMarker206"/> three extension methods to any class that implements <code class="inlineCode">IDbConnection</code> (like <code class="inlineCode">SqlConnection</code>). They are <code class="inlineCode">Query&lt;T&gt;</code>, <code class="inlineCode">Query</code>, and <code class="inlineCode">Execute</code>. Dapper will automatically open and close the associated connection as needed.</p>
    <p class="normal">The <code class="inlineCode">Query&lt;T&gt;</code> extension method is the most used because it runs any specified SQL command and then returns the results as an <code class="inlineCode">IEnumerable&lt;T&gt;</code> (a sequence of objects). It is designed to run commands that retrieve data like <code class="inlineCode">SELECT</code>. It has several parameters, as shown in <em class="italic">Table 2.8</em>:</p>
    <table class="table-container" id="table008">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Parameter</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">string sql</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This is the only mandatory parameter. It is either the text of a SQL command or the name of a stored procedure.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">object param = null</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">A complex object for passing parameters used in the query. This can be an anonymous type.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">IDbTransaction transaction = null</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">To manage distributed transactions.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">bool buffered = true</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">By default, it will buffer the entire reader on return. With large datasets, you can minimize memory and only load objects as needed by setting <code class="inlineCode">buffered</code> to <code class="inlineCode">false</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">int? commandTimeout = null</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">To change the default command timeout.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">CommandType? commandType = null)</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">To switch to a stored procedure instead of the default of text.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 2.8: Dapper’s Query&lt;T&gt; extension method parameters</p>
    <p class="normal">The <code class="inlineCode">Query</code> extension method is a loosely-typed equivalent so it is less frequently used.</p>
    <p class="normal">The <code class="inlineCode">Execute</code> extension method runs any specified SQL command and then returns the number of rows affected as an <code class="inlineCode">int</code>. It is designed to run commands like <code class="inlineCode">INSERT</code>, <code class="inlineCode">UPDATE</code>, and <code class="inlineCode">DELETE</code>. It has the same parameters as the <code class="inlineCode">Query&lt;T&gt;</code> extension method.</p>
    <h2 class="heading-2" id="_idParaDest-119">Querying using Dapper</h2>
    <p class="normal">Let’s see a<a id="_idIndexMarker207"/> simple example that queries the <code class="inlineCode">Suppliers</code> table instead of the <code class="inlineCode">Products</code> table:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Console.SqlClient</code> project, add a package reference for <code class="inlineCode">Dapper</code>, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference Include="Microsoft.Data.SqlClient" Version="5.1.2" /&gt;
<strong class="hljs-slc">  &lt;PackageReference Include=</strong><strong class="hljs-string-slc">"Dapper"</strong><strong class="hljs-slc"> Version=</strong><strong class="hljs-string-slc">"2.1.21"</strong><strong class="hljs-slc"> /&gt;</strong>
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal">At the time of writing, the latest version of Dapper is 2.1.21, released on November 11, 2023. You can check if it has been updated since then at the following link: <a href="https://www.nuget.org/packages/Dapper">https://www.nuget.org/packages/Dapper</a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Build the project to restore packages.</li>
      <li class="numberedList">Add a new class file named <code class="inlineCode">Supplier.cs</code>, and modify its contents to define a class to represent four columns from each row in the <code class="inlineCode">Suppliers</code> table, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.Models;
public class Supplier
{
  public int SupplierId { get; set; }
  public string? CompanyName { get; set; }
  public string? City { get; set; }
  public string? Country { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">At the bottom of <code class="inlineCode">Program.cs</code>, add statements to retrieve <code class="inlineCode">Supplier</code> entities in <code class="inlineCode">Germany</code>, enumerate the collection outputting basic information about each one, and then serialize the collection as JSON to the console, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">WriteLineInColor("Using Dapper", ConsoleColor.DarkGreen);
connection.ResetStatistics(); // So we can compare using Dapper.
IEnumerable&lt;Supplier&gt; suppliers = connection.Query&lt;Supplier&gt;(
  sql: "SELECT * FROM Suppliers WHERE Country=@Country",
  param: new { Country = "Germany" });
foreach (Supplier s in suppliers)
{
  WriteLine("{0}: {1}, {2}, {3}",
    s.SupplierId, s.CompanyName, s.City, s.Country);
}
WriteLineInColor(JsonSerializer.Serialize(suppliers),
  ConsoleColor.Green);
OutputStatistics(connection);
</code></pre>
      </li>
      <li class="numberedList">Run the <a id="_idIndexMarker208"/>console app, and in the section where we used Dapper, note the same connection was used, so its events were raised while the Dapper query was executed, the enumerated collection output, and then JSON generated from the list of suppliers, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Using Dapper
11: Heli Süßwaren GmbH &amp; Co. KG, Berlin, Germany
12: Plutzer Lebensmittelgroßmärkte AG, Frankfurt, Germany
13: Nord-Ost-Fisch Handelsgesellschaft mbH, Cuxhaven, Germany
[{"SupplierId":11,  "CompanyName":"Heli S\u00FC\u00DFwaren GmbH \u0026 Co. KG",
  "City":"Berlin","Country":"Germany"},
 {"SupplierId":12,
  "CompanyName":"Plutzer Lebensmittelgro\u00DFm\u00E4rkte AG",
  "City":"Frankfurt","Country":"Germany"},
 {"SupplierId":13,
  "CompanyName":"Nord-Ost-Fisch Handelsgesellschaft mbH",
  "City":"Cuxhaven","Country":"Germany"}]
BytesReceived: 1,430
BytesSent: 240
SelectRows: 3
ExecutionTime: 5
</code></pre>
      </li>
      <li class="numberedList">At the bottom of <code class="inlineCode">Program.cs</code>, add statements to run the <code class="inlineCode">GetExpensiveProducts</code> stored procedure, passing a <code class="inlineCode">price</code> parameter value of <code class="inlineCode">100</code>, enumerate the collection outputting basic information about each one, and<a id="_idIndexMarker209"/> then serialize the collection as JSON to the console, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">IEnumerable&lt;Product&gt; productsFromDapper = 
  connection.Query&lt;Product&gt;(sql: "GetExpensiveProducts",
  param: new { price = 100M, count = 0 }, 
  commandType: CommandType.StoredProcedure);
foreach (Product p in productsFromDapper)
{
  WriteLine("{0}: {1}, {2}",
    p.ProductId, p.ProductName, p.UnitPrice);
}
WriteLineInColor(JsonSerializer.Serialize(productsFromDapper),
  ConsoleColor.Green);
</code></pre>
      </li>
    </ol>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> With Dapper, you must pass a <code class="inlineCode">param</code> object with all parameters, even if they are only used as output parameters. For example, we must define <code class="inlineCode">count</code>, or an exception will be thrown. You must also remember to explicitly set the command type to stored procedure!</p>
    </div>
    <p class="normal">Run the console app, and in the section where we used Dapper to run the stored procedure to get the products that cost more than 100, note the same connection was used so its events were raised while the Dapper query was executed, the enumerated collection output, and then JSON generated from the list of products, as shown in the following output:</p>
    <pre class="programlisting con"><code class="hljs-con">Info: Getting expensive products: 100.00.
29: Thüringer Rostbratwurst, 123.7900
38: Côte de Blaye, 263.5000
[{"ProductId":29,"ProductName":"Th\u00FCringer Rostbratwurst","UnitPrice":123.7900},{"ProductId":38,"ProductName":"C\u00F4te de Blaye","UnitPrice":263.5000}]
</code></pre>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn more about Dapper at the following link: <a href="https://github.com/DapperLib/Dapper/blob/main/Readme.md">https://github.com/DapperLib/Dapper/blob/main/Readme.md</a>.</p>
    </div>
    <h1 class="heading-1" id="_idParaDest-120">Cleaning up data resources</h1>
    <p class="normal">When you <a id="_idIndexMarker210"/>are done with a SQL Server database, you can clean up the resources used.</p>
    <div><p class="normal">The Northwind database is used in most chapters of this book so if you plan to immediately continue with more chapters after this one, do not delete Northwind yet! If you created the database on your local computer, then you can leave it forever.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-121">Removing Azure resources</h2>
    <p class="normal">To remove <a id="_idIndexMarker211"/>the resources used by SQL Database to save costs:</p>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> If you do not remove the resources used by an Azure SQL database, then you will incur costs.</p>
    </div>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the Azure portal, find the resource group named <code class="inlineCode">apps-services-book</code>.</li>
      <li class="numberedList">Click <strong class="screenText">Delete</strong>.</li>
      <li class="numberedList">Enter the name of the resource group.</li>
      <li class="numberedList">Click <strong class="screenText">Delete</strong>.</li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-122">Practicing and exploring</h1>
    <p class="normal">Test your knowledge and understanding by answering some questions, getting some hands-on practice, and exploring this chapter’s topics with deeper research.</p>
    <h2 class="heading-2" id="_idParaDest-123">Exercise 2.1 – Test your knowledge</h2>
    <p class="normal">Answer the following questions:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Which NuGet package should you reference in a .NET project to get the best performance when working with data in SQL Server?</li>
      <li class="numberedList">What is the safest way to define a database connection string?</li>
      <li class="numberedList">What must T-SQL parameters and variables be prefixed with?</li>
      <li class="numberedList">What must you do before reading an output parameter?</li>
      <li class="numberedList">What type does Dapper add its extension methods to?</li>
      <li class="numberedList">What are the two most commonly used extension methods provided by Dapper?</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-124">Exercise 2.2 – Explore topics</h2>
    <p class="normal">Use the links on the following page to learn more details about the topics covered in this chapter:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-2---managing-relational-data-using-sql-server">https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-2---managing-relational-data-using-sql-server</a></p>
    <h2 class="heading-2" id="_idParaDest-125">Exercise 2.3 – Alternatives for storing secrets</h2>
    <p class="normal">Secrets like passwords and other values used in database connection strings, or values like keys to access a service, are often stored in environment variables. Other places for storing these values include App Secrets. You can learn more about them in the article <em class="italic">Safe storage of app secrets in development in ASP.NET Core</em>, found at the following link:</p>
    <p class="normal"><a href="https://learn.microsoft.com/en-us/aspnet/core/security/app-secrets">https://learn.microsoft.com/en-us/aspnet/core/security/app-secrets</a></p>
    <p class="normal">For related guidance about handling connection strings, you can read the following link:</p>
    <p class="normal"><a href="https://learn.microsoft.com/en-us/ef/core/miscellaneous/connection-strings">https://learn.microsoft.com/en-us/ef/core/miscellaneous/connection-strings</a></p>
    <h1 class="heading-1" id="_idParaDest-126">Summary</h1>
    <p class="normal">In this chapter, you learned:</p>
    <ul>
      <li class="bulletList">How to connect to an existing SQL Server database.</li>
      <li class="bulletList">How to execute a simple query and process the results using fast and low-level ADO.NET.</li>
      <li class="bulletList">How to execute a simple query and process the results using Dapper.</li>
    </ul>
    <p class="normal">In the next chapter, you will learn how to use the more powerful and complex ORM from Microsoft named EF Core.</p>
  </div>
</body></html>