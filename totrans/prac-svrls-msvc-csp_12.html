<html><head></head><body>
<div id="_idContainer232">
<h1 class="chapterNumber"><a id="_idTextAnchor345"/><span class="koboSpan" id="kobo.1.1">12</span></h1>
<h1 class="chapterTitle" id="_idParaDest-244"><a id="_idTextAnchor346"/><span class="koboSpan" id="kobo.2.1">Simplifying Microservices with .NET Aspire</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">.NET Aspire was conceived to simplify the testing of interacting microservices on development machines. </span><span class="koboSpan" id="kobo.3.2">In the </span><em class="italic"><span class="koboSpan" id="kobo.4.1">Running your microservices on Kubernetes</span></em><span class="koboSpan" id="kobo.5.1"> section of </span><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.6.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.7.1">, </span><em class="italic"><span class="koboSpan" id="kobo.8.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.9.1">, we listed two testing techniques we can adopt on our development machines:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">Testing the interacting microservices with minikube while debugging each single microservice with the bridge technique</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Exploiting Visual Studio native support for Docker to debug and test our microservices while they interact through a Docker virtual network</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.12.1">While the minikube technique is complete and more realistic, it is time-consuming, so most of the testing/debugging is performed with Docker virtual networks.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.13.1">.NET Aspire provides a simpler alternative to the direct usage of Docker networks. </span><span class="koboSpan" id="kobo.13.2">Moreover, it offers a simple way to configure the interaction between microservices and between each microservice and other resources. </span><span class="koboSpan" id="kobo.13.3">Finally, .NET Aspire projects can be compiled to produce instructions to both deploy all microservices on Azure Container Apps and to create some of the resources that they use on Azure. </span><span class="koboSpan" id="kobo.13.4">However, its main usage is in development and staging environments and it should not be used for automatically setting up actual production environments since it doesn’t handle all deployment options.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.14.1">In this chapter, we will describe the basics of .NET Aspire together with all the services and opportunities it offers. </span><span class="koboSpan" id="kobo.14.2">More specifically, this chapter covers the following:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.15.1">.NET Aspire features and services</span></li>
<li class="bulletList"><a id="_idTextAnchor347"/><span class="koboSpan" id="kobo.16.1">Configuring microservices and resources</span></li>
<li class="bulletList"><a id="_idTextAnchor348"/><span class="koboSpan" id="kobo.17.1">Using .NET Aspire in practice</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.18.1">Deploying a .NET Aspire project</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-245"><a id="_idTextAnchor349"/><span class="koboSpan" id="kobo.19.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.20.1">This chapter requires the following:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.21.1">Visual </span><a id="_idIndexMarker968"/><span class="koboSpan" id="kobo.22.1">Studio 2022 free </span><em class="italic"><span class="koboSpan" id="kobo.23.1">Community Edition</span></em><span class="koboSpan" id="kobo.24.1">, at least.</span></li>
<li class="numberedList"><strong class="keyWord"><span class="koboSpan" id="kobo.25.1">Docker Desktop</span></strong><span class="koboSpan" id="kobo.26.1"> for Windows (</span><a href="https://www.docker.com/products/docker-desktop"><span class="url"><span class="koboSpan" id="kobo.27.1">https://www.docker.com/products/docker-desktop</span></span></a><span class="koboSpan" id="kobo.28.1">), which, in turn, requires Windows Subsystem for Linux (WSL), which can be installed by following these steps:</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.29.1">Type </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.30.1">powershell</span></code><span class="koboSpan" id="kobo.31.1"> in the Windows 10/11 search bar.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.32.1">When Windows PowerShell is proposed as a search result, click on </span><strong class="screenText"><span class="koboSpan" id="kobo.33.1">Run as an administrator</span></strong><span class="koboSpan" id="kobo.34.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.35.1">In the Windows PowerShell administrative console that appears, run the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.36.1">wsl --install</span></code><span class="koboSpan" id="kobo.37.1"> command.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.38.1">You can find the sample code for this chapter at </span><a href="https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp"><span class="url"><span class="koboSpan" id="kobo.39.1">https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp</span></span></a><span class="koboSpan" id="kobo.40.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-246"><a id="_idTextAnchor350"/><span class="koboSpan" id="kobo.41.1">.NET Aspire features and services</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.42.1">.NET Aspire takes care of the microservices interaction and offers other services, as follows:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.43.1">It handles </span><a id="_idIndexMarker969"/><span class="koboSpan" id="kobo.44.1">the interaction with environment resources such as databases and message brokers in a very simple way. </span><span class="koboSpan" id="kobo.44.2">You don’t need to specify a connection string that might change when the microservice is deployed; it is enough that you declare the interaction between a microservice and a resource together with some general configuration. </span><span class="koboSpan" id="kobo.44.3">This is done with a .NET </span><a id="_idIndexMarker970"/><span class="koboSpan" id="kobo.45.1">feature called </span><strong class="keyWord"><span class="koboSpan" id="kobo.46.1">local service discovery</span></strong><span class="koboSpan" id="kobo.47.1">, which will be discussed in detail in the </span><em class="italic"><span class="koboSpan" id="kobo.48.1">Service discovery and its role in .NET Aspire</span></em><span class="koboSpan" id="kobo.49.1"> subsection.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.50.1">It offers simulators of cloud services, together with common disk and in-memory databases and message brokers.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.51.1">The interaction between microservices and other resources is configured declaratively in a dedicated .NET project, thus avoiding the usage of virtual addresses and connection strings inside the microservices code.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.52.1">Once a .NET Aspire project is run, all microservices and resources are run, and interactions among microservices and resources are automatically handled.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.53.1">While microservices are run in the development environment, both logs and statistics are collected.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.54.1">As soon as a .NET Aspire project is run, a smart console appears in the browser that shows all collected statistics and logs, together with the links to access all microservice endpoints.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.55.1">Interactions </span><a id="_idIndexMarker971"/><span class="koboSpan" id="kobo.56.1">between microservices and between microservices and other resources are declared in a special type of project called App Host. </span><span class="koboSpan" id="kobo.56.2">You can find the App Host project and all other Aspire templates by typing </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.57.1">Aspire</span></code><span class="koboSpan" id="kobo.58.1"> in the Visual Studio search box, as shown in the following figure:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.59.1"><img alt="Figure 12.1: Aspire projects and solution templates" src="../Images/B31916_12_1.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.60.1">Figure 12.1: Aspire projects and solution templates</span></p>
<p class="normal"><span class="koboSpan" id="kobo.61.1">Another Aspire-specific </span><a id="_idIndexMarker972"/><span class="koboSpan" id="kobo.62.1">project type is the .NET Aspire Service Defaults project, which provides extension methods to configure various services. </span><span class="koboSpan" id="kobo.62.2">In order to ensure that some basic services are configured in the same way in all microservices, we define them in this project and then call their extension methods in the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.63.1">Program.cs</span></code><span class="koboSpan" id="kobo.64.1"> configuration of all microservice projects. </span><span class="koboSpan" id="kobo.64.2">Accordingly, all microservices must add a reference to this project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.65.1">As a default, all Aspire templates configure the following service defaults:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.66.1">HttpClient</span></code><span class="koboSpan" id="kobo.67.1"> service discovery: In the App Host configuration, microservices and resources are given names, and thanks to this configuration, </span><code class="inlineCode"><span class="koboSpan" id="kobo.68.1">HttpClient</span></code><span class="koboSpan" id="kobo.69.1"> can use virtual URLs based on these names instead of the actual resource URLs, which might depend </span><a id="_idIndexMarker973"/><span class="koboSpan" id="kobo.70.1">on where the resources are deployed in the various environments (development, staging, production, etc.).</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.71.1">HttpClient</span></code><span class="koboSpan" id="kobo.72.1"> resiliency: Each </span><code class="inlineCode"><span class="koboSpan" id="kobo.73.1">HttpClient</span></code><span class="koboSpan" id="kobo.74.1"> call is automatically applied to all policies, as discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.75.1">Resilient task execution </span></em><span class="koboSpan" id="kobo.76.1">subsection of</span><em class="italic"> </em><a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic"><span class="koboSpan" id="kobo.77.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.78.1">, </span><em class="italic"><span class="koboSpan" id="kobo.79.1">Demystifying Microservices Applications</span></em><span class="koboSpan" id="kobo.80.1">. </span><span class="koboSpan" id="kobo.80.2">More specifically, retry, circuit break, timeout, and rate-limiting (bulkhead isolation) strategies are automatically applied and </span><a id="_idIndexMarker974"/><span class="koboSpan" id="kobo.81.1">can be configured once and for all in the </span><strong class="keyWord"><span class="koboSpan" id="kobo.82.1">.NET Aspire Service Defaults</span></strong><span class="koboSpan" id="kobo.83.1"> project.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.84.1">OpenTelemetry, which will be discussed in a dedicated subsection.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.85.1">Public endpoints exposing microservice health conditions. </span><span class="koboSpan" id="kobo.85.2">Health checks are used both by the App Host orchestrator and by staging and production orchestrators such as Kubernetes (see the </span><em class="italic"><span class="koboSpan" id="kobo.86.1">Readiness, liveness, and startup probes</span></em><span class="koboSpan" id="kobo.87.1"> subsection of </span><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.88.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.89.1">, </span><em class="italic"><span class="koboSpan" id="kobo.90.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.91.1">). </span><span class="koboSpan" id="kobo.91.2">Two default endpoints are provided: </span><code class="inlineCode"><span class="koboSpan" id="kobo.92.1">/health</span></code><span class="koboSpan" id="kobo.93.1">, which returns a </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.94.1">200</span></code><span class="koboSpan" id="kobo.95.1"> HTTP code and a “healthy” test response if the microservice is healthy, and an </span><code class="inlineCode"><span class="koboSpan" id="kobo.96.1">/alive</span></code><span class="koboSpan" id="kobo.97.1"> endpoint, which returns a </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.98.1">200</span></code><span class="koboSpan" id="kobo.99.1"> HTTP code and a “healthy” test response if the microservice is running and has not crashed.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.100.1">As a default, both endpoints are exposed only during development for security reasons. </span><span class="koboSpan" id="kobo.100.2">However, if the microservice is not accessible to external users, it can also be safely exposed in production. </span><span class="koboSpan" id="kobo.100.3">You need just to remove the condition on the environment in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.101.1">MapDefaultEndpoints()</span></code><span class="koboSpan" id="kobo.102.1"> extension defined in the the .NET Aspire Service Defaults project.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.103.1">If, instead, the microservice is a frontend, these endpoints can be exposed only if they are protected by both authentication and a throttling strategy that prevents denial of service attacks.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.104.1">You don’t need to manually add all these configurations since they are automatically added when the project is created. </span><span class="koboSpan" id="kobo.104.2">Most of the time, you will need to only change some parameters, such as the parameters of the various resiliency strategies.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.105.1">Each microservice needs just to call </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.106.1">builder.AddServiceDefaults()</span></code><span class="koboSpan" id="kobo.107.1"> an</span><a id="_idTextAnchor351"/><span class="koboSpan" id="kobo.108.1">d </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.109.1">app.MapDefaultEndpoints()</span></code><span class="koboSpan" id="kobo.110.1"> in order to apply all the configured defaults, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.111.1">var</span></span><span class="koboSpan" id="kobo.112.1"> builder = </span><span class="hljs-title"><span class="koboSpan" id="kobo.113.1">WebApplication</span></span><span class="koboSpan" id="kobo.114.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.115.1">CreateBuilder</span></span><span class="koboSpan" id="kobo.116.1">(args);
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.117.1">// Add service defaults &amp; Aspire client integrations.</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.118.1">builder.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.119.1">AddServiceDefaults</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.120.1">();</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.121.1">// Add application specific services</span></span><span class="koboSpan" id="kobo.122.1">
builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.123.1">Services</span></span><span class="koboSpan" id="kobo.124.1">…..
</span><span class="koboSpan" id="kobo.124.2">…
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.125.1">// Build application host</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.126.1">var</span></span><span class="koboSpan" id="kobo.127.1"> app = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.128.1">Build</span></span><span class="koboSpan" id="kobo.129.1">();
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.130.1">//Configure application</span></span><span class="koboSpan" id="kobo.131.1">
app….
</span><span class="koboSpan" id="kobo.131.2">…
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.132.1">//Add default endpoints</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.133.1">app.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.134.1">MapDefaultEndpoints</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.135.1">();</span></strong></span><span class="koboSpan" id="kobo.136.1">
app.</span><span class="hljs-title"><span class="koboSpan" id="kobo.137.1">Run</span></span><span class="koboSpan" id="kobo.138.1">();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.139.1">There are </span><a id="_idIndexMarker975"/><span class="koboSpan" id="kobo.140.1">also Aspire-specific testing projects based on xUnit, NUnit, and MSTest. </span><span class="koboSpan" id="kobo.140.2">They have all the needed references to create an app host, launch the application, and communicate with microservices through URLs based on their names (service discovery).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.141.1">As soon as you add a test project, it contains an initial example test with the whole code for creating the App Host and issuing a call to a microservice. </span><span class="koboSpan" id="kobo.141.2">This code is commented out, so you need just to add a reference to your App Host project to uncomment the code, and to replace the fake App Host project name and microservice name with your App Host project name and microservice name:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-comment"><span class="koboSpan" id="kobo.142.1">// Arrange</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.143.1">//    var appHost = await DistributedApplicationTestingBuilder</span></span><span class="koboSpan" id="kobo.144.1">
.</span><span class="hljs-property"><span class="koboSpan" id="kobo.145.1">CreateAsync</span></span><span class="koboSpan" id="kobo.146.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.147.1">Projects</span></span><span class="koboSpan" id="kobo.148.1">.</span><span class="code-highlight"><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.149.1">MyAspireApp_AppHost</span></strong></span><span class="koboSpan" id="kobo.150.1">&gt;();
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.151.1">//    appHost.Services.ConfigureHttpClientDefaults(clientBuilder =&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.152.1">//    {</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.153.1">//        clientBuilder.AddStandardResilienceHandler();</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.154.1">//    });        //</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.155.1">//    await using var app = await appHost.BuildAsync();</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.156.1">//    var resourceNotificationService = app.Services.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.157.1">    //    GetRequiredService&lt;ResourceNotificationService&gt;();</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.158.1">//    await app.StartAsync();</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.159.1">//    // Act</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.160.1">//    var httpClient = app.CreateHttpClient("</span></span><span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.161.1">webfrontend</span></strong></span><span class="hljs-comment"><span class="koboSpan" id="kobo.162.1">");</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.163.1">//    await resourceNotificationService</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.164.1">//    .WaitForResourceAsync("</span></span><span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.165.1">webfrontend</span></strong></span><span class="hljs-comment"><span class="koboSpan" id="kobo.166.1">",</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.167.1">//    KnownResourceStates.Running).WaitAsync(TimeSpan.FromSeconds(30));</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.168.1">//    var response = await httpClient.GetAsync("/");</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.169.1">In the preceding code, the fake names that must be replaced are highlighted.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.170.1">A template </span><a id="_idIndexMarker976"/><span class="koboSpan" id="kobo.171.1">called </span><strong class="keyWord"><span class="koboSpan" id="kobo.172.1">.NET Aspire Empty App</span></strong><span class="koboSpan" id="kobo.173.1"> is also available, which creates both the App Host and Service </span><a id="_idIndexMarker977"/><span class="koboSpan" id="kobo.174.1">Defaults projects, and a </span><strong class="keyWord"><span class="koboSpan" id="kobo.175.1">.NET Aspire Starter App</span></strong><span class="koboSpan" id="kobo.176.1"> template that adds some example microservices and resources, together </span><a id="_idIndexMarker978"/><span class="koboSpan" id="kobo.177.1">with their App Host configurations.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.178.1">The </span><strong class="keyWord"><span class="koboSpan" id="kobo.179.1">.NET Aspire Starter App</span></strong><span class="koboSpan" id="kobo.180.1"> template has a great didactic value because it immediately shows basic configurations, and how to configure and use </span><code class="inlineCode"><span class="koboSpan" id="kobo.181.1">HttpClient</span></code><span class="koboSpan" id="kobo.182.1"> with service discovery. </span><span class="koboSpan" id="kobo.182.2">Moreover, it is a good way to explore the console that appears in the browser when the application is launched with its statistics and logs, and the links to access all microservice endpoints. </span><span class="koboSpan" id="kobo.182.3">You are encouraged to create, explore, and run this project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.183.1">Service discovery is not an Aspire-specific feature but is a general .NET feature. </span><span class="koboSpan" id="kobo.183.2">It relies on various providers to map service names to actual URLs. </span><span class="koboSpan" id="kobo.183.3">We will discuss it in more detail in the next subsection.</span></p>
<h2 class="heading-2" id="_idParaDest-247"><a id="_idTextAnchor352"/><span class="koboSpan" id="kobo.184.1">Service discovery and its role in .NET Aspire.</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.185.1">Service discovery is an </span><code class="inlineCode"><span class="koboSpan" id="kobo.186.1">HttpClient</span></code><span class="koboSpan" id="kobo.187.1"> feature provided through extension methods defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.188.1">Microsoft.Extensions.ServiceDiscovery</span></code><span class="koboSpan" id="kobo.189.1"> NuGet package.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.190.1">Service names </span><a id="_idIndexMarker979"/><span class="koboSpan" id="kobo.191.1">are mapped to actual URLs </span><a id="_idIndexMarker980"/><span class="koboSpan" id="kobo.192.1">by using maps defined by providers. </span><span class="koboSpan" id="kobo.192.2">As a default, just the .NET configuration provider is added to the list of providers.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.193.1">This provider tries to read these maps from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.194.1">Service</span></code><span class="koboSpan" id="kobo.195.1">s section of the project configuration, where they must be defined as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.196.1">"Services":</span></span><span class="koboSpan" id="kobo.197.1"> {
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.198.1">"myservice":</span></span><span class="koboSpan" id="kobo.199.1"> {
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.200.1">"https":</span></span><span class="koboSpan" id="kobo.201.1"> [
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.202.1">"10.46.24.91:80"</span></span><span class="koboSpan" id="kobo.203.1">
      ],
       </span><span class="hljs-attr"><span class="koboSpan" id="kobo.204.1">"http":</span></span><span class="koboSpan" id="kobo.205.1"> [
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.206.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.207.1">10.46.24.91:443"</span></span><span class="koboSpan" id="kobo.208.1">
      ]
    }
  }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.209.1">When the service is called with </span><code class="inlineCode"><span class="koboSpan" id="kobo.210.1">http://myservice</span></code><span class="koboSpan" id="kobo.211.1">, the endpoint specified in the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.212.1">http</span></code><span class="koboSpan" id="kobo.213.1"> subsection is chosen; otherwise, if it is called with </span><code class="inlineCode"><span class="koboSpan" id="kobo.214.1">https://myservice</span></code><span class="koboSpan" id="kobo.215.1">, the one in the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.216.1">https</span></code><span class="koboSpan" id="kobo.217.1"> subsection is chosen.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.218.1">The configuration-based provider is added with the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.219.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.220.1">Services</span></span><span class="koboSpan" id="kobo.221.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.222.1">AddServiceDiscovery</span></span><span class="koboSpan" id="kobo.223.1">();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.224.1">The preceding </span><a id="_idIndexMarker981"/><span class="koboSpan" id="kobo.225.1">code also adds the pass-through provider, which simply resolves each service name to the service name itself. </span><span class="koboSpan" id="kobo.225.2">In other words, the pass-through provider does nothing! </span><span class="koboSpan" id="kobo.225.3">It must be used when deploying to Kubernetes since, in Kubernetes, names are resolved by services.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.226.1">Therefore, when deploying </span><a id="_idIndexMarker982"/><span class="koboSpan" id="kobo.227.1">to Kubernetes, each Microservice must have an associated service whose name is identical to the microservice name.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.228.1">For instance, if we have a microservice called </span><code class="inlineCode"><span class="koboSpan" id="kobo.229.1">routes_planning</span></code><span class="koboSpan" id="kobo.230.1"> that is deployed in a Kubernetes </span><code class="inlineCode"><span class="koboSpan" id="kobo.231.1">routes_planning</span></code><span class="koboSpan" id="kobo.232.1"> Deployment, then communications to </span><code class="inlineCode"><span class="koboSpan" id="kobo.233.1">routes_planning</span></code><span class="koboSpan" id="kobo.234.1"> must be passed through a Kubernetes service called </span><code class="inlineCode"><span class="koboSpan" id="kobo.235.1">routes-planning</span></code><span class="koboSpan" id="kobo.236.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.237.1">If a service name is not resolved by the configuration-based provider, it is passed to the next provider, which is the pass-through provider.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.238.1">Suppose we would like to deploy on Kubernetes but, first, we need to test our application with .NET Aspire. </span><span class="koboSpan" id="kobo.238.2">Do we need two different service discovery settings for these two environments?</span></p>
<p class="normal"><span class="koboSpan" id="kobo.239.1">The answer is no! </span><span class="koboSpan" id="kobo.239.2">In fact, .NET Aspire doesn’t use a configuration file to define the service maps. </span><span class="koboSpan" id="kobo.239.3">Instead, when the App Host project launches a microservice, it injects all service resolution rules it needs into environment variables that are then merged with all other microservice configuration information.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.240.1">When the application is published to a Kubernetes cluster, there will be no App Host, so no service resolution maps are injected in the configuration, and all resolutions are passed to the pass-through provider.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.241.1">One can also use </span><code class="inlineCode"><span class="koboSpan" id="kobo.242.1">AddServiceDiscoveryCore()</span></code><span class="koboSpan" id="kobo.243.1">, which doesn’t add any default provider instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.244.1">AddServiceDiscovery()</span></code><span class="koboSpan" id="kobo.245.1">. </span><span class="koboSpan" id="kobo.245.2">In this case, providers must be added manually by calling </span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.246.1">AddPassThroughServiceEndpointProvider()</span></code><span class="koboSpan" id="kobo.247.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.248.1">AddConfigurationServiceEndpointProvider()</span></code><span class="koboSpan" id="kobo.249.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.250.1">For instance, if we would like to add just the configuration-based provider, we can simply write the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.251.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.252.1">Services</span></span><span class="koboSpan" id="kobo.253.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.254.1">AddServiceDiscovery</span></span><span class="koboSpan" id="kobo.255.1">()
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.256.1">AddConfigurationServiceEndpointProvider</span></span><span class="koboSpan" id="kobo.257.1">();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.258.1">Service discovery can be also customized by setting the properties of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.259.1">ConfigurationServiceEndPointResolverOptions</span></code><span class="koboSpan" id="kobo.260.1"> option object. </span><span class="koboSpan" id="kobo.260.2">For instance, the following </span><a id="_idIndexMarker983"/><span class="koboSpan" id="kobo.261.1">code changes the name of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.262.1">Services</span></code><span class="koboSpan" id="kobo.263.1"> section in which to place all service name maps:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.264.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.265.1">Services</span></span><span class="koboSpan" id="kobo.266.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.267.1">Configure</span></span><span class="koboSpan" id="kobo.268.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.269.1">ConfigurationServiceEndPointResolverOptions</span></span><span class="koboSpan" id="kobo.270.1">&gt;(
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.271.1">static</span></span><span class="koboSpan" id="kobo.272.1"> options =&gt;
    {
        options.</span><span class="hljs-property"><span class="koboSpan" id="kobo.273.1">SectionName</span></span><span class="koboSpan" id="kobo.274.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.275.1">"MyCustomResolverSection"</span></span><span class="koboSpan" id="kobo.276.1">
    });
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.277.1">Once we </span><a id="_idIndexMarker984"/><span class="koboSpan" id="kobo.278.1">have added and configured service discovery, we must specify the HTTP clients that must use it. </span><span class="koboSpan" id="kobo.278.2">The following code applies service discovery to all HTTP clients:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.279.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.280.1">Services</span></span><span class="koboSpan" id="kobo.281.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.282.1">ConfigureHttpClientDefaults</span></span><span class="koboSpan" id="kobo.283.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.284.1">http</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.285.1"> =&gt;</span></span><span class="koboSpan" id="kobo.286.1">
{
    http.</span><span class="hljs-title"><span class="koboSpan" id="kobo.287.1">AddServiceDiscovery</span></span><span class="koboSpan" id="kobo.288.1">();
});
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.289.1">ConfigureHttpClientDefaults</span></code><span class="koboSpan" id="kobo.290.1"> can also be used to add and configure the various resiliency policies for all HTTP clients:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.291.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.292.1">Services</span></span><span class="koboSpan" id="kobo.293.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.294.1">ConfigureHttpClientDefaults</span></span><span class="koboSpan" id="kobo.295.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.296.1">http</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.297.1"> =&gt;</span></span><span class="koboSpan" id="kobo.298.1">
{
    http.</span><span class="hljs-title"><span class="koboSpan" id="kobo.299.1">AddStandardResilienceHandler</span></span><span class="koboSpan" id="kobo.300.1">();
    http.</span><span class="hljs-title"><span class="koboSpan" id="kobo.301.1">AddServiceDiscovery</span></span><span class="koboSpan" id="kobo.302.1">();
});
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.303.1">The preceding code is the default </span><code class="inlineCode"><span class="koboSpan" id="kobo.304.1">HttpClient</span></code><span class="koboSpan" id="kobo.305.1"> configuration added in all </span><strong class="keyWord"><span class="koboSpan" id="kobo.306.1">.NET Aspire Service Defaults</span></strong><span class="koboSpan" id="kobo.307.1"> projects.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.308.1">Service discovery can also be added to a specific </span><code class="inlineCode"><span class="koboSpan" id="kobo.309.1">HttpClient</span></code><span class="koboSpan" id="kobo.310.1">, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.311.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.312.1">Services</span></span><span class="koboSpan" id="kobo.313.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.314.1">AddHttpClient</span></span><span class="koboSpan" id="kobo.315.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.316.1">"myclient"</span></span><span class="koboSpan" id="kobo.317.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.318.1">static</span></span><span class="koboSpan" id="kobo.319.1"> client =&gt;
{
    client.</span><span class="hljs-property"><span class="koboSpan" id="kobo.320.1">BaseAddress</span></span><span class="koboSpan" id="kobo.321.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.322.1">new</span></span><span class="koboSpan" id="kobo.323.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.324.1">"https://routes_planning"</span></span><span class="koboSpan" id="kobo.325.1">);
})
.</span><span class="hljs-title"><span class="koboSpan" id="kobo.326.1">AddServiceDiscovery</span></span><span class="koboSpan" id="kobo.327.1">();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.328.1">When service discovery is in place, we can also write URIs such as </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.329.1">"https+http://routes_planning"</span></code><span class="koboSpan" id="kobo.330.1"> or </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.331.1">"http+https://routes_planning"</span></code><span class="koboSpan" id="kobo.332.1">. </span><span class="koboSpan" id="kobo.332.2">In this case, service discovery will attempt to resolve the URI with the first protocol (</span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.333.1">https</span></code><span class="koboSpan" id="kobo.334.1"> or </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.335.1">http</span></code><span class="koboSpan" id="kobo.336.1">), and will move to the second protocol in the case of failure.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.337.1">This is useful when we use </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.338.1">http</span></code><span class="koboSpan" id="kobo.339.1"> during development and </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.340.1">https</span></code><span class="koboSpan" id="kobo.341.1"> in staging and production. </span><span class="koboSpan" id="kobo.341.2">For this purpose, it is enough to define just </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.342.1">http</span></code><span class="koboSpan" id="kobo.343.1"> endpoints in the launch settings of all microservice projects. </span><span class="koboSpan" id="kobo.343.2">In fact, the App Host uses each microservice’s launch settings to create the service </span><a id="_idIndexMarker985"/><span class="koboSpan" id="kobo.344.1">discovery maps that it injects into the environment variables. </span><span class="koboSpan" id="kobo.344.2">Therefore, only </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.345.1">http</span></code><span class="koboSpan" id="kobo.346.1"> maps would be generated during development, so the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.347.1">https</span></code><span class="koboSpan" id="kobo.348.1"> resolution will fail. </span><span class="koboSpan" id="kobo.348.2">After deployment, instead, just the pass-through provider will work so the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.349.1">https</span></code><span class="koboSpan" id="kobo.350.1"> resolution will succeed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.351.1">Up to this point, we supposed </span><a id="_idIndexMarker986"/><span class="koboSpan" id="kobo.352.1">that each microservice has just a single endpoint, but sometimes, some services might have several endpoints, each on a different port. </span><span class="koboSpan" id="kobo.352.2">When a microservice has several endpoints, we must give names to all the endpoints except one (the default endpoint). </span><span class="koboSpan" id="kobo.352.3">Endpoint names are given in the service definition and configuration that is in the App Host. </span><span class="koboSpan" id="kobo.352.4">The following is the definition of a microservice with a default endpoint and a named endpoint whose name is </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.353.1">"aux"</span></code><span class="koboSpan" id="kobo.354.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.355.1">var</span></span><span class="koboSpan" id="kobo.356.1"> routesPlanning = builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.357.1">AddProject</span></span><span class="koboSpan" id="kobo.358.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.359.1">Projects</span></span><span class="koboSpan" id="kobo.360.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.361.1">RoutesPlanningService</span></span><span class="koboSpan" id="kobo.362.1">&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.363.1">"routes_planning "</span></span><span class="koboSpan" id="kobo.364.1">)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.365.1">WithHttpsEndpoint</span></span><span class="koboSpan" id="kobo.366.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.367.1">hostPort</span></span><span class="koboSpan" id="kobo.368.1">: </span><span class="hljs-number"><span class="koboSpan" id="kobo.369.1">9999</span></span><span class="koboSpan" id="kobo.370.1">, </span><span class="hljs-attr"><span class="koboSpan" id="kobo.371.1">name</span></span><span class="koboSpan" id="kobo.372.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.373.1">"aux"</span></span><span class="koboSpan" id="kobo.374.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.375.1">In this case, the generated configuration map will associate two URLs to the service name, one for the default endpoint and the other for the named endpoint, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-string"><span class="koboSpan" id="kobo.376.1">"Services"</span></span><span class="koboSpan" id="kobo.377.1">: {
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.378.1">"routes_planning"</span></span><span class="koboSpan" id="kobo.379.1">: {
      </span><span class="hljs-string"><span class="koboSpan" id="kobo.380.1">"https"</span></span><span class="koboSpan" id="kobo.381.1">: [</span><span class="hljs-string"><span class="koboSpan" id="kobo.382.1">"https://localhost:8080"</span></span><span class="koboSpan" id="kobo.383.1">],
      </span><span class="hljs-string"><span class="koboSpan" id="kobo.384.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.385.1">aux"</span></span><span class="koboSpan" id="kobo.386.1">: [</span><span class="hljs-string"><span class="koboSpan" id="kobo.387.1">"https://localhost:8090"</span></span><span class="koboSpan" id="kobo.388.1">]   
    }
  }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.389.1">The default endpoint can</span><a id="_idTextAnchor353"/><span class="koboSpan" id="kobo.390.1"> be acces</span><a id="_idTextAnchor354"/><span class="koboSpan" id="kobo.391.1">sed with </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.392.1">"https://routes_planning"</span></code><span class="koboSpan" id="kobo.393.1">, while, for the named endpoint, we must add also the endpoint name to the URI, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.394.1">https</span></span><span class="koboSpan" id="kobo.395.1">:</span><span class="hljs-comment"><span class="koboSpan" id="kobo.396.1">//_aux.routes_planning</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.397.1">When using </span><a id="_idIndexMarker987"/><span class="koboSpan" id="kobo.398.1">Aspire App Host, the preceding </span><a id="_idIndexMarker988"/><span class="koboSpan" id="kobo.399.1">configuration is automatically created and injected into all services that need it, so we don’t need to worry about it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.400.1">However, if we deploy on Kubernetes, we must define a Kubernetes service that correctly resolves both </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.401.1">"https://routes_planning"</span></code><span class="koboSpan" id="kobo.402.1"> and </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.403.1">"https://_aux.routes_planning"</span></code><span class="koboSpan" id="kobo.404.1">. </span><span class="koboSpan" id="kobo.404.2">This result is easily achieved with named ports, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.405.1">apiVersion</span></span><span class="koboSpan" id="kobo.406.1">: v1
</span><span class="hljs-attr"><span class="koboSpan" id="kobo.407.1">kind</span></span><span class="koboSpan" id="kobo.408.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.409.1">Service</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.410.1">metadata</span></span><span class="koboSpan" id="kobo.411.1">:
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.412.1">name</span></span><span class="koboSpan" id="kobo.413.1">: routes_planning
</span><span class="hljs-attr"><span class="koboSpan" id="kobo.414.1">spec</span></span><span class="koboSpan" id="kobo.415.1">:
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.416.1">selector</span></span><span class="koboSpan" id="kobo.417.1">:
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.418.1">name</span></span><span class="koboSpan" id="kobo.419.1">: routes_planning
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.420.1">ports</span></span><span class="koboSpan" id="kobo.421.1">:
  - </span><span class="hljs-attr"><span class="koboSpan" id="kobo.422.1">name</span></span><span class="koboSpan" id="kobo.423.1">: </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.424.1">default</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.425.1">port</span></span><span class="koboSpan" id="kobo.426.1">: </span><span class="hljs-number"><span class="koboSpan" id="kobo.427.1">8080</span></span><span class="koboSpan" id="kobo.428.1">
  - </span><span class="hljs-attr"><span class="koboSpan" id="kobo.429.1">name</span></span><span class="koboSpan" id="kobo.430.1">: aux
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.431.1">port</span></span><span class="koboSpan" id="kobo.432.1">: </span><span class="hljs-number"><span class="koboSpan" id="kobo.433.1">8090</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.434.1">The port associated with the default endpoint must be given the </span><code class="inlineCode"><span class="koboSpan" id="kobo.435.1">default</span></code><span class="koboSpan" id="kobo.436.1"> name, while all ports associated with named endpoints must be given the same name as the endpoint.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.437.1">Now that we understand the magic behind actual service URL discovery, let’s move on to the magic behind resource integration and automatic connection string handling.</span></p>
<h2 class="heading-2" id="_idParaDest-248"><a id="_idTextAnchor355"/><span class="koboSpan" id="kobo.438.1">Resource integration and automatic resource configuration</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.439.1">Resources needed for the various microservice projects can be simulated when the solution is run. </span><span class="koboSpan" id="kobo.439.2">It is </span><a id="_idIndexMarker989"/><span class="koboSpan" id="kobo.440.1">enough to add </span><a id="_idIndexMarker990"/><span class="koboSpan" id="kobo.441.1">the corresponding </span><a id="_idIndexMarker991"/><span class="koboSpan" id="kobo.442.1">Aspire NuGet packages and declare and configure </span><a id="_idIndexMarker992"/><span class="koboSpan" id="kobo.443.1">the resource in the App Host. </span><span class="koboSpan" id="kobo.443.2">There are extension methods for declaring the main databases, Redis, and the main message brokers such as RabbitMQ, Kafka, and even an Azure Service Bus simulator. </span><span class="koboSpan" id="kobo.443.3">For a complete list of all resources that can be added to an Aspire project and configured in its App Host, please refer to the official documentation on integration at </span><a href="https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/integrations-overview"><span class="url"><span class="koboSpan" id="kobo.444.1">https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/integrations-overview</span></span></a><span class="koboSpan" id="kobo.445.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.446.1">Behind the curtain, all these resources are implemented with Docker images, so most extension methods also allow you to choose a specific Docker image and a specific version. </span><span class="koboSpan" id="kobo.446.2">Furthermore, since the App Host supports generic Docker images, one can implement extension methods for a custom resource that is not yet supported. </span><span class="koboSpan" id="kobo.446.3">However, the list of supported resources is growing quickly, so you should find all the resources you ne</span><a id="_idTextAnchor356"/><span class="koboSpan" id="kobo.447.1">ed already implemented.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.448.1">In the </span><em class="italic"><span class="koboSpan" id="kobo.449.1">Using .NET Aspire in practice </span></em><span class="koboSpan" id="kobo.450.1">section of this chapter, you will see in detail how to integrate and configure SQL Server and RabbitMQ, and in the </span><em class="italic"><span class="koboSpan" id="kobo.451.1">Configuring Microservices and Resources</span></em><span class="koboSpan" id="kobo.452.1"> section, we will explain how to declare and configure both microservices and resources in the App Host.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.453.1">When </span><a id="_idIndexMarker993"/><span class="koboSpan" id="kobo.454.1">you configure </span><a id="_idIndexMarker994"/><span class="koboSpan" id="kobo.455.1">a resource, you give it a name, and if the resource supports a connection string, that name is assumed to </span><a id="_idIndexMarker995"/><span class="koboSpan" id="kobo.456.1">be the name of the connection string. </span><span class="koboSpan" id="kobo.456.2">Accordingly, when </span><a id="_idIndexMarker996"/><span class="koboSpan" id="kobo.457.1">the App Host creates a resource, it computes its connection string and passes it in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.458.1">ConnectionStrings</span></code><span class="koboSpan" id="kobo.459.1"> section of the configuration of all microservices that use that resource. </span><span class="koboSpan" id="kobo.459.2">This is done by placing the configuration string in an environment variable called </span><code class="inlineCode"><span class="koboSpan" id="kobo.460.1">ConnectionStrings__&lt;name&gt;</span></code><span class="koboSpan" id="kobo.461.1">, where </span><code class="inlineCode"><span class="koboSpan" id="kobo.462.1">&lt;name&gt;</span></code><span class="koboSpan" id="kobo.463.1"> is the name that we gave to the resource.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.464.1">For instance, suppose our application needs a SQL Server instance containing a database called </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.465.1">"mydatabase"</span></code><span class="koboSpan" id="kobo.466.1">. </span><span class="koboSpan" id="kobo.466.2">In the App Host, we may declare these resources with the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.467.1">var</span></span><span class="koboSpan" id="kobo.468.1"> builder = </span><span class="hljs-title"><span class="koboSpan" id="kobo.469.1">DistributedApplication</span></span><span class="koboSpan" id="kobo.470.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.471.1">CreateBuilder</span></span><span class="koboSpan" id="kobo.472.1">(args);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.473.1">var</span></span><span class="koboSpan" id="kobo.474.1"> sql = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.475.1">AddSqlServer</span></span><span class="koboSpan" id="kobo.476.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.477.1">"sql"</span></span><span class="koboSpan" id="kobo.478.1">);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.479.1">var</span></span><span class="koboSpan" id="kobo.480.1"> db = sql.</span><span class="hljs-title"><span class="koboSpan" id="kobo.481.1">AddDatabase</span></span><span class="koboSpan" id="kobo.482.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.483.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.484.1">mydatabase "</span></span><span class="koboSpan" id="kobo.485.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.486.1">Now, if a microservice defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.487.1">MyExampleProject</span></code><span class="koboSpan" id="kobo.488.1"> project must use the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.489.1">"mydatabase"</span></code><span class="koboSpan" id="kobo.490.1"> database, it must declare it as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.491.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.492.1">AddProject</span></span><span class="koboSpan" id="kobo.493.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.494.1">Projects</span></span><span class="koboSpan" id="kobo.495.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.496.1">MyExampleProject</span></span><span class="koboSpan" id="kobo.497.1">&gt;()
       .</span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.498.1">WithReference</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.499.1">(db);</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.500.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.501.1">WithReference(db)</span></code><span class="koboSpan" id="kobo.502.1"> call causes the connection string for accessing </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.503.1">"mydatabase"</span></code><span class="koboSpan" id="kobo.504.1"> in the SQL Server instance to be injected in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.505.1">ConnectionStrings__mydatabase</span></code><span class="koboSpan" id="kobo.506.1"> environment variable of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.507.1">MyExampleProject</span></code><span class="koboSpan" id="kobo.508.1"> microservice.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.509.1">Clearly, when we configure a resource, we can also specify the credentials to access it instead of using the default credentials created by the extension method.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.510.1">More details on how to configure resources and microservices in the App Host will be given in the next section.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.511.1">Usually, together with the connection string, the App Host passes a whole configuration section containing more details on the resources, such as username and password. </span><span class="koboSpan" id="kobo.511.2">The format of this auxiliary </span><a id="_idIndexMarker997"/><span class="koboSpan" id="kobo.512.1">data depends on the specific resource type. </span><span class="koboSpan" id="kobo.512.2">In the </span><em class="italic"><span class="koboSpan" id="kobo.513.1">Using .NET Aspire in practice</span></em><span class="koboSpan" id="kobo.514.1"> section of this chapter, we will see the RabbitMQ </span><a id="_idIndexMarker998"/><span class="koboSpan" id="kobo.515.1">auxiliary information format. </span><span class="koboSpan" id="kobo.515.2">The auxiliary information format of all supported resources is available in the official documentation.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.516.1">If we want </span><a id="_idIndexMarker999"/><span class="koboSpan" id="kobo.517.1">to use an already existing resource, we don’t </span><a id="_idIndexMarker1000"/><span class="koboSpan" id="kobo.518.1">need to declare </span><a id="_idIndexMarker1001"/><span class="koboSpan" id="kobo.519.1">it in the App Host but we need to declare its connection string with </span><code class="inlineCode"><span class="koboSpan" id="kobo.520.1">builder.AddConnectionString</span></code><span class="koboSpan" id="kobo.521.1"> so that the App Host can inject it into all the microservices that need it. </span><span class="koboSpan" id="kobo.521.2">For instance, if the SQL Server database of the previous example already exists both in the development environment and in the deployment environment, the code must be modified as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.522.1">var</span></span><span class="koboSpan" id="kobo.523.1"> builder = </span><span class="hljs-title"><span class="koboSpan" id="kobo.524.1">DistributedApplication</span></span><span class="koboSpan" id="kobo.525.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.526.1">CreateBuilder</span></span><span class="koboSpan" id="kobo.527.1">(args);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.528.1">var</span></span><span class="koboSpan" id="kobo.529.1"> db = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.530.1">AddConnectionString</span></span><span class="koboSpan" id="kobo.531.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.532.1">"parameterName"</span></span><span class="koboSpan" id="kobo.533.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.534.1">"database"</span></span><span class="koboSpan" id="kobo.535.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.536.1">Here, </span><code class="inlineCode"><span class="koboSpan" id="kobo.537.1">parameterName</span></code><span class="koboSpan" id="kobo.538.1"> is the name of the parameter that contains the connection string in the App Host configuration file in the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.539.1">"Parameters"</span></code><span class="koboSpan" id="kobo.540.1"> section, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.541.1">{
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.542.1">"Parameters":</span></span><span class="koboSpan" id="kobo.543.1"> {
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.544.1">" parameterName ":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.545.1">" SERVER=XXX.XXX.X.XX;DATABASE=DATABASENAME ……"</span></span><span class="koboSpan" id="kobo.546.1">
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.547.1">Needless to say, we can use .NET environments to provide different configurations in different environments.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.548.1">The remainder of the code remains unchanged:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.549.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.550.1">AddProject</span></span><span class="koboSpan" id="kobo.551.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.552.1">Projects</span></span><span class="koboSpan" id="kobo.553.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.554.1">MyExampleProject</span></span><span class="koboSpan" id="kobo.555.1">&gt;()
       .</span><span class="hljs-title"><span class="koboSpan" id="kobo.556.1">WithReference</span></span><span class="koboSpan" id="kobo.557.1">(db);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.558.1">What happens to all the connection strings and the auxiliary resource data when the application is deployed in production or staging?</span></p>
<p class="normal"><span class="koboSpan" id="kobo.559.1">If deployment is manual, the same environment variable inserted by the App Host must be defined in the configuration of the target orchestrator. </span><span class="koboSpan" id="kobo.559.2">Thus, for instance, if the target orchestrator is Kubernetes, it must be defined in the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.560.1">env</span></code><span class="koboSpan" id="kobo.561.1"> section of a Deployment. </span><span class="koboSpan" id="kobo.561.2">As we will see in more </span><a id="_idIndexMarker1002"/><span class="koboSpan" id="kobo.562.1">detail in the </span><em class="italic"><span class="koboSpan" id="kobo.563.1">Deploying a .NET Aspire project</span></em><span class="koboSpan" id="kobo.564.1"> section, when we use automatic tools for configuring the </span><a id="_idIndexMarker1003"/><span class="koboSpan" id="kobo.565.1">target orchestrator, there are two possibilities:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.566.1">If the automatic </span><a id="_idIndexMarker1004"/><span class="koboSpan" id="kobo.567.1">tool is capable of provisioning </span><a id="_idIndexMarker1005"/><span class="koboSpan" id="kobo.568.1">the required resources, it will also automatically configure all the environment variables, taking all the required information from the created resources</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.569.1">If the automatic tool doesn’t generate the required resources but only generates the code to configure all the microservices, it will ask the user for the environment variable values</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.570.1">The next subsection details how to handle telemetry during development and when the application is deployed.</span></p>
<h2 class="heading-2" id="_idParaDest-249"><a id="_idTextAnchor357"/><span class="koboSpan" id="kobo.571.1">Application telemetry</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.572.1">Telemetry </span><a id="_idIndexMarker1006"/><span class="koboSpan" id="kobo.573.1">enables the monitoring of </span><a id="_idIndexMarker1007"/><span class="koboSpan" id="kobo.574.1">a microservices application as a whole by connecting adequately related events taking place in different microservices. </span><span class="koboSpan" id="kobo.574.2">More specifically, it collects the following data:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.575.1">Logging: Individual logs of all microservices and resources are collected and classified according to their generation time and source.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.576.1">Tracing: Traces correlate log events that are part of the same logical activity (e.g., the handling of a single request), even if they’re spread across multiple machines or processes. </span><span class="koboSpan" id="kobo.576.2">Tracing is the starting point for diagnosing and debugging malfunctions.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.577.1">Metrics: Various microservice metrics are collected by each executing microservice and are sent to a collection point.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.578.1">When the application is run in the development environment and uses the App Host as an orchestrator, each microservice’s telemetry is enabled by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.579.1">ConfigureOpenTelemetry()</span></code><span class="koboSpan" id="kobo.580.1"> call configured in the </span><strong class="keyWord"><span class="koboSpan" id="kobo.581.1">.NET Aspire Service Defaults</span></strong><span class="koboSpan" id="kobo.582.1"> project. </span><span class="koboSpan" id="kobo.582.2">This call enables the collection of metrics and the transmission of these metrics together with the microservice logs to an </span><strong class="keyWord"><span class="koboSpan" id="kobo.583.1">OpenTelemetry</span></strong><span class="koboSpan" id="kobo.584.1"> endpoint </span><a id="_idIndexMarker1008"/><span class="koboSpan" id="kobo.585.1">that implements the </span><strong class="keyWord"><span class="koboSpan" id="kobo.586.1">OpenTelemetry Protocol (OTLP)</span></strong><span class="koboSpan" id="kobo.587.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.588.1">During development, the Aspire console that opens when the solution is run works as an OpenTelemetry endpoint, and the data for connecting with this endpoint is injected as an environment variable into all microservices by the App Host. </span><span class="koboSpan" id="kobo.588.2">Therefore, all the data we can see in this console comes from telemetry.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.589.1">When the application is deployed, the same environment variables must contain the data of an OpenTelemetry </span><a id="_idIndexMarker1009"/><span class="koboSpan" id="kobo.590.1">endpoint available in the deployment environment. </span><span class="koboSpan" id="kobo.590.2">Azure supports OTLP, so if, for instance, the application is </span><a id="_idIndexMarker1010"/><span class="koboSpan" id="kobo.591.1">deployed to Azure Kubernetes, we must pass the data of the telemetry endpoint that is created together with the Azure Kubernetes cluster. </span><span class="koboSpan" id="kobo.591.2">It is also possible to pass OpenTelemetry data to tools such as Grafana, which was described in the </span><em class="italic"><span class="koboSpan" id="kobo.592.1">Kubernetes administrative tools</span></em><span class="koboSpan" id="kobo.593.1"> subsection of </span><a href="Chapter_9.xhtml#_idTextAnchor261"><em class="italic"><span class="koboSpan" id="kobo.594.1">Chapter 9</span></em></a><span class="koboSpan" id="kobo.595.1">,</span><em class="italic"><span class="koboSpan" id="kobo.596.1"> Simplifying Containers and Kubernetes: Azure Container Apps</span></em><em class="italic"><span class="koboSpan" id="kobo.597.1"> and other Tools</span></em><span class="koboSpan" id="kobo.598.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.599.1">The environment variables automatically injected in each microservice by the App Host that we must inject manually in the deployment environment are as follows:</span></p>
<ul>
<li class="bulletList"><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.600.1">OTEL_EXPORTER_OTLP_ENDPOINT</span></code><span class="koboSpan" id="kobo.601.1">, which contains the URL of the OTLP endpoint.</span></li>
<li class="bulletList"><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.602.1">OTEL_SERVICE_NAME</span></code><span class="koboSpan" id="kobo.603.1">, which contains the service name that the microservice must add to the data it sends. </span><span class="koboSpan" id="kobo.603.2">You should use the same name given to the microservice in the App Host configuration.</span></li>
<li class="bulletList"><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.604.1">OTEL_RESOURCE_ATTRIBUTES</span></code><span class="koboSpan" id="kobo.605.1">, which contains a unique ID that univocally identifies each service instance. </span><span class="koboSpan" id="kobo.605.2">It must be added to all data, too, and must have the following format: </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.606.1">service.instance.id=&lt;unique name&gt;</span></code><span class="koboSpan" id="kobo.607.1">. </span><span class="koboSpan" id="kobo.607.2">Typically, GUIDs are used as unique service names.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.608.1">Once you have clarified all the services offered by Aspire, you need to learn how to configure the App Host.</span></p>
<h1 class="heading-1" id="_idParaDest-250"><a id="_idTextAnchor358"/><span class="koboSpan" id="kobo.609.1">Configuring microservices and resources</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.610.1">The App </span><a id="_idIndexMarker1011"/><span class="koboSpan" id="kobo.611.1">Host handles services as follows:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.612.1">.NET projects: These can be configured with </span><code class="inlineCode"><span class="koboSpan" id="kobo.613.1">var myService = builder.AddProject&lt;Projects.MyProjectName&gt;("myservicename");</span></code></li>
<li class="numberedList"><span class="koboSpan" id="kobo.614.1">Containers stored in some registry: These can be configured with </span><code class="inlineCode"><span class="koboSpan" id="kobo.615.1">var myService = builder.AddContainer("myservicename", "ContainerNameOrUri");</span></code></li>
<li class="numberedList"><span class="koboSpan" id="kobo.616.1">Executables: These can be configured with </span><code class="inlineCode"><span class="koboSpan" id="kobo.617.1">var myService = builder.AddExecutable("myservicename", "&lt;shell command&gt;", "&lt;executable working directory&gt;");</span></code></li>
<li class="numberedList"><span class="koboSpan" id="kobo.618.1">Dockerfiles to be built: These can be configured with </span><code class="inlineCode"><span class="koboSpan" id="kobo.619.1">var myService = bu</span><a id="_idTextAnchor359"/><span class="koboSpan" id="kobo.620.1">ilder.AddDockerfile(</span></code>
<pre class="programlisting code-one"><code class="hljs-code"><code class="inlineCode"><span class="koboSpan" id="kobo.621.1">    "myservicename ", "relative/context/path");</span></code>
</code></pre>
</li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.622.1">where </span><code class="inlineCode"><span class="koboSpan" id="kobo.623.1">"relative/context/path"</span></code><span class="koboSpan" id="kobo.624.1"> is the folder containing the Dockerfile and all files needed to build the Dockerfile. </span><span class="koboSpan" id="kobo.624.2">This path must be relative to the directory that contains the App Host project file.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.625.1">Each of the </span><a id="_idIndexMarker1012"/><span class="koboSpan" id="kobo.626.1">preceding commands can be followed by several configuration options, passed with a fluent interface, as shown in this example:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.627.1">var</span></span><span class="koboSpan" id="kobo.628.1"> cache = builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.629.1">AddProject</span></span><span class="koboSpan" id="kobo.630.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.631.1">Projects</span></span><span class="koboSpan" id="kobo.632.1">……
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.633.1">var</span></span><span class="koboSpan" id="kobo.634.1"> apiService = builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.635.1">AddProject</span></span><span class="koboSpan" id="kobo.636.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.637.1">Projects</span></span><span class="koboSpan" id="kobo.638.1">……
builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.639.1">AddProject</span></span><span class="koboSpan" id="kobo.640.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.641.1">Projects</span></span><span class="koboSpan" id="kobo.642.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.643.1">MyAspireProject</span></span><span class="koboSpan" id="kobo.644.1">&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.645.1">"webfrontend"</span></span><span class="koboSpan" id="kobo.646.1">)   
   .</span><span class="hljs-title"><span class="koboSpan" id="kobo.647.1">WithReference</span></span><span class="koboSpan" id="kobo.648.1">(cache)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.649.1">WaitFor</span></span><span class="koboSpan" id="kobo.650.1">(cache)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.651.1">WithReference</span></span><span class="koboSpan" id="kobo.652.1">(apiService)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.653.1">WaitFor</span></span><span class="koboSpan" id="kobo.654.1">(apiService);
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.655.1">WithReference</span></code><span class="koboSpan" id="kobo.656.1"> declares that the service communicates with the resource or service passed as an argument. </span><span class="koboSpan" id="kobo.656.2">It causes the injection of all environment variables containing the data needed by service discovery, connection strings, or other auxiliary resource information.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.657.1">WaitFor</span></code><span class="koboSpan" id="kobo.658.1"> declares that the microservice must be started after the service or resource passed as the argument is running.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.659.1">WithReplicas(int n)</span></code><span class="koboSpan" id="kobo.660.1"> is another important method of the fluent interface configuration. </span><span class="koboSpan" id="kobo.660.2">It declares that the microservice must be replicated </span><em class="italic"><span class="koboSpan" id="kobo.661.1">n</span></em><span class="koboSpan" id="kobo.662.1"> times. </span><span class="koboSpan" id="kobo.662.2">It is important if we plan to use an automatic tool to compile the App Host configuration into Kubernetes or Azure Container Apps configuration code.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.663.1">Unfortunately, often, when in development mode, the limited power of our development machine doesn’t allow the same number of replicas that we need in production. </span><span class="koboSpan" id="kobo.663.2">Therefore, we should execute different configuration instructions in these cases.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.664.1">The App Host configuration is executed both when we run the application on the development machine and when we use App Host configuration to generate code for other platforms. </span><span class="koboSpan" id="kobo.664.2">In the second case, we say that we are in publishing mode instead of running mode. </span><span class="koboSpan" id="kobo.664.3">Luckily, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.665.1">builder</span></code><span class="koboSpan" id="kobo.666.1"> object contains information on the execution environment in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.667.1">builder.ExecutionContext</span></code><span class="koboSpan" id="kobo.668.1"> property. </span><span class="koboSpan" id="kobo.668.2">In particular, we can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.669.1">builder.ExecutionContext.IsPublishMode</span></code><span class="koboSpan" id="kobo.670.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.671.1">builder.ExecutionContext.IsRunMode</span></code><span class="koboSpan" id="kobo.672.1"> properties to differentiate between the configuration in running mode and in publishing mode.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.673.1">As already mentioned, in the </span><em class="italic"><span class="koboSpan" id="kobo.674.1">Service discovery and its role in .NET Aspire</span></em><span class="koboSpan" id="kobo.675.1"> subsection, we can also use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.676.1">WithEndpoint</span></code><span class="koboSpan" id="kobo.677.1"> fluent interface method to declare auxiliary endpoints available on other ports:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.678.1">var</span></span><span class="koboSpan" id="kobo.679.1"> routesPlanning = builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.680.1">AddProject</span></span><span class="koboSpan" id="kobo.681.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.682.1">Projects</span></span><span class="koboSpan" id="kobo.683.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.684.1">RoutesPlanningService</span></span><span class="koboSpan" id="kobo.685.1">&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.686.1">"routes_planning "</span></span><span class="koboSpan" id="kobo.687.1">)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.688.1">WithEndpoint</span></span><span class="koboSpan" id="kobo.689.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.690.1">hostPort</span></span><span class="koboSpan" id="kobo.691.1">: </span><span class="hljs-number"><span class="koboSpan" id="kobo.692.1">9999</span></span><span class="koboSpan" id="kobo.693.1">, </span><span class="hljs-attr"><span class="koboSpan" id="kobo.694.1">name</span></span><span class="koboSpan" id="kobo.695.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.696.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.697.1">aux"</span></span><span class="koboSpan" id="kobo.698.1">);
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.699.1">WithEndpoint</span></code><span class="koboSpan" id="kobo.700.1"> can be replaced by </span><code class="inlineCode"><span class="koboSpan" id="kobo.701.1">WithHttpsEndpoint</span></code><span class="koboSpan" id="kobo.702.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.703.1">WithHttpEndpoint</span></code><span class="koboSpan" id="kobo.704.1"> to declare, respectively, HTTPS-only and HTTP-only endpoints.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.705.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.706.1">WithExternalHttpEndpoints()</span></code><span class="koboSpan" id="kobo.707.1"> fluent interface method declares that the microservice endpoint must </span><a id="_idIndexMarker1013"/><span class="koboSpan" id="kobo.708.1">be available outside of the application for application clients. </span><span class="koboSpan" id="kobo.708.2">These endpoints will be exposed with </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.709.1">Ingress</span></code><span class="koboSpan" id="kobo.710.1"> or </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.711.1">LoadBalancer</span></code><span class="koboSpan" id="kobo.712.1"> services when publishing the application on Kubernetes and with external ingresses when publishing the application on Azure Container Apps.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.713.1">Resources used by microservices can be declared and configured with the same fluent interface. </span><span class="koboSpan" id="kobo.713.2">Each resource type requires a dedicated NuGet package that provides the needed extension methods to the fluent interface. </span><span class="koboSpan" id="kobo.713.3">All these extension methods are built on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.714.1">builder.AddContainer</span></code><span class="koboSpan" id="kobo.715.1"> method since they use Docker images to implement the resources. </span><span class="koboSpan" id="kobo.715.2">Therefore, if a resource we need is not yet available, we can write the needed extension methods ourselves. </span><span class="koboSpan" id="kobo.715.3">However, as already mentioned, there are resources for all the main databases, Redis, all the main message brokers, and most Azure services. </span><span class="koboSpan" id="kobo.715.4">Some Azure resource configurators provision and use actual Azure resources, while others use local simulators. </span><span class="koboSpan" id="kobo.715.5">There are simulators for Azure Storage and Azure Service Bus.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.716.1">Refer to the official documentation for a list of all available resource integrations: </span><a href="https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/integrations-overview"><span class="url"><span class="koboSpan" id="kobo.717.1">https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/integrations-overview</span></span></a><span class="koboSpan" id="kobo.718.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.719.1">As a default, when the App Host is shut down, all database data is lost since all Docker images use temporary storage. </span><span class="koboSpan" id="kobo.719.2">However, we can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.720.1">WithDataVolume()</span></code><span class="koboSpan" id="kobo.721.1"> fluent interface method to force the usage of permanent Docker volume storage:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.722.1">var</span></span><span class="koboSpan" id="kobo.723.1"> sql = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.724.1">AddSqlServer</span></span><span class="koboSpan" id="kobo.725.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.726.1">"sql"</span></span><span class="koboSpan" id="kobo.727.1">)
                 .</span><span class="hljs-title"><span class="koboSpan" id="kobo.728.1">WithDataVolume</span></span><span class="koboSpan" id="kobo.729.1">();
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.730.1">var</span></span><span class="koboSpan" id="kobo.731.1"> db = sql.</span><span class="hljs-title"><span class="koboSpan" id="kobo.732.1">AddDatabase</span></span><span class="koboSpan" id="kobo.733.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.734.1">"database"</span></span><span class="koboSpan" id="kobo.735.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.736.1">When this method is called, a Docker volume with an auto-generated name is created. </span><span class="koboSpan" id="kobo.736.2">For more control over the volume name and the directory inside the container where it is mounted, you can use </span><code class="inlineCode"><span class="koboSpan" id="kobo.737.1">WithBindMount</span></code><span class="koboSpan" id="kobo.738.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.739.1">var</span></span><span class="koboSpan" id="kobo.740.1"> sql = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.741.1">AddSqlServer</span></span><span class="koboSpan" id="kobo.742.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.743.1">"sql"</span></span><span class="koboSpan" id="kobo.744.1">)
                 .</span><span class="hljs-title"><span class="koboSpan" id="kobo.745.1">WithBindMount</span></span><span class="koboSpan" id="kobo.746.1">("</span><span class="hljs-title"><span class="koboSpan" id="kobo.747.1">MyVolumeName</span></span><span class="koboSpan" id="kobo.748.1">", "/</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.749.1">var</span></span><span class="koboSpan" id="kobo.750.1">/opt/mssql");
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.751.1">var</span></span><span class="koboSpan" id="kobo.752.1"> db = sql.</span><span class="hljs-title"><span class="koboSpan" id="kobo.753.1">AddDatabase</span></span><span class="koboSpan" id="kobo.754.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.755.1">"database"</span></span><span class="koboSpan" id="kobo.756.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.757.1">Most resources use a default username, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.758.1">sa</span></code><span class="koboSpan" id="kobo.759.1">, and an auto-generated password. </span><span class="koboSpan" id="kobo.759.2">Both credentials are available through the resources information link of the App Host browser console. </span><span class="koboSpan" id="kobo.759.3">However, if data is not persisted with a volume, this password may change at each run.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.760.1">Luckily, all resources provide the possibility to specify some parameters, and </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.761.1">username</span></code><span class="koboSpan" id="kobo.762.1"> and </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.763.1">password</span></code><span class="koboSpan" id="kobo.764.1"> are always among them.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.765.1">Needless to say, parameters are not inserted directly in the code, for obvious reasons. </span><span class="koboSpan" id="kobo.765.2">They are taken from the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.766.1">"Parameter"</span></code><span class="koboSpan" id="kobo.767.1"> section of the App Host configuration. </span><span class="koboSpan" id="kobo.767.2">Therefore, they can be inserted in </span><a id="_idIndexMarker1014"/><span class="koboSpan" id="kobo.768.1">the App Host configuration file, so we can also provide a different value for each environment by using the usual .NET environment-based configuration file override.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.769.1">The first step is the definition of a parameter object with the name of the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.770.1">"Parameters"</span></code><span class="koboSpan" id="kobo.771.1"> property that contains the actual value:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.772.1">var</span></span><span class="koboSpan" id="kobo.773.1"> password = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.774.1">AddParameter</span></span><span class="koboSpan" id="kobo.775.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.776.1">"sqlpassword"</span></span><span class="koboSpan" id="kobo.777.1">, </span><span class="hljs-attr"><span class="koboSpan" id="kobo.778.1">secret</span></span><span class="koboSpan" id="kobo.779.1">: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.780.1">true</span></span><span class="koboSpan" id="kobo.781.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.782.1">By setting </span><code class="inlineCode"><span class="koboSpan" id="kobo.783.1">secret</span></code><span class="koboSpan" id="kobo.784.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.785.1">true</span></code><span class="koboSpan" id="kobo.786.1">, we enable the generation of a hint to store the parameter in a safe place when we run Aspire in publishing mode.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.787.1">Then, the parameter is placed in the right place of the resource extension method, which is resource-specific:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.788.1">var</span></span><span class="koboSpan" id="kobo.789.1"> sql = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.790.1">AddSqlServer</span></span><span class="koboSpan" id="kobo.791.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.792.1">"sql"</span></span><span class="koboSpan" id="kobo.793.1">, password)
                 .</span><span class="hljs-title"><span class="koboSpan" id="kobo.794.1">WithBindMount</span></span><span class="koboSpan" id="kobo.795.1">("</span><span class="hljs-title"><span class="koboSpan" id="kobo.796.1">MyVolumeName</span></span><span class="koboSpan" id="kobo.797.1">", "/</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.798.1">var</span></span><span class="koboSpan" id="kobo.799.1">/opt/mssql");
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.800.1">var</span></span><span class="koboSpan" id="kobo.801.1"> db = sql.</span><span class="hljs-title"><span class="koboSpan" id="kobo.802.1">AddDatabase</span></span><span class="koboSpan" id="kobo.803.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.804.1">"database"</span></span><span class="koboSpan" id="kobo.805.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.806.1">The actual value must be placed in the App Host project configuration file, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.807.1">{ 
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.808.1">"Parameters":</span></span><span class="koboSpan" id="kobo.809.1"> {
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.810.1">"sqlpassword":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.811.1">"my_password_value"</span></span><span class="koboSpan" id="kobo.812.1">,
   </span><span class="hljs-string"><span class="koboSpan" id="kobo.813.1">…</span></span><span class="koboSpan" id="kobo.814.1">
  },
  </span><span class="hljs-string"><span class="koboSpan" id="kobo.815.1">…</span></span><span class="koboSpan" id="kobo.816.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.817.1">The next subsection describes how to integrate Azure Functions projects in .NET Aspire solutions.</span></p>
<h2 class="heading-2" id="_idParaDest-251"><a id="_idTextAnchor360"/><span class="koboSpan" id="kobo.818.1">Azure Functions integration</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.819.1">At the time of writing this book, the integration of Azure Functions projects in .NET Aspire solutions is </span><a id="_idIndexMarker1015"/><span class="koboSpan" id="kobo.820.1">in preview. </span><span class="koboSpan" id="kobo.820.2">However, we will describe it briefly since it offers great opportunities.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.821.1">At the moment, only Azure </span><a id="_idIndexMarker1016"/><span class="koboSpan" id="kobo.822.1">Functions with the following triggers are supported: Azure Event Hubs, Azure Service Bus, Azure Blob storage, Azure Queue storage, Azure CosmosDB, HTTP, and Timer.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.823.1">In order to configure an Azure Functions project, the App Host must reference the </span><code class="inlineCode"><span class="koboSpan" id="kobo.824.1">Aspire.Hosting.Azure.Functions</span></code><span class="koboSpan" id="kobo.825.1"> NuGet package. </span><span class="koboSpan" id="kobo.825.2">Once this reference has been added, an Azure Functions project can be configured, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.826.1">var</span></span><span class="koboSpan" id="kobo.827.1"> myFunction = builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.828.1">AddAzureFunctionsProject</span></span><span class="koboSpan" id="kobo.829.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.830.1">Projects</span></span><span class="koboSpan" id="kobo.831.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.832.1">MyFunctionsProject</span></span><span class="koboSpan" id="kobo.833.1">&gt;(
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.834.1">" MyFunction "</span></span><span class="koboSpan" id="kobo.835.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.836.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.837.1">AddAzureFunctionsProject</span></code><span class="koboSpan" id="kobo.838.1"> call can be chained with the usual configuration methods of all other project types, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.839.1">WithExternalHttpEndpoints()</span></code><span class="koboSpan" id="kobo.840.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.841.1">Once defined in this way, </span><code class="inlineCode"><span class="koboSpan" id="kobo.842.1">myFunction</span></code><span class="koboSpan" id="kobo.843.1"> can be referred to by other projects with the usual methods:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.844.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.845.1">AddProject</span></span><span class="koboSpan" id="kobo.846.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.847.1">Projects</span></span><span class="koboSpan" id="kobo.848.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.849.1">MyOtherProject</span></span><span class="koboSpan" id="kobo.850.1">&gt;()
       .</span><span class="hljs-title"><span class="koboSpan" id="kobo.851.1">WithReference</span></span><span class="koboSpan" id="kobo.852.1">(myFunction)
       .</span><span class="hljs-title"><span class="koboSpan" id="kobo.853.1">WaitFor</span></span><span class="koboSpan" id="kobo.854.1">(myFunction);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.855.1">A local emulator of an Azure storage account may be added as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.856.1">var</span></span><span class="koboSpan" id="kobo.857.1"> storage = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.858.1">AddAzureStorage</span></span><span class="koboSpan" id="kobo.859.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.860.1">"storage"</span></span><span class="koboSpan" id="kobo.861.1">)
                     .</span><span class="hljs-title"><span class="koboSpan" id="kobo.862.1">RunAsEmulator</span></span><span class="koboSpan" id="kobo.863.1">();
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.864.1">var</span></span><span class="koboSpan" id="kobo.865.1"> myFunction = builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.866.1">AddAzureFunctionsProject</span></span><span class="koboSpan" id="kobo.867.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.868.1">Projects</span></span><span class="koboSpan" id="kobo.869.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.870.1">MyFunctionsProject</span></span><span class="koboSpan" id="kobo.871.1">&gt;(
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.872.1">" MyFunction "</span></span><span class="koboSpan" id="kobo.873.1">)
.</span><span class="hljs-title"><span class="koboSpan" id="kobo.874.1">WithHostStorage</span></span><span class="koboSpan" id="kobo.875.1">(storage)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.876.1">The emulator relies on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.877.1">Aspire.Hosting.Azure.Storage</span></code><span class="koboSpan" id="kobo.878.1"> NuGet package, which must be added to the App Host project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.879.1">References to other Azure resources can be added with </span><code class="inlineCode"><span class="koboSpan" id="kobo.880.1">WithReference</span></code><span class="koboSpan" id="kobo.881.1">, as usual. </span><span class="koboSpan" id="kobo.881.2">For instance, an Azure function with a Blob storage trigger on an emulated blob may be defined as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.882.1">var</span></span><span class="koboSpan" id="kobo.883.1"> storage = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.884.1">AddAzureStorage</span></span><span class="koboSpan" id="kobo.885.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.886.1">"storage"</span></span><span class="koboSpan" id="kobo.887.1">)
                     .</span><span class="hljs-title"><span class="koboSpan" id="kobo.888.1">RunAsEmulator</span></span><span class="koboSpan" id="kobo.889.1">();
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.890.1">var</span></span><span class="koboSpan" id="kobo.891.1"> blob = storage.</span><span class="hljs-title"><span class="koboSpan" id="kobo.892.1">AddBlobs</span></span><span class="koboSpan" id="kobo.893.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.894.1">"blob"</span></span><span class="koboSpan" id="kobo.895.1">);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.896.1">var</span></span><span class="koboSpan" id="kobo.897.1"> myFunction = builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.898.1">AddAzureFunctionsProject</span></span><span class="koboSpan" id="kobo.899.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.900.1">Projects</span></span><span class="koboSpan" id="kobo.901.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.902.1">MyFunctionsProject</span></span><span class="koboSpan" id="kobo.903.1">&gt;(
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.904.1">" MyFunction "</span></span><span class="koboSpan" id="kobo.905.1">)
.</span><span class="hljs-title"><span class="koboSpan" id="kobo.906.1">WithHostStorage</span></span><span class="koboSpan" id="kobo.907.1">(storage)
.</span><span class="hljs-title"><span class="koboSpan" id="kobo.908.1">WithReference</span></span><span class="koboSpan" id="kobo.909.1">(blob);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.910.1">This concludes </span><a id="_idIndexMarker1017"/><span class="koboSpan" id="kobo.911.1">our .NET Aspire description. </span><span class="koboSpan" id="kobo.911.2">In the next </span><a id="_idIndexMarker1018"/><span class="koboSpan" id="kobo.912.1">section, we will see how to translate the Kubernetes example of </span><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.913.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.914.1">, </span><em class="italic"><span class="koboSpan" id="kobo.915.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.916.1">, to run with Aspire. </span><span class="koboSpan" id="kobo.916.2">Finally, the </span><em class="italic"><span class="koboSpan" id="kobo.917.1">Deploying a .NET Aspire project</span></em><span class="koboSpan" id="kobo.918.1"> section will discuss how to use Aspire to generate the code for our target orchestrators, either manually or with automatic code generator tools.</span></p>
<h1 class="heading-1" id="_idParaDest-252"><a id="_idTextAnchor361"/><span class="koboSpan" id="kobo.919.1">Using .NET Aspire in practice</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.920.1">In this section, we will adapt the Kubernetes example of </span><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.921.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.922.1">, </span><em class="italic"><span class="koboSpan" id="kobo.923.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.924.1">, to run with Aspire. </span><span class="koboSpan" id="kobo.924.2">As a first step, let’s copy the whole solution folder into </span><a id="_idIndexMarker1019"/><span class="koboSpan" id="kobo.925.1">another in a different location, so we can modify it without destroying the previous version.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.926.1">Then, let’s execute the following steps to prepare the overall solution:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.927.1">Add </span><a id="_idTextAnchor362"/><span class="koboSpan" id="kobo.928.1">a new App Host project to the solution and call it </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.929.1">CarSharingAppHost</span></code><span class="koboSpan" id="kobo.930.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.931.1">Add a new .NET Aspire Service Defaults project to the solution and call it</span><a id="_idTextAnchor363"/> <code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.932.1">CarSharingServiceDefaults</span></code><span class="koboSpan" id="kobo.933.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.934.1">Add a reference to the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.935.1">FakeSource</span></code><span class="koboSpan" id="kobo.936.1">, </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.937.1">FakeDestination</span></code><span class="koboSpan" id="kobo.938.1">, and </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.939.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.940.1"> projects to the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.941.1">CarSharingAppHost</span></code><span class="koboSpan" id="kobo.942.1"> project.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.943.1">Add a reference to the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.944.1">CarSharingServiceDefaults</span></code><span class="koboSpan" id="kobo.945.1"> project to the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.946.1">FakeSource</span></code><span class="koboSpan" id="kobo.947.1">, </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.948.1">FakeDestination</span></code><span class="koboSpan" id="kobo.949.1">, and </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.950.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.951.1"> projects.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.952.1">Right-click on the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.953.1">CarSharingAppHost</span></code><span class="koboSpan" id="kobo.954.1"> project and, in the menu that appears, select </span><strong class="screenText"><span class="koboSpan" id="kobo.955.1">Set as Startup Project</span></strong><span class="koboSpan" id="kobo.956.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.957.1">The preceding steps prepare the solution for .NET Aspire. </span><span class="koboSpan" id="kobo.957.2">Now, let’s start modifying the code. </span><span class="koboSpan" id="kobo.957.3">As a first step, we must add service defaults to all the microservices. </span><span class="koboSpan" id="kobo.957.4">Therefore, let’s add </span><code class="inlineCode"><span class="koboSpan" id="kobo.958.1">builder.AddServiceDefaults();</span></code><span class="koboSpan" id="kobo.959.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.960.1">program.cs</span></code><span class="koboSpan" id="kobo.961.1"> file of the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.962.1">FakeSource</span></code><span class="koboSpan" id="kobo.963.1">, </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.964.1">FakeDestination</span></code><span class="koboSpan" id="kobo.965.1">, and </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.966.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.967.1"> projects. </span><span class="koboSpan" id="kobo.967.2">Then, we must add </span><code class="inlineCode"><span class="koboSpan" id="kobo.968.1">app.MapDefaultEndpoints()</span></code><span class="koboSpan" id="kobo.969.1">, which adds health endpoints just to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.970.1">program.cs</span></code><span class="koboSpan" id="kobo.971.1"> file of the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.972.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.973.1"> project, since it is the only web project that we have among our microservices. </span><span class="koboSpan" id="kobo.973.2">It must be placed as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.974.1">var</span></span><span class="koboSpan" id="kobo.975.1"> app = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.976.1">Build</span></span><span class="koboSpan" id="kobo.977.1">();
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.978.1">app.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.979.1">MapDefaultEndpoints</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.980.1">();</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.981.1">Now, let’s remember that we added all the microservices parameters as environment variables in their </span><code class="inlineCode"><span class="koboSpan" id="kobo.982.1">Properties/launcheSettings.json</span></code><span class="koboSpan" id="kobo.983.1"> file. </span><span class="koboSpan" id="kobo.983.2">We placed them in the Docker launch settings. </span><span class="koboSpan" id="kobo.983.3">Now, since these projects will not use Docker anymore while running in Aspire, we must </span><a id="_idIndexMarker1020"/><span class="koboSpan" id="kobo.984.1">copy all these definitions into the other launch setting profile.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.985.1">This is the launch settings code of the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.986.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.987.1"> project after this change:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.988.1">{
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.989.1">"profiles":</span></span><span class="koboSpan" id="kobo.990.1"> {
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.991.1">"http":</span></span><span class="koboSpan" id="kobo.992.1"> {
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.993.1">"commandName":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.994.1">"Project"</span></span><span class="koboSpan" id="kobo.995.1">,
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.996.1">"environmentVariables":</span></span><span class="koboSpan" id="kobo.997.1"> {
       
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.998.1">//place</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.999.1">here</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1000.1">your</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1001.1">environment</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1002.1">variables</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1003.1">"ConnectionStrings__DefaultConnection":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1004.1">"Server=localhost;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1005.1">            Database=RoutesPlanning;User Id=sa;Password=Passw0rd_;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1006.1">            Trust Server Certificate=True;MultipleActiveResultSets=true"</span></span><span class="koboSpan" id="kobo.1007.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1008.1">"ConnectionStrings__RabbitMQConnection":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1009.1">"host=localhost:5672;</span></span>
<span class="hljs-string"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1010.1">username=guest;password=_myguest;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1011.1">publisherConfirms=true;timeout=10”</span></span><span class="koboSpan" id="kobo.1012.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1013.1">"Messages__SubscriptionIdPrefix":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1014.1">"routesPlanning"</span></span><span class="koboSpan" id="kobo.1015.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1016.1">"Topology__MaxDistanceKm":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1017.1">"50"</span></span><span class="koboSpan" id="kobo.1018.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1019.1">"Topology__MaxMatches":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1020.1">"5"</span></span><span class="koboSpan" id="kobo.1021.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1022.1">"Timing__HousekeepingIntervalHours":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1023.1">"48"</span></span><span class="koboSpan" id="kobo.1024.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1025.1">"Timing__HousekeepingDelayDays":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1026.1">"10"</span></span><span class="koboSpan" id="kobo.1027.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1028.1">"Timing__OutputEmptyDelayMS":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1029.1">"500"</span></span><span class="koboSpan" id="kobo.1030.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1031.1">"Timing__OutputBatchCount":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1032.1">"10"</span></span><span class="koboSpan" id="kobo.1033.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1034.1">"Timing__OutputRequeueDelayMin":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1035.1">"5"</span></span><span class="koboSpan" id="kobo.1036.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1037.1">"Timing__OutputCircuitBreakMin":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1038.1">"4"</span></span><span class="koboSpan" id="kobo.1039.1">
      },
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1040.1">"dotnetRunMessages":</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1041.1">true</span></span><span class="koboSpan" id="kobo.1042.1">,
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1043.1">"applicationUrl":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1044.1">"http://localhost:5212"</span></span><span class="koboSpan" id="kobo.1045.1">
    },
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1046.1">"Container (Dockerfile)":</span></span><span class="koboSpan" id="kobo.1047.1"> {
</span><span class="hljs-string"><span class="koboSpan" id="kobo.1048.1">…</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1049.1">…</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1050.1">We replaced </span><code class="inlineCode"><span class="koboSpan" id="kobo.1051.1">host.docker.internal</span></code><span class="koboSpan" id="kobo.1052.1"> with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1053.1">localhost</span></code><span class="koboSpan" id="kobo.1054.1"> in all connection strings as, when running in Aspire, our microservices will not access the SQL database and the RabbitMQ message broker from inside a Docker container image but directly from the development machine.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1055.1">Similarly, the launch </span><a id="_idIndexMarker1021"/><span class="koboSpan" id="kobo.1056.1">settings of </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1057.1">FakeSource</span></code><span class="koboSpan" id="kobo.1058.1"> become the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1059.1">{
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1060.1">"profiles":</span></span><span class="koboSpan" id="kobo.1061.1"> {
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1062.1">"FakeSource":</span></span><span class="koboSpan" id="kobo.1063.1"> {
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1064.1">"commandName":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1065.1">"Project"</span></span><span class="koboSpan" id="kobo.1066.1">,
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1067.1">"environmentVariables":</span></span><span class="koboSpan" id="kobo.1068.1"> {
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1069.1">"</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1070.1">DOTNET_ENVIRONMENT":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1071.1">"Development"</span></span><span class="koboSpan" id="kobo.1072.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1073.1">"ConnectionStrings__RabbitMQConnection":</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1074.1">"host=localhost:5672;username=guest;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1075.1">            password=_myguest;publisherConfirms=true;timeout=10"</span></span><span class="koboSpan" id="kobo.1076.1">
      },
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1077.1">"dotnetRunMessages":</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1078.1">true</span></span><span class="koboSpan" id="kobo.1079.1">
    },
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1080.1">"Container (Dockerfile)":</span></span><span class="koboSpan" id="kobo.1081.1"> {
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1082.1">"commandName":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1083.1">"Docker"</span></span><span class="koboSpan" id="kobo.1084.1">,
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1085.1">"environmentVariables":</span></span><span class="koboSpan" id="kobo.1086.1"> {
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1087.1">"</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1088.1">ConnectionStrings__RabbitMQConnection":</span></span>
<span class="hljs-string"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1089.1">“host=host.docker.internal:5672;</span></span>
<span class="hljs-string"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1090.1">username=guest;password=_myguest;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1091.1">            publisherConfirms=true;timeout=10”</span></span><span class="koboSpan" id="kobo.1092.1">
      }
    }
  },
  </span><span class="hljs-string"><span class="koboSpan" id="kobo.1093.1">"$schema":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1094.1">"https://json.schemastore.org/launchsettings.json"</span></span><span class="koboSpan" id="kobo.1095.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1096.1">Finally, the launch settings of </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1097.1">FakeDestination</span></code><span class="koboSpan" id="kobo.1098.1"> become the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1099.1">{
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1100.1">"profiles":</span></span><span class="koboSpan" id="kobo.1101.1"> {
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1102.1">"FakeDestination":</span></span><span class="koboSpan" id="kobo.1103.1"> {
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1104.1">"commandName":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1105.1">"Project"</span></span><span class="koboSpan" id="kobo.1106.1">,
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1107.1">"</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1108.1">environmentVariables":</span></span><span class="koboSpan" id="kobo.1109.1"> {
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1110.1">"DOTNET_ENVIRONMENT":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1111.1">"Development"</span></span><span class="koboSpan" id="kobo.1112.1">,
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1113.1">"ConnectionStrings__RabbitMQConnection":</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1114.1">"host=localhost:5672;username=guest;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1115.1">            password=_myguest;publisherConfirms=true;timeout=10"</span></span><span class="koboSpan" id="kobo.1116.1">
      },
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1117.1">"dotnetRunMessages":</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1118.1">true</span></span><span class="koboSpan" id="kobo.1119.1">
    },
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1120.1">"Container (Dockerfile)":</span></span><span class="koboSpan" id="kobo.1121.1"> {
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1122.1">"commandName":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1123.1">"Docker"</span></span><span class="koboSpan" id="kobo.1124.1">,
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1125.1">"</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1126.1">environmentVariables":</span></span><span class="koboSpan" id="kobo.1127.1"> {
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1128.1">"ConnectionStrings__RabbitMQConnection":</span></span>
<span class="hljs-string"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1129.1">“host=host.docker.internal:5672;</span></span>
<span class="hljs-string"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1130.1">username=guest;password=_myguest;</span></span>
<span class="hljs-string"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1131.1">publisherConfirms=true;timeout=10</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1132.1">"</span></span><span class="koboSpan" id="kobo.1133.1">
      }
    }
  },
  </span><span class="hljs-string"><span class="koboSpan" id="kobo.1134.1">"$schema":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1135.1">"https://json.schemastore.org/launchsettings.json"</span></span><span class="koboSpan" id="kobo.1136.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1137.1">The content of both the RabbitMQ and SQL Server connection strings shows that we decided to use pre-existing RabbitMQ and SQL instances that run outside of Aspire. </span><span class="koboSpan" id="kobo.1137.2">This was the simplest choice for this solution since the whole code was already organized to run this way. </span><span class="koboSpan" id="kobo.1137.3">However, it is often the best choice when we start a solution from scratch since instances that live when the App </span><a id="_idIndexMarker1022"/><span class="koboSpan" id="kobo.1138.1">Host is not running are simpler to handle during development.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1139.1">In fact, we can pass database migrations to the database with no need to launch the App Host while we are working with migrations. </span><span class="koboSpan" id="kobo.1139.2">Similarly, we can inspect RabbitMQ from its browser console when the App Host is not running.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1140.1">Another alternative would be to split the whole App Host configuration code into two code zones. </span><span class="koboSpan" id="kobo.1140.2">The first code zone contains databases and message brokers that we need to manipulate when the application is not running, and the second code zone contains all other resources and microservices configuration.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1141.1">When we need to manipulate the resources defined in the first code zone, we comment out the whole second zone code and run the App Host. </span><span class="koboSpan" id="kobo.1141.2">After finishing working with migrations and inspecting the RabbitMQ queue, we uncomment the second code zone that defines and configures all other resources and microservices, and run the whole application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1142.1">The preceding methodology can be refined by defining a Boolean App Host environment variable that selects the second configuration zone with an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1143.1">if</span></code><span class="koboSpan" id="kobo.1144.1"> statement.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1145.1">After this premise, we can write our configuration code in the App Host </span><code class="inlineCode"><span class="koboSpan" id="kobo.1146.1">program.cs</span></code><span class="koboSpan" id="kobo.1147.1"> file.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1148.1">Since, in our case, each microservice has multiple launch settings profiles, we must specify the right profile to use with each microservice in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1149.1">AddProject</span></code><span class="koboSpan" id="kobo.1150.1"> fluent interface method.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1151.1">Moreover, since </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1152.1">FakeSource</span></code><span class="koboSpan" id="kobo.1153.1"> sends data to the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1154.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.1155.1"> microservice, and the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1156.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.1157.1"> microservice sends data to the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1158.1">FakeDestination</span></code><span class="koboSpan" id="kobo.1159.1"> service, we must ensure that </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1160.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.1161.1"> starts after </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1162.1">FakeDestination</span></code><span class="koboSpan" id="kobo.1163.1"> has been started and </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1164.1">FakeSource</span></code><span class="koboSpan" id="kobo.1165.1"> starts only after </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1166.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.1167.1"> has started. </span><span class="koboSpan" id="kobo.1167.2">We don’t need </span><code class="inlineCode"><span class="koboSpan" id="kobo.1168.1">WithReference</span></code><span class="koboSpan" id="kobo.1169.1"> since not all microservices communicate directly, but rather, communicate through a RabbitMQ instance, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1170.1">WithReference</span></code><span class="koboSpan" id="kobo.1171.1"> is only needed to inject information for communicating directly with a resource. </span><span class="koboSpan" id="kobo.1171.2">We don’t </span><a id="_idIndexMarker1023"/><span class="koboSpan" id="kobo.1172.1">need to declare a reference to RabbitMQ either, since we are using an external RabbitMQ instance that runs outside of the App Host, so we already have its connection string.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1173.1">It is easy to fulfill all constraints with the following configuration code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1174.1">var</span></span><span class="koboSpan" id="kobo.1175.1"> builder = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1176.1">DistributedApplication</span></span><span class="koboSpan" id="kobo.1177.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1178.1">CreateBuilder</span></span><span class="koboSpan" id="kobo.1179.1">(args);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1180.1">var</span></span><span class="koboSpan" id="kobo.1181.1"> fakeDestination=builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1182.1">AddProject</span></span><span class="koboSpan" id="kobo.1183.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1184.1">Projects</span></span><span class="koboSpan" id="kobo.1185.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1186.1">FakeDestination</span></span><span class="koboSpan" id="kobo.1187.1">&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1188.1">"fakedestination"</span></span><span class="koboSpan" id="kobo.1189.1">,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1190.1">"FakeDestination"</span></span><span class="koboSpan" id="kobo.1191.1">);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1192.1">var</span></span><span class="koboSpan" id="kobo.1193.1"> routesPlanning = builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1194.1">AddProject</span></span><span class="koboSpan" id="kobo.1195.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1196.1">Projects</span></span><span class="koboSpan" id="kobo.1197.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1198.1">RoutesPlanning</span></span><span class="koboSpan" id="kobo.1199.1">&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1200.1">"routesplanning"</span></span><span class="koboSpan" id="kobo.1201.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1202.1">"http"</span></span><span class="koboSpan" id="kobo.1203.1">)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1204.1">WaitFor</span></span><span class="koboSpan" id="kobo.1205.1">(fakeDestination);
builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1206.1">AddProject</span></span><span class="koboSpan" id="kobo.1207.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1208.1">Projects</span></span><span class="koboSpan" id="kobo.1209.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1210.1">FakeSource</span></span><span class="koboSpan" id="kobo.1211.1">&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1212.1">"fakesource"</span></span><span class="koboSpan" id="kobo.1213.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1214.1">"FakeSource"</span></span><span class="koboSpan" id="kobo.1215.1">)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1216.1">WaitFor</span></span><span class="koboSpan" id="kobo.1217.1">(routesPlanning);
builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1218.1">Build</span></span><span class="koboSpan" id="kobo.1219.1">().</span><span class="hljs-title"><span class="koboSpan" id="kobo.1220.1">Run</span></span><span class="koboSpan" id="kobo.1221.1">();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1222.1">Here, the second argument of each </span><code class="inlineCode"><span class="koboSpan" id="kobo.1223.1">AddProject</span></code><span class="koboSpan" id="kobo.1224.1"> call is the name of the launch profile to use for each microservice.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1225.1">Let’s ensure that both the RabbitMQ and SQL Server external Docker containers are running, and then launch our solution.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1226.1">If everything is working properly, you should see something like the following figure in the Aspire browser console:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1227.1"><img alt="Figure 12.2: App Host resources list" src="../Images/B31916_12_2.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1228.1">Figure 12.2: App Host resources list</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1229.1">Let’s click the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1230.1">Console</span></strong><span class="koboSpan" id="kobo.1231.1"> icon in the left menu to inspect all microservice logs. </span><span class="koboSpan" id="kobo.1231.2">Let’s choose </span><strong class="screenText"><span class="koboSpan" id="kobo.1232.1">fakedestination</span></strong><span class="koboSpan" id="kobo.1233.1">; you should see something like the following figure:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1234.1"><img alt="Figure 12.3: The fakedestination console" src="../Images/B31916_12_3.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1235.1">Figure 12.3: The fakedestination console</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1236.1">Logs should contain information about the connection with RabbitMQ through EasyNetQ and about the worker service start. </span><span class="koboSpan" id="kobo.1236.2">Finally, you should see two messages coming from the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1237.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.1238.1"> microservice that declare that two matches have been found.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1239.1">Since all Microservices </span><a id="_idIndexMarker1024"/><span class="koboSpan" id="kobo.1240.1">use the same RabbitMQ connection string, we can improve the whole code organization by removing it from each microservice’s launch settings and factoring it out into the App Host configuration with the help of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1241.1">AddConnectionString</span></code><span class="koboSpan" id="kobo.1242.1">, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1243.1">builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1244.1">AddConnectionString</span></span><span class="koboSpan" id="kobo.1245.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1246.1">"RabbitMQParameterName"</span></span><span class="koboSpan" id="kobo.1247.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1248.1">"RabbitMQConnection"</span></span><span class="koboSpan" id="kobo.1249.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1250.1">Here, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1251.1">RabbitMQParameterNam</span></code><span class="koboSpan" id="kobo.1252.1">e is the name of the App Host configuration parameter that contains the actual connection string:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1253.1">{
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1254.1">"Parameters":</span></span><span class="koboSpan" id="kobo.1255.1"> {
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1256.1">"RabbitMQParameterName":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1257.1">"host=localhost:5672;username=guest;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1258.1">            password=_myguest;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1259.1">        publisherConfirms=true;timeout=10"</span></span><span class="koboSpan" id="kobo.1260.1">
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1261.1">In the next subsection, we will describe how to modify the code to run RabbitMQ inside the App Host.</span></p>
<h2 class="heading-2" id="_idParaDest-253"><a id="_idTextAnchor364"/><span class="koboSpan" id="kobo.1262.1">RabbitMQ integration</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1263.1">RabbitMQ is supported by Aspire integration so we can run it also inside the App Host. </span><span class="koboSpan" id="kobo.1263.2">The first step for </span><a id="_idIndexMarker1025"/><span class="koboSpan" id="kobo.1264.1">doing this is the addition of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1265.1">Aspire.Hosting.RabbitMQ</span></code><span class="koboSpan" id="kobo.1266.1"> NuGet package.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1267.1">Then, we need </span><a id="_idIndexMarker1026"/><span class="koboSpan" id="kobo.1268.1">to configure the RabbitMQ instance:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1269.1">var</span></span><span class="koboSpan" id="kobo.1270.1"> username = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1271.1">AddParameter</span></span><span class="koboSpan" id="kobo.1272.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1273.1">"rabbitmqusername"</span></span><span class="koboSpan" id="kobo.1274.1">, </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1275.1">secret</span></span><span class="koboSpan" id="kobo.1276.1">: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1277.1">true</span></span><span class="koboSpan" id="kobo.1278.1">);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1279.1">var</span></span><span class="koboSpan" id="kobo.1280.1"> password = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1281.1">AddParameter</span></span><span class="koboSpan" id="kobo.1282.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1283.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1284.1">rabbitmqpassword"</span></span><span class="koboSpan" id="kobo.1285.1">, </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1286.1">secret</span></span><span class="koboSpan" id="kobo.1287.1">: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1288.1">true</span></span><span class="koboSpan" id="kobo.1289.1">);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1290.1">var</span></span><span class="koboSpan" id="kobo.1291.1"> rabbitmq = builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1292.1">AddRabbitMQ</span></span><span class="koboSpan" id="kobo.1293.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1294.1">"RabbitMQConnection"</span></span><span class="koboSpan" id="kobo.1295.1">, username, password)
       .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1296.1">WithManagementPlugin</span></span><span class="koboSpan" id="kobo.1297.1">()
       .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1298.1">WithDataVolume</span></span><span class="koboSpan" id="kobo.1299.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.1300.1">isReadOnly</span></span><span class="koboSpan" id="kobo.1301.1">: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1302.1">false</span></span><span class="koboSpan" id="kobo.1303.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1304.1">Here, we added a volume to persist data after the App Host is shut down and required the installation of the browser management console, so we can inspect all queues and can also configure the instance. </span><span class="koboSpan" id="kobo.1304.2">The actual username and password must be provided in the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1305.1">"Parameters"</span></code><span class="koboSpan" id="kobo.1306.1"> section of the App Host configuration file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1307.1">{
  </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1308.1">"Parameters":</span></span><span class="koboSpan" id="kobo.1309.1"> {
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1310.1">"rabbitmqusername":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1311.1">"&lt;username&gt;"</span></span><span class="koboSpan" id="kobo.1312.1">,
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1313.1">"rabbitmqpassword":</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1314.1">"&lt;password&gt;"</span></span><span class="koboSpan" id="kobo.1315.1">
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1316.1">After that, we must declare a reference to this RabbitMQ instance in all microservices with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1317.1">WithReference(rabbitmq)</span></code><span class="koboSpan" id="kobo.1318.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1319.1">At this point, we need to remove the RabbitMQ connection strings from all the launch settings of our microservices since the same connection string will now be injected by the App Host.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1320.1">Unfortunately, the injected connection string is not in the format needed by EasyNetQ but has the following format:</span></p>
<pre class="programlisting code"><code class="hljs-code"><code class="inlineCode"><span class="koboSpan" id="kobo.1321.1">amqp://username:password@&lt;host url&gt;:5672</span></code><span class="koboSpan" id="kobo.1322.1">.
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1323.1">The simplest way to solve this problem is to write a string manipulation method that converts this string and adds all other auxiliary information. </span><span class="koboSpan" id="kobo.1323.2">We can define this method in the Service Defaults project so it will be available to all microservices.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1324.1">We need just to extract the URL, username, and password and then we may use them to build the connection string in the format needed by EasyNetQ. </span><span class="koboSpan" id="kobo.1324.2">This can be done by splitting the string on </span><code class="inlineCode"><span class="koboSpan" id="kobo.1325.1">//</span></code><span class="koboSpan" id="kobo.1326.1">, then on </span><code class="inlineCode"><span class="koboSpan" id="kobo.1327.1">@</span></code><span class="koboSpan" id="kobo.1328.1">, and finally, on </span><code class="inlineCode"><span class="koboSpan" id="kobo.1329.1">:</span></code><span class="koboSpan" id="kobo.1330.1"> to get username and password.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1331.1">In the last section, we will describe how to get the configuration needed by our target orchestrator for an Aspire project.</span></p>
<h1 class="heading-1" id="_idParaDest-254"><a id="_idTextAnchor365"/><span class="koboSpan" id="kobo.1332.1">Deploying a .NET Aspire project</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1333.1">.NET Aspire can </span><a id="_idIndexMarker1027"/><span class="koboSpan" id="kobo.1334.1">be used to test an application or a small part </span><a id="_idIndexMarker1028"/><span class="koboSpan" id="kobo.1335.1">of a complex microservice application on the development machine, thus replacing minikube and Docker networks.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1336.1">However, small applications can be completely implemented in Aspire and then the Aspire code can be used to generate the configuration of the target orchestrator. </span><span class="koboSpan" id="kobo.1336.2">This generation can be manual or based on automatic tools.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1337.1">Both manual generation and automatic tools rely on a JSON manifest that can be created automatically and that describes the application configuration. </span><span class="koboSpan" id="kobo.1337.2">The JSON manifest can be generated by adding the following launch profile to the App Host project’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1338.1">launchSettings.json</span></code><span class="koboSpan" id="kobo.1339.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.1340.1">"profiles"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1341.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.1342.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1343.1">"generate-manifest"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1344.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.1345.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1346.1">"commandName"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1347.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1348.1">"Project"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1349.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1350.1">"launchBrowser"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1351.1">:</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1352.1">false</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1353.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1354.1">"dotnetRunMessages"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1355.1">:</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1356.1">true</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1357.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1358.1">"commandLineArgs"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1359.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1360.1">"--publisher manifest --output-path aspire-</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1361.1">                        manifest.json"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.1362.1">}</span></span><span class="koboSpan" id="kobo.1363.1">
…
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1364.1">Once added to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1365.1">launchSettings.json</span></code><span class="koboSpan" id="kobo.1366.1">, this profile appears in the Visual Studio profile selection combo next to the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1367.1">Run</span></strong><span class="koboSpan" id="kobo.1368.1"> button. </span><span class="koboSpan" id="kobo.1368.2">It is enough to select the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1369.1">"generate-manifest"</span></code><span class="koboSpan" id="kobo.1370.1"> profile and run the solution. </span><span class="koboSpan" id="kobo.1370.2">When the solution runs, the application is compiled but, instead of running, it creates the JSON manifest in the App Host project folder.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1371.1">You can manually read this manifest and use the information it contains to configure your orchestrator, or you can use automatic tools that generate the manifest and use it to automatically configure an orchestrator.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1372.1">Visual Studio natively supports the deployment of Azure Container Apps. </span><span class="koboSpan" id="kobo.1372.2">Publishing to Azure Container Apps is straightforward. </span><span class="koboSpan" id="kobo.1372.3">It is enough to right-click on the solution’s App Host project and select </span><strong class="keyWord"><span class="koboSpan" id="kobo.1373.1">Publish</span></strong><span class="koboSpan" id="kobo.1374.1">. </span><span class="koboSpan" id="kobo.1374.2">After that, you can select the Azure Container Apps publish target. </span><span class="koboSpan" id="kobo.1374.3">The procedure will drive you to connect to your Azure subscription and provide all the information needed to publish the application,</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1375.1">The </span><strong class="keyWord"><span class="koboSpan" id="kobo.1376.1">Publish</span></strong><span class="koboSpan" id="kobo.1377.1"> wizard will </span><a id="_idIndexMarker1029"/><span class="koboSpan" id="kobo.1378.1">publish all microservices as Azure Container Apps </span><a id="_idIndexMarker1030"/><span class="koboSpan" id="kobo.1379.1">applications and will provision all other resources defined in the App Host in Azure, such as databases and other Azure resources.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1380.1">An external tool called Aspir8 (</span><a href="https://prom3theu5.github.io/aspirational-manifests/getting-started.html"><span class="url"><span class="koboSpan" id="kobo.1381.1">https://prom3theu5.github.io/aspirational-manifests/getting-started.html</span></span></a><span class="koboSpan" id="kobo.1382.1">) is also available, which is capable of deploying the application on </span><a id="_idIndexMarker1031"/><span class="koboSpan" id="kobo.1383.1">a Kubernetes cluster. </span><span class="koboSpan" id="kobo.1383.2">However, in this case, it will create just Kubernetes Deployments and Services.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1384.1">Once installed, Aspir8 supports the following commands:</span></p>
<ul>
<li class="bulletList"><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1385.1">aspirate init</span></code><span class="koboSpan" id="kobo.1386.1">: Initializes the Aspir8 project in the current directory</span></li>
<li class="bulletList"><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1387.1">aspirate generate</span></code><span class="koboSpan" id="kobo.1388.1">: Generates Kubernetes manifests based on the .NET Aspire app host manifest</span></li>
<li class="bulletList"><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1389.1">aspirate apply</span></code><span class="koboSpan" id="kobo.1390.1">: Applies the generated Kubernetes manifests to the Kubernetes cluster</span></li>
<li class="bulletList"><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1391.1">aspirate destroy</span></code><span class="koboSpan" id="kobo.1392.1">: Deletes the resources created by the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1393.1">apply</span></code><span class="koboSpan" id="kobo.1394.1"> command</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1395.1">For a simple application, you can deploy directly on a Kubernetes cluster, and in the case of more complex applications, you can use the Kubernetes manifest as a starting point for designing the needed Kubernetes configuration.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1396.1">The </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1397.1">apply</span></code><span class="koboSpan" id="kobo.1398.1"> and </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1399.1">destroy</span></code><span class="koboSpan" id="kobo.1400.1"> commands need a </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1401.1">kubectl</span></code><span class="koboSpan" id="kobo.1402.1"> installation, and all operations are performed using the current </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1403.1">kubectl</span></code><span class="koboSpan" id="kobo.1404.1"> context. </span><span class="koboSpan" id="kobo.1404.2">Please refer to the </span><em class="italic"><span class="koboSpan" id="kobo.1405.1">Interacting with Kubernetes: kubectl, minikube, and AKS </span></em><span class="koboSpan" id="kobo.1406.1">section of</span><em class="italic"> </em><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.1407.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.1408.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1409.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.1410.1">, for a definition of the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1411.1">kubectl</span></code><span class="koboSpan" id="kobo.1412.1"> context.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1413.1">If you would like to manually inspect the manifest generated by the App Host, please refer to its official format documentation at </span><a href="https://learn.microsoft.com/en-us/dotnet/aspire/deployment/manifest-format"><span class="url"><span class="koboSpan" id="kobo.1414.1">https://learn.microsoft.com/en-us/dotnet/aspire/deployment/manifest-format</span></span></a><span class="koboSpan" id="kobo.1415.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-255"><a id="_idTextAnchor366"/><span class="koboSpan" id="kobo.1416.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1417.1">In this chapter, we described the opportunities and services offered by .NET Aspire. </span><span class="koboSpan" id="kobo.1417.2">We discussed how to configure a complex application made of microservices and other resources in the App Host project, and discussed in detail how service discovery works both in general and specifically with .NET Aspire.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1418.1">We described how environment variables containing all the information needed for the interaction between microservices and resources are automatically injected into all microservices by the App Host.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1419.1">Finally, we discussed how Aspire implements observability with the help of telemetry, and how App Host configuration can be used to generate automatic configuration for the target orchestrators.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1420.1">This chapter concludes our amazing journey among the concepts and technologies of modern distributed computing. </span><span class="koboSpan" id="kobo.1420.2">We hope that you enjoyed reading this book as much as we enjoyed writing it.</span></p>
<h1 class="heading-1" id="_idParaDest-256"><a id="_idTextAnchor367"/><span class="koboSpan" id="kobo.1421.1">Questions</span></h1>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1422.1">What are the Aspire-specific .NET SDK projects?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1423.1">.NET Aspire Starter Project, .NET Aspire Empty Project, .NET Aspire App Host, .NET Aspire Service Defaults, .and various NET Aspire Test projects.</span></p>
<ol>
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.1424.1">Is service discovery an Aspire-specific feature?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1425.1">No, it is a general .NET feature.</span></p>
<ol>
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.1426.1">How many service discovery providers come with the Aspire default settings?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1427.1">Just two.</span></p>
<ol>
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.1428.1">What is the best way to handle pre-existing resources that are not defined with the App Host but are shared by several microservices?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1429.1">The usage of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1430.1">AddConnectionString</span></code><span class="koboSpan" id="kobo.1431.1">.</span></p>
<ol>
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.1432.1">Does Aspir8 provision Azure resources, too?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1433.1">No, at moment it provisions just Kubernetes resources.</span></p>
<ol>
<li class="numberedList" value="6"><span class="koboSpan" id="kobo.1434.1">What is the purpose of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1435.1">WithReference</span></code><span class="koboSpan" id="kobo.1436.1"> fluent interface method?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1437.1">Declaring that a resource depends on another resource, meaning it needs information such as, URLs, and connection string, of that resource.</span></p>
<h1 class="heading-1" id="_idParaDest-257"><a id="_idTextAnchor368"/><span class="koboSpan" id="kobo.1438.1">Further reading</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1439.1">Official Aspire documentation: </span><a href="https://learn.microsoft.com/en-us/dotnet/aspire/get-started/aspire-overview"><span class="url"><span class="koboSpan" id="kobo.1440.1">https://learn.microsoft.com/en-us/dotnet/aspire/get-started/aspire-overview</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1441.1">All available Aspire integrations: </span><a href="https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/integrations-overview"><span class="url"><span class="koboSpan" id="kobo.1442.1">https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/integrations-overview</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1443.1">App Host configuration manifest format: </span><a href="https://learn.microsoft.com/en-us/dotnet/aspire/deployment/manifest-format "><span class="url"><span class="koboSpan" id="kobo.1444.1">https://learn.microsoft.com/en-us/dotnet/aspire/deployment/manifest-format</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1445.1">Aspir8: </span><a href="https://prom3theu5.github.io/aspirational-manifests/getting-started.html"><span class="url"><span class="koboSpan" id="kobo.1446.1">https://prom3theu5.github.io/aspirational-manifests/getting-started.html</span></span></a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-258"><a id="_idTextAnchor369"/><span class="koboSpan" id="kobo.1447.1">Join our community on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1448.1">Join our community’s Discord space for discussions with the author and other readers:</span></p>
<p class="normal"><a href="https://packt.link/PSMCSharp"><span class="url"><span class="koboSpan" id="kobo.1449.1">https://packt.link/PSMCSharp</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.1450.1"><img alt="A qr code with black squares  AI-generated content may be incorrect." src="../Images/B31916_Discord-QR-Code.png"/></span></p>
</div>


<div id="_idContainer236">
<p class="BM-packtLogo"><span class="koboSpan" id="kobo.1.1"><img alt="" role="presentation" src="../Images/Packt_Logo_New.png"/></span></p>
<p class="normal"><a href="http://packtpub.com"><span class="url"><span class="koboSpan" id="kobo.2.1">packtpub.com</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.3.1">Subscribe to our online digital library for full access to over 7,000 books and videos, as well as industry leading tools to help you plan your personal development and advance your career. </span><span class="koboSpan" id="kobo.3.2">For more information, please visit our website.</span></p>
<h1 class="heading-1" id="_idParaDest-259"><a id="_idTextAnchor370"/><span class="koboSpan" id="kobo.4.1">Why subscribe?</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.5.1">Spend less time learning and more time coding with practical eBooks and Videos from over 4,000 industry professionals</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.6.1">Improve your learning with Skill Plans built especially for you</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.7.1">Get a free eBook or video every month</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.8.1">Fully searchable for easy access to vital information</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.9.1">Copy and paste, print, and bookmark content</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.10.1">A</span><a id="_idTextAnchor371"/><span class="koboSpan" id="kobo.11.1">t </span><a href="http://www.packtpub.com"><span class="url"><span class="koboSpan" id="kobo.12.1">www.packtpub.com</span></span></a><span class="koboSpan" id="kobo.13.1">, you can also read a collection of free technical articles, sign up for a range of free newsletters, and receive exclusive discounts and offers on Packt books and eBooks.</span></p>
<p class="eop"/>
<h1 class="mainHeading" id="_idParaDest-260"><a id="_idTextAnchor372"/><span class="koboSpan" id="kobo.14.1">Other Books You May Enjoy</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.15.1">If you enjoyed this book, you may be interested in these other books by Packt:</span></p>
<p class="normal"><a href="https://www.packtpub.com/en-in/product/c-13-and-net-9-modern-cross-platform-development-fundamentals-9781835881231"><span class="koboSpan" id="kobo.16.1"><img alt="" role="presentation" src="../Images/9781835881231.jpg"/></span></a></p>
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.17.1">C# 13 and .NET 9 – Modern Cross-Platform Development Fundamentals</span></strong></p>
<p class="normal"><span class="koboSpan" id="kobo.18.1">Mark J. </span><span class="koboSpan" id="kobo.18.2">Price</span></p>
<p class="normal"><span class="koboSpan" id="kobo.19.1">ISBN: 978-1-83588-123-1</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.20.1">Discover the new features of .NET 9, including more flexible params and new LINQ like CountBy and Index</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.21.1">Leverage the new ASP.NET Core 9 features for optimized static assets, OpenAPI document generation, and HybridCache</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.22.1">Utilize the native AOT publish capability for faster startup and reduced memory footprint</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.23.1">Build rich web user interface experiences using Blazor in ASP.NET Core 9</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.24.1">Integrate and update databases in your applications using Entity Framework Core 9 models</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.25.1">Query and manipulate data using LINQ</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.26.1">Build powerful services using Minimal APIs</span></li>
</ul>
<p class="normal"><a href="https://www.packtpub.com/en-in/product/software-architecture-with-c-12-and-net-8-9781805122456"><span class="koboSpan" id="kobo.27.1"><img alt="" role="presentation" src="../Images/9781805122456.jpg"/></span></a></p>
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.28.1">Software Architecture with C# 12 and .NET 8</span></strong></p>
<p class="normal"><span class="koboSpan" id="kobo.29.1">Gabriel Baptista, Francesco Abbruzzese</span></p>
<p class="normal"><span class="koboSpan" id="kobo.30.1">ISBN: 978-1-80512-245-6</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.31.1">Program and maintain Azure DevOps and explore GitHub Projects</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.32.1">Manage software requirements to design functional and non-functional needs</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.33.1">Apply architectural approaches such as layered architecture and domain-driven design</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.34.1">Make effective choices between cloud-based and data storage solutions</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.35.1">Implement resilient frontend microservices, worker microservices, and distributed transactions</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.36.1">Understand when to use test-driven development (TDD) and alternative approaches</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.37.1">Choose the best option for cloud development, from IaaS to Serverless</span></li>
</ul>
<p class="eop"/>
<h1 class="heading-1" id="_idParaDest-261"><a id="_idTextAnchor373"/><span class="koboSpan" id="kobo.38.1">Packt is searching for authors like you</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.39.1">If you’re interested in becoming an author for Packt, please visit </span><a href="http://authors.packtpub.com"><span class="url"><span class="koboSpan" id="kobo.40.1">authors.packtpub.com</span></span></a><span class="koboSpan" id="kobo.41.1"> and apply today. </span><span class="koboSpan" id="kobo.41.2">We have worked with thousands of developers and tech professionals, just like you, to help them share their insight with the global tech community. </span><span class="koboSpan" id="kobo.41.3">You can make a general application, apply for a specific hot topic that we are recruiting an author for, or submit your own idea.</span></p>
<p class="eop"/>
<h1 class="heading-1" id="_idParaDest-262"><a id="_idTextAnchor374"/><span class="koboSpan" id="kobo.42.1">Share your thoughts</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.43.1">Once you’ve read </span><em class="italic"><span class="koboSpan" id="kobo.44.1">Practical Serverless and Microservices with C#</span></em><span class="koboSpan" id="kobo.45.1">, we’d love to hear your thoughts! </span><span class="koboSpan" id="kobo.45.2">Please </span><a href="https://packt.link/r/1836642016"><span class="koboSpan" id="kobo.46.1">click here to go straight to the Amazon review page</span></a><span class="koboSpan" id="kobo.47.1"> for this book and share your feedback.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.48.1">Your review is important to us and the tech community and will help us make sure we’re delivering excellent quality content.</span></p>
</div>
</body></html>