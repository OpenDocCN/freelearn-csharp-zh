<html><head></head><body>
<div id="_idContainer165">
<h1 class="chapter-number" id="_idParaDest-265"><a id="_idTextAnchor470"/><span class="koboSpan" id="kobo.1.1">13</span></h1>
<h1 id="_idParaDest-266"><a id="_idTextAnchor471"/><span class="koboSpan" id="kobo.2.1">Externalization of Authorization</span></h1>
<p><span class="koboSpan" id="kobo.3.1">The previous chapter was about business rules management in general. </span><span class="koboSpan" id="kobo.3.2">In this chapter, we will analyze a particular case of authorization management, since the rights and privileges of users are one of the most common uses of business rules that you can find in many applications. </span><span class="koboSpan" id="kobo.3.3">Since there exist two standards for authorization management (as already explored</span><a id="_idIndexMarker736"/><span class="koboSpan" id="kobo.4.1"> in </span><a href="B21293_08.xhtml#_idTextAnchor271"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.5.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.6.1">) we will quickly explain the first and more complete standard, namely </span><strong class="bold"><span class="koboSpan" id="kobo.7.1">XACML</span></strong><span class="koboSpan" id="kobo.8.1"> (short for, </span><strong class="bold"><span class="koboSpan" id="kobo.9.1">eXtensible Access Control Markup Language</span></strong><span class="koboSpan" id="kobo.10.1">) because it helps </span><a id="_idIndexMarker737"/><span class="koboSpan" id="kobo.11.1">understand how it relates to the </span><strong class="bold"><span class="koboSpan" id="kobo.12.1">Single Responsibility Principle</span></strong><span class="koboSpan" id="kobo.13.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.14.1">SRP</span></strong><span class="koboSpan" id="kobo.15.1">); then, we will create a more complete example with</span><a id="_idIndexMarker738"/><span class="koboSpan" id="kobo.16.1"> the new, lighter, standard, which is </span><strong class="bold"><span class="koboSpan" id="kobo.17.1">OPA</span></strong><span class="koboSpan" id="kobo.18.1"> (short for, </span><strong class="bold"><span class="koboSpan" id="kobo.19.1">Open </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.20.1">Policy Agent</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.22.1">We will then end this chapter (and the series of four chapters on the different parts of an ideal information system) by reflecting on how to implement this authorization in practice, which will open the way to the analysis and the implementation of the information system for </span><strong class="source-inline"><span class="koboSpan" id="kobo.23.1">DemoEditor</span></strong><span class="koboSpan" id="kobo.24.1">, which has accompanied us so far, illustrating with examples the concepts studied, and it will, of course, also serve as a practical example of the implementations of what we learned in the </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">previous chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.26.1">In this chapter, we’ll cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.28.1">A BRMS and </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">authorization management</span></span></li>
<li><span class="koboSpan" id="kobo.30.1">Applying authorization to our same </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">information syst</span><a id="_idTextAnchor472"/><span class="koboSpan" id="kobo.32.1">em</span></span></li>
</ul>
<h1 id="_idParaDest-267"><a id="_idTextAnchor473"/><span class="koboSpan" id="kobo.33.1">A BRMS and authorization management</span></h1>
<p><span class="koboSpan" id="kobo.34.1">As I quickly</span><a id="_idIndexMarker739"/><span class="koboSpan" id="kobo.35.1"> mentioned in the previous chapter, there is a functional domain in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.36.1">DemoEditor</span></strong><span class="koboSpan" id="kobo.37.1"> sample information system where an externalized business rules engine would be interesting, and this domain is one of authorization. </span><span class="koboSpan" id="kobo.37.2">Before explaining the need to clarify the semantics of the “rights” business domain, examine the main paradigms to implement authorization in software applications, and also explain one of the standards associated with this function, which decomposes very well the different responsibilities </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">it entai</span><a id="_idTextAnchor474"/><span class="koboSpan" id="kobo.39.1">ls.</span></span></p>
<h2 id="_idParaDest-268"><a id="_idTextAnchor475"/><span class="koboSpan" id="kobo.40.1">The semantics of identity and authorization management</span></h2>
<p><span class="koboSpan" id="kobo.41.1">As</span><a id="_idIndexMarker740"/><span class="koboSpan" id="kobo.42.1"> explained in </span><a href="B21293_09.xhtml#_idTextAnchor318"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.43.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.44.1">, semantics is the foundation of all things in architecture, and we will clarify the terms we use for certain concepts in order to not incorrectly define the business domain model. </span><span class="koboSpan" id="kobo.44.2">Thus, it is important to clearly define the</span><a id="_idIndexMarker741"/><span class="koboSpan" id="kobo.45.1"> different subdomains of </span><strong class="bold"><span class="koboSpan" id="kobo.46.1">Identity and Authorization Management</span></strong><span class="koboSpan" id="kobo.47.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.48.1">IAM</span></strong><span class="koboSpan" id="kobo.49.1">) and how we name things inside of them. </span><span class="koboSpan" id="kobo.49.2">Let’s start with the concept associated with </span><strong class="bold"><span class="koboSpan" id="kobo.50.1">identification</span></strong><span class="koboSpan" id="kobo.51.1"> (who you are) and </span><strong class="bold"><span class="koboSpan" id="kobo.52.1">authentication</span></strong><span class="koboSpan" id="kobo.53.1"> (how you can prove </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">your identity):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer143">
<span class="koboSpan" id="kobo.55.1"><img alt="Figure 13.1 – Identification and authentication semantics" src="image/Figure_13.1_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.56.1">Figure 13.1 – Identification and authentication semantics</span></p>
<p><span class="koboSpan" id="kobo.57.1">A first – and very important – point is that authorization should depend only on your identity (and, of course, some elements of context, but we will come to that later) and never on how you prove your identity. </span><span class="koboSpan" id="kobo.57.2">At least, this is how we are going to work on the information system for now. </span><span class="koboSpan" id="kobo.57.3">Of course, we may in the future have to take into account that some authentication methods are safer than others and that some applications may request a strong form of multi-factor authentication to open certain features. </span><span class="koboSpan" id="kobo.57.4">But this use case will be handled with the addition of attributes to identification to account for this. </span><span class="koboSpan" id="kobo.57.5">After all, even in this situation, an application does not need to know exactly what you authenticated but, rather, how strong a trust it can have in the identity that it is </span><span class="No-Break"><span class="koboSpan" id="kobo.58.1">provided with.</span></span></p>
<p><span class="koboSpan" id="kobo.59.1">There are already </span><a id="_idIndexMarker742"/><span class="koboSpan" id="kobo.60.1">some cases like this in the standard identity profiles associated with OAuth; for example, in addition to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.61.1">email</span></strong><span class="koboSpan" id="kobo.62.1"> attribute, the contact profile can provide an </span><strong class="source-inline"><span class="koboSpan" id="kobo.63.1">email_validated</span></strong><span class="koboSpan" id="kobo.64.1"> attribute that specifies that the identity provider has verified that the identified user indeed has control of a certain email address. </span><span class="koboSpan" id="kobo.64.2">This is a way of augmenting trust in the identification without the identity consumer knowing anything about </span><em class="italic"><span class="koboSpan" id="kobo.65.1">how</span></em><span class="koboSpan" id="kobo.66.1"> the email has been verified. </span><span class="koboSpan" id="kobo.66.2">We are not going to dig deeper into authentication, as this is a hugely sophisticated domain, and what we want to model precisely is the authorization domain. </span><span class="koboSpan" id="kobo.66.3">For now, let’s just remember that a given user can be authenticated by different accounts/ways to prove </span><span class="No-Break"><span class="koboSpan" id="kobo.67.1">its identity.</span></span></p>
<p><span class="koboSpan" id="kobo.68.1">The important aspect of what will follow is that users can belong to groups, which ultimately will bring them some commonalities in rights management. </span><span class="koboSpan" id="kobo.68.2">These groups can be formed in a hierarchical tree in order to ease complex management. </span><span class="koboSpan" id="kobo.68.3">Bear in mind that we are still in the identification domain, so belonging to a group does not directly give you certain rights. </span><span class="koboSpan" id="kobo.68.4">Groups are simply part of your identity, as are any other attributes such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.69.1">lastname</span></strong><span class="koboSpan" id="kobo.70.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.71.1">firstname</span></strong><span class="koboSpan" id="kobo.72.1">, to give examples from the OpenID </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">Connect/JWT/OAuth standards.</span></span></p>
<p><span class="koboSpan" id="kobo.74.1">Let’s now discuss the other half of IAM, which</span><a id="_idIndexMarker743"/><span class="koboSpan" id="kobo.75.1"> is </span><strong class="bold"><span class="koboSpan" id="kobo.76.1">authorization</span></strong><span class="koboSpan" id="kobo.77.1"> management. </span><span class="koboSpan" id="kobo.77.2">The main semantics are </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer144">
<span class="koboSpan" id="kobo.79.1"><img alt="Figure 13.2 – Authorization semantics" src="image/Figure_13.2_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.80.1">Figure 13.2 – Authorization semantics</span></p>
<p><span class="koboSpan" id="kobo.81.1">The preceding diagram is, of course, just an example, and you may have your vocabulary for the terms used within it. </span><span class="koboSpan" id="kobo.81.2">But this is precisely the goal of such a semantics analysis; I know that some people use the word “</span><em class="italic"><span class="koboSpan" id="kobo.82.1">profiles</span></em><span class="koboSpan" id="kobo.83.1">” to describe the groups of people from the identification domain, that some use the word “</span><em class="italic"><span class="koboSpan" id="kobo.84.1">group</span></em><span class="koboSpan" id="kobo.85.1">” to discuss authorization groups, and that some others replace “</span><em class="italic"><span class="koboSpan" id="kobo.86.1">role</span></em><span class="koboSpan" id="kobo.87.1">” with “</span><em class="italic"><span class="koboSpan" id="kobo.88.1">profile</span></em><span class="koboSpan" id="kobo.89.1">.” </span><span class="koboSpan" id="kobo.89.2">But there are also people using other vocabulary, and the important thing is not who is right; as long as there is no established standard, everyone is. </span><span class="koboSpan" id="kobo.89.3">The important thing is to be able to understand univocally what we talk about. </span><span class="koboSpan" id="kobo.89.4">In this book, a group will be an entity that organizes sets of users that are similar in their identity, while a role will be a set of authorizations that are often </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">used together.</span></span></p>
<p><span class="koboSpan" id="kobo.91.1">Let’s explain </span><a id="_idIndexMarker744"/><span class="koboSpan" id="kobo.92.1">in just a bit more detail the concept of permission, which is defined by pointing to a resource and an operation (or several, if this is easier in your model). </span><span class="koboSpan" id="kobo.92.2">For example, removing a book from the data referential service may be something that only some editors have the right to do; we would then design the corresponding permission by pointing to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">book</span></strong><span class="koboSpan" id="kobo.94.1"> resource and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">DELETE</span></strong><span class="koboSpan" id="kobo.96.1"> verb. </span><span class="koboSpan" id="kobo.96.2">The use of the REST-based vocabulary is, of course, intentional – first, it makes it more precise to explain what we mean; second, it allows for a precise alignment of what will happen in the software. </span><span class="koboSpan" id="kobo.96.3">In this case, this permission will be associated with the possibility of sending a </span><strong class="source-inline"><span class="koboSpan" id="kobo.97.1">DELETE</span></strong><span class="koboSpan" id="kobo.98.1"> verb to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.99.1">/api/books</span></strong><span class="koboSpan" id="kobo.100.1"> API, and it is thus implemented without any possible confusion in the books data </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">referential service.</span></span></p>
<p><span class="koboSpan" id="kobo.102.1">Of course, some permissions are linked – a senior editor will not only be able to delete books but also create, modify, and read them. </span><span class="koboSpan" id="kobo.102.2">This is where roles come into play – grouping together many permissions that make sense together. </span><span class="koboSpan" id="kobo.102.3">This is where semantics is also important. </span><span class="koboSpan" id="kobo.102.4">Naming the editor role is a difficult choice because we will tend to use the word </span><strong class="source-inline"><span class="koboSpan" id="kobo.103.1">editors</span></strong><span class="koboSpan" id="kobo.104.1"> for two things that are fundamentally different: the group to which all users belong when they </span><strong class="bold"><span class="koboSpan" id="kobo.105.1">are</span></strong><span class="koboSpan" id="kobo.106.1"> editors and also the role that contains the permissions traditionally assigned to them. </span><span class="koboSpan" id="kobo.106.2">A better choice is to keep </span><strong class="source-inline"><span class="koboSpan" id="kobo.107.1">editors</span></strong><span class="koboSpan" id="kobo.108.1"> for the identification group and use a name such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.109.1">book-editor</span></strong><span class="koboSpan" id="kobo.110.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">the role.</span></span></p>
<p><span class="koboSpan" id="kobo.112.1">Semantics is important in another area – since there are several applications in an information system and each of them (at least the data referential service) deals with specific resources, it is important to specify the main resource in the name of the role; otherwise, they would get confused with each other. </span><span class="koboSpan" id="kobo.112.2">By the way, this is how we will group the two previous schemas, showing this multiplicity of “rights management targets” against the unicity of </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">identification concerns:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer145">
<span class="koboSpan" id="kobo.114.1"><img alt="Figure 13.3 – Each application takes care of its authorizations" src="image/Figure_13.3_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.115.1">Figure 13.3 – Each application takes care of its authorizations</span></p>
<p><span class="koboSpan" id="kobo.116.1">Before we</span><a id="_idIndexMarker745"/><span class="koboSpan" id="kobo.117.1"> go into more detail about what is in the </span><strong class="bold"><span class="koboSpan" id="kobo.118.1">Authorization</span></strong><span class="koboSpan" id="kobo.119.1"> boxes, let’s make a useful digression on the way IAM is handled in many applications and how it should be used to obtain a neat </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">business/IT alig</span><a id="_idTextAnchor476"/><span class="koboSpan" id="kobo.121.1">nment.</span></span></p>
<h2 id="_idParaDest-269"><a id="_idTextAnchor477"/><span class="koboSpan" id="kobo.122.1">A digression on IAM implementation</span></h2>
<p><span class="koboSpan" id="kobo.123.1">In most existing</span><a id="_idIndexMarker746"/><span class="koboSpan" id="kobo.124.1"> information systems, identification is still handled directly by many applications, leading to the well-known antipattern </span><span class="No-Break"><span class="koboSpan" id="kobo.125.1">represented here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer146">
<span class="koboSpan" id="kobo.126.1"><img alt="Figure 13.4 – An antipattern where IAM is in many applications" src="image/Figure_13.4_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.127.1">Figure 13.4 – An antipattern where IAM is in many applications</span></p>
<p><span class="koboSpan" id="kobo.128.1">These </span><a id="_idIndexMarker747"/><span class="koboSpan" id="kobo.129.1">multiple implementations of a unique feature are one of the most observed misalignment patterns in existing information systems. </span><span class="koboSpan" id="kobo.129.2">It leads not only to the duplication of accounts, making it more difficult to manage access rights, but also to the duplication of different passwords, which is a pain for users and quickly causes security issues because lots of them will use similar passwords across their line of business applications, making a password breach suddenly more impactful because the attack surface </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">is increased.</span></span></p>
<p><span class="koboSpan" id="kobo.131.1">One method that is often used by companies to compensate for this difficulty is to automate the “newcomer” process and implement some kind of tool that will automatically create accounts in every application of the information system. </span><span class="koboSpan" id="kobo.131.2">Unless you only have a legacy application and no intention of modernizing your system (for example, because the activity will be closed in a few years), this is always the worst move that can be done, as it tends to crystallize the problem – since you have added another (potentially costly) component to the system, you will be even less keen on changing it again. </span><span class="koboSpan" id="kobo.131.3">The following diagram shows the second antipattern in </span><span class="No-Break"><span class="koboSpan" id="kobo.132.1">this approach:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer147">
<span class="koboSpan" id="kobo.133.1"><img alt="Figure 13.5 – The process for a newcomer in its coupled version" src="image/Figure_13.5_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.134.1">Figure 13.5 – The process for a newcomer in its coupled version</span></p>
<p><span class="koboSpan" id="kobo.135.1">This diagram </span><a id="_idIndexMarker748"/><span class="koboSpan" id="kobo.136.1">shows all the </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">additional problems:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.138.1">The process is designed in the upper functional layer, but it cannot be modified by the business persons, since its execution is based on a job executed by an </span><strong class="bold"><span class="koboSpan" id="kobo.139.1">ETL</span></strong><span class="koboSpan" id="kobo.140.1"> application and, thus, can only be modified by technicians, which creates some time coupling (a change of regulation will be applied not when the business needs it but when the IT department can get around to in its </span><span class="No-Break"><span class="koboSpan" id="kobo.141.1">many projects).</span></span></li>
<li><span class="koboSpan" id="kobo.142.1">Talking about the many things the IT has to do, did you notice that the only actor in the BPMN is </span><strong class="bold"><span class="koboSpan" id="kobo.143.1">IT</span></strong><span class="koboSpan" id="kobo.144.1">? </span><span class="koboSpan" id="kobo.144.2">This is logical since all tasks have been designed to be automated and IT is considered responsible for managing the users inside the software, simply because they are the ones who have installed it or know how to access the APIs. </span><span class="koboSpan" id="kobo.144.3">This is a very common problem; instead of having functional administrators taking full responsibility for their applications, they rely entirely on IT for this. </span><span class="koboSpan" id="kobo.144.4">Although this can be considered normal for technical tasks, this is a problem in this case because trusting IT to add users and determining their default permissions can be a recipe for regulatory disaster. </span><span class="koboSpan" id="kobo.144.5">After all, how could you be mad at an intern who has dealt with an urgent ticket from accounting by creating a user with a default password, not knowing that, in this legacy application, users are created by default with full rights, which allows the newcomer user to access the bank accounts of the company and empty them on their very first day in </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">the job?</span></span></li>
<li><span class="koboSpan" id="kobo.146.1">The process</span><a id="_idIndexMarker749"/><span class="koboSpan" id="kobo.147.1"> is directly implemented inside an ETL application, which is the number one misalignment antipattern. </span><span class="koboSpan" id="kobo.147.2">If you continue in this direction, very soon, all the business processes of the company will depend on one piece of software that, in addition, is a single point of failure in your IT system. </span><span class="koboSpan" id="kobo.147.3">What if it is discontinued? </span><span class="koboSpan" id="kobo.147.4">What if the editor suddenly raises prices? </span><span class="koboSpan" id="kobo.147.5">What if there is a </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">general failure?</span></span></li>
<li><span class="koboSpan" id="kobo.149.1">In some cases, the person doing the implementation may be lucky enough to be able to call a nice, backward compatible, and well-documented API such as on </span><strong class="source-inline"><span class="koboSpan" id="kobo.150.1">Application A</span></strong><span class="koboSpan" id="kobo.151.1">, allowing for some kind of decoupling, or even the possibility to expose this API in the BCM. </span><span class="koboSpan" id="kobo.151.2">But in </span><strong class="source-inline"><span class="koboSpan" id="kobo.152.1">Application B</span></strong><span class="koboSpan" id="kobo.153.1">, the API talks directly to a library of the application, making this interoperation brittle to any change of version. </span><span class="koboSpan" id="kobo.153.2">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.154.1">Application C</span></strong><span class="koboSpan" id="kobo.155.1">, it is even worse, since the only way found to automate the creation of an account was to insert lines directly into the database. </span><span class="koboSpan" id="kobo.155.2">The behavior might become completely erratic in the next version, or even as soon as you roll out in production because you have forgotten an important part of the persistence in your script, and </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">so on.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.157.1">The preceding approach tends to embed in a system this antipattern, where each application takes care of its own identification and even authentication, whereas it should only handle authorization (this antipattern has to stay there, since the application handles the resources, and the permissions apply to these). </span><span class="koboSpan" id="kobo.157.2">Instead of this, the right move would be to progressively adopt the following </span><span class="No-Break"><span class="koboSpan" id="kobo.158.1">correct pattern:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer148">
<span class="koboSpan" id="kobo.159.1"><img alt="Figure 13.6 – A correct map of IAM responsibility" src="image/Figure_13.6_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.160.1">Figure 13.6 – A correct map of IAM responsibility</span></p>
<p><span class="koboSpan" id="kobo.161.1">In this case, the </span><a id="_idIndexMarker750"/><span class="koboSpan" id="kobo.162.1">identification and authentication responsibilities are implemented by a dedicated piece of software (in our example, an Apache Keycloak IAM server, plugged into a Microsoft AD user directory) and all applications still take care of authorization on the resource they respectively manage, but they point to this unique identification feature that they need to apply the right permissions (again, without knowing anything about the authentication process). </span><span class="koboSpan" id="kobo.162.2">Of course, this would not be done in one day; you need to progressively equip your information system with an application that supports externalized authentication/identification. </span><span class="koboSpan" id="kobo.162.3">Nowadays, almost all modern enterprise-grade applications do so, and if they are browser-based, it is even possible in some cases to handle these responsibilities with a frontend protecting them if needed. </span><span class="koboSpan" id="kobo.162.4">And since you will likely always keep some legacy applications, you will certainly end up with a “middle of the journey” information system such as the following, which is already much better and easier </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">to handle:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer149">
<span class="koboSpan" id="kobo.164.1"><img alt="Figure 13.7 – The process for a newcomer in a perfectly aligned version" src="image/Figure_13.7_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.165.1">Figure 13.7 – The process for a newcomer in a perfectly aligned version</span></p>
<p><span class="koboSpan" id="kobo.166.1">Do not be put out by the added complexity to the diagram; it is simply more complete because I have added more details – in particular, the hardware layer, which had not been shown before. </span><span class="koboSpan" id="kobo.166.2">In this part of the information system, many advantages can be seen on the right of the diagram, but we will discuss them now in </span><span class="No-Break"><span class="koboSpan" id="kobo.167.1">more detail:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.168.1">The implementation of the process can now be dedicated to any tool, and it will not have any coupling to the technical stack (except for the call to the Apache Keycloak API to add a global user, but it is extremely rare, as this can be based on the LDIF standard and a change of software would not be visible by the </span><span class="No-Break"><span class="koboSpan" id="kobo.169.1">process users).</span></span></li>
<li><span class="koboSpan" id="kobo.170.1">If the process had to be modified – for example, by adding another step for a legacy application that had been forgotten in the first version – it could be done by decision-makers alone. </span><span class="koboSpan" id="kobo.170.2">In the new version, this additional task would work like the existing one for the legacy accounting system – when a user-based task is completed, an email would be sent to the functional administrator of the application, together with a link to the procedure to add the requested user. </span><span class="koboSpan" id="kobo.170.3">When done, this person would click on a link in the email received to signal that the task is done, which would also close </span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">the process.</span></span></li>
<li><span class="koboSpan" id="kobo.172.1">The first </span><a id="_idIndexMarker751"/><span class="koboSpan" id="kobo.173.1">task dedicated to the IT department would still be manual, as there would be a form to fill in (the one from Apache Keycloak or – as represented here – a form provided by the BPMN engine that would call the API from Keycloak associated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">Create user</span></strong><span class="koboSpan" id="kobo.175.1"> function of the BCM). </span><span class="koboSpan" id="kobo.175.2">If the API from Keycloak follows the LDIF standard, it could be considered as the standardized unique point associated with the function in the information system, making it easier to replace Keycloak with another software </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">if needed.</span></span></li>
<li><span class="koboSpan" id="kobo.177.1">In addition, Keycloak acts as an indirection layer to the actual user’s directory. </span><span class="koboSpan" id="kobo.177.2">If this had to change to another directory, or even use identity federation and several directories, this would be transparent for any user of the API associated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">Create </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">user</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.180.1"> function.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.181.1">Of course, the problem of the legacy application would not completely disappear, but at least, in this configuration, the legacy impact is progressively reduced and the right functions are ready for the new and more modern applications to work in the way they should. </span><span class="koboSpan" id="kobo.181.2">Also, the legacy application is isolated into a silo and will be easier to discard in the future. </span><span class="koboSpan" id="kobo.181.3">In this example, we could start by removing the task from the process, and then suppress the old application with its locally coupled identification and authentication features. </span><span class="koboSpan" id="kobo.181.4">Finally, we have to verify that the old server with an unsupported or exotic, hard-to-maintain operating system does not serve any other software role in </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">the</span><a id="_idTextAnchor478"/><span class="koboSpan" id="kobo.183.1"> system.</span></span></p>
<h2 id="_idParaDest-270"><a id="_idTextAnchor479"/><span class="koboSpan" id="kobo.184.1">Role-based access control and attribute-based access control models</span></h2>
<p><span class="koboSpan" id="kobo.185.1">After </span><a id="_idIndexMarker752"/><span class="koboSpan" id="kobo.186.1">that rather long – but hopefully useful – digression into IAM implementations, we will return to where we</span><a id="_idIndexMarker753"/><span class="koboSpan" id="kobo.187.1"> were before, which is the fact that, in a good information system, identification and authentication features are unique for all applications, but the authorization feature is duplicated for each resource. </span><span class="koboSpan" id="kobo.187.2">Indeed, only the application that handles the resources knows how to handle the permissions on them. </span><span class="koboSpan" id="kobo.187.3">In our example with the book data referential service, we saw that a role called </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">book-edition</span></strong><span class="koboSpan" id="kobo.189.1"> would make sense. </span><span class="koboSpan" id="kobo.189.2">But what about in an archiving system? </span><span class="koboSpan" id="kobo.189.3">Chances are we would find roles such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">archivist</span></strong><span class="koboSpan" id="kobo.191.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.192.1">readonly-verifier</span></strong><span class="koboSpan" id="kobo.193.1"> in there, but </span><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">book-edition</span></strong><span class="koboSpan" id="kobo.195.1"> would make </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">no sense.</span></span></p>
<p><span class="koboSpan" id="kobo.197.1">This is not to say that we could not find common role names between applications; on the contrary – similar names should be considered carefully because they do not mean the same thing. </span><span class="koboSpan" id="kobo.197.2">This is why it is so dangerous, even though it is frequently done, to name roles </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">administrator</span></strong><span class="koboSpan" id="kobo.199.1">. </span><span class="koboSpan" id="kobo.199.2">Of course, everyone understands what this means –users with this role can perform every operation in the software. </span><span class="koboSpan" id="kobo.199.3">But, specifically, the definition of “everything” can differ from one software to another. </span><span class="koboSpan" id="kobo.199.4">If you add to this situation a group called </span><strong class="source-inline"><span class="koboSpan" id="kobo.200.1">administrators</span></strong><span class="koboSpan" id="kobo.201.1"> inside your users’ directory, which is supposed to mean that the users in this group should have full permissions in every application, the confusion </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">is increased.</span></span></p>
<p><span class="koboSpan" id="kobo.203.1">I personally recommend restricting this situation to </span><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">domain-administrator</span></strong><span class="koboSpan" id="kobo.205.1"> and arranging for your IT department to never be a functional administrator of an application, only of the machines they are installed on (which does not prevent them from indirectly seeing or manipulating data, but this is another problem that should be dealt with by contractual standards and full traceability of </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">administrative actions).</span></span></p>
<p><span class="koboSpan" id="kobo.207.1">To account for this, a better representation of the preceding diagram would be the </span><span class="No-Break"><span class="koboSpan" id="kobo.208.1">following one:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer150">
<span class="koboSpan" id="kobo.209.1"><img alt="Figure 13.8 – Affecting authorizations on permissions rather than resources" src="image/Figure_13.8_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.210.1">Figure 13.8 – Affecting authorizations on permissions rather than resources</span></p>
<p><span class="koboSpan" id="kobo.211.1">The</span><a id="_idIndexMarker754"/><span class="koboSpan" id="kobo.212.1"> left-hand side is not </span><a id="_idIndexMarker755"/><span class="koboSpan" id="kobo.213.1">as detailed in the preceding diagram, but this is what we wanted. </span><span class="koboSpan" id="kobo.213.2">Since we stated that authorizations should be based on identity, how could we do this in practice? </span><span class="koboSpan" id="kobo.213.3">One of the easiest and most commonly used ways is </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer151">
<span class="koboSpan" id="kobo.215.1"><img alt="Figure 13.9 – A pure role-based access control approach" src="image/Figure_13.9_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.216.1">Figure 13.9 – A pure role-based access control approach</span></p>
<p><span class="koboSpan" id="kobo.217.1">When roles are associated (or “mapped”) to groups or directly to users, the paradigm of rights management is </span><a id="_idIndexMarker756"/><span class="koboSpan" id="kobo.218.1">called </span><strong class="bold"><span class="koboSpan" id="kobo.219.1">Role-Based Access Control</span></strong><span class="koboSpan" id="kobo.220.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.221.1">RBAC</span></strong><span class="koboSpan" id="kobo.222.1">). </span><span class="koboSpan" id="kobo.222.2">The main advantage of this approach is that it is very simple to implement. </span><span class="koboSpan" id="kobo.222.3">Since the person who administrated rights only sees the role, the diagram could even be represented like this from their point </span><span class="No-Break"><span class="koboSpan" id="kobo.223.1">of view:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer152">
<span class="koboSpan" id="kobo.224.1"><img alt="Figure 13.10 – A documented RBAC approach" src="image/Figure_13.10_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.225.1">Figure 13.10 – A documented RBAC approach</span></p>
<p><span class="koboSpan" id="kobo.226.1">This </span><a id="_idIndexMarker757"/><span class="koboSpan" id="kobo.227.1">eases</span><a id="_idIndexMarker758"/><span class="koboSpan" id="kobo.228.1"> the work of developers as well because, as long as they respect the contractual text-based definition of the rights associated with the role, they can choose whatever implementation method for the role they prefer, or even a mix </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">of them:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer153">
<span class="koboSpan" id="kobo.230.1"><img alt="Figure 13.11 – Other possible role implementations in RBAC" src="image/Figure_13.11_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.231.1">Figure 13.11 – Other possible role implementations in RBAC</span></p>
<p><span class="koboSpan" id="kobo.232.1">The</span><a id="_idIndexMarker759"/><span class="koboSpan" id="kobo.233.1"> textual </span><a id="_idIndexMarker760"/><span class="koboSpan" id="kobo.234.1">definition of the role may cause some trouble, due to the text’s imprecise nature and the potential for knowledge to become outdated over time, it is subject to approximation, particularly if the editor role has a high personnel turnover and/or does not document clearly its </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">software features.</span></span></p>
<p><span class="koboSpan" id="kobo.236.1">Since pure RBAC is quite restrictive, applications often allow for the direct mapping of granular permissions to users or groups, as </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">schematized here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer154">
<span class="koboSpan" id="kobo.238.1"><img alt="Figure 13.12 – Fine-grained permission as an improvement on RBAC" src="image/Figure_13.12_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.239.1">Figure 13.12 – Fine-grained permission as an improvement on RBAC</span></p>
<p><span class="koboSpan" id="kobo.240.1">This </span><a id="_idIndexMarker761"/><span class="koboSpan" id="kobo.241.1">extends the possibilities, but it also makes it much more difficult for functional administrators to keep track </span><a id="_idIndexMarker762"/><span class="koboSpan" id="kobo.242.1">of the rights given to different users if these cases become more than just exceptions. </span><span class="koboSpan" id="kobo.242.2">As the number of users increases, the use of groups and roles becomes more and more important. </span><span class="koboSpan" id="kobo.242.3">The temptation to delegate some rights administration responsibility increases as well, but it is essential to implement this with rigid rules and train people carefully, as it can quickly become a mess, where users with the same job title end up with different rights, depending on who has given them these rights. </span><span class="koboSpan" id="kobo.242.4">Even worse, some users end up with full permissions on the software because the new functional administrator does not understand precisely how the rights management system works. </span><span class="koboSpan" id="kobo.242.5">This is yet another reason to not give this responsibility to IT, however tempting this may be, because they would have control of the technical part of </span><span class="No-Break"><span class="koboSpan" id="kobo.243.1">the application.</span></span></p>
<p><span class="koboSpan" id="kobo.244.1">Another, more </span><a id="_idIndexMarker763"/><span class="koboSpan" id="kobo.245.1">sophisticated, way to extend the RBAC features is to shift to what is called </span><strong class="bold"><span class="koboSpan" id="kobo.246.1">Attribute-Based Access Control</span></strong><span class="koboSpan" id="kobo.247.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.248.1">ABAC</span></strong><span class="koboSpan" id="kobo.249.1">). </span><span class="koboSpan" id="kobo.249.2">In this rights management paradigm, rules are set that link attributes from the identification to attributes of </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">the resources:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer155">
<span class="koboSpan" id="kobo.251.1"><img alt="Figure 13.13 – An ABAC approach" src="image/Figure_13.13_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.252.1">Figure 13.13 – An ABAC approach</span></p>
<p><span class="koboSpan" id="kobo.253.1">This </span><a id="_idIndexMarker764"/><span class="koboSpan" id="kobo.254.1">allows us, for example, to </span><a id="_idIndexMarker765"/><span class="koboSpan" id="kobo.255.1">overcome the limitations that would happen with RBAC in our sample </span><strong class="source-inline"><span class="koboSpan" id="kobo.256.1">DemoEditor</span></strong><span class="koboSpan" id="kobo.257.1"> information system, if authors simply added a </span><strong class="source-inline"><span class="koboSpan" id="kobo.258.1">book-edition</span></strong><span class="koboSpan" id="kobo.259.1"> role. </span><span class="koboSpan" id="kobo.259.2">Indeed, this role would either give them the right to read and write books, </span><strong class="bold"><span class="koboSpan" id="kobo.260.1">including those from other authors</span></strong><span class="koboSpan" id="kobo.261.1">, or give them the right to read the books without being able to modify them. </span><span class="koboSpan" id="kobo.261.2">What we really want is that authors and editors can manipulate the data on </span><strong class="bold"><span class="koboSpan" id="kobo.262.1">their</span></strong><span class="koboSpan" id="kobo.263.1"> books (the ones they write or supervise) but have very limited rights or none on other books. </span><span class="koboSpan" id="kobo.263.2">With RBAC, this is not possible, as the role is related to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">books</span></strong><span class="koboSpan" id="kobo.265.1"> resource but not </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">specific books.</span></span></p>
<p><span class="koboSpan" id="kobo.267.1">This is a job for ABAC, and the attributes it would use are </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer156">
<span class="koboSpan" id="kobo.269.1"><img alt="Figure 13.14 – An ABAC implementation with a BRMS" src="image/Figure_13.14_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.270.1">Figure 13.14 – An ABAC implementation with a BRMS</span></p>
<p><span class="koboSpan" id="kobo.271.1">You will </span><a id="_idIndexMarker766"/><span class="koboSpan" id="kobo.272.1">notice </span><a id="_idIndexMarker767"/><span class="koboSpan" id="kobo.273.1">that permissions are still represented – and we could include roles as well – because ABAC is not exclusive of RBAC but, rather, complements it in </span><span class="No-Break"><span class="koboSpan" id="kobo.274.1">its forthcoming.</span></span></p>
<p><span class="koboSpan" id="kobo.275.1">What would happen technically in such a scenario is </span><span class="No-Break"><span class="koboSpan" id="kobo.276.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.277.1">An application would call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.278.1">GET</span></strong><span class="koboSpan" id="kobo.279.1"> verb </span><span class="No-Break"><span class="koboSpan" id="kobo.280.1">on </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">/api/books/978-2409002205</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.282.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.283.1">This request would be accompanied by a bearer-based </span><span class="No-Break"><span class="koboSpan" id="kobo.284.1">authentication header.</span></span></li>
<li><span class="koboSpan" id="kobo.285.1">The JWT token would include the custom attribute providing the author internal identifier (or another way to go would be to base the association to the author on the email or another </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">standard attribute).</span></span></li>
<li><span class="koboSpan" id="kobo.287.1">Upon reception of this request, the books referential service application would call the authorization central API, providing it with everything it knows about the request – the incoming JWT-born identity, the attributes of the book requested, and </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">so on.</span></span></li>
<li><span class="koboSpan" id="kobo.289.1">The authorization app would find the rule that applies to the situation – in this case, </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">GET</span></strong><span class="koboSpan" id="kobo.291.1"> on </span><span class="No-Break"><span class="koboSpan" id="kobo.292.1">a book.</span></span></li>
<li><span class="koboSpan" id="kobo.293.1">It would first check that the incoming user has </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">author_id</span></strong><span class="koboSpan" id="kobo.295.1"> and that this is the ID associated with one of the authors of the given book (looking at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">book_mainauthor_id</span></strong><span class="koboSpan" id="kobo.297.1"> attribute and – if necessary – the </span><strong class="source-inline"><span class="koboSpan" id="kobo.298.1">book_secondaryauthors_ids</span></strong><span class="koboSpan" id="kobo.299.1"> array </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">of attributes).</span></span></li>
<li><span class="koboSpan" id="kobo.301.1">It </span><a id="_idIndexMarker768"/><span class="koboSpan" id="kobo.302.1">would then check that the initial request to the book referential service does not contain something such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">$expand=release-information</span></strong><span class="koboSpan" id="kobo.304.1">, since this data will not be seen by </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">the author.</span></span></li>
<li><span class="koboSpan" id="kobo.306.1">It </span><a id="_idIndexMarker769"/><span class="koboSpan" id="kobo.307.1">would realize it needs to check that the author has not been blocked and would call a </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">GET</span></strong><span class="koboSpan" id="kobo.309.1"> request to </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">/api/authors/x24b72</span></strong><span class="koboSpan" id="kobo.311.1">. </span><span class="koboSpan" id="kobo.311.2">This would be done with a privileged account with full read rights, as we consider that the BRMS has a justified “right to know” due to its function in </span><span class="No-Break"><span class="koboSpan" id="kobo.312.1">the system.</span></span></li>
<li><span class="koboSpan" id="kobo.313.1">An alternative to this would be for the books referential service to provide an extended view of the book, just as if there had been a call </span><span class="No-Break"><span class="koboSpan" id="kobo.314.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">/api/books/978-2409002205?$expand=authors</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.317.1">For most advanced authorization systems, these three checks would be done in parallel to </span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">save time.</span></span></li>
<li><span class="koboSpan" id="kobo.319.1">If everything is correct, the BRMS will send a </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">200 OK</span></strong><span class="koboSpan" id="kobo.321.1"> HTTP response to the call from the books </span><span class="No-Break"><span class="koboSpan" id="kobo.322.1">referential service.</span></span></li>
<li><span class="koboSpan" id="kobo.323.1">The book referential service would then grant the </span><span class="No-Break"><span class="koboSpan" id="kobo.324.1">requested access.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.325.1">Of course, if anything goes wrong in these steps, the request will be refused with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">403 Forbidden</span></strong><span class="koboSpan" id="kobo.327.1"> status code. </span><span class="koboSpan" id="kobo.327.2">This could happen if the rules are not respected, but also if the BRMS system does not respond in time. </span><span class="koboSpan" id="kobo.327.3">This behavior is expected, as the so-called “graceful degradation” would imply, for security reasons, that the system does not take any risk to disclose date data or allow any operation if it is not sure it is allowed. </span><span class="koboSpan" id="kobo.327.4">This means that the authorization is another SPOF in the system and should be operated corresponding to this requested level </span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">of service.</span></span></p>
<p><span class="koboSpan" id="kobo.329.1">I hesitate to </span><a id="_idIndexMarker770"/><span class="koboSpan" id="kobo.330.1">discuss </span><strong class="bold"><span class="koboSpan" id="kobo.331.1">ReBAC</span></strong><span class="koboSpan" id="kobo.332.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.333.1">Relationship-Based Access Control</span></strong><span class="koboSpan" id="kobo.334.1">), which looks like a nice complement to the RBAC and ABAC paradigms but, at the time of writing, has not yet reached a mature enough state. </span><span class="koboSpan" id="kobo.334.2">In a nutshell, the principle of ReBAC is to manage authorizations based on links between entities; hence, it has a strong link to DDD. </span><span class="koboSpan" id="kobo.334.3">For example, this </span><a id="_idIndexMarker771"/><span class="koboSpan" id="kobo.335.1">approach allows you to easily give writing permission to an author on</span><a id="_idIndexMarker772"/><span class="koboSpan" id="kobo.336.1"> their books while keeping the books of other authors with read-only permissions. </span><span class="koboSpan" id="kobo.336.2">This can, of course, also be done with ABAC, but ReBAC makes it a little bit simpler, by basing its functioning on relationships instead of simply attributes. </span><span class="koboSpan" id="kobo.336.3">To read a bit more about ReBAC, you can start at </span><a href="https://en.wikipedia.org/wiki/Relationship-based_access_control"><span class="koboSpan" id="kobo.337.1">https://en.wikipedia.org/wiki/Relationship-based_access_control</span></a><span class="koboSpan" id="kobo.338.1"> and then check what OSO states about this mode </span><span class="No-Break"><span class="koboSpan" id="kobo.339.1">at </span></span><a href="https://www.osohq.com/academy/relationship-based-access-control-rebac"><span class="No-Break"><span class="koboSpan" id="kobo.340.1">https://www.osohq.com/academy/relationship-based-access-control-rebac</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.341.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.342.1">OpenFGA (</span><a href="https://openfga.dev/"><span class="koboSpan" id="kobo.343.1">https://openfga.dev/</span></a><span class="koboSpan" id="kobo.344.1">) is also a project that is worth looking at if you need a clean external authorization management system that is ReBAC-capable. </span><span class="koboSpan" id="kobo.344.2">Although still nascent, the project has already been referenced as a Cloud Native Computing Foundation project. </span><span class="koboSpan" id="kobo.344.3">If you want to check out what it could do for your authorization needs, one of the best ways to start is to tweak the samples provided in the </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">sandbox (</span></span><a href="https://play.fga.dev/sandbox"><span class="No-Break"><span class="koboSpan" id="kobo.346.1">https://</span><span id="_idTextAnchor480"/><span class="koboSpan" id="kobo.347.1">play.fga.dev/sandbox</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.348.1">).</span></span></p>
<h2 id="_idParaDest-271"><a id="_idTextAnchor481"/><span class="koboSpan" id="kobo.349.1">The XACML approach</span></h2>
<p><span class="koboSpan" id="kobo.350.1">Now</span><a id="_idIndexMarker773"/><span class="koboSpan" id="kobo.351.1"> that the different organizations of rights management have been discussed, we will start discussing a bit more about implementation and, by now, you will certainly have started wondering what kind of norms and standards are available to us. </span><span class="koboSpan" id="kobo.351.2">Since we have discussed the different steps to realize an ABAC implementation, it would be interesting to study one of the most complete</span><a id="_idIndexMarker774"/><span class="koboSpan" id="kobo.352.1"> specifications and explain how it would fit into these </span><span class="No-Break"><span class="koboSpan" id="kobo.353.1">ABAC steps.</span></span></p>
<p><strong class="bold"><span class="koboSpan" id="kobo.354.1">XACML</span></strong><span class="koboSpan" id="kobo.355.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.356.1">eXtensible Access Control Markup Language</span></strong><span class="koboSpan" id="kobo.357.1">) specifies how access control can be executed and administered. </span><span class="koboSpan" id="kobo.357.2">It is one of the most advanced ways to handle authorization and establishes five different responsibilities to </span><span class="No-Break"><span class="koboSpan" id="kobo.358.1">do so:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.359.1">The policy administration point is where rules </span><span class="No-Break"><span class="koboSpan" id="kobo.360.1">are defined</span></span></li>
<li><span class="koboSpan" id="kobo.361.1">The policy retrieval point is where they </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">are stored</span></span></li>
<li><span class="koboSpan" id="kobo.363.1">The policy decision point is the engine that decides which decision should </span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">be taken</span></span></li>
<li><span class="koboSpan" id="kobo.365.1">The policy information point is where additional attributes that are necessary for rule evaluation </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">are gathered</span></span></li>
<li><span class="koboSpan" id="kobo.367.1">The policy enforcement point is the place where the result of the decision </span><span class="No-Break"><span class="koboSpan" id="kobo.368.1">is applied</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.369.1">How these </span><a id="_idIndexMarker775"/><span class="koboSpan" id="kobo.370.1">five responsibilities are spread across one or many applications defines how sophisticated a system will be. </span><span class="koboSpan" id="kobo.370.2">In the most simple approach, all five responsibilities can be implemented inside the data referential service that ultimately has to apply the enforcement point (since the data referential service is the one who owns the data, this cannot be externalized). </span><span class="koboSpan" id="kobo.370.3">In this mode, the data referential service not only stores the data but also stores the rules, executes them, and decides what it should do depending on the outcome. </span><span class="koboSpan" id="kobo.370.4">The only instance in which a responsibility could still be considered as external is if the referential service needs some external data, but it could very well store that as well. </span><span class="koboSpan" id="kobo.370.5">In this case, the responsibilities are affected </span><span class="No-Break"><span class="koboSpan" id="kobo.371.1">like this:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer157">
<span class="koboSpan" id="kobo.372.1"><img alt="Figure 13.15 – All authorization responsibilities integrated into an application" src="image/Figure_13.15_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.373.1">Figure 13.15 – All authorization responsibilities integrated into an application</span></p>
<p><span class="koboSpan" id="kobo.374.1">By contrast, this is how we could spread the responsibilities in the previous organization of responsibilities we </span><span class="No-Break"><span class="koboSpan" id="kobo.375.1">discussed previously:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer158">
<span class="koboSpan" id="kobo.376.1"><img alt="Figure 13.16 – Authorization responsibilities completely spread across dedicated services" src="image/Figure_13.16_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.377.1">Figure 13.16 – Authorization responsibilities completely spread across dedicated services</span></p>
<p><span class="koboSpan" id="kobo.378.1">In this </span><a id="_idIndexMarker776"/><span class="koboSpan" id="kobo.379.1">very clean (but, of course, more expensive to set up) approach, each responsibility is completely separated, and the BRMS and data referential service work together in order to </span><span class="No-Break"><span class="koboSpan" id="kobo.380.1">orchestrate them:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.381.1">Before any first interaction, a functional user connects to the PAP and designs the rules (just like what was done in the example previously with the </span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">DMN use).</span></span></li>
<li><span class="koboSpan" id="kobo.383.1">These rules are stored in the associated database, which is </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">the PRP.</span></span></li>
<li><span class="koboSpan" id="kobo.385.1">The books referential service receives the initial request. </span><span class="koboSpan" id="kobo.385.2">It cannot make decisions on its own and delegates </span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">the PDP.</span></span></li>
<li><span class="koboSpan" id="kobo.387.1">It communicates to the deployed BRE the context of the call, in order to get a decision </span><span class="No-Break"><span class="koboSpan" id="kobo.388.1">from it.</span></span></li>
<li><span class="koboSpan" id="kobo.389.1">The PDP needs to retrieve the rules in order to process them. </span><span class="koboSpan" id="kobo.389.2">It could call the PRP, but luckily, it has a local clone in our case, where we made the hypothesis that the JBPM server has been used and the console deployed a standalone runtime container for the </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">rules execution.</span></span></li>
<li><span class="koboSpan" id="kobo.391.1">The PDP may also need some additional information that it could collect through the PIP, which retrieves the </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">blocked</span></strong><span class="koboSpan" id="kobo.393.1"> status for </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">the author.</span></span></li>
<li><span class="koboSpan" id="kobo.395.1">The PDP sends the result of its rules decision engine back to the books </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">referential service.</span></span></li>
<li><span class="koboSpan" id="kobo.397.1">As with the PEP, the books referential service uses the decision sent by the PDP to allow (or not) access to its data and possibly respond to the HTTP response that </span><span class="No-Break"><span class="koboSpan" id="kobo.398.1">was presented.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.399.1">Before we show</span><a id="_idIndexMarker777"/><span class="koboSpan" id="kobo.400.1"> you a practical example of how to set this up, let me make another digression, this time on how serv</span><a id="_idTextAnchor482"/><span class="koboSpan" id="kobo.401.1">ices should </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">be separated.</span></span></p>
<h2 id="_idParaDest-272"><a id="_idTextAnchor483"/><span class="koboSpan" id="kobo.403.1">A digression on the granularity of microservices</span></h2>
<p><span class="koboSpan" id="kobo.404.1">First of all, let’s draw a </span><a id="_idIndexMarker778"/><span class="koboSpan" id="kobo.405.1">diagram for a less sophisticated and more common situation, where each data referential service contains its own PRP and PDP in addition to the PEP. </span><span class="koboSpan" id="kobo.405.2">In this case, the PAP is generally minimal, as rules are integrated into the code and do not allow for easy management, which means that PRP is simply the code </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">base itself.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer159">
<span class="koboSpan" id="kobo.407.1"><img alt="Figure 13.17 – The problem of authorization management when data is cloned" src="image/Figure_13.17_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.408.1">Figure 13.17 – The problem of authorization management when data is cloned</span></p>
<p><span class="koboSpan" id="kobo.409.1">Can you spot the potential problem? </span><span class="koboSpan" id="kobo.409.2">The books referential service does not hold the author’s PDP/PRP, which is logical, since it is not responsible for it. </span><span class="koboSpan" id="kobo.409.3">However, it still stores a clone of the author’s data in order to quickly respond to API calls such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.410.1">/api/books/978-2409002205?$expand=authors</span></strong><span class="koboSpan" id="kobo.411.1">. </span><span class="koboSpan" id="kobo.411.2">This means that, since it does not know how to filter this kind of data, it might create a breach of confidential data if care is </span><a id="_idIndexMarker779"/><span class="koboSpan" id="kobo.412.1">not taken. </span><span class="koboSpan" id="kobo.412.2">In a four-layer diagram, this problem can be seen from a strange misalignment that appears </span><span class="No-Break"><span class="koboSpan" id="kobo.413.1">this way:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer160">
<span class="koboSpan" id="kobo.414.1"><img alt="Figure 13.18 – A representation of the authorization antipattern in the four-layer diagram" src="image/Figure_13.18_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.415.1">Figure 13.18 – A representation of the authorization antipattern in the four-layer diagram</span></p>
<p><span class="koboSpan" id="kobo.416.1">This kind of misalignment arises from the fact that authorization has been trusted by the application that stores the data. </span><span class="koboSpan" id="kobo.416.2">This way, since the data is duplicated, there are in fact two potentially different ways to apply authorization to the same data! </span><span class="koboSpan" id="kobo.416.3">This situation can also happen when we externalize data in a BRMS because the runtime and the PAP may not be synchronized, but the advantages in this case are much more important than the actual drawbacks. </span><span class="koboSpan" id="kobo.416.4">Indeed, the decoupling between the JBPM console and the BRE runtime container bears lots of added value – the console is a complex server whereas the runtime container is very light; it is much better to separate them because errors are prone to happen in the first, whereas the second one should have an excellent level of service. </span><span class="koboSpan" id="kobo.416.5">When the console is used to deploy a standalone server, it can then crash </span><a id="_idIndexMarker780"/><span class="koboSpan" id="kobo.417.1">without this being a problem. </span><span class="koboSpan" id="kobo.417.2">The runtime, conversely, can be made extremely robust, since it is stripped of almost every bit of code that is not immediately necessary to execute the functions. </span><span class="koboSpan" id="kobo.417.3">The fact that the console deploys versions of the rulesets makes it possible to create as many runtime servers as needed for performance reasons (thus, you also avoid the SPOF problem, since this service is required by many others and should be extremely stable) without any risk of a lack of consistency, which would be a big problem (imagine explaining to your customers that their rights of access to their tenant data vary on every </span><span class="No-Break"><span class="koboSpan" id="kobo.418.1">new request).</span></span></p>
<p><span class="koboSpan" id="kobo.419.1">Still, this does not mean that all responsibilities should always be added to as many services and different processes as possible. </span><span class="koboSpan" id="kobo.419.2">Of course, it may be useful, but, as is often the case in information architecture, the most important thing is to strike the right balance. </span><span class="koboSpan" id="kobo.419.3">There have been so many pointless discussions on the internet over which is best between microservices and monolith applications that you can almost surmise the quality of an article just by looking at its title. </span><span class="koboSpan" id="kobo.419.4">Of course, the only correct response to what is best is, “</span><em class="italic"><span class="koboSpan" id="kobo.420.1">It depends,</span></em><span class="koboSpan" id="kobo.421.1">” and any competent software architect knows that this is not a “</span><span class="No-Break"><span class="koboSpan" id="kobo.422.1">one-size-fits-all” situation.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer161">
<span class="koboSpan" id="kobo.423.1"><img alt="Figure 13.19 – Service granularity advantages and drawbacks" src="image/Figure_13.19_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.424.1">Figure 13.19 – Service granularity advantages and drawbacks</span></p>
<p><span class="koboSpan" id="kobo.425.1">I realize I </span><a id="_idIndexMarker781"/><span class="koboSpan" id="kobo.426.1">have been saying this every chapter or so, but it’s worth repeating – what should be a priority in the granularity of services for business functions? </span><span class="koboSpan" id="kobo.426.2">If you know that the authorization rules change very rarely and having to wait for a new release is not a problem, then implement what should be a priority in the granularity of services for business functions directly in the code of the associated referential service; you will get the best performance, and you only will have to deal with the problem of securing cloned data if you have some. </span><span class="koboSpan" id="kobo.426.3">If it is an issue, consider calling the other referential service if there is any doubt; it will also be a way to refresh part of your cloned data. </span><span class="koboSpan" id="kobo.426.4">Conversely, if you can foresee that authorization rules are going to change frequently or there are external circumstances, such as regulation, then consider progressively extracting responsibilities from your data referential service. </span><span class="koboSpan" id="kobo.426.5">Foreseeing this kind of thing is admittedly a fine line between over-anticipating and adopting too much of a DRY approach, but this is where judgment, long-time expertise, and having suffered from many previous </span><a id="_idTextAnchor484"/><span class="koboSpan" id="kobo.427.1">experiences come </span><span class="No-Break"><span class="koboSpan" id="kobo.428.1">in handy.</span></span></p>
<h1 id="_idParaDest-273"><a id="_idTextAnchor485"/><span class="koboSpan" id="kobo.429.1">Applying authorization to our sample information system</span></h1>
<p><span class="koboSpan" id="kobo.430.1">XACML was </span><a id="_idIndexMarker782"/><span class="koboSpan" id="kobo.431.1">explained previously but is quite a complex mechanism to put in place. </span><span class="koboSpan" id="kobo.431.2">Also, there is not a reference implementation of the protocol, although several products exist such as WSO², Balana, Axiomatics, or products from AT&amp;T. </span><span class="koboSpan" id="kobo.431.3">Although these all have their place in big information systems such as banks or insurance, they would be oversized for the small information system that we have decided to simulate in our example, so we are going to use something lighter and closer to t</span><a id="_idTextAnchor486"/><span class="koboSpan" id="kobo.432.1">he main </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">internet protocols.</span></span></p>
<h2 id="_idParaDest-274"><a id="_idTextAnchor487"/><span class="koboSpan" id="kobo.434.1">The Open Policy Agent alternative</span></h2>
<p><span class="koboSpan" id="kobo.435.1">Open Policy Agent </span><a id="_idIndexMarker783"/><span class="koboSpan" id="kobo.436.1">is a project that is supported by the Cloud Native Computing Foundation and that proposes a nice decoupling between grammar to describe policies. </span><span class="koboSpan" id="kobo.436.2">In short, OPA is to XACML what REST is to SOAP – a lightweight alternative that takes on 80% of the job with 20% of the complexity. </span><span class="koboSpan" id="kobo.436.3">Instead of installing a full-blown XACML server to show an example of externalizing the authorization responsibility, we are going to use Docker to customize an </span><span class="No-Break"><span class="koboSpan" id="kobo.437.1">authorization engine.</span></span></p>
<p><span class="koboSpan" id="kobo.438.1">OPA uses a declarative language named </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">Rego</span></strong><span class="koboSpan" id="kobo.440.1"> to describe the policies that should be applied to data to make decisions. </span><span class="koboSpan" id="kobo.440.2">It can then execute these policies to provide JSON results that can be exploited in other services, or another part of the code if you use the OPA implementation as </span><span class="No-Break"><span class="koboSpan" id="kobo.441.1">a component.</span></span></p>
<p><span class="koboSpan" id="kobo.442.1">Technically, what will happen is that a request like the following will be sent to OPA, and it will respond with whether the requested access should be authorized </span><span class="No-Break"><span class="koboSpan" id="kobo.443.1">or not:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.444.1">
{
    "input": {
        "user": "jpgou",
        "operation": "all",
        "resource": "books.content",
        "book": "978-2409002205"
    }
}</span></pre> <p><span class="koboSpan" id="kobo.445.1">In this example, the user </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">jpgou</span></strong><span class="koboSpan" id="kobo.447.1"> requests full access to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">content</span></strong><span class="koboSpan" id="kobo.449.1"> petal of the book, identified </span><a id="_idIndexMarker784"/><span class="koboSpan" id="kobo.450.1">under the ISBN number </span><strong class="source-inline"><span class="koboSpan" id="kobo.451.1">978-2409002205</span></strong><span class="koboSpan" id="kobo.452.1"> in the system. </span><span class="koboSpan" id="kobo.452.2">If this is granted by the OPA server, it will respond with something </span><span class="No-Break"><span class="koboSpan" id="kobo.453.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.454.1">
{
    "result": {
        "allow": true
    }
}</span></pre> <p><span class="koboSpan" id="kobo.455.1">Before diving into the technology again, we need to be precise about what we want to achieve fro</span><a id="_idTextAnchor488"/><span class="koboSpan" id="kobo.456.1">m a functional point </span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">of view.</span></span></p>
<h2 id="_idParaDest-275"><a id="_idTextAnchor489"/><span class="koboSpan" id="kobo.458.1">The functional needs of DemoEditor</span></h2>
<p><span class="koboSpan" id="kobo.459.1">Let’s return </span><a id="_idIndexMarker785"/><span class="koboSpan" id="kobo.460.1">to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">DemoEditor</span></strong><span class="koboSpan" id="kobo.462.1"> sample and describe what should be done from the authorization’s point of view. </span><span class="koboSpan" id="kobo.462.2">Of course, in a publishing company, authors have permission to provide the content of books and adjust it as they will, but they should never be able to read the content of another author’s book, in order to avoid plagiarism or even intellectual property theft. </span><span class="koboSpan" id="kobo.462.3">Since there are editors who take care of authors, it is logical that they can at least read the content of the books from the authors they manage. </span><span class="koboSpan" id="kobo.462.4">Salespersons, on the other hand, do not have any editing responsibility, so they may know some information about the book to prepare sales and orders but have no reason to know anything about the </span><span class="No-Break"><span class="koboSpan" id="kobo.463.1">editing process.</span></span></p>
<p><span class="koboSpan" id="kobo.464.1">In this short description of the stakes at play in the rights management of </span><strong class="source-inline"><span class="koboSpan" id="kobo.465.1">DemoEditor</span></strong><span class="koboSpan" id="kobo.466.1">, it is quite clear that pure RBAC will not be enough, and we will have to resort to ABAC to complete RBAC since there are rules based on the attributes of the book, namely who is the author, and even other information such as the link between authors and their editors. </span><span class="koboSpan" id="kobo.466.2">RBAC is simply not enough because an author has more rights on their own books than on the ones from a different author, although they both will benefit from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.467.1">author</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.468.1">authorization profile.</span></span></p>
<p><span class="koboSpan" id="kobo.469.1">As will be explained in more detail in the following section, we will also add a few rules, such as the fact that salespersons can only see the book once it has reached a certain status, or another one allowing us to block the rights for an author that does not respect the editing contract and should be denied permissions. </span><span class="koboSpan" id="kobo.469.2">To do so, we will use the same metaphor </span><a id="_idIndexMarker786"/><span class="koboSpan" id="kobo.470.1">that we used in </span><a href="B21293_09.xhtml#_idTextAnchor318"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.471.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.472.1">, where designating the different categories of data for books is like placing them in the petals of a flower, the core of which contains the most important, entity-defining data, such as the ISBN number and the title of the book. </span><span class="koboSpan" id="kobo.472.2">Although it may be tempting to define these petals based on the authorization rules, it is important to keep in mind they have to be drawn from functional constraints, and authorization management is one of th</span><a id="_idTextAnchor490"/><span class="koboSpan" id="kobo.473.1">em, but still only one </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">of them.</span></span></p>
<h2 id="_idParaDest-276"><a id="_idTextAnchor491"/><span class="koboSpan" id="kobo.475.1">Creating the authorization policies</span></h2>
<p><span class="koboSpan" id="kobo.476.1">Starting with </span><a id="_idIndexMarker787"/><span class="koboSpan" id="kobo.477.1">the definition of the authorization policies will allow us to do two </span><span class="No-Break"><span class="koboSpan" id="kobo.478.1">things simultaneously:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.479.1">Explain what kind of authorization behavior we intend to put in place and how the data referential service for the books </span><span class="No-Break"><span class="koboSpan" id="kobo.480.1">should work</span></span></li>
<li><span class="koboSpan" id="kobo.481.1">Explore some of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.482.1">Rego</span></strong><span class="koboSpan" id="kobo.483.1"> syntax and what is at play when externalizing authorizations with such </span><span class="No-Break"><span class="koboSpan" id="kobo.484.1">a mechanism</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.485.1">When writing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">policy.rego</span></strong><span class="koboSpan" id="kobo.487.1"> file (just an arbitrary name) for the authorization management of the books data referential service, we need to start with a package name, which allows us to separate rules from different groups when they are executed in the same engine. </span><span class="koboSpan" id="kobo.487.2">The beginning of the file also contains some instructions to import specific keywords and functions (OPA supports plugins and extensions of the grammar to ease its use) or prepare data (which we will come back to further on in </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">the chapter):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.489.1">
package app.abac
import future.keywords
import data.org_chart</span></pre> <p><span class="koboSpan" id="kobo.490.1">The body of the file then generally starts with a pattern where a main authorization attribute, which we will call </span><strong class="source-inline"><span class="koboSpan" id="kobo.491.1">allow</span></strong><span class="koboSpan" id="kobo.492.1">, is broken down into several finer-grained decision policies. </span><span class="koboSpan" id="kobo.492.2">What we want to achieve is an authorization engine that, when exposed to a type of access, will send as a result whether this access should be granted or not. </span><span class="koboSpan" id="kobo.492.3">We will come back to this part later when demonstrating how to apply the rules engine, but for now, let’s </span><a id="_idIndexMarker788"/><span class="koboSpan" id="kobo.493.1">continue with the policy-defining file and show how the behavior we discussed will </span><span class="No-Break"><span class="koboSpan" id="kobo.494.1">be implemented:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.495.1">
default allow := false
allow if {
    permission_associated_to_role
    no_author_blocking
    no_status_blocking
    authors_on_books_they_write
    editors_on_books_from_authors_they_manage
}</span></pre> <p><span class="koboSpan" id="kobo.496.1">In order to implement security best practices, access is forbidden by default. </span><span class="koboSpan" id="kobo.496.2">This allows for what is called “graceful degradation” – if there is a problem in the authorization subsystem, it will default to the safest situation. </span><span class="koboSpan" id="kobo.496.3">In our case, the safest approach is to not allow access, since a lack of availability is, of course, less of a problem than disclosing data to a person who should not have been able to see it, with all the business consequences such an event could have. </span><span class="koboSpan" id="kobo.496.4">This is what the first line in the preceding code is about – setting to </span><strong class="source-inline"><span class="koboSpan" id="kobo.497.1">false</span></strong><span class="koboSpan" id="kobo.498.1"> the default value of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.499.1">allow</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.500.1"> attribute.</span></span></p>
<p><span class="koboSpan" id="kobo.501.1">The second operation states that, in order to make </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">allow</span></strong><span class="koboSpan" id="kobo.503.1"> become </span><strong class="source-inline"><span class="koboSpan" id="kobo.504.1">true</span></strong><span class="koboSpan" id="kobo.505.1">, we need to pass five different decisions, each of them needing to be evaluated to </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">true</span></strong><span class="koboSpan" id="kobo.507.1">. </span><span class="koboSpan" id="kobo.507.2">These decisions are, of course, named in such a way they will be easy to understand and debug (setting authorizations correctly is somewhat of a challenge, but this will almost never be 100% correct at the first attempt). </span><span class="koboSpan" id="kobo.507.3">The rest of the file will basically be about detailing these five main decisions, but before we declare how they work, we need to prepare some data. </span><span class="koboSpan" id="kobo.507.4">Indeed, as we will explain in the next section, we need some referential service data in order for the engine to make decisions. </span><span class="koboSpan" id="kobo.507.5">For example, since we stated that editors should have access to books from the authors they coach, there will be an obvious need for the engine to know about the links between authors and editors. </span><span class="koboSpan" id="kobo.507.6">Some other information, such as the status attribute of the book, will also be useful. </span><span class="koboSpan" id="kobo.507.7">All this data will mostly come from the data referential service to the engine, but it will be basic data, and we may glean some information from it before actually using the whole set of data to </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">infer decisions.</span></span></p>
<p><span class="koboSpan" id="kobo.509.1">One such</span><a id="_idIndexMarker789"/><span class="koboSpan" id="kobo.510.1"> piece of information is the roles the current user owns. </span><span class="koboSpan" id="kobo.510.2">As stated previously, we will need some bits of RBAC, even if it is not enough. </span><span class="koboSpan" id="kobo.510.3">That means the user will be linked to some roles, some of them directly and some of them through the user belonging to identification groups. </span><span class="koboSpan" id="kobo.510.4">The following grammar expresses </span><span class="No-Break"><span class="koboSpan" id="kobo.511.1">precisely this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.512.1">
user_groups contains group if {
    some group in data.directory[input.user].groups
}
user_group_roles contains role if {
    some group in user_groups
    some role in data.group_mappings[group].roles
}
user_direct_roles contains role if {
    some role in data.user_mappings[input.user].roles
}
user_roles := user_group_roles | user_direct_roles</span></pre> <p><span class="koboSpan" id="kobo.513.1">Groups can be found in a piece of data called </span><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">directory</span></strong><span class="koboSpan" id="kobo.515.1">, by looking at the entry in the list designated by the value of the input variable called </span><strong class="source-inline"><span class="koboSpan" id="kobo.516.1">user</span></strong><span class="koboSpan" id="kobo.517.1">. </span><span class="koboSpan" id="kobo.517.2">Once this user is found in the list, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.518.1">groups</span></strong><span class="koboSpan" id="kobo.519.1"> attribute will provide the list of identification groups. </span><span class="koboSpan" id="kobo.519.2">These will then be used to retrieve the roles associated with the groups, leveraging a collection called </span><strong class="source-inline"><span class="koboSpan" id="kobo.520.1">group_mappings</span></strong><span class="koboSpan" id="kobo.521.1">. </span><span class="koboSpan" id="kobo.521.2">The same logic will be applied to a collection that sends the roles directly applied to a user, and the two role lists will simply be merged by the last operation shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.522.1">preceding code.</span></span></p>
<p><span class="koboSpan" id="kobo.523.1">We will also need information about the author potentially associated with the user. </span><span class="koboSpan" id="kobo.523.2">This is something I have not explained fully yet, briefly mentioning the fact that an author uses a user to access the information system from </span><strong class="source-inline"><span class="koboSpan" id="kobo.524.1">DemoEditor</span></strong><span class="koboSpan" id="kobo.525.1"> even if they are not really part of an organization, or at least not employees of it. </span><span class="koboSpan" id="kobo.525.2">This means that, first, access will have to be provided to them (we will come back to how to do this when implementing the associated function). </span><span class="koboSpan" id="kobo.525.3">This also means that there should be a way somehow to associate these two entities in the information system. </span><span class="koboSpan" id="kobo.525.4">A method that happens quite often is to use a verified </span><strong class="source-inline"><span class="koboSpan" id="kobo.526.1">email</span></strong><span class="koboSpan" id="kobo.527.1"> attribute to link them together. </span><span class="koboSpan" id="kobo.527.2">For the moment, we will just consider that the user’s information is contained in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.528.1">author</span></strong><span class="koboSpan" id="kobo.529.1"> entity. </span><span class="koboSpan" id="kobo.529.2">The </span><a id="_idIndexMarker790"/><span class="koboSpan" id="kobo.530.1">rule to retrieve the association is quite easy to write – it simply loops over the list of authors, and if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.531.1">user</span></strong><span class="koboSpan" id="kobo.532.1"> associated with an author is the one the request for access relates to, then the author is the one we are </span><span class="No-Break"><span class="koboSpan" id="kobo.533.1">looking for:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.534.1">
user_author contains author if {
    some author in data.authors
    author.user == input.user
}</span></pre> <p><span class="koboSpan" id="kobo.535.1">In fact, we should refer to authors rather than just an author because we know there will functionally be only one, but technically, we will use a list even if the name of the variable remains in the singular </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">form, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.537.1">user_author</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.538.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.539.1">The same applies to the book that the request talks about, as we need to retrieve its ID from the list of data to be able to make some decisions from rules on </span><span class="No-Break"><span class="koboSpan" id="kobo.540.1">book attributes:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.541.1">
book contains b if {
    some b in data.books[input.book]
}</span></pre> <p><span class="koboSpan" id="kobo.542.1">In the case of an author, we also have to retrieve the list of books they are the writer of because some rules apply to this </span><span class="No-Break"><span class="koboSpan" id="kobo.543.1">as well:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.544.1">
author_books contains book if {
    some author in user_author
    some b in data.books
    b.editing.author == author.id
}</span></pre> <p><span class="koboSpan" id="kobo.545.1">Now that all the necessary data is collected, we can start discussing the rules themselves, taking the five units of rules separately and breaking them down even more. </span><span class="koboSpan" id="kobo.545.2">The first rule that applies is that permissions should be owned by the user associated with the request. </span><span class="koboSpan" id="kobo.545.3">It will not be enough to grant access, but this is nonetheless a necessary </span><a id="_idIndexMarker791"/><span class="koboSpan" id="kobo.546.1">constraint. </span><span class="koboSpan" id="kobo.546.2">In order to know whether the user should be allowed access to the resource they requested, all accesses provided by roles should be studied. </span><span class="koboSpan" id="kobo.546.3">If one corresponds to the type of resource and the operation requested, then it is a match, and the permission </span><span class="No-Break"><span class="koboSpan" id="kobo.547.1">is applied:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.548.1">
permission_associated_to_role if {
    some access in user_accesses_by_roles
    access.type == input.resource
    access.operation == input.operation
}</span></pre> <p><span class="koboSpan" id="kobo.549.1">The following rule makes it happen that if someone gets a right to </span><strong class="source-inline"><span class="koboSpan" id="kobo.550.1">books.content</span></strong><span class="koboSpan" id="kobo.551.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.552.1">books.sales</span></strong><span class="koboSpan" id="kobo.553.1">, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">books.editing</span></strong><span class="koboSpan" id="kobo.555.1"> (one of the petals of the flower corresponding to the data referential service), then they automatically obtain a right to the core of the flower, which is logical, since having access to some data without being able to link it to a given entity would not prove to be </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">very useful:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.557.1">
permission_associated_to_role if {
    some access in user_accesses_by_roles
    "books" == input.resource
    access.operation == input.operation
}</span></pre> <p><span class="koboSpan" id="kobo.558.1">Since we have two rules with the same name (</span><strong class="source-inline"><span class="koboSpan" id="kobo.559.1">permission_associated_to_role</span></strong><span class="koboSpan" id="kobo.560.1">) instead of two rules with different names inside the same group, there is a big difference in processing, as it means that rules are considered to be separate by an “or” operator (and not all needs to be true for the result to be true, such as what was set up previously for </span><strong class="source-inline"><span class="koboSpan" id="kobo.561.1">allow</span></strong><span class="koboSpan" id="kobo.562.1">). </span><span class="koboSpan" id="kobo.562.2">Also, we are even going to add a third case where this part of the policy should be granted, namely when the access provided contains </span><strong class="source-inline"><span class="koboSpan" id="kobo.563.1">all</span></strong><span class="koboSpan" id="kobo.564.1"> as an operation. </span><span class="koboSpan" id="kobo.564.2">In this case, whether the requested operation is </span><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">read</span></strong><span class="koboSpan" id="kobo.566.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">write</span></strong><span class="koboSpan" id="kobo.568.1">, or any other value, it will be granted (at least based on </span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">this criteria):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.570.1">
permission_associated_to_role if {
    some access in user_accesses_by_roles
    access.type == input.resource
    access.operation == "all"
}</span></pre> <p><span class="koboSpan" id="kobo.571.1">Now, the</span><a id="_idIndexMarker792"/><span class="koboSpan" id="kobo.572.1"> question should be, how is </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">user_accesses_by_roles</span></strong><span class="koboSpan" id="kobo.574.1"> calculated? </span><span class="koboSpan" id="kobo.574.2">Well, this time, it is a bit more complicated, with a sub-decision that walks through some tree-like hierarchy of profiles and their associated accesses, contained in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">roles</span></strong><span class="koboSpan" id="kobo.576.1"> entity of the data provided. </span><span class="koboSpan" id="kobo.576.2">We will return to the definition in the next section, but for now, it is important to know that we will use a hierarchy to set managers on top, and then salespersons and editors below, and authors under their editors. </span><span class="koboSpan" id="kobo.576.3">The interesting bit in this approach will be how easy it is to make it so that the role above receives all the permissions of the one below in the tree. </span><span class="koboSpan" id="kobo.576.4">After all, if a salesperson has the right to write the sales values, it is logical that their manager has at least the same rights. </span><span class="koboSpan" id="kobo.576.5">The syntax is harder to read, but do not worry about this, as the OPA documentation is well-written, and there are many examples available for even the most </span><span class="No-Break"><span class="koboSpan" id="kobo.577.1">convoluted rules:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.578.1">
user_accesses_by_roles contains access if {
    some role in user_roles
    some access in permissions[role]
}
roles_graph[entity_name] := edges {
    data.roles[entity_name]
    edges := {neighbor | data.roles[neighbor].parent == entity_name}
}
permissions[entity_name] := access {
    data.roles[entity_name]
    reachable := graph.reachable(roles_graph, {entity_name})
    access := {item | reachable[k]; item := data.roles[k].access[_]}
}</span></pre> <p><span class="koboSpan" id="kobo.579.1">When </span><a id="_idIndexMarker793"/><span class="koboSpan" id="kobo.580.1">dealing with the rule stating that an author can only have rights on books they are authors of, we need to apply a little trick. </span><span class="koboSpan" id="kobo.580.2">As usual, we start by setting access to false, in order to respect security best practices. </span><span class="koboSpan" id="kobo.580.3">And we will set it to </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">true</span></strong><span class="koboSpan" id="kobo.582.1"> if we can follow the link of authoring when in the case of a book writer, and also simply in the case where the user is not a book writer. </span><span class="koboSpan" id="kobo.582.2">That may sound too relaxed a constraint, but remember that this is not the complete result. </span><span class="koboSpan" id="kobo.582.3">In this case, this is just the piece of decision that is about the link between an author and their books; if we are dealing with an editor, this rule simply does not apply, but some others will, and all of them need to align in order for the final, summarizing decision to be positive. </span><span class="koboSpan" id="kobo.582.4">The result is </span><span class="No-Break"><span class="koboSpan" id="kobo.583.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.584.1">
default authors_on_books_they_write := false
authors_on_books_they_write if {
    some role in user_roles
    role != "book-writer"
}
authors_on_books_they_write if {
    some role in user_roles
    role == "book-writer"
    some author in user_author
    some b in data.books
    b.editing.author == author.id
    b.id == input.book
}</span></pre> <p><span class="koboSpan" id="kobo.585.1">By now, you should start to be better accustomed to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">Rego</span></strong><span class="koboSpan" id="kobo.587.1"> syntax, but the third part of the global authorization scheme still requires some thinking, as it needs you to traverse the </span><a id="_idIndexMarker794"/><span class="koboSpan" id="kobo.588.1">whole organizational chart in order to retrieve the link between editors and “their” authors, since we need to apply the rule that an editor only has rights on books from the authors </span><span class="No-Break"><span class="koboSpan" id="kobo.589.1">they manage:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.590.1">
default editors_on_books_from_authors_they_manage := false
editors_on_books_from_authors_they_manage if {
    some role in user_roles
    role != "book-edition"
}
book_author contains b.editing.author if {
    some b in data.books
    b.id == input.book
}
editors_on_books_from_authors_they_manage if {
    some role in user_roles
    role == "book-edition"
    some author in book_author
    some b in data.books
    b.editing.author == author
    b.id == input.book
    user_hierarchy_ok
}
foundpath = path {
    [path, _] := walk(org_chart)
    some author in book_author
    path[_] == author
}
user_hierarchy_ok if {
    some user in foundpath
    user == input.user
}</span></pre> <p><span class="koboSpan" id="kobo.591.1">The fourth </span><a id="_idIndexMarker795"/><span class="koboSpan" id="kobo.592.1">part of the global decision is simpler – it considers that salespersons cannot see a book if it is not in a published or archived status. </span><span class="koboSpan" id="kobo.592.2">Again, in order to account for the “or” approach, we need to calculate twice the </span><strong class="source-inline"><span class="koboSpan" id="kobo.593.1">readable_for_sales</span></strong><span class="koboSpan" id="kobo.594.1"> attribute, initially set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">false</span></strong><span class="koboSpan" id="kobo.596.1"> for security reasons, respectively for the two values of the status allowing access to </span><span class="No-Break"><span class="koboSpan" id="kobo.597.1">the salespersons:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.598.1">
default no_status_blocking := false
no_status_blocking if {
    some role in user_roles
    role != "book-sales"
}
default readable_for_sales := false
readable_for_sales if {
    book.status == "published"
}
readable_for_sales if {
    book.status == "archived"
}
no_status_blocking if {
    some role in user_roles
    role == "book-sales"
    readable_for_sales
}</span></pre> <p><span class="koboSpan" id="kobo.599.1">The</span><a id="_idIndexMarker796"/><span class="koboSpan" id="kobo.600.1"> fifth and final part of the decision is even simpler, and we will not explain the code, simply the rule – if an author has been blocked, they cannot have any access to </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">any book:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.602.1">
default no_author_blocking := false
no_author_blocking if {
    some role in user_roles
    role != "book-writer"
}
no_author_blocking if {
    some role in user_roles
    role == "book-writer"
    some user in user_author
    user.restriction == "none"
}</span></pre> <p><span class="koboSpan" id="kobo.603.1">Once syntax is complete, we need a second type of information to make a decis</span><a id="_idTextAnchor492"/><span class="koboSpan" id="kobo.604.1">ion. </span><span class="koboSpan" id="kobo.604.2">This is what decision data </span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">is about.</span></span></p>
<h2 id="_idParaDest-277"><a id="_idTextAnchor493"/><span class="koboSpan" id="kobo.606.1">Adding some data in order to make decisions</span></h2>
<p><span class="koboSpan" id="kobo.607.1">We had </span><a id="_idIndexMarker797"/><span class="koboSpan" id="kobo.608.1">hinted in the previous section about the fact that data should be provided (and even inferred from other data) in order for the rules engine to be able to make a decision. </span><span class="koboSpan" id="kobo.608.2">Next, we will show what kinds of information we should put in place for our example to work. </span><span class="koboSpan" id="kobo.608.3">First, we need the definition of roles (remember that a role is a set of rights, each composed of a resource type and an </span><span class="No-Break"><span class="koboSpan" id="kobo.609.1">operation type):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.610.1">
"roles": {
    "book-direction": { "access": []},
    "book-sales": { "parent": "book-direction", "access": [{ "operation": "all", "type": "books.sales" }]},
    "book-edition": { "parent": "book-direction", "access": [{ "operation": "all", "type": "books.editing" }]},
    "book-writer": { "parent": "book-edition", "access": [{ "operation": "read", "type": "books.editing" }, { "operation": "all", "type": "books.content" }]}
}</span></pre> <p><span class="koboSpan" id="kobo.611.1">The </span><a id="_idIndexMarker798"/><span class="koboSpan" id="kobo.612.1">preceding JSON content also defines the notion of </span><strong class="source-inline"><span class="koboSpan" id="kobo.613.1">parent</span></strong><span class="koboSpan" id="kobo.614.1">, which creates a tree of roles, with, for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.615.1">book-sales</span></strong><span class="koboSpan" id="kobo.616.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.617.1">book-edition</span></strong><span class="koboSpan" id="kobo.618.1"> placed under </span><strong class="source-inline"><span class="koboSpan" id="kobo.619.1">book-direction</span></strong><span class="koboSpan" id="kobo.620.1">, which means that a director will automatically receive all the permissions granted by default to a salesperson </span><em class="italic"><span class="koboSpan" id="kobo.621.1">and</span></em><span class="koboSpan" id="kobo.622.1"> the ones granted to editors, in addition of course to the ones described directly on the </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">role itself.</span></span></p>
<p><span class="koboSpan" id="kobo.624.1">Some data about books will be sent in order to apply some specific rules that need this. </span><span class="koboSpan" id="kobo.624.2">In the following example, I have shown a list because I tested different combinations. </span><span class="koboSpan" id="kobo.624.3">In actual use, we could simply send the data associated with the only book we request OPA for to decide on its access, and nothing more, in order to preserve performance. </span><span class="koboSpan" id="kobo.624.4">Here is the </span><span class="No-Break"><span class="koboSpan" id="kobo.625.1">associated data:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.626.1">
"books": {
    "978-2409002205": { "id": "978-2409002205", "title": "Performance in .NET", "editing": { "author": "00024", "status": "published" }},
    "978-0000123456": { "id": "978-0000123456", "title": ".NET 8 and Blazor", "editing": { "author": "00025", "status": "draft" }}
}</span></pre> <p><span class="koboSpan" id="kobo.627.1">Note that the preceding code is not expressed in a JSON array but as a structure. </span><span class="koboSpan" id="kobo.627.2">The same is true for data </span><span class="No-Break"><span class="koboSpan" id="kobo.628.1">about authors:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.629.1">
"authors": {
    "00024": { "id": "00024", "firstName": "Jean-Philippe", "lastName": "Gouigoux", "user": "jpgou", "restriction": "none" },
    "00025": { "id": "00025", "firstName": "Nicolas", "lastName": "Couseur", "user": "nicou" }}</span></pre> <p><span class="koboSpan" id="kobo.630.1">The</span><a id="_idIndexMarker799"/><span class="koboSpan" id="kobo.631.1"> organizational chart allows us to define who is the big boss (</span><strong class="source-inline"><span class="koboSpan" id="kobo.632.1">frfra</span></strong><span class="koboSpan" id="kobo.633.1">), define which salespersons and editors are below him (three persons in my example), and finally, to place two authors below the editor, </span><span class="No-Break"><span class="koboSpan" id="kobo.634.1">codenamed </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.635.1">mnfra</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.636.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.637.1">
"org_chart": {
    "frfra": {
        "frvel": {},
        "cemol": {},
        "mnfra": {
            "00024": {},
            "00025": {}
        }
    }
}</span></pre> <p><span class="koboSpan" id="kobo.638.1">We then simulate what would be sent by a user directory – for example, the groups that each user belongs to. </span><span class="koboSpan" id="kobo.638.2">This is somewhat artificial, as we would normally extract this for the JWT token that has been passed through identification, but this is what we will do when hitting the difficulty in code. </span><span class="koboSpan" id="kobo.638.3">For now, we will stay quite symbolic with the </span><span class="No-Break"><span class="koboSpan" id="kobo.639.1">following tree:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.640.1">
"directory": {
    "frfra": {"groups": ["board"]},
    "frvel": {"groups": ["commerce", "marketing"]},
    "cemol": {"groups": ["commerce"]},
    "mnfra": {"groups": ["editors", "quality"]},
    "jpgou": {"groups": ["authors"]},
    "nicou": {"groups": ["authors"]}
}</span></pre> <p><span class="koboSpan" id="kobo.641.1">Of course, now </span><a id="_idIndexMarker800"/><span class="koboSpan" id="kobo.642.1">we have the groups, we need the mappings to link them to roles in a true </span><span class="No-Break"><span class="koboSpan" id="kobo.643.1">RBAC approach:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.644.1">
"group_mappings": {
    "board": { "roles": ["book-direction"] },
    "commerce": { "roles": ["book-sales"] },
    "editors": { "roles": ["book-edition"] },
    "authors": { "roles": ["book-writer"] }
}</span></pre> <p><span class="koboSpan" id="kobo.645.1">And since we have decided to be as complete as possible, we will allow – beyond pure RBAC – the possibility to also state some direct association between a user and a role, without the </span><span class="No-Break"><span class="koboSpan" id="kobo.646.1">group intermediary:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.647.1">
"user_mappings": {
    "frvel": { "roles": ["book-edition"] }
}</span></pre> <p><span class="koboSpan" id="kobo.648.1">Now that everything is set for the server to output some results (rules and data), we can go to the next step, which is setting up a real OPA server, feeding it with th</span><a id="_idTextAnchor494"/><span class="koboSpan" id="kobo.649.1">ese two files, and trying out </span><span class="No-Break"><span class="koboSpan" id="kobo.650.1">some decisions.</span></span></p>
<h2 id="_idParaDest-278"><a id="_idTextAnchor495"/><span class="koboSpan" id="kobo.651.1">Deploying a Docker-based OPA server</span></h2>
<p><span class="koboSpan" id="kobo.652.1">It is </span><a id="_idIndexMarker801"/><span class="koboSpan" id="kobo.653.1">so easy to deploy with Docker that we would be asking for trouble not using it to test OPA. </span><span class="koboSpan" id="kobo.653.2">The command line to run the server is </span><span class="No-Break"><span class="koboSpan" id="kobo.654.1">extremely simple:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.655.1">
docker run -d -p 8181:8181 --name opa openpolicyagent/opa run --server --addr :8181</span></pre> <p><span class="koboSpan" id="kobo.656.1">Once the server is up, we will start with a call to push policy definitions </span><span class="No-Break"><span class="koboSpan" id="kobo.657.1">in it:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.658.1">
curl --no-progress-meter -X PUT http://localhost:8181/v1/policies/app/abac --data-binary @policy.rego</span></pre> <p><span class="koboSpan" id="kobo.659.1">Another</span><a id="_idIndexMarker802"/><span class="koboSpan" id="kobo.660.1"> call is used to send </span><span class="No-Break"><span class="koboSpan" id="kobo.661.1">the data:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.662.1">
curl --no-progress-meter -X PUT http://localhost:8181/v1/data --data-binary @data.json</span></pre> <p><span class="koboSpan" id="kobo.663.1">Finally, we are able to test the OPA server with a simple request that is shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.664.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.665.1">
{
    "input": {
        "user": "jpgou",
        "operation": "all",
        "resource": "books.content",
        "book": "978-2409002205"
    }
}</span></pre> <p><span class="koboSpan" id="kobo.666.1">When called with the following command to send this text content to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">POST</span></strong><span class="koboSpan" id="kobo.668.1">-using API, the OPA server will send a result in JSON, the rest of the command taking care of retrieving only the part of the result we are </span><span class="No-Break"><span class="koboSpan" id="kobo.669.1">interested in:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.670.1">
curl --no-progress-meter -X POST http://localhost:8181/v1/data/app/abac --data-binary @input.json | jq -r '.result | .allow'</span></pre> <p><span class="koboSpan" id="kobo.671.1">If executed as is, this normally sends </span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">true</span></strong><span class="koboSpan" id="kobo.673.1">, meaning that this context of the request is granted by the OPA server. </span><span class="koboSpan" id="kobo.673.2">If you get rid of the last part of the command and display the whole response, you will get something like the following, which is really useful for debugging, since it shows the values for all </span><span class="No-Break"><span class="koboSpan" id="kobo.674.1">intermediate decisions:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.675.1">
{
  "result": {
    "allow": true,
    "author_books": [
      [
        "978-2409002205",
        "Performance in .NET",
        {
          "author": "00024",
          "status": "published"
        }
      ]
    ],
    "authors_on_books_they_write": true,
    "book": [
      "978-2409002205",
      "Performance in .NET",
      {
        "author": "00024",
        "status": "published"
      }
    ],
    "editors_on_books_from_authors_they_manage": true,
    "foundpath": [
      "frfra",
      "mnfra",
      "jpgou"
    ],
    "no_author_blocking": true,
    "no_status_blocking": true,
    "permission_associated_to_role": true,
    "permissions": {
      "book-direction": [
        {
          "operation": "all",
          "type": "books.content"
        },
        {
          "operation": "all",
          "type": "books.editing"
        },
        {
          "operation": "all",
          "type": "books.sales"
        },
        {
          "operation": "read",
          "type": "books.editing"
        }
      ],
      "book-edition": [
        {
          "operation": "all",
          "type": "books.content"
        },
        {
          "operation": "all",
          "type": "books.editing"
        },
        {
          "operation": "read",
          "type": "books.editing"
        }
      ],
      "book-sales": [
        {
          "operation": "all",
          "type": "books.sales"
        }
      ],
      "book-writer": [
        {
          "operation": "all",
          "type": "books.content"
        },
        {
          "operation": "read",
          "type": "books.editing"
        }
      ]
    },
    "readable_for_sales": false,
    "roles_graph": {
      "book-direction": [
        "book-edition",
        "book-sales"
      ],
      "book-edition": [
        "book-writer"
      ],
      "book-sales": [],
      "book-writer": []
    },
    "user_accesses_by_roles": [
      {
        "operation": "all",
        "type": "books.content"
      },
      {
        "operation": "read",
        "type": "books.editing"
      }
    ],
    "user_author": [
      {
        "firstName": "Jean-Philippe",
        "id": "00024",
        "lastName": "Gouigoux",
        "restriction": "none",
        "user": "jpgou"
      }
    ],
    "user_direct_roles": [],
    "user_group_roles": [
      "book-writer"
    ],
    "user_groups": [
      "authors"
    ],
    "user_hierarchy_ok": true,
    </span><a id="_idTextAnchor496"/><span class="koboSpan" id="kobo.676.1">"user_roles": [
      "book-writer"
    ]
  }
}</span></pre> <h2 id="_idParaDest-279"><a id="_idTextAnchor497"/><span class="koboSpan" id="kobo.677.1">Testing the authorizations</span></h2>
<p><span class="koboSpan" id="kobo.678.1">These </span><a id="_idIndexMarker803"/><span class="koboSpan" id="kobo.679.1">sample authorizations are not very complicated, but the level of complexity is enough to be hard to handle manually. </span><span class="koboSpan" id="kobo.679.2">There are many specific cases that pose questions. </span><span class="koboSpan" id="kobo.679.3">For example, if I told you that a manager requests access to the sales data of a book that has not been published yet, what do you think would happen? </span><span class="koboSpan" id="kobo.679.4">And, more importantly, what do you think </span><span class="No-Break"><span class="koboSpan" id="kobo.680.1">should happen?</span></span></p>
<p><span class="koboSpan" id="kobo.681.1">Also, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.682.1">Rego</span></strong><span class="koboSpan" id="kobo.683.1"> syntax has a steep learning curve. </span><span class="koboSpan" id="kobo.683.2">Writing the rules presented previously took me a few hours, if not a day since I am not a specialist, and I am not sure they work exactly the way I think </span><span class="No-Break"><span class="koboSpan" id="kobo.684.1">they do.</span></span></p>
<p><span class="koboSpan" id="kobo.685.1">This is where having good testers is of utmost importance, and their ability to define a testing campaign, find all the corner cases, discuss them with the product owners/customers, and so on will be a great help. </span><span class="koboSpan" id="kobo.685.2">Such a test campaign will be created using a Gherkin syntax (see the following sample scenarios). </span><span class="koboSpan" id="kobo.685.3">If you use a tool such as SpecFlow, you can create many of these scenarios and test them automatically so that every modification to the rules grammar does not break anything. </span><span class="koboSpan" id="kobo.685.4">Once your complete set of tests is ready, you will obtain a report on whether all the series of tests have passed, ultimately reassuring you that all modes you have thought of </span><span class="No-Break"><span class="koboSpan" id="kobo.686.1">are correct.</span></span></p>
<p><span class="koboSpan" id="kobo.687.1">In order to install SpecFlow in Visual Studio, follow the instructions at </span><a href="https://docs.specflow.org/projects/getting-started/en/latest/index.html"><span class="koboSpan" id="kobo.688.1">https://docs.specflow.org/projects/getting-started/en/latest/index.html</span></a><span class="koboSpan" id="kobo.689.1">. </span><span class="koboSpan" id="kobo.689.2">Then, you will need to create a project of type </span><strong class="source-inline"><span class="koboSpan" id="kobo.690.1">SpecFlow Project</span></strong><span class="koboSpan" id="kobo.691.1">. </span><span class="koboSpan" id="kobo.691.2">The result will be some classes with examples of how to use SpecFlow, and we are going to adapt them to our specific needs, which is to test the authorization rules we have set up in OPA. </span><span class="koboSpan" id="kobo.691.3">We will use xUnit as the underlying test framework here, but you can, of course, modify this to </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">your preferences:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer162">
<span class="koboSpan" id="kobo.693.1"><img alt="Figure 13.20 – Creating a SpecFlow project" src="image/Figure_13.20_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.694.1">Figure 13.20 – Creating a SpecFlow project</span></p>
<p><span class="koboSpan" id="kobo.695.1">The structure of the </span><a id="_idIndexMarker804"/><span class="koboSpan" id="kobo.696.1">project created will be based on a sample called </span><strong class="source-inline"><span class="koboSpan" id="kobo.697.1">Calculator</span></strong><span class="koboSpan" id="kobo.698.1">, and the very first action is to change the names to fit our own purpose, which is to </span><span class="No-Break"><span class="koboSpan" id="kobo.699.1">test OPA:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer163">
<span class="koboSpan" id="kobo.700.1"><img alt="Figure 13.21 – The SpecFlow project structure" src="image/Figure_13.21_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.701.1">Figure 13.21 – The SpecFlow project structure</span></p>
<p><span class="koboSpan" id="kobo.702.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">OPA.feature</span></strong><span class="koboSpan" id="kobo.704.1"> content is, in the first step, modified to the following </span><span class="No-Break"><span class="koboSpan" id="kobo.705.1">Gherkin content:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.706.1">
Feature: OPA
Scenario: An author has all rights to the content of their book
    Given book number 978-2409002205 with author id 00024 is in workInProgress status
    And user jpgou belongs to group authors
    And organizational chart is {"frfra":{"frvel":{},"cemol":{},"mnfra":{"00024":{},"00025":{}}}}
    And user jpgou is associated with author 00024 who has a level of restriction none
    When the user jpgou requests all access to the books.content petal of the book number 978-2409002205
    Then access should be accepted
Scenario: An author has no rights to the content of the book from another author
    Given book number 978-2409002205 with author id 00024 is in workInProgress status
    And user jpgou belongs to group authors
    And organizational chart is {"frfra":{"frvel":{},"cemol":{},"mnfra":{"00024":{},"00025":{}}}}
    And user jpgou is associated with author 00024 who has a level of restriction none
    When the user nicou requests read access to the books.content petal of the book number 978-2409002205
    Then access should be refused
Scenario: An author that has been blocked has no rights, even on their own books
    Given book number 978-2409002205 with author id 00024 is in workInProgress status
    And user jpgou belongs to group authors
    And organizational chart is {"frfra":{"frvel":{},"cemol":{},"mnfra":{"00024":{},"00025":{}}}}
    And user jpgou is associated with author 00024 who has a level of restriction blocked
    When the user jpgou requests all access to the books.content petal of the book number 978-2409002205
    Then access should be refused
Scenario: An editor has all rights to the content of the books from the authors they manage
    Given book number 978-2409002205 with author id 00024 is in workInProgress status
    And user jpgou belongs to group authors
    And user mnfra belongs to group editors
    And organizational chart is {"frfra":{"frvel":{},"cemol":{},"mnfra":{"00024":{},"00025":{}}}}
    And user jpgou is associated with author 00024 who has a level of restriction none
    When user mnfra requests all access to the books.content petal of the book number 978-2409002205
    Then access should be accepted
Scenario: An editor has no rights to the content of the books from the authors they do not manage
    Given book number 978-2409002205 with author id 00024 is in workInProgress status
    And user jpgou belongs to group authors
    And user mnfra belongs to group editors
    And organizational chart is {"frfra":{"frvel":{},"cemol":{},"mnfra":{"nicou":{}}}}
    And user jpgou is associated with author 00024 who has a level of restriction none
    When user mnfra requests all access to the books.content petal of the book number 978-2409002205
    Then access should be refused
Scenario: Refusing salesperson access to work-in-progress book
    Given book number 978-2409002205 with author id 00024 is in workInProgress status
    And user frvel belongs to the group commerce
    And organizational chart is {"frfra":{"frvel":{},"cemol":{},"mnfra":{"00024":{},"00025":{}}}}
    When the user frvel requests read access to the books.content petal of the book number 978-2409002205
    Then access should be refused</span></pre> <p><span class="koboSpan" id="kobo.707.1">This </span><a id="_idIndexMarker805"/><span class="koboSpan" id="kobo.708.1">syntax should be easy to read, even for non-developers; the idea of behavior-driven development is that functional people are able to express their requirements in such a language, called Gherkin (which has many more sophisticated features than we show here for simplicity reasons). </span><span class="koboSpan" id="kobo.708.2">In order for this Gherkin syntax to be transformed into an automated xUnit test, we need to create a correspondence between the lines in the scenario and the C# functions that implement this part of the test. </span><span class="koboSpan" id="kobo.708.3">This is done in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.709.1">OPAStepDefinitions.cs</span></strong><span class="koboSpan" id="kobo.710.1"> file. </span><span class="koboSpan" id="kobo.710.2">For example, for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.711.1">Given</span></strong><span class="koboSpan" id="kobo.712.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.713.1">And</span></strong><span class="koboSpan" id="kobo.714.1"> keywords (which are of the same notion), the corresponding functions will be </span><span class="No-Break"><span class="koboSpan" id="kobo.715.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.716.1">
[Given("book number (.*) with author id (.*) is in (.*) status")]
public void AddBookWithStatus(string number, string authorId, string status)
{
    _books.Add(new Book() { Number = number, AuthorId = authorId, Status = status });
}
[Given("user (.*) belongs to group (.*)")]
public void AddUserWithGroup(string login, string group)
{
    _users.Add(new User() { Login = login, Group = group });
}
[Given("user (.*) is associated to author (.*) who has level of restriction (.*)")]
public void AddAuthor(string login, string authorId, string restrictionLevel)
{
    _authors.Add(new Author() { Login = login, Id = authorId, Restriction = restrictionLevel });
}
[Given("organizational chart is (.*)")]
public void SetOrganizationChart(string orgChart)
{
    _orgChart = orgChart;
}</span></pre> <p><span class="koboSpan" id="kobo.717.1">In the initialization part of the class containing this function, we will, of course, have a member to store the books (and other lists for other entities needed for the </span><span class="No-Break"><span class="koboSpan" id="kobo.718.1">test scenarios):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.719.1">
private static HttpClient _client;
private static List&lt;Author&gt; _authors;
private static List&lt;Book&gt; _books;
private static List&lt;User&gt; _users;
private static string _orgChart;
private static string _result;</span></pre> <p><span class="koboSpan" id="kobo.720.1">The</span><a id="_idIndexMarker806"/><span class="koboSpan" id="kobo.721.1"> corresponding classes contain all that is needed to vary the context of the rules. </span><span class="koboSpan" id="kobo.721.2">As you can see, the first name and last name of the authors have not been integrated into the model, since we have a strong assurance that they cannot impact the output of the </span><span class="No-Break"><span class="koboSpan" id="kobo.722.1">rules engine:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.723.1">
public class Author
{
    public string Id { get; set; }
    public string Login { get; set; }
    public string Restriction { get; set; }
}
public class Book
{
    public string Number { get; set; }
    public string Status { get; set; }
    public string AuthorId { get; set; }
}
public class User
{
    public string Login { get; set; }
    public string Group { get; set; }
}
Some methods will be used to initiate the values for each scenario, and also for the entire feature:
[BeforeFeature]
public static void Initialize()
{
    _client = new HttpClient();
    _client.BaseAddress = new Uri("http://localhost:8181/v1/");
}
[BeforeScenario]
public static void InitializeScenario()
{
    _authors = new List&lt;Author&gt;();
    _books = new List&lt;Book&gt;();
    _users = new List&lt;User&gt;();
}</span></pre> <p><span class="koboSpan" id="kobo.724.1">This </span><a id="_idIndexMarker807"/><span class="koboSpan" id="kobo.725.1">will allow us, upon calling on the function associated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">When</span></strong><span class="koboSpan" id="kobo.727.1"> keyword, to realize the call to the so-called System Under Test (what we want to validate is the OPA server, which should have been started and customized with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.728.1">Rego</span></strong><span class="koboSpan" id="kobo.729.1"> content and will listen on port </span><strong class="source-inline"><span class="koboSpan" id="kobo.730.1">8181</span></strong><span class="koboSpan" id="kobo.731.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.732.1">our setup):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.733.1">
[When("user (.*) request (.*) access to the (.*) petal of the book number (.*)")]
public void ExecuteRequest(string login, string access, string perimeter, string bookNumber)
{
    StringBuilder sb = new StringBuilder();
    sb.AppendLine("{");
    sb.AppendLine("    \"roles\": {");
    sb.AppendLine("        \"book-direction\": { \"access\": []},");
    sb.AppendLine("        \"book-sales\": { \"parent\": \"book-direction\", \"access\": [{ \"operation\": \"all\", \"type\": \"books.sales\" }]},");
    sb.AppendLine("        \"book-edition\": { \"parent\": \"book-direction\", \"access\": [{ \"operation\": \"all\", \"type\": \"books.editing\" }]},");
    sb.AppendLine("        \"book-writer\": { \"parent\": \"book-edition\", \"access\": [{ \"operation\": \"read\", \"type\": \"books.editing\" }, { \"operation\": \"all\", \"type\": \"books.content\" }]}");
    sb.AppendLine("    },");
    sb.AppendLine("    \"books\": {");
    for (int i=0; i&lt;_books.Count; i++)
    {
        Book b = _books[i];
        sb.Append("        \"" + b.Number + "\": { \"id\": \"" + b.Number + "\", \"title\": \"***NORMALLY NO IMPACT ON RULES***\", \"editing\": { \"author\": \"" + b.AuthorId + "\", \"status\": \"" + b.Status + "\" }}");
        if (i &lt; _books.Count - 1) sb.AppendLine(","); else sb.AppendLine();
    }
    sb.AppendLine("    },");
    sb.AppendLine("    \"authors\": {");
    for (int i = 0; i &lt; _authors.Count; i++)
    {
        Author a = _authors[i];
        sb.AppendLine("        \"" + a.Id + "\": { \"id\": \"" + a.Id + "\", \"firstName\": \"***NORMALLY NO IMPACT ON RULES***\", \"lastName\": \"***NORMALLY NO IMPACT ON RULES***\", \"user\": \"" + a.Login + "\", \"restriction\": \"" + a.Restriction + "\" }");
        if (i &lt; _authors.Count - 1) sb.AppendLine(","); else sb.AppendLine();
    }
    sb.AppendLine("    },");
    sb.AppendLine("    \"org_chart\": " + _orgChart + ",");
    sb.AppendLine("    \"directory\": {");
    for (int i = 0; i &lt; _users.Count; i++)
    {
        User u = _users[i];
        sb.AppendLine("        \"" + u.Login + "\": {\"groups\": [\"" + u.Group + "\"]}");
        if (i &lt; _users.Count - 1) sb.AppendLine(","); else sb.AppendLine();
    }
    sb.AppendLine("    },");
    sb.AppendLine("    \"group_mappings\": {");
    sb.AppendLine("        \"board\": { \"roles\": [\"book-direction\"] },");
    sb.AppendLine("        \"commerce\": { \"roles\": [\"book-sales\"] },");
    sb.AppendLine("        \"editors\": { \"roles\": [\"book-edition\"] },");
    sb.AppendLine("        \"authors\": { \"roles\": [\"book-writer\"] }");
    sb.AppendLine("    },");
    sb.AppendLine("    \"user_mappings\": {");
    sb.AppendLine("    }");
    sb.AppendLine("}");
    var response = _client.PutAsync("data", new StringContent(sb.ToString(), Encoding.UTF8, "application/json")).Result;
    string input = "{ \"input\": { \"user\": \"" + login + "\","
        + " \"operation\": \"" + access + "\","
        + " \"resource\": \"" + perimeter + "\","
        + " \"book\": \"" + bookNumber + "\" } }";
    response = _client.PostAsync("data/app/abac", new StringContent(input, Encoding.UTF8, "application/json")).Result;
    if (response != null)
    {
        _result = response.Content.ReadAsStringAsync().Result;
    }
}
}</span></pre> <p><span class="koboSpan" id="kobo.734.1">The final </span><a id="_idIndexMarker808"/><span class="koboSpan" id="kobo.735.1">part of the test execution is carried out by the method associated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.736.1">Then</span></strong><span class="koboSpan" id="kobo.737.1"> keyword, which is the one running the asserts in order to simulate an </span><span class="No-Break"><span class="koboSpan" id="kobo.738.1">automated test:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.739.1">
[Then("access should be (.*)")]
public void ValidateExpectedResult(string expectedResult)
{
    JsonTextReader reader = new JsonTextReader(new StringReader(_result));
    reader.Read(); // Get first element
    reader.Read(); // Read result attribute
    reader.Read(); // Get element for result
    reader.Read(); // Read allow attribute
    bool? </span><span class="koboSpan" id="kobo.739.2">actual = reader.ReadAsBoolean(); // Get boolean value for allow attribute
    if (actual is null)
        throw new ApplicationException("Unable to find result");
    bool? </span><span class="koboSpan" id="kobo.739.3">expected = null;
    if (expectedResult == "refused") expected = false;
    if (expectedResult == "accepted") expected = true;
    if (expected is null)
        throw new ApplicationException("Unable to find expected value");
    Assert.Equal(expected, actual);
}</span></pre> <p><span class="koboSpan" id="kobo.740.1">You now can </span><a id="_idIndexMarker809"/><span class="koboSpan" id="kobo.741.1">display the Test Explorer by accessing it from the menu or using the </span><em class="italic"><span class="koboSpan" id="kobo.742.1">Ctrl</span></em><span class="koboSpan" id="kobo.743.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.744.1">E</span></em><span class="koboSpan" id="kobo.745.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.746.1">T</span></em><span class="koboSpan" id="kobo.747.1"> shortcut. </span><span class="koboSpan" id="kobo.747.2">The tests might not display at first, and you may have to run the solution generation for them to appear. </span><span class="koboSpan" id="kobo.747.3">Once they are displayed, you can run the scenarios one by one or simultaneously, and if everything works fine, they should confirm the rules work as intended and display everything with ticks </span><span class="No-Break"><span class="koboSpan" id="kobo.748.1">on circles:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer164">
<span class="koboSpan" id="kobo.749.1"><img alt="Figure 13.22 – The results of the SpecFlow tests" src="image/Figure_13.22_B21293.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.750.1">Figure 13.22 – The results of the SpecFlow tests</span></p>
<p><span class="koboSpan" id="kobo.751.1">Six scenarios are not a lot for such a complex set of policies, and in the real world, a few dozen such scenarios would be welcome to form such a powerful harness that everyone would be convinced the system works perfectly as expected. </span><span class="koboSpan" id="kobo.751.2">But again, since this is not the main subject of the book, we will leave the automated tests of authorization rules here. </span><span class="koboSpan" id="kobo.751.3">By the way, I showed automated BDD tests created with SpecFlow because this is the framework I am used to, but there are alternatives that may be more suitable, depending on your needs and context. </span><span class="koboSpan" id="kobo.751.4">The important thing is not whether you use SpecFlow, Postman, or any other method but that such important ru</span><a id="_idTextAnchor498"/><span class="koboSpan" id="kobo.752.1">les as authorizations should be </span><span class="No-Break"><span class="koboSpan" id="kobo.753.1">verified carefully.</span></span></p>
<h2 id="_idParaDest-280"><a id="_idTextAnchor499"/><span class="koboSpan" id="kobo.754.1">Challenges with OPA</span></h2>
<p><span class="koboSpan" id="kobo.755.1">OPA is a </span><a id="_idIndexMarker810"/><span class="koboSpan" id="kobo.756.1">great approach to authorization rule implementation, but it still offers </span><span class="No-Break"><span class="koboSpan" id="kobo.757.1">some challenges.</span></span></p>
<p><span class="koboSpan" id="kobo.758.1">First of all, there is the complexity of writing rules, as previously discussed. </span><span class="koboSpan" id="kobo.758.2">Although this is quite logical as we try to fit some complex functional algorithms into just a few keywords, it can really be limiting for those trying to adopt OPA and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.759.1">Rego</span></strong><span class="koboSpan" id="kobo.760.1"> syntax, only to be held up by many incorrect attempts at writing the </span><span class="No-Break"><span class="koboSpan" id="kobo.761.1">right rule.</span></span></p>
<p><span class="koboSpan" id="kobo.762.1">I personally experienced this, and to be perfectly honest, I still do not really understand how the following </span><span class="No-Break"><span class="koboSpan" id="kobo.763.1">rule works:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.764.1">
permissions[entity_name] := access {
    data.roles[entity_name]
    reachable := graph.reachable(roles_graph, {entity_name})
    access := {item | reachable[k]; item := data.roles[k].access[_]}
}</span></pre> <p><span class="koboSpan" id="kobo.765.1">I know that it does because I have tested it, and I can see the point about walking through a tree and picking some data of the path, but the additional recurrent valuation of </span><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">access</span></strong><span class="koboSpan" id="kobo.767.1"> combined with the use of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">_</span></strong><span class="koboSpan" id="kobo.769.1"> keyword and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">reachable</span></strong><span class="koboSpan" id="kobo.771.1"> function just make it too hard for me to write this on my own, without referring to some examples that others have written. </span><span class="koboSpan" id="kobo.771.2">It may be a lack of practice, but I have tried my fair share of exotic languages over almost four decades of programming, and I still think </span><strong class="source-inline"><span class="koboSpan" id="kobo.772.1">Rego</span></strong><span class="koboSpan" id="kobo.773.1"> might be one of the most complicated logics I have encountered. </span><span class="koboSpan" id="kobo.773.2">After a few attempts at using OpenFGA, it may be simpler to provide an equivalent authorization rule, but I cannot make a commitment to this, since I have not yet used this technology in a </span><span class="No-Break"><span class="koboSpan" id="kobo.774.1">production-ready module.</span></span></p>
<p><span class="koboSpan" id="kobo.775.1">Luckily, some documentation such as </span><a href="https://www.openpolicyagent.org/docs/latest/policy-reference/"><span class="koboSpan" id="kobo.776.1">https://www.openpolicyagent.org/docs/latest/policy-reference/</span></a><span class="koboSpan" id="kobo.777.1"> shows advanced examples, and I also found great advanced tips at </span><a href="https://www.fugue.co/blog/5-tips-for-using-the-rego-language-for-open-policy-agent-opa"><span class="koboSpan" id="kobo.778.1">https://www.fugue.co/blog/5-tips-for-using-the-rego-language-for-open-policy-agent-opa</span></a><span class="koboSpan" id="kobo.779.1">, while links such as </span><a href="mailto:https://medium.com/@agarwalshubhi17/rego-cheat-sheet-5e25faa6eee8"><span class="koboSpan" id="kobo.780.1">https://medium.com/@agarwalshubhi17/rego-cheat-sheet-5e25faa6eee8</span></a><span class="koboSpan" id="kobo.781.1"> provided some clear explanation on how these complex </span><span class="No-Break"><span class="koboSpan" id="kobo.782.1">syntaxes work.</span></span></p>
<p><span class="koboSpan" id="kobo.783.1">Another </span><a id="_idIndexMarker811"/><span class="koboSpan" id="kobo.784.1">challenge with OPA might come from the fact that HTTP API calls can cause performance problems if done in volume. </span><span class="koboSpan" id="kobo.784.2">And if your authorization rules are complex, chances are that you will be obliged to apply them to business entities one by one. </span><span class="koboSpan" id="kobo.784.3">So, how would you handle some calls requesting a list of entities? </span><span class="koboSpan" id="kobo.784.4">Calling the API hundreds of times or more is not an option. </span><span class="koboSpan" id="kobo.784.5">And what is true for a local Docker container is even more true for a service in the cloud such as OSO (</span><a href="https://www.osohq.com/"><span class="koboSpan" id="kobo.785.1">https://www.osohq.com/</span></a><span class="koboSpan" id="kobo.786.1">) that proposes a SaaS solution for </span><span class="No-Break"><span class="koboSpan" id="kobo.787.1">authorization rules.</span></span></p>
<p><span class="koboSpan" id="kobo.788.1">Of course, the best approach is still paginating results, which is also good not only for ecological reasons, helping to reduce the strain on resources, but also for ergonomic reasons, by providing users with screens that are less cluttered with data and easier to read and comprehend. </span><span class="koboSpan" id="kobo.788.2">However, cases where you need volume may remain, and calling an HTTP server many times is not an elegant option anyway. </span><span class="koboSpan" id="kobo.788.3">Luckily, OPA can be accessed directly from your code if you use the Go language, or even as a WebAssembly module, making it possible (although not currently easy) to integrate it at the code level from </span><span class="No-Break"><span class="koboSpan" id="kobo.789.1">many platforms.</span></span></p>
<p><span class="koboSpan" id="kobo.790.1">Here’s a final thing to note on authorization management – in this chapter, you have seen a simplified version of the grammar and data that will be applied more realistically in the upcoming chapters. </span><span class="koboSpan" id="kobo.790.2">For example, I used simple identifiers instead of URN, some attributes were repeated in order to ease rule execution, and so on. </span><span class="koboSpan" id="kobo.790.3">I could have shown the policies in their final form but considered it better to show the work in progress for </span><span class="No-Break"><span class="koboSpan" id="kobo.791.1">two reasons:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.792.1">Avoiding this additional complexity made it easier to concentrate on the subject of </span><span class="No-Break"><span class="koboSpan" id="kobo.793.1">authorization rules</span></span></li>
<li><span class="koboSpan" id="kobo.794.1">Showing these adjustments at the precise moment we need to make them will hopefully also make them more understandable, as the situation will show how the simple approach could c</span><a id="_idTextAnchor500"/><span class="koboSpan" id="kobo.795.1">ause an evolution problem and help explain </span><span class="No-Break"><span class="koboSpan" id="kobo.796.1">the change</span></span></li>
</ul>
<h1 id="_idParaDest-281"><a id="_idTextAnchor501"/><span class="koboSpan" id="kobo.797.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.798.1">In this chapter, we showed what a Business Rules Management System does, how useful it can be in an information system, and how we could implement one, starting with a functional example and then demonstrating another example relating to authorizations, which are one of the most used sets of business rules in </span><span class="No-Break"><span class="koboSpan" id="kobo.799.1">software applications.</span></span></p>
<p><span class="koboSpan" id="kobo.800.1">Just like for BPMN engines, BRMS engines are not used very often. </span><span class="koboSpan" id="kobo.800.2">In fact, business rules are – in the great majority of cases – implemented in code expressions or compiled into applications. </span><span class="koboSpan" id="kobo.800.3">This is absolutely normal because a BRMS represents an important investment, and implementing such complex applications really needs a strong business case, where business rules change very frequently or are associated with strict regulatory or marketing constraints, such as the necessity to trace all business rules and their changes, the capacity to simulate the effects of new versions of sets of business rules, and so on. </span><span class="koboSpan" id="kobo.800.4">We can conclude, then, that this approach is currently limited to very rare contexts. </span><span class="koboSpan" id="kobo.800.5">Things may, of course, change in the future, with the industrialization of information system design that we really long for, but at the present time, BPMNs and BRMSs are an effort that is almost </span><span class="No-Break"><span class="koboSpan" id="kobo.801.1">always overkill.</span></span></p>
<p><span class="koboSpan" id="kobo.802.1">And since two of the three parts of the ideal system are not worth using in most of an organization, this means this ideal system is really utopic. </span><span class="koboSpan" id="kobo.802.2">Moreover, even a centralized </span><strong class="bold"><span class="koboSpan" id="kobo.803.1">Master Data Management</span></strong><span class="koboSpan" id="kobo.804.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.805.1">MDM</span></strong><span class="koboSpan" id="kobo.806.1">) approach is complicated. </span><span class="koboSpan" id="kobo.806.2">The MDM practices per se are applicable to every business domain, so there is no problem with a data referential service; they are not very complicated to set up, as we will see in practice in </span><a href="B21293_15.xhtml#_idTextAnchor548"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.807.1">Chapter 15</span></em></span></a><span class="koboSpan" id="kobo.808.1">, and they bring lots of business value and advantages. </span><span class="koboSpan" id="kobo.808.2">However, the ideal system aims for generic MDM, dynamically adjusting to every entity in the business context of an application. </span><span class="koboSpan" id="kobo.808.3">This step further is also out of the scope of this book, though static code generation for a data referential service is becoming a viable option, as we will show at the end of </span><a href="B21293_15.xhtml#_idTextAnchor548"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.809.1">Chapter 15</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.810.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.811.1">In addition, we have shown that the three responsibilities of an ideal information system are, ultimately, quite entangled with </span><span class="No-Break"><span class="koboSpan" id="kobo.812.1">each other:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.813.1">MDM uses business rules in its validation </span><span class="No-Break"><span class="koboSpan" id="kobo.814.1">of data</span></span></li>
<li><span class="koboSpan" id="kobo.815.1">A BRMS needs data from MDM in order to apply the business rules and decide their </span><span class="No-Break"><span class="koboSpan" id="kobo.816.1">output value</span></span></li>
<li><span class="koboSpan" id="kobo.817.1">A BPMN serves mainly as a collector of data to feed the MDM, while also consuming data from </span><span class="No-Break"><span class="koboSpan" id="kobo.818.1">the MDM</span></span></li>
<li><span class="koboSpan" id="kobo.819.1">A BPMN also uses business rules in order to know where to go in the different gateways (and, sometimes, to calculate some additional data during a </span><span class="No-Break"><span class="koboSpan" id="kobo.820.1">given task)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.821.1">All this proves that, technically, this assembly of three generic servers for MDM, a BPMN, and a BRMS is not so feasible, and neither achieves a perfect decoupling. </span><span class="koboSpan" id="kobo.821.2">So, why did we bother in </span><a href="B21293_05.xhtml#_idTextAnchor164"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.822.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.823.1"> and the last three chapters to talk about such an ideal system? </span><span class="koboSpan" id="kobo.823.2">Again, the answer lies in the business/IT alignment. </span><span class="koboSpan" id="kobo.823.3">The ideal system is not something that can be realized in practice in information systems today (and certainly not for at least a few more decades), but it has the great advantage of forcing an architect to think in terms of three generic, always applicable, functional responsibilities. </span><span class="koboSpan" id="kobo.823.4">Even if you use a unique software application, knowing how to separate the data management, business rules management, and business process execution provides a great step toward decoupling your information system (which is not achieved at all with </span><em class="italic"><span class="koboSpan" id="kobo.824.1">n</span></em><span class="koboSpan" id="kobo.825.1">-tier architecture, for example). </span><span class="koboSpan" id="kobo.825.2">As you will see in the coming chapters, constructing an information system with these principles in mind will help us achieve a very complex goal, which is to be able to modify important functional rules and behaviors very easily and, in most cases, without any significant impact on </span><span class="No-Break"><span class="koboSpan" id="kobo.826.1">the implementation.</span></span></p>
<p><span class="koboSpan" id="kobo.827.1">In the next chapter, we will use everything we have learned so far to design the information system of </span><strong class="source-inline"><span class="koboSpan" id="kobo.828.1">DemoEditor</span></strong><span class="koboSpan" id="kobo.829.1">. </span><span class="koboSpan" id="kobo.829.2">In the following chapters, we will finally get hands-on and implement all the different parts of this information system, using C# and .NET as a programming platform and Docker as </span><span class="No-Break"><span class="koboSpan" id="kobo.830.1">deployment architecture.</span></span></p>
</div>


<div class="Content" id="_idContainer166">
<h1 id="_idParaDest-282" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor502"/><span class="koboSpan" id="kobo.1.1">Part 3: Building a Blueprint Application with .NET</span></h1>
<p><span class="koboSpan" id="kobo.2.1">After a theoretical part and one on the architecture principles, we will now dive deep into the technical aspects of the method by implementing some important parts of the sample information system. </span><span class="koboSpan" id="kobo.2.2">We will create some ASP.NET services implementing the API contracts and a graphical user interface that uses them and implements some of the business processes. </span><span class="koboSpan" id="kobo.2.3">Since some features have been externalized to bring more industrial-grade quality, we will also show how to interact with these modules in a lowly coupled way. </span><span class="koboSpan" id="kobo.2.4">Plugging the services into the Apache Keycloak IAM, using standards such as OAuth and JWT, will of course be an important step, but we will also show electronic document management systems in a standard way and talk about many other external services. </span><span class="koboSpan" id="kobo.2.5">Finally, the external execution of business processes will be shown, with both orchestration and </span><span class="No-Break"><span class="koboSpan" id="kobo.3.1">choreographic paradigms.</span></span></p>
<p><span class="koboSpan" id="kobo.4.1">This part has the </span><span class="No-Break"><span class="koboSpan" id="kobo.5.1">following chapters:</span></span></p>
<ul>
<li><a href="B21293_14.xhtml#_idTextAnchor503"><em class="italic"><span class="koboSpan" id="kobo.6.1">Chapter 14</span></em></a><span class="koboSpan" id="kobo.7.1">, </span><em class="italic"><span class="koboSpan" id="kobo.8.1">Decomposing the Functional Responsibilities</span></em></li>
<li><a href="B21293_15.xhtml#_idTextAnchor548"><em class="italic"><span class="koboSpan" id="kobo.9.1">Chapter 15</span></em></a><span class="koboSpan" id="kobo.10.1">, </span><em class="italic"><span class="koboSpan" id="kobo.11.1">Plugging Standard External Modules</span></em></li>
<li><a href="B21293_16.xhtml#_idTextAnchor588"><em class="italic"><span class="koboSpan" id="kobo.12.1">Chapter 16</span></em></a><span class="koboSpan" id="kobo.13.1">, </span><em class="italic"><span class="koboSpan" id="kobo.14.1">Creating a Write-Only Data Referential Service</span></em></li>
<li><a href="B21293_17.xhtml#_idTextAnchor608"><em class="italic"><span class="koboSpan" id="kobo.15.1">Chapter 17</span></em></a><span class="koboSpan" id="kobo.16.1">, </span><em class="italic"><span class="koboSpan" id="kobo.17.1">Adding Query to the Data Referential Service</span></em></li>
<li><a href="B21293_18.xhtml#_idTextAnchor622"><em class="italic"><span class="koboSpan" id="kobo.18.1">Chapter 18</span></em></a><span class="koboSpan" id="kobo.19.1">, </span><em class="italic"><span class="koboSpan" id="kobo.20.1">Deploying Data Referential Services</span></em></li>
<li><a href="B21293_19.xhtml#_idTextAnchor634"><em class="italic"><span class="koboSpan" id="kobo.21.1">Chapter 19</span></em></a><span class="koboSpan" id="kobo.22.1">, </span><em class="italic"><span class="koboSpan" id="kobo.23.1">Designing a Second Data Referential Service</span></em></li>
<li><a href="B21293_20.xhtml#_idTextAnchor647"><em class="italic"><span class="koboSpan" id="kobo.24.1">Chapter 20</span></em></a><span class="koboSpan" id="kobo.25.1">, </span><em class="italic"><span class="koboSpan" id="kobo.26.1">Creating a Graphical User Interface</span></em></li>
<li><a href="B21293_21.xhtml#_idTextAnchor674"><em class="italic"><span class="koboSpan" id="kobo.27.1">Chapter 21</span></em></a><span class="koboSpan" id="kobo.28.1">, </span><em class="italic"><span class="koboSpan" id="kobo.29.1">Extending the Interfaces</span></em></li>
<li><a href="B21293_22.xhtml#_idTextAnchor709"><em class="italic"><span class="koboSpan" id="kobo.30.1">Chapter 22</span></em></a><span class="koboSpan" id="kobo.31.1">, </span><em class="italic"><span class="koboSpan" id="kobo.32.1">Integrating Business Processes</span></em></li>
</ul>
</div>
<div>
<div class="Basic-Graphics-Frame" id="_idContainer167">
</div>
</div>
</body></html>