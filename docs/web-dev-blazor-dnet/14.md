# 十四、生产部署

在本章中，我们将了解在将 Blazor 应用部署到生产环境时，我们有哪些不同的选择。因为有许多不同的选择，把它们全部浏览一遍会是一本书。

我们不会详细讨论，而是涵盖我们需要考虑的不同事情，以便我们可以部署到任何提供商。

最后，部署是我们需要做的事情，以利用我们构建的东西。

在本章中，我们将介绍以下内容:

*   连续交付选项
*   部署数据库
*   托管选项

# 技术要求

本章是关于一般部署的，所以我们不需要任何代码。

# 连续交付选项

在将任何东西部署到生产中时，我们应该考虑确保消除不确定因素。例如，如果我们从自己的机器上部署，我们如何知道它是最新版本？我们如何知道我们的队友最近没有解决问题，我们的分支没有修复？说实话我们怎么知道源码控制的版本在制作上是一样的？还是生产中的版本甚至存在于源码控制中？

这就是**持续集成**和**持续交付/部署** ( **CI/CD** )进入画面的地方。我们只是确保部署到生产环境中的其他东西。部署本身就是一本书，所以我们不会深入探讨这个主题。

GitHub Actions 和 Azure DevOps(或 Azure Pipelines)是微软做 CI/CD 的两种方式。还有很多，比如詹金斯、团队城市和 git lab——名单很长。如果我们目前使用的 CI/CD 系统支持部署 ASP.NET，它将能够处理 Blazor，因为最终 Blazor 只是一个 ASP.NET 站点。

如果我们有测试(我们应该有)，我们还应该确保将测试设置为 CI/CD 管道的一部分。好的一点是，我们不需要添加任何特定的硬件来测试我们的组件；如果我们的 CI/CS 管道能够运行单元测试(n unit、xUnit)，它将会工作。

在我们的工作设置中，当我们执行拉取请求时，我们构建并运行所有的测试。如果构建和测试通过，团队中的其他人会进行代码评审并批准变更。如果团队成员批准了变更，那么它将触发一个发布，该发布将站点部署到我们的测试环境中。我们的测试人员运行测试协议并批准变更。

冲刺结束后，测试人员将运行完整的测试协议并批准站点。然后，我们会触发另一个版本，将站点部署到生产环境中。

既然 Blazor 是 ASP.NET，没有什么能阻止我们对网站进行自动化测试。

# 部署数据库

说到部署我们的数据库，实体框架为我们做了很多。如果需要，我们可以让实体框架应用迁移，但是我有点控制狂。

实体框架为应用和移除变更创建代码，所以让它做它的事情应该是非常安全的。还有一个选择，那就是让实体框架生成我们自己可以应用的 SQL 脚本。

通过添加`script`标志，我们将获得一个可以对数据库运行的 SQL 脚本:

```cs
dotnet ef migrations script 20180904195021_InitialCreate
```

我们可以使用许多不同的数据库，例如微软的 SQL、MySQL，以及我们在本书中使用的 SQLite。

我们也可以选择非关系型数据库。Blazor 支持这一切，所以任何适合这个项目的东西都是我们应该使用的。

# 托管选项

说到托管 Blazor，有很多选择。任何能够托管 ASP.NET Core 站点的云服务都应该能够毫无问题地运行 Blazor。

有一些的事情需要我们去思考，那么我们就一个一个的来看选项。

## 托管 Blazor 服务器

如果云提供商有启用/禁用网络套接字的选项，我们希望启用它们，因为是 SignalR 使用的协议。根据负载的不同，我们可能希望使用像 Azure SignalR Service 这样的服务，它将负责所有的连接，并使我们的应用能够处理更多的用户。

在某些情况下，云提供商可能支持.NET Core 3.x 但不支持.NET 5 开箱即用。但不用担心；通过确保以独立的部署模式发布我们的应用，我们确保部署还添加了运行项目所需的任何文件(这可能不适用于所有宿主提供程序)。

这也是一件好事，以确保我们运行在我们期望的确切框架版本上。

## 托管 Blazor 网络组装

如果我们使用的是一个. NET Core 后端(就像我们为博客做的那样)，我们托管的是一个. NET Core 网站，所以规则与托管 Blazor Server 相同。对于我们的博客，我们还添加了 SignalR，所以我们也需要启用 WebSockets。

在托管 Blazor WebAssembly 时，还有一些其他考虑事项，例如:

*   我们可能需要一个. NET Core 后端。
*   我们获得的数据可能是静态的，或者托管在其他地方。

在这两种情况下，我们都可以在 Azure 静态网站甚至 GitHub Pages 中托管我们的应用。

我们的博客使用身份服务器(这也是 Blazor WebAssembly 身份验证的默认实现)，当我们在开发过程中运行它时，它会使用开发人员证书运行。如果我们想将使用身份服务器的站点部署到生产环境中，我们还需要创建一个证书。

在本书中，我们不打算讨论如何做到这一点或如何设置它，但值得一提的是，我们知道要寻找什么。

## 在 IIS 上托管

我们也可以在**互联网信息服务器** ( **IIS** )上托管我们的应用。安装托管捆绑包，如果安装在有 IIS 的机器上，它还将确保包含 ASP.NET Core IIS 模块。

确保在服务器上启用 WebSocket 协议。

我们目前在 IIS 上运行我们的网站，并使用 Azure DevOps 来部署我们的网站。由于我们使用的是 Blazor 服务器，因此停机时间非常明显。一旦网站失去 SignalR 连接，网站将显示重新连接消息。

对于我们正在使用的站点，部署新版本时大约需要 8 到 10 秒的停机时间，这相当快。

# 总结

在本章中，我们讨论了为什么我们应该使用 CI/CD，因为它对确保应用的质量有着巨大的影响。我们研究了在任何支持的云提供商上运行我们的 Blazor 应用所需做的一些事情.NET 5。

部署可能是应用最重要的一步。不部署我们的应用，它只是代码。有了本章中提到的内容，例如 CI/CD、托管和部署，我们现在就可以部署代码了。

在下一章中，我们将看看我们将从这里走向何方。