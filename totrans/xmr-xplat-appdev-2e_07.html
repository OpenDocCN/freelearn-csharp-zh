<html><head></head><body>
<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07" class="calibre1"/>Chapter 7. Deploying and Testing on Devices</h1></div></div></div><p class="calibre8">Deploying to devices is both important and a bit of a hassle when you try it the first time. Testing on a device will commonly display performance issues that aren't present in the simulator/emulator of your application. You can also test things that are only possible on real devices such as GPS, camera, memory limitations, or cellular network connectivity. There are also common pitfalls that exist when developing for Xamarin, which will only surface when testing on a real device.</p><p class="calibre8">In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem">iOS provisioning</li><li class="listitem">Android device settings for debugging</li><li class="listitem">The linker</li><li class="listitem">Ahead-of-time (AOT) compilation</li><li class="listitem">Common memory pitfalls with Xamarin</li></ul></div><p class="calibre8">Before we begin this chapter, it is important to note that an iOS Developer Program membership is required to deploy to iOS devices. Feel free to go back to <a class="calibre1" title="Chapter 1. Setting Up Xamarin" href="part0014_split_000.html#page">Chapter 1</a>, <em class="calibre12">Setting Up Xamarin</em>, to walk through this process.</p></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_1"><a id="ch07lvl1sec50" class="calibre1"/>iOS provisioning</h1></div></div></div><p class="calibre8">Apple has a<a id="id428" class="calibre1"/> strict process for deploying applications to iOS devices. While being quite convoluted and sometimes painful for developers, Apple can enable a certain level of security by preventing the average user from side loading potentially malicious applications.</p></div></div>

<div><div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec28" class="calibre1"/>Prerequisites for deploying to iOS </h2></div></div></div><p class="calibre8">Before we can deploy our <a id="id429" class="calibre1"/>application to an iOS device, there are a few things we will need to set up in the<a id="id430" class="calibre1"/> <strong class="calibre2">iOS Dev Center</strong>. We will begin by creating an App ID or a bundle ID for your account. This is the primary identifier for any iOS application.</p><p class="calibre8">We will begin by <a id="id431" class="calibre1"/>navigating to <a class="calibre1" href="http://developer.apple.com">http://developer.apple.com</a> and performing the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Click on the <strong class="calibre2">iOS Apps</strong> icon.</li><li class="listitem" value="2">Sign in with your developer account.</li><li class="listitem" value="3">Click on <strong class="calibre2">Certificates, Identifiers, &amp; Profiles</strong> on the right-hand side navigation.</li><li class="listitem" value="4">Click on <strong class="calibre2">Identifiers</strong>.</li><li class="listitem" value="5">Click on the plus button to add a new iOS App ID.</li><li class="listitem" value="6">In the <strong class="calibre2">Name</strong> field, enter something meaningful such as <code class="literal">YourCompanyNameWildcard</code>.</li><li class="listitem" value="7">Select the <strong class="calibre2">Wildcard App ID</strong> radio button.</li><li class="listitem" value="8">In the <strong class="calibre2">Bundle ID</strong> field, select a reverse domain styled name for your company such as <code class="literal">com.yourcompanyname.*</code>.</li><li class="listitem" value="9">Click on <strong class="calibre2">Continue</strong>.</li><li class="listitem" value="10">Review the final setting and hit <strong class="calibre2">Submit</strong>.</li></ol><div></div><p class="calibre8">Leave this web page open, as we will be using it throughout the chapter.</p><p class="calibre8">We just registered a wildcard bundle ID for your account; use this as a prefix for all future applications you wish to identify with this account. Later, when you are preparing to deploy an app to the Apple App Store, you will create an <strong class="calibre2">Explicit App ID</strong> such as <code class="literal">com.yourcompanyname.yourapp</code>. This allows you to deploy the specific app to the store, while the wildcard ID is best used for deploying to devices for testing.</p><p class="calibre8">Next, we need to locate the unique identifier on each device you plan on debugging your application on. Apple requires each device to be registered under your account with a limit of 200 devices per developer. The only way to circumvent this requirement is to register for the iOS Developer Enterprise program with a $299 yearly fee that is separate from the standard $99 developer fee.</p><p class="calibre8">We will begin by launching Xcode and performing the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Navigate to <strong class="calibre2">Window</strong> | <strong class="calibre2">Devices</strong> in the top menu.</li><li class="listitem" value="2">Plug in your target device with a USB cable.</li><li class="listitem" value="3">On the left-hand side navigation, you should see your device's name. Click on it to select it.</li><li class="listitem" value="4">Notice the <strong class="calibre2">Identifier</strong> value for your device. Copy it to your clipboard.</li></ol><div></div><p class="calibre8">The following <a id="id432" class="calibre1"/>screenshot shows what your screen should look like with your device selected in Xcode:</p><div><img src="img/00053.jpeg" alt="Prerequisites for deploying to iOS" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">Return to<a id="id433" class="calibre1"/> <a class="calibre1" href="http://developer.apple.com">http://developer.apple.com</a> (hopefully, it is still open from earlier in the chapter) and perform the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Navigate to <strong class="calibre2">Devices</strong> | <strong class="calibre2">All</strong> on the left-hand side navigation.</li><li class="listitem" value="2">Click on the plus button in the top-right corner of the page.</li><li class="listitem" value="3">Enter a meaningful name for your device and paste the <strong class="calibre2">Identifier</strong> value from your clipboard into the <strong class="calibre2">UDID</strong> field.</li><li class="listitem" value="4">Click on <strong class="calibre2">Continue</strong>.</li><li class="listitem" value="5">Review the information you entered and hit <strong class="calibre2">Register</strong>.</li></ol><div></div><p class="calibre8">Down the road, when your account is fully set up, you can just click on the <strong class="calibre2">Use for Development</strong> button in Xcode and skip the second set of steps.</p><p class="calibre8">The following screenshot shows you what your device list should look like when complete:</p><div><img src="img/00054.jpeg" alt="Prerequisites for deploying to iOS" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">Next, we will need to generate a certificate to represent you as the developer for your account. Prior to<a id="id434" class="calibre1"/> Xcode 5, you had to create a certificate signing request using the<a id="id435" class="calibre1"/> <strong class="calibre2">Keychain</strong> app on your Mac. You can find this under <code class="literal">Applications</code>, or using the search spotlight on OS X via <em class="calibre12">Command</em> + <em class="calibre12">Space</em>. The newer versions of Xcode make things a lot easier by integrating a lot of this process into Xcode.</p><p class="calibre8">Open Xcode and perform the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Navigate to <strong class="calibre2">Xcode</strong> | <strong class="calibre2">Preferences</strong> in the menu at the top.</li><li class="listitem" value="2">Select the <strong class="calibre2">Accounts</strong> tab.</li><li class="listitem" value="3">Click on the plus button, on the bottom-left, and then click on <strong class="calibre2">Add Apple ID</strong>.</li><li class="listitem" value="4">Enter the e-mail and password for your developer account.</li><li class="listitem" value="5">On creating the account, click on <strong class="calibre2">View Details</strong> on the bottom-right.</li><li class="listitem" value="6">Click on the <strong class="calibre2">sync</strong> button on the bottom-left.</li><li class="listitem" value="7">If this is a new account, Xcode will display a warning that no certificates exist yet. Check each box and click on <strong class="calibre2">Request</strong> to generate the certificates.</li></ol><div></div><p class="calibre8">Xcode will now automatically create a developer certificate for your account and install it into your Mac's keychain.</p><p class="calibre8">The following screenshot shows what your screen will look after setting up your account:</p><div><img src="img/00055.jpeg" alt="Prerequisites for deploying to iOS" class="calibre9"/></div><p class="calibre10"> </p></div></div></div>

<div><div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec29" class="calibre1"/>Creating a provisioning profile</h2></div></div></div><p class="calibre8">Next, we need to create a <strong class="calibre2">provisioning profile</strong>. This is the final file that allows applications to <a id="id436" class="calibre1"/>be installed on an iOS device. A provisioning profile contains an App ID, a list of device IDs, and finally, a certificate for the developer. You<a id="id437" class="calibre1"/> must also have the private key of the developer certificate in your Mac's keychain to use a provisioning profile.</p><p class="calibre8">The following are a<a id="id438" class="calibre1"/> few types of provisioning profiles:</p><div><ul class="itemizedlist"><li class="listitem"><strong class="calibre2">Development</strong>: This<a id="id439" class="calibre1"/> is used for debug or release builds. You will actively use this type of profile when your applications are in development.</li><li class="listitem"><strong class="calibre2">Ad Hoc</strong>: This is used mainly for release builds. This type of certificate is great for beta testing or <a id="id440" class="calibre1"/>distribution to a small set of users. You can distribute to an unlimited number of users using this method with an enterprise developer account.</li><li class="listitem"><strong class="calibre2">App Store</strong>: This is used<a id="id441" class="calibre1"/> for release builds for submission to the App Store. You cannot deploy an app to your device using this certificate; it can only be used for store submission.</li></ul></div><p class="calibre8">Let's return to <a class="calibre1" href="http://developer.apple.com">http://developer.apple.com</a> and create a new provisioning profile by performing the<a id="id442" class="calibre1"/> following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Navigate to <strong class="calibre2">Provisioning Profiles</strong> | <strong class="calibre2">All</strong> on the left-hand side pane.</li><li class="listitem" value="2">Click on the plus button at the top-right of the page.</li><li class="listitem" value="3">Select <strong class="calibre2">iOS App Development</strong> and click on <strong class="calibre2">Continue</strong>.</li><li class="listitem" value="4">Select your wildcard App ID created earlier in the chapter and click on <strong class="calibre2">Continue</strong>.</li><li class="listitem" value="5">Select the certificate we created earlier in the chapter and click on <strong class="calibre2">Continue</strong>.</li><li class="listitem" value="6">Select the devices you want to deploy to and click on <strong class="calibre2">Continue</strong>.</li><li class="listitem" value="7">Enter an appropriate <strong class="calibre2">Profile Name</strong> such as <code class="literal">YourCompanyDev</code>.</li><li class="listitem" value="8">Click on <strong class="calibre2">Generate</strong> and your provisioning profile will be created.</li></ol><div></div><p class="calibre8">The following screenshot shows the new profile that you will end up with on creation. Don't worry about downloading the file; we'll use Xcode to import the final profile.</p><div><img src="img/00056.jpeg" alt="Creating a provisioning profile" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">To import the <a id="id443" class="calibre1"/>provisioning profile, return to Xcode and perform the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Navigate to <strong class="calibre2">Xcode</strong> | <strong class="calibre2">Preferences</strong> in the menu at the top of the dialog.</li><li class="listitem" value="2">Select the <strong class="calibre2">Accounts</strong> tab.</li><li class="listitem" value="3">Select your account and click on <strong class="calibre2">View Details</strong>.</li><li class="listitem" value="4">Click on the <strong class="calibre2">sync</strong> button on the bottom-left.</li><li class="listitem" value="5">After a few seconds, your provisioning profiles will appear.</li></ol><div></div><p class="calibre8">Xcode will automatically include any provisioning profiles you have created on the Apple developer site. Xcode will also create a few profiles on its own.</p><p class="calibre8">In the latest version of Xamarin Studio, you can view these profiles but will not be able to sync them. Navigate to <strong class="calibre2">Xamarin Studio</strong> | <strong class="calibre2">Preferences</strong> | <strong class="calibre2">Developer Accounts</strong> to view the provisioning profiles from Xamarin Studio. You can also view Xamarin's documentation on iOS provisioning on<a id="id444" class="calibre1"/> their documentation website at <a class="calibre1" href="http://docs.xamarin.com/guides/ios/getting_started/device_provisioning/">http://docs.xamarin.com/guides/ios/getting_started/device_provisioning/</a>.</p></div></div></div>
<div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec51" class="calibre1"/>Android device settings</h1></div></div></div><p class="calibre8">Compared to the hassle of deploying your application on iOS devices, Android is a breeze. To deploy an application to a device, you merely have to set a few settings on the device. This is due to Android's openness in comparison to iOS. Android device debugging is turned off for most users, but it can be easily turned on by any developer who might wish to<a id="id445" class="calibre1"/> have a go at writing Android applications.</p><p class="calibre8">We will begin by opening the <strong class="calibre2">Settings</strong> application. You might have to locate this by looking through all the applications on the device as follows:</p><div><ol class="orderedlist"><li class="listitem" value="1">Scroll down and click on the section labeled <strong class="calibre2">Developer options</strong>.</li><li class="listitem" value="2">In the action bar at the top, you might have to toggle a switch to the <strong class="calibre2">ON</strong> position. This varies on each device.</li><li class="listitem" value="3">Scroll down and check <strong class="calibre2">USB Debugging</strong>.</li><li class="listitem" value="4">A warning confirmation message will appear. Then, click on <strong class="calibre2">OK</strong>.</li></ol><div></div><div><h3 class="title2"><a id="tip10" class="calibre1"/>Tip</h3><p class="calibre8">Note that some newer Android devices have made it a little more difficult for the average user to turn on USB debugging. You have to click on the <strong class="calibre2">Developer options</strong> item seven times to turn this option on.</p></div><p class="calibre8">The following screenshot shows what your device will look like during the process:</p><div><img src="img/00057.jpeg" alt="Android device settings" class="calibre9"/></div><p class="calibre10"> </p><p class="calibre8">After enabling this option, all you have to do is plug in your device via USB and debug an Android application in Xamarin Studio. You will see your device listed in the <strong class="calibre2">Select Device</strong> dialog. Note that if you are on Windows or have a nonstandard device, you might have to visit <a id="id446" class="calibre1"/>your device vendor's website to install drivers. Most Samsung and Nexus devices install their drivers automatically. On Android 4.3 and higher, there is also a confirmation dialog on the device that appears before beginning a USB debugging session.</p><p class="calibre8">The following screenshot shows you what your device will look like for a Samsung Galaxy SII in the <strong class="calibre2">Select Device</strong> dialog. Xamarin Studio will display the model number, which is not always a name that you can recognize. You can view this model number in your device's settings.</p><div><img src="img/00058.jpeg" alt="Android device settings" class="calibre9"/></div><p class="calibre10"> </p></div>
<div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec52" class="calibre1"/>Understanding the linker</h1></div></div></div><p class="calibre8">To keep Xamarin applications small and lightweight for mobile devices, Xamarin has created a feature for their <a id="id447" class="calibre1"/>compiler called the <strong class="calibre2">linker</strong>. Its main purpose is to strip unused code out of the core Mono assemblies (such as <code class="literal">System.dll</code>) and platform-specific assemblies (such as <code class="literal">Mono.Android.dll</code> and <code class="literal">monotouch.dll</code>). However, it can also give you the same benefits if it is set up to run on your own assemblies. Without running the linker, the entire Mono framework can be around 30 megabytes. This is why linking is enabled by default in device builds, which enables you to keep your applications small.</p><p class="calibre8">The linker uses static analysis to work through the various code paths in an assembly. If it determines a method or class that is never used, it removes the unused code from that assembly. This can be a time-consuming process, so builds running in the simulator skip this step by default.</p><p class="calibre8">Xamarin applications have the following three main settings for the linker:</p><div><ul class="itemizedlist"><li class="listitem"><strong class="calibre2">Don't Link</strong>: In this setting, the linker compilation step is skipped. This is best used for builds running in the simulator or if you need to diagnose a potential issue with the linker.</li><li class="listitem"><strong class="calibre2">Link SDK Assemblies Only</strong>: In this setting, the linker will only be run on the core Mono assemblies such as <code class="literal">System.dll</code>, <code class="literal">System.Core.dll</code>, and <code class="literal">System.Xml.dll</code>.</li><li class="listitem"><strong class="calibre2">Link All Assemblies</strong>: In this setting, the linker is run against all the assemblies in your application, which include any class libraries or third-party assemblies you are using.</li></ul></div><p class="calibre8">These settings can be found in the <strong class="calibre2">Project</strong> options of any Xamarin.iOS or Xamarin.Android application. These settings are generally not present on class libraries, as it is generally associated with an iOS or Android application that will be deployed.</p><p class="calibre8">The linker can also <a id="id448" class="calibre1"/>cause potential issues at runtime as there are cases in which its analysis determines incorrectly that a piece of code is unused. This can happen if you are using features in the <code class="literal">System.Reflection</code> namespace instead of accessing the method or property directly. This is one reason why it is important for you to test your application on physical devices, as linking is enabled for device builds.</p><p class="calibre8">To demonstrate this issue, let's take a look at the following code example:</p><div><pre class="programlisting">//Just a simple class for holding info
public class Person
{
  public int Id { get; set; }
  public string Name { get; set; }
}

//Then somewhere later in your code
var person = new Person { Id = 1, Name = "Chuck Norris" };
var propInfo = person.GetType().GetProperty("Name");
string value = propInfo.GetValue(person) as string;
Console.WriteLine("Name: " + value);</pre></div><p class="calibre8">Running the preceding code will work fine using the options for <strong class="calibre2">Don't Link</strong> or <strong class="calibre2">Link SDK Assemblies Only</strong>. However, if you try to run this, when using <strong class="calibre2">Link All Assemblies</strong>, you will get an exception similar to the following:</p><div><pre class="programlisting">Unhandled Exception:
System.ArgumentException: Get Method not found for 'Name' at System.Reflection.MonoProperty.GetValue (System.Object obj, BindingFlags invokeAttr, System.Reflection.Binder binder, System.Object[] index, System.Globalization.CultureInfo culture) at System.Reflection.PropertyInfo.GetValue (System.Object obj)</pre></div><p class="calibre8">Since the <code class="literal">Name</code> property's getter was never used directly from code, the linker stripped it from the assembly. This caused the reflection code to fail at runtime.</p><p class="calibre8">Even though potential issues can arise in your code, the option of <strong class="calibre2">Link All Assemblies</strong> is still quite useful. There are a few optimizations that can only be performed in this mode, and Xamarin can reduce your application to the smallest possible size. If performance or a tiny download size is the requirement for your application, you can try this option. However, thorough testing should be performed to verify that no problems are caused by linking your assemblies.</p><p class="calibre8">To resolve issues in your code, Xamarin<a id="id449" class="calibre1"/> has included a complete set of workarounds to prevent specific parts of your code from being stripped away.</p><p class="calibre8">Some of the options include<a id="id450" class="calibre1"/> the following:</p><div><ul class="itemizedlist"><li class="listitem">Mark class members with <code class="literal">[Preserve]</code>. This will force the linker to include the attributed method, field, or property.</li><li class="listitem">Mark an entire class with <code class="literal">[Preserve(AllMembers=true)]</code>. This will preserve all code within the class.</li><li class="listitem">Mark an entire assembly with <code class="literal">[assembly: Preserve]</code>. This is an assembly-level attribute that will preserve all code contained within it.</li><li class="listitem">Skip an entire assembly by modifying <strong class="calibre2">Additional mtouch arguments</strong> in your project options. Use <code class="literal">--linkskip=System</code> to skip an entire assembly. This can be used on assemblies that you do not have the source code for.</li><li class="listitem">Custom linking via an XML file. This is the best option to use when you need to skip linking on a specific class or method that you do not have the source code for. Use <code class="literal">–-xml=YourFile.xml</code> in <strong class="calibre2">Additional mtouch arguments</strong>.</li></ul></div><p class="calibre8">The following is a sample XML file that demonstrates custom linking:</p><div><pre class="programlisting">&lt;linker&gt;
  &lt;assembly fullname="mscorlib"&gt;
    &lt;type fullname="System.Environment"&gt;
      &lt;field name="mono_corlib_version" /&gt;
        &lt;method name="get_StackTrace" /&gt; 
    &lt;/type&gt;
  &lt;/assembly&gt;
  &lt;assembly fullname="My.Assembly.Name"&gt;
    &lt;type fullname="MyTypeA" preserve="fields" /&gt;
       &lt;method name=".ctor" /&gt;
    &lt;/type&gt;
    &lt;type fullname="MyTypeB" /&gt;                         
      &lt;method signature="System.Void MyFunc(System.Int32 x)" /&gt;
        &lt;field signature="System.String _myField" /&gt;
    &lt;/type&gt;
  &lt;/assembly&gt;
&lt;/linker&gt;</pre></div><p class="calibre8">Custom linking is<a id="id451" class="calibre1"/> the most complicated option and is usually the last resort. Luckily, most Xamarin applications will not have to work around many linker issues.</p></div>
<div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec53" class="calibre1"/>Understanding AOT compilation</h1></div></div></div><p class="calibre8">The runtime behind Mono and .NET on Windows is based on a<a id="id452" class="calibre1"/> <strong class="calibre2">just in time</strong> (<strong class="calibre2">JIT</strong>) compiler. C# and other .NET languages are compiled into<a id="id453" class="calibre1"/> <strong class="calibre2">Microsoft Intermediate Language</strong> (<strong class="calibre2">MSIL</strong>). At runtime, MSIL is compiled into a native code to run on whatever type of architecture is running your application. Xamarin.Android follows this exact pattern. However, due to Apple's restrictions on dynamically generated code, a JIT compiler is not allowed on iOS.</p><p class="calibre8">To work around this restriction, Xamarin has developed a new option called <strong class="calibre2">Ahead-of-time</strong> (<strong class="calibre2">AOT</strong>) compilation. In addition to making .NET possible on iOS, AOT has other benefits such as a shorter<a id="id454" class="calibre1"/> startup time and potentially better performance.</p><p class="calibre8">AOT also has some limitations that are generally related to C# generics. To compile an assembly ahead of time, the compiler will need to run some static analysis against your code to determine the type of information. Generics throw a wrench into this situation.</p><p class="calibre8">There are a few cases that are not supported by AOT, but they are completely valid in C#. The first is a generic interface, which is as follows:</p><div><pre class="programlisting">interface MyInterface&lt;T&gt; 
{
  T GetMyValue();
}</pre></div><p class="calibre8">The compiler cannot determine the classes that can implement this interface ahead of time, especially when multiple assemblies are involved. The second limitation is related to the first. You cannot override virtual methods that contain generic parameters or return values.</p><p class="calibre8">The following is a simple example:</p><div><pre class="programlisting">class MyClass&lt;T&gt;
{
  public virtual T GetMyValue() 
  {
    //Some code here
  }
}

class MySubClass : MyClass&lt;int&gt;
{
  public override int GetMyValue()
  {
    //Some code here
  }
}</pre></div><p class="calibre8">Again, the static analysis of the compiler cannot determine which classes can override this method at compile time.</p><p class="calibre8">Another limitation is<a id="id455" class="calibre1"/> that you cannot use <code class="literal">DllImport</code> in a generic class, as shown in the following code:</p><div><pre class="programlisting">class MyGeneric&lt;T&gt;
{
  [DllImport('MyImport")]
  public static void MyImport();
}</pre></div><p class="calibre8">If you are not familiar with the language feature, <code class="literal">DllImport</code> is a way to call native C/C++ methods from C#. Using them inside generic classes is not supported.</p><p class="calibre8">These limitations are another good reason why testing on devices is important since the preceding code will work fine on other platforms that can run C# code but not Xamarin.iOS.</p></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec54" class="calibre1"/>Avoiding common memory pitfalls</h1></div></div></div><p class="calibre8">Memory on mobile <a id="id456" class="calibre1"/>devices is certainly not an unlimited commodity. Because of this, memory usage in your application can be much more important than on desktop applications. At times, you might find the need to use a memory profiler, or improve your code to use memory more efficiently.</p><p class="calibre8">The following<a id="id457" class="calibre1"/> are the most common memory pitfalls:</p><div><ul class="itemizedlist"><li class="listitem">The <strong class="calibre2">garbage collector</strong> (<strong class="calibre2">GC</strong>) is unable to collect large objects fast enough to keep up with your application</li><li class="listitem">Your code inadvertently causes a memory leak</li><li class="listitem">A C# object is garbage collected but is later attempted to be used by native code</li></ul></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec30" class="calibre1"/>Garbage collector</h2></div></div></div><p class="calibre8">Let's take a look at the first<a id="id458" class="calibre1"/> problem where the GC cannot keep up. Let's say we have a Xamarin.iOS application with a button for sharing an<a id="id459" class="calibre1"/> image on Twitter as follows:</p><div><pre class="programlisting">twitterShare.TouchUpInside += (sender, e) =&gt;
{
  var image = UImage.FromFile("YourLargeImage.png");
  //Share to Twitter
};</pre></div><p class="calibre8">Now let's assume the image is a 10 MB image from the user's camera roll. If the user clicks on the button and cancels the Twitter post rapidly, there could be a possibility of your application running out of memory. iOS will commonly force close apps using too much memory, and you don't want users to experience this with your app.</p><p class="calibre8">The best solution is to call <code class="literal">Dispose</code> on the image when you are finished with it as follows:</p><div><pre class="programlisting">var image = UImage.FromFile('YourLargeImage.png");
//Share to Twitter
image.Dispose();</pre></div><p class="calibre8">An even better approach would be to take advantage of the C# <code class="literal">using</code> statement as follows:</p><div><pre class="programlisting">using(var image = UImage.FromFile('YourLargeImage.png"))
{
  //Share to Twitter
}</pre></div><p class="calibre8">The C# <code class="literal">using</code> statement will automatically call <code class="literal">Dispose</code> in a <code class="literal">try-finally</code> block, so the object will get disposed even if an exception is thrown. I recommend that you take advantage of the <code class="literal">using</code> statement for any <code class="literal">IDisposable</code> class where possible. It is not always necessary for small objects such as <code class="literal">NSString</code>, but is always a good idea for larger, more<a id="id460" class="calibre1"/> heavyweight <code class="literal">UIKit</code> objects.</p><div><h3 class="title2"><a id="tip11" class="calibre1"/>Tip</h3><p class="calibre8">A similar situation can occur on Android with the <code class="literal">Bitmap</code> class. Although slightly different, it is best to call both the <code class="literal">Dispose</code> and <code class="literal">Recycle</code> methods on this class along with using the <code class="literal">BitmapFactory.Options</code> settings for <code class="literal">InPurgeable</code> and <code class="literal">InInputShareable</code>.</p></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec31" class="calibre1"/>Memory leaks</h2></div></div></div><p class="calibre8">Memory leaks are<a id="id461" class="calibre1"/> the next potential issues. C# being a managed, garbage-collected language prevents a lot of memory leaks, but not all of them. The most <a id="id462" class="calibre1"/>common leaks in C# are caused by events.</p><p class="calibre8">Let's assume that we have a static class with an event as follows:</p><div><pre class="programlisting">static class MyStatic
{
  public static event EventHandler MyEvent;
}</pre></div><p class="calibre8">Now, let's say we need to subscribe to the event from an iOS controller as follows:</p><div><pre class="programlisting">public override void ViewDidLoad()
{
  base.ViewDidLoad();

  MyStatic.MyEvent += (sender, e) =&gt;
  {
    //Do something
  };
}</pre></div><p class="calibre8">The problem here is that the static class will hold a reference to the controller until the event is unsubscribed. This is a situation that a lot of developers might miss. To fix this issue on iOS, I would subscribe to the event in <code class="literal">ViewWillAppear</code> and unsubscribe <code class="literal">ViewWillDisappear</code>. On Android, use <code class="literal">OnStart</code> and <code class="literal">OnStop</code>, or <code class="literal">OnPause</code> and <code class="literal">OnResume</code>.</p><p class="calibre8">You would correctly implement this event as follows:</p><div><pre class="programlisting">public override void ViewWillAppear()
{
  base.ViewWillAppear();
  MyStatic.MyEvent += OnMyEvent;
}

public override void ViewWillDisappear()
{
  base.ViewWillDisappear ();
  MyStatic.MyEvent -= OnMyEvent;
}</pre></div><p class="calibre8">However, an event is not a surefire cause of a memory leak. Subscribing to the <code class="literal">TouchUpInside</code> event on<a id="id463" class="calibre1"/> a button inside the <code class="literal">ViewDidLoad</code> method, for example, is just fine. Since the button lives in memory just as long as the controller does, everything can get garbage collected without any problems.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec32" class="calibre1"/>Accessing objects disposed by GC</h2></div></div></div><p class="calibre8">For the final issue, the<a id="id464" class="calibre1"/> garbage collector can sometimes<a id="id465" class="calibre1"/> remove a C# object. Later, an Objective-C object attempts to access it.</p><p class="calibre8">The following is an example to add a button to <code class="literal">UITableViewCell</code>:</p><div><pre class="programlisting">public override UITableViewCell GetCell(UITableView tableView, NSIndexPath indexPath)
{
  var cell = tableView.DequeueReusableCell('MyCell");
  //Remaining cell setup here

  var button = UIButton.FromType(UIButtonType.InfoDark);
  button.TouchUpInside += (sender, e) =&gt;
  {
    //Do something
  };
  cell.AccessoryView = button;
  return cell;
}</pre></div><p class="calibre8">We add the built-in info button as an accessory view to the cell. The problem here is that the button will get garbage collected, but its Objective-C counterpart will remain in use as it is displayed on the screen. If you click on the button after some period of time, you will get a crash that <a id="id466" class="calibre1"/>looks something similar to the following:</p><div><pre class="programlisting">mono-rt: Stacktrace:
mono-rt:   at &lt;unknown&gt;
mono-rt:   at (wrapper managed-to-native) MonoTouch.UIKit.UIApplication.UIApplicationMain (int,string[],intptr,intptr) 
mono-rt:   at MonoTouch.UIKit.UIApplication.Main (string[],string,string)  
... Continued ...
=================================================================
Got a SIGSEGV while executing native code. This usually indicates
a fatal error in the mono runtime or one of the native libraries 
used by your application.
================================================================</pre></div><p class="calibre8">It is not the most descriptive error message, but in general, you know that something went wrong in the native Objective-C code. To resolve the issue, create a custom subclass of <code class="literal">UITableViewCell</code>, and create a dedicated member variable for the button as follows:</p><div><pre class="programlisting">public class MyCell : UITableViewCell
{
  UIButton button;
  public MyCell()
  {
    button = UIButton.FromType(UIButtonType.InfoDark);
    button.TouchUpInside += (sender, e) =&gt; 
    {
      //Do something
    };
    AccessoryView = button;
  }
}</pre></div><p class="calibre8">Now, your <code class="literal">GetCell</code> implementation will look something like the following code:</p><div><pre class="programlisting">public override UITableViewCell GetCell(UITableView tableView, NSIndexPath indexPath)
{
  var cell = tableView.DequeueReusableCell('MyCell") as MyCell;
  //Remaining cell setup here
  return cell;
}</pre></div><p class="calibre8">Since the button is not a local variable, it will no longer get garbage collected sooner than needed. A crash is avoided, and in some ways this code is a bit cleaner. Similar situations can happen on Android<a id="id467" class="calibre1"/> with the interaction between C# and Java; however, it is less likely since both are garbage collected languages.</p></div></div>
<div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec55" class="calibre1"/>Summary</h1></div></div></div><p class="calibre8">In this chapter, we started out learning the process of setting up iOS provision profiles to deploy to iOS devices. Next, we looked at the required device settings for deploying your application to an Android device. We discovered the Xamarin linker and how it can make your applications smaller and more performance-oriented. We went through the various settings to resolve problems caused by your code and the linker, and we explained AOT compilation on iOS and the limitations that occur. Finally, we covered the most common memory pitfalls that can occur with Xamarin applications.</p><p class="calibre8">Testing your Xamarin application on mobile devices is important for various reasons. Some bugs are only displayed on the device due to the platform limitations that Xamarin has to work around. Your PC is much more powerful, so you will see different performances using the simulator rather than on a physical device. In the next chapter, we'll create a real web service using Windows Azure to drive our XamChat application. We will use a feature called Azure Mobile Services and implement push notifications on iOS and Android.</p></div></body></html>