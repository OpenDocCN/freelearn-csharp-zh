<html><head></head><body>
		<div><h1 id="_idParaDest-92"><em class="italic"><a id="_idTextAnchor163"/>Chapter 11</em>: Configuring Identity Management</h1>
			<p>In the last chapter, we learned about how to add and customize the ASP.NET Core Identity UI to enable users to register, log in, and manage their profiles. Unfortunately, ASP.NET Core Identity doesn't provide identity management by default.</p>
			<p>In this chapter, we are going to learn about how to manage ASP.NET Core Identity by using IdentityManager2 to create users and roles for your application.</p>
			<p>We'll cover the following sections:</p>
			<ul>
				<li>Introducing IdentityManager2</li>
				<li>Setting up IdentityManager2</li>
			</ul>
			<p>The topics of this chapter relate to the MVC layer of the ASP.NET Core architecture:</p>
			<div><div><img src="img/Figure_11.1_B17996.jpg" alt="Figure 11.1 – ASP.NET Core architecture"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.1 – ASP.NET Core architecture</p>
			<h1 id="_idParaDest-93"><a id="_idTextAnchor164"/>Technical requirements</h1>
			<p>To follow the examples in this chapter, you will need to create an ASP.NET Core MVC application. Open your console, shell, or Bash terminal, and change to your working directory. Use the following command to create a new MVC application:</p>
			<pre>dotnet new mvc -n IdentityManagementSample -o IdentityManagementSample --auth Individual</pre>
			<p>Now, open the project in Visual Studio by double-clicking the project file, or in VS Code by typing the following command in the already open console:</p>
			<pre>cd IdentityManagementSample
code .</pre>
			<p>All of the code samples of this chapter can be found in the GitHub repo for this book: <a href="https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter11">https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter11</a>.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">This chapter expects you to have completed the steps in the last chapter. As an alternative, you can reuse the project from the last chapter and might just need to adjust the project names.</p>
			<h1 id="_idParaDest-94"><a id="_idTextAnchor165"/>Introducing IdentityManager2</h1>
			<p>IdentityManager is a project <a id="_idIndexMarker166"/>that was initially created and owned by Brock Allen who also created IdentityServer together with Dominick Baier. Scott Brady (<a href="https://www.scottbrady91.com/aspnet-identity">https://www.scottbrady91.com/aspnet-identity</a>) and his employer took over the project, ported it to ASP.NET Core, and released it as IdentityManager2 (<a href="https://brockallen.com/2018/07/09/identitymanager2/">https://brockallen.com/2018/07/09/identitymanager2/</a>). </p>
			<p>It is provided via NuGet (<a href="https://www.nuget.org/packages/identitymanager2">https://www.nuget.org/packages/identitymanager2</a>).</p>
			<h1 id="_idParaDest-95"><a id="_idTextAnchor166"/>Setting up IdentityManager2</h1>
			<p>The first step is to <a id="_idIndexMarker167"/>load the package. Use the already open command line or the terminals in VS Code or Visual Studio:</p>
			<pre>dotnet add package IdentityManager2</pre>
			<p>If the package is loaded, open <code>Program.cs</code> and add IdentityManager2 to the service collection:</p>
			<pre>builder.Services.AddIdentityManager();</pre>
			<p>Change the service registration of ASP.NET Identity from the following:</p>
			<pre>builder.Services.AddDefaultIdentity&lt;ApplicationUser&gt;{ …</pre>
			<p>To this: </p>
			<pre>builder.Services.AddIdentity&lt;ApplicationUser, IdentityRole&gt;( …</pre>
			<p>This adds some more relevant services to the service collection.</p>
			<p>Also, <code>DefaultTokenProvider</code> needs to be added:</p>
			<pre>builder.Services.AddIdentity&lt;ApplicationUser, IdentityRole&gt;( … )
    .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;()
    .AddDefaultTokenProviders();</pre>
			<p>That's it <a id="_idIndexMarker168"/>with the services for now. </p>
			<p>Then <code>IdentityServer</code> needs to be added to the pipeline. Add it after the authentications and authorization middleware:</p>
			<pre>app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();
app.UseIdentityManager();
app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Home}/{action=Index}/{id?}");
app.MapRazorPages();</pre>
			<p>Now we need to connect IdentityManager2 with the database connection that is already configured with ASP.NET Identity. </p>
			<p>This needs the following package to be installed:</p>
			<pre>dotnet add package IdentityManager2.AspNetIdentity</pre>
			<p>Now you can <a id="_idIndexMarker169"/>connect IdentityManager2 with the already existing <code>ApplicationDbContext</code> that is <code>IdentityDbContext</code>, which handles <code>IdentityUsers</code> and <code>IdentityRoles</code>. Don't forget to add a <code>using</code> to <code>IdentityManager2.AspNetIdentity</code>. In the code, the already existing <code>ApplicationUser</code> needs to be used:</p>
			<pre>builder.Services.AddIdentityManager()
    .AddIdentityMangerService&lt;
AspNetCoreIdentityManagerService&lt;ApplicationUser, 
string, IdentityRole, string&gt;&gt;();</pre>
			<p>That's it to run <code>IdentityManager</code>. Type <code>dotnet watch</code> in Command Prompt to start the application or press <em class="italic">F5</em> in VS Code or VS. If you now call the application in the browser, you will see the UI to manage the data:</p>
			<div><div><img src="img/Figure_11.2_B17996.jpg" alt="Figure 11.2 ‒ IdentityManager2"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.2 ‒ IdentityManager2</p>
			<p>Now you can create roles and users:</p>
			<ol>
				<li>Create an <strong class="bold">Admin</strong> role and a <strong class="bold">User</strong> role. After that, create a User role for yourself. </li>
				<li>After the User role is <a id="_idIndexMarker170"/>created, go to <strong class="bold">All Users</strong> and edit the newly created user. Here, you can change the user properties and assign both roles to them:</li>
			</ol>
			<div><div><img src="img/Figure_11.3_B17996.jpg" alt="Figure 11.3 ‒ Editing the roles"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.3 ‒ Editing the roles</p>
			<p>By using IdentityManager, you get a <a id="_idIndexMarker171"/>complete tool to manage your users and roles. It also works with custom users and custom user properties. </p>
			<h1 id="_idParaDest-96"><a id="_idTextAnchor167"/>Securing IdentityManager2</h1>
			<p>I'm sure you recognized <a id="_idIndexMarker172"/>that IdentityManager2 was accessible without a login. This is by design. You need to restrict access to it.</p>
			<p>Scott Brady described a way to use IdentityServer to do that (<a href="https://www.scottbrady91.com/aspnet-identity/getting-started-with-identitymanager2">https://www.scottbrady91.com/aspnet-identity/getting-started-with-identitymanager2</a>). We would also propose doing it that way. Setting up IdentityServer isn't that straightforward and isn't covered in this book. Unfortunately, it is not possible to use the default ASP.NET Core individual authentication to protect IdentityManager2. It seems the middleware that creates the IdentityManager2 UI doesn't support individual authentication and redirects to the ASP.NET Core Identity UI.</p>
			<p>It would make sense <a id="_idIndexMarker173"/>to create a separate ASP.NET Core application that hosts IdentityManager2. This way, this kind of administrative UI would be completely separated from the publicly available application, and you would be able to use either OAuth or Azure Active Directory authentication to protect the applicati<a id="_idTextAnchor168"/><a id="_idTextAnchor169"/><a id="_idTextAnchor170"/>on. </p>
			<h1 id="_idParaDest-97"><a id="_idTextAnchor171"/>Summary</h1>
			<p>In this chapter, you learned how to add a user interface to manage the users and roles of your application. IdentityManager2 is the best and most complete solution to manage your identities.</p>
			<p>In the next chapter, you will learn how to use content negotiation to create different kinds of outputs with only a single HTTP endpoint.</p>
		</div>
	</body></html>