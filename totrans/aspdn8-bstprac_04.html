<html><head></head><body>
<div id="_idContainer030">
<h1 class="chapter-number" id="_idParaDest-84"><a id="_idTextAnchor086"/><span class="koboSpan" id="kobo.1.1">4</span></h1>
<h1 id="_idParaDest-85"><a id="_idTextAnchor087"/><span class="koboSpan" id="kobo.2.1">Applying Security from the Start</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Next to performance, security</span><a id="_idIndexMarker157"/><span class="koboSpan" id="kobo.4.1"> should always be a top priority when building web applications. </span><span class="koboSpan" id="kobo.4.2">The ability to create secure web applications continues to be a problem with the evolving landscape of internet </span><a id="_idIndexMarker158"/><span class="koboSpan" id="kobo.5.1">threats such as </span><strong class="bold"><span class="koboSpan" id="kobo.6.1">cross-site scripting</span></strong><span class="koboSpan" id="kobo.7.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.8.1">XSS</span></strong><span class="koboSpan" id="kobo.9.1">) and injection techniques. </span><span class="koboSpan" id="kobo.9.2">While the best developer can safeguard an application against even the worst threat, most attacks succeed through human interaction and environmental issues. </span><span class="koboSpan" id="kobo.9.3">The best approach for developers to protect their applications is to start from the ground up and create as many roadblocks as possible to deter even the most vigilant attackers from gaining access to </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">their systems.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1">First, we’ll learn how to identify highly sensitive data and how to secure access. </span><span class="koboSpan" id="kobo.11.2">We’ll then move on to common security practices and provide various ASP.NET Core features that you can apply to your applications. </span><span class="koboSpan" id="kobo.11.3">Finally, we’ll review the top three security threats according to the </span><strong class="bold"><span class="koboSpan" id="kobo.12.1">Open Worldwide Application Security Project</span></strong><span class="koboSpan" id="kobo.13.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.14.1">OWASP</span></strong><span class="koboSpan" id="kobo.15.1">) and how to safeguard </span><a id="_idIndexMarker159"/><span class="No-Break"><span class="koboSpan" id="kobo.16.1">your application.</span></span></p>
<p><span class="koboSpan" id="kobo.17.1">In this chapter, we’re going to cover the following </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">main topics:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.19.1">Developing Security</span></span></li>
<li><span class="koboSpan" id="kobo.20.1">Common </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">Security Practices</span></span></li>
<li><span class="koboSpan" id="kobo.22.1">Safeguarding Against the Top 3 </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">Security Threats</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.24.1">By the end of this chapter, you’ll understand what is considered sensitive data, a variety of common security practices in the industry, and how to safeguard yourself against the top three threats according to the </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">OWASP Foundation.</span></span></p>
<h1 id="_idParaDest-86"><a id="_idTextAnchor088"/><span class="koboSpan" id="kobo.26.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.27.1">While we will talk about security in this chapter, most of the discussion will contain small snippets of code that you can include in your projects. </span><span class="koboSpan" id="kobo.27.2">Access to a code editor isn’t necessary for this chapter to understand the essentials of security at a </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">developer level.</span></span></p>
<p><span class="koboSpan" id="kobo.29.1">The code files for this chapter can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">here: </span></span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">https://github.com/PacktPublishing/ASP.NET-Core-8-Best-Practices</span></span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">.</span></span></p>
<h1 id="_idParaDest-87"><a id="_idTextAnchor089"/><span class="koboSpan" id="kobo.33.1">Developing Security</span></h1>
<p><span class="koboSpan" id="kobo.34.1">In</span><a id="_idIndexMarker160"/><span class="koboSpan" id="kobo.35.1"> this section, we’ll examine terms and concepts regarding how to identify the data you need to secure and explain three extremely important ways to secure </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">your website.</span></span></p>
<p><span class="koboSpan" id="kobo.37.1">Too often, when developers start to build an ASP.NET web project, security is usually applied at the end of a project as opposed to being proactive and aware of security measures. </span><span class="koboSpan" id="kobo.37.2">One approach for implementing security is to examine your applications and look for these types of highly sensitive </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">data throughout:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.39.1">Name </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">and location</span></span></li>
<li><span class="koboSpan" id="kobo.41.1">Usernames </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">and passwords</span></span></li>
<li><span class="koboSpan" id="kobo.43.1">Contact information (phone number, email address, and </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">so on)</span></span></li>
<li><span class="koboSpan" id="kobo.45.1">Social </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">security number</span></span></li>
<li><span class="koboSpan" id="kobo.47.1">Financials (customer plans, credit cards, and </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">so on)</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.49.1">Database connections</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.50.1">Custom settings</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.51.1">Depending on the intent of the web application, other types might be involved, such as specific access to a section where permissions are implied. </span><span class="koboSpan" id="kobo.51.2">Other types of data could be considered sensitive based on industry or even </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">government regulations.</span></span></p>
<p><span class="koboSpan" id="kobo.53.1">Security in your application should be examined based on the criteria discussed in the </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">following sections.</span></span></p>
<h2 id="_idParaDest-88"><a id="_idTextAnchor090"/><span class="koboSpan" id="kobo.55.1">Do I have any sensitive data to protect?</span></h2>
<p><span class="koboSpan" id="kobo.56.1">Based </span><a id="_idIndexMarker161"/><span class="koboSpan" id="kobo.57.1">on your application and the list in the previous section, ask yourself, “If any of the data is leaked and made public, would there be </span><span class="No-Break"><span class="koboSpan" id="kobo.58.1">a problem?”</span></span></p>
<p><span class="koboSpan" id="kobo.59.1">Exposing any data from the aforementioned sources would be a disaster. </span><span class="koboSpan" id="kobo.59.2">Keep sensitive information contained using encryption, access controls, and secure coding practices, and use it only </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">when necessary.</span></span></p>
<h2 id="_idParaDest-89"><a id="_idTextAnchor091"/><span class="koboSpan" id="kobo.61.1">Am I exposing anything through the application?</span></h2>
<p><span class="koboSpan" id="kobo.62.1">When moving from one web page to another, am I passing something sensitive when maneuvering through the site? </span><span class="koboSpan" id="kobo.62.2">Is the application using primary keys in the URL? </span><span class="koboSpan" id="kobo.62.3">How is data passed to the </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">next page?</span></span></p>
<p><span class="koboSpan" id="kobo.64.1">Be mindful of visible clues to the users that contain information such as primary keys or sensitive information. </span><span class="koboSpan" id="kobo.64.2">We’ll discuss this later in </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">this chapter.</span></span></p>
<h2 id="_idParaDest-90"><a id="_idTextAnchor092"/><span class="koboSpan" id="kobo.66.1">Am I sanitizing user input?</span></h2>
<p><span class="koboSpan" id="kobo.67.1">When requesting input from a user, it’s always a good practice to sanitize the data. </span><span class="koboSpan" id="kobo.67.2">Sanitization, or scrubbing, is the process of taking user input and confirming it’s not malicious content that could compromise the system. </span><span class="koboSpan" id="kobo.67.3">One philosophy is to never trust </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">submitted data.</span></span></p>
<p><span class="koboSpan" id="kobo.69.1">It’s extremely important to use light validation with JavaScript/HTML on the client side, along with heavy validation and sanitization of data on </span><span class="No-Break"><span class="koboSpan" id="kobo.70.1">the server.</span></span></p>
<p><span class="koboSpan" id="kobo.71.1">Light validation would include ensuring the required fields are populated and contain the minimum and maximum length of data, and that certain fields meet a particular format (such as phone numbers, credit cards, and </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">so on).</span></span></p>
<p><span class="koboSpan" id="kobo.73.1">Heavier validation would reaffirm the light validation but also confirm various scenarios, such as that a user has access to something, referenced entities exist, or data disguised to</span><a id="_idIndexMarker162"/><span class="koboSpan" id="kobo.74.1"> cause </span><span class="No-Break"><span class="koboSpan" id="kobo.75.1">malicious activity.</span></span></p>
<h2 id="_idParaDest-91"><a id="_idTextAnchor093"/><span class="koboSpan" id="kobo.76.1">Securing Access</span></h2>
<p><span class="koboSpan" id="kobo.77.1">When building a website, it’s </span><a id="_idIndexMarker163"/><span class="koboSpan" id="kobo.78.1">best to think about whether a user is required to log in to your site or not. </span><span class="koboSpan" id="kobo.78.2">If you’re creating a blog, there wouldn’t be a need to have users log in to view a post. </span><span class="koboSpan" id="kobo.78.3">They would just view </span><span class="No-Break"><span class="koboSpan" id="kobo.79.1">it anonymously.</span></span></p>
<p><span class="koboSpan" id="kobo.80.1">However, if you require a user to log in to your website, there is a minimum of three mandatory requirements you must understand to </span><em class="italic"><span class="koboSpan" id="kobo.81.1">begin</span></em><span class="koboSpan" id="kobo.82.1"> to secure your application. </span><span class="koboSpan" id="kobo.82.2">We’ll look at them in the </span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">following sections.</span></span></p>
<h3><span class="koboSpan" id="kobo.84.1">Authentication</span></h3>
<p><span class="koboSpan" id="kobo.85.1">When authenticating a </span><a id="_idIndexMarker164"/><span class="koboSpan" id="kobo.86.1">user, you are </span><em class="italic"><span class="koboSpan" id="kobo.87.1">identifying and validating who they are</span></em><span class="koboSpan" id="kobo.88.1"> when they log in to </span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">your system.</span></span></p>
<p><span class="koboSpan" id="kobo.90.1">This is the primary concept of Microsoft’s Identity framework. </span><span class="koboSpan" id="kobo.90.2">It offers various methods to authenticate a user using either username/password, the ability to use third-party social networks (such as Facebook, Google, or Twitter), use </span><strong class="bold"><span class="koboSpan" id="kobo.91.1">two-factor authentication</span></strong><span class="koboSpan" id="kobo.92.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.93.1">2FA</span></strong><span class="koboSpan" id="kobo.94.1">), or even </span><a id="_idIndexMarker165"/><span class="koboSpan" id="kobo.95.1">use </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">third-party authenticators.</span></span></p>
<p><span class="koboSpan" id="kobo.97.1">You may have already experienced this on a website where you have to enter your username and password. </span><span class="koboSpan" id="kobo.97.2">That is step one in authenticating a user. </span><span class="koboSpan" id="kobo.97.3">Once verified, you are then asked to enter the code that’s been sent to your email or the authenticator app on your phone. </span><span class="koboSpan" id="kobo.97.4">That is </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">step two.</span></span></p>
<p><span class="koboSpan" id="kobo.99.1">Many websites use a username and password to log in. </span><span class="koboSpan" id="kobo.99.2">While this is the bare minimum to secure a website, it may help to implement additional security measures when authenticating </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">a user.</span></span></p>
<p><span class="koboSpan" id="kobo.101.1">Again, it’s a better approach to create as many additional roadblocks to protect your application from attackers as possible. </span><span class="koboSpan" id="kobo.101.2">The more obstacles, the less likely your site will </span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">be compromised.</span></span></p>
<h3><span class="koboSpan" id="kobo.103.1">Authorization</span></h3>
<p><span class="koboSpan" id="kobo.104.1">Once the user has authenticated, what can they do in the system? </span><span class="koboSpan" id="kobo.104.2">This is where authorization enters </span><span class="No-Break"><span class="koboSpan" id="kobo.105.1">the picture.</span></span></p>
<p><span class="koboSpan" id="kobo.106.1">Authorization</span><a id="_idIndexMarker166"/><span class="koboSpan" id="kobo.107.1"> is the </span><em class="italic"><span class="koboSpan" id="kobo.108.1">process of granting permission to do something in a system or on a website</span></em><span class="koboSpan" id="kobo.109.1">. </span><span class="koboSpan" id="kobo.109.2">For example, authors of a blog are permitted to update their articles when they log in, but they are not allowed to edit other articles unless they are authorized to do so by an administrator. </span><span class="koboSpan" id="kobo.109.3">An authorization system would need to be in place for this </span><span class="No-Break"><span class="koboSpan" id="kobo.110.1">to work.</span></span></p>
<p><span class="koboSpan" id="kobo.111.1">As mentioned in the </span><em class="italic"><span class="koboSpan" id="kobo.112.1">Authentication</span></em><span class="koboSpan" id="kobo.113.1"> section, Microsoft’s Identity framework contains various techniques for implementing role-based and user-based claims throughout the system. </span><span class="koboSpan" id="kobo.113.2">In our previous example, we mentioned that authors are only allowed to update their own articles. </span><span class="koboSpan" id="kobo.113.3">In a role-based system, the authors could be grouped into an “Authors” role, allowing them to create and update their own articles. </span><span class="koboSpan" id="kobo.113.4">In a user-based system, special privileges could be assigned at the user level, such as editing other </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">authors’ articles.</span></span></p>
<p><span class="koboSpan" id="kobo.115.1">While Microsoft Identity is flexible enough to incorporate any kind of authorization mechanism, developers should think about how to structure application-level authorizations from the very beginning before writing one line </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">of code.</span></span></p>
<p><span class="koboSpan" id="kobo.117.1">Authorizations </span><a id="_idIndexMarker167"/><span class="koboSpan" id="kobo.118.1">are extremely important when you’re identifying what a logged-in user can (and can’t) do on </span><span class="No-Break"><span class="koboSpan" id="kobo.119.1">your website.</span></span></p>
<h3><span class="koboSpan" id="kobo.120.1">Secure Sockets Layer (SSL)</span></h3>
<p><span class="koboSpan" id="kobo.121.1">If you’re </span><a id="_idIndexMarker168"/><span class="koboSpan" id="kobo.122.1">building a website, SSL is </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.123.1">absolutely required</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.125.1">The necessity to have an SSL-enabled website protects you for the </span><span class="No-Break"><span class="koboSpan" id="kobo.126.1">following reasons:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.127.1">You want your visitors to know they are on a </span><span class="No-Break"><span class="koboSpan" id="kobo.128.1">secure website.</span></span></li>
<li><span class="koboSpan" id="kobo.129.1">It prevents others on the same network viewing your </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">login credentials.</span></span></li>
<li><span class="koboSpan" id="kobo.131.1">HTTPS helps prevent</span><a id="_idIndexMarker169"/><span class="koboSpan" id="kobo.132.1"> a </span><strong class="bold"><span class="koboSpan" id="kobo.133.1">Man-in-the-Middle</span></strong><span class="koboSpan" id="kobo.134.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.135.1">MITM</span></strong><span class="koboSpan" id="kobo.136.1">) attack, where an attacker inserts themselves into a conversation between two users, possibly altering the exchange </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">of data.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.138.1">Search Engine Optimization</span></strong><span class="koboSpan" id="kobo.139.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.140.1">SEO</span></strong><span class="koboSpan" id="kobo.141.1">). </span><span class="koboSpan" id="kobo.141.2">Google </span><a id="_idIndexMarker170"/><span class="koboSpan" id="kobo.142.1">and other search engines use HTTPS as a ranking signal (reference: https://developers.google.com/search/blog/2014/08/https-as-ranking-signal). </span><span class="koboSpan" id="kobo.142.2">If you wanted to increase your chances of reaching number one in the search results, you should make your </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">site SSL-enabled.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.144.1">Most hosting companies </span><em class="italic"><span class="koboSpan" id="kobo.145.1">include</span></em><span class="koboSpan" id="kobo.146.1"> an SSL certificate free of charge for your sites. </span><span class="koboSpan" id="kobo.146.2">That’s how important SSL is to </span><span class="No-Break"><span class="koboSpan" id="kobo.147.1">a website.</span></span></p>
<p><span class="koboSpan" id="kobo.148.1">In this section, we identified what is considered sensitive data and learned about how to secure access using three critical concepts when building an ASP.NET </span><span class="No-Break"><span class="koboSpan" id="kobo.149.1">Core application.</span></span></p>
<p><span class="koboSpan" id="kobo.150.1">In the next section, we’ll look over some common security practices you can immediately start using in </span><span class="No-Break"><span class="koboSpan" id="kobo.151.1">your applications.</span></span></p>
<h1 id="_idParaDest-92"><a id="_idTextAnchor094"/><span class="koboSpan" id="kobo.152.1">Common Security Practices</span></h1>
<p><span class="koboSpan" id="kobo.153.1">As a developer, security</span><a id="_idIndexMarker171"/><span class="koboSpan" id="kobo.154.1"> seems to be a black box sometimes. </span><span class="koboSpan" id="kobo.154.2">You always hear about incidents where websites have been hacked, but you might think to yourself, “That couldn’t happen to me,” until it happens to you. </span><span class="koboSpan" id="kobo.154.3">When you witness a website you built being attacked first-hand, it’s a </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">humbling experience.</span></span></p>
<p><span class="koboSpan" id="kobo.156.1">While the techniques we’re about to cover only scratch the surface for ASP.NET websites, they encourage developers to become more </span><em class="italic"><span class="koboSpan" id="kobo.157.1">proactive</span></em><span class="koboSpan" id="kobo.158.1"> in their coding as opposed to finding out they were hacked and immediately </span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">becoming </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.160.1">reactive</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.161.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.162.1">In this section, we’ll review common security practices in the industry you can use to protect yourself so that you know what your system is doing and are not exposing too much to the world. </span><span class="koboSpan" id="kobo.162.2">We’ll learn about the different types of logs, how to update libraries and frameworks, and how to remove header information. </span><span class="koboSpan" id="kobo.162.3">We’ll finish this chapter by learning how to encrypt Entity Framework Core </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">database columns.</span></span></p>
<h2 id="_idParaDest-93"><a id="_idTextAnchor095"/><span class="koboSpan" id="kobo.164.1">Logging</span></h2>
<p><span class="koboSpan" id="kobo.165.1">Once you’ve created your website, some extra features are required before you can roll out the red carpet for everyone to </span><a id="_idIndexMarker172"/><span class="No-Break"><span class="koboSpan" id="kobo.166.1">enjoy it.</span></span></p>
<p><span class="koboSpan" id="kobo.167.1">How do you know what’s going on with your website? </span><span class="koboSpan" id="kobo.167.2">How will you know when someone deletes a post? </span><span class="koboSpan" id="kobo.167.3">How about a transaction? </span><span class="koboSpan" id="kobo.167.4">How long does it take for your Web API to make a full trip to present data? </span><span class="koboSpan" id="kobo.167.5">These questions should be answered by creating audit trails and enabling general logging for </span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">your application.</span></span></p>
<p><span class="koboSpan" id="kobo.169.1">Audit trails</span><a id="_idIndexMarker173"/><span class="koboSpan" id="kobo.170.1"> are a type of logging where you keep track of every action a user has executed in your system. </span><span class="koboSpan" id="kobo.170.2">Microsoft Id</span><a id="_idIndexMarker174"/><span class="koboSpan" id="kobo.171.1">entity should already be in place with logging code to sprinkle throughout </span><span class="No-Break"><span class="koboSpan" id="kobo.172.1">the application.</span></span></p>
<p><span class="koboSpan" id="kobo.173.1">IIS Logs</span><a id="_idIndexMarker175"/><span class="koboSpan" id="kobo.174.1"> are a type of audit trail. </span><span class="koboSpan" id="kobo.174.2">Every user accessing your system, including anonymous users, is logged through IIS. </span><span class="koboSpan" id="kobo.174.3">A simple log entry is </span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.176.1">
192.168.15.11, -, 01/01/22, 7:55:20, W3SVC2, -, 182.15.22.90, 4502, 163, 3223, 200, 0, GET, /Index, -,</span></pre> <p><span class="koboSpan" id="kobo.177.1">Standard data used in an audit trail would contain </span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">the following:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.179.1">Date/time</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.180.1">IP address/port</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.181.1">URL</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.182.1">Action taken</span></span></li>
<li><span class="koboSpan" id="kobo.183.1">The user who executed </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">the action</span></span></li>
<li><span class="koboSpan" id="kobo.185.1">An entity state before and after the action was </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">executed (</span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.187.1">optional</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.188.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.189.1">General logging</span><a id="_idIndexMarker176"/><span class="koboSpan" id="kobo.190.1"> is carried out more at an </span><a id="_idIndexMarker177"/><span class="koboSpan" id="kobo.191.1">application level as opposed to a system level. </span><span class="koboSpan" id="kobo.191.2">Most general logging includes data such </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">as this:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.193.1">Date/time</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.194.1">URL</span></span></li>
<li><span class="koboSpan" id="kobo.195.1">Log type (informational, warning, </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">or error)</span></span></li>
<li><span class="koboSpan" id="kobo.197.1">A comment about </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">the action</span></span></li>
<li><span class="koboSpan" id="kobo.199.1">Method/action/section name performing </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">the action</span></span></li>
<li><span class="koboSpan" id="kobo.201.1">The duration of the </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">process (</span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.203.1">optional</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.204.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.205.1">These types of </span><a id="_idIndexMarker178"/><span class="koboSpan" id="kobo.206.1">logs are essential in the API world. </span><span class="koboSpan" id="kobo.206.2">These logs are created by the developer and stored on a disk or in a database. </span><span class="koboSpan" id="kobo.206.3">Once you create a Web API, there will be moments when you’ll wonder what it’s doing and why it’s taking so long to complete a request. </span><span class="koboSpan" id="kobo.206.4">Logs are </span><a id="_idIndexMarker179"/><span class="koboSpan" id="kobo.207.1">windows to the system. </span><span class="koboSpan" id="kobo.207.2">What exactly is </span><span class="No-Break"><span class="koboSpan" id="kobo.208.1">happening there?</span></span></p>
<p><span class="koboSpan" id="kobo.209.1">When it comes to security, your logs are gold. </span><span class="koboSpan" id="kobo.209.2">If someone impersonates another user, you can immediately examine the logs, identify the user and IP, and take the necessary actions to prevent it from happening again. </span><span class="koboSpan" id="kobo.209.3">This could be done by resetting a password, disconnecting or disabling a user from logging in, or even removing the user from the </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">system overall.</span></span></p>
<p><span class="koboSpan" id="kobo.211.1">Without </span><a id="_idIndexMarker180"/><span class="koboSpan" id="kobo.212.1">logging, you’ll </span><a id="_idIndexMarker181"/><span class="koboSpan" id="kobo.213.1">be unaware of events occurring in </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">your system.</span></span></p>
<h2 id="_idParaDest-94"><a id="_idTextAnchor096"/><span class="koboSpan" id="kobo.215.1">Keep your Framework and Libraries Current</span></h2>
<p><span class="koboSpan" id="kobo.216.1">Every </span><a id="_idIndexMarker182"/><span class="koboSpan" id="kobo.217.1">developer has their favorite libraries and frameworks. </span><span class="koboSpan" id="kobo.217.2">With .NET, there are times when the framework requires an update to prevent possible </span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">security threats.</span></span></p>
<p><span class="koboSpan" id="kobo.219.1">Once you are aware of these security updates, it’s your responsibility to update the framework and/or libraries or notify someone who </span><em class="italic"><span class="koboSpan" id="kobo.220.1">can</span></em><span class="koboSpan" id="kobo.221.1"> perform the update (in case developers are not allowed to update servers) to protect against any type of threat based on the </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">update’s vulnerabilities.</span></span></p>
<p><span class="koboSpan" id="kobo.223.1">Twice in my career, a .NET version had a security issue and a security update was released to be applied to the framework. </span><span class="koboSpan" id="kobo.223.2">The patch wasn’t applied immediately. </span><span class="koboSpan" id="kobo.223.3">Two weeks later, there was a breach and it was concluded the breach could’ve been prevented if the patch was applied two </span><span class="No-Break"><span class="koboSpan" id="kobo.224.1">weeks earlier.</span></span></p>
<p><span class="koboSpan" id="kobo.225.1">It was a bad day for </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">the company.</span></span></p>
<p><span class="koboSpan" id="kobo.227.1">To see whether there is a security patch for .NET, refer to the </span><a id="_idIndexMarker183"/><span class="koboSpan" id="kobo.228.1">Microsoft Update Catalog </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">at </span></span><span class="No-Break"><span class="koboSpan" id="kobo.230.1">https://www.catalog.update.microsoft.com/home.aspx</span></span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">.</span></span></p>
<h2 id="_idParaDest-95"><a id="_idTextAnchor097"/><span class="koboSpan" id="kobo.232.1">Always Force SSL</span></h2>
<p><span class="koboSpan" id="kobo.233.1">If a visitor </span><a id="_idIndexMarker184"/><span class="koboSpan" id="kobo.234.1">arrives through an HTTP URL and not HTTPS, it’s best to redirect them over to the secure portion of </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">your site.</span></span></p>
<p><strong class="bold"><span class="koboSpan" id="kobo.236.1">HTTP Strict Transport Security Protocol</span></strong><span class="koboSpan" id="kobo.237.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.238.1">HSTS</span></strong><span class="koboSpan" id="kobo.239.1">) is a security enhancement specified by the web application through a </span><a id="_idIndexMarker185"/><span class="koboSpan" id="kobo.240.1">response header. </span><span class="koboSpan" id="kobo.240.2">When the browser receives an HSTS header, it prevents the user from using untrusted or </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">invalid certificates.</span></span></p>
<p><span class="koboSpan" id="kobo.242.1">However, there are limitations to </span><span class="No-Break"><span class="koboSpan" id="kobo.243.1">using this:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.244.1">Modern clients must </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">support HSTS</span></span></li>
<li><span class="koboSpan" id="kobo.246.1">HSTS must establish one HTTPS connection to establish an </span><span class="No-Break"><span class="koboSpan" id="kobo.247.1">HSTS policy</span></span></li>
<li><span class="koboSpan" id="kobo.248.1">The web application must examine every HTTP request and redirect or reject the </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">HTTP request</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.250.1">To implement </span><a id="_idIndexMarker186"/><span class="koboSpan" id="kobo.251.1">this in your code, you must revisit the middleware and add the HSTS extension to a production environment. </span><span class="koboSpan" id="kobo.251.2">If you’ve just created a new web app, this is automatically added by default. </span><span class="koboSpan" id="kobo.251.3">Here is </span><span class="No-Break"><span class="koboSpan" id="kobo.252.1">an example:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.253.1">
var builder = WebApplication.CreateBuilder(args);
builder.Services.AddRazorPages();
var app = builder.Build();
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
</span><strong class="bold"><span class="koboSpan" id="kobo.254.1">    app.UseHsts();</span></strong><span class="koboSpan" id="kobo.255.1">
}
</span><strong class="bold"><span class="koboSpan" id="kobo.256.1">app.UseHttpsRedirection();</span></strong><span class="koboSpan" id="kobo.257.1">
app.UseStaticFiles();
app.UseRouting();
app.UseAuthorization();
app.MapRazorPages();
app.Run();</span></pre> <p><span class="koboSpan" id="kobo.258.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">app.UseHttpsRedirection()</span></strong><span class="koboSpan" id="kobo.260.1"> method must appear after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">app.UseHsts()</span></strong><span class="koboSpan" id="kobo.262.1"> extension method for the redirect to occur. </span><span class="koboSpan" id="kobo.262.2">This ensures your users will be visiting an </span><a id="_idIndexMarker187"/><span class="No-Break"><span class="koboSpan" id="kobo.263.1">SSL-enabled website.</span></span></p>
<h2 id="_idParaDest-96"><a id="_idTextAnchor098"/><span class="koboSpan" id="kobo.264.1">Never Trust the Client</span></h2>
<p><span class="koboSpan" id="kobo.265.1">I’ve</span><a id="_idIndexMarker188"/><span class="koboSpan" id="kobo.266.1"> always likened this approach with the old saying, “Wearing suspenders with a belt.” </span><span class="koboSpan" id="kobo.266.2">At least you wouldn’t be caught with your pants down (as I use this as a </span><span class="No-Break"><span class="koboSpan" id="kobo.267.1">security metaphor).</span></span></p>
<p><span class="koboSpan" id="kobo.268.1">As mentioned near the beginning of this chapter, the intent here is to validate and sanitize data that’s been submitted by the client as best you can with JavaScript and HTML and then follow up with additional validation using C# when a form </span><span class="No-Break"><span class="koboSpan" id="kobo.269.1">is submitted.</span></span></p>
<p><span class="koboSpan" id="kobo.270.1">For example, HTML 5 is now available in almost every browser, with the ability to apply a certain type to a text input, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">type="number"</span></strong><span class="koboSpan" id="kobo.272.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">type="date"</span></strong><span class="koboSpan" id="kobo.274.1">. </span><span class="koboSpan" id="kobo.274.2">A welcome addition to this collection of input types is the ability to add a regex pattern to make validation even easier on the </span><span class="No-Break"><span class="koboSpan" id="kobo.275.1">client side:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.276.1">
&lt;input type="text"
       placeholder="Enter a Columbus Phone Number"
       title="Enter either a 740 or 614 area code using this format: (740) 999-9999"
       pattern="^\(?(740|614)\)?(\s+)?[0-9]{3}-?[0-9]{4}$"
       required /&gt;</span></pre> <p><span class="koboSpan" id="kobo.277.1">This pattern allows for either 740 or 614 area codes to be in a phone number. </span><span class="koboSpan" id="kobo.277.2">If the pattern doesn’t match, you will receive a tooltip message stating why it’s </span><span class="No-Break"><span class="koboSpan" id="kobo.278.1">not valid:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer028">
<span class="koboSpan" id="kobo.279.1"><img alt="Figure 4.1 – The effect of a failed validation on an input" src="image/Figure_4.01_B19493.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.280.1">Figure 4.1 – The effect of a failed validation on an input</span></p>
<p><span class="koboSpan" id="kobo.281.1">However, this </span><a id="_idIndexMarker189"/><span class="koboSpan" id="kobo.282.1">does not justify neglecting validation on the server. </span><span class="koboSpan" id="kobo.282.2">For every field where a user inputs data, this same effort regarding validation should be applied when the server receives </span><span class="No-Break"><span class="koboSpan" id="kobo.283.1">the data.</span></span></p>
<h2 id="_idParaDest-97"><a id="_idTextAnchor099"/><span class="koboSpan" id="kobo.284.1">Always Encode User Input</span></h2>
<p><span class="koboSpan" id="kobo.285.1">One of the </span><a id="_idIndexMarker190"/><span class="koboSpan" id="kobo.286.1">easiest methods of sanitizing user input on the </span><a id="_idIndexMarker191"/><span class="koboSpan" id="kobo.287.1">server </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">is </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.289.1">encoding</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.291.1">If a user enters data and the data will be displayed on a page at any time, it’s best to encode the data to prevent XSS. </span><span class="koboSpan" id="kobo.291.2">The easiest way to encode user input is to dependency inject </span><strong class="source-inline"><span class="koboSpan" id="kobo.292.1">HtmlEncoder</span></strong><span class="koboSpan" id="kobo.293.1"> into a method to perform the encoding, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.294.1">code snippet:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.295.1">
    public async Task&lt;IActionResult&gt; OnGet(
        [FromServices] HtmlEncoder htmlEncoder,
        string q = "")
    {
        PageResults = await PerformTheSearch(htmlEncoder.Encode(q));
        return Page();
    }</span></pre> <p><span class="koboSpan" id="kobo.296.1">.NET has various injectable services already defined. </span><strong class="source-inline"><span class="koboSpan" id="kobo.297.1">HtmlEncoder</span></strong><span class="koboSpan" id="kobo.298.1"> is one such service and is injected automatically by adding a </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">[FromServices]</span></strong><span class="koboSpan" id="kobo.300.1"> attribute. </span><span class="koboSpan" id="kobo.300.2">Once we have our encoder, we can encode the string that’s been passed in and safely perform the action that’s </span><span class="No-Break"><span class="koboSpan" id="kobo.301.1">been requested.</span></span></p>
<p><span class="koboSpan" id="kobo.302.1">In this section, you learned how to encode user input from the client, making your site safe from </span><span class="No-Break"><span class="koboSpan" id="kobo.303.1">malicious data.</span></span></p>
<p><span class="koboSpan" id="kobo.304.1">In the next section, you’ll learn how to hide what your servers are telling the world and how to make a reusable </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">middleware component.</span></span></p>
<h2 id="_idParaDest-98"><a id="_idTextAnchor100"/><span class="koboSpan" id="kobo.306.1">Securing Your Headers</span></h2>
<p><span class="koboSpan" id="kobo.307.1">By default, several headers</span><a id="_idIndexMarker192"/><span class="koboSpan" id="kobo.308.1"> are added to HTTP requests to identify a server, the version used, what technology stack you’re using, and what powers your website. </span><span class="koboSpan" id="kobo.308.2">While these default headers are helpful, some of them aren’t required, while others can make your site </span><span class="No-Break"><span class="koboSpan" id="kobo.309.1">more secure.</span></span></p>
<p><span class="koboSpan" id="kobo.310.1">In this section, we’ll focus on securing the recommended header changes through </span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">ASP.NET’s Middleware.</span></span></p>
<h3><span class="koboSpan" id="kobo.312.1">Removing Server Headers</span></h3>
<p><span class="koboSpan" id="kobo.313.1">It’s generally not a good idea to announce to the world what server you’re running and its version to an anonymous user. </span><span class="koboSpan" id="kobo.313.2">This exposes the type of web server you’re running and allows attackers to find IIS-specific techniques to gain access to your </span><span class="No-Break"><span class="koboSpan" id="kobo.314.1">web server.</span></span></p>
<p><span class="koboSpan" id="kobo.315.1">In ASP.NET, you can disable the server header for Kestrel (which is the open source server used in ASP.NET) </span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.319.1">
var builder = WebApplication.CreateBuilder(args);
builder.WebHost.UseKestrel(options =&gt; options.AddServerHeader = false);</span></pre> <p><span class="koboSpan" id="kobo.320.1">When we set </span><strong class="source-inline"><span class="koboSpan" id="kobo.321.1">AddServerHeader</span></strong><span class="koboSpan" id="kobo.322.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">false</span></strong><span class="koboSpan" id="kobo.324.1">, the header doesn’t display the type and version of </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">the server.</span></span></p>
<p><span class="koboSpan" id="kobo.326.1">In addition to the server header, we also need to remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.327.1">X-Powered-By</span></strong><span class="koboSpan" id="kobo.328.1"> header to avoid exposing too much information. </span><span class="koboSpan" id="kobo.328.2">This can be achieved through middleware, as </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.330.1">
app.</span><a id="_idTextAnchor101"/><span class="koboSpan" id="kobo.331.1">Use(async (context, next) =&gt;
{
    context.</span><a id="_idTextAnchor102"/><span class="koboSpan" id="kobo.332.1">Response.Headers.Remove("Server");
    context.Response.Headers.Remove("X-Powered-By");
    await next();
});</span></pre> <p><span class="koboSpan" id="kobo.333.1">However, you’ll also have to add it to </span><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">web.config</span></strong><span class="koboSpan" id="kobo.335.1">, which should exist in the root of your project. </span><span class="koboSpan" id="kobo.335.2">Here are the only reasons </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">web.config</span></strong><span class="koboSpan" id="kobo.337.1"> should exist in </span><span class="No-Break"><span class="koboSpan" id="kobo.338.1">your project:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.339.1">Compression configuration</span></span></li>
<li><span class="koboSpan" id="kobo.340.1">Removing specific </span><span class="No-Break"><span class="koboSpan" id="kobo.341.1">IIS headers</span></span></li>
<li><span class="koboSpan" id="kobo.342.1">Custom </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">MIME mappings</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.344.1">If it doesn’t exist, add</span><a id="_idIndexMarker193"/><span class="koboSpan" id="kobo.345.1"> it to your project and add the following path to remove the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">X-Powered-By</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.347.1"> header:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.348.1">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
  &lt;system.webServer&gt;
    &lt;httpProtocol&gt;
      &lt;customHeaders&gt;
        &lt;remove name="X-Powered-By" /&gt;</span></pre> <p><span class="koboSpan" id="kobo.349.1">Other header values to remove include </span><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">X-Aspnet-Version</span></strong><span class="koboSpan" id="kobo.351.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.352.1">X-AspnetMvc-Version</span></strong><span class="koboSpan" id="kobo.353.1">. </span><span class="koboSpan" id="kobo.353.2">The reason you should remove these headers is that they provide detailed information about what technology you’re running on your server. </span><span class="koboSpan" id="kobo.353.3">If there is a security flaw specifically for ASP.NET or ASP.NET Core MVC, these headers would make your site easier for attackers to narrow down their attacks and cause an inevitable </span><span class="No-Break"><span class="koboSpan" id="kobo.354.1">security event.</span></span></p>
<p><span class="koboSpan" id="kobo.355.1">To remove these two headers, add the following two lines to the </span><a id="_idTextAnchor103"/><span class="koboSpan" id="kobo.356.1">middleware in your </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.358.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.359.1">
context.Response.Headers.Remove("X-Aspnet-version");
context.Response.Headers.Remove("X-AspnetMvc-version");</span></pre> <h3><span class="koboSpan" id="kobo.360.1">No Sniffing Allowed</span></h3>
<p><span class="koboSpan" id="kobo.361.1">When you include </span><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">X-Content-Type-Options</span></strong><span class="koboSpan" id="kobo.363.1"> in a header, this tells the browser to adhere to the MIME types registered in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">Content-Type</span></strong><span class="koboSpan" id="kobo.365.1"> headers. </span><span class="koboSpan" id="kobo.365.2">Thes</span><a id="_idTextAnchor104"/><span class="koboSpan" id="kobo.366.1">e shouldn’t be changed </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">or followed:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.368.1">
context.Response.Headers.Add("X-Content-Type-Options", new
   StringValues("nosniff"));</span></pre> <p><span class="koboSpan" id="kobo.369.1">This marker tells the browser that these MIME types were intentionally configured to avoid MIME-type sniffing. </span><span class="koboSpan" id="kobo.369.2">This helps prevent attacks based on MIME-type confusion, where non-MIME types could be considered valid </span><span class="No-Break"><span class="koboSpan" id="kobo.370.1">MIME types.</span></span></p>
<h3><span class="koboSpan" id="kobo.371.1">No Framing Either</span></h3>
<p><span class="koboSpan" id="kobo.372.1">When the browser sees an </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">X-Frame-Options</span></strong><span class="koboSpan" id="kobo.374.1"> header response, it indicates whether or not the browser should render the web page in </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">&lt;fram</span><a id="_idTextAnchor105"/><span class="koboSpan" id="kobo.376.1">e&gt;</span></strong><span class="koboSpan" id="kobo.377.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">&lt;iframe&gt;</span></strong><span class="koboSpan" id="kobo.379.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">&lt;embed&gt;</span></strong><span class="koboSpan" id="kobo.381.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">&lt;object&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.385.1">
context.Response.Headers.Add("X-Frame-Options", new
    StringValues("DENY"));</span></pre> <p><span class="koboSpan" id="kobo.386.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">X-Frame-Options</span></strong><span class="koboSpan" id="kobo.388.1"> header prevents clickjacking attacks, where someone could embed your content into other sites using frames, embeds, or objects. </span><span class="koboSpan" id="kobo.388.2">Setting this to </span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">DENY</span></strong><span class="koboSpan" id="kobo.390.1"> protects</span><a id="_idIndexMarker194"/><span class="koboSpan" id="kobo.391.1"> you from </span><span class="No-Break"><span class="koboSpan" id="kobo.392.1">such attacks.</span></span></p>
<h3><span class="koboSpan" id="kobo.393.1">Creating a security middleware component</span></h3>
<p><span class="koboSpan" id="kobo.394.1">To finalize this section, we’ll create a simple middleware component we can reuse in our .NET Core </span><span class="No-Break"><span class="koboSpan" id="kobo.395.1">web applications.</span></span></p>
<p><span class="koboSpan" id="kobo.396.1">Since we created our middleware skeleton in </span><a href="B19493_03.xhtml#_idTextAnchor070"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.397.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.398.1">, we can reuse the code for our </span><strong class="source-inline"><span class="koboSpan" id="kobo.399.1">RemoveInsecureHeadersMiddleware</span></strong><span class="koboSpan" id="kobo.400.1"> component, as </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.402.1">
public class RemoveInsecureHeadersMiddleware
{
    private readonly RequestDelegate _next;
    public RemoveInsecureHeadersMiddleware(RequestDelegate next)
    {
        _next = next;
    }
    public async Task Invoke(HttpContext httpContext)
    {
        httpContext.Response.OnStarting((state) =&gt;
        {
            httpContext.Response.Headers.Remove("Server");
            httpContext.Response.Headers.Remove("X-Powered-By");
            httpContext.Response.Headers.Remove("X-Aspnet-version");
            httpContext.Response.Headers.Remove("X-AspnetMvc-                version");
            httpContext.Response.Headers.Add("X-Content-Type-Options",
                new StringValues("nosniff"));
            httpContext.Response.Headers.Add("X-Frame-Options",
                new StringValues("DENY"));
            return Task.CompletedTask;
        }, null!);
        await _next(httpContext);
    }
}</span></pre> <p><span class="koboSpan" id="kobo.403.1">Don’t forget</span><a id="_idIndexMarker195"/><span class="koboSpan" id="kobo.404.1"> our </span><span class="No-Break"><span class="koboSpan" id="kobo.405.1">extension method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.406.1">
public static class RemoveInsecureHeadersMiddlewareExtensions
{
    public static IApplicationBuilder RemoveInsecureHeaders(
        this IApplicationBuilder builder)
    {
        return builder.UseMiddleware&lt;RemoveInsecureHeadersMiddleware&gt;();
    }
}</span></pre> <p><span class="koboSpan" id="kobo.407.1">We can use newly created security extension in our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.409.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.410.1">
app.RemoveInsecureHeaders();</span></pre> <p><span class="koboSpan" id="kobo.411.1">While we’ve added the most obvious headers, the good news is that you can update this component by adding additional headers to increase the security of your site </span><span class="No-Break"><span class="koboSpan" id="kobo.412.1">even further.</span></span></p>
<p><span class="koboSpan" id="kobo.413.1">In this section, you learned how to secure your headers and create a reusable middleware component for all of your web applications. </span><span class="koboSpan" id="kobo.413.2">In the next section, you’ll learn how to secure Entity Framework by encrypting your data, using stored procedures, and using </span><span class="No-Break"><span class="koboSpan" id="kobo.414.1">parameterized queries.</span></span></p>
<h2 id="_idParaDest-99"><a id="_idTextAnchor106"/><span class="koboSpan" id="kobo.415.1">Securing Entity Framework Core</span></h2>
<p><span class="koboSpan" id="kobo.416.1">Entity Framework Core</span><a id="_idIndexMarker196"/><span class="koboSpan" id="kobo.417.1"> is one of</span><a id="_idIndexMarker197"/><span class="koboSpan" id="kobo.418.1"> those technologies that continues to amaze me. </span><span class="koboSpan" id="kobo.418.2">Every version of Entity Framework Core that’s released provides some new performance enhancement, a better approach to a technique, or some other method to make our lives a little </span><span class="No-Break"><span class="koboSpan" id="kobo.419.1">bit easier.</span></span></p>
<p><span class="koboSpan" id="kobo.420.1">In this section, we’ll learn about how we can encrypt our data at the </span><span class="No-Break"><span class="koboSpan" id="kobo.421.1">database level.</span></span></p>
<h3><span class="koboSpan" id="kobo.422.1">Encrypting Your Data</span></h3>
<p><span class="koboSpan" id="kobo.423.1">One of the most</span><a id="_idIndexMarker198"/><span class="koboSpan" id="kobo.424.1"> valuable things to a company is data. </span><span class="koboSpan" id="kobo.424.2">To prevent an attack, one of the security measures you can take is to encrypt the data in </span><span class="No-Break"><span class="koboSpan" id="kobo.425.1">the table.</span></span></p>
<p><span class="koboSpan" id="kobo.426.1">At the beginning of this chapter, we explained the types of data that require special attention, such as phone numbers, email addresses, and credit </span><span class="No-Break"><span class="koboSpan" id="kobo.427.1">card data.</span></span></p>
<p><span class="koboSpan" id="kobo.428.1">The best approach is to apply security at the database level by using the database’s encryption technology, whether it’s SQL Server or a </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">similar database.</span></span></p>
<p><span class="koboSpan" id="kobo.430.1">SQL Server encrypts specific </span><a id="_idIndexMarker199"/><span class="koboSpan" id="kobo.431.1">columns by using the </span><strong class="bold"><span class="koboSpan" id="kobo.432.1">Encrypt Columns…</span></strong><span class="koboSpan" id="kobo.433.1"> option in </span><strong class="bold"><span class="koboSpan" id="kobo.434.1">SQL Server Management Studio</span></strong><span class="koboSpan" id="kobo.435.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.436.1">SSMS</span></strong><span class="koboSpan" id="kobo.437.1">), as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.438.1">Figure 4</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.439.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.440.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer029">
<span class="koboSpan" id="kobo.441.1"><img alt="Figure 4.2 – The Encrypt Columns… option in SQL Server Management Studio" src="image/Figure_4.02_B19493.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.442.1">Figure 4.2 – The Encrypt Columns… option in SQL Server Management Studio</span></p>
<p><span class="koboSpan" id="kobo.443.1">If you are using Entity Framework, generating a DbContext will take the secure columns into account. </span><span class="koboSpan" id="kobo.443.2">Again, when creating encryption at the database level, it would be another roadblock to dissuade attackers from accessing </span><span class="No-Break"><span class="koboSpan" id="kobo.444.1">sensitive data.</span></span></p>
<p><span class="koboSpan" id="kobo.445.1">In this section, we examined the best approach to protecting your data – that is, by encrypting your data using SQL Server’s </span><strong class="bold"><span class="koboSpan" id="kobo.446.1">Encrypt Columns…</span></strong><span class="koboSpan" id="kobo.447.1"> feature. </span><span class="koboSpan" id="kobo.447.2">In the next section, we’ll look at how to protect your pages from a </span><strong class="bold"><span class="koboSpan" id="kobo.448.1">cross-site request forgery</span></strong><span class="koboSpan" id="kobo.449.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.450.1">XSRF</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.451.1">) attack.</span></span></p>
<h2 id="_idParaDest-100"><a id="_idTextAnchor107"/><span class="koboSpan" id="kobo.452.1">Use Microsoft Entra for Securing Applications</span></h2>
<p><span class="koboSpan" id="kobo.453.1">As mentioned previously, when logging into a website, it’s best to protect the database from intruders by encrypting the database. </span><span class="koboSpan" id="kobo.453.2">This means using existing methods as opposed to writing custom encryption algorithms. </span><span class="koboSpan" id="kobo.453.3">Creating a custom encryption algorithm should be avoided since most algorithms are easily broken through hacker tools. </span><span class="koboSpan" id="kobo.453.4">It’s best to use an existing framework like Microsoft Identity (now </span><span class="No-Break"><span class="koboSpan" id="kobo.454.1">called Entra).</span></span></p>
<p><span class="koboSpan" id="kobo.455.1">With Blazor and SPAs (Single-Page Applications) all the rage, it can be hard to secure an application using APIs. </span><span class="koboSpan" id="kobo.455.2">Previously, using Microsoft Identity through an API required a lot of effort making it harder to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.456.1">secure applications.</span></span></p>
<p><span class="koboSpan" id="kobo.457.1">With the latest .NET 8, Microsoft Entra introduces API-based calls for every aspect of security for web applications for </span><strong class="bold"><span class="koboSpan" id="kobo.458.1">Single-Page Applications</span></strong><span class="koboSpan" id="kobo.459.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.460.1">SPAs</span></strong><span class="koboSpan" id="kobo.461.1">). </span><span class="koboSpan" id="kobo.461.2">When creating a new application, the following code adds an Entra-enabled REST-based API to </span><span class="No-Break"><span class="koboSpan" id="kobo.462.1">an application:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.463.1">
var builder = WebApplication.CreateBuilder(args);
 
// Add services to the container.
</span><span class="koboSpan" id="kobo.463.2">builder.Services
    .AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddMicrosoftIdentityWebApi(builder.Configuration.GetSection(“AzureAd”));
builder.Services.AddAuthorization(); </span></pre> <p><span class="koboSpan" id="kobo.464.1">The preceding code creates our web application and defines a JwtBearerDefault authentication scheme and adds a Web API specifically for </span><span class="No-Break"><span class="koboSpan" id="kobo.465.1">Microsoft Identity.</span></span></p>
<p><span class="koboSpan" id="kobo.466.1">If JWT Tokens are not an option, .NET 8 also introduces Bearer Tokens as </span><span class="No-Break"><span class="koboSpan" id="kobo.467.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.468.1">
var builder = WebApplication.CreateBuilder(args);
 
// Add services to the container.
</span><span class="koboSpan" id="kobo.468.2">builder.Services
    .AddAuthentication()
    .AddBearerToken();
builder.Services.AddAuthorization();</span></pre> <p><span class="koboSpan" id="kobo.469.1">The ability to write fast APIs along with simple authentication and authorization gives web developers more options when writing web applications using Blazor and SPAs. </span><span class="koboSpan" id="kobo.469.2">We’ll cover Microsoft Entra more in </span><a href="B19493_09.xhtml#_idTextAnchor207"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.470.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.471.1"> when looking at creating better </span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">web APIs.</span></span></p>
<h2 id="_idParaDest-101"><a id="_idTextAnchor108"/><span class="koboSpan" id="kobo.473.1">Protecting Your Pages with Anti-Forgery</span></h2>
<p><span class="koboSpan" id="kobo.474.1">Cross-site request forgery, or</span><a id="_idIndexMarker200"/><span class="koboSpan" id="kobo.475.1"> XSRF, is where an attack occurs, tricking a user to </span><a id="_idIndexMarker201"/><span class="koboSpan" id="kobo.476.1">execute unwanted actions in a web application in which they’re currently authenticated. </span><span class="koboSpan" id="kobo.476.2">For example, a user could be tricked into using their credit card on a different site without them even </span><span class="No-Break"><span class="koboSpan" id="kobo.477.1">knowing it.</span></span></p>
<p><span class="koboSpan" id="kobo.478.1">To prevent an XSRF attack through your web forms, the recommended approach is to use </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">anti-forgery tokens.</span></span></p>
<p><span class="koboSpan" id="kobo.480.1">To add some to our Middleware, we will add them to our pipeline, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.481.1">code snippet:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.482.1">
services.AddAntiforgery();</span></pre> <p><span class="koboSpan" id="kobo.483.1">When an HTML form is created, anti-forgery tokens are automatically generated when a </span><strong class="source-inline"><span class="koboSpan" id="kobo.484.1">&lt;form&gt;</span></strong><span class="koboSpan" id="kobo.485.1"> tag contains </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">method="post"</span></strong><span class="koboSpan" id="kobo.487.1"> and one of the following conditions </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">is true:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.489.1">The action attribute is </span><span class="No-Break"><span class="koboSpan" id="kobo.490.1">empty (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.491.1">action=""</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.493.1">The action attribute isn’t supplied (</span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1">&lt;</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">form method="post"&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.496.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.497.1">If you have other attributes attached to the form tag, you can explicitly add an </span><strong class="source-inline"><span class="koboSpan" id="kobo.498.1">HtmlHelper</span></strong><span class="koboSpan" id="kobo.499.1"> called </span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">AntiForgeryToken()</span></strong><span class="koboSpan" id="kobo.501.1"> inside the </span><span class="No-Break"><span class="koboSpan" id="kobo.502.1">form tag:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.503.1">
@Html.AntiForgeryToken();</span></pre> <p><span class="koboSpan" id="kobo.504.1">This will generate a hidden input with an arbitrary value. </span><span class="koboSpan" id="kobo.504.2">If the value that comes back from the client is not the same as when the server originally sent it, the request will </span><span class="No-Break"><span class="koboSpan" id="kobo.505.1">be denied.</span></span></p>
<p><span class="koboSpan" id="kobo.506.1">In this section, you learned about audit trails and general logging, how to keep your frameworks and libraries current, how to always force SSL to make your connections secure, and to never trust the client’s input. </span><span class="koboSpan" id="kobo.506.2">You also learned that every user input should be encoded when received by the server, how to secure your headers, how to secure your database by using Entity Framework Core, and, finally, how to protect your forms from cross-site request</span><a id="_idIndexMarker202"/><span class="koboSpan" id="kobo.507.1"> forgery attacks by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.508.1">.AddAntiForgery()</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.509.1">Middleware service.</span></span></p>
<p><span class="koboSpan" id="kobo.510.1">In the next section, we’ll look at some real-world issues and how to solve the top three threats according </span><span class="No-Break"><span class="koboSpan" id="kobo.511.1">to OWASP.</span></span></p>
<h1 id="_idParaDest-102"><a id="_idTextAnchor109"/><span class="koboSpan" id="kobo.512.1">Safeguarding Against the Top 3 Security Threats</span></h1>
<p><span class="koboSpan" id="kobo.513.1">The </span><a id="_idIndexMarker203"/><span class="koboSpan" id="kobo.514.1">Open Worldwide Application Security Project, or OWASP, is a non-profit foundation dedicated to improving the security of software. </span><span class="koboSpan" id="kobo.514.2">Since new threats are emerging all the time, they keep a list called the OWASP Top 10, which is meant to keep software developers up to date regarding the latest security threats and how to prevent them. </span><span class="koboSpan" id="kobo.514.3">The Top 10 list includes the </span><a id="_idIndexMarker204"/><span class="koboSpan" id="kobo.515.1">following </span><span class="No-Break"><span class="koboSpan" id="kobo.516.1">security threats:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.517.1">Broken </span><span class="No-Break"><span class="koboSpan" id="kobo.518.1">Access Control</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.519.1">Cryptographic Failures</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.520.1">Injection</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.521.1">Insecure Design</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.522.1">Security Misconfiguration</span></span></li>
<li><span class="koboSpan" id="kobo.523.1">Vulnerable and </span><span class="No-Break"><span class="koboSpan" id="kobo.524.1">Outdated Components</span></span></li>
<li><span class="koboSpan" id="kobo.525.1">Identification and </span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">Authentication Failures</span></span></li>
<li><span class="koboSpan" id="kobo.527.1">Software and Data </span><span class="No-Break"><span class="koboSpan" id="kobo.528.1">Integrity Failures</span></span></li>
<li><span class="koboSpan" id="kobo.529.1">Security Logging and </span><span class="No-Break"><span class="koboSpan" id="kobo.530.1">Monitoring Failures</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.531.1">Server-Side Request </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.532.1">Forgery</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.533.1"> (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.534.1">SSRF</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.535.1">)</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.536.1">In this section, we’ll cover the top three threats and how to safeguard your ASP.NET Core application from these threats – that is, Broken Access Control, Cryptographic Failures, </span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">and Injection.</span></span></p>
<h2 id="_idParaDest-103"><a id="_idTextAnchor110"/><span class="koboSpan" id="kobo.538.1">Broken Access Control</span></h2>
<p><span class="koboSpan" id="kobo.539.1">Broken access control</span><a id="_idIndexMarker205"/><span class="koboSpan" id="kobo.540.1"> is when a user can perform a particular act in the system outside of their intended permissions. </span><span class="koboSpan" id="kobo.540.2">Permission checks could be missing in the software, or the correct permissions might not have been checked in </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1">the software.</span></span></p>
<p><span class="koboSpan" id="kobo.542.1">The key word to focus on here</span><a id="_idIndexMarker206"/><span class="koboSpan" id="kobo.543.1"> is </span><strong class="bold"><span class="koboSpan" id="kobo.544.1">authorization</span></strong><span class="koboSpan" id="kobo.545.1">. </span><span class="koboSpan" id="kobo.545.2">Authorizing users into your system is a </span><span class="No-Break"><span class="koboSpan" id="kobo.546.1">big responsibility.</span></span></p>
<p><span class="koboSpan" id="kobo.547.1">Let’s look at how to get better at </span><span class="No-Break"><span class="koboSpan" id="kobo.548.1">access control.</span></span></p>
<h3><span class="koboSpan" id="kobo.549.1">Denying Access by Default</span></h3>
<p><span class="koboSpan" id="kobo.550.1">When someone visits a site, consider </span><a id="_idIndexMarker207"/><span class="koboSpan" id="kobo.551.1">them anonymous and restricted from the administrative area. </span><span class="koboSpan" id="kobo.551.2">When an administrator adds someone to the system, they are now authenticated and should be able to log in to </span><span class="No-Break"><span class="koboSpan" id="kobo.552.1">the system.</span></span></p>
<p><span class="koboSpan" id="kobo.553.1">Your authorization system should be thoroughly tested. </span><span class="koboSpan" id="kobo.553.2">Even though a user is allowed to log in, they shouldn’t be able to do anything unless an administrator </span><span class="No-Break"><span class="koboSpan" id="kobo.554.1">authorizes them.</span></span></p>
<p><span class="koboSpan" id="kobo.555.1">“Deny by default” means that when a user uses the system, they should be denied access until permissions </span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">are granted.</span></span></p>
<p><span class="koboSpan" id="kobo.557.1">For Razor Pages, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.558.1">.AddRazorPages()</span></strong><span class="koboSpan" id="kobo.559.1"> Middleware component configuration to authorize certain pages and folders, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.560.1">code snippet:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.561.1">
services.AddRazorPages(options =&gt;
{
    options.Conventions.AuthorizeAreaFolder("Admin", "/Areas/Admin");
    options.Conventions.AllowAnonymousToFolder("/");
});</span></pre> <p><span class="koboSpan" id="kobo.562.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.563.1">AddRazorPages</span></strong><span class="koboSpan" id="kobo.564.1"> method, we are only allowing authenticated users into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">Admin</span></strong><span class="koboSpan" id="kobo.566.1"> area; anonymous users can only go to the root of </span><span class="No-Break"><span class="koboSpan" id="kobo.567.1">the website.</span></span></p>
<p><span class="koboSpan" id="kobo.568.1">For controller-based pages such as ASP.NET MVC, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">[Authorize]</span></strong><span class="koboSpan" id="kobo.570.1"> attribute to allow authenticated users to view the page, as </span><span class="No-Break"><span class="koboSpan" id="kobo.571.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.572.1">
[Authorize]
public class MySecretController : Controller
{
    public ActionResult Index()
    {
    }
}</span></pre> <p><span class="koboSpan" id="kobo.573.1">In the preceding code, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">Index</span></strong><span class="koboSpan" id="kobo.575.1"> page isn’t available to the authenticated user because the </span><strong class="source-inline"><span class="koboSpan" id="kobo.576.1">[Authorize]</span></strong><span class="koboSpan" id="kobo.577.1"> attribute is </span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">on </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.579.1">MySecretController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.581.1">If you only </span><a id="_idIndexMarker208"/><span class="koboSpan" id="kobo.582.1">want the </span><strong class="source-inline"><span class="koboSpan" id="kobo.583.1">Index</span></strong><span class="koboSpan" id="kobo.584.1"> page to be available to authenticated users, put the </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">[Authorize]</span></strong><span class="koboSpan" id="kobo.586.1"> attribute on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">Index()</span></strong><span class="koboSpan" id="kobo.588.1"> method, as </span><span class="No-Break"><span class="koboSpan" id="kobo.589.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.590.1">
[Authorize]
public ActionResult Index()
{
}</span></pre> <p><span class="koboSpan" id="kobo.591.1">These techniques deny anonymous users by default, which should be the </span><span class="No-Break"><span class="koboSpan" id="kobo.592.1">proper approach.</span></span></p>
<h3><span class="koboSpan" id="kobo.593.1">Avoid Exposing Keys</span></h3>
<p><span class="koboSpan" id="kobo.594.1">When you’re </span><a id="_idIndexMarker209"/><span class="koboSpan" id="kobo.595.1">building a blog, it’s best to have a URL without a post ID as an integer. </span><span class="koboSpan" id="kobo.595.2">When I’ve written blog posts, I’ve seen hits on my page before the page was public. </span><span class="koboSpan" id="kobo.595.3">It was great to see people were interested in looking at my latest post, but how were they getting to it? </span><span class="koboSpan" id="kobo.595.4">They would go to my blog, pull up the latest post, and add </span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">1</span></strong><span class="koboSpan" id="kobo.597.1"> to the post ID. </span><span class="koboSpan" id="kobo.597.2">There it was – an unfinished post in all its </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">unfinished glory.</span></span></p>
<p><span class="koboSpan" id="kobo.599.1">Imagine this type of scenario on a bank website. </span><span class="koboSpan" id="kobo.599.2">A user logs in to their account and they see the following </span><span class="No-Break"><span class="koboSpan" id="kobo.600.1">URL: </span></span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">https://www.bobsbank.com/view/accountid=511324</span></span><span class="No-Break"><span class="koboSpan" id="kobo.602.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.603.1">A curious user could add </span><strong class="source-inline"><span class="koboSpan" id="kobo.604.1">1</span></strong><span class="koboSpan" id="kobo.605.1"> to the account ID and view another </span><span class="No-Break"><span class="koboSpan" id="kobo.606.1">person’s account.</span></span></p>
<p><span class="koboSpan" id="kobo.607.1">Avoid </span><a id="_idIndexMarker210"/><span class="koboSpan" id="kobo.608.1">exposing accounts or primary keys to users and, if a user does guess an account number, confirm the authenticated user is the owner of their account before </span><span class="No-Break"><span class="koboSpan" id="kobo.609.1">viewing it.</span></span></p>
<h3><span class="koboSpan" id="kobo.610.1">Final Notes on Broken Access Controls</span></h3>
<p><span class="koboSpan" id="kobo.611.1">Here are some </span><a id="_idIndexMarker211"/><span class="koboSpan" id="kobo.612.1">other things you </span><span class="No-Break"><span class="koboSpan" id="kobo.613.1">should consider:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.614.1">Audit trails and logs are gold. </span><span class="koboSpan" id="kobo.614.2">They will help you identify risks and patterns </span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">with users.</span></span></li>
<li><span class="koboSpan" id="kobo.616.1">Confirm your authorization system works by running unit tests and integration tests. </span><span class="koboSpan" id="kobo.616.2">We’ll cover unit and integration tests in a </span><span class="No-Break"><span class="koboSpan" id="kobo.617.1">later chapter.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.618.1">In this section, we learned how to protect ourselves from broken access controls by denying users by default, hiding primary keys, and protecting certain pages by confirming users are allowed to view that page, as well as how to implement audit trails and logs and battle-test our </span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">authorization system.</span></span></p>
<p><span class="koboSpan" id="kobo.620.1">In this next section, we’ll look at how to protect against </span><span class="No-Break"><span class="koboSpan" id="kobo.621.1">cryptographic failures.</span></span></p>
<h2 id="_idParaDest-104"><a id="_idTextAnchor111"/><span class="koboSpan" id="kobo.622.1">Cryptographic Failures</span></h2>
<p><span class="koboSpan" id="kobo.623.1">OWASP </span><a id="_idIndexMarker212"/><span class="koboSpan" id="kobo.624.1">considers cryptographic failures as sensitive data that is unencrypted, failed security measures that use invalid access control, and even stale server environments, such as servers that don’t contain the latest security patches. </span><span class="koboSpan" id="kobo.624.2">This includes using industry-proven encryption algorithms which are already included in </span><span class="No-Break"><span class="koboSpan" id="kobo.625.1">Microsoft Entra.</span></span></p>
<p><span class="koboSpan" id="kobo.626.1">The following sections detail more common incidents in </span><span class="No-Break"><span class="koboSpan" id="kobo.627.1">the industry.</span></span></p>
<h3><span class="koboSpan" id="kobo.628.1">Transmitting Clear Text</span></h3>
<p><span class="koboSpan" id="kobo.629.1">If you are transmitting </span><a id="_idIndexMarker213"/><span class="koboSpan" id="kobo.630.1">sensitive data across the wire, it should be encrypted by using an </span><span class="No-Break"><span class="koboSpan" id="kobo.631.1">SSL connection.</span></span></p>
<p><span class="koboSpan" id="kobo.632.1">A general rule of thumb is that the client should be the one sending sensitive data to the server, not the other </span><span class="No-Break"><span class="koboSpan" id="kobo.633.1">way around.</span></span></p>
<p><span class="koboSpan" id="kobo.634.1">If you need to send sensitive data back to the client for approval, it’s best to mask the data somehow for display purposes (for example, using XXXX-XXXX-XXXX-9999 for credit cards) and, when updated, confirm this by having the authenticated user re-enter their password or </span><a id="_idIndexMarker214"/><span class="koboSpan" id="kobo.635.1">providing some way to authenticate </span><span class="No-Break"><span class="koboSpan" id="kobo.636.1">them again.</span></span></p>
<h3><span class="koboSpan" id="kobo.637.1">Invalid/Expired SSL Certificates</span></h3>
<p><span class="koboSpan" id="kobo.638.1">Once your code gets to a </span><a id="_idIndexMarker215"/><span class="koboSpan" id="kobo.639.1">server, its primary job is to deliver the data as fast and as securely </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">as possible.</span></span></p>
<p><span class="koboSpan" id="kobo.641.1">Certificates are required for SSL to create secure connections that have an expiration date. </span><span class="koboSpan" id="kobo.641.2">There should be some reminder or notification letting administrators know when a certificate expires. </span><span class="koboSpan" id="kobo.641.3">It’s not recommended to continue using an expired certificate on </span><span class="No-Break"><span class="koboSpan" id="kobo.642.1">your site.</span></span></p>
<h3><span class="koboSpan" id="kobo.643.1">Unencrypted Database</span></h3>
<p><span class="koboSpan" id="kobo.644.1">Again, if your database contains</span><a id="_idIndexMarker216"/><span class="koboSpan" id="kobo.645.1"> sensitive information, it’s best to be proactive and encrypt the database using the database’s recommended </span><span class="No-Break"><span class="koboSpan" id="kobo.646.1">encryption method.</span></span></p>
<h3><span class="koboSpan" id="kobo.647.1">Final Notes on Cryptographic Failures</span></h3>
<p><span class="koboSpan" id="kobo.648.1">Let’s look at some </span><a id="_idIndexMarker217"/><span class="No-Break"><span class="koboSpan" id="kobo.649.1">final notes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.650.1">Avoid weak algorithms such as MD5, SHA1, or PKCS number 1 v1.5, which are easy algorithms </span><span class="No-Break"><span class="koboSpan" id="kobo.651.1">to break.</span></span></li>
<li><span class="koboSpan" id="kobo.652.1">Avoid sending sensitive data to the client. </span><span class="koboSpan" id="kobo.652.2">If this is necessary, mask </span><span class="No-Break"><span class="koboSpan" id="kobo.653.1">the data.</span></span></li>
<li><span class="koboSpan" id="kobo.654.1">Use proper access key management, storing keys in safe locations such as Microsoft’s Key Vault, Google’s Cloud Key Management, or Amazon’s Key </span><span class="No-Break"><span class="koboSpan" id="kobo.655.1">Management Service.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.656.1">In this section, we learned how to avoid cryptographic failures by avoiding sending clear text, updating stale or invalid SSL certificates, and always encrypting the database if it contains </span><span class="No-Break"><span class="koboSpan" id="kobo.657.1">sensitive data.</span></span></p>
<p><span class="koboSpan" id="kobo.658.1">In the final section, we’ll look at how injection can impact </span><span class="No-Break"><span class="koboSpan" id="kobo.659.1">your application.</span></span></p>
<h2 id="_idParaDest-105"><a id="_idTextAnchor112"/><span class="koboSpan" id="kobo.660.1">Injection</span></h2>
<p><span class="koboSpan" id="kobo.661.1">In 2017, OWASP reported </span><a id="_idIndexMarker218"/><span class="koboSpan" id="kobo.662.1">SQL injection was the top threat when writing code for the web. </span><span class="koboSpan" id="kobo.662.2">Now, their Top 10 includes simply “injection,” which is an umbrella term covering SQL injection and XSS </span><span class="No-Break"><span class="koboSpan" id="kobo.663.1">as well.</span></span></p>
<h3><span class="koboSpan" id="kobo.664.1">SQL Injection</span></h3>
<p><span class="koboSpan" id="kobo.665.1">We already mentioned that </span><a id="_idIndexMarker219"/><span class="koboSpan" id="kobo.666.1">you should never trust the </span><a id="_idIndexMarker220"/><span class="koboSpan" id="kobo.667.1">client and always sanitize and encode user input, but it bears repeating since it is still considered a threat, even if it did move down two spots to </span><span class="No-Break"><span class="koboSpan" id="kobo.668.1">number three.</span></span></p>
<p><span class="koboSpan" id="kobo.669.1">The great news is that Entity Framework Core supports parameterized queries to help you avoid SQL injection. </span><span class="koboSpan" id="kobo.669.2">However, this feature doesn’t mean you don’t have to sanitize input </span><span class="No-Break"><span class="koboSpan" id="kobo.670.1">from users.</span></span></p>
<h3><span class="koboSpan" id="kobo.671.1">Script Injection</span></h3>
<p><span class="koboSpan" id="kobo.672.1">Script injection is when someone</span><a id="_idIndexMarker221"/><span class="koboSpan" id="kobo.673.1"> enters a script tag in a text box and the value is</span><a id="_idIndexMarker222"/><span class="koboSpan" id="kobo.674.1"> accepted and saved in the database. </span><span class="koboSpan" id="kobo.674.2">When the data is displayed on the page, the script is triggered and performs a </span><span class="No-Break"><span class="koboSpan" id="kobo.675.1">particular action.</span></span></p>
<p><span class="koboSpan" id="kobo.676.1">Here is a simple extension method that searches for and destroys malicious tags from HTML </span><span class="No-Break"><span class="koboSpan" id="kobo.677.1">using regex:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.678.1">
public static class StringExtensions
{
    public static string Sanitize(this string content)
    {
        // Replace the malicious tags with nothing.
</span><span class="koboSpan" id="kobo.678.2">        var maliciousTagsPattern =
            @"&lt;(applet|embed|frameset|head|noframes|noscript|object|            form|select|option|script|style|title)(.*?)&gt;"+
            "((.|\n)*?)"+
            "&lt;/(applet|embed|frameset|head|noframes|noscript|object|            select|form|option|script|style|title)&gt;";
        var options = RegexOptions.IgnoreCase | RegexOptions.            Multiline;
        var regex = new Regex(maliciousTagsPattern, options);
        content = regex.Replace(content, @"");
        // Remove the Javascript function on the tags (i.e. </span><span class="koboSpan" id="kobo.678.3">           OnChange="Javascript:&lt;blah blah blah&gt;")
        var inlinePattern = @"&lt;[^&gt;]*=""javascript:[^""]*""[^&gt;]*&gt;";
        options = RegexOptions.IgnoreCase;
        var regex2 = new Regex(inlinePattern, options);
        return regex2.Replace(content, @"");
    }
}</span></pre> <p><span class="koboSpan" id="kobo.679.1">While this </span><strong class="source-inline"><span class="koboSpan" id="kobo.680.1">.Sanitize()</span></strong><span class="koboSpan" id="kobo.681.1"> extension method removes any malicious tags from a string, if you are passing in HTML-formatted text, it also removes any tag using any JavaScript events on</span><a id="_idIndexMarker223"/><span class="koboSpan" id="kobo.682.1"> tags (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.683.1">onclick='alert("gotcha");'</span></strong><span class="koboSpan" id="kobo.684.1">). </span><span class="koboSpan" id="kobo.684.2">It then returns the sanitized string </span><a id="_idIndexMarker224"/><span class="No-Break"><span class="koboSpan" id="kobo.685.1">for use.</span></span></p>
<p><span class="koboSpan" id="kobo.686.1">Use this extension method like any other extension method with </span><span class="No-Break"><span class="koboSpan" id="kobo.687.1">a string:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.688.1">
var sanitizedString = inputFromUser.Sanitize();</span></pre> <p><span class="koboSpan" id="kobo.689.1">You could even extend the method further so that it includes other safeguards, such as encoding the string before </span><span class="No-Break"><span class="koboSpan" id="kobo.690.1">returning it.</span></span></p>
<p><span class="koboSpan" id="kobo.691.1">Always validate, filter, and sanitize input from the user. </span><span class="koboSpan" id="kobo.691.2">No </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">matter what.</span></span></p>
<h3><span class="koboSpan" id="kobo.693.1">Final Notes on Injection</span></h3>
<p><span class="koboSpan" id="kobo.694.1">Here are some final </span><a id="_idIndexMarker225"/><span class="koboSpan" id="kobo.695.1">things you </span><span class="No-Break"><span class="koboSpan" id="kobo.696.1">should consider:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.697.1">The further you can keep users (and users with malicious intent) away from the database, </span><span class="No-Break"><span class="koboSpan" id="kobo.698.1">the better</span></span></li>
<li><span class="koboSpan" id="kobo.699.1">Confirm you have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.700.1">maxlength</span></strong><span class="koboSpan" id="kobo.701.1"> attribute on single-line inputs to minimize how many characters are acceptable and limit the ability to allow scripts in HTML </span><span class="No-Break"><span class="koboSpan" id="kobo.702.1">input</span></span><span class="No-Break"><a id="_idIndexMarker226"/></span><span class="No-Break"><span class="koboSpan" id="kobo.703.1"> fields</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.704.1">Injection continues to be a credible threat and has always been listed on OWASP’s Top </span><span class="No-Break"><span class="koboSpan" id="kobo.705.1">10 list.</span></span></p>
<h1 id="_idParaDest-106"><a id="_idTextAnchor113"/><span class="koboSpan" id="kobo.706.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.707.1">In this chapter, we learned how to safeguard our code by understanding what sensitive data is and how to secure it using authentication, authorization, and </span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">SSL-enabled connections.</span></span></p>
<p><span class="koboSpan" id="kobo.709.1">In the second part of this chapter, we reviewed some common standards in the industry, such as logging, keeping our frameworks and libraries up-to-date, and always redirecting to SSL-enabled sites. </span><span class="koboSpan" id="kobo.709.2">After that, we learned to never trust client data and that we should validate, filter, and sanitize it and always encode it, and not announce to the world what server and version we’re running by adding or removing security headers. </span><span class="koboSpan" id="kobo.709.3">We even created a reusable security </span><span class="No-Break"><span class="koboSpan" id="kobo.710.1">middleware component.</span></span></p>
<p><span class="koboSpan" id="kobo.711.1">We also touched on encrypting database columns with SQL Server and how it’s important to protect fields by being proactive, and why creating a custom encryption algorithm should be avoided.. </span><span class="koboSpan" id="kobo.711.2">We also learned how to avoid cross-site request forgery by using </span><span class="No-Break"><span class="koboSpan" id="kobo.712.1">anti-forgery tokens.</span></span></p>
<p><span class="koboSpan" id="kobo.713.1">Finally, we examined the top three threats as determined by the OWASP Foundation and how to properly protect ourselves from Broken Access Control, Cryptographic Failures, and Injection of </span><span class="No-Break"><span class="koboSpan" id="kobo.714.1">all types.</span></span></p>
<p><span class="koboSpan" id="kobo.715.1">In the next chapter, we’ll pick up the discussion of Entity Framework Core once more and learn how to optimize data access using Entity Framework Core by using some </span><span class="No-Break"><span class="koboSpan" id="kobo.716.1">intuitive techniques.</span></span></p>
</div>
</body></html>