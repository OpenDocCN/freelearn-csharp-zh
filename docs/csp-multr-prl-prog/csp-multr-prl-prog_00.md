# 前言

欢迎来到*C#多线程与并行编程*。本书将带您了解使用 C#编程语言和.NET Framework 执行多线程和并发编程的所有方法。我们将从描述并发和并行编程是什么、为什么它很重要以及何时应该实现它开始。然后，我们将介绍.NET Framework 提供的不同类以及在开发多线程应用程序时常用的不同设计模式。

大多数现代机器都配备了双核处理器。这意味着现在的计算机具有多任务处理的能力。使用多个核心意味着您的应用程序可以更快地处理数据，并对用户更加响应。然而，要完全利用这一点，您需要在应用程序中编写多线程代码。

这将带我们踏上从 BackgroundWorker 组件、Thread 类、Task Parallel Library 到 async 和 await 关键字的旅程。我们还将探讨常见的模式，如管道化、生产者-消费者模式和 IAsyncResult 接口。

使用.NET 提供的并发和并行类，您可以轻松编写强大的多线程应用程序。在.NET 的最新版本中，微软增加了 Task Parallel Library 和 async 关键字，使得并发编程功能比使用线程更容易。

本书将涵盖使用.NET 最新版本开发多线程应用程序的所有方面。

# 本书涵盖的内容

第一章，*理解多处理和多核心*，涵盖了计算机硬件从单处理器系统到多处理器和多核心系统的演变。它还将讨论 Windows 调度器如何分配时间给线程。然后，本章将讨论并发的设计考虑因素，如何利用多处理器/多核心系统，以及这些设计可以实现预期的性能改进。在本章中，我们将通过一个简单的单线程示例和一个多线程示例来展示性能是如何得到提升的。

第二章，*查看多线程类 – BackgroundWorker*，使我们能够检查使用 BackgroundWorker 类进行多线程编程的基础。我们将通过一个 WPF 示例展示如何在后台处理的同时更新 UI。本章将讨论在多个进程之间协调工作的基础知识以及并发概念。

第三章, *Thread 类 – C#中的重量级并发*，使我们能够检查并使用 Thread 类和命名空间。我们将学习如何创建线程、在线程之间进行协调、在线程之间共享数据以及停止线程。本章将探讨重量级并发与轻量级并发的概念，这将在本书的后面部分进行详细解释。我们将专注于在应用程序中手动使用和协调多个线程。

第四章, *高级线程处理*，详细解释了重量级并发的概念以及使用 Thread 类进行多线程操作。本章将进一步扩展图像处理应用程序，演示如何通过避免死锁、锁定和错误处理来协调线程并等待线程完成。本章将使读者对如何开发多线程应用程序并完全控制其执行和交互有一个清晰的理解。

第五章"), *轻量级并发 – 任务并行库 (TPL)*，介绍了任务并行库以及 C#/.NET 中多线程编程的下一阶段进化。现在我们已经完全理解了如何开发、管理和控制多线程应用程序，我们将学习如何利用.NET 中的 Parallel 命名空间来为我们做很多繁重的工作。我们将通过利用.NET 现在提供的 Parallel 类来介绍轻量级并发的概念。这将使我们能够更多地关注设计高效且强大的应用程序，而较少关注协调单个线程。

第六章, *基于任务的并行性*，使我们能够检查任务并行库和任务并行性。任务是一组可以与其他任务并发运行的异步操作。我们将检查将应用程序设计为一系列可以并行执行的任务。通过示例，我们将演示如何创建、管理和协调任务。我们将进一步检查任务并行库和任务并行性的其他主题。我们将学习如何在运行多个任务时进行异常处理，如何在特定条件下调度任务，以及当需要时如何在任务完成之前取消正在运行的任务。

第七章，*数据并行*，探讨了数据并行的概念。我们将看到如何使用任务并行库（TPL）在集合的元素上并发执行相同的操作。Parallel 类有 For 和 ForEach 循环，我们将展示每个的示例来演示它们如何处理并发数据处理。我们将使用任务并行库而不是 Thread 类，将我们的图像处理应用程序从重量级转换为轻量级并发。

第八章，*使用 Visual Studio 调试多线程应用程序*，教我们如何充分利用 Visual Studio 2012 来调试我们的多线程应用程序。我们将演示使用线程视图、任务、并行堆栈和并行监视窗口。我们将以调试我们的图像处理应用程序结束。

第九章，*管道和生产者-消费者设计模式*，帮助我们探索两个最流行的并行开发模式——管道和生产者-消费者。在管道中，我们将看到如何完成一个简单的并行循环由于数据依赖性而无法工作的并行任务。生产者-消费者模式允许生产者（生成结果）与消费者一起运行，以便消费者可以并发地消费结果。我们将扩展我们的图像处理应用程序，以组合实现这两个模式。

第十章，*并行 LINQ – PLINQ*，详细介绍了并行 LINQ（PLINQ）提供的优势和功能。我们将看到 PLINQ 如何通过将数据源分割成部分并在每个部分上执行查询来加速传统的 LINQ。我们还将讨论适用于 PLINQ 的查询类型，因为并非所有查询使用 PLINQ 都会运行得更快。

第十一章，*异步编程模型*，解释了异步编程模型（APM），这是一个基于实现 IAsyncResult 接口的类的设计模式。我们将了解如何开始和结束异步操作，以及如何使用委托异步调用方法。本章还将涵盖新的 async 和 await 关键字，以及如何使用它们在自定义类中实现异步设计。

# 你需要为这本书准备什么

为了阅读这本书，你需要具备 C#、.NET 和 Visual Studio 的实际操作知识，以及学习.NET 提供的所有不同方法和技术以通过并行多线程技术提高应用程序性能的愿望。

# 本书面向对象

本书面向那些对 C#和.NET 框架有实际操作知识的开发者。我们假设你理解 C#编程的基础和 Visual Studio 开发环境的基本知识。

本书是为希望使用 .NET 中所有可用技术和方法来扩展他们的工具箱，并将现有代码转换为多线程和并发程序的开发者而编写的。如果您正在寻找使用当今的多 CPU 和多核处理器来提高应用程序性能和可伸缩性的方法，那么这本书就是为您而写的。

本书还专为那些了解 .NET 早期版本中使用的原始多线程技术，并希望使用 .NET 最新版本提供的新类（特别是任务并行库和 async 和 await 关键字）来更新他们的知识而设计。如果您需要使用当今最新的 .NET 并行技术来更新旧应用程序，那么这是一本很好的指南。

# 约定

在本书中，您将找到多种文本样式，用于区分不同类型的信息。以下是一些这些样式的示例及其含义的解释。

文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 处理程序如下所示：“这将要求我们与 `BackgroundWorker` 组件合作。”

代码块设置如下：

```cs
        private void setFishesVisibility(System.Windows.Visibility pbValue)
        {
            // Change the visibility of the controls 
            //related to the fishes game.
            imgFish1.Visibility = pbValue;
            imgFish2.Visibility = pbValue;
            imgFish3.Visibility = pbValue;
            txtFishGame.Visibility = pbValue;
            btnGameOver.Visibility = pbValue;
        }
```

**新术语**和**重要单词**以粗体显示。您在屏幕上看到的单词，例如在菜单或对话框中，在文本中显示如下：“在 Visual Studio 中创建一个新的 WPF 应用程序 C# 项目（**文件** | **新建** | **项目** | **Visual C#** | **WPF 应用程序**）。”

### 注意

警告或重要注意事项以如下框中的形式出现。

### 技巧

技巧和窍门看起来像这样。

# 读者反馈

我们始终欢迎读者的反馈。请告诉我们您对这本书的看法——您喜欢什么或可能不喜欢什么。读者反馈对我们开发您真正从中受益的标题非常重要。

要向我们发送一般反馈，只需发送一封电子邮件到 `<feedback@packtpub.com>`，并在邮件主题中提及书名。

如果您在某个主题上具有专业知识，并且您对撰写或为书籍做出贡献感兴趣，请参阅我们的作者指南[www.packtpub.com/authors](http://www.packtpub.com/authors)。

# 客户支持

现在，您已成为 Packt 书籍的骄傲拥有者，我们有一些事情可以帮助您从购买中获得最大收益。

## 下载示例代码

您可以从您在 [`www.packtpub.com`](http://www.packtpub.com) 的账户下载您购买的所有 Packt 书籍的示例代码文件。如果您在其他地方购买了这本书，您可以访问 [`www.packtpub.com/support`](http://www.packtpub.com/support) 并注册，以便将文件直接通过电子邮件发送给您。

## 错误清单

尽管我们已经尽一切努力确保内容的准确性，但错误仍然可能发生。如果你在我们的书中发现错误——可能是文本或代码中的错误——如果你能向我们报告这个问题，我们将不胜感激。通过这样做，你可以帮助其他读者避免挫败感，并帮助我们改进本书的后续版本。如果你发现任何勘误，请通过访问 [`www.packtpub.com/submit-errata`](http://www.packtpub.com/submit-errata)，选择你的书，点击 **勘误提交表单** 链接，并输入你的勘误详情。一旦你的勘误得到验证，你的提交将被接受，勘误将被上传到我们的网站或添加到该标题的勘误部分下的现有勘误列表中。

要查看之前提交的勘误表，请访问 [`www.packtpub.com/books/content/support`](https://www.packtpub.com/books/content/support)，并在搜索字段中输入书名。所需信息将在 **勘误** 部分显示。

## 盗版

在互联网上盗版版权材料是一个跨所有媒体持续存在的问题。在 Packt，我们非常重视保护我们的版权和许可证。如果你在互联网上发现任何形式的我们作品的非法副本，请立即提供位置地址或网站名称，以便我们可以寻求补救措施。

请通过 `<copyright@packtpub.com>` 联系我们，并提供涉嫌盗版材料的链接。

我们感谢你在保护我们作者和我们提供有价值内容的能力方面的帮助。

## 问题

如果你在本书的任何方面遇到问题，可以通过 `<questions@packtpub.com>` 联系我们，我们将尽力解决。
