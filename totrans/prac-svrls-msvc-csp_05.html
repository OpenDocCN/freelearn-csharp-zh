<html><head></head><body>
<div id="_idContainer128">
<h1 class="chapterNumber"><a id="_idTextAnchor122"/><span class="koboSpan" id="kobo.1.1">5</span></h1>
<h1 class="chapterTitle" id="_idParaDest-87"><a id="_idTextAnchor123"/><span class="koboSpan" id="kobo.2.1">Background Functions in Practice</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">When you start working with cloud computing, especially while working with </span><strong class="keyWord"><span class="koboSpan" id="kobo.4.1">Platform as a Service</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.6.1">PaaS</span></strong><span class="koboSpan" id="kobo.7.1">), one of the challenges you may encounter is how to enable background work if your solution is based on instances that require a request before processing. </span><span class="koboSpan" id="kobo.7.2">One of the answers to this problem is the use of serverless to process this background job. </span><span class="koboSpan" id="kobo.7.3">In Azure, you will find Azure Functions triggers that can help you with this.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.8.1">In this chapter, we will discuss three of them: the timer trigger, Blob storage trigger, and queue storage trigger. </span><span class="koboSpan" id="kobo.8.2">It is important to mention that we covered their basics in </span><a href="Chapter_1.xhtml#_idTextAnchor022"><em class="italic"><span class="koboSpan" id="kobo.9.1">Chapter 1</span></em></a><em class="italic"><span class="koboSpan" id="kobo.10.1">, Demystifying Serverless Applications</span></em><span class="koboSpan" id="kobo.11.1">, but we will start to implement them now.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.12.1">Together with their implementation, we will present an alternative to the publication of Azure Functions inside Visual Studio. </span><span class="koboSpan" id="kobo.12.2">We will also check how to monitor these functions. </span><span class="koboSpan" id="kobo.12.3">Understanding the advantages and disadvantages and when these functions are a good approach to be used will be discussed in the chapter. </span><span class="koboSpan" id="kobo.12.4">We will also see them working using the car-sharing example as a basis for understanding the purpose of each trigger better. </span><span class="koboSpan" id="kobo.12.5">Let’s go!</span></p>
<h1 class="heading-1" id="_idParaDest-88"><a id="_idTextAnchor124"/><span class="koboSpan" id="kobo.13.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.14.1">This chapter requires the Visual Studio 2022 free </span><em class="italic"><span class="koboSpan" id="kobo.15.1">Community edition </span></em><span class="koboSpan" id="kobo.16.1">or Visual Studio Code. </span><span class="koboSpan" id="kobo.16.2">You will also need an Azure account to create the sample environment. </span><span class="koboSpan" id="kobo.16.3">You can find the sample code for this chapter at </span><a href="https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp"><span class="url"><span class="koboSpan" id="kobo.17.1">https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp</span></span></a><span class="koboSpan" id="kobo.18.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-89"><a id="_idTextAnchor125"/><span class="koboSpan" id="kobo.19.1">Timer trigger</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.20.1">It is not uncommon to need to</span><a id="_idIndexMarker276"/><span class="koboSpan" id="kobo.21.1"> process a task from time to time, at a specific moment of the day. </span><span class="koboSpan" id="kobo.21.2">A timer trigger will certainly help you with this. </span><span class="koboSpan" id="kobo.21.3">This function is based on the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.22.1">NCRONTAB</span></code><span class="koboSpan" id="kobo.23.1"> expression, which is like a </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.24.1">CRON</span></code><span class="koboSpan" id="kobo.25.1"> expression:</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.26.1">{second} {minute} {hour} {day} {month} {day-of-week}</span></code></p>
<p class="normal"><span class="koboSpan" id="kobo.27.1">If you consider this expression, you will be able to schedule different moments to trigger the function. </span><span class="koboSpan" id="kobo.27.2">Let’s check the following table to understand it better: </span></p>
<table class="table-container" id="table001">
<tbody>
<tr>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.28.1">Second</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.29.1">Minute</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.30.1">Hour</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.31.1">Day</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.32.1">Month</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.33.1">Day of the Week</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.34.1">Result</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.35.1">Meaning</span></strong></p>
</th>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.36.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.37.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.38.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.39.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.40.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.41.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.42.1">* * * * * *</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.43.1">Every second</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.44.1">0</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.45.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.46.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.47.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.48.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.49.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.50.1">0 * * * * *</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.51.1">Every minute</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.52.1">*/5</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.53.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.54.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.55.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.56.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.57.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.58.1">*/5 * * * * *</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.59.1">Every five seconds</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.60.1">0</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.61.1">0</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.62.1">1</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.63.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.64.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.65.1">1-5</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.66.1">0 0 1 * * 1-5</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.67.1">At 1:00 AM, from Monday to Friday</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.68.1">5,10,20 </span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.69.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.70.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.71.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.72.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.73.1">*</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.74.1">5,10,20 * * * * *</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.75.1">At 5, 10, and 20 seconds past the minute</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="koboSpan" id="kobo.76.1">There are some important tips related to the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.77.1">NCRONTAB</span></code><span class="koboSpan" id="kobo.78.1"> expression. </span><span class="koboSpan" id="kobo.78.2">First, you may consider days of the week from Sunday (</span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.79.1">0</span></code><span class="koboSpan" id="kobo.80.1">) to Saturday (</span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.81.1">6</span></code><span class="koboSpan" id="kobo.82.1">). </span><span class="koboSpan" id="kobo.82.2">The </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.83.1">*</span></code><span class="koboSpan" id="kobo.84.1"> operator represents all values at the moment defined, while </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.85.1">-</span></code><span class="koboSpan" id="kobo.86.1"> is the range operator. </span><span class="koboSpan" id="kobo.86.2">If you want to express an interval, you may use the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.87.1">/</span></code><span class="koboSpan" id="kobo.88.1"> operator, and if you want to </span><a id="_idIndexMarker277"/><span class="koboSpan" id="kobo.89.1">define a set of values, the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.90.1">,</span></code><span class="koboSpan" id="kobo.91.1"> operator must be used.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.92.1">The following code is an example of a timer trigger and the way you define its schedule:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.93.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.94.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.95.1">SampleFunction</span></span><span class="koboSpan" id="kobo.96.1">
{
  private readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.97.1">ILogger</span></span><span class="koboSpan" id="kobo.98.1"> _logger;
  public </span><span class="hljs-title"><span class="koboSpan" id="kobo.99.1">SampleFunction</span></span><span class="koboSpan" id="kobo.100.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.101.1">ILoggerFactory</span></span><span class="koboSpan" id="kobo.102.1"> loggerFactory)
  {
    _logger = loggerFactory.</span><span class="hljs-property"><span class="koboSpan" id="kobo.103.1">CreateLogger</span></span><span class="koboSpan" id="kobo.104.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.105.1">SampleFunction</span></span><span class="koboSpan" id="kobo.106.1">&gt;();
  }
  [</span><span class="hljs-title"><span class="koboSpan" id="kobo.107.1">Function</span></span><span class="koboSpan" id="kobo.108.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.109.1">“SampleFunction”</span></span><span class="koboSpan" id="kobo.110.1">)]
  public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.111.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.112.1">Run</span></span><span class="koboSpan" id="kobo.113.1">([</span><span class="hljs-title"><span class="koboSpan" id="kobo.114.1">TimerTrigger</span></span><span class="koboSpan" id="kobo.115.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.116.1">“*/5 * * * * *”</span></span><span class="koboSpan" id="kobo.117.1">)] </span><span class="hljs-title"><span class="koboSpan" id="kobo.118.1">TimerInfo</span></span><span class="koboSpan" id="kobo.119.1"> myTimer)
  {
    _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.120.1">LogInformation</span></span><span class="koboSpan" id="kobo.121.1">($</span><span class="hljs-string"><span class="koboSpan" id="kobo.122.1">”C# Timer trigger function executed at:</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.123.1">                             {DateTime.Now}”</span></span><span class="koboSpan" id="kobo.124.1">);
   
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.125.1">if</span></span><span class="koboSpan" id="kobo.126.1"> (myTimer.</span><span class="hljs-property"><span class="koboSpan" id="kobo.127.1">ScheduleStatus</span></span><span class="koboSpan" id="kobo.128.1"> is not </span><span class="hljs-literal"><span class="koboSpan" id="kobo.129.1">null</span></span><span class="koboSpan" id="kobo.130.1">)
    {
      _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.131.1">LogInformation</span></span><span class="koboSpan" id="kobo.132.1">($</span><span class="hljs-string"><span class="koboSpan" id="kobo.133.1">”Next timer schedule at:</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.134.1">                              {myTimer.ScheduleStatus.Next}”</span></span><span class="koboSpan" id="kobo.135.1">);
    }
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.136.1">There are some websites where you can interpret the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.137.1">NCRONTAB</span></code><span class="koboSpan" id="kobo.138.1"> expression you have designed. </span><span class="koboSpan" id="kobo.138.2">You can check this out at https://crontab.cronhub.io/.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.139.1">The following figure shows the result of the preceding timer trigger code.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.140.1"><img alt="Figure 5.1: Timer trigger function in execution" src="../Images/B31916_05_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.141.1">Figure 5.1: Timer trigger function in execution</span></p>
<p class="normal"><span class="koboSpan" id="kobo.142.1">This flexibility enables you to define a solid structure of jobs to run your microservices. </span><span class="koboSpan" id="kobo.142.2">On the other hand, if you want to debug </span><a id="_idIndexMarker278"/><span class="koboSpan" id="kobo.143.1">a specific function, you may use the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.144.1">RunOnStartup</span></code><span class="koboSpan" id="kobo.145.1"> parameter set to </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.146.1">true</span></code><span class="koboSpan" id="kobo.147.1">. </span><span class="koboSpan" id="kobo.147.2">It is important to mention, though, that this parameter must not be used in production</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.148.1">There is a possibility to manually trigger non-HTTP functions. </span><span class="koboSpan" id="kobo.148.2">Please check this link to do so: </span><a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-manually-run-non-http"><span class="url"><span class="koboSpan" id="kobo.149.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-manually-run-non-http</span></span></a><span class="koboSpan" id="kobo.150.1">.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.151.1">Now you understand how timer trigger functions work, let’s check a way you can publish them using Visual Studio.</span></p>
<h1 class="heading-1" id="_idParaDest-90"><a id="_idTextAnchor126"/><span class="koboSpan" id="kobo.152.1">Publishing your functions</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.153.1">As you are developing your Azure functions in Visual Studio, it is useful to know that the IDE enables you to publish your</span><a id="_idIndexMarker279"/><span class="koboSpan" id="kobo.154.1"> code to Azure in small steps. </span><span class="koboSpan" id="kobo.154.2">Let’s check how to do so.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.155.1">The first step is to right-click the project you want to publish. </span><span class="koboSpan" id="kobo.155.2">As soon as you do this, you will find the </span><strong class="keyWord"><span class="koboSpan" id="kobo.156.1">Publish…</span></strong><span class="koboSpan" id="kobo.157.1"> action to start the process.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.158.1"><img alt="Figure 5.2: Publishing an Azure function project" src="../Images/B31916_05_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.159.1">Figure 5.2: Publishing an Azure function project</span></p>
<p class="normal"><span class="koboSpan" id="kobo.160.1">Once you decide to publish, you will be prompted to decide where to publish the function. </span><span class="koboSpan" id="kobo.160.2">Besides Azure, you might want to publish the function in a Docker container registry or a folder. </span><span class="koboSpan" id="kobo.160.3">You may also want to use a pre-made </span><a id="_idIndexMarker280"/><span class="koboSpan" id="kobo.161.1">profile, so there is also an option to import the profile. </span><span class="koboSpan" id="kobo.161.2">For this demo, the </span><strong class="keyWord"><span class="koboSpan" id="kobo.162.1">Azure</span></strong><span class="koboSpan" id="kobo.163.1"> option will be selected.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.164.1"><img alt="Figure 5.3: Publishing on Azure" src="../Images/B31916_05_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.165.1">Figure 5.3: Publishing on Azure</span></p>
<p class="normal"><span class="koboSpan" id="kobo.166.1">After the selection of </span><strong class="keyWord"><span class="koboSpan" id="kobo.167.1">Azure</span></strong><span class="koboSpan" id="kobo.168.1">, you need to decide where in Azure you will have your function running. </span><span class="koboSpan" id="kobo.168.2">As we saw in </span><a href="Chapter_1.xhtml#_idTextAnchor022"><em class="italic"><span class="koboSpan" id="kobo.169.1">Chapter 1</span></em></a><em class="italic"><span class="koboSpan" id="kobo.170.1">, Demystifying Serverless Applications</span></em><span class="koboSpan" id="kobo.171.1">, Azure functions can run in different operating systems and different container solutions. </span><span class="koboSpan" id="kobo.171.2">For this demo, we will select the Windows operating system.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.172.1"><img alt="Figure 5.4: Selecting Azure Function App for Windows" src="../Images/B31916_05_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.173.1">Figure 5.4: Selecting Azure Function App for Windows</span></p>
<p class="normal"><span class="koboSpan" id="kobo.174.1">After connecting Visual Studio</span><a id="_idIndexMarker281"/><span class="koboSpan" id="kobo.175.1"> to your Azure account, all the function instances available for deployment will be presented to you. </span><span class="koboSpan" id="kobo.175.2">However, if you don’t have any instances, you will also be given the opportunity to create a new instance, by selecting the </span><strong class="keyWord"><span class="koboSpan" id="kobo.176.1">Create new</span></strong><span class="koboSpan" id="kobo.177.1"> button.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.178.1"><img alt="Figure 5.5: Creating the Azure Function App on the Visual Studio interface" src="../Images/B31916_05_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.179.1">Figure 5.5: Creating the Azure Function App on the Visual Studio interface</span></p>
<p class="normal"><span class="koboSpan" id="kobo.180.1">The creation will take a few minutes, but then your Azure function can be published on Azure.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.181.1"><img alt="Figure 5.6: Azure Function App ready" src="../Images/B31916_05_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.182.1">Figure 5.6: Azure Function App ready</span></p>
<p class="normal"><span class="koboSpan" id="kobo.183.1">The current wizard </span><a id="_idIndexMarker282"/><span class="koboSpan" id="kobo.184.1">available in Visual Studio is very useful. </span><span class="koboSpan" id="kobo.184.2">It not only helps you publish in a single step but also creates a YML file for you, to be used together with GitHub Actions. </span><span class="koboSpan" id="kobo.184.3">For this demo, we will use the basic option that generates a </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.185.1">.pubxml</span></code><span class="koboSpan" id="kobo.186.1"> file, but you may consider GitHub Actions as the best opportunity for real-life scenarios.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.187.1"><img alt="Figure 5.7: Methods available for publishing" src="../Images/B31916_05_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.188.1">Figure 5.7: Methods available for publishing</span></p>
<p class="normal"><span class="koboSpan" id="kobo.189.1">Once you finish the </span><a id="_idIndexMarker283"/><span class="koboSpan" id="kobo.190.1">wizard, you will have the publishing profile ready to start publishing the application.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.191.1"><img alt="Figure 5.8: Publishing profiler" src="../Images/B31916_05_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.192.1">Figure 5.8: Publishing profiler</span></p>
<p class="normal"><span class="koboSpan" id="kobo.193.1">By clicking the </span><strong class="keyWord"><span class="koboSpan" id="kobo.194.1">Publish</span></strong><span class="koboSpan" id="kobo.195.1"> button, the </span><a id="_idIndexMarker284"/><span class="koboSpan" id="kobo.196.1">process will start running and, after a few moments, your Azure Function App will be published.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.197.1"><img alt="Figure 5.9: Function App published" src="../Images/B31916_05_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.198.1">Figure 5.9: Function App published</span></p>
<p class="normal"><span class="koboSpan" id="kobo.199.1">It is important to mention that </span><a id="_idIndexMarker285"/><span class="koboSpan" id="kobo.200.1">you will need to do this complete process only once. </span><span class="koboSpan" id="kobo.200.2">After that, the new deployments needed will be a lot easier.</span></p>
<h1 class="heading-1" id="_idParaDest-91"><a id="_idTextAnchor127"/><span class="koboSpan" id="kobo.201.1">Monitoring your functions</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.202.1">The process for deploying</span><a id="_idIndexMarker286"/><span class="koboSpan" id="kobo.203.1"> functions presented in the last section is not exclusive to timer trigger functions. </span><span class="koboSpan" id="kobo.203.2">The same happens when it comes to monitoring your functions. </span><span class="koboSpan" id="kobo.203.3">In Azure, there are some alternative ways to check whether your Azure function is running properly. </span><span class="koboSpan" id="kobo.203.4">Let’s explore them.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.204.1">The easiest way to monitor whether a function is running properly is by checking the number of invocations made by it. </span><span class="koboSpan" id="kobo.204.2">The </span><strong class="keyWord"><span class="koboSpan" id="kobo.205.1">Invocations</span></strong><span class="koboSpan" id="kobo.206.1"> tab is available in the Function App, and it will give you basic details about the execution.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.207.1"><img alt="Figure 5.10: Function invocations" src="../Images/B31916_05_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.208.1">Figure 5.10: Function invocations</span></p>
<p class="normal"><span class="koboSpan" id="kobo.209.1">However, you may want</span><a id="_idIndexMarker287"/><span class="koboSpan" id="kobo.210.1"> to obtain detailed information about each execution. </span><span class="koboSpan" id="kobo.210.2">In this case, the best option to get this kind of information is by accessing the logs retained by Azure Monitor.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.211.1"><img alt="Figure 5.11: Azure Monitor logs" src="../Images/B31916_05_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.212.1">Figure 5.11: Azure Monitor logs</span></p>
<p class="normal"><span class="koboSpan" id="kobo.213.1">Using Azure Monitor logs</span><a id="_idIndexMarker288"/><span class="koboSpan" id="kobo.214.1"> will result in a cost increase. </span><span class="koboSpan" id="kobo.214.2">Please check the best alternative for storing logs at </span><a href="https://docs.azure.cn/en-us/azure-monitor/logs/cost-logs"><span class="url"><span class="koboSpan" id="kobo.215.1">https://docs.azure.cn/en-us/azure-monitor/logs/cost-logs</span></span></a><span class="koboSpan" id="kobo.216.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.217.1">The logs stored by Azure Monitor will also give you two other views. </span><span class="koboSpan" id="kobo.217.2">The Application Insights </span><strong class="keyWord"><span class="koboSpan" id="kobo.218.1">Performance</span></strong><span class="koboSpan" id="kobo.219.1"> view helps you analyze performance and errors that may happen in the Azure functions you develop.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.220.1"><img alt="Figure 5.12: Application Insights Performance view" src="../Images/B31916_05_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.221.1">Figure 5.12: Application Insights Performance view</span></p>
<p class="normal"><span class="koboSpan" id="kobo.222.1">There is also a </span><strong class="keyWord"><span class="koboSpan" id="kobo.223.1">Live metrics</span></strong><span class="koboSpan" id="kobo.224.1"> view </span><a id="_idIndexMarker289"/><span class="koboSpan" id="kobo.225.1">of the function running, which may be useful for debugging or understanding behaviors in production.</span></p>
<figure class="mediaobject"> <span class="koboSpan" id="kobo.226.1"><img alt="Figure 5.13: Application Insights Live metrics view" src="../Images/B31916_05_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.227.1">Figure 5.13: Application Insights Live metrics view</span></p>
<p class="normal"><span class="koboSpan" id="kobo.228.1">These options make Azure Functions an excellent alternative for processing your background work, as the observability</span><a id="_idIndexMarker290"/><span class="koboSpan" id="kobo.229.1"> provided is very good.</span></p>
<h2 class="heading-2" id="_idParaDest-92"><a id="_idTextAnchor128"/><span class="koboSpan" id="kobo.230.1">Advantages, disadvantages, and when to use Azure timer triggers</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.231.1">As we saw before, Azure timer triggers provide a great way to execute functions at regular intervals without the need for manual intervention. </span><span class="koboSpan" id="kobo.231.2">Their simplicity in setup and configuration helps you create functions that will run regularly, such as data synchronization, cleanup operations, and scheduled reports.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.232.1">However, since the function will run</span><a id="_idIndexMarker291"/><span class="koboSpan" id="kobo.233.1"> exactly when you schedule it, if there is no job to be done at that moment, this execution will result in resource wastage, which basically means </span><a id="_idIndexMarker292"/><span class="koboSpan" id="kobo.234.1">spending money unnecessarily. </span><span class="koboSpan" id="kobo.234.2">So, you must properly define the execution of the timer trigger function.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.235.1">Based on the preceding information, scheduled actions that cannot depend on human manual intervention, such as backups, routine maintenance tasks, and periodic data processing, are great use cases for this kind of function. </span><span class="koboSpan" id="kobo.235.2">Even though it is important to define a way to monitor and report these executions, you can still make the most of this option.</span></p>
<h2 class="heading-2" id="_idParaDest-93"><a id="_idTextAnchor129"/><span class="koboSpan" id="kobo.236.1">Car-sharing timer trigger example</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.237.1">The car-sharing solution is an event-driven application. </span><span class="koboSpan" id="kobo.237.2">This means that there is no need for a timer trigger for this application </span><a id="_idIndexMarker293"/><span class="koboSpan" id="kobo.238.1">when it comes to its basic flow of work. </span><span class="koboSpan" id="kobo.238.2">However, let’s imagine a routine for processing billing. </span><span class="koboSpan" id="kobo.238.3">Considering the business rules of this company, there is no way to process bills on Sundays, and considering the cash flow on the other days, the billing can be processed once an hour.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.239.1">Based on this scenario, a timer trigger function can be a great choice to solve this problem, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.240.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.241.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.242.1">ProcessBilling</span></span><span class="koboSpan" id="kobo.243.1">
{
  private readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.244.1">ILogger</span></span><span class="koboSpan" id="kobo.245.1"> _logger;
  public </span><span class="hljs-title"><span class="koboSpan" id="kobo.246.1">ProcessBilling</span></span><span class="koboSpan" id="kobo.247.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.248.1">ILoggerFactory</span></span><span class="koboSpan" id="kobo.249.1"> loggerFactory)
  {
    _logger = loggerFactory.</span><span class="hljs-property"><span class="koboSpan" id="kobo.250.1">CreateLogger</span></span><span class="koboSpan" id="kobo.251.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.252.1">ProcessBilling</span></span><span class="koboSpan" id="kobo.253.1">&gt;();
  }
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.254.1">/// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.255.1">/// Every hour, between 08:00 AM and 05:59 PM, Monday through Saturday</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.256.1">/// &lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.257.1">/// &lt;param name=”myTimer”&gt;&lt;/param&gt;</span></span><span class="koboSpan" id="kobo.258.1">
  [</span><span class="hljs-title"><span class="koboSpan" id="kobo.259.1">Function</span></span><span class="koboSpan" id="kobo.260.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.261.1">“ProcessBilling”</span></span><span class="koboSpan" id="kobo.262.1">)]
  public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.263.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.264.1">Run</span></span><span class="koboSpan" id="kobo.265.1">([</span><span class="hljs-title"><span class="koboSpan" id="kobo.266.1">TimerTrigger</span></span><span class="koboSpan" id="kobo.267.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.268.1">“0 0 8-17 * * 1-6”</span></span><span class="koboSpan" id="kobo.269.1">)] </span><span class="hljs-title"><span class="koboSpan" id="kobo.270.1">TimerInfo</span></span><span class="koboSpan" id="kobo.271.1"> myTimer)
  {
    _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.272.1">LogInformation</span></span><span class="koboSpan" id="kobo.273.1">($</span><span class="hljs-string"><span class="koboSpan" id="kobo.274.1">”Time to process billing!”</span></span><span class="koboSpan" id="kobo.275.1">);
    _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.276.1">LogInformation</span></span><span class="koboSpan" id="kobo.277.1">($</span><span class="hljs-string"><span class="koboSpan" id="kobo.278.1">”Execution started at: {DateTime.Now}.”</span></span><span class="koboSpan" id="kobo.279.1">);
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.280.1">// TODO - Code for processing billing</span></span><span class="koboSpan" id="kobo.281.1">
    _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.282.1">LogInformation</span></span><span class="koboSpan" id="kobo.283.1">($</span><span class="hljs-string"><span class="koboSpan" id="kobo.284.1">”Process billing done: {DateTime.Now}.”</span></span><span class="koboSpan" id="kobo.285.1">);
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.286.1">Notice that no matter whether you have billing to process or not, the execution of the function will happen every single hour, between </span><a id="_idIndexMarker294"/><span class="koboSpan" id="kobo.287.1">8:00 AM and 5:59 PM, from Monday through Saturday. </span><span class="koboSpan" id="kobo.287.2">It is important to mention that Azure Functions will respect UTC time, so you should consider your location when defining the correct </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.288.1">CRON</span></code><span class="koboSpan" id="kobo.289.1"> expression to be used.</span></p>
<h1 class="heading-1" id="_idParaDest-94"><a id="_idTextAnchor130"/><span class="koboSpan" id="kobo.290.1">Blob trigger</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.291.1">Azure Blob Storage is a service provided </span><a id="_idIndexMarker295"/><span class="koboSpan" id="kobo.292.1">by Microsoft Azure for storing large amounts of unstructured data, such as images, videos, logs, and backups. </span><span class="koboSpan" id="kobo.292.2">It is optimized for storing binary data in a highly scalable and cost-effective </span><a id="_idIndexMarker296"/><span class="koboSpan" id="kobo.293.1">way. </span><strong class="keyWord"><span class="koboSpan" id="kobo.294.1">Blob</span></strong><span class="koboSpan" id="kobo.295.1"> stands for </span><strong class="keyWord"><span class="koboSpan" id="kobo.296.1">Binary Large Object</span></strong><span class="koboSpan" id="kobo.297.1">, highlighting its ability to handle massive volumes of data efficiently, making it an ideal solution for applications that require durable, scalable storage.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.298.1">The great thing about this service is that it is highly scalable, secure, and accessible from anywhere in the world via HTTP or HTTPS. </span><span class="koboSpan" id="kobo.298.2">Also, it enables integration with other Azure services, such as Azure Functions. </span><span class="koboSpan" id="kobo.298.3">This connector enables a variety of possible solutions for automating processes since it is possible to execute a function for each change made in a specific blob storage.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.299.1">The focus of this book is not to </span><a id="_idIndexMarker297"/><span class="koboSpan" id="kobo.300.1">go further into Blob Storage options, but it is useful to know that the service provides different access tiers, such as hot, cool, and archive, which vary according to access needs, each with its own pricing.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.301.1">When you start creating a Blob storage trigger function, one of the things that you will be asked to define is where the storage will run. </span><span class="koboSpan" id="kobo.301.2">For debugging, you will have the possibility to use </span><strong class="keyWord"><span class="koboSpan" id="kobo.302.1">Storage Azurite emulator</span></strong><span class="koboSpan" id="kobo.303.1">, which is a</span><a id="_idIndexMarker298"/><span class="koboSpan" id="kobo.304.1"> local emulator for Azure Storage. </span><span class="koboSpan" id="kobo.304.2">Azurite is available with Visual Studio. </span><span class="koboSpan" id="kobo.304.3">Based on your edition of Vision Studio, it will be placed in a specific folder. </span><span class="koboSpan" id="kobo.304.4">After you find the executable, you may run it using Admin access.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.305.1"><img alt="Figure 5.14: Azurite execution" src="../Images/B31916_05_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.306.1">Figure 5.14: Azurite execution</span></p>
<p class="normal"><span class="koboSpan" id="kobo.307.1">Another important tool to be used while creating Blob storage trigger functions is Microsoft Azure Storage Explorer. </span><span class="koboSpan" id="kobo.307.2">With these two tools, the process of creating Blob storage trigger functions will be very easy. </span><span class="koboSpan" id="kobo.307.3">The following figure shows how Visual Studio enables you to select Azurite as the default emulator for your project.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.308.1"><img alt="Figure 5.15: Connecting a Blob storage trigger to Azure" src="../Images/B31916_05_15.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.309.1">Figure 5.15: Connecting a Blob storage trigger to Azure</span></p>
<h2 class="heading-2" id="_idParaDest-95"><a id="_idTextAnchor131"/><span class="koboSpan" id="kobo.310.1">Advantages, disadvantages, and when to use Blob storage triggers</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.311.1">When it comes to advantages</span><a id="_idIndexMarker299"/><span class="koboSpan" id="kobo.312.1"> regarding the usage of Blob storage triggers, the possibility of handling large volumes of data</span><a id="_idIndexMarker300"/><span class="koboSpan" id="kobo.313.1"> efficiently can surely be mentioned. </span><span class="koboSpan" id="kobo.313.2">Besides that, the possibility to scale the processing no matter the number of incoming triggers is also a good reason why you should consider this kind of trigger to process data.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.314.1">On the other hand, pricing can be a problem since, in some cases, the pricing model is based on the number of executions and the amount of data processed, so do not forget to analyze the best way to allocate this kind of Azure function.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.315.1">It is also important to mention that, depending on the app plan you have defined for the Azure function, you may experience some delay between the uploading or updating of the file and the function processing. </span><span class="koboSpan" id="kobo.315.2">To avoid it, you may</span><a id="_idIndexMarker301"/><span class="koboSpan" id="kobo.316.1"> consider an App Service plan with Always On enabled, although this will obviously</span><a id="_idIndexMarker302"/><span class="koboSpan" id="kobo.317.1"> increase the cost of the solution. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.318.1">To finish, it is important to mention that the initial Blob storage trigger function implementation was based on pooling. </span><span class="koboSpan" id="kobo.318.2">Pooling refers to a periodic scan of the entire container, typically processing up to 10,000 blobs per batch. </span><span class="koboSpan" id="kobo.318.3">In this approach, each file has up to five retry attempts by default. </span><span class="koboSpan" id="kobo.318.4">If all retries fail, the function creates a poison message and moves it to the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.319.1">webjobs-blobtrigger-poison</span></code><span class="koboSpan" id="kobo.320.1"> queue. </span><span class="koboSpan" id="kobo.320.2">To avoid such scenarios and improve reliability, you can implement a Blob storage trigger using Event Grid instead. </span><span class="koboSpan" id="kobo.320.3">We will cover this in the next section.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.321.1">Based on this information, you can use a Blob storage trigger in applications where you have software requirements such as image processing, data analysis, and real-time or batch processing. </span><span class="koboSpan" id="kobo.321.2">In this kind of application, you generally need to react quickly and automatically to new or updated blobs. </span><span class="koboSpan" id="kobo.321.3">In these cases, the scalability and adaptability of Azure Functions will help you meet your demands.</span></p>
<h1 class="heading-1" id="_idParaDest-96"><a id="_idTextAnchor132"/><span class="koboSpan" id="kobo.322.1">Blob trigger implementation using Event Grid</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.323.1">The idea behind using </span><a id="_idIndexMarker303"/><span class="koboSpan" id="kobo.324.1">Event Grid to implement Blob trigger events is to reduce latency. </span><span class="koboSpan" id="kobo.324.2">Besides, if you decide to define your functions using the Flex Consumption plan, this is the only option you will have.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.325.1">To do so, while creating the function, select the </span><strong class="keyWord"><span class="koboSpan" id="kobo.326.1">Blob Trigger (using Event Grid)</span></strong><span class="koboSpan" id="kobo.327.1"> option. </span><span class="koboSpan" id="kobo.327.2">With this option, Visual Studio will create a different code for the Azure function.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.328.1"><img alt="Figure 5.16: Creating a Blob trigger function using Event Grid" src="../Images/B31916_05_16.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.329.1">Figure 5.16: Creating a Blob trigger function using Event Grid</span></p>
<p class="normal"><span class="koboSpan" id="kobo.330.1">It is important to mention that this </span><a id="_idIndexMarker304"/><span class="koboSpan" id="kobo.331.1">function will run better on Azure than locally. </span><span class="koboSpan" id="kobo.331.2">For this, you need to create a </span><strong class="keyWord"><span class="koboSpan" id="kobo.332.1">general-purpose v2 </span></strong><span class="koboSpan" id="kobo.333.1">storage account, which is mandatory for the event subscription.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.334.1"><img alt="Figure 5.17: Review of the creation of the storage account" src="../Images/B31916_05_17.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.335.1">Figure 5.17: Review of the creation of the storage account</span></p>
<p class="normal"><span class="koboSpan" id="kobo.336.1">In the same way that we have the prerequisite for Azure Storage, the function app for running this kind of trigger should</span><a id="_idIndexMarker305"/><span class="koboSpan" id="kobo.337.1"> consider using the Flex Consumption plan, as we can see in the following figure. </span><span class="koboSpan" id="kobo.337.2">The advantage of this Consumption plan, according to Microsoft, is that it reduces cold starts with always-ready instances, supports VNets, and scales automatically, even in high load periods. </span><span class="koboSpan" id="kobo.337.3">On the other hand, at the time of writing this book, this option was not available in all regions.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.338.1"><img alt="Figure 5.18: Flex Consumption plan" src="../Images/B31916_05_18.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.339.1">Figure 5.18: Flex Consumption plan</span></p>
<p class="normal"><span class="koboSpan" id="kobo.340.1">After the creation of the Azure function app, you may use the steps presented previously to publish the function. </span><span class="koboSpan" id="kobo.340.2">The name used for the function app in this example was </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.341.1">flexfunction</span></code><span class="koboSpan" id="kobo.342.1">. </span><span class="koboSpan" id="kobo.342.2">It is worth noting that Flex </span><a id="_idIndexMarker306"/><span class="koboSpan" id="kobo.343.1">Consumption plans are for Linux-based operating systems.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.344.1">The following code shows the published function. </span><span class="koboSpan" id="kobo.344.2">Notice that the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.345.1">Connection</span></code><span class="koboSpan" id="kobo.346.1"> parameter is </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.347.1">"ConnectionStringName"</span></code><span class="koboSpan" id="kobo.348.1"> in this example. </span><span class="koboSpan" id="kobo.348.2">Also, notice that the name of the function is </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.349.1">SampleFunction</span></code><span class="koboSpan" id="kobo.350.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.351.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.352.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.353.1">SampleFunction</span></span><span class="koboSpan" id="kobo.354.1">
{
  private readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.355.1">ILogger</span></span><span class="koboSpan" id="kobo.356.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.357.1">SampleFunction</span></span><span class="koboSpan" id="kobo.358.1">&gt; _logger;
  public </span><span class="hljs-title"><span class="koboSpan" id="kobo.359.1">SampleFunction</span></span><span class="koboSpan" id="kobo.360.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.361.1">ILogger</span></span><span class="koboSpan" id="kobo.362.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.363.1">SampleFunction</span></span><span class="koboSpan" id="kobo.364.1">&gt; logger)
  {
    _logger = logger;
  }
  [</span><span class="hljs-title"><span class="koboSpan" id="kobo.365.1">Function</span></span><span class="koboSpan" id="kobo.366.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.367.1">nameof</span></span><span class="koboSpan" id="kobo.368.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.369.1">SampleFunction</span></span><span class="koboSpan" id="kobo.370.1">))]
  public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.371.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.372.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.373.1">Run</span></span><span class="koboSpan" id="kobo.374.1">([</span><span class="hljs-title"><span class="koboSpan" id="kobo.375.1">BlobTrigger</span></span><span class="koboSpan" id="kobo.376.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.377.1">“event-grid-samples/{name}”</span></span><span class="koboSpan" id="kobo.378.1">,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.379.1">Source</span></span><span class="koboSpan" id="kobo.380.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.381.1">BlobTriggerSource</span></span><span class="koboSpan" id="kobo.382.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.383.1">EventGrid</span></span><span class="koboSpan" id="kobo.384.1">,
</span><span class="hljs-title"><span class="koboSpan" id="kobo.385.1">    Connection</span></span><span class="koboSpan" id="kobo.386.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.387.1">“ConnectionStringName”</span></span><span class="koboSpan" id="kobo.388.1">)] </span><span class="hljs-title"><span class="koboSpan" id="kobo.389.1">Stream</span></span><span class="koboSpan" id="kobo.390.1"> stream, string name)
  {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.391.1">using</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.392.1">var</span></span><span class="koboSpan" id="kobo.393.1"> blobStreamReader = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.394.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.395.1">StreamReader</span></span><span class="koboSpan" id="kobo.396.1">(stream);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.397.1">var</span></span><span class="koboSpan" id="kobo.398.1"> content = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.399.1">await</span></span><span class="koboSpan" id="kobo.400.1"> blobStreamReader.</span><span class="hljs-title"><span class="koboSpan" id="kobo.401.1">ReadToEndAsync</span></span><span class="koboSpan" id="kobo.402.1">();
    _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.403.1">LogInformation</span></span><span class="koboSpan" id="kobo.404.1">($</span><span class="hljs-string"><span class="koboSpan" id="kobo.405.1">”C# Blob Trigger (using Event Grid) processed</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.406.1">                             blob\n Name: {name} \n Data: {content}”</span></span><span class="koboSpan" id="kobo.407.1">);
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.408.1">You will need this information </span><a id="_idIndexMarker307"/><span class="koboSpan" id="kobo.409.1">to set the Azure function. </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.410.1">"ConnectionStringName"</span></code><span class="koboSpan" id="kobo.411.1"> needs to be defined in the settings of the function app as an environment variable, as you can see in the following figure. </span><span class="koboSpan" id="kobo.411.2">The content of this configuration is the connection string of the created storage account.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.412.1"><img alt="Figure 5.19: Defining the connection between the function app and the storage account" src="../Images/B31916_05_19.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.413.1">Figure 5.19: Defining the connection between the function app and the storage account</span></p>
<p class="normal"><span class="koboSpan" id="kobo.414.1">After that, you will have all the information needed to define the event that will be triggered in the function app. </span><span class="koboSpan" id="kobo.414.2">Notice</span><a id="_idIndexMarker308"/><span class="koboSpan" id="kobo.415.1"> that the event happens in the storage account and Event Grid triggers the function. </span><span class="koboSpan" id="kobo.415.2">To do this, a webhook is created. </span><span class="koboSpan" id="kobo.415.3">The definition of the URL of the webhook can be seen here:</span></p>
<table class="table-container" id="table002">
<thead>
<tr>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.416.1">Part</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.417.1">Template</span></strong></p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.418.1">Base function app URL</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="url"><span class="koboSpan" id="kobo.419.1">https://&lt;FUNCTION_APP_NAME&gt;.azurewebsites.net</span></span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.420.1">Blob-specific path</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="url"><span class="koboSpan" id="kobo.421.1">/runtime/webhooks/blobs</span></span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.422.1">Function query string</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="url"><span class="koboSpan" id="kobo.423.1">?functionName=Host.Functions.&lt;FUNCTION_NAME&gt;</span></span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.424.1">Blob extension access key</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="url"><span class="koboSpan" id="kobo.425.1">&amp;code=&lt;BLOB_EXTENSION_KEY&gt;</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="koboSpan" id="kobo.426.1">The blob extension access key can be found in the </span><strong class="keyWord"><span class="koboSpan" id="kobo.427.1">App Keys</span></strong><span class="koboSpan" id="kobo.428.1"> section of the function app. </span><span class="koboSpan" id="kobo.428.2">There is a specific system key for </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.429.1">blobs_extension</span></code><span class="koboSpan" id="kobo.430.1">. </span><span class="koboSpan" id="kobo.430.2">Once you have the key, you can use it to create a new event in Azure Storage, as you can see in the next figure.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.431.1"><img alt="Figure 5.20: Subscribing to an event in Blob Storage" src="../Images/B31916_05_20.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.432.1">Figure 5.20: Subscribing to an event in Blob Storage</span></p>
<p class="normal"><span class="koboSpan" id="kobo.433.1">It is important to mention </span><a id="_idIndexMarker309"/><span class="koboSpan" id="kobo.434.1">that your Azure subscription may not have enabled the resource provider for Event Grid and an error may occur with this disabled while creating the subscription. </span><span class="koboSpan" id="kobo.434.2">To enable the resource provider, you need to go to your subscription account and register it.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.435.1"><img alt="Figure 5.21: Registering the Microsoft.EventGrid resource provider" src="../Images/B31916_05_21.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.436.1">Figure 5.21: Registering the Microsoft.EventGrid resource provider</span></p>
<p class="normal"><span class="koboSpan" id="kobo.437.1">After this configuration, by simply </span><a id="_idIndexMarker310"/><span class="koboSpan" id="kobo.438.1">uploading files to the defined container, the function will be triggered for each file uploaded, in a low-latency model. </span><span class="koboSpan" id="kobo.438.2">You can monitor each trigger using the function’s </span><strong class="keyWord"><span class="koboSpan" id="kobo.439.1">Invocations</span></strong><span class="koboSpan" id="kobo.440.1"> panel. </span><span class="koboSpan" id="kobo.440.2">Notice, in the figure, that the function was triggered four times in the same second in the last calls, showing the capacity of the trigger function to handle a greater number of files at the same time.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.441.1"><img alt="Figure 5.22: Monitoring triggers" src="../Images/B31916_05_22.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.442.1">Figure 5.22: Monitoring triggers</span></p>
<p class="normal"><span class="koboSpan" id="kobo.443.1">It is worth noting that this example requires different components that may create additional costs. </span><span class="koboSpan" id="kobo.443.2">So, you must pay attention not to let this demo run in your Azure account if you are just trying this option. </span><span class="koboSpan" id="kobo.443.3">On the </span><a id="_idIndexMarker311"/><span class="koboSpan" id="kobo.444.1">other hand, this will decrease the latency between the arrival of a file and its processing, so you may consider it a good approach for real-life applications.</span></p>
<h2 class="heading-2" id="_idParaDest-97"><a id="_idTextAnchor133"/><span class="koboSpan" id="kobo.445.1">Car-sharing Blob storage trigger example</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.446.1">Considering the car-sharing use</span><a id="_idIndexMarker312"/><span class="koboSpan" id="kobo.447.1"> case that we are presenting in this book, it is worth mentioning that one of the services that may be included in this solution is to analyze the driver’s license. </span><span class="koboSpan" id="kobo.447.2">To do so, in the frontend application, there will be a user interface to upload this important document to the business logic of the application. </span><span class="koboSpan" id="kobo.447.3">However, as this file is important, storing information like this needs to be well designed. </span><span class="koboSpan" id="kobo.447.4">A good option is to only extract the information needed with the uploaded image and then create a hash of this information, so you can delete the file uploaded by the user.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.448.1">To do so, you may create a function dedicated to processing driver’s license photos. </span><span class="koboSpan" id="kobo.448.2">Using a Blob storage trigger to do so may be a good idea.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.449.1">It is important to mention that this example needs to update the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.450.1">Program.cs</span></code><span class="koboSpan" id="kobo.451.1"> file. </span><span class="koboSpan" id="kobo.451.2">Instead of directly using the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.452.1">FunctionsApplication</span></code><span class="koboSpan" id="kobo.453.1"> class, we will use </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.454.1">HostBuilder</span></code><span class="koboSpan" id="kobo.455.1"> here, configuring the Azure Functions application</span><a id="_idIndexMarker313"/><span class="koboSpan" id="kobo.456.1"> with the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.457.1">ConfigureFunctionsWebApplication</span></code><span class="koboSpan" id="kobo.458.1"> method. </span><span class="koboSpan" id="kobo.458.2">It is worth mentioning that in Azure Functions with .NET 8, </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.459.1">ConfigureFunctionsWebApplication()</span></code><span class="koboSpan" id="kobo.460.1"> enables ASP.NET Core integration, while the default </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.461.1">ConfigureFunctionsWorkerDefaults()</span></code><span class="koboSpan" id="kobo.462.1"> is used for the isolated worker model, offering greater flexibility and control over .NET versions and dependencies:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.463.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.464.1">Microsoft</span></span><span class="koboSpan" id="kobo.465.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.466.1">Extensions</span></span><span class="koboSpan" id="kobo.467.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.468.1">Hosting</span></span><span class="koboSpan" id="kobo.469.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.470.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.471.1">Microsoft</span></span><span class="koboSpan" id="kobo.472.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.473.1">Extensions</span></span><span class="koboSpan" id="kobo.474.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.475.1">Configuration</span></span><span class="koboSpan" id="kobo.476.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.477.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.478.1">CarShareBackground</span></span><span class="koboSpan" id="kobo.479.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.480.1">var</span></span><span class="koboSpan" id="kobo.481.1"> host = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.482.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.483.1">HostBuilder</span></span><span class="koboSpan" id="kobo.484.1">()
  .</span><span class="hljs-title"><span class="koboSpan" id="kobo.485.1">ConfigureFunctionsWebApplication</span></span><span class="koboSpan" id="kobo.486.1">()
  .</span><span class="hljs-title"><span class="koboSpan" id="kobo.487.1">ConfigureAppConfiguration</span></span><span class="koboSpan" id="kobo.488.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.489.1">config</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.490.1"> =&gt;</span></span><span class="koboSpan" id="kobo.491.1">
  {
    config.</span><span class="hljs-property"><span class="koboSpan" id="kobo.492.1">AddUserSecrets</span></span><span class="koboSpan" id="kobo.493.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.494.1">ProcessDriversLicensePhoto</span></span><span class="koboSpan" id="kobo.495.1">&gt;(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.496.1">optional</span></span><span class="koboSpan" id="kobo.497.1">: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.498.1">true</span></span><span class="koboSpan" id="kobo.499.1">,
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.500.1">reloadOnChange</span></span><span class="koboSpan" id="kobo.501.1">: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.502.1">false</span></span><span class="koboSpan" id="kobo.503.1">);
  })
  .</span><span class="hljs-title"><span class="koboSpan" id="kobo.504.1">Build</span></span><span class="koboSpan" id="kobo.505.1">();
host.</span><span class="hljs-title"><span class="koboSpan" id="kobo.506.1">Run</span></span><span class="koboSpan" id="kobo.507.1">();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.508.1">The </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.509.1">AddUserSecrets</span></code><span class="koboSpan" id="kobo.510.1"> method adds user secrets to the configuration, which is useful for storing sensitive information such as API keys or connection strings. </span><span class="koboSpan" id="kobo.510.2">In this case, we are storing the connection with Blob Storage. </span><span class="koboSpan" id="kobo.510.3">The </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.511.1">ProcessDriversLicensePhoto</span></code><span class="koboSpan" id="kobo.512.1"> type is used to identify the assembly containing the user secrets. </span><span class="koboSpan" id="kobo.512.2">The </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.513.1">optional: true</span></code><span class="koboSpan" id="kobo.514.1"> parameter means that the application will not fail if the user secrets file is not found, and </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.515.1">reloadOnChange: false</span></code><span class="koboSpan" id="kobo.516.1"> indicates that the configuration </span><a id="_idIndexMarker314"/><span class="koboSpan" id="kobo.517.1">will not automatically reload if the user secrets file changes.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.518.1">Once you have defined </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.519.1">Program.cs</span></code><span class="koboSpan" id="kobo.520.1">, you may create the Azure function to process Blob Storage. </span><span class="koboSpan" id="kobo.520.2">The function itself is quite simple to define, as you can see in the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.521.1">[</span><span class="hljs-title"><span class="koboSpan" id="kobo.522.1">Function</span></span><span class="koboSpan" id="kobo.523.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.524.1">nameof</span></span><span class="koboSpan" id="kobo.525.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.526.1">ProcessDriversLicensePhoto</span></span><span class="koboSpan" id="kobo.527.1">))]
public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.528.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.529.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.530.1">Run</span></span><span class="koboSpan" id="kobo.531.1">([</span><span class="hljs-title"><span class="koboSpan" id="kobo.532.1">BlobTrigger</span></span><span class="koboSpan" id="kobo.533.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.534.1">“drivers-license/{name}”</span></span><span class="koboSpan" id="kobo.535.1">,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.536.1">Connection</span></span><span class="koboSpan" id="kobo.537.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.538.1">“CarShareStorage”</span></span><span class="koboSpan" id="kobo.539.1">)] </span><span class="hljs-title"><span class="koboSpan" id="kobo.540.1">Stream</span></span><span class="koboSpan" id="kobo.541.1"> myBlob, string name)
{
  </span><span class="hljs-title"><span class="koboSpan" id="kobo.542.1">StreamReader</span></span><span class="koboSpan" id="kobo.543.1"> reader = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.544.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.545.1">StreamReader</span></span><span class="koboSpan" id="kobo.546.1">(myBlob);
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.547.1">var</span></span><span class="koboSpan" id="kobo.548.1"> message = reader.</span><span class="hljs-title"><span class="koboSpan" id="kobo.549.1">ReadToEnd</span></span><span class="koboSpan" id="kobo.550.1">();
  _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.551.1">LogInformation</span></span><span class="koboSpan" id="kobo.552.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.553.1">“File detected”</span></span><span class="koboSpan" id="kobo.554.1">);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.555.1">The </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.556.1">BlobTrigger</span></code><span class="koboSpan" id="kobo.557.1"> attribute defines where in Blob Storage the files will be uploaded, in this case, in the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.558.1">drivers-license</span></code><span class="koboSpan" id="kobo.559.1"> folder, where </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.560.1">{name} </span></code><span class="koboSpan" id="kobo.561.1">is a placeholder for the blob’s name, which will be passed as a string in the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.562.1">name</span></code><span class="koboSpan" id="kobo.563.1"> parameter. </span><span class="koboSpan" id="kobo.563.2">The stream of the file will be obtained by the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.564.1">myBlob</span></code><span class="koboSpan" id="kobo.565.1"> parameter.</span></p>
<h1 class="heading-1" id="_idParaDest-98"><a id="_idTextAnchor134"/><span class="koboSpan" id="kobo.566.1">Queue storage trigger</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.567.1">The principle of a</span><a id="_idIndexMarker315"/><span class="koboSpan" id="kobo.568.1"> queue is fairly well known since this is a data structure where you want to control the data so that first in will be first out. </span><span class="koboSpan" id="kobo.568.2">When we talk about the queue storage trigger in Azure Functions, we have the possibility to manage queues asynchronously and totally decoupled, making its usage extremely powerful.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.569.1">The great power that we have in this scenario is the ability to handle large amounts of messages efficiently. </span><span class="koboSpan" id="kobo.569.2">Azure Functions has the capability to scale automatically, and it guarantees that each task will be processed properly with reliability and fault tolerance.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.570.1">Considering this approach, it is worth noting that serverless applications will always focus the development on what is</span><a id="_idIndexMarker316"/><span class="koboSpan" id="kobo.571.1"> essentially needed – the business logic to make that service work. </span><span class="koboSpan" id="kobo.571.2">That is why serverless applications are a great way to implement microservices since the necessity of handling infrastructure will be less needed.</span></p>
<h2 class="heading-2" id="_idParaDest-99"><a id="_idTextAnchor135"/><span class="koboSpan" id="kobo.572.1">Advantages, disadvantages, and when to use queue storage triggers</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.573.1">If you have a use case where you must control a queue of data, a queue storage trigger function will be one of the good options to select. </span><span class="koboSpan" id="kobo.573.2">The fact that this approach can handle large volumes of messages efficiently is truly an advantage. </span><span class="koboSpan" id="kobo.573.3">In this case, you only need to focus on the business logic for the service that will be implemented.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.574.1">However, the pricing model is based on the number of executions and the amount of data processed, so you must be aware </span><a id="_idIndexMarker317"/><span class="koboSpan" id="kobo.575.1">of it and not be surprised by the costs related to the solution. </span><span class="koboSpan" id="kobo.575.2">It is also worth noting that high load or transient errors may occur and, as a developer, you </span><a id="_idIndexMarker318"/><span class="koboSpan" id="kobo.576.1">must implement retries and error-handling mechanisms to ensure your solution is well implemented.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.577.1">Queue storage triggers may be a good solution when you must deliver a reliable and efficient solution for processing queued tasks, considering all we have discussed. </span><span class="koboSpan" id="kobo.577.2">For instance, if you need order processing, background job scheduling, or event event-driven notifications, this kind of solution can be a good approach. </span><span class="koboSpan" id="kobo.577.3">Now, let’s check a scenario in the car-sharing example where a queue storage trigger could be a good solution.</span></p>
<h2 class="heading-2" id="_idParaDest-100"><a id="_idTextAnchor136"/><span class="koboSpan" id="kobo.578.1">Car-sharing queue storage trigger example</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.579.1">Considering the car-sharing</span><a id="_idIndexMarker319"/><span class="koboSpan" id="kobo.580.1"> use case, one of the services that may be created using a queue storage trigger is the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.581.1">My_Best_Matches</span></code><span class="koboSpan" id="kobo.582.1"> microservice. </span><span class="koboSpan" id="kobo.582.2">According to the car-sharing example specification described in </span><a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic"><span class="koboSpan" id="kobo.583.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.584.1">, </span><em class="italic"><span class="koboSpan" id="kobo.585.1">Demystifying Microservices Applications</span></em><span class="koboSpan" id="kobo.586.1">, all routes’ changes are sent to both the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.587.1">My_Best_Matches</span></code><span class="koboSpan" id="kobo.588.1"> and </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.589.1">Route-Choosing</span></code><span class="koboSpan" id="kobo.590.1"> microservices.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.591.1">Considering this scenario, let’s suppose that the routes’ changes are queued as JSON components in an Azure Storage </span><a id="_idIndexMarker320"/><span class="koboSpan" id="kobo.592.1">queue. </span><span class="koboSpan" id="kobo.592.2">This JSON will indicate that there is a new match to be processed by </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.593.1">My_Best_Matches</span></code><span class="koboSpan" id="kobo.594.1"> microservice:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.595.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.596.1">Azure</span></span><span class="koboSpan" id="kobo.597.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.598.1">Storage</span></span><span class="koboSpan" id="kobo.599.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.600.1">Queues</span></span><span class="koboSpan" id="kobo.601.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.602.1">Models</span></span><span class="koboSpan" id="kobo.603.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.604.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.605.1">Microsoft</span></span><span class="koboSpan" id="kobo.606.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.607.1">Azure</span></span><span class="koboSpan" id="kobo.608.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.609.1">Functions</span></span><span class="koboSpan" id="kobo.610.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.611.1">Worker</span></span><span class="koboSpan" id="kobo.612.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.613.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.614.1">Microsoft</span></span><span class="koboSpan" id="kobo.615.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.616.1">Extensions</span></span><span class="koboSpan" id="kobo.617.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.618.1">Logging</span></span><span class="koboSpan" id="kobo.619.1">;
namespace </span><span class="hljs-title"><span class="koboSpan" id="kobo.620.1">My</span></span><span class="koboSpan" id="kobo.621.1">_Best_Matches
{
  public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.622.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.623.1">NewMatchTrigger</span></span><span class="koboSpan" id="kobo.624.1">
  {
    private readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.625.1">ILogger</span></span><span class="koboSpan" id="kobo.626.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.627.1">NewMatchTrigger</span></span><span class="koboSpan" id="kobo.628.1">&gt; _logger;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.629.1">NewMatchTrigger</span></span><span class="koboSpan" id="kobo.630.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.631.1">ILogger</span></span><span class="koboSpan" id="kobo.632.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.633.1">NewMatchTrigger</span></span><span class="koboSpan" id="kobo.634.1">&gt; logger)
    {
      _logger = logger;
    }
    [</span><span class="hljs-title"><span class="koboSpan" id="kobo.635.1">Function</span></span><span class="koboSpan" id="kobo.636.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.637.1">nameof</span></span><span class="koboSpan" id="kobo.638.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.639.1">NewMatchTrigger</span></span><span class="koboSpan" id="kobo.640.1">))]
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.641.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.642.1">Run</span></span><span class="koboSpan" id="kobo.643.1">([</span><span class="hljs-title"><span class="koboSpan" id="kobo.644.1">QueueTrigger</span></span><span class="koboSpan" id="kobo.645.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.646.1">“new-match”</span></span><span class="koboSpan" id="kobo.647.1">,
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.648.1">Connection</span></span><span class="koboSpan" id="kobo.649.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.650.1">“CarSharingStorage”</span></span><span class="koboSpan" id="kobo.651.1">)] </span><span class="hljs-title"><span class="koboSpan" id="kobo.652.1">QueueMessage</span></span><span class="koboSpan" id="kobo.653.1"> message)
    {
      _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.654.1">LogInformation</span></span><span class="koboSpan" id="kobo.655.1">($</span><span class="hljs-string"><span class="koboSpan" id="kobo.656.1">”C# Queue trigger function processed:</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.657.1">        {message.MessageText}”</span></span><span class="koboSpan" id="kobo.658.1">);
    }
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.659.1">Once you have this code running, using the local storage emulator, you can place a message in the </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.660.1">new-match</span></code><span class="koboSpan" id="kobo.661.1"> queue.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.662.1"><img alt="Figure 5.23: Placing a message in the queue" src="../Images/B31916_05_23.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.663.1">Figure 5.23: Placing a message in the queue</span></p>
<p class="normal"><span class="koboSpan" id="kobo.664.1">The message placed in the </span><a id="_idIndexMarker321"/><span class="koboSpan" id="kobo.665.1">queue will be automatically processed by the function and then deleted from the storage.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.666.1"><img alt="Figure 5.24: Azure function output" src="../Images/B31916_05_24.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.667.1">Figure 5.24: Azure function output</span></p>
<p class="normal"><span class="koboSpan" id="kobo.668.1">Considering this scenario, this </span><a id="_idIndexMarker322"/><span class="koboSpan" id="kobo.669.1">message could be used to send an email to both the car holder and car seeker, indicating that there is a new match for them and that they can interact with the system to define whether or not they will accept the proposed route.</span></p>
<h1 class="heading-1" id="_idParaDest-101"><a id="_idTextAnchor137"/><span class="koboSpan" id="kobo.670.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.671.1">This chapter discussed the implementation of three important Azure trigger functions to implement background services – timer triggers, Blob storage triggers, and queue storage triggers. </span><span class="koboSpan" id="kobo.671.2">Tasks such as processing routines, images, data, and orders can be easily implemented using this serverless technology.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.672.1">While presenting these kinds of functions, the chapter explained how to publish and monitor functions. </span><span class="koboSpan" id="kobo.672.2">It also presented a more efficient way to implement blob trigger functions, using Event Grid as a basis, and reducing the latency between the file upload and the start of the processing.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.673.1">The chapter also explained how Azure Functions can be a great approach to implementing microservices. </span><span class="koboSpan" id="kobo.673.2">To do so, it presented three examples related to the car-sharing use case where the usage of this kind of solution will let developers focus on what really matters when it comes to software development – coding the business logic of the solution that is being developed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.674.1">Now, let’s move on to the next chapter, which will discuss how to enable IoT solutions using Azure Functions as a basis.</span></p>
<h1 class="heading-1" id="_idParaDest-102"><a id="_idTextAnchor138"/><span class="koboSpan" id="kobo.675.1">Questions</span></h1>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.676.1">What is the purpose of the timer trigger function?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.677.1">The timer trigger function is designed to execute code on a schedule, defined using </span><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.678.1">NCRONTAB</span></code><span class="koboSpan" id="kobo.679.1"> expressions. </span><span class="koboSpan" id="kobo.679.2">It allows developers to run background jobs at regular intervals without requiring manual initiation or HTTP requests.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.680.1">This is useful for scenarios such as data synchronization, cleanup operations, report generation, and periodic billing. </span><span class="koboSpan" id="kobo.680.2">It helps automate repetitive tasks, especially those that shouldn’t depend on human interaction to be performed.</span></p>
<ol>
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.681.1">What is the purpose of the blob trigger function?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.682.1">The blob trigger function responds automatically whenever a file is added or modified in a specific Azure Blob Storage container. </span><span class="koboSpan" id="kobo.682.2">It enables event-driven processing for unstructured data such as images, logs, or documents.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.683.1">This trigger is ideal for automating workflows involving data ingestion, file processing, image analysis, or document transformation. </span><span class="koboSpan" id="kobo.683.2">It supports scalability and integration with Event Grid to reduce latency in high-performance scenarios.</span></p>
<ol>
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.684.1">What is the purpose of the queue trigger function?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.685.1">The queue trigger function executes when a new message is added to Azure Queue Storage. </span><span class="koboSpan" id="kobo.685.2">It enables the asynchronous processing of tasks, decoupling producers from consumers in distributed systems.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.686.1">This approach ensures reliable and scalable handling of queued tasks such as background processing, order handling, or notifications, allowing developers to focus on business logic while Azure Functions handles infrastructure concerns.</span></p>
<ol>
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.687.1">What is the difference between the blob and queue trigger functions?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.688.1">The blob trigger function reacts to file changes in Azure Blob Storage, typically processing binary or unstructured data. </span><span class="koboSpan" id="kobo.688.2">It is event-driven and suited for scenarios such as file uploads, media processing, or document handling.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.689.1">In contrast, the queue trigger function is designed to process text-based messages from Azure Queue Storage. </span><span class="koboSpan" id="kobo.689.2">It is better suited for managing workflows, job scheduling, and message-driven integrations, where you need explicit control over task order and execution.</span></p>
<ol>
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.690.1">How can we reduce the latency between the file upload and the start of processing in a blob trigger function?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.691.1">To reduce latency in a blob trigger function, it’s recommended to use Event Grid-based blob triggers instead of polling-based triggers. </span><span class="koboSpan" id="kobo.691.2">Event Grid enables near-real-time processing by pushing events as they occur.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.692.1">Additionally, using the Flex Consumption plan or an App Service plan with Always On enabled helps minimize cold start times. </span><span class="koboSpan" id="kobo.692.2">However, these approaches may increase cost, so they should be evaluated based on application requirements.</span></p>
<ol>
<li class="numberedList" value="6"><span class="koboSpan" id="kobo.693.1">List different ways to monitor an Azure function.</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.694.1">Azure functions can be monitored using several built-in tools. </span><span class="koboSpan" id="kobo.694.2">The </span><strong class="keyWord"><span class="koboSpan" id="kobo.695.1">Invocation</span></strong><span class="koboSpan" id="kobo.696.1"> tab in the Azure portal provides basic metrics, such as the number of executions and execution status.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.697.1">For deeper insights, Azure Monitor logs and Application Insights (</span><strong class="keyWord"><span class="koboSpan" id="kobo.698.1">Performance</span></strong><span class="koboSpan" id="kobo.699.1"> and </span><strong class="keyWord"><span class="koboSpan" id="kobo.700.1">Live Metrics</span></strong><span class="koboSpan" id="kobo.701.1"> views) offer advanced telemetry, performance tracking, and real-time diagnostics. </span><span class="koboSpan" id="kobo.701.2">These tools help identify errors, analyze trends, and debug runtime behavior effectively.</span></p>
<h1 class="heading-1" id="_idParaDest-103"><a id="_idTextAnchor139"/><span class="koboSpan" id="kobo.702.1">Further reading</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.703.1">Azure Functions timer trigger: </span><a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer"><span class="url"><span class="koboSpan" id="kobo.704.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.705.1">Azurite: </span><a href="https://learn.microsoft.com/en-us/azure/storage/common/storage-use-azurite"><span class="url"><span class="koboSpan" id="kobo.706.1">https://learn.microsoft.com/en-us/azure/storage/common/storage-use-azurite</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.707.1">Microsoft Azure Storage Explorer: </span><a href="https://learn.microsoft.com/en-us/azure/storage/storage-explorer/vs-azure-tools-storage-manage-with-storage-explorer"><span class="url"><span class="koboSpan" id="kobo.708.1">https://learn.microsoft.com/en-us/azure/storage/storage-explorer/vs-azure-tools-storage-manage-with-storage-explorer</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.709.1">Azure Functions blob trigger: </span><a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-blob-trigger"><span class="url"><span class="koboSpan" id="kobo.710.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-blob-trigger</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.711.1">Azure Functions blob trigger with Event-Grid: </span><a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-event-grid-blob-trigger"><span class="url"><span class="koboSpan" id="kobo.712.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-event-grid-blob-trigger</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.713.1">Azure Queue storage trigger: </span><a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-queue"><span class="url"><span class="koboSpan" id="kobo.714.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-queue</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.715.1">Azure storage considerations: </span><a href="https://learn.microsoft.com/en-us/azure/azure-functions/storage-considerations"><span class="url"><span class="koboSpan" id="kobo.716.1">https://learn.microsoft.com/en-us/azure/azure-functions/storage-considerations</span></span></a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-104"><a id="_idTextAnchor140"/><span class="koboSpan" id="kobo.717.1">Join our community on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.718.1">Join our community’s Discord space for discussions with the author and other readers:</span></p>
<p class="normal"><a href="https://packt.link/PSMCSharp"><span class="url"><span class="koboSpan" id="kobo.719.1">https://packt.link/PSMCSharp</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.720.1"><img alt="A qr code with black squares  AI-generated content may be incorrect." src="../Images/B31916_Discord-QR-Code.png"/></span></p>
</div>
</body></html>