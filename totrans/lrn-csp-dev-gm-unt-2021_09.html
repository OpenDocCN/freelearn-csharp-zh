<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer321">&#13;
    <h1 class="chapterNumber">9</h1>&#13;
    <h1 id="_idParaDest-190" class="chapterTitle">Basic AI and Enemy Behavior</h1>&#13;
    <p class="normal">Virtual scenarios need conflicts, consequences, and potential rewards to feel real. Without these three things, there's no incentive for the player to care about what happens to their in-game character, much less continue to play the game. And while there are plenty of game mechanics that deliver on one or more of these conditions, nothing beats an enemy that will seek you out and try to end your session.</p>&#13;
    <p class="normal">Programming an intelligent enemy is no easy task, and often goes hand in hand with long working hours and frustration. However, Unity has built-in features, components, and classes we can use to design and implement AI systems in a more user-friendly way. These tools will push the first playable iteration of <em class="italic">Hero Born</em> over the finish line and provide a springboard for more advanced C# topics.</p>&#13;
    <p class="normal">In this chapter, we'll focus on the following topics:</p>&#13;
    <ul>&#13;
      <li class="bullet">The Unity navigation system</li>&#13;
      <li class="bullet">Static objects and navigation meshes</li>&#13;
      <li class="bullet">Navigation agents </li>&#13;
      <li class="bullet">Procedural programming and logic</li>&#13;
      <li class="bullet">Taking and dealing damage</li>&#13;
      <li class="bullet">Adding a loss condition</li>&#13;
      <li class="bullet">Refactoring and keeping it DRY</li>&#13;
    </ul>&#13;
    <p class="normal">Let's get started!</p>&#13;
    <h1 id="_idParaDest-191" class="title">Navigating 3D space in Unity</h1>&#13;
    <p class="normal">When we talk <a id="_idIndexMarker629"/>about navigation in real life, it's usually a conversation <a id="_idIndexMarker630"/>about how to get from point A to point B. Navigating around virtual 3D space is largely the same, but how do we account for the experiential knowledge we humans have accumulated since the day we first started crawling? Everything <a id="_idIndexMarker631"/>from walking on a flat surface to climbing stairs <a id="_idIndexMarker632"/>and jumping off of curbs is a skill we learned by doing; how can we possibly program all that into a game without going insane?</p>&#13;
    <p class="normal">Before you can answer any of these questions, you'll need to know what navigation components Unity has to offer.</p>&#13;
    <h2 id="_idParaDest-192" class="title">Navigation components</h2>&#13;
    <p class="normal">The short answer is that Unity has spent a lot of time perfecting its navigation system and delivering components that we can use to govern how playable and non-playable<a id="_idIndexMarker633"/> characters can get around. Each of the following components comes as standard with Unity and has complex features already built in:</p>&#13;
    <ul>&#13;
      <li class="bullet">A <strong class="keyword">NavMesh</strong> is essentially a map of the walkable surfaces in a given level; the NavMesh component <a id="_idIndexMarker634"/>itself is created from the level geometry in a process <a id="_idIndexMarker635"/>called baking. Baking a NavMesh into your level creates a unique project asset that holds the navigation data.</li>&#13;
      <li class="bullet">If a <strong class="keyword">NavMesh</strong> is the level map, then a <strong class="keyword">NavMeshAgent</strong> is the moving piece on the board. Any object <a id="_idIndexMarker636"/>with a NavMeshAgent component attached will <a id="_idIndexMarker637"/>automatically avoid other agents or obstacles it comes into contact with.</li>&#13;
      <li class="bullet">The navigation system needs to be aware of any moving or stationary objects in the level that could cause a NavMeshAgent to alter their route. Adding NavMeshObstacle components to those objects lets the system know that they need to be avoided.</li>&#13;
    </ul>&#13;
    <p class="normal">While this description of the Unity navigation system is far from complete, it's enough for us to move forward with our enemy behavior. For this chapter, we'll be focusing on adding a NavMesh to our level, setting up the Enemy Prefab as a NavMeshAgent, and getting the Enemy Prefab to move along a predefined route in a seemingly intelligent way.</p>&#13;
    <div class="note">&#13;
      <p class="Information-Box--PACKT-">We'll only be using the NavMesh and NavMeshAgent components in this chapter, but if you <a id="_idIndexMarker638"/>want to spice up your level, take a look at how to create obstacles here: <a href="https://docs.unity3d.com/Manual/nav-CreateNavMeshObstacle.html"><span class="url">https://docs.unity3d.com/Manual/nav-CreateNavMeshObstacle.html</span></a>.</p>&#13;
    </div>&#13;
    <p class="normal">Your first task in setting up an "intelligent" enemy is to create a NavMesh over the arena's walkable areas. Let's set up and configure our level's NavMesh:</p>&#13;
    <ol>&#13;
      <li class="numbered">Select the <strong class="screenText">Environment </strong>GameObject, click on the arrow icon next to <strong class="screenText">Static</strong> in the <strong class="screenText">Inspector</strong> window, and<a id="_idIndexMarker639"/> choose <strong class="screenText">Navigation Static</strong>:<figure class="mediaobject"><img src="Images/B17573_09_01.png" alt="" width="476" height="216"/></figure>&#13;
        <p class="packt_figref">Figure 9.1: Setting objects to Navigation Static</p>&#13;
      </li>&#13;
      <li class="numbered">Click <strong class="screenText">Yes, change children</strong> when the dialog window pops up to set all the <strong class="screenText">Environment</strong> child objects to <strong class="screenText">Navigation Static</strong>:<figure class="mediaobject"><img src="Images/B17573_09_02.png" alt="" width="750" height="269"/></figure>&#13;
        <p class="packt_figref">Figure 9.2: Changing all child objects</p>&#13;
      </li>&#13;
      <li class="numbered">Go to <strong class="screenText">Window</strong> | <strong class="screenText">AI</strong> | <strong class="screenText">Navigation</strong> and select the <strong class="screenText">Bake</strong> tab. Leave everything set to their default values <a id="_idIndexMarker640"/>and click <strong class="screenText">Bake</strong>. Once baking is finished, you'll see a new folder inside the <strong class="screenText">Scenes</strong> folder with lighting, navigation mesh, and reflection probe data:<figure class="mediaobject"><img src="Images/B17573_09_03.png" alt="" width="753" height="397"/></figure>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="packt_figref">Figure 9.3: Baking navigation mesh</p>&#13;
    <p class="normal">Every object in our level is now marked as <strong class="screenText">Navigation Static</strong>, which means that our newly baked NavMesh has evaluated their accessibility based on its default NavMeshAgent settings. Everywhere you can see a light blue overlay in the preceding screenshot is a walkable surface for any object with a NavMeshAgent component attached, which is your next task.</p>&#13;
    <h2 id="_idParaDest-193" class="title">Setting up enemy agents</h2>&#13;
    <p class="normal">Let's register the Enemy Prefab as a NavMeshAgent:</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">Select the Enemy <a id="_idIndexMarker641"/>Prefab in the <strong class="screenText">Prefabs</strong> folder, click <strong class="screenText">Add Component</strong> in the <strong class="screenText">Inspector</strong> window, and search for <strong class="screenText">NavMesh Agent</strong>:<figure class="mediaobject"><img src="Images/B17573_09_04.png" alt="" width="752" height="427"/></figure>&#13;
        <p class="packt_figref">Figure 9.4: Adding a NavMeshAgent component</p>&#13;
      </li>&#13;
      <li class="numbered">Click <strong class="screenText">+</strong> <strong class="screenText">|</strong> <strong class="screenText">Create Empty</strong> from the <strong class="screenText">Hierarchy </strong>window and name the GameObject <code class="Code-In-Text--PACKT-">Patrol_Route</code>:<ul>&#13;
          <li class="bullet-l2">Select <code class="Code-In-Text--PACKT-">Patrol_Route</code>, click <strong class="screenText">+</strong> <strong class="screenText">|</strong> <strong class="screenText">Create Empty</strong> to add a child GameObject, and <a id="_idIndexMarker642"/>name it <code class="Code-In-Text--PACKT-">Location_1</code>. Position <code class="Code-In-Text--PACKT-">Location_1</code> in one of the corners of the level:</li>&#13;
        </ul>&#13;
        <figure class="mediaobject"><img src="Images/B17573_09_05.png" alt="" width="1342" height="417"/></figure>&#13;
        <p class="packt_figref">Figure 9.5: Creating an empty patrol route object</p>&#13;
      </li>&#13;
      <li class="numbered">Create three more empty child objects in <code class="Code-In-Text--PACKT-">Patrol_Route</code>, name them <code class="Code-In-Text--PACKT-">Location_2</code>, <code class="Code-In-Text--PACKT-">Location_3</code>, and <code class="Code-In-Text--PACKT-">Location_4</code>, respectively, and position them in the remaining <a id="_idIndexMarker643"/>corners of the level to form a square:<figure class="mediaobject"><img src="Images/B17573_09_06.png" alt="" width="1342" height="415"/></figure>&#13;
    <p class="packt_figref">Figure 9.6: Creating all empty patrol route objects</p>&#13;
      </li>&#13;
    </ol>&#13;
&#13;
    <p class="normal">Adding a NavMeshAgent component to the Enemy tells the NavMesh component to take notice and register it as an object that has access to its autonomous navigation features. Creating the four empty game objects in each corner of the level lays out the simple route we want our enemies to eventually patrol; grouping them in an empty parent object makes it easier to reference them in code and makes for a more organized Hierarchy window. All that's left is the code to make the enemy walk the patrol route, which you'll add in the next section.</p>&#13;
    <h1 id="_idParaDest-194" class="title">Moving enemy agents</h1>&#13;
    <p class="normal">Our patrol locations are set and the Enemy Prefab has a NavMeshAgent component, but now we need to figure <a id="_idIndexMarker644"/>out how to reference those locations and get the enemy moving on its own. To do that, we'll first need to talk about an important concept in the world of software development: procedural programming.</p>&#13;
    <h2 id="_idParaDest-195" class="title">Procedural programming</h2>&#13;
    <p class="normal">Even though it's in the name, the idea behind procedural programming can be elusive until you get your head around it; once you do, you'll never see a code challenge the same way.</p>&#13;
    <p class="normal">Any task that executes the <a id="_idIndexMarker645"/>same logic on one or more sequential objects is the perfect candidate for procedural programming. You already did a little procedural programming when you debugged arrays, lists, and dictionaries with <code class="Code-In-Text--PACKT-">for</code> and <code class="Code-In-Text--PACKT-">foreach</code> loops. Each time those looping statements were executed, you performed the same call to <code class="Code-In-Text--PACKT-">Debug.Log()</code>, iterating over each item sequentially. The idea now is to use that skill to get a more useful outcome.</p>&#13;
    <p class="normal">One of the most common <a id="_idIndexMarker646"/>uses of procedural programming is adding items from one collection to another, often modifying them along the way. This works great for our purposes since we want to reference each child object in the <code class="Code-In-Text--PACKT-">Patrol_Route</code> parent and store them in a list.</p>&#13;
    <h2 id="_idParaDest-196" class="title">Referencing the patrol locations </h2>&#13;
    <p class="normal">Now that we understand the basics of procedural programming, it's time to get a reference to our <a id="_idIndexMarker647"/>patrol locations and assign them to a usable list:</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">Add the following code to <code class="Code-In-Text--PACKT-">EnemyBehavior</code>:&#13;
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EnemyBehavior</span> : <span class="hljs-title">MonoBehaviour</span>&#13;
{ &#13;
    <span class="code-highlight"><strong class="hljs-comment-slc">// 1</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> Transform PatrolRoute;</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-comment-slc">// 2</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> List&lt;Transform&gt; Locations;</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">void</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">Start</strong><strong class="hljs-function-slc">()</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 3</strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-slc">InitializePatrolRoute();</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-slc">}</strong></span> &#13;
          <span class="code-highlight"><strong class="hljs-comment-slc">// 4</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">void</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">InitializePatrolRoute</strong><strong class="hljs-function-slc">()</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 5</strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-keyword-slc">foreach</strong><strong class="hljs-slc">(Transform child </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> PatrolRoute)</strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-comment-slc">// 6</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-slc">Locations.Add(child);</strong></span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">}</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
    <span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">OnTriggerEnter</span><span class="hljs-function">(</span><span class="hljs-params">Collider other</span><span class="hljs-function">)</span> &#13;
    { &#13;
        <span class="hljs-comment">// ... No changes needed ... </span>&#13;
    } &#13;
    <span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">OnTriggerExit</span><span class="hljs-function">(</span><span class="hljs-params">Collider other</span><span class="hljs-function">)</span> &#13;
    { &#13;
        <span class="hljs-comment">// ... No changes needed ... </span>&#13;
    } &#13;
}&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numbered">Select <code class="Code-In-Text--PACKT-">Enemy</code> and drag the <code class="Code-In-Text--PACKT-">Patrol_Route</code> object from the <strong class="screenText">Hierarchy </strong>window onto the <strong class="screenText">Patrol Route</strong> variable in <code class="Code-In-Text--PACKT-">EnemyBehavior</code>:<figure class="mediaobject"><img src="Images/B17573_09_07.png" alt="" width="750" height="291"/></figure>&#13;
        <p class="packt_figref">Figure 9.7: Dragging Patrol_Route to the enemy script</p>&#13;
      </li>&#13;
      <li class="numbered">Hit the arrow icon next to the <strong class="screenText">Locations</strong> variable in the <strong class="screenText">Inspector</strong> window and run the game <a id="_idIndexMarker648"/>to see the list populate:<figure class="mediaobject"><img src="Images/B17573_09_08.png" alt="" width="752" height="255"/></figure>&#13;
    <p class="packt_figref">Figure 9.8: Testing procedural programming</p>&#13;
      </li>&#13;
    </ol>&#13;
&#13;
    <p class="normal">Let's break down the code:</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">First, it declares a variable for storing the <code class="Code-In-Text--PACKT-">PatrolRoute</code> empty parent GameObject.</li>&#13;
      <li class="numbered">Then, it declares a <code class="Code-In-Text--PACKT-">List</code> variable to hold all the child <code class="Code-In-Text--PACKT-">Transform</code> components in <code class="Code-In-Text--PACKT-">PatrolRoute</code>.</li>&#13;
      <li class="numbered">After that, it <a id="_idIndexMarker649"/>uses <code class="Code-In-Text--PACKT-">Start()</code> to call the <code class="Code-In-Text--PACKT-">InitializePatrolRoute()</code> method when the game begins.</li>&#13;
      <li class="numbered">Next, it creates <code class="Code-In-Text--PACKT-">InitializePatrolRoute()</code> as a private utility method to procedurally fill <code class="Code-In-Text--PACKT-">Locations</code> with <code class="Code-In-Text--PACKT-">Transform</code> values:<ul>&#13;
          <li class="bullet-l2">Remember that not including an access modifier makes variables and methods <code class="Code-In-Text--PACKT-">private</code> by default.</li>&#13;
        </ul>&#13;
      </li>&#13;
      <li class="numbered">Then, we use a <code class="Code-In-Text--PACKT-">foreach</code> statement to loop through each child GameObject in <code class="Code-In-Text--PACKT-">PatrolRoute</code> and reference its Transform component:<ul>&#13;
          <li class="bullet-l2">Each Transform component is captured in the local <code class="Code-In-Text--PACKT-">child</code> variable declared in the <code class="Code-In-Text--PACKT-">foreach</code> loop.</li>&#13;
        </ul>&#13;
      </li>&#13;
      <li class="numbered">Finally, we add each sequential <code class="Code-In-Text--PACKT-">child</code> <code class="Code-In-Text--PACKT-">Transform</code> component to the list of locations using the <code class="Code-In-Text--PACKT-">Add()</code> method as we loop through the child objects in <code class="Code-In-Text--PACKT-">PatrolRoute</code>:<ul>&#13;
          <li class="bullet-l2">This way, no matter what changes we make in the <strong class="screenText">Hierarchy</strong> window, <code class="Code-In-Text--PACKT-">Locations</code> will always be filled in with all the <code class="Code-In-Text--PACKT-">child</code> objects under the <code class="Code-In-Text--PACKT-">PatrolRoute</code> parent.</li>&#13;
        </ul>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="normal">While we could have assigned each location GameObject to <code class="Code-In-Text--PACKT-">Locations</code> by dragging and dropping them directly from the <strong class="screenText">Hierarchy</strong> window into the <strong class="screenText">Inspector</strong> window, it's easy to lose or break these connections; making changes to the location object names, object additions <a id="_idIndexMarker650"/>or deletions, or project updates can all throw a wrench into a class's initialization. It's much safer, and more readable, to procedurally fill GameObject lists or arrays in the <code class="Code-In-Text--PACKT-">Start()</code> method.</p>&#13;
    <div class="note">&#13;
      <p class="Information-Box--PACKT-">Due to that reasoning, I also tend to use <code class="Code-In-Text--PACKT-">GetComponent()</code> in the <code class="Code-In-Text--PACKT-">Start()</code> method to find and store component references attached to a given class instead of assigning them in the <strong class="screenText">Inspector</strong> window. </p>&#13;
    </div>&#13;
    <p class="normal">Now, we need the enemy object to follow the patrol route we laid out, which is your next task.</p>&#13;
    <h2 id="_idParaDest-197" class="title">Moving the enemy</h2>&#13;
    <p class="normal">With a list of patrol locations initialized on <code class="Code-In-Text--PACKT-">Start()</code>, we can grab the enemy NavMeshAgent component <a id="_idIndexMarker651"/>and set its first destination.</p>&#13;
    <p class="normal">Update <code class="Code-In-Text--PACKT-">EnemyBehavior</code> with the following code and hit play:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-comment-slc">// 1</strong></span><span class="hljs-comment"> </span>&#13;
<span class="code-highlight"><strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> UnityEngine.AI;</strong></span> &#13;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EnemyBehavior</span> : <span class="hljs-title">MonoBehaviour</span>  &#13;
{ &#13;
    <span class="hljs-keyword">public</span> Transform PatrolRoute;&#13;
    <span class="hljs-keyword">public</span> List&lt;Transform&gt; Locations;&#13;
    <span class="code-highlight"><strong class="hljs-comment-slc">// 2</strong></span><span class="hljs-comment"> </span>&#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc"> _locationIndex = </strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">;</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-comment-slc">// 3</strong></span><span class="hljs-comment"> </span>&#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> NavMeshAgent _agent;</strong></span> &#13;
    <span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">Start</span><span class="hljs-function">()</span> &#13;
    { &#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 4</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">_agent = GetComponent&lt;NavMeshAgent&gt;();</strong></span> &#13;
        InitializePatrolRoute(); &#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 5</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">MoveToNextPatrolLocation();</strong></span> &#13;
    }&#13;
    <span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">InitializePatrolRoute</span><span class="hljs-function">()</span>  &#13;
    { &#13;
         <span class="hljs-comment">// ... No changes needed ... </span>&#13;
    } &#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">void</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">MoveToNextPatrolLocation</strong><strong class="hljs-function-slc">()</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 6</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">_agent.destination = Locations[_locationIndex].position;</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-slc">}</strong></span> &#13;
    <span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">OnTriggerEnter</span><span class="hljs-function">(</span><span class="hljs-params">Collider other</span><span class="hljs-function">)</span> &#13;
    { &#13;
        <span class="hljs-comment">// ... No changes needed ... </span>&#13;
    } &#13;
    <span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">OnTriggerExit</span><span class="hljs-function">(</span><span class="hljs-params">Collider other</span><span class="hljs-function">)</span> &#13;
    { &#13;
        <span class="hljs-comment">// ... No changes needed ... </span>&#13;
    }&#13;
}&#13;
</code></pre>&#13;
    <p class="normal">Let's break down the code:</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">First, it adds the <code class="Code-In-Text--PACKT-">UnityEngine.AI</code> <code class="Code-In-Text--PACKT-">using</code> directive so that <code class="Code-In-Text--PACKT-">EnemyBehavior</code> has access to Unity's navigation classes, in this case, <code class="Code-In-Text--PACKT-">NavMeshAgent</code>.</li>&#13;
      <li class="numbered">Then, it declares a variable to keep track of which patrol location the enemy is currently walking <a id="_idIndexMarker652"/>toward. Since <code class="Code-In-Text--PACKT-">List</code> items are zero-indexed, we can have the Enemy Prefab move between patrol points in the order they are stored in <code class="Code-In-Text--PACKT-">Locations</code>.</li>&#13;
      <li class="numbered">Next, it declares a variable to store the NavMeshAgent component attached to the Enemy GameObject. This is <code class="Code-In-Text--PACKT-">private</code> because no other classes should be able to access or modify it.</li>&#13;
      <li class="numbered">After that, it uses <code class="Code-In-Text--PACKT-">GetComponent()</code> to find and return the attached NavMeshAgent component to the agent.</li>&#13;
      <li class="numbered">Then, it calls the <code class="Code-In-Text--PACKT-">MoveToNextPatrolLocation()</code> method on <code class="Code-In-Text--PACKT-">Start()</code>.</li>&#13;
      <li class="numbered">Finally, it declares <code class="Code-In-Text--PACKT-">MoveToNextPatrolLocation()</code> as a private method and sets <code class="Code-In-Text--PACKT-">_agent.destinat</code><code class="Code-In-Text--PACKT-">ion</code>:<ul>&#13;
          <li class="bullet-l2"><code class="Code-In-Text--PACKT-">destination</code> is a <code class="Code-In-Text--PACKT-">Vector3</code> position in 3D space.</li>&#13;
          <li class="bullet-l2"><code class="Code-In-Text--PACKT-">Locations[_locationIndex]</code> grabs the Transform item in <code class="Code-In-Text--PACKT-">Locations</code> at a given index.</li>&#13;
          <li class="bullet-l2">Adding <code class="Code-In-Text--PACKT-">.position</code> references the Transform component's <code class="Code-In-Text--PACKT-">Vector3</code> position.</li>&#13;
        </ul>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="normal">Now, when our scene starts, locations are filled with patrol points and <code class="Code-In-Text--PACKT-">MoveToNextPatrolLocation()</code> is called to set the destination position of the NavMeshAgent component to the first item at <code class="Code-In-Text--PACKT-">_locationIndex 0</code> in the list of locations. The next step is to <a id="_idIndexMarker653"/>have the enemy object move from the first patrol location to all the other locations in sequence.</p>&#13;
    <p class="normal">Our enemy moves to the first patrol point just fine, but then it stops. What we want is for it to continually move between each sequential location, which will require additional logic in <code class="Code-In-Text--PACKT-">Update()</code> and <code class="Code-In-Text--PACKT-">MoveToNextPatrolLocation()</code>. Let's create this behavior.</p>&#13;
    <p class="normal">Add the following code to <code class="Code-In-Text--PACKT-">EnemyBehavior</code> and hit play:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EnemyBehavior</span> : <span class="hljs-title">MonoBehaviour</span>  &#13;
{ &#13;
    <span class="hljs-comment">// ... No changes needed ... </span>&#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">void</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">Update</strong><strong class="hljs-function-slc">()</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 1</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc">(_agent.remainingDistance &lt; </strong><strong class="hljs-number-slc">0.2f</strong><strong class="hljs-slc"> &amp;&amp; !_agent.pathPending)</strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-comment-slc">// 2</strong></span><span class="hljs-comment"> </span>&#13;
            <span class="code-highlight"><strong class="hljs-slc">MoveToNextPatrolLocation();</strong></span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
    <span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">MoveToNextPatrolLocation</span><span class="hljs-function">()</span> &#13;
    { &#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 3</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (Locations.Count == </strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">)</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc">;</strong></span> &#13;
         &#13;
        _agent.destination = Locations[_locationIndex].position;&#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 4</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">_locationIndex = (_locationIndex + </strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">) % Locations.Count;</strong></span>&#13;
    }&#13;
    <span class="hljs-comment">// ... No other changes needed ... </span>&#13;
}&#13;
</code></pre>&#13;
    <p class="normal">Let's break down the code:</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">First, it declares the <code class="Code-In-Text--PACKT-">Update()</code> method and adds an <code class="Code-In-Text--PACKT-">if</code> statement to check whether two <a id="_idIndexMarker654"/>different conditions are true:<ul>&#13;
          <li class="bullet-l2"><code class="Code-In-Text--PACKT-">remainingDistance</code> returns how far the NavMeshAgent component currently is from its set destination<code class="Code-In-Text--PACKT-">,</code> so we're checking if that is less than 0.2.</li>&#13;
          <li class="bullet-l2"><code class="Code-In-Text--PACKT-">pathPending</code> returns a <code class="Code-In-Text--PACKT-">true</code> or <code class="Code-In-Text--PACKT-">false</code> Boolean, depending on whether Unity is computing a path for the NavMeshAgent component.</li>&#13;
        </ul>&#13;
      </li>&#13;
      <li class="numbered">If _<code class="Code-In-Text--PACKT-">agent</code> is very close to its destination, and no other path is being computed, the <code class="Code-In-Text--PACKT-">if</code> statement returns <code class="Code-In-Text--PACKT-">true</code> and calls <code class="Code-In-Text--PACKT-">MoveToNextPatrolLocation()</code>.</li>&#13;
      <li class="numbered">Here, we added an <code class="Code-In-Text--PACKT-">if</code> statement to make sure that <code class="Code-In-Text--PACKT-">Locations</code> isn't empty before the rest of the code in <code class="Code-In-Text--PACKT-">MoveToNextPatrolLocation()</code> is executed:<ul>&#13;
          <li class="bullet-l2">If <code class="Code-In-Text--PACKT-">Locations</code> is empty, we use the <code class="Code-In-Text--PACKT-">return</code> keyword to exit the method without continuing.&#13;
&#13;
    <div class="note">&#13;
      <p class="Information-Box--PACKT-">This is referred to as defensive programming, and, coupled with refactoring, it is an <a id="_idIndexMarker655"/>essential skill to have in your arsenal as you move toward more intermediate C# topics. We will consider refactoring at the end of the chapter.</p>&#13;
    </div></li>&#13;
        </ul>&#13;
      </li>&#13;
&#13;
      <li class="numbered" value="4">Then, we set <code class="Code-In-Text--PACKT-">_locationIndex</code> to its current value, <code class="Code-In-Text--PACKT-">+1</code>, followed by the modulo (<code class="Code-In-Text--PACKT-">%</code>) of <code class="Code-In-Text--PACKT-">Locations.Count</code>:<ul>&#13;
          <li class="bullet-l2">This will increment the index from 0 to 4 and then restart it at 0 so that our Enemy Prefab moves in a continuous path.</li>&#13;
          <li class="bullet-l2">The modulo operator returns the remainder of two values being divided—2 divided by 4 has a remainder of 2 when the result is an integer, so 2 % 4 = 2. Likewise, 4 divided by 4 has no remainder, so 4 % 4 = 0.</li>&#13;
        </ul>&#13;
      </li>&#13;
    </ol>&#13;
    <div class="note">&#13;
      <p class="Information-Box--PACKT-">Dividing an index by the maximum number of items in a collection is a quick way to always find the next item. If you're rusty on the modulo operator, revisit <em class="chapterRef">Chapter 2</em>, <em class="italic">The Building Blocks of Programming</em>.</p>&#13;
    </div>&#13;
    <p class="normal">We now need to check that the enemy is moving toward its set patrol location every frame in <code class="Code-In-Text--PACKT-">Update()</code>; when it <a id="_idIndexMarker656"/>gets close, <code class="Code-In-Text--PACKT-">MoveToNextPatrolLocation()</code> is fired, which increments <code class="Code-In-Text--PACKT-">_locationIndex</code> and sets the next patrol point as the destination.</p>&#13;
    <p class="normal">If you drag the <strong class="screenText">Scene</strong> view down next to the <strong class="screenText">Console</strong> window, as shown in the following screenshot, and hit play, you can watch the Enemy Prefab walk around the corners of the level in a continuous loop:</p>&#13;
    <figure class="mediaobject"><img src="Images/B17573_09_09.png" alt="" width="826" height="422"/></figure>&#13;
    <p class="packt_figref">Figure 9.9: Testing the enemy patrol route</p>&#13;
    <p class="normal">The enemy now follows the patrol route around the outside of the map, but it doesn't seek out the player and attack when it's within a preset range. You'll use the NavAgent component to do just that in the next section.</p>&#13;
    <h1 id="_idParaDest-198" class="title">Enemy game mechanics</h1>&#13;
    <p class="normal">Now that our enemy is on a continuous patrol circuit, it's time to give it some interaction mechanics <a id="_idIndexMarker657"/>of its own; there wouldn't be much risk or reward if we left it walking around with no way to act against us.</p>&#13;
    <h2 id="_idParaDest-199" class="title">Seek and destroy: changing the agent's destination</h2>&#13;
    <p class="normal">In this section, we'll be focusing on switching the target of the enemies' NavMeshAgent component when the player gets too close and dealing damage if a collision occurs. When the enemy <a id="_idIndexMarker658"/>successfully lowers the player's health, it will return to its patrol route until its next run-in with the player.</p>&#13;
    <p class="normal">However, we're not <a id="_idIndexMarker659"/>going to leave our player helpless; we'll also add in code to track enemy health, detect when an enemy is successfully hit with one of the player's bullets, and when an enemy needs to be destroyed.</p>&#13;
    <p class="normal">Now that the Enemy Prefab is moving around on patrol, we need to get a reference to the player's position and change the destination of NavMeshAgent if it gets too close.</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">Add the following code to <code class="Code-In-Text--PACKT-">EnemyBehavior</code>:&#13;
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EnemyBehavior</span> : <span class="hljs-title">MonoBehaviour</span>  &#13;
{ &#13;
    <span class="code-highlight"><strong class="hljs-comment-slc">// 1</strong></span><span class="hljs-comment"> </span>&#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> Transform Player;</strong></span>&#13;
    <span class="hljs-keyword">public</span> Transform PatrolRoute;&#13;
    <span class="hljs-keyword">public</span> List&lt;Transform&gt; Locations;&#13;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _locationIndex = <span class="hljs-number">0</span>;&#13;
    <span class="hljs-keyword">private</span> NavMeshAgent _agent;&#13;
    <span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">Start</span><span class="hljs-function">()</span> &#13;
    { &#13;
        _agent = GetComponent&lt;NavMeshAgent&gt;();&#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 2</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">Player = GameObject.Find(</strong><strong class="hljs-string-slc">"Player"</strong><strong class="hljs-slc">).transform;</strong></span> &#13;
        <span class="hljs-comment">// ... No other changes needed ... </span>&#13;
    } &#13;
    <span class="hljs-comment">/* ... No changes to Update,  </span>&#13;
<span class="hljs-comment">           InitializePatrolRoute, or  </span>&#13;
<span class="hljs-comment">           MoveToNextPatrolLocation ... */</span> &#13;
    <span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">OnTriggerEnter</span><span class="hljs-function">(</span><span class="hljs-params">Collider other</span><span class="hljs-function">)</span> &#13;
    { &#13;
        <span class="hljs-keyword">if</span>(other.name == <span class="hljs-string">"Player"</span>) &#13;
        { &#13;
            <span class="code-highlight"><strong class="hljs-comment-slc">// 3</strong></span><span class="hljs-comment"> </span>&#13;
            <span class="code-highlight"><strong class="hljs-slc">_agent.destination = Player.position;</strong></span>&#13;
            Debug.Log(<span class="hljs-string">"Enemy detected!"</span>);&#13;
        } &#13;
    } &#13;
    <span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">OnTriggerExit</span><span class="hljs-function">(</span><span class="hljs-params">Collider other</span><span class="hljs-function">)</span>&#13;
    { &#13;
        <span class="hljs-comment">// .... No changes needed ... </span>&#13;
    }&#13;
}&#13;
</code></pre>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="normal">Let's break down the code:</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">First, it declares a <code class="Code-In-Text--PACKT-">public</code> variable <a id="_idIndexMarker660"/>to hold the <code class="Code-In-Text--PACKT-">Player</code> capsule's <code class="Code-In-Text--PACKT-">Transform</code> value.</li>&#13;
      <li class="numbered">Then, we use <code class="Code-In-Text--PACKT-">GameObject.Find("Player")</code> to return a reference to the player object in the scene:<ul>&#13;
          <li class="bullet-l2">Adding <code class="Code-In-Text--PACKT-">.transform</code> directly <a id="_idIndexMarker661"/>references the object's <code class="Code-In-Text--PACKT-">Transform</code> value in the same line.</li>&#13;
        </ul>&#13;
      </li>&#13;
      <li class="numbered">Finally, we set <code class="Code-In-Text--PACKT-">_agent.destination</code> to the player's <code class="Code-In-Text--PACKT-">Vector3</code> position in <code class="Code-In-Text--PACKT-">OnTriggerEnter()</code> whenever the player enters the enemies' attack zone that we set up earlier with a Collider component.</li>&#13;
    </ol>&#13;
    <p class="normal">If you play the game now and get too close to the patrolling enemy, you'll see that it breaks from its path and <a id="_idIndexMarker662"/>comes straight for you. Once it reaches the player, the code in the <code class="Code-In-Text--PACKT-">Update()</code> method takes over again and the Enemy Prefab<a id="_idIndexMarker663"/> resumes its patrol.</p>&#13;
    <p class="normal">We still need the enemy to be able to hurt the player in some way, which we'll learn how to do in the next section.</p>&#13;
    <h2 id="_idParaDest-200" class="title">Lowering player health</h2>&#13;
    <p class="normal">While our enemy<a id="_idIndexMarker664"/> mechanic has come a long way, it's still anti-climactic to have nothing happen when the Enemy <a id="_idIndexMarker665"/>Prefab collides with the player Prefab. To fix this, we'll tie in the new enemy mechanics with the game manager.</p>&#13;
    <p class="normal">Update <code class="Code-In-Text--PACKT-">PlayerBehavior</code> with the following code and hit play:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PlayerBehavior</span> : <span class="hljs-title">MonoBehaviour</span>  &#13;
{ &#13;
    <span class="hljs-comment">// ... No changes to public variables needed ... </span>&#13;
    <span class="code-highlight"><strong class="hljs-comment-slc">// 1</strong></span><span class="hljs-comment"> </span>&#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> GameBehavior _gameManager;</strong></span>&#13;
    <span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">Start</span><span class="hljs-function">()</span> &#13;
    { &#13;
        _rb = GetComponent&lt;Rigidbody&gt;();&#13;
        _col = GetComponent&lt;CapsuleCollider&gt;();&#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 2</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">_gameManager = GameObject.Find(</strong><strong class="hljs-string-slc">"Game_Manager"</strong><strong class="hljs-slc">).GetComponent&lt;GameBehavior&gt;();</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-slc">}</strong></span> &#13;
    <span class="hljs-comment">/* ... No changes to Update,  </span>&#13;
<span class="hljs-comment">           FixedUpdate, or  </span>&#13;
<span class="hljs-comment">           IsGrounded ... */</span> &#13;
    <span class="code-highlight"><strong class="hljs-comment-slc">// 3</strong></span><span class="hljs-comment"> </span>&#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">void</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">OnCollisionEnter</strong><strong class="hljs-function-slc">(</strong><strong class="hljs-params-slc">Collision collision</strong><strong class="hljs-function-slc">)</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-slc">{</strong></span>&#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 4</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc">(collision.gameObject.name == </strong><strong class="hljs-string-slc">"Enemy"</strong><strong class="hljs-slc">)</strong></span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">{</strong></span>&#13;
            <span class="code-highlight"><strong class="hljs-comment-slc">// 5</strong></span><span class="hljs-comment"> </span>&#13;
            <span class="code-highlight"><strong class="hljs-slc">_gameManager.HP -= </strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">;</strong></span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
}&#13;
</code></pre>&#13;
    <p class="normal">Let's break down the code:</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">First, it declares a <code class="Code-In-Text--PACKT-">private</code> variable to hold the reference to the instance of <code class="Code-In-Text--PACKT-">GameBehavior</code> we have in the scene.</li>&#13;
      <li class="numbered">Then, it finds and returns the <code class="Code-In-Text--PACKT-">GameBehavior</code> script that's attached to the <code class="Code-In-Text--PACKT-">Game Manager</code> object in the scene:<ul>&#13;
          <li class="bullet-l2">Using <code class="Code-In-Text--PACKT-">GetComponent()</code> on the same line as <code class="Code-In-Text--PACKT-">GameObject.Find()</code> is a common way to cut down on unnecessary lines of code.</li>&#13;
        </ul>&#13;
      </li>&#13;
      <li class="numbered">Since our player is <a id="_idIndexMarker666"/>the object being collided with, it makes sense to declare <code class="Code-In-Text--PACKT-">OnCollisionEnter()</code> in <code class="Code-In-Text--PACKT-">PlayerBehavior</code>.</li>&#13;
      <li class="numbered">Next, we check<a id="_idIndexMarker667"/> for the name of the colliding object; if it's the Enemy Prefab, we execute the body of the <code class="Code-In-Text--PACKT-">if</code> statement.</li>&#13;
      <li class="numbered">Finally, we subtract <code class="Code-In-Text--PACKT-">1</code> from the public <code class="Code-In-Text--PACKT-">HP</code> variable using the <code class="Code-In-Text--PACKT-">_gameManager</code> instance.</li>&#13;
    </ol>&#13;
    <p class="normal">Whenever the enemy now tracks and collides with the player, the game manager will fire the set property on HP. The UI will update with a new value for player health, which means we have an opportunity to put in some additional logic for the loss condition later on.</p>&#13;
    <h2 id="_idParaDest-201" class="title">Detecting bullet collisions</h2>&#13;
    <p class="normal">Now that we have <a id="_idIndexMarker668"/>our loss condition, it's time to add in a way for our player to<a id="_idIndexMarker669"/> fight back and survive enemy attacks.</p>&#13;
    <p class="normal">Open up <code class="Code-In-Text--PACKT-">EnemyBehavior</code> and modify it with the following code:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EnemyBehavior</span> : <span class="hljs-title">MonoBehaviour</span>  &#13;
{ &#13;
    <span class="hljs-comment">//... No other variable changes needed ... </span>&#13;
    <span class="code-highlight"><strong class="hljs-comment-slc">// 1</strong></span><span class="hljs-comment"> </span>&#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc"> _lives = </strong><strong class="hljs-number-slc">3</strong><strong class="hljs-slc">;</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc"> EnemyLives </strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 2</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc"> { </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> _lives; }</strong></span>&#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 3</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc"> </strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-slc">_lives = </strong><strong class="hljs-keyword-slc">value</strong><strong class="hljs-slc">;</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-comment-slc">// 4</strong></span><span class="hljs-comment"> </span>&#13;
            <span class="code-highlight"><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (_lives &lt;= </strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">)</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
                <span class="code-highlight"><strong class="hljs-slc">Destroy(</strong><strong class="hljs-keyword-slc">this</strong><strong class="hljs-slc">.gameObject);</strong></span> &#13;
                <span class="code-highlight"><strong class="hljs-slc">Debug.Log(</strong><strong class="hljs-string-slc">"Enemy down."</strong><strong class="hljs-slc">);</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
    <span class="hljs-comment">/* ... No changes to Start,  </span>&#13;
<span class="hljs-comment">           Update,  </span>&#13;
<span class="hljs-comment">           InitializePatrolRoute,  </span>&#13;
<span class="hljs-comment">           MoveToNextPatrolLocation,  </span>&#13;
<span class="hljs-comment">           OnTriggerEnter, or  </span>&#13;
<span class="hljs-comment">           OnTriggerExit ... */</span> &#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">void</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">OnCollisionEnter</strong><strong class="hljs-function-slc">(</strong><strong class="hljs-params-slc">Collision collision</strong><strong class="hljs-function-slc">)</strong></span> &#13;
    <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-comment-slc">// 5</strong></span><span class="hljs-comment"> </span>&#13;
        <span class="code-highlight"><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc">(collision.gameObject.name == </strong><strong class="hljs-string-slc">"Bullet(Clone)"</strong><strong class="hljs-slc">)</strong></span> &#13;
        <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-comment-slc">// 6</strong></span><span class="hljs-comment"> </span>&#13;
            <span class="code-highlight"><strong class="hljs-slc">EnemyLives -= </strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">;</strong></span>&#13;
            <span class="code-highlight"><strong class="hljs-slc">Debug.Log(</strong><strong class="hljs-string-slc">"Critical hit!"</strong><strong class="hljs-slc">);</strong></span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
}&#13;
</code></pre>&#13;
    <p class="normal">Let's break <a id="_idIndexMarker670"/>down the <a id="_idIndexMarker671"/>code:</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">First, it declares a <code class="Code-In-Text--PACKT-">private int</code> variable called <code class="Code-In-Text--PACKT-">_lives</code> with a <code class="Code-In-Text--PACKT-">public</code> backing variable called <code class="Code-In-Text--PACKT-">EnemyLives</code>. This will let us control how <code class="Code-In-Text--PACKT-">EnemyLives</code> is referenced and set, just like in <code class="Code-In-Text--PACKT-">GameBehavior</code>.</li>&#13;
      <li class="numbered">Then, we set the <code class="Code-In-Text--PACKT-">get</code> property to always return <code class="Code-In-Text--PACKT-">_lives</code>.</li>&#13;
      <li class="numbered">Next, we use <code class="Code-In-Text--PACKT-">private set</code> to <a id="_idIndexMarker672"/>assign the new value of <code class="Code-In-Text--PACKT-">EnemyLives</code> to <code class="Code-In-Text--PACKT-">_lives</code> to keep them both in sync.<div class="note">&#13;
          <p class="Information-Box--PACKT-">We haven't seen <code class="Code-In-Text--PACKT-">private get</code> or <code class="Code-In-Text--PACKT-">set</code> before, but they can have their access modifiers, just like any other executable code. Declaring <code class="Code-In-Text--PACKT-">get</code> or <code class="Code-In-Text--PACKT-">set</code> as <code class="Code-In-Text--PACKT-">private</code> means that only the parent class has access to their functionality.</p>&#13;
        </div>&#13;
      </li>&#13;
      <li class="numbered">Then, we add an <code class="Code-In-Text--PACKT-">if</code> statement to check whether <code class="Code-In-Text--PACKT-">_lives</code> is less than or equal to 0, meaning that the enemy should be dead:<ul>&#13;
          <li class="bullet-l2">When that's the case, we destroy the <code class="Code-In-Text--PACKT-">Enemy</code> GameObject and print out a message to the console.</li>&#13;
        </ul>&#13;
      </li>&#13;
      <li class="numbered">Because <code class="Code-In-Text--PACKT-">Enemy</code> is the object getting hit with bullets, it's sensible to include a check for those collisions in <code class="Code-In-Text--PACKT-">EnemyBehavior</code> with <code class="Code-In-Text--PACKT-">OnCollisionEnter()</code>.</li>&#13;
      <li class="numbered">Finally, if the name of the <a id="_idIndexMarker673"/>colliding object matches a bullet clone object, we decrement <code class="Code-In-Text--PACKT-">EnemyLives</code> by <code class="Code-In-Text--PACKT-">1</code> and print out another message.</li>&#13;
    </ol>&#13;
    <div class="note">&#13;
      <p class="Information-Box--PACKT-">Notice that the name we're checking for is <code class="Code-In-Text--PACKT-">Bullet(Clone)</code>, even though our bullet Prefab is named <code class="Code-In-Text--PACKT-">Bullet</code>. This is because Unity adds the <code class="Code-In-Text--PACKT-">(Clone)</code> suffix to any object created with the <code class="Code-In-Text--PACKT-">Instantiate()</code> method, which is how we made them in our shooting logic.</p>&#13;
      <p class="Information-Box--PACKT-">You can also check for the GameObjects' tag, but since that's a Unity-specific feature, we're going to leave the code as-is and do things with pure C#.</p>&#13;
    </div>&#13;
    <p class="normal">Now, the player can fight back when the enemy tries to take one of its lives by shooting it three times and destroying it. Again, our use of the <code class="Code-In-Text--PACKT-">get</code> and <code class="Code-In-Text--PACKT-">set</code> properties to handle additional logic proves to be a flexible and scalable solution. With that done, your final task is to update the game manager with a loss condition.</p>&#13;
    <h2 id="_idParaDest-202" class="title">Updating the game manager</h2>&#13;
    <p class="normal">To fully <a id="_idIndexMarker674"/>implement the loss <a id="_idIndexMarker675"/>condition, we need to update the manager class:</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">Open up <code class="Code-In-Text--PACKT-">GameBehavior</code> and add the following code:&#13;
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GameBehavior</span> : <span class="hljs-title">MonoBehaviour</span>  &#13;
{ &#13;
    <span class="hljs-comment">// ... No other variable changes... </span>&#13;
    <span class="code-highlight"><strong class="hljs-comment-slc">// 1 </strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> Button LossButton;</strong></span> &#13;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _itemsCollected = <span class="hljs-number">0</span>; &#13;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Items &#13;
    { &#13;
        <span class="hljs-comment">// ... No changes needed ... </span>&#13;
    } &#13;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _playerHP = <span class="hljs-number">10</span>; &#13;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> HP &#13;
    { &#13;
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> _playerHP; } &#13;
        <span class="hljs-keyword">set</span> {  &#13;
            _playerHP = <span class="hljs-keyword">value</span>; &#13;
                HealthText.text = <span class="hljs-string">"Player Health: "</span> + HP; &#13;
            <span class="code-highlight"><strong class="hljs-comment-slc">// 2</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc">(_playerHP &lt;= </strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">)</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
                <span class="code-highlight"><strong class="hljs-slc">ProgressText.text= </strong><strong class="hljs-string-slc">"You want another life with</strong></span> <span class="code-highlight"><strong class="hljs-string-slc">that?"</strong><strong class="hljs-slc">;</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-slc">LossButton.gameObject.SetActive(</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">); </strong></span>&#13;
                <span class="code-highlight"><strong class="hljs-slc">Time.timeScale = </strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">; </strong></span>&#13;
            <span class="code-highlight"><strong class="hljs-slc">}</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-keyword-slc">else</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-slc">{</strong></span> &#13;
                <span class="code-highlight"><strong class="hljs-slc">ProgressText.text = </strong><strong class="hljs-string-slc">"Ouch... that's got hurt."</strong><strong class="hljs-slc">;</strong></span> &#13;
            <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
        }&#13;
    }&#13;
}&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numbered">In the <strong class="screenText">Hierarchy</strong> window, right-click <a id="_idIndexMarker676"/>on <strong class="screenText">Win Condition</strong>, choose <strong class="screenText">Duplicate</strong>, and name it <strong class="screenText">Loss Condition</strong>:<ul>&#13;
          <li class="bullet-l2">Click the arrow to the left of <strong class="screenText">Loss Condition</strong> to expand it, select the <strong class="screenText">Text </strong>object, and <a id="_idIndexMarker677"/>change the text to <strong class="screenText">You lose...</strong></li>&#13;
        </ul>&#13;
      </li>&#13;
      <li class="numbered">Select <strong class="screenText">Game_Manager</strong> in the <strong class="screenText">Hierarchy </strong>window and drag <strong class="screenText">Loss Condition</strong> into the <strong class="screenText">Loss Button</strong> slot<a id="_idIndexMarker678"/> in the <strong class="screenText">Game Behavior (Script)</strong> component:<figure class="mediaobject"><img src="Images/B17573_09_11.png" alt="" width="750" height="540"/></figure>&#13;
    <p class="packt_figref">Figure 9.10: Game behavior script with text and button variables completed in the Inspector pane</p>&#13;
      </li>&#13;
    </ol>&#13;
&#13;
    <p class="normal">Let's break down the code:</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">First, we declare a new button that we want to show when the player loses the game.</li>&#13;
      <li class="numbered">Then, we add in an <code class="Code-In-Text--PACKT-">if</code> statement to check when <code class="Code-In-Text--PACKT-">_playerHP</code> drops below <code class="Code-In-Text--PACKT-">0</code>:<ul>&#13;
          <li class="bullet-l2">If it's <code class="Code-In-Text--PACKT-">true</code>, <code class="Code-In-Text--PACKT-">ProgessText</code> and <code class="Code-In-Text--PACKT-">Time.timeScale</code> are updated and the loss button is activated.</li>&#13;
          <li class="bullet-l2">If the player is still alive following an enemy collision, <code class="Code-In-Text--PACKT-">ProgessText</code> shows a different message: "Ouch… that's got to hurt.".</li>&#13;
        </ul>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="normal">Now, change _<code class="Code-In-Text--PACKT-">playerHP</code> to 1 in <code class="Code-In-Text--PACKT-">GameBehavior.cs</code> and get the Enemy Prefab to collide with you and observe what happens.</p>&#13;
    <p class="normal">That's a wrap! You've successfully added a "smart" enemy that can damage the player and be damaged right back, as well <a id="_idIndexMarker679"/>as a loss screen through the game manager. Before we finish this chapter, there's one more important topic that we need to <a id="_idIndexMarker680"/>discuss, and that's how to avoid repeating code. </p>&#13;
    <p class="normal">Repeated code is the bane of all programmers, so it makes sense that you learn how to keep it out of your projects early on!</p>&#13;
    <h1 id="_idParaDest-203" class="title">Refactoring and keeping it DRY</h1>&#13;
    <p class="normal">The <strong class="keyword">Don't Repeat Yourself</strong> (<strong class="keyword">DRY</strong>) acronym is the software developer's conscience: it tells you when you're in <a id="_idIndexMarker681"/>danger of making a bad or questionable decision, and gives you a feeling of satisfaction after a job well done.</p>&#13;
    <p class="normal">In practice, repeated code is part of programming life. Trying to avoid it by constantly thinking ahead will put up so many roadblocks in your project that it won't seem worthwhile carrying on. A more efficient—and sane—approach to dealing with repeating code is to quickly <a id="_idIndexMarker682"/>identify it when and where it occurs and then look for the best way to remove it. This task is called refactoring, and our <code class="Code-In-Text--PACKT-">GameBehavior</code> class could use a little of its magic right now.</p>&#13;
    <p class="normal">You may have noticed that we set the progress text and timescale in two separate places, but we could easily make ourselves a utility method to do this for us in a single place.</p>&#13;
    <p class="normal">To refactor the existing code, you'll need to update <code class="Code-In-Text--PACKT-">GameBehavior.cs</code> as follows:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GameBehavior</span>: <span class="hljs-title">MonoBehaviour</span>&#13;
{&#13;
    <span class="code-highlight"><strong class="hljs-comment-slc">// 1</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-keyword-slc">public</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-keyword-slc">void</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">UpdateScene</strong><strong class="hljs-function-slc">(</strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-params-slc"> updatedText</strong><strong class="hljs-function-slc">)</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-slc">{</strong></span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">ProgressText.text = updatedText;</strong></span>&#13;
        <span class="code-highlight"><strong class="hljs-slc">Time.timeScale = </strong><strong class="hljs-number-slc">0f</strong><strong class="hljs-slc">;</strong></span>&#13;
    <span class="code-highlight"><strong class="hljs-slc">}</strong></span>&#13;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _itemsCollected = <span class="hljs-number">0</span>;&#13;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Items&#13;
    {&#13;
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> _itemsCollected; }&#13;
        <span class="hljs-keyword">set</span>&#13;
        {&#13;
            _itemsCollected = <span class="hljs-keyword">value</span>;&#13;
            ItemText.text = <span class="hljs-string">"Items Collected: "</span> + Items;&#13;
            <span class="hljs-keyword">if</span> (_itemsCollected &gt;= MaxItems)&#13;
            {&#13;
                WinButton.gameObject.SetActive(<span class="hljs-literal">true</span>);&#13;
                <span class="code-highlight"><strong class="hljs-comment-slc">// 2</strong></span>&#13;
                <span class="code-highlight"><strong class="hljs-slc">UpdateScene(</strong><strong class="hljs-string-slc">"You've found all the items!"</strong><strong class="hljs-slc">);</strong></span>&#13;
            }&#13;
            <span class="hljs-keyword">else</span>&#13;
            {&#13;
                ProgressText.text = <span class="hljs-string">"Item found, only "</span> + (MaxItems - _itemsCollected) + <span class="hljs-string">" more to go!"</span>;&#13;
            }&#13;
        }&#13;
    }&#13;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _playerHP = <span class="hljs-number">10</span>;&#13;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> HP&#13;
    {&#13;
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> _playerHP; }&#13;
        <span class="hljs-keyword">set</span>&#13;
        {&#13;
            _playerHP = <span class="hljs-keyword">value</span>;&#13;
            HealthText.text = <span class="hljs-string">"Player Health: "</span> + HP;&#13;
            <span class="hljs-keyword">if</span> (_playerHP &lt;= <span class="hljs-number">0</span>)&#13;
            {&#13;
                LossButton.gameObject.SetActive(<span class="hljs-literal">true</span>);&#13;
                <span class="code-highlight"><strong class="hljs-comment-slc">// 3</strong></span>&#13;
                <span class="code-highlight"><strong class="hljs-slc">UpdateScene(</strong><strong class="hljs-string-slc">"You want another life with that?"</strong><strong class="hljs-slc">);</strong></span>&#13;
            }&#13;
            <span class="hljs-keyword">else</span>&#13;
            {&#13;
                ProgressText.text = <span class="hljs-string">"Ouch... that's got hurt."</span>;&#13;
            }&#13;
            Debug.LogFormat(<span class="hljs-string">"Lives: {0}"</span>, _playerHP);&#13;
        }&#13;
    }&#13;
}&#13;
</code></pre>&#13;
    <p class="normal">Let's break down the code:</p>&#13;
    <ol>&#13;
      <li class="numbered" value="1">We declared a new method called <code class="Code-In-Text--PACKT-">UpdateScene</code>, which takes in a string parameter that <a id="_idIndexMarker683"/>we want to assign to <code class="Code-In-Text--PACKT-">ProgressText</code> and sets <code class="Code-In-Text--PACKT-">Time.timeScale</code> to <code class="Code-In-Text--PACKT-">0</code>.</li>&#13;
      <li class="numbered">We deleted our first instance of duplicated code and used our new method to update our scene when the game is won.</li>&#13;
      <li class="numbered">We deleted our second instance of duplicated code and update the scene when the game is lost.</li>&#13;
    </ol>&#13;
    <p class="normal">There's always more to refactor if you look in the right places.</p>&#13;
    <h1 id="_idParaDest-204" class="title">Summary</h1>&#13;
    <p class="normal">With that, our enemy and player interactions are complete. We can dish out damage as well as take it, lose lives, and fight back, all while updating the on-screen GUI. Our enemies use Unity's navigation system to walk around the arena and change to attack mode when within a specified range of the player. Each GameObject is responsible for its behavior, internal logic, and object collisions, while the game manager keeps track of the variables that govern the game's state. Lastly, we learned about simple procedural programming and how much cleaner code can be when repeated instructions are abstracted out into their methods.</p>&#13;
    <p class="normal">You should feel a sense of accomplishment at this point, especially if you started this book as a total beginner. Getting up to speed with a new programming language while building a working game is no easy trick. In the next chapter, you'll be introduced to some intermediate topics in C#, including new type modifiers, method overloading, interfaces, and class extensions.</p>&#13;
    <h1 id="_idParaDest-205" class="title">Pop quiz – AI and navigation</h1>&#13;
    <ol>&#13;
      <li class="numbered" value="1">How is a NavMesh component created in a Unity scene?</li>&#13;
      <li class="numbered">What component identifies a GameObject to a NavMesh?</li>&#13;
      <li class="numbered">Executing the same logic on one or more sequential objects is an example of which programming technique?</li>&#13;
      <li class="numbered">What does the DRY acronym stand for?</li>&#13;
    </ol>&#13;
    <h1 class="heading-1">JOIN us on Discord!</h1>&#13;
    <p class="normal">Read this book alongside other users, Unity/C# experts, and Harrison Ferrone. Ask questions, provide solutions to other readers, chat with the author via <em class="italic">Ask Me Anything sessions</em> and much more.</p>&#13;
<p class="normal">Join Now! </p>&#13;
    <p class="normal"><a href="https://packt.link/csharpunity2021"><span class="url">https://packt.link/csharpunity2021</span></a></p>&#13;
    <p class="normal"><span class="url"><img style="height: 8em; width: auto;" src="Images/QR_Code_9781801813945.png" alt="" width="354" height="354"/></span></p>&#13;
  </div>&#13;
</div></body></html>