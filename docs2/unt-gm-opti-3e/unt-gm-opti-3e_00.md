# 前言

用户体验是任何游戏的关键组成部分。这不仅包括我们游戏的故事和玩法，还包括图形的流畅度、游戏连接到多人服务器的可靠性、对用户输入的响应性，甚至由于移动设备和云下载的普及，最终应用程序文件的大小。由于 Unity 等工具的出现，游戏开发的门槛大大降低，这些工具提供了大量有用的开发功能，同时仍然对个人开发者开放。然而，由于游戏行业的竞争激烈，玩家对我们期望提供的最终产品质量的要求每天都在提高。我们应该预料到玩家和评论家会仔细审查我们游戏的每一个方面。

性能优化的目标与用户体验紧密相连。优化不良的游戏可能导致帧率低、冻结、崩溃、输入延迟、加载时间长、运行时行为不一致和抖动、物理引擎故障，甚至过度高的电池功耗（对于移动设备来说，这是一个常被忽视的指标）。仅仅一个这些问题就可能是游戏开发者最可怕的噩梦，因为评论往往会集中在我们做得不好的那一点上，而忽略我们做得好的所有事情。

性能优化的一个目标是要充分利用可用的资源，包括 CPU 资源，如消耗的周期数、我们使用的内存空间（称为 RAM），以及**图形处理单元**（**GPU**）资源，这包括其自身的内存空间（称为 VRAM）、填充率、内存带宽等。然而，性能优化的最重要的目标是确保没有任何单一资源在不适时造成瓶颈，并且最高优先级任务首先得到处理。即使是微小的、间歇性的性能波动和迟钝也可能将玩家从体验中拉出来，破坏游戏沉浸感，限制我们创造预期体验的潜力。另一个考虑因素是，我们能够节省的资源越多，我们就能在我们的游戏中实施更多的活动，从而产生更令人兴奋和动态的游戏玩法。

决定何时退一步停止进行性能提升也是至关重要的。在一个时间和资源无限的世界里，总有另一种方法可以使它变得更好、更快、更高效。在开发过程中，我们必须决定产品已经达到了可接受的质量水平。如果不这样做，我们可能会陷入反复实施变化，而这些变化带来的实际效益很小或没有，而且每次变化也都有可能引入更多的错误。

判断一个性能问题是否值得修复的最佳方式是回答这个问题：“用户会注意到吗？”如果这个问题的答案是“不会”，那么性能优化将是一种徒劳的努力。在软件开发中有一个古老的谚语：

过早的优化是万恶之源。

过早的优化是重构和重构代码以增强性能的致命罪过，没有任何证据表明这是必要的。这可能意味着在没有表明性能问题甚至存在的情况下进行更改，或者在我们没有证明一个性能问题可能来自特定区域之前，就认为它可能来自该区域。

当然，唐纳德·克努特（Donald Knuth）这个常见说法的原始版本继续说道，我们仍然应该编写我们的代码以避免更直接和明显的问题。然而，真正的性能优化工作在项目末尾可能需要花费很多时间，我们应该计划时间来适当打磨产品，同时避免在没有任何有效证据的情况下实施更昂贵和耗时的更改。这类错误已经让软件开发者作为一个整体，浪费了大量的工作时间。

本书旨在为您提供检测和修复 Unity 应用程序中性能问题的工具、知识和技能，无论这些问题源自何处。这些瓶颈可能出现在硬件组件中，如 CPU、GPU 和 RAM，或者出现在软件子系统，如物理、渲染和 Unity 引擎本身。

优化我们游戏性能将大大提高它们在每天充斥着新高质量游戏的竞争激烈的市场中成功和脱颖而出的机会。

# 本书面向的对象

本书旨在为想要学习使用最新 Unity 版本构建高性能游戏的开发者提供优化技术。

# 本书涵盖的内容

第一章，*评估性能问题*，提供了对 Unity Profiler 的探索，以及一系列用于分析我们的应用程序、检测性能瓶颈和进行根本原因分析的方法。

第二章，*脚本策略*，讨论了我们的 Unity C#脚本代码的最佳实践，最小化 MonoBehaviour 回调开销，改进对象间通信等。

第三章，*批处理的好处*，探讨了 Unity 的动态批处理和静态批处理系统，以及如何利用它们来减轻渲染管道的负担。

第四章，*优化您的艺术资产*，帮助您了解艺术资产背后的技术，并学习如何避免导入、压缩和编码中的常见陷阱。

第五章，*更快的物理*，探讨了 Unity 内部物理引擎的细微差别，无论是用于 3D 还是 2D 游戏，以及如何正确组织我们的物理对象以改善性能。

第六章，*动态图形*，深入探讨了渲染管线，以及如何改善在 GPU 或 CPU 中遭受渲染瓶颈的应用程序，如何优化图形效果，如光照、阴影和粒子效果，优化着色器代码的方法，以及针对移动设备的特定图形优化。

第七章，*虚拟和增强现实优化*，专注于 VR 和 AR 等新兴娱乐媒介，并包括一些针对这些平台构建的应用程序的性能优化独特技术。

第八章，*精湛的内存管理*，探讨了 Unity 引擎、Mono 框架的内部工作原理，以及如何在这些组件中管理内存以保护我们的应用程序免受过多的堆分配和运行时垃圾回收的影响。

第九章，*面向数据的技术堆栈*，探讨了 Unity 针对多线程密集型游戏的新优化：DOTS。我们介绍了新的 C#作业系统、新的 Unity ECS 和 burst 编译器。

第十章，*战术技巧和窍门*，以 Unity 专业人士使用的众多实用技术结束本书，这些技术用于改善项目工作流程和场景管理。

# 为了充分利用本书

本书的大部分内容将专注于适用于 Unity 2019 和 Unity 2020 的功能和增强。本书中探讨的许多技术也可以应用于 Unity 2018 项目以及更早的版本，但某些功能可能会有所不同。这些差异将在适用的情况下进行突出显示。

值得注意的是，代码本应适用于 Unity 2020，但在撰写本文时，我们只能在 alpha 版本上对其进行测试。当 Unity 2020 退出 alpha 版本时，可能还会出现其他不兼容性。

# 下载示例代码文件

您可以从[www.packt.com](http://www.packt.com)的账户下载本书的示例代码文件。如果您在其他地方购买了本书，您可以访问[www.packtpub.com/support](https://www.packtpub.com/support)并注册，以便将文件直接通过电子邮件发送给您。

您可以通过以下步骤下载代码文件：

1.  在[www.packt.com](http://www.packt.com)登录或注册。

1.  选择支持选项卡。

1.  点击代码下载。

1.  在搜索框中输入书籍名称，并遵循屏幕上的说明。

文件下载后，请确保使用最新版本的以下软件解压或提取文件夹：

+   WinRAR/7-Zip for Windows

+   Zipeg/iZip/UnRarX for Mac

+   7-Zip/PeaZip for Linux

该书的代码包也托管在 GitHub 上，网址为 [`github.com/PacktPublishing/Unity-Game-Optimization-Third-Edition`](https://github.com/PacktPublishing/Unity-Game-Optimization-Third-Edition)。如果代码有更新，它将在现有的 GitHub 仓库中更新。

我们还有其他来自我们丰富的书籍和视频目录的代码包，可在 [`github.com/PacktPublishing/`](https://github.com/PacktPublishing/) 找到。去看看吧！

# 下载彩色图像

我们还提供了一份包含本书中使用的截图/图表彩色图像的 PDF 文件。您可以从这里下载：[`static.packt-cdn.com/downloads/9781838556518_ColorImages.pdf`](https://static.packt-cdn.com/downloads/9781838556518_ColorImages.pdf)。

# 使用的约定

本书使用了多种文本约定。

`CodeInText`：表示文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 账号。以下是一个示例：“这些可以通过 `UnityEngine.Profiling.Profiler` 类及其 `BeginSample()` 和 `EndSample()` 方法访问。”

代码块设置如下：

```cs
void DoSomethingCompletelyStupid() { 
  Profiler.BeginSample("My Profiler Sample");  
  List<int> listOfInts = new List<int>();  
  for(int i = 0; i < 1000000; ++i) {    
    listOfInts.Add(i);  
  }
  Profiler.EndSample();
}
```

**粗体**：表示新术语、重要单词或您在屏幕上看到的单词。例如，菜单或对话框中的单词在文本中显示如下。以下是一个示例：“当 Unity 应用程序以开发模式编译时。”

警告或重要注意事项看起来像这样。

小贴士和技巧看起来像这样。

# 联系我们

我们欢迎读者的反馈。

**一般反馈**：如果您对本书的任何方面有疑问，请在邮件主题中提及书名，并通过 `customercare@packtpub.com` 邮箱联系我们。

**勘误表**：尽管我们已经尽一切努力确保内容的准确性，但错误仍然可能发生。如果您在这本书中发现了错误，我们将不胜感激，如果您能向我们报告，我们将不胜感激。请访问 [www.packtpub.com/support/errata](https://www.packtpub.com/support/errata)，选择您的书籍，点击勘误提交表单链接，并输入详细信息。

**盗版**：如果您在互联网上以任何形式遇到我们作品的非法副本，我们将不胜感激，如果您能提供位置地址或网站名称，我们将不胜感激。请通过 `copyright@packt.com` 联系我们，并提供材料的链接。

**如果您想成为一名作者**：如果您在某个领域有专业知识，并且对撰写或参与一本书籍感兴趣，请访问 [authors.packtpub.com](http://authors.packtpub.com/).

# 评论

请留下评论。一旦您阅读并使用了这本书，为何不在您购买它的网站上留下评论呢？潜在的读者可以看到并使用您的客观意见来做出购买决定，Packt 的我们能够了解您对我们产品的看法，我们的作者也可以看到他们对书籍的反馈。谢谢！

如需了解 Packt 的更多信息，请访问 [packt.com](http://www.packt.com/).
