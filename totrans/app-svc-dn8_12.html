<html><head></head><body>
  <div><h1 class="chapterNumber">12</h1>
    <h1 class="chapterTitle" id="_idParaDest-436">Combining Data Sources Using GraphQL</h1>
    <p class="normal">In this chapter, you will be introduced to GraphQL, a service technology that provides a more modern approach to combining data from various sources and then providing a standard way to query that data.</p>
    <p class="normal">This chapter will cover the following topics:</p>
    <ul>
      <li class="bulletList">Understanding GraphQL</li>
      <li class="bulletList">Building a service that supports GraphQL</li>
      <li class="bulletList">Defining GraphQL queries for EF Core models</li>
      <li class="bulletList">Building .NET clients for a GraphQL service</li>
      <li class="bulletList">Implementing GraphQL mutations</li>
      <li class="bulletList">Implementing GraphQL subscriptions</li>
    </ul>
    <h1 class="heading-1" id="_idParaDest-437">Understanding GraphQL</h1>
    <p class="normal">In <em class="chapterRef">Chapter 8</em>, <em class="italic">Building and Securing Web Services Using Minimal APIs</em>, you learned how to define a Web API service<a id="_idIndexMarker1208"/> by mapping request path endpoints to lambda expressions or methods that return the response. Any parameters and the format of responses are under the control of the service. A client cannot ask for what they exactly need or use more efficient data formats.</p>
    <p class="normal">If you completed the online-only section, <em class="italic">Exposing Data via the Web Using OData</em>, then you know that OData has a built-in query language for the client to control what data they want to be returned. However, OData has a rather old-fashioned approach and is tied to the HTTP standard, for example, using query strings in an HTTP request.</p>
    <p class="normal">If you would prefer to use a more modern and flexible technology to combine and expose your data as a service, then a good alternative is <strong class="keyWord">GraphQL</strong>.</p>
    <p class="normal">Like OData, GraphQL is a standard<a id="_idIndexMarker1209"/> for describing your data and then querying it that gives the client control over exactly what they need. It was developed internally by Facebook in 2012 before being open sourced in 2015, and it is now managed by the GraphQL Foundation.</p>
    <p class="normal">Some of the key benefits<a id="_idIndexMarker1210"/> of GraphQL over OData are:</p>
    <ul>
      <li class="bulletList">GraphQL does not require HTTP because it is transport-agnostic, so you could use alternative transport protocols like WebSockets or TCP.</li>
      <li class="bulletList">GraphQL has more client libraries for different platforms than OData has.</li>
      <li class="bulletList">GraphQL has a single endpoint, usually simply <code class="inlineCode">/graphql</code>.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-438">GraphQL query document format</h2>
    <p class="normal">GraphQL uses its own document<a id="_idIndexMarker1211"/> format for its queries, which are a bit like JSON, but GraphQL queries do not require commas between field names, as shown in the following query, which requests some fields and related data for the product with an ID of <code class="inlineCode">23</code>:</p>
    <pre class="programlisting code"><code class="hljs-code">{
  product (productId: 23) {
    productId
    productName
    unitPrice
    supplier {
      companyName
      country
    }
  }
}
</code></pre>
    <div><p class="normal">The official media type for GraphQL query documents is <code class="inlineCode">application/graphql</code>.</p>
    </div>
    <h3 class="heading-3" id="_idParaDest-439">Requesting fields</h3>
    <p class="normal">The most basic GraphQL query requests<a id="_idIndexMarker1212"/> one or more fields from a type, for example, requesting three fields for each <code class="inlineCode">customer</code> entity, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code"># The query keyword is optional. Comments are prefixed with #.
query {
  customer {
    customerId
    companyName
    country
  }
}
</code></pre>
    <p class="normal">The response is in the JSON format, for example, an array of <code class="inlineCode">customer</code> objects, as shown in the following document:</p>
    <pre class="programlisting code"><code class="hljs-code">{
  "data": [
    {
      "customerId": "ALFKI",
      "companyName": "Alfreds Futterkiste",
      "country": "Germany"
    },
  ...
  ]
}
</code></pre>
    <h3 class="heading-3" id="_idParaDest-440">Specifying filters and arguments</h3>
    <p class="normal">With an HTTP or REST-style API, the caller<a id="_idIndexMarker1213"/> is limited to only passing parameters<a id="_idIndexMarker1214"/> when the API predefines that. With GraphQL, you can set parameters anywhere in the query, for example, filtering orders by order date and by the country of the customer who made the order, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">query GetOrdersByDateAndCountry {
  order(orderDate: "23/04/1998") {
    orderId
    orderDate
    customer(country: "UK") {
      companyName
      country
    }
  }
}
</code></pre>
    <p class="normal">Note that although GraphQL uses camelCase for entity, property, and parameter names, you should use PascalCase for query names.</p>
    <p class="normal">You might want to pass values<a id="_idIndexMarker1215"/> for named parameters instead of hardcoding <a id="_idIndexMarker1216"/>them, as shown in the following code:</p>
    <pre class="programlisting gen"><code class="hljs">query GetOrdersByDateAndCountry($country: String, $orderDate: String) {
  order(orderDate: $orderDate) {
    orderId
    orderDate
    customer(country: $country) {
      companyName
      country
    }
  }
}
</code></pre>
    <div><p class="normal">You can learn more about<a id="_idIndexMarker1217"/> the GraphQL query language at the following link: <a href="https://graphql.org/learn/queries/">https://graphql.org/learn/queries/</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-441">Understanding other GraphQL capabilities</h2>
    <p class="normal">As well as queries, other standard GraphQL features are mutations and subscriptions:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Mutations</strong> enable you to create, update, and<a id="_idIndexMarker1218"/> delete<a id="_idIndexMarker1219"/> resources.</li>
      <li class="bulletList"><strong class="keyWord">Subscriptions</strong> enable a client to get notified<a id="_idIndexMarker1220"/> when resources change. They work<a id="_idIndexMarker1221"/> best with additional communication technologies like WebSockets.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-442">Understanding the ChilliCream GraphQL platform</h2>
    <p class="normal">GraphQL.NET is one of the most popular platforms <a id="_idIndexMarker1222"/>for implementing GraphQL with .NET. In my opinion, GraphQL.NET requires too much configuration for even the most basic example, and the documentation is frustrating. I have a feeling that, although it is powerful, it implements the GraphQL specification in a one-to-one manner instead of rethinking how a .NET platform could make it easier to get started.</p>
    <div><p class="normal">You can learn<a id="_idIndexMarker1223"/> about GraphQL.NET at the following link: <a href="https://graphql-dotnet.github.io/">https://graphql-dotnet.github.io/</a>.</p>
    </div>
    <p class="normal">For this book, I looked for alternatives, and I found exactly what I was looking for. ChilliCream is a company that has created a whole platform to work with GraphQL:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Hot Chocolate</strong> enables you to create<a id="_idIndexMarker1224"/> GraphQL services for .NET.</li>
      <li class="bulletList"><strong class="keyWord">Strawberry Shake</strong> enables you to create<a id="_idIndexMarker1225"/> GraphQL clients for .NET.</li>
      <li class="bulletList"><strong class="keyWord">Banana Cake Pop</strong> enables you to run queries<a id="_idIndexMarker1226"/> and explore a GraphQL endpoint using a Monaco-based GraphQL IDE.</li>
      <li class="bulletList"><strong class="keyWord">Green Donut</strong> enables better performance<a id="_idIndexMarker1227"/> when loading data.</li>
    </ul>
    <p class="normal">Unlike some other packages that can be used to add support for GraphQL, ChilliCream packages are designed to be as easy to implement as possible, using conventions and simple POCO classes instead of complex types and special schemas. It works in a similar way to how Microsoft might have built a GraphQL platform for .NET, with sensible defaults and conventions rather than lots of boilerplate code and configuration.</p>
    <p class="normal">As ChilliCream says<a id="_idIndexMarker1228"/> on its home page, <em class="italic">“We at ChilliCream build the ultimate GraphQL platform. Most of our code is open-source and will forever remain open-source.”</em></p>
    <div><p class="normal">The GitHub repository for Hot Chocolate is at the following link: <a href="https://github.com/ChilliCream/hotchocolate">https://github.com/ChilliCream/hotchocolate</a>.</p>
    </div>
    <h1 class="heading-1" id="_idParaDest-443">Building a service that supports GraphQL</h1>
    <p class="normal">There is no <code class="inlineCode">dotnet</code> <code class="inlineCode">new</code> project template<a id="_idIndexMarker1229"/> for GraphQL, so we will use the <strong class="screenText">ASP.NET Core Empty</strong> project<a id="_idIndexMarker1230"/> template. Even though GraphQL does not have to be hosted on a web server because it is not tied to HTTP, it is a sensible choice to get started. We will then add a package reference for GraphQL support:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to add a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">ASP.NET Core Empty</strong> / <code class="inlineCode">web</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter12</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.GraphQL.Service</code></li>
          <li class="bulletList">Other Visual Studio 2022 options: <ul>
              <li class="bulletList"><strong class="screenText">Configure for HTTPS</strong>: Selected</li>
              <li class="bulletList"><strong class="screenText">Enable Docker</strong>: Cleared</li>
              <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared</li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="numberedList">In the project file, add a package reference for Hot Chocolate hosted in ASP.NET Core, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference Include="HotChocolate.AspNetCore" Version="13.5.1" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal">Version 13.6.0 was in preview at the time of writing. To use the most recent preview version, you can set it to <code class="inlineCode">13.6-*</code>. But I recommend that you go to the following link<a id="_idIndexMarker1231"/> and then reference the latest GA version: <a href="https://www.nuget.org/packages/HotChocolate.AspNetCore/">https://www.nuget.org/packages/HotChocolate.AspNetCore/</a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">In the project file, treat<a id="_idIndexMarker1232"/> warnings as errors and disable <a id="_idIndexMarker1233"/>the warning <code class="inlineCode">AD0001</code>, as highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;PropertyGroup&gt;
  &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
  &lt;Nullable&gt;enable&lt;/Nullable&gt;
  &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
<strong class="hljs-slc">  &lt;TreatWarningsAsErrors&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/TreatWarningsAsErrors&gt;</strong>
<strong class="hljs-slc">  &lt;NoWarn&gt;AD0001&lt;/NoWarn&gt;</strong>
&lt;/PropertyGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Properties</code> folder, in <code class="inlineCode">launchSettings.json</code>, for the <code class="inlineCode">https</code> profile, modify the <code class="inlineCode">applicationUrl</code> to use port <code class="inlineCode">5121</code> for <code class="inlineCode">https</code> and port <code class="inlineCode">5122</code> for <code class="inlineCode">http</code>. Then, add a <code class="inlineCode">launchUrl</code> of <code class="inlineCode">graphql</code>, as<a id="_idIndexMarker1234"/> highlighted in the following configuration:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-attr-slc">"https"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">{</strong>
  "commandName": "Project",
  "dotnetRunMessages": true,
  "launchBrowser": true,
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"launchUrl"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">graphql"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"applicationUrl"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"https://localhost:5121;http://localhost:5122"</strong><strong class="hljs-punctuation-slc">,</strong>
  "environmentVariables": {
    "ASPNETCORE_ENVIRONMENT": "Development"
  }
</code></pre>
      </li>
      <li class="numberedList">Build<a id="_idIndexMarker1235"/> the <code class="inlineCode">Northwind.GraphQL.Service</code> project.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-444">Defining the GraphQL schema for Hello World</h2>
    <p class="normal">The first task is to define what we want<a id="_idIndexMarker1236"/> to expose as GraphQL models<a id="_idIndexMarker1237"/> in the web service.</p>
    <p class="normal">Let’s define a GraphQL query for the most basic <code class="inlineCode">Hello World</code> example, which will respond with plain text when a request for a greeting is made:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.GraphQL.Service</code> project/folder, add a class file named <code class="inlineCode">Query.cs</code>.</li>
      <li class="numberedList">Modify the class to have a method named <code class="inlineCode">GetGreeting</code> that returns the plain text <code class="inlineCode">"Hello, World!"</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.GraphQL.Service;
public class Query
{
  public string GetGreeting() =&gt; "Hello, World!";
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, import the namespace where we defined the <code class="inlineCode">Query</code> class, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.GraphQL.Service; // To use Query.
</code></pre>
      </li>
      <li class="numberedList">In the section to configure services, after the call to <code class="inlineCode">CreateBuilder</code>, add a statement to add GraphQL server-side support, and add the query type to the collection of registered services, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services
  .AddGraphQLServer()
  .AddQueryType&lt;Query&gt;();
</code></pre>
      </li>
      <li class="numberedList">Modify the statement that maps a <code class="inlineCode">GET</code> request to return a more useful plain text message, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.MapGet("/", () =&gt; "Navigate to: https://localhost:5121/graphql");
</code></pre>
      </li>
      <li class="numberedList">In the section to configure<a id="_idIndexMarker1238"/> the HTTP<a id="_idIndexMarker1239"/> pipeline, before the call to <code class="inlineCode">Run</code>, add a statement to map GraphQL as an endpoint, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.MapGraphQL();
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.GraphQL.Service</code> web project, using the <code class="inlineCode">https</code> profile without debugging:<ul>
          <li class="bulletList">If you are using Visual Studio 2022, then select the <strong class="screenText">https</strong> profile, start the project without debugging, and note that the browser starts automatically.</li>
          <li class="bulletList">If you are using Visual Studio Code, then enter the command <code class="inlineCode">dotnet run --launch-profile https</code>, start Chrome manually, and navigate to <code class="inlineCode">https://localhost:5121/graphql</code>.</li>
        </ul>
      </li>
      <li class="numberedList">Note the <strong class="screenText">BananaCakePop</strong> user interface, and then click the <strong class="screenText">Create Document</strong> button.</li>
      <li class="numberedList">In the top-right corner, click the <strong class="screenText">Connection Settings</strong> button, as shown in <em class="italic">Figure 12.1</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_01.png"/></figure>
    <p class="packt_figref">Figure 12.1: A new BananaCakePop document and connection settings button</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">In <strong class="screenText">Connection Settings</strong>, confirm<a id="_idIndexMarker1240"/> that the <strong class="screenText">Schema Endpoint</strong> is correct, and then<a id="_idIndexMarker1241"/> click <strong class="screenText">Cancel</strong>, as shown in <em class="italic">Figure 12.2</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_02.png"/></figure>
    <p class="packt_figref">Figure 12.2: Reviewing the BananaCakePop connection settings</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="11">At the top of the <strong class="screenText">untitled 1</strong> document, click the <strong class="screenText">Schema Reference</strong> tab.</li>
      <li class="numberedList">In the <strong class="screenText">Schema Reference</strong> tab, note “The <code class="inlineCode">Query</code> type is a special type that defines the entry point of every GraphQL query”, and it has a field named <code class="inlineCode">greeting</code> that returns a <code class="inlineCode">String!</code> value. The exclamation mark indicates that the value will <em class="italic">not</em> be <code class="inlineCode">null</code>.</li>
      <li class="numberedList">Click the <strong class="screenText">Schema Definition</strong> tab, and note there is only<a id="_idIndexMarker1242"/> one type defined, the special <code class="inlineCode">Query</code> object with its <code class="inlineCode">greeting</code> field, which is a non-null <code class="inlineCode">String</code> value, as shown<a id="_idIndexMarker1243"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code">type Query {
  greeting: String!
}
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-445">Writing and executing GraphQL queries</h2>
    <p class="normal">Now that we know<a id="_idIndexMarker1244"/> the schema, we can write<a id="_idIndexMarker1245"/> and run a query:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <strong class="screenText">Banana Cake Pop</strong>, in the <strong class="screenText">untitled 1</strong> document, click the <strong class="screenText">Operations</strong> tab.</li>
      <li class="numberedList">On the left-hand side, type an open curly brace, <code class="inlineCode">{</code>, and note that a close curly brace, <code class="inlineCode">}</code>, is written for you.</li>
      <li class="numberedList">Type the letter <code class="inlineCode">g</code> , and note that the autocomplete shows it recognizes the <code class="inlineCode">greeting</code> field, as shown in <em class="italic">Figure 12.3</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_03.png"/></figure>
    <p class="packt_figref">Figure 12.3: Autocomplete for the greeting field</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Press <em class="keystroke">Enter</em> to accept the autocomplete suggestion.</li>
      <li class="numberedList">Click the <strong class="screenText">Run</strong> button and note the response, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "greeting": "Hello, World!"
  }
}
</code></pre>
      </li>
      <li class="numberedList">Close Chrome, and shut down<a id="_idIndexMarker1246"/> the web<a id="_idIndexMarker1247"/> server.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-446">Naming GraphQL queries aka operations</h2>
    <p class="normal">The query that we wrote<a id="_idIndexMarker1248"/> was unnamed. We could also have created it as a named<a id="_idIndexMarker1249"/> query, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">query QueryNameGoesHere {
  greeting
}
</code></pre>
    <p class="normal">Named queries allow clients to identify<a id="_idIndexMarker1250"/> queries and responses for telemetry <a id="_idIndexMarker1251"/>purposes, for example, when hosting in Microsoft Azure cloud services and monitoring using Application Insights.</p>
    <h2 class="heading-2" id="_idParaDest-447">Understanding field conventions</h2>
    <p class="normal">The C# method we created<a id="_idIndexMarker1252"/> in the <code class="inlineCode">Query</code> class was named <code class="inlineCode">GetGreeting</code>, but when querying it, we used <code class="inlineCode">greeting</code>. The <code class="inlineCode">Get</code> prefix on method names that represent fields in GraphQL is optional. Let’s see some more examples:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Query.cs</code>, add two more methods without the <code class="inlineCode">Get</code> prefix, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.GraphQL.Service;
public class Query
{
  public string GetGreeting() =&gt; "Hello, World!";
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">Farewell</strong><strong class="hljs-function-slc">()</strong><strong class="hljs-slc"> =&gt; </strong><strong class="hljs-string-slc">"Ciao! Ciao!"</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">RollTheDie</strong><strong class="hljs-function-slc">()</strong><strong class="hljs-slc"> =&gt; Random.Shared.Next(</strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">, </strong><strong class="hljs-number-slc">7</strong><strong class="hljs-slc">);</strong>
}
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.GraphQL.Service</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Click the <strong class="screenText">Schema Definition</strong> tab, and note the updated schema, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">type Query {
  greeting: String!
  farewell: String!
  rollTheDie: Int!
}
</code></pre>
      
    <div><p class="normal">C# methods use PascalCase. GraphQL fields use camelCase.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Click the <strong class="screenText">Operations</strong> tab, and modify the query to specify a name and request the <code class="inlineCode">rollTheDie</code> field, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">query GetNumber {
  rollTheDie
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong> again multiple times. Note that the responses contain a random number between 1 and 6, and a history of requests and responses is stored for the current browser session, as shown in <em class="italic">Figure 12.4</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_04.png"/></figure>
    <p class="packt_figref">Figure 12.4: Executing a named query and the history of requests and responses</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Close Chrome, and shut down<a id="_idIndexMarker1253"/> the web server.</li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-448">Defining GraphQL queries for EF Core models</h1>
    <p class="normal">Now that we have a basic GraphQL service<a id="_idIndexMarker1254"/> operating successfully, let’s extend<a id="_idIndexMarker1255"/> it to enable querying the Northwind database.</p>
    <h2 class="heading-2" id="_idParaDest-449">Adding support for EF Core</h2>
    <p class="normal">We must add another Hot Chocolate<a id="_idIndexMarker1256"/> package to allow easy dependency service integration of our EF Core database context with GraphQL query classes:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Add a package reference for Hot Chocolate integration with EF Core and a project reference to the Northwind database<a id="_idIndexMarker1257"/> context project, as highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference Include="HotChocolate.AspNetCore" Version="13.5.1" /&gt;
<strong class="hljs-slc">  &lt;PackageReference Include=</strong><strong class="hljs-string-slc">"HotChocolate.Data.EntityFramework"</strong><strong class="hljs-slc"> </strong>
<strong class="hljs-slc">                    Version=</strong><strong class="hljs-string-slc">"13.5.1"</strong><strong class="hljs-slc"> /&gt;</strong>
&lt;/ItemGroup&gt;
<strong class="hljs-slc">&lt;ItemGroup&gt;</strong>
<strong class="hljs-slc">  &lt;ProjectReference Include=</strong><strong class="hljs-string-slc">"..\..\Chapter03\Northwind.Common.DataContext</strong>
<strong class="hljs-string-slc">.SqlServer\Northwind.Common.DataContext.SqlServer.csproj"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">&lt;/ItemGroup&gt;</strong>
</code></pre>
        <div><p class="normal">The path to the project must not have a line break. All Hot Chocolate packages should have the same version number.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Build the <code class="inlineCode">Northwind.GraphQLService</code> project at the command prompt or terminal using <code class="inlineCode">dotnet build</code>.
    <div><p class="normal">When you reference a project outside of the current solution, you must build the project at least once at the command prompt or terminal before you can use the Visual Studio 2022 <strong class="screenText">Build</strong> menu to compile it.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">In <code class="inlineCode">Program.cs</code>, import the namespace to work with our EF Core model for the Northwind database, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels; // To use AddNorthwindContext method.
</code></pre>
      </li>
      <li class="numberedList">Add a statement after the <code class="inlineCode">CreateBuilder</code> method to register the <code class="inlineCode">Northwind</code> database context class, and add a statement after adding the GraphQL server support to register the <code class="inlineCode">NorthwindContent</code> class for dependency injection, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">builder.Services.AddNorthwindContext();</strong>
builder.Services
  .AddGraphQLServer()
<strong class="hljs-slc">  .RegisterDbContext&lt;NorthwindContext&gt;()</strong>
  .AddQueryType&lt;Query&gt;();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Query.cs</code>, add statements<a id="_idIndexMarker1258"/> to define an object graph type that has some types of queries to return a list of categories, a single category, products for a category, products with a minimum unit price, and all products, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> Microsoft.EntityFrameworkCore; </strong><strong class="hljs-comment-slc">// To use Include method.</strong>
<strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> Northwind.EntityModels; </strong><strong class="hljs-comment-slc">// To use NorthwindContext.</strong>
namespace Northwind.GraphQL.Service;
public class Query
{
  public string GetGreeting() =&gt; "Hello, World!";
  public string Farewell() =&gt; "Ciao! Ciao!";
  public int RollTheDie() =&gt; Random.Shared.Next(1, 7);
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-function-slc"> IQueryable&lt;Category&gt; </strong><strong class="hljs-title-slc">GetCategories</strong><strong class="hljs-function-slc">(</strong><strong class="hljs-params-slc">NorthwindContext db</strong><strong class="hljs-function-slc">)</strong><strong class="hljs-slc"> =&gt; </strong>
<strong class="hljs-slc">    db.Categories.Include(c =&gt; c.Products);</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> Category? GetCategory(NorthwindContext db, </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc"> categoryId)</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    Category? category = db.Categories.Find(categoryId);</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (category == </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">) </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">    db.Entry(category).Collection(c =&gt; c.Products).Load();</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> category;</strong>
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-function-slc"> IQueryable&lt;Product&gt; </strong><strong class="hljs-title-slc">GetProducts</strong><strong class="hljs-function-slc">(</strong><strong class="hljs-params-slc">NorthwindContext db</strong><strong class="hljs-function-slc">)</strong><strong class="hljs-slc"> =&gt; </strong>
<strong class="hljs-slc">    db.Products.Include(p =&gt; p.Category);</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-function-slc"> IQueryable&lt;Product&gt; </strong><strong class="hljs-title-slc">GetProductsInCategory</strong><strong class="hljs-function-slc">(</strong>
<strong class="hljs-params-slc">    NorthwindContext db, </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-params-slc"> categoryId</strong><strong class="hljs-function-slc">)</strong> <strong class="hljs-slc">=&gt;</strong>
<strong class="hljs-slc">      db.Products.Where(p =&gt; p.CategoryId == categoryId);</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-function-slc"> IQueryable&lt;Product&gt; </strong><strong class="hljs-title-slc">GetProductsByUnitPrice</strong><strong class="hljs-function-slc">(</strong>
<strong class="hljs-params-slc">    NorthwindContext db, </strong><strong class="hljs-built_in-slc">decimal</strong><strong class="hljs-params-slc"> minimumUnitPrice</strong><strong class="hljs-function-slc">)</strong><strong class="hljs-slc"> =&gt;</strong>
<strong class="hljs-slc">      db.Products.Where(p =&gt; p.UnitPrice &gt;= minimumUnitPrice);</strong>
}
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-450">Exploring GraphQL queries with Northwind</h2>
    <p class="normal">Now we can test writing GraphQL queries<a id="_idIndexMarker1259"/> for the categories and products <a id="_idIndexMarker1260"/>in the Northwind database:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">If your database server is not running, for example, because you are hosting it in Docker, a virtual machine, or the cloud, then make sure to start it.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.GraphQL.Service</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">In <strong class="screenText">Banana Cake Pop</strong>, click the <strong class="screenText">+</strong> to open a new tab.</li>
      <li class="numberedList">Click the <strong class="screenText">Schema Definition</strong> tab, and note the query and type definitions for <code class="inlineCode">Category</code>, as partially shown in <em class="italic">Figure 12.5</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_05.png"/></figure>
    <p class="packt_figref">Figure 12.5: Schema for querying the Northwind categories and products using GraphQL</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Note the full<a id="_idIndexMarker1261"/> definitions in the following<a id="_idIndexMarker1262"/> code:
        <pre class="programlisting code"><code class="hljs-code">type Query {
  greeting: String!
  farewell: String!
  rollTheDie: Int!
  categories: [Category!]!
  category(categoryId: Int!): Category
  products: [Product!]!
  productsInCategory(categoryId: Int!): [Product!]!
  productsByUnitPrice(minimumUnitPrice: Decimal!): [Product!]!
}
type Category {
  categoryId: Int!
  categoryName: String!
  description: String
  picture: [Byte!]
  products: [Product!]!
}
type Product {
  productId: Int!
  productName: String!
  supplierId: Int
  categoryId: Int
  quantityPerUnit: String
  unitPrice: Decimal
  unitsInStock: Short
  unitsOnOrder: Short
  reorderLevel: Short
  discontinued: Boolean!
  category: Category
  orderDetails: [OrderDetail!]!
  supplier: Supplier
}
</code></pre>
      </li>
      <li class="numberedList">Click the <strong class="screenText">Operations</strong> tab, and write a named query to request the ID, name, and description fields for all categories, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">query AllCategories {
  categories {
    categoryId
    categoryName
    description
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note<a id="_idIndexMarker1263"/> the response, as shown in <em class="italic">Figure 12.6</em> and the following<a id="_idIndexMarker1264"/> partial output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "categories": [
      {
        "categoryId": 1,
        "categoryName": "Beverages",
        "description": "Soft drinks, coffees, teas, beers, and ales"
      },
      {
        "categoryId": 2,
        "categoryName": "Condiments",
        "description": "Sweet and savory sauces, relishes, spreads, and seasonings"
      },
      ...
</code></pre>
      </li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_06.png"/></figure>
    <p class="packt_figref">Figure 12.6: Getting all categories</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">Click the <strong class="screenText">+</strong> to open a tab for a new document named <strong class="screenText">untitled 2</strong>, and write a query to request the category with ID <code class="inlineCode">2</code>, including the ID, name, and price of its products, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">query Condiments {
  category (categoryId: 2) {
    categoryId
    categoryName
    products {
      productId
      productName
      unitPrice
    }
  }
}
</code></pre>
      
    <div><p class="normal">Make sure that the <code class="inlineCode">I</code> in <code class="inlineCode">categoryId</code> is uppercase.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">Click <strong class="screenText">Run</strong>, and note<a id="_idIndexMarker1265"/> the response, as shown in the following<a id="_idIndexMarker1266"/> partial output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "category": {
      "categoryId": 2,
      "categoryName": "Condiments",
      "products": [
        {
          "productId": 3,
          "productName": "Aniseed Syrup",
          "unitPrice": 10
        },
        {
          "productId": 4,
          "productName": "Chef Anton's Cajun Seasoning",
          "unitPrice": 22
        },
        ...
</code></pre>
      </li>
      <li class="numberedList">In the GraphQL web service command prompt or terminal, note the SQL statements executed for this query, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (68ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='Text', CommandTimeout='30']
      SELECT TOP(1) [c].[CategoryId], [c].[CategoryName], [c].[Description], [c].[Picture]
      FROM [Categories] AS [c]
      WHERE [c].[CategoryId] = @__p_0
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (5ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='Text', CommandTimeout='30']
      SELECT [p].[ProductId], [p].[CategoryId], [p].[Discontinued], [p].[ProductName], [p].[QuantityPerUnit], [p].[ReorderLevel], [p].[SupplierId], [p].[UnitPrice], [p].[UnitsInStock], [p].[UnitsOnOrder]
      FROM [Products] AS [p]
      WHERE [p].[CategoryId] = @__p_0
</code></pre>
      
    <div><p class="normal">Although the GraphQL query did not need the picture of each category and only needed the ID, name, and unit price, the dynamically-generated queries from EF Core returned all properties.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="11">Click the <strong class="screenText">+</strong> tab to open<a id="_idIndexMarker1267"/> a new tab, and write a query<a id="_idIndexMarker1268"/> to request the ID, name, and units in stock of the products in the category with ID <code class="inlineCode">1</code>, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">query BeverageProducts {
  productsInCategory (categoryId: 1) {
    productId
    productName
    unitsInStock
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note the response, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "productsInCategory": [
      {
        "productId": 1,
        "productName": "Chai",
        "unitsInStock": 39
      },
      {
        "productId": 2,
        "productName": "Chang",
        "unitsInStock": 17
      },
      ...
</code></pre>
      </li>
      <li class="numberedList">Click the <strong class="screenText">+</strong> tab to open<a id="_idIndexMarker1269"/> a new tab, and write a query<a id="_idIndexMarker1270"/> to request the ID, name, and units in stock of products, along with their category names, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">query ProductsWithCategoryNames {
  products {
    productId
    productName
    category {
      categoryName
    }
    unitsInStock
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note the response, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "products": [
      {
        "productId": 1,
        "productName": "Chai",
        "category": {
          "categoryName": "Beverages"
        },
        "unitsInStock": 39
      },
      {
        "productId": 2,
        "productName": "Chang",
        "category": {
          "categoryName": "Beverages"
        },
        "unitsInStock": 17
      },
      ...
</code></pre>
      </li>
      <li class="numberedList">Click the <strong class="screenText">+</strong> tab to open a new tab, and write a query<a id="_idIndexMarker1271"/> to request the ID and name of a category, select the category<a id="_idIndexMarker1272"/> by specifying its category ID, and include the ID and name for each of its products. The ID of the category will be set using a variable, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">query CategoryAndItsProducts($id: Int!){
  category(categoryId: $id) {
    categoryId
    categoryName
    products {
      productId
      productName
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">In the <strong class="screenText">Variables</strong> section, define a value for the variable, as shown in the following code and in <em class="italic">Figure 12.7</em>:
        <pre class="programlisting code"><code class="hljs-code">{
  "id": 1
}
</code></pre>
      </li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_07.png"/></figure>
    <p class="packt_figref">Figure 12.7: Executing a GraphQL query with a variable</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="17">Click <strong class="screenText">Run</strong>, and note<a id="_idIndexMarker1273"/> the response, as shown in the following<a id="_idIndexMarker1274"/> partial output:
        <pre class="programlisting code"><code class="hljs-code">{
  "data": {
    "category": {
      "categoryId": 1,
      "categoryName": "Beverages",
      "products": [
        {
          "productId": 1,
          "productName": "Chai"
        },
        {
          "productId": 2,
          "productName": "Chang"
        },
        ...
</code></pre>
      </li>
      <li class="numberedList">Click the <strong class="screenText">+</strong> tab to open a new tab, write a query to request the ID and name of a category, select the category<a id="_idIndexMarker1275"/> by specifying its category ID, and include<a id="_idIndexMarker1276"/> the ID and name for each of its products. The ID of the category will be set using a variable, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">query ProductsWithMinimumPrice($unitPrice: Decimal!){
  productsByUnitPrice(minimumUnitPrice: $unitPrice) {
      productId
      productName
      unitPrice
  }
}
</code></pre>
      </li>
      <li class="numberedList">In the <strong class="screenText">Variables</strong> section, define a value for the variable, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">{
  "unitPrice": 100
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note the response, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "productsByUnitPrice": [
      {
        "productId": 29,
        "productName": "Thüringer Rostbratwurst",
        "unitPrice": 123.79
      },
      {
        "productId": 38,
        "productName": "Côte de Blaye",
        "unitPrice": 263.5
      }
    ]
  }
}
</code></pre>
      </li>
      <li class="numberedList">Close Chrome, and<a id="_idIndexMarker1277"/> shut down<a id="_idIndexMarker1278"/> the web server.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-451">Implementing paging support</h2>
    <p class="normal">When we request products <a id="_idIndexMarker1279"/>using the <code class="inlineCode">GetProducts</code> method (the <code class="inlineCode">products</code> query), all 77 products<a id="_idIndexMarker1280"/> are returned. Let’s add paging support:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Query.cs</code>, add statements to define a query to return all products, using paging, and note that its implementation is the same as the query for products without paging, but it is decorated with the <code class="inlineCode">[UsePaging]</code> attribute, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">[UsePaging]
public IQueryable&lt;Product&gt; GetProductsWithPaging(NorthwindContext db) =&gt;
  db.Products.Include(p =&gt; p.Category);
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: The <code class="inlineCode">[UsePaging]</code>, <code class="inlineCode">[UseFiltering]</code>, and <code class="inlineCode">[UseSorting]</code> attributes must be decorated onto a query method that returns <code class="inlineCode">IQueryable&lt;T&gt;</code> , allowing GraphQL to dynamically configure the LINQ query before executing it against the data store.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">Start the <code class="inlineCode">Northwind.GraphQL.Service</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">In <strong class="screenText">Banana Cake Pop</strong>, click the <strong class="screenText">+</strong> to open a new tab.</li>
      <li class="numberedList">Click the <strong class="screenText">Schema Definition</strong> tab, and note the queries named <code class="inlineCode">products</code> (without paging) and <code class="inlineCode">productsWithPaging</code>, which documents how to use the query to request a page of products, as shown in the following output:
        <pre class="programlisting code"><code class="hljs-code">products: [Product!]!
productsInCategory(categoryId: Int!): [Product!]!
productsByUnitPrice(minimumUnitPrice: Decimal!): [Product!]!
productsWithPaging(
  """
  Returns the first _n_ elements from the list.
  """
  first: Int
  """
  Returns the elements in the list that come after the specified cursor.
  """
  after: String
  """
  Returns the last _n_ elements from the list.
  """
  last: Int
  """
  Returns the elements in the list that come before the specified cursor.
  """
  before: String
): ProductsWithPagingConnection
</code></pre>
      </li>
      <li class="numberedList">Click the <strong class="screenText">Operations</strong> tab, and write<a id="_idIndexMarker1281"/> a named query to request<a id="_idIndexMarker1282"/> the first page of 10 products, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">query FirstTenProducts {
  productsWithPaging(first: 10) {
    pageInfo {
      hasPreviousPage
      hasNextPage
      startCursor
      endCursor
    }
    nodes {
      productId
      productName
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note the response, including the <code class="inlineCode">pageInfo</code> section, which tells us that there is another page of products and the cursor for this page ranges from <code class="inlineCode">MA==</code> to <code class="inlineCode">OQ==</code>, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "productsWithPaging": {
      "pageInfo": {
        "hasPreviousPage": false,
        "hasNextPage": true,
        "startCursor": "MA==",
        "endCursor": "OQ=="
      },
      "nodes": [
        {
          "productId": 1,
          "productName": "Chai"
        },
...
{
          "productId": 10,
          "productName": "Ikura"
        }
      ]
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click the <strong class="screenText">+</strong> to open a new tab, and write<a id="_idIndexMarker1283"/> a named query to request<a id="_idIndexMarker1284"/> the second page of 10 products, by specifying that we want the cursor that starts after <code class="inlineCode">OQ==</code>, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">query SecondTenProducts {
  productsWithPaging(after: "OQ==") {
    pageInfo {
      hasPreviousPage
      hasNextPage
      startCursor
      endCursor
    }
    nodes {
      productId
      productName
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note the response, including the <code class="inlineCode">pageInfo</code> section, which tells us that there is another page of products and the cursor for this page ranges from <code class="inlineCode">MTA=</code> to <code class="inlineCode">MTk=</code>, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "productsWithPaging": {
      "pageInfo": {
        "hasPreviousPage": true,
        "hasNextPage": true,
        "startCursor": "MTA=",
        "endCursor": "MTk="
      },
      "nodes": [
        {
          "productId": 11,
          "productName": "Queso Cabrales"
        },
...
{
          "productId": 20,
          "productName": "Sir Rodney's Marmalade"
        }
      ]
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Close Chrome, and shut down<a id="_idIndexMarker1285"/> the web<a id="_idIndexMarker1286"/> server.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-452">Implementing filtering support</h2>
    <p class="normal">When we explored queries earlier<a id="_idIndexMarker1287"/> in this chapter, we predefined<a id="_idIndexMarker1288"/> some queries with parameters, for example, a query that returns all the products in a category by passing a <code class="inlineCode">categoryId</code> parameter.</p>
    <p class="normal">However, what if you do not know ahead of time what filtering you want to perform?</p>
    <p class="normal">Let’s add filtering support to our GraphQL queries:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Program.cs</code>, add a call to <code class="inlineCode">AddFiltering</code> after calling <code class="inlineCode">AddGraphQLServer</code>, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services
  .AddGraphQLServer()
<strong class="hljs-slc">  .AddFiltering()</strong>
  .RegisterDbContext&lt;NorthwindContext&gt;()
  .AddQueryType&lt;Query&gt;();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Query.cs</code>, decorate the <code class="inlineCode">GetProducts</code> method with the <code class="inlineCode">[UseFiltering]</code> attribute, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">[</strong><strong class="hljs-meta-slc">UseFiltering</strong><strong class="hljs-slc">]</strong>
public IQueryable&lt;Product&gt; GetProducts(NorthwindContext db) =&gt;
  db.Products.Include(p =&gt; p.Category);
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.GraphQL.Service</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">In <strong class="screenText">Banana Cake Pop</strong>, click the <strong class="screenText">+</strong> to open a new tab.</li>
      <li class="numberedList">Click <strong class="screenText">Scheme Definition</strong> , and note<a id="_idIndexMarker1289"/> that the <code class="inlineCode">products</code> query<a id="_idIndexMarker1290"/> now accepts a filter input, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">products(where: ProductFilterInput): [Product!]!
</code></pre>
      </li>
      <li class="numberedList">Scroll down the schema definition to find <code class="inlineCode">ProductFilterInput</code>, and note the filtering options include Boolean operators like <code class="inlineCode">and</code> and <code class="inlineCode">or</code>, as well as field filters like <code class="inlineCode">IntOperationFilterInput</code> and <code class="inlineCode">StringOperationFilterInput</code>, as shown in the following markup:
        <pre class="programlisting con"><code class="hljs-con">input ProductFilterInput {
  and: [ProductFilterInput!]
  or: [ProductFilterInput!]
  productId: IntOperationFilterInput
  productName: StringOperationFilterInput
  supplierId: IntOperationFilterInput
  categoryId: IntOperationFilterInput
  quantityPerUnit: StringOperationFilterInput
  unitPrice: DecimalOperationFilterInput
  unitsInStock: ShortOperationFilterInput
  unitsOnOrder: ShortOperationFilterInput
  reorderLevel: ShortOperationFilterInput
  discontinued: BooleanOperationFilterInput
  category: CategoryFilterInput
  orderDetails: ListFilterInputTypeOfOrderDetailFilterInput
  supplier: SupplierFilterInput
}
</code></pre>
      </li>
      <li class="numberedList">Scroll down the schema definition<a id="_idIndexMarker1291"/> to find <code class="inlineCode">IntOperationFilterInput</code> and <code class="inlineCode">StringOperationFilterInput</code>, and note the operations<a id="_idIndexMarker1292"/> you can use with them, like equals (<code class="inlineCode">eq</code>), not equals (<code class="inlineCode">neq</code>), in an array (<code class="inlineCode">in</code>), greater than (<code class="inlineCode">gt</code>), <code class="inlineCode">contains</code>, and <code class="inlineCode">startsWith</code>, as shown in the following markup:
        <pre class="programlisting con"><code class="hljs-con">input IntOperationFilterInput {
  eq: Int
  neq: Int
  in: [Int]
  nin: [Int]
  gt: Int
  ngt: Int
  gte: Int
  ngte: Int
  lt: Int
  nlt: Int
  lte: Int
  nlte: Int
}
input StringOperationFilterInput {
  and: [StringOperationFilterInput!]
  or: [StringOperationFilterInput!]
  eq: String
  neq: String
  contains: String
  ncontains: String
  in: [String]
  nin: [String]
  startsWith: String
  nstartsWith: String
  endsWith: String
  nendsWith: String
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Operations</strong>, and then write a named query to request products with more than <code class="inlineCode">120</code> units in stock, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">query ProductsWithMoreThan40InStock {
  products(where: { unitsInStock: { gt: 120 } }) {
    productId
    productName
    unitsInStock
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note the response, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "products": [
      {
        "productId": 40,
        "productName": "Boston Crab Meat",
        "unitsInStock": 123
      },
      {
        "productId": 75,
        "productName": "Rhönbräu Klosterbier",
        "unitsInStock": 125
      }
    ]
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click the <strong class="screenText">+</strong> to open a new tab, click <strong class="screenText">Operations</strong>, and then write a named query to request products whose<a id="_idIndexMarker1293"/> names start with <code class="inlineCode">Cha</code>, as shown<a id="_idIndexMarker1294"/> in the following markup:
        <pre class="programlisting code"><code class="hljs-code">query ProductNamesCha {
  products(where: { productName: { startsWith: "Cha" } }) {
    productId
    productName
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note the response, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "products": [
      {
        "productId": 1,
        "productName": "Chai"
      },
      {
        "productId": 2,
        "productName": "Chang"
      },
      {
        "productId": 39,
        "productName": "Chartreuse verte"
      }
    ]
  }
}
</code></pre>
      </li>
      <li class="numberedList">In the GraphQL service command prompt or terminal, note the EF Core-generated SQL filters using parameters, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (2ms) [Parameters=[@__p_0_rewritten='?' (Size = 40)], CommandType='Text', CommandTimeout='30']
      SELECT [p].[ProductId], [p].[CategoryId], [p].[Discontinued], [p].[ProductName], [p].[QuantityPerUnit], [p].[ReorderLevel], [p].[SupplierId], [p].[UnitPrice], [p].[UnitsInStock], [p].[UnitsOnOrder], [c].[CategoryId], [c].[CategoryName], [c].[Description], [c].[Picture]
      FROM [Products] AS [p]
      LEFT JOIN [Categories] AS [c] ON [p].[CategoryId] = [c].[CategoryId]
      WHERE [p].[ProductName] LIKE @__p_0_rewritten ESCAPE N'\'
</code></pre>
      </li>
      <li class="numberedList">Close Chrome, and<a id="_idIndexMarker1295"/> shut down<a id="_idIndexMarker1296"/> the web server.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-453">Implementing sorting support</h2>
    <p class="normal">To enable sorting<a id="_idIndexMarker1297"/> with a GraphQL service, call <a id="_idIndexMarker1298"/>the <code class="inlineCode">AddSorting</code> method, as highlighted in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">builder.Services
  .AddGraphQLServer()
  .AddFiltering()
<strong class="hljs-slc">  .AddSorting()</strong>
  .RegisterDbContext&lt;NorthwindContext&gt;()
  .AddQueryType&lt;Query&gt;();
</code></pre>
    <p class="normal">Then, decorate a query method that returns <code class="inlineCode">IQueryable&lt;T&gt;</code> with the <code class="inlineCode">[UseSorting]</code> attribute, as highlighted in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">[UseFiltering]
<strong class="hljs-slc">[</strong><strong class="hljs-meta-slc">UseSorting</strong><strong class="hljs-slc">]</strong>
public IQueryable&lt;Product&gt; GetProducts(NorthwindContext db) =&gt;
  db.Products.Include(p =&gt; p.Category);
</code></pre>
    <p class="normal">In a query, apply one or more sort orders, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">query ProductsSortedByMostExpensive {
  products(order: [ { unitPrice: DESC } ]) {
    productId
    productName
    unitPrice
  }
}
</code></pre>
    <p class="normal"><code class="inlineCode">SortEnumType</code> has two values, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">enum SortEnumType {
  ASC
  DESC
}
</code></pre>
    <p class="normal">I will leave adding sorting capabilities<a id="_idIndexMarker1299"/> to your GraphQL service<a id="_idIndexMarker1300"/> to you.</p>
    <h1 class="heading-1" id="_idParaDest-454">Building .NET clients for a GraphQL service</h1>
    <p class="normal">Now that we have explored some queries<a id="_idIndexMarker1301"/> with the <strong class="screenText">Banana Cake Pop</strong> tool, let’s see how a client<a id="_idIndexMarker1302"/> could call the GraphQL service. Although the <strong class="screenText">Banana Cake Pop</strong> tool is convenient, it runs in the same domain as the service, so some issues might not become apparent until we create a separate client.</p>
    <h2 class="heading-2" id="_idParaDest-455">Choosing GraphQL request formats</h2>
    <p class="normal">Most GraphQL services process <code class="inlineCode">GET</code> and <code class="inlineCode">POST</code> requests<a id="_idIndexMarker1303"/> in either the <code class="inlineCode">application/graphql</code> or <code class="inlineCode">application/json</code> media formats. An <code class="inlineCode">application/graphql</code> request would only contain a query document. The benefit of using <code class="inlineCode">application/json</code> is that as well as the query document, you can specify operations when you have more than one, and define and set variables, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">{
  "query": "...",
  "operationName": "...",
  "variables": { "variable1": "value1", ... }
}
</code></pre>
    <p class="normal">We will use the <code class="inlineCode">application/json</code> media format so that we can pass variables and their values.</p>
    <h2 class="heading-2" id="_idParaDest-456">Understanding the GraphQL response format</h2>
    <p class="normal">A GraphQL service should return a JSON document<a id="_idIndexMarker1304"/> containing the expected data object and maybe some errors in an array, with the following structure:</p>
    <pre class="programlisting code"><code class="hljs-code">{
  "data": { ... },
  "errors": [ ... ]
}
</code></pre>
    <p class="normal">The <code class="inlineCode">errors</code> array should only be in the document if there are errors.</p>
    <h2 class="heading-2" id="_idParaDest-457">Using REST Client as a GraphQL client</h2>
    <p class="normal">Before we write code as a client<a id="_idIndexMarker1305"/> to the GraphQL service, it would be good<a id="_idIndexMarker1306"/> to test it with your code editor’s <code class="inlineCode">.http</code> file support. This is so that if our .NET client app does not work, we know the problem is in our client code rather than the service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">If you are using Visual Studio Code and have not already installed REST Client by Huachao Mao (<code class="inlineCode">humao.rest-client</code>), then install it now.</li>
      <li class="numberedList">In your preferred code editor, start the <code class="inlineCode">Northwind.GraphQL.Service</code> project web service, using the <code class="inlineCode">https</code> profile without debugging, and leave it running.</li>
      <li class="numberedList">In your code editor, in the <code class="inlineCode">HttpRequests</code> folder, create a file named <code class="inlineCode">graphql-queries.http</code>, and modify<a id="_idIndexMarker1307"/> its contents to contain<a id="_idIndexMarker1308"/> a request to get products in the seafood category, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">### Configure a variable for the GraphQL service base address.
@base_address = https://localhost:5121/graphql
### Get all products in the specified category.
POST {{base_address}}
Content-Type: application/json
{
  "query" : "{productsInCategory(categoryId:8){productId productName unitsInStock}}"
}
</code></pre>
      </li>
      <li class="numberedList">Send the query request, and note the response, as shown in <em class="italic">Figure 12.8</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_08.png"/></figure>
    <p class="packt_figref">Figure 12.8: Requesting seafood products using REST Client</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Add a query to make a request to get the ID, name, and description of all categories, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">### Get all categories.
POST {{base_address}}
Content-Type: application/json
{
  "query" : "{categories{categoryId categoryName description}}"
}
</code></pre>
      </li>
      <li class="numberedList">Send the query request, and note<a id="_idIndexMarker1309"/> the response contains the eight categories<a id="_idIndexMarker1310"/> in a <code class="inlineCode">data</code> property.</li>
      <li class="numberedList">In the query document, change <code class="inlineCode">categoryId</code> to <code class="inlineCode">id</code>.</li>
      <li class="numberedList">Send the query request, and note the response contains an <code class="inlineCode">errors</code> array, as shown in the following response:
        <pre class="programlisting con"><code class="hljs-con">Response time: 60 ms
Status code: BadRequest (400)
Alt-Svc: h3=":5121"; ma=86400
Transfer-Encoding: chunked
Date: Tue, 06 Jun 2023 16:35:18 GMT
Server: Kestrel
Content-Type: application/graphql-response+json; charset=utf-8
Content-Length: 338
------------------------------------------------
Content:
{
  "errors": [
    {
      "message": "The field `id` does not exist on the type `Category`.",
      "locations": [
        {
          "line": 1,
          "column": 13
        }
      ],
      "path": [
        "categories"
      ],
      "extensions": {
        "type": "Category",
        "field": "id",
        "responseName": "id",
        "specifiedBy": "http://spec.graphql.org/October2021/#sec-Field-Selections-on-Objects-Interfaces-and-Unions-Types"
      }
    }
  ]
}
</code></pre>
      </li>
      <li class="numberedList">In the query document, change <code class="inlineCode">id</code> back to <code class="inlineCode">categoryId</code>.</li>
      <li class="numberedList">Add a query to request<a id="_idIndexMarker1311"/> to get the ID and name of a category<a id="_idIndexMarker1312"/> specified by a parameter for its ID, along with the ID and name of each of its products, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">### Get a category and its products using a variable.
POST {{base_address}}
Content-Type: application/json
{
  "query": "query categoryAndItsProducts($id: Int!){category(categoryId: $id){categoryId categoryName products{productId productName}}}",
  "variables": {"id":1}
}
</code></pre>
      </li>
      <li class="numberedList">Send the query request, and note the response contains category <code class="inlineCode">1</code>, <code class="inlineCode">Beverages</code>, with its products in a <code class="inlineCode">data</code> property.</li>
      <li class="numberedList">Change the ID to <code class="inlineCode">4</code>, send the request, and note the response contains category <code class="inlineCode">4</code>, <code class="inlineCode">Dairy Products</code>, with its products in a <code class="inlineCode">data</code> property.</li>
    </ol>
    <p class="normal">Now that we have done some basic<a id="_idIndexMarker1313"/> testing of the service and its responses<a id="_idIndexMarker1314"/> to queries that we want to run, we can build a client to make those queries and process the JSON responses.</p>
    <h2 class="heading-2" id="_idParaDest-458">Using an ASP.NET Core MVC project as a GraphQL client</h2>
    <p class="normal">We will create a model class to make<a id="_idIndexMarker1315"/> it easy to deserialize<a id="_idIndexMarker1316"/> the response:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to add a new project, as defined in the following list:<ol class="numberedList" style="list-style-type: decimal;">
          <li class="numberedList" value="1">Project template: <strong class="screenText">ASP.NET Core Web App (Model-View-Controller)</strong> / <code class="inlineCode">mvc</code></li>
          <li class="numberedList">Solution file and folder: <code class="inlineCode">Chapter12</code></li>
          <li class="numberedList">Project file and folder: <code class="inlineCode">Northwind.GraphQL.Client.Mvc</code></li>
          <li class="numberedList">Other Visual Studio 2022 options: <ul>
              <li class="bulletList"><strong class="screenText">Authentication Type</strong>: None</li>
              <li class="bulletList"><strong class="screenText">Configure for HTTPS</strong>: Selected</li>
              <li class="bulletList"><strong class="screenText">Enable Docker</strong>: Cleared</li>
              <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared</li>
            </ul>
          </li>
        </ol>
      </li>
      <li class="numberedList">In Visual Studio 2022, set the startup project with the current selection.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.GraphQL.Client.Mvc</code> project, add a project reference to the Northwind entity models project, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\..\Chapter03\Northwind.Common.EntityModels
.SqlServer\Northwind.Common.EntityModels.SqlServer.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal">The path to the project must not have a line break.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Build the <code class="inlineCode">Northwind.GraphQL.Client.Mvc</code> project at the command prompt or terminal.</li>
      <li class="numberedList">In the <code class="inlineCode">Properties</code> folder, in <code class="inlineCode">launchSettings.json</code>, modify the <code class="inlineCode">applicationUrl</code> to use port <code class="inlineCode">5123</code> for <code class="inlineCode">https</code> and port <code class="inlineCode">5124</code> for <code class="inlineCode">http</code>, as highlighted in the following configuration:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-attr-slc">"https"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">{</strong>
  "commandName": "Project",
  "dotnetRunMessages": true,
  "launchBrowser": true,
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"applicationUrl"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"https://localhost:5123;http://localhost:5124"</strong><strong class="hljs-punctuation-slc">,</strong>
  "environmentVariables": {
    "ASPNETCORE_ENVIRONMENT": "Development"
  }
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.GraphQL.Client.Mvc</code> project, in the <code class="inlineCode">Models</code> folder, add<a id="_idIndexMarker1317"/> a new class file<a id="_idIndexMarker1318"/> named <code class="inlineCode">ResponseErrors.cs</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.GraphQL.Client.Mvc.Models;
public class ResponseErrors
{
  public Error[]? Errors { get; set; }
}
public class Error
{
  public string Message { get; set; } = null!;
  public Location[] Locations { get; set; } = null!;
  public string[] Path { get; set; } = null!;
}
public class Location
{
  public int Line { get; set; }
  public int Column { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Models</code> folder, add a new class file named <code class="inlineCode">ResponseProducts.cs</code>, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels; // To use Product.
namespace Northwind.GraphQL.Client.Mvc.Models;
public class ResponseProducts
{
  public class DataProducts
  {
    public Product[]? ProductsInCategory { get; set; }
  }
  public DataProducts? Data { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Models</code> folder, add a new<a id="_idIndexMarker1319"/> class file named <code class="inlineCode">ResponseCategories.cs</code>, as shown in the following<a id="_idIndexMarker1320"/> code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels; // To use Category.
namespace Northwind.GraphQL.Client.Mvc.Models;
public class ResponseCategories
{
  public class DataCategories
  {
    public Category[]? Categories { get; set; }
  }
  public DataCategories? Data { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Models</code> folder, add a new class file named <code class="inlineCode">IndexViewModel.cs</code> , which will have properties to store all the data that we might want to show in the view, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels; // To use Product.
using System.Net; // To use HttpStatusCode.
namespace Northwind.GraphQL.Client.Mvc.Models;
public class IndexViewModel
{
  public HttpStatusCode Code { get; set; }
  public string? RawResponseBody { get; set; }
  public Product[]? Products { get; set; }
  public Category[]? Categories { get; set; }
  public Error[]? Errors { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, import the namespace to set HTTP headers, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using System.Net.Http.Headers; // To use MediaTypeWithQualityHeaderValue.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after the <code class="inlineCode">CreateBuilder</code> method call, add statements to register an HTTP client for the GraphQL service, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddHttpClient(name: "Northwind.GraphQL.Service",
  configureClient: options =&gt;
  {
    options.BaseAddress = new Uri("https://localhost:5121/");
    options.DefaultRequestHeaders.Accept.Add(
      new MediaTypeWithQualityHeaderValue(
      "application/json", 1.0));
  });
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Controllers</code> folder, in <code class="inlineCode">HomeController.cs</code>, import the namespace<a id="_idIndexMarker1321"/> to work with text encodings<a id="_idIndexMarker1322"/> and for the local project models, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.Mvc.GraphQLClient.Models; // To use IndexViewModel.
using System.Text; // To use Encoding.
</code></pre>
      </li>
      <li class="numberedList">Define a field to store the registered HTTP client factory, and set it in the constructor, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">protected</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> IHttpClientFactory _clientFactory;</strong>
public HomeController(ILogger&lt;HomeController&gt; logger<strong class="hljs-params-slc">, </strong>
<strong class="hljs-params-slc">  IHttpClientFactory clientFactory</strong>)
{
  _logger = logger;
<strong class="hljs-slc">  _clientFactory = clientFactory;</strong>
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Index</code> action method, modify the method to be asynchronous. Then, add statements to call the GraphQL service, and note that the HTTP request is a <code class="inlineCode">POST</code>, the media type is for an <code class="inlineCode">application/json</code> document that contains a GraphQL query, and the query requests the ID, name, and number of units in stock for all products in a given category, passed as a parameter<a id="_idIndexMarker1323"/> named <code class="inlineCode">id</code>, as shown in the following<a id="_idIndexMarker1324"/> code:
        <pre class="programlisting code"><code class="hljs-code">public async Task&lt;IActionResult&gt; Index(string id = "1")
{
  IndexViewModel model = new();
  try
  {
    HttpClient client = _clientFactory.CreateClient(
      name: "Northwind.GraphQL.Service");
    // First, try a simple GET request to service root.
    HttpRequestMessage request = new(
      method: HttpMethod.Get, requestUri: "/");
    HttpResponseMessage response = await client.SendAsync(request);
    if (!response.IsSuccessStatusCode)
    {
      model.Code = response.StatusCode;
      model.Errors = new[] { new Error { Message = 
        "Service is not successfully responding to GET requests." } };
      return View(model);
    }
    // Next, make a request to the GraphQL endpoint.
    request = new(
      method: HttpMethod.Post, requestUri: "graphql");
    request.Content = new StringContent(content: $$$"""
{
  "query": "{productsInCategory(categoryId:{{{id}}}){productId productName unitsInStock}}"
}
      """,
      encoding: Encoding.UTF8,
      mediaType: "application/json");
    response = await client.SendAsync(request);
    model.Code = response.StatusCode;
    model.RawResponseBody = await response.Content.ReadAsStringAsync();
    if (response.IsSuccessStatusCode)
    {
      model.Products = (await response.Content
        .ReadFromJsonAsync&lt;ResponseProducts&gt;())?.Data?.ProductsInCategory;
    }
    else
    {
      model.Errors = (await response.Content
        .ReadFromJsonAsync&lt;ResponseErrors&gt;())?.Errors;
    }
  }
  catch (Exception ex)
  {
    _logger.LogWarning(
      $"Northwind.GraphQL.Service exception: {ex.Message}");
    model.Errors = new[] { new Error { Message = ex.Message } };
  }
  return View(model);
}
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: To set the content of our request, we will use the C# 11 or later raw interpolated string literal syntax of three-dollar signs and three double quotes. This allows us to embed the <code class="inlineCode">id</code> variable using three curly braces, which should not be confused with the two curly braces after <code class="inlineCode">unitsInStock</code>, which end the query itself.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="15">In the <code class="inlineCode">Views/Home</code> folder, in <code class="inlineCode">Index.cshtml</code>, delete<a id="_idIndexMarker1325"/> its existing markup, and then<a id="_idIndexMarker1326"/> add markup to render the seafood products, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">@using Northwind.EntityModels
@using Northwind.GraphQL.Client.Mvc.Models @* for VS Code only *@
@model IndexViewModel
@{
  ViewData["Title"] = "Products from GraphQL service";
}
&lt;div class="text-center"&gt;
  &lt;h1 class="display-4"&gt;@ViewData["Title"]&lt;/h1&gt;
  &lt;div class="card card-body"&gt;
    &lt;form&gt;
      Enter a category id
      &lt;input name="id" value="1" /&gt;
      &lt;input type="submit" /&gt;
    &lt;/form&gt;
  &lt;/div&gt;
  @if (Model.Errors is not null)
  {
    &lt;div class="alert alert-danger" role="alert"&gt;
      &lt;table class="table table-striped"&gt;
        &lt;thead&gt;
        &lt;tr&gt;
          &lt;td&gt;Message&lt;/td&gt;
          &lt;td&gt;Path&lt;/td&gt;
          &lt;td&gt;Locations&lt;/td&gt;
        &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
          @foreach (Error error in Model.Errors)
          {
            &lt;tr&gt;
              &lt;td&gt;@error.Message&lt;/td&gt;
              &lt;td&gt;
                @if (error.Path is not null)
                {
                  @foreach (string path in error.Path)
                  {
                    &lt;span class="badge bg-danger"&gt;@path&lt;/span&gt;
                  }
                }
              &lt;/td&gt;
              &lt;td&gt;
                @if (error.Locations is not null)
                {
                  @foreach (Location location in error.Locations)
                  {
                    &lt;span class="badge bg-danger"&gt;
                      @location.Line, @location.Column
                    &lt;/span&gt;
                  }
                }
              &lt;/td&gt;
            &lt;/tr&gt;
          }
        &lt;/tbody&gt;
      &lt;/table&gt;
    &lt;/div&gt;
  }
  @if (Model.Categories is not null)
  {
    &lt;div&gt;
      &lt;p class="alert alert-success" role="alert"&gt;
        There are @Model.Categories.Count() products.&lt;/p&gt;
      &lt;p&gt;
        @foreach (Category category in Model.Categories)
        {
          &lt;span class="badge bg-dark"&gt;
            @category.CategoryId
            @category.CategoryName
          &lt;/span&gt;
        }
      &lt;/p&gt;
    &lt;/div&gt;
  }
  @if (Model.Products is not null)
  {
    &lt;div&gt;
      &lt;p class="alert alert-success" role="alert"&gt;
        There are @Model.Products.Count() products.&lt;/p&gt;
      &lt;p&gt;
        @foreach (Product p in Model.Products)
        {
          &lt;span class="badge bg-dark"&gt;
            @p.ProductId
            @p.ProductName
            -
            @(p.UnitsInStock is null ? "0" : p.UnitsInStock.Value) in stock
          &lt;/span&gt;
        }
      &lt;/p&gt;
    &lt;/div&gt;
  }
  &lt;p&gt;
    &lt;a class="btn btn-primary" data-bs-toggle="collapse" 
       href="#collapseExample" role="button" 
       aria-expanded="false" aria-controls="collapseExample"&gt;
      Show/Hide Details
    &lt;/a&gt;
  &lt;/p&gt;
  &lt;div class="collapse" id="collapseExample"&gt;
    &lt;div class="card card-body"&gt;
      Status code @((int)Model.Code): @Model.Code
      &lt;hr /&gt;
      @Model.RawResponseBody
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-459">Testing the .NET client</h2>
    <p class="normal">Now, we can test<a id="_idIndexMarker1327"/> our .NET client:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">If your database server is not running, for example, because you are hosting it in Docker, a virtual machine, or in the cloud, then make sure to start it.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.GraphQL.Service</code> project, using its <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.GraphQL.Client.Mvc</code> project, using its <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Note that products are successfully retrieved using GraphQL, as shown in <em class="italic">Figure 12.9</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_09.png"/></figure>
    <p class="packt_figref">Figure 12.9: Products in the Beverages category from the GraphQL service</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Enter another category<a id="_idIndexMarker1328"/> ID that exists, for example, <code class="inlineCode">4</code>.</li>
      <li class="numberedList">Enter a category ID that is out of range, for example, <code class="inlineCode">13</code>, and note that there are 0 products returned.</li>
      <li class="numberedList">Close Chrome, and shut down the web server for the <code class="inlineCode">Northwind.GraphQL.Client.Mvc</code> project.</li>
      <li class="numberedList">In <code class="inlineCode">HomeController.cs</code>, modify the query to make a deliberate mistake, like changing <code class="inlineCode">productId</code> to <code class="inlineCode">productid</code>.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.GraphQL.Client.Mvc</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Click the <strong class="screenText">Show/Hide Details</strong> button, and note the error message and response details, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{"errors":[{"message":"The field \u0060productid\u0060 
does not exist on the type \u0060Product\u0060.",
 "locations":[{"line":1,"column":35}],
 "path":["productsInCategory"],
 "extensions":{"type":"Product","field":"productid",
 "responseName":"productid",
 "specifiedBy":"http://spec.graphql.org/October2021/
#sec-Field-Selections-on-Objects-Interfaces-and-Unions-Types"}}]}
</code></pre>
      </li>
      <li class="numberedList">Close Chrome, and shut down both web servers.</li>
      <li class="numberedList">Fix the mistake<a id="_idIndexMarker1329"/> in the query!</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-460">Creating a console app client using Strawberry Shake</h2>
    <p class="normal">Instead of using ordinary<a id="_idIndexMarker1330"/> HTTP clients, ChilliCream has a GraphQL client<a id="_idIndexMarker1331"/> library to more easily build .NET clients to GraphQL services.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn more about Strawberry Shake<a id="_idIndexMarker1332"/> at the following link: <a href="https://chillicream.com/docs/strawberryshake">https://chillicream.com/docs/strawberryshake</a></p>
    </div>
    <p class="normal">Now, let’s create another client using Strawberry Shake so that you can see the benefits:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to add a new <strong class="screenText">Console App</strong> / <code class="inlineCode">console</code> project, named <code class="inlineCode">Northwind.GraphQL.Client.Console</code>.</li>
      <li class="numberedList">At the command prompt or terminal for the project folder, create a tools manifest file, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet new tool-manifest
</code></pre>
      </li>
      <li class="numberedList">At the command line or terminal, install the Strawberry Shake tools, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet tool install StrawberryShake.Tools --local
</code></pre>
      </li>
      <li class="numberedList">Note Strawberry Shake is installed, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">You can invoke the tool from this directory using the following commands:
'dotnet tool run dotnet-graphql' or 'dotnet dotnet-graphql'.
Tool 'strawberryshake.tools' (version '13.5.1') was successfully installed.
Entry is added to the manifest file C:\apps-services-net8\Chapter12\
Northwind.GraphQL.Client.Console\.config\dotnet-tools.json.
</code></pre>
      </li>
      <li class="numberedList">In the project, treat warnings<a id="_idIndexMarker1333"/> as errors, add references to NuGet packages for Microsoft extensions for dependency injection, working with HTTP, and Strawberry Shake code<a id="_idIndexMarker1334"/> generation, and then globally and statically import the <code class="inlineCode">Console</code> class, as highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;Project Sdk="Microsoft.NET.Sdk"&gt;
  &lt;PropertyGroup&gt;
    &lt;OutputType&gt;Exe&lt;/OutputType&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
<strong class="hljs-slc">    &lt;TreatWarningsAsErrors&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/TreatWarningsAsErrors&gt;</strong>
  &lt;/PropertyGroup&gt;
<strong class="hljs-slc">  &lt;ItemGroup&gt;</strong>
<strong class="hljs-slc">    &lt;PackageReference Version=</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">8.0.0"</strong>
<strong class="hljs-slc">      Include=</strong><strong class="hljs-string-slc">"Microsoft.Extensions.DependencyInjection"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">    &lt;PackageReference Version=</strong><strong class="hljs-string-slc">"8.0.0"</strong>
<strong class="hljs-slc">      Include=</strong><strong class="hljs-string-slc">"Microsoft.Extensions.Http"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">    &lt;PackageReference Version=</strong><strong class="hljs-string-slc">"13.5.1"</strong>
<strong class="hljs-slc">      Include=</strong><strong class="hljs-string-slc">"StrawberryShake.Server"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong>
<strong class="hljs-slc">  &lt;ItemGroup&gt;</strong>
<strong class="hljs-slc">    &lt;Using Include=</strong><strong class="hljs-string-slc">"System.Console"</strong><strong class="hljs-slc"> Static=</strong><strong class="hljs-string-slc">"true"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong>
&lt;/Project&gt;
</code></pre>
      
    <div><p class="normal">You need to use different Strawberry Shake packages for different types of .NET project. For console apps and ASP.NET Core apps, reference <code class="inlineCode">StrawberryShake.Server</code>. For Blazor WebAssembly apps, reference <code class="inlineCode">StrawberryShake.Blazor</code>. For .NET MAUI apps, reference <code class="inlineCode">StrawberryShake.Maui</code>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Build the <code class="inlineCode">Northwind.GraphQL.Client.Console</code> project to restore packages.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.GraphQL.Service</code> project, using the <code class="inlineCode">https</code> profile without debugging, and leave it running so that the Strawberry Shake tool can talk to it.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.GraphQL.Client.Console</code> project, at the command prompt or terminal, add a client for your GraphQL service, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet graphql init https://localhost:5121/graphql/ -n NorthwindClient
</code></pre>
      </li>
      <li class="numberedList">Note the results, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Download schema started.
Download schema completed in 189 ms
Client configuration started.
Client configuration completed in 83 ms
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.GraphQL.Client.Console</code> project, in the <code class="inlineCode">.graphqlrc.json</code> file, add an entry to control<a id="_idIndexMarker1335"/> the C# namespace used<a id="_idIndexMarker1336"/> during code generation, as highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">{
  "schema": "schema.graphql",
  "documents": "**/*.graphql",
  "extensions": {
    "strawberryShake": {
      "name": "NorthwindClient",
<strong class="hljs-slc">      </strong><strong class="hljs-attr-slc">"namespace"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"Northwind.GraphQL.Client.Console"</strong><strong class="hljs-punctuation-slc">,</strong>
      "url": "https://localhost:5111/graphql/",
      "records": {
        "inputs": false,
        "entities": false
      },
      "transportProfiles": [
        {
          "default": "Http",
          "subscription": "WebSocket"
        }
      ]
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.GraphQL.Client.Console</code> project, add a new file named <code class="inlineCode">seafoodProducts.graphql</code>, which defines a query to get seafood products, as shown in the following document:
        <pre class="programlisting code"><code class="hljs-code">query SeafoodProducts {
  productsInCategory(categoryId:8) {
    productId 
    productName 
    unitsInStock
  }
}
</code></pre>
        <div><p class="normal">GraphQL queries used by Strawberry Shake must be named.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="12">If you are using Visual Studio 2022, it might automatically modify the project file to explicitly remove this file from the build process because it does not recognize it. If it has, then delete<a id="_idIndexMarker1337"/> or comment out that element, as shown<a id="_idIndexMarker1338"/> in the following markup:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">&lt;!-- An element like this will remove the file from the build process.</strong>
&lt;ItemGroup&gt;
  &lt;GraphQL Remove="seafoodProducts.graphql" /&gt;
&lt;/ItemGroup&gt;
<strong class="hljs-slc">--&gt;</strong>
</code></pre>
        <div><p class="normal"><strong class="keyWord">Good Practice</strong>: There must be at least one <code class="inlineCode">.graphql</code> file for the Strawberry Shake tool to be able to generate its code automatically. An element like the proceeding one will prevent the Strawberry Shake tool from generating its code, and you will later get compile errors. You should delete or comment out that element.</p>
        </div>
      </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="13">Build the <code class="inlineCode">Northwind.GraphQL.Client.Console</code> project to make Strawberry Shake process the GraphQL query file and generate proxy classes.</li>
      <li class="numberedList">Note the <code class="inlineCode">obj\Debug\net8.0\berry</code> folder that was autogenerated, the file named <code class="inlineCode">NorthwindClient.Client.cs</code>, and the dozen or so types defined by it, including the <code class="inlineCode">INorthwindClient</code> interface, as shown in <em class="italic">Figure 12.10</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_10.png"/></figure>
    <p class="packt_figref">Figure 12.10: The generated class file for the Northwind GraphQL service</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="15">In <code class="inlineCode">Program.cs</code>, delete the existing<a id="_idIndexMarker1339"/> statements. Add statements<a id="_idIndexMarker1340"/> to create a new service collection, add the autogenerated <code class="inlineCode">NorthwindClient</code> to it with the correct URL for the service, and then get and use the dependency service to fetch the seafood products, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Extensions.DependencyInjection; // To use ServiceCollection.
using Northwind.GraphQL.Client.Console; // To use INorthwindClient.
using StrawberryShake; // To use EnsureNoErrors extension method.
ServiceCollection serviceCollection = new();
serviceCollection
  .AddNorthwindClient() // Strawberry Shake extension method.
  .ConfigureHttpClient(client =&gt; 
    client.BaseAddress = new Uri("https://localhost:5121/graphql"));
IServiceProvider services = serviceCollection.BuildServiceProvider();
INorthwindClient client = services.GetRequiredService&lt;INorthwindClient&gt;();
var result = await client.SeafoodProducts.ExecuteAsync();
result.EnsureNoErrors();
if (result.Data is null)
{
  WriteLine("No data!");
  return; 
}
foreach (var product in result.Data.ProductsInCategory)
{
  WriteLine("{0}: {1}",
    product.ProductId, product.ProductName);
}
</code></pre>
      </li>
      <li class="numberedList">Run the console app<a id="_idIndexMarker1341"/> and note the results, as shown<a id="_idIndexMarker1342"/> in the following output:
        <pre class="programlisting con"><code class="hljs-con">10: Ikura
13: Konbu
18: Carnarvon Tigers
30: Nord-Ost Matjeshering
36: Inlagd Sill
37: Gravad lax
40: Boston Crab Meat
41: Jack's New England Clam Chowder
45: Rogede sild
46: Spegesild
58: Escargots de Bourgogne
73: Röd Kaviar
</code></pre>
      </li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-461">Implementing GraphQL mutations</h1>
    <p class="normal">Most services need to modify<a id="_idIndexMarker1343"/> data as well as<a id="_idIndexMarker1344"/> query it. GraphQL calls these <strong class="keyWord">mutations</strong>. A mutation has three related components:</p>
    <ul>
      <li class="bulletList">The mutation itself, which defines<a id="_idIndexMarker1345"/> the change that will be made to the graph. It should be named using a verb, a noun, and use camel casing, for example, <code class="inlineCode">addProduct</code>.</li>
      <li class="bulletList">The <strong class="keyWord">input</strong> is the input for a mutation, and it should have the same name as the mutation with a suffix of <code class="inlineCode">Input</code>, for example, <code class="inlineCode">AddProductInput</code>. Although there is only one input, it is an object graph, so it can be as complex as you need.</li>
      <li class="bulletList">The <strong class="keyWord">payload</strong> is the returned document for a mutation, and it should have the same name as the mutation with a suffix of <code class="inlineCode">Payload</code>, for example, <code class="inlineCode">AddProductPayload</code>. Although there is only one payload, it is an object graph, so it can be as complex as you need.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-462">Adding mutations to the GraphQL service</h2>
    <p class="normal">Let’s define mutations<a id="_idIndexMarker1346"/> for adding, and later, we will define some<a id="_idIndexMarker1347"/> to update and delete products:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.GraphQL.Service</code> project/folder, add a class file named <code class="inlineCode">Mutation.cs</code>.</li>
      <li class="numberedList">In the class file, define a record and two classes to represent the three types needed to perform an <code class="inlineCode">addProduct</code> mutation, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels; // To use Product.
namespace Northwind.GraphQL.Service;
// Inputs are readonly so we will use a record.
public record AddProductInput(
  string ProductName,
  int? SupplierId,
  int? CategoryId,
  string QuantityPerUnit,
  decimal? UnitPrice,
  short? UnitsInStock,
  short? UnitsOnOrder,
  short? ReorderLevel,
  bool Discontinued);
public class AddProductPayload
{
  public AddProductPayload(Product product)
  {
    Product = product;
  }
  public Product Product { get; }
}
public class Mutation
{
  public async Task&lt;AddProductPayload&gt; AddProductAsync(
    AddProductInput input, NorthwindContext db)
  {
    // This could be a good place to use a tool like AutoMapper,
    // but we will do the mapping between two objects manually.
    Product product = new()
    {
      ProductName = input.ProductName,
      SupplierId = input.SupplierId,
      CategoryId = input.CategoryId,
      QuantityPerUnit = input.QuantityPerUnit,
      UnitPrice = input.UnitPrice,
      UnitsInStock = input.UnitsInStock,
      UnitsOnOrder = input.UnitsOnOrder,
      ReorderLevel = input.ReorderLevel,
      Discontinued = input.Discontinued
    };
    db.Products.Add(product);
    int affectedRows = await db.SaveChangesAsync();
    // We could use affectedRows to return an error
    // or some other action if it is 0.
    return new AddProductPayload(product);
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, add a call to the <code class="inlineCode">AddMutationType&lt;T&gt;</code> method<a id="_idIndexMarker1348"/> to register your <code class="inlineCode">Mutation</code> class, as highlighted<a id="_idIndexMarker1349"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services
  .AddGraphQLServer()
  .AddFiltering()
  .AddSorting()
  .RegisterDbContext&lt;NorthwindContext&gt;()
  .AddQueryType&lt;Query&gt;()
<strong class="hljs-slc">  .AddMutationType&lt;Mutation&gt;();</strong>
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-463">Exploring the add product mutation</h2>
    <p class="normal">Now, we can explore<a id="_idIndexMarker1350"/> mutations using Banana Cake Pop:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start the <code class="inlineCode">Northwind.GraphQL.Service</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">In <strong class="screenText">Banana Cake Pop</strong>, click the <strong class="screenText">+</strong> to open a new tab.</li>
      <li class="numberedList">Click the <strong class="screenText">Schema Definition</strong> tab, and note the mutation type, as partially shown in <em class="italic">Figure 12.11</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_11.png"/></figure>
    <p class="packt_figref">Figure 12.11: Schema to mutate a product using GraphQL</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Note the full schema<a id="_idIndexMarker1351"/> definitions for the <code class="inlineCode">addProduct</code> mutation and its related types, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">type Mutation {
  addProduct(input: AddProductInput!): AddProductPayload!
}
type Product {
  productId: Int!
  productName: String!
  supplierId: Int
  categoryId: Int
  quantityPerUnit: String
  unitPrice: Decimal
  unitsInStock: Short
  unitsOnOrder: Short
  reorderLevel: Short
  discontinued: Boolean!
  category: Category
  supplier: Supplier
  orderDetails: [OrderDetail!]!
}
...
type AddProductPayload {
  product: Product!
}
input AddProductInput {
  productName: String!
  supplierId: Int
  categoryId: Int
  quantityPerUnit: String!
  unitPrice: Decimal
  unitsInStock: Short
  unitsOnOrder: Short
  reorderLevel: Short
  discontinued: Boolean!
}
</code></pre>
      </li>
      <li class="numberedList">Click the <strong class="screenText">Operations</strong> tab and, if necessary, create a new blank document, and then enter a mutation to add a new product named <code class="inlineCode">Tasty Burgers</code>. Then, from the returned <code class="inlineCode">product</code> object, just select<a id="_idIndexMarker1352"/> the ID and name, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">mutation AddProduct {
  addProduct(
    input: {
      productName: "Tasty Burgers"
      supplierId: 1
      categoryId: 2
      quantityPerUnit: "6 per box"
      unitPrice: 40
      unitsInStock: 0
      unitsOnOrder: 0
      reorderLevel: 0
      discontinued: false
    }
  )
  {
    product {
      productId
      productName
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note that the new product has been successfully added and assigned the next sequential number by the SQL Server database, which could be any number over 77, depending<a id="_idIndexMarker1353"/> on if you have already added some other products, as shown in the following output and in <em class="italic">Figure 12.12</em>:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "addProduct": {
      "product": {
        "productId": 79,
        "productName": "Tasty Burgers",
      }
    }
  }
}
</code></pre>
        <div><p class="normal"><strong class="keyWord">Warning!</strong> Please make a note of the ID assigned to the new product you have added. In the next section, you will update this product and then delete it. You cannot delete any of the existing products with IDs between 1 and 77 because they are related to other tables, and doing so would throw a referential integrity exception!</p>
        </div>
      </li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_12.png"/></figure>
    <p class="packt_figref">Figure 12.12: Adding a new product using a GraphQL mutation</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Close the browser, and shut down<a id="_idIndexMarker1354"/> the web server.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-464">Implementing updates and deletes as mutations</h2>
    <p class="normal">Next, we will define mutations<a id="_idIndexMarker1355"/> to update just the unit price <a id="_idIndexMarker1356"/>for a product, all the “units” fields<a id="_idIndexMarker1357"/> for a product, and<a id="_idIndexMarker1358"/> delete a product:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Mutation.cs</code>, define three <code class="inlineCode">record</code> types to represent the inputs needed to perform two <code class="inlineCode">updateProduct</code> and one <code class="inlineCode">deleteProduct</code> mutations, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public record UpdateProductPriceInput(
  int? ProductId,
  decimal? UnitPrice);
public record UpdateProductUnitsInput(
  int? ProductId,
  short? UnitsInStock,
  short? UnitsOnOrder,
  short? ReorderLevel);
public record DeleteProductInput(
  int? ProductId);
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Mutation.cs</code>, define two class<a id="_idIndexMarker1359"/> types to represent the types needed <a id="_idIndexMarker1360"/>to return the results from<a id="_idIndexMarker1361"/> an <code class="inlineCode">update</code> or <code class="inlineCode">delete</code> mutation, including if the action was successful, as shown<a id="_idIndexMarker1362"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code">public class UpdateProductPayload
{
  public UpdateProductPayload(Product? product, bool updated)
  {
    Product = product;
    Success = updated;
  }
  public Product? Product { get; }
  public bool Success { get; }
}
public class DeleteProductPayload
{
  public DeleteProductPayload(bool deleted)
  {
    Success = deleted;
  }
  public bool Success { get; }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Mutation.cs</code>, in the <code class="inlineCode">Mutation</code> class, define three methods to implement two <code class="inlineCode">updateProduct</code> and one <code class="inlineCode">deleteProduct</code> mutations, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public async Task&lt;UpdateProductPayload&gt; UpdateProductPriceAsync(
  UpdateProductPriceInput input, NorthwindContext db)
{
  Product? product = await db.Products.FindAsync(input.ProductId);
  int affectedRows = 0;
  if (product is not null)
  {
    product.UnitPrice = input.UnitPrice;
    affectedRows = await db.SaveChangesAsync();
  }
  return new UpdateProductPayload(product, 
    updated: affectedRows == 1);
}
public async Task&lt;UpdateProductPayload&gt; UpdateProductUnitsAsync(
  UpdateProductUnitsInput input, NorthwindContext db)
{
  Product? product = await db.Products.FindAsync(input.ProductId);
  int affectedRows = 0;
  if (product is not null)
  {
    product.UnitsInStock = input.UnitsInStock;
    product.UnitsOnOrder = input.UnitsOnOrder;
    product.ReorderLevel = input.ReorderLevel;
    affectedRows = await db.SaveChangesAsync();
  }
  return new UpdateProductPayload(product,
    updated: affectedRows == 1);
}
public async Task&lt;DeleteProductPayload&gt; DeleteProductAsync(
  DeleteProductInput input, NorthwindContext db)
{
  Product? product = await db.Products.FindAsync(input.ProductId);
  int affectedRows = 0;
  if (product is not null)
  {
    db.Products.Remove(product);
    affectedRows = await db.SaveChangesAsync();
  }
  return new DeleteProductPayload(
    deleted: affectedRows == 1);
}
</code></pre>
      </li>
      <li class="numberedList">If your database server<a id="_idIndexMarker1363"/> is not running, for example, because you are hosting<a id="_idIndexMarker1364"/> it in Docker, a virtual<a id="_idIndexMarker1365"/> machine, or in the cloud, then<a id="_idIndexMarker1366"/> make sure to start it.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.GraphQL.Service</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">In <strong class="screenText">Banana Cake Pop</strong>, click the <strong class="screenText">+</strong> to open a new tab.</li>
      <li class="numberedList">Write a named query to request products that you have added, for example, with a <code class="inlineCode">productId</code> greater than <code class="inlineCode">77</code>, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">query NewProducts {
  products(where: { productId: { gt: 77 } }) {
    productId
    productName
    unitPrice
    unitsInStock
    unitsOnOrder
    reorderLevel
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note the response includes the new product you previously added with a unit price of <code class="inlineCode">40</code>, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "products": [
      {
        "productId": 79,
        "productName": "Tasty Burgers",
        "unitPrice": 40,
        "unitsInStock": 0,
        "unitsOnOrder": 0,
        "reorderLevel": 0
      }
    ]
  }
}
</code></pre>
      </li>
      <li class="numberedList">Make a note of the <code class="inlineCode">productId</code> of the product you added. In my case, it is <code class="inlineCode">79</code>.</li>
      <li class="numberedList">In <strong class="screenText">Banana Cake Pop</strong>, click the <strong class="screenText">+</strong> to open a new tab.</li>
      <li class="numberedList">Enter a mutation to update the unit<a id="_idIndexMarker1367"/> price of your new product to <code class="inlineCode">75</code>, and then<a id="_idIndexMarker1368"/> from the returned <code class="inlineCode">product</code> object, just <a id="_idIndexMarker1369"/>select the ID, name, unit <a id="_idIndexMarker1370"/>price, and units in stock, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">mutation UpdateProductPrice {
  updateProductPrice(
    input: {
      productId: 79
      unitPrice: 75
    }
  ) 
  {
    product {
      productId
      productName
      unitPrice
      unitsInStock
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note the response, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "updateProductPrice": {
      "product": {
        "productId": 79,
        "productName": "Tasty Burgers",
        "unitPrice": 75,
        "unitsInStock": 0
      }
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click the <strong class="screenText">+</strong> to open a new <a id="_idIndexMarker1371"/>tab, enter a mutation to update<a id="_idIndexMarker1372"/> the units of an existing product, and then<a id="_idIndexMarker1373"/> from the returned <code class="inlineCode">product</code> object just select the ID, name, unit price, and<a id="_idIndexMarker1374"/> units in stock, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">mutation UpdateProductUnits {
  updateProductUnits(
    input: {
      productId: 79
      unitsInStock: 20
      unitsOnOrder: 0
      reorderLevel: 10
    }
  ) 
  {
    success
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note the response, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "updateProductUnits": {
      "success": true
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">In the query tab to request new products, click <strong class="screenText">Run</strong>, and note the response, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "products": [
      {
        "productId": 79,
        "productName": "Tasty Burgers",
        "unitPrice": 75,
        "unitsInStock": 20,
        "unitsOnOrder": 0,
        "reorderLevel": 10
      }
    ]
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click the <strong class="screenText">+</strong> to open a new tab, and enter<a id="_idIndexMarker1375"/> a mutation to delete the product<a id="_idIndexMarker1376"/> and show if it was<a id="_idIndexMarker1377"/> successful, as shown<a id="_idIndexMarker1378"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code">mutation DeleteProduct {
  deleteProduct(
    input: {
      productId: 79
    }
  ) 
  {
    success
  }
}
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Warning!</strong> You will not be able to delete products that are referenced in other tables. IDs 1 to 77 will throw a referential integrity exception.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="17">Click <strong class="screenText">Run</strong>, and note the response, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "deleteProduct": {
      "success": true
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Confirm that the product was deleted by re-running the query for new products, and note that you get an empty array, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "products": []
  }
}
</code></pre>
      </li>
      <li class="numberedList">Close the <a id="_idIndexMarker1379"/>browser, and shut<a id="_idIndexMarker1380"/> down<a id="_idIndexMarker1381"/> the web<a id="_idIndexMarker1382"/> server.</li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-465">Implementing GraphQL subscriptions</h1>
    <p class="normal">GraphQL subscriptions, by default, work over WebSockets<a id="_idIndexMarker1383"/> but can also<a id="_idIndexMarker1384"/> work over <strong class="keyWord">Server-Sent Events</strong> (<strong class="keyWord">SSE</strong>), SignalR, or even gRPC.</p>
    <p class="normal">Imagine that a client app wants to be notified when a product has its unit price reduced. It would be great if the client could subscribe to an event that gets triggered whenever a unit price is reduced, instead of having to query for changes to the unit prices.</p>
    <h2 class="heading-2" id="_idParaDest-466">Adding a subscription and topic to the GraphQL service</h2>
    <p class="normal">Let’s add this feature<a id="_idIndexMarker1385"/> to our GraphQL service <a id="_idIndexMarker1386"/>using subscriptions:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Add a new class file named <code class="inlineCode">ProductDiscount.cs</code>.</li>
      <li class="numberedList">Modify the contents<a id="_idIndexMarker1387"/> to define a model to notify a client about<a id="_idIndexMarker1388"/> a product’s unit price reduction, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.GraphQL.Service;
public class ProductDiscount
{
  public int? ProductId { get; set; }
  public decimal? OriginalUnitPrice { get; set; }
  public decimal? NewUnitPrice { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">Add a new class file named <code class="inlineCode">Subscription.cs</code>.</li>
      <li class="numberedList">Modify the contents to define a subscription<a id="_idIndexMarker1389"/> to an event (aka a topic) named <code class="inlineCode">OnProductDiscounted</code> that a client<a id="_idIndexMarker1390"/> can subscribe<a id="_idIndexMarker1391"/> to, as shown in the following<a id="_idIndexMarker1392"/> code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.GraphQL.Service;
public class Subscription
{
  [Subscribe]
  [Topic]
  public ProductDiscount OnProductDiscounted(
    [EventMessage] ProductDiscount productDiscount)
      =&gt; productDiscount;
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Mutation.cs</code>, in the <code class="inlineCode">UpdateProductPriceAsync</code> method, add statements to send a message over the topic whenever a product has its unit price reduced, as highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">public async Task&lt;UpdateProductPayload&gt; UpdateProductPriceAsync(
  UpdateProductPriceInput input, NorthwindContext db<strong class="hljs-params-slc">,</strong>
<strong class="hljs-params-slc">  ITopicEventSender eventSender</strong>)
{
  Product? product = await db.Products.FindAsync(input.ProductId);
  int affectedRows = 0;
  if (product is not null)
  {
<strong class="hljs-slc">    </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (input.UnitPrice &lt; product.UnitPrice)</strong>
<strong class="hljs-slc">    {</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-comment-slc">// If the product has been discounted,</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-comment-slc">// send a message to subscribers.</strong>
<strong class="hljs-slc">      ProductDiscount productDiscount = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">()</strong>
<strong class="hljs-slc">      {</strong>
<strong class="hljs-slc">        ProductId = input.ProductId,</strong>
<strong class="hljs-slc">        OriginalUnitPrice = product.UnitPrice,</strong>
<strong class="hljs-slc">        NewUnitPrice = input.UnitPrice</strong>
<strong class="hljs-slc">      };</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> eventSender.SendAsync(topicName:</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-keyword-slc">nameof</strong><strong class="hljs-slc">(Subscription.OnProductDiscounted),</strong>
<strong class="hljs-slc">        message: productDiscount);</strong>
<strong class="hljs-slc">    }</strong>
    product.UnitPrice = input.UnitPrice;
    affectedRows = await db.SaveChangesAsync();
  }
  return new UpdateProductPayload(product,
    updated: affectedRows == 1);
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, configure the GraphQL service<a id="_idIndexMarker1393"/> to register the <code class="inlineCode">Subscription</code> class<a id="_idIndexMarker1394"/> and to store active subscriptions<a id="_idIndexMarker1395"/> in-memory, as highlighted<a id="_idIndexMarker1396"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services
  .AddGraphQLServer()
  .AddFiltering()
  .AddSorting()
<strong class="hljs-slc">  .AddSubscriptionType&lt;Subscription&gt;()</strong>
<strong class="hljs-slc">  .AddInMemorySubscriptions()</strong>
  .RegisterDbContext&lt;NorthwindContext&gt;()
  .AddQueryType&lt;Query&gt;()
  .AddMutationType&lt;Mutation&gt;();
</code></pre>
      
    <div><p class="normal">As well as in-memory, you can use Redis and other data stores to keep track of active subscriptions.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Optionally, after building<a id="_idIndexMarker1397"/> the <code class="inlineCode">app</code>, configure<a id="_idIndexMarker1398"/> the use<a id="_idIndexMarker1399"/> of WebSockets, as shown<a id="_idIndexMarker1400"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.UseWebSockets(); // For subscriptions.
</code></pre>
        <div><p class="normal">This is optional because the GraphQL service can fall back to using SSE over <code class="inlineCode">https</code>.</p>
        </div>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-467">Exploring subscribing to a topic</h2>
    <p class="normal">Let’s subscribe to a topic<a id="_idIndexMarker1401"/> and see the results:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start the <code class="inlineCode">Northwind.GraphQL.Service</code> project, using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">In <strong class="screenText">Banana Cake Pop</strong>, click the <strong class="screenText">+</strong> to open a new tab.</li>
      <li class="numberedList">Click the <strong class="screenText">Schema Reference</strong> tab, click the <code class="inlineCode">Subscription</code> type, and note the topic named <strong class="screenText">onProductDiscounted</strong>, as shown in <em class="italic">Figure 12.13</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_13.png"/></figure>
    <p class="packt_figref">Figure 12.13: A subscription with a topic</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Click <strong class="screenText">Operations</strong>, enter a subscription to the topic, and choose all the fields to show in the results, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">subscription {
  onProductDiscounted {
    productId
    originalUnitPrice
    newUnitPrice
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note that the subscription starts but no results are shown yet.</li>
      <li class="numberedList">Click the <strong class="screenText">+</strong> to open a new tab, and enter a mutation<a id="_idIndexMarker1402"/> to update the unit price of the existing product <code class="inlineCode">1</code> to <code class="inlineCode">8.99</code>. Then, from the returned <code class="inlineCode">product</code> object, select the ID and unit price, and show if the update succeeded, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">mutation UpdateProductPrice {
  updateProductPrice(
    input: {
      productId: 1
      unitPrice: 8.99
    }
  ) 
  {
    product {
      productId
      unitPrice
    }
    success
  }
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Run</strong>, and note the response, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">{
  "data": {
    "updateProductPrice": {
      "product": {
        "productId": 1,
        "unitPrice": 8.99
      },
      "success": true
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Switch back to the tab with the subscription, and note the response and that the subscription is still active, indicated by the spinners on the tab and the <strong class="screenText">Cancel</strong> button, as shown in <em class="italic">Figure 12.14</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_12_14.png"/></figure>
    <p class="packt_figref">Figure 12.14: An active subscription shows a spinner</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">Switch back to the tab with the update mutation, change the unit price to <code class="inlineCode">7.99</code>, and click <strong class="screenText">Run</strong>. Then, switch back to the tab with the subscription, and note that it receives that update notification too.</li>
      <li class="numberedList">Switch back to the tab with the update mutation, change the unit price to <code class="inlineCode">9.99</code>, and click <strong class="screenText">Run</strong>. Then, switch back to the tab with the subscription, and note that it has not been sent any notifications because the unit price was increased, not reduced.</li>
      <li class="numberedList">Close the browser, and shut down<a id="_idIndexMarker1403"/> the web server.</li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-468">Practicing and exploring</h1>
    <p class="normal">Test your knowledge and understanding by answering some questions, getting some hands-on practice, and exploring this chapter’s topics with deeper research.</p>
    <h2 class="heading-2" id="_idParaDest-469">Exercise 12.1 – Test your knowledge</h2>
    <p class="normal">Answer the following questions:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">What transport protocol does a GraphQL service use?</li>
      <li class="numberedList">What media type does GraphQL use for its queries?</li>
      <li class="numberedList">How can you parameterize GraphQL queries?</li>
      <li class="numberedList">What are the benefits of using Strawberry Shake over a regular HTTP client for GraphQL queries?</li>
      <li class="numberedList">How might you insert a new product into the Northwind database? </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-470">Exercise 12.2 – Explore topics</h2>
    <p class="normal">Use the links on the following page to learn more details about the topics covered in this chapter:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-12---combining-data-sources-using-graphql">https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-12---combining-data-sources-using-graphql</a></p>
    <h2 class="heading-2" id="_idParaDest-471">Exercise 12.3 – Practice building .NET clients</h2>
    <p class="normal">In <code class="inlineCode">HomeController.cs</code>, add an action method named <code class="inlineCode">Categories</code> , and implement it to query the <code class="inlineCode">categories</code> field with a variable for the <code class="inlineCode">id</code>. On the page, allow the visitor to submit an <code class="inlineCode">id</code>, and note the category information and a list of its products.</p>
    <h1 class="heading-1" id="_idParaDest-472">Summary</h1>
    <p class="normal">In this chapter, you learned about:</p>
    <ul>
      <li class="bulletList">Some of the concepts of GraphQL.</li>
      <li class="bulletList">How to build a <code class="inlineCode">Query</code> class with fields that represent entities that can be queried.</li>
      <li class="bulletList">How to use the Banana Cake Pop tool to explore a GraphQL service schema.</li>
      <li class="bulletList">How to use the REST Client extension to POST to a GraphQL service.</li>
      <li class="bulletList">How to create a .NET client for a GraphQL service.</li>
      <li class="bulletList">How to implement GraphQL mutations.</li>
      <li class="bulletList">How to implement GraphQL subscriptions.</li>
    </ul>
    <p class="normal">In the next chapter, you will learn about the gRPC service technology that can be used to implement efficient microservices.</p>
    <h1 class="heading-1" id="_idParaDest-473">Learn more on Discord</h1>
    <p class="normal">To join the Discord community for this book – where you can share feedback, ask questions to the author, and learn about new releases – follow the QR code below:</p>
    <p class="normal"><a href="https://packt.link/apps_and_services_dotnet8">https://packt.link/apps_and_services_dotnet8</a></p>
    <p class="normal"><img alt="" src="img/QR_Code3048220001028652625.png"/></p>
  </div>
</body></html>