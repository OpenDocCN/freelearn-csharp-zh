<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="packt" name="generator"/>
<title>17 Getting Started with Vertical Slice Architecture</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<link href="../styles/stylesheet2.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body>
<section class="level1 pkt" data-number="18" id="getting-started-with-vertical-slice-architecture">
<h1 data-number="18"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">17 Getting Started with Vertical Slice Architecture</span></h1>
<section class="level2" data-number="18.1" id="before-you-begin-join-our-book-community-on-discord-16">
<h2 data-number="18.1"><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Before you begin: Join our book community on Discord</span></h2>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">Give your feedback straight to the author himself and chat to other early readers on our Discord server (find the "architecting-aspnet-core-apps-3e" channel under EARLY ACCESS SUBSCRIPTION).</span></p>
<p><a href="https://packt.link/EarlyAccess"><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">https://packt.link/EarlyAccess</span></a></p>
<p><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Qr code Description automatically generated" src="../media/file111.png" style="width:10em"/></span></p>
<p><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">This chapter introduces Vertical Slice Architecture, an effective way to organize our ASP.NET Core applications. </span><span class="koboSpan" id="kobo.6.2" xmlns="http://www.w3.org/1999/xhtml">Vertical Slice Architecture moves elements from multiple layers to a feature-oriented design, helping us maintain a clean, simple, cohesive, loosely-coupled, and manageable codebase.Vertical Slice Architecture flips our architectural perspective toward simplified architecture. </span><span class="koboSpan" id="kobo.6.3" xmlns="http://www.w3.org/1999/xhtml">Historically, we divided the logic of a feature across various layers like UI, business logic, and data access. </span><span class="koboSpan" id="kobo.6.4" xmlns="http://www.w3.org/1999/xhtml">However, we create independent slices of functionality with Vertical Slice Architecture instead. </span><span class="koboSpan" id="kobo.6.5" xmlns="http://www.w3.org/1999/xhtml">Think of your application as a cake; instead of cutting it horizontally (layers), we're cutting vertically (features), with each slice being fully functional on its own.This style changes how we design and organize our project, testing strategies, and coding approach. </span><span class="koboSpan" id="kobo.6.6" xmlns="http://www.w3.org/1999/xhtml">We don't have to worry about bloated controllers or overly complicated "God objects"; instead, making changes becomes more manageable because of the loose coupling between features.This chapter guides you through applying Vertical Slice Architecture to your ASP.NET Core applications, detailing how to handle commands, queries, validation, and entity mapping using CQS, MVC, MediatR, AutoMapper, and FluentValidation, which we explored in the previous chapters.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">We don’t have to use those tools to apply the architectural style and can replace those libraries with others or even code the whole stack ourselves.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml">By the end of this chapter, you will understand Vertical Slice Architecture and its benefits, and should have the confidence to apply this style to your next project. </span><span class="koboSpan" id="kobo.8.2" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we cover the following topics:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">Anti-pattern – Big Ball of Mud</span></li>
<li><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml">Vertical Slice Architecture</span></li>
<li><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml">Continuing your journey: A few tips and tricks</span></li>
</ul>
<p><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">Let's journey through the vertical slices and piece the architecture together, one slice at a time.</span></p>
</section>
<section class="level2" data-number="18.2" id="anti-pattern-big-ball-of-mud">
<h2 data-number="18.2"><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">Anti-pattern – Big Ball of Mud</span></h2>
<p><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start with an anti-pattern. </span><span class="koboSpan" id="kobo.14.2" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">Big Ball of Mud</span></strong><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml"> anti-pattern describes a system that ended badly or was never properly designed. </span><span class="koboSpan" id="kobo.16.2" xmlns="http://www.w3.org/1999/xhtml">Sometimes a system starts great but evolves into a Big Ball of Mud due to pressure, volatile requirements, impossible deadlines, bad practices, or other reasons. </span><span class="koboSpan" id="kobo.16.3" xmlns="http://www.w3.org/1999/xhtml">We often refer to the Big Ball of Mud as </span><strong><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">spaghetti code</span></strong><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">, which means the same thing.This anti-pattern means a very hard-to-maintain codebase, poorly written code that is difficult to read, lots of unwanted tight coupling, low cohesion, or worse: all that in the same codebase.Applying the techniques covered in this book should help you avoid this anti-pattern. </span><span class="koboSpan" id="kobo.18.2" xmlns="http://www.w3.org/1999/xhtml">Aim at small, well-designed components that are testable. </span><span class="koboSpan" id="kobo.18.3" xmlns="http://www.w3.org/1999/xhtml">Enforce that using automated testing. </span><span class="koboSpan" id="kobo.18.4" xmlns="http://www.w3.org/1999/xhtml">Refactor and improve your codebase whenever you can, iteratively (continuous improvement). </span><span class="koboSpan" id="kobo.18.5" xmlns="http://www.w3.org/1999/xhtml">Apply the SOLID principles. </span><span class="koboSpan" id="kobo.18.6" xmlns="http://www.w3.org/1999/xhtml">Define your application pattern before starting. </span><span class="koboSpan" id="kobo.18.7" xmlns="http://www.w3.org/1999/xhtml">Think of the best way to implement each component and feature; do research, and make one or more proof of concept or experiments if unsure of the best approach. </span><span class="koboSpan" id="kobo.18.8" xmlns="http://www.w3.org/1999/xhtml">Ensure you understand the business requirements of the program you are building (this is probably the best advice). </span><span class="koboSpan" id="kobo.18.9" xmlns="http://www.w3.org/1999/xhtml">Those tips should help you avoid creating a Big Ball of Mud.Building feature-oriented applications is one of the best ways to avoid creating a Big Ball of Mud. </span><span class="koboSpan" id="kobo.18.10" xmlns="http://www.w3.org/1999/xhtml">Let’s get started!</span></p>
</section>
<section class="level2" data-number="18.3" id="vertical-slice-architecture">
<h2 data-number="18.3"><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml">Vertical Slice Architecture</span></h2>
<p><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">Instead of separating an application horizontally (layers), a vertical slice groups all horizontal concerns together to encapsulate a feature. </span><span class="koboSpan" id="kobo.20.2" xmlns="http://www.w3.org/1999/xhtml">Here is a diagram that illustrates that:</span></p>
<figure>
<span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 17.1: Diagram representing a vertical slice crossing all layers" src="../media/file112.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">Figure 17.1: Diagram representing a vertical slice crossing all layers</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">Jimmy Bogard, who is a pioneer of this type of architecture, wrote the following:</span></p>
<blockquote>
<em><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">[The goal is to] minimize coupling between slices and maximize coupling within a slice.</span></em>
</blockquote>
<p><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">What does that mean? </span><span class="koboSpan" id="kobo.25.2" xmlns="http://www.w3.org/1999/xhtml">Let’s split that sentence into two distinct points:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">“minimize coupling between slices” (improved maintainability, loose coupling)</span></li>
<li><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml">“maximize coupling within a slice” (cohesion)</span></li>
</ul>
<p><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">We could see the former as one vertical slice should not depend on another, so when you modify a vertical slice, you don’t have to worry about the impact on the other slices because the coupling is minimal.We could see the latter as: instead of spreading code around multiple layers, with potentially superfluous abstractions along the way, let’s regroup and simplify that code. </span><span class="koboSpan" id="kobo.28.2" xmlns="http://www.w3.org/1999/xhtml">That helps keep the tight coupling inside a vertical slice to create a cohesive unit of code that serves a single purpose: handling the feature end to end.Then we could wrap that to create software around the business problem we are trying to solve instead of the developer’s concerns, which your customers have no interest in (such as data access).Now, what is a slice in more generic terms? </span><span class="koboSpan" id="kobo.28.3" xmlns="http://www.w3.org/1999/xhtml">I see slices as composite hierarchies. </span><span class="koboSpan" id="kobo.28.4" xmlns="http://www.w3.org/1999/xhtml">For example, a shipping manager program has a multistep creation workflow, a list, and a details page. </span><span class="koboSpan" id="kobo.28.5" xmlns="http://www.w3.org/1999/xhtml">Each step of the creation flow would be a slice responsible for handling its respective logic. </span><span class="koboSpan" id="kobo.28.6" xmlns="http://www.w3.org/1999/xhtml">When put together, they compose the “create slice”, which is responsible for creating a shipment (a bigger slice). </span><span class="koboSpan" id="kobo.28.7" xmlns="http://www.w3.org/1999/xhtml">The list and details pages are two other slices. </span><span class="koboSpan" id="kobo.28.8" xmlns="http://www.w3.org/1999/xhtml">Then, all of those slices become another bigger slice, leading to something like this:</span></p>
<figure>
<span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 17.2: A diagram displaying a top-down coupling structure where smaller parts (top) depend on bigger parts (middle) of complex features (bottom) based on their cohesion with one another (vertically)" src="../media/file113.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml">Figure 17.2: A diagram displaying a top-down coupling structure where smaller parts (top) depend on bigger parts (middle) of complex features (bottom) based on their cohesion with one another (vertically)</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml">There is strong coupling inside </span><strong><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml">Step 1</span></strong><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">, with limited coupling between the other steps; they share some creation code as part of the </span><strong><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">Create</span></strong><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml"> slice. </span><strong><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">Create</span></strong><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">, </span><strong><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">List</span></strong><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><strong><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">Details</span></strong><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml"> also share some code, but in a limited way; they are all part of the </span><strong><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml">Shipments</span></strong><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml"> slice and access or manipulate the same entity: one or more shipments. </span><span class="koboSpan" id="kobo.43.2" xmlns="http://www.w3.org/1999/xhtml">Finally, the </span><strong><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml">Shipments</span></strong><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml"> slice shares no code (or very little) with </span><strong><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml">Other features</span></strong><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml">Following the pattern I just described, we have limited coupling and maximum cohesion. </span><span class="koboSpan" id="kobo.48.2" xmlns="http://www.w3.org/1999/xhtml">The downside is that you must continuously design and refactor the application, which requires stronger design skills than a layered approach. </span><span class="koboSpan" id="kobo.48.3" xmlns="http://www.w3.org/1999/xhtml">Moreover, you must know how to build the feature end to end, limiting the division of tasks between people and centralizing them on each team member instead; each member becomes a full-stack developer. </span><span class="koboSpan" id="kobo.48.4" xmlns="http://www.w3.org/1999/xhtml">We revisit this example in the </span><em><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">Continuing your journey</span></em><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml"> section near the end of the chapter.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml">We explore the advantages and disadvantages next.</span></p>
<section class="level3" data-number="18.3.1" id="what-are-the-advantages-and-disadvantages">
<h3 data-number="18.3.1"><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml">What are the advantages and disadvantages?</span></h3>
<p><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml">Let’s explore some advantages and disadvantages of Vertical Slice Architecture.</span></p>
<section class="level4" data-number="18.3.1.1" id="advantages-1">
<h4 data-number="18.3.1.1"><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml">Advantages</span></h4>
<p><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml">On the upside, we have the following:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml">We reduce coupling between features, making working on such a project more manageable. </span><span class="koboSpan" id="kobo.56.2" xmlns="http://www.w3.org/1999/xhtml">We only need to think about a single vertical slice, not </span><em><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml">N</span></em><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml"> layers, improving </span><strong><span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml">maintainability</span></strong><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml"> by centralizing the code around a shared concern.</span></li>
<li><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml">We can choose how each vertical slice interacts with the external resources they require without considering the other slices. </span><span class="koboSpan" id="kobo.61.2" xmlns="http://www.w3.org/1999/xhtml">That adds </span><strong><span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml">flexibility</span></strong><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml"> since one slice can use T-SQL while another uses EF Core, for example.</span></li>
<li><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">We can start small with a few lines of code (described as </span><strong><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml">Transaction Scripts</span></strong><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml"> in </span><em><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">Patterns of Enterprise Application Architecture,</span></em><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml"> by Martin Fowler) without extravagant design or over-engineering. </span><span class="koboSpan" id="kobo.68.2" xmlns="http://www.w3.org/1999/xhtml">Then we can refactor our way to a better design when the need arises and patterns emerge, leading to a </span><strong><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml">faster time to market</span></strong><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml">Each vertical slice should contain precisely the right amount of code needed to be correct—not more, not less. </span><span class="koboSpan" id="kobo.71.2" xmlns="http://www.w3.org/1999/xhtml">That leads to a </span><strong><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">more robust</span></strong><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml"> codebase (less code means less extraneous code and less code to maintain).</span></li>
<li><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">It is easier for newcomers to find their way around an existing system since each feature is near-independent, leading to a </span><strong><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml">faster onboarding time</span></strong><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml">All patterns and techniques you learned in previous chapters still apply.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml">From my experience, features tend to start small and grow over time. </span><span class="koboSpan" id="kobo.78.2" xmlns="http://www.w3.org/1999/xhtml">The users often find out what they need while using the software, changing the requirements over time, which leads to changes in the software. </span><span class="koboSpan" id="kobo.78.3" xmlns="http://www.w3.org/1999/xhtml">After the fact, I wish many projects I worked on were built using Vertical Slice Architecture instead of layering.</span></p>
</blockquote>
</section>
<section class="level4" data-number="18.3.1.2" id="disadvantages-1">
<h4 data-number="18.3.1.2"><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml">Disadvantages</span></h4>
<p><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">Of course, nothing is perfect, so here are some downsides:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml">It may take time to wrap your head around Vertical Slice Architecture if you’re used to layering, leading to an adaptation period to learn a new way to think about your software.</span></li>
<li><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml">It is a “newer” type of architecture, and people don’t like change.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">Another thing that I learned the hard way is to embrace change. </span><span class="koboSpan" id="kobo.83.2" xmlns="http://www.w3.org/1999/xhtml">I don’t think I’ve seen one project end as it was supposed to. </span><span class="koboSpan" id="kobo.83.3" xmlns="http://www.w3.org/1999/xhtml">Everyone identifies the missing pieces of the business processes while using the software. </span><span class="koboSpan" id="kobo.83.4" xmlns="http://www.w3.org/1999/xhtml">That leads to the following advice: release the software as fast as possible and have your customers use the software as soon as possible. </span><span class="koboSpan" id="kobo.83.5" xmlns="http://www.w3.org/1999/xhtml">That advice can be easier to achieve with Vertical Slice Architecture because you build value for your customers instead of more or less valuable abstractions and layers. </span><span class="koboSpan" id="kobo.83.6" xmlns="http://www.w3.org/1999/xhtml">Having a customer try staged software is very hard; no customer has time to do such a thing; they are busy running their business. </span><span class="koboSpan" id="kobo.83.7" xmlns="http://www.w3.org/1999/xhtml">However, releasing production-ready slices may lead to faster adoption and feedback.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml">At the beginning of my career, I was frustrated when specifications changed, and I thought that better planning would have fixed that. </span><span class="koboSpan" id="kobo.84.2" xmlns="http://www.w3.org/1999/xhtml">Sometimes better planning would have helped, but sometimes, the customer just did not know how to express their business processes or needs and had to try the application to figure it out. </span><span class="koboSpan" id="kobo.84.3" xmlns="http://www.w3.org/1999/xhtml">My advice here is don’t be frustrated when the specs change, even if that means rewriting a part of the software that took you days or more to code in the first place; that will happen all the time. </span><span class="koboSpan" id="kobo.84.4" xmlns="http://www.w3.org/1999/xhtml">Learn to accept that instead, and find ways to make this process easier and faster. </span><span class="koboSpan" id="kobo.84.5" xmlns="http://www.w3.org/1999/xhtml">If you are in contact with the customers, find ways to help them figure out their needs and reduce the number of changes.</span></p>
</blockquote>
</blockquote>
</section>
<section class="level4" data-number="18.3.1.3" id="downside-or-upsides">
<h4 data-number="18.3.1.3"><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml">Downside or Upsides?</span></h4>
<p><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml">The following points are downsides that we can tame as upsides:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml">Suppose you are used to working in silos (such as the DBAs doing the data stuff). </span><span class="koboSpan" id="kobo.87.2" xmlns="http://www.w3.org/1999/xhtml">In that case, assigning tasks that touch the whole feature may be more challenging, but this can become an advantage since everyone in your team works more closely together, leading to more learning and collaboration and possibly a new cross-functional team—which is excellent. </span><span class="koboSpan" id="kobo.87.3" xmlns="http://www.w3.org/1999/xhtml">Having a data expert on the team is great; no one is an expert in all areas.</span></li>
<li><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml">Refactoring: strong refactoring skills will go a long way. </span><span class="koboSpan" id="kobo.88.2" xmlns="http://www.w3.org/1999/xhtml">Over time, most systems need some refactoring, which is even more true for Vertical Slice Architecture. </span><span class="koboSpan" id="kobo.88.3" xmlns="http://www.w3.org/1999/xhtml">That can be caused by changes in the requirements or due to technical debt. </span><span class="koboSpan" id="kobo.88.4" xmlns="http://www.w3.org/1999/xhtml">No matter the reason, you may end up with a </span><strong><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml">Big Ball of Mud</span></strong><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml"> if you don't. </span><span class="koboSpan" id="kobo.90.2" xmlns="http://www.w3.org/1999/xhtml">First, writing isolated code and then refactoring to patterns is a crucial part of Vertical Slice Architecture. </span><span class="koboSpan" id="kobo.90.3" xmlns="http://www.w3.org/1999/xhtml">That’s one of the best ways to keep cohesion high inside a slice and coupling as low as possible between slices. </span><span class="koboSpan" id="kobo.90.4" xmlns="http://www.w3.org/1999/xhtml">This tip applies to all types of architecture and is made easier with a robust test suite that validates your changes automatically.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml">A way to start refactoring that business logic would be to push the logic into the </span><strong><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml">domain model</span></strong><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml">, creating a </span><strong><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml">rich domain model</span></strong><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.95.2" xmlns="http://www.w3.org/1999/xhtml">You can also use other design patterns and techniques to fine-tune the code and make it more maintainable, such as creating services or layers. </span><span class="koboSpan" id="kobo.95.3" xmlns="http://www.w3.org/1999/xhtml">A layer does not have to cross all vertical slices; it can cross only a subset of them.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml">Compared to other application-level patterns, such as layering, fewer rules lead to more choices (Vertical Slice Architecture). </span><em><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml">You can use all design patterns, principles, and best practices inside a vertical slice without exporting those choices application-wide.</span></em></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">How do you organize a project into Vertical Slice Architecture? </span><span class="koboSpan" id="kobo.98.2" xmlns="http://www.w3.org/1999/xhtml">Unfortunately, there is no definitive answer to that, and it depends on the engineers working on the project. </span><span class="koboSpan" id="kobo.98.3" xmlns="http://www.w3.org/1999/xhtml">We explore one way in the next project, but you can organize your project as you see fit. </span><span class="koboSpan" id="kobo.98.4" xmlns="http://www.w3.org/1999/xhtml">Then we dig deeper into refactoring and organization.</span></p>
</section>
</section>
<section class="level3" data-number="18.3.2" id="project-vertical-slice-architecture">
<h3 data-number="18.3.2"><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml">Project – Vertical Slice Architecture</span></h3>
<p><strong><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></strong><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">: We are getting tired of layering, and we got asked to rebuild our small demo shop using Vertical Slice Architecture.Here is an updated diagram that shows how we conceptually organized the project:</span></p>
<figure>
<span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 17.3: Diagram representing the organization of the demo shop project" src="../media/file114.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml">Figure 17.3: Diagram representing the organization of the demo shop project</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">Each vertical box is a use case (or slice), while each horizontal box is a crosscutting concern or a shared component. </span><span class="koboSpan" id="kobo.104.2" xmlns="http://www.w3.org/1999/xhtml">This is a small project, so we share the data access code (</span><code><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml">) and the </span><code><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml">Product</span></code><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml"> model between the three use cases. </span><span class="koboSpan" id="kobo.108.2" xmlns="http://www.w3.org/1999/xhtml">This sharing is unrelated to Vertical Slice Architecture, but splitting it more in a small project like this is hard and pointless.In this project, I decided to go with web API controllers instead of minimal APIs and an anemic product model instead of a rich one. </span><span class="koboSpan" id="kobo.108.3" xmlns="http://www.w3.org/1999/xhtml">We could have used minimal APIs, a rich model, or any combination. </span><span class="koboSpan" id="kobo.108.4" xmlns="http://www.w3.org/1999/xhtml">I chose this so you have a glimpse of using controllers, as this is something you might very well end up using. </span><span class="koboSpan" id="kobo.108.5" xmlns="http://www.w3.org/1999/xhtml">We go back to minimal APIs in the next chapter.Here are the actors:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml">ProductsController</span></code><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml"> is the REST API to manage products.</span></li>
<li><code><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml">StocksController</span></code><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml"> is the REST API to manage the inventory.</span></li>
<li><code><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml">AddStocks</span></code><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml">RemoveStocks</span></code><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml">ListAllProducts</span></code><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml"> are the same use cases we have copied in our project since </span><em><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 14</span></em><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml">Layering and Clean Architecture</span></em><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">The persistence “layer” consists of an EF Core </span><code><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml"> that persists the </span><code><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">Product</span></code><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml"> model to an in-memory database.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml">We could add other crosscutting concerns on top of our vertical slices, such as authorization, error management, and logging, to name a few.Next, let’s look at how we organized the project.</span></p>
<section class="level4" data-number="18.3.2.1" id="project-organization">
<h4 data-number="18.3.2.1"><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml">Project organization</span></h4>
<p><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml">Here is how we organized the project:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml">Data</span></code><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml"> directory contains EF Core-related classes.</span></li>
<li><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml">Features</span></code><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml"> directory contains the features. </span><span class="koboSpan" id="kobo.136.2" xmlns="http://www.w3.org/1999/xhtml">Each subfolder contains its underlying features (vertical slices), including controllers, exceptions, and other support classes required to implement the feature.</span></li>
<li><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml">Each use case is self-contained and exposes the following classes:</span></li>
</ul>
<ol>
<li><code><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml">Query</span></code><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml"> representing the MediatR request.</span></li>
<li><code><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml">Result</span></code><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml"> is the return value of that request.</span></li>
<li><code><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml">MapperProfile</span></code><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml"> instructs AutoMapper on how to map the use case-related objects (if any).</span></li>
<li><code><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">Validator</span></code><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml"> contains the validation rules to validate the </span><code><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml">Query</span></code><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml"> objects (if any).</span></li>
<li><code><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml"> contains the use case logic: how to handle the request.</span></li>
</ol>
<ul>
<li><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml">Models</span></code><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml"> directory contains the domain model.</span></li>
</ul>
<figure>
<span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 17.4: Solution Explorer view of the file organization" src="../media/file115.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">Figure 17.4: Solution Explorer view of the file organization</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml">In this project, we support request validation using </span><strong><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidation</span></strong><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml">, a third-party NuGet package. </span><span class="koboSpan" id="kobo.161.2" xmlns="http://www.w3.org/1999/xhtml">We can also use </span><code><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">System.ComponentModel.DataAnnotations</span></code><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml"> or any other validation library that we want.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml">With FluentValidation, I find it easy to keep the validation within our vertical slice but outside the class we want to validate. </span><span class="koboSpan" id="kobo.164.2" xmlns="http://www.w3.org/1999/xhtml">The out-of-the-box .NET validation framework, </span><code><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml">DataAnnotations</span></code><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml">, does the opposite, forcing us to include the validation as metadata on the entities themselves. </span><span class="koboSpan" id="kobo.166.2" xmlns="http://www.w3.org/1999/xhtml">Both have pros and cons, but FluentValidation is easier to test and extend.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml">The following code is the </span><code><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml"> file. </span><span class="koboSpan" id="kobo.169.2" xmlns="http://www.w3.org/1999/xhtml">The highlighted lines represent registering FluentValidation and scanning the assembly to find validators:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml">var currentAssembly = typeof(Program).Assembly;
var builder = WebApplication.CreateBuilder(args);
builder.Services
    // Plumbing/Dependencies
    .AddAutoMapper(currentAssembly)
    .AddMediatR(o =&gt; o.RegisterServicesFromAssembly(currentAssembly))
    .AddSingleton(typeof(IPipelineBehavior&lt;,&gt;), typeof(ThrowFluentValidationExceptionBehavior&lt;,&gt;))
    // Data
    .AddDbContext&lt;ProductContext&gt;(options =&gt; options
        .UseInMemoryDatabase("ProductContextMemoryDB")
        .ConfigureWarnings(builder =&gt; builder.Ignore(InMemoryEventId.TransactionIgnoredWarning))
    )
    // Web/MVC
    .AddFluentValidationAutoValidation()
    .AddValidatorsFromAssembly(currentAssembly)
    .AddControllers()
;
var app = builder.Build();
app.MapControllers();
using (var seedScope = app.Services.CreateScope())
{
    var db = seedScope.ServiceProvider.GetRequiredService&lt;ProductContext&gt;();
    await ProductSeeder.SeedAsync(db);
}
app.Run();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code adds the bindings we explored in previous chapters, FluentValidation, and the other pieces required to run the application. </span><span class="koboSpan" id="kobo.171.2" xmlns="http://www.w3.org/1999/xhtml">The highlighted lines register FluentValidation and scan the </span><code><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml">currentAssembly</span></code><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml"> for validator classes. </span><span class="koboSpan" id="kobo.173.2" xmlns="http://www.w3.org/1999/xhtml">The validators themselves are part of each vertical slice. </span><span class="koboSpan" id="kobo.173.3" xmlns="http://www.w3.org/1999/xhtml">Now that we covered the organization of the project, let’s look at features.</span></p>
</section>
<section class="level4" data-number="18.3.2.2" id="exploring-the-removestock-feature">
<h4 data-number="18.3.2.2"><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml">Exploring the RemoveStock feature</span></h4>
<p><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">In this subsection, we explore the </span><code><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml">RemoveStocks</span></code><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml"> feature with the same logic as in previous samples but organized differently (a.k.a. </span><span class="koboSpan" id="kobo.177.2" xmlns="http://www.w3.org/1999/xhtml">the difference between architectural styles). </span><span class="koboSpan" id="kobo.177.3" xmlns="http://www.w3.org/1999/xhtml">Since we use an anemic product model, we moved the add and remove stocks logic from the </span><code><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">Product</span></code><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml"> class to the </span><code><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.181.2" xmlns="http://www.w3.org/1999/xhtml">Let’s look at the code next. </span><span class="koboSpan" id="kobo.181.3" xmlns="http://www.w3.org/1999/xhtml">I describe each nested class along the way.The sample starts with the </span><code><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml">RemoveStocks</span></code><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml"> class that contains the feature’s nested classes. </span><span class="koboSpan" id="kobo.183.2" xmlns="http://www.w3.org/1999/xhtml">That helps organize the feature and saves us some headaches about naming collision.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">We could use namespaces instead, but tools like Visual Studio recommend adding a </span><code><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml">using</span></code><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml"> statement and removing the inline namespace. </span><span class="koboSpan" id="kobo.186.2" xmlns="http://www.w3.org/1999/xhtml">Nowadays, it often automatically adds the using statement, like when pasting code, which is great for many scenarios but inconvenient for this specific one. </span><span class="koboSpan" id="kobo.186.3" xmlns="http://www.w3.org/1999/xhtml">So using nested classes fixes this.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml">Here is the </span><code><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml">RemoveStocks</span></code><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml"> class skeleton:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml">using AutoMapper;
using FluentValidation;
using MediatR;
using VerticalApp.Data;
using VerticalApp.Models;
namespace VerticalApp.Features.Stocks;
public class RemoveStocks
{
    public class Command : IRequest&lt;Result&gt; {/*...*/}
    public class Result {/*...*/}
    public class MapperProfile : Profile {/*...*/}
    public class Validator : AbstractValidator&lt;Command&gt; {/*...*/}
    public class Handler : IRequestHandler&lt;Command, Result&gt; {/*...*/}
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code showcases that the </span><code><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml">RemoveStocks</span></code><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml"> class contains all the required elements it needs for its specific use case:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml"> is the input DTO.</span></li>
<li><code><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml">Result</span></code><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml"> is the output DTO.</span></li>
<li><code><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml">MapperProfile</span></code><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml"> is the AutoMapper profile that maps feature-specific classes to non-feature-specific classes and vice versa.</span></li>
<li><code><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml">Validator</span></code><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml"> validates the input before an instance hits the </span><code><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml"> class (the </span><code><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml"> class).</span></li>
<li><code><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml"> encapsulates the use case logic.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml">Next, we explore those nested classes, starting with the </span><code><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml"> class, which is the </span><strong><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">input of the use case</span></strong><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml"> (the request):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml">public class Command : IRequest&lt;Result&gt;
{
    public int ProductId { get; set; }
    public int Amount { get; set; }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml">The preceding request contains everything it needs to remove stocks from the inventory and fulfill the operation. </span><span class="koboSpan" id="kobo.214.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml">IRequest&lt;TResult&gt;</span></code><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml"> interface tells MediatR that the </span><code><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml"> class is a request and should be routed to its handler. </span><span class="koboSpan" id="kobo.218.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml">Result</span></code><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml"> class is the return value of that handler and represents the </span><strong><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml">output of the use case</span></strong><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml">:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml">public record class Result(int QuantityInStock);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">The mapper profile is optional and allows encapsulating AutoMapper </span><em><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml">maps</span></em><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml"> related to the use case. </span><span class="koboSpan" id="kobo.226.2" xmlns="http://www.w3.org/1999/xhtml">The following </span><code><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml">MapperProfile</span></code><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml"> class registers the mapping from a </span><code><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml">Product</span></code><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml"> instance to a </span><code><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">Result</span></code><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml"> instance:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml">public class MapperProfile : Profile
{
    public MapperProfile()
    {
        CreateMap&lt;Product, Result&gt;();
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml">validator</span></code><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml"> class is also optional and allows validating the input (</span><code><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml">) before it hits the handler; in this case, it ensures the </span><code><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml">Amount</span></code><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml"> value is greater than zero:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml">public class Validator : AbstractValidator&lt;Command&gt;
{
    public Validator()
    {
        RuleFor(x =&gt; x.Amount).GreaterThan(0);
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml">Finally, the most important piece is the </span><code><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml"> class, which implements the use case logic:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml">public class Handler : IRequestHandler&lt;Command, Result&gt;
{
    private readonly ProductContext _db;
    private readonly IMapper _mapper;
    public Handler(ProductContext db, IMapper mapper)
    {
        _db = db ?? </span><span class="koboSpan" id="kobo.245.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(db));
        _mapper = mapper ?? </span><span class="koboSpan" id="kobo.245.3" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(mapper));
    }
    public async Task&lt;Result&gt; Handle(Command request, CancellationToken cancellationToken)
    {
        var product = await _db.Products.FindAsync(new object[] { request.ProductId }, cancellationToken);
        if (product == null)
        {
            throw new ProductNotFoundException(request.ProductId);
        }
        if (request.Amount &gt; product.QuantityInStock)
        {
            throw new NotEnoughStockException(product.QuantityInStock, request.Amount);
        }
        product.QuantityInStock -= request.Amount;
        await _db.SaveChangesAsync(cancellationToken);
        return _mapper.Map&lt;Result&gt;(product);
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml"> class implements the </span><code><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml">IRequestHandler&lt;Command, Result&gt;</span></code><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml"> interface, which links the </span><code><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">, the </span><code><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">, and the </span><code><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">Result</span></code><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml"> classes. </span><span class="koboSpan" id="kobo.256.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml">Handle</span></code><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml"> method implements the same logic as the previous implementations from </span><em><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 14</span></em><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml">Layering</span></em> <em><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">and Clean Architecture</span></em><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml">, onward.Now that we have a fully functional use case, let’s look at the skeleton of the </span><code><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">StocksController</span></code><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml"> class that translates the HTTP requests to the MediatR pipeline so our use case gets executed:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml">using MediatR;
using Microsoft.AspNetCore.Mvc;
namespace VerticalApp.Features.Stocks;
[ApiController]
[Route("products/{productId}/")]
public class StocksController : ControllerBase
{
    private readonly IMediator _mediator;
    public StocksController(IMediator mediator)
    {
        _mediator = mediator ?? </span><span class="koboSpan" id="kobo.266.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(mediator));
    }
    [HttpPost("add-stocks")]
    public async Task&lt;ActionResult&lt;AddStocks.Result&gt;&gt; AddAsync(
        int productId,
        [FromBody] AddStocks.Command command
    ) {/*...*/}
    [HttpPost("remove-stocks")]
    public async Task&lt;ActionResult&lt;RemoveStocks.Result&gt;&gt; RemoveAsync(
        int productId,
        [FromBody] RemoveStocks.Command command
    ) {/*...*/}
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml">In the controller, we inject an </span><code><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml"> into the constructor. </span><span class="koboSpan" id="kobo.269.2" xmlns="http://www.w3.org/1999/xhtml">We used constructor injection because all actions of this controller use the </span><code><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.271.2" xmlns="http://www.w3.org/1999/xhtml">We have two actions, add and remove stocks.The following code represents the remove stocks action method:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml">[HttpPost("remove-stocks")]
public async Task&lt;ActionResult&lt;RemoveStocks.Result&gt;&gt; RemoveAsync(
    int productId,
    [FromBody] RemoveStocks.Command command
)
{
    try
    {
        command.ProductId = productId;
        var result = await _mediator.Send(command);
        return Ok(result);
    }
    catch (NotEnoughStockException ex)
    {
        return Conflict(new
        {
            ex.Message,
            ex.AmountToRemove,
            ex.QuantityInStock
        });
    }
    catch (ProductNotFoundException ex)
    {
        return NotFound(new
        {
            ex.Message,
            productId,
        });
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we read the content of the </span><code><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml">RemoveStocks.Command</span></code><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml"> instance from the body, the action sets the </span><code><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml">ProductId</span></code><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml"> property from the route value, and it sends the </span><code><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml">command</span></code><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml"> object into the MediatR pipeline. </span><span class="koboSpan" id="kobo.279.2" xmlns="http://www.w3.org/1999/xhtml">From there, MediatR routes the request to its handler before returning the result of that operation with an HTTP </span><code><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml">200 OK</span></code><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml"> status code. </span><span class="koboSpan" id="kobo.281.2" xmlns="http://www.w3.org/1999/xhtml">One of the differences between the preceding code and previous implementations is that we moved the DTOs to the vertical slice itself. </span><span class="koboSpan" id="kobo.281.3" xmlns="http://www.w3.org/1999/xhtml">Each vertical slice defines the input, the logic, and the output of its feature, as follows:</span></p>
<figure>
<span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 17.5: Diagram representing the three primary pieces of a vertical slice" src="../media/file116.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml">Figure 17.5: Diagram representing the three primary pieces of a vertical slice</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">When we add input validation, we have the following:</span></p>
<figure>
<span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 17.6: Diagram representing the three primary pieces of a vertical slice, with added validation" src="../media/file117.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">Figure 17.6: Diagram representing the three primary pieces of a vertical slice, with added validation</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml">The controller is a tiny layer between HTTP and our domain, guiding the HTTP requests to the MediatR pipeline and the responses back to HTTP. </span><span class="koboSpan" id="kobo.287.2" xmlns="http://www.w3.org/1999/xhtml">That thin piece represents the presentation of the API and allows access to the domain logic; the features. </span><span class="koboSpan" id="kobo.287.3" xmlns="http://www.w3.org/1999/xhtml">When controllers grow, it is often a sign that part of the feature logic is in the wrong place, most likely leading to code that is harder to test because the HTTP and other logic become intertwined.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">We still have the extra line for the </span><code><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml">productId</span></code><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml">try/catch</span></code><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml"> blocks in the controller’s code, but we could eliminate these using custom model binders and exception filters. </span><span class="koboSpan" id="kobo.292.2" xmlns="http://www.w3.org/1999/xhtml">I left additional resources at the end of the chapter, and we dig deeper into this in the next chapter.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml">With that in place, it is now straightforward to add new features to the project. </span><span class="koboSpan" id="kobo.293.2" xmlns="http://www.w3.org/1999/xhtml">Visually, we end up with the following vertical slices (bold), possible vertical expansions (normal), and shared classes (italics):</span></p>
<figure>
<span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 17.7: Diagram representing the project and possible extensions related to product management" src="../media/file118.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">Figure 17.7: Diagram representing the project and possible extensions related to product management</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">The diagram shows the grouping of the two main areas, products, and stocks. </span><span class="koboSpan" id="kobo.296.2" xmlns="http://www.w3.org/1999/xhtml">On the products side, I included an expansion that depicts a CRUD-like feature group.In our tiny application, it is tough to divide the data access part into more than one </span><code><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml">, so </span><code><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml">ProductContext</span></code><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml"> is used by all slices, creating a shared data access layer.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">In other cases, create multiple </span><code><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml"> when possible. </span><span class="koboSpan" id="kobo.303.2" xmlns="http://www.w3.org/1999/xhtml">This has nothing to do with Vertical Slice Archvaliitecture but is a good practice to divide your domain into smaller bounded contexts.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml">Think about grouping features when they are cohesive and fit under the same part of the domain.Next, let’s test our application.</span></p>
</section>
<section class="level4" data-number="18.3.2.3" id="testing">
<h4 data-number="18.3.2.3"><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml">Testing</span></h4>
<p><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">For this project, I wrote one integration test per use case outcome, which lowers the number of unit tests required while increasing the level of confidence in the system at the same time. </span><span class="koboSpan" id="kobo.306.2" xmlns="http://www.w3.org/1999/xhtml">Why? </span><span class="koboSpan" id="kobo.306.3" xmlns="http://www.w3.org/1999/xhtml">Because we are testing the features themselves instead of many abstracted parts independently. </span><span class="koboSpan" id="kobo.306.4" xmlns="http://www.w3.org/1999/xhtml">This is grey-box testing.We can also add as many unit tests as we need. </span><span class="koboSpan" id="kobo.306.5" xmlns="http://www.w3.org/1999/xhtml">This approach helps us write fewer but better feature-oriented tests, diminishing the need for mock-heavy unit tests. </span><span class="koboSpan" id="kobo.306.6" xmlns="http://www.w3.org/1999/xhtml">Unit tests are practical for validating complex use cases and algorithms faster than integration tests.Let’s look at the </span><code><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml">StocksTest</span></code><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml"> class skeleton first:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml">namespace VerticalApp.Features.Stocks;
public class StocksTest
{
    private static async Task SeederDelegate(ProductContext db)
    {
        db.Products.RemoveRange(db.Products.ToArray());
        await db.Products.AddAsync(new Product(
            id: 4,
            name: "Ghost Pepper",
            quantityInStock: 10
        ));
        await db.Products.AddAsync(new Product(
            id: 5,
            name: "Carolina Reaper",
            quantityInStock: 10
        ));
        await db.SaveChangesAsync();
    }
    public class AddStocksTest : StocksTest
    {
         // omitted test methods
    }
    public class RemoveStocksTest : StocksTest
    {
         // omitted test methods
    }
    public class StocksControllerTest : StocksTest
    {
         // omitted test methods
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml">SeedAsync</span></code><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml"> method removes all products and inserts two new ones in the in-memory test database so the test methods can run using a predictable data set. </span><span class="koboSpan" id="kobo.312.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml">AddStocksTest</span></code><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml">RemoveStocksTest</span></code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml"> classes contain the test methods for their respective use case. </span><code><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml">StocksControllerTest</span></code><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml"> tests the MVC part. </span><span class="koboSpan" id="kobo.318.2" xmlns="http://www.w3.org/1999/xhtml">Let’s explore the happy path of the </span><code><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml">AddStocksTest</span></code><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public async Task Should_increment_QuantityInStock_by_the_specified_amount()
{
    // Arrange
    await using var application = new VerticalAppApplication();
    await application.SeedAsync(SeederDelegate);
    using var requestScope = application.Services.CreateScope();
    var mediator = requestScope.ServiceProvider
        .GetRequiredService&lt;IMediator&gt;();
    // Act
    var result = await mediator.Send(new AddStocks.Command
    {
        ProductId = 4,
        Amount = 10
    });
    // Assert
    using var assertScope = application.Services.CreateScope();
    var db = assertScope.ServiceProvider
        .GetRequiredService&lt;ProductContext&gt;();
    var peppers = await db.Products.FindAsync(4);
    Assert.NotNull(peppers);
    Assert.Equal(20, peppers!.QuantityInStock);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml">In the </span><em><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml">Arrange</span></em><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml"> section of the preceding test case, we create an instance of the application, create a scope to simulate an HTTP request, access the EF Core </span><code><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml">, and then get an </span><code><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml"> instance to act on.In the </span><em><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml">Act</span></em><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml"> block, we send a valid </span><code><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml">AddStocks.Command</span></code><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml"> through the MediatR pipeline.We create a new scope in the </span><em><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml">Assert</span></em><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml"> block then and get a </span><code><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml">ProductContext</span></code><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml"> out of the container. </span><span class="koboSpan" id="kobo.336.2" xmlns="http://www.w3.org/1999/xhtml">With that </span><code><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">, we find the product, ensure it’s not null, and validate that the quantity in stock is what we expect. </span><span class="koboSpan" id="kobo.338.2" xmlns="http://www.w3.org/1999/xhtml">Using a new </span><code><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml">ProductContext</span></code><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml"> ensures we are not dealing with any cached items from the previous operations and the transaction has been saved as expected.With that test case, we know that if a valid command is issued to the mediator, that handler gets executed and successfully increments the stock property by the specified amount.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml">VerticalAppApplication</span></code><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml"> class inherits from </span><code><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml">WebApplicationFactory&lt;TEntryPoint&gt;</span></code><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">, creates a new </span><code><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml">DbContextOptionsBuilder&lt;ProductContext&gt;</span></code><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml"> instance that has a configurable database name, implements a </span><code><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">SeedAsync</span></code><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml"> method that allows seeding the database, and allows altering the application services. </span><span class="koboSpan" id="kobo.349.2" xmlns="http://www.w3.org/1999/xhtml">I omitted the code for brevity reasons, but you can consult the complete source code in the GitHub repository (</span><a href="https://adpg.link/mWep"><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/mWep</span></a><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml">).</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">Now, we can test the MVC part to ensure the controller is configured correctly. </span><span class="koboSpan" id="kobo.352.2" xmlns="http://www.w3.org/1999/xhtml">In the </span><code><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">StocksControllerTest</span></code><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml"> class, the </span><code><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml">AddAsync</span></code><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml"> class contains the following test method:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml">public class AddAsync : StocksControllerTest
{
    [Fact]
    public async Task Should_send_a_valid_AddStocks_Command_to_the_mediator()
    {
        // Arrange
        var mediatorMock = new Mock&lt;IMediator&gt;();
        AddStocks.Command? </span><span class="koboSpan" id="kobo.357.2" xmlns="http://www.w3.org/1999/xhtml">addStocksCommand = default;
        mediatorMock
            .Setup(x =&gt; x.Send(It.IsAny&lt;AddStocks.Command&gt;(), It.IsAny&lt;CancellationToken&gt;()))
            .Callback((IRequest&lt;AddStocks.Result&gt; request, CancellationToken cancellationToken) =&gt; addStocksCommand = request as AddStocks.Command)
        ;
        await using var application = new VerticalAppApplication(
            afterConfigureServices: services =&gt; services
                .AddSingleton(mediatorMock.Object)
        );
        var client = application.CreateClient();
        var httpContent = JsonContent.Create(
            new { amount = 1 },
            options: new JsonSerializerOptions(JsonSerializerDefaults.Web)
        );
        // Act
        var response = await client.PostAsync("/products/5/add-stocks", httpContent);
        // Assert
        Assert.NotNull(response);
        Assert.NotNull(addStocksCommand);
        response.EnsureSuccessStatusCode();
        mediatorMock.Verify(
            x =&gt; x.Send(It.IsAny&lt;AddStocks.Command&gt;(), It.IsAny&lt;CancellationToken&gt;()),
            Times.Once()
        );
        Assert.Equal(5, addStocksCommand!.ProductId);
        Assert.Equal(1, addStocksCommand!.Amount);
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml">The highlighted code of the preceding test case </span><em><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml">Arrange</span></em><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml"> block mocks the </span><code><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml">IMediator</span></code><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml"> and saves what is passed to the </span><code><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml">Send</span></code><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml"> method in the </span><code><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml">addStocksCommand</span></code><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml"> variable. </span><span class="koboSpan" id="kobo.366.2" xmlns="http://www.w3.org/1999/xhtml">We are using that value in the highlighted code of the </span><em><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml">Assert</span></em><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml"> block. </span><span class="koboSpan" id="kobo.368.2" xmlns="http://www.w3.org/1999/xhtml">When creating the </span><code><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml">VerticalAppApplication</span></code><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml"> instance, we register the mock with the container to use it instead of the MediatR one, which bypasses the default behavior. </span><span class="koboSpan" id="kobo.370.2" xmlns="http://www.w3.org/1999/xhtml">We then create an </span><code><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml">HttpClient</span></code><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml"> connected to our in-process application and craft a valid HTTP request to add the stocks we POST in the </span><em><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml">Act</span></em><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml"> section.The </span><em><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">Assert</span></em><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml"> block code ensures the request was successful, verifies the mock method was hit once, and ensures </span><code><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml">AddStocks.Command</span></code><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml"> was configured correctly.From the first test, we know the MediatR piece works. </span><span class="koboSpan" id="kobo.378.2" xmlns="http://www.w3.org/1999/xhtml">With this second test in place, we know the HTTP piece works. </span><span class="koboSpan" id="kobo.378.3" xmlns="http://www.w3.org/1999/xhtml">We are now almost certain that a valid add stocks request will hit the database with those two tests.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml">I say “almost certain” because our tests run against an in-memory database, which is different from a real database engine (for example, it has no relational integrity and the like). </span><span class="koboSpan" id="kobo.379.2" xmlns="http://www.w3.org/1999/xhtml">In case of more complex database operations that affect more than one table or to ensure the correctness of the feature, you can run the tests against a database closer to the production database. </span><span class="koboSpan" id="kobo.379.3" xmlns="http://www.w3.org/1999/xhtml">For example, we can run the tests against a SQL Server container to spawn and tear down the databases in our CI/CD pipeline easily.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml">In the test project, I added more tests covering the remove stocks and listing all products’ features, and ensuring AutoMapper configuration correctness. </span><span class="koboSpan" id="kobo.380.2" xmlns="http://www.w3.org/1999/xhtml">Feel free to browse the code. </span><span class="koboSpan" id="kobo.380.3" xmlns="http://www.w3.org/1999/xhtml">I omitted them here as they become redundant. </span><span class="koboSpan" id="kobo.380.4" xmlns="http://www.w3.org/1999/xhtml">The objective is to explore testing a feature almost end to end with very few tests (two for the happy path in this case), and I think we covered that.</span></p>
</section>
</section>
<section class="level3" data-number="18.3.3" id="conclusion-26">
<h3 data-number="18.3.3"><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">Conclusion</span></h3>
<p><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml">The vertical slice project shows how we can remove abstractions while keeping the objects loosely coupled. </span><span class="koboSpan" id="kobo.382.2" xmlns="http://www.w3.org/1999/xhtml">We also organized the project into features (verticals) instead of layers (horizontals). </span><span class="koboSpan" id="kobo.382.3" xmlns="http://www.w3.org/1999/xhtml">We leveraged CQS, Mediator, and MVC patterns. </span><span class="koboSpan" id="kobo.382.4" xmlns="http://www.w3.org/1999/xhtml">Conceptually, the layers are still there; for example, the controllers are part of the presentation layer, but they are not organized that way, making them part of the feature. </span><span class="koboSpan" id="kobo.382.5" xmlns="http://www.w3.org/1999/xhtml">The sole dependency that crosses all our features is the </span><code><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml">ProductContext</span></code><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml"> class, which makes sense since our model comprises a single class (</span><code><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml">Product</span></code><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.386.2" xmlns="http://www.w3.org/1999/xhtml">We could, for example, add a new feature that leverages minimal APIs instead of a controller, which would be okay because each slice is independent.We can significantly reduce the number of mocks required by testing each vertical slice with integration tests. </span><span class="koboSpan" id="kobo.386.3" xmlns="http://www.w3.org/1999/xhtml">That can also significantly lower the number of unit tests, testing features instead of mocked units of code. </span><span class="koboSpan" id="kobo.386.4" xmlns="http://www.w3.org/1999/xhtml">We should focus on producing features and business value, not the details behind querying the infrastructure or the code itself. </span><span class="koboSpan" id="kobo.386.5" xmlns="http://www.w3.org/1999/xhtml">We should not neglect the technical aspects either; performance and maintainability are also important characteristics, but reducing the number of abstractions can also make the application easier to maintain and for sure easier to understand.Overall, we explored a modern way to design an application that aligns well with Agile and helps generate value for our customers.Before moving to the summary, let’s see how Vertical Slice Architecture can help us follow the </span><strong><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml">SOLID</span></strong><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml"> principles:</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml">S</span></strong><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml">: Each vertical slice (feature) becomes a cohesive unit that changes as a whole, leading to the segregation of responsibilities per feature. </span><span class="koboSpan" id="kobo.390.2" xmlns="http://www.w3.org/1999/xhtml">Based on a CQS-inspired approach, each feature splits the application’s complexity into commands and queries, leading to multiple small pieces. </span><span class="koboSpan" id="kobo.390.3" xmlns="http://www.w3.org/1999/xhtml">Each piece handles a part of the process. </span><span class="koboSpan" id="kobo.390.4" xmlns="http://www.w3.org/1999/xhtml">For example, we can define an input, a validator, a mapper profile, a handler, a result, an HTTP bridge (controller or endpoint), and as many more pieces as we need to craft the slice.</span></li>
<li><strong><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml">O</span></strong><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml">: We can enhance the system globally by extending the ASP.NET Core, MVC, or MediatR pipelines. </span><span class="koboSpan" id="kobo.392.2" xmlns="http://www.w3.org/1999/xhtml">We can design the features as we see fit, including respecting the OCP.</span></li>
<li><strong><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml">L</span></strong><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml">: N/A</span></li>
<li><strong><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">I</span></strong><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml">: By organizing features by units of domain-centric use cases, we create many client-specific components instead of general-purpose elements, like layers.</span></li>
<li><strong><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml">D</span></strong><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml">: The slice pieces depend on interfaces and are tied together using dependency injection. </span><span class="koboSpan" id="kobo.398.2" xmlns="http://www.w3.org/1999/xhtml">Furthermore, by cutting the less useful abstractions out of the system, we simplify it, making it more maintainable and concise. </span><span class="koboSpan" id="kobo.398.3" xmlns="http://www.w3.org/1999/xhtml">Having that many pieces of a feature living close to each other makes the system easier to maintain and improves its discoverability.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml">Next, we look at a few tricks and processes to get started with a bigger application. </span><span class="koboSpan" id="kobo.399.2" xmlns="http://www.w3.org/1999/xhtml">These are ways that I found work for me and will hopefully work for you too. </span><span class="koboSpan" id="kobo.399.3" xmlns="http://www.w3.org/1999/xhtml">Take what works for you and leave the rest; we are all different and work differently.</span></p>
</section>
</section>
<section class="level2" data-number="18.4" id="continuing-your-journey-a-few-tips-and-tricks">
<h2 data-number="18.4"><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml">Continuing your journey: A few tips and tricks</span></h2>
<p><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml">The previous project was tiny. </span><span class="koboSpan" id="kobo.401.2" xmlns="http://www.w3.org/1999/xhtml">It had a shared model that served as the data layer because it was composed of a single class. </span><span class="koboSpan" id="kobo.401.3" xmlns="http://www.w3.org/1999/xhtml">When building real-world applications, you have more than one class, so I’ll give you a good starting point to tackle bigger apps. </span><span class="koboSpan" id="kobo.401.4" xmlns="http://www.w3.org/1999/xhtml">The idea is to create slices as small as possible, limit interactions with other slices as much as possible, and refactor that code into better code. </span><span class="koboSpan" id="kobo.401.5" xmlns="http://www.w3.org/1999/xhtml">We cannot remove coupling, so we need to organize it instead, and the key is to centralize that coupling inside a feature.Here is a workflow inspired by TDD, yet less rigid:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml">Write the contracts that cover your feature (input and output).</span></li>
<li><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml">Write one or more integration tests covering your feature, using those contracts; the </span><code><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml">Query</span></code><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml"> class (</span><code><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">IRequest</span></code><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml">) as input and the </span><code><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml">Result</span></code><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml"> class as output.</span></li>
<li><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml">Implement your </span><code><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml">Validator</span></code><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml">MapperProfile</span></code><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">, and any other bit that needs to be coded. </span><span class="koboSpan" id="kobo.418.2" xmlns="http://www.w3.org/1999/xhtml">At this point, the code could be a giant </span><code><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml">; it does not matter.</span></li>
<li><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml">Once your integration tests pass, refactor that code by breaking down your giant </span><code><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">Handle</span></code><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml"> method as needed.</span></li>
<li><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml">Make sure your tests still pass.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml">During </span><em><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml">step 2</span></em><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml">, you may also test the validation rules with unit tests. </span><span class="koboSpan" id="kobo.427.2" xmlns="http://www.w3.org/1999/xhtml">It is way easier and faster to test multiple combinations and scenarios from unit tests, and you don’t need to access a database for that. </span><span class="koboSpan" id="kobo.427.3" xmlns="http://www.w3.org/1999/xhtml">The same also applies to any other parts of your system that are not tied to an external resource.During </span><em><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml">step 4</span></em><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml">, you may find duplicated logic between features. </span><span class="koboSpan" id="kobo.429.2" xmlns="http://www.w3.org/1999/xhtml">If that’s the case, it is time to encapsulate that logic elsewhere, in a shared place. </span><span class="koboSpan" id="kobo.429.3" xmlns="http://www.w3.org/1999/xhtml">That could be creating a method in the model, a service class, or any other pattern and technique you know might solve your duplication of logic problem. </span><span class="koboSpan" id="kobo.429.4" xmlns="http://www.w3.org/1999/xhtml">Working from isolated features and extracting shared logic will help you design the application. </span><span class="koboSpan" id="kobo.429.5" xmlns="http://www.w3.org/1999/xhtml">You want to push that shared logic outside of a handler, not the other way around (well, once you have that shared logic, you can use it as needed). </span><span class="koboSpan" id="kobo.429.6" xmlns="http://www.w3.org/1999/xhtml">Here, I want to emphasize </span><em><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml">shared logic</span></em><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">, which means a business rule. </span><span class="koboSpan" id="kobo.431.2" xmlns="http://www.w3.org/1999/xhtml">When a business rule changes, all consumers of that business rule must also change their behavior. </span><span class="koboSpan" id="kobo.431.3" xmlns="http://www.w3.org/1999/xhtml">Avoid sharing </span><em><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml">similar code</span></em><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml"> but do share business rules. </span><span class="koboSpan" id="kobo.433.2" xmlns="http://www.w3.org/1999/xhtml">Remember the DRY principle.What is very important when designing software is to focus on the functional needs, not the technical ones. </span><span class="koboSpan" id="kobo.433.3" xmlns="http://www.w3.org/1999/xhtml">Your customers and users don’t care about the technical stuff; they want results, new features, bug fixes, and improvements. </span><span class="koboSpan" id="kobo.433.4" xmlns="http://www.w3.org/1999/xhtml">Simultaneously, beware of the technical debt, so don’t skip the refactoring step, or your project may get in trouble. </span><span class="koboSpan" id="kobo.433.5" xmlns="http://www.w3.org/1999/xhtml">This advice applies to all types of architecture.Another advice is to keep all the code that makes a vertical slice as close as possible. </span><span class="koboSpan" id="kobo.433.6" xmlns="http://www.w3.org/1999/xhtml">You don’t have to keep all use case classes in a single file, but I find this helps. </span><span class="koboSpan" id="kobo.433.7" xmlns="http://www.w3.org/1999/xhtml">Partial classes are a way to split classes into multiple files. </span><span class="koboSpan" id="kobo.433.8" xmlns="http://www.w3.org/1999/xhtml">If named correctly, Visual Studio will nest them under the primary file. </span><span class="koboSpan" id="kobo.433.9" xmlns="http://www.w3.org/1999/xhtml">For example, Visual Studio will nest the </span><code><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml">MyFeature.Hander.cs</span></code><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml"> file under the </span><code><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml">MyFeature.cs</span></code><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml"> file, and so on.You can also create a folder hierarchy where the deeper levels share the previous levels. </span><span class="koboSpan" id="kobo.437.2" xmlns="http://www.w3.org/1999/xhtml">For example, the creation process of a workflow I implemented in an MVC application related to shipments had multiple steps. </span><span class="koboSpan" id="kobo.437.3" xmlns="http://www.w3.org/1999/xhtml">So I ended up with a hierarchy that looked like the following:</span></p>
<figure>
<span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 17.12: The organizational hierarchy of directories and elements" src="../media/file119.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml">Figure 17.12: The organizational hierarchy of directories and elements</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml">Initially, I coded all the handlers individually. </span><span class="koboSpan" id="kobo.440.2" xmlns="http://www.w3.org/1999/xhtml">Then I saw patterns emerge, so I encapsulated that shared logic into shared classes. </span><span class="koboSpan" id="kobo.440.3" xmlns="http://www.w3.org/1999/xhtml">Then I reused some upper-level exceptions, so I moved those up from the </span><code><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml">Features/Shipments/Create</span></code><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml"> folder to the </span><code><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml">Features/Shipments</span></code><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml"> folder. </span><span class="koboSpan" id="kobo.444.2" xmlns="http://www.w3.org/1999/xhtml">I also extracted a service class to manage shared logic between multiple use cases. </span><span class="koboSpan" id="kobo.444.3" xmlns="http://www.w3.org/1999/xhtml">Ultimately, I have only the code I need, no duplicated logic, and the collaborators (classes, interfaces) are as close as possible. </span><span class="koboSpan" id="kobo.444.4" xmlns="http://www.w3.org/1999/xhtml">The coupling between features was minimal, while parts of the system work in synergy (cohesion). </span><span class="koboSpan" id="kobo.444.5" xmlns="http://www.w3.org/1999/xhtml">Moreover, there is very little to no coupling with other parts of the system. </span><span class="koboSpan" id="kobo.444.6" xmlns="http://www.w3.org/1999/xhtml">If we compare that result to another type of architecture, such as layering, I would most likely have needed more abstractions, such as repositories, services, and whatnot; the result with Vertical Slice Architecture was cleaner and simpler.The key point here is to code your handlers independently, organize them the best you can, keep an eye open for shared logic and emerging patterns, extract and encapsulate that logic, and try to limit interactions between use cases and slices.</span></p>
</section>
<section class="level2" data-number="18.5" id="summary-16">
<h2 data-number="18.5"><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml">This chapter overviewed Vertical Slice Architecture, which flips layers by 90°. </span><span class="koboSpan" id="kobo.446.2" xmlns="http://www.w3.org/1999/xhtml">Vertical Slice Architecture is about writing minimal code to generate maximum value by getting superfluous abstractions and rules out of the equation by relying on the developers’ skills and judgment instead.Refactoring is critical in a Vertical Slice Architecture project; success or failure will most likely depend on it. </span><span class="koboSpan" id="kobo.446.3" xmlns="http://www.w3.org/1999/xhtml">We can also use any patterns with Vertical Slice Architecture. </span><span class="koboSpan" id="kobo.446.4" xmlns="http://www.w3.org/1999/xhtml">It has lots of advantages over layering with only a few disadvantages. </span><span class="koboSpan" id="kobo.446.5" xmlns="http://www.w3.org/1999/xhtml">Teams who work in silos (horizontal teams) may need to rethink switching to Vertical Slice Architecture and first create or aim at creating multi-functional teams instead (vertical teams).We replaced the low-value abstraction with commands and queries (CQS-inspired). </span><span class="koboSpan" id="kobo.446.6" xmlns="http://www.w3.org/1999/xhtml">Those are then routed to their respective </span><code><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml"> using the Mediator pattern (helped by MediatR). </span><span class="koboSpan" id="kobo.448.2" xmlns="http://www.w3.org/1999/xhtml">That allows encapsulating the business logic and decoupling it from its callers. </span><span class="koboSpan" id="kobo.448.3" xmlns="http://www.w3.org/1999/xhtml">Those commands and queries ensure that each bit of domain logic is centralized in a single location.Of course, if you start with a strong analysis of your problem, you will most likely have a head start, like with any project. </span><span class="koboSpan" id="kobo.448.4" xmlns="http://www.w3.org/1999/xhtml">Nothing stops you from building and using a robust domain model in your slices. </span><span class="koboSpan" id="kobo.448.5" xmlns="http://www.w3.org/1999/xhtml">The more requirements you have, the easier the initial project organization will be. </span><span class="koboSpan" id="kobo.448.6" xmlns="http://www.w3.org/1999/xhtml">To reiterate, all engineering practices that you know still apply.The next chapter simplifies the concept of Vertical Slice Architecture even more by exploring the Request-EndPoint-Response (REPR) pattern using Minimal APIs.</span></p>
</section>
<section class="level2" data-number="18.6" id="questions-16">
<h2 data-number="18.6"><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">Questions</span></h2>
<p><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml">Let’s take a look at a few practice questions:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml">What design patterns can we use in a vertical slice?</span></li>
<li><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml">When using Vertical Slice Architecture, is it true that you must pick a single ORM and stick with it, such as a data layer?</span></li>
<li><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml">What will likely happen if you don’t refactor your code and pay the technical debt in the long run?</span></li>
<li><span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml">What does cohesion mean?</span></li>
<li><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml">What does tight coupling mean?</span></li>
</ol>
</section>
<section class="level2" data-number="18.7" id="further-reading-14">
<h2 data-number="18.7"><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml">Further reading</span></h2>
<p><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml">Here are a few links to build upon what we learned in the chapter:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml">For UI implementations, you can look at how Jimmy Bogard upgraded ContosoUniversity:</span></li>
</ul>
<ol>
<li><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml">ContosoUniversity on ASP.NET Core with .NET Core: </span><a href="https://adpg.link/UXnr"><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/UXnr</span></a></li>
<li><span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml">ContosoUniversity on ASP.NET Core with .NET Core and Razor Pages: </span><a href="https://adpg.link/6Lbo"><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/6Lbo</span></a></li>
</ol>
<ul>
<li><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidation: </span><a href="https://adpg.link/xXgp"><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/xXgp</span></a></li>
<li><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml">AutoMapper: </span><a href="https://adpg.link/5AUZ"><span class="koboSpan" id="kobo.466.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/5AUZ</span></a></li>
<li><span class="koboSpan" id="kobo.467.1" xmlns="http://www.w3.org/1999/xhtml">MediatR: </span><a href="https://adpg.link/ZQap"><span class="koboSpan" id="kobo.468.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/ZQap</span></a></li>
</ul>
</section>
<section class="level2" data-number="18.8" id="answers-13">
<h2 data-number="18.8"><span class="koboSpan" id="kobo.469.1" xmlns="http://www.w3.org/1999/xhtml">Answers</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.470.1" xmlns="http://www.w3.org/1999/xhtml">Any pattern and technique you know that can help you implement your feature. </span><span class="koboSpan" id="kobo.470.2" xmlns="http://www.w3.org/1999/xhtml">That’s the beauty of Vertical Slice Architecture; you are limited only by yourself.</span></li>
<li><span class="koboSpan" id="kobo.471.1" xmlns="http://www.w3.org/1999/xhtml">No, you can pick the best tool for the job inside each vertical slice; you don’t even need layers.</span></li>
<li><span class="koboSpan" id="kobo.472.1" xmlns="http://www.w3.org/1999/xhtml">The application will most likely become a Big Ball of Mud and be very hard to maintain, which is not good for your stress level, the product quality, time to market of changes, and so on.</span></li>
<li><span class="koboSpan" id="kobo.473.1" xmlns="http://www.w3.org/1999/xhtml">Cohesion means elements that should work together as a united whole.</span></li>
<li><span class="koboSpan" id="kobo.474.1" xmlns="http://www.w3.org/1999/xhtml">Tight coupling describes elements that cannot change independently; that directly depend on one another.</span></li>
</ol>
</section>
</section>
</body>
</html>
