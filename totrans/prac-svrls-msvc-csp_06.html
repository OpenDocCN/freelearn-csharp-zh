<html><head></head><body>
<div id="_idContainer139">
<h1 class="chapterNumber"><a id="_idTextAnchor141"/><span class="koboSpan" id="kobo.1.1">6</span></h1>
<h1 class="chapterTitle" id="_idParaDest-105"><a id="_idTextAnchor142"/><span class="koboSpan" id="kobo.2.1">IoT Functions in Practice</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">The implementation of the Internet of Things certainly is changing the way we interact with the world. </span><span class="koboSpan" id="kobo.3.2">Although we have a lot of solutions delivered, IoT is still challenging to deliver, especially if you want to focus on a scalable solution.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">The idea of this chapter is to present Event Grid, Event Hubs, and IoT Hub triggers that will be good options to start a microservice connected to devices. </span><span class="koboSpan" id="kobo.4.2">Besides that, we will discuss how to enable IoT using Azure.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5.1">This chapter will help you to create an IoT environment using Azure. </span><span class="koboSpan" id="kobo.5.2">Besides that, it will guide you on connecting this environment through Azure IoT Function triggers. </span><span class="koboSpan" id="kobo.5.3">To finish, it will present the car-sharing example case for IoT. </span><span class="koboSpan" id="kobo.5.4">Let’s check how to do it.</span></p>
<h1 class="heading-1" id="_idParaDest-106"><a id="_idTextAnchor143"/><span class="koboSpan" id="kobo.6.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.7.1">This chapter requires Visual Studio 2022 free </span><em class="italic"><span class="koboSpan" id="kobo.8.1">community edition </span></em><span class="koboSpan" id="kobo.9.1">or Visual Studio Code. </span><span class="koboSpan" id="kobo.9.2">You will also need an Azure account to create the sample environment. </span><span class="koboSpan" id="kobo.9.3">You can find the sample code for this chapter at </span><a href="https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp"><span class="url"><span class="koboSpan" id="kobo.10.1">https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp</span></span></a><span class="koboSpan" id="kobo.11.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-107"><a id="_idTextAnchor144"/><span class="koboSpan" id="kobo.12.1">Enabling IoT in Azure</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.13.1">When we think about IoT, one of the greatest worries is the scalability of the solution. </span><span class="koboSpan" id="kobo.13.2">Considering that we are designing a solution to facilitate connection with a great number of devices, the best way to enable IoT in Azure is by using IoT Hub. </span><span class="koboSpan" id="kobo.13.3">IoT Hub creates a great environment for connecting, monitoring, and managing your IoT devices, offering a Platform as a Service (PaaS) solution that will make</span><a id="_idIndexMarker323"/><span class="koboSpan" id="kobo.14.1"> you focus on the application you are working on.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.15.1">There are two tiers of pricing for IoT Hub in Azure and the Free Edition of it. </span><span class="koboSpan" id="kobo.15.2">The Free Edition enables up to 8,000 messages of 0.5KB a day and it has the same features we have in the Standard tier. </span><span class="koboSpan" id="kobo.15.3">If you go for the Basic or Standard tiers, this can be increased to up to 3 billion messages of 4KB a day! </span><span class="koboSpan" id="kobo.15.4">The standard tier also offers device management, cloud-to-device messaging, and IoT Edge. </span><span class="koboSpan" id="kobo.15.5">Besides that, the Standard tier has a layer of security managed by Defender, called Defender for IoT. </span><span class="koboSpan" id="kobo.15.6">This</span><a id="_idIndexMarker324"/><span class="koboSpan" id="kobo.16.1"> information gives us an idea of how scalable the platform is.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.17.1">For our purposes in this book and to help you understand the following examples, we suggest that you create a free tier IoT Hub component. </span><span class="koboSpan" id="kobo.17.2">The next topics will discuss how to get messages from this IoT Hub so you can create a microservice based on it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.18.1">The process of doing so is quite simple. </span><span class="koboSpan" id="kobo.18.2">You must go to </span><strong class="keyWord"><span class="koboSpan" id="kobo.19.1">Create Resource</span></strong><span class="koboSpan" id="kobo.20.1"> in Azure and type IoT Hub in Azure Marketplace.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.21.1"><img alt="Figure 6.1: Creating an IoT Hub using Azure Marketplace" src="../Images/B31916_06_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.22.1">Figure 6.1: Creating an IoT Hub using Azure Marketplace</span></p>
<p class="normal"><span class="koboSpan" id="kobo.23.1">For </span><strong class="keyWord"><span class="koboSpan" id="kobo.24.1">Free Tier</span></strong><span class="koboSpan" id="kobo.25.1">, you only</span><a id="_idIndexMarker325"/><span class="koboSpan" id="kobo.26.1"> need to fill in the information related to the </span><strong class="keyWord"><span class="koboSpan" id="kobo.27.1">Basics</span></strong><span class="koboSpan" id="kobo.28.1"> tab, so after this, you can move on to the </span><strong class="keyWord"><span class="koboSpan" id="kobo.29.1">Review + create</span></strong><span class="koboSpan" id="kobo.30.1"> tab.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.31.1"><img alt="Figure 6.2: Azure IoT Hub Free Tier setup" src="../Images/B31916_06_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.32.1">Figure 6.2: Azure IoT Hub Free Tier setup</span></p>
<p class="normal"><span class="koboSpan" id="kobo.33.1">As soon as the resource is </span><a id="_idIndexMarker326"/><span class="koboSpan" id="kobo.34.1">created, you will be able to create devices in the Azure IoT Hub </span><strong class="keyWord"><span class="koboSpan" id="kobo.35.1">Device management</span></strong><span class="koboSpan" id="kobo.36.1"> area.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.37.1"><img alt="Figure 6.3: Azure IoT Hub Device management" src="../Images/B31916_06_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.38.1">Figure 6.3: Azure IoT Hub Device management</span></p>
<p class="normal"><span class="koboSpan" id="kobo.39.1">First, the device will only need </span><strong class="keyWord"><span class="koboSpan" id="kobo.40.1">Device ID</span></strong><span class="koboSpan" id="kobo.41.1"> information, which represents the uniqueness of the device that will be handled.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.42.1"><img alt="Figure 6.4: Creating a device in IoT Hub" src="../Images/B31916_06_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.43.1">Figure 6.4: Creating a device in IoT Hub</span></p>
<p class="normal"><span class="koboSpan" id="kobo.44.1">IoT Hub also provides the possibility to connect devices on the edge, by using IoT Edge devices. </span><span class="koboSpan" id="kobo.44.2">This is not the focus of this book, but </span><a id="_idIndexMarker327"/><span class="koboSpan" id="kobo.45.1">you will find information about it in the </span><em class="italic"><span class="koboSpan" id="kobo.46.1">Further reading</span></em><span class="koboSpan" id="kobo.47.1"> section. </span><span class="koboSpan" id="kobo.47.2">For the book’s purpose, devices created in Azure are good to go.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.48.1">Considering we have the devices created, we need to understand how to simulate them. </span><span class="koboSpan" id="kobo.48.2">The code below shows how we can do it using the .NET </span><code class="inlineCode"><span class="koboSpan" id="kobo.49.1">Microsoft.Azure.Devices.Client</span></code><span class="koboSpan" id="kobo.50.1"> library:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.51.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.52.1">// Simulates a device by creating a DeviceClient and sending a message.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.53.1">// &lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.54.1">// &lt;param name=”connectionString”&gt;The connection string of the //device.&lt;/param&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.55.1">// &lt;param name=”message”&gt;The message to be sent by the device.&lt;/param&gt;</span></span><span class="koboSpan" id="kobo.56.1">
private </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.57.1">static</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.58.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.59.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.60.1">SimulateDeviceAsync</span></span><span class="koboSpan" id="kobo.61.1">(string connectionString, string message)
{
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.62.1">var</span></span><span class="koboSpan" id="kobo.63.1"> deviceClient = </span><span class="hljs-title"><span class="koboSpan" id="kobo.64.1">DeviceClient</span></span><span class="koboSpan" id="kobo.65.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.66.1">CreateFromConnectionString</span></span><span class="koboSpan" id="kobo.67.1">(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.68.1">connectionString, </span><span class="hljs-title"><span class="koboSpan" id="kobo.69.1">TransportType</span></span><span class="koboSpan" id="kobo.70.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.71.1">Mqtt</span></span><span class="koboSpan" id="kobo.72.1">);
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.73.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.74.1">SendMessageAsync</span></span><span class="koboSpan" id="kobo.75.1">(deviceClient, message);
}
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.76.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.77.1">// Sends a message to the IoT hub using the provided DeviceClient.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.78.1">// &lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.79.1">// &lt;param name=”deviceClient”&gt;The DeviceClient used to send the //message.&lt;/param&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.80.1">/// &lt;param name=”message”&gt;The message to be sent.&lt;/param&gt;</span></span><span class="koboSpan" id="kobo.81.1">
private </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.82.1">static</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.83.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.84.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.85.1">SendMessageAsync</span></span><span class="koboSpan" id="kobo.86.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.87.1">DeviceClient</span></span><span class="koboSpan" id="kobo.88.1"> deviceClient, string message)
{
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.89.1">var</span></span><span class="koboSpan" id="kobo.90.1"> messageBytes = </span><span class="hljs-title"><span class="koboSpan" id="kobo.91.1">Encoding</span></span><span class="koboSpan" id="kobo.92.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.93.1">UTF8</span></span><span class="koboSpan" id="kobo.94.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.95.1">GetBytes</span></span><span class="koboSpan" id="kobo.96.1">(message);
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.97.1">var</span></span><span class="koboSpan" id="kobo.98.1"> iotMessage = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.99.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.100.1">Message</span></span><span class="koboSpan" id="kobo.101.1">(messageBytes);
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.102.1">await</span></span><span class="koboSpan" id="kobo.103.1"> deviceClient.</span><span class="hljs-title"><span class="koboSpan" id="kobo.104.1">SendEventAsync</span></span><span class="koboSpan" id="kobo.105.1">(iotMessage);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.106.1">The connectionString argument in the method above is specific to each IoT device. </span><span class="koboSpan" id="kobo.106.2">You can get it using the Azure portal, but it is </span><a id="_idIndexMarker328"/><span class="koboSpan" id="kobo.107.1">great to mention that there is a very useful tool for Azure IoT Hub called </span><strong class="keyWord"><span class="koboSpan" id="kobo.108.1">Azure IoT Explorer</span></strong><span class="koboSpan" id="kobo.109.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.110.1">With Azure IoT Explorer, we</span><a id="_idIndexMarker329"/><span class="koboSpan" id="kobo.111.1"> can manage devices connected to IoT Hub in a graphical tool that facilitates diagnosing and testing. </span><span class="koboSpan" id="kobo.111.2">For instance, to get the </span><strong class="keyWord"><span class="koboSpan" id="kobo.112.1">connection string</span></strong><span class="koboSpan" id="kobo.113.1"> of a specific device, you can check the </span><strong class="keyWord"><span class="koboSpan" id="kobo.114.1">Device identity</span></strong><span class="koboSpan" id="kobo.115.1"> information available.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.116.1"><img alt="Figure 6.5: Getting device connection string" src="../Images/B31916_06_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.117.1">Figure 6.5: Getting device connection string</span></p>
<p class="normal"><span class="koboSpan" id="kobo.118.1">Now that we have understood how to simulate devices, let’s learn how to receive data from these devices using Azure </span><a id="_idIndexMarker330"/><span class="koboSpan" id="kobo.119.1">Functions.</span></p>
<h1 class="heading-1" id="_idParaDest-108"><a id="_idTextAnchor145"/><span class="koboSpan" id="kobo.120.1">Connecting IoT Hub with Azure Functions</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.121.1">By default, IoT Hub offers a built-in service that delivers device-to-cloud messages to a compatible EventHubs </span><a id="_idIndexMarker331"/><span class="koboSpan" id="kobo.122.1">endpoint at messages/events. </span><span class="koboSpan" id="kobo.122.2">This </span><a id="_idIndexMarker332"/><span class="koboSpan" id="kobo.123.1">means that you can easily connect IoT Hub device messages to an Event Hubs trigger function:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.124.1">[</span><span class="hljs-title"><span class="koboSpan" id="kobo.125.1">Function</span></span><span class="koboSpan" id="kobo.126.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.127.1">nameof</span></span><span class="koboSpan" id="kobo.128.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.129.1">IoTFunction</span></span><span class="koboSpan" id="kobo.130.1">))]
public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.131.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.132.1">Run</span></span><span class="koboSpan" id="kobo.133.1">([</span><span class="hljs-title"><span class="koboSpan" id="kobo.134.1">EventHubTrigger</span></span><span class="koboSpan" id="kobo.135.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.136.1">“messages/events”</span></span><span class="koboSpan" id="kobo.137.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.138.1">Connection</span></span><span class="koboSpan" id="kobo.139.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.140.1">“EventHubConnection”</span></span><span class="koboSpan" id="kobo.141.1">)] </span><span class="hljs-title"><span class="koboSpan" id="kobo.142.1">EventData</span></span><span class="koboSpan" id="kobo.143.1">[] events)
{
</span><span class="hljs-title"><span class="koboSpan" id="kobo.144.1">foreach</span></span><span class="koboSpan" id="kobo.145.1"> (</span><span class="hljs-title"><span class="koboSpan" id="kobo.146.1">EventData</span></span><span class="koboSpan" id="kobo.147.1"> @event </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.148.1">in</span></span><span class="koboSpan" id="kobo.149.1"> events)
  {
    _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.150.1">LogInformation</span></span><span class="koboSpan" id="kobo.151.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.152.1">“Event Body: {body}”</span></span><span class="koboSpan" id="kobo.153.1">, @event.</span><span class="hljs-property"><span class="koboSpan" id="kobo.154.1">EventBody</span></span><span class="koboSpan" id="kobo.155.1">);
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.156.1">This option is certainly very useful since you can develop a solution very fast where you connect different devices using IoT Hub and Azure Functions. </span><span class="koboSpan" id="kobo.156.2">So, this can be considered the simplest way to directly integrate message processing.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.157.1">In the code above, we are just defining the default endpoint messages/events and defining the variable that will give us the connection string for the Event Hub. </span><span class="koboSpan" id="kobo.157.2">The EventHubConnection variable can be found in </span><strong class="keyWord"><span class="koboSpan" id="kobo.158.1">Built-in endpoints</span></strong><span class="koboSpan" id="kobo.159.1"> in IoT Hub. </span><span class="koboSpan" id="kobo.159.2">There will be only shared access policies that enable us to receive data from devices (</span><strong class="keyWord"><span class="koboSpan" id="kobo.160.1">ServiceConnect</span></strong><span class="koboSpan" id="kobo.161.1"> permissions). </span><span class="koboSpan" id="kobo.161.2">It is recommended that you share the policy with the least access, considering the purpose of this connection is just reading the information.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.162.1"><img alt="Figure 6.6: Obtaining Event Hubs connection string to receive data from IoT Hub" src="../Images/B31916_06_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.163.1">Figure 6.6: Obtaining Event Hubs connection string to receive data from IoT Hub</span></p>
<p class="normal"><span class="koboSpan" id="kobo.164.1">It is also worth noting that these messages can be retained for a maximum of seven days, according to the tier you have </span><a id="_idIndexMarker333"/><span class="koboSpan" id="kobo.165.1">selected in Azure IoT Hub.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.166.1">Although the built-in option is very </span><a id="_idIndexMarker334"/><span class="koboSpan" id="kobo.167.1">easy and fast to implement, you may want to apply different IoT scenarios where other alternatives can be applied. </span><span class="koboSpan" id="kobo.167.2">There are several ways to trigger data coming from devices using </span><strong class="keyWord"><span class="koboSpan" id="kobo.168.1">Events</span></strong><span class="koboSpan" id="kobo.169.1"> in Azure IoT Hub, as we can see in the following screenshot.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.170.1"><img alt="Figure 6.7: Azure IoT Hub Events alternatives to receive data from devices" src="../Images/B31916_06_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.171.1">Figure 6.7: Azure IoT Hub Events alternatives to receive data from devices</span></p>
<p class="normal"><span class="koboSpan" id="kobo.172.1">Each approach certainly will give</span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.173.1"> you the versatility to implement event driven and scalable solutions. </span><span class="koboSpan" id="kobo.173.2">Besides that, you</span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.174.1"> need to analyze exactly the data you are going to send from devices to the cloud to define the best alternative. </span><span class="koboSpan" id="kobo.174.2">It is worth noting that only IoT Hub triggers aims at direct integration between IoT Hub and Azure Functions. </span><span class="koboSpan" id="kobo.174.3">The other triggers are visible under the </span><strong class="keyWord"><span class="koboSpan" id="kobo.175.1">Events</span></strong><span class="koboSpan" id="kobo.176.1"> blade.</span></p>
<table class="table-container" id="table001-1">
<thead>
<tr>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.177.1">Approach</span></strong></p>
</th>
<th class="table-head">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.178.1">When to use</span></strong></p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.179.1">IoT Hub Trigger</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.180.1">Simplest, direct integration for message processing.</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.181.1">Event Grid Trigger</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.182.1">Best for event-driven systems and scalable architecture.</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.183.1">Service Bus Trigger</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.184.1">When you need intermediate buffering or message priority handling.</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.185.1">Blob Storage Trigger</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.186.1">When you want to store and process telemetry data as files.</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.187.1">HTTP Trigger (Direct)</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.188.1">When you need fine-grained control over function invocation.</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.189.1">Logic Apps</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.190.1">For no-code/low-code integration with IoT Hub and Functions.</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.191.1">Stream Analytics Output</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.192.1">When you need to perform real-time analytics before invoking the function.</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.193.1">Queue Trigger</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.194.1">For lightweight, simple queue-based message processing.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="koboSpan" id="kobo.195.1">We have already </span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.196.1">covered how to implement some of these alternatives in the </span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.197.1">last three chapters, so we will not explore them again.</span></p>
<h1 class="heading-1" id="_idParaDest-109"><a id="_idTextAnchor146"/><span class="koboSpan" id="kobo.198.1">Car-sharing IoT example</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.199.1">The car-sharing example that we are covering in the book enables interaction between car-seeking and car-holding users. </span><span class="koboSpan" id="kobo.199.2">But let’s </span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.200.1">suppose we have the possibility to deliver a special plan for car-holders who apply for a specific IoT device from the platform we are designing. </span><span class="koboSpan" id="kobo.200.2">Another option would be to integrate the car-sharing app in the central car cockpit. </span><span class="koboSpan" id="kobo.200.3">In this scenario, users could track the location, speed, and status of the available vehicles. </span><span class="koboSpan" id="kobo.200.4">It would also be possible to monitor vehicle health parameters such as battery life, tire pressure, and fuel levels.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.201.1">In the alternatives presented before, a new vehicle-tracking microservice could be implemented and its data would probably be shared with the existing </span><strong class="keyWord"><span class="koboSpan" id="kobo.202.1">Routes-Listing </span></strong><span class="koboSpan" id="kobo.203.1">and </span><strong class="keyWord"><span class="koboSpan" id="kobo.204.1">Routes-Planner</span></strong><span class="koboSpan" id="kobo.205.1"> microservices. </span><span class="koboSpan" id="kobo.205.2">For the first one, it would be possible to provide up-to-date information on car availability and estimated arrival times. </span><span class="koboSpan" id="kobo.205.3">For the planner, it would facilitate the decision of the best car to suggest a new hide.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.206.1">But considering the scenario above, which would be a great architectural approach? </span><span class="koboSpan" id="kobo.206.2">In </span><a href="Chapter_7.xhtml#_idTextAnchor151"><em class="italic"><span class="koboSpan" id="kobo.207.1">Chapter 7</span></em></a><span class="koboSpan" id="kobo.208.1">, </span><em class="italic"><span class="koboSpan" id="kobo.209.1">Microservices in Practice</span></em><span class="koboSpan" id="kobo.210.1">, we will present the RabbitMQ message broker, which will be very useful for this scenario, and the complete example of Routes-Planner microservices. </span><span class="koboSpan" id="kobo.210.2">The diagram below shows how the IoT solution and the Vehicle-Tracking microservice will be connected to the main solution.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.211.1">Azure IoT Hub is the component responsible for managing multiple cars (devices) and it will send tracking data received</span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.212.1"> from each car to the Vehicle-Tracking microservice using Azure Event Hubs messages. </span><span class="koboSpan" id="kobo.212.2">This microservice will be responsible for processing vehicle health parameters, as presented above, and this information will be stored in the Cosmos DB database, considering the volume of data received. </span><span class="koboSpan" id="kobo.212.3">To finish, it will publish only the data needed for the RoutesPlanning microservice using a RabbitMQ principal bus.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.213.1"><img alt="Figure 6.8: IoT solution connected to a microservice solution" src="../Images/B31916_06_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.214.1">Figure 6.8: IoT solution connected to a microservice solution</span></p>
<p class="normal"><span class="koboSpan" id="kobo.215.1">The tracking data that is sent from the car could have a structure like the one below. </span><span class="koboSpan" id="kobo.215.2">It is also great to mention that, if you are</span><a id="_idIndexMarker341"/><span class="koboSpan" id="kobo.216.1"> running .NET from a device to the cloud, this structure can be reused if you work in a class library dedicated to defining SharedMessages:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.217.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.218.1">SharedMessages</span></span><span class="koboSpan" id="kobo.219.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.220.1">BasicTypes</span></span><span class="koboSpan" id="kobo.221.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.222.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.223.1">System</span></span><span class="koboSpan" id="kobo.224.1">;
namespace </span><span class="hljs-title"><span class="koboSpan" id="kobo.225.1">SharedMessages</span></span><span class="koboSpan" id="kobo.226.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.227.1">VehicleTracking</span></span><span class="koboSpan" id="kobo.228.1">
{
  public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.229.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.230.1">VehicleTrackingMessage</span></span><span class="koboSpan" id="kobo.231.1"> : </span><span class="hljs-title"><span class="koboSpan" id="kobo.232.1">TimedMessage</span></span><span class="koboSpan" id="kobo.233.1">
  {
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.234.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.235.1">VehicleId</span></span><span class="koboSpan" id="kobo.236.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.237.1">GeoLocalizationMessage</span></span><span class="koboSpan" id="kobo.238.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.239.1">Location</span></span><span class="koboSpan" id="kobo.240.1"> { get; set; }
    public double </span><span class="hljs-title"><span class="koboSpan" id="kobo.241.1">Speed</span></span><span class="koboSpan" id="kobo.242.1"> { get; set; }
    public double </span><span class="hljs-title"><span class="koboSpan" id="kobo.243.1">CarStatus</span></span><span class="koboSpan" id="kobo.244.1"> { get; set; }
    public double </span><span class="hljs-title"><span class="koboSpan" id="kobo.245.1">BatteryLevel</span></span><span class="koboSpan" id="kobo.246.1"> { get; set; }
    public double </span><span class="hljs-title"><span class="koboSpan" id="kobo.247.1">FuelLevel</span></span><span class="koboSpan" id="kobo.248.1"> { get; set; }
    public double </span><span class="hljs-title"><span class="koboSpan" id="kobo.249.1">TirePressure</span></span><span class="koboSpan" id="kobo.250.1"> { get; set; }   
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.251.1">It is worth noting that the Location property is defined by another shared class, called GeoLocalizationMessage:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.252.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.253.1">System</span></span><span class="koboSpan" id="kobo.254.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.255.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.256.1">System</span></span><span class="koboSpan" id="kobo.257.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.258.1">Collections</span></span><span class="koboSpan" id="kobo.259.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.260.1">Generic</span></span><span class="koboSpan" id="kobo.261.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.262.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.263.1">System</span></span><span class="koboSpan" id="kobo.264.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.265.1">Text</span></span><span class="koboSpan" id="kobo.266.1">;
namespace </span><span class="hljs-title"><span class="koboSpan" id="kobo.267.1">SharedMessages</span></span><span class="koboSpan" id="kobo.268.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.269.1">BasicTypes</span></span><span class="koboSpan" id="kobo.270.1">
{
  public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.271.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.272.1">GeoLocalizationMessage</span></span><span class="koboSpan" id="kobo.273.1">
  {
    public double </span><span class="hljs-title"><span class="koboSpan" id="kobo.274.1">Latitude</span></span><span class="koboSpan" id="kobo.275.1"> { get; set; }
    public double </span><span class="hljs-title"><span class="koboSpan" id="kobo.276.1">Longitude</span></span><span class="koboSpan" id="kobo.277.1"> { get; set; }
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.278.1">Considering this </span><a id="_idIndexMarker342"/><span class="koboSpan" id="kobo.279.1">scenario, the following code is an emulation of a car collecting data and sending data using IoT Hub as the front door:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.280.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.281.1">System</span></span><span class="koboSpan" id="kobo.282.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.283.1">Text</span></span><span class="koboSpan" id="kobo.284.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.285.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.286.1">System</span></span><span class="koboSpan" id="kobo.287.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.288.1">Text</span></span><span class="koboSpan" id="kobo.289.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.290.1">Json</span></span><span class="koboSpan" id="kobo.291.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.292.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.293.1">Microsoft</span></span><span class="koboSpan" id="kobo.294.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.295.1">Azure</span></span><span class="koboSpan" id="kobo.296.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.297.1">Devices</span></span><span class="koboSpan" id="kobo.298.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.299.1">Client</span></span><span class="koboSpan" id="kobo.300.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.301.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.302.1">SharedMessages</span></span><span class="koboSpan" id="kobo.303.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.304.1">BasicTypes</span></span><span class="koboSpan" id="kobo.305.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.306.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.307.1">SharedMessages</span></span><span class="koboSpan" id="kobo.308.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.309.1">VehicleTracking</span></span><span class="koboSpan" id="kobo.310.1">;
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.311.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.312.1">// The main class for the Car Simulator program.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.313.1">// &lt;/summary&gt;</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.314.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.315.1">Program</span></span><span class="koboSpan" id="kobo.316.1">
{
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.317.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.318.1">// The connection string for the car device.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.319.1">// &lt;/summary&gt;</span></span><span class="koboSpan" id="kobo.320.1">
  private </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.321.1">static</span></span><span class="koboSpan" id="kobo.322.1"> string carConnectionString = </span><span class="hljs-string"><span class="koboSpan" id="kobo.323.1">“[device connection string]”</span></span><span class="koboSpan" id="kobo.324.1">;
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.325.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.326.1">// The main entry point for the program.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.327.1">// &lt;/summary&gt;</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.328.1">static</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.329.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.330.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.331.1">Main</span></span><span class="koboSpan" id="kobo.332.1">()
  {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.333.1">while</span></span><span class="koboSpan" id="kobo.334.1"> (</span><span class="hljs-literal"><span class="koboSpan" id="kobo.335.1">true</span></span><span class="koboSpan" id="kobo.336.1">)
    {
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.337.1">// Create a new vehicle tracking message with random data</span></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.338.1">VehicleTrackingMessage</span></span><span class="koboSpan" id="kobo.339.1"> vehicleTrackingMessage = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.340.1">new</span></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.341.1">        VehicleTrackingMessage</span></span><span class="koboSpan" id="kobo.342.1">
      {
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.343.1">VehicleId</span></span><span class="koboSpan" id="kobo.344.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.345.1">Guid</span></span><span class="koboSpan" id="kobo.346.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.347.1">NewGuid</span></span><span class="koboSpan" id="kobo.348.1">(),
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.349.1">Location</span></span><span class="koboSpan" id="kobo.350.1"> = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.351.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.352.1">GeoLocalizationMessage</span></span><span class="koboSpan" id="kobo.353.1">
        {
          </span><span class="hljs-title"><span class="koboSpan" id="kobo.354.1">Latitude</span></span><span class="koboSpan" id="kobo.355.1"> = </span><span class="hljs-number"><span class="koboSpan" id="kobo.356.1">47.6426</span></span><span class="koboSpan" id="kobo.357.1">,
          </span><span class="hljs-title"><span class="koboSpan" id="kobo.358.1">Longitude</span></span><span class="koboSpan" id="kobo.359.1"> = -</span><span class="hljs-number"><span class="koboSpan" id="kobo.360.1">122.1301</span></span><span class="koboSpan" id="kobo.361.1">
        },
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.362.1">Speed</span></span><span class="koboSpan" id="kobo.363.1"> = </span><span class="hljs-number"><span class="koboSpan" id="kobo.364.1">60</span></span><span class="koboSpan" id="kobo.365.1"> + </span><span class="hljs-title"><span class="koboSpan" id="kobo.366.1">DateTime</span></span><span class="koboSpan" id="kobo.367.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.368.1">Now</span></span><span class="koboSpan" id="kobo.369.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.370.1">Second</span></span><span class="koboSpan" id="kobo.371.1">,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.372.1">CarStatus</span></span><span class="koboSpan" id="kobo.373.1"> = </span><span class="hljs-number"><span class="koboSpan" id="kobo.374.1">1</span></span><span class="koboSpan" id="kobo.375.1">,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.376.1">BatteryLevel</span></span><span class="koboSpan" id="kobo.377.1"> = </span><span class="hljs-number"><span class="koboSpan" id="kobo.378.1">100</span></span><span class="koboSpan" id="kobo.379.1"> - </span><span class="hljs-title"><span class="koboSpan" id="kobo.380.1">DateTime</span></span><span class="koboSpan" id="kobo.381.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.382.1">Now</span></span><span class="koboSpan" id="kobo.383.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.384.1">Second</span></span><span class="koboSpan" id="kobo.385.1">,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.386.1">FuelLevel</span></span><span class="koboSpan" id="kobo.387.1"> = </span><span class="hljs-number"><span class="koboSpan" id="kobo.388.1">100</span></span><span class="koboSpan" id="kobo.389.1">,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.390.1">TirePressure</span></span><span class="koboSpan" id="kobo.391.1"> = </span><span class="hljs-number"><span class="koboSpan" id="kobo.392.1">32</span></span><span class="koboSpan" id="kobo.393.1">
      };
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.394.1">// Simulate sending the device message</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.395.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.396.1">SimulateDeviceAsync</span></span><span class="koboSpan" id="kobo.397.1">(carConnectionString,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.398.1">vehicleTrackingMessage);
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.399.1">Console</span></span><span class="koboSpan" id="kobo.400.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.401.1">WriteLine</span></span><span class="koboSpan" id="kobo.402.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.403.1">“Vehicle tracking sent!”</span></span><span class="koboSpan" id="kobo.404.1">);
      </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.405.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.406.1">Task</span></span><span class="koboSpan" id="kobo.407.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.408.1">Delay</span></span><span class="koboSpan" id="kobo.409.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.410.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.411.1">Random</span></span><span class="koboSpan" id="kobo.412.1">().</span><span class="hljs-title"><span class="koboSpan" id="kobo.413.1">Next</span></span><span class="koboSpan" id="kobo.414.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.415.1">10000</span></span><span class="koboSpan" id="kobo.416.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.417.1">20000</span></span><span class="koboSpan" id="kobo.418.1">));
    }
  }
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.419.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.420.1">// Simulates sending a device message to the IoT hub.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.421.1">// &lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.422.1">// &lt;param name=”connectionString”&gt;The connection string for the  </span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.423.1">  //device.&lt;/param&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.424.1">// &lt;param name=”message”&gt;The vehicle tracking message to send.&lt;/param&gt;</span></span><span class="koboSpan" id="kobo.425.1">
  private </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.426.1">static</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.427.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.428.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.429.1">SimulateDeviceAsync</span></span><span class="koboSpan" id="kobo.430.1">(string connectionString,
                                        </span><span class="hljs-title"><span class="koboSpan" id="kobo.431.1">VehicleTrackingMessage</span></span><span class="koboSpan" id="kobo.432.1"> message)
  {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.433.1">var</span></span><span class="koboSpan" id="kobo.434.1"> deviceClient = </span><span class="hljs-title"><span class="koboSpan" id="kobo.435.1">DeviceClient</span></span><span class="koboSpan" id="kobo.436.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.437.1">CreateFromConnectionString</span></span><span class="koboSpan" id="kobo.438.1">(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.439.1">connectionString, </span><span class="hljs-title"><span class="koboSpan" id="kobo.440.1">TransportType</span></span><span class="koboSpan" id="kobo.441.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.442.1">Mqtt</span></span><span class="koboSpan" id="kobo.443.1">);
    string jsonMessage = </span><span class="hljs-title"><span class="koboSpan" id="kobo.444.1">JsonSerializer</span></span><span class="koboSpan" id="kobo.445.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.446.1">Serialize</span></span><span class="koboSpan" id="kobo.447.1">(message);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.448.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.449.1">SendMessageAsync</span></span><span class="koboSpan" id="kobo.450.1">(deviceClient, jsonMessage);
  }
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.451.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.452.1">// Sends a message to the IoT hub.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.453.1">// &lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.454.1">// &lt;param name=”deviceClient”&gt;The device client to use for sending the  </span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.455.1">  //message.&lt;/param&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.456.1">// &lt;param name=”message”&gt;The message to send.&lt;/param&gt;</span></span><span class="koboSpan" id="kobo.457.1">
  private </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.458.1">static</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.459.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.460.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.461.1">SendMessageAsync</span></span><span class="koboSpan" id="kobo.462.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.463.1">DeviceClient</span></span><span class="koboSpan" id="kobo.464.1"> deviceClient, 
      string message)
  {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.465.1">var</span></span><span class="koboSpan" id="kobo.466.1"> messageBytes = </span><span class="hljs-title"><span class="koboSpan" id="kobo.467.1">Encoding</span></span><span class="koboSpan" id="kobo.468.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.469.1">UTF8</span></span><span class="koboSpan" id="kobo.470.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.471.1">GetBytes</span></span><span class="koboSpan" id="kobo.472.1">(message);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.473.1">var</span></span><span class="koboSpan" id="kobo.474.1"> iotMessage = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.475.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.476.1">Message</span></span><span class="koboSpan" id="kobo.477.1">(messageBytes);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.478.1">await</span></span><span class="koboSpan" id="kobo.479.1"> deviceClient.</span><span class="hljs-title"><span class="koboSpan" id="kobo.480.1">SendEventAsync</span></span><span class="koboSpan" id="kobo.481.1">(iotMessage);
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.482.1">It is worth noting that we are just creating data here with random information. </span><span class="koboSpan" id="kobo.482.2">However, the process itself exactly represents the output of data from a device to the cloud.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.483.1">Depending on the </span><a id="_idIndexMarker343"/><span class="koboSpan" id="kobo.484.1">device you have, you may need to change the protocol used with Azure IoT Hub. </span><span class="koboSpan" id="kobo.484.2">You may check https://learn.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-protocols for more information.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.485.1">On the other hand, the following code represents the function that will process the vehicle tracking message, storing its data in Cosmos DB and, at the same time, alerting all the microservices via RabbitMQ that there is a new message from a car, so other microservices, like RoutesPlanning, can make use of it to run their business rules:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.486.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.487.1">System</span></span><span class="koboSpan" id="kobo.488.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.489.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.490.1">System</span></span><span class="koboSpan" id="kobo.491.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.492.1">Text</span></span><span class="koboSpan" id="kobo.493.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.494.1">Json</span></span><span class="koboSpan" id="kobo.495.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.496.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.497.1">Azure</span></span><span class="koboSpan" id="kobo.498.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.499.1">Messaging</span></span><span class="koboSpan" id="kobo.500.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.501.1">EventHubs</span></span><span class="koboSpan" id="kobo.502.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.503.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.504.1">Microsoft</span></span><span class="koboSpan" id="kobo.505.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.506.1">Azure</span></span><span class="koboSpan" id="kobo.507.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.508.1">Functions</span></span><span class="koboSpan" id="kobo.509.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.510.1">Worker</span></span><span class="koboSpan" id="kobo.511.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.512.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.513.1">Microsoft</span></span><span class="koboSpan" id="kobo.514.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.515.1">Extensions</span></span><span class="koboSpan" id="kobo.516.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.517.1">Logging</span></span><span class="koboSpan" id="kobo.518.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.519.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.520.1">SharedMessages</span></span><span class="koboSpan" id="kobo.521.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.522.1">VehicleTracking</span></span><span class="koboSpan" id="kobo.523.1">;
namespace </span><span class="hljs-title"><span class="koboSpan" id="kobo.524.1">VehicleTrackingFunction</span></span><span class="koboSpan" id="kobo.525.1">
{
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.526.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.527.1">// Azure Function to process vehicle tracking messages from Event Hub.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.528.1">// &lt;/summary&gt;</span></span><span class="koboSpan" id="kobo.529.1">
  public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.530.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.531.1">VehicleTracking</span></span><span class="koboSpan" id="kobo.532.1">
  {
    private readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.533.1">ILogger</span></span><span class="koboSpan" id="kobo.534.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.535.1">VehicleTracking</span></span><span class="koboSpan" id="kobo.536.1">&gt; _logger;
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.537.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.538.1">// Initializes a new instance of the &lt;see cref=”VehicleTracking”/&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.539.1">    //class.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.540.1">// &lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.541.1">// &lt;param name=”logger”&gt;The logger instance.&lt;/param&gt;</span></span><span class="koboSpan" id="kobo.542.1">
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.543.1">VehicleTracking</span></span><span class="koboSpan" id="kobo.544.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.545.1">ILogger</span></span><span class="koboSpan" id="kobo.546.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.547.1">VehicleTracking</span></span><span class="koboSpan" id="kobo.548.1">&gt; logger)
    {
      _logger = logger;
    }
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.549.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.550.1">// Function triggered by Event Hub messages.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.551.1">// &lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.552.1">// &lt;param name=”events”&gt;Array of EventData received from Event</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.553.1">    //Hub.&lt;/param&gt;</span></span><span class="koboSpan" id="kobo.554.1">
    [</span><span class="hljs-title"><span class="koboSpan" id="kobo.555.1">Function</span></span><span class="koboSpan" id="kobo.556.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.557.1">nameof</span></span><span class="koboSpan" id="kobo.558.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.559.1">VehicleTracking</span></span><span class="koboSpan" id="kobo.560.1">))]
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.561.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.562.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.563.1">Run</span></span><span class="koboSpan" id="kobo.564.1">([</span><span class="hljs-title"><span class="koboSpan" id="kobo.565.1">EventHubTrigger</span></span><span class="koboSpan" id="kobo.566.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.567.1">“messages/events”</span></span><span class="koboSpan" id="kobo.568.1">,
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.569.1">Connection</span></span><span class="koboSpan" id="kobo.570.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.571.1">“CarSharingIoTEventHub”</span></span><span class="koboSpan" id="kobo.572.1">)] </span><span class="hljs-title"><span class="koboSpan" id="kobo.573.1">EventData</span></span><span class="koboSpan" id="kobo.574.1">[] events)
    {
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.575.1">foreach</span></span><span class="koboSpan" id="kobo.576.1"> (</span><span class="hljs-title"><span class="koboSpan" id="kobo.577.1">EventData</span></span><span class="koboSpan" id="kobo.578.1"> @event </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.579.1">in</span></span><span class="koboSpan" id="kobo.580.1"> events)
      {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.581.1">var</span></span><span class="koboSpan" id="kobo.582.1"> jsonString = @event.</span><span class="hljs-property"><span class="koboSpan" id="kobo.583.1">EventBody</span></span><span class="koboSpan" id="kobo.584.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.585.1">ToString</span></span><span class="koboSpan" id="kobo.586.1">();
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.587.1">if</span></span><span class="koboSpan" id="kobo.588.1"> (!string.</span><span class="hljs-title"><span class="koboSpan" id="kobo.589.1">IsNullOrEmpty</span></span><span class="koboSpan" id="kobo.590.1">(jsonString))
        {
          </span><span class="hljs-title"><span class="koboSpan" id="kobo.591.1">VehicleTrackingMessage</span></span><span class="koboSpan" id="kobo.592.1">? </span><span class="koboSpan" id="kobo.592.2">vehicleTrackingMessage = </span><span class="hljs-title"><span class="koboSpan" id="kobo.593.1">JsonSerializer</span></span><span class="koboSpan" id="kobo.594.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.595.1">Deserialize</span></span><span class="koboSpan" id="kobo.596.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.597.1">VehicleTrackingMessage</span></span><span class="koboSpan" id="kobo.598.1">&gt;(jsonString);
          </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.599.1">if</span></span><span class="koboSpan" id="kobo.600.1"> (vehicleTrackingMessage != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.601.1">null</span></span><span class="koboSpan" id="kobo.602.1">)
          {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.603.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.604.1">SaveDataToDatabase</span></span><span class="koboSpan" id="kobo.605.1">(vehicleTrackingMessage);
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.606.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.607.1">AlertDataToRabbitMQ</span></span><span class="koboSpan" id="kobo.608.1">(vehicleTrackingMessage);
          }
        }
      }
    }
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.609.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.610.1">// Sends vehicle tracking data to RabbitMQ.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.611.1">// &lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.612.1">// &lt;param name=”vehicleTrackingMessage”&gt;The vehicle tracking</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.613.1">    //message.&lt;/param&gt;</span></span><span class="koboSpan" id="kobo.614.1">
    private </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.615.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.616.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.617.1">AlertDataToRabbitMQ</span></span><span class="koboSpan" id="kobo.618.1">(
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.619.1">VehicleTrackingMessage</span></span><span class="koboSpan" id="kobo.620.1"> vehicleTrackingMessage)
    {
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.621.1">// Implementation for alerting data to RabbitMQ</span></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.622.1">Console</span></span><span class="koboSpan" id="kobo.623.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.624.1">WriteLine</span></span><span class="koboSpan" id="kobo.625.1">($</span><span class="hljs-string"><span class="koboSpan" id="kobo.626.1">”Vehicle tracking data alerted to RabbitMQ: ID =</span></span>
<span class="hljs-title"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.627.1">{vehicleTrackingMessage.VehicleId};</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.628.1">        Speed = {vehicleTrackingMessage.Speed}”</span></span><span class="koboSpan" id="kobo.629.1">);
    }
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.630.1">// &lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.631.1">// Saves vehicle tracking data to CosmosDB database.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.632.1">// &lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.633.1">// &lt;param name=”vehicleTrackingMessage”&gt;The vehicle tracking</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.634.1">    //message.&lt;/param&gt;</span></span><span class="koboSpan" id="kobo.635.1">
    private </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.636.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.637.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.638.1">SaveDataToDatabase</span></span><span class="koboSpan" id="kobo.639.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.640.1">VehicleTrackingMessage</span></span><span class="koboSpan" id="kobo.641.1"> 
      vehicleTrackingMessage)
    {
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.642.1">// Implementation for saving data to the database CosmosDB</span></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.643.1">Console</span></span><span class="koboSpan" id="kobo.644.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.645.1">WriteLine</span></span><span class="koboSpan" id="kobo.646.1">($</span><span class="hljs-string"><span class="koboSpan" id="kobo.647.1">”Vehicle tracking data saved to database: ID =</span></span>
<span class="hljs-title"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.648.1">{vehicleTrackingMessage.VehicleId};</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.649.1">        Speed = {vehicleTrackingMessage.Speed}”</span></span><span class="koboSpan" id="kobo.650.1">);
    }
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.651.1">Some great things about this approach justify why microservices are a good way to work with big products. </span><span class="koboSpan" id="kobo.651.2">First, the implementation of the IoT solution is totally decoupled from the implementation of the rest of the application, which enables developers to define the technology used and the deployment pipeline. </span><span class="koboSpan" id="kobo.651.3">Second, the usage of the information provided by the IoT solution is optional</span><a id="_idIndexMarker344"/><span class="koboSpan" id="kobo.652.1"> and can be spread to each microservice that is required. </span><span class="koboSpan" id="kobo.652.2">Besides that, one point of attention is the contract defined in the Shared Messages. </span><span class="koboSpan" id="kobo.652.3">You must be careful not to create an incompatibility between the systems. </span><span class="koboSpan" id="kobo.652.4">A good approach to avoid this is to version the message content.</span></p>
<h1 class="heading-1" id="_idParaDest-110"><a id="_idTextAnchor147"/><span class="koboSpan" id="kobo.653.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.654.1">This chapter discussed how Internet of Things solutions can be handled in Azure, especially with the help of Azure IoT Hub and Azure Functions. </span><span class="koboSpan" id="kobo.654.2">It also presented an extension of the car-sharing example using an IoT service, which demonstrates how useful microservices architecture can be.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.655.1">Microservices offer several strategic advantages in the development of large-scale applications, especially when it comes to implementing IoT solutions. </span><span class="koboSpan" id="kobo.655.2">By decoupling the IoT solution from the rest of the application, developers have the flexibility to choose the appropriate technologies and pipelines for deployment independently. </span><span class="koboSpan" id="kobo.655.3">This modular approach not only enhances scalability and maintainability but also allows different teams to work on various parts of the application without interference.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.656.1">Another significant benefit of microservices is their optional and distributed usage of information. </span><span class="koboSpan" id="kobo.656.2">The data provided by the IoT solution can be utilized by any microservice that requires it, ensuring efficient data handling and processing. </span><span class="koboSpan" id="kobo.656.3">However, it is crucial to maintain compatibility across different systems by carefully managing contracts. </span><span class="koboSpan" id="kobo.656.4">Versioning message content is an effective strategy to avoid incompatibility issues, ensuring smooth communication between microservices. </span><span class="koboSpan" id="kobo.656.5">In the next chapter, we will start discussing the usage of microservices in practice with more emphasis.</span></p>
<h1 class="heading-1" id="_idParaDest-111"><a id="_idTextAnchor148"/><span class="koboSpan" id="kobo.657.1">Questions</span></h1>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.658.1">What is the purpose of reading device-to-cloud messages from the built-in endpoint in IoT applications?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.659.1">The built-in endpoint in IoT Hub allows you to read device-to-cloud messages easily and directly, making it ideal for quick integration between devices and backend applications. </span><span class="koboSpan" id="kobo.659.2">It simplifies the process of connecting IoT devices to services like Azure Functions using standard Event Hub-compatible endpoints.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.660.1">This approach is useful for scenarios where rapid prototyping or lightweight integration is needed, as it requires minimal configuration and supports scalable, event-driven solutions.</span></p>
<ol>
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.661.1">How can you read device-to-cloud messages from the built-in endpoint?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.662.1">To read messages from the built-in endpoint, you can create an Azure function using an Event Hub trigger and point it to the default messages/events endpoint of IoT Hub. </span><span class="koboSpan" id="kobo.662.2">The connection string with read permissions (typically from the service policy) is used to access the messages.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.663.1">This method enables a fast and straightforward implementation of serverless message processing, allowing the Azure Function to automatically execute whenever a device sends data to IoT Hub.</span></p>
<ol>
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.664.1">What are the advantages of using the Azure IoT explorer for managing IoT devices?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.665.1">The Azure IoT explorer is a graphical tool that simplifies device management in IoT Hub. </span><span class="koboSpan" id="kobo.665.2">It allows you to register new devices, view connection strings, send test messages, and monitor device status without writing any code.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.666.1">This tool is especially helpful during the development and testing phases, as it accelerates diagnostics and gives developers a user-friendly interface to interact with and configure IoT devices.</span></p>
<ol>
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.667.1">How does Queue Trigger facilitate lightweight, simple queue-based message processing?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.668.1">Queue triggers enable Azure Functions to respond to messages placed in Azure Storage Queues. </span><span class="koboSpan" id="kobo.668.2">This pattern provides a lightweight and decoupled way to process tasks asynchronously, making it easy to implement background job handling or message workflows.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.669.1">It is particularly effective in scenarios where simplicity, scalability, and fault tolerance are desired without the need for complex messaging infrastructure.</span></p>
<ol>
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.670.1">What are the key differences between IoT Hub and Event Hubs?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.671.1">IoT Hub is specifically designed for secure and scalable communication with IoT devices, offering device management, bidirectional messaging, and integration with IoT Edge. </span><span class="koboSpan" id="kobo.671.2">Event Hubs, on the other hand, is a high-throughput, general-purpose event ingestion service mainly used for telemetry and logging.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.672.1">While both support massive data ingestion, IoT Hub provides device-centric features like twin properties, direct methods, and security credentials per device, whereas Event Hubs focuses on data streaming and integration into analytics pipelines.</span></p>
<ol>
<li class="numberedList" value="6"><span class="koboSpan" id="kobo.673.1">What are the benefits of decoupling the IoT solution from the rest of the application?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.674.1">Decoupling the IoT solution allows independent development, scaling, and deployment of the device communication layer. </span><span class="koboSpan" id="kobo.674.2">Each microservice can process only the data it needs, leading to better performance, flexibility, and maintainability.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.675.1">Additionally, this separation enables teams to adopt different technologies or deployment strategies as needed, while keeping the core application architecture clean and modular.</span></p>
<ol>
<li class="numberedList" value="7"><span class="koboSpan" id="kobo.676.1">How can versioning message content help prevent incompatibility issues in shared messages?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.677.1">Versioning message content ensures that changes to data structures don’t break functionality in microservices that consume these messages. </span><span class="koboSpan" id="kobo.677.2">Each service can process the version it understands, allowing smooth evolution of the system.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.678.1">By maintaining compatibility across versions, developers can update and deploy components independently without risking integration failures or data misinterpretation between services.</span></p>
<ol>
<li class="numberedList" value="8"><span class="koboSpan" id="kobo.679.1">What role does the pipeline of deployment play in the implementation of microservices in IoT solutions?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.680.1">A well-defined deployment pipeline allows each microservice, including those related to IoT, to be built, tested, and deployed independently. </span><span class="koboSpan" id="kobo.680.2">This supports continuous integration and delivery, reducing time to market and minimizing risks during updates.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.681.1">For IoT scenarios, where data ingestion and processing are critical, automated pipelines ensure reliability, version control, and traceability across the distributed system—enhancing overall application robustness.</span></p>
<h1 class="heading-1" id="_idParaDest-112"><a id="_idTextAnchor149"/><span class="koboSpan" id="kobo.682.1">Further reading</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.683.1">Azurite: </span><a href="https://learn.microsoft.com/en-us/azure/storage/common/storage-use-azurite"><span class="url"><span class="koboSpan" id="kobo.684.1">https://learn.microsoft.com/en-us/azure/storage/common/storage-use-azurite</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.685.1">Microsoft Azure Storage Explorer: </span><a href="https://learn.microsoft.com/en-us/azure/storage/storage-explorer/vs-azure-tools-storage-manage-with-storage-explorer"><span class="url"><span class="koboSpan" id="kobo.686.1">https://learn.microsoft.com/en-us/azure/storage/storage-explorer/vs-azure-tools-storage-manage-with-storage-explorer</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.687.1">Azure IoT Edge Documentation: </span><a href="https://learn.microsoft.com/en-us/azure/iot-edge"><span class="url"><span class="koboSpan" id="kobo.688.1">https://learn.microsoft.com/en-us/azure/iot-edge</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.689.1">Read device-to-cloud messages from the built-in endpoint: </span><a href="https://learn.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-messages-read-builtin"><span class="url"><span class="koboSpan" id="kobo.690.1">https://learn.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-messages-read-builtin</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.691.1">Azure IoT explorer: </span><a href="https://learn.microsoft.com/en-us/azure/iot/howto-use-iot-explorer"><span class="url"><span class="koboSpan" id="kobo.692.1">https://learn.microsoft.com/en-us/azure/iot/howto-use-iot-explorer</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.693.1">Comparison between IoT Hub and Event Hubs: </span><a href="https://learn.microsoft.com/en-us/azure/iot-hub/iot-hub-compare-event-hubs"><span class="url"><span class="koboSpan" id="kobo.694.1">https://learn.microsoft.com/en-us/azure/iot-hub/iot-hub-compare-event-hubs</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.695.1">Azure Functions Event Triggers: </span><span class="url"><span class="koboSpan" id="kobo.696.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-event-iot</span></span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.697.1">Azure Functions IoT Triggers: </span><span class="url"><span class="koboSpan" id="kobo.698.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-event-iot-trigger</span></span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.699.1">Azure Stream Analytics: </span><span class="url"><span class="koboSpan" id="kobo.700.1">https://azure.microsoft.com/en-us/products/stream-analytics/</span></span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-113"><span class="url"><a id="_idTextAnchor150"/></span><span class="koboSpan" id="kobo.701.1">Join our community on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.702.1">Join our community’s Discord space for discussions with the author and other readers:</span></p>
<p class="normal"><a href="https://packt.link/PSMCSharp"><span class="url"><span class="koboSpan" id="kobo.703.1">https://packt.link/PSMCSharp</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.704.1"><img alt="A qr code with black squares  AI-generated content may be incorrect." src="../Images/B31916_Discord-QR-Code.png"/></span></p>
</div>
</body></html>