- en: '*Chapter 7*: Logging in .NET 6'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '*第7章*：.NET 6中的日志记录'
- en: Logging helps you to record your application's behavior for different data at
    runtime and you can control what you want to record and where you want to record
    it. Once the development of your feature is complete, you can unit test it thoroughly
    on a development PC, deploy it in a test environment for thorough integration
    testing, then deploy it in production, and finally, open it up for many users.
    The context in which your application is running (such as servers, data, and load)
    is different in test environments and production environments when you compare
    it with the development box, and you might face unexpected issues in the test
    and production environments in the initial days.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 日志记录可以帮助你在运行时记录应用程序的不同数据的行为，你可以控制你想记录什么以及你想在哪里记录它。一旦你的功能开发完成，你可以在开发PC上彻底进行单元测试，然后在测试环境中进行彻底的集成测试，然后部署到生产环境中，最后对许多用户开放。与开发机器相比，你的应用程序运行的上下文（如服务器、数据和负载）在测试环境和生产环境中是不同的，你可能会在测试和生产环境的最初几天遇到意外问题。
- en: This is where logging plays a very important role in recording what happens
    during runtime when different components in the end-to-end flow perform their
    functions and interact with each other. With the log information available, we
    can debug production issues and build very useful insights. We will learn about
    logging best practices and the different logging providers available, such as
    Azure App Service logging and Application Insights logging, and will build a reusable
    logging library that can be used in different projects.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，日志记录在记录端到端流程中不同组件执行其功能并相互交互时的运行时发生的事情中起着非常重要的作用。有了日志信息，我们可以调试生产问题并构建非常有用的见解。我们将学习日志最佳实践和可用的不同日志提供程序，例如Azure
    App Service日志记录和Application Insights日志记录，并将构建一个可重复使用的日志库，该库可用于不同的项目。
- en: 'In this chapter, we will cover the following topics:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖以下主题：
- en: Characteristics of good logging
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 良好日志记录的特点
- en: Understanding the available logging providers
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 理解可用的日志提供程序
- en: Working with Azure App Service
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 与Azure App Service一起工作
- en: Real-time telemetry in Application Insights
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Application Insights中的实时遥测
- en: Creating a .NET 6 logging class library
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 创建.NET 6日志类库
- en: By the end of the chapter, you'll have a good idea about logging as well as
    some of the platform-level concepts from Azure App Service and Application Insights
    that can be applied when working on deployment.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 到本章结束时，你将对日志记录有一个很好的了解，以及一些可以在部署时应用的Azure App Service和Application Insights的平台级概念。
- en: Technical requirements
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: A basic understanding of Microsoft .NET and Azure is required.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 需要具备对Microsoft .NET和Azure的基本了解。
- en: 'The code for the chapter can be found here: [https://github.com/PacktPublishing/Enterprise-Application-Development-with-C-10-and-.NET-6-Second-Edition/tree/main/Chapter07](https://github.com/PacktPublishing/Enterprise-Application-Development-with-C-10-and-.NET-6-Second-Edition/tree/main/Chapter07).'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 本章的代码可以在以下位置找到：[https://github.com/PacktPublishing/Enterprise-Application-Development-with-C-10-and-.NET-6-Second-Edition/tree/main/Chapter07](https://github.com/PacktPublishing/Enterprise-Application-Development-with-C-10-and-.NET-6-Second-Edition/tree/main/Chapter07).
- en: Characteristics of good logging
  id: totrans-13
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 良好日志记录的特点
- en: Logging is implemented but the information in the logs is not useful for building
    insights or debugging production issues. How many times have you seen this issue?
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 日志记录已实现，但日志中的信息对构建见解或调试生产问题没有用。你见过多少次这个问题？
- en: 'That''s where best practices come into the picture, to implement good logging
    in your application. Some of the characteristics of good logging are as follows:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 这就是最佳实践发挥作用的地方，在你的应用程序中实现良好的日志记录。良好日志记录的一些特点如下：
- en: It should not affect the actual application performance.
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它不应影响实际的应用程序性能。
- en: It should be accurate and complete.
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它应该是准确和完整的。
- en: It should be leveraged for data analytics and learning about application usages,
    such as concurrent users, peak load time, and most/least used features.
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它应该用于数据分析和学习应用程序的使用情况，例如并发用户、峰值负载时间和最/最少使用的功能。
- en: It should help us reproduce the issue reported for root cause analysis and minimize
    *unable to reproduce* instances.
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它应该帮助我们重现报告的问题，以进行根本原因分析，并最小化*无法重现*的实例。
- en: It should be distributed and easily accessible by everyone – development, product
    owner, and support.
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它应该是分布式的，并且易于每个人（开发人员、产品所有者和支持人员）访问。
- en: It should not contain protected or sensitive information, **personally identifiable
    information** (**PII**), or duplicate or unnecessary logs.
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它不应包含受保护或敏感信息，**个人身份信息**（**PII**），或重复或不必要的日志。
- en: 'In addition to these, it should capture some of the following key information:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 除了这些，它还应捕获以下关键信息的一些内容：
- en: '**Correlation ID**: A unique identifier for an issue that can be used to search
    in the log store.'
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**关联 ID**：用于在日志存储中搜索的问题的唯一标识符。'
- en: '**Log level**: Information, warning, and error, for example.'
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**日志级别**：信息、警告和错误等。'
- en: '**Timestamp**: Time of the log entry (always use one agreed standard format,
    such as UTC or server time, and don''t mix both).'
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**时间戳**：日志条目的时间（始终使用一个同意的标准格式，例如 UTC 或服务器时间，不要混合使用）。'
- en: '**Message**: Message to be logged. This could be an information or custom error
    message, an actual exception message, or a combination of a custom and actual
    error message.'
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**消息**：要记录的消息。这可能是一个信息或自定义错误消息，实际的异常消息，或自定义和实际错误消息的组合。'
- en: '**Machine/server/instance name**: There could be multiple servers in the load
    balancer. This would help us with finding the server where the log occurred.'
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**机器/服务器/实例名称**：负载均衡器中可能有多个服务器。这将帮助我们找到日志发生的服务器。'
- en: '**Assembly**: Name of the assembly where the log occurred.'
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**程序集**：日志发生的位置的程序集名称。'
- en: 'What do you want to record? This is where log-level guidance comes into the
    picture:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 你想记录什么？这就是日志级别指导介入的地方：
- en: '![Table 7.1'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: '![表 7.1'
- en: '](img/Table_7.1.jpg)'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Table_7.1.jpg)'
- en: Table 7.1
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 表 7.1
- en: 'The log level is configurable and based on the level specified; it will be
    enabled from that specified level to all higher levels. For example, if you specify
    the log level as **Information** in your configuration, all log messages from
    **Information**, **Warning**, **Error**, and **Fatal** will be logged, and **Debug**
    and **Trace** messages will not be logged, as shown in the following table. If
    no log level is specified, logging defaults to the **Information** level:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 日志级别是可配置的，并基于指定的级别；它将从指定的级别启用到所有更高级别。例如，如果您在配置中指定日志级别为**信息**，则所有来自**信息**、**警告**、**错误**和**致命**的日志消息都将被记录，而**调试**和**跟踪**消息将不会记录，如下表所示。如果没有指定日志级别，则默认为**信息**级别：
- en: '![Table 7.2'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: '![表 7.2'
- en: '](img/Table_7.2.jpg)'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Table_7.2.jpg)'
- en: Table 7.2
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 表 7.2
- en: Where do you want to record? This is where logging providers come into the picture.
    Let's look at them in the next section.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 你想在何处记录？这就是日志提供程序介入的地方。让我们在下一节中看看它们。
- en: Understanding the available logging providers
  id: totrans-38
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 理解可用的日志提供程序
- en: .NET 6 supports multiple built-in logging providers as well as several third-party
    logging providers. APIs exposed by these providers help in writing log output
    to different sources, such as a file or event log supported by the providers.
    Your code can also enable multiple providers, which is a very common scenario
    when you are moving from one provider to another, where you can keep the old one,
    monitor the new one, and once you are good, you can retire the old provider. Let's
    discuss both types of providers in detail.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: .NET 6 支持多个内置日志提供程序以及几个第三方日志提供程序。这些提供程序公开的 API 帮助将日志输出写入不同的来源，例如提供程序支持的文件或事件日志。您的代码还可以启用多个提供程序，这在您从一个提供程序迁移到另一个提供程序时是一个非常常见的场景，您可以保留旧的，监控新的，一旦您满意，您就可以退役旧的提供程序。让我们详细讨论这两种类型的提供程序。
- en: Built-in logging providers
  id: totrans-40
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 内置日志提供程序
- en: 'All built-in logging providers are supported in the `Microsoft.Extensions.Logging`
    namespace. Let''s have a look at some of them:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 所有内置日志提供程序都支持在 `Microsoft.Extensions.Logging` 命名空间中。让我们看看其中的一些：
- en: '![Table 7.3'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: '![表 7.3'
- en: '](img/Table_7.3(a).jpg)![Table 7.3'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Table_7.3(a).jpg)![表 7.3'
- en: '](img/Table_7.3(b).jpg)'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Table_7.3(b).jpg)'
- en: Table 7.3
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 表 7.3
- en: Third-party logging providers
  id: totrans-46
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第三方日志提供程序
- en: 'While .NET 6 provides several powerful inbuilt logging providers, it also supports
    third-party logging providers. Let''s look at them:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然 .NET 6 提供了几个强大的内置日志提供程序，但它也支持第三方日志提供程序。让我们来看看它们：
- en: '![Table 7.4'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: '![表 7.4'
- en: '](img/Table_7.4.jpg)'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Table_7.4.jpg)'
- en: Table 7.4
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 表 7.4
- en: Having taken a brief look at the multiple built-in and third-party providers,
    let's take a deeper look at Azure App Service and Application Insights in the
    next section.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 在简要了解了多个内置和第三方提供程序之后，让我们在下一节中深入探讨 Azure App Service 和 Application Insights。
- en: Working with Azure App Service
  id: totrans-52
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 Azure App Service
- en: In an **Infrastructure as a Service** (**IaaS**) hosting model, you have full
    control over the operating system and software installed on the machine. It is
    very similar to the on-premises deployments that many of us are used to. You can
    access the servers via remote desktop, go through IIS logs, Windows Event Viewer,
    or files. When you move to the **Platform as a Service** (**PaaS**) hosting model,
    Azure takes care of managing the instances completely. This helps in saving a
    considerable amount of time as your engineers don't have to spend time managing
    the servers to keep up to date with respect to the operating systems, infrastructure,
    and security updates.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **基础设施即服务**（**IaaS**）托管模型中，您对机器上安装的操作系统和软件拥有完全控制权。这与我们许多人习惯的本地部署非常相似。您可以通过远程桌面访问服务器，查看
    IIS 日志、Windows 事件查看器或文件。当您迁移到 **平台即服务**（**PaaS**）托管模型时，Azure 会完全负责管理实例。这有助于节省大量时间，因为您的工程师不必花费时间管理服务器，以保持操作系统、基础设施和安全更新的最新状态。
- en: In this section, we will see how to do extensive logging and monitoring when
    you deploy your app in an Azure App Service plan (one of the important PaaS offerings
    from Microsoft).
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 在本节中，我们将了解如何在将应用程序部署到 Azure App Service 计划（Microsoft 的重要 PaaS 提供之一）时进行广泛的日志记录和监控。
- en: Enabling application logging in Azure App Service
  id: totrans-55
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在 Azure App Service 中启用应用程序日志记录
- en: 'To enable application logging, you need to perform the following steps:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 要启用应用程序日志记录，您需要执行以下步骤：
- en: '`AzureAppServices` package in any of your existing .NET 6 projects using the
    `dotnet add <.csproj>  package <Nuget package> -v <Version number>` command, as
    shown:'
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 `dotnet add <.csproj>  package <Nuget package> -v <Version number>` 命令在您的现有
    .NET 6 项目中添加 `AzureAppServices` 包，如下所示：
- en: '![Figure 7.1 – Installing a package from the CLI'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: '![Figure 7.1 – Installing a package from the CLI'
- en: '](img/Figure_7.1_B18507.jpg)'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: '![img/Figure_7.1_B18507.jpg]'
- en: Figure 7.1 – Installing a package from the CLI
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.1 – 从CLI安装包
- en: You can get more details about .NET CLI commands from [https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet](https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet).
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以从 [https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet](https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet)
    获取有关 .NET CLI 命令的更多详细信息。
- en: 'You can also right-click on `Microsoft.Extensions.Logging.AzureAppServices`
    package and install it as shown in the following screenshot:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 您也可以右键单击 `Microsoft.Extensions.Logging.AzureAppServices` 包，并按以下截图所示进行安装：
- en: '![Figure 7.2 – Installing a package from the IDE'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: '![Figure 7.2 – 从IDE安装包'
- en: '](img/Figure_7.2_B18507.jpg)'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: '![img/Figure_7.2_B18507.jpg]'
- en: Figure 7.2 – Installing a package from the IDE
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.2 – 从IDE安装包
- en: '`Program.cs` file of your .NET 6 app, add the following highlighted code in
    the `CreateHostBuilder` method:'
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在您的 .NET 6 应用程序的 `Program.cs` 文件中，在 `CreateHostBuilder` 方法中添加以下突出显示的代码：
- en: '[PRE0]'
  id: totrans-67
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '`CreateHostBuilder` does the default configuration for the app we are developing.
    Let''s add a logging configuration here, which will also dynamically inject `_logger`
    (object creation happens using **dependency injection** (**DI**), as explained
    in [*Chapter 5*](B18507_05_Epub.xhtml#_idTextAnchor445), *Dependency Injection
    in .NET 6*).'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: '`CreateHostBuilder` 为我们正在开发的程序执行默认配置。让我们在这里添加一个日志配置，这也会动态注入 `_logger` 对象（对象创建使用
    **依赖注入**（**DI**）进行，如[*第5章*](B18507_05_Epub.xhtml#_idTextAnchor445)，*.NET 6中的依赖注入*所述）。'
- en: '**Adding logging**: Add the following highlighted logging code to your methods
    in any of the controllers where core logic resides generally to test whether logging
    works:'
  id: totrans-69
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**添加日志记录**：将以下突出显示的日志代码添加到任何控制器中的方法中，通常位于核心逻辑处，以测试日志记录是否正常工作：'
- en: '[PRE1]'
  id: totrans-70
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: '`TestAppServiceForLoggingDemo`. For more information on how to publish, refer
    to [https://docs.microsoft.com/en-us/visualstudio/deployment/quickstart-deploy-to-azure?view=vs-2022](https://docs.microsoft.com/en-us/visualstudio/deployment/quickstart-deploy-to-azure?view=vs-2022).
    For this example, we have leveraged the Windows-based App Service plan.'
  id: totrans-71
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`TestAppServiceForLoggingDemo`。有关如何发布的更多信息，请参阅[https://docs.microsoft.com/en-us/visualstudio/deployment/quickstart-deploy-to-azure?view=vs-2022](https://docs.microsoft.com/en-us/visualstudio/deployment/quickstart-deploy-to-azure?view=vs-2022)。对于此示例，我们使用了基于
    Windows 的 App Service 计划。'
- en: '**Enabling logging**: Go to the Azure portal | **Your subscription** | **Resource
    Group** | **App service** where it is deployed, and select **App Service logs**
    under **Monitoring**. You can see different logging options, as shown:'
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**启用日志记录**：转到 Azure 门户 | **您的订阅** | **资源组** | **应用服务**（它在那里部署），然后在 **监控** 下选择
    **应用服务日志**。您可以看到不同的日志选项，如下所示：'
- en: '![Figure 7.3 – App Service logs default state'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: '![Figure 7.3 – App Service日志默认状态'
- en: '](img/Figure_7.3_B18507.jpg)'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: '![img/Figure_7.3_B18507.jpg]'
- en: Figure 7.3 – App Service logs default state
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.3 – 应用服务日志默认状态
- en: 'All logging options are turned off by default, as shown in the previous screenshot.
    Let''s see what those options are:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，所有日志选项都已关闭，如前一个截图所示。让我们看看这些选项有哪些：
- en: '**Application Logging (Filesystem)**: Writes log messages from the application
    to the local filesystem on the web server. This will be enabled for 12 hours once
    you turn it on and will be disabled automatically after that. Therefore, this
    option is for temporary debugging purposes.'
  id: totrans-77
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**应用程序日志（文件系统）**：将应用程序的日志消息写入Web服务器的本地文件系统。一旦您打开它，这将启用12小时，之后将自动禁用。因此，此选项用于临时调试目的。'
- en: '**Application Logging (Blob)**: Writes log messages from the application to
    Blob storage for persistent logs for a configured retention period. Logging in
    blobs is for long-term debugging purposes. You would need a Blob storage container
    to write logs to. You can read more about Blob storage containers here: [https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction).
    Once you select **On**, you will get an option to create a new storage account
    or search for an existing storage account where you can write the logs. Click
    on **+ Storage account** and specify a name to create a new account, as shown
    in the following screenshot:'
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**应用程序日志（Blob）**：将应用程序的日志消息写入Blob存储，以在配置的保留期内进行持久日志记录。Blob中的日志记录用于长期调试目的。您需要一个Blob存储容器来写入日志。您可以在[https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)上了解更多关于Blob存储容器的信息。一旦您选择**开启**，您将获得创建新存储账户或搜索现有存储账户以写入日志的选项。点击**+
    存储账户**并指定一个名称以创建新账户，如下截图所示：'
- en: '![Figure 7.4 – Storage account configuration'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: '![图7.4 – 存储账户配置'
- en: '](img/Figure_7.4_B18507.jpg)'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_7.4_B18507.jpg)'
- en: Figure 7.4 – Storage account configuration
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.4 – 存储账户配置
- en: '**Web server logging**: IIS logs on servers that give diagnostic information
    such as the HTTP method, resource URI, client IP, client port, user agent, and
    response code. You can store the logs in Blob storage or on the filesystem. In
    **Retention Period (Days)**, you can configure the number of days for which the
    logs should be retained.'
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Web服务器日志**：IIS日志记录在服务器上，提供诊断信息，如HTTP方法、资源URI、客户端IP、客户端端口、用户代理和响应代码。您可以将日志存储在Blob存储或文件系统中。在**保留期（天数）**中，您可以配置日志应保留的天数。'
- en: '`400` responses from the server, which can help you determine why the server
    returned this error.'
  id: totrans-83
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 服务器返回的`400`响应，这可以帮助您确定服务器为什么返回此错误。
- en: Note
  id: totrans-84
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 注意
- en: For security reasons, we don't send detailed error pages to clients in production,
    but App Service can save this error in the filesystem each time an application
    error occurs that has HTTP code `400` or greater.
  id: totrans-85
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 由于安全原因，在生产环境中，我们不向客户端发送详细的错误页面，但每当应用程序发生HTTP代码`400`或更高的错误时，应用服务都可以将此错误保存到文件系统中。
- en: '**Failed request tracing**: Detailed information on failed requests, including
    IIS trace and so on. For each failed request, a folder is generated that contains
    the XML log file and the XSL stylesheet to view the log file.'
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**失败的请求跟踪**：关于失败请求的详细信息，包括IIS跟踪等。对于每个失败的请求，都会生成一个包含XML日志文件和用于查看日志文件的XSL样式的文件夹。'
- en: 'The following screenshot shows how it will look when you turn it on and enable
    all the log options:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 以下截图显示了您打开并启用所有日志选项时的外观：
- en: '![Figure 7.5 – App Service logs enabled'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: '![图7.5 – 应用服务日志启用'
- en: '](img/Figure_7.5_B18507.jpg)'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_7.5_B18507.jpg)'
- en: Figure 7.5 – App Service logs enabled
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.5 – 应用服务日志启用
- en: 'You can verify logs from any of the logging options we have enabled by browsing
    the site hosted on App Service and navigating to the page that hits the controller
    where logging is done. For example, let''s check **Application Logging (Blob)**
    by accessing the Blob storage where we configured one of the logging options,
    as shown in the following screenshot:'
  id: totrans-91
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 您可以通过浏览托管在应用服务上的网站并导航到执行日志记录的控制器所在的页面来验证我们已启用的任何日志选项。例如，让我们通过访问配置了日志选项之一的Blob存储来检查**应用程序日志（Blob）**，如下截图所示：
- en: '![Figure 7.6 – App Service logs from Blob storage'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: '![图7.6 – 从Blob存储获取的应用服务日志'
- en: '](img/Figure_7.6_B18507.jpg)'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_7.6_B18507.jpg)'
- en: Figure 7.6 – App Service logs from Blob storage
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.6 – 从Blob存储获取的应用服务日志
- en: 'You can also see the logs in the log stream in real-time from the controller
    where we added test logs by navigating to **Log stream** under **Monitoring**:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 您还可以通过导航到**监控**下的**日志流**，从添加测试日志的控制器实时查看日志：
- en: '![Figure 7.7 – App Service logs in Log stream'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: '![图7.7 – 应用服务日志在日志流中'
- en: '](img/Figure_7.7_B18507.jpg)'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_7.7_B18507.jpg)'
- en: Figure 7.7 – App Service logs in Log stream
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.7 – 应用服务日志在日志流中
- en: We saw how to enable different logs in Azure App Service and verified logs in
    **Application Logging (Blob)** and **Log stream**. In the next section, we will
    see how we can monitor and raise alerts.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 我们看到了如何在Azure应用服务中启用不同的日志并验证了**应用程序日志（Blob）**和**日志流**中的日志。在下一节中，我们将看到如何进行监控和设置警报。
- en: Monitoring using metrics
  id: totrans-100
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用度量值进行监控
- en: You can monitor your App Service plan and app services using metrics in Azure
    Monitor.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用Azure Monitor中的度量值来监控您的应用服务计划和应用程序服务。
- en: 'Navigate to your App Service plan and check the overview, as shown in the following
    screenshot. You can see standard charts for CPU, memory, data in, data out, and
    so on:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 导航到您的应用服务计划并查看概述，如以下截图所示。您可以看到CPU、内存、数据输入、数据输出等标准图表：
- en: '![Figure 7.8 – App Service plan overview'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: '![图7.8 – 应用服务计划概述'
- en: '](img/Figure_7.8_B18507.jpg)'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_7.8_B18507.jpg)'
- en: Figure 7.8 – App Service plan overview
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.8 – 应用服务计划概述
- en: 'Now, click on any of the charts, for example, the **CPU Percentage** chart.
    You will get the view shown in the following screenshot (the default duration
    is 1 hour):'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，点击任何图表，例如，**CPU百分比**图表。您将看到以下截图所示的视图（默认持续时间是1小时）：
- en: '![Figure 7.9 – App Service metrics overview'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: '![图7.9 – 应用服务度量值概述'
- en: '](img/Figure_7.9_B18507.jpg)'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_7.9_B18507.jpg)'
- en: Figure 7.9 – App Service metrics overview
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.9 – 应用服务度量值概述
- en: 'I have highlighted three important sections in the chart shown in the previous
    screenshot. Let''s discuss them:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 我在之前截图所示的图表中突出显示了三个重要部分。让我们来讨论它们：
- en: '**Local Time**: When you click on **Local Time**, you will get options as shown
    in the following screenshot. You can change the value of the time range for which
    this chart should represent:'
  id: totrans-111
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**本地时间**：当您点击**本地时间**时，您将看到以下截图所示的选项。您可以更改此图表应表示的时间范围值：'
- en: '![Figure 7.10 – App Service metrics time range'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: '![图7.10 – 应用服务度量值时间范围'
- en: '](img/Figure_7.10_B18507.jpg)'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_7.10_B18507.jpg)'
- en: Figure 7.10 – App Service metrics time range
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.10 – 应用服务度量值时间范围
- en: '**Add metric**: When you click on **Add metric**, you will get the options
    shown in the following screenshot. You can select the metric you want the chart
    to display:'
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**添加度量值**：当您点击**添加度量值**时，您将看到以下截图所示的选项。您可以选择图表要显示的度量值：'
- en: '![Figure 7.11 – App Service – Add metric'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: '![图7.11 – 应用服务 – 添加度量值'
- en: '](img/Figure_7.11_B18507.jpg)'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_7.11_B18507.jpg)'
- en: Figure 7.11 – App Service – Add metric
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.11 – 应用服务 – 添加度量值
- en: '**Pin to dashboard**: You can click on **Pin to dashboard** and add the chart
    to the dashboard so that you can see updates when you log in to the Azure portal.'
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**固定到仪表板**：您可以通过点击**固定到仪表板**将图表添加到仪表板，以便您登录Azure门户时可以看到更新。'
- en: 'When you click on the left portal menu, you can see **Dashboard**, and you
    can click on that to see all the pinned dashboards:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 当您点击左侧门户菜单时，您可以看到**仪表板**，您可以点击它以查看所有已固定的仪表板：
- en: '![Figure 7.12 – Left portal menu option for Dashboard'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: '![图7.12 – 左侧门户菜单仪表板选项'
- en: '](img/Figure_7.12_B18507.jpg)'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/Figure_7.12_B18507.jpg)'
- en: Figure 7.12 – Left portal menu option for Dashboard
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.12 – 仪表板左侧门户菜单选项
- en: In the next section, let's see how to enable real-time telemetry in Azure Application
    insights.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一节中，让我们看看如何在Azure应用洞察中启用实时遥测。
- en: Real-time telemetry in Azure Application Insights
  id: totrans-125
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Azure应用洞察的实时遥测
- en: 'Application Insights is one of the best telemetry offerings provided by Microsoft
    Azure for developers and DevOps professionals as an extensible **application performance
    management** (**APM**) service to do the following:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: Application Insights是Microsoft Azure为开发人员和DevOps专业人员提供的最佳遥测服务之一，作为一个可扩展的**应用程序性能管理（APM）**服务，用于以下目的：
- en: Monitor your applications live.
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实时监控您的应用程序。
- en: Automatically detect performance anomalies.
  id: totrans-128
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 自动检测性能异常。
- en: Include powerful analytics tools to help you diagnose issues.
  id: totrans-129
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 包含强大的分析工具以帮助您诊断问题。
- en: Understand what users do with your app.
  id: totrans-130
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 了解用户如何使用您的应用程序。
- en: Help you continuously improve performance and usability.
  id: totrans-131
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 帮助您持续改进性能和可用性。
- en: '`Microsoft.Extensions.Logging.ApplicationInsights` is included as a dependency
    of `Microsoft.ApplicationInsights.AspNetCore`. The `Microsoft.ApplicationInsights.AspNetCore`
    package is used in ASP.NET Core applications for telemetry, and when you use this,
    you don''t need to install `Microsoft.Extensions.Logging.ApplicationInsights`.'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: '`Microsoft.Extensions.Logging.ApplicationInsights` 作为 `Microsoft.ApplicationInsights.AspNetCore`
    的依赖项被包含。`Microsoft.ApplicationInsights.AspNetCore` 包用于 ASP.NET Core 应用程序中的遥测，当您使用此包时，您不需要安装
    `Microsoft.Extensions.Logging.ApplicationInsights`。'
- en: 'As shown in the following figure, you can install this package in your application
    to enable and write telemetry:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 如下图所示，您可以在应用程序中安装此包以启用并写入遥测：
- en: '![Figure 7.13 – Application Insights instrumentation for telemetry'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.13 – 应用洞察遥测的仪器化'
- en: '](img/Figure_7.13_B18507.png)'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片](img/Figure_7.13_B18507.png)'
- en: Figure 7.13 – Application Insights instrumentation for telemetry
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.13 – 应用洞察遥测的仪器化
- en: Note
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: There is no impact on your app performance. Calls to Application Insights are
    non-blocking and sent in separate threads in batches.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 这不会影响您的应用程序性能。对应用洞察的调用是非阻塞的，并且以批量形式在单独的线程中发送。
- en: Enabling application logging in Application Insights
  id: totrans-139
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在应用洞察中启用应用程序日志记录
- en: 'The steps to enable application logging when using Application Insights are
    as follows:'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 使用应用洞察启用应用程序日志记录的步骤如下：
- en: '`Microsoft.ApplicationInsights.AspNetCore` package from `Install-Package <Package
    name> -version <Version number>` command:'
  id: totrans-141
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 `Install-Package <Package name> -version <Version number>` 命令安装 `Microsoft.ApplicationInsights.AspNetCore`
    包：
- en: '![Figure 7.14 - Installing packages from Package Manager Console'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.14 - 从包管理控制台安装包'
- en: '](img/Figure_7.14_B18507.jpg)'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片](img/Figure_7.14_B18507.jpg)'
- en: Figure 7.14 - Installing packages from Package Manager Console
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.14 - 从包管理控制台安装包
- en: '`appsettings.json` so that all telemetry data is written to your Azure Application
    Insights resource. If you don''t have an Azure Application Insights resource,
    go ahead and create one, and then add it to `appsettings.json`:'
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`appsettings.json` 以确保所有遥测数据都写入您的 Azure 应用洞察资源。如果您没有 Azure 应用洞察资源，请继续创建一个，然后将其添加到
    `appsettings.json`：'
- en: '[PRE2]'
  id: totrans-146
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '`Program.cs` file, add the highlighted code:'
  id: totrans-147
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 `Program.cs` 文件中，添加高亮代码：
- en: '[PRE3]'
  id: totrans-148
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Now, you can build and run the application. Out of the box, you will get a lot
    of telemetry data.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，您可以构建和运行应用程序。默认情况下，您将获得大量的遥测数据。
- en: 'Navigate to **Application Insights** | **Overview** and you can see any failed
    requests, the server response time, and server requests, as shown in the following
    screenshot:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 导航到 **应用洞察** | **概览**，您可以看到任何失败的请求、服务器响应时间和服务器请求，如图下截图所示：
- en: '![Figure 7.15 – Application Insights overview'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.15 – 应用洞察概览'
- en: '](img/Figure_7.15_B18507.jpg)'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片](img/Figure_7.15_B18507.jpg)'
- en: Figure 7.15 – Application Insights overview
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.15 – 应用洞察概览
- en: 'You can navigate to **Application Insights** | **Live Metrics** for real-time
    performance counters, as shown in the following figure:'
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以导航到 **应用洞察** | **实时指标** 以获取实时性能计数器，如图下所示：
- en: '![Figure 7.16 - Application Insights live metrics'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.16 – 应用洞察实时指标'
- en: '](img/Figure_7.16_B18507.jpg)'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片](img/Figure_7.16_B18507.jpg)'
- en: Figure 7.16 - Application Insights live metrics
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.16 - 应用洞察实时指标
- en: 'You can navigate to **Application Insights** | **Metrics** to get different
    metrics and charts, as shown in the following figure:'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以导航到 **应用洞察** | **指标** 以获取不同的指标和图表，如图下所示：
- en: '![Figure 7.17 – Application Insights metrics'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.17 – 应用洞察指标'
- en: '](img/Figure_7.17_B18507.jpg)'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片](img/Figure_7.17_B18507.jpg)'
- en: Figure 7.17 – Application Insights metrics
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.17 – 应用洞察指标
- en: 'You can navigate to **Application Insights** | **Performance** and analyze
    operation duration, dependency response time, and so on, as shown in the following
    figure:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以导航到 **应用洞察** | **性能** 以分析操作持续时间、依赖项响应时间等，如图下所示：
- en: '![Figure 7.18 – Application Insights performance'
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.18 – 应用洞察性能'
- en: '](img/Figure_7.18_B18507.jpg)'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片](img/Figure_7.18_B18507.jpg)'
- en: Figure 7.18 – Application Insights performance
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.18 – 应用洞察性能
- en: 'You can navigate to **Application Insights** | **Failures** and analyze operations,
    failed requests, failed dependencies, the top three response codes, exception
    types, and dependency failures, as shown in the following figure:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以导航到 **应用洞察** | **失败** 并分析操作、失败的请求、失败的依赖项、前三个响应代码、异常类型和依赖项失败，如图下所示：
- en: '![Figure 7.19 – Application Insights failures'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.19 – 应用洞察失败'
- en: '](img/Figure_7.19_B18507.jpg)'
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片](img/Figure_7.19_B18507.jpg)'
- en: Figure 7.19 – Application Insights failures
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.19 – 应用洞察失败
- en: 'We have seen the telemetry and alerts available out of the box. How do we add
    logs for information, errors, or warnings? You can use the logger (object creation
    happens using DI, which was covered in [*Chapter 5*](B18507_05_Epub.xhtml#_idTextAnchor445),
    *Dependency Injection in .NET 6*). DI is enabled by the second (*App settings
    configuration*) and third (*Enabling the Application Insights telemetry*) steps
    that we saw in the preceding set of steps to enable logging in Application Insights.
    For testing purposes, to see whether it''s working, you can add the following
    code to your controller and run the application:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经看到了开箱即用的遥测和警报。我们如何添加信息、错误或警告的日志？您可以使用日志记录器（对象创建是通过 DI 实现的，这在 [*第 5 章*](B18507_05_Epub.xhtml#_idTextAnchor445)，*.NET
    6 中的依赖注入*）中已经介绍过）。DI 是通过前述步骤中看到的第二个（*应用程序设置配置*）和第三个（*启用 Application Insights 遥测*）步骤启用的。为了测试目的，为了查看它是否正常工作，您可以将以下代码添加到您的控制器中并运行应用程序：
- en: '[PRE4]'
  id: totrans-171
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: '[PRE5]'
  id: totrans-172
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: '[PRE6]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: '[PRE7]'
  id: totrans-174
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: '[PRE8]'
  id: totrans-175
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: '[PRE9]'
  id: totrans-176
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: '[PRE10]'
  id: totrans-177
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: '[PRE11]'
  id: totrans-178
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'You can navigate to **Application Insights** | **Logs** and check traces, where
    you can see both the warnings and errors that were logged, as shown in the following
    figure:'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以导航到 **Application Insights** | **日志** 并检查跟踪，在那里您可以查看已记录的警告和错误，如图所示：
- en: '![Figure 7.20 – Application Insights logs'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.20 – Application Insights 日志](img/Figure_7.20_B18507.jpg)'
- en: '](img/Figure_7.20_B18507.jpg)'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.20 – Application Insights 日志](img/Figure_7.20_B18507.jpg)'
- en: Figure 7.20 – Application Insights logs
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.20 – Application Insights 日志
- en: Application Insights is very simple to use and a very powerful log provider.
    We saw the rich telemetry it provides out-of-the-box and added our own logs. In
    the next section, we will develop a custom logging class library. The default
    logger provided in .NET 6 is more than enough for your application telemetry.
    If you need custom metrics and events to be logged on top of what's provided by
    default in .NET 6, you can leverage the following custom logger library.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: Application Insights 非常简单易用，是一个非常强大的日志提供程序。我们看到了它提供的丰富遥测数据，并添加了我们自己的日志。在下一节中，我们将开发一个自定义日志类库。.NET
    6 中提供的默认日志记录器对于您的应用程序遥测来说已经足够了。如果您需要记录默认在 .NET 6 中提供的自定义指标和事件，您可以利用以下自定义日志记录器库。
- en: Creating a .NET 6 logging class library
  id: totrans-184
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建 .NET 6 日志类库
- en: 'We will create a class library (DLL) that will support Application Insights
    logging and can be extended to support logging to other sources if needed. Perform
    the following steps for this:'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将创建一个支持 Application Insights 日志记录并可扩展以支持其他来源日志记录的类库（DLL）。为此，请执行以下步骤：
- en: Create a new .NET 6 class library with the name `Logger`.
  id: totrans-186
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个新的名为 `Logger` 的 .NET 6 类库。
- en: Install the `Microsoft.ApplicationInsights` package.
  id: totrans-187
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装 `Microsoft.ApplicationInsights` 包。
- en: 'Create a new class called `ICustomLogger.cs` and add the following code:'
  id: totrans-188
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个名为 `ICustomLogger.cs` 的新类，并添加以下代码：
- en: '[PRE12]'
  id: totrans-189
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Create a new class called `AiLogger.cs` and add the following code to log custom
    events and metrics:'
  id: totrans-190
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个名为 `AiLogger.cs` 的新类，并添加以下代码以记录自定义事件和指标：
- en: '**Namespaces and Constructor**:'
  id: totrans-191
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**命名空间和构造函数**:'
- en: '[PRE13]'
  id: totrans-192
  prefs:
  - PREF_IND
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: '**Code to log warning, error, and exception**:'
  id: totrans-193
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**代码用于记录警告、错误和异常**:'
- en: '[PRE14]'
  id: totrans-194
  prefs:
  - PREF_IND
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE14]'
- en: '**Code to log custom event, metric, information, request, and dependency**:'
  id: totrans-195
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**代码用于记录自定义事件、指标、信息、请求和依赖**:'
- en: '[PRE15]'
  id: totrans-196
  prefs:
  - PREF_IND
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: '`AiLogger` uses the `TelemetryClient` class, which sends telemetry to Azure
    Application Insights.'
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: '`AiLogger` 使用 `TelemetryClient` 类，该类将遥测数据发送到 Azure Application Insights。'
- en: Build the library, and your custom .NET 6 logger is ready to consume events
    in your project.
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 构建库，您的自定义 .NET 6 日志记录器就绪，可以消费项目中的事件。
- en: In the upcoming chapters, we will be consuming the logging library as part of
    our enterprise application development. In the example provided for this chapter,
    you can see how we have dynamically injected this custom logger into the `LoggerDemoService`
    project.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 在接下来的章节中，我们将作为企业应用程序开发的一部分使用日志记录库。在本章提供的示例中，您可以看到我们如何动态地将此自定义日志记录器注入到 `LoggerDemoService`
    项目中。
- en: Summary
  id: totrans-200
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, we learned about the characteristics of good logging, the different
    logging providers available, such as the Azure App Service logging provider and
    the Azure Application Insights logging provider, and how to create a reusable
    logger library.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们学习了良好日志记录的特点，可用的不同日志提供程序，例如 Azure App Service 日志提供程序和 Azure Application
    Insights 日志提供程序，以及如何创建可重用的日志记录器库。
- en: You now have the necessary knowledge of logging that will help you to implement
    a reusable logger or extend a current logger in your project, with the right level
    of logging and key information to debug issues and build analytics on production
    data.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 您现在拥有了必要的日志记录知识，这将帮助您在项目中实现可重用的记录器或扩展当前的记录器，以适当的日志级别和关键信息来调试问题并在生产数据上构建分析。
- en: In the next chapter, we will learn about various techniques to cache data in
    .NET 6 applications, as well as various caching components and the platforms available
    that can be integrated with a .NET application.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将学习如何在 .NET 6 应用程序中缓存数据的各种技术，以及可以与 .NET 应用程序集成的各种缓存组件和平台。
- en: Questions
  id: totrans-204
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 问题
- en: 'Which logs highlight when the current flow of execution has stopped due to
    a failure? These should indicate a failure in the current activity, not an application-wide
    failure:'
  id: totrans-205
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 哪些日志会在执行流程因失败而停止时突出显示？这些应该表明当前活动中的失败，而不是应用程序范围内的失败：
- en: a. Warning
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: a. 警告
- en: b. Error
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: b. 错误
- en: c. Critical
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: c. 严重
- en: d. Information
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: d. 信息
- en: '**Answer : b**'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: '**答案：b**'
- en: What can be leveraged by applications and components running anywhere, on Azure,
    AWS, your own on-premises servers, or a mobile platform, for logging?
  id: totrans-211
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对于在任何地方运行的应用程序和组件，包括 Azure、AWS、您自己的本地服务器或移动平台，用于日志记录可以依赖什么？
- en: a. Application Insights
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: a. 应用洞察
- en: b. Azure App Service
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: b. Azure App Service
- en: c. EventLog
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: c. EventLog
- en: d. Serilog
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: d. Serilog
- en: '**Answer: a**'
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: '**答案：a**'
- en: What are the logging options available in Azure App Service?
  id: totrans-217
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: Azure App Service 中可用的日志记录选项有哪些？
- en: a. **Application Logging (Filesystem)** and **Application Logging (Blob****)**
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: a. **应用程序日志（文件系统）**和**应用程序日志（Blob**）
- en: b. **Web server logging** and **Detailed error messages**
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: b. **Web 服务器日志**和**详细错误消息**
- en: c. **Failed request tracing**
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: c. **失败的请求跟踪**
- en: d. All the above
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: d. 所有以上选项
- en: '**Answer: d**'
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: '**答案：d**'
- en: Application Insights is an extensible APM service to do which of the following?
  id: totrans-223
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 应用洞察是一个可扩展的 APM 服务，可以执行以下哪些操作？
- en: a. Monitor your live applications.
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: a. 监控您的实时应用程序。
- en: b. Automatically detect performance anomalies.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: b. 自动检测性能异常。
- en: c. Include powerful analytics tools to help you diagnose issues.
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: c. 包含强大的分析工具以帮助您诊断问题。
- en: d. All the above.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: d. 所有以上选项。
- en: '**Answer: d**'
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: '**答案：d**'
