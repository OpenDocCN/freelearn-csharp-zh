<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="z3998: http://www.daisy.org/z3998/2012/vocab/structure/#" lang="en" xml:lang="en">
<head>
    <title>Testing and Deploying &amp;#x2013; The Let&amp;#x27;s Chat Web Application</title>
    <link href="css/style.css" rel="stylesheet" type="text/css"/>
    <link href="68851547a55f.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Testing and Deploying – The Let's Chat Web Application</h1>
                </header>
            
            <article>
                
<p class="mce-root">In the previous chapter, we developed the authentication module of our Let's Chat web application. In this chapter, we will develop the Chat hub module using SignalR and wrap up the coding of our web application. After that, we will have a demonstration of how it works, and learn to test and deploy it. We will learn about Docker containers and how they may be helpful. Finally, we will develop an ASP.NET Core-based Chatbot and integrate it with the Let's Chat application and Facebook. The motivation behind this chapter is to understand the testing deployment model of .NET Core applications, the Live Unit Testing feature of Visual Studio 2017, and containers, and get a sneak peek into developing a simple Bot, based on the Microsoft Bot Framework. In this chapter, we will cover the following:</p>
<ul>
<li>Chat hub module</li>
<li>Testing overview</li>
<li>Introduction to containers</li>
<li>Bot 101</li>
</ul>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Chat hub module</h1>
                </header>
            
            <article>
                
<p>Now that we have the authentication module in place, a user can log in to our Let's Chat web application using Facebook. We still need to develop the Chat module so that the user can see their friends online and chat with them. In this section, we will develop the Chat hub module using SignalR. We have already developed a Tic-Tac-Toe game using SignalR. Hence, we are already familiar with how to develop a SignalR hub and get the communication going back and forth between clients and server, so this should be relatively easier for us. On the client side, we will make use of Razor pages. ASP.NET Core 2.0 introduced a new feature called Razor pages, which makes the coding of page-focused scenarios much easier. If you have worked on earlier versions of ASP.NET, you will have seen or heard about ASP.NET Web forms (<kbd>.aspx</kbd>) applications, which had web forms at the heart of development. This is more or less on the same lines in the MVC world and makes it really productive to develop quick demos and <strong>proof of concepts</strong> (<strong>PoCs</strong>). We will quickly do a detour through Razor,&#160;<span>views, and R</span>azor pages, and then jump into the coding of the Chat hub module.</p>
<p>View, in a <strong>Model-View-Controller</strong> (<strong>MVC</strong>) pattern, handles the application data presentation and user interaction. Specifically, in the context of ASP.NET MVC, View is just an HTML template with Razor markup. <span>Razor markup... huh!&#160; Let's have a look at the Razor primer, before we understand View.</span></p>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Razor primer</h1>
                </header>
            
            <article>
                
<p>Razor is a markup syntax for embedding server-based code in a web page. Developers familiar with PHP will find themselves at home while working with Razor, as the syntax is very similar. Razor syntax consists of Razor markup, C#, and HTML. Since it contains C# as well as HTML, files containing Razor syntax generally have a <kbd>.cshtml</kbd> extension. The <kbd>@</kbd> symbol is of great importance in Razor syntax and it is used to transition from HTML to C#. OK! But how does Razor work?&#160; A <kbd>.cshtml</kbd> file can have Razor, C#, and HTML. The server first runs the Razor markup and C#, which ultimately would translate into HTML that the browser can understand and render. This HTML is then combined with the remaining HTML content and sent back to the browser. The following are reserved keywords in Razor:</p>
<ul>
<li><kbd>functions</kbd></li>
<li><kbd>inherits</kbd></li>
<li><kbd>model</kbd></li>
<li><kbd>page</kbd></li>
<li><kbd>section</kbd></li>
</ul>
<p>Language-specific keywords (for C# in <kbd>.cshtml</kbd> and VB in <kbd>.vbhtml</kbd>) remain as-is in Razor code blocks, and hence are not given special mention. It must be noted that when an <kbd>@</kbd> symbol is followed by a Razor reserved keyword, it gets translated into Razor-specific markup; otherwise, it transitions into plain C#. &#160;Let's have a quick look at the Razor syntax:</p>
<table style="width: 1054px;height: 449px">
<tbody>
<tr>
<td><strong>Point to learn</strong></td>
<td><strong>Example</strong></td>
<td><strong>Remarks</strong></td>
</tr>
<tr>
<td><kbd>@</kbd> with Razor reserved keyword</td>
<td>
<p class="mce-root"><kbd>@model</kbd></p>
<kbd>@page</kbd></td>
<td>When an <kbd>@</kbd> symbol is followed by a Razor reserved keyword, it transitions into Razor-specific markup. Otherwise, it transitions into plain C#.</td>
</tr>
<tr>
<td>Escape <kbd>@</kbd> character</td>
<td>
<p class="mce-root"><kbd>&lt;span&gt;@@Name&lt;/span&gt;</kbd> is rendered in HTML as&#160;</p>
<kbd>&lt;span&gt;@Name&lt;/span&gt;</kbd></td>
<td><span>The HTML attributes and content containing email addresses don't treat&#160;</span><kbd>@</kbd><span><span>&#160;as a transition character.&#160;</span></span>To escape an<span>&#160;<kbd>@</kbd>&#160;</span><span>symbol in Razor markup, use a second</span><span>&#160;<kbd>@</kbd></span><span>&#160;</span><span>symbol.</span></td>
</tr>
<tr>
<td>Implicit Razor expression</td>
<td><kbd>&lt;p&gt;@DateTime.Now&lt;/p&gt;</kbd></td>
<td><kbd>@</kbd> followed by C# code.</td>
</tr>
<tr>
<td>Spaces not allowed</td>
<td><kbd><span>@DateTime.Now - TimeSpan.FromDays(2)</span></kbd></td>
<td>Rendered as <kbd>29/12/2017 – TimeSpan.FromDays(2)</kbd> as there are spaces between.</td>
</tr>
<tr>
<td>Generics are <em>not</em> supported</td>
<td><kbd><span>&lt;p&gt;@SomeMethod&lt;int&gt;()&lt;/p&gt;</span></kbd></td>
<td><kbd>&lt;&gt;</kbd> would be interpreted as an HTML tag, hence not supported in implicit expression.</td>
</tr>
<tr>
<td>Explicit Razor syntax</td>
<td><kbd>@(DateTime.Now.AddDays(1))</kbd></td>
<td>Any content inside <kbd>@()</kbd> brackets is evaluated and rendered to output.</td>
</tr>
<tr>
<td>Expression encoding</td>
<td><kbd><span>@("</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span>Hello DotNet 2.0 By Example</span><span class="hljs-tag x-hidden-focus">&lt;/<span class="hljs-name">span</span>&gt;</span><span>")</span></kbd></td>
<td>Renders the HTML as&#160;<span><kbd>&amp;lt;span&amp;gt;Hello DotNet 2.0 By Example&amp;lt;/span&amp;gt;</kbd>, which is shown in the browser as <kbd>&lt;span&gt;Hello DotNet 2.0 By Example&lt;/span&gt;</kbd>.</span></td>
</tr>
<tr>
<td>Without expression encoding</td>
<td>
<p class="mce-root"><kbd>@Html.Raw("&lt;span&gt; Hello .NET Core 2.0 &lt;/span&gt;")</kbd></p>
is rendered as <kbd>&lt;span&gt;Hello .NET Core 2.0&lt;/span&gt;</kbd></td>
<td>This results in security vulnerabilities such as malicious user input and cross site scripting and hence must be used with the utmost care. Make a rule of thumb to avoid using <kbd>@Html.Raw</kbd> unless you are 110% sure that it can under no circumstances compromise on security and would never be user input.</td>
</tr>
<tr>
<td>Razor code blocks</td>
<td>
<p class="mce-root"><kbd>@{</kbd></p>
<p class="mce-root"><kbd>ViewData["Title"] = "Let's Chat";</kbd></p>
<p class="mce-root"><kbd>}</kbd></p>
</td>
<td><span>Razor code blocks start with&#160;<kbd>@</kbd></span><span>&#160;and are enclosed by<kbd>&#160;{}</kbd></span><span>. Unlike expressions, C# code inside code blocks isn't rendered.&#160;</span></td>
</tr>
<tr>
<td>Explicit line transition</td>
<td>
<p class="mce-root"><kbd>@:Name: @User.Name</kbd></p>
would render as <kbd>Name: &lt;&lt;Value of User.Name&gt;&gt;</kbd></td>
<td>
<p><span>To render the rest of an entire line as HTML inside a code block, use the<kbd>&#160;@:</kbd>&#160;</span><span>syntax.</span></p>
</td>
</tr>
<tr>
<td><kbd>@If-else if-else</kbd></td>
<td>
<p class="mce-root"><kbd><span>@if (condition)</span><span>{</span></kbd></p>
<p class="mce-root"><kbd><span>}</span><span>else if (some condition)</span> <span>{</span></kbd></p>
<p class="mce-root"><kbd><span>} else {</span><span>&#160;}</span></kbd></p>
</td>
<td>
<p><kbd>@</kbd> is needed only before starting <kbd>if</kbd>.</p>
</td>
</tr>
<tr>
<td><kbd>@switch</kbd></td>
<td>
<p class="mce-root"><kbd>@switch(value)</kbd></p>
<kbd>{ case 1:break;default:break;}</kbd></td>
<td>
<p>Simple syntax for <kbd>switch</kbd> case.</p>
</td>
</tr>
<tr>
<td><kbd>@for</kbd></td>
<td><kbd><span>@for (var i = 0; i</span> <span class="hljs-tag">&lt; <span class="hljs-attr x-hidden-focus">array.Length</span>; <span class="hljs-attr">i</span>++){}</span></kbd></td>
<td>
<p>Use <kbd>@for</kbd>.</p>
</td>
</tr>
<tr>
<td><kbd>@foreach</kbd></td>
<td><kbd><span>@foreach (var item in array) {}</span></kbd></td>
<td>Use <kbd>@foreach</kbd>.</td>
</tr>
<tr>
<td><kbd>@while</kbd></td>
<td><kbd>@{var i=0;}</kbd>
<p class="mce-root"><kbd><span>@while (i</span> <span class="hljs-tag">&lt; <span class="hljs-attr">array.Length</span>) {}</span></kbd></p>
</td>
<td>
<p>Use <kbd>@while</kbd>.</p>
</td>
</tr>
<tr>
<td><kbd>@do while</kbd></td>
<td>
<pre class="mce-root">@{ var i = 0; }<br/>@do {<br/>  }while(i&lt; array.Length)</pre>
</td>
<td>
<p>Use <kbd>@do...while</kbd>.</p>
</td>
</tr>
<tr>
<td><kbd>@using</kbd></td>
<td>
<p class="mce-root"><kbd><span>@using (Html.BeginForm()) {</span></kbd></p>
<kbd>@* Entire form content *@}@using System.Linq</kbd></td>
<td>
<p class="mce-root">Used to create HTML helpers that contain additional content. The example renders a form tag.</p>
<p>Can also be used as a <kbd>using</kbd> directive and it adds the C# <kbd>using</kbd> directive to the generated view.&#160;</p>
</td>
</tr>
<tr>
<td><kbd>@try</kbd>, <kbd>catch</kbd>, <kbd>finally</kbd></td>
<td>
<p class="mce-root"><kbd>@try{}</kbd></p>
<p class="mce-root"><kbd>catch(Exception ex){}</kbd></p>
<p class="mce-root"><kbd>finally{}</kbd></p>
</td>
<td>
<p>use <kbd>@try</kbd> and similar to C# syntax.</p>
</td>
</tr>
<tr>
<td><kbd>@lock</kbd></td>
<td>
<p class="mce-root"><kbd>@lock(syncLock)</kbd></p>
<kbd>{// DO critical work here}</kbd></td>
<td>
<p>Same as C#, to protect the critical region. Use <kbd>@lock.</kbd></p>
</td>
</tr>
<tr>
<td>Comments</td>
<td>
<ul>
<li class="mce-root"><kbd>&lt;!-- HTML Comment--&gt;</kbd></li>
<li class="mce-root"><kbd>/* C# Comment */// C# comment</kbd></li>
<li class="mce-root"><kbd>@* Razor multiline comment *@</kbd></li>
</ul>
</td>
<td>
<p>Razor supports both HTML and C# comments.</p>
</td>
</tr>
<tr>
<td><kbd>@model</kbd></td>
<td><kbd>@model HomeViewModel</kbd></td>
<td>
<p><span>The&#160;<kbd>@model&#160;</kbd></span><span>directive specifies the type of the model passed to a view and is used extensively in strongly typed views.</span></p>
</td>
</tr>
<tr>
<td><kbd>@inherits</kbd></td>
<td>
<p class="mce-root"><kbd>@inherits BaseRazorPage</kbd></p>
Now the view will have access to all the protected and public properties, fields and methods of the&#160;<kbd>BaseRazorPage</kbd> class</td>
<td>
<p><kbd>@inherits</kbd>&#160;<span>directive provides full control of the class the view inherits.</span></p>
</td>
</tr>
<tr>
<td><kbd>@inject</kbd></td>
<td><kbd>@inject IHtmlLocalizer</kbd></td>
<td>
<p>The <kbd>@inject</kbd> directive&#160;<span>enables the Razor page to inject a service from the&#160;</span>service container<span>&#160;into a view.</span></p>
</td>
</tr>
<tr>
<td><kbd>@functions</kbd></td>
<td>
<pre class="mce-root">@functions { public string GetTime(){<br/>  return     DateTime.Now.ToString();<br/>}}</pre>
<kbd>&lt;div&gt; Current Time : @GetTime()&lt;/div&gt;</kbd></td>
<td>
<p>The <kbd>@functions</kbd><span>&#160;directive enables a Razor page to add function-level content to a view.</span></p>
</td>
</tr>
<tr>
<td><kbd>@section</kbd></td>
<td><kbd><span>@section Scripts {</span> <span class="hljs-tag">&lt;<span class="hljs-name x-hidden-focus">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"~/scripts/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span> <span>}</span></kbd></td>
<td>
<p>The <span><kbd>@section</kbd> directive is used in conjunction with the layout page to enable views to render contents in different parts of the HTML page such as&#160; header, footer, body, and so on.</span></p>
</td>
</tr>
</tbody>
</table>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Tag Helpers</h1>
                </header>
            
            <article>
                
<p class="mce-root"><span>Tag Helpers are a new feature introduced in ASP.NET Core that enables server-side code to participate in creating and rendering HTML elements in Razor files.&#160;Tag Helpers are C# classes that participate in view generation by manipulating HTML elements.&#160;By using Tag Helpers, we can add additional attributes to HTML elements, change the content, or replace them entirely. In simple terms, Tag Helper's code that helps us to build our <kbd>.cshtml</kbd> forms without needing to write Razor syntax. For example, if we were to write an anchor tag in Razor we would write it like:</span></p>
<p><kbd>@Html.ActionLink("Read my book", "Read", "Book")&#160;</kbd></p>
<p>where <kbd>Read</kbd> is the action in <kbd>Book</kbd> controller and the text between anchor tag would be <kbd>"Read my book"</kbd>. Using Tag Helper, it becomes very easy to write the same anchor tag as:</p>
<pre>&lt;a asp-action="Read" asp-controller="Book"&gt;Read my book&lt;/a&gt;</pre>
<p>This is both very easy to write as well as easy to understand, and looks more neat and easily maintainable as well, as it looks like HTML. Visual Studio has great tooling support for Tag Helpers and it highlights all the HTML elements that use Tag Helpers, thus making it easier to identify them and also provide rich intellisense to explore and use them as needed. Notice that all the Tag Helper attributes start with <kbd>asp-</kbd>&#160;and their naming is self-explanatory. There are a number of inbuilt Tag Helpers that come with the framework&#160;<span>and writing a new one is also pretty straightforward</span>. Let's have a quick look at a few inbuilt Tag Helpers and then we will conclude this discussion by creating one custom Tag Helper as well. The following table lists a few of the inbuilt Tag Helpers:</p>
<table>
<tbody>
<tr>
<td>
<p><strong>Tag Helper</strong></p>
</td>
<td>
<p><strong>Example</strong></p>
</td>
</tr>
<tr>
<td>
<p>Anchor</p>
</td>
<td>
<p class="mce-root"><kbd>&lt;a asp-action="Index" asp-controller="Home"&gt;Back to Home&lt;/a&gt;</kbd>&#160;anchor Tag Helper has few other properties that could be set, such as&#160;<kbd>asp-fragment</kbd>, <kbd>asp-route</kbd>, <kbd>asp-path</kbd>. This defines the anchor tag.&#160;</p>
</td>
</tr>
<tr>
<td>
<p>Label</p>
</td>
<td>
<p class="mce-root"><kbd>&lt;label asp-for="Name"&gt;&lt;/label&gt;</kbd>&#160;defines a label for a control.</p>
</td>
</tr>
<tr>
<td>
<p>Input</p>
</td>
<td>
<p class="mce-root"><kbd>&lt;input type="text" asp-for="Name"/&gt;</kbd></p>
<p>Earlier we used to have multiple Razor helpers for different types of input (<kbd>checkbox</kbd>, <kbd>select</kbd>, <kbd>radio</kbd>, <kbd>text</kbd>). Now we have just two helper attributes <kbd>asp-for</kbd> and <kbd>asp-format</kbd>.</p>
</td>
</tr>
<tr>
<td>
<p>Form</p>
</td>
<td>
<p class="mce-root"><kbd>&lt;form asp-action="Create" asp-anti-forgery="true" asp-controller="Person"&gt;&lt;/form&gt;</kbd></p>
<p><kbd>action</kbd> and <kbd>controller</kbd> are defined, as well as the <kbd>ValidateAntiForgeryToken</kbd> is taken care of ! Wonderful!</p>
</td>
</tr>
<tr>
<td>
<p>Text area</p>
</td>
<td><kbd>&lt;textarea asp-for="Description"&gt;&lt;/textarea&gt;</kbd>.</td>
</tr>
<tr>
<td>
<p>Select</p>
</td>
<td><kbd>&lt;select asp-for="SelectedBook" asp-items="Model.Books"&gt;&lt;/select&gt;</kbd>.</td>
</tr>
<tr>
<td>
<p>Image</p>
</td>
<td>
<p class="mce-root"><kbd>&lt;img src="~/content/images/image.png" alt="profile image" asp-append-version="true"/&gt;</kbd></p>
<p>Used for cache-busting the image as the Tag Helper appends the hash of the image as the query string parameter such as&#160;<kbd>&lt;img src="/content/images/image.png?v=Z6p6D366_nQ2fQqUso0F24gWy2ZekXjHz83WvYbaiOOk" alt="profile image"/&gt;</kbd>.</p>
</td>
</tr>
<tr>
<td>
<p>Cache</p>
</td>
<td>
<p class="mce-root"><kbd>&lt;cache expires-after="@TimeSpan.FromMinutes(5)"&gt;&lt;/cache&gt;&#160;</kbd></p>
<p>The content inside the <kbd>cache</kbd> tag is cached in server memory unless explicitly disabled.</p>
<p>&#160;</p>
</td>
</tr>
<tr>
<td>
<p>Link and Script</p>
</td>
<td>
<p class="mce-root">These are the most interesting Tag Helpers of the lot as they have cache busting as well as fallback mechanisms implemented in them, such as&#160;&#160;<kbd>&lt;link rel="stylesheet" href="//ajax.aspnetcdn.com/ajax/bootstrap/3.0.0/css/bootstrap.min.css" asp-fallback-href="~/lib/bootstrap/css/bootstrap.min.css" asp-fallback-test-class="hidden" asp-fallback-test-property="visibility" asp-fallback-test-value="hidden" /&gt;</kbd>.</p>
</td>
</tr>
<tr>
<td>
<p>Validation</p>
</td>
<td>
<p class="mce-root"><kbd>&lt;span asp-validation-for="Description"&gt;&lt;/span&gt;</kbd>.</p>
<p>&#160;</p>
</td>
</tr>
<tr>
<td>
<p>Environment</p>
</td>
<td>
<p class="mce-root"><kbd><span>&lt;environment names="Staging,Production"&gt;&lt;/environment&gt;</span></kbd><span>.</span></p>
<p>This is a special helper as contents of helper gets rendered only if the deployed environment name matches the names property of the Environment tag.&#160;</p>
</td>
</tr>
</tbody>
</table>
<p>As we can see, Tag Helpers provide a great boost in productivity while coding&#160;<kbd>.cshtml</kbd> files. The Visual Studio tooling with IntelliSense makes this experience even more efficient. In ASP.NET Core 2.0, Application Insights is also enabled by using a Tag Helper in the background. Next let's create a custom Tag Helper. Creating a custom Tag Helper needs these steps to be followed:</p>
<ol>
<li>Create a custom class which derives from the&#160;<kbd><span>Microsoft.AspNet.Razor.TagHelper.</span>TagHelper</kbd> class</li>
<li>Create the properties in the class to hold the attribute values</li>
<li>Restrict the Tag Helper to be applicable only to a certain type of HTML element by decorating the class with the&#160;<kbd>HtmlTargetElement</kbd> attribute</li>
<li>Override the <kbd>ProcessAsync</kbd> method and set the attributes as needed</li>
<li>Add a line to <kbd>_ViewImports.cshtml</kbd> for the Razor views to recognize the Tag Helpers</li>
</ol>
<p>Since we are not using <span>Tag Helpers&#160;</span>right now, we will not go into details, but as we can see, it's quite straightforward and easy. Now that we have visited the fundamentals of Razor syntax and Tag Helpers, we will quickly recap views.</p>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Views</h1>
                </header>
            
            <article>
                
<p>In the MVC pattern, a View is meant to display the application data to the user and handle user interaction. View helps us to implement the separation of concern design principle in MVC applications, by separating the user interface from business logic. It is an HTML page with additional Razor markup apart from the HTML markup, as we have seen earlier in this chapter. The <kbd>.cshtml</kbd> files are Views and treated as web pages. For example, if we create a simple MVC application, it creates a View under the <kbd>Views</kbd> folder and each View is associated with a controller. In the following example,&#160;<kbd>HomeController</kbd> is calling three Views—<kbd>Index</kbd>, <kbd>About</kbd>, and <kbd>Contact</kbd> . Inside the <kbd>Views</kbd>&#160;folder, we have a sub-folder with the controller name (<kbd>Home</kbd>) and this folder contains all views used in <kbd>HomeController</kbd>. This is shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/f98c1128-2b21-400b-aee0-c185593b741d.png"/></div>
<p>The most commonly used components of Views are:</p>
<ol>
<li><strong>Layouts</strong>: These are like the master page and are used to maintain consistency among all web pages. For example, we see common content used in all the pages such as header, footer, menu, and so on.</li>
<li><strong>Partial views</strong>: Partial Views are useful for re-usability. If we have some content which needs to be displayed in more than one screen, or if we have a page which doesn't have any logic or code to execute and has only content to display, we can have them as partial Views.</li>
<li><strong>View Components</strong>: These are similar to partial Views and help us to reuse the code, but the difference is that a partial View only binds the model, and View components can interact with data and business logic, as they have a mini controller. A common example of a View component is the shopping cart of any e-commerce website. It renders content using database interaction.<strong>&#160;</strong></li>
</ol>
<p class="mce-root">Next, we will look into a new feature introduced in ASP.NET Core 2.0 called Razor pages.</p>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Razor pages</h1>
                </header>
            
            <article>
                
<p>Razor pages are lightweight pages with the added functionality of handling requests directly without a controller. This makes them extremely useful to create a quick application, or a proof of concept or for presenting cool demonstrations to an audience. To make a View page into a Razor page, we need to add the&#160;<kbd>@page</kbd> directive. It should be the first directive on the page. For example:</p>
<pre>@page<br/>&lt;h1&gt;Hello from .NET Core 2.0 By Example&lt;/h1&gt;</pre>
<p>Razor pages are useful when we need a View with small logic. For smaller logic, the return on investment would be better for Razor pages than that for creating a controller, actions, and view. In Razor pages, we can add logic inside the page or we can simply create code behind <kbd>page.cshtml.cs</kbd>, to write code. The question that came to my mind is: <em>Are we moving forward, or moving back to the web form code-behind world?</em>.&#160;</p>
<p>Creating a Razor page is very simple. Right-click on the project and click <span class="packt_screen">Add</span>&#160;|&#160;<span class="packt_screen">New Item</span> and select <span class="packt_screen">Razor Page,</span> as shown here:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/d4e2acfa-8214-4f03-9c82-392698964287.png"/></div>
<p>In this example, the&#160;<kbd>DemoRazorPage.cshtml</kbd> has <kbd>DemoRazorPage.cshtml.cs</kbd> and <kbd><span>DemoRazorPageM</span>odel</kbd> associated with it. We can go ahead and write code as needed, without needing to worry about creating a controller, then its action&#160;methods, and finally adding a view in the specific location. Super productive!</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/92d9ff34-324d-4fea-bab5-9c08798c8f69.png"/></div>
<p>In the&#160; image, <kbd>DemoRazorPage.cshtml</kbd> file is the Razor page, and&#160;<kbd>DemoRazorPage.cshtml.cs</kbd> is the code behind the file of the Razor page, which uses <kbd>DemoRazorPageModel</kbd> as the model.</p>
<p class="mce-root">With this, we have touched upon all the basic and most frequently used features of ASP.NET Core. We will now move on to code the Chat hub module.</p>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Coding the Chat hub module</h1>
                </header>
            
            <article>
                
<p>Now let's code the Chat hub module for our Let's Chat web application. We have already seen how to create a simple real-time web application using SignalR, while developing a Tic-Tac-Toe game, so we would not spend much time on things we have already seen. Recall that we already have authentication implemented using Facebook and we have user details, such as the display name and profile picture. We need to develop the following as part of our Chat hub module:</p>
<ul>
<li>List all online users connected to the Chat hub</li>
<li>Update the online list of users, as and when someone joins or leaves the chat room</li>
<li>Any chat message sent in the room goes to all the connected users</li>
</ul>
<p>Quite clearly, to meet these requirements, we would need to track the users, so that a connected user shows in the online list and disappears from the list when they leave the chat room. We would first create a class named <kbd>UserInformation</kbd> to hold the user details such as <kbd>name</kbd>, display picture URL (<kbd>imageURL</kbd>), and <kbd>connection identifier</kbd>, as defined here:</p>
<pre>    /// &lt;summary&gt;<br/>    /// The class to hold the user information.<br/>    /// &lt;/summary&gt;<br/>    public class UserInformation<br/>    {<br/>        /// &lt;summary&gt;<br/>        /// Initializes a new instance of the &lt;see <br/>            cref="UserInformation"/&gt; class.<br/>        /// &lt;/summary&gt;<br/>        /// &lt;param name="connectionId"&gt;The connection identifier.<br/>            &lt;/param&gt;<br/>        /// &lt;param name="name"&gt;The name of user.&lt;/param&gt;<br/>        /// &lt;param name="imageUrl"&gt;The url of user's profile picture.<br/>            &lt;/param&gt;<br/>        public UserInformation(string connectionId, string name, string <br/>        imageUrl)<br/>        {<br/>            this.ConnectionId = connectionId;<br/>            this.Name = name;<br/>            this.ImageUrl = imageUrl;<br/>        }<br/><br/>        /// &lt;summary&gt;<br/>        /// Gets the image path of the user<br/>        /// &lt;/summary&gt;<br/>        public string ImageUrl { get; }<br/><br/>        /// &lt;summary&gt;<br/>        /// Gets the connection identifier.<br/>        /// &lt;/summary&gt;<br/>        public string ConnectionId { get; }<br/><br/>        /// &lt;summary&gt;<br/>        /// Gets the name of user.<br/>        /// &lt;/summary&gt;<br/>        public string Name { get; }<br/>    }</pre>
<p>Next, let's create an interface named <kbd>IUserTracker</kbd> with three methods for user tracking:</p>
<ul>
<li><strong>Get all online users</strong>: This would be used to display all the users that are connected to the chat</li>
<li><strong>Add user</strong>: This would be used to add a user-to-user tracker data store and should be called when a user joins the chat room</li>
<li><strong>Remove user</strong>:&#160;<span>This would be used to remove a user from the user tracker data store and should be called when a user leaves the chat room</span></li>
</ul>
<p>The code is as shown here and the comments should make the code comprehensive:</p>
<pre>    /// &lt;summary&gt;<br/>    /// Contract for user tracking.<br/>    /// &lt;/summary&gt;<br/>    public interface IUserTracker<br/>    {<br/>        /// &lt;summary&gt;<br/>        /// Gets all the online users (connected to chat hub)<br/>        /// &lt;/summary&gt;<br/>        /// &lt;returns&gt;A collection of online user information&lt;/returns&gt;<br/>        Task&lt;IEnumerable&lt;UserInformation&gt;&gt; GetAllOnlineUsersAsync();<br/>       <br/>        /// &lt;summary&gt;<br/>        /// Add user to User Tracker data store. This would be called <br/>            when a user joins the chat hub.<br/>        /// &lt;/summary&gt;<br/>        /// &lt;param name="connection"&gt;The hub connection context.<br/>            &lt;/param&gt;<br/>        /// &lt;param name="userInfo"&gt;The user information&lt;/param&gt;<br/>        /// &lt;returns&gt;The task.&lt;/returns&gt;<br/>        Task AddUserAsync(HubConnectionContext connection, <br/>        UserInformation userInfo);<br/><br/>        /// &lt;summary&gt;<br/>        /// Removes user from User Tracker data store. This would be <br/>            called when a user leaves the chat hub.<br/>        /// &lt;/summary&gt;<br/>        /// &lt;param name="connection"&gt;The hub connection context.<br/>            &lt;/param&gt;<br/>        /// &lt;returns&gt;The task.&lt;/returns&gt;<br/>        Task RemoveUserAsync(HubConnectionContext connection);<br/>    }</pre>
<p>We created an interface so that we could leverage Dependency Injection to inject the user tracking component, wherever we need it. Though we have worked with SignalR already, we have not come across the <kbd>HubConnectionContext</kbd> class, which we have used in the interface. So, let's have a quick look at it. The&#160;<kbd>HubConnectionContext</kbd> class resides in the&#160;<kbd>Microsoft.AspNetCore.SignalR.Core</kbd> assembly under the&#160;<kbd>Microsoft.AspNet.SignalR</kbd> namespace. It encapsulates all the information about a SignalR connection. The following code map diagram shows the <kbd>HubConnectionContext</kbd> class and its properties:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/10caa2c6-74e0-44c4-a67b-828e6bdf1b27.png"/></div>
<p>The code is as shown here:</p>
<pre>namespace Microsoft.AspNetCore.SignalR<br/>{<br/>    public class HubConnectionContext<br/>    {<br/>        public HubConnectionContext(WritableChannel&lt;HubMessage&gt; output, <br/>        ConnectionContext connectionContext);<br/><br/>        public virtual string ConnectionId { get; }<br/>        public virtual ClaimsPrincipal User { get; }<br/>        public virtual IFeatureCollection Features { get; }<br/>        public virtual IDictionary&lt;object, object&gt; Metadata { get; }<br/>        public virtual HubProtocolReaderWriter ProtocolReaderWriter {  <br/>        get; set; }<br/>        public virtual WritableChannel&lt;HubMessage&gt; Output { get; }<br/>    }<br/>}</pre>
<p>There would be an extension method to get the <kbd>HttpContext</kbd> from <kbd>HubConnectionContext</kbd>.</p>
<p>We use the <span><kbd>HubConnectionContext</kbd> class&#160;</span>to keep track of the user and connection in our <kbd>UserTracker</kbd> class, which we will implement next. Let's&#160;implement the <kbd>IUserTracker</kbd> interface in our <kbd>UserTracker</kbd> class, as shown here:</p>
<pre>    /// &lt;summary&gt;<br/>    /// The User Tracker class for tracking users that are connected to  <br/>        chat.<br/>    /// &lt;/summary&gt;<br/>    public class UserTracker : IUserTracker<br/>    {<br/>        /// &lt;summary&gt;<br/>        /// The private storage for keeping the track of online users <br/>            connected to chat hub.<br/>        /// We are going to register the User Tracker as singleton, so    <br/>            no need to make it as static as it would be resued once the   <br/>            class is initialized.<br/>        /// &lt;/summary&gt;<br/>        private readonly ConcurrentDictionary&lt;HubConnectionContext, <br/>        UserInformation&gt; onlineUserStore = new <br/>        ConcurrentDictionary&lt;HubConnectionContext, UserInformation&gt;();<br/><br/>        /// &lt;summary&gt;<br/>        /// Add user to User Tracker data store. This would be called <br/>            when a user joins the chat hub.<br/>        /// &lt;/summary&gt;<br/>        /// &lt;param name="connection"&gt;The hub connection context.<br/>            &lt;/param&gt;<br/>        /// &lt;param name="userInfo"&gt;The user information&lt;/param&gt;<br/>        /// &lt;returns&gt;The task.&lt;/returns&gt;<br/>        public async Task AddUserAsync(HubConnectionContext connection, <br/>        UserInformation userInfo)<br/>        {<br/>            //// Add the connection and user to the local storage.<br/>            onlineUserStore.TryAdd(connection, userInfo);<br/>            await Task.CompletedTask;<br/>        }<br/><br/>        /// &lt;summary&gt;<br/>        /// Gets all the online users (connected to chat hub)<br/>        /// &lt;/summary&gt;<br/>        /// &lt;returns&gt;A collection of online user information&lt;/returns&gt;<br/>        public async Task&lt;IEnumerable&lt;UserInformation&gt;&gt; <br/>        GetAllOnlineUsersAsync() =&gt; await <br/>        Task.FromResult(onlineUserStore.Values.AsEnumerable());<br/><br/>        /// &lt;summary&gt;<br/>        /// Removes user from User Tracker data store. This would be <br/>            called when a user leaves the chat hub.<br/>        /// &lt;/summary&gt;<br/>        /// &lt;param name="connection"&gt;The hub connection context.<br/>            &lt;/param&gt;<br/>        /// &lt;returns&gt;The task.&lt;/returns&gt;<br/>        public async Task RemoveUserAsync(HubConnectionContext <br/>        connection)<br/>        {<br/>            //// Remove the connection and user from the local storage.<br/>            if (onlineUserStore.TryRemove(connection, out var <br/>            userInfo))<br/>            {<br/>                await Task.CompletedTask;<br/>            }<br/>        }<br/>    }</pre>
<p>With this, our user tracker component is created. It has a backup store (concurrent dictionary), where we will add the connection and user details when a user joins the chat room, and remove the entry from it when the user leaves the chat room. We can keep the concurrent dictionary as <kbd>static</kbd> as well, but we will use dependency registration to register our <kbd>UserTracker</kbd> class as a singleton, so we can be sure that the same instance of class would be used for all the user connections. To register our <kbd>UserTracker</kbd> as a singleton, we would write the following lines of code in the <kbd>ConfigureServices</kbd> method of the&#160;<kbd>Startup.cs</kbd> class:</p>
<pre>//// Register IUserTracker as singleton.<br/>services.AddSingleton(typeof(IUserTracker), typeof(UserTracker));<br/><br/>services.AddSignalR();   //// Adds SignalR goodness in the container.  </pre>
<p>Next, we will code the Chat hub, which will use the <kbd>UserTracker</kbd> class, and SignalR goodness to complete our chat room.&#160; To do so, let's create a class named <kbd>ChatHub</kbd>&#160;derived from the&#160;<kbd>Hub</kbd> class, with the following code:</p>
<pre>    /// &lt;summary&gt;<br/>    /// The Chat hub class.<br/>    /// &lt;/summary&gt;<br/>    [Authorize]<br/>    public class ChatHub : Hub<br/>    {<br/>        /// &lt;summary&gt;<br/>        /// The user tracker to keep track of online users.<br/>        /// &lt;/summary&gt;<br/>        private IUserTracker userTracker;<br/><br/>        /// &lt;summary&gt;<br/>        /// Initializes a new instance of the &lt;see cref="ChatHub"/&gt; <br/>            class.<br/>        /// &lt;/summary&gt;<br/>        /// &lt;param name="userTracker"&gt;The user tracker.&lt;/param&gt;<br/>        public ChatHub(IUserTracker userTracker) <br/>        {<br/>            this.userTracker = userTracker;<br/>        }<br/>    }</pre>
<p>There are important points to note here:</p>
<ol>
<li>The class <kbd>ChatHub</kbd> derives from the&#160;<kbd>Microsoft.AspNetCore.SignalR.Hub</kbd> class.</li>
<li>The class <kbd>ChatHub</kbd> is decorated with the&#160;<kbd>[Authorize]</kbd> attribute, which means only an authenticated and authorized user can access the hub.</li>
<li>The constructor of <kbd>ChatHub</kbd> uses <kbd>IUserTracker</kbd> as a dependency, which would be injected through Dependency Injection.</li>
</ol>
<p>The&#160;<span><kbd>Microsoft.AspNetCore.SignalR.Hub</kbd> class has a property called <kbd>Context</kbd> of type <kbd>HubCallerContext</kbd>, which contains the SignalR connection identifier, user claim information, and <kbd>HubConnectionContext</kbd>. We can leverage the <kbd>Context</kbd> property to extract the user information from our Chat hub. To do so, we would need a helper/extension method, which takes in <kbd>HubCallerContext</kbd> and returns the <kbd>UserInformation</kbd> object that we created earlier. The following code snippet shows a helper class, which contains a method to translate the <kbd>HubCallerContext</kbd> to <kbd>UserInformation</kbd></span>:</p>
<pre>    /// &lt;summary&gt;<br/>    /// The Helper class.<br/>    /// &lt;/summary&gt;<br/>    public static class Helper<br/>    {<br/>        /// &lt;summary&gt;<br/>        /// Gets the user information from the Hub caller context.<br/>        /// &lt;/summary&gt;<br/>        /// &lt;param name="context"&gt;The Hub Caller Context.&lt;/param&gt;<br/>        /// &lt;returns&gt;The user Information.&lt;/returns&gt;<br/>        public static UserInformation <br/>        GetUserInformationFromContext(HubCallerContext context)<br/>        {<br/>            Claim nameIdentifierClaim = <br/>            context.User.Claims.FirstOrDefault(j =&gt; j.Type ==   <br/>            "http://schemas.xmlsoap.org/ws/2005/05/<br/>            identity/claims/nameidentifier")<br/>            ; //// Make it a constant.<br/>            var userId = nameIdentifierClaim.Value; //// Get user Id.<br/>            var imageUrl = <br/>            $"https://graph.facebook.com/{userId}/picture?type=square"; <br/>            //// Get FB image.<br/>            return new UserInformation(context.ConnectionId, <br/>            context.User.Identity.Name, imageUrl);<br/>        }<br/>    }</pre>
<p>With this structure, we are now in a position to track online users, as and when they join or leave our chat room, by overriding the <kbd>OnConnectedAsync</kbd> and <kbd>OnDiconnectedAsync</kbd> virtual methods, which are exposed by the&#160;<span><kbd>Microsoft.AspNetCore.SignalR.Hub</kbd> class. We would also need to add an additional method to fetch a list of all the connected users. We can do this easily by writing the following code in our <kbd>ChatHub</kbd> class:</span></p>
<pre>        /// &lt;summary&gt;<br/>        /// Gets all the connected user list.<br/>        /// &lt;/summary&gt;<br/>        /// &lt;returns&gt;The collection of online users.&lt;/returns&gt;<br/>        public async Task&lt;IEnumerable&lt;UserInformation&gt;&gt; <br/>        GetOnlineUsersAsync()<br/>        {<br/>            return await userTracker.GetAllOnlineUsersAsync();<br/>        }<br/><br/>        /// &lt;summary&gt;<br/>        /// Fires on client connected.<br/>        /// &lt;/summary&gt;<br/>        /// &lt;returns&gt;The task.&lt;/returns&gt;<br/>        public override async Task OnConnectedAsync()<br/>        {<br/>            var user = Helper.GetUserInformationFromContext(Context);<br/>            await this.userTracker.AddUserAsync(Context.Connection, <br/>            user);<br/>            await Clients.All.InvokeAsync("UsersJoined", new <br/>            UserInformation[] { user });<br/>            //// On connection, refresh online list.<br/>            await Clients.All.InvokeAsync("SetUsersOnline", await <br/>            GetOnlineUsersAsync());<br/>           <br/>            await base.OnConnectedAsync();<br/>        }<br/><br/>        /// &lt;summary&gt;<br/>        /// Fires when client disconnects.<br/>        /// &lt;/summary&gt;<br/>        /// &lt;param name="exception"&gt;The exception.&lt;/param&gt;<br/>        /// &lt;returns&gt;The task.&lt;/returns&gt;<br/>        public override async Task OnDisconnectedAsync(Exception <br/>        exception)<br/>        {<br/>            var user = Helper.GetUserInformationFromContext(Context);<br/>            await Clients.All.InvokeAsync("UsersLeft", new <br/>            UserInformation[] { user });<br/>            await this.userTracker.RemoveUserAsync(Context.Connection);<br/>            //// On disconnection, refresh online list.<br/>            await Clients.All.InvokeAsync("SetUsersOnline", await <br/>            GetOnlineUsersAsync());<br/>            await base.OnDisconnectedAsync(exception);<br/>        }<br/>       <br/>        /// &lt;summary&gt;<br/>        /// Sends the message to all the connected clients.<br/>        /// &lt;/summary&gt;<br/>        /// &lt;param name="message"&gt;The message to be sent.&lt;/param&gt;<br/>        /// &lt;returns&gt;A task.&lt;/returns&gt;<br/>        public async Task Send(string message)<br/>        {<br/>            UserInformation user = <br/>            Helper.GetUserInformationFromContext(Context);<br/>            await Clients.All.InvokeAsync("Send", user.Name, message, <br/>            user.ImageUrl);<br/>        }</pre>
<p>The code is simple to understand. However, for the sake of clarity and completeness, we will do a quick walk-through of the preceding code. There are four methods:</p>
<ul>
<li><kbd>GetOnlineUsersAsync</kbd>: This method returns all the online users as stored in the&#160;<kbd>UserTracker</kbd> store. This method would be used to display online users in the chat room page.</li>
<li><kbd>OnConnectedAsync</kbd>: This method is fired when a user connects to the Chat hub, that is, joins the chat room. In this method, we first fetch the user information by calling the <kbd>Helper</kbd> class method,&#160;<kbd>GetUserInformationFromContext,</kbd>&#160;passing the <kbd>Context</kbd> property of hub, which contains information about the current connection. After getting the user information, we add the connection and user information in the <kbd>UserTracker</kbd> store. Next, we need to notify all connected clients that a new user is now available for chat, so we fire the&#160;<kbd>UsersJoined</kbd> method on all the clients. We will see this method in a short while. This method takes an array of <kbd>UserInformation</kbd> as a parameter. This way, we can display to all the connected clients that a new user has joined the chat room. Finally, we need to update the list displaying the online users, so we invoke the client method,&#160;<kbd>SetUsersOnline</kbd>, on all the connected clients, passing in the list of connected users.&#160;</li>
<li><kbd>OnDisconnectedAsync</kbd>: This method is the exact opposite of the&#160;<kbd>OnConnectedAsync</kbd> method and&#160;<span>is fired when a user disconnects from the Chat hub, that is, leaves the chat room. In this method, we first fetch the user information by calling the <kbd>Helper</kbd> class method,&#160;</span><span><kbd>GetUserInformationFromContext</kbd></span>, <span>passing the <kbd>Context</kbd> property of hub, which contains information about the current connection. After getting the user information,&#160;we need to notify all the connected clients that the user is no longer available for chat, so we fire the&#160;<kbd>UsersLeft</kbd> method on all the clients. We will see this method in a short while. This method takes an array of <kbd>UserInformation</kbd> as a parameter. This way, we can display to all the connected clients that a user has left the chat room.&#160;Next, we remove the connection and user information from the <kbd>UserTracker</kbd> store. Finally, we need to update the list displaying the online users, so we invoke the client method,&#160;<kbd>SetUsersOnline</kbd></span>, <span><span>on all the connected clients, passing in a list of connected users.&#160;</span></span></li>
<li><kbd>Send</kbd>: The last method that we see is called <kbd>Send</kbd>. As the name suggests, this method is used to send the message to all the connected clients, along with the username and image URL. In this method, we first get the user information from the <kbd>Context</kbd> like we did in the preceding methods, and then invoke the client method,&#160;<kbd>Send</kbd>, on all connected clients, passing in the username and image URL of the user who has typed the message. We will see the details of the&#160;<kbd>Send</kbd> method shortly, when we explore client-side methods.</li>
</ul>
<p>We will wrap our server-side coding of the Chat hub by configuring the HTTP pipeline to intercept and map any request having <kbd>chatHub</kbd> to our <kbd>ChatHub</kbd> class. To do so, we will write the following code in the <kbd>Configure</kbd> method of <kbd>Startup.cs</kbd> between <kbd>app.UseAuthentication</kbd> and <kbd>app.UseMvc</kbd>:</p>
<pre>//// Use - SignalR &amp; let it know to intercept and map any request having chatHub.<br/>app.UseSignalR(routes =&gt;<br/>{<br/>   routes.MapHub&lt;ChatHub&gt;("chatHub");<br/>});</pre>
<p class="mce-root">This wraps up our server-side coding. Next, we will look at the client-side coding that we will do in our View.&#160; The user interface code is quite straightforward and so we will not go into details. The reader can browse the source code and see the user interface code and the used <kbd>.css</kbd> classes. We will look at the client-side JavaScript code that would be needed to complete the chat room experience. As a matter of best practice, all the JavaScript/jQuery coding should be done in a separate <kbd>.js</kbd> file and referenced in the View. For the sake of simplicity, I shall be showing the inline JavaScript in the View itself. So let's code the client-side stuff:</p>
<p>We begin by ensuring that the following references for CSS and JavaScript are present in the&#160;<kbd>_Layout.cshtml</kbd> file, so that they would be available in our View as well:</p>
<pre>&lt;script src="~/lib/jquery/dist/jquery.js"&gt;&lt;/script&gt;<br/>&lt;link href="~/css/site.css" rel="stylesheet" /&gt;<br/>&lt;script src="~/js/signalr-client-1.0.0-alpha1-final.js"&gt;&lt;/script&gt;<br/>&lt;script src="~/js/signalr-clientES5-1.0.0-alpha1-final.js"&gt;&lt;/script&gt;<br/>&lt;script src="~/js/signalr-msgpackprotocol-1.0.0-alpha1-final.js"&gt;&lt;/script&gt;</pre>
<p class="mce-root">In the <kbd>Index.cshtml</kbd> of our <kbd>HomeController</kbd> class, create a <kbd>&lt;script&gt;</kbd> node and initialize the SignalR hub connection in the bottom of the page as shown here:</p>
<pre>&lt;script type="text/javascript"&gt;<br/>    let hubUrl = '/chatHub';<br/>    let httpConnection = new signalR.HttpConnection(hubUrl);<br/>    let hubConnection = new signalR.HubConnection(httpConnection);<br/>&lt;/script&gt;</pre>
<p>Next, we need to define the following methods that we saw previously, while doing the server side coding:</p>
<ul>
<li><kbd>SetUsersOnline</kbd>: This method displays connected users in the left panel.</li>
<li><kbd>UsersJoined</kbd>: This method is fired when a user joins the chat room. This method displays information to the effect that the user has joined the room.</li>
<li><kbd>UsersLeft</kbd>: This method is fired when a user leaves the chat room. This method displays information to the effect that the user has left the room.</li>
<li><kbd>Send</kbd>: This method is called when a user types a message and clicks on the <kbd>Send</kbd> button.&#160;</li>
</ul>
<p>The pseudo code for the preceding methods is as follows. The detailed and complete code can be seen from the source code repository URL (<a href="https://github.com/PacktPublishing/.NET-Core-2.0-By-Example">https://github.com/PacktPublishing/.NET-Core-2.0-By-Example</a>) shared with the book:</p>
<pre> hubConnection.on('SetUsersOnline', usersOnline =&gt; {<br/>        if (usersOnline.length &gt; 0) {<br/>            $('#onlineUsers').innerText = '';<br/>            $.each(usersOnline, function (i, user) {<br/>                //// Display users in the panel.<br/>            });<br/>        }<br/>    });<br/><br/>    hubConnection.on('UsersJoined', users =&gt; {<br/>        if (users != null &amp;&amp; typeof (users) != undefined) {<br/>            appendLine(users.name + ' joined the chat room', 'green');<br/>            //// Display that user joined the chat room.<br/>        }<br/>    });<br/><br/>    hubConnection.on('UsersLeft', users =&gt; {<br/>        if (users != null &amp;&amp; typeof (users) != undefined) {<br/>            appendLine(users.name + ' left the chat room', 'red');<br/>            //// Display that user left the chat room.<br/>            document.getElementById(users.connectionId).outerHTML = '';<br/>        }<br/>    });</pre>
<div class="mce-root packt_tip">While doing any client-side development or any web page/View design using Bootstrap, you can make use of Bootstrap theme sites such as&#160;<a href="https://bootswatch.com/default/">https://bootswatch.com/default/</a>, which gives the preceding code as needed, and can be used with minimal changes. We can spin up a web page or a complete site in a matter of hours. Do try it out! It's very handy!&#160;</div>
<p>Once we are done with the user interface and client-side coding, our Let's Chat application is ready to be used. Let's run the application. This is what the user interface of the Let's Chat application looks like:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/90af6620-da31-48e7-8ad8-3d3479e13857.png"/></div>
<p>Let's look at it from top to bottom:</p>
<ol>
<li>It recognizes the logged in user and hence is able to display <span class="packt_screen">Hello <kbd>{User Name}</kbd></span> (<span class="packt_screen">Rishabh Verma</span> in the screenshot), so our authentication module is working fine.</li>
<li>On the left, it displays <span class="packt_screen">Online Users</span>, which lists just one name, so it is able to track users that are connected to the chat room.</li>
<li>In the Chat area, we can see&#160;<span class="packt_screen"><span class="packt_screen">Rishabh Verma</span> joined the chat room</span>, <span class="packt_screen"><span class="packt_screen">Neha Shrivastava</span> joined the chat room</span>, so our <kbd>IUserTracker</kbd> class is working fine in conjunction with the authentication module.</li>
<li>The Facebook profile pictures of users display with their message.</li>
<li>It also displays text if a user leaves the chat room.&#160;</li>
</ol>
<p>With this, our Let's Chat application code is complete. Next, we will do unit testing to ensure that issues or bugs in the code are caught at the time of development itself, and we thus ship and deploy a quality product. In the process, we will also learn about testing with reference to ASP.NET Core 2.0.</p>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Testing overview</h1>
                </header>
            
            <article>
                
<p>The famous Java programmer, Bruce Eckel, come up with a slogan which highlights the importance of testing software:</p>
<div class="packt_quote">If it ain't tested, it's broken.</div>
<p>Though a confident programmer may challenge this, it beautifully highlights the ability to determine that code works as expected over and over again, without any exception.&#160;How do we know that the code that we are shipping to the end user or customer is of good quality and all the user requirements would work? By testing? Yes, by testing, we can be confident that the software works as per customer requirements and specifications. If there are any discrepancies between expected and actual behavior, it is referred to as a bug/defect in the software.&#160;<span>The earlier the discrepancies are caught, the more easily they</span>&#160;can be fixed before the software is shipped; and the results is good quality. No wonder&#160; software testers are also referred to as quality control analysts in various software firms. The mantra for a good software tester would be:</p>
<div class="packt_quote">In God we trust, the rest we test.</div>
<p>We will not go into types of testing in any depth, as that would make another chapter in itself. We will look at them briefly, and then write our unit tests, which every good developer should write after writing any software program. Software testing is conducted at various levels:</p>
<ul>
<li><strong>Unit testing</strong>: While coding, the developer conducts tests on a unit of a program to validate that the code they have written is error-free. We will write a few unit tests shortly.</li>
<li><strong>Integration testing</strong>: In a team where a number of developers are working, there may be different components that the developers are working on. Even if all developers perform unit testing and ensure that their units are working fine, there is still a need to ensure that, upon integration of these components, they work without any error. This is achieved through integration testing.</li>
<li><strong>System testing</strong>: The entire software product is tested as a whole. This is accomplished using one or more of the following:
<ul>
<li><strong>Functionality testing</strong>: Test all the functionality of the software against the business requirement document.</li>
<li><strong>Performance testing</strong>: To test how performant the software is. It tests the average time, resource utilization, and so on, taken by the software to complete a desired business use case. This is done by means of load testing and stress testing, where the software is put under high user and data load.</li>
<li><strong>Security testing</strong>: Tests how secure the software is against common and well-known security threats.&#160;</li>
<li><strong>Accessibility testing</strong>: Tests if the user interface is accessible and user-friendly to specially-abled people or not.</li>
</ul>
</li>
<li><strong>User acceptance testing</strong>: When the software is ready to be handed over to the customer, it goes through a round of testing by the customer for user interaction and response.&#160;</li>
<li><strong>Regression testing</strong>: Whenever a piece of code is added/updated in the software to add a new functionality or fix an existing functionality, it is tested to detect if there are any side-effects from the newly added/updated code.&#160;</li>
</ul>
<p>Of all these different types of testing (and many more not listed here), we would focus on unit testing, as that is done by the developer coding the functionality.</p>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Unit testing</h1>
                </header>
            
            <article>
                
<p>.NET Core has been designed with testability in mind. .NET Core 2.0 has unit test project templates for VB, F#, and C#. We can also pick the testing framework of our choice amongst xUnit, NUnit, and MSTest.</p>
<p>Unit tests that test single programming parts are the most minimal-level tests. Unit tests should just test code inside the developer's control, and ought to not test infrastructure concerns, for example databases, filesystems, or network resources. Unit tests might be composed utilizing <strong>test-driven development</strong> (<strong>TDD</strong>) or they can be added to existing code to affirm its accuracy. The naming convention of <kbd>Test</kbd> class names should end with <kbd>Test</kbd>&#160;and reside in the same namespace as the class being tested. For instance, the unit tests for the&#160;<kbd>Microsoft.Example.AspNetCore</kbd> class would be in the&#160;<kbd>Microsoft.Example.AspNetCoreTest</kbd> class in the test assembly. Also, unit test method names must be descriptive about&#160;<em>what is being tested</em>,&#160;<em>under what conditions</em>, and&#160;<em>what the expectations are</em>.&#160;A good unit test has three main parts to it in the following specified order:</p>
<ol>
<li>Arrange</li>
<li>Act</li>
<li>Assert</li>
</ol>
<p>We first arrange the code and then act on it and then do a series of asserts to check if the actual output matches the expected output. Let's have a look at them in detail:</p>
<ol>
<li><strong>Arrange:&#160;</strong>All the parameter building, and method invocations needed for making a call in the act section must be declared in the arrange section.</li>
<li><strong>Act:</strong> <span>The act stage should be one statement and as simple as possible. This one statement should be a call to the method that we are trying to test.</span></li>
<li><strong>Assert:</strong> <span>The only reason method invocation may fail is if the method itself throws an exception, e</span><span>lse,</span><span><span>&#160;there should always be some state change or output from any meaningful method invocation. When we write the act statement, we anticipate an output and then do assertions if the actual output is the same as expected. If the method under test should throw an exception under normal circumstances, we can do assertions on the type of exception and the error message that should be thrown.</span></span></li>
</ol>
<div class="packt_tip">We should be watchful, while writing unit test cases, that we don't inject any dependencies on the infrastructure. Infrastructure dependencies should be taken care of in integration test cases, not in unit tests. We can maintain a strategic distance from these shrouded dependencies in our application code by following the Explicit Dependencies Principle and utilizing Dependency Injection to request our dependencies on the framework. We can likewise keep our unit tests in a different project from our integration tests and guarantee our unit test project doesn't have references to the framework.</div>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Testing using xUnit</h1>
                </header>
            
            <article>
                
<p>In this section we will learn to write unit and integration tests for our controllers. There are a number of options available to us for choosing the test framework. We will use xUnit for all our unit tests and Moq for mocking objects. Let's create a xUnit test project by doing the following:</p>
<ol>
<li>Open the Let's Chat project in Visual Studio 2017</li>
<li>Create a new folder named&#160; <kbd>Test</kbd></li>
<li>Right-click the <kbd>Test</kbd> folder and click <span class="packt_screen">Add</span>&#160;|&#160;<span class="packt_screen">New Project</span></li>
<li>Select <span class="packt_screen">xUnit Test Project (.NET Core)</span> under <span class="packt_screen">Visual C#</span> project templates, as shown here:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/ecbd02c7-afd6-459a-a477-222ab220deb5.png"/></div>
<ol start="5">
<li>Delete the default test class that gets created with the template</li>
<li>Create a test class inside this project&#160;<kbd>AuthenticationControllerUnitTests</kbd> for the unit test</li>
</ol>
<p>We need to add some NuGet packages. Right-click the project in VS 2017 to edit the project file and add the references manually, or use the NuGet Package Manager to add these packages:</p>
<pre><span>// This package contains dependencies to ASP.NET Core <br/>&lt;PackageReference Include="Microsoft.AspNetCore.All" Version="2.0.0" /&gt;<br/>// This package is useful for the integration testing, to build a test host for the project to test.<br/></span><span>&lt;PackageReference Include="Microsoft.AspNetCore.TestHost" Version="2.0.0" /&gt;<br/>// Moq is used to create fake objects<br/>&lt;PackageReference Include="Moq" Version="4.7.63" /&gt;</span></pre>
<p>With this, we are now ready to write our unit tests. Let's start doing this, but before we do that, here's some quick theory about xUnit and Moq.&#160;</p>
<p><span>The documentation from the xUnit website and Wikipedia&#160;tells us that xUnit.net is a free, open source, community-focused unit testing tool for the .NET Framework. It is the latest technology for unit testing C#, F#, Visual Basic .NET, and other .NET languages.&#160;</span>All xUnit frameworks share the following basic component architecture:</p>
<ul>
<li><span class="mw-headline"><strong>Test runner</strong>: It</span><span>&#160;</span>is an executable program that runs tests implemented using an<span>&#160;</span>xUnit<span>&#160;</span>framework and reports the test results.</li>
<li><strong>Test case</strong>: It<span>&#160;</span><span>is the most elementary class. All unit tests are inherited from here.</span></li>
<li><strong>T<span class="mw-headline">est fixtures:</span></strong><span>&#160;Test fixures&#160;</span><span>(also known as a test context) are the set of</span><span>&#160;</span><span>preconditions</span><span>&#160;</span><span>or state needed to run a test. The developer should set up a known good state before the tests, and return to the original state after the tests.</span></li>
<li><strong>Test suites:</strong> It<span>&#160;</span><span>is a set of tests that all share the same fixture. The order of the tests shouldn't matter.</span></li>
</ul>
<p>xUnit.net includes support for two different major types of unit test:&#160;</p>
<ol>
<li><strong>Facts</strong>:<em>&#160;</em>Tests which are always true. They test invariant conditions, that is, data-independent tests.</li>
<li><strong>Theories</strong>: Tests which are only true for a particular set of data<em>.</em></li>
</ol>
<p><strong>Moq</strong>&#160;is&#160;<span>a mocking framework for C#/.NET. It is used in unit testing to isolate the class under test from its dependencies, and ensure that the proper methods on the dependent objects are being called.&#160;</span></p>
<p>Recall that in unit tests, we only test a unit or a layer/part of the software in isolation and hence do not bother about external dependencies, so we assume they work fine and just mock them using the mocking framework of our choice.</p>
<p>Let's put this theory into action by writing a unit test for the following action in <kbd>AuthenticationController</kbd>:</p>
<pre>    public class AuthenticationController : Controller<br/>    {<br/>        private readonly ILogger&lt;AuthenticationController&gt; logger;<br/><br/>        public <br/>        AuthenticationController(ILogger&lt;AuthenticationController&gt; <br/>        logger)<br/>        {<br/>            this.logger = logger;<br/>        }<br/><br/>        [Route("signin")]<br/>        public IActionResult SignIn()<br/>        {<br/>            logger.LogInformation($"Calling {nameof(this.SignIn)}");<br/>            return Challenge(new AuthenticationProperties { RedirectUri <br/>            = "/" });<br/>        }<br/>    }</pre>
<p class="mce-root">The unit test code depends on how the method to be tested is written. To understand this, let's write a unit test for a&#160;<kbd>SignIn</kbd> action. To test the&#160;<kbd>SignIn</kbd> method, we need to invoke the&#160;<kbd>SignIn</kbd> action in <kbd>AuthenticationController</kbd>. To do so, we need an instance of the&#160;<kbd>AuthenticationController</kbd> class, on which the&#160;<kbd>SignIn</kbd> action can be invoked. To create the instance of <kbd>AuthenticationController</kbd>, we need a logger object, as the <kbd>AuthenticationController</kbd> constructor expects it as a parameter. Since we are only testing the&#160;<kbd>SignIn</kbd> action, we do not bother about the logger and so we can mock it. Let's do it:&#160;</p>
<pre>    /// &lt;summary&gt;<br/>    /// Authentication Controller Unit Test - Notice the naming <br/>        convention {ControllerName}Test<br/>    /// &lt;/summary&gt;<br/>    public class AuthenticationControllerTest<br/>    {<br/>        /// &lt;summary&gt;<br/>        /// Mock the dependency needed to initialize the controller.<br/>        /// &lt;/summary&gt;<br/>        private Mock&lt;ILogger&lt;AuthenticationController&gt;&gt; mockedLogger = <br/>        new Mock&lt;ILogger&lt;AuthenticationController&gt;&gt;();<br/><br/>        /// &lt;summary&gt;<br/>        /// Tests the SignIn action.<br/>        /// &lt;/summary&gt;<br/>        [Fact]<br/>        public void SignIn_Pass_Test()<br/>        {<br/>            // Arrange - Initialize the controller. Notice the mocked <br/>               logger object passed as the parameter.<br/>            var controller = new <br/>            AuthenticationController(mockedLogger.Object);<br/><br/>            // Act - Invoke the method to be tested.<br/>            var actionResult = controller.SignIn();<br/><br/>            // Assert - Make assertions if actual output is same as <br/>               expected output.<br/>            Assert.NotNull(actionResult);<br/>            Assert.IsType&lt;ChallengeResult&gt;(actionResult);           <br/>            Assert.Equal(((ChallengeResult)actionResult).    <br/>            Properties.Items.Count, 1);<br/>        } <br/>    }</pre>
<p class="mce-root">Reading the comments would explain the unit test code. The previous example shows how easy it is to write a unit test. Through depending upon the method to be tested, things can get complicated, but most of it would be around mocking the objects and, with some experience on the mocking framework and binging around, mocking should not be a difficult task. The unit test for the <kbd>SignOut</kbd> action would be a bit complicated in terms of mocking as it uses <kbd>HttpContext</kbd>. The unit test for the <kbd>SignOut</kbd> action is left to the reader as an exercise. Let's explore a new feature introduced in Visual Studio 2017 called Live Unit Testing.</p>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Live Unit Testing</h1>
                </header>
            
            <article>
                
<p>It may disappoint you but <strong>Live Unit Testing</strong> (<strong>LUT</strong>) is available only in the Visual Studio 2017 Enterprise edition and not in the Community edition. What is Live Unit Testing? It's a new productivity feature, introduced in the Visual Studio 2017 Enterprise edition,&#160;<span>that provides real-time feedback directly in the Visual Studio editor on how code changes are impacting unit tests and code coverage. All this happens live, while you write the code and hence it is called Live Unit Testing. This will help in maintaining the quality by keeping tests passing as changes are made. It will also remind us when we need to write additional unit tests, as we are making bug fixes or adding features.</span></p>
<p><span>To start Live Unit Testing:</span></p>
<ol>
<li>Go to the <span class="packt_screen">Test</span> menu item</li>
<li>Click <span class="packt_screen">Live Unit Testing</span></li>
<li>Click <span class="packt_screen">Start,</span> as shown here:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="241" width="411" src="assets/7fff37d1-b81e-4220-8dc7-74cd10389323.png"/></div>
<p>On clicking this, your CPU usage may go higher as Visual Studio spawns the MSBuild and tests runner processes in the background. In a short while, the editor will display the code coverage of the individual lines of code that are covered by the unit test. The following image displays the lines of code in&#160;<kbd>AuthenticationController</kbd> that are covered by the unit test. On clicking the right icon, it displays the tests covering this line of code and also provides the option to run and debug the test:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/e66530b5-25c2-41af-bb11-b5b9327bbbd0.png"/></div>
<p>Similarly, if we open the test file, it will show the indicator there as well. Super cool, right!</p>
<p>If we navigate to <span class="packt_screen">Test|</span><span class="packt_screen">Live Unit Testing</span> now, we would see the options to <span class="packt_screen">Stop</span> and <span class="packt_screen">Pause</span>. So, in case we wish to save&#160; our resources after getting the data once, we can pause or stop Live Unit Testing:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/24ba706b-894e-47a2-a1f0-0e6b2fa9501e.png"/></div>
<p>There are numerous icons which indicates the code coverage status of individual lines of code. These are:</p>
<ul>
<li><strong>Red cross</strong>: Indicates that the line is covered by at least one failing test</li>
</ul>
<div class="CDPAlignCenter CDPAlign"><img src="assets/deaba7b9-0b62-4972-a9da-b408d0954e11.png"/></div>
<ul>
<li><strong>Green check mark</strong>: Indicates that the line is covered by only passing tests</li>
</ul>
<div class="CDPAlignCenter CDPAlign"><img src="assets/9cc0d169-5bd9-4ed4-ba31-f6c14f26bfa0.png"/></div>
<ul>
<li><strong>Blue dash</strong>: Indicates that the line is not covered by any test</li>
</ul>
<div class="CDPAlignCenter CDPAlign"><img src="assets/2f63d887-8e5b-4df0-8760-8a49a140bfea.png"/></div>
<p class="mce-root">If you see a clock-like icon just below any of these icons, it indicates that the data is not up to date. With this productivity enhancing feature, we conclude our discussion on basic unit testing. Next we will learn about containers and how we can do the deployment and testing of our .NET Core 2.0 applications in containers.</p>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Introduction to containers</h1>
                </header>
            
            <article>
                
<p>Think of a container as just another process running in the machine; it's just that they offer a lot more isolation than a normal process does. So, we define a container as an isolated process. A container can have its own filesystem, own network IP address, own hostname, own registry, own unique resources and so on. A question that would come to mind is:&#160;<em>Why Containers?</em>&#160;In the modern world, where new software comes&#160;in and changes overnight, there are numerous challenges in:</p>
<ol>
<li><strong>Discovering the software</strong>: There is no single point at which to find all software. A few are available as executables on the developer sites, a few in platform-specific application stores, a few as package managers, and so on and so forth.</li>
<li><strong>Installing the software</strong>: Software can be installed on specific OS, CPU architectures, OS versions, and build versions with the relevant prerequisites. Over a period of time, this becomes messy and confusing.</li>
<li><strong>Running the software</strong>: We have all faced the issue where&#160;<em>I am unable to find that software that I&#160; downloaded</em>. Applications that are installed and updated in the registry are easy to find but the ones that run as stand alone executables are more likely to missed. On top of that, we have licensing, upgrades, documentation, paths, and so on to take care of if we wish to run the software. On top of it, are we 100% sure that the executable that we are running is secure and would not cause a security breach if it's run on the machine?</li>
</ol>
<p>These slightly over exaggerated points highlight that there are challenges a plenty in discovering, installing, and running software. Containers are about software and relieve much of this pain.&#160;Just as shipping containers allow goods to be transported by ship, train, or truck regardless of the cargo inside, software containers act as a standard unit of software that can contain different code and dependencies. Containerizing software this way enables developers and IT professionals to deploy them across environments, with little or no modification.&#160;<span>Containers also isolate applications from each other on a shared OS. Containerized applications run on top of a container host that in turn runs on the OS (Linux or Windows). Containers therefore have a significantly smaller footprint than <strong>virtual machine</strong> (<strong>VM</strong>) images.&#160;</span>There is a myth that containers are replacements for VMs, which is incorrect. Containers require fewer resources than VMs, and hence a server can host more containers than VMs, making choice easier when there is a confusion. There are a number of containers available in the market today such as LXC, Docker, and so on. We will use Docker as our container, and will discuss it next.</p>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Docker</h1>
                </header>
            
            <article>
                
<p>Docker<span>&#160;is an&#160;</span>open source project<span>&#160;for automating the deployment of applications as portable, self-sufficient containers that can run on the cloud or on-premise. Docker is also a&#160;</span>company<span>&#160;that promotes and evolves this technology. Docker works in collaboration with cloud, Linux, and Windows vendors, including Microsoft. Docker image containers run natively on Linux and Windows. Windows images run only on Windows hosts and Linux images run only on Linux hosts. The host is a server or a VM.&#160;</span><span>Docker containers&#160;package an application&#160;with everything&#160;it needs to run: code, runtime, system tools, system libraries—anything&#160;we would install&#160;on a server for the application to run.&#160; A container is an isolated place where an application can run without affecting the rest of the system, and vice versa. This makes them an ideal way to package and run applications in production environments.&#160; Additionally, as discussed previously, Docker containers are lightweight which enables scaling applications quickly by spinning up new instances.</span></p>
<p>Before we&#160; deploy our Let's Chat application in Docker, let's get familiar with Docker terminology from Microsoft's official documentation site, (<a href="https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/container-docker-introduction/docker-terminology">https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/container-docker-introduction/docker-terminology</a>):</p>
<ul>
<li><strong>Container image</strong>: It is a package with all the dependencies and information needed to create a container.&#160;<span>An image includes all the dependencies such as frameworks, deployment, and the execution configuration to be used by a container at runtime. An image is immutable once it has been created.</span></li>
<li><strong>Container</strong>: An instance of a Docker image is called a container.&#160;<span>It represents the execution of a single application, process, or service. It consists of the contents of a Docker image, an execution environment, and a standard set of instructions. When scaling a service, we create multiple instances of a container from the same image.&#160;</span></li>
<li><strong>Tag</strong>: A mark or label applied to images, so that different images or versions can be identified.</li>
<li><strong>Dockerfile</strong><span>: It is a text file that contains instructions to build a Docker image.</span></li>
<li><strong>Build</strong><span>: The action of building a container image, based on the information and context provided by its Docker file, and additional files in the folder where the image is built. We can build images with the Docker docker build command.</span></li>
<li><strong>Repository</strong><span><span>: A collection of related Docker images, labeled with a tag that indicates the image version.&#160;</span></span></li>
<li><strong>Registry</strong><span>: A service that provides access to repositories. The default registry for most public images is</span><span>&#160;the&#160;</span><span>Docker Hub</span><span>&#160;</span><span>(owned by Docker as an organization). A registry usually contains repositories from multiple teams. Companies often have private registries to store and manage images they've created; the Azure Container Registry is another example.</span></li>
<li><strong>Docker Hub</strong><span>: A public registry to upload images and work with them. Docker Hub provides Docker image hosting, public or private registries, build triggers and web hooks, and integration with GitHub and Bitbucket.</span></li>
<li><strong>Azure Container Registry</strong><span>: A public resource for working with Docker images and its components in Azure. This provides a registry that is close to deployments in Azure and that gives control over access, making it possible to use Azure Active Directory groups and permissions.</span></li>
<li><strong>Compose</strong><span>: A command-line tool and YAML file format with metadata for defining and running multi-container applications. We define a single application based on multiple images with one or more</span> <kbd>.yml</kbd> <span>files that can override values depending on the environment. After creating the definitions, we can deploy the whole multi-container application with a single command (<kbd>docker-compose up</kbd>) that creates a container per image on the Docker host.</span></li>
</ul>
<p>This is just a basic introduction to Docker to get us started. There is a lot to be learned, so much so that a complete book can be written on Docker itself. So, interested and curious readers should spend quality time in familiarizing themselves with Docker from the Docker documentation site, or Microsoft's documentation on Docker.&#160;</p>
<p>Now that we have some context about Docker, let's try and deploy our Let's Chat application in a Docker container, using the tooling provided by Visual Studio 2017. To do so, we will follow these steps:</p>
<ol>
<li>&#160;If you have used Visual Studio 2017 and worked along with the chapters thus far, you already have Docker support enabled with the Visual Studio installation. If not, you would need to modify the Visual Studio 2017 installation and choose the&#160;<span class="packt_screen">.NET Core cross-platform development</span> workload.</li>
<li>Next, we will need to install Docker for Windows from&#160;<a href="https://docs.docker.com/docker-for-windows/install/">https://docs.docker.com/docker-for-windows/install/</a>. It's a simple installation in which you just need to do <span class="packt_screen">Next</span> | <span class="packt_screen">OK</span> | <span class="packt_screen">Finish</span> stuff, so we will not discuss it here. As of writing this chapter, 17.12 is the latest version.<a href="https://docs.docker.com/docker-for-windows/install/"></a></li>
</ol>
<ol start="3">
<li>Once the installation is successful, we would see a dialog as shown here:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="607" width="253" src="assets/08ae1984-ba70-4678-9a5c-9a92ecbdbcc0.png"/></div>
<div class="CDPAlignCenter CDPAlign"></div>
<p>&#160;</p>
<ol start="4">
<li>Next, we would need to share the drive in our local machine with Docker, where the images can be built and run. To do this, right-click on the Docker system tray icon and click <span class="packt_screen">Settings,</span> as shown here:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/646112c7-3269-45ad-98aa-d51b30394747.png"/></div>
<ol start="4">
<li>Share the drive where the images will run from in the <span class="packt_screen">Shared Drives</span> tab of <span class="packt_screen">Settings</span>.</li>
<li>Now, open the Let's Chat project in Visual Studio 2017.</li>
<li>Right-click on&#160;<kbd>LetsChat.csproj</kbd> and choose <span class="packt_screen">Add |</span>&#160;<span class="packt_screen">Docker Support</span>.</li>
<li>Visual Studio would do all the heavy lifting for us and add a Docker file amongst a few others as shown here:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/4c387b17-31b0-466a-a4c9-c860364e9ac9.png"/></div>
<ol start="8">
<li>We can also see that the&#160; <span class="packt_screen">Start&#160;</span> button in the command bar has changed to <span class="packt_screen">Docker,</span> as shown here:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/7a3cde48-2eaa-4a2a-8937-6652f32d0366.png"/></div>
<ol start="9">
<li>With this, we are done with our steps. Just click on the <span class="packt_screen">Docker</span> button (or press <em>F5</em>) and the application will run in the Docker container.&#160;&#160;</li>
</ol>
<p>We will see in <a href="ch10.html">Chapter 10</a>, <em>Functional Programming with F#</em>&#160;how we can deploy the application in the cloud, as well as how we can deploy Docker containers in Azure. This wraps up our discussion on Docker containers. We will conclude this chapter by learning to develop a FAQ Bot using the Microsoft Bot Framework.</p>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Bot 101</h1>
                </header>
            
            <article>
                
<p>A Chatbot,<span>&#160;also known as</span> talkbot<span>,&#160;</span>chatterbot<span>,&#160;</span>Bot<span>, or&#160;</span>IM bot,<span>&#160;is a&#160;</span>computer program<span>&#160;which conducts a&#160;</span>conversation<span>&#160;through auditory or textual methods.</span><span>&#160;Such programs are often designed to convincingly simulate how a human would behave as a conversational partner, thereby passing the&#160;</span>Turing test<span>. Chatbots are typically used in&#160;</span>dialog systems<span>&#160;for various practical purposes, including customer service or information acquisition. You would have noticed that various sites offer live chat with agents as it helps them gain better customer experience and business. In this section, we will see how we can quickly create a simple Chatbot to answer the basic questions. This section is completely informational and just provides a basic 100-level awareness of how a simple Chatbot can be created and the related technology. Curious and enthusiastic readers can explore other avenues from this basic knowledge. Let's learn to develop a simple FAQ Bot, which will answer simple queries like:</span></p>
<ul>
<li>How do I use Let's Chat?</li>
<li>How are you?</li>
<li>Hello!</li>
<li>Bye!</li>
</ul>
<p>The more you train the Bot and the more questions you put in its knowledge base, the better it will be, so let's get started. First of all, we need to create a page that can be accessed anonymously, as this is <span><strong>frequently asked questions</strong> (</span><strong>FAQ</strong> ), and hence the user should not be required to be logged in to the system to access this page. To do so, let's create a new controller called <kbd>FaqController</kbd> in our <kbd>LetsChat.csproj</kbd>. It will be a very simple class with just one action called <kbd>Index</kbd>, which will display the FAQ page. The code is as follows:</p>
<pre><strong>[AllowAnonymous]</strong><br/> public class FaqController : Controller<br/> {<br/>     // GET: Faq<br/>     public ActionResult Index()<br/>     {<br/>         return this.View();<br/>     }<br/> }</pre>
<p>Notice that we have used the&#160;<kbd>[AllowAnonymous]</kbd> attribute, so that&#160; this controller can be accessed even if the user is not logged in. The corresponding <kbd>.cshtml</kbd> is also very simple. In the solution explore, right-click on the <span class="packt_screen">Views</span> folder under the <kbd>LetsChat</kbd> project and create a folder named <kbd>Faq</kbd> and then add an <kbd>Index.cshtml</kbd> file in that folder. The markup of the&#160;<kbd>Index.cshtml</kbd> would look like this:</p>
<pre>@{<br/>     ViewData["Title"] = "Let's Chat";<br/>     ViewData["UserName"] = "Guest";<br/>     if(User.Identity.IsAuthenticated)<br/>     {<br/>         ViewData["UserName"] = User.Identity.Name;<br/>     }<br/> }<br/> &lt;h1&gt;<br/>   Hello @ViewData["UserName"]! Welcome to FAQ page of Let's Chat<br/> &lt;/h1&gt;<br/> &lt;br /&gt;</pre>
<p>Nothing much here apart from the welcome message. The message displays the username if the user is authenticated, else it displays <kbd>Guest</kbd>. Now, we need to integrate the Chatbot stuff in this page. To do so, let's browse to <a href="http://qnamaker.ai">http://qnamaker.ai</a>. This is Microsoft's QnA (as in questions and answers) maker site which&#160;<span>a free, easy-to-use, REST API and web-based service that trains <strong>artificial intelligence</strong> (<strong>AI</strong>) to respond to user questions in a more natural, conversational way. Compatible across development platforms, hosting services, and channels, QnA Maker is the only question and answer service with a graphical user interface—meaning you don’t need to be a developer to train, manage, and use it for a wide range of solutions. And that is what makes it incredibly easy to use. You would need to log in to this site with your Microsoft&#160;account (<kbd>@microsoft</kbd>/<kbd>@live</kbd>/<kbd>@outlook</kbd>).</span></p>
<p><span>If you don't have one, you should create one and log in. On the very first login, the site would display a dialog seeking permission to access your email address and profile information. Click</span> <span class="packt_screen">Yes</span> and g<span>rant permission:</span></p>
<div class="CDPAlignCenter"><img height="546" width="432" src="assets/379293d3-5aea-441f-8dc5-381bb76224d8.png"/></div>
<p class="CDPAlignLeft CDPAlign">You would then be presented with the service terms. Accept that as well. Then navigate to the <span class="packt_screen">Create New Service</span> tab. A form will appear as shown here:</p>
<div class="CDPAlignCenter CDPAlign"><img height="622" width="508" src="assets/db61900f-1dd1-4017-a5f1-439bae9bd77a.png"/></div>
<p>The form is easy to fill in and provides the option to extract the question/answer pairs from a site or <kbd>.tsv</kbd>, <kbd>.docx</kbd>, <kbd>.pdf</kbd>, and&#160;<kbd>.xlsx</kbd> files. We don't have questions handy and so we will type them; so do not bother about these fields. Just enter the service name and click the&#160;<span class="packt_screen">Create&#160;</span>button. The service should be created successfully and the knowledge base screen should be displayed. We will enter probable questions and answers in this knowledge base. If the user types a question that resembles the question in the knowledge base, it will respond with the answer in the knowledge base. Hence, the more questions and answers we type, the better it will perform. So, enter all the questions and answers that you wish to enter, test it in the local Chatbot setup, and, once you are happy with it, click on <span class="packt_screen">Publish</span>. This would publish the knowledge bank and share the sample URL to make the HTTP request. Note it down in a notepad. It contains the knowledge base identifier guide, hostname, and subscription key. With this, our questions and answers are ready and deployed. We need to display a chat interface, pass the user-entered text to this service, and display the response from this service to the user in the chat user interface. To do so, we will make use of the Microsoft Bot Builder SDK for .NET and follow these steps:</p>
<ol>
<li>Download the <kbd>Bot Application</kbd> project template from&#160;<a href="http://aka.ms/bf-bc-vstemplate">http://aka.ms/bf-bc-vstemplate.</a></li>
<li>Download the <kbd>Bot Controller</kbd> item template from&#160;<a href="http://aka.ms/bf-bc-vscontrollertemplate">http://aka.ms/bf-bc-vscontrollertemplate.</a></li>
<li>Download the <kbd>Bot Dialog</kbd> item template from&#160;<a href="http://aka.ms/bf-bc-vsdialogtemplate">http://aka.ms/bf-bc-vsdialogtemplate.</a></li>
<li>Next, identify the project template and item template directory for Visual Studio 2017. The project template directory is located at&#160;<span><kbd>%USERPROFILE%\Documents\Visual Studio 2017\Templates\ProjectTemplates\Visual C#\</kbd> and the item template directory is located at&#160;<kbd>%USERPROFILE%\Documents\Visual Studio 2017\Templates\ItemTemplates\Visual C#\</kbd>.</span></li>
<li>Copy the <kbd>Bot Application</kbd> project template to the project template directory.</li>
<li>Copy the <kbd>Bot Controller</kbd> ZIP and <kbd>Bot Dialog</kbd> ZIP to the item template directory.</li>
</ol>
<ol start="7">
<li>In the solution explorer of the&#160;<kbd>LetsChat</kbd> project, right-click on the solution and add a new project. Under <span class="packt_screen">Visual C#</span>, we should now start seeing a <kbd>Bot Application</kbd> template as shown here:</li>
</ol>
<div class="CDPAlignCenter"><img src="assets/97f782e4-e57f-4cba-8d7e-0e0dad251975.png"/></div>
<ol start="8">
<li>Name the project&#160;<kbd>FaqBot</kbd> and click <span class="packt_screen">OK</span>.</li>
<li>A new project will be created in the solution, which looks similar to the MVC project template. Build the project, so that all the dependencies are resolved and packages are restored. If you run the project, it is already a working Bot, which can be tested by the Microsoft Bot Framework emulator. Download the BotFramework-Emulator setup executable from&#160;<a href="https://github.com/Microsoft/BotFramework-Emulator/releases/tag/v3.5.34">https://github.com/Microsoft/BotFramework-Emulator/releases/.</a></li>
<li>Let's run the Bot project by hitting <em>F5</em>. It will display a page pointing to the default URL of <kbd>http://localhost:3979</kbd>. Now, open the Bot framework emulator and navigate to the preceding URL and append <kbd>api/messages</kbd>; to it, that is, browse to <kbd>http://localhost:3979/api/messages</kbd> and click <span class="packt_screen">Connect</span>. On successful connection to the Bot, a chat-like interface will be displayed in which you can type the message. The following screenshot displays this step:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="735" width="684" src="assets/9001ba6a-df8a-4b4f-a3aa-e31e8ca3fe45.png"/></div>
<p style="padding-left: 60px">We have a working Bot in place which just returns the text along with its length. We need to modify this Bot, to pass the user input to our QnA Maker service and display the response returned from our service. To do so, we will need to check the code of&#160;<kbd>MessagesController</kbd> in the <kbd>Controllers</kbd> folder. We notice that it has just one method called <kbd>Post</kbd>, which checks the activity type, does specific processing for the activity type, creates a response, and returns it. The calculation happens in the&#160;<kbd>Dialogs.RootDialog</kbd>&#160;class, which is where we need to make the modification to wire up our QnA service. The modified code is shown here:</p>
<pre style="padding-left: 60px">private static string knowledgeBaseId = ConfigurationManager.AppSettings["KnowledgeBaseId"]; //// Knowledge base id of QnA Service.<br/> <br/> private static string qnamakerSubscriptionKey = <br/> ConfigurationManager.AppSettings["SubscriptionKey"]; ////Subscription <br/> key.<br/> <br/> private static string hostUrl = <br/> ConfigurationManager.AppSettings["HostUrl"];<br/> <br/> <br/> private async Task MessageReceivedAsync(IDialogContext context, <br/> IAwaitable&lt;object&gt; result)<br/> {<br/>     var activity = await result as Activity;<br/>     // return our reply to the user<br/>     await <br/>     context.PostAsync(this.GetAnswerFromService(activity.Text));<br/>     context.Wait(MessageReceivedAsync);<br/> }<br/> <br/> private string GetAnswerFromService(string inputText)<br/> {<br/>     //// Build the QnA Service URI<br/>     Uri qnamakerUriBase = new Uri(hostUrl);<br/>     var builder = new UriBuilder($"{qnamakerUriBase}/knowledgebases    <br/>     /{knowledgeBaseId}/generateAnswer");<br/>     var postBody = $"{{\"question\": \"{inputText}\"}}";<br/>     //Add the subscription key header<br/>     using (WebClient client = new WebClient())<br/>     {<br/>         client.Headers.Add("Ocp-Apim-Subscription-Key",  <br/>         qnamakerSubscriptionKey);<br/>         client.Headers.Add("Content-Type", "application/json");<br/>         try<br/>         {<br/>             var response = client.UploadString(builder.Uri,   <br/>             postBody);<br/>             var json = JsonConvert.DeserializeObject&lt;QnAResult&gt;<br/>             (response);<br/>             return json?.answers?.FirstOrDefault().answer;<br/>         }<br/>         catch (Exception ex)<br/>         {<br/>             return ex.Message;<br/>         }<br/>     }<br/> }</pre>
<p style="padding-left: 60px">The code is pretty straightforward. First, we add the QnA Maker service subscription key, host URL, and knowledge base ID in the&#160;<kbd>appSettings</kbd> section of <kbd>Web.config</kbd>. Next, we read these app settings into static variables so that they are available always. Next, we modify the <kbd>MessageReceivedAsync</kbd> method of the dialog to pass the user input to the QnA service and return the response of the service back to the user. The <kbd>QnAResult</kbd> class can be seen from the source code.</p>
<ol start="11">
<li>This can be tested in the emulator by typing in any of the questions that we have stored in our knowledge base, and we will get the appropriate response, as shown next:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="620" width="398" src="assets/9df01620-17e1-4d87-9b4c-829bba6e86ee.png"/></div>
<p>Deploying it in our Let's Chat application would need a basic knowledge of Azure, which we have not touched on yet. We will continue deploying and integrating this Chatbot&#160;in our Let's Chat application later in<span>&#160;</span><a href="https://cdp.packtpub.com/_net_core_2_0_by_example/wp-admin/post.php?post=174&amp;action=edit#post_376">Chapter 10</a><span>,&#160;</span><em>Functional Programming with F#</em>, when we discuss and learn Azure fundamentals and will be deploying ASP.NET Core 2.0 applications in the cloud.</p>
<p>This concludes our awareness discussion on developing a basic Chatbot using the Microsoft Bot Framework, the QnA Maker service, and ASP.NET Core 2.0. The Bot can be deployed in Azure and can be integrated to work with a variety of channels such as Skype, Facebook, web chat, and so on. With this, we conclude our chapter as well. In the next chapter, we would look into a new term that has sprung up over the last few years called microservices, with respect to ASP.NET Core 2.0.</p>


            </article>

            
        </section>
    </div>


    <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we learnt about Razor syntax, Views, Razor pages, and Tag Helpers. We then coded the Chat hub module of our Let's Chat application. We also learnt the importance of testing and how we can write unit tests using Moq and xUnit. We saw a new productivity-enhancing feature introduced in Visual Studio 2017 Enterprise edition called Live Unit Testing and how it helps us write better-quality code. We also learnt about containers and how we can deploy our application in Docker from Visual Studio itself. We concluded the chapter by learning about developing a FAQ Bot using the Microsoft Bot Framework and ASP.NET Core 2.0. We have not deployed our application in the cloud yet, which we will do in <a href="https://cdp.packtpub.com/_net_core_2_0_by_example/wp-admin/post.php?post=174&amp;action=edit#post_376">Chapter 10</a><span>,&#160;</span><em>Functional Programming with F#</em>. In the next couple of chapters, we will delve into the new world of microservices.</p>


            </article>

            
        </section>
    </div>
</body>
</html>