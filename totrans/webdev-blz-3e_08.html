<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer048">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">8</span></h1>
<h1 class="chapterTitle" id="_idParaDest-161"><span class="koboSpan" id="kobo.2.1">Authentication and Authorization</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">In this chapter, we will learn </span><a id="_idIndexMarker374"/><span class="koboSpan" id="kobo.4.1">how to add </span><strong class="keyWord"><span class="koboSpan" id="kobo.5.1">authentication</span></strong><span class="koboSpan" id="kobo.6.1"> and </span><strong class="keyWord"><span class="koboSpan" id="kobo.7.1">authorization</span></strong><span class="koboSpan" id="kobo.8.1"> to our</span><a id="_idIndexMarker375"/><span class="koboSpan" id="kobo.9.1"> blog because we don’t want just anyone to be able to create or edit blog posts.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.10.1">Covering authentication and authorization could take a whole book, so we will keep things simple here. </span><span class="koboSpan" id="kobo.10.2">This chapter aims to get the built-in authentication and authorization functionalities working, building on the already existing functionality that’s built into ASP.NET. </span><span class="koboSpan" id="kobo.10.3">That means that there is not a lot of Blazor magic involved here; many resources already exist that we can take advantage of.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.11.1">Almost every system today has some way to log in, whether it is an admin interface (like ours) or a member login portal. </span><span class="koboSpan" id="kobo.11.2">There are many different login providers, such as Google, Twitter, and Microsoft. </span><span class="koboSpan" id="kobo.11.3">We can use all of these providers since we will just be building on existing architecture.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.12.1">Some sites might already have a database for storing login credentials, but for our blog, we will use a service called Auth0 to manage our users. </span><span class="koboSpan" id="kobo.12.2">It is a very powerful way to add many different social providers (if we want to), and we don’t have to manage the users ourselves.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.13.1">We can check the option to add authentication when creating our project. </span><span class="koboSpan" id="kobo.13.2">The authentication works differently when it comes to Blazor Server, Blazor WebAssembly, and the API, which we will look at in more detail in this chapter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.14.1">We will cover the following topics in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.15.1">Setting up authentication</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.16.1">Securing Blazor Server</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.17.1">Securing Blazor WebAssembly</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.18.1">Securing the API</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.19.1">Adding authorization</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-162"><span class="koboSpan" id="kobo.20.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.21.1">Make sure you have followed the previous chapters or use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.22.1">Chapter07</span></code><span class="koboSpan" id="kobo.23.1"> folder as a starting point.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.24.1">You can find the source code for this chapter’s end result at </span><a href="https://github.com/PacktPublishing/Web-Development-with-Blazor-Third-Edition/tree/main/Chapter08"><span class="url"><span class="koboSpan" id="kobo.25.1">https://github.com/PacktPublishing/Web-Development-with-Blazor-Third-Edition/tree/main/Chapter08</span></span></a><span class="koboSpan" id="kobo.26.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-163"><span class="koboSpan" id="kobo.27.1">Setting up authentication</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.28.1">There are a lot of built-in functionalities</span><a id="_idIndexMarker376"/><span class="koboSpan" id="kobo.29.1"> when it comes to authentication. </span><span class="koboSpan" id="kobo.29.2">The easiest way to add authentication is to select an authentication option when creating a project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.30.1">We need to implement authentication separately for the Blazor Server project and the Blazor WebAssembly project because they work differently.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.31.1">But there are still things we can share between these two projects. </span><span class="koboSpan" id="kobo.31.2">First, we need to set up Auth0.</span></p>
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.32.1">Auth0</span></strong><span class="koboSpan" id="kobo.33.1"> is a </span><a id="_idIndexMarker377"/><span class="koboSpan" id="kobo.34.1">service that can help us with handling our users. </span><span class="koboSpan" id="kobo.34.2">There are many different services like this, but Auth0 is a good fit for us. </span><span class="koboSpan" id="kobo.34.3">We can connect one or more social connectors, which will allow our users to log in with Facebook, Twitter, Twitch, or whatever we add to our site.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.35.1">Even though all of this can be achieved by writing code ourselves, integration like this is a great way to add authentication quickly and also get a very powerful solution. </span><span class="koboSpan" id="kobo.35.2">Also, authentication is complex, so don’t write this unless you are sure of what you are doing. </span><span class="koboSpan" id="kobo.35.3">Auth0 is free for up to 7,000 users (which our blog probably won’t reach, especially not the admin interface).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.36.1">It also has great functionality to add data to our users that we have access to. </span><span class="koboSpan" id="kobo.36.2">We will do that later in the chapter when we add roles to our users. </span><span class="koboSpan" id="kobo.36.3">You’ll need to take the following steps:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.37.1">Head over to </span><a href="https://auth0.com"><span class="url"><span class="koboSpan" id="kobo.38.1">https://auth0.com</span></span></a><span class="koboSpan" id="kobo.39.1"> and create an account.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.40.1">Click the </span><strong class="screenText"><span class="koboSpan" id="kobo.41.1">Create Application</span></strong><span class="koboSpan" id="kobo.42.1"> button.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.43.1">Now, it’s time to name our application. </span><span class="koboSpan" id="kobo.43.2">Use </span><code class="inlineCode"><span class="koboSpan" id="kobo.44.1">MyBlog</span></code><span class="koboSpan" id="kobo.45.1">, for example. </span><span class="koboSpan" id="kobo.45.2">Then, it’s time to select what kind of application type we are using. </span><span class="koboSpan" id="kobo.45.3">Is it a native app? </span><span class="koboSpan" id="kobo.45.4">Is it a </span><strong class="keyWord"><span class="koboSpan" id="kobo.46.1">single-page web application</span></strong><span class="koboSpan" id="kobo.47.1">, </span><strong class="keyWord"><span class="koboSpan" id="kobo.48.1">regular web application</span></strong><span class="koboSpan" id="kobo.49.1">, or </span><strong class="keyWord"><span class="koboSpan" id="kobo.50.1">machine-to-machine application</span></strong><span class="koboSpan" id="kobo.51.1">?</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.52.1">This depends </span><a id="_idIndexMarker378"/><span class="koboSpan" id="kobo.53.1">on what hosting model we are going to run.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.54.1">The beautiful thing with how we have the project set up right now is that the server is going to handle all the authentication and hand that over to WebAssembly (if we have a component that is running in InteractiveAuto or InteractiveWebAssembly). </span><span class="koboSpan" id="kobo.54.2">But it won’t limit the functionality, only what we need to configure when setting up our application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.55.1">If we intend to only run as Blazor Server (InteractiveServer), we should use a regular web application. </span><span class="koboSpan" id="kobo.55.2">But we might want to change to running everything in InteractiveWebAssembly, so let’s not limit ourselves here. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.56.1">Select </span><strong class="screenText"><span class="koboSpan" id="kobo.57.1">Single Page Application</span></strong><span class="koboSpan" id="kobo.58.1">, that way we get the option to use our authentication in any hosting model.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.59.1">Next, we will choose what technology we are using for our project. </span><span class="koboSpan" id="kobo.59.2">We have Apache, .NET, Django, Go, and many other choices, but we don’t have a choice for Blazor specifically, at least not at the time of writing.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.60.1">Just skip this and click the </span><strong class="screenText"><span class="koboSpan" id="kobo.61.1">Setting</span></strong><span class="koboSpan" id="kobo.62.1"> tab.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.63.1">Now, we will set up our application. </span><span class="koboSpan" id="kobo.63.2">There are a couple of values we need to save and use later. </span><span class="koboSpan" id="kobo.63.3">You need to make sure that you write down the </span><code class="inlineCode"><span class="koboSpan" id="kobo.64.1">Domain</span></code><span class="koboSpan" id="kobo.65.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.66.1">Client ID</span></code><span class="koboSpan" id="kobo.67.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.68.1">Client Secret</span></code><span class="koboSpan" id="kobo.69.1">, as we will use those in a bit.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.70.1">If we scroll down, we can change the logo, but we will skip that.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.71.1">Leave </span><code class="inlineCode"><span class="koboSpan" id="kobo.72.1">Application Login URI</span></code><span class="koboSpan" id="kobo.73.1"> empty. </span><span class="koboSpan" id="kobo.73.2">Starting with .NET 6, the port numbers are random, so make sure you add your application’s port number:</span><ol class="alphabeticList" style="list-style-type: lower-alpha;">
<li class="alphabeticList" value="1"><code class="inlineCode"><span class="koboSpan" id="kobo.74.1">Allowed callback URLs</span></code><span class="koboSpan" id="kobo.75.1">: </span><code class="inlineCode"><span class="koboSpan" id="kobo.76.1">https://localhost:PORTNUMBER/callback</span></code></li>
<li class="alphabeticList"><code class="inlineCode"><span class="koboSpan" id="kobo.77.1">Allowed logout URLs</span></code><span class="koboSpan" id="kobo.78.1">: </span><code class="inlineCode"><span class="koboSpan" id="kobo.79.1">https://localhost:PORTNUMBER/</span></code></li>
</ol>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.80.1">Allowed callback</span><a id="_idIndexMarker379"/><span class="koboSpan" id="kobo.81.1"> URLs are the URLs </span><code class="inlineCode"><span class="koboSpan" id="kobo.82.1">Auth0</span></code><span class="koboSpan" id="kobo.83.1"> will make a call to after the user authentication and allowed logout URLs are where the user should be redirected after logging out.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.84.1">Now, press </span><strong class="screenText"><span class="koboSpan" id="kobo.85.1">Save Changes</span></strong><span class="koboSpan" id="kobo.86.1"> at the bottom of the page.</span></p>
<h2 class="heading-2" id="_idParaDest-164"><span class="koboSpan" id="kobo.87.1">Configuring our Blazor app</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.88.1">We are done with configuring </span><a id="_idIndexMarker380"/><span class="koboSpan" id="kobo.89.1">Auth0. </span><span class="koboSpan" id="kobo.89.2">Next, we will configure our Blazor application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.90.1">There are many ways to store secrets in .NET (a file that is not checked in, Azure Key Vault, etc.). </span><span class="koboSpan" id="kobo.90.2">You can use the one that you are most familiar with.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.91.1">We will keep it very simple and store secrets in our </span><code class="inlineCode"><span class="koboSpan" id="kobo.92.1">appsettings.json</span></code><span class="koboSpan" id="kobo.93.1">. </span><span class="koboSpan" id="kobo.93.2">Make sure to remember to exclude the file when you check in. </span><span class="koboSpan" id="kobo.93.3">You don’t check the secrets in source control. </span><span class="koboSpan" id="kobo.93.4">You can right-click on the file and select </span><strong class="screenText"><span class="koboSpan" id="kobo.94.1">Git</span></strong><span class="koboSpan" id="kobo.95.1">,</span><strong class="screenText"><span class="koboSpan" id="kobo.96.1"> Ignore and Untrack Item</span></strong><span class="koboSpan" id="kobo.97.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.98.1">To configure our Blazor project, follow these steps:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.99.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.100.1">BlazorWebApp.Client</span></code><span class="koboSpan" id="kobo.101.1"> project, in the root, add a new class called </span><code class="inlineCode"><span class="koboSpan" id="kobo.102.1">UserInfo.cs</span></code><span class="koboSpan" id="kobo.103.1">, and add the following content:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.104.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.105.1">BlazorWebApp.Client</span></span><span class="koboSpan" id="kobo.106.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.107.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.108.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.109.1">UserInfo</span></span><span class="koboSpan" id="kobo.110.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.111.1">public</span></span><span class="koboSpan" id="kobo.112.1"> required </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.113.1">string</span></span><span class="koboSpan" id="kobo.114.1"> UserId { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.115.1">get</span></span><span class="koboSpan" id="kobo.116.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.117.1">set</span></span><span class="koboSpan" id="kobo.118.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.119.1">public</span></span><span class="koboSpan" id="kobo.120.1"> required </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.121.1">string</span></span><span class="koboSpan" id="kobo.122.1"> Email { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.123.1">get</span></span><span class="koboSpan" id="kobo.124.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.125.1">set</span></span><span class="koboSpan" id="kobo.126.1">; }    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.127.1">public</span></span><span class="koboSpan" id="kobo.128.1"> required </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.129.1">string</span></span><span class="koboSpan" id="kobo.130.1">[] Roles { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.131.1">get</span></span><span class="koboSpan" id="kobo.132.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.133.1">set</span></span><span class="koboSpan" id="kobo.134.1">; }
}
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.135.1">This is taken from the Blazor template.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.136.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.137.1">BlazorWebApp</span></code><span class="koboSpan" id="kobo.138.1"> project, open </span><code class="inlineCode"><span class="koboSpan" id="kobo.139.1">appsettings.json</span></code><span class="koboSpan" id="kobo.140.1"> and add the following code to the root of the existing app settings object:
        </span><pre class="programlisting code"><code class="hljs-code">  <span class="hljs-string"><span class="koboSpan" id="kobo.141.1">"Auth0"</span></span><span class="koboSpan" id="kobo.142.1">: {
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.143.1">"Authority"</span></span><span class="koboSpan" id="kobo.144.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.145.1">"Get this from the domain for your application at Auth0"</span></span><span class="koboSpan" id="kobo.146.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.147.1">"ClientId"</span></span><span class="koboSpan" id="kobo.148.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.149.1">"Get this from Auth0 setting"</span></span><span class="koboSpan" id="kobo.150.1">
  }
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.151.1">These are the values we made a note of in the previous section. </span><span class="koboSpan" id="kobo.151.2">Replace the values with our own values from </span><code class="inlineCode"><span class="koboSpan" id="kobo.152.1">Auth0</span></code><span class="koboSpan" id="kobo.153.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.154.1">Since our site is an ASP.NET site with some added Blazor functionality, this means we can use a NuGet package to get some of the functionality out of the box.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.155.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.156.1">BlazorWebApp</span></code><span class="koboSpan" id="kobo.157.1"> project, add</span><a id="_idIndexMarker381"/><span class="koboSpan" id="kobo.158.1"> a reference to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.159.1">Auth0.AspNetCore.Authentication NuGet</span></code><span class="koboSpan" id="kobo.160.1"> package.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.161.1">In the root of the project, create a new class named </span><code class="inlineCode"><span class="koboSpan" id="kobo.162.1">PersistingServerAuthenticationStateProvider.cs</span></code><span class="koboSpan" id="kobo.163.1">, and add the following code:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.164.1">using</span></span><span class="koboSpan" id="kobo.165.1"> BlazorWebApp.Client;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.166.1">using</span></span><span class="koboSpan" id="kobo.167.1"> Microsoft.AspNetCore.Components;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.168.1">using</span></span><span class="koboSpan" id="kobo.169.1"> Microsoft.AspNetCore.Components.Authorization;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.170.1">using</span></span><span class="koboSpan" id="kobo.171.1"> Microsoft.AspNetCore.Components.Server;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.172.1">using</span></span><span class="koboSpan" id="kobo.173.1"> Microsoft.AspNetCore.Components.Web;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.174.1">using</span></span><span class="koboSpan" id="kobo.175.1"> Microsoft.AspNetCore.Identity;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.176.1">using</span></span><span class="koboSpan" id="kobo.177.1"> Microsoft.Extensions.Options;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.178.1">using</span></span><span class="koboSpan" id="kobo.179.1"> System.Diagnostics;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.180.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.181.1">BlazorWebApp</span></span><span class="koboSpan" id="kobo.182.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.183.1">internal</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.184.1">sealed</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.185.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.186.1">PersistingServerAuthenticationStateProvider</span></span><span class="koboSpan" id="kobo.187.1"> : </span><span class="hljs-title"><span class="koboSpan" id="kobo.188.1">ServerAuthenticationStateProvider</span></span><span class="koboSpan" id="kobo.189.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.190.1">IDisposable</span></span><span class="koboSpan" id="kobo.191.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.192.1">private</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.193.1">readonly</span></span><span class="koboSpan" id="kobo.194.1"> PersistentComponentState state;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.195.1">private</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.196.1">readonly</span></span><span class="koboSpan" id="kobo.197.1"> IdentityOptions options;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.198.1">private</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.199.1">readonly</span></span><span class="koboSpan" id="kobo.200.1"> PersistingComponentStateSubscription subscription;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.201.1">private</span></span><span class="koboSpan" id="kobo.202.1"> Task&lt;AuthenticationState&gt;? </span><span class="koboSpan" id="kobo.202.2">authenticationStateTask;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.203.1">public</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.204.1">PersistingServerAuthenticationStateProvider</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.205.1">(</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.206.1">        PersistentComponentState persistentComponentState,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.207.1">        IOptions&lt;IdentityOptions&gt; optionsAccessor</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.208.1">)</span></span><span class="koboSpan" id="kobo.209.1">
    {
        state = persistentComponentState;
        options = optionsAccessor.Value;
        AuthenticationStateChanged += OnAuthenticationStateChanged;
        subscription = state.RegisterOnPersisting(OnPersistingAsync, RenderMode.InteractiveWebAssembly);
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.210.1">private</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.211.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.212.1">OnAuthenticationStateChanged</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.213.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.214.1">Task&lt;AuthenticationState&gt; task</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.215.1">)</span></span><span class="koboSpan" id="kobo.216.1">
    {
        authenticationStateTask = task;
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.217.1">private</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.218.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.219.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.220.1">OnPersistingAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.221.1">()</span></span><span class="koboSpan" id="kobo.222.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.223.1">if</span></span><span class="koboSpan" id="kobo.224.1"> (authenticationStateTask </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.225.1">is</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.226.1">null</span></span><span class="koboSpan" id="kobo.227.1">)
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.228.1">throw</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.229.1">new</span></span><span class="koboSpan" id="kobo.230.1"> UnreachableException(</span><span class="hljs-string"><span class="koboSpan" id="kobo.231.1">$"Authentication state not set in </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.232.1">{</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.233.1">nameof</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.234.1">(OnPersistingAsync)}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.235.1">()."</span></span><span class="koboSpan" id="kobo.236.1">);
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.237.1">var</span></span><span class="koboSpan" id="kobo.238.1"> authenticationState = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.239.1">await</span></span><span class="koboSpan" id="kobo.240.1"> authenticationStateTask;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.241.1">var</span></span><span class="koboSpan" id="kobo.242.1"> principal = authenticationState.User;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.243.1">if</span></span><span class="koboSpan" id="kobo.244.1"> (principal.Identity?.IsAuthenticated == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.245.1">true</span></span><span class="koboSpan" id="kobo.246.1">)
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.247.1">var</span></span><span class="koboSpan" id="kobo.248.1"> userId = principal.FindFirst(options.ClaimsIdentity.UserIdClaimType)?.Value;
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.249.1">var</span></span><span class="koboSpan" id="kobo.250.1"> email = principal.FindFirst(options.ClaimsIdentity.EmailClaimType)?.Value;
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.251.1">var</span></span><span class="koboSpan" id="kobo.252.1"> roles = principal.FindAll(options.ClaimsIdentity.RoleClaimType);
            
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.253.1">if</span></span><span class="koboSpan" id="kobo.254.1"> (userId != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.255.1">null</span></span><span class="koboSpan" id="kobo.256.1">)
            {
                state.PersistAsJson(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.257.1">nameof</span></span><span class="koboSpan" id="kobo.258.1">(UserInfo), </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.259.1">new</span></span><span class="koboSpan" id="kobo.260.1"> UserInfo
                {
                    UserId = userId,
                    Email = email,
                    Roles=roles.Select(r=&gt;r.Value).ToArray()
                });
            }
        }
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.261.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.262.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.263.1">Dispose</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.264.1">()</span></span><span class="koboSpan" id="kobo.265.1">
    {
        subscription.Dispose();
        AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.266.1">I have taken this file from the Blazor template (when we choose to add authentication right away). </span><span class="koboSpan" id="kobo.266.2">I added roles to it so if </span><code class="inlineCode"><span class="koboSpan" id="kobo.267.1">Auth0</span></code><span class="koboSpan" id="kobo.268.1"> delivers any roles, they will be stored in the state as well. </span><span class="koboSpan" id="kobo.268.2">Right now, </span><code class="inlineCode"><span class="koboSpan" id="kobo.269.1">Auth0</span></code><span class="koboSpan" id="kobo.270.1"> won’t give us any roles, so we will get back to roles in a bit. </span><span class="koboSpan" id="kobo.270.2">What is happening is when we log in, it will save the logged-in user in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.271.1">PersistentComponentState</span></code><span class="koboSpan" id="kobo.272.1"> so that we can easily transfer the user over to WebAssembly. </span><span class="koboSpan" id="kobo.272.2">The server will render the data on the DOM, and WebAssembly will then pick that up. </span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.273.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.274.1">Program.cs</span></code><span class="koboSpan" id="kobo.275.1"> and add the following at the top of the file:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.276.1">using</span></span><span class="koboSpan" id="kobo.277.1"> BlazorWebApp;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.278.1">using</span></span><span class="koboSpan" id="kobo.279.1"> Auth0.AspNetCore.Authentication;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.280.1">using</span></span><span class="koboSpan" id="kobo.281.1"> Microsoft.AspNetCore.Authentication;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.282.1">using</span></span><span class="koboSpan" id="kobo.283.1"> Microsoft.AspNetCore.Authentication.Cookies;
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.284.1">Add the following code just before </span><code class="inlineCode"><span class="koboSpan" id="kobo.285.1">WebApplication app = builder.Build();</span></code><span class="koboSpan" id="kobo.286.1">:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.287.1">builder.Services.AddScoped&lt;AuthenticationStateProvider, PersistingServerAuthenticationStateProvider&gt;();
builder.Services.AddCascadingAuthenticationState();
builder.Services
    .AddAuth0WebAppAuthentication(options =&gt;
    {
        options.Domain = builder.Configuration[</span><span class="hljs-string"><span class="koboSpan" id="kobo.288.1">"Auth0:Authority"</span></span><span class="koboSpan" id="kobo.289.1">]??</span><span class="hljs-string"><span class="koboSpan" id="kobo.290.1">""</span></span><span class="koboSpan" id="kobo.291.1">;;
        options.ClientId = builder.Configuration[</span><span class="hljs-string"><span class="koboSpan" id="kobo.292.1">"Auth0:ClientId"</span></span><span class="koboSpan" id="kobo.293.1">]??</span><span class="hljs-string"><span class="koboSpan" id="kobo.294.1">""</span></span><span class="koboSpan" id="kobo.295.1">;;
    });
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.296.1">In previous versions of Blazor, we had to first make sure that when our components asked for </span><code class="inlineCode"><span class="koboSpan" id="kobo.297.1">AuthenticationStateProvider</span></code><span class="koboSpan" id="kobo.298.1">, we sent back an instance of our </span><code class="inlineCode"><span class="koboSpan" id="kobo.299.1">PersistingServerAuthenticationStateProvider</span></code><span class="koboSpan" id="kobo.300.1">. </span><span class="koboSpan" id="kobo.300.2">We also add a call to </span><code class="inlineCode"><span class="koboSpan" id="kobo.301.1">AddCascadingAuthenticationState</span></code><span class="koboSpan" id="kobo.302.1">, which will make sure to always send an </span><code class="inlineCode"><span class="koboSpan" id="kobo.303.1">AuthenticationState</span></code><span class="koboSpan" id="kobo.304.1"> to all our components regardless of hosting method.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.305.1">Also, add the </span><a id="_idIndexMarker382"/><span class="koboSpan" id="kobo.306.1">following code just after </span><code class="inlineCode"><span class="koboSpan" id="kobo.307.1">app.UseAntiforgery();</span></code><span class="koboSpan" id="kobo.308.1">. </span><span class="koboSpan" id="kobo.308.2">This code will allow us to secure our site:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.309.1">app.UseAuthentication();
app.UseAuthorization();
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.310.1">In </span><code class="inlineCode"><span class="koboSpan" id="kobo.311.1">Program.cs</span></code><span class="koboSpan" id="kobo.312.1">, add the following code just before </span><code class="inlineCode"><span class="koboSpan" id="kobo.313.1">app.Run()</span></code><span class="koboSpan" id="kobo.314.1">:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.315.1">app.MapGet("account/login", </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.316.1">async</span></span><span class="koboSpan" id="kobo.317.1"> (</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.318.1">string</span></span><span class="koboSpan" id="kobo.319.1"> redirectUri, HttpContext
 context) =&gt;
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.320.1">var</span></span><span class="koboSpan" id="kobo.321.1"> authenticationProperties = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.322.1">new</span></span><span class="koboSpan" id="kobo.323.1"> LoginAuthenticationPropertiesBuilder()
         .WithRedirectUri(redirectUri)
         .Build();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.324.1">await</span></span><span class="koboSpan" id="kobo.325.1"> context.ChallengeAsync(Auth0Constants.AuthenticationScheme, authenticationProperties);
});
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.326.1">When our site redirects to </span><code class="inlineCode"><span class="koboSpan" id="kobo.327.1">authentication/login</span></code><span class="koboSpan" id="kobo.328.1">, the Minimal API endpoint will kick off the login functionality.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="11"><span class="koboSpan" id="kobo.329.1">We need to add a similar functionality for logging out. </span><span class="koboSpan" id="kobo.329.2">Add the following code below the previous endpoint from </span><em class="italic"><span class="koboSpan" id="kobo.330.1">Step 7</span></em><span class="koboSpan" id="kobo.331.1">:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.332.1">app.MapGet("authentication/logout", </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.333.1">async</span></span><span class="koboSpan" id="kobo.334.1"> (HttpContext context) =&gt;
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.335.1">var</span></span><span class="koboSpan" id="kobo.336.1"> authenticationProperties = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.337.1">new</span></span><span class="koboSpan" id="kobo.338.1"> LogoutAuthenticationPropertiesBuilder()
         .WithRedirectUri("/")
         .Build();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.339.1">await</span></span><span class="koboSpan" id="kobo.340.1"> context.SignOutAsync(Auth0Constants.AuthenticationScheme, authenticationProperties);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.341.1">await</span></span><span class="koboSpan" id="kobo.342.1"> context.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
});
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.343.1">It needs to sign out</span><a id="_idIndexMarker383"/><span class="koboSpan" id="kobo.344.1"> twice, once for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.345.1">Auth0</span></code><span class="koboSpan" id="kobo.346.1"> authentication scheme and once for the cookie authentication scheme. </span><span class="koboSpan" id="kobo.346.2">The configuration is all set. </span><span class="koboSpan" id="kobo.346.3">Now, we need something to secure.</span></p>
<h1 class="heading-1" id="_idParaDest-165"><span class="koboSpan" id="kobo.347.1">Securing our Blazor app</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.348.1">Blazor </span><a id="_idIndexMarker384"/><span class="koboSpan" id="kobo.349.1">uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.350.1">App.razor</span></code><span class="koboSpan" id="kobo.351.1"> for routing. </span><span class="koboSpan" id="kobo.351.2">To enable securing Blazor, we need to add a couple of components in the app component.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.352.1">We need to add </span><code class="inlineCode"><span class="koboSpan" id="kobo.353.1">CascadingAuthenticationState</span></code><span class="koboSpan" id="kobo.354.1">, which will send the authentication state to all the components that are listening for it. </span><span class="koboSpan" id="kobo.354.2">We also need to change the route view to </span><code class="inlineCode"><span class="koboSpan" id="kobo.355.1">AuthorizeRouteView</span></code><span class="koboSpan" id="kobo.356.1">, which can have different views depending on whether or not you are authenticated:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.357.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.358.1">BlazorWebApp</span></code><span class="koboSpan" id="kobo.359.1"> project, open </span><code class="inlineCode"><span class="koboSpan" id="kobo.360.1">Components/_Imports.razor</span></code><span class="koboSpan" id="kobo.361.1"> and add the namespaces:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.362.1">@using Microsoft.AspNetCore.Components.Authorization
@using BlazorWebApp.Components.Layout
@using BlazorWebApp.Components
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.363.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.364.1">Components/Routes.razor</span></code><span class="koboSpan" id="kobo.365.1"> component and replace everything inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.366.1">Router</span></code><span class="koboSpan" id="kobo.367.1"> component with the following:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.368.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.369.1">Found</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.370.1">Context</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.371.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.372.1">"routeData"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.373.1">&gt;</span></span>
     <span class="hljs-tag"><span class="koboSpan" id="kobo.374.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.375.1">AuthorizeRouteView</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.376.1">RouteData</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.377.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.378.1">"@routeData"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.379.1">DefaultLayout</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.380.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.381.1">"@typeof(MainLayout)"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.382.1">&gt;</span></span>
         <span class="hljs-tag"><span class="koboSpan" id="kobo.383.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.384.1">Authorizing</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.385.1">&gt;</span></span>
             <span class="hljs-tag"><span class="koboSpan" id="kobo.386.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.387.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.388.1">&gt;</span></span><span class="koboSpan" id="kobo.389.1">Determining session state, please wait...</span><span class="hljs-tag"><span class="koboSpan" id="kobo.390.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.391.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.392.1">&gt;</span></span>
         <span class="hljs-tag"><span class="koboSpan" id="kobo.393.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.394.1">Authorizing</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.395.1">&gt;</span></span>
         <span class="hljs-tag"><span class="koboSpan" id="kobo.396.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.397.1">NotAuthorized</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.398.1">&gt;</span></span>
             <span class="hljs-tag"><span class="koboSpan" id="kobo.399.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.400.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.401.1">&gt;</span></span><span class="koboSpan" id="kobo.402.1">Sorry</span><span class="hljs-tag"><span class="koboSpan" id="kobo.403.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.404.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.405.1">&gt;</span></span>
             <span class="hljs-tag"><span class="koboSpan" id="kobo.406.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.407.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.408.1">&gt;</span></span><span class="koboSpan" id="kobo.409.1">You're not authorized to reach this page. </span><span class="koboSpan" id="kobo.409.2">You need to log in.</span><span class="hljs-tag"><span class="koboSpan" id="kobo.410.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.411.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.412.1">&gt;</span></span>
         <span class="hljs-tag"><span class="koboSpan" id="kobo.413.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.414.1">NotAuthorized</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.415.1">&gt;</span></span>
     <span class="hljs-tag"><span class="koboSpan" id="kobo.416.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.417.1">AuthorizeRouteView</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.418.1">&gt;</span></span>
     <span class="hljs-tag"><span class="koboSpan" id="kobo.419.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.420.1">FocusOnNavigate</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.421.1">RouteData</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.422.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.423.1">"@routeData"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.424.1">Selector</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.425.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.426.1">"h1"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.427.1"> /&gt;</span></span>
 <span class="hljs-tag"><span class="koboSpan" id="kobo.428.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.429.1">Found</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.430.1">&gt;</span></span>
 <span class="hljs-tag"><span class="koboSpan" id="kobo.431.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.432.1">NotFound</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.433.1">&gt;</span></span>
     <span class="hljs-tag"><span class="koboSpan" id="kobo.434.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.435.1">PageTitle</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.436.1">&gt;</span></span><span class="koboSpan" id="kobo.437.1">Not found</span><span class="hljs-tag"><span class="koboSpan" id="kobo.438.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.439.1">PageTitle</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.440.1">&gt;</span></span>
     <span class="hljs-tag"><span class="koboSpan" id="kobo.441.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.442.1">LayoutView</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.443.1">Layout</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.444.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.445.1">"@typeof(MainLayout)"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.446.1">&gt;</span></span>
         <span class="hljs-tag"><span class="koboSpan" id="kobo.447.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.448.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.449.1">role</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.450.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.451.1">"alert"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.452.1">&gt;</span></span><span class="koboSpan" id="kobo.453.1">Sorry, there's nothing at this address.</span><span class="hljs-tag"><span class="koboSpan" id="kobo.454.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.455.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.456.1">&gt;</span></span>
     <span class="hljs-tag"><span class="koboSpan" id="kobo.457.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.458.1">LayoutView</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.459.1">&gt;</span></span>
 <span class="hljs-tag"><span class="koboSpan" id="kobo.460.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.461.1">NotFound</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.462.1">&gt;</span></span>
</code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.463.1">In previous versions of Blazor, we had to surround the code with </span><code class="inlineCode"><span class="koboSpan" id="kobo.464.1">&lt;CascadingAuthenticationState&gt;</span></code><span class="koboSpan" id="kobo.465.1">, but with .NET 8, that is handled automatically by adding the call to </span><code class="inlineCode"><span class="koboSpan" id="kobo.466.1">AddCascadingAuthenticationState</span></code><span class="koboSpan" id="kobo.467.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.468.1">Now, only two things remain: a page that we can secure and a login link display.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.469.1">In</span><a id="_idIndexMarker385"/><span class="koboSpan" id="kobo.470.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.471.1">Components</span></code><span class="koboSpan" id="kobo.472.1"> folder, add a new Razor component called </span><code class="inlineCode"><span class="koboSpan" id="kobo.473.1">LoginStatus.razor</span></code><span class="koboSpan" id="kobo.474.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.475.1">Replace the content with the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.476.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.477.1">AuthorizeView</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.478.1">&gt;</span></span>
    <span class="hljs-tag"><span class="koboSpan" id="kobo.479.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.480.1">Authorized</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.481.1">&gt;</span></span>
        <span class="hljs-tag"><span class="koboSpan" id="kobo.482.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.483.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.484.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.485.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.486.1">"authentication/logout"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.487.1">&gt;</span></span><span class="koboSpan" id="kobo.488.1">Log out</span><span class="hljs-tag"><span class="koboSpan" id="kobo.489.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.490.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.491.1">&gt;</span></span>
    <span class="hljs-tag"><span class="koboSpan" id="kobo.492.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.493.1">Authorized</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.494.1">&gt;</span></span>
    <span class="hljs-tag"><span class="koboSpan" id="kobo.495.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.496.1">NotAuthorized</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.497.1">&gt;</span></span>
        <span class="hljs-tag"><span class="koboSpan" id="kobo.498.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.499.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.500.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.501.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.502.1">"account/login?returnUrl=/"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.503.1">&gt;</span></span><span class="koboSpan" id="kobo.504.1">Log in</span><span class="hljs-tag"><span class="koboSpan" id="kobo.505.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.506.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.507.1">&gt;</span></span>
    <span class="hljs-tag"><span class="koboSpan" id="kobo.508.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.509.1">NotAuthorized</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.510.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.511.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.512.1">AuthorizeView</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.513.1">&gt;</span></span>
</code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.514.1">LoginStatus</span></code><span class="koboSpan" id="kobo.515.1"> is a component that will show a login link if we are not authenticated and a logout link if we are authenticated.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.516.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.517.1">Components/Layout/MainLayout.razor</span></code><span class="koboSpan" id="kobo.518.1">:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.519.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.520.1">AuthorizeView</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.521.1">Roles</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.522.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.523.1">"Administrator"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.524.1">&gt;</span></span>
        <span class="hljs-tag"><span class="koboSpan" id="kobo.525.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.526.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.527.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.528.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.529.1">"sidebar"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.530.1">&gt;</span></span>
            <span class="hljs-tag"><span class="koboSpan" id="kobo.531.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.532.1">NavMenu</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.533.1"> /&gt;</span></span>
        <span class="hljs-tag"><span class="koboSpan" id="kobo.534.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.535.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.536.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.537.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.538.1">AuthorizeView</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.539.1">&gt;</span></span>
</code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.540.1">Replace the about link with the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.541.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.542.1">LoginStatus</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.543.1"> /&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.544.1">Now, our layout page will show us whether or not we’re logged in and give us the opportunity to log in or log out.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.545.1">In </span><code class="inlineCode"><span class="koboSpan" id="kobo.546.1">SharedComponents</span></code><span class="koboSpan" id="kobo.547.1"> and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.548.1">BlazorWebApp.Client</span></code><span class="koboSpan" id="kobo.549.1"> project, in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.550.1">_Imports</span></code><span class="koboSpan" id="kobo.551.1"> file of each project, add the following:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.552.1">@using Microsoft.AspNetCore.Authorization
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.553.1">Add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.554.1">authorize</span></code><span class="koboSpan" id="kobo.555.1"> attribute to the component we wish to secure.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.556.1">We have the following components in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.557.1">SharedComponents</span></code><span class="koboSpan" id="kobo.558.1"> project:</span></li>
</ol>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.559.1">Pages/Admin/BlogPostEdit.razor</span></code></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.560.1">Pages/Admin/BlogPostList.razor</span></code></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.561.1">Pages/Admin/CategoryList.razor</span></code></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.562.1">Pages/Admin/TagList.razor (in the BlazorWebApp.Client project)</span></code></p>
<p class="normal"><span class="koboSpan" id="kobo.563.1">In each of the preceding components, add the following attribute:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.564.1">@attribute [Authorize]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.565.1">This is all it takes, some configuration, and then we are all set.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.566.1">Now, start our </span><code class="inlineCode"><span class="koboSpan" id="kobo.567.1">BlazorWebApp</span></code><span class="koboSpan" id="kobo.568.1"> and see if you can access the </span><code class="inlineCode"><span class="koboSpan" id="kobo.569.1">/admin/blogposts</span></code><span class="koboSpan" id="kobo.570.1"> page (spoiler: you shouldn’t be able to); log in (create a user) and see if you can access the page now.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.571.1">Our</span><a id="_idIndexMarker386"/><span class="koboSpan" id="kobo.572.1"> admin interface is secured.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.573.1">In the next section, we will secure the Blazor WebAssembly version of our blog and the API.</span></p>
<h1 class="heading-1" id="_idParaDest-166"><span class="koboSpan" id="kobo.574.1">Securing Blazor WebAssembly</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.575.1">In the previous editions</span><a id="_idIndexMarker387"/><span class="koboSpan" id="kobo.576.1"> of this book, we built two versions of the blog, one for Blazor Server and one for Blazor WebAssembly. </span><span class="koboSpan" id="kobo.576.2">In this edition, the whole point is that we don’t have to choose one over the other. </span><span class="koboSpan" id="kobo.576.3">As previously mentioned, there are two projects, </span><code class="inlineCode"><span class="koboSpan" id="kobo.577.1">BlazorWebApp</span></code><span class="koboSpan" id="kobo.578.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.579.1">BlazorWebApp.Client</span></code><span class="koboSpan" id="kobo.580.1">. </span><span class="koboSpan" id="kobo.580.2">In the client project, we add all the components we want to be able to run as WebAssembly. </span><span class="koboSpan" id="kobo.580.3">Here is the really cool part. </span><span class="koboSpan" id="kobo.580.4">We have our </span><code class="inlineCode"><span class="koboSpan" id="kobo.581.1">TagList</span></code><span class="koboSpan" id="kobo.582.1"> component in the client project. </span><span class="koboSpan" id="kobo.582.2">If we are running it as InteractiveAuto, it will first render on the server using SignalR using the configuration found in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.583.1">BlazorWebApp</span></code><span class="koboSpan" id="kobo.584.1"> project. </span><span class="koboSpan" id="kobo.584.2">But the next time the site runs, it will load the WebAssembly version and use the configuration in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.585.1">BlazorWebApp.Client</span></code><span class="koboSpan" id="kobo.586.1"> project. </span><span class="koboSpan" id="kobo.586.2">So, the same component can use a different dependency injection. </span><span class="koboSpan" id="kobo.586.3">In one case, it will use direct data access, and in the other, it will use the API client we created in the previous chapter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.587.1">For us to </span><a id="_idIndexMarker388"/><span class="koboSpan" id="kobo.588.1">be able to access our API, we need to set up </span><code class="inlineCode"><span class="koboSpan" id="kobo.589.1">HttpClient</span></code><span class="koboSpan" id="kobo.590.1">:</span></p>
<p class="normal"><span class="koboSpan" id="kobo.591.1">But first, we need to get authentication information from the server. </span><span class="koboSpan" id="kobo.591.2">WebAssembly doesn’t really log in; it gets the information from the server and uses the authentication cookie for additional calls to the server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.592.1">In the server project, we added a </span><code class="inlineCode"><span class="koboSpan" id="kobo.593.1">PersistingServerAuthenticationStateProvider</span></code><span class="koboSpan" id="kobo.594.1"> to store information about the logged-in user. </span><span class="koboSpan" id="kobo.594.2">On the client, we need to get that information.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.595.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.596.1">BlazorWebApp.Client</span></code><span class="koboSpan" id="kobo.597.1"> project, add a new class in the root called </span><code class="inlineCode"><span class="koboSpan" id="kobo.598.1">PersistentAuthenticationStateProvider.cs</span></code><span class="koboSpan" id="kobo.599.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.600.1">Replace the code with the following:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.601.1">using</span></span><span class="koboSpan" id="kobo.602.1"> BlazorWebApp.Client;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.603.1">using</span></span><span class="koboSpan" id="kobo.604.1"> Microsoft.AspNetCore.Components;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.605.1">using</span></span><span class="koboSpan" id="kobo.606.1"> Microsoft.AspNetCore.Components.Authorization;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.607.1">using</span></span><span class="koboSpan" id="kobo.608.1"> System.Security.Claims;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.609.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.610.1">BlazorApp1.Client</span></span><span class="koboSpan" id="kobo.611.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.612.1">internal</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.613.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.614.1">PersistentAuthenticationStateProvider</span></span><span class="koboSpan" id="kobo.615.1"> : </span><span class="hljs-title"><span class="koboSpan" id="kobo.616.1">AuthenticationStateProvider</span></span><span class="koboSpan" id="kobo.617.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.618.1">private</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.619.1">static</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.620.1">readonly</span></span><span class="koboSpan" id="kobo.621.1"> Task&lt;AuthenticationState&gt; defaultUnauthenticatedTask =
        Task.FromResult(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.622.1">new</span></span><span class="koboSpan" id="kobo.623.1"> AuthenticationState(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.624.1">new</span></span><span class="koboSpan" id="kobo.625.1"> ClaimsPrincipal(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.626.1">new</span></span><span class="koboSpan" id="kobo.627.1"> ClaimsIdentity())));
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.628.1">private</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.629.1">readonly</span></span><span class="koboSpan" id="kobo.630.1"> Task&lt;AuthenticationState&gt; authenticationStateTask = defaultUnauthenticatedTask;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.631.1">public</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.632.1">PersistentAuthenticationStateProvider</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.633.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.634.1">PersistentComponentState state</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.635.1">)</span></span><span class="koboSpan" id="kobo.636.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.637.1">if</span></span><span class="koboSpan" id="kobo.638.1"> (!state.TryTakeFromJson&lt;UserInfo&gt;(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.639.1">nameof</span></span><span class="koboSpan" id="kobo.640.1">(UserInfo), </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.641.1">out</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.642.1">var</span></span><span class="koboSpan" id="kobo.643.1"> userInfo) || userInfo </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.644.1">is</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.645.1">null</span></span><span class="koboSpan" id="kobo.646.1">)
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.647.1">return</span></span><span class="koboSpan" id="kobo.648.1">;
        }
        List&lt;Claim&gt; claims = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.649.1">new</span></span><span class="koboSpan" id="kobo.650.1">();
        claims.Add(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.651.1">new</span></span><span class="koboSpan" id="kobo.652.1"> Claim(ClaimTypes.NameIdentifier, userInfo.UserId));
        claims.Add(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.653.1">new</span></span><span class="koboSpan" id="kobo.654.1"> Claim(ClaimTypes.Name, userInfo.Email??</span><span class="hljs-string"><span class="koboSpan" id="kobo.655.1">""</span></span><span class="koboSpan" id="kobo.656.1">));
        claims.Add(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.657.1">new</span></span><span class="koboSpan" id="kobo.658.1"> Claim(ClaimTypes.Email, userInfo.Email??</span><span class="hljs-string"><span class="koboSpan" id="kobo.659.1">""</span></span><span class="koboSpan" id="kobo.660.1">));
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.661.1">foreach</span></span><span class="koboSpan" id="kobo.662.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.663.1">var</span></span><span class="koboSpan" id="kobo.664.1"> role </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.665.1">in</span></span><span class="koboSpan" id="kobo.666.1"> userInfo.Roles)
        {
            claims.Add(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.667.1">new</span></span><span class="koboSpan" id="kobo.668.1"> Claim(ClaimTypes.Role, role));
        }
        authenticationStateTask = Task.FromResult(
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.669.1">new</span></span><span class="koboSpan" id="kobo.670.1"> AuthenticationState(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.671.1">new</span></span><span class="koboSpan" id="kobo.672.1"> ClaimsPrincipal(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.673.1">new</span></span><span class="koboSpan" id="kobo.674.1"> ClaimsIdentity(claims,
                authenticationType: </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.675.1">nameof</span></span><span class="koboSpan" id="kobo.676.1">(PersistentAuthenticationStateProvider)))));
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.677.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.678.1">override</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.679.1"> Task&lt;AuthenticationState&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.680.1">GetAuthenticationStateAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.681.1">()</span></span><span class="koboSpan" id="kobo.682.1"> =&gt; authenticationStateTask;
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.683.1">This is also</span><a id="_idIndexMarker389"/><span class="koboSpan" id="kobo.684.1"> taken from the Blazor template (with authentication). </span><span class="koboSpan" id="kobo.684.2">Only minor modifications appear here, like adding roles.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.685.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.686.1">BlazorWebApp.Client</span></code><span class="koboSpan" id="kobo.687.1"> project, in </span><code class="inlineCode"><span class="koboSpan" id="kobo.688.1">Program.cs</span></code><span class="koboSpan" id="kobo.689.1">, add the following lines just above </span><code class="inlineCode"><span class="koboSpan" id="kobo.690.1">builder.Build().RunAsync()</span></code><span class="koboSpan" id="kobo.691.1">;:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.692.1">builder.Services.AddAuthorizationCore();
builder.Services.AddCascadingAuthenticationState();
builder.Services.AddSingleton&lt;AuthenticationStateProvider, PersistentAuthenticationStateProvider&gt;();
builder.Services.AddHttpClient(</span><span class="hljs-string"><span class="koboSpan" id="kobo.693.1">"Api"</span></span><span class="koboSpan" id="kobo.694.1">,client =&gt; client.BaseAddress = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.695.1">new</span></span><span class="koboSpan" id="kobo.696.1"> Uri(builder.HostEnvironment.BaseAddress)); 
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.697.1">This will enable authentication, add cascading </span><code class="inlineCode"><span class="koboSpan" id="kobo.698.1">authentication state</span></code><span class="koboSpan" id="kobo.699.1"> to our components, and get the logged-in user from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.700.1">Persistent Component State</span></code><span class="koboSpan" id="kobo.701.1">. </span><span class="koboSpan" id="kobo.701.2">The name of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.702.1">HttpClient</span></code><span class="koboSpan" id="kobo.703.1"> is “</span><code class="inlineCode"><span class="koboSpan" id="kobo.704.1">Api"</span></code><span class="koboSpan" id="kobo.705.1">; this is the name we used in </span><em class="chapterRef"><span class="koboSpan" id="kobo.706.1">Chapter 7</span></em><span class="koboSpan" id="kobo.707.1">, </span><em class="italic"><span class="koboSpan" id="kobo.708.1">Creating an API</span></em><span class="koboSpan" id="kobo.709.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.710.1">We also need </span><a id="_idIndexMarker390"/><span class="koboSpan" id="kobo.711.1">to set up dependency injection so that when we ask for an </span><code class="inlineCode"><span class="koboSpan" id="kobo.712.1">IBlogAPI</span></code><span class="koboSpan" id="kobo.713.1">, we will get the </span><code class="inlineCode"><span class="koboSpan" id="kobo.714.1">BlogApiWebClient</span></code><span class="koboSpan" id="kobo.715.1"> that we created in </span><em class="chapterRef"><span class="koboSpan" id="kobo.716.1">Chapter 7</span></em><span class="koboSpan" id="kobo.717.1">, </span><em class="italic"><span class="koboSpan" id="kobo.718.1">Creating an API</span></em><span class="koboSpan" id="kobo.719.1">.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.720.1">In </span><code class="inlineCode"><span class="koboSpan" id="kobo.721.1">Program.cs</span></code><span class="koboSpan" id="kobo.722.1">, add the following code below the </span><code class="inlineCode"><span class="koboSpan" id="kobo.723.1">builder.Services.AddSingleton&lt;AuthenticationStateProvider, PersistentAuthenticationStateProvider&gt;();</span></code><span class="koboSpan" id="kobo.724.1"> line:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.725.1">builder.Services.AddTransient&lt;IBlogApi, BlogApiWebClient&gt;();
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.726.1">Now, when we ask for an </span><code class="inlineCode"><span class="koboSpan" id="kobo.727.1">IBlogApi</span></code><span class="koboSpan" id="kobo.728.1">, we will get the API web client that accesses the data through an API. </span><span class="koboSpan" id="kobo.728.2">The really cool thing here is that, depending on whether the component is rendered on the server (Static, InteractiveServer), the client (InteractiveWebAssembly), or a combination (InteractiveAuto), it will choose the right client for that scenario. </span><span class="koboSpan" id="kobo.728.3">We have the ability to choose the one that is best suited.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="6"><span class="koboSpan" id="kobo.729.1">Make sure to add the required namespaces as well.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.730.1">Now, everything is prepared for us to secure when running in WebAssembly mode.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.731.1">This sample is about securing WebAssembly when running with an ASP.NET backend. </span><span class="koboSpan" id="kobo.731.2">In </span><em class="chapterRef"><span class="koboSpan" id="kobo.732.1">Chapter 16</span></em><span class="koboSpan" id="kobo.733.1">, </span><em class="italic"><span class="koboSpan" id="kobo.734.1">Going Deeper into WebAssembly</span></em><span class="koboSpan" id="kobo.735.1">, we will take a look at how to secure a Blazor WebAssembly app.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.736.1">Let’s give it a try:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.737.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.738.1">BlazorWebApp.Client</span></code><span class="koboSpan" id="kobo.739.1"> project, open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.740.1">Pages/Admin/TagList.razor</span></code><span class="koboSpan" id="kobo.741.1">. </span><span class="koboSpan" id="kobo.741.2">We have been running our component with the InteractiveServer render mode up to this point. </span><span class="koboSpan" id="kobo.741.3">Now, let’s change that and run it as InteractiveWebAssembly instead.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.742.1">Change </span><code class="inlineCode"><span class="koboSpan" id="kobo.743.1">@rendermode InteractiveServer</span></code><span class="koboSpan" id="kobo.744.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.745.1">@rendermode InteractiveWebAssembly</span></code><span class="koboSpan" id="kobo.746.1">. </span><span class="koboSpan" id="kobo.746.2">That’s it! </span><span class="koboSpan" id="kobo.746.3">Now, our component will first render on the server (since we are running server pre-rendering), and then WebAssembly will take over and render the component again. </span><span class="koboSpan" id="kobo.746.4">It will pick up the authentication information stored in the component state and use our web API to retrieve the data from our API. </span><span class="koboSpan" id="kobo.746.5">This is because the WebAssembly application is configured to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.747.1">BlogApiWebClient</span></code><span class="koboSpan" id="kobo.748.1"> when we ask for an instance of </span><code class="inlineCode"><span class="koboSpan" id="kobo.749.1">IBlogApi</span></code><span class="koboSpan" id="kobo.750.1">. </span><span class="koboSpan" id="kobo.750.2">So, the same component is first prerendered on the server using direct data access, then again using the web API. </span><span class="koboSpan" id="kobo.750.3">Pretty cool!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.751.1">Now, run the project, navigate to </span><code class="inlineCode"><span class="koboSpan" id="kobo.752.1">/Admin/Tags</span></code><span class="koboSpan" id="kobo.753.1">, and try to edit some tags. </span><span class="koboSpan" id="kobo.753.2">This component is now running on WebAssembly. </span><span class="koboSpan" id="kobo.753.3">You can try to change it to </span><code class="inlineCode"><span class="koboSpan" id="kobo.754.1">@rendermode InteractiveAuto</span></code><span class="koboSpan" id="kobo.755.1">. </span><span class="koboSpan" id="kobo.755.2">To see the behavior, this will first hook up SignalR and then, on the next load, switch to WebAssembly.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.756.1">But what if </span><a id="_idIndexMarker391"/><span class="koboSpan" id="kobo.757.1">different users have different permissions?</span></p>
<p class="normal"><span class="koboSpan" id="kobo.758.1">That is where roles come in.</span></p>
<h1 class="heading-1" id="_idParaDest-167"><span class="koboSpan" id="kobo.759.1">Adding roles</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.760.1">Blazor Server and Blazor WebAssembly handle roles a bit differently; it’s nothing major, but we need to do different implementations. </span><span class="koboSpan" id="kobo.760.2">In this chapter, we will take a look at implementing it for our current project (per component) and return to roles in </span><em class="chapterRef"><span class="koboSpan" id="kobo.761.1">Chapter 16</span></em><span class="koboSpan" id="kobo.762.1">, </span><em class="italic"><span class="koboSpan" id="kobo.763.1">Going Deeper into WebAssembly</span></em><span class="koboSpan" id="kobo.764.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-168"><span class="koboSpan" id="kobo.765.1">Configuring Auth0 by adding roles</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.766.1">Let’s </span><a id="_idIndexMarker392"/><span class="koboSpan" id="kobo.767.1">start by adding</span><a id="_idIndexMarker393"/><span class="koboSpan" id="kobo.768.1"> roles in Auth0:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.769.1">Log in to </span><code class="inlineCode"><span class="koboSpan" id="kobo.770.1">Auth0</span></code><span class="koboSpan" id="kobo.771.1">, navigate to </span><strong class="screenText"><span class="koboSpan" id="kobo.772.1">User Management</span></strong><span class="koboSpan" id="kobo.773.1"> | </span><strong class="screenText"><span class="koboSpan" id="kobo.774.1">Roles</span></strong><span class="koboSpan" id="kobo.775.1">, and click </span><strong class="screenText"><span class="koboSpan" id="kobo.776.1">Create Role</span></strong><span class="koboSpan" id="kobo.777.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.778.1">Enter the name </span><code class="inlineCode"><span class="koboSpan" id="kobo.779.1">Administrator</span></code><span class="koboSpan" id="kobo.780.1"> and the description </span><code class="inlineCode"><span class="koboSpan" id="kobo.781.1">Can do anything</span></code><span class="koboSpan" id="kobo.782.1"> and press </span><strong class="screenText"><span class="koboSpan" id="kobo.783.1">Create</span></strong><span class="koboSpan" id="kobo.784.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.785.1">Go to the </span><strong class="screenText"><span class="koboSpan" id="kobo.786.1">Users</span></strong><span class="koboSpan" id="kobo.787.1"> tab, click </span><strong class="screenText"><span class="koboSpan" id="kobo.788.1">Add Users</span></strong><span class="koboSpan" id="kobo.789.1">, search for your user, and then click </span><strong class="screenText"><span class="koboSpan" id="kobo.790.1">Assign</span></strong><span class="koboSpan" id="kobo.791.1">. </span><span class="koboSpan" id="kobo.791.2">You can also manage roles from the </span><strong class="screenText"><span class="koboSpan" id="kobo.792.1">Users</span></strong><span class="koboSpan" id="kobo.793.1"> menu on the left.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.794.1">By default, roles won’t be sent to the client, so we need to enrich the data to include roles.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.795.1">We do that by adding an action.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.796.1">Go to </span><strong class="screenText"><span class="koboSpan" id="kobo.797.1">Actions</span></strong><span class="koboSpan" id="kobo.798.1">, and then </span><strong class="screenText"><span class="koboSpan" id="kobo.799.1">Flows</span></strong><span class="koboSpan" id="kobo.800.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.801.1">Flows are a way to execute code in a particular flow.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.802.1">We want </span><code class="inlineCode"><span class="koboSpan" id="kobo.803.1">Auth0</span></code><span class="koboSpan" id="kobo.804.1"> to add our roles when we log in.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="6"><span class="koboSpan" id="kobo.805.1">Select </span><strong class="screenText"><span class="koboSpan" id="kobo.806.1">Login</span></strong><span class="koboSpan" id="kobo.807.1">, and </span><a id="_idIndexMarker394"/><span class="koboSpan" id="kobo.808.1">there we will see the flow; in our case, we don’t </span><a id="_idIndexMarker395"/><span class="koboSpan" id="kobo.809.1">have anything yet.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.810.1">On the right-hand side, click </span><strong class="screenText"><span class="koboSpan" id="kobo.811.1">Custom</span></strong><span class="koboSpan" id="kobo.812.1"> and the plus sign. </span><span class="koboSpan" id="kobo.812.2">As a small pop-up menu appears, select </span><strong class="screenText"><span class="koboSpan" id="kobo.813.1">Build from scratch</span></strong><span class="koboSpan" id="kobo.814.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.815.1">Name the action </span><code class="inlineCode"><span class="koboSpan" id="kobo.816.1">Add Roles</span></code><span class="koboSpan" id="kobo.817.1">, leave </span><strong class="screenText"><span class="koboSpan" id="kobo.818.1">Trigger</span></strong><strong class="keyWord"> </strong><span class="koboSpan" id="kobo.819.1">and </span><strong class="screenText"><span class="koboSpan" id="kobo.820.1">Runtime</span></strong><span class="koboSpan" id="kobo.821.1"> as is, and press </span><strong class="screenText"><span class="koboSpan" id="kobo.822.1">Create</span></strong><span class="koboSpan" id="kobo.823.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.824.1">We will see a window where we can write our action.</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="9"><span class="koboSpan" id="kobo.825.1">Replace all the code with the following:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.826.1">/**</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.827.1"> * @param {Event} event - Details about the user and the context in which they are logging in.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.828.1"> * @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.829.1"> */</span></span><span class="koboSpan" id="kobo.830.1">
exports.onExecutePostLogin = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.831.1">async</span></span><span class="koboSpan" id="kobo.832.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.833.1">event</span></span><span class="koboSpan" id="kobo.834.1">, api) =&gt; {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.835.1">const</span></span><span class="koboSpan" id="kobo.836.1"> claimName  = </span><span class="hljs-string"><span class="koboSpan" id="kobo.837.1">'http://schemas.microsoft.com/ws/2008/06/identity/claims/role'</span></span>
  <span class="hljs-keyword"><span class="koboSpan" id="kobo.838.1">if</span></span><span class="koboSpan" id="kobo.839.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.840.1">event</span></span><span class="koboSpan" id="kobo.841.1">.authorization) {
    api.idToken.setCustomClaim(claimName, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.842.1">event</span></span><span class="koboSpan" id="kobo.843.1">.authorization.roles);
    api.accessToken.setCustomClaim(claimName, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.844.1">event</span></span><span class="koboSpan" id="kobo.845.1">.authorization.roles);
  }
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.846.1">Click </span><strong class="screenText"><span class="koboSpan" id="kobo.847.1">Deploy</span></strong><span class="koboSpan" id="kobo.848.1"> and then </span><strong class="screenText"><span class="koboSpan" id="kobo.849.1">Back to flow</span></strong><span class="koboSpan" id="kobo.850.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.851.1">Click </span><strong class="screenText"><span class="koboSpan" id="kobo.852.1">Custom</span></strong><span class="koboSpan" id="kobo.853.1"> again, and we will see our newly created action.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.854.1">Drag the </span><strong class="screenText"><span class="koboSpan" id="kobo.855.1">Add Roles</span></strong><span class="koboSpan" id="kobo.856.1"> action to the arrow between </span><strong class="screenText"><span class="koboSpan" id="kobo.857.1">Start</span></strong><span class="koboSpan" id="kobo.858.1"> and </span><strong class="screenText"><span class="koboSpan" id="kobo.859.1">Complete</span></strong><span class="koboSpan" id="kobo.860.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.861.1">Click </span><strong class="screenText"><span class="koboSpan" id="kobo.862.1">Apply</span></strong><span class="koboSpan" id="kobo.863.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.864.1">Now, we have an action that will add the roles to our login token.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.865.1">Our user is now an administrator. </span><span class="koboSpan" id="kobo.865.2">It’s worth noting that roles are a paid feature in Auth0 and will only be free during the trial.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.866.1">Now, let’s set up Blazor to use this new role.</span></p>
<h2 class="heading-2" id="_idParaDest-169"><span class="koboSpan" id="kobo.867.1">Adding roles to Blazor</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.868.1">Since we are</span><a id="_idIndexMarker396"/><span class="koboSpan" id="kobo.869.1"> using the </span><a id="_idIndexMarker397"/><span class="koboSpan" id="kobo.870.1">Auth0 library, the setup is almost done for Blazor.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.871.1">Let’s modify a component to show whether the user is an administrator:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.872.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.873.1">Components</span></code><span class="koboSpan" id="kobo.874.1"> project, open </span><code class="inlineCode"><span class="koboSpan" id="kobo.875.1">Shared/NavMenu.razor</span></code><span class="koboSpan" id="kobo.876.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.877.1">At the top of the component, add the following:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.878.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.879.1">AuthorizeView</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.880.1">Roles</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.881.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.882.1">"Administrator"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.883.1">&gt;</span></span>
    <span class="hljs-tag"><span class="koboSpan" id="kobo.884.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.885.1">Authorized</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.886.1">&gt;</span></span><span class="koboSpan" id="kobo.887.1">
        Hi admin!
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.888.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.889.1">Authorized</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.890.1">&gt;</span></span>
    <span class="hljs-tag"><span class="koboSpan" id="kobo.891.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.892.1">NotAuthorized</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.893.1">&gt;</span></span><span class="koboSpan" id="kobo.894.1">
        You are not an admin =(
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.895.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.896.1">NotAuthorized</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.897.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.898.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.899.1">AuthorizeView</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.900.1">&gt;</span></span>
</code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.901.1">Now, run our BlazorWebApp project.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.902.1">If we log in, we should be able to see text to the left saying </span><strong class="screenText"><span class="koboSpan" id="kobo.903.1">Hi Admin!</span></strong><span class="koboSpan" id="kobo.904.1"> in black text on top of dark blue, so it might not be very visible. </span><span class="koboSpan" id="kobo.904.2">We will take care of this in </span><em class="chapterRef"><span class="koboSpan" id="kobo.905.1">Chapter 9</span></em><span class="koboSpan" id="kobo.906.1">, </span><em class="italic"><span class="koboSpan" id="kobo.907.1">Sharing Code and Resources</span></em><span class="koboSpan" id="kobo.908.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-170"><span class="koboSpan" id="kobo.909.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.910.1">In this chapter, we learned how to add authentication to our existing site. </span><span class="koboSpan" id="kobo.910.2">It is easier to add authentication when creating a project. </span><span class="koboSpan" id="kobo.910.3">Still, now we have a better understanding of what is going on under the hood and how to handle adding an external source for authentication.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.911.1">Throughout the book, we have shared components between the different hosting models.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.912.1">In the next chapter, we will look at sharing even more things, like static files and CSS, and try to make everything look nice.</span></p>
</div>
</body></html>