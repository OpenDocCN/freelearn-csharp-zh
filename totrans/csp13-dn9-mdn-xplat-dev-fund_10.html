<html><head></head><body><div><div><div><h1 class="chapterNumber">10</h1>
    <h1 id="_idParaDest-602" class="chapterTitle">Working with Data Using Entity Framework Core</h1>
    <p class="normal">This chapter is about reading from and writing to relational data stores, such as SQLite and <a id="_idIndexMarker1549"/>SQL Server, by using the object-to-data store mapping technology named <strong class="keyWord">Entity Framework Core</strong> (<strong class="keyWord">EF Core</strong>).</p>
    <p class="normal">This chapter will cover the following topics:</p>
    <ul>
      <li class="bulletList">Understanding modern databases</li>
      <li class="bulletList">Setting up EF Core in a .NET project</li>
      <li class="bulletList">Defining EF Core models</li>
      <li class="bulletList">Querying EF Core models</li>
    </ul>
    <h1 id="_idParaDest-603" class="heading-1">Understanding modern databases</h1>
    <p class="normal">Two of <a id="_idIndexMarker1550"/>the most common <a id="_idIndexMarker1551"/>places to store data are in a <strong class="keyWord">relational database management system</strong> (<strong class="keyWord">RDBMS</strong>), such as SQL Server, PostgreSQL, MySQL, and SQLite, or <a id="_idIndexMarker1552"/>a <strong class="keyWord">NoSQL</strong> database, such as Azure Cosmos DB, Redis, MongoDB, and Apache Cassandra.</p>
    <p class="normal">Relational databases were invented in the 1970s. They are queried with <strong class="keyWord">Structured Query Language</strong> (<strong class="keyWord">SQL</strong>). At the time, data storage costs were high, so they reduced <a id="_idIndexMarker1553"/>data duplication as much as possible. Data is stored in tabular structures with rows and columns that are tricky to refactor once in production. They can be difficult and expensive to scale.</p>
    <p class="normal">NoSQL databases do not just mean “no SQL”; they can also mean “not only SQL.” They were <a id="_idIndexMarker1554"/>invented in the 2000s, after the internet and the web had become popular, and adopted many of the learnings from that era of software. They are designed for massive scalability, high performance, and making programming easier by providing maximum flexibility and allowing schema changes at any time because they do not enforce a structure.</p>
    <p class="normal">If you know <a id="_idIndexMarker1555"/>nothing about relational databases, then you should read the database primer that I wrote at the following link:</p>
    <p class="normal"><a href="https://github.com/markjprice/cs13net9/blob/main/docs/ch10-database-primer.md">https://github.com/markjprice/cs13net9/blob/main/docs/ch10-database-primer.md</a></p>
    <h2 id="_idParaDest-604" class="heading-2">Understanding legacy Entity Framework</h2>
    <p class="normal"><strong class="keyWord">Entity Framework</strong> (<strong class="keyWord">EF</strong>) was first released as part of .NET Framework 3.5 with Service <a id="_idIndexMarker1556"/>Pack 1 back in late 2008. Since then, EF has evolved, as Microsoft has observed how programmers use <strong class="keyWord">object-relational mapping</strong> (<strong class="keyWord">ORM</strong>) tools in the real world.</p>
    <p class="normal">ORMs use <a id="_idIndexMarker1557"/>a mapping definition to associate columns in tables with properties in classes. Then, a programmer can interact with objects of different types in a way that they are familiar with, instead of having to deal with knowing how to store the values in a relational table or another structure provided by a NoSQL data store.</p>
    <p class="normal">The version <a id="_idIndexMarker1558"/>of EF included with .NET Framework is <strong class="keyWord">Entity Framework 6</strong> (<strong class="keyWord">EF6</strong>). It is mature and stable and supports an EDMX (XML file) way of defining the model, as well as complex inheritance models and a few other advanced features.</p>
    <p class="normal">EF 6.3 and later versions have been extracted from .NET Framework as a separate package, so they can be supported on .NET Core 3 and later. This enables <a id="_idIndexMarker1559"/>existing projects like web applications and services to be ported and run cross-platform. However, EF6 should be considered legacy technology because it has some limitations when running cross-platform and no new features will be added to it.</p>
    <h2 id="_idParaDest-605" class="heading-2">Using the legacy Entity Framework 6.3 or later</h2>
    <p class="normal">To use <a id="_idIndexMarker1560"/>the legacy Entity Framework in a .NET <a id="_idIndexMarker1561"/>Core 3 or later project, you must add a package reference to it in your project file, as shown in the following markup:</p>
    <pre class="programlisting code"><code class="hljs-code">&lt;PackageReference Include="EntityFramework" Version="6.5.1" /&gt;
</code></pre>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Only use legacy EF6 if you must; for example, you might use it to migrate a <strong class="keyWord">Windows Presentation Foundation</strong> (<strong class="keyWord">WPF</strong>) app that uses EF6 on .NET Framework to modern .NET. This book is about modern cross-platform development, so in the rest of this chapter, I will only cover the modern EF Core. You will not need to reference the legacy EF6 package as shown above in the projects for this chapter.</p>
    </div>
    <h2 id="_idParaDest-606" class="heading-2">Understanding Entity Framework Core</h2>
    <p class="normal">The truly <a id="_idIndexMarker1562"/>cross-platform version, <strong class="keyWord">EF Core</strong>, is different from the legacy Entity Framework. Although EF Core has a similar name, you should be aware of how it varies from EF6. The latest EF Core is version 9, to match .NET 9.</p>
    <div><p class="normal">EF Core 9 targets .NET 8 or later because the EF Core team wants as many developers as possible to benefit from new features in future releases even if you must target only long-term support releases of .NET. This means that you can use all the new features of EF Core 9 with either .NET 8 or .NET 9. But when EF Core 10 is released in November 2025, your projects will need to target .NET 10 to use it.</p>
    </div>
    <p class="normal">EF Core 3 and <a id="_idIndexMarker1563"/>later only work with platforms that support .NET Standard 2.1, meaning .NET Core 3 and later. EF Core 3 and later do not support .NET Standard 2.0 platforms like .NET Framework 4.8.</p>
    <p class="normal">As well as traditional RDBMSs, EF Core supports modern cloud-based, non-relational, schema-less data stores, such as Azure Cosmos DB and MongoDB, sometimes with third-party providers.</p>
    <p class="normal">EF Core has so many improvements in each release that this chapter cannot cover them all. In this chapter, I will focus on the fundamentals that all .NET developers should know and some of the most useful new features. You can learn more about EF Core and how to use it with SQL Server in my companion book, <em class="italic">Apps and Services with .NET 8</em>, or by reading the official documentation, found at the following link:</p>
    <p class="normal"><a href="https://learn.microsoft.com/en-us/ef/core/">https://learn.microsoft.com/en-us/ef/core/</a></p>
    <p class="normal">You can keep up with the latest EF Core news at the following link:</p>
    <p class="normal"><a href="https://aka.ms/efnews">https://aka.ms/efnews</a></p>
    <h2 id="_idParaDest-607" class="heading-2">Understanding Database First and Code First</h2>
    <p class="normal">There are two approaches to working with EF Core:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Database First</strong>: A database <a id="_idIndexMarker1564"/>already exists, so you build a model that matches its structure and features. This is the most common scenario in real life. You will see an example of this throughout this chapter.</li>
      <li class="bulletList"><strong class="keyWord">Code First</strong>: No database exists, so you build a model and then use EF Core to <a id="_idIndexMarker1565"/>create a database that matches its structure and features. You will see an example of this if you complete the online-only section linked to in one of the exercises at the end of this chapter.</li>
    </ul>
    <h2 id="_idParaDest-608" class="heading-2">Performance improvements in EF Core</h2>
    <p class="normal">The EF Core team continues to work hard on improving the performance of EF Core. For <a id="_idIndexMarker1566"/>example, if EF Core identifies that only a single statement will be executed against the database when <code class="inlineCode">SaveChanges</code> is called, then it does not create an explicit transaction as earlier versions do. That gives a 25% performance improvement to a common scenario.</p>
    <p class="normal">There is too much information about all the recent performance improvements to cover in this chapter, and you get all the benefits without needing to know how they work anyway. If you are interested (and it is fascinating what they looked at and how they took advantage of some cool SQL Server features in particular), then I recommend that you read the following posts from the EF Core team:</p>
    <ul>
      <li class="bulletList">Announcing <a id="_idIndexMarker1567"/>Entity Framework Core 7 Preview 6: Performance Edition: <a href="https://devblogs.microsoft.com/dotnet/announcing-ef-core-7-preview6-performance-optimizations/">https://devblogs.microsoft.com/dotnet/announcing-ef-core-7-preview6-performance-optimizations/</a></li>
      <li class="bulletList">Announcing <a id="_idIndexMarker1568"/>Entity Framework Core 6.0 Preview 4: Performance Edition: <a href="https://devblogs.microsoft.com/dotnet/announcing-entity-framework-core-6-0-preview-4-performance-edition/">https://devblogs.microsoft.com/dotnet/announcing-entity-framework-core-6-0-preview-4-performance-edition/</a></li>
    </ul>
    <h2 id="_idParaDest-609" class="heading-2">Using a sample relational database</h2>
    <p class="normal">To learn how <a id="_idIndexMarker1569"/>to manage an RDBMS using .NET, it would be useful to have a sample one so that you can practice on one that has a medium complexity and a decent number of sample records. Microsoft offers several sample databases, most of which are too complex for our needs, so instead, we will use <a id="_idIndexMarker1570"/>a database that was first created in the early 1990s known as <code class="inlineCode">Northwind</code>.</p>
    <p class="normal">Let’s take a <a id="_idIndexMarker1571"/>minute to look at a diagram of the <code class="inlineCode">Northwind</code> database. You can use the diagram in <em class="italic">Figure 10.1</em> to refer to as we write code and queries throughout this book:</p>
    <figure class="mediaobject"><img src="img/B22322_10_01.png" alt="" width="877" height="620"/></figure>
    <p class="packt_figref">Figure 10.1: The Northwind database tables and relationships</p>
    <p class="normal">You will write code to work with the <code class="inlineCode">Categories</code> and <code class="inlineCode">Products</code> tables later in this chapter, and other tables in later chapters. But before we do, note the following:</p>
    <ul>
      <li class="bulletList">Each category has a unique identifier, name, description, and picture.</li>
      <li class="bulletList">Each product has a unique identifier, name, unit price, units in stock, and other fields.</li>
      <li class="bulletList">Each product is associated with a category by storing the category’s unique identifier.</li>
      <li class="bulletList">The relationship between <code class="inlineCode">Categories</code> and <code class="inlineCode">Products</code> is one-to-many, meaning <a id="_idIndexMarker1572"/>each category can have zero or more products. This is indicated in <em class="italic">Figure 10.1</em> by an infinity symbol at one end (meaning many) and a yellow key at the other end (meaning one).</li>
    </ul>
    <h2 id="_idParaDest-610" class="heading-2">Using SQLite</h2>
    <p class="normal">SQLite is a small, fast, cross-platform, self-contained RDBMS that is available in the public <a id="_idIndexMarker1573"/>domain. It’s the most common RDBMS for mobile platforms such as iOS (iPhone and iPad) and Android. SQLite is the most used database engine in the world and there are more than one trillion SQLite databases <a id="_idIndexMarker1574"/>in active use. You can read more about this at <a href="https://www.sqlite.org/mostdeployed.html">https://www.sqlite.org/mostdeployed.html</a>.</p>
    <div><p class="normal">I decided to demonstrate databases using SQLite in this book since its important themes are cross-platform development and fundamental skills that only need basic database capabilities. I recommend that you initially complete the book code tasks using SQLite. If you also want to try the code tasks using SQL Server, then I provide documentation to do so in the online-only sections in the GitHub repository for this book.</p>
    </div>
    <h2 id="_idParaDest-611" class="heading-2">Using SQL Server or other SQL systems</h2>
    <p class="normal">Enterprises <a id="_idIndexMarker1575"/>that standardize on Windows tend to also use SQL <a id="_idIndexMarker1576"/>Server as their database. If you would prefer to use <a id="_idIndexMarker1577"/>SQL Server, please see the online instructions at the following link:</p>
    <p class="normal"><a href="https://github.com/markjprice/cs13net9/blob/main/docs/sql-server/README.md">https://github.com/markjprice/cs13net9/blob/main/docs/sql-server/README.md</a></p>
    <p class="normal">If you would prefer to use a different SQL system, then the SQL scripts that I provide should work with most SQL systems, for example, PostgreSQL or MySQL. However, I have not written step-by-step instructions for them and I make no guarantees they will work.</p>
    <p class="normal">My recommendation is to complete this book using SQLite, so you focus on learning what’s taught in the book about EF Core rather than adding the complication <a id="_idIndexMarker1578"/>of trying to use a different database system. Learning is <a id="_idIndexMarker1579"/>hard enough; don’t bite off more than you can chew, and don’t make it harder on yourself. Once you’ve learned what’s in the book, you can always repeat it with a different database system.</p>
    <h2 id="_idParaDest-612" class="heading-2">Setting up SQLite CLI tools for Windows</h2>
    <p class="normal">On Windows, we need to download SQLite CLI tools and add the folder for SQLite <a id="_idIndexMarker1580"/>to the system path so it will be found when we enter commands at a command prompt or terminal:</p>
    <ol>
      <li class="numberedList" value="1">Start your favorite browser and navigate to <a href="https://www.sqlite.org/download.html">https://www.sqlite.org/download.html</a>.</li>
      <li class="numberedList">Scroll down the page to the <strong class="screenText">Precompiled Binaries for Windows</strong> section.</li>
      <li class="numberedList">Click <strong class="screenText">sqlite-tools-win32-x86-3460100.zip</strong> (the file might have a higher version number), as shown in the following screenshot:</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_10_02.png" alt="" width="812" height="245"/></figure>
    <p class="packt_figref">Figure 10.2: Downloading SQLite for Windows</p>
    <ol>
      <li class="numberedList" value="4">Extract the ZIP file into a folder named <code class="inlineCode">C:\Sqlite\</code>. Make sure that the three extracted files, including <code class="inlineCode">sqlite3.exe</code>, are directly inside the <code class="inlineCode">C:\SQLite</code> folder or the executable will not be found later when you try to use it.</li>
      <li class="numberedList">In the Windows <strong class="screenText">Start</strong> menu, navigate to <strong class="screenText">Settings</strong>.</li>
      <li class="numberedList">Search for <code class="inlineCode">environment</code> and choose <strong class="screenText">Edit the system environment variables</strong>. On non-English versions of Windows, please search for the equivalent <a id="_idIndexMarker1581"/>word in your local language to find the setting.</li>
      <li class="numberedList">Click the <strong class="screenText">Environment Variables</strong> button.</li>
      <li class="numberedList">In <strong class="screenText">System variables</strong>, select <strong class="screenText">Path</strong> in the list, and then click <strong class="screenText">Edit…</strong>.</li>
      <li class="numberedList">If <code class="inlineCode">C:\SQLite</code> is not already in the path, then click <strong class="screenText">New</strong>, enter <code class="inlineCode">C:\Sqlite</code>, and press <em class="keystroke">Enter</em>.</li>
      <li class="numberedList">Click <strong class="screenText">OK</strong>, then <strong class="screenText">OK</strong>, then <strong class="screenText">OK</strong> again, and then close <strong class="screenText">Settings</strong>.</li>
      <li class="numberedList">To confirm that the path to SQLite has been configured correctly, at any command prompt or terminal, enter the following command to start SQLite:
        <pre class="programlisting con-one"><code class="hljs-con">sqlite3
</code></pre>
      </li>
      <li class="numberedList">Note the result, as shown in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">SQLite version 3.42.0 2023-05-16 12:36:15
Enter ".help" for usage hints.
Connected to a transient in-memory database.
Use ".open FILENAME" to reopen on a persistent database.
sqlite&gt;
</code></pre>
      </li>
      <li class="numberedList">To exit the SQLite command prompt, do the following:<ul>
          <li class="bulletList level-2">On Windows, press <em class="keystroke">Ctrl</em> + <em class="keystroke">C</em> twice.</li>
          <li class="bulletList level-2">On macOS, press <em class="keystroke">Ctrl</em> + <em class="keystroke">D</em>.</li>
        </ul>
      </li>
    </ol>
    <h2 id="_idParaDest-613" class="heading-2">Setting up SQLite for macOS and Linux</h2>
    <p class="normal">On macOS, SQLite <a id="_idIndexMarker1582"/>is included in the <code class="inlineCode">/usr/bin/</code> directory as <a id="_idIndexMarker1583"/>a command-line application named <code class="inlineCode">sqlite3</code>.</p>
    <p class="normal">On Linux, you can get set up with SQLite using the following command:</p>
    <pre class="programlisting con"><code class="hljs-con">sudo apt-get install sqlite3
</code></pre>
    <p class="normal">SQLite can be downloaded and installed for other OSs from the following link:</p>
    <p class="normal"><a href="https://www.sqlite.org/download.html">https://www.sqlite.org/download.html</a></p>
    <h1 id="_idParaDest-614" class="heading-1">Setting up EF Core in a .NET project</h1>
    <p class="normal">Now that <a id="_idIndexMarker1584"/>we have <a id="_idIndexMarker1585"/>a database system set up, we can create a database and .NET project that uses it.</p>
    <h2 id="_idParaDest-615" class="heading-2">Creating a console app for working with EF Core</h2>
    <p class="normal">First, we will create a console app project for this chapter.</p>
    <p class="normal">Use <a id="_idIndexMarker1586"/>your preferred code editor to create a new project, as defined in the following list:</p>
    <ul>
      <li class="bulletList">Project template: <strong class="screenText">Console App </strong>/ <code class="inlineCode">console</code></li>
      <li class="bulletList">Project file and folder: <code class="inlineCode">WorkingWithEFCore</code></li>
      <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter10</code></li>
    </ul>
    <h2 id="_idParaDest-616" class="heading-2">Creating the Northwind sample database for SQLite</h2>
    <p class="normal">Now we <a id="_idIndexMarker1587"/>can create the <code class="inlineCode">Northwind</code> sample database for SQLite using an SQL script:</p>
    <ol>
      <li class="numberedList" value="1">If you have not previously cloned or downloaded the ZIP for the GitHub repository for this book, then do so now using the following link: <a href="https://github.com/markjprice/cs13net9">https://github.com/markjprice/cs13net9</a>.</li>
      <li class="numberedList">Copy the script to create the <code class="inlineCode">Northwind</code> database for SQLite from the following path in your local Git repository or where you extracted the ZIP: <code class="inlineCode">/scripts/sql-scripts/Northwind4SQLite.sql</code> into the <code class="inlineCode">WorkingWithEFCore</code> folder.</li>
      <li class="numberedList">Start a command prompt or terminal in the <code class="inlineCode">WorkingWithEFCore</code> project folder:<ul>
          <li class="bulletList level-2">On Windows, start <strong class="screenText">File Explorer</strong>, right-click the <code class="inlineCode">WorkingWithEFCore</code> folder, and select <strong class="screenText">New Command Prompt at Folder</strong> or <strong class="screenText">Open in Windows Terminal</strong>.</li>
          <li class="bulletList level-2">On macOS, start <strong class="screenText">Finder</strong>, right-click the <code class="inlineCode">WorkingWithEFCore</code> folder, and select <strong class="screenText">New Terminal at Folder</strong>.</li>
        </ul>
      </li>
      <li class="numberedList">Enter <a id="_idIndexMarker1588"/>the command to execute the SQL script using SQLite to create the <code class="inlineCode">Northwind.db</code> database, as shown here:
        <pre class="programlisting con-one"><code class="hljs-con">sqlite3 Northwind.db -init Northwind4SQLite.sql
</code></pre>
      </li>
      <li class="numberedList">Be patient because this command might take a while to create the database structure. Eventually, you will see the SQLite command prompt, as shown in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">-- Loading resources from Northwind4SQLite.sql
SQLite version 3.42.0 2023-05-16 12:36:15
Enter ".help" for usage hints.
sqlite&gt;
</code></pre>
      </li>
      <li class="numberedList">To exit the SQLite command prompt, do the following:<ul>
          <li class="bulletList level-2">On Windows, press <em class="keystroke">Ctrl</em> + <em class="keystroke">C</em> twice.</li>
          <li class="bulletList level-2">On macOS or Linux, press <em class="keystroke">Ctrl</em> + <em class="keystroke">D</em>.</li>
        </ul>
      </li>
      <li class="numberedList">You can leave the command prompt or terminal window open because you will use it again soon.</li>
    </ol>
    <h2 id="_idParaDest-617" class="heading-2">If you are using Visual Studio</h2>
    <p class="normal">If you are using VS Code and the <code class="inlineCode">dotnet run</code> command, the compiled application executes in the <code class="inlineCode">WorkingWithEFCore</code> folder, allowing it to locate the database file stored <a id="_idIndexMarker1589"/>therein. But if you are using Visual Studio or Rider, then the compiled application executes in the <code class="inlineCode">WorkingWithEFCore\bin\Debug\net9.0</code> folder, so it will not find the database file because it is not in that directory.</p>
    <p class="normal">Let’s tell Visual Studio to copy the database file to the directory that it runs the code in so that it can find the file, but only if the database file is newer or is missing so it will not overwrite any database changes we make during runtime:</p>
    <ol>
      <li class="numberedList" value="1">In <strong class="screenText">Solution Explorer</strong>, right-click the <code class="inlineCode">Northwind.db</code> file and select <strong class="screenText">Properties</strong>.</li>
      <li class="numberedList">In <strong class="screenText">Properties</strong>, set <strong class="screenText">Copy to Output Directory</strong> to <strong class="screenText">Copy if newer</strong>.</li>
      <li class="numberedList">In <code class="inlineCode">WorkingWithEFCore.csproj</code>, note the new elements, as shown in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;None Update="Northwind.db"&gt;
    &lt;CopyToOutputDirectory&gt;PreserveNewest&lt;/CopyToOutputDirectory&gt;
  &lt;/None&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
    </ol>
    <div><p class="normal">If you prefer to overwrite the data changes every time you start the project, then set <strong class="screenText">CopyToOutputDirectory</strong> to <strong class="screenText">Always</strong>.</p>
    </div>
    <p class="normal">You could make the preceding changes to the project file manually instead of using the <strong class="screenText">Properties</strong> window. In fact, any change made to the project file by any tool can also be made manually just by editing the XML. Tools like the <strong class="screenText">Properties</strong> window just read the files in a project and show an alternative view. This is why in <em class="chapterRef">Chapter 1</em>, I stressed using multiple code editors when learning .NET. The danger is that if you only use Visual Studio, then you may start to think that Visual Studio <em class="italic">is</em> .NET development. It is not.</p>
    <p class="normal">The real .NET <a id="_idIndexMarker1590"/>development is the contents of the source code files, like <code class="inlineCode">.cs</code>, and the project file <code class="inlineCode">.csproj</code>, which are then compiled by the command-line interface <code class="inlineCode">dotnet</code>. Any other tool you use is just an additional layer on top of that.</p>
    <div><p class="normal">Interestingly, a future feature in .NET that Microsoft is actively looking at is “implicit project files.” This would mean having a folder that contains only one or more <code class="inlineCode">.cs</code> files and the <code class="inlineCode">.csproj</code> file would not need to exist because its content could be implied using defaults. For example, it might default to the current SDK and its target .NET version, and so on. But it gets complicated, so we will have to wait and see if this ever happens.</p>
    </div>
    <h2 id="_idParaDest-618" class="heading-2">Managing the Northwind sample database with SQLiteStudio</h2>
    <p class="normal">You <a id="_idIndexMarker1591"/>can use a cross-platform graphical database manager <a id="_idIndexMarker1592"/>named <strong class="keyWord">SQLiteStudio</strong> to easily manage SQLite databases:</p>
    <ol>
      <li class="numberedList" value="1">Navigate to <a href="https://sqlitestudio.pl">https://sqlitestudio.pl</a>, and then download and install the application.</li>
      <li class="numberedList">Start <strong class="screenText">SQLiteStudio</strong>.</li>
      <li class="numberedList">Navigate to <strong class="screenText">Database</strong> | <strong class="screenText">Add a database</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Database</strong> dialog, in the <strong class="screenText">File</strong> section, click on the yellow folder button to browse for an existing database file on the local computer, select the <code class="inlineCode">Northwind.db</code> file in the <code class="inlineCode">WorkingWithEFCore</code> project folder, and then click <strong class="screenText">OK</strong>, as shown in <em class="italic">Figure 10.3</em>:</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_10_03.png" alt="" width="812" height="284"/></figure>
    <p class="packt_figref">Figure 10.3: Adding the Northwind.db database file to SQLiteStudio</p>
    <ol>
      <li class="numberedList" value="5">If you <a id="_idIndexMarker1593"/>cannot see the database, then navigate to <strong class="screenText">View</strong> | <strong class="screenText">Databases</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Databases</strong> window, right-click on the <code class="inlineCode">Northwind</code> database and choose <strong class="screenText">Connect to the database</strong> (or just double-click <code class="inlineCode">Northwind</code>). You will see the 10 tables that were created by the script. (The script for SQLite is simpler than the one for SQL Server; it does not create as many tables or other database objects.)</li>
      <li class="numberedList">Right-click on the <strong class="screenText">Products</strong> table and choose <strong class="screenText">Edit the table</strong>, or just double-click the table.</li>
      <li class="numberedList">In the table editor window, note the structure of the <code class="inlineCode">Products</code> table, including column names, data types, keys, and constraints, as shown in <em class="italic">Figure 10.4</em>:</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_10_04.png" alt="" width="812" height="336"/></figure>
    <p class="packt_figref">Figure 10.4: The table editor in SQLiteStudio showing the structure of the Products table</p>
    <ol>
      <li class="numberedList" value="9">In the <a id="_idIndexMarker1594"/>table editor window, click the <strong class="screenText">Data</strong> tab, and you will see 77 products, as shown in <em class="italic">Figure 10.5</em>:</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_10_05.png" alt="" width="812" height="250"/></figure>
    <p class="packt_figref">Figure 10.5: The Data tab showing the 77 rows in the Products table</p>
    <ol>
      <li class="numberedList" value="10">In the <strong class="screenText">Database</strong> window, right-click <code class="inlineCode">Northwind</code> and select <strong class="screenText">Disconnect from the database</strong>.</li>
      <li class="numberedList">Quit SQLiteStudio.</li>
    </ol>
    <h2 id="_idParaDest-619" class="heading-2">Using the lightweight ADO.NET database providers</h2>
    <p class="normal">Before <a id="_idIndexMarker1595"/>Entity Framework, there <a id="_idIndexMarker1596"/>was <strong class="keyWord">ADO.NET</strong>. Compared to EF, this is a simpler and more efficient API for working with databases. It provides abstract classes like <code class="inlineCode">DbConnection</code>, <code class="inlineCode">DbCommand</code>, and <code class="inlineCode">DbReader</code>, and provider-specific implementations of them like <code class="inlineCode">SqlConnection</code> and <code class="inlineCode">SqlCommand</code>.</p>
    <p class="normal">In this chapter, if you choose to use SQL Server, then you should use the <code class="inlineCode">SqlConnectionStringBuilder</code> class to help write a valid connection string. This is because it has properties for all possible parts of a database connection string that you set individually and then it returns the complete string. You should also get <a id="_idIndexMarker1597"/>sensitive secrets like passwords from an environment variable or a secret management system instead of writing them in your source code.</p>
    <p class="normal">For SQLite, the connection string is so simple that you do not need to use the <code class="inlineCode">SqliteConnectionStringBuilder</code> class.</p>
    <p class="normal">The EF Core database providers for SQLite and SQL Server are built on top of the ADO.NET libraries, so EF Core is always inherently slower than ADO.NET.</p>
    <p class="normal">If you want <a id="_idIndexMarker1598"/>to use native <strong class="keyWord">ahead-of-time</strong> (<strong class="keyWord">AOT</strong>) publishing, be aware that EF Core does not yet support it. This means you can only use the ADO.NET libraries if you plan to compile to native code. The EF Core team is investigating how they can support native AOT, but it is challenging so it has not happened with EF Core 9 this year. Hopefully, it will happen for EF Core 10 in 2025.</p>
    <p class="normal">Apart from <code class="inlineCode">SqlConnectionStringBuilder</code>, this book does not cover using the ADO.NET library, but I do cover examples of how to publish native AOT minimal API web services using the ADO.NET for SQL Server library in the companion book, <em class="italic">Apps and Services with .NET 8</em>.</p>
    <p class="normal">You can <a id="_idIndexMarker1599"/>learn more about the ADO.NET for SQLite library at the following link:</p>
    <p class="normal"><a href="https://learn.microsoft.com/en-us/dotnet/standard/data/sqlite/">https://learn.microsoft.com/en-us/dotnet/standard/data/sqlite/</a></p>
    <p class="normal">You can learn more about the ADO.NET for SQL Server library at the following link:</p>
    <p class="normal"><a href="https://learn.microsoft.com/en-us/sql/connect/ado-net/microsoft-ado-net-sql-server">https://learn.microsoft.com/en-us/sql/connect/ado-net/microsoft-ado-net-sql-server</a></p>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> All <code class="inlineCode">System.Data.SqlClient</code> users <a id="_idIndexMarker1600"/>are encouraged to transition to <code class="inlineCode">Microsoft.Data.SqlClient</code>. You can read the announcement about how <code class="inlineCode">System.Data.SqlClient</code> package is <a id="_idIndexMarker1601"/>now deprecated at the following link:</p>
      <p class="normal"><a href="https://techcommunity.microsoft.com/t5/sql-server-blog/announcement-system-data-sqlclient-package-is-now-deprecated/ba-p/4227205">https://techcommunity.microsoft.com/t5/sql-server-blog/announcement-system-data-sqlclient-package-is-now-deprecated/ba-p/4227205</a></p>
    </div>
    <h2 id="_idParaDest-620" class="heading-2">Choosing an EF Core database provider</h2>
    <p class="normal">Before we dive into the practicalities of managing data using EF Core, let’s briefly talk <a id="_idIndexMarker1602"/>about choosing between EF Core database providers. To manage data in a specific database, we need classes that know how to efficiently talk to that database.</p>
    <p class="normal">EF Core database providers are sets of classes that are optimized for a specific data store. There is even a provider for storing the data in the memory of the current process, which can be useful for high-performance unit testing since it avoids hitting an external system.</p>
    <p class="normal">They are distributed as NuGet packages, as shown in <em class="italic">Table 10.1</em>:</p>
    <table id="table001-9" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">To manage this data store</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Reference this NuGet package</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">SQL Server 2012 or later</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Microsoft.EntityFrameworkCore.SqlServer</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">SQLite 3.7 or later</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Microsoft.EntityFrameworkCore.SQLite</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">In-memory</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Microsoft.EntityFrameworkCore.InMemory</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Azure Cosmos DB SQL API</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Microsoft.EntityFrameworkCore.Cosmos</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">MySQL</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">MySQL.EntityFrameworkCore</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Oracle DB 11.2</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Oracle.EntityFrameworkCore</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">PostgreSQL</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Npgsql.EntityFrameworkCore.PostgreSQL</code></p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 10.1: NuGet packages for common EF Core database providers</p>
    <p class="normal">You <a id="_idIndexMarker1603"/>can reference as many EF Core database providers in the same project as you need. Each package includes the common shared types, as well as provider-specific types.</p>
    <h2 id="_idParaDest-621" class="heading-2">Connecting to a named SQLite database</h2>
    <p class="normal">To connect <a id="_idIndexMarker1604"/>to an SQLite database, we just need to know the database path and filename, set using the legacy parameter <code class="inlineCode">Filename</code> or the modern equivalent, <code class="inlineCode">Data Source</code>. The path can be relative to the current directory or an absolute path. We specify this information in a <strong class="keyWord">connection string</strong>.</p>
    <h2 id="_idParaDest-622" class="heading-2">Defining the Northwind database context class</h2>
    <p class="normal">A class named <code class="inlineCode">Northwind</code> will be used to represent the database. To use EF Core, the <a id="_idIndexMarker1605"/>class must inherit from <code class="inlineCode">DbContext</code>. The <code class="inlineCode">DbContext</code> class understands how to communicate with databases and dynamically generate SQL statements to query and manipulate data.</p>
    <p class="normal">Your <code class="inlineCode">DbContext</code>-derived class should have an overridden method named <code class="inlineCode">OnConfiguring</code>, which will set the database connection string.</p>
    <p class="normal">We will create a project that uses SQLite, but feel free to use SQL Server or some other database system if you feel comfortable doing so instead:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">WorkingWithEFCore</code> project, add a package reference to the EF Core provider for SQLite and globally and statically import the <code class="inlineCode">System.Console</code> class for all C# files, as shown in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;Using Include="System.Console" Static="true" /&gt;
&lt;/ItemGroup&gt;
&lt;ItemGroup&gt;
  &lt;PackageReference Version="9.0.0"
    Include="Microsoft.EntityFrameworkCore.Sqlite" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build <a id="_idIndexMarker1606"/>the <code class="inlineCode">WorkingWithEFCore</code> project to restore packages.<div><p class="normal">After February 2025, you will be able to try out previews of EF Core 10 by specifying version <code class="inlineCode">10.0-*</code>, so you must also install a preview of .NET 10 SDK. The target framework for your project must be <code class="inlineCode">net10.0</code>. By using a wildcard, you will automatically download the latest monthly preview when you restore the packages for the project. Once the EF Core 10 GA version is released in November 2025, change the package version to <code class="inlineCode">10.0.0</code>. After February 2026, you will be able to do the same with EF Core 11 and that will continue to require a project targeting <code class="inlineCode">net10.0</code>.</p>
        </div>
      </li>
    </ol>
    <ol>
      <li class="numberedList" value="3">In the project folder, add a new class file named <code class="inlineCode">NorthwindDb.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">NorthwindDb.cs</code>, import the main namespace for EF Core, define a class named <code class="inlineCode">NorthwindDb</code>, and make the class inherit from <code class="inlineCode">DbContext</code>. Then, in an <code class="inlineCode">OnConfiguring</code> method, configure the options builder to use SQLite with an appropriate database connection string, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">using Microsoft.EntityFrameworkCore; // To use DbContext and so on.
namespace Northwind.EntityModels;
// This manages interactions with the Northwind database.
public class NorthwindDb : DbContext
{
  protected override void OnConfiguring(
    DbContextOptionsBuilder optionsBuilder)
  {
    string databaseFile = "Northwind.db";
    string path = Path.Combine(
      Environment.CurrentDirectory, databaseFile);
    string connectionString = $"Data Source={path}";
    WriteLine($"Connection: {connectionString}");
    optionsBuilder.UseSqlite(connectionString);
  }
}
</code></pre>
        <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Some code editors like Visual Studio will automatically add a call to the base class member when you override a member. Although this is generally <a id="_idIndexMarker1607"/>good practice, it is unnecessary in this case because the base implementation does nothing. To decide if you need to keep the call or not, view the tooltip or definition of the member. If you hover over the <code class="inlineCode">OnConfiguring</code> method name, its tooltip tells you “The base implementation does nothing.” If you <strong class="screenText">Go To Definition</strong> (<em class="keystroke">F12</em>) of the method, you will see that it does nothing, as shown in the following code:</p>
          <pre class="programlisting code"><code class="hljs-code">protected internal virtual void OnConfiguring(
DbContextOptionsBuilder optionsBuilder)
{
}
</code></pre>
          <p class="normal">The method only exists in the base class so that subclasses can override it and then EF Core can call your code when it needs to configure the data context. It would be a waste for your overridden method implementation to call the base implementation. If your code editor adds the call to the base class automatically, then you should delete the statement to make your code match the code in the book. The same applies later in the book when you override the <code class="inlineCode">OnModelCreating</code> method.</p>
        </div>
      </li>
    </ol>
    <ol>
      <li class="numberedList" value="5">In <code class="inlineCode">Program.cs</code>, delete the existing statements. Then, import the <code class="inlineCode">Northwind.EntityModels</code> namespace and output the database provider, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">using Northwind.EntityModels; // To use Northwind.
using NorthwindDb db = new();
WriteLine($"Provider: {db.Database.ProviderName}");
// Disposes the database context.
</code></pre>
      </li>
      <li class="numberedList">Run the <a id="_idIndexMarker1608"/>console app and note the output showing the database connection string and which database provider you are using, as shown in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">Connection: Data Source=C:\cs13net9\Chapter10\WorkingWithEFCore\bin\Debug\net9.0\Northwind.db
Provider: Microsoft.EntityFrameworkCore.Sqlite
</code></pre>
      </li>
    </ol>
    <p class="normal">You now know how to connect to a database by defining the EF Core data context. Next, we need to define a model that represents the tables in the database.</p>
    <h1 id="_idParaDest-623" class="heading-1">Defining EF Core models</h1>
    <p class="normal">EF Core <a id="_idIndexMarker1609"/>uses a combination of <strong class="keyWord">conventions</strong>, <strong class="keyWord">annotation attributes</strong>, and <strong class="keyWord">Fluent API</strong> statements to build an <strong class="keyWord">entity model</strong> at runtime, which enables any actions performed on the classes to later be automatically translated into actions performed on the actual database. An <strong class="keyWord">entity class</strong> represents <a id="_idIndexMarker1610"/>the structure of a table, and an instance of the class represents a row in that table.</p>
    <p class="normal">First, we will review the three ways to define a model, with code examples, and then we will create some classes that implement those techniques.</p>
    <h2 id="_idParaDest-624" class="heading-2">Using EF Core conventions to define the model</h2>
    <p class="normal">The <a id="_idIndexMarker1611"/>code we will write will use the following conventions:</p>
    <ul>
      <li class="bulletList">The name of a table is assumed to match the name of a <code class="inlineCode">DbSet&lt;T&gt;</code> property in the <code class="inlineCode">DbContext</code> class, for example, <code class="inlineCode">Products</code>.</li>
      <li class="bulletList">The names of the columns are assumed to match the names of properties in the entity model class, for example, <code class="inlineCode">ProductId</code>.</li>
      <li class="bulletList">The <code class="inlineCode">string</code> .NET type is assumed to be a <code class="inlineCode">nvarchar</code> type in the database.</li>
      <li class="bulletList">The <code class="inlineCode">int</code> .NET type is assumed to be an <code class="inlineCode">int</code> type in the database.</li>
      <li class="bulletList">The primary key is assumed to be a property that is named <code class="inlineCode">Id</code> or <code class="inlineCode">ID</code>, or when the entity model class is named <code class="inlineCode">Product</code>, then the property can be named <code class="inlineCode">ProductId</code> or <code class="inlineCode">ProductID</code>. If this property is an integer type or the <code class="inlineCode">Guid</code> type, then it is also assumed to be an <code class="inlineCode">IDENTITY</code> column (a column type that automatically assigns a value when inserting).</li>
    </ul>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: There are many other conventions that you should know, and you can even define your own, but that is beyond the scope of this book. You can read about them at the following link:</p>
      <p class="normal"><a href="https://learn.microsoft.com/en-us/ef/core/modeling/">https://learn.microsoft.com/en-us/ef/core/modeling/</a></p>
    </div>
    <h2 id="_idParaDest-625" class="heading-2">Using EF Core annotation attributes to define the model</h2>
    <p class="normal">Conventions <a id="_idIndexMarker1612"/>often aren’t enough to completely map the classes to the database objects. A simple way of making your model smarter is to apply annotation attributes. Some common attributes recognized by EF Core are shown in <em class="italic">Table 10.2</em>:</p>
    <table id="table002-9" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Attribute</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[Required]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This ensures the value is not null. In .NET 8, it has a <code class="inlineCode">DisallowAllDefaultValues</code> parameter to prevent value types from having their default value. For example, an <code class="inlineCode">int</code> cannot be <code class="inlineCode">0</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[StringLength(50)]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This ensures the value is up to 50 characters in length.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[Column(TypeName = "money", Name = "UnitPrice")]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This specifies the column type and column name used in the table.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 10.2: Common EF Core annotation attributes</p>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> <code class="inlineCode">[StringLength]</code> is not honored by all EF Core data providers. For example, although SQL Server honors it, SQLite does not. For SQLite, use <code class="inlineCode">[Column(TypeName = "text(50)")]</code> instead.</p>
    </div>
    <p class="normal">Some <a id="_idIndexMarker1613"/>additional attributes that can be used to validate entities and are recognized by platforms like ASP.NET Core and Blazor for validation are shown in <em class="italic">Table 10.3</em>:</p>
    <table id="table003-7" class="table-container">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Attribute</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[RegularExpression(expression)]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This ensures the value matches the specified regular expression.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[EmailAddress]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This ensures the value contains one <code class="inlineCode">@</code> symbol, but not as the first or last character. It does not use a regular expression.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[Range(1, 10)]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This ensures a <code class="inlineCode">double</code>, <code class="inlineCode">int</code>, or <code class="inlineCode">string</code> value within a specified range. New in .NET 8 are the parameters <code class="inlineCode">MinimumIsExclusive</code> and <code class="inlineCode">MaximumIsExclusive</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[Length(10, 20)]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This ensures a string or collection is within a specified length range, for example, a minimum of 10 characters or items, and a a maximum of 20 characters or items.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[Base64String]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This ensures the value is a well-formed Base64 string.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[AllowedValues]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">This ensures the value is one of the items in the <code class="inlineCode">params</code> array of objects. For example, <code class="inlineCode">"alpha"</code>, <code class="inlineCode">"beta"</code>, <code class="inlineCode">"gamma"</code>, or <code class="inlineCode">1</code>, <code class="inlineCode">2</code>, <code class="inlineCode">3</code>.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[DeniedValues]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Ensures value is not one of the items in the <code class="inlineCode">params</code> array of objects. For example, <code class="inlineCode">"alpha"</code>, <code class="inlineCode">"beta"</code>, <code class="inlineCode">"gamma"</code>, or <code class="inlineCode">1</code>, <code class="inlineCode">2</code>, <code class="inlineCode">3</code>.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 10.3: Validation annotation attributes</p>
    <div><p class="normal">Why does the <code class="inlineCode">EmailAddress</code> attribute seem so basic? According to a comment by ajcvickers, who also closed the GitHub issue, “<em class="italic">The check is intentionally naive because doing something infallible is very hard. The email really should be validated in some other way, such as through an email confirmation flow where an email is actually sent. The validation attribute is designed only to catch egregiously wrong values such as for a U.I.</em>” You can read the debate at the following link:</p>
      <p class="normal"><a href="https://github.com/dotnet/runtime/issues/27592">https://github.com/dotnet/runtime/issues/27592</a></p>
    </div>
    <p class="normal">For example, in the database, the maximum length of a product name is 40, and the <a id="_idIndexMarker1614"/>value cannot be null, as shown highlighted in the following <strong class="keyWord">data definition language</strong> (<strong class="keyWord">DDL</strong>) code <a id="_idIndexMarker1615"/>from the <code class="inlineCode">Northwind4SQLite.sql</code> script file, which defines how to create a table named <code class="inlineCode">Products</code> with its columns, data types, keys, and other constraints:</p>
    <pre class="programlisting code"><code class="hljs-code">CREATE TABLE Products (
    ProductId       INTEGER       PRIMARY KEY,
<strong class="hljs-slc">    ProductName     NVARCHAR (</strong><strong class="hljs-number-slc">40</strong><strong class="hljs-slc">) </strong><strong class="hljs-keyword-slc">NOT</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">NULL</strong><strong class="hljs-slc">,</strong>
    SupplierId      "INT",
    CategoryId      "INT",
    QuantityPerUnit NVARCHAR (20),
    UnitPrice       "MONEY"       CONSTRAINT DF_Products_UnitPrice DEFAULT (0),
    UnitsInStock    "SMALLINT"    CONSTRAINT DF_Products_UnitsInStock DEFAULT (0),
    UnitsOnOrder    "SMALLINT"    CONSTRAINT DF_Products_UnitsOnOrder DEFAULT (0),
    ReorderLevel    "SMALLINT"    CONSTRAINT DF_Products_ReorderLevel DEFAULT (0),
    Discontinued    "BIT"         NOT NULL
                                  CONSTRAINT DF_Products_Discontinued DEFAULT (0),
    CONSTRAINT FK_Products_Categories FOREIGN KEY (
        CategoryId
    )
    REFERENCES Categories (CategoryId),
    CONSTRAINT FK_Products_Suppliers FOREIGN KEY (
        SupplierId
    )
    REFERENCES Suppliers (SupplierId),
    CONSTRAINT CK_Products_UnitPrice CHECK (UnitPrice &gt;= 0),
    CONSTRAINT CK_ReorderLevel CHECK (ReorderLevel &gt;= 0),
    CONSTRAINT CK_UnitsInStock CHECK (UnitsInStock &gt;= 0),
    CONSTRAINT CK_UnitsOnOrder CHECK (UnitsOnOrder &gt;= 0)
);
</code></pre>
    <p class="normal">In a <code class="inlineCode">Product</code> class, we <a id="_idIndexMarker1616"/>could apply attributes to specify this, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">[Required]
[StringLength(40)]
public string ProductName { get; set; }
</code></pre>
    <p class="normal">When there isn’t an obvious map between .NET types and database types, an attribute can be used.</p>
    <p class="normal">For <a id="_idIndexMarker1617"/>example, in the database, the column type of <code class="inlineCode">UnitPrice</code> for the <code class="inlineCode">Products</code> table is <code class="inlineCode">money</code>. .NET does not have a <code class="inlineCode">money</code> type, so it should use <code class="inlineCode">decimal</code> instead, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">[Column(TypeName = "money")]
public decimal? UnitPrice { get; set; }
</code></pre>
    <h2 id="_idParaDest-626" class="heading-2">Using the EF Core Fluent API to define the model</h2>
    <p class="normal">The last way that the model can be defined is by using the Fluent API. This API can be <a id="_idIndexMarker1618"/>used instead of attributes, as well as in addition to them. For example, to define the <code class="inlineCode">ProductName</code> property, instead of decorating the property with two attributes, an equivalent Fluent API statement could be written in the <code class="inlineCode">OnModelCreating</code> method of the database context class, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">modelBuilder.Entity&lt;Product&gt;()
  .Property(product =&gt; product.ProductName)
  .IsRequired()
  .HasMaxLength(40);
</code></pre>
    <p class="normal">This keeps the entity model class simpler.</p>
    <h2 id="_idParaDest-627" class="heading-2">Understanding data seeding with the Fluent API</h2>
    <p class="normal">Another <a id="_idIndexMarker1619"/>benefit of the Fluent API is to provide initial data to populate a database. EF Core automatically works out which insert, update, or delete operations must be executed.</p>
    <p class="normal">For example, if we wanted to make sure that a new database had at least one row in the <code class="inlineCode">Products</code> table, then we would call the <code class="inlineCode">HasData</code> method, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">modelBuilder.Entity&lt;Product&gt;()
  .HasData(new Product
  {
    ProductId = 1,
    ProductName = "Chai",
    UnitPrice = 8.99M
  });
</code></pre>
    <p class="normal">Calls <a id="_idIndexMarker1620"/>to <code class="inlineCode">HasData</code> take effect either during a data migration executed by the command <code class="inlineCode">dotnet ef database update</code> or when you call the <code class="inlineCode">Database.EnsureCreated</code> method.</p>
    <p class="normal">Our model will map to an existing database that is already populated with data, so we will not need to use this technique in our code.</p>
    <h2 id="_idParaDest-628" class="heading-2">Building EF Core models for the Northwind tables</h2>
    <p class="normal">Now that you’ve learned about the ways to define EF Core models, let’s build models to <a id="_idIndexMarker1621"/>represent two of the tables in the <code class="inlineCode">Northwind</code> database. For reuse, we will do this in a separate class library project.</p>
    <p class="normal">The two entity classes will refer to each other, so to avoid compiler errors, we will create the classes without any members first:</p>
    <ol>
      <li class="numberedList" value="1">Use your preferred code editor to create a new project, as defined in the following list:<ul>
          <li class="bulletList level-2"><strong class="keyWord">Project template</strong>: <strong class="screenText">Class Library </strong>/ <code class="inlineCode">classlib</code></li>
          <li class="bulletList level-2"><strong class="keyWord">Project file and folder</strong>: <code class="inlineCode">Northwind.EntityModels</code></li>
          <li class="bulletList level-2"><strong class="keyWord">Solution file and folder</strong>: <code class="inlineCode">Chapter10</code></li>
        </ul>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.EntityModels</code> project, delete the file named <code class="inlineCode">Class1.cs</code> and then add two class files named <code class="inlineCode">Category.cs</code> and <code class="inlineCode">Product.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Category.cs</code>, define a class named <code class="inlineCode">Category</code>, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">namespace Northwind.EntityModels;
public class Category
{
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Product.cs</code>, define a class named <code class="inlineCode">Product</code>, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">namespace Northwind.EntityModels;
public class Product
{
}
</code></pre>
      </li>
      <li class="numberedList">In <a id="_idIndexMarker1622"/>the <code class="inlineCode">WorkingWithEFCore</code> project, add a project reference to the <code class="inlineCode">Northwind.EntityModels</code> project, as shown in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\Northwind.EntityModels\
Northwind.EntityModels.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
    </ol>
    <div><p class="normal">The project reference path and filename must all go on one line.</p>
    </div>
    <ol>
      <li class="numberedList" value="6">Build the <code class="inlineCode">WorkingWithEFCore</code> project.</li>
    </ol>
    <h2 id="_idParaDest-629" class="heading-2">Defining the Category and Product entity classes</h2>
    <p class="normal">The <code class="inlineCode">Category</code> class, also known as an entity model, will be used to represent a row <a id="_idIndexMarker1623"/>in the <code class="inlineCode">Categories</code> table. This table has four columns, as shown in the following <a id="_idIndexMarker1624"/>DDL taken from the <code class="inlineCode">Northwind4SQLite.sql</code> script file:</p>
    <pre class="programlisting code"><code class="hljs-code">CREATE TABLE Categories (
  CategoryId   INTEGER       PRIMARY KEY,
  CategoryName NVARCHAR (15) NOT NULL,
  Description  "NTEXT",
  Picture      "IMAGE"
);
</code></pre>
    <p class="normal">We will use conventions to define the following:</p>
    <ul>
      <li class="bulletList">Three of the four properties (we will not map the <code class="inlineCode">Picture</code> column)</li>
      <li class="bulletList">The primary key</li>
      <li class="bulletList">The one-to-many relationship to the <code class="inlineCode">Products</code> table</li>
    </ul>
    <p class="normal">To map the <code class="inlineCode">Description</code> column to the correct database type, we will need to decorate the <code class="inlineCode">string</code> property with the <code class="inlineCode">Column</code> attribute.</p>
    <p class="normal">Later in this chapter, we will use the Fluent API to define that <code class="inlineCode">CategoryName</code> cannot be null and is limited to a maximum of 15 characters.</p>
    <p class="normal">Let’s go:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.EntityModels</code> project, modify the <code class="inlineCode">Category</code> entity model class, as shown highlighted in the following code:
        <pre class="programlisting code-one"><code class="hljs-code"><strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> System.ComponentModel.DataAnnotations.Schema; </strong><strong class="hljs-comment-slc">// To use [Column].</strong>
namespace Northwind.EntityModels;
public class Category
{
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// These properties map to columns in the database.</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc"> CategoryId { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; } </strong><strong class="hljs-comment-slc">// The primary key.</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc"> CategoryName { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; } = </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">!;</strong>
<strong class="hljs-slc">  [</strong><strong class="hljs-meta-slc">Column(TypeName = </strong><strong class="hljs-string-slc">"ntext"</strong><strong class="hljs-meta-slc">)</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc">? Description { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// Defines a navigation property for related rows.</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">virtual</strong><strong class="hljs-slc"> ICollection&lt;Product&gt; Products { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; }</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-comment-slc">// To enable developers to add products to a Category, we must</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-comment-slc">// initialize the navigation property to an empty collection.</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-comment-slc">// This also avoids an exception if we get a member like Count.</strong>
<strong class="hljs-slc">    = </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> HashSet&lt;Product&gt;();</strong>
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">Note <a id="_idIndexMarker1625"/>the following:</p>
    <ul>
      <li class="bulletList level-2">The <code class="inlineCode">Category</code> class <a id="_idIndexMarker1626"/>will be in the <code class="inlineCode">Northwind.EntityModels</code> namespace.</li>
      <li class="bulletList level-2">The <code class="inlineCode">CategoryId</code> property follows the primary key naming convention, so it will be mapped to a column marked as the primary key with an index.</li>
      <li class="bulletList level-2">The <code class="inlineCode">CategoryName</code> property maps to a column that does not allow database NULL values, so it is a non-nullable string. To disable nullability warnings, we have assigned the null-forgiving operator.</li>
      <li class="bulletList level-2">The <code class="inlineCode">Description</code> property maps to a column with the <code class="inlineCode">ntext</code> data type instead of the default mapping for <code class="inlineCode">string</code> values to <code class="inlineCode">nvarchar</code>.</li>
      <li class="bulletList level-2">We initialize the collection of <code class="inlineCode">Product</code> objects to a new, empty <code class="inlineCode">HashSet</code>. A hash set is more efficient than a list because it is unordered. If you do not initialize <code class="inlineCode">Products</code>, then it will be null and <a id="_idIndexMarker1627"/>if you try to get its <code class="inlineCode">Count</code>, then you will get an exception.</li>
    </ul>
    <ol>
      <li class="numberedList" value="2">Modify <a id="_idIndexMarker1628"/>the <code class="inlineCode">Product</code> class, as shown highlighted in the following code:
        <pre class="programlisting code-one"><code class="hljs-code"><strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> System.ComponentModel.DataAnnotations; </strong><strong class="hljs-comment-slc">// To use [Required].</strong>
<strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> System.ComponentModel.DataAnnotations.Schema; </strong><strong class="hljs-comment-slc">// To use [Column].</strong>
namespace Northwind.EntityModels;
public class Product
{
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc"> ProductId { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; } </strong><strong class="hljs-comment-slc">// The primary key.</strong>
<strong class="hljs-slc">  [</strong><strong class="hljs-meta-slc">Required</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">  [</strong><strong class="hljs-meta-slc">StringLength(40)</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc"> ProductName { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; } = </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">!;</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// Property name is different from the column name.</strong>
<strong class="hljs-slc">  [</strong><strong class="hljs-meta-slc">Column(</strong><strong class="hljs-string-slc">"UnitPrice"</strong><strong class="hljs-meta-slc">, TypeName = </strong><strong class="hljs-string-slc">"money"</strong><strong class="hljs-meta-slc">)</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">decimal</strong><strong class="hljs-slc">? Cost { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; }</strong>
<strong class="hljs-slc">  [</strong><strong class="hljs-meta-slc">Column(</strong><strong class="hljs-string-slc">"UnitsInStock"</strong><strong class="hljs-meta-slc">)</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">short</strong><strong class="hljs-slc">? Stock { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">bool</strong><strong class="hljs-slc"> Discontinued { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// These two properties define the foreign key relationship</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// to the Categories table.</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc"> CategoryId { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">virtual</strong><strong class="hljs-slc"> Category Category { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; } = </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">!;</strong>
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">Note the following:</p>
    <ul>
      <li class="bulletList level-2">The <code class="inlineCode">Product</code> class will be used to represent a row in the <code class="inlineCode">Products</code> table, which has 10 columns.</li>
      <li class="bulletList level-2">You do <a id="_idIndexMarker1629"/>not need to include all columns from a table as properties of a class. We will only map <a id="_idIndexMarker1630"/>six properties: <code class="inlineCode">ProductId</code>, <code class="inlineCode">ProductName</code>, <code class="inlineCode">UnitPrice</code>, <code class="inlineCode">UnitsInStock</code>, <code class="inlineCode">Discontinued</code>, and <code class="inlineCode">CategoryId</code>.</li>
      <li class="bulletList level-2">Columns that are not mapped to properties cannot be read or set using the class instances. If you use the class to create a new object, then the new row in the table will have <code class="inlineCode">NULL</code> or some other default value for the unmapped column values in that row. You must make sure that those missing columns are optional or have default values set by the database, or else an exception will be thrown at runtime. In this scenario, the rows already have data values and I have decided that I do not need to read those values in this application.</li>
      <li class="bulletList level-2">We can rename a column by defining a property with a different name, like <code class="inlineCode">Cost</code>, and then decorating the property with the <code class="inlineCode">[Column]</code> attribute and specifying its column name, like <code class="inlineCode">UnitPrice</code>.</li>
      <li class="bulletList level-2">The final property, <code class="inlineCode">CategoryId</code>, is associated with a <code class="inlineCode">Category</code> property that will be used to map each product to its parent category.</li>
    </ul>
    <p class="normal">The two properties that relate to the two entities, <code class="inlineCode">Category.Products</code> and <code class="inlineCode">Product.Category</code>, are both marked as <code class="inlineCode">virtual</code>. This allows EF Core to inherit and override the properties to provide extra features, such as lazy loading.</p>
    <h2 id="_idParaDest-630" class="heading-2">Adding tables to the Northwind database context class</h2>
    <p class="normal">Inside your <code class="inlineCode">DbContext</code>-derived class, you must define at least one property of the <code class="inlineCode">DbSet&lt;T&gt;</code> type. These properties represent the tables. To tell EF Core what columns <a id="_idIndexMarker1631"/>each table has, the <code class="inlineCode">DbSet&lt;T&gt;</code> properties use generics to specify a class that represents a row in the table. That entity model class has properties that represent its columns.</p>
    <p class="normal">The <code class="inlineCode">DbContext</code>-derived class can optionally have an overridden method named <code class="inlineCode">OnModelCreating</code>. This is where you can write Fluent API statements as an alternative to decorating your entity classes with attributes.</p>
    <p class="normal">Let’s write the code:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">WorkingWithEFCore</code> project, modify the <code class="inlineCode">NorthwindDb</code> class to add statements to define two properties for the two tables and an <code class="inlineCode">OnModelCreating</code> method, as shown highlighted in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">public class NorthwindDb : DbContext
{
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// These two properties map to tables in the database.</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">DbSet</strong><strong class="hljs-function-slc">&lt;</strong><strong class="hljs-title-slc">Category</strong><strong class="hljs-function-slc">&gt;? Categories</strong><strong class="hljs-slc"> { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; }</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">DbSet</strong><strong class="hljs-function-slc">&lt;</strong><strong class="hljs-title-slc">Product</strong><strong class="hljs-function-slc">&gt;? Products</strong><strong class="hljs-slc"> { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; }</strong>
  protected override void OnConfiguring(
    DbContextOptionsBuilder optionsBuilder)
  {
    ...
  }
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">protected</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-keyword-slc">override</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-keyword-slc">void</strong><strong class="hljs-function-slc"> </strong><strong class="hljs-title-slc">OnModelCreating</strong><strong class="hljs-function-slc">(</strong>
<strong class="hljs-params-slc">    ModelBuilder modelBuilder</strong><strong class="hljs-function-slc">)</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-comment-slc">// Example of using Fluent API instead of attributes</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-comment-slc">// to limit the length of a category name to 15.</strong>
<strong class="hljs-slc">    modelBuilder.Entity&lt;Category&gt;()</strong>
<strong class="hljs-slc">      .Property(category =&gt; category.CategoryName)</strong>
<strong class="hljs-slc">      .IsRequired() </strong><strong class="hljs-comment-slc">// NOT NULL</strong>
<strong class="hljs-slc">      .HasMaxLength(</strong><strong class="hljs-number-slc">15</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-comment-slc">// Some SQLite-specific configuration.</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (Database.ProviderName?.Contains(</strong><strong class="hljs-string-slc">"Sqlite"</strong><strong class="hljs-slc">) ?? </strong><strong class="hljs-literal-slc">false</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    {</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-comment-slc">// To "fix" the lack of decimal support in SQLite.</strong>
<strong class="hljs-slc">      modelBuilder.Entity&lt;Product&gt;()</strong>
<strong class="hljs-slc">        .Property(product =&gt; product.Cost)</strong>
<strong class="hljs-slc">        .HasConversion&lt;</strong><strong class="hljs-built_in-slc">double</strong><strong class="hljs-slc">&gt;();</strong>
<strong class="hljs-slc">    }</strong>
<strong class="hljs-slc">  }</strong>
}
</code></pre>
      </li>
    </ol>
    <p class="normal">The <code class="inlineCode">decimal</code> type is not supported by the SQLite database provider for sorting and <a id="_idIndexMarker1632"/>other operations. We can fix this by telling the model that <code class="inlineCode">decimal</code> values can be treated as <code class="inlineCode">double</code> values when using the SQLite database provider. This does not actually perform any conversion at runtime.</p>
    <p class="normal">Now that you have seen some examples of defining an entity model manually, let’s look at a tool that can do some of the work for you.</p>
    <h2 id="_idParaDest-631" class="heading-2">Setting up the dotnet-ef tool</h2>
    <p class="normal">The .NET CLI tool named <code class="inlineCode">dotnet</code> can be extended with capabilities useful for working <a id="_idIndexMarker1633"/>with EF Core. It can perform design-time tasks like creating and applying migrations from an older model to a newer model and generating code for a model from an existing database.</p>
    <p class="normal">The <code class="inlineCode">dotnet-ef</code> command-line tool is not automatically installed. You must install this package as either a <strong class="keyWord">global</strong> or <strong class="keyWord">local tool</strong>. If you have already installed an older version of the tool, then you should update it to the latest version:</p>
    <ol>
      <li class="numberedList" value="1">At a command prompt or terminal, check if you have already installed <code class="inlineCode">dotnet-ef</code> as a global tool, as shown in the following command:
        <pre class="programlisting con-one"><code class="hljs-con">dotnet tool list --global
</code></pre>
      </li>
      <li class="numberedList">Check in the list if an older version of the tool has been installed, like the one for .NET 7, as shown in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">Package Id      Version     Commands
-------------------------------------
dotnet-ef       7.0.0       dotnet-ef
</code></pre>
      </li>
      <li class="numberedList">If an old <a id="_idIndexMarker1634"/>version is already installed, then update the tool, as shown in the following command:
        <pre class="programlisting con-one"><code class="hljs-con">dotnet tool update --global dotnet-ef
</code></pre>
      </li>
      <li class="numberedList">If it is not already installed, then install the latest version, as shown in the following command:
        <pre class="programlisting con-one"><code class="hljs-con">dotnet tool install --global dotnet-ef
</code></pre>
      </li>
    </ol>
    <p class="normal">If necessary, follow any OS-specific instructions to add the <code class="inlineCode">dotnet tools</code> directory to your <code class="inlineCode">PATH</code> environment variable, as described in the output of installing the <code class="inlineCode">dotnet-ef</code> tool.</p>
    <p class="normal">By default, the latest GA release of .NET will be used to install the tool. To explicitly set a version, for example, to use a preview, add the <code class="inlineCode">--version</code> switch. As another example, to update to the latest .NET 9 preview version available from February 2024 to October 2024, use the following command with a version wildcard:</p>
    <pre class="programlisting con"><code class="hljs-con">dotnet tool update --global dotnet-ef --version 9.0-*
</code></pre>
    <p class="normal">Once the .NET 9 GA release happens in November 2024, you can just use the command without the <code class="inlineCode">--version</code> switch to upgrade.</p>
    <p class="normal">You can also remove the tool, as shown in the following command:</p>
    <pre class="programlisting con"><code class="hljs-con">dotnet tool uninstall --global dotnet-ef
</code></pre>
    <h2 id="_idParaDest-632" class="heading-2">Scaffolding models using an existing database</h2>
    <p class="normal">Scaffolding is the process of using a tool to create classes that represent the model <a id="_idIndexMarker1635"/>of an existing database using reverse engineering. A good scaffolding tool allows you to extend the automatically generated classes because they are <code class="inlineCode">partial</code> and then regenerate those classes without losing your <code class="inlineCode">partial</code> classes.</p>
    <p class="normal">If you know that you will never regenerate the classes using the tool, then feel free to change the code for the automatically generated classes as much as you want. The code generated by the tool is just the best approximation.</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Do not be afraid to overrule a tool when you know better.</p>
    </div>
    <p class="normal">The instructions in this section apply to any data provider, not just SQLite. Whatever data provider you use, you will need to add a reference to the <code class="inlineCode">Microsoft.EntityFrameworkCore.Design</code> package.</p>
    <p class="normal">Let’s see if the tool generates the same model as we did manually:</p>
    <ol>
      <li class="numberedList" value="1">Add the latest version of the <code class="inlineCode">Microsoft.EntityFrameworkCore.Design</code> package to the <code class="inlineCode">WorkingWithEFCore</code> project, as shown highlighted in the following markup:
        <pre class="programlisting code-one"><code class="hljs-code">&lt;ItemGroup&gt;
<strong class="hljs-slc">  &lt;PackageReference Version=</strong><strong class="hljs-string-slc">"9.0.0"</strong>
<strong class="hljs-slc">                    Include=</strong><strong class="hljs-string-slc">"Microsoft.EntityFrameworkCore.Design"</strong><strong class="hljs-slc">&gt;</strong>
<strong class="hljs-slc">    &lt;PrivateAssets&gt;all&lt;/PrivateAssets&gt;</strong>
<strong class="hljs-slc">    &lt;IncludeAssets&gt;runtime; build; native; contentfiles; analyzers; buildtransitive&lt;/IncludeAssets&gt;</strong>
<strong class="hljs-slc">  &lt;/PackageReference&gt;</strong>
  &lt;PackageReference Version="9.0.0"
                    Include="Microsoft.EntityFrameworkCore.Sqlite" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
    </ol>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: If you are unfamiliar with how packages like <code class="inlineCode">Microsoft.EntityFrameworkCore.Design</code> can manage their assets, then you can learn more at the following link:</p>
      <p class="normal"><a href="https://learn.microsoft.com/en-us/nuget/consume-packages/package-references-in-project-files#controlling-dependency-assets">https://learn.microsoft.com/en-us/nuget/consume-packages/package-references-in-project-files#controlling-dependency-assets</a></p>
    </div>
    <ol>
      <li class="numberedList" value="2">Build the <code class="inlineCode">WorkingWithEFCore</code> project to restore packages.</li>
      <li class="numberedList">Start <a id="_idIndexMarker1636"/>a command prompt or terminal in the <code class="inlineCode">WorkingWithEFCore</code> project folder. Here is an example:<ul>
          <li class="bulletList level-2">If you are using Visual Studio, in <strong class="screenText">Solution Explorer</strong>, right-click the <code class="inlineCode">WorkingWithEFCore</code> project and select <strong class="screenText">Open in Terminal</strong>.</li>
          <li class="bulletList level-2">On Windows, start <strong class="screenText">File Explorer</strong>, right-click the <code class="inlineCode">WorkingWithEFCore</code> folder, and select <strong class="screenText">New Command Prompt at Folder</strong> or <strong class="screenText">Open in Windows Terminal</strong>.</li>
          <li class="bulletList level-2">On macOS, start <strong class="screenText">Finder</strong>, right-click the <code class="inlineCode">WorkingWithEFCore</code> folder, and select <strong class="screenText">New Terminal at Folder</strong>.</li>
          <li class="bulletList level-2">If you are using Rider, in <strong class="screenText">Solution Explorer</strong>, right-click the <code class="inlineCode">WorkingWithEFCore</code> project and select <strong class="screenText">Open In</strong> | <strong class="screenText">Terminal</strong>.</li>
        </ul>
      </li>
    </ol>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> When I say the <code class="inlineCode">WorkingWithEFCore</code> project folder, I mean the folder that contains the <code class="inlineCode">WorkingWithEFCore.csproj</code> project file. If you enter the command in a folder that does not contain a project file, then you will see the following error: <code class="inlineCode">No project was found. Change the current working directory or use the --project option</code>.</p>
    </div>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: You are about to enter a long command. I recommend that you type from the print book or copy and paste long commands like this from the eBook into a plain text editor like Notepad. Then make sure that the whole command is properly formatted as a single line with correct spacing. Only then should you copy and paste it into the command prompt or terminal. Copying and pasting directly from the eBook is likely to include newline characters and missing spaces that break the command if you aren’t careful. Also, remember that all commands are available to copy at <a href="https://github.com/markjprice/cs13net9/blob/main/docs/command-lines.md">https://github.com/markjprice/cs13net9/blob/main/docs/command-lines.md</a>. <strong class="keyWord">Warning!</strong> If you copy from a PDF, double-dashes in a command link are sometimes lost, so be careful!</p>
    </div>
    <ol>
      <li class="numberedList" value="4">At a <a id="_idIndexMarker1637"/>command prompt or terminal, use the <code class="inlineCode">dotnet-ef</code> tool to generate a model for the <code class="inlineCode">Categories</code> and <code class="inlineCode">Products</code> tables in a new folder named <code class="inlineCode">AutoGenModels</code>, as shown in the following command:
        <pre class="programlisting con-one"><code class="hljs-con">dotnet ef dbcontext scaffold "Data Source=Northwind.db" Microsoft.EntityFrameworkCore.Sqlite --table Categories --table Products --output-dir AutoGenModels --namespace WorkingWithEFCore.AutoGen --data-annotations --context NorthwindDb
</code></pre>
      </li>
    </ol>
    <p class="normal-one">Note the following:</p>
    <ul>
      <li class="bulletList level-2">The command action: <code class="inlineCode">dbcontext scaffold</code></li>
      <li class="bulletList level-2">The connection string: <code class="inlineCode">"Data Source=Northwind.db"</code></li>
      <li class="bulletList level-2">The database provider: <code class="inlineCode">Microsoft.EntityFrameworkCore.Sqlite</code></li>
      <li class="bulletList level-2">The tables to generate models for: <code class="inlineCode">--table Categories --table Products</code></li>
      <li class="bulletList level-2">The output folder: <code class="inlineCode">--output-dir AutoGenModels</code></li>
      <li class="bulletList level-2">The namespace: <code class="inlineCode">--namespace WorkingWithEFCore.AutoGen</code></li>
      <li class="bulletList level-2">To use data annotations as well as the Fluent API: <code class="inlineCode">--data-annotations</code></li>
      <li class="bulletList level-2">To rename the context from <code class="inlineCode">[database_name]Context</code>: <code class="inlineCode">--context NorthwindDb</code>
        <div><p class="normal">If you prefer to use SQL Server, then the equivalent command is found at the following link:</p>
          <p class="normal"><a href="https://github.com/markjprice/cs13net9/blob/main/docs/sql-server/README.md#scaffolding-models-using-an-existing-database">https://github.com/markjprice/cs13net9/blob/main/docs/sql-server/README.md#scaffolding-models-using-an-existing-database</a></p>
        </div>
      </li>
    </ul>
    <ol>
      <li class="numberedList" value="5">Note <a id="_idIndexMarker1638"/>the build messages and warnings, as shown in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">Build started...
Build succeeded.
To protect potentially sensitive information in your connection string, you should move it out of source code. You can avoid scaffolding the connection string by using the Name= syntax to read it from configuration - see https://go.microsoft.com/fwlink/?linkid=2131148. For more guidance on storing connection strings, see http://go.microsoft.com/fwlink/?LinkId=723263.
Skipping foreign key with identity '0' on table 'Products' since principal table 'Suppliers' was not found in the model. This usually happens when the principal table was not included in the selection set.
</code></pre>
      </li>
    </ol>
    <h2 id="_idParaDest-633" class="heading-2">Reviewing the scaffolded code</h2>
    <p class="normal">Now let’s <a id="_idIndexMarker1639"/>review the scaffolded code:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">AutoGenModels</code> folder, note the three class files that were automatically generated: <code class="inlineCode">Category.cs</code>, <code class="inlineCode">NorthwindDb.cs</code>, and <code class="inlineCode">Product.cs</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">AutoGenModels</code> folder, in <code class="inlineCode">Category.cs</code>, note the differences compared to the one you created manually. I have not included namespace imports to save space, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">namespace WorkingWithEFCore.AutoGen;
[Index("CategoryName", Name = "CategoryName")]
public partial class Category
{
  [Key]
  public int CategoryId { get; set; }
  [Column(TypeName = "nvarchar (15)")]
  public string CategoryName { get; set; } = null!;
  [Column(TypeName = "ntext")]
  public string? Description { get; set; }
  [Column(TypeName = "image")]
  public byte[]? Picture { get; set; }
  [InverseProperty("Category")]
  public virtual ICollection&lt;Product&gt; Products { get; set; }
    = new List&lt;Product&gt;();
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">Note <a id="_idIndexMarker1640"/>the following:</p>
    <ul>
      <li class="bulletList level-2">It decorates the entity class with the <code class="inlineCode">[Index]</code> attribute, which was introduced in EF Core 5. This indicates properties that should have an index when using the Code First approach to generate a database at runtime. Since we are using Database First with an existing database, this is not needed. But if we wanted to recreate a new, empty database from our code, then this information would be needed.</li>
      <li class="bulletList level-2">The table <a id="_idIndexMarker1641"/>name in the database is <code class="inlineCode">Categories</code> but the <code class="inlineCode">dotnet-ef</code> tool uses the <strong class="keyWord">Humanizer</strong> third-party library to automatically singularize the class name to <code class="inlineCode">Category</code>, which is a more natural name when creating a single entity that represents a row in the table.</li>
      <li class="bulletList level-2">The entity class is declared using the <code class="inlineCode">partial</code> keyword so that you can create a matching <code class="inlineCode">partial</code> class for adding additional code. This allows you to rerun the tool and regenerate the entity class without losing that extra code.</li>
      <li class="bulletList level-2">The <code class="inlineCode">CategoryId</code> property is decorated with the <code class="inlineCode">[Key]</code> attribute to indicate that it is the primary key for this entity. The data type for this property is <code class="inlineCode">int</code> for SQLite and <code class="inlineCode">long</code> for SQL Server. We did not need to decorate the property in our code because we followed the naming primary key convention.</li>
      <li class="bulletList level-2">The <code class="inlineCode">CategoryName</code> property is decorated with the <code class="inlineCode">[Column(TypeName = "nvarchar (15)")]</code> attribute, which is only needed if you want to generate a database from the model.</li>
      <li class="bulletList level-2">We <a id="_idIndexMarker1642"/>chose not to include the <code class="inlineCode">Picture</code> column as a property because this is a binary object that we will not use in our console app.</li>
      <li class="bulletList level-2">The <code class="inlineCode">Products</code> property uses the <code class="inlineCode">[InverseProperty]</code> attribute to define the foreign key relationship to the <code class="inlineCode">Category</code> property on the <code class="inlineCode">Product</code> entity class, and it initializes the collection to a new empty list.</li>
    </ul>
    <ol>
      <li class="numberedList" value="3">In the <code class="inlineCode">AutoGenModels</code> folder, in <code class="inlineCode">Product.cs</code>, note the differences compared to the one you created manually.</li>
      <li class="numberedList">In the <code class="inlineCode">AutoGenModels</code> folder, in <code class="inlineCode">NorthwindDb.cs</code>, note the differences compared to the one you created manually, as shown in the following edited-for-space code:
        <pre class="programlisting code-one"><code class="hljs-code">using Microsoft.EntityFrameworkCore;
namespace WorkingWithEFCore.AutoGen;
public partial class NorthwindDb : DbContext
{
  public NorthwindDb()
  {
  }
  public NorthwindDb(DbContextOptions&lt;NorthwindDb&gt; options)
      : base(options)
  {
  }
  public virtual DbSet&lt;Category&gt; Categories { get; set; }
  public virtual DbSet&lt;Product&gt; Products { get; set; }
  protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
#warning To protect potentially sensitive information in your connection string, you should move it out of source code. You can avoid scaffolding the connection string by using the Name= syntax to read it from configuration - see https://go.microsoft.com/fwlink/?linkid=2131148. For more guidance on storing connection strings, see http://go.microsoft.com/fwlink/?LinkId=723263.
      =&gt; optionsBuilder.UseSqlite("Data Source=Northwind.db");
  protected override void OnModelCreating(ModelBuilder modelBuilder)
  {
    modelBuilder.Entity&lt;Category&gt;(entity =&gt;
    {
      entity.Property(e =&gt; e.CategoryId).ValueGeneratedNever();
    });
    modelBuilder.Entity&lt;Product&gt;(entity =&gt;
    {
      entity.Property(e =&gt; e.ProductId).ValueGeneratedNever();
      entity.Property(e =&gt; e.Discontinued).HasDefaultValueSql("0");
      entity.Property(e =&gt; e.ReorderLevel).HasDefaultValueSql("0");
      entity.Property(e =&gt; e.UnitPrice).HasDefaultValueSql("0");
      entity.Property(e =&gt; e.UnitsInStock).HasDefaultValueSql("0");
      entity.Property(e =&gt; e.UnitsOnOrder).HasDefaultValueSql("0");
    });
    OnModelCreatingPartial(modelBuilder);
  }
  partial void OnModelCreatingPartial(ModelBuilder modelBuilder);
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">Note <a id="_idIndexMarker1643"/>the following:</p>
    <ul>
      <li class="bulletList level-2">The <code class="inlineCode">NorthwindDb</code> data context class is <code class="inlineCode">partial</code> to allow you to extend it and regenerate it in the future.</li>
      <li class="bulletList level-2">It has two constructors: a default parameter-less one and one that allows options to be passed in. This is useful in apps where you want to specify the connection string at runtime.</li>
      <li class="bulletList level-2">In the <code class="inlineCode">OnConfiguring</code> method, if options have not been specified in the constructor, then it defaults to using a connection string that looks for the database file in the current folder. It has a compiler warning to remind you that you should not hardcode security information in this connection string.</li>
      <li class="bulletList level-2">In the <code class="inlineCode">OnModelCreating</code> method, the Fluent API is used to configure the two entity classes, and then a <code class="inlineCode">partial</code> method named <code class="inlineCode">OnModelCreatingPartial</code> is invoked. This allows you to implement that <code class="inlineCode">partial</code> method in your own <code class="inlineCode">partial</code> <code class="inlineCode">Northwind</code> class to add your own Fluent API configuration that will not be lost if you regenerate the model classes.</li>
    </ul>
    <ol>
      <li class="numberedList" value="5">Close the automatically generated class files.</li>
    </ol>
    <h2 id="_idParaDest-634" class="heading-2">Customizing the reverse engineering templates</h2>
    <p class="normal">One of the features introduced with EF Core 7 was the ability to customize the code <a id="_idIndexMarker1644"/>that is automatically generated by the <code class="inlineCode">dotnet-ef</code> scaffolding tool. This is an advanced technique, so I do not cover it in this book. Usually, it is easier to just modify the code that is generated by default anyway.</p>
    <p class="normal">If you would like to learn how to modify the T4 templates used by the <code class="inlineCode">dotnet-ef</code> scaffolding tool, then you can find that information at the following link:</p>
    <p class="normal"><a href="https://learn.microsoft.com/en-us/ef/core/managing-schemas/scaffolding/templates">https://learn.microsoft.com/en-us/ef/core/managing-schemas/scaffolding/templates</a></p>
    <h2 id="_idParaDest-635" class="heading-2">Configuring preconvention models</h2>
    <p class="normal">Along with support for the <code class="inlineCode">DateOnly</code> and <code class="inlineCode">TimeOnly</code> types for use with the SQLite database <a id="_idIndexMarker1645"/>provider, one of the features introduced with EF Core 6 was configuring preconvention models.</p>
    <p class="normal">As models become more complex, relying on conventions to discover entity types and their properties and successfully map them to tables and columns becomes harder. It would be useful if you could configure the conventions themselves before they are used to analyze and build a model.</p>
    <p class="normal">For example, you might want to define a convention to say that all <code class="inlineCode">string</code> properties should have a maximum length of 50 characters as a default, or any property types that implement a custom interface should not be mapped, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">protected override void ConfigureConventions(
  ModelConfigurationBuilder configurationBuilder)
{
  configurationBuilder.Properties&lt;string&gt;().HaveMaxLength(50);
  configurationBuilder.IgnoreAny&lt;IDoNotMap&gt;();
}
</code></pre>
    <p class="normal">In the rest of this chapter, we will use the classes that you manually created.</p>
    <h1 id="_idParaDest-636" class="heading-1">Querying EF Core models</h1>
    <p class="normal">Now that we have a model that maps to the <code class="inlineCode">Northwind</code> database and two of its tables, we <a id="_idIndexMarker1646"/>can write some simple <strong class="keyWord">Language-Integrated Query</strong> (<strong class="keyWord">LINQ</strong>) queries to fetch data. You will learn much more about writing LINQ queries in <em class="chapterRef">Chapter 11</em>, <em class="italic">Querying and Manipulating Data Using LINQ</em>.</p>
    <p class="normal"><strong class="keyWord">LINQ to Entities</strong> (a.k.a. <strong class="keyWord">LINQ to EF Core</strong>) is a LINQ provider that converts a LINQ query into SQL to execute against the database. You can write a LINQ query built up over many C# statements. </p>
    <p class="normal">You can discover the equivalent SQL statement without executing the query against the database by calling <code class="inlineCode">ToQueryString</code>. This is known as deferred execution. Only when the query is enumerated using <code class="inlineCode">foreach</code>, or when you call a method like <code class="inlineCode">ToArray</code> or <code class="inlineCode">ToList</code> on the LINQ query, will you trigger the execution of the query against the database and the results are returned to <a id="_idIndexMarker1647"/>your code. This is known as <strong class="keyWord">materialization</strong>.</p>
    <p class="normal">For now, just write the code and view the results:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">WorkingWithEFCore</code> project, add a new class file named <code class="inlineCode">Program.Helpers.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.Helpers.cs</code>, add a partial <code class="inlineCode">Program</code> class with some methods, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">partial class Program
{
  private static void ConfigureConsole(string culture = "en-US",
    bool useComputerCulture = false)
  {
    // To enable Unicode characters like Euro symbol in the console.
    OutputEncoding = System.Text.Encoding.UTF8;
    if (!useComputerCulture)
    {
      CultureInfo.CurrentCulture = CultureInfo.GetCultureInfo(culture);
    }
    WriteLine($"CurrentCulture: {CultureInfo.CurrentCulture.DisplayName}");
  }
  private static void WriteLineInColor(string text, ConsoleColor color)
  {
    ConsoleColor previousColor = ForegroundColor;
    ForegroundColor = color;
    WriteLine(text);
    ForegroundColor = previousColor;
  }
  private static void SectionTitle(string title)
  {
    WriteLineInColor($"*** {title} ***", ConsoleColor.DarkYellow);
  }
  private static void Fail(string message)
  {
    WriteLineInColor($"Fail &gt; {message}", ConsoleColor.Red);
  }
  private static void Info(string message)
  {
    WriteLineInColor($"Info &gt; {message}", ConsoleColor.Cyan);
  }
}
</code></pre>
      </li>
      <li class="numberedList">Add a <a id="_idIndexMarker1648"/>new class file named <code class="inlineCode">Program.Queries.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.Queries.cs</code>, define a partial <code class="inlineCode">Program</code> class with a <code class="inlineCode">QueryingCategories</code> method, and add statements to do these tasks, as shown in the following code:<ul>
          <li class="bulletList level-2">Create an instance of the <code class="inlineCode">Northwind</code> class that will manage the database. Database context instances are designed for short lifetimes in a unit of work. They should be disposed of as soon as possible. So, we will wrap our instance in a <code class="inlineCode">using</code> statement. In <em class="chapterRef">Chapter 13</em>, <em class="italic">Building Websites Using ASP.NET Core</em>, you will learn how to get database context using dependency injection.</li>
          <li class="bulletList level-2">Create a <a id="_idIndexMarker1649"/>query for all categories that include their related products. <code class="inlineCode">Include</code> is an extension method that requires you to import the <code class="inlineCode">Microsoft.EntityFrameworkCore</code> namespace.</li>
          <li class="bulletList level-2">Enumerate through the categories, outputting the name and number of products for each one:
            <pre class="programlisting code"><code class="hljs-code">using Microsoft.EntityFrameworkCore; // To use Include method.
using Northwind.EntityModels; // To use Northwind, Category, Product.
partial class Program
{
  private static void QueryingCategories()
  {
    using NorthwindDb db = new();
    SectionTitle("Categories and how many products they have");
    // A query to get all categories and their related products.
    // This is a query definition. Nothing has executed against the database.
    IQueryable&lt;Category&gt;? categories = db.Categories?
      .Include(c =&gt; c.Products);
    // You could call any of the following LINQ methods and nothing will be executed against the database:
    // Where, GroupBy, Select, SelectMany, OfType, OrderBy, ThenBy, Join, GroupJoin, Take, Skip, Reverse.
    // Usually, methods that return IEnumerable or IQueryable support deferred execution.
    // Usually, methods that return a single value do not support deferred execution.
    if (categories is null || !categories.Any())
    {
      Fail("No categories found.");
      return;
    }
    // Enumerating the query converts it to SQL and executes it against the database.
    // Execute query and enumerate results.
    foreach (Category c in categories)
    {
      WriteLine($"{c.CategoryName} has {c.Products.Count} products.");
    }
  }
}
</code></pre>
          </li>
        </ul>
      </li>
    </ol>
    <div><p class="normal">Note that <a id="_idIndexMarker1650"/>the order of the clauses in the <code class="inlineCode">if</code> statement is important. We must check that <code class="inlineCode">categories</code> is <code class="inlineCode">null</code> first. If this is <code class="inlineCode">true</code>, then the code will never execute the second clause and, therefore, won’t throw a <code class="inlineCode">NullReferenceException</code> when accessing the <code class="inlineCode">Any()</code> member.</p>
    </div>
    <ol>
      <li class="numberedList" value="5">In <code class="inlineCode">Program.cs</code>, comment out the two statements that create a <code class="inlineCode">Northwind</code> instance and output the database provider name, and then call the <code class="inlineCode">ConfigureConsole</code> and <code class="inlineCode">QueryingCategories</code> methods, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">ConfigureConsole();
QueryingCategories();
</code></pre>
      </li>
      <li class="numberedList">Run the <a id="_idIndexMarker1651"/>code and view the result, as shown in the following partial output:
        <pre class="programlisting con-one"><code class="hljs-con">Beverages has 12 products.
Condiments has 12 products.
Confections has 13 products.
Dairy Products has 10 products.
Grains/Cereals has 7 products.
Meat/Poultry has 6 products.
Produce has 5 products.
Seafood has 12 products.
</code></pre>
      </li>
    </ol>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> If you see the following exception, the most likely problem is that the <code class="inlineCode">Northwind.db</code> file is not being copied to the output directory: <code class="inlineCode">Unhandled exception. Microsoft.Data.Sqlite.SqliteException (0x80004005): SQLite Error 1: 'no such table: Categories'</code>. Make sure that <strong class="screenText">Copy to Output Directory</strong> is set, but even when it is, some code editors do not always copy the file when they should. You might need to manually copy the <code class="inlineCode">Northwind.db</code> file to the appropriate directory.</p>
    </div>
    <h2 id="_idParaDest-637" class="heading-2">Filtering included entities</h2>
    <p class="normal">EF Core 5 introduced <strong class="keyWord">filtered includes</strong>, which means you can specify a lambda expression <a id="_idIndexMarker1652"/>in the <code class="inlineCode">Include</code> method call to filter which entities are returned in the results:</p>
    <ol>
      <li class="numberedList" value="1">In <code class="inlineCode">Program.Queries.cs</code>, define a <code class="inlineCode">FilteredIncludes</code> method and add statements to do these tasks, as shown in the following code:<ul>
          <li class="bulletList level-2">Create an instance of the <code class="inlineCode">Northwind</code> class that will manage the database.</li>
          <li class="bulletList level-2">Prompt the user to enter a minimum value for units in stock.</li>
          <li class="bulletList level-2">Create a query for categories that have products with that minimum number of units in stock.</li>
          <li class="bulletList level-2">Enumerate through the categories and products, outputting the <a id="_idIndexMarker1653"/>name and units in stock for each one:
            <pre class="programlisting code"><code class="hljs-code">private static void FilteredIncludes()
{
  using NorthwindDb db = new();
  SectionTitle("Products with a minimum number of units in stock");
  string? input;
  int stock;
  do
  {
    Write("Enter a minimum for units in stock: ");
    input = ReadLine();
  } while (!int.TryParse(input, out stock));
  IQueryable&lt;Category&gt;? categories = db.Categories?
    .Include(c =&gt; c.Products.Where(p =&gt; p.Stock &gt;= stock));
  if (categories is null || !categories.Any())
  {
    Fail("No categories found.");
    return;
  }
  foreach (Category c in categories)
  {
    WriteLine(
      "{0} has {1} products with a minimum {2} units in stock.",
      arg0: c.CategoryName, arg1: c.Products.Count, arg2: stock);
    foreach(Product p in c.Products)
    {
      WriteLine($"  {p.ProductName} has {p.Stock} units in stock.");
    }
  }
}
</code></pre>
          </li>
        </ul>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, call the <code class="inlineCode">FilteredIncludes</code> method, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">FilteredIncludes();
</code></pre>
      </li>
      <li class="numberedList">Run the <a id="_idIndexMarker1654"/>code, enter a minimum value for units in stock, like <code class="inlineCode">100</code>, and view the result, as shown in the following partial output:
        <pre class="programlisting con-one"><code class="hljs-con">Enter a minimum for units in stock: 100
Beverages has 2 products with a minimum of 100 units in stock.
  Sasquatch Ale has 111 units in stock.
  Rhönbräu Klosterbier has 125 units in stock.
Condiments has 2 products with a minimum of 100 units in stock.
  Grandma's Boysenberry Spread has 120 units in stock.
  Sirop d'érable has 113 units in stock.
Confections has 0 products with a minimum of 100 units in stock.
Dairy Products has 1 products with a minimum of 100 units in stock.
  Geitost has 112 units in stock.
Grains/Cereals has 1 products with a minimum of 100 units in stock.
  Gustaf's Knäckebröd has 104 units in stock.
Meat/Poultry has 1 products with a minimum of 100 units in stock.
  Pâté chinois has 115 units in stock.
Produce has 0 products with a minimum of 100 units in stock.
Seafood has 3 products with a minimum of 100 units in stock.
  Inlagd Sill has 112 units in stock.
  Boston Crab Meat has 123 units in stock.
  Röd Kaviar has 101 units in stock.
</code></pre>
      </li>
    </ol>
    <div><p class="normal"><strong class="keyWord">Unicode characters in the Windows console</strong>: There is a limitation with the console <a id="_idIndexMarker1655"/>provided by Microsoft on versions of Windows before the Windows 10 Fall Creators Update. By default, the console cannot display Unicode characters, for example, the ones in the name Rhönbräu.</p>
      <p class="normal">If you have this issue, then you can temporarily change the code page (also known as the character set) in a console to Unicode UTF-8 by entering the following command at the prompt before running the app:</p>
      <pre class="programlisting con"><code class="hljs-con">chcp 65001
</code></pre>
    </div>
    <h2 id="_idParaDest-638" class="heading-2">Filtering and sorting products</h2>
    <p class="normal">Let’s <a id="_idIndexMarker1656"/>explore a more <a id="_idIndexMarker1657"/>complex query that will filter and sort data:</p>
    <ol>
      <li class="numberedList" value="1">In <code class="inlineCode">Program.Queries.cs</code>, define a <code class="inlineCode">QueryingProducts</code> method, and add statements to do the following, as shown in the following code:<ul>
          <li class="bulletList level-2">Create an instance of the <code class="inlineCode">Northwind</code> class that will manage the database.</li>
          <li class="bulletList level-2">Prompt the user for a price for products.</li>
          <li class="bulletList level-2">Create a query for products that cost more than the price using LINQ.</li>
          <li class="bulletList level-2">Loop through the results, outputting the ID, name, cost (formatted in US dollars), and number of units in stock:
            <pre class="programlisting code"><code class="hljs-code">private static void QueryingProducts()
{
  using NorthwindDb db = new();
  SectionTitle("Products that cost more than a price, highest at top");
  string? input;
  decimal price;
  do
  {
    Write("Enter a product price: ");
    input = ReadLine();
  } while (!decimal.TryParse(input, out price));
  IQueryable&lt;Product&gt;? products = db.Products?
    .Where(product =&gt; product.Cost &gt; price)
    .OrderByDescending(product =&gt; product.Cost);
  if (products is null || !products.Any())
  {
    Fail("No products found.");
    return;
  }
  foreach (Product p in products)
  {
    WriteLine(
      "{0}: {1} costs {2:$#,##0.00} and has {3} in stock.",
      p.ProductId, p.ProductName, p.Cost, p.Stock);
  }
}
</code></pre>
          </li>
        </ul>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, call the <code class="inlineCode">QueryingProducts</code> method.</li>
      <li class="numberedList">Run <a id="_idIndexMarker1658"/>the code, enter <code class="inlineCode">50</code> when prompted to enter a product price, view the result, and <a id="_idIndexMarker1659"/>note the descending order by cost, as shown in the following partial output:
        <pre class="programlisting con-one"><code class="hljs-con">Enter a product price: 50
38: Côte de Blaye costs $263.50 and has 17 in stock.
29: Thüringer Rostbratwurst costs $123.79 and has 0 in stock.
9: Mishi Kobe Niku costs $97.00 and has 29 in stock.
20: Sir Rodney's Marmalade costs $81.00 and has 40 in stock.
18: Carnarvon Tigers costs $62.50 and has 42 in stock.
59: Raclette Courdavault costs $55.00 and has 79 in stock.
51: Manjimup Dried Apples costs $53.00 and has 20 in stock.
</code></pre>
      </li>
      <li class="numberedList">Run <a id="_idIndexMarker1660"/>the code, enter <code class="inlineCode">500</code> when prompted to enter a product price, and view the result, as <a id="_idIndexMarker1661"/>shown in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">Fail &gt; No products found.
</code></pre>
      </li>
    </ol>
    <h2 id="_idParaDest-639" class="heading-2">Getting the generated SQL</h2>
    <p class="normal">You might be wondering how well written the SQL statements are that are generated <a id="_idIndexMarker1662"/>from the C# queries we write. EF Core 5 introduced a quick and easy way to see the SQL generated:</p>
    <ol>
      <li class="numberedList" value="1">In the <code class="inlineCode">QueryingProducts</code> method, before using the <code class="inlineCode">foreach</code> statement to enumerate the query, add a statement to output the generated SQL, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">// Calling ToQueryString does not execute against the database.
// LINQ to Entities just converts the LINQ query to an SQL statement.
Info($"ToQueryString: {products.ToQueryString()}");
</code></pre>
      </li>
    </ol>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> The <code class="inlineCode">ToQueryString</code> method can only work on objects that implement <code class="inlineCode">IQueryable</code>. This means that if you write a LINQ query using deferred methods like <code class="inlineCode">Where</code>, <code class="inlineCode">GroupBy</code>, <code class="inlineCode">Select</code>, <code class="inlineCode">OrderBy</code>, <code class="inlineCode">Join</code>, <code class="inlineCode">Take</code>, <code class="inlineCode">Skip</code>, <code class="inlineCode">Reverse</code>, and so on, then <code class="inlineCode">ToQueryString</code> can show you the SQL before you run the query. But methods that return a non-<code class="inlineCode">IQueryable</code> value and immediately execute the query, like a single scalar result like <code class="inlineCode">Count()</code> or <code class="inlineCode">First()</code>, do not support <code class="inlineCode">ToQueryString</code>.</p>
    </div>
    <ol>
      <li class="numberedList" value="2">Run the code, enter a minimum value for units in stock, like <code class="inlineCode">95</code>, and view the result, as shown in the following partial output:
        <pre class="programlisting con-one"><code class="hljs-con">Enter a minimum for units in stock: 95
Connection: Data Source=C:\cs13net9\Chapter10\WorkingWithEFCore\bin\Debug\net9.0\Northwind.db
Info &gt; ToQueryString: .param set @__stock_0 95
SELECT "c"."CategoryId", "c"."CategoryName", "c"."Description", "t"."ProductId", "t"."CategoryId", "t"."UnitPrice", "t"."Discontinued", "t"."ProductName", "t"."UnitsInStock"
FROM "Categories" AS "c"
LEFT JOIN (
    SELECT "p"."ProductId", "p"."CategoryId", "p"."UnitPrice", "p"."Discontinued", "p"."ProductName", "p"."UnitsInStock"
    FROM "Products" AS "p"
    WHERE "p"."UnitsInStock" &gt;= @__stock_0
) AS "t" ON "c"."CategoryId" = "t"."CategoryId"
ORDER BY "c"."CategoryId"
Beverages has 2 products with a minimum of 95 units in stock.
  Sasquatch Ale has 111 units in stock.
  Rhönbräu Klosterbier has 125 units in stock.
...
</code></pre>
      </li>
    </ol>
    <p class="normal">Note that the <a id="_idIndexMarker1663"/>SQL parameter named <code class="inlineCode">@__stock_0</code> has been set to a minimum stock value of <code class="inlineCode">95</code>.</p>
    <p class="normal">If you used SQL Server, the generated SQL will be slightly different. For example, it uses square brackets instead of double quotes around object names, as shown in the following output:</p>
    <pre class="programlisting con"><code class="hljs-con">Info &gt; ToQueryString: DECLARE @__stock_0 smallint = CAST(95 AS smallint);
SELECT [c].[CategoryId], [c].[CategoryName], [c].[Description], [t].[ProductId], [t].[CategoryId], [t].[UnitPrice], [t].[Discontinued], [t].[ProductName], [t].[UnitsInStock]
FROM [Categories] AS [c]
LEFT JOIN (
    SELECT [p].[ProductId], [p].[CategoryId], [p].[UnitPrice], [p].[Discontinued], [p].[ProductName], [p].[UnitsInStock]
    FROM [Products] AS [p]
    WHERE [p].[UnitsInStock] &gt;= @__stock_0
) AS [t] ON [c].[CategoryId] = [t].[CategoryId]
ORDER BY [c].[CategoryId]
</code></pre>
    <h2 id="_idParaDest-640" class="heading-2">Logging EF Core</h2>
    <p class="normal">To monitor <a id="_idIndexMarker1664"/>the interaction between EF Core and the database, we can enable logging. Logging could be to the console, to <code class="inlineCode">Debug</code> or <code class="inlineCode">Trace</code>, or to a file. Enabling logging for EF Core shows all of the SQL commands that are actually executed against the database. <code class="inlineCode">ToQueryString</code> does not execute against the database.</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: By default, EF Core logging will exclude any data that is sensitive. You can include this data by calling the <code class="inlineCode">EnableSensitiveDataLogging</code> method, especially during development. You should disable it before deploying to production. You can also call <code class="inlineCode">EnableDetailedErrors</code>.</p>
    </div>
    <p class="normal">Let’s see an example of this in action:</p>
    <ol>
      <li class="numberedList" value="1">In <code class="inlineCode">NorthwindDb.cs</code>, at the bottom of the <code class="inlineCode">OnConfiguring</code> method, add statements to log to the console and to include sensitive data like parameter values for commands being sent to the database if we compile the debug configuration, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">optionsBuilder.LogTo(WriteLine) // This is the Console method.
#if DEBUG
  .EnableSensitiveDataLogging() // Include SQL parameters.
  .EnableDetailedErrors()
#endif
;
</code></pre>
        <div><p class="normal"><code class="inlineCode">LogTo</code> requires an <code class="inlineCode">Action&lt;string&gt;</code> delegate. EF Core will call this delegate, passing a <code class="inlineCode">string</code> value for each log message. Passing the <code class="inlineCode">Console</code> class <code class="inlineCode">WriteLine</code> method, therefore, tells the logger to write each method to the console.</p>
        </div>
      </li>
    </ol>
    <ol>
      <li class="numberedList" value="2">Note that <a id="_idIndexMarker1665"/>when the solution configuration is <strong class="screenText">Debug</strong>, the calls to the <code class="inlineCode">EnableSensitiveDataLogging</code> and <code class="inlineCode">EnableDetailedErrors</code> methods are included in the compilation, but if you change the solution configuration to <strong class="screenText">Release</strong>, the method calls are grayed out to indicate that they are not compiled, as shown in <em class="italic">Figure 10.6</em>:</li>
    </ol>
    <figure class="mediaobject"><img src="img/B22322_10_06.png" alt="" width="812" height="268"/></figure>
    <p class="packt_figref">Figure 10.6: Including SQL parameters in logging for debug configuration</p>
    <ol>
      <li class="numberedList" value="3">Run the code and view the log messages, which are shown in the following partial output:
        <pre class="programlisting con-one"><code class="hljs-con">warn: 7/16/2023 14:03:40.255 CoreEventId.SensitiveDataLoggingEnabledWarning[10400] (Microsoft.EntityFrameworkCore.Infrastructure)
      Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development.
...
dbug: 05/03/2023 12:36:11.702 RelationalEventId.ConnectionOpening[20000] (Microsoft.EntityFrameworkCore.Database.Connection)
      Opening connection to database 'main' on server 'C:\cs13net9\Chapter10\WorkingWithEFCore\bin\Debug\net9.0\Northwind.db'.
dbug: 05/03/2023 12:36:11.718 RelationalEventId.ConnectionOpened[20001] (Microsoft.EntityFrameworkCore.Database.Connection)
      Opened connection to database 'main' on server 'C:\cs13net9\Chapter10\WorkingWithEFCore\bin\Debug\net9.0\Northwind.db'.
dbug: 05/03/2023 12:36:11.721 RelationalEventId.CommandExecuting[20100] (Microsoft.EntityFrameworkCore.Database.Command)
      Executing DbCommand [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT "c"."CategoryId", "c"."CategoryName", "c"."Description", "p"."ProductId", "p"."CategoryId", "p"."UnitPrice", "p"."Discontinued", "p"."ProductName", "p"."UnitsInStock"
      FROM "Categories" AS "c"
      LEFT JOIN "Products" AS "p" ON "c"."CategoryId" = "p"."CategoryId"
      ORDER BY "c"."CategoryId"
...
</code></pre>
      </li>
    </ol>
    <p class="normal">Your logs <a id="_idIndexMarker1666"/>might vary from those shown above based on your chosen database provider and code editor, as well as future improvements to EF Core. For now, note that different events, like opening a connection or executing a command, have different event IDs, as shown in the following list:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">20000</code> <code class="inlineCode">RelationalEventId.ConnectionOpening</code>: Includes the database file path</li>
      <li class="bulletList"><code class="inlineCode">20001</code> <code class="inlineCode">RelationalEventId.ConnectionOpened</code>: Includes the database file path</li>
      <li class="bulletList"><code class="inlineCode">20100</code> <code class="inlineCode">RelationalEventId.CommandExecuting</code>: Includes the SQL statement</li>
    </ul>
    <h2 id="_idParaDest-641" class="heading-2">Filtering logs by provider-specific values</h2>
    <p class="normal">The event ID values and what they mean will be specific to the EF Core provider. If <a id="_idIndexMarker1667"/>we want to know how the LINQ query has been translated into SQL statements and is executing, then the event ID to output has an <code class="inlineCode">Id</code> value of <code class="inlineCode">20100</code>:</p>
    <ol>
      <li class="numberedList" value="1">At the top of <code class="inlineCode">NorthwindDb.cs</code>, import the namespace for working for EF Core diagnostics, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">// To use RelationalEventId.
using Microsoft.EntityFrameworkCore.Diagnostics;
</code></pre>
      </li>
      <li class="numberedList">Modify the <code class="inlineCode">LogTo</code> method call to only output events with an <code class="inlineCode">Id</code> of <code class="inlineCode">20100</code>, as shown highlighted in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">optionsBuilder.LogTo(WriteLine<strong class="hljs-slc">,</strong> // This is the Console method.
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc">[] { RelationalEventId.CommandExecuting }</strong>)
#if DEBUG
  .EnableSensitiveDataLogging()
  .EnableDetailedErrors()
#endif
;
</code></pre>
      </li>
      <li class="numberedList">Run the code and note the following SQL statements that were logged, as shown in the following output, which has been edited for space:
        <pre class="programlisting con-one"><code class="hljs-con">dbug: 05/03/2022 12:48:43.153 RelationalEventId.CommandExecuting[20100] (Microsoft.EntityFrameworkCore.Database.Command)
      Executing DbCommand [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT "c"."CategoryId", "c"."CategoryName", "c"."Description", "p"."ProductId", "p"."CategoryId", "p"."UnitPrice", "p"."Discontinued", "p"."ProductName", "p"."UnitsInStock"
      FROM "Categories" AS "c"
      LEFT JOIN "Products" AS "p" ON "c"."CategoryId" = "p"."CategoryId"
      ORDER BY "c"."CategoryId"
Beverages has 12 products.
Condiments has 12 products.
Confections has 13 products.
Dairy Products has 10 products.
Grains/Cereals has 7 products.
Meat/Poultry has 6 products.
Produce has 5 products.
Seafood has 12 products.
</code></pre>
      </li>
    </ol>
    <h2 id="_idParaDest-642" class="heading-2">Logging with query tags</h2>
    <p class="normal">When <a id="_idIndexMarker1668"/>logging LINQ queries, it can be tricky to correlate log messages in complex scenarios. EF Core 2.2 introduced the query tags feature to help by allowing you to add SQL comments to the log.</p>
    <p class="normal">You can annotate a LINQ query using the <code class="inlineCode">TagWith</code> method, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">IQueryable&lt;Product&gt;? products = db.Products?
  .TagWith("Products filtered by price and sorted.")
  .Where(product =&gt; product.Cost &gt; price)
  .OrderByDescending(product =&gt; product.Cost);
</code></pre>
    <p class="normal">This will add an SQL comment to the log, as shown in the following output:</p>
    <pre class="programlisting con"><code class="hljs-con">-- Products filtered by price and sorted.
</code></pre>
    <h2 id="_idParaDest-643" class="heading-2">Getting a single entity</h2>
    <p class="normal">There are two LINQ methods to get a single entity: <code class="inlineCode">First</code> and <code class="inlineCode">Single</code>. It is important <a id="_idIndexMarker1669"/>to understand the difference between them when using an EF Core database provider. Let’s see an example:</p>
    <ol>
      <li class="numberedList" value="1">In <code class="inlineCode">Program.Queries.cs</code>, define a <code class="inlineCode">GettingOneProduct</code> method, and add statements to do the following, as shown in the following code:<ul>
          <li class="bulletList level-2">Create an instance of the <code class="inlineCode">Northwind</code> class that will manage the database.</li>
          <li class="bulletList level-2">Prompt the user for a product ID.</li>
          <li class="bulletList level-2">Create a query for products with that product ID using the <code class="inlineCode">First</code> and <code class="inlineCode">Single</code> methods.</li>
          <li class="bulletList level-2">Write an SQL statement for each query to the console:
            <pre class="programlisting code"><code class="hljs-code">private static void GettingOneProduct()
{
  using NorthwindDb db = new();
  SectionTitle("Getting a single product");
  string? input;
  int id;
  do
  {
    Write("Enter a product ID: ");
    input = ReadLine();
  } while (!int.TryParse(input, out id));
  // This query is not deferred because the First method does not return IEnumerable or IQueryable.
  // The LINQ query is immediately converted to SQL and executed to fetch the first product.
  Product? product = db.Products?
    .First(product =&gt; product.ProductId == id);
  Info($"First: {product?.ProductName}");
  if (product is null) Fail("No product found using First.");
  product = db.Products?
    .Single(product =&gt; product.ProductId == id);
  Info($"Single: {product?.ProductName}");
  if (product is null) Fail("No product found using Single.");
}
</code></pre>
          </li>
        </ul>
      </li>
    </ol>
    <div><p class="normal">LINQ methods that fetch a single entity (<code class="inlineCode">First</code>, <code class="inlineCode">FirstOrDefault</code>, <code class="inlineCode">Single</code>, <code class="inlineCode">SingleOrDefault</code>, <code class="inlineCode">ElementAt</code>, and <code class="inlineCode">ElementAtOrDefault</code>) or return a single scalar value or entity like the aggregate methods (<code class="inlineCode">Count</code>, <code class="inlineCode">Sum</code>, <code class="inlineCode">Max</code>, <code class="inlineCode">Min</code>, <code class="inlineCode">Average</code>, <code class="inlineCode">All</code>, <code class="inlineCode">Any</code>, and so on) are not deferred. When using the LINQ to Entities provider, any LINQ query that ends with a call to one of these methods is immediately converted to an SQL statement and executed against the database.</p>
    </div>
    <ol>
      <li class="numberedList" value="2">In <code class="inlineCode">Program.cs</code>, call the <code class="inlineCode">GettingOneProduct</code> method.</li>
      <li class="numberedList">Run <a id="_idIndexMarker1670"/>the code, enter <code class="inlineCode">1</code> when prompted to enter a product ID, view the result, and note the SQL statements used by <code class="inlineCode">First</code> and <code class="inlineCode">Single</code>, as shown in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">Enter a product ID: 1
Connection: Data Source=C:\cs13net9\Chapter10\WorkingWithEFCore\bin\Debug\net9.0\Northwind.db
dbug: 9/17/2023 18:04:14.210 RelationalEventId.CommandExecuting[20100] (Microsoft.EntityFrameworkCore.Database.Command)
      Executing DbCommand [Parameters=[@__id_0='1'], CommandType='Text', CommandTimeout='30']
      SELECT "p"."ProductId", "p"."CategoryId", "p"."UnitPrice", "p"."Discontinued", "p"."ProductName", "p"."UnitsInStock"
      FROM "Products" AS "p"
      WHERE "p"."ProductId" &gt; @__id_0
      <strong class="hljs-con-slc">LIMIT 1</strong>
Info &gt; First: Chang
dbug: 9/17/2023 18:04:14.286 RelationalEventId.CommandExecuting[20100] (Microsoft.EntityFrameworkCore.Database.Command)
      Executing DbCommand [Parameters=[@__id_0='1'], CommandType='Text', CommandTimeout='30']
      SELECT "p"."ProductId", "p"."CategoryId", "p"."UnitPrice", "p"."Discontinued", "p"."ProductName", "p"."UnitsInStock"
      FROM "Products" AS "p"
      WHERE "p"."ProductId" &gt; @__id_0
      <strong class="hljs-con-slc">LIMIT 2</strong>
Info &gt; Single: Chang
</code></pre>
      </li>
    </ol>
    <p class="normal">Note <a id="_idIndexMarker1671"/>that both methods execute the same SQL statement except for the <code class="inlineCode">LIMIT</code> clauses highlighted in the preceding code. For <code class="inlineCode">First</code>, it sets <code class="inlineCode">LIMIT 1</code> but for <code class="inlineCode">Single</code>, it sets <code class="inlineCode">LIMIT 2</code>. Why?</p>
    <p class="normal">For <code class="inlineCode">First</code>, the query can match one or more entities and only the first will be returned. If there are no matches, an exception is thrown, but you can call <code class="inlineCode">FirstOrDefault</code> to return <code class="inlineCode">null</code> if there are no matches.</p>
    <p class="normal">For <code class="inlineCode">Single</code>, the query must match only one entity and it will be returned. If there is more than one match, an exception must be thrown. But the only way for EF Core to know if there is more than one match is to request more than one and check. So, it has to set <code class="inlineCode">LIMIT 2</code> and check if there is a second entity match.</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: If you do not need to make sure that only one entity matches, use <code class="inlineCode">First</code> instead of <code class="inlineCode">Single</code> to avoid retrieving two records.</p>
    </div>
    <h2 id="_idParaDest-644" class="heading-2">Pattern matching with Like</h2>
    <p class="normal">EF Core <a id="_idIndexMarker1672"/>supports common SQL statements, including <code class="inlineCode">Like</code> for pattern matching:</p>
    <ol>
      <li class="numberedList" value="1">In <code class="inlineCode">Program.Queries.cs</code>, add a method named <code class="inlineCode">QueryingWithLike</code>, as shown in the following code, and note the following:<ul>
          <li class="bulletList level-2">We have enabled logging.</li>
          <li class="bulletList level-2">We prompt the user to enter part of a product name and then use the <code class="inlineCode">EF.Functions.Like</code> method to search anywhere in the <code class="inlineCode">ProductName</code> property.</li>
          <li class="bulletList level-2">For each matching product, we output its name, stock, and if it is discontinued:
            <pre class="programlisting code"><code class="hljs-code">private static void QueryingWithLike()
{
  using NorthwindDb db = new();
  SectionTitle("Pattern matching with LIKE");
  Write("Enter part of a product name: ");
  string? input = ReadLine();
  if (string.IsNullOrWhiteSpace(input))
  {
    Fail("You did not enter part of a product name.");
    return;
  }
  IQueryable&lt;Product&gt;? products = db.Products?
    .Where(p =&gt; EF.Functions.Like(p.ProductName, $"%{input}%"));
  if (products is null || !products.Any())
  {
    Fail("No products found.");
    return;
  }
  foreach (Product p in products)
  {
    WriteLine("{0} has {1} units in stock. Discontinued: {2}",
      p.ProductName, p.Stock, p.Discontinued);
  }
}
</code></pre>
          </li>
        </ul>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, comment out the existing methods and call <code class="inlineCode">QueryingWithLike</code>.</li>
      <li class="numberedList">Run <a id="_idIndexMarker1673"/>the code, enter a partial product name, such as <code class="inlineCode">che</code>, and view the result, as shown in the following edited output:
        <pre class="programlisting con-one"><code class="hljs-con">Enter part of a product name: che
dbug: 07/16/2023 13:03:42.793 RelationalEventId.CommandExecuting[20100] (Microsoft.EntityFrameworkCore.Database.Command)
      Executing DbCommand [Parameters=[@__Format_1='%che%' (Size = 5)], CommandType='Text', CommandTimeout='30']
      SELECT "p"."ProductId", "p"."CategoryId", "p"."UnitPrice", "p"."Discontinued", "p"."ProductName", "p"."UnitsInStock"
      FROM "Products" AS "p"
      WHERE "p"."ProductName" LIKE @__Format_1
Chef Anton's Cajun Seasoning has 53 units in stock. Discontinued: False
Chef Anton's Gumbo Mix has 0 units in stock. Discontinued: True
Queso Manchego La Pastora has 86 units in stock. Discontinued: False
</code></pre>
      </li>
    </ol>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn more about wildcards with <code class="inlineCode">Like</code> at <a href="https://learn.microsoft.com/en-us/dotnet/framework/data/adonet/ef/language-reference/like-entity-sql">https://learn.microsoft.com/en-us/dotnet/framework/data/adonet/ef/language-reference/like-entity-sql</a>.</p>
    </div>
    <h2 id="_idParaDest-645" class="heading-2">Generating a random number in queries</h2>
    <p class="normal">EF Core 6 introduced a useful function, <code class="inlineCode">EF.Functions.Random</code>, that maps to a database <a id="_idIndexMarker1674"/>function returning a pseudo-random real number between <code class="inlineCode">0.0</code> and <code class="inlineCode">1.0</code>, exclusive.</p>
    <p class="normal">For example, suppose you’re developing a quiz or survey app that needs to display questions in a random order each time a user takes it. You can use <code class="inlineCode">EF.Functions.Random()</code> to fetch a random selection of questions directly from the database, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">var randomQuestions = await db.Questions
  .OrderBy(q =&gt; EF.Functions.Random())
  .Take(10); // Select 10 random questions.
</code></pre>
    <p class="normal">During the development and testing phase, generating random data can be useful for simulating various scenarios. For example, creating randomized datasets for performance testing or generating random sets of rows for unit tests by selecting about half of the products randomly, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">var randomDataSample = await db.Products
  .Where(d =&gt; EF.Functions.Random() &gt; 0.5);
</code></pre>
    <h2 id="_idParaDest-646" class="heading-2">Defining global filters</h2>
    <p class="normal"><code class="inlineCode">Northwind</code> <a id="_idIndexMarker1675"/>products can be discontinued, so it might be useful to ensure that discontinued products are never returned in results, even if the programmer does not use <code class="inlineCode">Where</code> to filter them out in their queries:</p>
    <ol>
      <li class="numberedList" value="1">In <code class="inlineCode">NorthwindDb.cs</code>, at the bottom of the <code class="inlineCode">OnModelCreating</code> method, add a global filter to remove discontinued products, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">// A global filter to remove discontinued products.
modelBuilder.Entity&lt;Product&gt;()
  .HasQueryFilter(p =&gt; !p.Discontinued);
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, uncomment the call to <code class="inlineCode">QueryingWithLike</code>, and comment out all the other method calls.</li>
      <li class="numberedList">Run the code, enter the partial product name <code class="inlineCode">che</code>, view the result, and note that <code class="inlineCode">Chef Anton's Gumbo Mix</code> is now missing. This is because the SQL <a id="_idIndexMarker1676"/>statement generated includes a filter for the <code class="inlineCode">Discontinued</code> column, as shown highlighted in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">Enter part of a product name: che
dbug: 05/03/2022 13:34:27.290 RelationalEventId.CommandExecuting[20100] (Microsoft.EntityFrameworkCore.Database.Command)
      Executing DbCommand [Parameters=[@__Format_1='%che%' (Size = 5)], CommandType='Text', CommandTimeout='30']
      SELECT "p"."ProductId", "p"."CategoryId", "p"."UnitPrice", "p"."Discontinued", "p"."ProductName", "p"."UnitsInStock"
      FROM "Products" AS "p"
      WHERE <strong class="hljs-con-slc">NOT ("p"."Discontinued") AND</strong> ("p"."ProductName" LIKE @__Format_1)
Chef Anton's Cajun Seasoning has 53 units in stock. Discontinued? False
Queso Manchego La Pastora has 86 units in stock. Discontinued? False
Gumbär Gummibärchen has 15 units in stock. Discontinued? False
</code></pre>
      </li>
    </ol>
    <h2 id="_idParaDest-647" class="heading-2">SQL SELECT queries</h2>
    <p class="normal">Usually, you can express all the queries you need to using LINQ. But for times when <a id="_idIndexMarker1677"/>you cannot, you can use <code class="inlineCode">FromSql</code> and its related methods.</p>
    <div><p class="normal"><code class="inlineCode">FromSql</code> was introduced with EF Core 7. If you need to execute raw SQL with EF Core 6 or earlier, then you must use the <code class="inlineCode">FromSqlInterpolated</code> method.</p>
    </div>
    <p class="normal">The <code class="inlineCode">FromSql</code> method allows you to execute raw SQL queries against the database and map the results to your entity classes. <code class="inlineCode">FromSql</code> can be used to perform <code class="inlineCode">SELECT</code> queries that return entity types or types that are not part of the EF Core model.</p>
    <p class="normal">The <code class="inlineCode">FromSql</code> method is <a id="_idIndexMarker1678"/>particularly useful in the following situations:</p>
    <ul>
      <li class="bulletList">It allows you to run complex SQL queries that might not be feasible with LINQ.</li>
      <li class="bulletList">Sometimes, raw SQL can be more performant than LINQ for certain types of queries.</li>
      <li class="bulletList">If you are working with a legacy system where specific SQL queries need to be executed.</li>
      <li class="bulletList">You can execute stored procedures that return entities.</li>
    </ul>
    <p class="normal">The parameter to <code class="inlineCode">FromSql</code> must be a <code class="inlineCode">FormattableString</code>, not just a regular <code class="inlineCode">string</code> value. This is to enforce safe parameterization. Pass parameter values using the interpolated <code class="inlineCode">string</code> format.</p>
    <p class="normal">Let’s see some examples:</p>
    <ol>
      <li class="numberedList" value="1">In <code class="inlineCode">Program.Queries.cs</code>, add a method named <code class="inlineCode">GetProductUsingSql</code>, as shown in the following code:
        <pre class="programlisting code-one"><code class="hljs-code">private static void GetProductUsingSql()
{
  using NorthwindDb db = new();
  SectionTitle("Get product using SQL");
  int? rowCount = db.Products?.Count();
  if (rowCount is null)
  {
    Fail("Products table is empty.");
    return;
  }
  int productId = 1;
  Product? p = db.Products?.FromSql(
    $"SELECT * FROM Products WHERE ProductId = {
    productId}").FirstOrDefault();
  if (p is null)
  {
    Fail("Product not found.");
    return;
  }
  WriteLine($"Product: {p.ProductId} - {p.ProductName}");
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, add a call to <code class="inlineCode">GetProductUsingSql</code>.</li>
      <li class="numberedList">Run the <a id="_idIndexMarker1679"/>code and view the result, as shown in the following output:
        <pre class="programlisting con-one"><code class="hljs-con">dbug: 7/27/2024 14:47:07.515 RelationalEventId.CommandExecuting[20100] (Microsoft.EntityFrameworkCore.Database.Command)
      Executing DbCommand [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT COUNT(*)
      FROM "Products" AS "p"
      WHERE NOT ("p"."Discontinued")
dbug: 7/27/2024 14:47:07.582 RelationalEventId.CommandExecuting[20100] (Microsoft.EntityFrameworkCore.Database.Command)
      Executing DbCommand [Parameters=[p0='1'], CommandType='Text', CommandTimeout='30']
      SELECT "n"."ProductId", "n"."CategoryId", "n"."UnitPrice", "n"."Discontinued", "n"."ProductName", "n"."UnitsInStock"
      FROM (
          SELECT * FROM Products WHERE ProductId = @p0
      ) AS "n"
      WHERE NOT ("n"."Discontinued")
      LIMIT 1
Product: 1 – Chai
</code></pre>
      </li>
    </ol>
    <div><p class="normal"><code class="inlineCode">FromSql</code> can only be called on a <code class="inlineCode">DbSet&lt;T&gt;</code>, not on a LINQ query.</p>
    </div>
    <p class="normal">You <a id="_idIndexMarker1680"/>can make the SQL even more dynamic for scenarios that need it. For example, if the name of a column might change, as well as the value, then you can use <code class="inlineCode">FromSqlRaw</code>. But beware! You are responsible for ensuring this <code class="inlineCode">string</code> value is secure, especially if it originates from an untrusted source. This involves identifying <a id="_idIndexMarker1681"/>special characters like semicolons, comments, and other SQL constructs, and then properly escaping or rejecting these inputs to prevent potential security risks.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn more about dynamic SQL and parameters at <a href="https://learn.microsoft.com/en-us/ef/core/querying/sql-queries#dynamic-sql-and-parameters">https://learn.microsoft.com/en-us/ef/core/querying/sql-queries#dynamic-sql-and-parameters</a>.</p>
    </div>
    <p class="normal">You’ve now seen many common ways to query data using EF Core. In some online sections, you can look at how data is loaded and tracked and why you might want to control how EF Core does that.</p>
    <h1 id="_idParaDest-648" class="heading-1">Practicing and exploring</h1>
    <p class="normal">Test your knowledge and understanding by answering some questions, getting some hands-on practice, and exploring this chapter’s topics with deeper research.</p>
    <h2 id="_idParaDest-649" class="heading-2">Exercise 10.1 – online materials</h2>
    <p class="normal">Online materials can be extra content written by me for this book, or they can be references to content created by Microsoft or third parties.</p>
    <h3 id="_idParaDest-650" class="heading-3">Loading and tracking patterns with EF Core</h3>
    <p class="normal">Learn how data is loaded and tracked with EF Core at the following link:</p>
    <p class="normal"><a href="https://github.com/markjprice/cs13net9/blob/main/docs/ch10-loading-tracking.md">https://github.com/markjprice/cs13net9/blob/main/docs/ch10-loading-tracking.md</a></p>
    <h3 id="_idParaDest-651" class="heading-3">Modifying data with EF Core</h3>
    <p class="normal">Learn how data can be modified with EF Core at the following link:</p>
    <p class="normal"><a href="https://github.com/markjprice/cs13net9/blob/main/docs/ch10-modifying.md">https://github.com/markjprice/cs13net9/blob/main/docs/ch10-modifying.md</a></p>
    <h3 id="_idParaDest-652" class="heading-3">Working with transactions</h3>
    <p class="normal">Add transactions to the modification code:</p>
    <p class="normal"><a href="https://github.com/markjprice/cs13net9/blob/main/docs/ch10-transactions.md">https://github.com/markjprice/cs13net9/blob/main/docs/ch10-transactions.md</a></p>
    <h3 id="_idParaDest-653" class="heading-3">Exploring a Code First EF Core model</h3>
    <p class="normal">Work through an example of a Code First model that generates an empty database, seeds it with sample data, and then queries the data:</p>
    <p class="normal"><a href="https://github.com/markjprice/cs13net9/blob/main/docs/ch10-code-first.md">https://github.com/markjprice/cs13net9/blob/main/docs/ch10-code-first.md</a></p>
    <h3 id="_idParaDest-654" class="heading-3">Exploring app secrets</h3>
    <p class="normal">When connecting to a database, you often need to include sensitive secret values like a username or password. These values should never be stored in source code or even in a separate file that might be added to a code repository.</p>
    <p class="normal">Secrets should be stored locally during development and in secure systems for production. You can use <strong class="keyWord">Secret Manager</strong> during local development and <strong class="keyWord">Azure Key Vault</strong> for cloud production systems. To learn more about app secrets, I have written an online-only section that you can read at the following link:</p>
    <p class="normal"><a href="https://github.com/markjprice/cs13net9/blob/main/docs/ch10-app-secrets.md">https://github.com/markjprice/cs13net9/blob/main/docs/ch10-app-secrets.md</a></p>
    <h3 id="_idParaDest-655" class="heading-3">NoSQL databases</h3>
    <p class="normal">This chapter focused on RDBMSs such as SQL Server and SQLite. If you wish to learn more about NoSQL databases, such as Cosmos DB and MongoDB, and how to use them with EF Core, then I recommend the following links:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Welcome to Azure Cosmos DB</strong>: <a href="https://learn.microsoft.com/en-us/azure/cosmos-db/introduction">https://learn.microsoft.com/en-us/azure/cosmos-db/introduction</a></li>
      <li class="bulletList"><strong class="keyWord">Use NoSQL databases as a persistence infrastructure</strong>: <a href="https://learn.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/nosql-database-persistence-infrastructure">https://learn.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/nosql-database-persistence-infrastructure</a></li>
      <li class="bulletList"><strong class="keyWord">Document database providers for Entity Framework Core</strong>: <a href="https://github.com/BlueshiftSoftware/EntityFrameworkCore">https://github.com/BlueshiftSoftware/EntityFrameworkCore</a></li>
    </ul>
    <h2 id="_idParaDest-656" class="heading-2">Exercise 10.2 – practice exercises</h2>
    <p class="normal">Practice exercises go deeper into the topics for this chapter.</p>
    <h3 id="_idParaDest-657" class="heading-3">Exporting data using different serialization formats</h3>
    <p class="normal">In the <code class="inlineCode">Chapter10</code> solution, create a console app named <code class="inlineCode">Exercise_DataSerialization</code> that queries the <code class="inlineCode">Northwind</code> database for all the categories and products, and then serializes the data using at least three formats of serialization available to .NET. Which format of serialization uses the least number of bytes?</p>
    <h2 id="_idParaDest-658" class="heading-2">Exercise 10.3 – test your knowledge</h2>
    <p class="normal">Answer the following questions:</p>
    <ol>
      <li class="numberedList" value="1">What type would you use for the property that represents a table, for example, the <code class="inlineCode">Products</code> property of a database context?</li>
      <li class="numberedList">What type would you use for a property that represents a one-to-many relationship, for example, the <code class="inlineCode">Products</code> property of a <code class="inlineCode">Category</code> entity?</li>
      <li class="numberedList">What is the EF Core convention for primary keys?</li>
      <li class="numberedList">When might you use an annotation attribute in an entity class?</li>
      <li class="numberedList">Why might you choose the Fluent API in preference to annotation attributes?</li>
      <li class="numberedList">What does a transaction isolation level of <code class="inlineCode">Serializable</code> mean?</li>
      <li class="numberedList">What does the <code class="inlineCode">DbContext.SaveChanges()</code> method return?</li>
      <li class="numberedList">What is the difference between eager loading and explicit loading?</li>
      <li class="numberedList">How should you define an EF Core entity class to match the following table?
        <pre class="programlisting code-one"><code class="hljs-code">CREATE TABLE Employees(
  EmpId INT IDENTITY,
  FirstName NVARCHAR(40) NOT NULL,
  Salary MONEY
)
</code></pre>
      </li>
      <li class="numberedList">What benefit do you get from declaring entity navigation properties as <code class="inlineCode">virtual</code>?</li>
    </ol>
    <h2 id="_idParaDest-659" class="heading-2">Exercise 10.4 – explore topics</h2>
    <p class="normal">Use this link to learn more about the topics covered in this chapter:</p>
    <p class="normal"><a href="https://github.com/markjprice/cs13net9/blob/main/docs/book-links.md#chapter-10---working-with-data-using-entity-framework-core">https://github.com/markjprice/cs13net9/blob/main/docs/book-links.md#chapter-10---working-with-data-using-entity-framework-core</a></p>
    <h1 id="_idParaDest-660" class="heading-1">Summary</h1>
    <p class="normal">In this chapter, you learned how to do the following:</p>
    <ul>
      <li class="bulletList">Connect to and build entity data models for an existing database.</li>
      <li class="bulletList">Execute a simple LINQ query and process the results.</li>
      <li class="bulletList">Use filtered includes.</li>
      <li class="bulletList">Execute SQL queries directly.</li>
    </ul>
    <p class="normal">In the next chapter, you will learn how to write more advanced LINQ queries to select, filter, sort, join, and group.</p>
  </div>
</div></div></body></html>