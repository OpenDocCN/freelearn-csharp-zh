<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer365">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">21</span></h1>
<h1 class="chapterTitle" id="_idParaDest-433"><span class="koboSpan" id="kobo.2.1">Case Study</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">As mentioned during the previous chapters, for this new edition, we reformulated the way we present the case study of the book – </span><strong class="keyWord"><span class="koboSpan" id="kobo.4.1">World Wild Travel Club</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.6.1">WWTravelClub</span></strong><span class="koboSpan" id="kobo.7.1">). </span><span class="koboSpan" id="kobo.7.2">This case study will take you through the process of creating the software architecture for a travel agency.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.8.1">The purpose of this case study is not to furnish a production-ready application, but just to help you understand the theory explained in each chapter and to provide an example of how to develop an enterprise application with Azure, Azure DevOps, C# 12, .NET 8, ASP.NET Core, and all other technologies introduced in this book.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.9.1">Let’s start with a description of what our case study application is. </span><span class="koboSpan" id="kobo.9.2">Then, we will gradually move to formal specifications.</span></p>
<h1 class="heading-1" id="_idParaDest-434"><span class="koboSpan" id="kobo.10.1">Introducing World Wild Travel Club</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.11.1">WWTravelClub is a travel agency </span><a id="_idIndexMarker1547"/><span class="koboSpan" id="kobo.12.1">that was created to revolutionize vacation planning and travel experiences globally. </span><span class="koboSpan" id="kobo.12.2">To do so, they are developing an online service, where each aspect of a trip is meticulously curated and supported by a dedicated team of destination-specific experts.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.13.1">The concept of this platform is that you can be both a visitor and a destination expert at the same time. </span><span class="koboSpan" id="kobo.13.2">The more you participate as an expert in a destination, the more points you score. </span><span class="koboSpan" id="kobo.13.3">These points can then be redeemed for tickets that people buy online using the platform.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.14.1">The responsible for the WWTravelClub project came with the following requirements list for the platform:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.15.1">Common user view:</span><ul>
<li class="bulletList"><span class="koboSpan" id="kobo.16.1">Promotional packages on the home page</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.17.1">Get a recommendation</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.18.1">Search for packages</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.19.1">Details for each package:</span><ul>
<li class="bulletList"><span class="koboSpan" id="kobo.20.1">Buy a package</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.21.1">Buy a package with a club of experts included</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.22.1">Comment on your experience</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.23.1">Ask an expert</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.24.1">Evaluate an expert</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.25.1">Register as a common user</span></li>
</ul>
</li>
</ul>
</li>
<li class="bulletList"><span class="koboSpan" id="kobo.26.1">Destination expert view:</span><ul>
<li class="bulletList"><span class="koboSpan" id="kobo.27.1">The same view as the common user view</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.28.1">Answer questions asking for your destination expertise</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.29.1">Manage the points you scored by answering questions</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.30.1">Exchange points for tickets</span></li>
</ul>
</li>
<li class="bulletList"><span class="koboSpan" id="kobo.31.1">Administrator view:</span><ul>
<li class="bulletList"><span class="koboSpan" id="kobo.32.1">Manage </span><a id="_idIndexMarker1548"/><span class="koboSpan" id="kobo.33.1">packages</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.34.1">Manage common users</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.35.1">Manage destination experts</span></li>
</ul>
</li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.36.1">Besides the functionalities asked for on the platform, it is important to note that WWTravelClub intends to have more than 100 destination experts per package and will offer around 1,000 different packages all over the world.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.37.1">It is important to know that, in general, customers do not bring the requirements ready for development. </span><span class="koboSpan" id="kobo.37.2">That is why the process of gathering requirements is so important, as described in </span><em class="italic"><span class="koboSpan" id="kobo.38.1">Chapter 1, Understanding the Importance of Software Architecture</span></em><span class="koboSpan" id="kobo.39.1">. </span><span class="koboSpan" id="kobo.39.2">This process will transform the list presented above into user needs and system requirements. </span><span class="koboSpan" id="kobo.39.3">Let’s check how this will work in the next section.</span></p>
<h1 class="heading-1" id="_idParaDest-435"><span class="koboSpan" id="kobo.40.1">User needs and system requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.41.1">As presented in </span><em class="italic"><span class="koboSpan" id="kobo.42.1">Chapter 1, Understanding the Importance of Software Architecture</span></em><span class="koboSpan" id="kobo.43.1">, to summarize the user needs, you may use the User Story pattern. </span><span class="koboSpan" id="kobo.43.2">We have used this approach here so that you </span><a id="_idIndexMarker1549"/><span class="koboSpan" id="kobo.44.1">can read the following user stories for WWTravelClub:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.45.1">US_001</span></code><span class="koboSpan" id="kobo.46.1">: As a common user, I want to view promotional packages on the home page so that I can easily find my next vacation.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.47.1">US_002</span></code><span class="koboSpan" id="kobo.48.1">: As a common user, I want to search for packages I cannot find on the home page so that I can explore other trip opportunities.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.49.1">US_003</span></code><span class="koboSpan" id="kobo.50.1">: As a common user, I want to see the details of a package so that I can decide which package to buy.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.51.1">US_004</span></code><span class="koboSpan" id="kobo.52.1">: As a common user, I want to register myself so that I can start buying the package.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.53.1">US_005</span></code><span class="koboSpan" id="kobo.54.1">: As a registered user, I want to process the payment so that I can buy a package.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.55.1">US_006</span></code><span class="koboSpan" id="kobo.56.1">: As a registered user, I want to buy a package with an expert recommendation included so that I can have an exclusive trip experience.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.57.1">US_007</span></code><span class="koboSpan" id="kobo.58.1">: As a registered user, I want to ask for an expert so that I can find out the best things to do on my trip.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.59.1">US_008</span></code><span class="koboSpan" id="kobo.60.1">: As a registered user, I want to comment on my experience so that I can give feedback on my trip.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.61.1">US_009</span></code><span class="koboSpan" id="kobo.62.1">: As a registered user, I want to review an expert who has helped me so that I can share with others how fantastic they were.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.63.1">US_010</span></code><span class="koboSpan" id="kobo.64.1">: As a registered user, I want to register as a destination expert view so that I can help people who travel to my city.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.65.1">US_011</span></code><span class="koboSpan" id="kobo.66.1">: As an expert user, I want to answer questions about my city so that I can score points to be exchanged in the future.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.67.1">US_012</span></code><span class="koboSpan" id="kobo.68.1">: As an expert user, I want to exchange points for tickets so that I can travel around the world more.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.69.1">US_013</span></code><span class="koboSpan" id="kobo.70.1">: As an administrator user, I want to manage packages so that users can have fantastic opportunities to travel.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.71.1">US_014</span></code><span class="koboSpan" id="kobo.72.1">: As an administrator user, I want to manage registered users so that WWTravelClub can guarantee good service quality.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.73.1">US_015</span></code><span class="koboSpan" id="kobo.74.1">: As an administrator user, I want to manage expert users so that all the questions regarding our destinations are answered.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.75.1">US_016</span></code><span class="koboSpan" id="kobo.76.1">: As an administrator user, I want to offer more than 1,000 packages around the world so that different countries can experience the WWTravelClub service.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.77.1">US_017</span></code><span class="koboSpan" id="kobo.78.1">: As the CEO, I want to have more than 1,000 users simultaneously accessing the website so that the business can scale effectively.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.79.1">US_018</span></code><span class="koboSpan" id="kobo.80.1">: As a user, I want to access WWTravelClub in my native language so that I can easily understand the package offered.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.81.1">US_019</span></code><span class="koboSpan" id="kobo.82.1">: As a user, I want to access WWTravelClub in the Chrome, Firefox, and Edge web browsers so that I can use the web browser of my preference.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.83.1">US_020</span></code><span class="koboSpan" id="kobo.84.1">: As a user, I want to know that my credit card information is stored securely, so I can buy packages safely.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.85.1">US_021</span></code><span class="koboSpan" id="kobo.86.1">: As a user, I want to get a recommendation of a good place to visit according to other people from my city, so I can find out about new places that fit my style.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.87.1">Notice that while </span><a id="_idIndexMarker1550"/><span class="koboSpan" id="kobo.88.1">writing the stories, information related to non-functional requirements such as security, environment, performance, and scalability can be included.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.89.1">However, some system requirements may be omitted when you write user stories and need to be included in the software specification. </span><span class="koboSpan" id="kobo.89.2">These requirements can be related to legal aspects, hardware, and software prerequisites, or even points of attention for the correct system delivery. </span><span class="koboSpan" id="kobo.89.3">We discussed them in </span><em class="italic"><span class="koboSpan" id="kobo.90.1">Chapter 2, Non-Functional Requirements</span></em><span class="koboSpan" id="kobo.91.1">. </span><span class="koboSpan" id="kobo.91.2">So non-functional requirements need to be mapped and listed, as well as the user stories. </span><span class="koboSpan" id="kobo.91.3">The WWTravelClub system requirements are presented in the following list. </span><span class="koboSpan" id="kobo.91.4">Note that requirements are written in the future tense because the system does not exist yet:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.92.1">SR_001</span></code><span class="koboSpan" id="kobo.93.1">: The system shall use cloud computing components to deliver the scalability required.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.94.1">SR_002</span></code><span class="koboSpan" id="kobo.95.1">: The system shall</span><a id="_idIndexMarker1551"/><span class="koboSpan" id="kobo.96.1"> respect </span><strong class="keyWord"><span class="koboSpan" id="kobo.97.1">General Data Protection Regulation</span></strong><span class="koboSpan" id="kobo.98.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.99.1">GDPR</span></strong><span class="koboSpan" id="kobo.100.1">) requirements.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.101.1">SR_003</span></code><span class="koboSpan" id="kobo.102.1">: Any web page of this system shall respond within at least 2 seconds of 1,000 users accessing it concurrently.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.103.1">The idea of having this list of user stories and system requirements is to help you understand how complex the development of a platform might be if you think about it from an architectural perspective.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.104.1">Now that we have the list of user stories for the platform, it is time to start selecting the .NET project</span><a id="_idIndexMarker1552"/><span class="koboSpan" id="kobo.105.1"> types that will be used at WWTravelClub. </span><span class="koboSpan" id="kobo.105.2">Let’s check them in the next topic.</span></p>
<h1 class="heading-1" id="_idParaDest-436"><span class="koboSpan" id="kobo.106.1">Main types of .NET projects used at WWTravelClub</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.107.1">The development of this book’s use case will be based on various kinds of .NET Core Visual Studio projects. </span><span class="koboSpan" id="kobo.107.2">This </span><a id="_idIndexMarker1553"/><span class="koboSpan" id="kobo.108.1">section describes all of them. </span><span class="koboSpan" id="kobo.108.2">Let us select </span><strong class="keyWord"><span class="koboSpan" id="kobo.109.1">New project</span></strong><span class="koboSpan" id="kobo.110.1"> in the Visual Studio </span><strong class="keyWord"><span class="koboSpan" id="kobo.111.1">File</span></strong><span class="koboSpan" id="kobo.112.1"> menu.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.113.1">For instance, you can filter </span><strong class="keyWord"><span class="koboSpan" id="kobo.114.1">.NET Core </span></strong><span class="koboSpan" id="kobo.115.1">project types by typing them into the search engine as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.116.1"><img alt="" role="presentation" src="../Images/B19820_21_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.117.1">Figure 21.1: Searching types of .NET Core projects in Visual Studio</span></p>
<p class="normal"><span class="koboSpan" id="kobo.118.1">There, you will find common C# projects (console, a class library, Windows Forms, and WPF), and various types of test projects, each based on a different test framework: xUnit, NUnit, and MSTest. </span><span class="koboSpan" id="kobo.118.2">Choosing among the various testing frameworks is just a matter of preference since they all offer comparable features. </span><span class="koboSpan" id="kobo.118.3">Adding tests to each piece of software that composes a solution is a common practice and allows the software to be modified frequently without jeopardizing its reliability.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.119.1">You may also want to define your class library projects under </span><strong class="keyWord"><span class="koboSpan" id="kobo.120.1">.NET Standard</span></strong><span class="koboSpan" id="kobo.121.1">, which was discussed in </span><em class="italic"><span class="koboSpan" id="kobo.122.1">Chapter 5</span></em><span class="koboSpan" id="kobo.123.1">,</span><em class="italic"><span class="koboSpan" id="kobo.124.1"> Implementing Code Reusability in C# 12</span></em><span class="koboSpan" id="kobo.125.1">. </span><span class="koboSpan" id="kobo.125.2">These class libraries are based on standards that make</span><a id="_idIndexMarker1554"/><span class="koboSpan" id="kobo.126.1"> them compatible with several .NET versions. </span><span class="koboSpan" id="kobo.126.2">For instance, libraries based on 2.0 standards are compatible with all .NET Core versions greater than or equal to 2.0, with all .NET versions greater than 5, and with all .NET Framework versions greater than 4.6. </span><span class="koboSpan" id="kobo.126.3">This compatibility advantage comes at the price of having fewer available features.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.127.1">Besides filtering </span><strong class="keyWord"><span class="koboSpan" id="kobo.128.1">project types</span></strong><span class="koboSpan" id="kobo.129.1"> to the </span><strong class="keyWord"><span class="koboSpan" id="kobo.130.1">cloud</span></strong><span class="koboSpan" id="kobo.131.1">, we have several more project types. </span><span class="koboSpan" id="kobo.131.2">Some of them will enable us to define microservices. </span><span class="koboSpan" id="kobo.131.3">Microservice-based architectures allow an application to be split into several independent microservices. </span><span class="koboSpan" id="kobo.131.4">Several instances of the same microservice can be created and distributed across several machines to fine-tune the performance of each application part. </span><span class="koboSpan" id="kobo.131.5">If you want to learn about microservices, we have talked about them in the following chapters:</span></p>
<ul>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.132.1">Chapter 11</span></em><span class="koboSpan" id="kobo.133.1">,</span><em class="italic"><span class="koboSpan" id="kobo.134.1"> Applying a Microservice Architecture to Your Enterprise Application</span></em></li>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.135.1">Chapter 14</span></em><span class="koboSpan" id="kobo.136.1">, </span><em class="italic"><span class="koboSpan" id="kobo.137.1">Implementing Microservices with .NET</span></em></li>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.138.1">Chapter 20</span></em><span class="koboSpan" id="kobo.139.1">, </span><em class="italic"><span class="koboSpan" id="kobo.140.1">Kubernetes</span></em></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.141.1">In </span><em class="italic"><span class="koboSpan" id="kobo.142.1">Chapter 2</span></em><span class="koboSpan" id="kobo.143.1">, </span><em class="italic"><span class="koboSpan" id="kobo.144.1">Non-Functional Requirements</span></em><span class="koboSpan" id="kobo.145.1">, we described an ASP.NET Core application project in the subsection </span><em class="italic"><span class="koboSpan" id="kobo.146.1">Creating a scalable web app with .NET 8</span></em><span class="koboSpan" id="kobo.147.1">. </span><span class="koboSpan" id="kobo.147.2">There, we defined an ASP.NET Core application, but Visual Studio also contains project templates for projects based on RESTful APIs and the most important single-page application frameworks, such as Angular, React, Vue.js, and the Blazor framework based on WebAssembly, which was discussed in </span><em class="italic"><span class="koboSpan" id="kobo.148.1">Chapter 19</span></em><span class="koboSpan" id="kobo.149.1">,</span><em class="italic"><span class="koboSpan" id="kobo.150.1"> Client Frameworks: Blazor</span></em><span class="koboSpan" id="kobo.151.1">. </span><span class="koboSpan" id="kobo.151.2">Some of them are available with the standard Visual Studio installation, while others require the installation of an SPA package, called </span><strong class="keyWord"><span class="koboSpan" id="kobo.152.1">ASP.NET and web development</span></strong><span class="koboSpan" id="kobo.153.1"> workload.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.154.1">To finish, testing projects were discussed in detail in </span><em class="italic"><span class="koboSpan" id="kobo.155.1">Chapter 9</span></em><span class="koboSpan" id="kobo.156.1">,</span><em class="italic"><span class="koboSpan" id="kobo.157.1"> Testing Your Enterprise Application</span></em><span class="koboSpan" id="kobo.158.1">. </span><span class="koboSpan" id="kobo.158.2">We suggest you, as a software architect, try all the templates available at Visual Studio by creating</span><a id="_idIndexMarker1555"/><span class="koboSpan" id="kobo.159.1"> proofs of concept that may help you define the best project types for your solution.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.160.1">Now that we have checked these different project types, let’s have a look at Azure DevOps and how it can be helpful in managing WWTravelClub is requirements.</span></p>
<h1 class="heading-1" id="_idParaDest-437"><span class="koboSpan" id="kobo.161.1">Managing WWTravelClub’s requirements using Azure DevOps</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.162.1">As discussed in </span><em class="italic"><span class="koboSpan" id="kobo.163.1">Chapter 3, Managing Requirements</span></em><span class="koboSpan" id="kobo.164.1">, an important step for a software development project is where and </span><a id="_idIndexMarker1556"/><span class="koboSpan" id="kobo.165.1">how the team will organize the user stories mapped</span><a id="_idIndexMarker1557"/><span class="koboSpan" id="kobo.166.1"> from the user needs. </span><span class="koboSpan" id="kobo.166.2">There, as described in the </span><em class="italic"><span class="koboSpan" id="kobo.167.1">Managing system requirements in Azure DevOps</span></em><span class="koboSpan" id="kobo.168.1"> section, Azure DevOps enables you to document system requirements using work items, which are mainly tasks or actions that need to be completed to deliver a product or service.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.169.1">It is also important to remember that the work items available depend on the </span><em class="italic"><span class="koboSpan" id="kobo.170.1">work item process</span></em><span class="koboSpan" id="kobo.171.1"> you select while creating the Azure DevOps project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.172.1">Considering the scenario described for WWTravelClub, we decided to use the Agile process and have defined three Epic work items as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.173.1"><img alt="" role="presentation" src="../Images/B19820_21_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.174.1">Figure 21.2: User case Epics</span></p>
<p class="normal"><span class="koboSpan" id="kobo.175.1">The creation of these work items is quite simple:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.176.1">Inside each work item, we</span><a id="_idIndexMarker1558"/><span class="koboSpan" id="kobo.177.1"> link the different types of work items, as you can see in </span><em class="italic"><span class="koboSpan" id="kobo.178.1">Figure 21.3</span></em><span class="koboSpan" id="kobo.179.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.180.1">It is important to </span><a id="_idIndexMarker1559"/><span class="koboSpan" id="kobo.181.1">determine that the connections between work items are useful during software development. </span><span class="koboSpan" id="kobo.181.2">Hence, as a software architect, you must provide this knowledge to your team, and, more than that, you must incentivize them to make these connections:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.182.1"><img alt="" role="presentation" src="../Images/B19820_21_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.183.1">Figure 21.3: Defining a Feature link to the Epic selected</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.184.1">As soon as you </span><a id="_idIndexMarker1560"/><span class="koboSpan" id="kobo.185.1">create a </span><strong class="screenText"><span class="koboSpan" id="kobo.186.1">Feature</span></strong><span class="koboSpan" id="kobo.187.1"> work item, you will be able to connect it to several</span><a id="_idIndexMarker1561"/><span class="koboSpan" id="kobo.188.1"> User Story work items that detail its specifications. </span><span class="koboSpan" id="kobo.188.2">The following screenshot shows the details:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.189.1"><img alt="" role="presentation" src="../Images/B19820_21_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.190.1">Figure 21.4: Product Backlog work item</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.191.1">After that, Task and Test Case work items can be created for each User Story work item. </span><span class="koboSpan" id="kobo.191.2">The </span><a id="_idIndexMarker1562"/><span class="koboSpan" id="kobo.192.1">user interface provided by Azure</span><a id="_idIndexMarker1563"/><span class="koboSpan" id="kobo.193.1"> DevOps is efficacious because it enables you to track the chain of functionalities and the relationships between them.</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.194.1"><img alt="" role="presentation" src="../Images/B19820_21_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.195.1">Figure 21.5: Board view</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.196.1">Considering we are using Scrum as the basis for the Agile process, as soon as you complete the input for the User Story and Task work items, you will be able to plan the project sprints together with your team. </span><span class="koboSpan" id="kobo.196.2">The plan view enables you to drag and drop User Story work items to each planned sprint/iteration:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.197.1"><img alt="" role="presentation" src="../Images/B19820_21_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.198.1">Figure 21.6: Backlogs view</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="6"><span class="koboSpan" id="kobo.199.1">By clicking on a</span><a id="_idIndexMarker1564"/><span class="koboSpan" id="kobo.200.1"> specific sprint on the right, you will see just the work items assigned to that </span><a id="_idIndexMarker1565"/><span class="koboSpan" id="kobo.201.1">sprint. </span><span class="koboSpan" id="kobo.201.2">Each sprint page is quite like the backlog page but contains more tabs, where you can define </span><strong class="screenText"><span class="koboSpan" id="kobo.202.1">Sprint Period</span></strong><span class="koboSpan" id="kobo.203.1"> and </span><strong class="screenText"><span class="koboSpan" id="kobo.204.1">Team Capacity</span></strong><span class="koboSpan" id="kobo.205.1">, for instance.</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.206.1"><img alt="Interface gráfica do usuário, Aplicativo  Descrição gerada automaticamente" src="../Images/B19820_21_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.207.1">Figure 21.7: Planning view</span></p>
<p class="normal"><span class="koboSpan" id="kobo.208.1">Also useful is the </span><strong class="screenText"><span class="koboSpan" id="kobo.209.1">Sprints</span></strong><span class="koboSpan" id="kobo.210.1"> menu on the left, which enables each user to jump immediately to the current sprints of all the projects they are engaged in.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.211.1">This is how these work items are created. </span><span class="koboSpan" id="kobo.211.2">Once you understand this mechanism, you will be able to create and plan any software project. </span><span class="koboSpan" id="kobo.211.3">It is worth mentioning that the tool itself will not solve problems related to team management. </span><span class="koboSpan" id="kobo.211.4">However, the tool is a great way to incentivize the team to</span><a id="_idIndexMarker1566"/><span class="koboSpan" id="kobo.212.1"> update the project status, so you can maintain a clear perspective of how</span><a id="_idIndexMarker1567"/><span class="koboSpan" id="kobo.213.1"> the project is evolving.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.214.1">Now that we have defined how we will manage WWTravelClub requirements, it is time to start thinking about the code standard that will be followed by the developers. </span><span class="koboSpan" id="kobo.214.2">Let’s check this out in the next section.</span></p>
<h1 class="heading-1" id="_idParaDest-438"><span class="koboSpan" id="kobo.215.1">Code standard for WWTravelClub – Dos and don’ts when writing code</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.216.1">In </span><em class="italic"><span class="koboSpan" id="kobo.217.1">Chapter 4, Best Practices in Coding C# 12</span></em><span class="koboSpan" id="kobo.218.1">, we learned that, as a software architect, you must define a code standard that matches the needs of the company you are working for.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.219.1">In the sample project of this</span><a id="_idIndexMarker1568"/><span class="koboSpan" id="kobo.220.1"> book, this is no different. </span><span class="koboSpan" id="kobo.220.2">The way we decided to present the standard for it is by describing a list of dos and don’ts. </span><span class="koboSpan" id="kobo.220.3">We have followed this list while writing the samples we produced. </span><span class="koboSpan" id="kobo.220.4">It is worth mentioning that the list is a good way to start your standard and, as a software architect, you should discuss this list with the developers you have in the team so that you can develop it in a practical and good manner.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.221.1">It is also important to remember that, in the </span><em class="italic"><span class="koboSpan" id="kobo.222.1">Understanding and applying tools that can evaluate C# code</span></em><span class="koboSpan" id="kobo.223.1"> section of </span><em class="italic"><span class="koboSpan" id="kobo.224.1">Chapter 4, Best Practices in Coding C#12</span></em><span class="koboSpan" id="kobo.225.1">, we have discussed some good tools that can help you define a </span><em class="italic"><span class="koboSpan" id="kobo.226.1">coding style </span></em><span class="koboSpan" id="kobo.227.1">for your team</span><em class="italic"><span class="koboSpan" id="kobo.228.1">.</span></em></p>
<p class="normal"><span class="koboSpan" id="kobo.229.1">In addition, the statements below are designed to clarify the communication between team members and improve the performance and maintenance of the software you are developing.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.230.1">You may consider the list below a waste of space in the book since we have great C# community coding standards without the need to enforce a standard. </span><span class="koboSpan" id="kobo.230.2">However, how can you guarantee maintainability without it? </span><span class="koboSpan" id="kobo.230.3">If defining coding standards was not necessary, we wouldn’t have </span><a id="_idIndexMarker1569"/><span class="koboSpan" id="kobo.231.1">so many projects with maintenance issues. </span><span class="koboSpan" id="kobo.231.2">So, let’s check the list of dos and don’ts defined for the WWTravelClub project:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.232.1">DO write your code in English.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.233.1">DO use PascalCasing for all public member, type, and namespace names consisting of multiple words.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.234.1">DO use camelCasing for parameter names.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.235.1">DO write classes, methods, and variables with understandable names.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.236.1">DO comment public classes, methods, and properties.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.237.1">DO use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.238.1">using</span></code><span class="koboSpan" id="kobo.239.1"> statement whenever possible.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.240.1">DO use </span><code class="inlineCode"><span class="koboSpan" id="kobo.241.1">async</span></code><span class="koboSpan" id="kobo.242.1"> implementation whenever possible.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.243.1">DON’T write empty </span><code class="inlineCode"><span class="koboSpan" id="kobo.244.1">try-catch</span></code><span class="koboSpan" id="kobo.245.1"> statements.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.246.1">DON’T write methods with a cyclomatic complexity score of more than 10.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.247.1">DON’T use </span><code class="inlineCode"><span class="koboSpan" id="kobo.248.1">break</span></code><span class="koboSpan" id="kobo.249.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.250.1">continue</span></code><span class="koboSpan" id="kobo.251.1"> inside </span><code class="inlineCode"><span class="koboSpan" id="kobo.252.1">for/while/do-while/foreach</span></code><span class="koboSpan" id="kobo.253.1"> statements.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.254.1">These dos and don’ts are simple to follow and, better than that, will yield great results for the code your team produces. </span><span class="koboSpan" id="kobo.254.2">It is worth mentioning that these DOs and DON’Ts are a guide, not a set of hard-and-fast rules to be followed by every team. </span><span class="koboSpan" id="kobo.254.3">They can be adapted as needed for the specific needs of a team before they are sent out to the team members. </span><span class="koboSpan" id="kobo.254.4">As a software architect, it is essential that all team members follow the same DOs and DON’Ts.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.255.1">Considering we now have a coding standard defined, let’s learn how to apply SonarCloud as a tool for helping us in code analysis.</span></p>
<h1 class="heading-1" id="_idParaDest-439"><span class="koboSpan" id="kobo.256.1">Applying SonarCloud to WWTravelClub APIs</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.257.1">Now that we have already</span><a id="_idIndexMarker1570"/><span class="koboSpan" id="kobo.258.1"> created the WWTravelClub repository, we can Improve the code quality, as discussed in </span><em class="italic"><span class="koboSpan" id="kobo.259.1">Chapter 4, Best Practices in Coding C# 12</span></em><span class="koboSpan" id="kobo.260.1">. </span><span class="koboSpan" id="kobo.260.2">As we</span><a id="_idIndexMarker1571"/><span class="koboSpan" id="kobo.261.1"> saw in that chapter, Azure DevOps enables continuous integration, and this can be useful. </span><span class="koboSpan" id="kobo.261.2">In this section, we will discuss more reasons why the DevOps concept and the Azure DevOps platform are so useful.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.262.1">For now, the only thing we would like to introduce is the possibility of analyzing code after it is committed by the developers but before it has been published. </span><span class="koboSpan" id="kobo.262.2">Nowadays, in a SaaS world for application life cycle tools, this is only possible because of some of the SaaS code analysis platforms that we have. </span><span class="koboSpan" id="kobo.262.3">This use case will use SonarCloud.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.263.1">SonarCloud is the SaaS version provided by Sonar. </span><span class="koboSpan" id="kobo.263.2">Also, it might be worth noting that SonarCloud is exceptionally easy to self-host; this way, sensitive security information may be kept within an enterprise. </span><span class="koboSpan" id="kobo.263.3">It is free for open-source code and can analyze code stored in GitHub, Bitbucket, and</span><a id="_idIndexMarker1572"/><span class="koboSpan" id="kobo.264.1"> Azure DevOps. </span><span class="koboSpan" id="kobo.264.2">The user needs a registration for these platforms. </span><span class="koboSpan" id="kobo.264.3">As soon as you log in, assuming your code is stored in </span><a id="_idIndexMarker1573"/><span class="koboSpan" id="kobo.265.1">Azure DevOps, you can follow the steps described in the following article to create a connection between your </span><a id="_idIndexMarker1574"/><span class="koboSpan" id="kobo.266.1">Azure DevOps and SonarCloud: </span><a href="https://docs.sonarcloud.io/"><span class="url"><span class="koboSpan" id="kobo.267.1">https://docs.sonarcloud.io/</span></span></a><span class="koboSpan" id="kobo.268.1">.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.269.1">Sonar also provides a self-managed edition that can be useful for scenarios where SonarCloud cannot be used. </span><span class="koboSpan" id="kobo.269.2">Please check </span><a href="https://www.sonarsource.com/"><span class="url"><span class="koboSpan" id="kobo.270.1">https://www.sonarsource.com/</span></span></a><span class="koboSpan" id="kobo.271.1"> for more details.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.272.1">After setting up the connection between your project in Azure DevOps and SonarCloud, you will have a build pipeline like the one that follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.273.1"><img alt="" role="presentation" src="../Images/B19820_21_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.274.1">Figure 21.8: SonarCloud configuration in the Azure build pipeline</span></p>
<p class="normal"><span class="koboSpan" id="kobo.275.1">It is worth mentioning that C# projects do not have a GUID number, and this is required by SonarCloud. </span><span class="koboSpan" id="kobo.275.2">You can easily </span><a id="_idIndexMarker1575"/><span class="koboSpan" id="kobo.276.1">generate one using this link: </span><a href="https://www.guidgenerator.com/"><span class="url"><span class="koboSpan" id="kobo.277.1">https://www.guidgenerator.com/</span></span></a><span class="koboSpan" id="kobo.278.1">, or using the </span><strong class="keyWord"><span class="koboSpan" id="kobo.279.1">Create GUID</span></strong><span class="koboSpan" id="kobo.280.1"> tool in Visual </span><a id="_idIndexMarker1576"/><span class="koboSpan" id="kobo.281.1">Studio (</span><strong class="screenText"><span class="koboSpan" id="kobo.282.1">Tools</span></strong><span class="koboSpan" id="kobo.283.1"> -&gt; </span><strong class="screenText"><span class="koboSpan" id="kobo.284.1">Create GUID</span></strong><span class="koboSpan" id="kobo.285.1">). </span><span class="koboSpan" id="kobo.285.2">The GUID will need to be placed as in the following screenshot:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.286.1"><img alt="" role="presentation" src="../Images/B19820_21_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.287.1">Figure 21.9: SonarCloud project GUID</span></p>
<p class="normal"><span class="koboSpan" id="kobo.288.1">As soon as you finish the build, the result of the code analysis will be presented in SonarCloud, as can be seen in the following screenshot. </span><span class="koboSpan" id="kobo.288.2">If you want to navigate to this project, you can visit </span><a href="https://sonarcloud.io/summary/overall?id=gabrielbaptista_wwtravelclub-4th"><span class="url"><span class="koboSpan" id="kobo.289.1">https://sonarcloud.io/summary/overall?id=gabrielbaptista_wwtravelclub-4th</span></span></a><span class="koboSpan" id="kobo.290.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.291.1"><img alt="Tela de computador com jogo  Descrição gerada automaticamente" src="../Images/B19820_21_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.292.1">Figure 21.10: SonarCloud results</span></p>
<p class="normal"><span class="koboSpan" id="kobo.293.1">Also, by this time, the code analyzed is not yet in the release, so this can be useful for getting the next step of</span><a id="_idIndexMarker1577"/><span class="koboSpan" id="kobo.294.1"> quality before releasing your system. </span><span class="koboSpan" id="kobo.294.2">You can use this approach as a reference for automating code analysis during committal.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.295.1">Considering we have</span><a id="_idIndexMarker1578"/><span class="koboSpan" id="kobo.296.1"> implemented a way to continuously evaluate code quality, it is time to design reusable software. </span><span class="koboSpan" id="kobo.296.2">Let’s look at this in the next section.</span></p>
<h1 class="heading-1" id="_idParaDest-440"><span class="koboSpan" id="kobo.297.1">Reusing code as a fast way to deliver good and safe software</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.298.1">As we checked in </span><em class="italic"><span class="koboSpan" id="kobo.299.1">Chapter 5, Implementing Code Reusability in C# 12</span></em><span class="koboSpan" id="kobo.300.1">, a good approach for accelerating the delivery of good software is creating reusable components. </span><span class="koboSpan" id="kobo.300.2">The final design of the solution for </span><a id="_idIndexMarker1579"/><span class="koboSpan" id="kobo.301.1">evaluating content for WWTravelClub can be checked in the diagram below. </span><span class="koboSpan" id="kobo.301.2">This approach consists of using many topics that were discussed in that chapter. </span><span class="koboSpan" id="kobo.301.3">First, all the code is placed in a .NET 8 class library. </span><span class="koboSpan" id="kobo.301.4">This means that you can add this code to different types of solutions, such as ASP.NET Core web apps and Xamarin apps for the Android and iOS platforms:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.302.1"><img alt="Diagrama  Descrição gerada automaticamente" src="../Images/B19820_21_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.303.1">Figure 21.11: WWTravelClub reuse approach</span></p>
<p class="normal"><span class="koboSpan" id="kobo.304.1">This design makes use</span><a id="_idIndexMarker1580"/><span class="koboSpan" id="kobo.305.1"> of object-oriented principles such as inheritance, so you do not need to write properties and methods more than once that can be used in many classes. </span><span class="koboSpan" id="kobo.305.2">The design also makes use of the polymorphism principle so that you can change the behavior of the code without changing the name of the method.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.306.1">To finish, the design abstracts the idea of the content by introducing generics as a tool that can facilitate the manipulation of similar classes, such as the ones we have in WWTravelClub, to evaluate content regarding cities, comments, destination experts, and travel packages.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.307.1">The big difference between a team that incentivizes code reuse and one that does not is the velocity of delivering good software to end users. </span><span class="koboSpan" id="kobo.307.2">Of course, beginning this approach is not easy, but rest assured that you will get good results after some time working with it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.308.1">Since we have covered the</span><a id="_idIndexMarker1581"/><span class="koboSpan" id="kobo.309.1"> possibilities of code reuse using object-oriented principles, what about organizing the application using domains created by </span><strong class="keyWord"><span class="koboSpan" id="kobo.310.1">domain-driven design</span></strong><span class="koboSpan" id="kobo.311.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.312.1">DDD</span></strong><span class="koboSpan" id="kobo.313.1">)? </span><span class="koboSpan" id="kobo.313.2">We will check it in the next section.</span></p>
<h1 class="heading-1" id="_idParaDest-441"><span class="koboSpan" id="kobo.314.1">Understanding the domains of the WWTravelClub application</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.315.1">In this section we will perform the</span><a id="_idIndexMarker1582"/><span class="koboSpan" id="kobo.316.1"> DDD analysis of the WWTravelClub system, trying to identify all its domains (also called</span><strong class="keyWord"><span class="koboSpan" id="kobo.317.1"> bounded contexts</span></strong><span class="koboSpan" id="kobo.318.1">), that is, the subsystems characterized by different languages</span><a id="_idIndexMarker1583"/><span class="koboSpan" id="kobo.319.1"> used by the experts. </span><span class="koboSpan" id="kobo.319.2">Once identified, each domain might be assigned to a different development team and will give rise to a different microservice.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.320.1">From the requirements listed in the </span><em class="italic"><span class="koboSpan" id="kobo.321.1">Introducing World Wild Travel Club</span></em><span class="koboSpan" id="kobo.322.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.323.1">U</span></em><em class="italic"><span class="koboSpan" id="kobo.324.1">ser needs and system requirements</span></em><span class="koboSpan" id="kobo.325.1"> sections, we know that the WWTravelClub system is composed of the following parts:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.326.1">Information about the available destinations and packages.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.327.1">Reservation/purchase orders subsystem.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.328.1">Communication with the experts/review subsystem.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.329.1">Payment subsystem. </span><span class="koboSpan" id="kobo.329.2">We briefly analyzed the features of this subsystem and its relationship with the reservation purchase subsystem at the beginning of </span><em class="italic"><span class="koboSpan" id="kobo.330.1">Chapter 7</span></em><span class="koboSpan" id="kobo.331.1">, in the</span><em class="italic"><span class="koboSpan" id="kobo.332.1"> Understanding DDD</span></em><span class="koboSpan" id="kobo.333.1"> section.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.334.1">User accounts subsystem.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.335.1">Statistics reporting subsystem.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.336.1">Do the preceding subsystems represent different bounded contexts? </span><span class="koboSpan" id="kobo.336.2">Can some subsystems be split into different bounded contexts? </span><span class="koboSpan" id="kobo.336.3">The answers to these questions are given by the languages that are spoken in each subsystem:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.337.1">The language that’s spoken in subsystem 1 is the language of </span><strong class="keyWord"><span class="koboSpan" id="kobo.338.1">travel agencies</span></strong><span class="koboSpan" id="kobo.339.1">. </span><span class="koboSpan" id="kobo.339.2">There is no concept of a customer, just of locations, packages, and their features.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.340.1">The language that’s spoken in subsystem 2 is common to all service purchases, such as the available resources, reservations, and purchase orders. </span><span class="koboSpan" id="kobo.340.2">This is a separate bounded context.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.341.1">The language that’s spoken in subsystem 3 has a lot in common with subsystem 1’s language. </span><span class="koboSpan" id="kobo.341.2">However, there are also typical </span><strong class="keyWord"><span class="koboSpan" id="kobo.342.1">social media</span></strong><span class="koboSpan" id="kobo.343.1"> concepts, such as ratings, chats, post sharing, media sharing, and so on. </span><span class="koboSpan" id="kobo.343.2">This subsystem can be split into two parts: a social media subsystem that has a new Bounded Context and an available information subsystem that is part of the Bounded Context of subsystem 1.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.344.1">As we pointed out in the </span><em class="italic"><span class="koboSpan" id="kobo.345.1">Understanding DDD</span></em><span class="koboSpan" id="kobo.346.1"> section in </span><em class="italic"><span class="koboSpan" id="kobo.347.1">Chapter 7</span></em><span class="koboSpan" id="kobo.348.1">, in subsystem 4, we speak the language of </span><strong class="keyWord"><span class="koboSpan" id="kobo.349.1">banking</span></strong><span class="koboSpan" id="kobo.350.1">. </span><span class="koboSpan" id="kobo.350.2">This subsystem communicates with the reservation purchase subsystem and executes tasks that are needed to carry out a purchase. </span><span class="koboSpan" id="kobo.350.3">From these observations, we</span><a id="_idIndexMarker1584"/><span class="koboSpan" id="kobo.351.1"> can see that it is a different Bounded Context and has a customer/supplier relationship with the purchase/reservation system.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.352.1">Subsystem 5 is a separate Bounded Context (as in almost all web applications). </span><span class="koboSpan" id="kobo.352.2">It has a relationship with all the bounded contexts that have either the concept of a user or the concept of a customer because the concept of user accounts always maps to these concepts. </span><span class="koboSpan" id="kobo.352.3">You must be wondering how. </span><span class="koboSpan" id="kobo.352.4">Well, it’s quite simple—the currently logged-in user is assumed to be the social media user of the social media bounded context, the customer of the reservation/purchase bounded context, and the payer of the payment Bounded Context.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.353.1">The query-only subsystem (that is, 6) speaks the language of analytics and statistics and differs a lot from the languages that are spoken in the other subsystems. </span><span class="koboSpan" id="kobo.353.2">However, it has a connection with almost all the bounded contexts since it takes all its input from them. </span><span class="koboSpan" id="kobo.353.3">The preceding constraints force us to adopt CQRS in its strong form, thereby considering it a query-only separated Bounded Context.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.354.1">In conclusion, each of the listed subsystems defines a different Bounded Context, but part of the communication with the experts/review subsystem must be included in the information about the available destinations, and the package’s Bounded Context.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.355.1">As the analysis continues and a prototype is implemented, some bounded contexts may split and some others may be added, but it is fundamental to immediately start modeling the system and to immediately start analyzing the relationships among the bounded contexts with the partial information we have since this will drive further investigations and will help us define the communication protocols and ubiquitous languages that are</span><a id="_idIndexMarker1585"/><span class="koboSpan" id="kobo.356.1"> needed so that we can interact with the domain experts.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.357.1">The following is a basic first sketch of the domain map:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.358.1"><img alt="" role="presentation" src="../Images/B19820_21_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.359.1">Figure 21.12: WWTravelClub domain map. </span><span class="koboSpan" id="kobo.359.2">Thin black arrows represent data exchanged between bounded contexts, while thick blue arrows represent the relationships between bounded contexts (conformist, customer/supplier, and so on)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.360.1">For simplicity, we’ve omitted the </span><strong class="keyWord"><span class="koboSpan" id="kobo.361.1">Statistics reporting</span></strong><span class="koboSpan" id="kobo.362.1"> bounded context. </span><span class="koboSpan" id="kobo.362.2">We say just that it collects statistics on the daily purchases of each package.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.363.1">Here, we’re assuming that the </span><strong class="keyWord"><span class="koboSpan" id="kobo.364.1">User accounts</span></strong><span class="koboSpan" id="kobo.365.1"> and </span><strong class="keyWord"><span class="koboSpan" id="kobo.366.1">Social</span></strong><span class="koboSpan" id="kobo.367.1"> bounded contexts have a </span><strong class="keyWord"><span class="koboSpan" id="kobo.368.1">conformist</span></strong><span class="koboSpan" id="kobo.369.1"> relationship with all the other counded contexts that communicate with them because they are implemented with already existing software, so all the other components must adapt to them.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.370.1">As we mentioned previously, the relationship between </span><strong class="keyWord"><span class="koboSpan" id="kobo.371.1">Reservation</span></strong><span class="koboSpan" id="kobo.372.1"> and </span><strong class="keyWord"><span class="koboSpan" id="kobo.373.1">Payments</span></strong><span class="koboSpan" id="kobo.374.1"> is </span><strong class="keyWord"><span class="koboSpan" id="kobo.375.1">customer/supplier</span></strong><span class="koboSpan" id="kobo.376.1"> because </span><strong class="keyWord"><span class="koboSpan" id="kobo.377.1">Payments</span></strong><span class="koboSpan" id="kobo.378.1"> provides services that are used to execute the tasks of </span><strong class="keyWord"><span class="koboSpan" id="kobo.379.1">Reservation</span></strong><span class="koboSpan" id="kobo.380.1">. </span><span class="koboSpan" id="kobo.380.2">All the other relationships are classified as </span><strong class="keyWord"><span class="koboSpan" id="kobo.381.1">partners</span></strong><span class="koboSpan" id="kobo.382.1">. </span><span class="koboSpan" id="kobo.382.2">The various concepts of customer/user that most bounded contexts have are coordinated by the </span><strong class="keyWord"><span class="koboSpan" id="kobo.383.1">User accounts</span></strong> <strong class="keyWord"><span class="koboSpan" id="kobo.384.1">Authorization token</span></strong><span class="koboSpan" id="kobo.385.1"> arrow, which indirectly takes care of mapping these concepts between</span><a id="_idIndexMarker1586"/><span class="koboSpan" id="kobo.386.1"> all the counded contexts.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.387.1">The </span><strong class="keyWord"><span class="koboSpan" id="kobo.388.1">Packages/locations</span></strong><span class="koboSpan" id="kobo.389.1"> subsystem communicates the following information to </span><strong class="keyWord"><span class="koboSpan" id="kobo.390.1">Reservation</span></strong><span class="koboSpan" id="kobo.391.1">:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.392.1">Chosen package info</span></strong><span class="koboSpan" id="kobo.393.1">, which contains the package information that’s needed to carry out a reservation/purchase</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.394.1">Price changes</span></strong><span class="koboSpan" id="kobo.395.1">, which takes care of informing pending purchase orders of possible price changes</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.396.1">Social interactions are started from an existing review provided by users (the </span><strong class="keyWord"><span class="koboSpan" id="kobo.397.1">Reviews</span></strong><span class="koboSpan" id="kobo.398.1"> arrow between </span><strong class="keyWord"><span class="koboSpan" id="kobo.399.1">Packages/locations</span></strong><span class="koboSpan" id="kobo.400.1"> and </span><strong class="keyWord"><span class="koboSpan" id="kobo.401.1">Social</span></strong><span class="koboSpan" id="kobo.402.1">) and are supported by </span><strong class="keyWord"><span class="koboSpan" id="kobo.403.1">Location/review info</span></strong><span class="koboSpan" id="kobo.404.1"> communications from </span><strong class="keyWord"><span class="koboSpan" id="kobo.405.1">Packages/locations</span></strong><span class="koboSpan" id="kobo.406.1"> to </span><strong class="keyWord"><span class="koboSpan" id="kobo.407.1">Social</span></strong><span class="koboSpan" id="kobo.408.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.409.1">Finally, </span><strong class="keyWord"><span class="koboSpan" id="kobo.410.1">Reservation</span></strong><span class="koboSpan" id="kobo.411.1"> communicates purchase codes, descriptions, and prices to </span><strong class="keyWord"><span class="koboSpan" id="kobo.412.1">Payments</span></strong><span class="koboSpan" id="kobo.413.1"> through the </span><strong class="keyWord"><span class="koboSpan" id="kobo.414.1">Prices/codes/descriptions</span></strong><span class="koboSpan" id="kobo.415.1"> arrow.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.416.1">Having identified our application’s bounded contexts, we are in a position to organize the application DevOps cycle.</span></p>
<h1 class="heading-1" id="_idParaDest-442"><span class="koboSpan" id="kobo.417.1">The WWTravelClub DevOps approach</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.418.1">During </span><em class="italic"><span class="koboSpan" id="kobo.419.1">Chapter 8, Understanding DevOps Principles and CI/CD</span></em><span class="koboSpan" id="kobo.420.1">, screenshots from the WWTravelClub project </span><a id="_idIndexMarker1587"/><span class="koboSpan" id="kobo.421.1">showed the steps needed to implement a good DevOps cycle. </span><span class="koboSpan" id="kobo.421.2">The WWTravelClub team has decided to use Azure DevOps because they understand that the tool is essential for getting the best DevOps experience for the whole cycle. </span><span class="koboSpan" id="kobo.421.3">In fact, it appears the most complete of the tools offered by GitHub, since it covers the whole CI/CD cycle from requirements collection to deployment in staging and production. </span><span class="koboSpan" id="kobo.421.4">Moreover, all team members already know it very well.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.422.1">The requirements were written using user stories, which can be found in the </span><strong class="keyWord"><span class="koboSpan" id="kobo.423.1">Work items</span></strong><span class="koboSpan" id="kobo.424.1"> section of Azure DevOps. </span><span class="koboSpan" id="kobo.424.2">The code is placed in the repository of the Azure DevOps project. </span><span class="koboSpan" id="kobo.424.3">Both concepts were explained in </span><em class="italic"><span class="koboSpan" id="kobo.425.1">Chapter 3</span></em><span class="koboSpan" id="kobo.426.1">, </span><em class="italic"><span class="koboSpan" id="kobo.427.1">Managing Requirements</span></em><span class="koboSpan" id="kobo.428.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.429.1">The management life cycle used for getting things done is Scrum, presented in </span><em class="italic"><span class="koboSpan" id="kobo.430.1">Chapter 1</span></em><span class="koboSpan" id="kobo.431.1">, </span><em class="italic"><span class="koboSpan" id="kobo.432.1">Understanding the Importance of Software Architecture</span></em><span class="koboSpan" id="kobo.433.1">. </span><span class="koboSpan" id="kobo.433.2">This approach divides the implementation into sprints, which forces value to be delivered by the end of each cycle. </span><span class="koboSpan" id="kobo.433.3">Using the CI facilities we learned in this chapter, code will be compiled each time the team merges new code into the master branch of the repository.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.434.1">Once the code is compiled and tested, the first stage of the deployment is done. </span><span class="koboSpan" id="kobo.434.2">The first stage is normally named development/test because you enable it for internal tests. </span><span class="koboSpan" id="kobo.434.3">Both Application Insights and Test and Feedback can be used to get the first feedback on the new release.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.435.1">If the tests and the </span><a id="_idIndexMarker1588"/><span class="koboSpan" id="kobo.436.1">feedback of the new release pass, it is time to go to the second stage, quality assurance. </span><span class="koboSpan" id="kobo.436.2">Application Insights and Test and Feedback can be used again, but now in a more stable environment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.437.1">The cycle ends with the authorization to deploy in the production stage. </span><span class="koboSpan" id="kobo.437.2">This certainly is a tough decision, but DevOps indicates that you must do it continuously so you can get better feedback from customers. </span><span class="koboSpan" id="kobo.437.3">Application Insights keeps being a useful tool since you can monitor the evolution of the new release in production, even comparing it to past releases.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.438.1">The WWTravelClub project approach described here can be used in many other modern application development life cycles. </span><span class="koboSpan" id="kobo.438.2">As a software architect, you must oversee the process. </span><span class="koboSpan" id="kobo.438.3">The tools are ready to go, and it depends on you to make things right!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.439.1">For this reason, even considering WWTravelClub as a hypothetical scenario, some concerns were considered while building it:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.440.1">CI is enabled, but a multi-stage scenario is enabled too.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.441.1">Even with a multi-stage scenario, the </span><strong class="keyWord"><span class="koboSpan" id="kobo.442.1">PR</span></strong><span class="koboSpan" id="kobo.443.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.444.1">Pull Request</span></strong><span class="koboSpan" id="kobo.445.1">) is a way to guarantee that only good-quality code will be presented in the first stage.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.446.1">To do a good job in the PR, peer reviews are undertaken.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.447.1">The peer reviews check, for instance, the presence of a feature flag while creating a new feature.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.448.1">The peer reviews check both unit and functional tests developed during the creation of the new feature.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.449.1">The preceding steps are not exclusively for WWTravelClub. </span><span class="koboSpan" id="kobo.449.2">You, as a software architect, will need to define the approach to guarantee a safe CI/CD scenario. </span><span class="koboSpan" id="kobo.449.3">You may use this as a starting point. </span><span class="koboSpan" id="kobo.449.4">It is worth pointing out that both in Azure DevOps and GitHub, we can completely disable pushing on the master branch, thus forcing the usage of PR for merging modifications</span><a id="_idIndexMarker1589"/><span class="koboSpan" id="kobo.450.1"> on the master branch.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.451.1">In the next section, we will start with the actual code, by showing how to choose among various data storage options.</span></p>
<h1 class="heading-1" id="_idParaDest-443"><span class="koboSpan" id="kobo.452.1">How to choose your data storage in the cloud</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.453.1">In </span><em class="italic"><span class="koboSpan" id="kobo.454.1">Chapter 12</span></em><span class="koboSpan" id="kobo.455.1">, </span><em class="italic"><span class="koboSpan" id="kobo.456.1">Choosing Your Data Storage in the Cloud,</span></em><span class="koboSpan" id="kobo.457.1"> we learned how to use NoSQL. </span><span class="koboSpan" id="kobo.457.2">Now we must decide whether NoSQL databases are adequate for our book use case WWTravelClub application. </span><span class="koboSpan" id="kobo.457.3">We</span><a id="_idIndexMarker1590"/><span class="koboSpan" id="kobo.458.1"> need to store the following families of data:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.459.1">Information about available destinations and packages</span></strong><span class="koboSpan" id="kobo.460.1">: Relevant operations for these data are reads since packages and destinations do not change very often. </span><span class="koboSpan" id="kobo.460.2">However, they must be accessed as fast as possible from all over the world to ensure a pleasant user experience when users browse the available options. </span><span class="koboSpan" id="kobo.460.3">Therefore, a distributed relational database with geographically distributed replicas is possible but not necessary since packages can be stored inside their destinations in a cheaper NoSQL database.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.461.1">Destination reviews</span></strong><span class="koboSpan" id="kobo.462.1">: In this case, distributed write operations have a non-negligible impact. </span><span class="koboSpan" id="kobo.462.2">Moreover, most writes are additions since reviews are not usually updated. </span><span class="koboSpan" id="kobo.462.3">Additions benefit a lot from sharding and do not cause consistency issues like updates do. </span><span class="koboSpan" id="kobo.462.4">Accordingly, the best option for this data is a NoSQL collection.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.463.1">Reservations</span></strong><span class="koboSpan" id="kobo.464.1">: In this case, consistency errors are not acceptable because they may cause overbooking. </span><span class="koboSpan" id="kobo.464.2">Reads and writes have a comparable impact, but we need reliable transactions and good consistency checks. </span><span class="koboSpan" id="kobo.464.3">Luckily, data can be organized in a multi-tenant database where tenants are destinations since reservation information belonging to different destinations is completely unrelated. </span><span class="koboSpan" id="kobo.464.4">Accordingly, we may use sharded Azure SQL Database instances.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.465.1">In conclusion, the best option for data in the first and second bullet points is Cosmos DB, while the best option for the third point is Azure SQL Server. </span><span class="koboSpan" id="kobo.465.2">Actual applications may require a more detailed analysis of all data operations and their frequencies. </span><span class="koboSpan" id="kobo.465.3">In some cases, it is worth</span><a id="_idIndexMarker1591"/><span class="koboSpan" id="kobo.466.1"> implementing prototypes for various possible options and executing performance tests with typical workloads on all of them.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.467.1">In the remainder of this section, we will migrate the destinations/packages data layer we looked at in </span><em class="italic"><span class="koboSpan" id="kobo.468.1">Chapter 13</span></em><span class="koboSpan" id="kobo.469.1">, </span><em class="italic"><span class="koboSpan" id="kobo.470.1">Interacting with Data in C# – Entity Framework Core</span></em><span class="koboSpan" id="kobo.471.1">, to Cosmos DB.</span></p>
<h2 class="heading-2" id="_idParaDest-444"><span class="koboSpan" id="kobo.472.1">Implementing the destinations/packages database with Cosmos DB</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.473.1">Let’s move on to the database example we built in </span><em class="italic"><span class="koboSpan" id="kobo.474.1">Chapter 13</span></em><span class="koboSpan" id="kobo.475.1">, </span><em class="italic"><span class="koboSpan" id="kobo.476.1">Interacting with Data in C# – Entity Framework Core</span></em><span class="koboSpan" id="kobo.477.1">, and implement</span><a id="_idIndexMarker1592"/><span class="koboSpan" id="kobo.478.1"> this database with Cosmos DB by following these steps:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.479.1">First, we need to make a copy </span><a id="_idIndexMarker1593"/><span class="koboSpan" id="kobo.480.1">of the WWTravelClubDB project and rename its root folder as </span><code class="inlineCode"><span class="koboSpan" id="kobo.481.1">WWTravelClubDBCosmo</span></code><span class="koboSpan" id="kobo.482.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.483.1">Open the project and delete the </span><code class="inlineCode"><span class="koboSpan" id="kobo.484.1">Migrations</span></code><span class="koboSpan" id="kobo.485.1"> folder since migrations are not required anymore.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.486.1">We need to replace the SQL Server Entity Framework provider with the Cosmos DB provider. </span><span class="koboSpan" id="kobo.486.2">To do this, go to </span><strong class="keyWord"><span class="koboSpan" id="kobo.487.1">Manage NuGet Packages</span></strong><span class="koboSpan" id="kobo.488.1"> and uninstall the </span><code class="inlineCode"><span class="koboSpan" id="kobo.489.1">Microsoft.EntityFrameworkCore.SqlServer</span></code><span class="koboSpan" id="kobo.490.1"> NuGet package. </span><span class="koboSpan" id="kobo.490.2">Then, install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.491.1">Microsoft.EntityFrameworkCore.Cosmos</span></code><span class="koboSpan" id="kobo.492.1"> NuGet package.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.493.1">Then, do the following on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.494.1">Destination</span></code><span class="koboSpan" id="kobo.495.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.496.1">Package</span></code><span class="koboSpan" id="kobo.497.1"> entities:</span><ul>
<li class="bulletList"><span class="koboSpan" id="kobo.498.1">Remove all data annotations.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.499.1">Add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.500.1">[Key]</span></code><span class="koboSpan" id="kobo.501.1"> attribute to their </span><code class="inlineCode"><span class="koboSpan" id="kobo.502.1">Id</span></code><span class="koboSpan" id="kobo.503.1"> properties since this is obligatory for Cosmos DB providers.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.504.1">Transform the type of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.505.1">Id</span></code><span class="koboSpan" id="kobo.506.1"> properties of both </span><code class="inlineCode"><span class="koboSpan" id="kobo.507.1">Package</span></code><span class="koboSpan" id="kobo.508.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.509.1">Destination</span></code><span class="koboSpan" id="kobo.510.1"> and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.511.1">PackagesListDTO</span></code><span class="koboSpan" id="kobo.512.1"> classes from </span><code class="inlineCode"><span class="koboSpan" id="kobo.513.1">int</span></code><span class="koboSpan" id="kobo.514.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.515.1">string</span></code><span class="koboSpan" id="kobo.516.1">. </span><span class="koboSpan" id="kobo.516.2">We also need to turn the </span><code class="inlineCode"><span class="koboSpan" id="kobo.517.1">DestinationId</span></code><span class="koboSpan" id="kobo.518.1"> external references in </span><code class="inlineCode"><span class="koboSpan" id="kobo.519.1">Package</span></code><span class="koboSpan" id="kobo.520.1"> and in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.521.1">PackagesListDTO</span></code><span class="koboSpan" id="kobo.522.1"> classes into </span><code class="inlineCode"><span class="koboSpan" id="kobo.523.1">string</span></code><span class="koboSpan" id="kobo.524.1">. </span><span class="koboSpan" id="kobo.524.2">In fact, the best option for keys in distributed databases is a string generated from a GUID, because it is hard to maintain an identity counter when table data is distributed among several servers.</span></li>
</ul>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.525.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.526.1">MainDBContext</span></code><span class="koboSpan" id="kobo.527.1"> file, we need to specify that packages related to a destination must be stored inside the destination document itself. </span><span class="koboSpan" id="kobo.527.2">This can be achieved by replacing the </span><strong class="keyWord"><span class="koboSpan" id="kobo.528.1">Destination-Package</span></strong><span class="koboSpan" id="kobo.529.1"> relation configuration in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.530.1">OnModelCreating</span></code><span class="koboSpan" id="kobo.531.1"> method with the following code:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.532.1">builder.Entity&lt;Destination&gt;()
    .OwnsMany(m =&gt;m.Packages);
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.533.1">Here, we must replace </span><code class="inlineCode"><span class="koboSpan" id="kobo.534.1">HasMany</span></code><span class="koboSpan" id="kobo.535.1"> with </span><code class="inlineCode"><span class="koboSpan" id="kobo.536.1">OwnsMany</span></code><span class="koboSpan" id="kobo.537.1">. </span><span class="koboSpan" id="kobo.537.2">There is no equivalent to </span><code class="inlineCode"><span class="koboSpan" id="kobo.538.1">WithOne</span></code><span class="koboSpan" id="kobo.539.1"> since once an entity is owned, it must have just one owner, and the fact that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.540.1">MyDestination</span></code><span class="koboSpan" id="kobo.541.1"> property contains a pointer to the father entity is evident from its type. </span><span class="koboSpan" id="kobo.541.2">Cosmos </span><a id="_idIndexMarker1594"/><span class="koboSpan" id="kobo.542.1">DB also allows the use of </span><code class="inlineCode"><span class="koboSpan" id="kobo.543.1">HasMany</span></code><span class="koboSpan" id="kobo.544.1">, but in this case, the two entities </span><a id="_idIndexMarker1595"/><span class="koboSpan" id="kobo.545.1">are not nested one in the other. </span><span class="koboSpan" id="kobo.545.2">There is also an </span><code class="inlineCode"><span class="koboSpan" id="kobo.546.1">OwnOne</span></code><span class="koboSpan" id="kobo.547.1"> configuration method for nesting single entities inside other entities.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.548.1">Both </span><code class="inlineCode"><span class="koboSpan" id="kobo.549.1">OwnsMany</span></code><span class="koboSpan" id="kobo.550.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.551.1">OwnsOne</span></code><span class="koboSpan" id="kobo.552.1"> are available for relational databases, but in this case, the difference between </span><code class="inlineCode"><span class="koboSpan" id="kobo.553.1">HasMany</span></code><span class="koboSpan" id="kobo.554.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.555.1">HasOne</span></code><span class="koboSpan" id="kobo.556.1"> is that children entities are automatically included in all queries that return their father entities, with no need to specify an </span><code class="inlineCode"><span class="koboSpan" id="kobo.557.1">Include</span></code><span class="koboSpan" id="kobo.558.1"> LINQ clause. </span><span class="koboSpan" id="kobo.558.2">However, child entities are still stored in separate tables.</span></li>
<li class="numberedList"><code class="inlineCode"><span class="koboSpan" id="kobo.559.1">LibraryDesignTimeDbContextFactory</span></code><span class="koboSpan" id="kobo.560.1"> must be modified to use Cosmos DB connection data, as shown in the following code:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.561.1">using</span></span><span class="koboSpan" id="kobo.562.1"> Microsoft.EntityFrameworkCore;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.563.1">using</span></span><span class="koboSpan" id="kobo.564.1"> Microsoft.EntityFrameworkCore.Design;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.565.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.566.1">WWTravelClubDB</span></span><span class="koboSpan" id="kobo.567.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.568.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.569.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.570.1">LibraryDesignTimeDbContextFactory</span></span><span class="koboSpan" id="kobo.571.1">
        : </span><span class="hljs-title"><span class="koboSpan" id="kobo.572.1">IDesignTimeDbContextFactory</span></span><span class="koboSpan" id="kobo.573.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.574.1">MainDBContext</span></span><span class="koboSpan" id="kobo.575.1">&gt;
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.576.1">private</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.577.1">const</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.578.1">string</span></span><span class="koboSpan" id="kobo.579.1"> endpoint = </span><span class="hljs-string"><span class="koboSpan" id="kobo.580.1">"&lt;your account endpoint&gt;"</span></span><span class="koboSpan" id="kobo.581.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.582.1">private</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.583.1">const</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.584.1">string</span></span><span class="koboSpan" id="kobo.585.1"> key = </span><span class="hljs-string"><span class="koboSpan" id="kobo.586.1">"&lt;your account key&gt;"</span></span><span class="koboSpan" id="kobo.587.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.588.1">private</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.589.1">const</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.590.1">string</span></span><span class="koboSpan" id="kobo.591.1"> databaseName = </span><span class="hljs-string"><span class="koboSpan" id="kobo.592.1">"packagesdb"</span></span><span class="koboSpan" id="kobo.593.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.594.1">public</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.595.1"> MainDBContext </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.596.1">CreateDbContext</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.597.1">(</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.598.1">params</span></span><span class="hljs-params"> </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.599.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.600.1">[] args</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.601.1">)</span></span><span class="koboSpan" id="kobo.602.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.603.1">var</span></span><span class="koboSpan" id="kobo.604.1"> builder = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.605.1">new</span></span><span class="koboSpan" id="kobo.606.1"> DbContextOptionsBuilder&lt;MainDBContext&gt;();
            builder.UseCosmos(endpoint, key, databaseName);
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.607.1">return</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.608.1">new</span></span><span class="koboSpan" id="kobo.609.1"> MainDBContext(builder.Options);
        }
    }
}
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.610.1">Finally, in our test </span><a id="_idIndexMarker1596"/><span class="koboSpan" id="kobo.611.1">console, we must</span><a id="_idIndexMarker1597"/><span class="koboSpan" id="kobo.612.1"> explicitly create all entity principal keys using GUIDs:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.613.1">var</span></span><span class="koboSpan" id="kobo.614.1"> context = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.615.1">new</span></span><span class="koboSpan" id="kobo.616.1"> LibraryDesignTimeDbContextFactory()
    .CreateDbContext();
context.Database.EnsureCreated();
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.617.1">var</span></span><span class="koboSpan" id="kobo.618.1"> firstDestination = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.619.1">new</span></span><span class="koboSpan" id="kobo.620.1"> Destination
{
    Id = Guid.NewGuid().ToString(),
    Name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.621.1">"Florence"</span></span><span class="koboSpan" id="kobo.622.1">,
    Country = </span><span class="hljs-string"><span class="koboSpan" id="kobo.623.1">"Italy"</span></span><span class="koboSpan" id="kobo.624.1">,
    Packages = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.625.1">new</span></span><span class="koboSpan" id="kobo.626.1"> List&lt;Package&gt;()
    {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.627.1">new</span></span><span class="koboSpan" id="kobo.628.1"> Package
    {
        Id=Guid.NewGuid().ToString(),
        Name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.629.1">"Summer in Florence"</span></span><span class="koboSpan" id="kobo.630.1">,
        StartValidityDate = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.631.1">new</span></span><span class="koboSpan" id="kobo.632.1"> DateTime(</span><span class="hljs-number"><span class="koboSpan" id="kobo.633.1">2019</span></span><span class="koboSpan" id="kobo.634.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.635.1">6</span></span><span class="koboSpan" id="kobo.636.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.637.1">1</span></span><span class="koboSpan" id="kobo.638.1">),
        EndValidityDate = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.639.1">new</span></span><span class="koboSpan" id="kobo.640.1"> DateTime(</span><span class="hljs-number"><span class="koboSpan" id="kobo.641.1">2019</span></span><span class="koboSpan" id="kobo.642.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.643.1">10</span></span><span class="koboSpan" id="kobo.644.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.645.1">1</span></span><span class="koboSpan" id="kobo.646.1">),
        DurationInDays=</span><span class="hljs-number"><span class="koboSpan" id="kobo.647.1">7</span></span><span class="koboSpan" id="kobo.648.1">,
        Price=</span><span class="hljs-number"><span class="koboSpan" id="kobo.649.1">1000</span></span><span class="koboSpan" id="kobo.650.1">
    },
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.651.1">new</span></span><span class="koboSpan" id="kobo.652.1"> Package
    {
        Id=Guid.NewGuid().ToString(),
        Name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.653.1">"Winter in Florence"</span></span><span class="koboSpan" id="kobo.654.1">,
        StartValidityDate = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.655.1">new</span></span><span class="koboSpan" id="kobo.656.1"> DateTime(</span><span class="hljs-number"><span class="koboSpan" id="kobo.657.1">2019</span></span><span class="koboSpan" id="kobo.658.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.659.1">12</span></span><span class="koboSpan" id="kobo.660.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.661.1">1</span></span><span class="koboSpan" id="kobo.662.1">),
        EndValidityDate = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.663.1">new</span></span><span class="koboSpan" id="kobo.664.1"> DateTime(</span><span class="hljs-number"><span class="koboSpan" id="kobo.665.1">2020</span></span><span class="koboSpan" id="kobo.666.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.667.1">2</span></span><span class="koboSpan" id="kobo.668.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.669.1">1</span></span><span class="koboSpan" id="kobo.670.1">),
        DurationInDays=</span><span class="hljs-number"><span class="koboSpan" id="kobo.671.1">7</span></span><span class="koboSpan" id="kobo.672.1">,
        Price=</span><span class="hljs-number"><span class="koboSpan" id="kobo.673.1">500</span></span><span class="koboSpan" id="kobo.674.1">
    }
  }
};
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.675.1">Here, we call </span><code class="inlineCode"><span class="koboSpan" id="kobo.676.1">context.Database.EnsureCreated()</span></code><span class="koboSpan" id="kobo.677.1"> instead of applying migrations since we only need to create the database. </span><span class="koboSpan" id="kobo.677.2">Once the database and collections have been created, we can fine-tune their settings from the Azure portal. </span><span class="koboSpan" id="kobo.677.3">Hopefully, future versions of the Cosmos DB Entity Framework Core provider will allow us to specify all collection options.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.678.1">Finally, the final query (which starts with </span><code class="inlineCode"><span class="koboSpan" id="kobo.679.1">context.Packages.Where...</span></code><span class="koboSpan" id="kobo.680.1">) must be modified since queries can’t start with entities that are nested in other documents (in our case, </span><code class="inlineCode"><span class="koboSpan" id="kobo.681.1">Packages</span></code><span class="koboSpan" id="kobo.682.1"> entities). </span><span class="koboSpan" id="kobo.682.2">Therefore, we must start our query from the unique root </span><code class="inlineCode"><span class="koboSpan" id="kobo.683.1">DbSet&lt;T&gt;</span></code><span class="koboSpan" id="kobo.684.1"> property we</span><a id="_idIndexMarker1598"/><span class="koboSpan" id="kobo.685.1"> have in our </span><code class="inlineCode"><span class="koboSpan" id="kobo.686.1">DBContext</span></code><span class="koboSpan" id="kobo.687.1">, that is, </span><code class="inlineCode"><span class="koboSpan" id="kobo.688.1">Destinations</span></code><span class="koboSpan" id="kobo.689.1">. </span><span class="koboSpan" id="kobo.689.2">We can </span><a id="_idIndexMarker1599"/><span class="koboSpan" id="kobo.690.1">move from listing the external collection to listing all the internal collections with the help of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.691.1">SelectMany</span></code><span class="koboSpan" id="kobo.692.1"> method, which performs a logical merge of all nested </span><code class="inlineCode"><span class="koboSpan" id="kobo.693.1">Packages</span></code><span class="koboSpan" id="kobo.694.1"> collections. </span><span class="koboSpan" id="kobo.694.2">However, since Cosmos DB SQL doesn’t support </span><code class="inlineCode"><span class="koboSpan" id="kobo.695.1">SelectMany</span></code><span class="koboSpan" id="kobo.696.1">, we must force </span><code class="inlineCode"><span class="koboSpan" id="kobo.697.1">SelectMany</span></code><span class="koboSpan" id="kobo.698.1"> to be simulated on the client with </span><code class="inlineCode"><span class="koboSpan" id="kobo.699.1">AsEnumerable()</span></code><span class="koboSpan" id="kobo.700.1">, as shown in the following code:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.701.1">var</span></span><span class="koboSpan" id="kobo.702.1"> list = context.Destinations
    .AsEnumerable() </span><span class="hljs-comment"><span class="koboSpan" id="kobo.703.1">// move computation on the client side</span></span><span class="koboSpan" id="kobo.704.1">
    .SelectMany(m =&gt;m.Packages)
    .Where(m =&gt; period &gt;= m.StartValidityDate....)
    ...
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.705.1">The remainder of the query remains unchanged. </span><span class="koboSpan" id="kobo.705.2">If you run the project now, you should see the same outputs that were received in the case of SQL Server (except for the primary key values).</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.706.1">After executing the program, go to your Cosmos DB account. </span><span class="koboSpan" id="kobo.706.2">You should see something like the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.707.1"><img alt="A picture containing table  Description automatically generated" src="../Images/B19820_21_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.708.1">Figure 21.13: Execution results</span></p>
<p class="normal"><span class="koboSpan" id="kobo.709.1">The packages have </span><a id="_idIndexMarker1600"/><span class="koboSpan" id="kobo.710.1">been nested inside their </span><a id="_idIndexMarker1601"/><span class="koboSpan" id="kobo.711.1">destinations as required and Entity Framework Core creates a unique collection that has the same name as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.712.1">DBContext</span></code><span class="koboSpan" id="kobo.713.1"> class.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.714.1">If you would like to continue experimenting with Cosmos DB development without wasting all your free Azure portal credit, you can install the Cosmos DB emulator, available at this link: </span><a href="https://aka.ms/cosmosdb-emulator"><span class="url"><span class="koboSpan" id="kobo.715.1">https://aka.ms/cosmosdb-emulator</span></span></a><span class="koboSpan" id="kobo.716.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.717.1">Having learned how to</span><a id="_idIndexMarker1602"/><span class="koboSpan" id="kobo.718.1"> choose the best </span><a id="_idIndexMarker1603"/><span class="koboSpan" id="kobo.719.1">options for data storage, we are in a position to start coding our first microservice.</span></p>
<h1 class="heading-1" id="_idParaDest-445"><span class="koboSpan" id="kobo.720.1">A worker microservice with ASP.NET Core</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.721.1">In this section, we will show you</span><a id="_idIndexMarker1604"/><span class="koboSpan" id="kobo.722.1"> how to implement a microservice that receives communications through gRPC and an internal queue based on a database table. </span><span class="koboSpan" id="kobo.722.2">The first subsection briefly describes the microservice specifications and the overall architecture. </span><span class="koboSpan" id="kobo.722.3">You are encouraged</span><a id="_idIndexMarker1605"/><span class="koboSpan" id="kobo.723.1"> to review </span><em class="italic"><span class="koboSpan" id="kobo.724.1">Chapter 14</span></em><span class="koboSpan" id="kobo.725.1">, </span><em class="italic"><span class="koboSpan" id="kobo.726.1">Implementing Microservices with .NET,</span></em><span class="koboSpan" id="kobo.727.1"> which contains all the theory behind this example.</span></p>
<h2 class="heading-2" id="_idParaDest-446"><span class="koboSpan" id="kobo.728.1">The specifications and architecture</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.729.1">Our example microservice is required to compute the daily sums of all purchases. </span><span class="koboSpan" id="kobo.729.2">According to the data-driven approach, we suppose that all daily sums are pre-computed by receiving messages that</span><a id="_idIndexMarker1606"/><span class="koboSpan" id="kobo.730.1"> are sent as soon as a new purchase is finalized. </span><span class="koboSpan" id="kobo.730.2">The purpose of the microservice is to maintain a database of all purchases and all daily sums that can be queried by an administrative user. </span><span class="koboSpan" id="kobo.730.3">We will implement just the functionalities needed to fill the two database tables.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.731.1">The implementation described in this section is based on an ASP.NET Core application that hosts a gRPC service. </span><span class="koboSpan" id="kobo.731.2">The gRPC service simply fills a messages queue and immediately returns to avoid the sender remaining blocked for the whole time of the computation.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.732.1">The actual processing is performed by an ASP.NET Core-hosted service declared in the dependency injection engine associated with the application host. </span><span class="koboSpan" id="kobo.732.2">The worker-hosted service executes an endless loop where it extracts </span><code class="inlineCode"><span class="koboSpan" id="kobo.733.1">N</span></code><span class="koboSpan" id="kobo.734.1"> messages from the queue and passes them to </span><code class="inlineCode"><span class="koboSpan" id="kobo.735.1">N</span></code><span class="koboSpan" id="kobo.736.1"> parallel threads that process them.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.737.1"><img alt="" role="presentation" src="../Images/B19820_21_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.738.1">Figure 21.14: gRPC microservice architecture</span></p>
<p class="normal"><span class="koboSpan" id="kobo.739.1">When the </span><code class="inlineCode"><span class="koboSpan" id="kobo.740.1">N</span></code><span class="koboSpan" id="kobo.741.1"> messages are taken</span><a id="_idIndexMarker1607"/><span class="koboSpan" id="kobo.742.1"> from the queue, they are not immediately removed but are simply marked with the extraction time. </span><span class="koboSpan" id="kobo.742.2">Since messages can only be extracted from the queue if their last extraction time is far enough ahead (say, a time </span><code class="inlineCode"><span class="koboSpan" id="kobo.743.1">T</span></code><span class="koboSpan" id="kobo.744.1">), no other worker thread can extract them again while they are being processed. </span><span class="koboSpan" id="kobo.744.2">When message processing is successfully completed, the message is removed from the queue. </span><span class="koboSpan" id="kobo.744.3">If the processing fails, no action is taken on the message, so the message remains blocked in the queue till the </span><code class="inlineCode"><span class="koboSpan" id="kobo.745.1">T</span></code><span class="koboSpan" id="kobo.746.1"> interval expires, and then it can be picked up again by the worker thread.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.747.1">The microservice can be scaled vertically by increasing the processor cores and the number </span><code class="inlineCode"><span class="koboSpan" id="kobo.748.1">N</span></code><span class="koboSpan" id="kobo.749.1"> of threads. </span><span class="koboSpan" id="kobo.749.2">It can be scaled horizontally, too, by using a load balancer that splits the loads into several identical copies of the ASP.NET Core application. </span><span class="koboSpan" id="kobo.749.3">This kind of horizontal scaling increases the number of threads that can receive messages and the number of worker threads, but since all ASP.NET Core applications share the same database, it is limited by database performance.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.750.1">The database layer is implemented in a separate </span><strong class="keyWord"><span class="koboSpan" id="kobo.751.1">DLL</span></strong><span class="koboSpan" id="kobo.752.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.753.1">Dynamic Link Library)</span></strong><span class="koboSpan" id="kobo.754.1"> and all functionalities are abstracted in two interfaces, one for interacting with the queue and another for adding a new purchase to the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.755.1">The next subsection briefly describes the database layer. </span><span class="koboSpan" id="kobo.755.2">We will not give all the details since the main focus of the example is the microservice architecture and the communication technique. </span><span class="koboSpan" id="kobo.755.3">However, the full code is available in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.756.1">ch15/GrpcMicroService</span></code><span class="koboSpan" id="kobo.757.1"> folder of the GitHub repository associated with the book.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.758.1">Having defined the overall architecture, let’s start with the storage layer code.</span></p>
<h2 class="heading-2" id="_idParaDest-447"><span class="koboSpan" id="kobo.759.1">The storage layer</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.760.1">The storage layer is based on</span><a id="_idIndexMarker1608"/><span class="koboSpan" id="kobo.761.1"> a database. </span><span class="koboSpan" id="kobo.761.2">It uses Entity Framework Core and is based on three entities with their associated tables:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.762.1">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.763.1">QueueItem</span></code><span class="koboSpan" id="kobo.764.1"> entity that represents a queue item</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.765.1">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.766.1">Purchase</span></code><span class="koboSpan" id="kobo.767.1"> entity that represents a single purchase</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.768.1">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.769.1">DayTotal</span></code><span class="koboSpan" id="kobo.770.1"> entity that represents the total of all purchases performed in a given day</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.771.1">Below is a definition of the interface that manipulates the queue:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.772.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.773.1">interface</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.774.1">IMessageQueue</span></span><span class="koboSpan" id="kobo.775.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.776.1">public</span></span><span class="koboSpan" id="kobo.777.1"> Task&lt;IList&lt;QueueItem&gt;&gt; Top(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.778.1">int</span></span><span class="koboSpan" id="kobo.779.1"> n);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.780.1">public</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.781.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.782.1">Dequeue</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.783.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.784.1">IEnumerable&lt;QueueItem&gt; items</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.785.1">)</span></span><span class="koboSpan" id="kobo.786.1">;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.787.1">public</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.788.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.789.1">Enqueue</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.790.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.791.1">QueueItem item</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.792.1">)</span></span><span class="koboSpan" id="kobo.793.1">;
}
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.794.1">Top</span></code><span class="koboSpan" id="kobo.795.1"> extracts the </span><code class="inlineCode"><span class="koboSpan" id="kobo.796.1">N</span></code><span class="koboSpan" id="kobo.797.1"> messages to pass to a maximum of </span><code class="inlineCode"><span class="koboSpan" id="kobo.798.1">N</span></code><span class="koboSpan" id="kobo.799.1"> different threads. </span><code class="inlineCode"><span class="koboSpan" id="kobo.800.1">Enqueue</span></code><span class="koboSpan" id="kobo.801.1"> adds a new message to the queue. </span><span class="koboSpan" id="kobo.801.2">Finally, </span><code class="inlineCode"><span class="koboSpan" id="kobo.802.1">Dequeue</span></code><span class="koboSpan" id="kobo.803.1"> removes the items that have been successfully processed from the queue.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.804.1">The interface that updates the purchase data is defined as shown below:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.805.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.806.1">interface</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.807.1">IDayStatistics</span></span><span class="koboSpan" id="kobo.808.1">
{
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.809.1">Task&lt;</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.810.1">decimal</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.811.1">&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.812.1">DayTotal</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.813.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.814.1">DateTimeOffset day</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.815.1">)</span></span><span class="koboSpan" id="kobo.816.1">;
    Task&lt;QueueItem?&gt; Add(QueueItem model);
}
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.817.1">Add</span></code><span class="koboSpan" id="kobo.818.1"> adds a new purchase to the database. </span><span class="koboSpan" id="kobo.818.2">It returns the input queue item if the addition is successful, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.819.1">null</span></code><span class="koboSpan" id="kobo.820.1"> otherwise. </span><code class="inlineCode"><span class="koboSpan" id="kobo.821.1">DayTotal</span></code><span class="koboSpan" id="kobo.822.1"> is a query method that returns a single day total.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.823.1">The application layer communicates with the database layer through these two interfaces, through the three database entities, through the </span><code class="inlineCode"><span class="koboSpan" id="kobo.824.1">IUnitOfWork</span></code><span class="koboSpan" id="kobo.825.1"> interface (which, as explained in the </span><em class="italic"><span class="koboSpan" id="kobo.826.1">How data and domain layers communicate with other layers</span></em><span class="koboSpan" id="kobo.827.1"> section of </span><em class="italic"><span class="koboSpan" id="kobo.828.1">Chapter 13</span></em><span class="koboSpan" id="kobo.829.1">, </span><em class="italic"><span class="koboSpan" id="kobo.830.1">Interacting with Data in C# – Entity Framework Core</span></em><span class="koboSpan" id="kobo.831.1"> abstracts the </span><code class="inlineCode"><span class="koboSpan" id="kobo.832.1">DbContext</span></code><span class="koboSpan" id="kobo.833.1">), and through a dependency injection extension method like the one below:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.834.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.835.1">static</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.836.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.837.1">StorageExtensions</span></span><span class="koboSpan" id="kobo.838.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.839.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.840.1">static</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.841.1"> IServiceCollection </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.842.1">AddStorage</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.843.1">(</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.844.1">this</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.845.1"> IServiceCollection services,</span></span>
<span class="hljs-params"> </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.846.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.847.1"> connectionString</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.848.1">)</span></span><span class="koboSpan" id="kobo.849.1">
    {
        services.AddDbContext&lt;IUnitOfWork,MainDbContext&gt;(options =&gt;
            options.UseSqlServer(connectionString, b =&gt;
b.MigrationsAssembly(</span><span class="hljs-string"><span class="koboSpan" id="kobo.850.1">"GrpcMicroServiceStore"</span></span><span class="koboSpan" id="kobo.851.1">)));
        services.AddScoped&lt;IMessageQueue, MessageQueue&gt;();
        services.AddScoped&lt;IDayStatistics, DayStatistics&gt;();
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.852.1">return</span></span><span class="koboSpan" id="kobo.853.1"> services;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.854.1">This method, which will be called in the application layer dependency injection definition, receives as</span><a id="_idIndexMarker1609"/><span class="koboSpan" id="kobo.855.1"> input the database connection string and adds the </span><code class="inlineCode"><span class="koboSpan" id="kobo.856.1">DbContext</span></code><span class="koboSpan" id="kobo.857.1"> abstracted with </span><code class="inlineCode"><span class="koboSpan" id="kobo.858.1">IUnitOfWork</span></code><span class="koboSpan" id="kobo.859.1">, with the two interfaces we defined before.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.860.1">The database project, called </span><code class="inlineCode"><span class="koboSpan" id="kobo.861.1">GrpcMicroServiceStore</span></code><span class="koboSpan" id="kobo.862.1">, is contained in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.863.1">ch15/GrpcMicroService</span></code><span class="koboSpan" id="kobo.864.1"> folder of the GitHub repository associated with the book. </span><span class="koboSpan" id="kobo.864.2">It already contains all the necessary database migrations, so you can create the needed database with the steps below:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.865.1">In the Visual Studio </span><strong class="screenText"><span class="koboSpan" id="kobo.866.1">Package Manager Console</span></strong><span class="koboSpan" id="kobo.867.1">, select the </span><strong class="screenText"><span class="koboSpan" id="kobo.868.1">GrpcMicroServiceStore</span></strong><span class="koboSpan" id="kobo.869.1"> project.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.870.1">In Visual Studio </span><strong class="screenText"><span class="koboSpan" id="kobo.871.1">Solution Explorer</span></strong><span class="koboSpan" id="kobo.872.1">, right-click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.873.1">GrpcMicroServiceStore</span></strong><span class="koboSpan" id="kobo.874.1"> project and set it as the startup project.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.875.1">In the Visual Studio </span><strong class="screenText"><span class="koboSpan" id="kobo.876.1">Package Manager Console</span></strong><span class="koboSpan" id="kobo.877.1">, issue the </span><code class="inlineCode"><span class="koboSpan" id="kobo.878.1">Update-Database</span></code><span class="koboSpan" id="kobo.879.1"> command.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.880.1">Having a working storage layer, we can proceed with the microservices application layer.</span></p>
<h2 class="heading-2" id="_idParaDest-448"><span class="koboSpan" id="kobo.881.1">The application layer</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.882.1">The application layer is an </span><strong class="keyWord"><span class="koboSpan" id="kobo.883.1">ASP.NET Core gRPC service</span></strong><span class="koboSpan" id="kobo.884.1"> project called </span><code class="inlineCode"><span class="koboSpan" id="kobo.885.1">GrpcMicroService</span></code><span class="koboSpan" id="kobo.886.1">. </span><span class="koboSpan" id="kobo.886.2">When the project is scaffolded by </span><a id="_idIndexMarker1610"/><span class="koboSpan" id="kobo.887.1">Visual Studio, it contains a </span><code class="inlineCode"><span class="koboSpan" id="kobo.888.1">.proto</span></code><span class="koboSpan" id="kobo.889.1"> file in its </span><code class="inlineCode"><span class="koboSpan" id="kobo.890.1">Protos</span></code><span class="koboSpan" id="kobo.891.1"> folder. </span><span class="koboSpan" id="kobo.891.2">This file needs to be deleted and replaced by a file called </span><code class="inlineCode"><span class="koboSpan" id="kobo.892.1">counting.proto</span></code><span class="koboSpan" id="kobo.893.1">, whose content must be as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.894.1">syntax = </span><span class="hljs-string"><span class="koboSpan" id="kobo.895.1">"proto3"</span></span><span class="koboSpan" id="kobo.896.1">;
option csharp_namespace = </span><span class="hljs-string"><span class="koboSpan" id="kobo.897.1">"GrpcMicroService"</span></span><span class="koboSpan" id="kobo.898.1">;
import </span><span class="hljs-string"><span class="koboSpan" id="kobo.899.1">"google/protobuf/timestamp.proto"</span></span><span class="koboSpan" id="kobo.900.1">;
package counting;
service Counter {
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.901.1">// Accepts a counting request</span></span>
<span class="hljs-function"><span class="koboSpan" id="kobo.902.1">rpc </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.903.1">Count</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.904.1"> (</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.905.1">CountingRequest</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.906.1">) </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.907.1">returns</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.908.1"> (</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.909.1">CountingReply</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.910.1">)</span></span><span class="koboSpan" id="kobo.911.1">;
}
message CountingRequest {
  </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.912.1">string</span></span><span class="koboSpan" id="kobo.913.1"> id = </span><span class="hljs-number"><span class="koboSpan" id="kobo.914.1">1</span></span><span class="koboSpan" id="kobo.915.1">;
  google.protobuf.Timestamp time = </span><span class="hljs-number"><span class="koboSpan" id="kobo.916.1">2</span></span><span class="koboSpan" id="kobo.917.1">;
  </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.918.1">string</span></span><span class="koboSpan" id="kobo.919.1"> location = </span><span class="hljs-number"><span class="koboSpan" id="kobo.920.1">3</span></span><span class="koboSpan" id="kobo.921.1">;
  sint32 cost =</span><span class="hljs-number"><span class="koboSpan" id="kobo.922.1">4</span></span><span class="koboSpan" id="kobo.923.1">;
  google.protobuf.Timestamp purchaseTime = </span><span class="hljs-number"><span class="koboSpan" id="kobo.924.1">5</span></span><span class="koboSpan" id="kobo.925.1">;
}.
</span><span class="koboSpan" id="kobo.925.2">message CountingReply {}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.926.1">The above code defines the gRPC service with its input and output messages and the .NET namespace where you place them. </span><span class="koboSpan" id="kobo.926.2">We import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.927.1">google/protobuf/timestamp.proto</span></code><span class="koboSpan" id="kobo.928.1"> predefined </span><code class="inlineCode"><span class="koboSpan" id="kobo.929.1">.proto</span></code><span class="koboSpan" id="kobo.930.1"> file because we need the </span><code class="inlineCode"><span class="koboSpan" id="kobo.931.1">TimeStamp</span></code><span class="koboSpan" id="kobo.932.1"> type. </span><span class="koboSpan" id="kobo.932.2">The</span><a id="_idIndexMarker1611"/><span class="koboSpan" id="kobo.933.1"> request contains purchase data, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.934.1">time</span></code><span class="koboSpan" id="kobo.935.1"> when the request message was created, and a unique message </span><code class="inlineCode"><span class="koboSpan" id="kobo.936.1">id</span></code><span class="koboSpan" id="kobo.937.1"> that is used to force message idempotency.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.938.1">In the database layer, the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.939.1">IDayStatistics.Add</span></code><span class="koboSpan" id="kobo.940.1"> method uses this </span><code class="inlineCode"><span class="koboSpan" id="kobo.941.1">id</span></code><span class="koboSpan" id="kobo.942.1"> to verify if a purchase with the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.943.1">id</span></code><span class="koboSpan" id="kobo.944.1"> has already been processed, in which case it returns immediately:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-type"><span class="koboSpan" id="kobo.945.1">bool</span></span><span class="koboSpan" id="kobo.946.1"> processed = await ctx.Purchases.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.947.1">AnyAsync</span></span><span class="koboSpan" id="kobo.948.1">(m =&gt; m.Id == model.MessageId);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.949.1">if</span></span><span class="koboSpan" id="kobo.950.1"> (processed) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.951.1">return</span></span><span class="koboSpan" id="kobo.952.1"> model;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.953.1">Automatic code generation for this file is enabled by replacing the existing </span><code class="inlineCode"><span class="koboSpan" id="kobo.954.1">protobuf</span></code><span class="koboSpan" id="kobo.955.1"> XML tag with:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.956.1">&lt;Protobuf Include=</span><span class="hljs-string"><span class="koboSpan" id="kobo.957.1">"Protos\counting.proto"</span></span><span class="koboSpan" id="kobo.958.1"> GrpcServices=</span><span class="hljs-string"><span class="koboSpan" id="kobo.959.1">"Server"</span></span><span class="koboSpan" id="kobo.960.1"> /&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.961.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.962.1">Grpc</span></code><span class="koboSpan" id="kobo.963.1"> attribute set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.964.1">"Server"</span></code><span class="koboSpan" id="kobo.965.1"> enables server-side code generation.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.966.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.967.1">Services</span></code><span class="koboSpan" id="kobo.968.1"> project folder, the predefined gRPC service scaffolded by Visual Studio must be replaced with a file </span><a id="_idIndexMarker1612"/><span class="koboSpan" id="kobo.969.1">named </span><code class="inlineCode"><span class="koboSpan" id="kobo.970.1">CounterService.cs</span></code><span class="koboSpan" id="kobo.971.1"> with the content below:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.972.1">using</span></span><span class="koboSpan" id="kobo.973.1"> Grpc.Core;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.974.1">using</span></span><span class="koboSpan" id="kobo.975.1"> GrpcMicroServiceStore;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.976.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.977.1">GrpcMicroService.Services</span></span><span class="koboSpan" id="kobo.978.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.979.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.980.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.981.1">CounterService</span></span><span class="koboSpan" id="kobo.982.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.983.1">Counter.CounterBase</span></span><span class="koboSpan" id="kobo.984.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.985.1">private</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.986.1">readonly</span></span><span class="koboSpan" id="kobo.987.1"> IMessageQueue queue;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.988.1">public</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.989.1">CounterService</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.990.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.991.1">IMessageQueue queue</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.992.1">)</span></span><span class="koboSpan" id="kobo.993.1">
    {
	 If (queue == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.994.1">null</span></span><span class="koboSpan" id="kobo.995.1">) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.996.1">throw</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.997.1">new</span></span><span class="koboSpan" id="kobo.998.1"> 					ArgumentNullException(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.999.1">nameof</span></span><span class="koboSpan" id="kobo.1000.1">(queue));
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1001.1">this</span></span><span class="koboSpan" id="kobo.1002.1">.queue = queue;
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1003.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1004.1">override</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1005.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1006.1">  Task&lt;CountingReply&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.1007.1">Count</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1008.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1009.1">CountingRequest request,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.1010.1">        ServerCallContext context</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1011.1">)</span></span><span class="koboSpan" id="kobo.1012.1">
    {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1013.1">await</span></span><span class="koboSpan" id="kobo.1014.1"> queue.Enqueue(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1015.1">new</span></span><span class="koboSpan" id="kobo.1016.1"> GrpcMicroServiceStore.Models.QueueItem
            {
                Cost = request.Cost,
                MessageId = Guid.Parse(request.Id),
                Location = request.Location,
                PurchaseTime = request.PurchaseTime.ToDateTimeOffset(),
                Time = request.Time.ToDateTimeOffset()
            });
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1017.1">return</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1018.1">new</span></span><span class="koboSpan" id="kobo.1019.1"> CountingReply {  }; 
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1020.1">The actual service that receives the purchase messages inherits from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1021.1">Counter.CounterBase</span></code><span class="koboSpan" id="kobo.1022.1"> abstract class created by the code generator from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1023.1">counting.proto</span></code><span class="koboSpan" id="kobo.1024.1"> file. </span><span class="koboSpan" id="kobo.1024.2">It receives the database layer interface </span><code class="inlineCode"><span class="koboSpan" id="kobo.1025.1">IMessageQueue</span></code><span class="koboSpan" id="kobo.1026.1"> using dependency injection and overrides the abstract </span><code class="inlineCode"><span class="koboSpan" id="kobo.1027.1">Count</span></code><span class="koboSpan" id="kobo.1028.1"> method inherited from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1029.1">Counter.CounterBase</span></code><span class="koboSpan" id="kobo.1030.1">. </span><span class="koboSpan" id="kobo.1030.2">Then, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1031.1">Count</span></code><span class="koboSpan" id="kobo.1032.1"> uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.1033.1">IMessageQueue</span></code><span class="koboSpan" id="kobo.1034.1"> to enqueue each received message.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1035.1">Before compiling, a few other steps are necessary:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1036.1">We must add a reference to the database-layer </span><code class="inlineCode"><span class="koboSpan" id="kobo.1037.1">GrpcMicroServiceStore</span></code><span class="koboSpan" id="kobo.1038.1"> project.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1039.1">We must add the database connection string to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1040.1">appsettings.json</span></code><span class="koboSpan" id="kobo.1041.1"> setting file:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.1042.1">"ConnectionStrings"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1043.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.1044.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1045.1">"DefaultConnection"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1046.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1047.1">"Server=(localdb)\\mssqllocaldb;Database=grpcmicroservice;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.1048.1">}</span></span>
</code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1049.1">We must add all the</span><a id="_idIndexMarker1613"/><span class="koboSpan" id="kobo.1050.1"> necessary database-layer interfaces to the dependency injection by calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1051.1">AddStorage</span></code><span class="koboSpan" id="kobo.1052.1"> database layer extension method:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1053.1">builder.Services.AddStorage(
builder.Configuration.GetConnectionString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1054.1">"DefaultConnection"</span></span><span class="koboSpan" id="kobo.1055.1">));
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1056.1">In </span><code class="inlineCode"><span class="koboSpan" id="kobo.1057.1">Program.cs</span></code><span class="koboSpan" id="kobo.1058.1">, we must remove the declaration of the gRPC service scaffolded by Visual Studio, and we must replace it with:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1059.1">app.MapGrpcService&lt;CounterService&gt;();
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1060.1">At this point, compilation should succeed. </span><span class="koboSpan" id="kobo.1060.2">Having completed the application-layer infrastructure, we can move to the hosted service that performs the actual queue processing.</span></p>
<h2 class="heading-2" id="_idParaDest-449"><span class="koboSpan" id="kobo.1061.1">Processing the queued requests</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1062.1">The actual request processing is </span><a id="_idIndexMarker1614"/><span class="koboSpan" id="kobo.1063.1">performed by a worker-hosted service that runs in parallel with the ASP.NET Core pipeline. </span><span class="koboSpan" id="kobo.1063.2">It is implemented with the hosted services we discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.1064.1">Using generic hosts</span></em><span class="koboSpan" id="kobo.1065.1"> section of </span><em class="italic"><span class="koboSpan" id="kobo.1066.1">Chapter 11</span></em><span class="koboSpan" id="kobo.1067.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1068.1">Applying a Microservice Architecture to Your Enterprise Application</span></em><span class="koboSpan" id="kobo.1069.1">. </span><span class="koboSpan" id="kobo.1069.2">It is worth recalling that hosted services are implementations of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1070.1">IHostedService</span></code><span class="koboSpan" id="kobo.1071.1"> interface defined in the dependency injection engine as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1072.1">builder.Services.AddHostedService&lt;MyHostedService&gt;();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1073.1">We already described how to implement hosted services for the implementation of ASP.NET Core-based worker microservices in the </span><em class="italic"><span class="koboSpan" id="kobo.1074.1">Implementing worker microservices with ASP.NET Core</span></em><span class="koboSpan" id="kobo.1075.1"> section of </span><em class="italic"><span class="koboSpan" id="kobo.1076.1">Chapter 14, Implementing Microservices with .NET</span></em><span class="koboSpan" id="kobo.1077.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1078.1">Below, we repeat the whole </span><a id="_idIndexMarker1615"/><span class="koboSpan" id="kobo.1079.1">code with all details that are specific to our example. </span><span class="koboSpan" id="kobo.1079.2">The hosted service is defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1080.1">ProcessPurchases.cs</span></code><span class="koboSpan" id="kobo.1081.1"> file placed in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1082.1">HostedServices</span></code><span class="koboSpan" id="kobo.1083.1"> folder:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1084.1">using</span></span><span class="koboSpan" id="kobo.1085.1"> GrpcMicroServiceStore;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1086.1">using</span></span><span class="koboSpan" id="kobo.1087.1"> GrpcMicroServiceStore.Models;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1088.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1089.1">GrpcMicroService.HostedServices</span></span><span class="koboSpan" id="kobo.1090.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1091.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1092.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1093.1">ProcessPurchases</span></span><span class="koboSpan" id="kobo.1094.1"> : </span><span class="hljs-title"><span class="koboSpan" id="kobo.1095.1">BackgroundService</span></span><span class="koboSpan" id="kobo.1096.1">
{
    IServiceProvider services;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1097.1">public</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.1098.1">ProcessPurchases</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1099.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1100.1">IServiceProvider services</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1101.1">)</span></span><span class="koboSpan" id="kobo.1102.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1103.1">this</span></span><span class="koboSpan" id="kobo.1104.1">.services = services;
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1105.1">protected</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1106.1">override</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1107.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1108.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.1109.1">ExecuteAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1110.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1111.1">CancellationToken stoppingToken</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1112.1">)</span></span><span class="koboSpan" id="kobo.1113.1">
    {
        </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1114.1">bool</span></span><span class="koboSpan" id="kobo.1115.1"> queueEmpty = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1116.1">false</span></span><span class="koboSpan" id="kobo.1117.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1118.1">while</span></span><span class="koboSpan" id="kobo.1119.1"> (!stoppingToken.IsCancellationRequested)
        {
           </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1120.1">while</span></span><span class="koboSpan" id="kobo.1121.1"> (!queueEmpty &amp;&amp; !stoppingToken.IsCancellationRequested)
           {
             ...
           </span><span class="koboSpan" id="kobo.1121.2">}
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1122.1">await</span></span><span class="koboSpan" id="kobo.1123.1"> Task.Delay(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1124.1">100</span></span><span class="koboSpan" id="kobo.1125.1">, stoppingToken);
            queueEmpty = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1126.1">false</span></span><span class="koboSpan" id="kobo.1127.1">;
        }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1128.1">Below is the content of the inner loop:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1129.1">using</span></span><span class="koboSpan" id="kobo.1130.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1131.1">var</span></span><span class="koboSpan" id="kobo.1132.1"> scope = services.CreateScope())
{
    IMessageQueue queue = scope.ServiceProvider.GetRequiredService&lt;IMessageQueue&gt;();
                   
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1133.1">var</span></span><span class="koboSpan" id="kobo.1134.1"> toProcess = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1135.1">await</span></span><span class="koboSpan" id="kobo.1136.1"> queue.Top(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1137.1">10</span></span><span class="koboSpan" id="kobo.1138.1">);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1139.1">if</span></span><span class="koboSpan" id="kobo.1140.1"> (toProcess.Count &gt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.1141.1">0</span></span><span class="koboSpan" id="kobo.1142.1">)
    {
        Task&lt;QueueItem?&gt;[] tasks = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1143.1">new</span></span><span class="koboSpan" id="kobo.1144.1"> Task&lt;QueueItem?&gt;[toProcess.Count];
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1145.1">for</span></span><span class="koboSpan" id="kobo.1146.1"> (</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1147.1">int</span></span><span class="koboSpan" id="kobo.1148.1"> i = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1149.1">0</span></span><span class="koboSpan" id="kobo.1150.1">; i &lt; tasks.Length; i++)
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1151.1">var</span></span><span class="koboSpan" id="kobo.1152.1"> toExecute = ...
            </span><span class="koboSpan" id="kobo.1152.2">tasks[i] = toExecute();
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1153.1">await</span></span><span class="koboSpan" id="kobo.1154.1"> Task.WhenAll(tasks);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1155.1">await</span></span><span class="koboSpan" id="kobo.1156.1"> queue.Dequeue(tasks.Select(m =&gt; m.Result)
           .Where(m =&gt; m != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1157.1">null</span></span><span class="koboSpan" id="kobo.1158.1">).OfType&lt;QueueItem&gt;());
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1159.1">else</span></span><span class="koboSpan" id="kobo.1160.1"> queueEmpty = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1161.1">true</span></span><span class="koboSpan" id="kobo.1162.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1163.1">The above code was already </span><a id="_idIndexMarker1616"/><span class="koboSpan" id="kobo.1164.1">explained in the </span><em class="italic"><span class="koboSpan" id="kobo.1165.1">Implementing worker microservices with ASP.NET Core</span></em><span class="koboSpan" id="kobo.1166.1"> section of </span><em class="italic"><span class="koboSpan" id="kobo.1167.1">Chapter 14, Implementing Microservices with .NET</span></em><span class="koboSpan" id="kobo.1168.1">. </span><span class="koboSpan" id="kobo.1168.2">Therefore, here, we will analyze just the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1169.1">toExecute</span></code><span class="koboSpan" id="kobo.1170.1"> lambda that is specific to our example:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1171.1">var</span></span><span class="koboSpan" id="kobo.1172.1"> toExecute = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1173.1">async</span></span><span class="koboSpan" id="kobo.1174.1"> () =&gt;
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1175.1">using</span></span><span class="koboSpan" id="kobo.1176.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1177.1">var</span></span><span class="koboSpan" id="kobo.1178.1"> sc = services.CreateScope())
    {
        IDayStatistics statistics = sc.ServiceProvider.GetRequiredService&lt;IDayStatistics&gt;();
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1179.1">return</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1180.1">await</span></span><span class="koboSpan" id="kobo.1181.1"> statistics.Add(toProcess[i]);
    }
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1182.1">Each task creates a different session scope so it can have a private copy of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1183.1">IDayStatistics</span></code><span class="koboSpan" id="kobo.1184.1">, and then processes its request with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1185.1">statistics.Add</span></code><span class="koboSpan" id="kobo.1186.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1187.1">That’s all! </span><span class="koboSpan" id="kobo.1187.2">Now we need a source of purchase data to test our code. </span><span class="koboSpan" id="kobo.1187.3">In the next subsection, we will create a fake microservice that randomly creates purchase data and passes it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1188.1">Counter</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.1189.1">gRPC</span></code><span class="koboSpan" id="kobo.1190.1"> service.</span></p>
<h2 class="heading-2" id="_idParaDest-450"><span class="koboSpan" id="kobo.1191.1">Testing the GrpcMicroservice project with a fake purchase requests generator</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1192.1">Let’s implement another </span><a id="_idIndexMarker1617"/><span class="koboSpan" id="kobo.1193.1">microservice that feeds the previous microservice with randomly generated requests. </span><span class="koboSpan" id="kobo.1193.2">The right project for a worker service that is not based on ASP.NET Core is the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1194.1">Worker Service</span></strong><span class="koboSpan" id="kobo.1195.1"> project template. </span><span class="koboSpan" id="kobo.1195.2">This project template automatically scaffolds a host containing a unique hosted service called </span><code class="inlineCode"><span class="koboSpan" id="kobo.1196.1">Worker</span></code><span class="koboSpan" id="kobo.1197.1">. </span><span class="koboSpan" id="kobo.1197.2">We called this project </span><code class="inlineCode"><span class="koboSpan" id="kobo.1198.1">FakeSource</span></code><span class="koboSpan" id="kobo.1199.1">. </span><span class="koboSpan" id="kobo.1199.2">In order to enable gRPC client usage, we must add the following NuGet packages: </span><code class="inlineCode"><span class="koboSpan" id="kobo.1200.1">Google.Protobuf</span></code><span class="koboSpan" id="kobo.1201.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1202.1">Grpc.NET.Client</span></code><span class="koboSpan" id="kobo.1203.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1204.1">Grpc.Tools</span></code><span class="koboSpan" id="kobo.1205.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1206.1">Then, we must add the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.1207.1">counting.proto</span></code><span class="koboSpan" id="kobo.1208.1"> file as was added to the previous project. </span><span class="koboSpan" id="kobo.1208.2">However, this time, we must require client code generation by placing the code below in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1209.1">FakeSource</span></code><span class="koboSpan" id="kobo.1210.1"> project file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.1211.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1212.1">ItemGroup</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1213.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1214.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1215.1">Protobuf</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1216.1">Include</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1217.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1218.1">"..\GrpcMicroService\Protos\counting.proto"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1219.1">GrpcServices</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1220.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1221.1">"Client"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1222.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1223.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1224.1">Link</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1225.1">&gt;</span></span><span class="koboSpan" id="kobo.1226.1">Protos\counting.proto</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1227.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1228.1">Link</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1229.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1230.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1231.1">Protobuf</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1232.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1233.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1234.1">ItemGroup</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1235.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1236.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1237.1">GrpcServices</span></code><span class="koboSpan" id="kobo.1238.1"> attribute </span><a id="_idIndexMarker1618"/><span class="koboSpan" id="kobo.1239.1">set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1240.1">Client</span></code><span class="koboSpan" id="kobo.1241.1"> is what enables client code generation instead of server code generation. </span><span class="koboSpan" id="kobo.1241.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1242.1">link</span></code><span class="koboSpan" id="kobo.1243.1"> tag appears since we added the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.1244.1">counting.proto</span></code><span class="koboSpan" id="kobo.1245.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1246.1">GrpcMicroService</span></code><span class="koboSpan" id="kobo.1247.1"> project as a link instead of copying it into the new project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1248.1">The hosted service is defined with the usual endless loop:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1249.1">using</span></span><span class="koboSpan" id="kobo.1250.1"> Grpc.Net.Client;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1251.1">using</span></span><span class="koboSpan" id="kobo.1252.1"> GrpcMicroService;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1253.1">using</span></span><span class="koboSpan" id="kobo.1254.1"> Google.Protobuf.WellKnownTypes;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1255.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1256.1">FakeSource</span></span><span class="koboSpan" id="kobo.1257.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1258.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1259.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1260.1">Worker</span></span><span class="koboSpan" id="kobo.1261.1"> : </span><span class="hljs-title"><span class="koboSpan" id="kobo.1262.1">BackgroundService</span></span><span class="koboSpan" id="kobo.1263.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1264.1">private</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1265.1">readonly</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1266.1">string</span></span><span class="koboSpan" id="kobo.1267.1">[] locations = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1268.1">new</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1269.1">string</span></span><span class="koboSpan" id="kobo.1270.1">[]
           { </span><span class="hljs-string"><span class="koboSpan" id="kobo.1271.1">"Florence"</span></span><span class="koboSpan" id="kobo.1272.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1273.1">"London"</span></span><span class="koboSpan" id="kobo.1274.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1275.1">"New York"</span></span><span class="koboSpan" id="kobo.1276.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1277.1">"Paris"</span></span><span class="koboSpan" id="kobo.1278.1"> };
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1279.1">protected</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1280.1">override</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1281.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1282.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.1283.1">ExecuteAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1284.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1285.1">CancellationToken stoppingToken</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1286.1">)</span></span><span class="koboSpan" id="kobo.1287.1">
    {
        Random random = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1288.1">new</span></span><span class="koboSpan" id="kobo.1289.1"> Random();
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1290.1">while</span></span><span class="koboSpan" id="kobo.1291.1"> (!stoppingToken.IsCancellationRequested)
        {
          </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1292.1">try</span></span><span class="koboSpan" id="kobo.1293.1">
          {
             ...
             </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1294.1">await</span></span><span class="koboSpan" id="kobo.1295.1"> Task.Delay(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1296.1">2000</span></span><span class="koboSpan" id="kobo.1297.1">, stoppingToken);
          }
          </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1298.1">catch</span></span><span class="koboSpan" id="kobo.1299.1"> (OperationCanceledException)
          {
             </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1300.1">return</span></span><span class="koboSpan" id="kobo.1301.1">;
          }
          </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1302.1">catch</span></span><span class="koboSpan" id="kobo.1303.1"> { }
        }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1304.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1305.1">locations</span></code><span class="koboSpan" id="kobo.1306.1"> array contains locations that will be randomly selected. </span><span class="koboSpan" id="kobo.1306.2">As soon as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1307.1">ExecuteAsync</span></code><span class="koboSpan" id="kobo.1308.1"> method </span><a id="_idIndexMarker1619"/><span class="koboSpan" id="kobo.1309.1">starts, it creates the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1310.1">Random</span></code><span class="koboSpan" id="kobo.1311.1"> instance that will be used in all random generations.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1312.1">Each loop is enclosed in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1313.1">try</span></code><span class="koboSpan" id="kobo.1314.1">/</span><code class="inlineCode"><span class="koboSpan" id="kobo.1315.1">catch</span></code><span class="koboSpan" id="kobo.1316.1">; if an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1317.1">OperationCanceledException</span></code><span class="koboSpan" id="kobo.1318.1"> is generated, the method exits, since a similar exception is created when the application is being shut down and the thread is killed. </span><span class="koboSpan" id="kobo.1318.2">In the case of other exceptions, the code tries to recover by simply moving to the next loop. </span><span class="koboSpan" id="kobo.1318.3">In an actual production application, the final </span><code class="inlineCode"><span class="koboSpan" id="kobo.1319.1">catch</span></code><span class="koboSpan" id="kobo.1320.1"> should contain instructions to log the intercepted exception and/or instructions for a better recovery strategy. </span><span class="koboSpan" id="kobo.1320.2">In the next example, we will see more sophisticated exception handling that is adequate for actual production applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1321.1">Inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1322.1">try</span></code><span class="koboSpan" id="kobo.1323.1">, the code creates a purchase message, sends it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1324.1">Counter</span></code><span class="koboSpan" id="kobo.1325.1"> service, and then sleeps for 2 seconds.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1326.1">Below is the code that sends the requests:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1327.1">var</span></span><span class="koboSpan" id="kobo.1328.1"> purchaseDay = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1329.1">new</span></span><span class="koboSpan" id="kobo.1330.1"> DateTimeOffset(DateTime.UtcNow.Date, TimeSpan.Zero);
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1331.1">//randomize a little bit purchase day</span></span><span class="koboSpan" id="kobo.1332.1">
purchaseDay = purchaseDay.AddDays(random.Next(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1333.1">0</span></span><span class="koboSpan" id="kobo.1334.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1335.1">3</span></span><span class="koboSpan" id="kobo.1336.1">) - </span><span class="hljs-number"><span class="koboSpan" id="kobo.1337.1">1</span></span><span class="koboSpan" id="kobo.1338.1">); 
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1339.1">//message time</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1340.1">var</span></span><span class="koboSpan" id="kobo.1341.1"> now = DateTimeOffset.UtcNow;
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1342.1">//add random location</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1343.1">var</span></span><span class="koboSpan" id="kobo.1344.1"> location = locations[random.Next(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1345.1">0</span></span><span class="koboSpan" id="kobo.1346.1">, locations.Length)];
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1347.1">var</span></span><span class="koboSpan" id="kobo.1348.1"> messageId = Guid.NewGuid().ToString();
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1349.1">//add random cost</span></span>
<span class="hljs-built_in"><span class="koboSpan" id="kobo.1350.1">int</span></span><span class="koboSpan" id="kobo.1351.1"> cost = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1352.1">200</span></span><span class="koboSpan" id="kobo.1353.1"> * random.Next(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1354.1">1</span></span><span class="koboSpan" id="kobo.1355.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1356.1">4</span></span><span class="koboSpan" id="kobo.1357.1">);
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1358.1">//send message</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1359.1">using</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1360.1">var</span></span><span class="koboSpan" id="kobo.1361.1"> channel = GrpcChannel.ForAddress(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1362.1">"http://localhost:5000"</span></span><span class="koboSpan" id="kobo.1363.1">);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1364.1">var</span></span><span class="koboSpan" id="kobo.1365.1"> client = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1366.1">new</span></span><span class="koboSpan" id="kobo.1367.1"> Counter.CounterClient(channel);
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1368.1">//since this is a fake random source</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1369.1">//in case of errors we simply do nothing.</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1370.1">//An actual client should use Polly</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1371.1">//to define retry policies</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1372.1">try</span></span><span class="koboSpan" id="kobo.1373.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1374.1">await</span></span><span class="koboSpan" id="kobo.1375.1"> client.CountAsync(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1376.1">new</span></span><span class="koboSpan" id="kobo.1377.1"> CountingRequest
    {
        Id = messageId,
        Location = location,
        PurchaseTime = Timestamp.FromDateTimeOffset(purchaseDay),
        Time = Timestamp.FromDateTimeOffset(now),
        Cost = cost
    });
                   
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1378.1">catch</span></span><span class="koboSpan" id="kobo.1379.1"> {}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1380.1">The code just prepares the message with random data; then, it creates a communication channel for</span><a id="_idIndexMarker1620"/><span class="koboSpan" id="kobo.1381.1"> the gRPC server address and passes it to the constructor of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1382.1">Counter</span></code><span class="koboSpan" id="kobo.1383.1"> service proxy. </span><span class="koboSpan" id="kobo.1383.2">Finally, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1384.1">Count</span></code><span class="koboSpan" id="kobo.1385.1"> method is called on the proxy. </span><span class="koboSpan" id="kobo.1385.2">The call is enclosed in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1386.1">try</span></code><span class="koboSpan" id="kobo.1387.1">/</span><code class="inlineCode"><span class="koboSpan" id="kobo.1388.1">catch</span></code><span class="koboSpan" id="kobo.1389.1">, and in the case of an error, the error is simply ignored, since we are just sending random data. </span><span class="koboSpan" id="kobo.1389.2">Instead, an actual production application should use </span><strong class="keyWord"><span class="koboSpan" id="kobo.1390.1">Polly</span></strong><span class="koboSpan" id="kobo.1391.1"> to retry the communication with predefined strategies. </span><strong class="keyWord"><span class="koboSpan" id="kobo.1392.1">Polly</span></strong><span class="koboSpan" id="kobo.1393.1"> was described in the </span><em class="italic"><span class="koboSpan" id="kobo.1394.1">Resilient task execution</span></em><span class="koboSpan" id="kobo.1395.1"> section of </span><em class="italic"><span class="koboSpan" id="kobo.1396.1">Chapter 11</span></em><span class="koboSpan" id="kobo.1397.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1398.1">Applying a Microservice Architecture to Your Enterprise Application</span></em><span class="koboSpan" id="kobo.1399.1">. </span><span class="koboSpan" id="kobo.1399.2">We will show you how to use </span><strong class="keyWord"><span class="koboSpan" id="kobo.1400.1">Polly</span></strong><span class="koboSpan" id="kobo.1401.1"> in the example in the next section.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1402.1">And there you have it! </span><span class="koboSpan" id="kobo.1402.2">Now it is time to test everything. </span><span class="koboSpan" id="kobo.1402.3">Right-click on the solution and select </span><strong class="keyWord"><span class="koboSpan" id="kobo.1403.1">Set Startup Projects</span></strong><span class="koboSpan" id="kobo.1404.1">, then set both </span><code class="inlineCode"><span class="koboSpan" id="kobo.1405.1">FakeSource</span></code><span class="koboSpan" id="kobo.1406.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1407.1">GrpcMicroService</span></code><span class="koboSpan" id="kobo.1408.1"> to start. </span><span class="koboSpan" id="kobo.1408.2">This way, both projects will be launched simultaneously when the solution is run.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1409.1">Launch Visual Studio and then let both processes run for a couple of minutes, then go to </span><strong class="keyWord"><span class="koboSpan" id="kobo.1410.1">SQL Server Object Explorer</span></strong><span class="koboSpan" id="kobo.1411.1"> and look for a database called </span><code class="inlineCode"><span class="koboSpan" id="kobo.1412.1">grpcmicroservice</span></code><span class="koboSpan" id="kobo.1413.1">. </span><span class="koboSpan" id="kobo.1413.2">If the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1414.1">SQL Server Object Explorer</span></strong><span class="koboSpan" id="kobo.1415.1"> window is not available in the left menu of Visual Studio, go to the top </span><strong class="keyWord"><span class="koboSpan" id="kobo.1416.1">Window</span></strong><span class="koboSpan" id="kobo.1417.1"> menu and select it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1418.1">Once you have located the database, show the content of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1419.1">DayTotals</span></code><span class="koboSpan" id="kobo.1420.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1421.1">Purchases</span></code><span class="koboSpan" id="kobo.1422.1"> tables. </span><span class="koboSpan" id="kobo.1422.2">You should see all computed daily sums and all processed purchases.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1423.1">You can also inspect what happens in the server project by opening the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1424.1">HostedServices/ProcessPurchases.cs</span></code><span class="koboSpan" id="kobo.1425.1"> file and placing breakpoints on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1426.1">queue.Top(10)</span></code><span class="koboSpan" id="kobo.1427.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1428.1">await</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.1429.1">queue.Dequeue(...)</span></code><span class="koboSpan" id="kobo.1430.1"> instructions.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1431.1">You can also move </span><code class="inlineCode"><span class="koboSpan" id="kobo.1432.1">FakeSource</span></code><span class="koboSpan" id="kobo.1433.1"> into a different Visual Studio solution so that you can simultaneously run several copies of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1434.1">FakeSource</span></code><span class="koboSpan" id="kobo.1435.1"> each in a different Visual Studio instance. </span><span class="koboSpan" id="kobo.1435.2">It is also possible to double-click on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1436.1">FakeSource</span></code><span class="koboSpan" id="kobo.1437.1"> project, which gives the option to save a new Visual Studio solution containing just a reference to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1438.1">FakeSource</span></code><span class="koboSpan" id="kobo.1439.1"> project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1440.1">The full code is in the </span><a id="_idIndexMarker1621"/><code class="inlineCode"><span class="koboSpan" id="kobo.1441.1">GrpcMicroService</span></code><span class="koboSpan" id="kobo.1442.1"> subfolder of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1443.1">ch15</span></code><span class="koboSpan" id="kobo.1444.1"> folder of the book’s GitHub repository. </span><span class="koboSpan" id="kobo.1444.2">The next section shows you how to solve the same problem with queued communication using the RabbitMQ message broker.</span></p>
<h1 class="heading-1" id="_idParaDest-451"><span class="koboSpan" id="kobo.1445.1">A worker microservice based on RabbitMQ</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1446.1">This section explains the </span><a id="_idIndexMarker1622"/><span class="koboSpan" id="kobo.1447.1">modifications needed to use a message broker instead of gRPC communication with an internal queue. </span><span class="koboSpan" id="kobo.1447.2">This kind of solution is usually more difficult to test and design but allows for better horizontal scaling, and also enables extra features at almost no cost since they are offered by the message broker itself.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1448.1">We assume that RabbitMQ has already been installed and adequately prepared, as explained in the </span><em class="italic"><span class="koboSpan" id="kobo.1449.1">Installing RabbitMQ core</span></em><span class="koboSpan" id="kobo.1450.1"> subsection of </span><em class="italic"><span class="koboSpan" id="kobo.1451.1">Chapter 14, Implementing Microservices with .NET</span></em><span class="koboSpan" id="kobo.1452.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1453.1">First, the ASP.NET Core project must be replaced by another </span><strong class="keyWord"><span class="koboSpan" id="kobo.1454.1">Worker Service</span></strong><span class="koboSpan" id="kobo.1455.1"> project. </span><span class="koboSpan" id="kobo.1455.2">Also, this project must add the connection string to its configuration file and must call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1456.1">AddStorage</span></code><span class="koboSpan" id="kobo.1457.1"> extension method to add all the database services to the dependency injection engine. </span><span class="koboSpan" id="kobo.1457.2">Below is the full content of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1458.1">Program.cs</span></code><span class="koboSpan" id="kobo.1459.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1460.1">using</span></span><span class="koboSpan" id="kobo.1461.1"> GrpcMicroService.HostedServices;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1462.1">using</span></span><span class="koboSpan" id="kobo.1463.1"> GrpcMicroServiceStore;
IHost host = Host.CreateDefaultBuilder(args)
    .ConfigureServices((hostContext, services) =&gt;
    {
        services.AddStorage(hostContext.Configuration
            .GetConnectionString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1464.1">"DefaultConnection"</span></span><span class="koboSpan" id="kobo.1465.1">));
        services.AddHostedService&lt;ProcessPurchases&gt;();
    })
    .Build();
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1466.1">await</span></span><span class="koboSpan" id="kobo.1467.1"> host.RunAsync();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1468.1">We don’t need the gRPC services and service proxies anymore, just ProtoBuf for the binary messages, so both</span><a id="_idIndexMarker1623"/><span class="koboSpan" id="kobo.1469.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1470.1">FakeSource</span></code><span class="koboSpan" id="kobo.1471.1"> process and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1472.1">GrpcMicroService</span></code><span class="koboSpan" id="kobo.1473.1"> projects must add just the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1474.1">Google.Protobuf</span></code><span class="koboSpan" id="kobo.1475.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1476.1">Grpc.Tools</span></code><span class="koboSpan" id="kobo.1477.1"> NuGet packages. </span><span class="koboSpan" id="kobo.1477.2">Both projects need the following </span><code class="inlineCode"><span class="koboSpan" id="kobo.1478.1">messages.proto</span></code><span class="koboSpan" id="kobo.1479.1"> file, which defines just the purchase message:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1480.1">syntax = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1481.1">"proto3"</span></span><span class="koboSpan" id="kobo.1482.1">;
option csharp_namespace = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1483.1">"GrpcMicroService"</span></span><span class="koboSpan" id="kobo.1484.1">;
import </span><span class="hljs-string"><span class="koboSpan" id="kobo.1485.1">"google/protobuf/timestamp.proto"</span></span><span class="koboSpan" id="kobo.1486.1">;
package purchase;
message PurchaseMessage {
  </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1487.1">string</span></span><span class="koboSpan" id="kobo.1488.1"> id = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1489.1">1</span></span><span class="koboSpan" id="kobo.1490.1">;
  google.protobuf.Timestamp time = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1491.1">2</span></span><span class="koboSpan" id="kobo.1492.1">;
  </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1493.1">string</span></span><span class="koboSpan" id="kobo.1494.1"> location = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1495.1">3</span></span><span class="koboSpan" id="kobo.1496.1">;
  int32 cost =</span><span class="hljs-number"><span class="koboSpan" id="kobo.1497.1">4</span></span><span class="koboSpan" id="kobo.1498.1">;
  google.protobuf.Timestamp purchaseTime = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1499.1">5</span></span><span class="koboSpan" id="kobo.1500.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1501.1">The automatic generation of the message classes is enabled in both projects with the same XML declaration in their project files:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.1502.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1503.1">ItemGroup</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1504.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1505.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1506.1">Protobuf</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1507.1">Include</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1508.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1509.1">"Protos\messages.proto"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1510.1">GrpcServices</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1511.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1512.1">"Client"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1513.1"> /&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1514.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1515.1">ItemGroup</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1516.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1517.1">Both projects need to specify </span><code class="inlineCode"><span class="koboSpan" id="kobo.1518.1">Client</span></code><span class="koboSpan" id="kobo.1519.1"> code generation since no service needs to be created.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1520.1">To communicate with the RabbitMQ server, both projects must add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1521.1">RabbitMQ.Client</span></code><span class="koboSpan" id="kobo.1522.1"> NuGet package.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1523.1">Finally, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1524.1">FakeSource</span></code><span class="koboSpan" id="kobo.1525.1"> also adds the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1526.1">Polly</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.1527.1">NuGet</span></code><span class="koboSpan" id="kobo.1528.1"> package because we will use Polly to define reliable communication strategies.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1529.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1530.1">ExecuteAsync</span></code><span class="koboSpan" id="kobo.1531.1"> method of the client project is a little bit different:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1532.1">protected</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1533.1">override</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1534.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1535.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.1536.1">ExecuteAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1537.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1538.1">CancellationToken stoppingToken</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1539.1">)</span></span><span class="koboSpan" id="kobo.1540.1">
{
    Random random = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1541.1">new</span></span><span class="koboSpan" id="kobo.1542.1"> Random();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1543.1">var</span></span><span class="koboSpan" id="kobo.1544.1"> factory = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1545.1">new</span></span><span class="koboSpan" id="kobo.1546.1"> ConnectionFactory{ HostName = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1547.1">"localhost"</span></span><span class="koboSpan" id="kobo.1548.1"> };
    IConnection? </span><span class="koboSpan" id="kobo.1548.2">connection =</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1549.1">null</span></span><span class="koboSpan" id="kobo.1550.1">;
    IModel? </span><span class="koboSpan" id="kobo.1550.2">channel = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1551.1">null</span></span><span class="koboSpan" id="kobo.1552.1">;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1553.1">try</span></span><span class="koboSpan" id="kobo.1554.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1555.1">while</span></span><span class="koboSpan" id="kobo.1556.1"> (!stoppingToken.IsCancellationRequested)
        {
        ...      
        </span><span class="koboSpan" id="kobo.1556.2">}
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1557.1">finally</span></span><span class="koboSpan" id="kobo.1558.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1559.1">if</span></span><span class="koboSpan" id="kobo.1560.1"> (connection != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1561.1">null</span></span><span class="koboSpan" id="kobo.1562.1">)
        {
            channel.Dispose();
            connection.Dispose();
            channel = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1563.1">null</span></span><span class="koboSpan" id="kobo.1564.1">;
            connection = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1565.1">null</span></span><span class="koboSpan" id="kobo.1566.1">;
        }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1567.1">Communication requires the creation of a connection factory, then the creation factory generates a connection, and the connection generates a channel. </span><span class="koboSpan" id="kobo.1567.2">The connection factory is created outside of the main loop since it can be reused several times, and it is not invalidated by </span><a id="_idIndexMarker1624"/><span class="koboSpan" id="kobo.1568.1">communication errors.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1569.1">For the connection and channel, outside of the main loop, we just define the variables and where to place them since they are invalidated in the case of communication exceptions, so we must dispose of them and recreate them from scratch after each exception.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1570.1">The main loop is enclosed in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1571.1">try</span></code><span class="koboSpan" id="kobo.1572.1">/</span><code class="inlineCode"><span class="koboSpan" id="kobo.1573.1">finally</span></code><span class="koboSpan" id="kobo.1574.1"> to ensure that any channel/connection pair is disposed of before leaving the method.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1575.1">Inside the main loop, as a first step, we create the purchase message:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1576.1">var</span></span><span class="koboSpan" id="kobo.1577.1"> purchaseDay = DateTime.UtcNow.Date;
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1578.1">//randomize a little bit purchase day</span></span><span class="koboSpan" id="kobo.1579.1">
purchaseDay = purchaseDay.AddDays(random.Next(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1580.1">0</span></span><span class="koboSpan" id="kobo.1581.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1582.1">3</span></span><span class="koboSpan" id="kobo.1583.1">) – </span><span class="hljs-number"><span class="koboSpan" id="kobo.1584.1">1</span></span><span class="koboSpan" id="kobo.1585.1">);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1586.1">var</span></span><span class="koboSpan" id="kobo.1587.1"> purchase = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1588.1">new</span></span><span class="koboSpan" id="kobo.1589.1"> PurchaseMessage
{
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1590.1">//message time</span></span><span class="koboSpan" id="kobo.1591.1">
    PurchaseTime = Timestamp.FromDateTime(purchaseDay),
    Time = Timestamp.FromDateTime(DateTime.UtcNow),
    Id = Guid.NewGuid().ToString(),
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1592.1">//add random location</span></span><span class="koboSpan" id="kobo.1593.1">
    Location = locations[random.Next(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1594.1">0</span></span><span class="koboSpan" id="kobo.1595.1">, locations.Length)],
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1596.1">//add random cost</span></span><span class="koboSpan" id="kobo.1597.1">
    Cost = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1598.1">200</span></span><span class="koboSpan" id="kobo.1599.1"> * random.Next(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1600.1">1</span></span><span class="koboSpan" id="kobo.1601.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1602.1">4</span></span><span class="koboSpan" id="kobo.1603.1">)
};
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1604.1">Then, the message is serialized:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.1605.1">byte</span></span><span class="koboSpan" id="kobo.1606.1">[]? </span><span class="koboSpan" id="kobo.1606.2">body = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1607.1">null</span></span><span class="koboSpan" id="kobo.1608.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1609.1">using</span></span><span class="koboSpan" id="kobo.1610.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1611.1">var</span></span><span class="koboSpan" id="kobo.1612.1"> stream = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1613.1">new</span></span><span class="koboSpan" id="kobo.1614.1"> MemoryStream())
{
    purchase.WriteTo(stream);
    stream.Flush();
    body = stream.ToArray();
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1615.1">Before executing the </span><a id="_idIndexMarker1625"/><span class="koboSpan" id="kobo.1616.1">communication, we define a Polly policy:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1617.1">var</span></span><span class="koboSpan" id="kobo.1618.1"> policy = Policy
    .Handle&lt;Exception&gt;()
    .WaitAndRetry(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1619.1">6</span></span><span class="koboSpan" id="kobo.1620.1">,
        retryAttempt =&gt; TimeSpan.FromSeconds(Math.Pow(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1621.1">2</span></span><span class="koboSpan" id="kobo.1622.1">,
        retryAttempt)));
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1623.1">The above policy is an exponential retry, which, in the case of an exception, waits for an exponentially growing amount of time. </span><span class="koboSpan" id="kobo.1623.2">So, if six attempts are made, then the second attempt is made after 2 seconds, the third after 4 seconds, the fourth after 8 seconds, and so on. </span><span class="koboSpan" id="kobo.1623.3">If all attempts fail, the exception is rethrown and causes the message to be lost. </span><span class="koboSpan" id="kobo.1623.4">If it’s important that messages can’t be lost, we can combine this strategy with a circuit break strategy (see </span><em class="italic"><span class="koboSpan" id="kobo.1624.1">Resilient task execution</span></em><span class="koboSpan" id="kobo.1625.1"> in </span><em class="italic"><span class="koboSpan" id="kobo.1626.1">Chapter 11</span></em><span class="koboSpan" id="kobo.1627.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1628.1">Applying a Microservice Architecture to Your Enterprise Application</span></em><span class="koboSpan" id="kobo.1629.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1630.1">Once we have defined the retry policy, we can execute all the communication steps in the context of this policy:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1631.1">policy.Execute(() =&gt;
{
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1632.1">try</span></span><span class="koboSpan" id="kobo.1633.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1634.1">if</span></span><span class="koboSpan" id="kobo.1635.1">(connection == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1636.1">null</span></span><span class="koboSpan" id="kobo.1637.1"> || channel == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1638.1">null</span></span><span class="koboSpan" id="kobo.1639.1">)
    {
        connection = factory.CreateConnection();
        channel = connection.CreateModel();
        channel.ConfirmSelect();
    }
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1640.1">//actual communication here</span></span><span class="koboSpan" id="kobo.1641.1">
    ...
    </span><span class="koboSpan" id="kobo.1641.2">...
</span><span class="koboSpan" id="kobo.1641.3">}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1642.1">catch</span></span><span class="koboSpan" id="kobo.1643.1">
{
    channel.Dispose();
    connection.Dispose();
    channel = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1644.1">null</span></span><span class="koboSpan" id="kobo.1645.1">;
    connection = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1646.1">null</span></span><span class="koboSpan" id="kobo.1647.1">;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1648.1">throw</span></span><span class="koboSpan" id="kobo.1649.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1650.1">If there are no valid connections or channels, they are created. </span><code class="inlineCode"><span class="koboSpan" id="kobo.1651.1">channel.ConfirmSelect()</span></code><span class="koboSpan" id="kobo.1652.1"> declares that we need confirmation that the message was safely received and stored on </span><a id="_idIndexMarker1626"/><span class="koboSpan" id="kobo.1653.1">disk. </span><span class="koboSpan" id="kobo.1653.2">In the case that an exception is thrown, both the channel and the connection are disposed of, since they might have been corrupted by the exception. </span><span class="koboSpan" id="kobo.1653.3">This way, the next communication attempt will use fresh communication and a new channel. </span><span class="koboSpan" id="kobo.1653.4">After the disposal, the exception is rethrown so it can be handled by the Polly policy.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1654.1">Finally, here are the actual communication steps:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1655.1">First of all, if the queue doesn’t already exist, it is created. </span><span class="koboSpan" id="kobo.1655.2">The queue is created as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1656.1">durable</span></code><span class="koboSpan" id="kobo.1657.1">; that is, it must be stored on disk and not be </span><code class="inlineCode"><span class="koboSpan" id="kobo.1658.1">exclusive</span></code><span class="koboSpan" id="kobo.1659.1"> so that several servers can extract messages from the queue in parallel:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1660.1">channel.QueueDeclare(queue: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1661.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1662.1">purchase_queue"</span></span><span class="koboSpan" id="kobo.1663.1">,
    durable: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1664.1">true</span></span><span class="koboSpan" id="kobo.1665.1">,
    exclusive: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1666.1">false</span></span><span class="koboSpan" id="kobo.1667.1">,
    autoDelete: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1668.1">false</span></span><span class="koboSpan" id="kobo.1669.1">,
   arguments: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1670.1">null</span></span><span class="koboSpan" id="kobo.1671.1">);
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1672.1">Then, each message is declared as persistent; that is, it must be stored on disk:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1673.1">var</span></span><span class="koboSpan" id="kobo.1674.1"> properties = channel.CreateBasicProperties();
properties.Persistent = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1675.1">true</span></span><span class="koboSpan" id="kobo.1676.1">;
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1677.1">Finally, the message is sent through the default exchange, which sends it to a specific named queue:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1678.1">channel.BasicPublish(exchange: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1679.1">""</span></span><span class="koboSpan" id="kobo.1680.1">,
        routingKey: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1681.1">"purchase_queue"</span></span><span class="koboSpan" id="kobo.1682.1">,
        basicProperties: properties,
        body: body);
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1683.1">As a final step, we wait until the message is safely stored on disk:
        </span><pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1684.1">channel.WaitForConfirmsOrDie(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1685.1">new</span></span><span class="koboSpan" id="kobo.1686.1"> TimeSpan(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1687.1">0</span></span><span class="koboSpan" id="kobo.1688.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1689.1">0</span></span><span class="koboSpan" id="kobo.1690.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1691.1">5</span></span><span class="koboSpan" id="kobo.1692.1">));
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1693.1">If a confirmation doesn’t arrive within the specified timeout, an exception is thrown that triggers the Polly retry policy. </span><span class="koboSpan" id="kobo.1693.2">When messages are taken from a local database queue, we can also use a non-blocking confirmation that triggers the removal of the message from the local queue.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1694.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1695.1">ExecuteAsync</span></code><span class="koboSpan" id="kobo.1696.1"> method </span><a id="_idIndexMarker1627"/><span class="koboSpan" id="kobo.1697.1">of the server-hosted process is defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1698.1">HostedServices/ProcessPurchase.cs</span></code><span class="koboSpan" id="kobo.1699.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1700.1">protected</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1701.1">override</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1702.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1703.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.1704.1">ExecuteAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1705.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1706.1">CancellationToken stoppingToken</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1707.1">)</span></span><span class="koboSpan" id="kobo.1708.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1709.1">while</span></span><span class="koboSpan" id="kobo.1710.1"> (!stoppingToken.IsCancellationRequested)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1711.1">try</span></span><span class="koboSpan" id="kobo.1712.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1713.1">var</span></span><span class="koboSpan" id="kobo.1714.1"> factory = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1715.1">new</span></span><span class="koboSpan" id="kobo.1716.1"> ConnectionFactory() { HostName = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1717.1">"localhost"</span></span><span class="koboSpan" id="kobo.1718.1"> };
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1719.1">using</span></span><span class="koboSpan" id="kobo.1720.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1721.1">var</span></span><span class="koboSpan" id="kobo.1722.1"> connection = factory.CreateConnection())
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1723.1">using</span></span><span class="koboSpan" id="kobo.1724.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1725.1">var</span></span><span class="koboSpan" id="kobo.1726.1"> channel = connection.CreateModel())
            {
                channel.QueueDeclare(queue: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1727.1">"purchase_queue"</span></span><span class="koboSpan" id="kobo.1728.1">,
                                     durable: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1729.1">true</span></span><span class="koboSpan" id="kobo.1730.1">,
                                     exclusive: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1731.1">false</span></span><span class="koboSpan" id="kobo.1732.1">,
                                     autoDelete: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1733.1">false</span></span><span class="koboSpan" id="kobo.1734.1">,
                                     arguments: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1735.1">null</span></span><span class="koboSpan" id="kobo.1736.1">);
                channel.BasicQos(prefetchSize: </span><span class="hljs-number"><span class="koboSpan" id="kobo.1737.1">0</span></span><span class="koboSpan" id="kobo.1738.1">, prefetchCount: </span><span class="hljs-number"><span class="koboSpan" id="kobo.1739.1">1</span></span><span class="koboSpan" id="kobo.1740.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1741.1">global</span></span><span class="koboSpan" id="kobo.1742.1">: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1743.1">false</span></span><span class="koboSpan" id="kobo.1744.1">);
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1745.1">var</span></span><span class="koboSpan" id="kobo.1746.1"> consumer = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1747.1">new</span></span><span class="koboSpan" id="kobo.1748.1"> EventingBasicConsumer(channel);
                consumer.Received += </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1749.1">async</span></span><span class="koboSpan" id="kobo.1750.1"> (sender, ea) =&gt;
                {
                    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1751.1">// Message received even handler</span></span><span class="koboSpan" id="kobo.1752.1">
                    ...
                </span><span class="koboSpan" id="kobo.1752.2">};
                channel.BasicConsume(queue: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1753.1">"purchase_queue"</span></span><span class="koboSpan" id="kobo.1754.1">,
                            autoAck: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1755.1">false</span></span><span class="koboSpan" id="kobo.1756.1">,
                            consumer: consumer);
                 </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1757.1">await</span></span><span class="koboSpan" id="kobo.1758.1"> Task.Delay(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1759.1">1000</span></span><span class="koboSpan" id="kobo.1760.1">, stoppingToken);
            }
         }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1761.1">catch</span></span><span class="koboSpan" id="kobo.1762.1"> { }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1763.1">Inside the main loop, if an exception is thrown, it is intercepted by the empty </span><code class="inlineCode"><span class="koboSpan" id="kobo.1764.1">catch</span></code><span class="koboSpan" id="kobo.1765.1">. </span><span class="koboSpan" id="kobo.1765.2">Since the two </span><code class="inlineCode"><span class="koboSpan" id="kobo.1766.1">using</span></code><span class="koboSpan" id="kobo.1767.1"> statements are left, both the connection and channel are disposed of. </span><span class="koboSpan" id="kobo.1767.2">Therefore, after the exception, a new loop is executed that creates a new fresh connection and a new channel.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1768.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1769.1">using</span></code><span class="koboSpan" id="kobo.1770.1"> statement body, we ensure that our queue exists, and then set </span><code class="inlineCode"><span class="koboSpan" id="kobo.1771.1">prefetch</span></code><span class="koboSpan" id="kobo.1772.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1773.1">1</span></code><span class="koboSpan" id="kobo.1774.1">. </span><span class="koboSpan" id="kobo.1774.2">This means that each server </span><a id="_idIndexMarker1628"/><span class="koboSpan" id="kobo.1775.1">must extract just one message at a time, which ensures a fair distribution of the load among all servers. </span><span class="koboSpan" id="kobo.1775.2">However, setting </span><code class="inlineCode"><span class="koboSpan" id="kobo.1776.1">prefetch</span></code><span class="koboSpan" id="kobo.1777.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1778.1">1</span></code><span class="koboSpan" id="kobo.1779.1"> might not be convenient when servers are based on several parallel threads since it sacrifices thread usage optimization in favor of fair distribution among servers. </span><span class="koboSpan" id="kobo.1779.2">As a consequence, threads that could successfully process further messages (after the first) might remain idle.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1780.1">Then, we define a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1781.1">message received</span></code><span class="koboSpan" id="kobo.1782.1"> event handler. </span><code class="inlineCode"><span class="koboSpan" id="kobo.1783.1">BasicConsume</span></code><span class="koboSpan" id="kobo.1784.1"> starts the actual message reception. </span><span class="koboSpan" id="kobo.1784.2">With </span><code class="inlineCode"><span class="koboSpan" id="kobo.1785.1">autoAck</span></code><span class="koboSpan" id="kobo.1786.1"> set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1787.1">false</span></code><span class="koboSpan" id="kobo.1788.1">, when a message is read from the queue, it is not removed but just blocked so it is not available to other servers that read from the same queue. </span><span class="koboSpan" id="kobo.1788.2">The message is actually removed when a confirmation that it has been successfully processed is sent to RabbitMQ. </span><span class="koboSpan" id="kobo.1788.3">We can also send a failure confirmation, in which case, the message is unblocked and becomes available for processing again.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1789.1">If no confirmation is received, the message remains blocked till the connection and channel are disposed of.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.1790.1">BasicConsume</span></code><span class="koboSpan" id="kobo.1791.1"> is non-blocking, so the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1792.1">Task.Delay</span></code><span class="koboSpan" id="kobo.1793.1"> after it blocks till the cancelation token is signaled. </span><span class="koboSpan" id="kobo.1793.2">In any case, after 1 second, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1794.1">Task.Delay</span></code><span class="koboSpan" id="kobo.1795.1"> unblocks and both the connection and the channel are replaced with fresh ones. </span><span class="koboSpan" id="kobo.1795.2">This prevents non-confirmed messages from remaining blocked forever.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1796.1">Let’s move on to the code inside the </span><em class="italic"><span class="koboSpan" id="kobo.1797.1">message received</span></em><span class="koboSpan" id="kobo.1798.1"> event. </span><span class="koboSpan" id="kobo.1798.2">This is the place where the actual message processing takes place.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1799.1">As a first step, the code verifies if the application is being shut down, in which case it disposes of the channel</span><a id="_idIndexMarker1629"/><span class="koboSpan" id="kobo.1800.1"> and connection and returns without performing any further operations:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1801.1">if</span></span><span class="koboSpan" id="kobo.1802.1"> (stoppingToken.IsCancellationRequested)
{
    channel.Close();
    connection.Close();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1803.1">return</span></span><span class="koboSpan" id="kobo.1804.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1805.1">Then, a session scope is created to access all session-scoped dependency injection services:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1806.1">using</span></span><span class="koboSpan" id="kobo.1807.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1808.1">var</span></span><span class="koboSpan" id="kobo.1809.1"> scope = services.CreateScope())
{
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1810.1">try</span></span><span class="koboSpan" id="kobo.1811.1">
  {
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1812.1">// actual message processing</span></span><span class="koboSpan" id="kobo.1813.1">
  ...
  </span><span class="koboSpan" id="kobo.1813.2">}
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1814.1">catch</span></span><span class="koboSpan" id="kobo.1815.1"> {
    ((EventingBasicConsumer)sender).Model.BasicNack(ea.DeliveryTag, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1816.1">false</span></span><span class="koboSpan" id="kobo.1817.1">, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1818.1">true</span></span><span class="koboSpan" id="kobo.1819.1">);
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1820.1">When an exception is thrown during the message processing, a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1821.1">Nack</span></code><span class="koboSpan" id="kobo.1822.1"> message is sent to RabbitMQ to inform it that the message processing failed. </span><code class="inlineCode"><span class="koboSpan" id="kobo.1823.1">ea.DeliveryTag</span></code><span class="koboSpan" id="kobo.1824.1"> is a tag that uniquely identifies the message. </span><span class="koboSpan" id="kobo.1824.2">The second argument set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1825.1">false</span></code><span class="koboSpan" id="kobo.1826.1"> informs RabbitMQ that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1827.1">Nack</span></code><span class="koboSpan" id="kobo.1828.1"> is just for the message identified by </span><code class="inlineCode"><span class="koboSpan" id="kobo.1829.1">ea.DeliveryTag</span></code><span class="koboSpan" id="kobo.1830.1"> that doesn’t also involve all other messages waiting for confirmation from this server. </span><span class="koboSpan" id="kobo.1830.2">Finally, the last argument set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1831.1">true</span></code><span class="koboSpan" id="kobo.1832.1"> asks RabbitMQ to requeue the message whose processing failed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1833.1">Inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1834.1">try</span></code><span class="koboSpan" id="kobo.1835.1"> block, we get an instance of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1836.1">IDayStatistics</span></code><span class="koboSpan" id="kobo.1837.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1838.1">IDayStatistics statistics = scope.ServiceProvider
    .GetRequiredService&lt;IDayStatistics&gt;();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1839.1">Then, we deserialize the message body to get a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1840.1">PurchaseMessage</span></code><span class="koboSpan" id="kobo.1841.1"> instance and add it to the database:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1842.1">var</span></span><span class="koboSpan" id="kobo.1843.1"> body = ea.Body.ToArray();
PurchaseMessage? </span><span class="koboSpan" id="kobo.1843.2">message = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1844.1">null</span></span><span class="koboSpan" id="kobo.1845.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1846.1">using</span></span><span class="koboSpan" id="kobo.1847.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1848.1">var</span></span><span class="koboSpan" id="kobo.1849.1"> stream = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1850.1">new</span></span><span class="koboSpan" id="kobo.1851.1"> MemoryStream(body))
{
    message = PurchaseMessage.Parser.ParseFrom(stream);
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1852.1">var</span></span><span class="koboSpan" id="kobo.1853.1"> res = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1854.1">await</span></span><span class="koboSpan" id="kobo.1855.1"> statistics.Add(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1856.1">new</span></span><span class="koboSpan" id="kobo.1857.1"> Purchase {
    Cost= message.Cost,
    Id= Guid.Parse(message.Id),
    Location = message.Location,
    Time = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1858.1">new</span></span><span class="koboSpan" id="kobo.1859.1"> DateTimeOffset(message.Time.ToDateTime(), TimeSpan.Zero),
    PurchaseTime = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1860.1">new</span></span><span class="koboSpan" id="kobo.1861.1"> DateTimeOffset(message.PurchaseTime.ToDateTime(), TimeSpan.Zero)
});
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1862.1">If the operation</span><a id="_idIndexMarker1630"/><span class="koboSpan" id="kobo.1863.1"> fails, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1864.1">Add</span></code><span class="koboSpan" id="kobo.1865.1"> operation returns </span><code class="inlineCode"><span class="koboSpan" id="kobo.1866.1">null</span></code><span class="koboSpan" id="kobo.1867.1">, so we must send a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1868.1">Nack</span></code><span class="koboSpan" id="kobo.1869.1">; otherwise, we must send an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1870.1">Ack</span></code><span class="koboSpan" id="kobo.1871.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1872.1">if</span></span><span class="koboSpan" id="kobo.1873.1">(res != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1874.1">null</span></span><span class="koboSpan" id="kobo.1875.1">)
    ((EventingBasicConsumer)sender).Model
        .BasicAck(ea.DeliveryTag, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1876.1">false</span></span><span class="koboSpan" id="kobo.1877.1">);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1878.1">else</span></span><span class="koboSpan" id="kobo.1879.1">
    ((EventingBasicConsumer)sender).Model
        .BasicNack(ea.DeliveryTag, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1880.1">false</span></span><span class="koboSpan" id="kobo.1881.1">, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1882.1">true</span></span><span class="koboSpan" id="kobo.1883.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1884.1">That’s all! </span><span class="koboSpan" id="kobo.1884.2">The full code is in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1885.1">GrpcMicroServiceRabbitProto</span></code><span class="koboSpan" id="kobo.1886.1"> subfolder of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1887.1">ch15</span></code><span class="koboSpan" id="kobo.1888.1"> folder in the GitHub repository of this book. </span><span class="koboSpan" id="kobo.1888.2">You can test the code by setting both the client and server projects as the start project and running the solution. </span><span class="koboSpan" id="kobo.1888.3">After 1–2 minutes, the database should be populated with new purchases and new daily totals. </span><span class="koboSpan" id="kobo.1888.4">In a staging/production environment, you can run several copies of both the client and server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1889.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1890.1">GrpcMicroServiceRabbit</span></code><span class="koboSpan" id="kobo.1891.1"> subfolder in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1892.1">ch15</span></code><span class="koboSpan" id="kobo.1893.1"> folder of the GitHub repository contains another version of the same application that uses the </span><em class="italic"><span class="koboSpan" id="kobo.1894.1">Binaron</span></em><span class="koboSpan" id="kobo.1895.1"> NuGet package for serialization. </span><span class="koboSpan" id="kobo.1895.2">It is faster than ProtoBuf, but being .NET-specific, it is not interoperable. </span><span class="koboSpan" id="kobo.1895.3">Moreover, it has no features to facilitate message versioning. </span><span class="koboSpan" id="kobo.1895.4">It is useful when performance is critical and versioning and interoperability are not a priority.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1896.1">The </span><em class="italic"><span class="koboSpan" id="kobo.1897.1">Binaron</span></em><span class="koboSpan" id="kobo.1898.1"> version differs in that it has no </span><code class="inlineCode"><span class="koboSpan" id="kobo.1899.1">.proto</span></code><span class="koboSpan" id="kobo.1900.1"> files or other ProtoBuf stuff, but it explicitly defines a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1901.1">PurchaseMessage</span></code><span class="koboSpan" id="kobo.1902.1"> .NET class. </span><span class="koboSpan" id="kobo.1902.2">Moreover, ProtoBuf serialization and deserialization instructions are replaced by the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.1903.1">byte</span></span><span class="koboSpan" id="kobo.1904.1">[]? </span><span class="koboSpan" id="kobo.1904.2">body = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1905.1">null</span></span><span class="koboSpan" id="kobo.1906.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1907.1">using</span></span><span class="koboSpan" id="kobo.1908.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1909.1">var</span></span><span class="koboSpan" id="kobo.1910.1"> stream = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1911.1">new</span></span><span class="koboSpan" id="kobo.1912.1"> MemoryStream())
{
    BinaronConvert.Serialize(purchase, stream);
    stream.Flush();
    body = stream.ToArray();
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1913.1">Together with:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1914.1">PurchaseMessage? </span><span class="koboSpan" id="kobo.1914.2">message = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1915.1">null</span></span><span class="koboSpan" id="kobo.1916.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1917.1">using</span></span><span class="koboSpan" id="kobo.1918.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1919.1">var</span></span><span class="koboSpan" id="kobo.1920.1"> stream = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1921.1">new</span></span><span class="koboSpan" id="kobo.1922.1"> MemoryStream(body))
{
    message = BinaronConvert.Deserialize&lt;PurchaseMessage&gt;(stream);
}.
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1923.1">Now that we have</span><a id="_idIndexMarker1631"/><span class="koboSpan" id="kobo.1924.1"> created a microservice connected to a message broker, it is also important to learn how to expose packages from WWTravelClub using web APIs. </span><span class="koboSpan" id="kobo.1924.2">Let’s see this in the next section.</span></p>
<h1 class="heading-1" id="_idParaDest-452"><span class="koboSpan" id="kobo.1925.1">Exposing WWTravelClub packages using Web APIs</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1926.1">In this section, we will implement an ASP.NET REST service that lists all the packages that are available for a given</span><a id="_idIndexMarker1632"/><span class="koboSpan" id="kobo.1927.1"> vacation’s start and end dates. </span><span class="koboSpan" id="kobo.1927.2">For </span><a id="_idIndexMarker1633"/><span class="koboSpan" id="kobo.1928.1">didactic purposes, we will not structure the application according to the best practices we have described previously; instead, we will simply generate the results with a LINQ query that will be directly placed in the controller action method. </span><span class="koboSpan" id="kobo.1928.2">A well-structured ASP.NET Core application has been presented in </span><em class="italic"><span class="koboSpan" id="kobo.1929.1">Chapter 18</span></em><span class="koboSpan" id="kobo.1930.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1931.1">Implementing Frontend Microservices with ASP.NET Core</span></em><span class="koboSpan" id="kobo.1932.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1933.1">Let us make a copy of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1934.1">WWTravelClubDB</span></code><span class="koboSpan" id="kobo.1935.1"> solution folder and rename the new folder </span><code class="inlineCode"><span class="koboSpan" id="kobo.1936.1">WWTravelClubWebAPI80</span></code><span class="koboSpan" id="kobo.1937.1">. </span><span class="koboSpan" id="kobo.1937.2">The WWTravelClubDB project was built step by step in the various sections of </span><em class="italic"><span class="koboSpan" id="kobo.1938.1">Chapter 13</span></em><span class="koboSpan" id="kobo.1939.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1940.1">Interacting with Data in C# – Entity Framework Core</span></em><span class="koboSpan" id="kobo.1941.1">. </span><span class="koboSpan" id="kobo.1941.2">Let us open the new solution and add a new ASP.NET Core API project to it named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1942.1">WWTravelClubWebAPI80</span></code><span class="koboSpan" id="kobo.1943.1"> (the same name as the new solution folder). </span><span class="koboSpan" id="kobo.1943.2">For simplicity, select </span><strong class="keyWord"><span class="koboSpan" id="kobo.1944.1">No Authentication</span></strong><span class="koboSpan" id="kobo.1945.1">. </span><span class="koboSpan" id="kobo.1945.2">Right-click on the newly created project and select </span><strong class="keyWord"><span class="koboSpan" id="kobo.1946.1">Set as StartUp project</span></strong><span class="koboSpan" id="kobo.1947.1"> to make it the default project that is launched when the solution is run.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1948.1">Finally, we need to add a reference to the WWTravelClubDB project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1949.1">ASP.NET Core projects store configuration constants in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1950.1">appsettings.json</span></code><span class="koboSpan" id="kobo.1951.1"> file. </span><span class="koboSpan" id="kobo.1951.2">Let’s open this file and add the database connection string for the database we created in the WWTravelClubDB</span><a id="_idIndexMarker1634"/><span class="koboSpan" id="kobo.1952.1"> project to it, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1953.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1954.1">"</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1955.1">ConnectionStrings"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1956.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.1957.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1958.1">"DefaultConnection"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1959.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1960.1">"Server=</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1961.1">   (localdb)\\mssqllocaldb;Database=wwtravelclub;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1962.1">Trusted_Connection=True;MultipleActiveResultSets=true"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.1963.1">},</span></span><span class="koboSpan" id="kobo.1964.1">
    ...
    </span><span class="koboSpan" id="kobo.1964.2">...
</span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1965.1">}</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1966.1">Now, we must add the </span><a id="_idIndexMarker1635"/><span class="koboSpan" id="kobo.1967.1">WWTravelClubDB entity framework database context to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1968.1">Program.cs</span></code><span class="koboSpan" id="kobo.1969.1">, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1970.1">builder.Services.AddDbContext&lt;WWTravelClubDB.MainDBContext&gt;(options =&gt;
options.UseSqlServer(
builder.Configuration.GetConnectionString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1971.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1972.1">DefaultConnection"</span></span><span class="koboSpan" id="kobo.1973.1">),
            b =&gt;b.MigrationsAssembly(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1974.1">"WWTravelClubDB"</span></span><span class="koboSpan" id="kobo.1975.1">)))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1976.1">The option object settings that are passed to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1977.1">AddDbContext</span></code><span class="koboSpan" id="kobo.1978.1"> specify the usage of SQL Server with a connection string that is extracted from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1979.1">ConnectionStrings</span></code><span class="koboSpan" id="kobo.1980.1"> section of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1981.1">appsettings.json</span></code><span class="koboSpan" id="kobo.1982.1"> configuration file with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1983.1">Configuration.GetConnectionString("DefaultConnection")</span></code><span class="koboSpan" id="kobo.1984.1"> method. </span><span class="koboSpan" id="kobo.1984.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1985.1">b =&gt;b.MigrationsAssembly("WWTravelClubDB")</span></code><span class="koboSpan" id="kobo.1986.1"> lambda function declares the name of the assembly that contains the database migrations (see </span><em class="italic"><span class="koboSpan" id="kobo.1987.1">Chapter 13</span></em><span class="koboSpan" id="kobo.1988.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1989.1">Interacting with Data in C# – Entity Framework Core</span></em><span class="koboSpan" id="kobo.1990.1">), which, in our case, is the DLL that was generated by the WWTravelClubDB project. </span><span class="koboSpan" id="kobo.1990.2">For the preceding code to compile, you should add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1991.1">Microsoft.EntityFrameworkCore</span></code><span class="koboSpan" id="kobo.1992.1"> namespace.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1993.1">Since we want to enrich our REST service with OpenAPI documentation, let’s add a reference to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1994.1">Swashbuckle.AspNetCore</span></code><span class="koboSpan" id="kobo.1995.1"> NuGet package. </span><span class="koboSpan" id="kobo.1995.2">Now, we can add the following very basic configuration to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1996.1">Program.cs</span></code><span class="koboSpan" id="kobo.1997.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1998.1">var</span></span><span class="koboSpan" id="kobo.1999.1"> builder = WebApplication.CreateBuilder(args);
...
</span><span class="koboSpan" id="kobo.1999.2">builder.Services.AddSwaggerGen(c =&gt;
{
    c.SwaggerDoc(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2000.1">"v2"</span></span><span class="koboSpan" id="kobo.2001.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2002.1">new</span></span><span class="koboSpan" id="kobo.2003.1">() { Title = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2004.1">"WWTravelClub REST API - .NET 8"</span></span><span class="koboSpan" id="kobo.2005.1">, Version = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2006.1">"v2"</span></span><span class="koboSpan" id="kobo.2007.1"> });
});
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2008.1">var</span></span><span class="koboSpan" id="kobo.2009.1"> app = builder.Build();
...
</span><span class="koboSpan" id="kobo.2009.2">app.UseSwagger();
app.UseSwaggerUI(c =&gt; c.SwaggerEndpoint(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2010.1">"/swagger/v2/swagger.json"</span></span><span class="koboSpan" id="kobo.2011.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2012.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2013.1">WWTravelClub REST API - .NET 8"</span></span><span class="koboSpan" id="kobo.2014.1">));
...
</span><span class="koboSpan" id="kobo.2014.2">app.Run();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2015.1">Now, we are ready to encode </span><a id="_idIndexMarker1636"/><span class="koboSpan" id="kobo.2016.1">our service. </span><span class="koboSpan" id="kobo.2016.2">Let’s delete </span><code class="inlineCode"><span class="koboSpan" id="kobo.2017.1">WeatherForecastController</span></code><span class="koboSpan" id="kobo.2018.1">, which is automatically</span><a id="_idIndexMarker1637"/><span class="koboSpan" id="kobo.2019.1"> scaffolded by Visual Studio. </span><span class="koboSpan" id="kobo.2019.2">Then, right-click on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2020.1">Controllers</span></code><span class="koboSpan" id="kobo.2021.1"> folder and select </span><strong class="screenText"><span class="koboSpan" id="kobo.2022.1">Add | Controller</span></strong><span class="koboSpan" id="kobo.2023.1">. </span><span class="koboSpan" id="kobo.2023.2">Now, choose an empty API controller called </span><code class="inlineCode"><span class="koboSpan" id="kobo.2024.1">PackagesController</span></code><span class="koboSpan" id="kobo.2025.1">. </span><span class="koboSpan" id="kobo.2025.2">First, let’s modify the code as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2026.1">[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2027.1">Route(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2028.1">"api/packages"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.2029.1">)</span></span><span class="koboSpan" id="kobo.2030.1">]
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2031.1">ApiController</span></span><span class="koboSpan" id="kobo.2032.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2033.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2034.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2035.1">PackagesController</span></span><span class="koboSpan" id="kobo.2036.1"> : </span><span class="hljs-title"><span class="koboSpan" id="kobo.2037.1">ControllerBase</span></span><span class="koboSpan" id="kobo.2038.1">
{
    [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2039.1">HttpGet(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2040.1">"bydate/{start}/{stop}"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.2041.1">)</span></span><span class="koboSpan" id="kobo.2042.1">]
    [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2043.1">ProducesResponseType(typeof(IEnumerable&lt;PackagesListDTO&gt;), 200)</span></span><span class="koboSpan" id="kobo.2044.1">]
    [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2045.1">ProducesResponseType(400)</span></span><span class="koboSpan" id="kobo.2046.1">]
    [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2047.1">ProducesResponseType(500)</span></span><span class="koboSpan" id="kobo.2048.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2049.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2050.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2051.1"> Task&lt;IActionResult&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.2052.1">GetPackagesByDate</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2053.1">(</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.2054.1">        [FromServices] WWTravelClubDB.MainDBContext ctx,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.2055.1">        DateTime start, DateTime stop</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2056.1">)</span></span><span class="koboSpan" id="kobo.2057.1">
    {
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2058.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2059.1">Route</span></code><span class="koboSpan" id="kobo.2060.1"> attribute declares that the basic path for our service will be </span><code class="inlineCode"><span class="koboSpan" id="kobo.2061.1">api/packages</span></code><span class="koboSpan" id="kobo.2062.1">. </span><span class="koboSpan" id="kobo.2062.2">The unique action method that we implement is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2063.1">GetPackagesByDate</span></code><span class="koboSpan" id="kobo.2064.1">, which is invoked on </span><code class="inlineCode"><span class="koboSpan" id="kobo.2065.1">HttpGet</span></code><span class="koboSpan" id="kobo.2066.1"> requests on paths of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2067.1">bydate/{start}/{stop}</span></code><span class="koboSpan" id="kobo.2068.1"> type, where </span><code class="inlineCode"><span class="koboSpan" id="kobo.2069.1">start</span></code><span class="koboSpan" id="kobo.2070.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2071.1">stop</span></code><span class="koboSpan" id="kobo.2072.1"> are the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2073.1">DateTime</span></code><span class="koboSpan" id="kobo.2074.1"> parameters that are passed as input to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2075.1">GetPackagesByDate</span></code><span class="koboSpan" id="kobo.2076.1">. </span><span class="koboSpan" id="kobo.2076.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2077.1">ProduceResponseType</span></code><span class="koboSpan" id="kobo.2078.1"> attributes declare the following:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2079.1">When a request is successful, a 200 code is returned, and the body contains an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2080.1">IEnumerable</span></code><span class="koboSpan" id="kobo.2081.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2082.1">PackagesListDTO</span></code><span class="koboSpan" id="kobo.2083.1"> type (which we will soon define) containing the required package information.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2084.1">When the request is ill formed, a 400 code is returned. </span><span class="koboSpan" id="kobo.2084.2">We don’t specify the type returned since bad requests are automatically handled by the ASP.NET Core framework </span><a id="_idIndexMarker1638"/><span class="koboSpan" id="kobo.2085.1">through the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2086.1">ApiController</span></code><span class="koboSpan" id="kobo.2087.1"> attribute.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2088.1">In the case of </span><a id="_idIndexMarker1639"/><span class="koboSpan" id="kobo.2089.1">unexpected errors, a 500 code is returned with the exception error message.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2090.1">Now, let’s define the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2091.1">PackagesListDTO</span></code><span class="koboSpan" id="kobo.2092.1"> class in a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.2093.1">DTOs</span></code><span class="koboSpan" id="kobo.2094.1"> folder:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2095.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2096.1">WWTravelClubWebAPI80.DTOs</span></span><span class="koboSpan" id="kobo.2097.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2098.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2099.1">record</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2100.1">PackagesListDTO</span></span><span class="koboSpan" id="kobo.2101.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2102.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2103.1">int</span></span><span class="koboSpan" id="kobo.2104.1"> Id { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2105.1">get</span></span><span class="koboSpan" id="kobo.2106.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2107.1">set</span></span><span class="koboSpan" id="kobo.2108.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2109.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2110.1">string</span></span><span class="koboSpan" id="kobo.2111.1"> Name { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2112.1">get</span></span><span class="koboSpan" id="kobo.2113.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2114.1">set</span></span><span class="koboSpan" id="kobo.2115.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2116.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2117.1">decimal</span></span><span class="koboSpan" id="kobo.2118.1"> Price { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2119.1">get</span></span><span class="koboSpan" id="kobo.2120.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2121.1">set</span></span><span class="koboSpan" id="kobo.2122.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2123.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2124.1">int</span></span><span class="koboSpan" id="kobo.2125.1"> DurationInDays { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2126.1">get</span></span><span class="koboSpan" id="kobo.2127.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2128.1">set</span></span><span class="koboSpan" id="kobo.2129.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2130.1">public</span></span><span class="koboSpan" id="kobo.2131.1"> DateTime? </span><span class="koboSpan" id="kobo.2131.2">StartValidityDate { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2132.1">get</span></span><span class="koboSpan" id="kobo.2133.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2134.1">set</span></span><span class="koboSpan" id="kobo.2135.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2136.1">public</span></span><span class="koboSpan" id="kobo.2137.1"> DateTime? </span><span class="koboSpan" id="kobo.2137.2">EndValidityDate { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2138.1">get</span></span><span class="koboSpan" id="kobo.2139.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2140.1">set</span></span><span class="koboSpan" id="kobo.2141.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2142.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2143.1">string</span></span><span class="koboSpan" id="kobo.2144.1"> DestinationName { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2145.1">get</span></span><span class="koboSpan" id="kobo.2146.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2147.1">set</span></span><span class="koboSpan" id="kobo.2148.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2149.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2150.1">int</span></span><span class="koboSpan" id="kobo.2151.1"> DestinationId { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2152.1">get</span></span><span class="koboSpan" id="kobo.2153.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2154.1">set</span></span><span class="koboSpan" id="kobo.2155.1">; }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2156.1">Finally, let’s add the following </span><code class="inlineCode"><span class="koboSpan" id="kobo.2157.1">using</span></code><span class="koboSpan" id="kobo.2158.1"> clauses to our controller code so that we can easily refer to our DTO and Entity Framework LINQ methods:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2159.1">using</span></span><span class="koboSpan" id="kobo.2160.1"> Microsoft.EntityFrameworkCore;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2161.1">using</span></span><span class="koboSpan" id="kobo.2162.1"> WWTravelClubWebAPI80.DTOs;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2163.1">Now, we are ready to fill the body of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2164.1">GetPackagesByDate</span></code><span class="koboSpan" id="kobo.2165.1"> method with the following code.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2166.1">try</span></span><span class="koboSpan" id="kobo.2167.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2168.1">var</span></span><span class="koboSpan" id="kobo.2169.1"> res = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2170.1">await</span></span><span class="koboSpan" id="kobo.2171.1"> ctx.Packages
        .Where(m =&gt; start &gt;= m.StartValidityDate
        &amp;&amp; stop &lt;= m.EndValidityDate)
        .Select(m =&gt; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2172.1">new</span></span><span class="koboSpan" id="kobo.2173.1"> PackagesListDTO
        {
            StartValidityDate = m.StartValidityDate,
            EndValidityDate = m.EndValidityDate,
            Name = m.Name,
            DurationInDays = m.DurationInDays,
            Id = m.Id,
            Price = m.Price,
            DestinationName = m.MyDestination.Name,
            DestinationId = m.DestinationId
        })
        .ToListAsync();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2174.1">return</span></span><span class="koboSpan" id="kobo.2175.1"> Ok(res);
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2176.1">catch</span></span><span class="koboSpan" id="kobo.2177.1"> (Exception err)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2178.1">return</span></span><span class="koboSpan" id="kobo.2179.1"> StatusCode(</span><span class="hljs-number"><span class="koboSpan" id="kobo.2180.1">500</span></span><span class="koboSpan" id="kobo.2181.1">, err.ToString());
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2182.1">It is important to</span><a id="_idIndexMarker1640"/><span class="koboSpan" id="kobo.2183.1"> remember that we are focusing only on presenting the results of an API exposed using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2184.1">Swashbuckle.AspNetCore</span></code><span class="koboSpan" id="kobo.2185.1"> NuGet package. </span><span class="koboSpan" id="kobo.2185.2">It is not a good practice to make use of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2186.1">DbContext</span></code><span class="koboSpan" id="kobo.2187.1"> in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2188.1">Controller</span></code> <a id="_idIndexMarker1641"/><span class="koboSpan" id="kobo.2189.1">class, and as a software architect, you may define the best architectural design for your application (multi-tier, hexagonal, onion, clean, DDD, and so on).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2190.1">The LINQ query is like the one contained in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2191.1">WWTravelClubDBTest</span></code><span class="koboSpan" id="kobo.2192.1"> project we tested in </span><em class="italic"><span class="koboSpan" id="kobo.2193.1">Chapter 13</span></em><span class="koboSpan" id="kobo.2194.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2195.1">Interacting with Data in C# – Entity Framework Core</span></em><span class="koboSpan" id="kobo.2196.1">. </span><span class="koboSpan" id="kobo.2196.2">Once the result has been computed, it is returned with an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2197.1">OK</span></code><span class="koboSpan" id="kobo.2198.1"> call. </span><span class="koboSpan" id="kobo.2198.2">The method’s code handles internal server errors by catching exceptions and returning a 500 status code since bad requests are automatically handled before the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2199.1">Controller</span></code><span class="koboSpan" id="kobo.2200.1"> method is called by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2201.1">ApiController</span></code><span class="koboSpan" id="kobo.2202.1"> attribute.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2203.1">Let’s run the solution. </span><span class="koboSpan" id="kobo.2203.2">When the browser opens, it is unable to receive any result from our ASP.NET Core website. </span><span class="koboSpan" id="kobo.2203.3">Let’s modify the browser URL so that it is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2204.1">https://localhost:&lt;previous port&gt;/swagger</span></code><span class="koboSpan" id="kobo.2205.1">. </span><span class="koboSpan" id="kobo.2205.2">It is worth mentioning that you can also configure your local settings file to either launch and go to the Swagger URL automatically, or have Swagger live under the root.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2206.1">The user interface of the OpenAPI documentation will look as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2207.1"><img alt="" role="presentation" src="../Images/B19820_21_15.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2208.1">Figure 21.15: Swagger output</span></p>
<p class="normal"><strong class="screenText"><span class="koboSpan" id="kobo.2209.1">PackagesListDTO</span></strong><span class="koboSpan" id="kobo.2210.1"> is the model we defined to list the packages, while </span><strong class="screenText"><span class="koboSpan" id="kobo.2211.1">ProblemDetails</span></strong><span class="koboSpan" id="kobo.2212.1"> is the model that is used to </span><a id="_idIndexMarker1642"/><span class="koboSpan" id="kobo.2213.1">report errors in the event of bad requests. </span><span class="koboSpan" id="kobo.2213.2">By clicking the </span><strong class="screenText"><span class="koboSpan" id="kobo.2214.1">GET</span></strong><span class="koboSpan" id="kobo.2215.1"> button, we can get </span><a id="_idIndexMarker1643"/><span class="koboSpan" id="kobo.2216.1">more details about our </span><code class="inlineCode"><span class="koboSpan" id="kobo.2217.1">GET</span></code><span class="koboSpan" id="kobo.2218.1"> method and we can also test it, as shown in the following screenshot:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2219.1"><img alt="Interface gráfica do usuário, Aplicativo  Descrição gerada automaticamente" src="../Images/B19820_21_16.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2220.1">Figure 21.16: GET method details</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2221.1">Pay attention when it comes to</span><a id="_idIndexMarker1644"/><span class="koboSpan" id="kobo.2222.1"> inserting dates that are covered by packages in the database; otherwise, an </span><a id="_idIndexMarker1645"/><span class="koboSpan" id="kobo.2223.1">empty list will be returned. </span><span class="koboSpan" id="kobo.2223.2">The ones shown in the preceding screenshot should work.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2224.1">Dates must be entered in a correct JSON format; otherwise, a 400 Bad Request error is returned, like the one shown in the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2225.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2226.1">"errors"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2227.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.2228.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2229.1">"start"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2230.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.2231.1">[</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2232.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2233.1">The value '2019' is not valid."</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.2234.1">]</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.2235.1">},</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2236.1">"title"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2237.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2238.1">"One or more validation errors occurred."</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2239.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2240.1">"status"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2241.1">:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.2242.1">400</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2243.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.2244.1">"traceId"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.2245.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2246.1">"80000008-0000-f900-b63f-84710c7967bb"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.2247.1">}</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2248.1">If you insert the correct input parameters, the Swagger UI returns the packages that satisfy the query in JSON format.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2249.1">That is all! </span><span class="koboSpan" id="kobo.2249.2">You have implemented your first API with OpenAPI documentation! </span><span class="koboSpan" id="kobo.2249.3">Now let’s check how easy it can be to implement a serverless solution using Azure Functions.</span></p>
<h1 class="heading-1" id="_idParaDest-453"><span class="koboSpan" id="kobo.2250.1">Implementing Azure Functions to send emails</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2251.1">Here, we will use a subset of the </span><a id="_idIndexMarker1646"/><span class="koboSpan" id="kobo.2252.1">Azure components. </span><span class="koboSpan" id="kobo.2252.2">The use case from WWTravelClub proposes a worldwide implementation of the service, and there is a chance that this service will need different architecture designs to achieve all the key performance points that we described in </span><em class="italic"><span class="koboSpan" id="kobo.2253.1">Chapter 1</span></em><span class="koboSpan" id="kobo.2254.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2255.1">Understanding the Importance of Software Architecture</span></em><span class="koboSpan" id="kobo.2256.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2257.1">If you go back to the user stories that were described in this chapter, you will find that many needs are related to communication. </span><span class="koboSpan" id="kobo.2257.2">Because of this, it is common to have some alerts provided by emails in the solution. </span><span class="koboSpan" id="kobo.2257.3">This implementation will focus on how to send emails. </span><span class="koboSpan" id="kobo.2257.4">The architecture will be totally serverless. </span><span class="koboSpan" id="kobo.2257.5">The benefits of using an architecture like that are explained below.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2258.1">The following diagram shows the basic structure of the architecture. </span><span class="koboSpan" id="kobo.2258.2">To give users a great experience, all the emails that are sent by the application will be queued asynchronously, thereby</span><a id="_idIndexMarker1647"/><span class="koboSpan" id="kobo.2259.1"> preventing significant delays in the system’s responses:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2260.1"><img alt="Diagram  Description automatically generated" src="../Images/B19820_21_17.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2261.1">Figure 21.17: Architectural design for sending emails</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2262.1">Basically, when a user does any action that requires sending an alert (1), the alert is posted in a </span><strong class="keyWord"><span class="koboSpan" id="kobo.2263.1">send email request function</span></strong><span class="koboSpan" id="kobo.2264.1"> (2), which stores the request in Azure Queue Storage (3). </span><span class="koboSpan" id="kobo.2264.2">So, for the user, the alert is already performed at this moment, and they can keep working. </span><span class="koboSpan" id="kobo.2264.3">However, since we have a queue, no matter the number of alerts sent, they will be processed by the </span><strong class="keyWord"><span class="koboSpan" id="kobo.2265.1">send email function </span></strong><span class="koboSpan" id="kobo.2266.1">that is triggered (4) as soon as a request is made, respecting the time needed to process the requests, but guaranteeing that the receiver will get the alert (5). </span><span class="koboSpan" id="kobo.2266.2">Note that there are no dedicated servers that manage Azure Functions for enqueuing or dequeuing messages from Azure Queue Storage. </span><span class="koboSpan" id="kobo.2266.3">This is exactly what we call serverless, as described in </span><em class="italic"><span class="koboSpan" id="kobo.2267.1">Chapter 16, Working with Serverless - Azure Functions</span></em><span class="koboSpan" id="kobo.2268.1">. </span><span class="koboSpan" id="kobo.2268.2">It is worth mentioning that this architecture is not restricted to only sending emails – it can also be used to process any HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.2269.1">POST</span></code><span class="koboSpan" id="kobo.2270.1"> request.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2271.1">Now, we will learn, in three steps, how to set up security in the API so that only authorized applications can use the given solution.</span></p>
<h2 class="heading-2" id="_idParaDest-454"><span class="koboSpan" id="kobo.2272.1">First step — creating an Azure queue storage</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2273.1">It is quite simple to create</span><a id="_idIndexMarker1648"/><span class="koboSpan" id="kobo.2274.1"> storage in the Azure portal. </span><span class="koboSpan" id="kobo.2274.2">Let us learn how. </span><span class="koboSpan" id="kobo.2274.3">First, you will need to create a storage account by clicking on </span><strong class="screenText"><span class="koboSpan" id="kobo.2275.1">Create a resource</span></strong><span class="koboSpan" id="kobo.2276.1"> on the main page of the Azure portal and searching for </span><strong class="screenText"><span class="koboSpan" id="kobo.2277.1">Storage account</span></strong><span class="koboSpan" id="kobo.2278.1">. </span><span class="koboSpan" id="kobo.2278.2">Then, you will be able to set up its basic information, such as </span><strong class="screenText"><span class="koboSpan" id="kobo.2279.1">Storage account name</span></strong><span class="koboSpan" id="kobo.2280.1"> and </span><strong class="screenText"><span class="koboSpan" id="kobo.2281.1">Location</span></strong><span class="koboSpan" id="kobo.2282.1">. </span><span class="koboSpan" id="kobo.2282.2">Information about </span><strong class="screenText"><span class="koboSpan" id="kobo.2283.1">Networking</span></strong><span class="koboSpan" id="kobo.2284.1"> and </span><strong class="screenText"><span class="koboSpan" id="kobo.2285.1">Data protection</span></strong><span class="koboSpan" id="kobo.2286.1">, as shown in the following screenshot, can be checked in this wizard, too. </span><span class="koboSpan" id="kobo.2286.2">There are default values for these settings that we will cover the demo:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2287.1"><img alt="" role="presentation" src="../Images/B19820_21_18.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2288.1">Figure 21.18: Creating an Azure storage account</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2289.1">Once you have the storage account in place, you will be able to set up a queue. </span><span class="koboSpan" id="kobo.2289.2">You will find this option by clicking on the </span><strong class="screenText"><span class="koboSpan" id="kobo.2290.1">Overview</span></strong><span class="koboSpan" id="kobo.2291.1"> link in the storage account and selecting the </span><strong class="screenText"><span class="koboSpan" id="kobo.2292.1">Queue service</span></strong><span class="koboSpan" id="kobo.2293.1"> option </span><a id="_idIndexMarker1649"/><span class="koboSpan" id="kobo.2294.1">or by selecting </span><strong class="screenText"><span class="koboSpan" id="kobo.2295.1">Queues</span></strong><span class="koboSpan" id="kobo.2296.1"> via the </span><strong class="screenText"><span class="koboSpan" id="kobo.2297.1">Storage account</span></strong><span class="koboSpan" id="kobo.2298.1"> menu. </span><span class="koboSpan" id="kobo.2298.2">Then, you will find an option to add the queue (</span><strong class="screenText"><span class="koboSpan" id="kobo.2299.1">+ Queue</span></strong><span class="koboSpan" id="kobo.2300.1">), where you just need to provide its name:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2301.1"><img alt="Interface gráfica do usuário, Texto, Aplicativo  Descrição gerada automaticamente" src="../Images/B19820_21_19.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2302.1">Figure 21.19: Defining a queue to monitor emails</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2303.1">The created queue will give you an overview of the Azure portal. </span><span class="koboSpan" id="kobo.2303.2">There, you will find your queue’s URL and be able to use Storage Explorer:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2304.1"><img alt="" role="presentation" src="../Images/B19820_21_20.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2305.1">Figure 21.20: Queue created</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2306.1">Note that you will also be able to connect to this storage using Microsoft Azure Storage Explorer (</span><a href="https://azure.microsoft.com/en-us/features/storage-explorer/"><span class="url"><span class="koboSpan" id="kobo.2307.1">https://azure.microsoft.com/en-us/features/storage-explorer/</span></span></a><span class="koboSpan" id="kobo.2308.1">):</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2309.1"><img alt="" role="presentation" src="../Images/B19820_21_21.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2310.1">Figure 21.21: Monitoring the queue using Microsoft Azure Storage Explorer</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2311.1">This tool is especially </span><a id="_idIndexMarker1650"/><span class="koboSpan" id="kobo.2312.1">useful if you are not connected to the Azure portal. </span><span class="koboSpan" id="kobo.2312.2">Let’s move to the second step, where we will create the function that receives the requests to send emails.</span></p>
<h2 class="heading-2" id="_idParaDest-455"><span class="koboSpan" id="kobo.2313.1">Second step — creating the function to send emails</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2314.1">Now, you can start programming in earnest, informing the queue that an email is waiting to be sent. </span><span class="koboSpan" id="kobo.2314.2">Here, we </span><a id="_idIndexMarker1651"/><span class="koboSpan" id="kobo.2315.1">need to use an HTTP trigger. </span><span class="koboSpan" id="kobo.2315.2">Note that the function is a static class that runs asynchronously. </span><span class="koboSpan" id="kobo.2315.3">The following code, written in Visual Studio, gathers the request data coming from the HTTP trigger and inserts the data into a queue that will be processed later. </span><span class="koboSpan" id="kobo.2315.4">It is worth mentioning that the environment variable </span><code class="inlineCode"><span class="koboSpan" id="kobo.2316.1">EmailQueueConnectionString</span></code><span class="koboSpan" id="kobo.2317.1"> is set in the function app settings, and it contains the information provided by the Azure Queue Storage connection string.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2318.1">We have below a code snippet from the function available in the GitHub repository of the book:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2319.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2320.1">static</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2321.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2322.1">SendEmail</span></span><span class="koboSpan" id="kobo.2323.1">
{
    [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2324.1">FunctionName(nameof(SendEmail))</span></span><span class="koboSpan" id="kobo.2325.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2326.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2327.1">static</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2328.1">async</span></span><span class="koboSpan" id="kobo.2329.1"> Task&lt;HttpResponseMessage&gt;RunAsync( [HttpTrigger(AuthorizationLevel.Function, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2330.1">"post"</span></span><span class="koboSpan" id="kobo.2331.1">)] HttpRequestMessage req, ILogger log)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2332.1">var</span></span><span class="koboSpan" id="kobo.2333.1"> requestData = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2334.1">await</span></span><span class="koboSpan" id="kobo.2335.1"> req.Content.ReadAsStringAsync();
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2336.1">var</span></span><span class="koboSpan" id="kobo.2337.1"> connectionString = Environment.GetEnvironmentVariable(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2338.1">"EmailQueueConnectionString"</span></span><span class="koboSpan" id="kobo.2339.1">);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2340.1">var</span></span><span class="koboSpan" id="kobo.2341.1"> storageAccount = CloudStorageAccount.Parse(connectionString);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2342.1">var</span></span><span class="koboSpan" id="kobo.2343.1"> queueClient = storageAccount.CreateCloudQueueClient();
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2344.1">var</span></span><span class="koboSpan" id="kobo.2345.1"> messageQueue = queueClient.GetQueueReference(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2346.1">"email"</span></span><span class="koboSpan" id="kobo.2347.1">);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2348.1">var</span></span><span class="koboSpan" id="kobo.2349.1"> message = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2350.1">new</span></span><span class="koboSpan" id="kobo.2351.1"> CloudQueueMessage(requestData);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2352.1">await</span></span><span class="koboSpan" id="kobo.2353.1"> messageQueue.AddMessageAsync(message);
        log.LogInformation(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2354.1">"HTTP trigger from SendEmail function processed a request."</span></span><span class="koboSpan" id="kobo.2355.1">);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2356.1">var</span></span><span class="koboSpan" id="kobo.2357.1"> responseObj = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2358.1">new</span></span><span class="koboSpan" id="kobo.2359.1"> { success = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2360.1">true</span></span><span class="koboSpan" id="kobo.2361.1"> };
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2362.1">return</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2363.1">new</span></span><span class="koboSpan" id="kobo.2364.1"> HttpResponseMessage(HttpStatusCode.OK)
        {
            Content = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2365.1">new</span></span><span class="koboSpan" id="kobo.2366.1"> StringContent(JsonConvert.SerializeObject(responseObj), Encoding.UTF8, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2367.1">"application/json"</span></span><span class="koboSpan" id="kobo.2368.1">),
         };
    }
}
</span></code></pre>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.2369.1">In some scenarios, you </span><a id="_idIndexMarker1652"/><span class="koboSpan" id="kobo.2370.1">may try to avoid the queue setup indicated in the preceding code by using a queue output binding. </span><span class="koboSpan" id="kobo.2370.2">Check out the details at </span><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-queue-output?tabs=csharp"><span class="url"><span class="koboSpan" id="kobo.2371.1">https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-queue-output?tabs=csharp</span></span></a><span class="koboSpan" id="kobo.2372.1">.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2373.1">You can use a tool such as Postman to test your function. </span><span class="koboSpan" id="kobo.2373.2">Before that, you just need to run the app in Visual Studio, which will launch Azure Functions Core Tools and its emulator:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2374.1"><img alt="Interface gráfica do usuário, Texto, Aplicativo  Descrição gerada automaticamente" src="../Images/B19820_21_22.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2375.1">Figure 21.22: Postman function test</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2376.1">The result will appear in</span><a id="_idIndexMarker1653"/><span class="koboSpan" id="kobo.2377.1"> Microsoft Azure Storage Explorer and the Azure portal. </span><span class="koboSpan" id="kobo.2377.2">In the Azure portal, you can manage each message and dequeue each of them or even clear the queue storage:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2378.1"><img alt="Interface gráfica do usuário, Texto, Aplicativo, Email  Descrição gerada automaticamente" src="../Images/B19820_21_23.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2379.1">Figure 21.23: HTTP trigger and queue storage test</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2380.1">To finish this topic, let’s </span><a id="_idIndexMarker1654"/><span class="koboSpan" id="kobo.2381.1">move on to the final third step, where we will create the function that will process the requests for sending emails.</span></p>
<h2 class="heading-2" id="_idParaDest-456"><span class="koboSpan" id="kobo.2382.1">Third step — creating the queue trigger function</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2383.1">After this, you can create a second </span><a id="_idIndexMarker1655"/><span class="koboSpan" id="kobo.2384.1">function by right-clicking the project and selecting </span><strong class="screenText"><span class="koboSpan" id="kobo.2385.1">Add -&gt; New Azure Function</span></strong><span class="koboSpan" id="kobo.2386.1">. </span><span class="koboSpan" id="kobo.2386.2">This one will be triggered by data entering your queue. </span><span class="koboSpan" id="kobo.2386.3">It is worth mentioning that, for Azure Functions v4, you will have the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2387.1">Microsoft.Azure.WebJobs.Extensions.Storage</span></code><span class="koboSpan" id="kobo.2388.1"> library added as a NuGet reference automatically:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2389.1"><img alt="Graphical user interface, text, application  Description automatically generated" src="../Images/B19820_21_24.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2390.1">Figure 21.24: Creating a queue trigger</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2391.1">Once you have set the </span><a id="_idIndexMarker1656"/><span class="koboSpan" id="kobo.2392.1">connection string inside </span><code class="inlineCode"><span class="koboSpan" id="kobo.2393.1">local.settings.json</span></code><span class="koboSpan" id="kobo.2394.1">, you will be able to run both functions and test them with Postman. </span><span class="koboSpan" id="kobo.2394.2">The difference is that, with the second function running, if you set a breakpoint at the start of it, you will be able to check whether the message has been sent:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2395.1"><img alt="Tela de computador com texto preto sobre fundo branco  Descrição gerada automaticamente" src="../Images/B19820_21_25.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2396.1">Figure 21.25: Queue triggered in Visual Studio 2022</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2397.1">From this point, the way </span><a id="_idIndexMarker1657"/><span class="koboSpan" id="kobo.2398.1">to send emails will depend on the email options you have. </span><span class="koboSpan" id="kobo.2398.2">You may decide to use a proxy or connect directly to your email server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2399.1">There are several advantages to creating an email service this way:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2400.1">Once your service has been coded and tested, you can use it to send emails from any of your applications. </span><span class="koboSpan" id="kobo.2400.2">This means that your code can always be reused.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2401.1">Apps that use this service will not be stopped from sending emails due to the asynchronous advantages of posting in an HTTP service.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2402.1">You do not need to pool the queue to check whether data is ready for processing.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2403.1">Finally, the queue process runs concurrently, which delivers a better experience in most cases. </span><span class="koboSpan" id="kobo.2403.2">It is possible to turn it off by setting some properties in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2404.1">host.json</span></code><span class="koboSpan" id="kobo.2405.1">. </span><span class="koboSpan" id="kobo.2405.2">All the options for this can be found in the </span><em class="italic"><span class="koboSpan" id="kobo.2406.1">Further reading</span></em><span class="koboSpan" id="kobo.2407.1"> section at the end of this chapter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2408.1">In this part of the case study, we checked an example of an architecture where you connect multiple functions to avoid pooling data and enable concurrent processing. </span><span class="koboSpan" id="kobo.2408.2">We have seen with this demo </span><a id="_idIndexMarker1658"/><span class="koboSpan" id="kobo.2409.1">how great the fit between serverless and event-driven architecture is.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2410.1">Now, let’s change the subject a bit, and discuss how to implement a frontend microservice.</span></p>
<h1 class="heading-1" id="_idParaDest-457"><span class="koboSpan" id="kobo.2411.1">A frontend microservice</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2412.1">In this section, as an example of an ASP.NET Core MVC frontend microservice described in </span><em class="italic"><span class="koboSpan" id="kobo.2413.1">Chapter 18, Implementing Frontend Microservices with ASP.NET Core</span></em><span class="koboSpan" id="kobo.2414.1">, we will implement the administrative panel for </span><a id="_idIndexMarker1659"/><span class="koboSpan" id="kobo.2415.1">managing the destinations and packages of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2416.1">WWTravelClub</span></code><span class="koboSpan" id="kobo.2417.1"> book use case. </span><span class="koboSpan" id="kobo.2417.2">The application will be implemented with the</span><strong class="keyWord"> </strong><span class="koboSpan" id="kobo.2418.1">DDD</span><strong class="keyWord"> </strong><span class="koboSpan" id="kobo.2419.1">approach and associated patterns described in </span><em class="italic"><span class="koboSpan" id="kobo.2420.1">Chapter 7</span></em><span class="koboSpan" id="kobo.2421.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2422.1">Understanding the Different Domains in Software Solutions</span></em><span class="koboSpan" id="kobo.2423.1">. </span><span class="koboSpan" id="kobo.2423.2">So, having a good understanding of that chapter is a fundamental prerequisite to reading this chapter. </span><span class="koboSpan" id="kobo.2423.3">The subsections that follow describe the overall application specifications and organization. </span><span class="koboSpan" id="kobo.2423.4">The full code of the example can be found in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2424.1">ch19</span></code><span class="koboSpan" id="kobo.2425.1"> folder of the GitHub repository associated with the book.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2426.1">As usual, let’s start by stating clearly our frontend microservice specifications.</span></p>
<h2 class="heading-2" id="_idParaDest-458"><span class="koboSpan" id="kobo.2427.1">Defining application specifications</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2428.1">The destinations and packages were described in </span><em class="italic"><span class="koboSpan" id="kobo.2429.1">Chapter 13</span></em><span class="koboSpan" id="kobo.2430.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2431.1">Interacting with Data in C# – Entity Framework Core</span></em><span class="koboSpan" id="kobo.2432.1">. </span><span class="koboSpan" id="kobo.2432.2">Here, we will use the same data model, with the necessary modifications to adapt it to the DDD</span><a id="_idIndexMarker1660"/><span class="koboSpan" id="kobo.2433.1"> approach. </span><span class="koboSpan" id="kobo.2433.2">The administrative panel must allow packages, a destination listing, and CRUD operations on it. </span><span class="koboSpan" id="kobo.2433.3">To simplify the application, the two listings will be quite simple: the application will show all destinations sorted according to their names, while all packages will be sorted starting from the ones with a later validity date.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2434.1">Furthermore, we make the following assumptions:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2435.1">The application that shows destinations and packages to the user shares the same database used by the administrative panel. </span><span class="koboSpan" id="kobo.2435.2">Since only the administrative panel application needs to modify data, there will be just one write copy of the database with several read-only replicas.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2436.1">Price modifications and package deletions are immediately used to update the user’s shopping carts. </span><span class="koboSpan" id="kobo.2436.2">For this reason, the administrative application must send asynchronous</span><a id="_idIndexMarker1661"/><span class="koboSpan" id="kobo.2437.1"> communications about price changes and package removals. </span><span class="koboSpan" id="kobo.2437.2">We will not implement all the communication logic here, but we will just add all such events to an event table, which should be used as input to a parallel thread that’s in charge of sending these events to all relevant microservices.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2438.1">Here, we will give the full code for just package management; most of the code for destination management is designed as an exercise for you. </span><span class="koboSpan" id="kobo.2438.2">The full code is available in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2439.1">ch16</span></code><span class="koboSpan" id="kobo.2440.1"> folder of the GitHub repository associated with this book. </span><span class="koboSpan" id="kobo.2440.2">In the remainder of this section, we will describe the application’s overall organization and discuss some relevant samples of code. </span><span class="koboSpan" id="kobo.2440.3">We start with an overall description of the application architecture.</span></p>
<h2 class="heading-2" id="_idParaDest-459"><span class="koboSpan" id="kobo.2441.1">Defining the application architecture</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2442.1">The application is organized based on the guidelines described in </span><em class="italic"><span class="koboSpan" id="kobo.2443.1">Chapter 7</span></em><span class="koboSpan" id="kobo.2444.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2445.1">Understanding the Different Domains in Software Solutions</span></em><span class="koboSpan" id="kobo.2446.1">, while considering the DDD approach and related patterns. </span><span class="koboSpan" id="kobo.2446.2">That is, the</span><a id="_idIndexMarker1662"/><span class="koboSpan" id="kobo.2447.1"> application is organized into three layers, each implemented as a different project:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2448.1">There’s a domain implementation layer, which contains the repository’s implementation and the classes describing database entities. </span><span class="koboSpan" id="kobo.2448.2">It is a .NET library project. </span><span class="koboSpan" id="kobo.2448.3">However, since it needs some interfaces, like </span><code class="inlineCode"><span class="koboSpan" id="kobo.2449.1">IServiceCollection</span></code><span class="koboSpan" id="kobo.2450.1">, which are defined in </span><code class="inlineCode"><span class="koboSpan" id="kobo.2451.1">Microsoft.NET.Sdk.web</span></code><span class="koboSpan" id="kobo.2452.1">, and since the layer </span><code class="inlineCode"><span class="koboSpan" id="kobo.2453.1">DBContext</span></code><span class="koboSpan" id="kobo.2454.1"> must inherit from the identity framework in order to also handle the application authentication and authorization database tables, we must add a reference not only to the .NET SDK but also to the ASP.NET Core SDK. </span><span class="koboSpan" id="kobo.2454.2">This can be done as follows:</span><ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2455.1">Right-click on the project icon in Solution Explorer and select </span><strong class="screenText"><span class="koboSpan" id="kobo.2456.1">Edit project file</span></strong><span class="koboSpan" id="kobo.2457.1">, or just double-click the project name.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2458.1">In the </span><strong class="screenText"><span class="koboSpan" id="kobo.2459.1">Edit</span></strong><span class="koboSpan" id="kobo.2460.1"> window, add:
            </span><pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.2461.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2462.1">ItemGroup</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2463.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2464.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2465.1">FrameworkReference</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2466.1">Include</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2467.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2468.1">"Microsoft.AspNetCore.App"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2469.1"> /&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2470.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2471.1">ItemGroup</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2472.1">&gt;</span></span>
</code></pre>
</li>
</ol>
</li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2473.1">There’s also a domain layer abstraction, which contains repository specifications – that is, interfaces that describe repository implementations and DDD aggregates. </span><span class="koboSpan" id="kobo.2473.2">In our implementation, we decided to implement aggregates by hiding</span><a id="_idIndexMarker1663"/><span class="koboSpan" id="kobo.2474.1"> the forbidden operations/properties of root data entities behind interfaces. </span><span class="koboSpan" id="kobo.2474.2">Hence, for instance, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2475.1">Package</span></code><span class="koboSpan" id="kobo.2476.1"> entity class, which is an aggregate root, has a corresponding </span><code class="inlineCode"><span class="koboSpan" id="kobo.2477.1">IPackage</span></code><span class="koboSpan" id="kobo.2478.1"> interface in the domain layer abstraction that hides all the property setters of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2479.1">Package</span></code><span class="koboSpan" id="kobo.2480.1"> entity. </span><span class="koboSpan" id="kobo.2480.2">The domain layer abstraction also contains the definitions of all the domain events, while the event handlers that will subscribe to these events are defined in the application layer. </span><code class="inlineCode"><span class="koboSpan" id="kobo.2481.1">IPackage</span></code><span class="koboSpan" id="kobo.2482.1"> has also the associated </span><code class="inlineCode"><span class="koboSpan" id="kobo.2483.1">IPackageRepository</span></code><span class="koboSpan" id="kobo.2484.1"> repository interface.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2485.1">All repository interfaces inherit from the empty </span><code class="inlineCode"><span class="koboSpan" id="kobo.2486.1">IRepository</span></code><span class="koboSpan" id="kobo.2487.1"> interface.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2488.1">This way, they declare it as a repository interface, and all repository interfaces can be automatically discovered with reflection and added to the dependency injection engine together with their implementations.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2489.1">Finally, there’s the application layer – that is, the ASP.NET Core MVC application – where we define DDD queries, commands, command handlers, and event handlers. </span><span class="koboSpan" id="kobo.2489.2">Controllers fill query objects and execute them to get ViewModels they can pass to Views. </span><span class="koboSpan" id="kobo.2489.3">They update storage by filling command objects and executing their associated command handlers. </span><span class="koboSpan" id="kobo.2489.4">In turn, command handlers use </span><code class="inlineCode"><span class="koboSpan" id="kobo.2490.1">IRepository</span></code><span class="koboSpan" id="kobo.2491.1"> interfaces (that is, interfaces that inherit from the empty </span><code class="inlineCode"><span class="koboSpan" id="kobo.2492.1">IRepository</span></code><span class="koboSpan" id="kobo.2493.1"> interface) and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2494.1">IUnitOfWork</span></code><span class="koboSpan" id="kobo.2495.1"> instances coming from the domain layer to manage and coordinate transactions.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2496.1">It is worth pointing out that, in more complex microservices, the application layer may be implemented as a separate library project and would contain just DDD queries, commands, command handlers, and event handlers. </span><span class="koboSpan" id="kobo.2496.2">While, the MVC project would contain just controllers, UIs, and dependency injection.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2497.1">The application uses the </span><strong class="keyWord"><span class="koboSpan" id="kobo.2498.1">Command Query Responsibility Segregation</span></strong><span class="koboSpan" id="kobo.2499.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.2500.1">CQRS</span></strong><span class="koboSpan" id="kobo.2501.1">) pattern; therefore, it uses command objects to modify the </span><a id="_idIndexMarker1664"/><span class="koboSpan" id="kobo.2502.1">storage and the query object to query it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2503.1">The query is simple to use and implement: controllers fill their parameters and then call their execution methods. </span><span class="koboSpan" id="kobo.2503.2">In turn, query objects have direct LINQ implementations that project results directly onto</span><a id="_idIndexMarker1665"/><span class="koboSpan" id="kobo.2504.1"> the ViewModels used by the controller Views with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2505.1">Select</span></code><span class="koboSpan" id="kobo.2506.1"> LINQ methods. </span><span class="koboSpan" id="kobo.2506.2">You may also decide to hide the LINQ implementation behind the same repository classes used for the storage update operations, but this would turn the definition and modification of simple queries into very time-consuming tasks.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2507.1">In any case, it can be beneficial to encapsulate query objects behind interfaces so that their implementations can be replaced by fake implementations when you test controllers.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2508.1">However, the chain of objects and calls involved in the execution of commands is more complex. </span><span class="koboSpan" id="kobo.2508.2">This is because it requires the construction and modification of aggregates (as well as a definition of the interaction between several aggregates and between aggregates and other applications through domain events) to be provided.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2509.1">The following diagram is a sketch of how storage update operations are performed. </span><span class="koboSpan" id="kobo.2509.2">The circles are data being exchanged between the various layers, while rectangles are the procedures that process them. </span><span class="koboSpan" id="kobo.2509.3">Moreover, dotted arrows connect interfaces with types that implement them:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2510.1"><img alt="" role="presentation" src="../Images/B19820_21_26.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2511.1">Figure 21.26: Diagram of command execution</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2512.1">Here’s the flow of action through </span><em class="italic"><span class="koboSpan" id="kobo.2513.1">Figure 21.26</span></em><span class="koboSpan" id="kobo.2514.1"> as a list of steps:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2515.1">A controller’s action method receives one or more ViewModels and performs validation.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2516.1">One or more ViewModels containing changes to apply are hidden behind interfaces (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2517.1">IMyUpdate</span></code><span class="koboSpan" id="kobo.2518.1">) defined in the domain layer. </span><span class="koboSpan" id="kobo.2518.2">They are used to fill the properties of a command object. </span><span class="koboSpan" id="kobo.2518.3">These interfaces must be defined in the domain layer since</span><a id="_idIndexMarker1666"/><span class="koboSpan" id="kobo.2519.1"> they will be used as arguments of the repository aggregate methods defined there.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2520.1">A command handler matching the previous command is retrieved via </span><strong class="keyWord"><span class="koboSpan" id="kobo.2521.1">Dependency Injection</span></strong><span class="koboSpan" id="kobo.2522.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.2523.1">DI</span></strong><span class="koboSpan" id="kobo.2524.1">) in the controller action method (through the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2525.1">[FromServices]</span></code><span class="koboSpan" id="kobo.2526.1"> parameter attribute we described in the </span><em class="italic"><span class="koboSpan" id="kobo.2527.1">Defining controllers and views</span></em><span class="koboSpan" id="kobo.2528.1"> subsection). </span><span class="koboSpan" id="kobo.2528.2">Then, the handler is executed. </span><span class="koboSpan" id="kobo.2528.3">During its execution, the handler interacts with various repository interface methods and with the aggregates they return.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2529.1">When creating the command handler discussed in </span><em class="italic"><span class="koboSpan" id="kobo.2530.1">step 3</span></em><span class="koboSpan" id="kobo.2531.1">, the ASP.NET Core DI engine automatically injects all parameters declared in its constructor. </span><span class="koboSpan" id="kobo.2531.2">In particular, it injects all repository implementations needed to perform all command handler transactions. </span><span class="koboSpan" id="kobo.2531.3">The command handler performs its job by calling the methods of these </span><code class="inlineCode"><span class="koboSpan" id="kobo.2532.1">IRepository</span></code><span class="koboSpan" id="kobo.2533.1"> implementations received in its constructor to build aggregates and modify the built aggregates. </span><span class="koboSpan" id="kobo.2533.2">Aggregates either represent already-existing entities or newly created ones. </span><span class="koboSpan" id="kobo.2533.3">Handlers use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2534.1">IUnitOfWork</span></code><span class="koboSpan" id="kobo.2535.1"> interface contained in each repository interface, as well as the concurrency exceptions returned by the data layer, to organize their operations as transactions. </span><span class="koboSpan" id="kobo.2535.2">It is worth pointing out that each aggregate has its own repository implementation, and that the whole logic for updating each aggregate is defined in the aggregate itself, not in its associated repository implementation, to keep the code more modular.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2536.1">Behind the scenes, in the domain layer implementation, repository implementations use Entity Framework to perform their job. </span><span class="koboSpan" id="kobo.2536.2">Aggregates are implemented by root data entities hidden behind interfaces defined in the domain layer, while </span><code class="inlineCode"><span class="koboSpan" id="kobo.2537.1">IUnitOfWork</span></code><span class="koboSpan" id="kobo.2538.1"> methods, which handle transactions and pass changes to the database, are implemented with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2539.1">DbContext</span></code><span class="koboSpan" id="kobo.2540.1"> methods. </span><span class="koboSpan" id="kobo.2540.2">In other words, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2541.1">IUnitOfWork</span></code><span class="koboSpan" id="kobo.2542.1"> is implemented with the application’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.2543.1">DbContext</span></code><span class="koboSpan" id="kobo.2544.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2545.1">Domain events are generated during each aggregate process and are added to the aggregates themselves by calling their </span><code class="inlineCode"><span class="koboSpan" id="kobo.2546.1">AddDomainEvent</span></code><span class="koboSpan" id="kobo.2547.1"> methods. </span><span class="koboSpan" id="kobo.2547.2">However, they are not triggered immediately. </span><span class="koboSpan" id="kobo.2547.3">Usually, they are triggered at the end of all the aggregates’ processing and before changes are passed to the database; however, this is not a general rule.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2548.1">The application handles errors by throwing exceptions.
    </span><div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2549.1">A more efficient approach would be to define a request-scoped object in the dependency engine, where each application subpart may add its errors as domain events. </span><span class="koboSpan" id="kobo.2549.2">However, while this approach is more efficient, it increases the complexity of the code and the application development time.</span></p>
</div></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2550.1">The Visual Studio solution is</span><a id="_idIndexMarker1667"/><span class="koboSpan" id="kobo.2551.1"> composed of three projects:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2552.1">There’s a project containing the domain layer abstraction called </span><code class="inlineCode"><span class="koboSpan" id="kobo.2553.1">PackagesManagementDomain</span></code><span class="koboSpan" id="kobo.2554.1">, which is a .NET Standard 2.1 library. </span><span class="koboSpan" id="kobo.2554.2">When a library doesn’t use features or NuGet packages that are specific to a .NET version, it is a good practice to implement it as a .NET Standard library because, this way, it doesn’t need modifications when the application is moved to a newer .NET version.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2555.1">There’s a project containing the whole domain layer implementation called </span><code class="inlineCode"><span class="koboSpan" id="kobo.2556.1">PackagesManagementDB</span></code><span class="koboSpan" id="kobo.2557.1">, which is a .NET 8.0 library.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2558.1">Finally, there’s an ASP.NET Core MVC 8.0 project called </span><code class="inlineCode"><span class="koboSpan" id="kobo.2559.1">PackagesManagement</span></code><span class="koboSpan" id="kobo.2560.1"> that contains both the application and presentation layers. </span><span class="koboSpan" id="kobo.2560.2">When you define this project, select </span><strong class="screenText"><span class="koboSpan" id="kobo.2561.1">No Authentication</span></strong><span class="koboSpan" id="kobo.2562.1">; otherwise, the user database will be added directly to the ASP.NET Core MVC project instead of to the database layer. </span><span class="koboSpan" id="kobo.2562.2">We will add the user database manually in the data layer.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2563.1">Let’s start by creating the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2564.1">PackagesManagement</span></code><span class="koboSpan" id="kobo.2565.1"> ASP.NET Core MVC project so that the whole solution has the same name as the ASP.NET Core MVC project. </span><span class="koboSpan" id="kobo.2565.2">Then, we’ll add the other two library projects to the same solution.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2566.1">Finally, let the ASP.NET Core MVC project reference both projects, while </span><code class="inlineCode"><span class="koboSpan" id="kobo.2567.1">PackagesManagementDB</span></code><span class="koboSpan" id="kobo.2568.1"> references </span><code class="inlineCode"><span class="koboSpan" id="kobo.2569.1">PackagesManagementDomain</span></code><span class="koboSpan" id="kobo.2570.1">. </span><span class="koboSpan" id="kobo.2570.2">We suggest you define your own projects and then copy the code of this book’s GitHub repository into them as you read this section.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2571.1">The next subsection describes the code of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2572.1">PackagesManagementDomain</span></code><span class="koboSpan" id="kobo.2573.1"> domain layer abstraction project.</span></p>
<h2 class="heading-2" id="_idParaDest-460"><span class="koboSpan" id="kobo.2574.1">Defining the domain layer abstraction</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2575.1">Once the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2576.1">PackagesManagementDomain</span></code><span class="koboSpan" id="kobo.2577.1"> Standard 2.1 library project has been added to the solution, we’ll add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2578.1">Tools</span></code><span class="koboSpan" id="kobo.2579.1"> folder to the project root. </span><span class="koboSpan" id="kobo.2579.2">Then, we’ll place all the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2580.1">DomainLayer</span></code><span class="koboSpan" id="kobo.2581.1"> tools contained in the code associated with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2582.1">ch11</span></code><span class="koboSpan" id="kobo.2583.1">. </span><span class="koboSpan" id="kobo.2583.2">Since the code contained in this folder uses data annotations</span><a id="_idIndexMarker1668"/><span class="koboSpan" id="kobo.2584.1"> and defines DI extension methods, we must also add references to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2585.1">System.ComponentModel.Annotations</span></code><span class="koboSpan" id="kobo.2586.1"> and</span><code class="inlineCode"><span class="koboSpan" id="kobo.2587.1"> Microsoft.Extensions.DependencyInjection.Abstration</span></code><span class="koboSpan" id="kobo.2588.1"> NuGet packages.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2589.1">Then, we need an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2590.1">Aggregates</span></code><span class="koboSpan" id="kobo.2591.1"> folder containing all the aggregate definitions (remember, we implemented aggregates as interfaces) – namely, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2592.1">IDestination</span></code><span class="koboSpan" id="kobo.2593.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2594.1">IPackage</span></code><span class="koboSpan" id="kobo.2595.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2596.1">IPackageEvent</span></code><span class="koboSpan" id="kobo.2597.1">. </span><span class="koboSpan" id="kobo.2597.2">Here, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2598.1">IPackageEvent</span></code><span class="koboSpan" id="kobo.2599.1"> is the aggregate associated with the table where we will place events to be propagated to other applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2600.1">As an example, let’s analyze </span><code class="inlineCode"><span class="koboSpan" id="kobo.2601.1">IPackage</span></code><span class="koboSpan" id="kobo.2602.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2603.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2604.1">interface</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2605.1">IPackage</span></span><span class="koboSpan" id="kobo.2606.1"> : </span><span class="hljs-title"><span class="koboSpan" id="kobo.2607.1">IEntity</span></span><span class="koboSpan" id="kobo.2608.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2609.1">int</span></span><span class="koboSpan" id="kobo.2610.1">&gt;
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2611.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2612.1">FullUpdate</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2613.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2614.1">IPackageFullEditDTO packageDTO</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2615.1">)</span></span><span class="koboSpan" id="kobo.2616.1">;
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2617.1">string</span></span><span class="koboSpan" id="kobo.2618.1"> Name { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2619.1">get</span></span><span class="koboSpan" id="kobo.2620.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2621.1">set</span></span><span class="koboSpan" id="kobo.2622.1">; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2623.1">null</span></span><span class="koboSpan" id="kobo.2624.1">!;
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2625.1">string</span></span><span class="koboSpan" id="kobo.2626.1"> Description { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2627.1">get</span></span><span class="koboSpan" id="kobo.2628.1">;} = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2629.1">null</span></span><span class="koboSpan" id="kobo.2630.1">!;
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2631.1">decimal</span></span><span class="koboSpan" id="kobo.2632.1"> Price { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2633.1">get</span></span><span class="koboSpan" id="kobo.2634.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2635.1">set</span></span><span class="koboSpan" id="kobo.2636.1">; }
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2637.1">int</span></span><span class="koboSpan" id="kobo.2638.1"> DurationInDays { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2639.1">get</span></span><span class="koboSpan" id="kobo.2640.1">; }
    DateTime? </span><span class="koboSpan" id="kobo.2640.2">StartValidityDate { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2641.1">get</span></span><span class="koboSpan" id="kobo.2642.1">;}
    DateTime? </span><span class="koboSpan" id="kobo.2642.2">EndValidityDate { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2643.1">get</span></span><span class="koboSpan" id="kobo.2644.1">; }
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2645.1">int</span></span><span class="koboSpan" id="kobo.2646.1"> DestinationId { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2647.1">get</span></span><span class="koboSpan" id="kobo.2648.1">; }
       
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2649.1">It contains the same properties as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2650.1">Package</span></code><span class="koboSpan" id="kobo.2651.1"> entity, which we saw in </span><em class="italic"><span class="koboSpan" id="kobo.2652.1">Chapter 13</span></em><span class="koboSpan" id="kobo.2653.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2654.1">Interacting with Data in C# – Entity Framework Core</span></em><span class="koboSpan" id="kobo.2655.1">. </span><span class="koboSpan" id="kobo.2655.2">The only differences are the following:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2656.1">It inherits from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2657.1">IEntity&lt;int&gt;</span></code><span class="koboSpan" id="kobo.2658.1">, which furnishes all basic functionalities of aggregates</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2659.1">It has no </span><code class="inlineCode"><span class="koboSpan" id="kobo.2660.1">Id</span></code><span class="koboSpan" id="kobo.2661.1"> property since it is inherited from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2662.1">IEntity&lt;int&gt;</span></code></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2663.1">All properties are read-only, and it has a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2664.1">FullUpdate</span></code><span class="koboSpan" id="kobo.2665.1"> method since all aggregates can only be modified through update operations defined in the user domain (in our case, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2666.1">FullUpdate</span></code><span class="koboSpan" id="kobo.2667.1"> method)</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2668.1">Now, let’s also add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2669.1">DTOs</span></code><span class="koboSpan" id="kobo.2670.1"> folder. </span><span class="koboSpan" id="kobo.2670.2">Here, we place all interfaces used to pass updates to the aggregates. </span><span class="koboSpan" id="kobo.2670.3">Such interfaces are implemented by the application layer ViewModels used to define such updates. </span><span class="koboSpan" id="kobo.2670.4">In our case, it contains </span><code class="inlineCode"><span class="koboSpan" id="kobo.2671.1">IPackageFullEditDTO</span></code><span class="koboSpan" id="kobo.2672.1">, which we can use to update existing </span><a id="_idIndexMarker1669"/><span class="koboSpan" id="kobo.2673.1">packages. </span><span class="koboSpan" id="kobo.2673.2">If you would like to add the logic to manage destinations, you must define an analogous interface for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2674.1">IDestination</span></code><span class="koboSpan" id="kobo.2675.1"> aggregate.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2676.1">An </span><code class="inlineCode"><span class="koboSpan" id="kobo.2677.1">IRepositories</span></code><span class="koboSpan" id="kobo.2678.1"> folder contains all repository specifications – namely, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2679.1">IDestinationRepository</span></code><span class="koboSpan" id="kobo.2680.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2681.1">IPackageRepository</span></code><span class="koboSpan" id="kobo.2682.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2683.1">IPackageEventRepository</span></code><span class="koboSpan" id="kobo.2684.1">. </span><span class="koboSpan" id="kobo.2684.2">Here, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2685.1">IPackageEventRepository</span></code><span class="koboSpan" id="kobo.2686.1"> is the repository associated with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2687.1">IPackageEvent</span></code><span class="koboSpan" id="kobo.2688.1"> aggregate. </span><span class="koboSpan" id="kobo.2688.2">As an example, let’s have a look at the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2689.1">IPackageRepository</span></code><span class="koboSpan" id="kobo.2690.1"> repository:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2691.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2692.1">interface</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2693.1">IPackageRepository</span></span><span class="koboSpan" id="kobo.2694.1">:
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2695.1">IRepository</span></span><span class="koboSpan" id="kobo.2696.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2697.1">IPackage</span></span><span class="koboSpan" id="kobo.2698.1">&gt;
{
    Task&lt;IPackage?&gt; GetAsync(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2699.1">int</span></span><span class="koboSpan" id="kobo.2700.1"> id);
    </span><span class="hljs-function"><span class="koboSpan" id="kobo.2701.1">IPackage </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.2702.1">New</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2703.1">()</span></span><span class="koboSpan" id="kobo.2704.1">;
    Task&lt;IPackage?&gt; Delete(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2705.1">int</span></span><span class="koboSpan" id="kobo.2706.1"> id);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2707.1">Repositories always contain just a few methods since all business logic should be represented as aggregate methods – in our case, just the methods to create a new package, to retrieve an existing package, and to delete an existing package. </span><span class="koboSpan" id="kobo.2707.2">The logic to modify an existing package is included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2708.1">FullUpdate</span></code><span class="koboSpan" id="kobo.2709.1"> method of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2710.1">IPackage</span></code><span class="koboSpan" id="kobo.2711.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2712.1">Finally, as with all domain layer projects, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2713.1">PackagesManagementDomain</span></code><span class="koboSpan" id="kobo.2714.1"> contains an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2715.1">Events</span></code><span class="koboSpan" id="kobo.2716.1"> folder containing all domain event definitions. </span><span class="koboSpan" id="kobo.2716.2">In our case, the folder is named </span><code class="inlineCode"><span class="koboSpan" id="kobo.2717.1">Events</span></code><span class="koboSpan" id="kobo.2718.1"> and contains the package-deleted event and the price-changed event:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2719.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2720.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2721.1">PackageDeleteEvent</span></span><span class="koboSpan" id="kobo.2722.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.2723.1">IEventNotification</span></span><span class="koboSpan" id="kobo.2724.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2725.1">public</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2726.1">PackageDeleteEvent</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2727.1">(</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2728.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2729.1"> id, </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2730.1">long</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2731.1"> oldVersion</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2732.1">)</span></span><span class="koboSpan" id="kobo.2733.1">
    {
        PackageId = id;
        OldVersion = oldVersion;
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2734.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2735.1">int</span></span><span class="koboSpan" id="kobo.2736.1"> PackageId { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2737.1">get</span></span><span class="koboSpan" id="kobo.2738.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2739.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2740.1">long</span></span><span class="koboSpan" id="kobo.2741.1"> OldVersion { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2742.1">get</span></span><span class="koboSpan" id="kobo.2743.1">; }
       
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2744.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2745.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2746.1">PackagePriceChangedEvent</span></span><span class="koboSpan" id="kobo.2747.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.2748.1">IEventNotification</span></span><span class="koboSpan" id="kobo.2749.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2750.1">public</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2751.1">PackagePriceChangedEvent</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2752.1">(</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2753.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2754.1"> id, </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2755.1">decimal</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2756.1"> price,</span></span>
<span class="hljs-params"> </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2757.1">long</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2758.1"> oldVersion, </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2759.1">long</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2760.1"> newVersion</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2761.1">)</span></span><span class="koboSpan" id="kobo.2762.1">
    {
            PackageId = id;
            NewPrice = price;
            OldVersion = oldVersion;
            NewVersion = newVersion;
     }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2763.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2764.1">int</span></span><span class="koboSpan" id="kobo.2765.1"> PackageId { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2766.1">get</span></span><span class="koboSpan" id="kobo.2767.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2768.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2769.1">decimal</span></span><span class="koboSpan" id="kobo.2770.1"> NewPrice { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2771.1">get</span></span><span class="koboSpan" id="kobo.2772.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2773.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2774.1">long</span></span><span class="koboSpan" id="kobo.2775.1"> OldVersion { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2776.1">get</span></span><span class="koboSpan" id="kobo.2777.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2778.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2779.1">long</span></span><span class="koboSpan" id="kobo.2780.1"> NewVersion { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2781.1">get</span></span><span class="koboSpan" id="kobo.2782.1">; }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2783.1">When an aggregate sends all its </span><a id="_idIndexMarker1670"/><span class="koboSpan" id="kobo.2784.1">changes to another application, it should have a version property. </span><span class="koboSpan" id="kobo.2784.2">The application that receives the changes uses this version property to apply all changes in the right order. </span><span class="koboSpan" id="kobo.2784.3">An explicit version number is necessary because changes are sent asynchronously, so the order in which they are received may differ from the order in which they were sent. </span><span class="koboSpan" id="kobo.2784.4">For this purpose, events that are used to publish changes outside of the application have both </span><code class="inlineCode"><span class="koboSpan" id="kobo.2785.1">OldVersion</span></code><span class="koboSpan" id="kobo.2786.1"> (the version before the change) and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2787.1">NewVersion</span></code><span class="koboSpan" id="kobo.2788.1"> (the version after the change) properties. </span><span class="koboSpan" id="kobo.2788.2">Events associated with delete events have no </span><code class="inlineCode"><span class="koboSpan" id="kobo.2789.1">NewVersion</span></code><span class="koboSpan" id="kobo.2790.1"> since, after being deleted, an entity can’t store any versions.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2791.1">For more details on how to use and process version information to restore the right order of incoming messages, please refer to the </span><em class="italic"><span class="koboSpan" id="kobo.2792.1">A worker microservice with ASP.NET Core</span></em><span class="koboSpan" id="kobo.2793.1"> section of this chapter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2794.1">The next subsection explains how all interfaces defined in the domain layer abstraction are implemented in the domain layer implementation.</span></p>
<h2 class="heading-2" id="_idParaDest-461"><span class="koboSpan" id="kobo.2795.1">Defining the domain layer implementation</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2796.1">The data layer project contains</span><a id="_idIndexMarker1671"/><span class="koboSpan" id="kobo.2797.1"> references to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2798.1">Microsoft.AspNetCore.Identity.EntityFrameworkCore</span></code><span class="koboSpan" id="kobo.2799.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2800.1">Microsoft.EntityFrameworkCore.SqlServer</span></code><span class="koboSpan" id="kobo.2801.1"> NuGet packages, since we are using Entity Framework Core with SQL Server. </span><span class="koboSpan" id="kobo.2801.2">It references </span><code class="inlineCode"><span class="koboSpan" id="kobo.2802.1">Microsoft.EntityFrameworkCore.Tools</span></code><span class="koboSpan" id="kobo.2803.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2804.1">Microsoft.EntityFrameworkCore.Design</span></code><span class="koboSpan" id="kobo.2805.1">, which are needed to generate database migrations, as explained in the </span><em class="italic"><span class="koboSpan" id="kobo.2806.1">Entity Framework Core migrations</span></em><span class="koboSpan" id="kobo.2807.1"> section of </span><em class="italic"><span class="koboSpan" id="kobo.2808.1">Chapter 13</span></em><span class="koboSpan" id="kobo.2809.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2810.1">Interacting with Data in C# – Entity Framework Core</span></em><span class="koboSpan" id="kobo.2811.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2812.1">We have a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2813.1">Models</span></code><span class="koboSpan" id="kobo.2814.1"> folder that contains all database entities. </span><span class="koboSpan" id="kobo.2814.2">They are similar to the ones in </span><em class="italic"><span class="koboSpan" id="kobo.2815.1">Chapter 13</span></em><span class="koboSpan" id="kobo.2816.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2817.1">Interacting with Data in C# – Entity Framework Core</span></em><span class="koboSpan" id="kobo.2818.1">. </span><span class="koboSpan" id="kobo.2818.2">The only differences are as follows:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2819.1">They inherit from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2820.1">Entity&lt;T&gt;</span></code><span class="koboSpan" id="kobo.2821.1">, which contains all the basic features of aggregates. </span><span class="koboSpan" id="kobo.2821.2">Please note that inheriting from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2822.1">Entity&lt;T&gt;</span></code><span class="koboSpan" id="kobo.2823.1"> is only needed for aggregate roots; all other entities must be defined as explained in </span><em class="italic"><span class="koboSpan" id="kobo.2824.1">Chapter 7</span></em><span class="koboSpan" id="kobo.2825.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2826.1">Understanding the Different Domains in Software Solutions.</span></em><span class="koboSpan" id="kobo.2827.1"> In our example, all entities are aggregate roots.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2828.1">They have no </span><code class="inlineCode"><span class="koboSpan" id="kobo.2829.1">Id</span></code><span class="koboSpan" id="kobo.2830.1"> since it is inherited from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2831.1">Entity&lt;T&gt;</span></code><span class="koboSpan" id="kobo.2832.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2833.1">Some of them have </span><a id="_idIndexMarker1672"/><span class="koboSpan" id="kobo.2834.1">an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2835.1">EntityVersion</span></code><span class="koboSpan" id="kobo.2836.1"> property that is decorated with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2837.1">[ConcurrencyCheck]</span></code><span class="koboSpan" id="kobo.2838.1"> attribute. </span><span class="koboSpan" id="kobo.2838.2">It contains the entity version, which is essential for propagating all entity changes to other applications. </span><span class="koboSpan" id="kobo.2838.3">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2839.1">ConcurrencyCheck</span></code><span class="koboSpan" id="kobo.2840.1"> attribute is needed to prevent concurrency errors while updating the entity version. </span><span class="koboSpan" id="kobo.2840.2">This prevents suffering the performance penalty implied by a transaction.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2841.1">More specifically, when saving entity changes, if the value of a field marked with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2842.1">ConcurrencyCheck</span></code><span class="koboSpan" id="kobo.2843.1"> attribute is different from the one that was read when the entity was loaded in memory, a concurrency exception is thrown to inform the calling method that someone else modified this value after the entity was read but before we attempted to save its changes. </span><span class="koboSpan" id="kobo.2843.2">This way, the calling method can repeat the whole operation with the hope that this time, no one will write the same entity in the database during its execution.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2844.1">The only alternative to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2845.1">ConcurrencyCheck</span></code><span class="koboSpan" id="kobo.2846.1"> attribute would be:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2847.1">Start a transaction.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2848.1">Read the interested aggregate.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2849.1">Increment its </span><code class="inlineCode"><span class="koboSpan" id="kobo.2850.1">EntityVersion</span></code><span class="koboSpan" id="kobo.2851.1"> property.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2852.1">Update the aggregate.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2853.1">Save all changes.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2854.1">Close the transaction.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2855.1">The transaction duration would be unacceptably long since the transaction should be maintained for the time of various database commands – namely, from the initial read to the final update – thus, preventing other requests from accessing the involved tables/records for too long a time.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2856.1">On the contrary, by using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2857.1">ConcurrencyCheck</span></code><span class="koboSpan" id="kobo.2858.1"> attribute, we open just a very short single-command transaction when the aggregate is saved to the database:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2859.1">Read the interested aggregate.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2860.1">Increment the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2861.1">EntityVersion</span></code><span class="koboSpan" id="kobo.2862.1"> property.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2863.1">Update the aggregate.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2864.1">Save all changes with a</span><a id="_idIndexMarker1673"/><span class="koboSpan" id="kobo.2865.1"> fast single-command transaction.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2866.1">It is worth analyzing the code of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2867.1">Package</span></code><span class="koboSpan" id="kobo.2868.1"> entity:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2869.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2870.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2871.1">Package</span></span><span class="koboSpan" id="kobo.2872.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.2873.1">Entity</span></span><span class="koboSpan" id="kobo.2874.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2875.1">int</span></span><span class="koboSpan" id="kobo.2876.1">&gt;, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2877.1">IPackage</span></span><span class="koboSpan" id="kobo.2878.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2879.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2880.1">void</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.2881.1">FullUpdate</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2882.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2883.1">IPackageFullEditDTO o</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2884.1">)</span></span><span class="koboSpan" id="kobo.2885.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2886.1">if</span></span><span class="koboSpan" id="kobo.2887.1"> (IsTransient())
        {
            Id = o.Id;
            DestinationId = o.DestinationId;
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2888.1">else</span></span><span class="koboSpan" id="kobo.2889.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2890.1">if</span></span><span class="koboSpan" id="kobo.2891.1"> (o.Price != </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2892.1">this</span></span><span class="koboSpan" id="kobo.2893.1">.Price)
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2894.1">this</span></span><span class="koboSpan" id="kobo.2895.1">.AddDomainEvent(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2896.1">new</span></span><span class="koboSpan" id="kobo.2897.1"> PackagePriceChangedEvent(
                        Id, o.Price, EntityVersion, EntityVersion+</span><span class="hljs-number"><span class="koboSpan" id="kobo.2898.1">1</span></span><span class="koboSpan" id="kobo.2899.1">));
        }
        Name = o.Name;
        Description = o.Description;
        Price = o.Price;
        DurationInDays = o.DurationInDays;
        StartValidityDate = o.StartValidityDate;
        EndValidityDate = o.EndValidityDate;
    }
    [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2900.1">MaxLength(128)</span></span><span class="koboSpan" id="kobo.2901.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2902.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2903.1">string</span></span><span class="koboSpan" id="kobo.2904.1"> Name { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2905.1">get</span></span><span class="koboSpan" id="kobo.2906.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2907.1">set</span></span><span class="koboSpan" id="kobo.2908.1">; }= </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2909.1">null</span></span><span class="koboSpan" id="kobo.2910.1">!;
    [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2911.1">MaxLength(128)</span></span><span class="koboSpan" id="kobo.2912.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2913.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2914.1">string</span></span><span class="koboSpan" id="kobo.2915.1">? </span><span class="koboSpan" id="kobo.2915.2">Description { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2916.1">get</span></span><span class="koboSpan" id="kobo.2917.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2918.1">set</span></span><span class="koboSpan" id="kobo.2919.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2920.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2921.1">decimal</span></span><span class="koboSpan" id="kobo.2922.1"> Price { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2923.1">get</span></span><span class="koboSpan" id="kobo.2924.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2925.1">set</span></span><span class="koboSpan" id="kobo.2926.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2927.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2928.1">int</span></span><span class="koboSpan" id="kobo.2929.1"> DurationInDays { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2930.1">get</span></span><span class="koboSpan" id="kobo.2931.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2932.1">set</span></span><span class="koboSpan" id="kobo.2933.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2934.1">public</span></span><span class="koboSpan" id="kobo.2935.1"> DateTime? </span><span class="koboSpan" id="kobo.2935.2">StartValidityDate { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2936.1">get</span></span><span class="koboSpan" id="kobo.2937.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2938.1">set</span></span><span class="koboSpan" id="kobo.2939.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2940.1">public</span></span><span class="koboSpan" id="kobo.2941.1"> DateTime? </span><span class="koboSpan" id="kobo.2941.2">EndValidityDate { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2942.1">get</span></span><span class="koboSpan" id="kobo.2943.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2944.1">set</span></span><span class="koboSpan" id="kobo.2945.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2946.1">public</span></span><span class="koboSpan" id="kobo.2947.1"> Destination MyDestination { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2948.1">get</span></span><span class="koboSpan" id="kobo.2949.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2950.1">set</span></span><span class="koboSpan" id="kobo.2951.1">; }= </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2952.1">null</span></span><span class="koboSpan" id="kobo.2953.1">!;
    [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2954.1">ConcurrencyCheck</span></span><span class="koboSpan" id="kobo.2955.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2956.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2957.1">long</span></span><span class="koboSpan" id="kobo.2958.1"> EntityVersion{ </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2959.1">get</span></span><span class="koboSpan" id="kobo.2960.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2961.1">set</span></span><span class="koboSpan" id="kobo.2962.1">; }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2963.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2964.1">int</span></span><span class="koboSpan" id="kobo.2965.1"> DestinationId { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2966.1">get</span></span><span class="koboSpan" id="kobo.2967.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2968.1">set</span></span><span class="koboSpan" id="kobo.2969.1">; }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2970.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2971.1">FullUpdate</span></code><span class="koboSpan" id="kobo.2972.1"> method is the only way to update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2973.1">IPackage</span></code><span class="koboSpan" id="kobo.2974.1"> aggregate. </span><span class="koboSpan" id="kobo.2974.2">When the price changes, add </span><code class="inlineCode"><span class="koboSpan" id="kobo.2975.1">PackagePriceChangedEvent</span></code><span class="koboSpan" id="kobo.2976.1"> to the entity list of events.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2977.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2978.1">MainDBContext.cs</span></code><span class="koboSpan" id="kobo.2979.1"> file </span><a id="_idIndexMarker1674"/><span class="koboSpan" id="kobo.2980.1">contains the database context definition. </span><span class="koboSpan" id="kobo.2980.2">It doesn’t inherit from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2981.1">DbContext</span></code><span class="koboSpan" id="kobo.2982.1"> but from the following predefined context class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2983.1">IdentityDbContext&lt;IdentityUser</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2984.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2985.1">int</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2986.1">&gt;</span></span><span class="koboSpan" id="kobo.2987.1">, IdentityRole</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2988.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2989.1">int</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2990.1">&gt;</span></span><span class="koboSpan" id="kobo.2991.1">, int&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2992.1">This context defines the user’s tables needed for the authentication. </span><span class="koboSpan" id="kobo.2992.2">In our case, we opted for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2993.1">IdentityUser&lt;T&gt;</span></code><span class="koboSpan" id="kobo.2994.1"> standard and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2995.1">IdentityRole&lt;S&gt;</span></code><span class="koboSpan" id="kobo.2996.1"> for users and roles, respectively, and used integers for both the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2997.1">T</span></code><span class="koboSpan" id="kobo.2998.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2999.1">S</span></code><span class="koboSpan" id="kobo.3000.1"> entity keys. </span><span class="koboSpan" id="kobo.3000.2">However, we may also use classes that inherit from </span><code class="inlineCode"><span class="koboSpan" id="kobo.3001.1">IdentityUser</span></code><span class="koboSpan" id="kobo.3002.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3003.1">IdentityRole</span></code><span class="koboSpan" id="kobo.3004.1"> and then add further properties.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3005.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3006.1">OnModelCreating</span></code><span class="koboSpan" id="kobo.3007.1"> method, we must call </span><code class="inlineCode"><span class="koboSpan" id="kobo.3008.1">base.OnModelCreating(builder)</span></code><span class="koboSpan" id="kobo.3009.1"> in order to apply the configuration defined in </span><code class="inlineCode"><span class="koboSpan" id="kobo.3010.1">IdentityDbContext</span></code><span class="koboSpan" id="kobo.3011.1">.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.3012.1">MainDBContext</span></code><span class="koboSpan" id="kobo.3013.1"> implements </span><code class="inlineCode"><span class="koboSpan" id="kobo.3014.1">IUnitOfWork</span></code><span class="koboSpan" id="kobo.3015.1">. </span><span class="koboSpan" id="kobo.3015.2">The following code shows the implementation of all methods that start, roll back, and commit a transaction:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3016.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3017.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3018.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3019.1">StartAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3020.1">()</span></span><span class="koboSpan" id="kobo.3021.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3022.1">await</span></span><span class="koboSpan" id="kobo.3023.1"> Database.BeginTransactionAsync();
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3024.1">public</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3025.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3026.1">CommitAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3027.1">()</span></span><span class="koboSpan" id="kobo.3028.1">
{
    Database.CommitTransaction();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3029.1">return</span></span><span class="koboSpan" id="kobo.3030.1"> Task.CompletedTask;
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3031.1">public</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3032.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3033.1">RollbackAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3034.1">()</span></span><span class="koboSpan" id="kobo.3035.1">
{
    Database.RollbackTransaction();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3036.1">return</span></span><span class="koboSpan" id="kobo.3037.1"> Task.CompletedTask;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3038.1">However, they are rarely used by command classes in a distributed environment. </span><span class="koboSpan" id="kobo.3038.2">This is because retrying the same operation until no concurrency exception is returned usually ensures better performance than transactions.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3039.1">It is worth analyzing the implementation of the method that passes all changes applied to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3040.1">DbContext</span></code><span class="koboSpan" id="kobo.3041.1"> to the database:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3042.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3043.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3044.1"> Task&lt;</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3045.1">bool</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3046.1">&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3047.1">SaveEntitiesAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3048.1">()</span></span><span class="koboSpan" id="kobo.3049.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3050.1">try</span></span><span class="koboSpan" id="kobo.3051.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3052.1">return</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3053.1">await</span></span><span class="koboSpan" id="kobo.3054.1"> SaveChangesAsync() &gt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.3055.1">0</span></span><span class="koboSpan" id="kobo.3056.1">;
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3057.1">catch</span></span><span class="koboSpan" id="kobo.3058.1"> (DbUpdateConcurrencyException ex)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3059.1">foreach</span></span><span class="koboSpan" id="kobo.3060.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3061.1">var</span></span><span class="koboSpan" id="kobo.3062.1"> entry </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3063.1">in</span></span><span class="koboSpan" id="kobo.3064.1"> ex.Entries)
        {
            entry.State = EntityState.Detached;
                        
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3065.1">throw</span></span><span class="koboSpan" id="kobo.3066.1">;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3067.1">The preceding</span><a id="_idIndexMarker1675"/><span class="koboSpan" id="kobo.3068.1"> implementation just calls the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3069.1">SaveChangesAsync</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.3070.1">DbContext</span></code><span class="koboSpan" id="kobo.3071.1"> context method, which saves all changes to the database, but then it intercepts all concurrency exceptions and detaches all the entities involved in the concurrency error from the context. </span><span class="koboSpan" id="kobo.3071.2">This way, the next time a command retries the whole failed operation, their updated versions will be reloaded from the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3072.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3073.1">Repositories</span></code><span class="koboSpan" id="kobo.3074.1"> folder contains all repository implementations. </span><span class="koboSpan" id="kobo.3074.2">It is worth analyzing the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3075.1">IPackageRepository.Delete</span></code><span class="koboSpan" id="kobo.3076.1"> method:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3077.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3078.1">async</span></span><span class="koboSpan" id="kobo.3079.1"> Task&lt;IPackage?&gt; Delete(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3080.1">int</span></span><span class="koboSpan" id="kobo.3081.1"> id)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3082.1">var</span></span><span class="koboSpan" id="kobo.3083.1"> model = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3084.1">await</span></span><span class="koboSpan" id="kobo.3085.1"> GetAsync(id);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3086.1">if</span></span><span class="koboSpan" id="kobo.3087.1"> (model </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3088.1">is</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3089.1">not</span></span><span class="koboSpan" id="kobo.3090.1"> Package package) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3091.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.3092.1">null</span></span><span class="koboSpan" id="kobo.3093.1">;
    context.Packages.Remove(package);
    model.AddDomainEvent(
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3094.1">new</span></span><span class="koboSpan" id="kobo.3095.1"> PackageDeleteEvent(
            model.Id, package.EntityVersion));
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3096.1">return</span></span><span class="koboSpan" id="kobo.3097.1"> model;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3098.1">It reads the entity from the database and formally removes it from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3099.1">Packages</span></code><span class="koboSpan" id="kobo.3100.1"> dataset. </span><span class="koboSpan" id="kobo.3100.2">This will force the entity to be deleted from the database when changes are saved to the database. </span><span class="koboSpan" id="kobo.3100.3">Moreover, it adds </span><code class="inlineCode"><span class="koboSpan" id="kobo.3101.1">PackageDeleteEvent</span></code><span class="koboSpan" id="kobo.3102.1"> to the aggregate list of events.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3103.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3104.1">Extensions</span></code><span class="koboSpan" id="kobo.3105.1"> folder </span><a id="_idIndexMarker1676"/><span class="koboSpan" id="kobo.3106.1">contains the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3107.1">DBExtensions</span></code><span class="koboSpan" id="kobo.3108.1"> static class, which, in turn, defines two extension methods to be added to the application DI engine and the ASP.NET Core pipeline, respectively. </span><span class="koboSpan" id="kobo.3108.2">Once added to the pipeline, these two methods will connect the database layer to the application layer.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3109.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3110.1">IServiceCollection</span></code><span class="koboSpan" id="kobo.3111.1"> extension of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3112.1">AddDbLayer</span></code><span class="koboSpan" id="kobo.3113.1"> accepts (as its input parameters) the database connection string and the name of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3114.1">.dll</span></code><span class="koboSpan" id="kobo.3115.1"> file that contains all migrations. </span><span class="koboSpan" id="kobo.3115.2">Then, it does the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3116.1">services.AddDbContext&lt;MainDbContext&gt;(options =&gt;
                options.UseSqlServer(connectionString,
                b =&gt; b.MigrationsAssembly(migrationAssembly)));
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3117.1">That is, it adds the database context to the DI engine and defines its options – namely, that it uses SQL Server, the database connection string, and the name of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3118.1">.dll</span></code><span class="koboSpan" id="kobo.3119.1"> file that contains all migrations.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3120.1">Then, it does the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3121.1">services.AddIdentity&lt;IdentityUser&lt;</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3122.1">int</span></span><span class="koboSpan" id="kobo.3123.1">&gt;, IdentityRole&lt;</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3124.1">int</span></span><span class="koboSpan" id="kobo.3125.1">&gt;&gt;()
                .AddEntityFrameworkStores&lt;MainDbContext&gt;()
                .AddDefaultTokenProviders();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3126.1">That is, it adds and configures all the types needed to handle database-based authentication and authorization. </span><span class="koboSpan" id="kobo.3126.2">It adds </span><code class="inlineCode"><span class="koboSpan" id="kobo.3127.1">UserManager</span></code><span class="koboSpan" id="kobo.3128.1">, which the application layer can use to manage users. </span><code class="inlineCode"><span class="koboSpan" id="kobo.3129.1">AddDefaultTokenProviders</span></code><span class="koboSpan" id="kobo.3130.1"> adds the provider that creates the authentication tokens using data contained in the database when users log in.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3131.1">Finally, it discovers and adds to the DI engine all repository implementations by calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3132.1">AddAllRepositories</span></code><span class="koboSpan" id="kobo.3133.1"> method, which is defined in the DDD tools we added to the domain layer project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3134.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3135.1">UseDBLayer</span></code><span class="koboSpan" id="kobo.3136.1"> extension method ensures migrations are applied to the database by calling </span><code class="inlineCode"><span class="koboSpan" id="kobo.3137.1">context.Database.Migrate()</span></code><span class="koboSpan" id="kobo.3138.1">, and then it populates the database with some initial objects. </span><span class="koboSpan" id="kobo.3138.2">In our case, it uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.3139.1">RoleManager</span></code><span class="koboSpan" id="kobo.3140.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3141.1">UserManager</span></code><span class="koboSpan" id="kobo.3142.1"> to create an administrative role and an initial administrator, respectively. </span><span class="koboSpan" id="kobo.3142.2">Then, it creates some sample destinations and packages.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.3143.1">context.Database.Migrate()</span></code><span class="koboSpan" id="kobo.3144.1"> is useful to quickly set up and update staging and test environments. </span><span class="koboSpan" id="kobo.3144.2">When deploying in production, if we don’t have the credentials for creating a new database or for modifying its structure, we can also produce an SQL script from the migrations using the migration tools. </span><span class="koboSpan" id="kobo.3144.3">Then, this script should be examined before being applied by the person in charge of maintaining the database and, finally, applied with their credentials.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3145.1">To create migrations, we </span><a id="_idIndexMarker1677"/><span class="koboSpan" id="kobo.3146.1">must add the aforementioned extension methods to the ASP.NET Core MVC </span><code class="inlineCode"><span class="koboSpan" id="kobo.3147.1">Program.cs</span></code><span class="koboSpan" id="kobo.3148.1"> file, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3149.1">    ...
    </span><span class="koboSpan" id="kobo.3149.2">builder.Services.AddRazorPages();
    builder.Services.AddDbLayer(
        builder.Configuration.GetConnectionString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3150.1">"DefaultConnection"</span></span><span class="koboSpan" id="kobo.3151.1">),
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.3152.1">"PackagesManagementDB"</span></span><span class="koboSpan" id="kobo.3153.1">);
    ...
    </span><span class="koboSpan" id="kobo.3153.2">app.UseAuthentication();
    app.UseAuthorization();
    ...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3154.1">Please be sure that both the authorization and authentication middleware have been added to the ASP.NET Core pipeline in the right order; otherwise, the authentication/authorization engine will not work.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3155.1">Then, we must add the connection string to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3156.1">appsettings.json</span></code><span class="koboSpan" id="kobo.3157.1"> file, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3158.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.3159.1">"ConnectionStrings"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3160.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.3161.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.3162.1">"DefaultConnection"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3163.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3164.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3165.1">Server=(localdb)\\mssqllocaldb;Database=package-management;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.3166.1">},</span></span><span class="koboSpan" id="kobo.3167.1">
    ...
</span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3168.1">}</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3169.1">Finally, let’s add </span><code class="inlineCode"><span class="koboSpan" id="kobo.3170.1">Microsoft.EntityFrameworkCore.Design</span></code><span class="koboSpan" id="kobo.3171.1"> to the ASP.NET Core project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3172.1">At this point, let’s open the Visual Studio Package Manager Console, select </span><code class="inlineCode"><span class="koboSpan" id="kobo.3173.1">PackageManagementDB</span></code><span class="koboSpan" id="kobo.3174.1"> as the default project, and then launch the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3175.1">Add-Migration Initial -Project PackageManagementDB
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3176.1">The preceding command will scaffold the first migration. </span><span class="koboSpan" id="kobo.3176.2">We may apply it to the database with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3177.1">Update-Database</span></code><span class="koboSpan" id="kobo.3178.1"> command. </span><span class="koboSpan" id="kobo.3178.2">Please note that if you copy the project from GitHub, you don’t need to scaffold migrations since they have already been created, but you still </span><a id="_idIndexMarker1678"/><span class="koboSpan" id="kobo.3179.1">need to update the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3180.1">In the next subsection, we will define the application layer that contains the business logic for manipulating the aggregates.</span></p>
<h2 class="heading-2" id="_idParaDest-462"><span class="koboSpan" id="kobo.3181.1">Defining the application layer</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3182.1">As a first step, for simplicity, let’s</span><a id="_idIndexMarker1679"/><span class="koboSpan" id="kobo.3183.1"> freeze the application culture to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3184.1">en-US</span></code><span class="koboSpan" id="kobo.3185.1"> by adding the following code to the ASP.NET Core pipeline:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3186.1">app.UseAuthorization();
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.3187.1">// Code to add: configure the Localization middleware</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3188.1">var</span></span><span class="koboSpan" id="kobo.3189.1"> ci = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3190.1">new</span></span><span class="koboSpan" id="kobo.3191.1"> CultureInfo(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3192.1">"en-US"</span></span><span class="koboSpan" id="kobo.3193.1">);
app.UseRequestLocalization(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3194.1">new</span></span><span class="koboSpan" id="kobo.3195.1"> RequestLocalizationOptions
{
    DefaultRequestCulture = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3196.1">new</span></span><span class="koboSpan" id="kobo.3197.1"> RequestCulture(ci),
    SupportedCultures = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3198.1">new</span></span><span class="koboSpan" id="kobo.3199.1"> List&lt;CultureInfo&gt;
    {
        ci,
    },
     SupportedUICultures = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3200.1">new</span></span><span class="koboSpan" id="kobo.3201.1"> List&lt;CultureInfo&gt;
    {
        ci,
    }
});
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3202.1">Then, let’s create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3203.1">Tools</span></code><span class="koboSpan" id="kobo.3204.1"> folder and place the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3205.1">ApplicationLayer</span></code><span class="koboSpan" id="kobo.3206.1"> code there, which you can find in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3207.1">ch11</span></code><span class="koboSpan" id="kobo.3208.1"> code of the GitHub repository associated with this book. </span><span class="koboSpan" id="kobo.3208.2">With these tools in place, we can add the code that automatically discovers and adds all queries, command handlers, and event handlers to the DI engine, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3209.1">...
</span><span class="koboSpan" id="kobo.3209.2">...
</span><span class="koboSpan" id="kobo.3209.3">builder.Services.AddAllQueries(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3210.1">this</span></span><span class="koboSpan" id="kobo.3211.1">.GetType().Assembly);
builder.Services.AddAllCommandHandlers(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3212.1">this</span></span><span class="koboSpan" id="kobo.3213.1">.GetType().Assembly);
builder.Services.AddAllEventHandlers(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3214.1">this</span></span><span class="koboSpan" id="kobo.3215.1">.GetType().Assembly);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3216.1">Then, we must add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3217.1">Queries</span></code><span class="koboSpan" id="kobo.3218.1"> folder to place all queries and their associated interfaces. </span><span class="koboSpan" id="kobo.3218.2">As an example, let’s</span><a id="_idIndexMarker1680"/><span class="koboSpan" id="kobo.3219.1"> have a look at the query that lists all packages:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3220.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3221.1">class</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.3222.1">PackagesListQuery</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3223.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3224.1">MainDbContext ctx</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3225.1">) :IPackagesListQuery</span></span><span class="koboSpan" id="kobo.3226.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3227.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3228.1">async</span></span><span class="koboSpan" id="kobo.3229.1"> Task&lt;IReadOnlyCollection&lt;PackageInfosViewModel&gt;&gt; GetAllPackages()
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3230.1">return</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3231.1">await</span></span><span class="koboSpan" id="kobo.3232.1"> ctx.Packages.Select(m =&gt; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3233.1">new</span></span><span class="koboSpan" id="kobo.3234.1"> PackageInfosViewModel
        {
            StartValidityDate = m.StartValidityDate,
            EndValidityDate = m.EndValidityDate,
            Name = m.Name,
            DurationInDays = m.DurationInDays,
            Id = m.Id,
            Price = m.Price,
            DestinationName = m.MyDestination.Name,
            DestinationId = m.DestinationId
        })
            .OrderByDescending(m=&gt; m.EndValidityDate)
            .ToListAsync();
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3235.1">The query object is automatically injected into the application DB context. </span><span class="koboSpan" id="kobo.3235.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3236.1">GetAllPackages</span></code><span class="koboSpan" id="kobo.3237.1"> method uses LINQ to project all of the required information into </span><code class="inlineCode"><span class="koboSpan" id="kobo.3238.1">PackageInfosViewModel</span></code><span class="koboSpan" id="kobo.3239.1"> and sorts all results in descending order on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3240.1">EndValidityDate</span></code><span class="koboSpan" id="kobo.3241.1"> property.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3242.1">Projections that involve several properties are time-wasting and error-prone; that’s why there are mapping libraries that automatically generate these projections using naming conventions and configuration settings. </span><span class="koboSpan" id="kobo.3242.2">Mapping libraries helps also in copying data from one object to another, such as, for example, from a ViewModel to a DTO, and vice versa.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3243.1">Among all mapping software, it is worth at </span><a id="_idIndexMarker1681"/><span class="koboSpan" id="kobo.3244.1">least mentioning AutoMapper (</span><a href="https://www.nuget.org/packages/AutoMapper"><span class="url"><span class="koboSpan" id="kobo.3245.1">https://www.nuget.org/packages/AutoMapper</span></span></a><span class="koboSpan" id="kobo.3246.1">).</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.3247.1">PackageInfosViewModel</span></code><span class="koboSpan" id="kobo.3248.1"> is placed in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3249.1">Models</span></code><span class="koboSpan" id="kobo.3250.1"> folder together with all other ViewModels. </span><span class="koboSpan" id="kobo.3250.2">It is common practice to organize ViewModels into folders by defining a different folder for each </span><a id="_idIndexMarker1682"/><span class="koboSpan" id="kobo.3251.1">controller. </span><span class="koboSpan" id="kobo.3251.2">It is worth analyzing the ViewModel used for editing packages:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3252.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3253.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3254.1">PackageFullEditViewModel</span></span><span class="koboSpan" id="kobo.3255.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.3256.1">IPackageFullEditDTO</span></span><span class="koboSpan" id="kobo.3257.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3258.1">public</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.3259.1">PackageFullEditViewModel</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3260.1">()</span></span><span class="koboSpan" id="kobo.3261.1"> { }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3262.1">public</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.3263.1">PackageFullEditViewModel</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3264.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3265.1">IPackage o</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3266.1">)</span></span><span class="koboSpan" id="kobo.3267.1">
        {
            Id = o.Id;
            DestinationId = o.DestinationId;
            Name = o.Name;
            Description = o.Description;
            Price = o.Price;
            DurationInDays = o.DurationInDays;
            StartValidityDate = o.StartValidityDate;
            EndValidityDate = o.EndValidityDate;
        }
        ...
        </span><span class="koboSpan" id="kobo.3267.2">...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3268.1">It has a constructor that accepts an </span><code class="inlineCode"><span class="koboSpan" id="kobo.3269.1">IPackage</span></code><span class="koboSpan" id="kobo.3270.1"> aggregate. </span><span class="koboSpan" id="kobo.3270.2">This way, package data is copied into the ViewModel that is used to populate the edit view. </span><span class="koboSpan" id="kobo.3270.3">It implements the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3271.1">IPackageFullEditDTO</span></code><span class="koboSpan" id="kobo.3272.1"> DTO interface defined in the domain layer. </span><span class="koboSpan" id="kobo.3272.2">This way, it can be directly used to send </span><code class="inlineCode"><span class="koboSpan" id="kobo.3273.1">IPackage</span></code><span class="koboSpan" id="kobo.3274.1"> updates to the domain layer.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3275.1">All properties contain validation attributes that are automatically used by client-side and server-side validation engines. </span><span class="koboSpan" id="kobo.3275.2">Each property contains a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3276.1">Display</span></code><span class="koboSpan" id="kobo.3277.1"> attribute that defines the label to give to the input field that will be used to edit the property. </span><span class="koboSpan" id="kobo.3277.2">It is better to place the field labels in the ViewModels than it is to place them directly into the views since, this way, the same names are automatically used in all views that use the same ViewModel. </span><span class="koboSpan" id="kobo.3277.3">The following code block lists all its properties:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3278.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.3279.1">int</span></span><span class="koboSpan" id="kobo.3280.1"> Id { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3281.1">get</span></span><span class="koboSpan" id="kobo.3282.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3283.1">set</span></span><span class="koboSpan" id="kobo.3284.1">; }
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3285.1">StringLength(128, MinimumLength = 5), Required</span></span><span class="koboSpan" id="kobo.3286.1">]
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3287.1">Display(Name = </span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3288.1">"name"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.3289.1">)</span></span><span class="koboSpan" id="kobo.3290.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3291.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.3292.1">string</span></span><span class="koboSpan" id="kobo.3293.1"> Name { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3294.1">get</span></span><span class="koboSpan" id="kobo.3295.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3296.1">set</span></span><span class="koboSpan" id="kobo.3297.1">; }= </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3298.1">null</span></span><span class="koboSpan" id="kobo.3299.1">!;
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3300.1">Display(Name = </span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3301.1">"package infos"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.3302.1">)</span></span><span class="koboSpan" id="kobo.3303.1">]
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3304.1">StringLength(128, MinimumLength = 10), Required</span></span><span class="koboSpan" id="kobo.3305.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3306.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.3307.1">string</span></span><span class="koboSpan" id="kobo.3308.1"> Description { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3309.1">get</span></span><span class="koboSpan" id="kobo.3310.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3311.1">set</span></span><span class="koboSpan" id="kobo.3312.1">; }= </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3313.1">null</span></span><span class="koboSpan" id="kobo.3314.1">!;
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3315.1">Display(Name = </span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3316.1">"price"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.3317.1">)</span></span><span class="koboSpan" id="kobo.3318.1">]
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3319.1">Range(0, 100000)</span></span><span class="koboSpan" id="kobo.3320.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3321.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.3322.1">decimal</span></span><span class="koboSpan" id="kobo.3323.1"> Price { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3324.1">get</span></span><span class="koboSpan" id="kobo.3325.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3326.1">set</span></span><span class="koboSpan" id="kobo.3327.1">; }
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3328.1">Display(Name = </span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3329.1">"duration in days"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.3330.1">)</span></span><span class="koboSpan" id="kobo.3331.1">]
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3332.1">Range(1, 90)</span></span><span class="koboSpan" id="kobo.3333.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3334.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.3335.1">int</span></span><span class="koboSpan" id="kobo.3336.1"> DurationInDays { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3337.1">get</span></span><span class="koboSpan" id="kobo.3338.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3339.1">set</span></span><span class="koboSpan" id="kobo.3340.1">; }
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3341.1">Display(Name = </span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3342.1">"available from"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.3343.1">), Required</span></span><span class="koboSpan" id="kobo.3344.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3345.1">public</span></span><span class="koboSpan" id="kobo.3346.1"> DateTime? </span><span class="koboSpan" id="kobo.3346.2">StartValidityDate { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3347.1">get</span></span><span class="koboSpan" id="kobo.3348.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3349.1">set</span></span><span class="koboSpan" id="kobo.3350.1">; }
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3351.1">Display(Name = </span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3352.1">"available to"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.3353.1">), Required</span></span><span class="koboSpan" id="kobo.3354.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3355.1">public</span></span><span class="koboSpan" id="kobo.3356.1"> DateTime? </span><span class="koboSpan" id="kobo.3356.2">EndValidityDate { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3357.1">get</span></span><span class="koboSpan" id="kobo.3358.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3359.1">set</span></span><span class="koboSpan" id="kobo.3360.1">; }
[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3361.1">Display(Name = </span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3362.1">"destination"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.3363.1">)</span></span><span class="koboSpan" id="kobo.3364.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3365.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.3366.1">int</span></span><span class="koboSpan" id="kobo.3367.1"> DestinationId { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3368.1">get</span></span><span class="koboSpan" id="kobo.3369.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3370.1">set</span></span><span class="koboSpan" id="kobo.3371.1">; }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3372.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3373.1">Commands</span></code><span class="koboSpan" id="kobo.3374.1"> folder </span><a id="_idIndexMarker1683"/><span class="koboSpan" id="kobo.3375.1">contains all commands. </span><span class="koboSpan" id="kobo.3375.2">As an example, let’s have a look at the command used to modify packages:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3376.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3377.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3378.1">UpdatePackageCommand</span></span><span class="koboSpan" id="kobo.3379.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.3380.1">ICommand</span></span><span class="koboSpan" id="kobo.3381.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3382.1">public</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.3383.1">UpdatePackageCommand</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3384.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3385.1">IPackageFullEditDTO updates</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3386.1">)</span></span><span class="koboSpan" id="kobo.3387.1">
    {
        Updates = updates;
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3388.1">public</span></span><span class="koboSpan" id="kobo.3389.1"> IPackageFullEditDTO Updates { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3390.1">get</span></span><span class="koboSpan" id="kobo.3391.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3392.1">private</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3393.1">set</span></span><span class="koboSpan" id="kobo.3394.1">; }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3395.1">Its constructor must be invoked with an implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3396.1">IPackageFullEditDTO</span></code><span class="koboSpan" id="kobo.3397.1"> DTO interface, which, in our case, is the edit ViewModel we described previously. </span><span class="koboSpan" id="kobo.3397.2">Command handlers are placed in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3398.1">Handlers</span></code><span class="koboSpan" id="kobo.3399.1"> folder. </span><span class="koboSpan" id="kobo.3399.2">It is worth analyzing the command that updates packages:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3400.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3401.1">class</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.3402.1">UpdatePackageCommandHandler</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3403.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3404.1">IPackageRepository repo, IEventMediator mediator</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3405.1">)</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3406.1">Its principal constructor has automatically injected the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3407.1">IPackageRepository</span></code><span class="koboSpan" id="kobo.3408.1"> repository and an </span><code class="inlineCode"><span class="koboSpan" id="kobo.3409.1">IEventMediator</span></code><span class="koboSpan" id="kobo.3410.1"> instance needed to trigger event handlers. </span><span class="koboSpan" id="kobo.3410.2">The following code also shows the implementation of the standard </span><code class="inlineCode"><span class="koboSpan" id="kobo.3411.1">HandleAsync</span></code><span class="koboSpan" id="kobo.3412.1"> command handler method:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3413.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3414.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3415.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3416.1">HandleAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3417.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3418.1">UpdatePackageCommand command</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3419.1">)</span></span><span class="koboSpan" id="kobo.3420.1">
{
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3421.1">bool</span></span><span class="koboSpan" id="kobo.3422.1"> done = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3423.1">false</span></span><span class="koboSpan" id="kobo.3424.1">;
    IPackage model;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3425.1">while</span></span><span class="koboSpan" id="kobo.3426.1"> (!done)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3427.1">try</span></span><span class="koboSpan" id="kobo.3428.1">
        {
            model = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3429.1">await</span></span><span class="koboSpan" id="kobo.3430.1"> repo.GetAsync(command.Updates.Id);
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3431.1">if</span></span><span class="koboSpan" id="kobo.3432.1"> (model == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3433.1">null</span></span><span class="koboSpan" id="kobo.3434.1">) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3435.1">return</span></span><span class="koboSpan" id="kobo.3436.1">;
            model.FullUpdate(command.Updates);
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3437.1">await</span></span><span class="koboSpan" id="kobo.3438.1"> mediator.TriggerEvents(model.DomainEvents);
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3439.1">await</span></span><span class="koboSpan" id="kobo.3440.1"> repo.UnitOfWork.SaveEntitiesAsync();
            done = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3441.1">true</span></span><span class="koboSpan" id="kobo.3442.1">;
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3443.1">catch</span></span><span class="koboSpan" id="kobo.3444.1"> (DbUpdateConcurrencyException)
        {
          </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3445.1">// add some logging here</span></span><span class="koboSpan" id="kobo.3446.1">
        }
    }
}
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.3447.1">HandleAsync</span></code><span class="koboSpan" id="kobo.3448.1"> uses the</span><a id="_idIndexMarker1684"/><span class="koboSpan" id="kobo.3449.1"> repository to get an instance of the entity to modify. </span><span class="koboSpan" id="kobo.3449.2">If the entity is not found (it has been deleted), the commands stop its execution. </span><span class="koboSpan" id="kobo.3449.3">Otherwise, all changes are passed to the retrieved aggregate. </span><span class="koboSpan" id="kobo.3449.4">Immediately after the update, all events contained in the aggregate are triggered. </span><span class="koboSpan" id="kobo.3449.5">In particular, if the price has changed, the event handler associated with the price change is executed. </span><span class="koboSpan" id="kobo.3449.6">The concurrency check declared with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3450.1">[ConcurrencyCheck]</span></code><span class="koboSpan" id="kobo.3451.1"> attribute on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3452.1">EntityVersion</span></code><span class="koboSpan" id="kobo.3453.1"> property of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3454.1">Package</span></code><span class="koboSpan" id="kobo.3455.1"> entity ensures that the package version is updated properly (by incrementing its previous version number by 1), as well as that the price-changed event is passed the right version numbers.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3456.1">Also, event handlers are placed in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3457.1">Handlers</span></code><span class="koboSpan" id="kobo.3458.1"> folder. </span><span class="koboSpan" id="kobo.3458.2">As an example, let’s have a look at the price-changed event handler:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3459.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3460.1">class</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.3461.1">PackagePriceChangedEventHandler</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3462.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3463.1"> IPackageEventRepository repo</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3464.1">) :</span></span>
<span class="hljs-function"><span class="koboSpan" id="kobo.3465.1">	IEventHandler&lt;PackagePriceChangedEvent&gt;</span></span><span class="koboSpan" id="kobo.3466.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3467.1">public</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3468.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3469.1">HandleAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3470.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3471.1">PackagePriceChangedEvent ev</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3472.1">)</span></span><span class="koboSpan" id="kobo.3473.1">
    {
        repo.New(PackageEventType.CostChanged, ev.PackageId,
            ev.OldVersion, ev.NewVersion, ev.NewPrice);
      </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3474.1">return</span></span><span class="koboSpan" id="kobo.3475.1"> Task.CompletedTask;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3476.1">The principal constructor has automatically injected the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3477.1">IPackageEventRepository</span></code><span class="koboSpan" id="kobo.3478.1"> repository, which handles the database table and all the events to send to other applications. </span><span class="koboSpan" id="kobo.3478.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3479.1">HandleAsync</span></code><span class="koboSpan" id="kobo.3480.1"> implementation simply calls the repository method, which adds a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.3481.1">IPackageEvent</span></code><span class="koboSpan" id="kobo.3482.1"> to a queue of events to be sent to other microservices.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3483.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3484.1">IPackageEvent</span></code><span class="koboSpan" id="kobo.3485.1"> records should be extracted by the above queue and sent to all interested microservices by a</span><a id="_idIndexMarker1685"/><span class="koboSpan" id="kobo.3486.1"> parallel task, which is not implemented in the GitHub code associated with this section. </span><span class="koboSpan" id="kobo.3486.2">It can be implemented as a hosted service (thus inheriting from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3487.1">BackgroundService</span></code><span class="koboSpan" id="kobo.3488.1"> class) and then added to the DI engine with a call such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.3489.1">builder.Services.AddHostedService&lt;MyHostedService&gt;()</span></code><span class="koboSpan" id="kobo.3490.1">, as detailed in the </span><em class="italic"><span class="koboSpan" id="kobo.3491.1">Using generic hosts</span></em><span class="koboSpan" id="kobo.3492.1"> subsection of </span><em class="italic"><span class="koboSpan" id="kobo.3493.1">Chapter 11</span></em><span class="koboSpan" id="kobo.3494.1">, </span><em class="italic"><span class="koboSpan" id="kobo.3495.1">Applying a Microservice Architecture to Your Enterprise Application</span></em><span class="koboSpan" id="kobo.3496.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3497.1">We are almost finished! </span><span class="koboSpan" id="kobo.3497.2">Just the presentation layer is missing, which, in the case of an MVC-based application, consists of controllers and views. </span><span class="koboSpan" id="kobo.3497.3">The next subsection defines both controllers and views needed by our microservice.</span></p>
<h2 class="heading-2" id="_idParaDest-463"><span class="koboSpan" id="kobo.3498.1">Defining controllers and views</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3499.1">We need to add two more controllers to</span><a id="_idIndexMarker1686"/><span class="koboSpan" id="kobo.3500.1"> the one automatically scaffolded by Visual Studio – namely, </span><code class="inlineCode"><span class="koboSpan" id="kobo.3501.1">AccountController</span></code><span class="koboSpan" id="kobo.3502.1">, which takes care of user login/logout and registration, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3503.1">ManagePackageController</span></code><span class="koboSpan" id="kobo.3504.1">, which handles all package-related operations. </span><span class="koboSpan" id="kobo.3504.2">It is enough to right-click on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3505.1">Controllers</span></code><span class="koboSpan" id="kobo.3506.1"> folder and then select </span><strong class="screenText"><span class="koboSpan" id="kobo.3507.1">Add | Controller</span></strong><span class="koboSpan" id="kobo.3508.1">. </span><span class="koboSpan" id="kobo.3508.2">Then, choose the controller name and select the empty MVC controller to avoid the possibility of Visual Studio scaffolding code you don’t need.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3509.1"><img alt="" role="presentation" src="../Images/B19820_21_27.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3510.1">Figure 21.27: Adding AccountController</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3511.1">It is worth pointing out that Visual Studio can automatically scaffold all of the UI for managing users if one </span><a id="_idIndexMarker1687"/><span class="koboSpan" id="kobo.3512.1">selects to automatically add authentication when the MVC project is created. </span><span class="koboSpan" id="kobo.3512.2">However, scaffolded code doesn’t respect any layer or onions architecture: it inserts everything in the MVC project. </span><span class="koboSpan" id="kobo.3512.3">That’s why we decided to proceed manually.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3513.1">For simplicity, our implementation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3514.1">AccountController</span></code><span class="koboSpan" id="kobo.3515.1"> just has login and logout methods, so you can log in just with the initial administrator user. </span><span class="koboSpan" id="kobo.3515.2">However, you can add further action methods that use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3516.1">UserManager</span></code><span class="koboSpan" id="kobo.3517.1"> class to define, update, and delete users.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3518.1"><img alt="" role="presentation" src="../Images/B19820_21_28.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3519.1">Figure 21.28: Login, logout, and authentication</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3520.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3521.1">UserManager</span></code><span class="koboSpan" id="kobo.3522.1"> class can</span><a id="_idIndexMarker1688"/><span class="koboSpan" id="kobo.3523.1"> be provided through DI, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3524.1">public</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.3525.1">AccountController</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3526.1">(</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.3527.1">  UserManager&lt;IdentityUser&lt;</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3528.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3529.1">&gt;&gt; userManager,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.3530.1">  SignInManager&lt;IdentityUser&lt;</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3531.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3532.1">&gt;&gt; signInManager</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3533.1">) : Controller</span></span>
</code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.3534.1">SignInManager</span></code><span class="koboSpan" id="kobo.3535.1"> takes care of login/logout operations. </span><span class="koboSpan" id="kobo.3535.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3536.1">Logout</span></code><span class="koboSpan" id="kobo.3537.1"> action method is quite simple and is shown here (for more information on authentication in ASP.NET Core, please refer to the </span><em class="italic"><span class="koboSpan" id="kobo.3538.1">Defining the ASP.NET Core pipeline</span></em><span class="koboSpan" id="kobo.3539.1"> section of </span><em class="italic"><span class="koboSpan" id="kobo.3540.1">Chapter 17</span></em><span class="koboSpan" id="kobo.3541.1">, </span><em class="italic"><span class="koboSpan" id="kobo.3542.1">Presenting ASP.NET Core</span></em><span class="koboSpan" id="kobo.3543.1">):</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3544.1">[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3545.1">HttpPost</span></span><span class="koboSpan" id="kobo.3546.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3547.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3548.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3549.1"> Task&lt;IActionResult&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3550.1">Logout</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3551.1">()</span></span><span class="koboSpan" id="kobo.3552.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3553.1">await</span></span><span class="koboSpan" id="kobo.3554.1"> signInManager.SignOutAsync();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3555.1">return</span></span><span class="koboSpan" id="kobo.3556.1"> RedirectToAction(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3557.1">nameof</span></span><span class="koboSpan" id="kobo.3558.1">(HomeController.Index), </span><span class="hljs-string"><span class="koboSpan" id="kobo.3559.1">"Home"</span></span><span class="koboSpan" id="kobo.3560.1">);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3561.1">It just calls the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3562.1">signInManager.SignOutAsync</span></code><span class="koboSpan" id="kobo.3563.1"> method and then redirects the browser to the home page. </span><span class="koboSpan" id="kobo.3563.2">To avoid it being called by clicking a link, it is decorated with </span><code class="inlineCode"><span class="koboSpan" id="kobo.3564.1">HttpPost</span></code><span class="koboSpan" id="kobo.3565.1">, so it can only be invoked via a form submit.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.3566.1">All requests that cause modifications must never use a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3567.1">GET</span></code><span class="koboSpan" id="kobo.3568.1"> verb; otherwise, someone might erroneously trigger those actions either by clicking a link or by writing the wrong URL in the browser. </span><span class="koboSpan" id="kobo.3568.2">An action triggered by GET might also be exploited by a phishing website that might adequately “camouflage” a link that triggers a dangerous GET action. </span><span class="koboSpan" id="kobo.3568.3">The GET verb should be used just for retrieving information.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.3569.1">Login, on the other hand, requires</span><a id="_idIndexMarker1689"/><span class="koboSpan" id="kobo.3570.1"> two action methods. </span><span class="koboSpan" id="kobo.3570.2">The first one is invoked via </span><code class="inlineCode"><span class="koboSpan" id="kobo.3571.1">GET</span></code><span class="koboSpan" id="kobo.3572.1"> and shows the login form, where the user must place their username and password. </span><span class="koboSpan" id="kobo.3572.2">It is shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3573.1">[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3574.1">HttpGet</span></span><span class="koboSpan" id="kobo.3575.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3576.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3577.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3578.1"> Task&lt;IActionResult&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3579.1">Login</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3580.1">(</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3581.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3582.1">? </span><span class="koboSpan" id="kobo.3582.2">returnUrl = </span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.3583.1">null</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3584.1">)</span></span><span class="koboSpan" id="kobo.3585.1">
{
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3586.1">// Clear the existing external cookie</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.3587.1">//to ensure a clean login process</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3588.1">await</span></span><span class="koboSpan" id="kobo.3589.1"> HttpContext
         .SignOutAsync(IdentityConstants.ExternalScheme);
    ViewData[</span><span class="hljs-string"><span class="koboSpan" id="kobo.3590.1">"ReturnUrl"</span></span><span class="koboSpan" id="kobo.3591.1">] = returnUrl;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3592.1">return</span></span><span class="koboSpan" id="kobo.3593.1"> View();
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3594.1">It receives </span><code class="inlineCode"><span class="koboSpan" id="kobo.3595.1">returnUrl</span></code><span class="koboSpan" id="kobo.3596.1"> as its parameter when the browser is automatically redirected to the login page by the authorization module. </span><span class="koboSpan" id="kobo.3596.2">This happens when an unlogged-in user tries to access a protected page. </span><code class="inlineCode"><span class="koboSpan" id="kobo.3597.1">returnUrl</span></code><span class="koboSpan" id="kobo.3598.1"> is stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3599.1">ViewState</span></code><span class="koboSpan" id="kobo.3600.1"> dictionary that is passed to the login view. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.3601.1">The form in the login view passes it back to the controller, together with the username and password when it is submitted, as shown in this code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.3602.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3603.1">form</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3604.1">asp-route-returnurl</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3605.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3606.1">"@ViewData["</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.3607.1">ReturnUrl</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3608.1">"]" </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.3609.1">method</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3610.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3611.1">"post"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3612.1">&gt;</span></span><span class="koboSpan" id="kobo.3613.1">
...
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3614.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3615.1">form</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3616.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3617.1">The form post is intercepted by an action method with the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.3618.1">Login</span></code><span class="koboSpan" id="kobo.3619.1"> name but decorated with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3620.1">[HttpPost]</span></code><span class="koboSpan" id="kobo.3621.1"> attribute, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3622.1">[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3623.1">ValidateAntiForgeryToken</span></span><span class="koboSpan" id="kobo.3624.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3625.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3626.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3627.1"> Task&lt;IActionResult&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3628.1">Login</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3629.1">(</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.3630.1">    LoginViewModel model,</span></span>
<span class="hljs-params"> </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3631.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3632.1">? </span><span class="koboSpan" id="kobo.3632.2">returnUrl = </span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.3633.1">null</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3634.1">)</span></span><span class="koboSpan" id="kobo.3635.1">
        {
            ...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3636.1">The preceding method receives the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3637.1">Login</span></code><span class="koboSpan" id="kobo.3638.1"> model used by the login view, together with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3639.1">returnUrl</span></code><span class="koboSpan" id="kobo.3640.1"> query string parameter. </span><span class="koboSpan" id="kobo.3640.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3641.1">ValidateAntiForgeryToken</span></code><span class="koboSpan" id="kobo.3642.1"> attribute verifies a token (called an anti-forgery token) that MVC forms automatically. </span><span class="koboSpan" id="kobo.3642.2">This is then added to a hidden field to prevent XSRF/CSRF attacks.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.3643.1">Forgery attacks exploit authentication cookies stored in the victim’s browser to submit a legitimate authenticated request to a web application. </span><span class="koboSpan" id="kobo.3643.2">They do this by inducing the user to click a button on a phishing website that causes a submit to the target web application. </span><span class="koboSpan" id="kobo.3643.3">The fraudulent request is accepted since, once a form is submitted, the authentication cookies for the target URL are automatically sent by the browser. </span><span class="koboSpan" id="kobo.3643.4">There are just two defenses against this kind of attack:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.3644.1">Authentication cookies are defined as same-origin – that is, they are sent from other domains just in case of GET requests. </span><span class="koboSpan" id="kobo.3644.2">Thus, when a form is submitted from a phishing website to the target application, they are not sent.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3645.1">Anti-forgery tokens added to forms. </span><span class="koboSpan" id="kobo.3645.2">In this case, if authentication cookies are sent together with the submitted form, the application understands that the request comes from a different website and blocks it since it is missing a valid anti-forgery token.</span></li>
</ul>
</div>
<p class="normal"><span class="koboSpan" id="kobo.3646.1">As a first step, the action</span><a id="_idIndexMarker1690"/><span class="koboSpan" id="kobo.3647.1"> method logs the user out if they are already logged in:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3648.1">if</span></span><span class="koboSpan" id="kobo.3649.1"> (User.Identity.IsAuthenticated)
{
      </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3650.1">await</span></span><span class="koboSpan" id="kobo.3651.1"> signInManager.SignOutAsync();
     
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3652.1">Otherwise, it verifies whether there are validation errors, in which case, it shows the same view filled with the data of the ViewModel to let the user correct their errors:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3653.1">if</span></span><span class="koboSpan" id="kobo.3654.1"> (ModelState.IsValid)
{
     ...
</span><span class="koboSpan" id="kobo.3654.2">}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3655.1">else</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.3656.1">// If we got this far, something failed, redisplay form</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3657.1">return</span></span><span class="koboSpan" id="kobo.3658.1"> View(model);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3659.1">If the model is valid, </span><code class="inlineCode"><span class="koboSpan" id="kobo.3660.1">signInManager</span></code><span class="koboSpan" id="kobo.3661.1"> is used to log the user in:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3662.1">var</span></span><span class="koboSpan" id="kobo.3663.1"> result = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3664.1">await</span></span><span class="koboSpan" id="kobo.3665.1"> signInManager.PasswordSignInAsync(
    model.UserName,
    model.Password, model.RememberMe,
    lockoutOnFailure: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3666.1">false</span></span><span class="koboSpan" id="kobo.3667.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3668.1">If the result returned by the operation is successful, the action method redirects the browser to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3669.1">returnUrl</span></code><span class="koboSpan" id="kobo.3670.1"> if it’s not null; otherwise, it redirects the browser to the home page:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3671.1">if</span></span><span class="koboSpan" id="kobo.3672.1"> (result.Succeeded)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3673.1">if</span></span><span class="koboSpan" id="kobo.3674.1"> (!</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3675.1">string</span></span><span class="koboSpan" id="kobo.3676.1">.IsNullOrEmpty(returnUrl))
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3677.1">return</span></span><span class="koboSpan" id="kobo.3678.1"> LocalRedirect(returnUrl);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3679.1">else</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3680.1">return</span></span><span class="koboSpan" id="kobo.3681.1"> RedirectToAction(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3682.1">nameof</span></span><span class="koboSpan" id="kobo.3683.1">(HomeController.Index), </span><span class="hljs-string"><span class="koboSpan" id="kobo.3684.1">"Home"</span></span><span class="koboSpan" id="kobo.3685.1">);
}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3686.1">else</span></span><span class="koboSpan" id="kobo.3687.1">
{
    ModelState.AddModelError(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3688.1">string</span></span><span class="koboSpan" id="kobo.3689.1">.Empty,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.3690.1">"wrong username or password"</span></span><span class="koboSpan" id="kobo.3691.1">);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3692.1">return</span></span><span class="koboSpan" id="kobo.3693.1"> View(model);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3694.1">If the login fails, it adds an </span><a id="_idIndexMarker1691"/><span class="koboSpan" id="kobo.3695.1">error to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3696.1">ModelState</span></code><span class="koboSpan" id="kobo.3697.1"> and shows the same form to let the user try again.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.3698.1">ManagePackagesController</span></code><span class="koboSpan" id="kobo.3699.1"> contains an </span><code class="inlineCode"><span class="koboSpan" id="kobo.3700.1">Index</span></code><span class="koboSpan" id="kobo.3701.1"> method that shows all packages in table format (for more details on controllers, views, and the MVC pattern in general, please refer to the </span><em class="italic"><span class="koboSpan" id="kobo.3702.1">The MVC pattern</span></em><span class="koboSpan" id="kobo.3703.1"> section of </span><em class="italic"><span class="koboSpan" id="kobo.3704.1">Chapter 17</span></em><span class="koboSpan" id="kobo.3705.1">, </span><em class="italic"><span class="koboSpan" id="kobo.3706.1">Presenting ASP.NET Core</span></em><span class="koboSpan" id="kobo.3707.1">):</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3708.1">[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3709.1">HttpGet</span></span><span class="koboSpan" id="kobo.3710.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3711.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3712.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3713.1"> Task&lt;IActionResult&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3714.1">Index</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3715.1">(</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.3716.1">    [FromServices] IPackagesListQuery query</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3717.1">)</span></span><span class="koboSpan" id="kobo.3718.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3719.1">var</span></span><span class="koboSpan" id="kobo.3720.1"> results = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3721.1">await</span></span><span class="koboSpan" id="kobo.3722.1"> query.GetAllPackages();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3723.1">var</span></span><span class="koboSpan" id="kobo.3724.1"> vm = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3725.1">new</span></span><span class="koboSpan" id="kobo.3726.1"> PackagesListViewModel { Items = results };
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3727.1">return</span></span><span class="koboSpan" id="kobo.3728.1"> View(vm);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3729.1">The query object is injected into the action method by DI. </span><span class="koboSpan" id="kobo.3729.2">Then, the action method invokes it and inserts the resulting </span><code class="inlineCode"><span class="koboSpan" id="kobo.3730.1">IEnumerable</span></code><span class="koboSpan" id="kobo.3731.1"> into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3732.1">Items</span></code><span class="koboSpan" id="kobo.3733.1"> property of a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3734.1">PackagesListViewModel</span></code><span class="koboSpan" id="kobo.3735.1"> instance. </span><span class="koboSpan" id="kobo.3735.2">It is a good practice to include </span><code class="inlineCode"><span class="koboSpan" id="kobo.3736.1">IEnumerables</span></code><span class="koboSpan" id="kobo.3737.1"> in ViewModels instead of passing them directly to the views so that, if necessary, other properties can be added without the need to modify the existing view code.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3738.1">Moreover, it is good practice to define enumerable properties of ViewModels as </span><code class="inlineCode"><span class="koboSpan" id="kobo.3739.1">IReadOnlyCollection&lt;T&gt;</span></code><span class="koboSpan" id="kobo.3740.1"> if the enumerables are read-only or as </span><code class="inlineCode"><span class="koboSpan" id="kobo.3741.1">IList&lt;T&gt;</span></code><span class="koboSpan" id="kobo.3742.1"> if the enumerables can be modified or if they are involved in model binding. </span><span class="koboSpan" id="kobo.3742.2">In fact, </span><code class="inlineCode"><span class="koboSpan" id="kobo.3743.1">ICollection&lt;T&gt;</span></code><span class="koboSpan" id="kobo.3744.1"> has a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3745.1">Count</span></code><span class="koboSpan" id="kobo.3746.1"> property, which may be very useful when rendering ViewModels in views, while </span><code class="inlineCode"><span class="koboSpan" id="kobo.3747.1">IList&lt;T</span></code><span class="koboSpan" id="kobo.3748.1">&gt; also has indexers that are necessary for rendering all items with appropriate names for model binding to succeed (see this Phil Haack post: </span><a href="http://haacked.com/archive/2008/10/23/model-binding-to-a-list.aspx"><span class="url"><span class="koboSpan" id="kobo.3749.1">http://haacked.com/archive/2008/10/23/model-binding-to-a-list.aspx</span></span></a><span class="koboSpan" id="kobo.3750.1">). </span><code class="inlineCode"><span class="koboSpan" id="kobo.3751.1">IEnumerable&lt;T&gt;</span></code><span class="koboSpan" id="kobo.3752.1"> should be preferred only in the case that one needs the typical lazy evaluation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3753.1">IEnumerable&lt;T&gt;.</span></code></p>
<p class="normal"><span class="koboSpan" id="kobo.3754.1">The results are shown in a Bootstrap table since Bootstrap CSS is automatically scaffolded by Visual Studio. </span><span class="koboSpan" id="kobo.3754.2">Bootstrap</span><a id="_idIndexMarker1692"/><span class="koboSpan" id="kobo.3755.1"> is a good choice for a CSS framework, since it is quite simple and extensible, and is not connected to any particular company but is handled by an independent team.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3756.1">The result is shown here:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3757.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B19820_21_29.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3758.1">Figure 21.29: Application packages handling page</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3759.1">The </span><strong class="screenText"><span class="koboSpan" id="kobo.3760.1">New package</span></strong><span class="koboSpan" id="kobo.3761.1"> link (it is shaped like a </span><strong class="screenText"><span class="koboSpan" id="kobo.3762.1">Bootstrap</span></strong><span class="koboSpan" id="kobo.3763.1"> button, but it is a link) invokes a controller </span><code class="inlineCode"><span class="koboSpan" id="kobo.3764.1">Create</span></code><span class="koboSpan" id="kobo.3765.1"> action method, while the </span><strong class="screenText"><span class="koboSpan" id="kobo.3766.1">delete</span></strong><span class="koboSpan" id="kobo.3767.1"> and </span><strong class="screenText"><span class="koboSpan" id="kobo.3768.1">edit</span></strong><span class="koboSpan" id="kobo.3769.1"> links in each row invoke a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3770.1">Delete</span></code><span class="koboSpan" id="kobo.3771.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3772.1">Edit</span></code><span class="koboSpan" id="kobo.3773.1"> action method, respectively, and pass them the ID of the package shown in the row.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3774.1">Here is the implementation of the two row links:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3775.1">@foreach(var package in Model.Items)
{
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3776.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3777.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3778.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3779.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3780.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3781.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3782.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3783.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3784.1">asp-controller</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3785.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3786.1">"ManagePackages"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3787.1">asp-action</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3788.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3789.1">"@nameof(ManagePackagesController.Delete)"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3790.1">asp-route-id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3791.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3792.1">"@package.Id"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3793.1">&gt;</span></span><span class="koboSpan" id="kobo.3794.1">
            delete
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3795.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3796.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3797.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3798.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3799.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3800.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3801.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3802.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3803.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3804.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3805.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3806.1">asp-controller</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3807.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3808.1">"ManagePackages"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3809.1">asp-action</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3810.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3811.1">"@nameof(ManagePackagesController.Edit)"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3812.1">asp-route-id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3813.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3814.1">"@package.Id"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3815.1">&gt;</span></span><span class="koboSpan" id="kobo.3816.1">
            edit
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3817.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3818.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3819.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3820.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3821.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3822.1">&gt;</span></span><span class="koboSpan" id="kobo.3823.1">
    ...
    </span><span class="koboSpan" id="kobo.3823.2">...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3824.1">It is worth describing the code of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3825.1">HttpGet</span></code><span class="koboSpan" id="kobo.3826.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3827.1">HttpPost</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.3828.1">Edit</span></code><span class="koboSpan" id="kobo.3829.1"> action methods:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3830.1">[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3831.1">HttpGet</span></span><span class="koboSpan" id="kobo.3832.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3833.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3834.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3835.1"> Task&lt;IActionResult&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3836.1">Edit</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3837.1">(</span></span>
<span class="hljs-params"> </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3838.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3839.1"> id,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.3840.1">    [FromServices] IPackageRepository repo</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3841.1">)</span></span><span class="koboSpan" id="kobo.3842.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3843.1">if</span></span><span class="koboSpan" id="kobo.3844.1"> (id == </span><span class="hljs-number"><span class="koboSpan" id="kobo.3845.1">0</span></span><span class="koboSpan" id="kobo.3846.1">) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3847.1">return</span></span><span class="koboSpan" id="kobo.3848.1"> RedirectToAction(
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3849.1">nameof</span></span><span class="koboSpan" id="kobo.3850.1">(ManagePackagesController.Index));
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3851.1">var</span></span><span class="koboSpan" id="kobo.3852.1"> aggregate = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3853.1">await</span></span><span class="koboSpan" id="kobo.3854.1"> repo.Get(id);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3855.1">if</span></span><span class="koboSpan" id="kobo.3856.1"> (aggregate == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3857.1">null</span></span><span class="koboSpan" id="kobo.3858.1">) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3859.1">return</span></span><span class="koboSpan" id="kobo.3860.1"> RedirectToAction(
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3861.1">nameof</span></span><span class="koboSpan" id="kobo.3862.1">(ManagePackagesController.Index));
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3863.1">var</span></span><span class="koboSpan" id="kobo.3864.1"> vm = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3865.1">new</span></span><span class="koboSpan" id="kobo.3866.1"> PackageFullEditViewModel(aggregate);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3867.1">return</span></span><span class="koboSpan" id="kobo.3868.1"> View(vm);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3869.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3870.1">Edit</span></code><span class="koboSpan" id="kobo.3871.1"> method of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3872.1">HttpGet</span></code><span class="koboSpan" id="kobo.3873.1"> uses </span><code class="inlineCode"><span class="koboSpan" id="kobo.3874.1">IPackageRepository</span></code><span class="koboSpan" id="kobo.3875.1"> to retrieve the existing package. </span><span class="koboSpan" id="kobo.3875.2">If the package is not</span><a id="_idIndexMarker1693"/><span class="koboSpan" id="kobo.3876.1"> found, that means it has been deleted by some other user, and the browser is redirected again to the list page to show the updated list of packages. </span><span class="koboSpan" id="kobo.3876.2">Otherwise, the aggregate is passed to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3877.1">PackageFullEditViewModel</span></code><span class="koboSpan" id="kobo.3878.1"> ViewModel, which is rendered by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3879.1">Edit</span></code><span class="koboSpan" id="kobo.3880.1"> view.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3881.1">The view used to render the package must render an HTML </span><code class="inlineCode"><span class="koboSpan" id="kobo.3882.1">select</span></code><span class="koboSpan" id="kobo.3883.1"> with all possible package destinations, so it needs an instance of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3884.1">IDestinationListQuery</span></code><span class="koboSpan" id="kobo.3885.1"> query that was implemented to assist with the destination selection HTML logic. </span><span class="koboSpan" id="kobo.3885.2">This query is injected directly into the view since it is the view’s responsibility to decide how to enable the user to select a destination. </span><span class="koboSpan" id="kobo.3885.3">The code that injects the query and uses it is shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3886.1">@inject PackagesManagement.Queries.IDestinationListQuery destinationsQuery
@{
    ViewData[</span><span class="hljs-string"><span class="koboSpan" id="kobo.3887.1">"Title"</span></span><span class="koboSpan" id="kobo.3888.1">] = </span><span class="hljs-string"><span class="koboSpan" id="kobo.3889.1">"Edit/Create package"</span></span><span class="koboSpan" id="kobo.3890.1">;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3891.1">var</span></span><span class="koboSpan" id="kobo.3892.1"> allDestinations =
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3893.1">await</span></span><span class="koboSpan" id="kobo.3894.1"> destinationsQuery.AllDestinations();
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3895.1">The action method that </span><a id="_idIndexMarker1694"/><span class="koboSpan" id="kobo.3896.1">processes the post of the view form is given here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3897.1">[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3898.1">HttpPost</span></span><span class="koboSpan" id="kobo.3899.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3900.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3901.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3902.1"> Task&lt;IActionResult&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.3903.1">Edit</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3904.1">(</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.3905.1">    PackageFullEditViewModel vm,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.3906.1">    [FromServices] ICommandHandler&lt;UpdatePackageCommand&gt; command</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3907.1">)</span></span><span class="koboSpan" id="kobo.3908.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3909.1">if</span></span><span class="koboSpan" id="kobo.3910.1"> (ModelState.IsValid)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3911.1">await</span></span><span class="koboSpan" id="kobo.3912.1"> command.HandleAsync(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3913.1">new</span></span><span class="koboSpan" id="kobo.3914.1"> UpdatePackageCommand(vm));
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3915.1">return</span></span><span class="koboSpan" id="kobo.3916.1"> RedirectToAction(
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3917.1">nameof</span></span><span class="koboSpan" id="kobo.3918.1">(ManagePackagesController.Index));
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3919.1">else</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3920.1">return</span></span><span class="koboSpan" id="kobo.3921.1"> View(vm);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3922.1">If </span><code class="inlineCode"><span class="koboSpan" id="kobo.3923.1">ModelState</span></code><span class="koboSpan" id="kobo.3924.1"> is valid, </span><code class="inlineCode"><span class="koboSpan" id="kobo.3925.1">UpdatePackageCommand</span></code><span class="koboSpan" id="kobo.3926.1"> is created and its associated handler is invoked; otherwise, the View is displayed again to the user to enable them to correct all the errors.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3927.1">The new links to the package list page and login page must be added to the main menu, which is in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3928.1">_Layout</span></code><span class="koboSpan" id="kobo.3929.1"> view, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3930.1">@if (User.Identity.IsAuthenticated)
{
	</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3931.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3932.1">li</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3933.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3934.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3935.1">"nav-item"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3936.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3937.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3938.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3939.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3940.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3941.1">"nav-link text-dark"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3942.1">asp-controller</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3943.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3944.1">"ManagePackages"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3945.1">asp-action</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3946.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3947.1">"Index"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3948.1">&gt;</span></span><span class="koboSpan" id="kobo.3949.1">Manage packages</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3950.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3951.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3952.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3953.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3954.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3955.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3956.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3957.1">li</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3958.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3959.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3960.1">"nav-item"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3961.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3962.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3963.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3964.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3965.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3966.1">"nav-link text-dark"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3967.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3968.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3969.1">"javascript:document.getElementById('logoutForm').submit()"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3970.1">&gt;</span></span><span class="koboSpan" id="kobo.3971.1">
            Logout
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3972.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3973.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3974.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3975.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3976.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3977.1">&gt;</span></span><span class="koboSpan" id="kobo.3978.1">
}
else
{
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3979.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3980.1">li</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3981.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3982.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3983.1">"nav-item"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3984.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3985.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3986.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3987.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3988.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3989.1">"nav-link text-dark"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3990.1">asp-controller</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3991.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3992.1">"Account"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3993.1">asp-action</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3994.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3995.1">"Login"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3996.1">&gt;</span></span><span class="koboSpan" id="kobo.3997.1">Login</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3998.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3999.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4000.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4001.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4002.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4003.1">&gt;</span></span><span class="koboSpan" id="kobo.4004.1">
}
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.4005.1">logoutForm</span></code><span class="koboSpan" id="kobo.4006.1"> is an empty form whose only purpose is to send a post to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4007.1">Logout</span></code><span class="koboSpan" id="kobo.4008.1"> action method. </span><span class="koboSpan" id="kobo.4008.2">It has been added </span><a id="_idIndexMarker1695"/><span class="koboSpan" id="kobo.4009.1">to the end of the body, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4010.1">@if (User.Identity.IsAuthenticated)
{
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.4011.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4012.1">form</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4013.1">asp-area</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4014.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4015.1">""</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4016.1">asp-controller</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4017.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4018.1">"Account"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4019.1">asp-action</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4020.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4021.1">"Logout"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4022.1">method</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4023.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4024.1">"post"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4025.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4026.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4027.1">"logoutForm"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4028.1"> &gt;&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4029.1">form</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4030.1">&gt;</span></span><span class="koboSpan" id="kobo.4031.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4032.1">Now, the application is ready! </span><span class="koboSpan" id="kobo.4032.2">You can run it, log in, and start to manage packages.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4033.1">After having learned how to implement, in practice, a presentation layer with server-side technologies in this section, we now just need to learn how to implement it also with client-side technologies. </span><span class="koboSpan" id="kobo.4033.2">We will do this in the next section.</span></p>
<h1 class="heading-1" id="_idParaDest-464"><span class="koboSpan" id="kobo.4034.1">Using client technologies</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.4035.1">In this section, we will implement </span><a id="_idIndexMarker1696"/><span class="koboSpan" id="kobo.4036.1">a package search application for the WWTravelClub book use case. </span><span class="koboSpan" id="kobo.4036.2">The first subsection explains how to set up the solution exploiting the domain layer and data layer of the MVC application we implemented in the previous</span><a id="_idIndexMarker1697"/><span class="koboSpan" id="kobo.4037.1"> section of this chapter.</span></p>
<h2 class="heading-2" id="_idParaDest-465"><span class="koboSpan" id="kobo.4038.1">Preparing the solution</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.4039.1">We will modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4040.1">PackagesManagement</span></code><span class="koboSpan" id="kobo.4041.1"> project both to save coding time and to show how to transform a solution based on </span><a id="_idIndexMarker1698"/><span class="koboSpan" id="kobo.4042.1">server-side MVC technology into a solution based on the Blazor client-side technology. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.4043.1">First of all, create a copy of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4044.1">PackagesManagement</span></code><span class="koboSpan" id="kobo.4045.1"> solution folder we created in the previous section and rename it </span><code class="inlineCode"><span class="koboSpan" id="kobo.4046.1">PackagesManagementBlazor</span></code><span class="koboSpan" id="kobo.4047.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4048.1">To open the solution, right-click on the web project (the one named </span><code class="inlineCode"><span class="koboSpan" id="kobo.4049.1">PackagesManagement</span></code><span class="koboSpan" id="kobo.4050.1">) and remove it (the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4051.1">Remove</span></code><span class="koboSpan" id="kobo.4052.1"> menu item). </span><span class="koboSpan" id="kobo.4052.2">Then, go to the solution folder and delete the whole web project folder (the one named </span><code class="inlineCode"><span class="koboSpan" id="kobo.4053.1">PackagesManagement</span></code><span class="koboSpan" id="kobo.4054.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4055.1">Now, right-click on the solution and select </span><strong class="screenText"><span class="koboSpan" id="kobo.4056.1">Add New Project</span></strong><span class="koboSpan" id="kobo.4057.1">. </span><span class="koboSpan" id="kobo.4057.2">Add a new </span><strong class="screenText"><span class="koboSpan" id="kobo.4058.1">Blazor WebAssembly Standalone App</span></strong><span class="koboSpan" id="kobo.4059.1"> project called </span><code class="inlineCode"><span class="koboSpan" id="kobo.4060.1">PackagesManagementBlazor.Client</span></code><span class="koboSpan" id="kobo.4061.1">. </span><span class="koboSpan" id="kobo.4061.2">Select </span><strong class="screenText"><span class="koboSpan" id="kobo.4062.1">None</span></strong><span class="koboSpan" id="kobo.4063.1"> for the authentication type, </span><strong class="screenText"><span class="koboSpan" id="kobo.4064.1">Configure for https</span></strong><span class="koboSpan" id="kobo.4065.1">, and </span><strong class="screenText"><span class="koboSpan" id="kobo.4066.1">Include Sample Pages</span></strong><span class="koboSpan" id="kobo.4067.1">. </span><span class="koboSpan" id="kobo.4067.2">We don’t need authentication since the search-by-location feature we are going to implement must also be available to unregistered users.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4068.1">Now, add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.4069.1">PackagesManagementBlazor.Server</span></code> <strong class="screenText"><span class="koboSpan" id="kobo.4070.1">ASP.NET Core Web API</span></strong><span class="koboSpan" id="kobo.4071.1"> project. </span><span class="koboSpan" id="kobo.4071.2">Select </span><strong class="screenText"><span class="koboSpan" id="kobo.4072.1">None</span></strong><span class="koboSpan" id="kobo.4073.1"> for the authentication type, </span><strong class="screenText"><span class="koboSpan" id="kobo.4074.1">Configure for https</span></strong><span class="koboSpan" id="kobo.4075.1">, </span><strong class="screenText"><span class="koboSpan" id="kobo.4076.1">Enable OpenAPI Support</span></strong><span class="koboSpan" id="kobo.4077.1">, and </span><strong class="screenText"><span class="koboSpan" id="kobo.4078.1">Use Controllers</span></strong><span class="koboSpan" id="kobo.4079.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4080.1">Finally, add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.4081.1">PackagesManagementBlazor.Shared</span></code> <strong class="screenText"><span class="koboSpan" id="kobo.4082.1">Class Library</span></strong><span class="koboSpan" id="kobo.4083.1"> project, delete the default </span><code class="inlineCode"><span class="koboSpan" id="kobo.4084.1">Class1</span></code><span class="koboSpan" id="kobo.4085.1"> class created by Visual Studio, and add this project to both </span><code class="inlineCode"><span class="koboSpan" id="kobo.4086.1">PackagesManagementBlazor.Client</span></code><span class="koboSpan" id="kobo.4087.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.4088.1">PackagesManagementBlazor.Server</span></code><span class="koboSpan" id="kobo.4089.1"> as reference.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4090.1">The server project needs to reference both the domain implementation (</span><code class="inlineCode"><span class="koboSpan" id="kobo.4091.1">PackagesManagementDB</span></code><span class="koboSpan" id="kobo.4092.1">) and the domain abstraction (</span><code class="inlineCode"><span class="koboSpan" id="kobo.4093.1">PackagesManagementDomain</span></code><span class="koboSpan" id="kobo.4094.1">) projects, so please add them as references.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4095.1">Both </span><code class="inlineCode"><span class="koboSpan" id="kobo.4096.1">PackagesManagementBlazor.Client</span></code><span class="koboSpan" id="kobo.4097.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.4098.1">PackagesManagementBlazor.Server</span></code><span class="koboSpan" id="kobo.4099.1"> must start simultaneously, so define them as starting projects by right-clicking on the solutions, selecting </span><strong class="keyWord"><span class="koboSpan" id="kobo.4100.1">Configure Startup Projects</span></strong><span class="koboSpan" id="kobo.4101.1">, and choosing them as startup projects.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4102.1">Now, launch the solution to verify that everything works properly. </span><span class="koboSpan" id="kobo.4102.2">Two browser windows should open, one for testing the REST API project and the other containing a Blazor application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4103.1">Take note of the Blazor application URL (</span><code class="inlineCode"><span class="koboSpan" id="kobo.4104.1">https://localhost:7027/</span></code><span class="koboSpan" id="kobo.4105.1"> in my case) since we will need it. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.4106.1">The Blazor website will exchange data with the REST API website, which runs on a different domain (a domain is identified by both hostname and port number). </span><span class="koboSpan" id="kobo.4106.2">REST API calls coming from browsers running on different domains are clues of potential phishing attacks; therefore, the receiving server only accepts them if they come from well-known domains (this way, they are sure they don’t come from phishing websites).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4107.1">On the other hand, when a browser application tries to communicate with a different URL, the browser detects it and issues the call with a different protocol called CORS. </span><span class="koboSpan" id="kobo.4107.2">Therefore, as soon as it </span><a id="_idIndexMarker1699"/><span class="koboSpan" id="kobo.4108.1">detects the CORS protocol, the receiving server understands it is dealing with a request coming from a different website, and serves the request only if the other domain has been registered with a so-called CORS policy.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4109.1">In ASP.NET Core, CORS policies are registered with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4110.1">builder.Services.AddCors</span></code><span class="koboSpan" id="kobo.4111.1"> extension method in </span><code class="inlineCode"><span class="koboSpan" id="kobo.4112.1">Program.cs</span></code><span class="koboSpan" id="kobo.4113.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4114.1">Therefore, in our case, we need to register a CORS policy for the domain of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4115.1">PackagesManagementBlazor.Client</span></code><span class="koboSpan" id="kobo.4116.1"> web application in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4117.1">PackagesManagementBlazor.Server</span></code><span class="koboSpan" id="kobo.4118.1"> web application, since all REST API calls of </span><code class="inlineCode"><span class="koboSpan" id="kobo.4119.1">PackagesManagementBlazor.Client</span></code><span class="koboSpan" id="kobo.4120.1"> will be issued to </span><code class="inlineCode"><span class="koboSpan" id="kobo.4121.1">PackagesManagementBlazor.Server</span></code><span class="koboSpan" id="kobo.4122.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4123.1">Accordingly, let’s open </span><code class="inlineCode"><span class="koboSpan" id="kobo.4124.1">Program.cs</span></code><span class="koboSpan" id="kobo.4125.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4126.1">PackagesManagementBlazor.Server</span></code><span class="koboSpan" id="kobo.4127.1"> project and enable it for CORS by adding this:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4128.1">builder.Services.AddCors(o =&gt; {
    o.AddDefaultPolicy(pbuilder =&gt;
    {
        pbuilder.AllowAnyMethod();
        pbuilder.WithHeaders(HeaderNames.ContentType, HeaderNames.Authorization);
        pbuilder.WithOrigins(</span><span class="hljs-string"><span class="koboSpan" id="kobo.4129.1">"https://localhost:7027/"</span></span><span class="koboSpan" id="kobo.4130.1">);
    });
});
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4131.1">Also, add </span><code class="inlineCode"><span class="koboSpan" id="kobo.4132.1">app.UseCors();</span></code><span class="koboSpan" id="kobo.4133.1"> in the ASP.NET Core pipeline, immediately before </span><code class="inlineCode"><span class="koboSpan" id="kobo.4134.1">app.UseAuthorization();</span></code><span class="koboSpan" id="kobo.4135.1"> .</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4136.1">Now, we must enable the Blazor application to communicate with this server. </span><span class="koboSpan" id="kobo.4136.2">Launch the solution again and take note of the REST API URL (in my case, </span><code class="inlineCode"><span class="koboSpan" id="kobo.4137.1">https://localhost:7269/</span></code><span class="koboSpan" id="kobo.4138.1">), and then replace the URL in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4139.1">HttpClient</span></code><span class="koboSpan" id="kobo.4140.1"> configuration in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4141.1">Program.cs</span></code><span class="koboSpan" id="kobo.4142.1"> file of the Blazor application with this URL:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4143.1">builder.Services.AddScoped(sp =&gt; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4144.1">new</span></span><span class="koboSpan" id="kobo.4145.1"> HttpClient {
 BaseAddress = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4146.1">new</span></span><span class="koboSpan" id="kobo.4147.1"> Uri(</span><span class="hljs-string"><span class="koboSpan" id="kobo.4148.1">"https://localhost:7269/"</span></span><span class="koboSpan" id="kobo.4149.1">)});
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4150.1">Let’s also copy the same connection string of the old web project into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4151.1">PackagesManagementBlazor.Server</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.4152.1">appsettings.json</span></code><span class="koboSpan" id="kobo.4153.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.4154.1">"ConnectionStrings"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.4155.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.4156.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.4157.1">"DefaultConnection"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.4158.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.4159.1">"Server=(localdb)\\mssqllocaldb;Database=package-management;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.4160.1">},</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4161.1">This way, we can</span><a id="_idIndexMarker1700"/><span class="koboSpan" id="kobo.4162.1"> reuse the database we have created. </span><span class="koboSpan" id="kobo.4162.2">We also need to add the same DDD tools we added to the old web project. </span><span class="koboSpan" id="kobo.4162.3">Add a folder named </span><code class="inlineCode"><span class="koboSpan" id="kobo.4163.1">Tools</span></code><span class="koboSpan" id="kobo.4164.1"> in the project root and copy the contents of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4165.1">ch07</span></code><span class="koboSpan" id="kobo.4166.1"> -&gt;</span><code class="inlineCode"><span class="koboSpan" id="kobo.4167.1"> ApplicationLayer</span></code><span class="koboSpan" id="kobo.4168.1"> folder of the GitHub repository associated with the book there.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4169.1">In order to finish the solution setup, we just need to connect </span><code class="inlineCode"><span class="koboSpan" id="kobo.4170.1">PackagesManagementBlazor.Server</span></code><span class="koboSpan" id="kobo.4171.1"> with the domain layer by adding the following code at the end of the services configuration code in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4172.1">Program.cs</span></code><span class="koboSpan" id="kobo.4173.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4174.1">builder.services.AddDbLayer(Configuration
                .GetConnectionString(</span><span class="hljs-string"><span class="koboSpan" id="kobo.4175.1">"DefaultConnection"</span></span><span class="koboSpan" id="kobo.4176.1">),
                </span><span class="hljs-string"><span class="koboSpan" id="kobo.4177.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4178.1">PackagesManagementDB"</span></span><span class="koboSpan" id="kobo.4179.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4180.1">It is the same method we added to the old web project. </span><span class="koboSpan" id="kobo.4180.2">Finally, we can also add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4181.1">AddAllQueries</span></code><span class="koboSpan" id="kobo.4182.1"> extension method, which discovers all queries in the web project:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4183.1">builder.services.AddAllQueries(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4184.1">this</span></span><span class="koboSpan" id="kobo.4185.1">.GetType().Assembly);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4186.1">We don’t need other automatic discovery tools since this is a query-only application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4187.1">Due to a bug in Entity Framework Core 8, you also need to change a setting in the server project that prevents the usage of .NET culture. </span><span class="koboSpan" id="kobo.4187.2">You must change the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4188.1">InvariantGlobalization</span></code><span class="koboSpan" id="kobo.4189.1"> project setting to </span><code class="inlineCode"><span class="koboSpan" id="kobo.4190.1">false</span></code><span class="koboSpan" id="kobo.4191.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.4192.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4193.1">InvariantGlobalization</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4194.1">&gt;</span></span><span class="koboSpan" id="kobo.4195.1">false</span><span class="hljs-tag"><span class="koboSpan" id="kobo.4196.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4197.1">InvariantGlobalization</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4198.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4199.1">At this point, we have the project completely configured. </span><span class="koboSpan" id="kobo.4199.2">We just need to implement server-side code and client-side code that implements our package search.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4200.1">The next subsection</span><a id="_idIndexMarker1701"/><span class="koboSpan" id="kobo.4201.1"> explains how to design the server-side REST API.</span></p>
<h2 class="heading-2" id="_idParaDest-466"><span class="koboSpan" id="kobo.4202.1">Implementing the required ASP.NET Core REST APIs</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.4203.1">As the first step, let’s define the </span><a id="_idIndexMarker1702"/><span class="koboSpan" id="kobo.4204.1">ViewModels used in the communication between the server and the client applications. </span><span class="koboSpan" id="kobo.4204.2">They must be defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4205.1">PackagesManagementBlazor.Shared</span></code><span class="koboSpan" id="kobo.4206.1"> project that is referenced by both applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4207.1">Let’s start with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4208.1">PackageInfosViewModel</span></code><span class="koboSpan" id="kobo.4209.1"> ViewModel, which will be the data structure used by the Blazor application to exchange package info with the server-side REST API:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.4210.1">using</span></span><span class="koboSpan" id="kobo.4211.1"> System;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4212.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4213.1">PackagesManagementBlazor.Shared</span></span><span class="koboSpan" id="kobo.4214.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4215.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.4216.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4217.1">PackageInfosViewModel</span></span><span class="koboSpan" id="kobo.4218.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4219.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.4220.1">int</span></span><span class="koboSpan" id="kobo.4221.1"> Id { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4222.1">get</span></span><span class="koboSpan" id="kobo.4223.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4224.1">set</span></span><span class="koboSpan" id="kobo.4225.1">; }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4226.1">public</span></span><span class="koboSpan" id="kobo.4227.1"> required </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.4228.1">string</span></span><span class="koboSpan" id="kobo.4229.1"> Name { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4230.1">get</span></span><span class="koboSpan" id="kobo.4231.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4232.1">set</span></span><span class="koboSpan" id="kobo.4233.1">; }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4234.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.4235.1">decimal</span></span><span class="koboSpan" id="kobo.4236.1"> Price { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4237.1">get</span></span><span class="koboSpan" id="kobo.4238.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4239.1">set</span></span><span class="koboSpan" id="kobo.4240.1">; }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4241.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.4242.1">int</span></span><span class="koboSpan" id="kobo.4243.1"> DurationInDays { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4244.1">get</span></span><span class="koboSpan" id="kobo.4245.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4246.1">set</span></span><span class="koboSpan" id="kobo.4247.1">; }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4248.1">public</span></span><span class="koboSpan" id="kobo.4249.1"> DateTime? </span><span class="koboSpan" id="kobo.4249.2">StartValidityDate { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4250.1">get</span></span><span class="koboSpan" id="kobo.4251.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4252.1">set</span></span><span class="koboSpan" id="kobo.4253.1">; }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4254.1">public</span></span><span class="koboSpan" id="kobo.4255.1"> DateTime? </span><span class="koboSpan" id="kobo.4255.2">EndValidityDate { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4256.1">get</span></span><span class="koboSpan" id="kobo.4257.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4258.1">set</span></span><span class="koboSpan" id="kobo.4259.1">; }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4260.1">public</span></span><span class="koboSpan" id="kobo.4261.1"> required </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.4262.1">string</span></span><span class="koboSpan" id="kobo.4263.1"> DestinationName { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4264.1">get</span></span><span class="koboSpan" id="kobo.4265.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4266.1">set</span></span><span class="koboSpan" id="kobo.4267.1">; }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4268.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.4269.1">int</span></span><span class="koboSpan" id="kobo.4270.1"> DestinationId { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4271.1">get</span></span><span class="koboSpan" id="kobo.4272.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4273.1">set</span></span><span class="koboSpan" id="kobo.4274.1">; }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4275.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4276.1">override</span></span><span class="hljs-function"> </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.4277.1">string</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.4278.1">ToString</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4279.1">()</span></span><span class="koboSpan" id="kobo.4280.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4281.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.4282.1">$"</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.4283.1">{Name}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4284.1">. </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.4285.1">{DurationInDays}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4286.1"> days in </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.4287.1">{DestinationName}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4288.1">, price: </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.4289.1">{Price}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4290.1">"</span></span><span class="koboSpan" id="kobo.4291.1">;
        }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4292.1">Then, add the ViewModel that encloses all packages to return to the Blazor application:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.4293.1">using</span></span><span class="koboSpan" id="kobo.4294.1"> System.Collections.Generic;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4295.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4296.1">PackagesManagementBlazor.Shared</span></span><span class="koboSpan" id="kobo.4297.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4298.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.4299.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4300.1">PackagesListViewModel</span></span><span class="koboSpan" id="kobo.4301.1">
    {
        Public required ReadOnlyCollection&lt;PackageInfosViewModel&gt;
            Items { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4302.1">get</span></span><span class="koboSpan" id="kobo.4303.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4304.1">set</span></span><span class="koboSpan" id="kobo.4305.1">; }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4306.1">Now, we can also add our query that searches packages by location. </span><span class="koboSpan" id="kobo.4306.2">Let’s add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.4307.1">Queries</span></code><span class="koboSpan" id="kobo.4308.1"> folder in the root of </span><a id="_idIndexMarker1703"/><span class="koboSpan" id="kobo.4309.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4310.1">PackagesManagementBlazor.Server</span></code><span class="koboSpan" id="kobo.4311.1"> project and then add the interface that defines our query, </span><code class="inlineCode"><span class="koboSpan" id="kobo.4312.1">IPackagesListByLocationQuery</span></code><span class="koboSpan" id="kobo.4313.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.4314.1">using</span></span><span class="koboSpan" id="kobo.4315.1"> DDD.ApplicationLayer;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4316.1">using</span></span><span class="koboSpan" id="kobo.4317.1"> PackagesManagementBlazor.Shared;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4318.1">using</span></span><span class="koboSpan" id="kobo.4319.1"> System.Collections.Generic;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4320.1">using</span></span><span class="koboSpan" id="kobo.4321.1"> System.Threading.Tasks;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4322.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4323.1">PackagesManagementBlazor.Server.Queries</span></span><span class="koboSpan" id="kobo.4324.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4325.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.4326.1">interface</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4327.1">IPackagesListByLocationQuery</span></span><span class="koboSpan" id="kobo.4328.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.4329.1">IQuery</span></span><span class="koboSpan" id="kobo.4330.1">
    {
        Task&lt;ReadOnlyCollection&lt;PackageInfosViewModel&gt;&gt;
            GetPackagesOf(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.4331.1">string</span></span><span class="koboSpan" id="kobo.4332.1"> location);
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4333.1">Finally, let’s also add the query implementation:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.4334.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4335.1">class</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.4336.1">PackagesListByLocationQuery</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4337.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.4338.1">MainDbContext ctx</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4339.1">):IPackagesListByLocationQuery</span></span><span class="koboSpan" id="kobo.4340.1">
{
   
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4341.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4342.1">async</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.4343.1">Task</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4344.1">&lt;</span></span><span class="hljs-title"><span class="koboSpan" id="kobo.4345.1">ReadOnlyCollection</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4346.1">&lt;</span></span><span class="hljs-title"><span class="koboSpan" id="kobo.4347.1">PackageInfosViewModel</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4348.1">&gt;&gt;</span></span>
<span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.4349.1">GetPackagesOfAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4350.1">(</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.4351.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.4352.1"> location</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4353.1">)</span></span><span class="koboSpan" id="kobo.4354.1">
    {
        </span><span class="hljs-function"><span class="koboSpan" id="kobo.4355.1">Return </span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4356.1">new</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.4357.1">ReadOnlyCollection</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4358.1">&lt;</span></span><span class="hljs-title"><span class="koboSpan" id="kobo.4359.1">PackageInfosViewModel</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4360.1">&gt;</span></span>
<span class="hljs-function"><span class="koboSpan" id="kobo.4361.1">	(</span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4362.1">await</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.4363.1"> ctx.Packages</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4364.1">            .Where(m =&gt; m.MyDestination.Name.StartsWith(location</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4365.1">))</span></span>
<span class="hljs-function"><span class="koboSpan" id="kobo.4366.1">            .</span></span><span class="hljs-title"><span class="koboSpan" id="kobo.4367.1">Select</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4368.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.4369.1">m =&gt; </span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4370.1">new</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.4371.1"> PackageInfosViewModel</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4372.1">        {</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4373.1">            StartValidityDate = m.StartValidityDate,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4374.1">            EndValidityDate = m.EndValidityDate,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4375.1">            Name = m.Name,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4376.1">            DurationInDays = m.DurationInDays,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4377.1">            Id = m.Id,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4378.1">            Price = m.Price,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4379.1">            DestinationName = m.MyDestination.Name,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4380.1">            DestinationId = m.DestinationId</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4381.1">        }</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4382.1">)</span></span>
<span class="hljs-function"><span class="koboSpan" id="kobo.4383.1">            .</span></span><span class="hljs-title"><span class="koboSpan" id="kobo.4384.1">OrderByDescending</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4385.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.4386.1">m=&gt; m.EndValidityDate</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4387.1">)</span></span>
<span class="hljs-function"><span class="koboSpan" id="kobo.4388.1">            .</span></span><span class="hljs-title"><span class="koboSpan" id="kobo.4389.1">ToListAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4390.1">())</span></span><span class="koboSpan" id="kobo.4391.1">;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4392.1">We are finally ready to</span><a id="_idIndexMarker1704"/><span class="koboSpan" id="kobo.4393.1"> define our </span><code class="inlineCode"><span class="koboSpan" id="kobo.4394.1">PackagesController</span></code><span class="koboSpan" id="kobo.4395.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.4396.1">using</span></span><span class="koboSpan" id="kobo.4397.1"> Microsoft.AspNetCore.Mvc;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4398.1">using</span></span><span class="koboSpan" id="kobo.4399.1"> PackagesManagementBlazor.Server.Queries;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4400.1">using</span></span><span class="koboSpan" id="kobo.4401.1"> PackagesManagementBlazor.Shared;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4402.1">using</span></span><span class="koboSpan" id="kobo.4403.1"> System.Threading.Tasks;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4404.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4405.1">PackagesManagementBlazor.Server.Controllers</span></span><span class="koboSpan" id="kobo.4406.1">
{
    [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.4407.1">Route(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4408.1">"[controller]"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.4409.1">)</span></span><span class="koboSpan" id="kobo.4410.1">]
    [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.4411.1">ApiController</span></span><span class="koboSpan" id="kobo.4412.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4413.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.4414.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4415.1">PackagesController</span></span><span class="koboSpan" id="kobo.4416.1"> : </span><span class="hljs-title"><span class="koboSpan" id="kobo.4417.1">ControllerBase</span></span><span class="koboSpan" id="kobo.4418.1">
    {
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.4419.1">// GET api/&lt;PackagesController&gt;/Flor</span></span><span class="koboSpan" id="kobo.4420.1">
        [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.4421.1">HttpGet(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4422.1">"{location}"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.4423.1">)</span></span><span class="koboSpan" id="kobo.4424.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4425.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4426.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4427.1"> Task&lt;PackagesListViewModel&gt;    </span></span>
<span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.4428.1">GetAsync</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4429.1">(</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.4430.1">string</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.4431.1"> location,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4432.1">            [FromServices] IPackagesListByLocationQuery query </span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4433.1">)</span></span><span class="koboSpan" id="kobo.4434.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4435.1">return</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.4436.1">new</span></span><span class="koboSpan" id="kobo.4437.1"> PackagesListViewModel
            {
                Items = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4438.1">await</span></span><span class="koboSpan" id="kobo.4439.1"> query.GetPackagesOf(location)
            };
        } 
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4440.1">The server-side code is finished! </span><span class="koboSpan" id="kobo.4440.2">Let’s move on to the definition of the Blazor service that communicates with the server.</span></p>
<h2 class="heading-2" id="_idParaDest-467"><span class="koboSpan" id="kobo.4441.1">Implementing the business logic in a service</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.4442.1">Let’s add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.4443.1">ViewModels</span></code><span class="koboSpan" id="kobo.4444.1"> and a </span><code class="inlineCode"><span class="koboSpan" id="kobo.4445.1">Services</span></code><span class="koboSpan" id="kobo.4446.1"> folder to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4447.1">PackagesManagementBlazor.Client</span></code><span class="koboSpan" id="kobo.4448.1"> project. </span><span class="koboSpan" id="kobo.4448.2">Most of the </span><a id="_idIndexMarker1705"/><span class="koboSpan" id="kobo.4449.1">ViewModels we need were defined in the </span><strong class="keyWord"><span class="koboSpan" id="kobo.4450.1">PackagesManagementBlazor.Shared</span></strong><span class="koboSpan" id="kobo.4451.1"> project. </span><span class="koboSpan" id="kobo.4451.2">We only need a ViewModel for the search form. </span><span class="koboSpan" id="kobo.4451.3">Let’s add it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4452.1">ViewModels</span></code><span class="koboSpan" id="kobo.4453.1"> folder:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.4454.1">using</span></span><span class="koboSpan" id="kobo.4455.1"> System.ComponentModel.DataAnnotations;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4456.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4457.1">PackagesManagementBlazor.Client.ViewModels</span></span><span class="koboSpan" id="kobo.4458.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4459.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.4460.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4461.1">SearchViewModel</span></span><span class="koboSpan" id="kobo.4462.1">
    {
        [</span><span class="hljs-meta"><span class="koboSpan" id="kobo.4463.1">Required</span></span><span class="koboSpan" id="kobo.4464.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4465.1">public</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.4466.1">string</span></span><span class="koboSpan" id="kobo.4467.1">? </span><span class="koboSpan" id="kobo.4467.2">Location { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4468.1">get</span></span><span class="koboSpan" id="kobo.4469.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4470.1">set</span></span><span class="koboSpan" id="kobo.4471.1">; }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4472.1">Let’s call our </span><a id="_idIndexMarker1706"/><span class="koboSpan" id="kobo.4473.1">service </span><code class="inlineCode"><span class="koboSpan" id="kobo.4474.1">PackagesClient</span></code><span class="koboSpan" id="kobo.4475.1">, and let’s add it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4476.1">Services</span></code><span class="koboSpan" id="kobo.4477.1"> folder:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.4478.1">namespace</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4479.1">PackagesManagementBlazor.Client.Services</span></span><span class="koboSpan" id="kobo.4480.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4481.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.4482.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4483.1">PackagesClient</span></span><span class="koboSpan" id="kobo.4484.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4485.1">private</span></span><span class="koboSpan" id="kobo.4486.1"> HttpClient client;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4487.1">public</span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="koboSpan" id="kobo.4488.1">PackagesClient</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4489.1">(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.4490.1">HttpClient client</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4491.1">)</span></span><span class="koboSpan" id="kobo.4492.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4493.1">this</span></span><span class="koboSpan" id="kobo.4494.1">.client = client;
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4495.1">public</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.4496.1">async</span></span><span class="koboSpan" id="kobo.4497.1"> Task&lt;IEnumerable&lt;PackageInfosViewModel&gt;&gt;
            GetByLocationAsync(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.4498.1">string</span></span><span class="koboSpan" id="kobo.4499.1"> location)
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4500.1">var</span></span><span class="koboSpan" id="kobo.4501.1"> result =
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4502.1">await</span></span><span class="koboSpan" id="kobo.4503.1"> client.GetFromJsonAsync&lt;PackagesListViewModel&gt;
                    (</span><span class="hljs-string"><span class="koboSpan" id="kobo.4504.1">"Packages/"</span></span><span class="koboSpan" id="kobo.4505.1"> + Uri.EscapeDataString(location));
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4506.1">return</span></span><span class="koboSpan" id="kobo.4507.1"> result.Items;
        }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4508.1">The code is straightforward! </span><span class="koboSpan" id="kobo.4508.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.4509.1">Uri.EscapeDataString</span></code><span class="koboSpan" id="kobo.4510.1"> method URL-encodes the parameter so it can be safely appended to the URL.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4511.1">Finally, let’s register the service in the dependency injection:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4512.1">builder.Services.AddScoped&lt;PackagesClient&gt;();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4513.1">It is worth pointing out that in a commercial application, we should have registered the service through an </span><code class="inlineCode"><span class="koboSpan" id="kobo.4514.1">IPackagesClient</span></code><span class="koboSpan" id="kobo.4515.1"> interface in order to be able to mock it in the tests (</span><code class="inlineCode"><span class="koboSpan" id="kobo.4516.1">.AddScoped&lt;IPackagesClient, PackagesClient&gt;()</span></code><span class="koboSpan" id="kobo.4517.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4518.1">With everything in </span><a id="_idIndexMarker1707"/><span class="koboSpan" id="kobo.4519.1">place, we just need to build the UI.</span></p>
<h2 class="heading-2" id="_idParaDest-468"><span class="koboSpan" id="kobo.4520.1">Implementing the user interface</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.4521.1">As the first step, let’s delete the </span><a id="_idIndexMarker1708"/><span class="koboSpan" id="kobo.4522.1">application pages we don’t need – namely, </span><code class="inlineCode"><span class="koboSpan" id="kobo.4523.1">Pages-&gt;Counter.razor</span></code><span class="koboSpan" id="kobo.4524.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.4525.1">Pages-&gt;Weather.razor</span></code><span class="koboSpan" id="kobo.4526.1">. </span><span class="koboSpan" id="kobo.4526.2">Let’s also remove their links from the side menu in </span><code class="inlineCode"><span class="koboSpan" id="kobo.4527.1">Shared</span></code><span class="koboSpan" id="kobo.4528.1"> -&gt; </span><code class="inlineCode"><span class="koboSpan" id="kobo.4529.1">NavMenu.razor</span></code><span class="koboSpan" id="kobo.4530.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4531.1">We will put our code in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4532.1">Pages</span></code><span class="koboSpan" id="kobo.4533.1"> -&gt; </span><code class="inlineCode"><span class="koboSpan" id="kobo.4534.1">Home.razor</span></code><span class="koboSpan" id="kobo.4535.1"> page. </span><span class="koboSpan" id="kobo.4535.2">Let’s replace the code of this page with the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4536.1">@using PackagesManagementBlazor.Client.ViewModels
@using PackagesManagementBlazor.Shared
@using PackagesManagementBlazor.Client.Services
@inject PackagesClient client
@page "/"
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.4537.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4538.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4539.1">&gt;</span></span><span class="koboSpan" id="kobo.4540.1">Search packages by location</span><span class="hljs-tag"><span class="koboSpan" id="kobo.4541.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4542.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4543.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4544.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4545.1">EditForm</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4546.1">Model</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4547.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4548.1">"search"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4549.1">OnValidSubmit</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4550.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4551.1">"Search"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4552.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4553.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4554.1">DataAnnotationsValidator</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4555.1"> /&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4556.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4557.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4558.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4559.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4560.1">"form-group"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4561.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4562.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4563.1">label</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4564.1">for</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4565.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4566.1">"integerfixed"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4567.1">&gt;</span></span><span class="koboSpan" id="kobo.4568.1">Insert location starting chars</span><span class="hljs-tag"><span class="koboSpan" id="kobo.4569.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4570.1">label</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4571.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4572.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4573.1">InputText</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4574.1"> @</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.4575.1">bind-Value</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4576.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4577.1">"search.Location"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4578.1"> /&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4579.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4580.1">ValidationMessage</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4581.1">For</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4582.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4583.1">"@(() =&gt; search.Location)"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4584.1"> /&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4585.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4586.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4587.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4588.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4589.1">button</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4590.1">type</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4591.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4592.1">"submit"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4593.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4594.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4595.1">"btn btn-primary"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4596.1">&gt;</span></span><span class="koboSpan" id="kobo.4597.1">
        Search
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.4598.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4599.1">button</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4600.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4601.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4602.1">EditForm</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4603.1">&gt;</span></span><span class="koboSpan" id="kobo.4604.1">
@code{
    SearchViewModel search { get; set; } = new SearchViewModel();
    async Task Search()
    {
        ...
    </span><span class="koboSpan" id="kobo.4604.2">}
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4605.1">The preceding code adds the needed </span><code class="inlineCode"><span class="koboSpan" id="kobo.4606.1">@using</span></code><span class="koboSpan" id="kobo.4607.1"> statements, injects our </span><code class="inlineCode"><span class="koboSpan" id="kobo.4608.1">PackagesClient</span></code><span class="koboSpan" id="kobo.4609.1"> service into the page, and</span><a id="_idIndexMarker1709"/><span class="koboSpan" id="kobo.4610.1"> defines the search form. </span><span class="koboSpan" id="kobo.4610.2">When the form is successfully submitted, it invokes the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4611.1">Search</span></code><span class="koboSpan" id="kobo.4612.1"> callback, where we will place the code that retrieves all the results.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4613.1">It is time to add the logic to display all the results and to complete the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4614.1">@code</span></code><span class="koboSpan" id="kobo.4615.1"> block. </span><span class="koboSpan" id="kobo.4615.2">The following code must be placed immediately after the search form:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4616.1">@if (packages != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.4617.1">null</span></span><span class="koboSpan" id="kobo.4618.1">)
{
...
</span><span class="koboSpan" id="kobo.4618.2">}
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4619.1">else</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.4620.1">if</span></span><span class="koboSpan" id="kobo.4621.1"> (loading)
{
    &lt;p&gt;&lt;em&gt;Loading...&lt;/em&gt;&lt;/p&gt;
}
@code{
    SearchViewModel search { </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4622.1">get</span></span><span class="koboSpan" id="kobo.4623.1">; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4624.1">set</span></span><span class="koboSpan" id="kobo.4625.1">; } = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4626.1">new</span></span><span class="koboSpan" id="kobo.4627.1"> SearchViewModel();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4628.1">private</span></span><span class="koboSpan" id="kobo.4629.1"> IEnumerable&lt;PackageInfosViewModel&gt; packages;
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.4630.1">bool</span></span><span class="koboSpan" id="kobo.4631.1"> loading;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4632.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4633.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.4634.1">Search</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4635.1">()</span></span><span class="koboSpan" id="kobo.4636.1">
    {
        packages = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.4637.1">null</span></span><span class="koboSpan" id="kobo.4638.1">;
        loading = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.4639.1">true</span></span><span class="koboSpan" id="kobo.4640.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4641.1">await</span></span><span class="koboSpan" id="kobo.4642.1"> InvokeAsync(StateHasChanged);
        packages = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4643.1">await</span></span><span class="koboSpan" id="kobo.4644.1"> client.GetByLocationAsync(search.Location);
        loading = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.4645.1">false</span></span><span class="koboSpan" id="kobo.4646.1">;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4647.1">The omitted code in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4648.1">if</span></code><span class="koboSpan" id="kobo.4649.1"> block is responsible for rendering a table with all the results. </span><span class="koboSpan" id="kobo.4649.2">We will show it after having commented on the preceding code.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4650.1">Before retrieving the results with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4651.1">PackagesClient</span></code><span class="koboSpan" id="kobo.4652.1"> service, we remove all previous results and set the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4653.1">loading</span></code><span class="koboSpan" id="kobo.4654.1"> field so the Razor code selects the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4655.1">else if</span></code><span class="koboSpan" id="kobo.4656.1"> path that replaces the previous table with a loading message. </span><span class="koboSpan" id="kobo.4656.2">Once we’ve set these variables, we are forced to call </span><code class="inlineCode"><span class="koboSpan" id="kobo.4657.1">StateHasChanged</span></code><span class="koboSpan" id="kobo.4658.1"> to trigger change detection and refresh the page. </span><span class="koboSpan" id="kobo.4658.2">After all the results have been retrieved and the callback returns, there is no need to call </span><code class="inlineCode"><span class="koboSpan" id="kobo.4659.1">StateHasChanged</span></code><span class="koboSpan" id="kobo.4660.1"> again because the termination of the callback itself triggers change detection and causes the required page refresh.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4661.1">Here is the code that renders the table with all the results:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.4662.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4663.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4664.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4665.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4666.1">"table-responsive"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4667.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4668.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4669.1">table</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4670.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4671.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4672.1">"table"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4673.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4674.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4675.1">thead</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4676.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4677.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4678.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4679.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4680.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4681.1">th</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4682.1">scope</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4683.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4684.1">"col"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4685.1">&gt;</span></span><span class="koboSpan" id="kobo.4686.1">Destination</span><span class="hljs-tag"><span class="koboSpan" id="kobo.4687.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4688.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4689.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4690.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4691.1">th</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4692.1">scope</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4693.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4694.1">"col"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4695.1">&gt;</span></span><span class="koboSpan" id="kobo.4696.1">Name</span><span class="hljs-tag"><span class="koboSpan" id="kobo.4697.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4698.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4699.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4700.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4701.1">th</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4702.1">scope</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4703.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4704.1">"col"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4705.1">&gt;</span></span><span class="koboSpan" id="kobo.4706.1">Duration/days</span><span class="hljs-tag"><span class="koboSpan" id="kobo.4707.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4708.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4709.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4710.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4711.1">th</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4712.1">scope</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4713.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4714.1">"col"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4715.1">&gt;</span></span><span class="koboSpan" id="kobo.4716.1">Price</span><span class="hljs-tag"><span class="koboSpan" id="kobo.4717.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4718.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4719.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4720.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4721.1">th</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4722.1">scope</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4723.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4724.1">"col"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4725.1">&gt;</span></span><span class="koboSpan" id="kobo.4726.1">Available from</span><span class="hljs-tag"><span class="koboSpan" id="kobo.4727.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4728.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4729.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4730.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4731.1">th</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.4732.1">scope</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4733.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.4734.1">"col"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4735.1">&gt;</span></span><span class="koboSpan" id="kobo.4736.1">Available to</span><span class="hljs-tag"><span class="koboSpan" id="kobo.4737.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4738.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4739.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4740.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4741.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4742.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4743.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4744.1">thead</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4745.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4746.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4747.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4748.1">&gt;</span></span><span class="koboSpan" id="kobo.4749.1">
      @foreach (var package in packages)
      {
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.4750.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4751.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4752.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4753.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4754.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4755.1">&gt;</span></span><span class="koboSpan" id="kobo.4756.1">
            @package.DestinationName
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.4757.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4758.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4759.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4760.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4761.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4762.1">&gt;</span></span><span class="koboSpan" id="kobo.4763.1">
            @package.Name
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.4764.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4765.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4766.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4767.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4768.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4769.1">&gt;</span></span><span class="koboSpan" id="kobo.4770.1">
            @package.DurationInDays
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.4771.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4772.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4773.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4774.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4775.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4776.1">&gt;</span></span><span class="koboSpan" id="kobo.4777.1">
            @package.Price
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.4778.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4779.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4780.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4781.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4782.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4783.1">&gt;</span></span><span class="koboSpan" id="kobo.4784.1">
            @(package.StartValidityDate.HasValue ?
              </span><span class="koboSpan" id="kobo.4784.2">package.StartValidityDate.Value.ToString("d")
              :
              String.Empty)
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.4785.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4786.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4787.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4788.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4789.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4790.1">&gt;</span></span><span class="koboSpan" id="kobo.4791.1">
            @(package.EndValidityDate.HasValue ?
              </span><span class="koboSpan" id="kobo.4791.2">package.EndValidityDate.Value.ToString("d")
              :
              String.Empty)
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.4792.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4793.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4794.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4795.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4796.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4797.1">&gt;</span></span><span class="koboSpan" id="kobo.4798.1">
      }
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.4799.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4800.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4801.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4802.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4803.1">table</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4804.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.4805.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4806.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4807.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4808.1">Run the project and write the initial characters of Florence. </span><span class="koboSpan" id="kobo.4808.2">Since we inserted Florence as a location in the same database in previous chapters (see the </span><em class="italic"><span class="koboSpan" id="kobo.4809.1">Querying and updating data with Entity Framework Core</span></em><span class="koboSpan" id="kobo.4810.1"> section of </span><em class="italic"><span class="koboSpan" id="kobo.4811.1">Chapter 13</span></em><span class="koboSpan" id="kobo.4812.1">, </span><em class="italic"><span class="koboSpan" id="kobo.4813.1">Interacting with Data in C# – Entity Framework Core</span></em><span class="koboSpan" id="kobo.4814.1">), some results should appear. </span><span class="koboSpan" id="kobo.4814.2">If you inserted different data, please try with different starting words.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4815.1">Usually, together with</span><a id="_idIndexMarker1710"/><span class="koboSpan" id="kobo.4816.1"> web-based clients, all applications also furnish mobile-native applications to get a better performance with possibly slow mobile devices. </span><span class="koboSpan" id="kobo.4816.2">So, let’s also design a mobile-native client application!</span></p>
<h2 class="heading-2" id="_idParaDest-469"><span class="koboSpan" id="kobo.4817.1">Adding a Blazor MAUI version</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.4818.1">In this section, we explain how to </span><a id="_idIndexMarker1711"/><span class="koboSpan" id="kobo.4819.1">add a Blazor MAUI version to the application of the previous solution.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4820.1">First of all, right-click on the solution icon in Solution Explorer and add a new project to the solution. </span><span class="koboSpan" id="kobo.4820.2">Select a MAUI Blazor application and call it </span><code class="inlineCode"><span class="koboSpan" id="kobo.4821.1">PackagesManagementMAUIBlazor</span></code><span class="koboSpan" id="kobo.4822.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4823.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4824.1">PackagesManagementMAUIBlazor</span></code><span class="koboSpan" id="kobo.4825.1"> project file and remove all the platforms you don’t want to support (I removed Android, iOS, and Mac Catalyst, and kept only Windows):</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.4826.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4827.1">TargetFrameworks</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4828.1">&gt;</span></span><span class="koboSpan" id="kobo.4829.1"> Condition="$([MSBuild]::IsOSPlatform('windows'))"&gt;$(TargetFrameworks);net8.0-windows10.0.19041.0 </span><span class="hljs-tag"><span class="koboSpan" id="kobo.4830.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.4831.1">TargetFrameworks</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.4832.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4833.1">Then, add a reference to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4834.1">PackagesManagementBlazor.Shared</span></code><span class="koboSpan" id="kobo.4835.1"> project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4836.1">Now, right-click on the client WebAssembly project and select </span><strong class="screenText"><span class="koboSpan" id="kobo.4837.1">Open Folder in File Explorer</span></strong><span class="koboSpan" id="kobo.4838.1">. </span><span class="koboSpan" id="kobo.4838.2">Then, copy the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4839.1">ViewModels</span></code><span class="koboSpan" id="kobo.4840.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.4841.1">Services</span></code><span class="koboSpan" id="kobo.4842.1"> folders, and paste them in Visual Studio Solution Explorer under the newly created </span><code class="inlineCode"><span class="koboSpan" id="kobo.4843.1">PackagesManagementMAUIBlazor</span></code><span class="koboSpan" id="kobo.4844.1"> node.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4845.1">Then, change the namespaces of the files contained in these folders to be, respectively, </span><code class="inlineCode"><span class="koboSpan" id="kobo.4846.1">PackagesManagementMAUIBlazor.ViewModels</span></code><span class="koboSpan" id="kobo.4847.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.4848.1">PackagesManagementMAUIBlazor.Services</span></code><span class="koboSpan" id="kobo.4849.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4850.1">Now, replace the content of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4851.1">Shared</span></code><span class="koboSpan" id="kobo.4852.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.4853.1">Pages</span></code><span class="koboSpan" id="kobo.4854.1"> folders of the newly created project with the content of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4855.1">Layout</span></code><span class="koboSpan" id="kobo.4856.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.4857.1">Pages</span></code><span class="koboSpan" id="kobo.4858.1"> folders of the client Blazor WebAssembly project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4859.1">Edit the newly copied </span><code class="inlineCode"><span class="koboSpan" id="kobo.4860.1">Home.razor</span></code><span class="koboSpan" id="kobo.4861.1"> file and replace its header with:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4862.1">@using PackagesManagementMAUIBlazor.Services
@using PackagesManagementBlazor.Shared
@using PackagesManagementMAUIBlazor.ViewModels
@inject PackagesClient client
@page </span><span class="hljs-string"><span class="koboSpan" id="kobo.4863.1">"/"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4864.1">Finally, add the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.4865.1">HttpClient</span></code><span class="koboSpan" id="kobo.4866.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.4867.1">PackagesClient</span></code><span class="koboSpan" id="kobo.4868.1"> configurations of the WebAssembly</span><a id="_idIndexMarker1712"/><span class="koboSpan" id="kobo.4869.1"> project to </span><code class="inlineCode"><span class="koboSpan" id="kobo.4870.1">MAUIProgram.cs</span></code><span class="koboSpan" id="kobo.4871.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4872.1">builder.Services.AddScoped(sp =&gt; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4873.1">new</span></span><span class="koboSpan" id="kobo.4874.1"> HttpClient
    { BaseAddress = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4875.1">new</span></span><span class="koboSpan" id="kobo.4876.1"> Uri(</span><span class="hljs-string"><span class="koboSpan" id="kobo.4877.1">"https://localhost:7269/"</span></span><span class="koboSpan" id="kobo.4878.1">) });
builder.Services.AddScoped&lt;PackagesClient&gt;();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4879.1">With this, you must add </span><code class="inlineCode"><span class="koboSpan" id="kobo.4880.1">PackagesManagementMAUIBlazor</span></code><span class="koboSpan" id="kobo.4881.1"> to the projects to start. </span><span class="koboSpan" id="kobo.4881.2">Right-click on the solution and select </span><strong class="screenText"><span class="koboSpan" id="kobo.4882.1">Configure Startup Projects</span></strong><span class="koboSpan" id="kobo.4883.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4884.1">In the windows that open, select also the newly created MAUI Blazor project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4885.1">Now, you can launch the application. </span><span class="koboSpan" id="kobo.4885.2">Three windows should open (two browser windows and a Windows window) but both client project windows should show exactly the same application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4886.1">After having discussed all the components of our WWTravelClub application, we need just to describe how to test it.</span></p>
<h1 class="heading-1" id="_idParaDest-470"><span class="koboSpan" id="kobo.4887.1">Testing the WWTravelClub application</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.4888.1">In this section, we add some unit</span><a id="_idIndexMarker1713"/><span class="koboSpan" id="kobo.4889.1"> and functional test projects to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4890.1">PackagesManagement</span></code><span class="koboSpan" id="kobo.4891.1"> frontend microservice we described in the </span><em class="italic"><span class="koboSpan" id="kobo.4892.1">A frontend microservice</span></em><span class="koboSpan" id="kobo.4893.1"> section of this chapter. </span><span class="koboSpan" id="kobo.4893.2">If you don’t have it, you can download it from the section of the GitHub repository associated with the book in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4894.1">ch19</span></code><span class="koboSpan" id="kobo.4895.1"> folder. </span><span class="koboSpan" id="kobo.4895.2">It is worth pointing out that in real-world projects, unit test batteries are enhanced by integration tests, and acceptance tests would include not only functional tests but also various kinds of performance tests.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4896.1">You are encouraged to review </span><em class="italic"><span class="koboSpan" id="kobo.4897.1">Chapter 9</span></em><span class="koboSpan" id="kobo.4898.1">, </span><em class="italic"><span class="koboSpan" id="kobo.4899.1">Testing Your Enterprise Application</span></em><span class="koboSpan" id="kobo.4900.1">, before continuing with this section.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4901.1">As a first step, let’s make a new copy of the solution folder and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.4902.1">PackagesManagementWithTests</span></code><span class="koboSpan" id="kobo.4903.1">. </span><span class="koboSpan" id="kobo.4903.2">Then, open the solution and add it to an xUnit .NET C# test project named </span><code class="inlineCode"><span class="koboSpan" id="kobo.4904.1">PackagesManagementTest</span></code><span class="koboSpan" id="kobo.4905.1">. </span><span class="koboSpan" id="kobo.4905.2">Finally, add a reference to the ASP.NET Core project (</span><code class="inlineCode"><span class="koboSpan" id="kobo.4906.1">PackagesManagement</span></code><span class="koboSpan" id="kobo.4907.1">), since we will test it, and a reference to the latest version of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4908.1">Moq</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.4909.1">NuGet</span></code><span class="koboSpan" id="kobo.4910.1"> package, since we require mocking capabilities. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.4911.1">It is worth remembering that </span><code class="inlineCode"><span class="koboSpan" id="kobo.4912.1">Moq</span></code><span class="koboSpan" id="kobo.4913.1"> is a mocking library and that the purpose of mocking is to decouple dependencies between classes by replacing actual classes with mocked classes whose behavior is under the complete control of the test code. </span><span class="koboSpan" id="kobo.4913.2">This way, each class can be unit tested independently </span><a id="_idIndexMarker1714"/><span class="koboSpan" id="kobo.4914.1">from the behavior of other classes it references. </span><span class="koboSpan" id="kobo.4914.2">For more details about </span><code class="inlineCode"><span class="koboSpan" id="kobo.4915.1">Moq</span></code><span class="koboSpan" id="kobo.4916.1">, please refer to </span><em class="italic"><span class="koboSpan" id="kobo.4917.1">Chapter 9</span></em><span class="koboSpan" id="kobo.4918.1">, </span><em class="italic"><span class="koboSpan" id="kobo.4919.1">Testing Your Enterprise Application</span></em><span class="koboSpan" id="kobo.4920.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4921.1">At this point, we are ready to write our tests.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4922.1">As an example, we will write unit tests for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4923.1">Edit</span></code><span class="koboSpan" id="kobo.4924.1"> method decorated with </span><code class="inlineCode"><span class="koboSpan" id="kobo.4925.1">[HttpPost]</span></code><span class="koboSpan" id="kobo.4926.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4927.1">ManagePackagesController</span></code><span class="koboSpan" id="kobo.4928.1"> controller, which is shown as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4929.1">[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.4930.1">HttpPost</span></span><span class="koboSpan" id="kobo.4931.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4932.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4933.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4934.1"> Task&lt;IActionResult&gt; </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.4935.1">Edit</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4936.1">(</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4937.1">    PackageFullEditViewModel vm,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.4938.1">    [FromServices] ICommandHandler&lt;UpdatePackageCommand&gt; command</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4939.1">)</span></span><span class="koboSpan" id="kobo.4940.1">
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4941.1">if</span></span><span class="koboSpan" id="kobo.4942.1"> (ModelState.IsValid)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4943.1">await</span></span><span class="koboSpan" id="kobo.4944.1"> command.HandleAsync(
		</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4945.1">new</span></span><span class="koboSpan" id="kobo.4946.1">  UpdatePackageCommand(vm));
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4947.1">return</span></span><span class="koboSpan" id="kobo.4948.1"> RedirectToAction(
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4949.1">nameof</span></span><span class="koboSpan" id="kobo.4950.1">(ManagePackagesController.Index));
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4951.1">else</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.4952.1">return</span></span><span class="koboSpan" id="kobo.4953.1"> View(vm);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4954.1">Before writing our test methods, let’s rename the test class that was automatically included in the test project as </span><code class="inlineCode"><span class="koboSpan" id="kobo.4955.1">ManagePackagesControllerTests</span></code><span class="koboSpan" id="kobo.4956.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4957.1">The first test verifies that if there are errors in </span><code class="inlineCode"><span class="koboSpan" id="kobo.4958.1">ModelState</span></code><span class="koboSpan" id="kobo.4959.1">, the action method renders a view with the same model it received as an argument so that the user can correct all errors. </span><span class="koboSpan" id="kobo.4959.2">We need to test all possibilities. </span><span class="koboSpan" id="kobo.4959.3">Let’s delete the existing test method and write an empty </span><code class="inlineCode"><span class="koboSpan" id="kobo.4960.1">DeletePostValidationFailedTest</span></code><span class="koboSpan" id="kobo.4961.1"> method, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4962.1">[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.4963.1">Fact</span></span><span class="koboSpan" id="kobo.4964.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4965.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4966.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4967.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.4968.1">DeletePostValidationFailedTest</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4969.1">()</span></span><span class="koboSpan" id="kobo.4970.1">
{
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4971.1">The method must be </span><code class="inlineCode"><span class="koboSpan" id="kobo.4972.1">async</span></code><span class="koboSpan" id="kobo.4973.1"> and the </span><a id="_idIndexMarker1715"/><span class="koboSpan" id="kobo.4974.1">return type must be </span><code class="inlineCode"><span class="koboSpan" id="kobo.4975.1">Task</span></code><span class="koboSpan" id="kobo.4976.1"> since the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4977.1">Edit</span></code><span class="koboSpan" id="kobo.4978.1"> method that we have to test is </span><code class="inlineCode"><span class="koboSpan" id="kobo.4979.1">async</span></code><span class="koboSpan" id="kobo.4980.1">. </span><span class="koboSpan" id="kobo.4980.2">In this test, we don’t need mocked objects since no injected object will be used. </span><span class="koboSpan" id="kobo.4980.3">Thus, as a preparation for the test, we just need to create a controller instance, and we must add an error to </span><code class="inlineCode"><span class="koboSpan" id="kobo.4981.1">ModelState</span></code><span class="koboSpan" id="kobo.4982.1"> as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.4983.1">var</span></span><span class="koboSpan" id="kobo.4984.1"> controller = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4985.1">new</span></span><span class="koboSpan" id="kobo.4986.1"> ManagePackagesController();
controller.ModelState
    .AddModelError(</span><span class="hljs-string"><span class="koboSpan" id="kobo.4987.1">"Name"</span></span><span class="koboSpan" id="kobo.4988.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.4989.1">"fake error"</span></span><span class="koboSpan" id="kobo.4990.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4991.1">Then, we invoke the method, injecting </span><code class="inlineCode"><span class="koboSpan" id="kobo.4992.1">ViewModel</span></code><span class="koboSpan" id="kobo.4993.1"> and a </span><code class="inlineCode"><span class="koboSpan" id="kobo.4994.1">null</span></code><span class="koboSpan" id="kobo.4995.1"> command handler as its arguments, since the command handler will not be used:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.4996.1">var</span></span><span class="koboSpan" id="kobo.4997.1"> vm = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4998.1">new</span></span><span class="koboSpan" id="kobo.4999.1"> PackageFullEditViewModel();
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5000.1">var</span></span><span class="koboSpan" id="kobo.5001.1"> commandDependency =
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5002.1">new</span></span><span class="koboSpan" id="kobo.5003.1"> Mock&lt;ICommandHandler&lt;UpdatePackageCommand&gt;&gt;();
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5004.1">var</span></span><span class="koboSpan" id="kobo.5005.1"> result = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5006.1">await</span></span><span class="koboSpan" id="kobo.5007.1"> controller.Edit(vm, commandDependency.Object);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.5008.1">In the verification stage, we verify that the result is </span><code class="inlineCode"><span class="koboSpan" id="kobo.5009.1">ViewResult</span></code><span class="koboSpan" id="kobo.5010.1"> and that it contains the same model that was injected into the controller:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.5011.1">var</span></span><span class="koboSpan" id="kobo.5012.1"> viewResult = Assert.IsType&lt;ViewResult&gt;(result);
Assert.Equal(vm, viewResult.Model);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.5013.1">Now, we also need a test to verify that if there are no errors, the command handler is called, and then the browser is redirected to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.5014.1">Index</span></code><span class="koboSpan" id="kobo.5015.1"> controller action method. </span><span class="koboSpan" id="kobo.5015.2">We call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.5016.1">DeletePostSuccessTest</span></code><span class="koboSpan" id="kobo.5017.1"> method:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.5018.1">[</span><span class="hljs-meta"><span class="koboSpan" id="kobo.5019.1">Fact</span></span><span class="koboSpan" id="kobo.5020.1">]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5021.1">public</span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5022.1">async</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.5023.1"> Task </span></span><span class="hljs-title"><span class="koboSpan" id="kobo.5024.1">DeletePostSuccessTest</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.5025.1">()</span></span><span class="koboSpan" id="kobo.5026.1">
{
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.5027.1">This time, the preparation code must include the preparation of a command handler mock, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.5028.1">var</span></span><span class="koboSpan" id="kobo.5029.1"> controller = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5030.1">new</span></span><span class="koboSpan" id="kobo.5031.1"> ManagePackagesController();
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5032.1">var</span></span><span class="koboSpan" id="kobo.5033.1"> commandDependency =
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5034.1">new</span></span><span class="koboSpan" id="kobo.5035.1"> Mock&lt;ICommandHandler&lt;UpdatePackageCommand&gt;&gt;();
commandDependency
    .Setup(m =&gt;
	m.HandleAsync(It.IsAny&lt;UpdatePackageCommand&gt;()))
    .Returns(Task.CompletedTask);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5036.1">var</span></span><span class="koboSpan" id="kobo.5037.1"> vm = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5038.1">new</span></span><span class="koboSpan" id="kobo.5039.1"> PackageFullEditViewModel();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.5040.1">Since the handler </span><code class="inlineCode"><span class="koboSpan" id="kobo.5041.1">HandleAsync</span></code><span class="koboSpan" id="kobo.5042.1"> method returns no </span><code class="inlineCode"><span class="koboSpan" id="kobo.5043.1">async</span></code><span class="koboSpan" id="kobo.5044.1"> value, we can’t use </span><code class="inlineCode"><span class="koboSpan" id="kobo.5045.1">ReturnsAsync</span></code><span class="koboSpan" id="kobo.5046.1">, but we </span><a id="_idIndexMarker1716"/><span class="koboSpan" id="kobo.5047.1">have to return just a completed </span><code class="inlineCode"><span class="koboSpan" id="kobo.5048.1">Task (Task.Complete)</span></code><span class="koboSpan" id="kobo.5049.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.5050.1">Returns</span></code><span class="koboSpan" id="kobo.5051.1"> method. </span><span class="koboSpan" id="kobo.5051.2">The method to test is called with both </span><code class="inlineCode"><span class="koboSpan" id="kobo.5052.1">ViewModel</span></code><span class="koboSpan" id="kobo.5053.1"> and the mocked handler:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.5054.1">var</span></span><span class="koboSpan" id="kobo.5055.1"> result = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5056.1">await</span></span><span class="koboSpan" id="kobo.5057.1"> controller.Edit(vm,
    commandDependency.Object);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.5058.1">In this case, the verification code is as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.5059.1">commandDependency.Verify(m =&gt; m.HandleAsync(
    It.IsAny&lt;UpdatePackageCommand&gt;()),
    Times.Once);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5060.1">var</span></span><span class="koboSpan" id="kobo.5061.1"> redirectResult = Assert.IsType&lt;RedirectToActionResult&gt;(result);
Assert.Equal(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.5062.1">nameof</span></span><span class="koboSpan" id="kobo.5063.1">(ManagePackagesController.Index),
    redirectResult.ActionName);
Assert.Null(redirectResult.ControllerName);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.5064.1">As the first step, we verify that the command handler has actually been invoked once. </span><span class="koboSpan" id="kobo.5064.2">A better verification should also include a check that it was invoked with a command that includes </span><code class="inlineCode"><span class="koboSpan" id="kobo.5065.1">ViewModel</span></code><span class="koboSpan" id="kobo.5066.1"> passed to the action method. </span><span class="koboSpan" id="kobo.5066.2">We will take it up as an exercise.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5067.1">Then we verify that the action method returns </span><code class="inlineCode"><span class="koboSpan" id="kobo.5068.1">RedirectToActionResult</span></code><span class="koboSpan" id="kobo.5069.1"> with the right action method name and with no controller name specified.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5070.1">Once all the tests are ready, if the test window does not appear on the left bar of Visual Studio, we may simply select the </span><strong class="screenText"><span class="koboSpan" id="kobo.5071.1">Run all tests</span></strong><span class="koboSpan" id="kobo.5072.1"> item from the Visual Studio </span><strong class="screenText"><span class="koboSpan" id="kobo.5073.1">Test</span></strong><span class="koboSpan" id="kobo.5074.1"> menu. </span><span class="koboSpan" id="kobo.5074.2">Once the test window appears, further invocations can be launched from within this window.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5075.1">If a test fails, we can add a breakpoint to its code, so we can launch a debug session on it by right-clicking on it in the test window and then selecting </span><strong class="screenText"><span class="koboSpan" id="kobo.5076.1">Debug selected tests</span></strong><span class="koboSpan" id="kobo.5077.1">. </span><span class="koboSpan" id="kobo.5077.2">It is worth remembering that failures do not depend necessarily on errors in the code under test but might also depend on errors in the testing code itself.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5078.1">In the next subsection, we</span><a id="_idIndexMarker1717"/><span class="koboSpan" id="kobo.5079.1"> will show how to upload our code to a shared Azure DevOps repository and how to automatize our tests with an Azure DevOps pipeline.</span></p>
<h2 class="heading-2" id="_idParaDest-471"><span class="koboSpan" id="kobo.5080.1">Connecting to an Azure DevOps repository</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.5081.1">Tests play a fundamental role in the</span><a id="_idIndexMarker1718"/><span class="koboSpan" id="kobo.5082.1"> application CI/CD cycle, specifically in CI. </span><span class="koboSpan" id="kobo.5082.2">They must be executed at least each time the master branch of the application repository is modified to verify that changes don’t introduce bugs.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5083.1">The following steps show how to connect our solution to an Azure DevOps repository, where we will define an Azure DevOps pipeline that builds the project, and that also launches all the unit tests we defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.5084.1">PackagesManagementTest</span></code><span class="koboSpan" id="kobo.5085.1"> project at each build.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5086.1">However, the functional tests that we defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.5087.1">PackagesManagementFTest</span></code><span class="koboSpan" id="kobo.5088.1"> project must be executed only before a sprint is released. </span><span class="koboSpan" id="kobo.5088.2">Therefore, they must be placed in a different pipeline that takes care of delivering the application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5089.1">In this way, every day after all developers have pushed their changes, we can launch the pipeline to verify that the repository code compiles and passes all the unit tests:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.5090.1">As a first step, we need a free DevOps subscription. </span><span class="koboSpan" id="kobo.5090.2">If you don’t already have one, please create one by clicking the </span><strong class="screenText"><span class="koboSpan" id="kobo.5091.1">Start free</span></strong><span class="koboSpan" id="kobo.5092.1"> button on this page: </span><a href="https://azure.microsoft.com/en-us/services/devops/"><span class="url"><span class="koboSpan" id="kobo.5093.1">https://azure.microsoft.com/en-us/services/devops/</span></span></a><span class="koboSpan" id="kobo.5094.1">. </span><span class="koboSpan" id="kobo.5094.2">Here, let’s follow the wizard to define an organization and then a project.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.5095.1">On the project page, select the </span><strong class="screenText"><span class="koboSpan" id="kobo.5096.1">Files</span></strong><span class="koboSpan" id="kobo.5097.1"> menu, click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.5098.1">Repos</span></strong><span class="koboSpan" id="kobo.5099.1"> menu item, and then copy the repository URL:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.5100.1"><img alt="Graphical user interface  Description automatically generated with medium confidence" src="../Images/B19820_21_30.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.5101.1">Figure 21.30: Copying the repository URL</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.5102.1">Ensure you are logged in to Visual Studio with your Azure account (the same one used in the creation </span><a id="_idIndexMarker1719"/><span class="koboSpan" id="kobo.5103.1">of the DevOps account). </span><span class="koboSpan" id="kobo.5103.2">In the </span><strong class="screenText"><span class="koboSpan" id="kobo.5104.1">Git Changes</span></strong><span class="koboSpan" id="kobo.5105.1"> tab, click the </span><strong class="screenText"><span class="koboSpan" id="kobo.5106.1">Create Git Repository...</span></strong><span class="koboSpan" id="kobo.5107.1"> button:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.5108.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B19820_21_31.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.5109.1">Figure 21.31: Opening the connection window</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.5110.1">In the window that opens, select </span><strong class="screenText"><span class="koboSpan" id="kobo.5111.1">Existing remote</span></strong><span class="koboSpan" id="kobo.5112.1"> from the left menu and copy and paste the remote repository URL:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.5113.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B19820_21_32.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.5114.1">Figure 21.32: Connection window</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.5115.1">Then, click the </span><strong class="screenText"><span class="koboSpan" id="kobo.5116.1">Create and Push</span></strong><span class="koboSpan" id="kobo.5117.1"> button and wait until the ready icon in the bottom-left corner of</span><a id="_idIndexMarker1720"/><span class="koboSpan" id="kobo.5118.1"> Visual Studio is checked:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.5119.1"><img alt="Graphical user interface, application, Teams  Description automatically generated" src="../Images/B19820_21_33.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.5120.1">Figure 21.33: Operation completed</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="6"><span class="koboSpan" id="kobo.5121.1">At this point, the repository has been created locally, connected with the selected remote repository, and all changes have been committed and pushed to the remote repository.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.5122.1">Now, click the </span><strong class="screenText"><span class="koboSpan" id="kobo.5123.1">Pipelines</span></strong><span class="koboSpan" id="kobo.5124.1"> menu item to create a DevOps pipeline to build and test your project. </span><span class="koboSpan" id="kobo.5124.2">In the window that appears, click the button to create a new pipeline:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.5125.1"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B19820_21_34.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.5126.1">Figure 21.34: Pipeline page</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="8"><span class="koboSpan" id="kobo.5127.1">You will be</span><a id="_idIndexMarker1721"/><span class="koboSpan" id="kobo.5128.1"> prompted to select where your repository is located:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.5129.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B19820_21_35.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.5130.1">Figure 21.35: Repository selection</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="9"><span class="koboSpan" id="kobo.5131.1">Select </span><strong class="screenText"><span class="koboSpan" id="kobo.5132.1">Azure Repos Git</span></strong><span class="koboSpan" id="kobo.5133.1"> and then</span><a id="_idIndexMarker1722"/><span class="koboSpan" id="kobo.5134.1"> your repository. </span><span class="koboSpan" id="kobo.5134.2">Then, you will be prompted about the nature of the project:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.5135.1"><img alt="Graphical user interface, text, application  Description automatically generated" src="../Images/B19820_21_36.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.5136.1">Figure 21.36: Pipeline configuration</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="10"><span class="koboSpan" id="kobo.5137.1">Select </span><strong class="screenText"><span class="koboSpan" id="kobo.5138.1">ASP.NET Core</span></strong><span class="koboSpan" id="kobo.5139.1">. </span><span class="koboSpan" id="kobo.5139.2">A pipeline</span><a id="_idIndexMarker1723"/><span class="koboSpan" id="kobo.5140.1"> for building and testing your project will be automatically created for you. </span><span class="koboSpan" id="kobo.5140.2">Save it by committing the newly created </span><code class="inlineCode"><span class="koboSpan" id="kobo.5141.1">.yaml</span></code><span class="koboSpan" id="kobo.5142.1"> file to your repository:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.5143.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B19820_21_37.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.5144.1">Figure 21.37: Pipeline properties</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="11"><span class="koboSpan" id="kobo.5145.1">The pipeline can be run by selecting the </span><strong class="screenText"><span class="koboSpan" id="kobo.5146.1">Queue</span></strong><span class="koboSpan" id="kobo.5147.1"> button, but since the standard pipeline </span><a id="_idIndexMarker1724"/><span class="koboSpan" id="kobo.5148.1">scaffolded by DevOps has a trigger on the master branch of the repository, it is automatically launched each time changes to this branch are committed and each time the pipeline is modified. </span><span class="koboSpan" id="kobo.5148.2">The pipeline can be modified by clicking the </span><strong class="screenText"><span class="koboSpan" id="kobo.5149.1">Edit</span></strong><span class="koboSpan" id="kobo.5150.1"> button:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.5151.1"><img alt="Graphical user interface, text, application, email, Teams  Description automatically generated" src="../Images/B19820_21_38.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.5152.1">Figure 21.38: Pipeline code</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="12"><span class="koboSpan" id="kobo.5153.1">Once in edit</span><a id="_idIndexMarker1725"/><span class="koboSpan" id="kobo.5154.1"> mode, all pipeline steps can be edited by clicking the </span><strong class="screenText"><span class="koboSpan" id="kobo.5155.1">Settings</span></strong><span class="koboSpan" id="kobo.5156.1"> link that appears above each of them. </span><span class="koboSpan" id="kobo.5156.2">New pipeline steps can be added as follows:</span><ol class="alphabeticList" style="list-style-type: lower-alpha;">
<li class="alphabeticList" value="1"><span class="koboSpan" id="kobo.5157.1">Write </span><code class="inlineCode"><span class="koboSpan" id="kobo.5158.1">- task:</span></code><span class="koboSpan" id="kobo.5159.1"> where the new step must be added and then accept one of the suggestions that appear while you are typing the task name.</span></li>
<li class="alphabeticList"><span class="koboSpan" id="kobo.5160.1">Once you have written a valid task name, a </span><strong class="screenText"><span class="koboSpan" id="kobo.5161.1">Settings</span></strong><span class="koboSpan" id="kobo.5162.1"> link appears above the new step. </span><span class="koboSpan" id="kobo.5162.2">Click it.</span></li>
<li class="alphabeticList"><span class="koboSpan" id="kobo.5163.1">Insert the desired task parameters in the window that appears and then save.</span></li>
</ol>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.5164.1">To have our test working, we need to specify the criteria to locate all assemblies that contain tests. </span><span class="koboSpan" id="kobo.5164.2">In our case, since we have to execute just the tests contained in </span><code class="inlineCode"><span class="koboSpan" id="kobo.5165.1">PackagesManagementTest.dll</span></code><span class="koboSpan" id="kobo.5166.1"> and not the ones contained in </span><code class="inlineCode"><span class="koboSpan" id="kobo.5167.1">PackagesManagementFTest.dll</span></code><span class="koboSpan" id="kobo.5168.1">, we must specify the exact .</span><code class="inlineCode"><span class="koboSpan" id="kobo.5169.1">ddl</span></code><span class="koboSpan" id="kobo.5170.1"> name.
    </span><p class="normal"><span class="koboSpan" id="kobo.5171.1">Click the </span><strong class="screenText"><span class="koboSpan" id="kobo.5172.1">Settings</span></strong><span class="koboSpan" id="kobo.5173.1"> link of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.5174.1">VSTest@2</span></code><span class="koboSpan" id="kobo.5175.1"> test task and replace the content that is automatically suggested for the </span><strong class="screenText"><span class="koboSpan" id="kobo.5176.1">Test files</span></strong><span class="koboSpan" id="kobo.5177.1"> field with the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.5178.1">**\PackagesManagementTest.dll
!**\*TestAdapter.dll
!**\obj\**
</span></code></pre></li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="14"><span class="koboSpan" id="kobo.5179.1">Then, click </span><strong class="screenText"><span class="koboSpan" id="kobo.5180.1">Add</span></strong><span class="koboSpan" id="kobo.5181.1"> to modify </span><a id="_idIndexMarker1726"/><span class="koboSpan" id="kobo.5182.1">the actual pipeline content. </span><span class="koboSpan" id="kobo.5182.2">As soon as you confirm your changes in the </span><strong class="screenText"><span class="koboSpan" id="kobo.5183.1">Save and run</span></strong><span class="koboSpan" id="kobo.5184.1"> dialog, the pipeline is launched and, if there are no errors, test results are computed. </span><span class="koboSpan" id="kobo.5184.2">The results of tests launched during a specific build can be analyzed by selecting the specific build in the pipeline </span><strong class="screenText"><span class="koboSpan" id="kobo.5185.1">Runs</span></strong><span class="koboSpan" id="kobo.5186.1"> tab and by clicking the </span><strong class="screenText"><span class="koboSpan" id="kobo.5187.1">Tests</span></strong><span class="koboSpan" id="kobo.5188.1"> tab on the page that appears. </span><span class="koboSpan" id="kobo.5188.2">In our case, we should see something like the following screenshot:</span></li>
</ol>
<figure class="mediaobject"><span class="koboSpan" id="kobo.5189.1"><img alt="" role="presentation" src="../Images/B19820_21_39.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.5190.1">Figure 21.39: Test results</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5191.1">Summing up, we created a new Azure DevOps repository, published the solution to the new repository, and then created a build pipeline that executes our tests after each build. </span><span class="koboSpan" id="kobo.5191.2">The build pipeline is</span><a id="_idIndexMarker1727"/><span class="koboSpan" id="kobo.5192.1"> executed as soon as we save it and will be executed each time someone commits to the master branch.</span></p>
<h1 class="heading-1" id="_idParaDest-472"><span class="koboSpan" id="kobo.5193.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.5194.1">The main purpose of this chapter was to deliver pieces of implementations that can be useful to begin the challenge of delivering a software solution for an enterprise. </span><span class="koboSpan" id="kobo.5194.2">Although we have not shown the complete implemention of the WWTravelClub application, we are confident that the microservices and code provided here can help you in your professional projects; this is in line with what we understand to be the main purpose of a software architect―to help the team in developing software that meets the users’ needs exactly as required.</span></p>
<h1 class="heading-1"><span class="koboSpan" id="kobo.5195.1">Leave a review!</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.5196.1">Enjoyed this book? </span><span class="koboSpan" id="kobo.5196.2">Help readers like you by leaving an Amazon review. </span><span class="koboSpan" id="kobo.5196.3">Scan the QR code below for a 20% discount code.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5197.1"><img alt="" role="presentation" src="../Images/Leave_a_review_QR.png"/></span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.5198.1">*Limited Offer</span></em></p>
</div>
</body></html>