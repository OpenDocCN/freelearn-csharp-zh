<html><head></head><body>
<div id="_idContainer031">
<h1 class="chapter-number" id="_idParaDest-68"><a id="_idTextAnchor130"/><span class="koboSpan" id="kobo.1.1">3</span></h1>
<h1 id="_idParaDest-69"><a id="_idTextAnchor131"/><span class="koboSpan" id="kobo.2.1">ASP.NET Core Fundamentals (Part 1)</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In the previous chapter, we learned how to create a basic REST API using ASP.NET Core. </span><span class="koboSpan" id="kobo.3.2">ASP.NET Core provides a lot of features that make it easy to build </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">web APIs.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In this chapter, we will be covering the </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">following topics:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.7.1">Routing</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.8.1">Configuration</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.9.1">Environments</span></span></li>
</ul>
<p><strong class="bold"><span class="koboSpan" id="kobo.10.1">Routing</span></strong><span class="koboSpan" id="kobo.11.1"> is </span><a id="_idIndexMarker256"/><span class="koboSpan" id="kobo.12.1">used to map incoming requests to the corresponding controller actions. </span><span class="koboSpan" id="kobo.12.2">We will discuss how to use attribute routing to configure the routing for ASP.NET Core web APIs. </span><strong class="bold"><span class="koboSpan" id="kobo.13.1">Configuration</span></strong><span class="koboSpan" id="kobo.14.1"> is used to provide the initial settings for an application on its startup, such as database connection strings, API keys, and other settings. </span><span class="koboSpan" id="kobo.14.2">Configuration is often used with </span><strong class="bold"><span class="koboSpan" id="kobo.15.1">environments</span></strong><span class="koboSpan" id="kobo.16.1">, such as development, staging, and production. </span><span class="koboSpan" id="kobo.16.2">At the conclusion of this chapter, you will have the skills to create RESTful routes for your ASP.NET Core web APIs and utilize the ASP.NET Core configuration framework to manage configurations for </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">different environments.</span></span></p>
<h1 id="_idParaDest-70"><a id="_idTextAnchor132"/><span class="koboSpan" id="kobo.18.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.19.1">The code examples in this chapter can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">at </span></span><a href="https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8"><span class="No-Break"><span class="koboSpan" id="kobo.21.1">https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.22.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.23.1">You can use Visual Studio 2022 or </span><strong class="bold"><span class="koboSpan" id="kobo.24.1">VS Code</span></strong><span class="koboSpan" id="kobo.25.1"> to open </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">the solutions.</span></span></p>
<h1 id="_idParaDest-71"><a id="_idTextAnchor133"/><span class="koboSpan" id="kobo.27.1">Routing</span></h1>
<p><span class="koboSpan" id="kobo.28.1">In </span><a href="B18971_02.xhtml#_idTextAnchor068"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.29.1">Chapter 2</span></em></span></a><em class="italic"><span class="koboSpan" id="kobo.30.1">, </span></em><span class="koboSpan" id="kobo.31.1">we introduced how to </span><a id="_idIndexMarker257"/><span class="koboSpan" id="kobo.32.1">create a simple ASP.NET Core web API project using the default controller-based template. </span><span class="koboSpan" id="kobo.32.2">The project uses some attributes, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.33.1">[Route("api/controller")]</span></strong><span class="koboSpan" id="kobo.34.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.35.1">[HttpGet]</span></strong><span class="koboSpan" id="kobo.36.1">, and so on, to map incoming requests to the corresponding controller actions. </span><span class="koboSpan" id="kobo.36.2">These attributes are used to configure the routing for the ASP.NET Core web </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">API project.</span></span></p>
<p><span class="koboSpan" id="kobo.38.1">Routing is a mechanism that monitors incoming requests and determines which action method is to be invoked for those requests. </span><span class="koboSpan" id="kobo.38.2">ASP.NET Core provides two types of routing: conventional routing and attribute routing. </span><span class="koboSpan" id="kobo.38.3">Conventional routing is typically used for ASP.NET Core MVC applications, while ASP.NET Core web APIs use attribute routing. </span><span class="koboSpan" id="kobo.38.4">In this section, we will discuss attribute routing in </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">more detail.</span></span></p>
<p><span class="koboSpan" id="kobo.40.1">You can download the </span><strong class="source-inline"><span class="koboSpan" id="kobo.41.1">RoutingDemo</span></strong><span class="koboSpan" id="kobo.42.1"> sample project from </span><strong class="source-inline"><span class="koboSpan" id="kobo.43.1">/samples/chapter3/RoutingDemo/</span></strong><span class="koboSpan" id="kobo.44.1"> in the chapter's </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">GitHub repository.</span></span></p>
<h2 id="_idParaDest-72"><a id="_idTextAnchor134"/><span class="koboSpan" id="kobo.46.1">What is attribute routing?</span></h2>
<p><span class="koboSpan" id="kobo.47.1">Open </span><a id="_idIndexMarker258"/><span class="koboSpan" id="kobo.48.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.49.1">Program.cs</span></strong><span class="koboSpan" id="kobo.50.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.51.1">RoutingDemo</span></strong><span class="koboSpan" id="kobo.52.1"> project. </span><span class="koboSpan" id="kobo.52.2">You </span><a id="_idIndexMarker259"/><span class="koboSpan" id="kobo.53.1">will find the </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.55.1">
app.MapControllers();</span></pre> <p><span class="koboSpan" id="kobo.56.1">This line of code adds endpoints for controller actions to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.57.1">IEndpointRouteBuilder</span></strong><span class="koboSpan" id="kobo.58.1"> instance without specifying any routes. </span><span class="koboSpan" id="kobo.58.2">To specify the routes, we need to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.59.1">[Route]</span></strong><span class="koboSpan" id="kobo.60.1"> attribute on the controller class and the action methods. </span><span class="koboSpan" id="kobo.60.2">The following code shows how to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.61.1">[Route]</span></strong><span class="koboSpan" id="kobo.62.1"> attribute on the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.63.1">WeatherForecastController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.64.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.65.1">
[ApiController][Route("[controller]")]
public class WeatherForecastController : ControllerBase
{
  // Omitted for brevity
}</span></pre>
<p><span class="koboSpan" id="kobo.66.1">In the preceding code, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.67.1">[controller]</span></strong><span class="koboSpan" id="kobo.68.1"> token is a placeholder for the controller name. </span><span class="koboSpan" id="kobo.68.2">In this case, the controller name is </span><strong class="source-inline"><span class="koboSpan" id="kobo.69.1">WeatherForecast</span></strong><span class="koboSpan" id="kobo.70.1">, so the </span><strong class="source-inline"><span class="koboSpan" id="kobo.71.1">[controller]</span></strong><span class="koboSpan" id="kobo.72.1"> route template is replaced with </span><strong class="source-inline"><span class="koboSpan" id="kobo.73.1">WeatherForecast</span></strong><span class="koboSpan" id="kobo.74.1">. </span><span class="koboSpan" id="kobo.74.2">That means the route for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.75.1">WeatherForecastController</span></strong><span class="koboSpan" id="kobo.76.1"> class </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.78.1">/WeatherForecast</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.79.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.80.1">ASP.NET Core has</span><a id="_idIndexMarker260"/><span class="koboSpan" id="kobo.81.1"> some built-in route tokens, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.82.1">[controller]</span></strong><span class="koboSpan" id="kobo.83.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.84.1">[action]</span></strong><span class="koboSpan" id="kobo.85.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.86.1">[area]</span></strong><span class="koboSpan" id="kobo.87.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.88.1">[page]</span></strong><span class="koboSpan" id="kobo.89.1">, and so on. </span><span class="koboSpan" id="kobo.89.2">These tokens are enclosed in square brackets (</span><strong class="source-inline"><span class="koboSpan" id="kobo.90.1">[]</span></strong><span class="koboSpan" id="kobo.91.1">) and will be replaced with the corresponding values. </span><span class="koboSpan" id="kobo.91.2">Note </span><a id="_idIndexMarker261"/><span class="koboSpan" id="kobo.92.1">that these tokens are reserved route parameter names and should not be used as a route parameter </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">like </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.94.1">{controller}</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.96.1">In ASP.NET Core REST web APIs, we usually use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.97.1">[Route("api/[controller]")]</span></strong><span class="koboSpan" id="kobo.98.1"> template to represent API endpoints. </span><span class="koboSpan" id="kobo.98.2">You can find the </span><strong class="source-inline"><span class="koboSpan" id="kobo.99.1">PostsController</span></strong><span class="koboSpan" id="kobo.100.1"> class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.101.1">Controllers</span></strong><span class="koboSpan" id="kobo.102.1"> folder. </span><span class="koboSpan" id="kobo.102.2">The following code shows the routing attribute of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.103.1">PostsController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.104.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.105.1">
[ApiController] [Route("api/[controller]")]
 public class PostsController : ControllerBase
 {
   // Omitted for brevity
 }</span></pre>
<p><span class="koboSpan" id="kobo.106.1">The route for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.107.1">PostsController</span></strong><span class="koboSpan" id="kobo.108.1"> class is </span><strong class="source-inline"><span class="koboSpan" id="kobo.109.1">/api/Posts</span></strong><span class="koboSpan" id="kobo.110.1">. </span><span class="koboSpan" id="kobo.110.2">This is an indication that the endpoint is a REST API endpoint. </span><span class="koboSpan" id="kobo.110.3">Whether you use </span><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">/api</span></strong><span class="koboSpan" id="kobo.112.1"> as the route prefix or not is up to you. </span><span class="koboSpan" id="kobo.112.2">There is no standard </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">for this.</span></span></p>
<p><span class="koboSpan" id="kobo.114.1">Some developers prefer to use lowercase for route templates, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.115.1">/api/posts</span></strong><span class="koboSpan" id="kobo.116.1">. </span><span class="koboSpan" id="kobo.116.2">To achieve this, the route value can be explicitly specified; for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.117.1">[Route("api/posts")]</span></strong><span class="koboSpan" id="kobo.118.1">. </span><span class="koboSpan" id="kobo.118.2">However, it seems a bit tedious to specify the route value for each controller class. </span><span class="koboSpan" id="kobo.118.3">Fortunately, ASP.NET Core provides a way to configure the route value globally. </span><span class="koboSpan" id="kobo.118.4">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.120.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.121.1">
builder.Services.AddRouting(options =&gt; options.LowercaseUrls = true);</span></pre> <p><span class="koboSpan" id="kobo.122.1">The preceding code converts all route templates to lowercase. </span><span class="koboSpan" id="kobo.122.2">Actually, the text matching in ASP.NET Core routing is case-insensitive. </span><span class="koboSpan" id="kobo.122.3">So, this change only affects the generated paths’ URLs, such as </span><a id="_idIndexMarker262"/><span class="koboSpan" id="kobo.123.1">the URLs in Swagger UI and the </span><strong class="bold"><span class="koboSpan" id="kobo.124.1">OpenAPI Specification</span></strong><span class="koboSpan" id="kobo.125.1">. </span><span class="koboSpan" id="kobo.125.2">You</span><a id="_idIndexMarker263"/><span class="koboSpan" id="kobo.126.1"> can use either </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">/api/Posts</span></strong><span class="koboSpan" id="kobo.128.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">/api/posts</span></strong><span class="koboSpan" id="kobo.130.1"> to hit the same </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">controller route.</span></span></p>
<p><span class="koboSpan" id="kobo.132.1">Multiple routes can be applied to one controller class. </span><span class="koboSpan" id="kobo.132.2">The following code shows how to apply multiple routes to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">PostsController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.134.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.135.1">
[ApiController] [Route("api/[controller]")]
 [Route("api/some-posts-whatever")]
 public class PostsController : ControllerBase
 {
   // Omitted for brevity
 }</span></pre>
<p><span class="koboSpan" id="kobo.136.1">In this </span><a id="_idIndexMarker264"/><span class="koboSpan" id="kobo.137.1">case, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">PostsController</span></strong><span class="koboSpan" id="kobo.139.1"> class has two routes: </span><strong class="source-inline"><span class="koboSpan" id="kobo.140.1">/api/posts</span></strong><span class="koboSpan" id="kobo.141.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.142.1">/api/some-posts-whatever</span></strong><span class="koboSpan" id="kobo.143.1">. </span><span class="koboSpan" id="kobo.143.2">It is not recommended to have multiple routes for the same controller class as this can lead to confusion. </span><span class="koboSpan" id="kobo.143.3">If you require multiple routes for the same controller class, please ensure that you have strong reasons for </span><span class="No-Break"><span class="koboSpan" id="kobo.144.1">doing so.</span></span></p>
<p><span class="koboSpan" id="kobo.145.1">In ASP.NET Core REST APIs, we usually do not use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">[action]</span></strong><span class="koboSpan" id="kobo.147.1"> token because the action name is not included in the route template. </span><span class="koboSpan" id="kobo.147.2">Similarly, do not use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.148.1">[Route]</span></strong><span class="koboSpan" id="kobo.149.1"> attribute for action methods. </span><span class="koboSpan" id="kobo.149.2">Instead, we use the HTTP method to distinguish action methods. </span><span class="koboSpan" id="kobo.149.3">We will discuss this in the </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">following section.</span></span></p>
<h2 id="_idParaDest-73"><a id="_idTextAnchor135"/><span class="koboSpan" id="kobo.151.1">Mapping HTTP methods to action methods</span></h2>
<p><span class="koboSpan" id="kobo.152.1">REST APIs </span><a id="_idIndexMarker265"/><span class="koboSpan" id="kobo.153.1">are centered on resources. </span><span class="koboSpan" id="kobo.153.2">When</span><a id="_idIndexMarker266"/><span class="koboSpan" id="kobo.154.1"> we design a REST API, we need to map the CRUD operations to the HTTP methods. </span><span class="koboSpan" id="kobo.154.2">In ASP.NET Core, we can use the following HTTP verb attributes to map HTTP methods to </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">action methods:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.156.1">[HttpGet]</span></strong><span class="koboSpan" id="kobo.157.1"> maps an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.158.1">GET</span></strong><span class="koboSpan" id="kobo.159.1"> method to an </span><span class="No-Break"><span class="koboSpan" id="kobo.160.1">action method</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">[HttpPost]</span></strong><span class="koboSpan" id="kobo.162.1"> maps an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">POST</span></strong><span class="koboSpan" id="kobo.164.1"> method to an </span><span class="No-Break"><span class="koboSpan" id="kobo.165.1">action method</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.166.1">[HttpPut]</span></strong><span class="koboSpan" id="kobo.167.1"> maps an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">PUT</span></strong><span class="koboSpan" id="kobo.169.1"> method to an </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">action method</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.171.1">[HttpDelete]</span></strong><span class="koboSpan" id="kobo.172.1"> maps an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.173.1">DELETE</span></strong><span class="koboSpan" id="kobo.174.1"> method to an </span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">action method</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">[HttpPatch]</span></strong><span class="koboSpan" id="kobo.177.1"> maps an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">PATCH</span></strong><span class="koboSpan" id="kobo.179.1"> method to an </span><span class="No-Break"><span class="koboSpan" id="kobo.180.1">action method</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">[HttpHead]</span></strong><span class="koboSpan" id="kobo.182.1"> maps an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.183.1">HEAD</span></strong><span class="koboSpan" id="kobo.184.1"> method to an </span><span class="No-Break"><span class="koboSpan" id="kobo.185.1">action method</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.186.1">The </span><a id="_idIndexMarker267"/><span class="koboSpan" id="kobo.187.1">following </span><a id="_idIndexMarker268"/><span class="koboSpan" id="kobo.188.1">code shows how to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">[HttpGet]</span></strong><span class="koboSpan" id="kobo.190.1"> attribute to map the HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">GET</span></strong><span class="koboSpan" id="kobo.192.1"> method to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">GetPosts()</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.194.1">action method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.195.1">
[HttpGet] public async Task&lt;ActionResult&lt;List&lt;Post&gt;&gt;&gt; GetPosts()
 {
   // Omitted for brevity
 }</span></pre>
<p><span class="koboSpan" id="kobo.196.1">In ASP.NET Core REST APIs, each action must have an HTTP verb attribute. </span><span class="koboSpan" id="kobo.196.2">If you do not specify an HTTP verb attribute, the framework cannot determine which method should be invoked for the incoming request. </span><span class="koboSpan" id="kobo.196.3">In the preceding code, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.197.1">GET</span></strong><span class="koboSpan" id="kobo.198.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">/api/posts</span></strong><span class="koboSpan" id="kobo.200.1"> endpoint is mapped to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">GetPosts()</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.202.1">action method.</span></span></p>
<p><span class="koboSpan" id="kobo.203.1">The following code shows how to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">[HttpGet]</span></strong><span class="koboSpan" id="kobo.205.1"> attribute to map the HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.206.1">GET</span></strong><span class="koboSpan" id="kobo.207.1"> method to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">GetPost()</span></strong><span class="koboSpan" id="kobo.209.1"> action method with a </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">route template:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.211.1">
[HttpGet("{id}")] public async Task&lt;ActionResult&lt;Post&gt;&gt; GetPost(int id)
 {
   // Omitted for brevity
 }</span></pre>
<p><span class="koboSpan" id="kobo.212.1">The preceding </span><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">HttpGet</span></strong><span class="koboSpan" id="kobo.214.1"> attribute has an </span><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">{id}</span></strong><span class="koboSpan" id="kobo.216.1"> route template, which is a route parameter. </span><span class="koboSpan" id="kobo.216.2">The route parameter is enclosed in curly braces ( </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">{}</span></strong><span class="koboSpan" id="kobo.218.1">). </span><span class="koboSpan" id="kobo.218.2">The route parameter is used to capture the value from the incoming request. </span><span class="koboSpan" id="kobo.218.3">For example, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.219.1">GET</span></strong><span class="koboSpan" id="kobo.220.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">/api/posts/1</span></strong><span class="koboSpan" id="kobo.222.1"> endpoint is mapped to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.223.1">GetPost(int id)</span></strong><span class="koboSpan" id="kobo.224.1"> action method, and the value </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">1</span></strong><span class="koboSpan" id="kobo.226.1"> is captured by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.227.1">{id}</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.228.1">route parameter.</span></span></p>
<p><span class="koboSpan" id="kobo.229.1">The following code shows how to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">[HttpPut]</span></strong><span class="koboSpan" id="kobo.231.1"> attribute to publish </span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">a post:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.233.1">
[HttpPut("{id}/publish")] public async Task&lt;ActionResult&gt; PublishPost(int id)
 {
   // Omitted for brevity
 }</span></pre>
<p><span class="koboSpan" id="kobo.234.1">The </span><a id="_idIndexMarker269"/><span class="koboSpan" id="kobo.235.1">preceding </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">HttpPut</span></strong><span class="koboSpan" id="kobo.237.1"> attribute </span><a id="_idIndexMarker270"/><span class="koboSpan" id="kobo.238.1">has an </span><strong class="source-inline"><span class="koboSpan" id="kobo.239.1">{id}/publish</span></strong><span class="koboSpan" id="kobo.240.1"> route template. </span><span class="koboSpan" id="kobo.240.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">publish</span></strong><span class="koboSpan" id="kobo.242.1"> literal is used to match the </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">publish</span></strong><span class="koboSpan" id="kobo.244.1"> literal in the incoming request. </span><span class="koboSpan" id="kobo.244.2">So, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">PUT</span></strong><span class="koboSpan" id="kobo.246.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">/api/posts/1/publish</span></strong><span class="koboSpan" id="kobo.248.1"> endpoint is mapped to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">PublishPost(int id)</span></strong><span class="koboSpan" id="kobo.250.1"> action method, and the value </span><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">1</span></strong><span class="koboSpan" id="kobo.252.1"> is captured by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">{id}</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.254.1">route parameter.</span></span></p>
<p><span class="koboSpan" id="kobo.255.1">When defining a route template, please make sure there are no conflicts. </span><span class="koboSpan" id="kobo.255.2">For example, we want to add a new action method to get posts by a user ID. </span><span class="koboSpan" id="kobo.255.3">If we use the following code, it will </span><span class="No-Break"><span class="koboSpan" id="kobo.256.1">not work:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.257.1">
[HttpGet("{userId}")] // api/posts/user/1 public async Task&lt;ActionResult&lt;List&lt;Post&gt;&gt;&gt; GetPostsByUserId(int userId)</span></pre>
<p><span class="koboSpan" id="kobo.258.1">This is because we already have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">GetPost()</span></strong><span class="koboSpan" id="kobo.260.1"> action method that uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">[HttpGet("{id}")]</span></strong><span class="koboSpan" id="kobo.262.1">. </span><span class="koboSpan" id="kobo.262.2">When sending a </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">GET</span></strong><span class="koboSpan" id="kobo.264.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">/api/posts/1</span></strong><span class="koboSpan" id="kobo.266.1"> endpoint, the request matches multiple actions, so you will see a </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">500</span></strong><span class="koboSpan" id="kobo.268.1"> error </span><span class="No-Break"><span class="koboSpan" id="kobo.269.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.270.1">
Microsoft.AspNetCore.Routing.Matching.AmbiguousMatchException: The request matched multiple endpoints. </span><span class="koboSpan" id="kobo.270.2">Matches:RoutingDemo.Controllers.PostsController.GetPost (RoutingDemo)
 RoutingDemo.Controllers.PostsController.GetPostsByUserId (RoutingDemo)</span></pre>
<p><span class="koboSpan" id="kobo.271.1">To fix it, we need to specify a different template, such </span><span class="No-Break"><span class="koboSpan" id="kobo.272.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">[HttpGet("user/{userId}")]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.274.1">.</span></span></p>
<h2 id="_idParaDest-74"><a id="_idTextAnchor136"/><span class="koboSpan" id="kobo.275.1">Route constraints</span></h2>
<p><span class="koboSpan" id="kobo.276.1">In the </span><a id="_idIndexMarker271"/><span class="koboSpan" id="kobo.277.1">previous section, we introduced how to use a route parameter to </span><a id="_idIndexMarker272"/><span class="koboSpan" id="kobo.278.1">capture the value from an incoming request. </span><span class="koboSpan" id="kobo.278.2">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">[HttpGet("{id}")] </span></strong><span class="koboSpan" id="kobo.280.1">attribute can match a </span><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">GET</span></strong><span class="koboSpan" id="kobo.282.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.283.1">/api/posts/1</span></strong><span class="koboSpan" id="kobo.284.1"> endpoint. </span><span class="koboSpan" id="kobo.284.2">But what if the request is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">GET</span></strong><span class="koboSpan" id="kobo.286.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">api/posts/abc</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.289.1"> endpoint?</span></span></p>
<p><span class="koboSpan" id="kobo.290.1">As the </span><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">id</span></strong><span class="koboSpan" id="kobo.292.1"> parameter is of type </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">int</span></strong><span class="koboSpan" id="kobo.294.1">, the framework will try to convert the captured value to an </span><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">int</span></strong><span class="koboSpan" id="kobo.296.1"> value. </span><span class="koboSpan" id="kobo.296.2">If the conversion fails, the framework will return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.297.1">400 Bad Request</span></strong><span class="koboSpan" id="kobo.298.1"> response. </span><span class="koboSpan" id="kobo.298.2">So, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">GET</span></strong><span class="koboSpan" id="kobo.300.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">/api/posts/abc</span></strong><span class="koboSpan" id="kobo.302.1"> endpoint will fail and return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">400 Bad </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">Request</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.305.1"> response.</span></span></p>
<p><span class="koboSpan" id="kobo.306.1">We can add route constraints to route parameters to restrict the values of the route parameters. </span><span class="koboSpan" id="kobo.306.2">For example, we can add a route constraint to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">id</span></strong><span class="koboSpan" id="kobo.308.1"> parameter to ensure that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">id</span></strong><span class="koboSpan" id="kobo.310.1"> parameter is an integer. </span><span class="koboSpan" id="kobo.310.2">The following code shows how to add a route constraint to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">id</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.312.1"> parameter:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.313.1">
[HttpGet("{id:int}")] public async Task&lt;ActionResult&lt;Post&gt;&gt; GetPost(int id)
 {
   // Omitted for brevity
 }</span></pre>
<p><span class="koboSpan" id="kobo.314.1">Now, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">id</span></strong><span class="koboSpan" id="kobo.316.1"> parameter must be an integer. </span><span class="koboSpan" id="kobo.316.2">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">GET</span></strong><span class="koboSpan" id="kobo.318.1"> request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.319.1">/api/posts/abc</span></strong><span class="koboSpan" id="kobo.320.1"> endpoint will return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.321.1">404 Not Found</span></strong><span class="koboSpan" id="kobo.322.1"> response because the route does </span><span class="No-Break"><span class="koboSpan" id="kobo.323.1">not match.</span></span></p>
<p><span class="koboSpan" id="kobo.324.1">ASP.NET Core provides a set of built-in route constraints, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">the following:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">int</span></strong><span class="koboSpan" id="kobo.327.1">: The parameter must be an </span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">integer value.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.329.1">bool</span></strong><span class="koboSpan" id="kobo.330.1">: The parameter must be a </span><span class="No-Break"><span class="koboSpan" id="kobo.331.1">Boolean value.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.332.1">datetime</span></strong><span class="koboSpan" id="kobo.333.1">: The parameter must be a </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">DateTime value.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.335.1">decimal</span></strong><span class="koboSpan" id="kobo.336.1">: The parameter must be a </span><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">decimal</span></strong><span class="koboSpan" id="kobo.338.1"> value. </span><span class="koboSpan" id="kobo.338.2">Similarly, there are </span><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">double</span></strong><span class="koboSpan" id="kobo.340.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">float</span></strong><span class="koboSpan" id="kobo.342.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.343.1">long</span></strong><span class="koboSpan" id="kobo.344.1">, and </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">so on.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">guid</span></strong><span class="koboSpan" id="kobo.347.1">: The parameter must be a </span><span class="No-Break"><span class="koboSpan" id="kobo.348.1">GUID value.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">minlength(value)</span></strong><span class="koboSpan" id="kobo.350.1">: The parameter must be a string with a minimum length; for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">{name:minlength(6)}</span></strong><span class="koboSpan" id="kobo.352.1">, which means the </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">name</span></strong><span class="koboSpan" id="kobo.354.1"> parameter must be a string and the length of the string must be at least 6 characters. </span><span class="koboSpan" id="kobo.354.2">Similarly, there are </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">maxlength(value)</span></strong><span class="koboSpan" id="kobo.356.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">length(value)</span></strong><span class="koboSpan" id="kobo.358.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.359.1">length(min, max)</span></strong><span class="koboSpan" id="kobo.360.1">, and </span><span class="No-Break"><span class="koboSpan" id="kobo.361.1">so on.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">min(value)</span></strong><span class="koboSpan" id="kobo.363.1">: The parameter must be an integer with a minimum value; for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">{id:min(1)}</span></strong><span class="koboSpan" id="kobo.365.1">, which means the </span><strong class="source-inline"><span class="koboSpan" id="kobo.366.1">id</span></strong><span class="koboSpan" id="kobo.367.1"> parameter must be an integer and the value must be greater than or equal to 1. </span><span class="koboSpan" id="kobo.367.2">Similarly, there are </span><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">max(value)</span></strong><span class="koboSpan" id="kobo.369.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">range(min,</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.371.1">max)</span></strong><span class="koboSpan" id="kobo.372.1">, and </span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">so on.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">alpha</span></strong><span class="koboSpan" id="kobo.375.1">: The parameter must be a string with one or </span><span class="No-Break"><span class="koboSpan" id="kobo.376.1">more letters.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">regex(expression)</span></strong><span class="koboSpan" id="kobo.378.1">: The parameter must be a string that matches the </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">regular expression.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">required</span></strong><span class="koboSpan" id="kobo.381.1">: The parameter must be provided in the route; for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.382.1">{id:required}</span></strong><span class="koboSpan" id="kobo.383.1">, which means the </span><strong class="source-inline"><span class="koboSpan" id="kobo.384.1">id</span></strong><span class="koboSpan" id="kobo.385.1"> parameter must be provided in </span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">the route.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.387.1">If the value </span><a id="_idIndexMarker273"/><span class="koboSpan" id="kobo.388.1">of the route parameter does not match the </span><a id="_idIndexMarker274"/><span class="koboSpan" id="kobo.389.1">route constraint, the action method will not accept the request, and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">404 Not Found</span></strong><span class="koboSpan" id="kobo.391.1"> response will </span><span class="No-Break"><span class="koboSpan" id="kobo.392.1">be returned.</span></span></p>
<p><span class="koboSpan" id="kobo.393.1">Multiple route constraints can be applied together. </span><span class="koboSpan" id="kobo.393.2">The following code shows how to apply multiple route constraints to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">id</span></strong><span class="koboSpan" id="kobo.395.1"> parameter, which means the </span><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">id</span></strong><span class="koboSpan" id="kobo.397.1"> parameter must be an integer and the value must be greater than or equal to 1 and less than or equal </span><span class="No-Break"><span class="koboSpan" id="kobo.398.1">to 100:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.399.1">
[HttpGet("{id:int:range(1, 100)}")] public async Task&lt;ActionResult&lt;Post&gt;&gt; GetPost(int id)
 {
   // Omitted for brevity
 }</span></pre>
<p><span class="koboSpan" id="kobo.400.1">Route constraints can be used to make a route more specific. </span><span class="koboSpan" id="kobo.400.2">However, they should not be used to validate the input. </span><span class="koboSpan" id="kobo.400.3">If the input is invalid, the API should return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">400 Bad Request</span></strong><span class="koboSpan" id="kobo.402.1"> response rather than a </span><strong class="source-inline"><span class="koboSpan" id="kobo.403.1">404 Not </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.404.1">Found</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.405.1"> response.</span></span></p>
<h2 id="_idParaDest-75"><a id="_idTextAnchor137"/><span class="koboSpan" id="kobo.406.1">Binding source attributes</span></h2>
<p><span class="koboSpan" id="kobo.407.1">We can </span><a id="_idIndexMarker275"/><span class="koboSpan" id="kobo.408.1">define parameters in the action. </span><span class="koboSpan" id="kobo.408.2">See the</span><a id="_idIndexMarker276"/><span class="koboSpan" id="kobo.409.1"> following </span><span class="No-Break"><span class="koboSpan" id="kobo.410.1">action method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.411.1">
[HttpGet("{id}")] public async Task&lt;ActionResult&lt;Post&gt;&gt; GetPost(int id)</span></pre>
<p><span class="koboSpan" id="kobo.412.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">GetPost()</span></strong><span class="koboSpan" id="kobo.414.1"> method has a parameter named </span><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">id</span></strong><span class="koboSpan" id="kobo.416.1">, which matches the parameter in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.417.1">{id}</span></strong><span class="koboSpan" id="kobo.418.1"> route template. </span><span class="koboSpan" id="kobo.418.2">So, the value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.419.1">id</span></strong><span class="koboSpan" id="kobo.420.1"> will come from the route, such as 1 in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.421.1">/api/posts/1</span></strong><span class="koboSpan" id="kobo.422.1"> URL. </span><span class="koboSpan" id="kobo.422.2">This is called </span><span class="No-Break"><span class="koboSpan" id="kobo.423.1">parameter inference.</span></span></p>
<p><span class="koboSpan" id="kobo.424.1">ASP.NET Core offers the following binding </span><span class="No-Break"><span class="koboSpan" id="kobo.425.1">source attributes:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">[FromBody]</span></strong><span class="koboSpan" id="kobo.427.1">: The parameter is from the </span><span class="No-Break"><span class="koboSpan" id="kobo.428.1">request body</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">[FromForm]</span></strong><span class="koboSpan" id="kobo.430.1">: The parameter is from the form data in the </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">request body</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.432.1">[FromHeader]</span></strong><span class="koboSpan" id="kobo.433.1">: The parameter is from the </span><span class="No-Break"><span class="koboSpan" id="kobo.434.1">request header</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.435.1">[FromQuery]</span></strong><span class="koboSpan" id="kobo.436.1">: The parameter is from the query strings in </span><span class="No-Break"><span class="koboSpan" id="kobo.437.1">the request</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.438.1">[FromRoute]</span></strong><span class="koboSpan" id="kobo.439.1">: The parameter is from the </span><span class="No-Break"><span class="koboSpan" id="kobo.440.1">route path</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">[FromServices]</span></strong><span class="koboSpan" id="kobo.442.1">: The parameter is from the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.443.1">DI</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.444.1"> container</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.445.1">For example, we can define a pagination action method </span><span class="No-Break"><span class="koboSpan" id="kobo.446.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.447.1">
[HttpGet("paged")] public async Task&lt;ActionResult&lt;List&lt;Post&gt;&gt;&gt; GetPosts([FromQuery] int pageIndex, [FromQuery] int pageSize)
 {
     // Omitted for brevity
 }</span></pre>
<p><span class="koboSpan" id="kobo.448.1">The preceding code means the </span><strong class="source-inline"><span class="koboSpan" id="kobo.449.1">pageIndex</span></strong><span class="koboSpan" id="kobo.450.1"> parameter and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.451.1">pageSize</span></strong><span class="koboSpan" id="kobo.452.1"> parameter should be from query strings in the URL, such </span><span class="No-Break"><span class="koboSpan" id="kobo.453.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.454.1">/api/posts/paged?pageIndex=1&amp;pageSize=10</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.455.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.456.1">When an </span><strong class="source-inline"><span class="koboSpan" id="kobo.457.1">[ApiController]</span></strong><span class="koboSpan" id="kobo.458.1"> attribute is applied to a controller class, a set of default inference</span><a id="_idIndexMarker277"/><span class="koboSpan" id="kobo.459.1"> rules will be applied, so we do not need to explicitly add these binding </span><a id="_idIndexMarker278"/><span class="koboSpan" id="kobo.460.1">source attributes. </span><span class="koboSpan" id="kobo.460.2">For example, the following code shows a </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">POST</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.462.1">action method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.463.1">
[HttpPost] public async Task&lt;ActionResult&lt;Post&gt;&gt; CreatePost(Post post)
 {
     // Omitted for brevity
 }
The </span><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">post</span></strong><span class="koboSpan" id="kobo.465.1"> parameter is a complex type, so </span><strong class="source-inline"><span class="koboSpan" id="kobo.466.1">[FromBody]</span></strong><span class="koboSpan" id="kobo.467.1"> inferred that the post should be from the request body. </span><span class="koboSpan" id="kobo.467.2">But </span><strong class="source-inline"><span class="koboSpan" id="kobo.468.1">[FromBody]</span></strong><span class="koboSpan" id="kobo.469.1"> is not inferred for simple data types, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.470.1">int</span></strong><span class="koboSpan" id="kobo.471.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.472.1">string</span></strong><span class="koboSpan" id="kobo.473.1">, and so on. </span><span class="koboSpan" id="kobo.473.2">We will define an action method as follows:
[HttpPost("search")]
 public async Task&lt;ActionResult&lt;Post&gt;&gt; SearchPosts(string keyword)</span></pre>
<p><span class="koboSpan" id="kobo.474.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">keyword</span></strong><span class="koboSpan" id="kobo.476.1"> parameter is a simple type, so </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">[FromQuery]</span></strong><span class="koboSpan" id="kobo.478.1"> inferred that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">keyword</span></strong><span class="koboSpan" id="kobo.480.1"> parameter should be from the query strings in the URL, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">/api/posts/search?keyword=xyz</span></strong><span class="koboSpan" id="kobo.482.1">. </span><span class="koboSpan" id="kobo.482.2">If we want to force the </span><strong class="source-inline"><span class="koboSpan" id="kobo.483.1">keyword </span></strong><span class="koboSpan" id="kobo.484.1">parameter to be from the request body, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">[FromBody]</span></strong><span class="koboSpan" id="kobo.486.1"> attribute </span><span class="No-Break"><span class="koboSpan" id="kobo.487.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.488.1">
[HttpPost("search")] public async Task&lt;ActionResult&lt;Post&gt;&gt; SearchPosts([FromBody] string keyword)</span></pre>
<p><span class="koboSpan" id="kobo.489.1">Then, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.490.1">keyword</span></strong><span class="koboSpan" id="kobo.491.1"> parameter must be from the request body. </span><span class="koboSpan" id="kobo.491.2">Note that this is a bad example because we usually do not use the request body to pass a simple </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">type parameter.</span></span></p>
<p><span class="koboSpan" id="kobo.493.1">The default inference</span><a id="_idIndexMarker279"/><span class="koboSpan" id="kobo.494.1"> rules of those binding source attributes are </span><span class="No-Break"><span class="koboSpan" id="kobo.495.1">listed next:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.496.1">For complex type parameters, if the type is registered in the DI container, </span><strong class="source-inline"><span class="koboSpan" id="kobo.497.1">[FromServices]</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.498.1">is inferred.</span></span></li>
<li><span class="koboSpan" id="kobo.499.1">For complex type parameters that are not registered in the DI container, </span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">[FromBody]</span></strong><span class="koboSpan" id="kobo.501.1"> is inferred. </span><span class="koboSpan" id="kobo.501.2">It does not support multiple </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">[</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.503.1">FromBody]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.504.1"> parameters.</span></span></li>
<li><span class="koboSpan" id="kobo.505.1">For types such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">IFormFile</span></strong><span class="koboSpan" id="kobo.507.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.508.1">IFormFileCollection</span></strong><span class="koboSpan" id="kobo.509.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">[FromForm]</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.511.1">is inferred.</span></span></li>
<li><span class="koboSpan" id="kobo.512.1">For any parameters that appear in the route, </span><strong class="source-inline"><span class="koboSpan" id="kobo.513.1">[FromRoute]</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.514.1">is inferred.</span></span></li>
<li><span class="koboSpan" id="kobo.515.1">For any parameters of simple types, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.516.1">int</span></strong><span class="koboSpan" id="kobo.517.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.518.1">string</span></strong><span class="koboSpan" id="kobo.519.1">, and so on, </span><strong class="source-inline"><span class="koboSpan" id="kobo.520.1">[FromQuery]</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.521.1">is inferred.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.522.1">If a </span><a id="_idIndexMarker280"/><span class="koboSpan" id="kobo.523.1">parameter can be inferred based on these rules, the binding source attribute can be omitted. </span><span class="koboSpan" id="kobo.523.2">Otherwise, we need to explicitly specify the binding </span><span class="No-Break"><span class="koboSpan" id="kobo.524.1">source attribute.</span></span></p>
<p><span class="koboSpan" id="kobo.525.1">Routing is a very important concept in REST APIs. </span><span class="koboSpan" id="kobo.525.2">Ensure that routes are well designed, intuitive, and easy to understand. </span><span class="koboSpan" id="kobo.525.3">This will help the consumers of your REST APIs use </span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">them easily.</span></span></p>
<p><span class="koboSpan" id="kobo.527.1">Next, we will check the config</span><a id="_idTextAnchor138"/><span class="koboSpan" id="kobo.528.1">uration in </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">ASP.NET Core.</span></span></p>
<h1 id="_idParaDest-76"><a id="_idTextAnchor139"/><span class="koboSpan" id="kobo.530.1">Configuration</span></h1>
<p><span class="koboSpan" id="kobo.531.1">ASP.NET Core provides</span><a id="_idIndexMarker281"/><span class="koboSpan" id="kobo.532.1"> a comprehensive configuration framework that makes it easy to work with configuration settings. </span><span class="koboSpan" id="kobo.532.2">A configuration is considered a key-value pair. </span><span class="koboSpan" id="kobo.532.3">These configuration settings are stored in a variety of sources, such as JSON files, environment variables, and command-line arguments, or in the cloud, such as Azure Key Vault. </span><span class="koboSpan" id="kobo.532.4">In ASP.NET Core, these sources are referred to as </span><strong class="bold"><span class="koboSpan" id="kobo.533.1">configuration providers</span></strong><span class="koboSpan" id="kobo.534.1">. </span><span class="koboSpan" id="kobo.534.2">Each</span><a id="_idIndexMarker282"/><span class="koboSpan" id="kobo.535.1"> configuration provider is responsible for loading configuration settings from a </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">specific source.</span></span></p>
<p><span class="koboSpan" id="kobo.537.1">ASP.NET Core supports a set of configuration providers, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.538.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.539.1">The file configuration provider, such as, </span><strong class="source-inline"><span class="koboSpan" id="kobo.540.1">appsettings.json</span></strong> </li>
<li><span class="koboSpan" id="kobo.541.1">The User secrets </span></li>
<li><span class="koboSpan" id="kobo.542.1">The environment variables configuration provider </span></li>
<li><span class="koboSpan" id="kobo.543.1">The command-line configuration provider </span></li>
<li><span class="koboSpan" id="kobo.544.1">The Azure App Configuration provider </span></li>
<li><span class="koboSpan" id="kobo.545.1">The Azure Key Vault </span><span class="No-Break"><span class="koboSpan" id="kobo.546.1">configuration provider</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.547.1">The configuration of ASP.NET Core is provided by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.548.1">Microsoft.Extension.Configuration</span></strong><span class="koboSpan" id="kobo.549.1"> NuGet package. </span><span class="koboSpan" id="kobo.549.2">You do not need to install this package explicitly as it is already installed with the default ASP.NET Core template, which provides several built-in configuration providers, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.550.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.551.1">. </span><span class="koboSpan" id="kobo.551.2">These configuration providers are configured in priority order. </span><span class="koboSpan" id="kobo.551.3">We will discuss this in more detail in the </span><em class="italic"><span class="koboSpan" id="kobo.552.1">Understanding the priorities of configuration and environment variables</span></em><span class="koboSpan" id="kobo.553.1"> section. </span><span class="koboSpan" id="kobo.553.2">First, let us look at how to </span><span class="No-Break"><span class="koboSpan" id="kobo.554.1">use </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.555.1">appsettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.556.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.557.1">Run the following command to create a new ASP.NET Core web </span><span class="No-Break"><span class="koboSpan" id="kobo.558.1">API project:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.559.1">
dotnet new webapi -n ConfigurationDemo -controllers</span></pre> <p><span class="koboSpan" id="kobo.560.1">You can download the example project named </span><strong class="source-inline"><span class="koboSpan" id="kobo.561.1">ConfigurationDemo</span></strong><span class="koboSpan" id="kobo.562.1"> from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.563.1">/samples/chapter3/ConfigurationDemo</span></strong><span class="koboSpan" id="kobo.564.1"> folder in the chapter's </span><span class="No-Break"><span class="koboSpan" id="kobo.565.1">GitHub repository.</span></span></p>
<h2 id="_idParaDest-77"><a id="_idTextAnchor140"/><span class="koboSpan" id="kobo.566.1">Using appsettings.json</span></h2>
<p><span class="koboSpan" id="kobo.567.1">By </span><a id="_idIndexMarker283"/><span class="koboSpan" id="kobo.568.1">default, ASP.NET Core apps are configured to read configuration settings from </span><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.570.1"> using </span><strong class="source-inline"><span class="koboSpan" id="kobo.571.1">JsonConfigurationProvider</span></strong><span class="koboSpan" id="kobo.572.1">. </span><span class="koboSpan" id="kobo.572.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.574.1"> file is located in the project’s root directory, which is a JSON file that contains key-value pairs. </span><span class="koboSpan" id="kobo.574.2">The following</span><a id="_idIndexMarker284"/><span class="koboSpan" id="kobo.575.1"> code shows the default content of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.576.1">appsettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.577.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.578.1">
{  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}</span></pre>
<p><span class="koboSpan" id="kobo.579.1">You will find another </span><strong class="source-inline"><span class="koboSpan" id="kobo.580.1">appsettings.Development.json</span></strong><span class="koboSpan" id="kobo.581.1"> file, which will be used for the development environment. </span><span class="koboSpan" id="kobo.581.2">We will introduce the environment in the </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">following section.</span></span></p>
<p><span class="koboSpan" id="kobo.583.1">Let us add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">"MyKey": "MyValue"</span></strong><span class="koboSpan" id="kobo.585.1"> key-value pair to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.587.1"> file. </span><span class="koboSpan" id="kobo.587.2">This key-value pair is an example configuration that we will read in the code </span><span class="No-Break"><span class="koboSpan" id="kobo.588.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">JsonConfigurationProvider</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.590.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.591.1">
{  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "MyKey": "MyValue"
}</span></pre>
<p><span class="koboSpan" id="kobo.592.1">Create a </span><a id="_idIndexMarker285"/><span class="koboSpan" id="kobo.593.1">new controller named </span><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">ConfigurationController</span></strong><span class="koboSpan" id="kobo.595.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">Controllers</span></strong><span class="koboSpan" id="kobo.597.1"> folder. </span><span class="koboSpan" id="kobo.597.2">In this controller, we will read the configuration value from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.598.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.599.1"> file and return it as a string. </span><span class="koboSpan" id="kobo.599.2">The</span><a id="_idIndexMarker286"/><span class="koboSpan" id="kobo.600.1"> following code shows the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.601.1">ConfigurationController</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.602.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.603.1">
using Microsoft.AspNetCore.Mvc;namespace ConfigurationDemo.Controllers;
[ApiController]
[Route("[controller]")]
public class ConfigurationController(IConfiguration configuration) : ControllerBase
{
    [HttpGet]
    [Route("my-key")]
    public ActionResult GetMyKey()
    {
        var myKey = configuration["MyKey"];
        return Ok(myKey);
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.604.1">To </span><a id="_idIndexMarker287"/><span class="koboSpan" id="kobo.605.1">access the configuration settings, we need to inject the </span><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">IConfiguration</span></strong><span class="koboSpan" id="kobo.607.1"> interface into the constructor of the controller. </span><span class="koboSpan" id="kobo.607.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.608.1">IConfiguration</span></strong><span class="koboSpan" id="kobo.609.1"> interface represents a set of key/value application </span><a id="_idIndexMarker288"/><span class="koboSpan" id="kobo.610.1">configuration properties. </span><span class="koboSpan" id="kobo.610.2">The following code shows how to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">configuration settings:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.612.1">
var myKey = configuration["MyKey"];</span></pre> <p><span class="koboSpan" id="kobo.613.1">Run the application and send a request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.614.1">/Configuration/my-key</span></strong><span class="koboSpan" id="kobo.615.1"> endpoint. </span><span class="koboSpan" id="kobo.615.2">You can use any HTTP client, such as Postman, Thunder Client in VS Code, or HttpRepl. </span><span class="koboSpan" id="kobo.615.3">The following code shows how to </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">use HttpRepl:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.617.1">
httprepl http://localhost:5116cd Configuration
get my-key</span></pre>
<p><span class="koboSpan" id="kobo.618.1">You will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">following response:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.620.1">
HTTP/1.1 200 OKContent-Type: text/plain; charset=utf-8
Date: Fri, 23 Sep 2022 11:22:40 GMT
Server: Kestrel
Transfer-Encoding: chunked
MyValue</span></pre>
<p><span class="koboSpan" id="kobo.621.1">The configuration supports hierarchical settings. </span><span class="koboSpan" id="kobo.621.2">For example, consider the following </span><span class="No-Break"><span class="koboSpan" id="kobo.622.1">configuration settings:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.623.1">
{  "Database": {
    "Type": "SQL Server",
    "ConnectionString": "This is the database connection string"
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.624.1">To access </span><a id="_idIndexMarker289"/><span class="koboSpan" id="kobo.625.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.626.1">Type</span></strong><span class="koboSpan" id="kobo.627.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">ConnectionString</span></strong><span class="koboSpan" id="kobo.629.1"> properties, we </span><a id="_idIndexMarker290"/><span class="koboSpan" id="kobo.630.1">can use the </span><span class="No-Break"><span class="koboSpan" id="kobo.631.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.632.1">
[HttpGet][Route("database-configuration")]
public ActionResult GetDatabaseConfiguration()
{
    var type = configuration["Database:Type"];
    var connectionString = configuration["Database:ConnectionString"];
    return Ok(new { Type = type, ConnectionString = connectionString });
}</span></pre>
<p><span class="koboSpan" id="kobo.633.1">Note that we use a colon (</span><strong class="source-inline"><span class="koboSpan" id="kobo.634.1">:</span></strong><span class="koboSpan" id="kobo.635.1">) to separate the </span><span class="No-Break"><span class="koboSpan" id="kobo.636.1">hierarchical settings.</span></span></p>
<p><span class="koboSpan" id="kobo.637.1">Run the application and send a request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">/Configuration/database-configuration</span></strong><span class="koboSpan" id="kobo.639.1"> endpoint. </span><span class="koboSpan" id="kobo.639.2">If you use HttpRepl, you can use the </span><span class="No-Break"><span class="koboSpan" id="kobo.640.1">following command:</span></span></p>
<pre class="console">
<strong class="source-inline"><span class="koboSpan" id="kobo.641.1">httprepl http://localhost:5116</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.642.1">cd Configuration</span></strong>
<strong class="source-inline"><span class="koboSpan" id="kobo.643.1">get database-configuration</span></strong></pre>
<p><span class="koboSpan" id="kobo.644.1">The following code shows a response </span><span class="No-Break"><span class="koboSpan" id="kobo.645.1">from HttpRepl:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.646.1">
HTTP/1.1 200 OKContent-Type: application/json; charset=utf-8
Date: Fri, 23 Sep 2022 11:35:55 GMT
Server: Kestrel
Transfer-Encoding: chunked
{
  "type": "SQL Server",
  "connectionString": "This is the database connection string"
}</span></pre>
<p><span class="koboSpan" id="kobo.647.1">Using </span><a id="_idIndexMarker291"/><span class="koboSpan" id="kobo.648.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.649.1">IConfiguration</span></strong><span class="koboSpan" id="kobo.650.1"> interface, we can access the configuration settings with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.651.1">configuration[key]</span></strong><span class="koboSpan" id="kobo.652.1"> format. </span><span class="koboSpan" id="kobo.652.2">However, hardcoding the keys is not a good practice. </span><span class="koboSpan" id="kobo.652.3">To avoid hardcoding, ASP.NET Core supports the options pattern, which can </span><a id="_idIndexMarker292"/><span class="koboSpan" id="kobo.653.1">provide a strongly typed </span><a id="_idTextAnchor141"/><span class="koboSpan" id="kobo.654.1">way to access </span><span class="No-Break"><span class="koboSpan" id="kobo.655.1">hierarchical settings.</span></span></p>
<h2 id="_idParaDest-78"><a id="_idTextAnchor142"/><span class="koboSpan" id="kobo.656.1">Using the options pattern</span></h2>
<p><span class="koboSpan" id="kobo.657.1">To use </span><a id="_idIndexMarker293"/><span class="koboSpan" id="kobo.658.1">the </span><a id="_idIndexMarker294"/><span class="koboSpan" id="kobo.659.1">options pattern, we need to create a class that represents the configuration settings. </span><span class="koboSpan" id="kobo.659.2">The following code shows how to create a class </span><span class="No-Break"><span class="koboSpan" id="kobo.660.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.661.1">DatabaseOption</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.662.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.663.1">
namespace ConfigurationDemo;public class DatabaseOption
{
    public const string SectionName = "Database";
    public string Type { get; set; } = string.Empty;
    public string ConnectionString { get; set; } = string.Empty;
}</span></pre>
<p><span class="koboSpan" id="kobo.664.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.665.1">SectionName</span></strong><span class="koboSpan" id="kobo.666.1"> field is used to specify the section name in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.668.1"> file. </span><span class="koboSpan" id="kobo.668.2">This field is not mandatory. </span><span class="koboSpan" id="kobo.668.3">But if we do not define it here, we will need</span><a id="_idIndexMarker295"/><span class="koboSpan" id="kobo.669.1"> to pass a hardcoded string for the section name when we bind the configuration section. </span><span class="koboSpan" id="kobo.669.2">To better leverage the</span><a id="_idIndexMarker296"/><span class="koboSpan" id="kobo.670.1"> strong typing, we can define a </span><strong class="source-inline"><span class="koboSpan" id="kobo.671.1">SectionName</span></strong><span class="koboSpan" id="kobo.672.1"> field. </span><span class="koboSpan" id="kobo.672.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.673.1">Type</span></strong><span class="koboSpan" id="kobo.674.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.675.1">ConnectionString</span></strong><span class="koboSpan" id="kobo.676.1"> properties are used to represent the </span><strong class="source-inline"><span class="koboSpan" id="kobo.677.1">Type</span></strong><span class="koboSpan" id="kobo.678.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.679.1">ConnectionString</span></strong><span class="koboSpan" id="kobo.680.1"> fields in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">appsettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.682.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.683.1">Note that an option class must be non-abstract with a public </span><span class="No-Break"><span class="koboSpan" id="kobo.684.1">parameterless constructor.</span></span></p>
<p><span class="koboSpan" id="kobo.685.1">There are multiple ways to u</span><a id="_idTextAnchor143"/><span class="koboSpan" id="kobo.686.1">se the options pattern. </span><span class="No-Break"><span class="koboSpan" id="kobo.687.1">Let's continue.</span></span></p>
<h3><span class="koboSpan" id="kobo.688.1">Using the ConfigurationBinder.Bind() method</span></h3>
<p><span class="koboSpan" id="kobo.689.1">First, Let's </span><a id="_idIndexMarker297"/><span class="koboSpan" id="kobo.690.1">use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.691.1">ConfigurationBinder.Bind()</span></strong><span class="koboSpan" id="kobo.692.1"> method, which attempts to bind a given object instance to configuration values by recursively matching property names against </span><span class="No-Break"><span class="koboSpan" id="kobo.693.1">configuration keys.</span></span></p>
<p><span class="koboSpan" id="kobo.694.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.695.1">ConfigurationController</span></strong><span class="koboSpan" id="kobo.696.1"> class, add the </span><span class="No-Break"><span class="koboSpan" id="kobo.697.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.698.1">
[HttpGet][Route("database-configuration-with-bind")]
public ActionResult GetDatabaseConfigurationWithBind()
{
    var databaseOption = new DatabaseOption();
    // The `SectionName` is defined in the `DatabaseOption` class, which shows the section name in the `appsettings.json` file.
</span><span class="koboSpan" id="kobo.698.2">    configuration.GetSection(DatabaseOption.SectionName).Bind(databaseOption);
    // You can also use the code below to achieve the same result
    // configuration.Bind(DatabaseOption.SectionName, databaseOption);
    return Ok(new { databaseOption.Type, databaseOption.ConnectionString });
}</span></pre>
<p><span class="koboSpan" id="kobo.699.1">Run the </span><a id="_idIndexMarker298"/><span class="koboSpan" id="kobo.700.1">application and send a request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.701.1">/Configuration/database-configuration-with-bind</span></strong><span class="koboSpan" id="kobo.702.1"> endpoint. </span><span class="koboSpan" id="kobo.702.2">You will see the same response as in the previous section, </span><em class="italic"><span class="koboSpan" id="kobo.703.1">Using appsettings.json</span></em><span class="koboSpan" id="kobo.704.1">. </span><span class="koboSpan" id="kobo.704.2">In this way, we can use the strongly typed option class to access the configurat</span><a id="_idTextAnchor144"/><span class="koboSpan" id="kobo.705.1">ion settings, such </span><span class="No-Break"><span class="koboSpan" id="kobo.706.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.707.1">databaseOption.Type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.709.1">Using the ConfigurationBinder.Get&lt;TOption&gt;() method</span></h3>
<p><span class="koboSpan" id="kobo.710.1">We</span><a id="_idIndexMarker299"/><span class="koboSpan" id="kobo.711.1"> can also use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.712.1">ConfigurationBinder.Get&lt;TOption&gt;()</span></strong><span class="koboSpan" id="kobo.713.1"> method, which attempts to bind the configuration instance to a new instance of type </span><strong class="source-inline"><span class="koboSpan" id="kobo.714.1">T</span></strong><span class="koboSpan" id="kobo.715.1">. </span><span class="koboSpan" id="kobo.715.2">If this configuration section has a value, then that value will be used; otherwise, it attempts to bind the configuration instance by matching property names against configuration keys recursively. </span><span class="koboSpan" id="kobo.715.3">The code is </span><span class="No-Break"><span class="koboSpan" id="kobo.716.1">shown next:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.717.1">
[HttpGet][Route("database-configuration-with-generic-type")]
public ActionResult GetDatabaseConfigurationWithGenericType()
{
    var databaseOption = configuration.GetSection(DatabaseOption.SectionName).Get&lt;DatabaseOption&gt;();
    return Ok(new { databaseOption.Type, databaseOption.ConnectionString });
}</span></pre>
<p><span class="koboSpan" id="kobo.718.1">Run the </span><a id="_idIndexMarker300"/><span class="koboSpan" id="kobo.719.1">application and send a request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">/Configuration/database-configuration-with-generic-type</span></strong><span class="koboSpan" id="kobo.721.1"> endpoint. </span><span class="koboSpan" id="kobo.721.2">You will see the same respon</span><a id="_idTextAnchor145"/><span class="koboSpan" id="kobo.722.1">se as in the </span><em class="italic"><span class="koboSpan" id="kobo.723.1">Using </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.724.1">appsettings.json</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.725.1"> section.</span></span></p>
<h3><span class="koboSpan" id="kobo.726.1">Using the IOptions&lt;TOption&gt; interface</span></h3>
<p><span class="koboSpan" id="kobo.727.1">ASP.NET Core</span><a id="_idIndexMarker301"/><span class="koboSpan" id="kobo.728.1"> provides built-in DI support for the options pattern. </span><span class="koboSpan" id="kobo.728.2">To use DI, we need to register the </span><strong class="source-inline"><span class="koboSpan" id="kobo.729.1">DatabaseOption</span></strong><span class="koboSpan" id="kobo.730.1"> class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.731.1">Services.Configure()</span></strong><span class="koboSpan" id="kobo.732.1"> method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.733.1">Program.cs</span></strong><span class="koboSpan" id="kobo.734.1"> file. </span><span class="koboSpan" id="kobo.734.2">The following code shows how to register the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.735.1">DatabaseOption</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.736.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.737.1">
// Register the DatabaseOption class as a configuration object.// This line must be added before the `builder.Build()` method.
</span><span class="koboSpan" id="kobo.737.2">builder.Services.Configure&lt;DatabaseOption&gt;(builder.Configuration.GetSection(DatabaseOption.SectionName));
var app = builder.Build();</span></pre>
<p><span class="koboSpan" id="kobo.738.1">Next, we can use DI to inject the </span><strong class="source-inline"><span class="koboSpan" id="kobo.739.1">IOptions&lt;DatabaseOption&gt;</span></strong><span class="koboSpan" id="kobo.740.1"> interface into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.741.1">ConfigurationController</span></strong><span class="koboSpan" id="kobo.742.1"> class. </span><span class="koboSpan" id="kobo.742.2">The following code shows how to inject the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.743.1">IOptions&lt;DatabaseOption&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.744.1"> interface:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.745.1">
[HttpGet][Route("database-configuration-with-ioptions")]
public ActionResult GetDatabaseConfigurationWithIOptions([FromServices] IOptions&lt;DatabaseOption&gt; options)
{
    var databaseOption = options.Value;
    return Ok(new { databaseOption.Type, databaseOption.ConnectionString });
}</span></pre>
<p><span class="koboSpan" id="kobo.746.1">Run the </span><a id="_idIndexMarker302"/><span class="koboSpan" id="kobo.747.1">application and send a request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.748.1">/Configuration/database-configuration-with-ioptions</span></strong><span class="koboSpan" id="kobo.749.1"> endpoint. </span><span class="koboSpan" id="kobo.749.2">You will see the same resp</span><a id="_idTextAnchor146"/><span class="koboSpan" id="kobo.750.1">onse as in the </span><em class="italic"><span class="koboSpan" id="kobo.751.1">Using </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.752.1">appsettings.json</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.753.1"> section.</span></span></p>
<h3><span class="koboSpan" id="kobo.754.1">Using other options interfaces</span></h3>
<p><span class="koboSpan" id="kobo.755.1">We have</span><a id="_idIndexMarker303"/><span class="koboSpan" id="kobo.756.1"> introduced several ways to use the options pattern. </span><span class="koboSpan" id="kobo.756.2">What differences do </span><span class="No-Break"><span class="koboSpan" id="kobo.757.1">they have?</span></span></p>
<p><span class="koboSpan" id="kobo.758.1">Run the application and test the preceding endpoints. </span><span class="koboSpan" id="kobo.758.2">You will see all responses are the same, which contains a </span><strong class="source-inline"><span class="koboSpan" id="kobo.759.1">Type</span></strong><span class="koboSpan" id="kobo.760.1"> property with the value </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.761.1">SQL Server</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.762.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.763.1">Keep the application running. </span><span class="koboSpan" id="kobo.763.2">Let's make a change to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.765.1"> file. </span><span class="koboSpan" id="kobo.765.2">Change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">Type</span></strong><span class="koboSpan" id="kobo.767.1"> property from </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">SQL Server</span></strong><span class="koboSpan" id="kobo.769.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">MySQL</span></strong><span class="koboSpan" id="kobo.771.1">. </span><span class="koboSpan" id="kobo.771.2">Save the file and send the requests to these endpoints again. </span><span class="koboSpan" id="kobo.771.3">You will find the </span><span class="No-Break"><span class="koboSpan" id="kobo.772.1">following results:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.773.1">database-configuration</span></strong><span class="koboSpan" id="kobo.774.1"> returns the </span><em class="italic"><span class="koboSpan" id="kobo.775.1">new</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.776.1">value </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">MySQL</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.778.1">database-configuration-with-bind</span></strong><span class="koboSpan" id="kobo.779.1"> returns the </span><em class="italic"><span class="koboSpan" id="kobo.780.1">new</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.781.1">value </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.782.1">MySQL</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">database-configuration-with-generic-type</span></strong><span class="koboSpan" id="kobo.784.1"> returns the </span><em class="italic"><span class="koboSpan" id="kobo.785.1">new</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.786.1">value </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.787.1">MySQL</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.788.1">database-configuration-with-ioptions</span></strong><span class="koboSpan" id="kobo.789.1"> returns the </span><em class="italic"><span class="koboSpan" id="kobo.790.1">old</span></em><span class="koboSpan" id="kobo.791.1"> value </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.792.1">SQL Server</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.793.1">Let's try to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.794.1">IOptionsSnapshot&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.795.1"> interface to replace the </span><strong class="source-inline"><span class="koboSpan" id="kobo.796.1">IOptions&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.797.1"> interface. </span><span class="koboSpan" id="kobo.797.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.798.1">IOptionsSnapshot&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.799.1"> interface provides a snapshot of options for the current request. </span><span class="koboSpan" id="kobo.799.2">The following code shows how to use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.800.1">IOptionsSnapshot&lt;TOption&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.801.1"> interface:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.802.1">
[HttpGet][Route("database-configuration-with-ioptions-snapshot")]
public ActionResult GetDatabaseConfigurationWithIOptionsSnapshot([FromServices] IOptionsSnapshot&lt;DatabaseOption&gt; options)
{
    var databaseOption = options.Value;
    return Ok(new { databaseOption.Type, databaseOption.ConnectionString });
}</span></pre>
<p><span class="koboSpan" id="kobo.803.1">Run the </span><a id="_idIndexMarker304"/><span class="koboSpan" id="kobo.804.1">application again. </span><span class="koboSpan" id="kobo.804.2">Change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.805.1">Type</span></strong><span class="koboSpan" id="kobo.806.1"> property in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.807.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.808.1"> file. </span><span class="koboSpan" id="kobo.808.2">Send requests to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.809.1">/Configuration/database-configuration-with-ioptions-snapshot</span></strong><span class="koboSpan" id="kobo.810.1"> endpoint. </span><span class="koboSpan" id="kobo.810.2">You will find the response is the </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.811.1">new</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.812.1"> value.</span></span></p>
<p><span class="koboSpan" id="kobo.813.1">Okay, we now know the difference between the </span><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">IOptions&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.815.1"> interface and the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.816.1">IOptionsSnapshot&lt;TOption&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.817.1"> interface:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.818.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.819.1">IOptions&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.820.1"> interface provides a way to access options, but it cannot get the latest value if the setting value has been changed when the application </span><span class="No-Break"><span class="koboSpan" id="kobo.821.1">is running.</span></span></li>
<li><span class="koboSpan" id="kobo.822.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.823.1">IOptionsSnapshot&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.824.1"> interface provides a snapshot of options for the current request. </span><span class="koboSpan" id="kobo.824.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.825.1">IOptionsSnapshot&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.826.1"> interface is useful when we want to get the latest options for the </span><span class="No-Break"><span class="koboSpan" id="kobo.827.1">current request.</span></span></li>
</ul>
<p><span class="No-Break"><span class="koboSpan" id="kobo.828.1">But why?</span></span></p>
<p><span class="koboSpan" id="kobo.829.1">The ASP.NET Core framework provides built-in support for </span><strong class="source-inline"><span class="koboSpan" id="kobo.830.1">appsetting.json</span></strong><span class="koboSpan" id="kobo.831.1"> using </span><strong class="source-inline"><span class="koboSpan" id="kobo.832.1">JsonConfigurationProvider</span></strong><span class="koboSpan" id="kobo.833.1">, which reads the configuration values from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.834.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.835.1"> file. </span><span class="koboSpan" id="kobo.835.2">When the framework registers </span><strong class="source-inline"><span class="koboSpan" id="kobo.836.1">JsonConfigurationProvider</span></strong><span class="koboSpan" id="kobo.837.1">, the code looks </span><span class="No-Break"><span class="koboSpan" id="kobo.838.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.839.1">
config.AddJsonFile("appsettings.json", optional: true, reloadOnChange: true)  .AddJsonFile($"appsettings.{env.EnvironmentName}.json", optional: true, reloadOnChange: true);</span></pre>
<p><span class="koboSpan" id="kobo.840.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.841.1">reloadOnChange</span></strong><span class="koboSpan" id="kobo.842.1"> parameter is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.843.1">true</span></strong><span class="koboSpan" id="kobo.844.1">, which means the configuration values will be reloaded if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.845.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.846.1"> file has been changed. </span><span class="koboSpan" id="kobo.846.2">So, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.847.1">ConfigurationBinder.Bind()</span></strong><span class="koboSpan" id="kobo.848.1"> method and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.849.1">ConfigurationBinder.Get&lt;TOption&gt;()</span></strong><span class="koboSpan" id="kobo.850.1"> method can get the </span><span class="No-Break"><span class="koboSpan" id="kobo.851.1">latest value.</span></span></p>
<p><span class="koboSpan" id="kobo.852.1">However, when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.853.1">IOptions&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.854.1"> interface is registered by the ASP.NET Core framework, it is registered as a </span><em class="italic"><span class="koboSpan" id="kobo.855.1">singleton</span></em><span class="koboSpan" id="kobo.856.1"> service, which means an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.857.1">IOption&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.858.1"> will be created only once. </span><span class="koboSpan" id="kobo.858.2">You can inject it into any service lifetime, but it cannot read the latest value if the setting value has </span><span class="No-Break"><span class="koboSpan" id="kobo.859.1">been changed.</span></span></p>
<p><span class="koboSpan" id="kobo.860.1">In contrast, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.861.1">IOptionsSnapshot&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.862.1"> interface is registered as a </span><em class="italic"><span class="koboSpan" id="kobo.863.1">scoped</span></em><span class="koboSpan" id="kobo.864.1"> service, so</span><a id="_idIndexMarker305"/><span class="koboSpan" id="kobo.865.1"> it cannot be injected into a singleton service. </span><span class="koboSpan" id="kobo.865.2">It is useful in scenarios if you want to get the latest options for </span><span class="No-Break"><span class="koboSpan" id="kobo.866.1">each request.</span></span></p>
<p><span class="koboSpan" id="kobo.867.1">It looks like </span><strong class="source-inline"><span class="koboSpan" id="kobo.868.1">IOptionsSnapshot&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.869.1"> is better than </span><strong class="source-inline"><span class="koboSpan" id="kobo.870.1">IOptions&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.871.1">. </span><span class="koboSpan" id="kobo.871.2">Not really. </span><strong class="source-inline"><span class="koboSpan" id="kobo.872.1">IOptionsSnapshot&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.873.1"> can only cache options for the current request. </span><span class="koboSpan" id="kobo.873.2">It may cause performance issues because it is recomputed per request. </span><span class="koboSpan" id="kobo.873.3">So, you need to choose the interface to use wisely. </span><span class="koboSpan" id="kobo.873.4">If the options are not changed, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.874.1">IOptions&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.875.1"> interface. </span><span class="koboSpan" id="kobo.875.2">If the options are changed frequently and you want to ensure the app gets the latest value per request, you can use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.876.1">IOptionsSnapshot&lt;TOption&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.877.1"> interface.</span></span></p>
<p><span class="koboSpan" id="kobo.878.1">There is another options interface called </span><strong class="source-inline"><span class="koboSpan" id="kobo.879.1">IOptionsMonitor&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.880.1">. </span><span class="koboSpan" id="kobo.880.2">It is a combination of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.881.1">IOptions&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.882.1"> and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.883.1">IOptionsSnapshot&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.884.1"> interfaces. </span><span class="koboSpan" id="kobo.884.2">It provides the </span><span class="No-Break"><span class="koboSpan" id="kobo.885.1">following features:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.886.1">It is a singleton service, which can be injected into any </span><span class="No-Break"><span class="koboSpan" id="kobo.887.1">service lifetime</span></span></li>
<li><span class="koboSpan" id="kobo.888.1">It supports </span><span class="No-Break"><span class="koboSpan" id="kobo.889.1">reloadable configuration</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.890.1">Here is an example of using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.891.1">IOptionsMonitor&lt;TOption&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.892.1"> interface:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.893.1">
[HttpGet][Route("database-configuration-with-ioptions-monitor")]
public ActionResult GetDatabaseConfigurationWithIOptionsMonitor([FromServices] IOptionsMonitor&lt;DatabaseOption&gt; options)
{
    var databaseOption = options.CurrentValue;
    return Ok(new { databaseOption.Type, databaseOption.ConnectionString });
}</span></pre>
<p><span class="koboSpan" id="kobo.894.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.895.1">IOptionsMonitor&lt;TOption&gt;</span></strong><span class="koboSpan" id="kobo.896.1"> interface provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.897.1">CurrentValue</span></strong><span class="koboSpan" id="kobo.898.1"> property to get the latest value. </span><span class="koboSpan" id="kobo.898.2">It also provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.899.1">OnChange(Action&lt;TOption, string&gt; listener)</span></strong><span class="koboSpan" id="kobo.900.1"> method to register a listener </span><a id="_idIndexMarker306"/><span class="koboSpan" id="kobo.901.1">that will be called whenever the options are reloaded. </span><span class="koboSpan" id="kobo.901.2">Normally, you do not need to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.902.1">OnChange()</span></strong><span class="koboSpan" id="kobo.903.1"> method unless you w</span><a id="_idTextAnchor147"/><span class="koboSpan" id="kobo.904.1">ant to do something when the options </span><span class="No-Break"><span class="koboSpan" id="kobo.905.1">are reloaded.</span></span></p>
<h3><span class="koboSpan" id="kobo.906.1">Using named options</span></h3>
<p><span class="koboSpan" id="kobo.907.1">Sometimes, we</span><a id="_idIndexMarker307"/><span class="koboSpan" id="kobo.908.1"> need to use multiple database instances in our application. </span><span class="koboSpan" id="kobo.908.2">Consider the </span><span class="No-Break"><span class="koboSpan" id="kobo.909.1">following scenario:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.910.1">
{  "Databases": {
    "System": {
      "Type": "SQL Server",
      "ConnectionString": "This is the database connection string for the system database."
</span><span class="koboSpan" id="kobo.910.2">    },
    "Business": {
      "Type": "MySQL",
      "ConnectionString": "This is the database connection string for the business database."
</span><span class="koboSpan" id="kobo.910.3">    }
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.911.1">Rather than creating two classes to represent the two database options, we can use the named options feature. </span><span class="koboSpan" id="kobo.911.2">The following code shows how to use the named options feature for</span><a id="_idIndexMarker308"/> <span class="No-Break"><span class="koboSpan" id="kobo.912.1">each section:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.913.1">
public class DatabaseOptions{
    public const string SystemDatabaseSectionName = "System";
    public const string BusinessDatabaseSectionName = "Business";
    public string Type { get; set; } = string.Empty;
    public string ConnectionString { get; set; } = string.Empty;
}</span></pre>
<p><span class="koboSpan" id="kobo.914.1">Then, register the named options feature in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.915.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.916.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.917.1">
builder.Services.Configure&lt;DatabaseOptions&gt;(DatabaseOptions.SystemDatabaseSectionName, builder.Configuration.GetSection($"{DatabaseOptions.SectionName}:{DatabaseOptions.SystemDatabaseSectionName}"));builder.Services.Configure&lt;DatabaseOptions&gt;(DatabaseOptions.BusinessDatabaseSectionName, builder.Configuration.GetSection($"{DatabaseOptions.SectionName}:{DatabaseOptions.BusinessDatabaseSectionName}"));</span></pre>
<p><span class="koboSpan" id="kobo.918.1">The following code shows how to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.919.1">named options:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.920.1">
[HttpGet][Route("database-configuration-with-named-options")]
public ActionResult GetDatabaseConfigurationWithNamedOptions([FromServices] IOptionsSnapshot&lt;DatabaseOptions&gt; options)
{
    var systemDatabaseOption = options.Get(DatabaseOptions.SystemDatabaseSectionName);
    var businessDatabaseOption = options.Get(DatabaseOptions.BusinessDatabaseSectionName);
    return Ok(new { SystemDatabaseOption = systemDatabaseOption, BusinessDatabaseOption = businessDatabaseOption });
}</span></pre>
<p><span class="koboSpan" id="kobo.921.1">Run the</span><a id="_idIndexMarker309"/><span class="koboSpan" id="kobo.922.1"> application and send a request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.923.1">/Configuration/database-configuration-with-named-options</span></strong><span class="koboSpan" id="kobo.924.1"> endpoint. </span><span class="koboSpan" id="kobo.924.2">You will find the response contains the two database options, as </span><span class="No-Break"><span class="koboSpan" id="kobo.925.1">shown next:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.926.1">
{  "systemDatabaseOption": {
    "type": "SQL Server",
    "connectionString": "This is the database connection string for the system database."
</span><span class="koboSpan" id="kobo.926.2">  },
  "businessDatabaseOption": {
    "type": "MySQL",
    "connectionString": "This is the database connection string for the business database."
</span><span class="koboSpan" id="kobo.926.3">  }
}</span></pre>
<p><span class="koboSpan" id="kobo.927.1">Now, Let's summarize the options feature in </span><span class="No-Break"><span class="koboSpan" id="kobo.928.1">ASP.NET Core:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-3">
<colgroup>
<col/>
<col/>
<col/>
<col/>
</colgroup>
<thead>
<tr class="No-Table-Style">
<td class="No-Table-Style"/>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.929.1">Server lifetime</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold"><span class="koboSpan" id="kobo.930.1">Reloadable </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.931.1">configuration</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.932.1">Named options</span></strong></span></p>
</td>
</tr>
</thead>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.933.1">IOptions&lt;TOption&gt;</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.934.1">Singleton</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.935.1">No</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.936.1">No</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.937.1">IOptionsSnapshot&lt;TOption&gt;</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.938.1">Scope</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.939.1">Yes</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.940.1">Yes</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.941.1">IOptionsMonitor&lt;TOption&gt;</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.942.1">Singleton</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.943.1">Yes</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.944.1">Yes</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.945.1">Table 3.1 – Summary of the options feature in </span><strong class="source-inline"><span class="koboSpan" id="kobo.946.1">ASP.NET</span></strong><span class="koboSpan" id="kobo.947.1"> Core</span></p>
<p><span class="koboSpan" id="kobo.948.1">Next, we will discuss how to register a group of options to make the </span><strong class="source-inline"><span class="koboSpan" id="kobo.949.1">Program.cs</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.950.1">file cleaner.</span></span></p>
<h3><a id="_idTextAnchor148"/><span class="koboSpan" id="kobo.951.1">Group options registration</span></h3>
<p><span class="koboSpan" id="kobo.952.1">In </span><a href="B18971_02.xhtml#_idTextAnchor068"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.953.1">Chapter 2</span></em></span></a><span class="koboSpan" id="kobo.954.1">, we introduced how to use group registration to register multiple services in an extension method. </span><span class="koboSpan" id="kobo.954.2">The group</span><a id="_idIndexMarker310"/><span class="koboSpan" id="kobo.955.1"> registration feature is also available for the options feature. </span><span class="koboSpan" id="kobo.955.2">The following code shows how to use the group registration feature to register </span><span class="No-Break"><span class="koboSpan" id="kobo.956.1">multiple options:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.957.1">
using ConfigurationDemo;namespace DependencyInjectionDemo;
public static class OptionsCollectionExtensions
{
    public static IServiceCollection AddConfig(this IServiceCollection services, IConfiguration configuration)
    {
        services.Configure&lt;DatabaseOption&gt;(configuration.GetSection(DatabaseOption.SectionName));
        services.Configure&lt;DatabaseOptions&gt;(DatabaseOptions.SystemDatabaseSectionName, configuration.GetSection($"{DatabaseOptions.SectionName}:{DatabaseOptions.SystemDatabaseSectionName}"));
        services.Configure&lt;DatabaseOptions&gt;(DatabaseOptions.BusinessDatabaseSectionName, configuration.GetSection($"{DatabaseOptions.SectionName}:{DatabaseOptions.BusinessDatabaseSectionName}"));
        return services;
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.958.1">Then, register</span><a id="_idIndexMarker311"/><span class="koboSpan" id="kobo.959.1"> the options in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.960.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.961.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.962.1">
builder.Services.AddConfig(builder.Configuration);</span></pre> <p><span class="koboSpan" id="kobo.963.1">Now, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.964.1">Program.cs</span></strong><span class="koboSpan" id="kobo.965.1"> file is </span><span class="No-Break"><span class="koboSpan" id="kobo.966.1">much cleaner</span><a id="_idTextAnchor149"/><span class="koboSpan" id="kobo.967.1">.</span></span></p>
<h2 id="_idParaDest-79"><a id="_idTextAnchor150"/><span class="koboSpan" id="kobo.968.1">Other configuration providers</span></h2>
<p><span class="koboSpan" id="kobo.969.1">We mentioned</span><a id="_idIndexMarker312"/><span class="koboSpan" id="kobo.970.1"> that ASP.NET Core supports multiple configuration providers. </span><span class="koboSpan" id="kobo.970.2">The configuration provider for reading the </span><strong class="source-inline"><span class="koboSpan" id="kobo.971.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.972.1"> file is </span><strong class="source-inline"><span class="koboSpan" id="kobo.973.1">JsonConfigurationProvider</span></strong><span class="koboSpan" id="kobo.974.1">, which is derived from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.975.1">FileConfigurationProvider</span></strong><span class="koboSpan" id="kobo.976.1"> base class. </span><span class="koboSpan" id="kobo.976.2">There are some other implementations of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.977.1">FileConfigurationProvider</span></strong><span class="koboSpan" id="kobo.978.1"> base class, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.979.1">IniConfigurationProvider</span></strong><span class="koboSpan" id="kobo.980.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.981.1">XmlConfigurationProvider</span></strong><span class="koboSpan" id="kobo.982.1">, and </span><span class="No-Break"><span class="koboSpan" id="kobo.983.1">so on.</span></span></p>
<p><span class="koboSpan" id="kobo.984.1">Besides </span><strong class="source-inline"><span class="koboSpan" id="kobo.985.1">JsonConfigurationProvider</span></strong><span class="koboSpan" id="kobo.986.1">, the ASP.NET Core framework automatically registers the following </span><span class="No-Break"><span class="koboSpan" id="kobo.987.1">configuration providers:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.988.1">A </span><strong class="bold"><span class="koboSpan" id="kobo.989.1">user secrets configuration provider</span></strong><span class="koboSpan" id="kobo.990.1"> is used to read secrets from the local secrets file when the app runs in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.991.1">Development</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.992.1"> environment</span></span></li>
<li><span class="koboSpan" id="kobo.993.1">A </span><strong class="bold"><span class="koboSpan" id="kobo.994.1">non-prefixed environment variables configuration provider</span></strong><span class="koboSpan" id="kobo.995.1"> is used to read environment variables that do not have </span><span class="No-Break"><span class="koboSpan" id="kobo.996.1">a prefix</span></span></li>
<li><span class="koboSpan" id="kobo.997.1">A </span><strong class="bold"><span class="koboSpan" id="kobo.998.1">command-line configuration provider</span></strong><span class="koboSpan" id="kobo.999.1"> is used to read </span><span class="No-Break"><span class="koboSpan" id="kobo.1000.1">command-line arguments</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1001.1">Let us see more details about these </span><span class="No-Break"><span class="koboSpan" id="kobo.1002.1">configuration provider</span><a id="_idTextAnchor151"/><span class="koboSpan" id="kobo.1003.1">s.</span></span></p>
<h3><span class="koboSpan" id="kobo.1004.1">User secrets configuration provider</span></h3>
<p><span class="koboSpan" id="kobo.1005.1">It is </span><a id="_idIndexMarker313"/><span class="koboSpan" id="kobo.1006.1">not a </span><a id="_idIndexMarker314"/><span class="koboSpan" id="kobo.1007.1">good practice to store sensitive information in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1008.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1009.1"> file. </span><span class="koboSpan" id="kobo.1009.2">For example, if the database connection string is stored in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1010.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1011.1"> file, developers may accidentally commit the database connection string (or other sensitive information, secrets, and so on) to the source control system, which will cause </span><span class="No-Break"><span class="koboSpan" id="kobo.1012.1">security issues.</span></span></p>
<p><span class="koboSpan" id="kobo.1013.1">Instead, we</span><a id="_idIndexMarker315"/><span class="koboSpan" id="kobo.1014.1"> can use the </span><a id="_idIndexMarker316"/><span class="koboSpan" id="kobo.1015.1">user secrets feature to store sensitive information in the local secrets file. </span><span class="koboSpan" id="kobo.1015.2">The user secrets feature is only available in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1016.1">Development</span></strong><span class="koboSpan" id="kobo.1017.1"> environment. </span><span class="koboSpan" id="kobo.1017.2">By default, the ASP.NET Core framework registers the user secrets configuration provider after the JSON configuration provider. </span><span class="koboSpan" id="kobo.1017.3">Therefore, the user secrets configuration provider has higher priority than the JSON configuration provider, so it will override the JSON configuration provider if the same configuration key exists in </span><span class="No-Break"><span class="koboSpan" id="kobo.1018.1">both providers.</span></span></p>
<p><span class="koboSpan" id="kobo.1019.1">To use user secrets, we need to use the Secret Manager tool to store the secrets in a local secrets file. </span><span class="koboSpan" id="kobo.1019.2">Run the following command in the project folder to initialize a local </span><span class="No-Break"><span class="koboSpan" id="kobo.1020.1">secrets file:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1021.1">
dotnet user-secrets init</span></pre> <p><span class="koboSpan" id="kobo.1022.1">The preceding command creates a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1023.1">UserSecretsId</span></strong><span class="koboSpan" id="kobo.1024.1"> property in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1025.1">.csproj</span></strong><span class="koboSpan" id="kobo.1026.1"> file. </span><span class="koboSpan" id="kobo.1026.2">By default, the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1027.1">UserSecretsId</span></strong><span class="koboSpan" id="kobo.1028.1"> property is a GUID, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.1029.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1030.1">
&lt;PropertyGroup&gt;  &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
  &lt;Nullable&gt;enable&lt;/Nullable&gt;
  &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
  &lt;UserSecretsId&gt;f3351c6a-2508-4243-8d80-89c27758164d&lt;/UserSecretsId&gt;
&lt;/PropertyGroup&gt;</span></pre>
<p><span class="koboSpan" id="kobo.1031.1">Then, we can use the Secret Manager tool to store secrets in the local secrets file. </span><span class="koboSpan" id="kobo.1031.2">Run the following command from the project folder to </span><span class="No-Break"><span class="koboSpan" id="kobo.1032.1">store secrets:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1033.1">
dotnet user-secrets set "Database:Type" "PostgreSQL"dotnet user-secrets set "Database:ConnectionString" "This is the database connection string from user secrets"</span></pre>
<p><span class="koboSpan" id="kobo.1034.1">After running the preceding commands, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1035.1">secrets.json</span></strong><span class="koboSpan" id="kobo.1036.1"> file is created in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1037.1">%APPDATA%\Microsoft\UserSecrets\&lt;UserSecretsId&gt;</span></strong><span class="koboSpan" id="kobo.1038.1"> folder. </span><span class="koboSpan" id="kobo.1038.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1039.1">secrets.json</span></strong><span class="koboSpan" id="kobo.1040.1"> file contains the </span><span class="No-Break"><span class="koboSpan" id="kobo.1041.1">following content:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1042.1">
{  "Database:Type": "PostgreSQL",
  "Database:ConnectionString": "This is the database connection string from user secrets"
}</span></pre>
<p><span class="koboSpan" id="kobo.1043.1">Note that the JSON structure </span><span class="No-Break"><span class="koboSpan" id="kobo.1044.1">is flattened.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1045.1">Location of the secrets.json file</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1046.1">If you use Linux or macOS, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1047.1">secrets.json</span></strong><span class="koboSpan" id="kobo.1048.1"> file is created in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1049.1">~/.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1050.1">microsoft/usersecrets/&lt;UserSecretsId&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1051.1"> folder.</span></span></p>
<p><span class="koboSpan" id="kobo.1052.1">Run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1053.1">dotnet run</span></strong><span class="koboSpan" id="kobo.1054.1"> to run the application and send a request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1055.1">/Configuration/database-configuration</span></strong><span class="koboSpan" id="kobo.1056.1"> endpoint. </span><span class="koboSpan" id="kobo.1056.2">You will find the response contains the database options from the user secrets, which overrides the database options from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1057.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1058.1"> file and contains a PostgreSQL </span><span class="No-Break"><span class="koboSpan" id="kobo.1059.1">database type.</span></span></p>
<p><span class="koboSpan" id="kobo.1060.1">The</span><a id="_idIndexMarker317"/><span class="koboSpan" id="kobo.1061.1"> local secrets file is out </span><a id="_idIndexMarker318"/><span class="koboSpan" id="kobo.1062.1">of the project folder and not committed to the source control system. </span><span class="koboSpan" id="kobo.1062.2">Keep in mind that the Secret Manager tool is only for development purposes. </span><span class="koboSpan" id="kobo.1062.3">Developers should have the responsibility to protect the local </span><span class="No-Break"><span class="koboSpan" id="kobo.1063.1">secrets file.</span></span></p>
<p><span class="koboSpan" id="kobo.1064.1">There are some commands to operate the local secrets file. </span><span class="koboSpan" id="kobo.1064.2">You need to run the following commands from the </span><span class="No-Break"><span class="koboSpan" id="kobo.1065.1">project folder:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1066.1">
# List all the secretsdotnet user-secrets list
# Remove a secret
dotnet user-secrets remove "Database:Type"
# Clear all the secrets
dotnet user-secrets clear</span></pre>
<p class="callout-heading"><span class="koboSpan" id="kobo.1067.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1068.1">If you download the code example for this section, the secrets file is not included in the repository. </span><span class="koboSpan" id="kobo.1068.2">You need to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1069.1">dotnet user-secrets init</span></strong><span class="koboSpan" id="kobo.1070.1"> command to initialize the secrets file on your </span><span class="No-Break"><span class="koboSpan" id="kobo.1071.1">local </span><a id="_idTextAnchor152"/><span class="koboSpan" id="kobo.1072.1">machine.</span></span></p>
<h3><span class="koboSpan" id="kobo.1073.1">Environment variables configuration provider</span></h3>
<p><span class="koboSpan" id="kobo.1074.1">.NET and ASP.NET Core define</span><a id="_idIndexMarker319"/><span class="koboSpan" id="kobo.1075.1"> some environment variables that can be used to configure the application. </span><span class="koboSpan" id="kobo.1075.2">These</span><a id="_idIndexMarker320"/><span class="koboSpan" id="kobo.1076.1"> specific variables have a prefix of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1077.1">DOTNET_</span></strong><span class="koboSpan" id="kobo.1078.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1079.1">DOTNETCORE_</span></strong><span class="koboSpan" id="kobo.1080.1">, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1081.1">ASPNETCORE_</span></strong><span class="koboSpan" id="kobo.1082.1">. </span><span class="koboSpan" id="kobo.1082.2">Variables that have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1083.1">DOTNET_</span></strong><span class="koboSpan" id="kobo.1084.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1085.1">DOTNETCORE_</span></strong><span class="koboSpan" id="kobo.1086.1"> prefix are used to configure the .NET runtime. </span><span class="koboSpan" id="kobo.1086.2">Variables that have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1087.1">ASPNETCORE_</span></strong><span class="koboSpan" id="kobo.1088.1"> prefix are used to configure ASP.NET Core. </span><span class="koboSpan" id="kobo.1088.2">For example, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1089.1">ASPNETCORE_ENVIRONMENT</span></strong><span class="koboSpan" id="kobo.1090.1"> variable is used to set the environment name. </span><span class="koboSpan" id="kobo.1090.2">We will discuss the environment in the </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1091.1">Environments</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1092.1"> section.</span></span></p>
<p><span class="koboSpan" id="kobo.1093.1">For those environment variables that do not have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1094.1">ASPNETCORE_</span></strong><span class="koboSpan" id="kobo.1095.1"> prefix, ASP.NET Core can also use the environment variables configuration provider to read them. </span><span class="koboSpan" id="kobo.1095.2">Environment variables have a higher priority than the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1096.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1097.1"> file. </span><span class="koboSpan" id="kobo.1097.2">For example, we have the following configuration in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1098.1">appsettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1099.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1100.1">
{  "Database": {
    "Type": "SQL Server",
    "ConnectionString": "This is the database connection string."
</span><span class="koboSpan" id="kobo.1100.2">  }
}</span></pre>
<p><span class="koboSpan" id="kobo.1101.1">If we set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1102.1">Database__Type</span></strong><span class="koboSpan" id="kobo.1103.1"> environment variable to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1104.1">MySQL</span></strong><span class="koboSpan" id="kobo.1105.1">, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1106.1">Database__Type</span></strong><span class="koboSpan" id="kobo.1107.1"> value in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1108.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1109.1"> file will be overridden by the environment variable value. </span><span class="koboSpan" id="kobo.1109.2">The following code shows how to access an environment variable </span><span class="No-Break"><span class="koboSpan" id="kobo.1110.1">in PowerShell:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1111.1">
$Env:&lt;variable-name&gt;</span></pre> <p><span class="koboSpan" id="kobo.1112.1">To </span><a id="_idIndexMarker321"/><span class="koboSpan" id="kobo.1113.1">represent</span><a id="_idIndexMarker322"/><span class="koboSpan" id="kobo.1114.1"> the hierarchical keys of environment variables, it is recommended to use  </span><strong class="source-inline"><span class="koboSpan" id="kobo.1115.1">__</span></strong><span class="koboSpan" id="kobo.1116.1"> (double underscore) as a separator because it is supported by all platforms. </span><span class="koboSpan" id="kobo.1116.2">Please do not use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1117.1">:</span></strong><span class="koboSpan" id="kobo.1118.1"> because it is not supported </span><span class="No-Break"><span class="koboSpan" id="kobo.1119.1">by Bash.</span></span></p>
<p><span class="koboSpan" id="kobo.1120.1">You can use the following command to set an environment variable </span><span class="No-Break"><span class="koboSpan" id="kobo.1121.1">in PowerShell:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1122.1">
$Env:Database__Type="SQLite"</span></pre> <p><span class="koboSpan" id="kobo.1123.1">To check if the environment variable is set correctly, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1124.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1125.1">
$Env:Database__Type</span></pre> <p class="callout-heading"><span class="koboSpan" id="kobo.1126.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1127.1">If you use Bash, you need to use the following command to set the </span><span class="No-Break"><span class="koboSpan" id="kobo.1128.1">environment variable:</span></span></p>
<p class="callout"><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1129.1">export Database__Type="SQLite"</span></strong></span></p>
<p class="callout"><span class="koboSpan" id="kobo.1130.1">For more information, please refer </span><span class="No-Break"><span class="koboSpan" id="kobo.1131.1">to </span></span><a href="https://linuxize.com/post/how-to-set-and-list-environment-variables-in-linux/"><span class="No-Break"><span class="koboSpan" id="kobo.1132.1">https://linuxize.com/post/how-to-set-and-list-environment-variables-in-linux/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1133.1">.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.1134.1">Also, please note that, unlike in Windows, environment variable names are case-sensitive on macOS </span><span class="No-Break"><span class="koboSpan" id="kobo.1135.1">and Linux.</span></span></p>
<p><span class="koboSpan" id="kobo.1136.1">You will see </span><a id="_idIndexMarker323"/><span class="koboSpan" id="kobo.1137.1">the output is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1138.1">SQLite</span></strong><span class="koboSpan" id="kobo.1139.1">. </span><span class="koboSpan" id="kobo.1139.2">Now, in the same PowerShell session, you can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1140.1">dotnet run</span></strong><span class="koboSpan" id="kobo.1141.1"> to run the application and send a request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1142.1">/Configuration/database-configuration</span></strong><span class="koboSpan" id="kobo.1143.1"> endpoint. </span><span class="koboSpan" id="kobo.1143.2">You will find the response </span><a id="_idIndexMarker324"/><span class="koboSpan" id="kobo.1144.1">contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1145.1">SQLite</span></strong><span class="koboSpan" id="kobo.1146.1"> value, even though the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1147.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1148.1"> file contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1149.1">SQL Server</span></strong><span class="koboSpan" id="kobo.1150.1"> value. </span><span class="koboSpan" id="kobo.1150.2">That means the environment variable value overrides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1151.1">appsettings.js</span><a id="_idTextAnchor153"/><span class="koboSpan" id="kobo.1152.1">on</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1153.1">file value.</span></span></p>
<h3><span class="koboSpan" id="kobo.1154.1">Command-line configuration provider</span></h3>
<p><span class="koboSpan" id="kobo.1155.1">Command-line arguments </span><a id="_idIndexMarker325"/><span class="koboSpan" id="kobo.1156.1">have a higher priority than environment variables. </span><span class="koboSpan" id="kobo.1156.2">By default, the</span><a id="_idIndexMarker326"/><span class="koboSpan" id="kobo.1157.1"> configuration settings set on the command line override values set with other </span><span class="No-Break"><span class="koboSpan" id="kobo.1158.1">configuration providers.</span></span></p>
<p><span class="koboSpan" id="kobo.1159.1">Following the example in the previous section, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1160.1">Database__Type</span></strong><span class="koboSpan" id="kobo.1161.1"> value is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1162.1">SQL Server</span></strong><span class="koboSpan" id="kobo.1163.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1164.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1165.1"> file. </span><span class="koboSpan" id="kobo.1165.2">We also set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1166.1">Database__Type</span></strong><span class="koboSpan" id="kobo.1167.1"> environment variable to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1168.1">SQLite</span></strong><span class="koboSpan" id="kobo.1169.1">. </span><span class="koboSpan" id="kobo.1169.2">Now, let us change the value to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1170.1">MySQL</span></strong><span class="koboSpan" id="kobo.1171.1"> in the command-line argument using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1172.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1173.1">
dotnet run Database:Type=MySQL</span></pre> <p><span class="koboSpan" id="kobo.1174.1">Send a request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1175.1">/Configuration/database-configuration</span></strong><span class="koboSpan" id="kobo.1176.1"> endpoint. </span><span class="koboSpan" id="kobo.1176.2">You will find the response contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1177.1">MySQL</span></strong><span class="koboSpan" id="kobo.1178.1"> value, which means the command-line argument value overrides the environment </span><span class="No-Break"><span class="koboSpan" id="kobo.1179.1">variable value.</span></span></p>
<p><span class="koboSpan" id="kobo.1180.1">Command-line arguments can also be set in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1181.1">following ways:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1182.1">
dotnet run --Database:Type MySQLdotnet run /Database:Type MySQL</span></pre>
<p><span class="koboSpan" id="kobo.1183.1">If </span><strong class="source-inline"><span class="koboSpan" id="kobo.1184.1">--</span></strong><span class="koboSpan" id="kobo.1185.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1186.1">/</span></strong><span class="koboSpan" id="kobo.1187.1"> is used for the key, the value can follow a space. </span><span class="koboSpan" id="kobo.1187.2">Otherwise, the value must follow the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1188.1">=</span></strong><span class="koboSpan" id="kobo.1189.1"> sign. </span><span class="koboSpan" id="kobo.1189.2">Please do not mix the two ways in t</span><a id="_idTextAnchor154"/><span class="koboSpan" id="kobo.1190.1">he </span><span class="No-Break"><span class="koboSpan" id="kobo.1191.1">same command.</span></span></p>
<h3><span class="koboSpan" id="kobo.1192.1">Azure Key Vault configuration provider</span></h3>
<p><span class="koboSpan" id="kobo.1193.1">Azure Key Vault is a</span><a id="_idIndexMarker327"/><span class="koboSpan" id="kobo.1194.1"> cloud-based service that provides secure storage for secrets, such as passwords, certificates, and </span><a id="_idIndexMarker328"/><span class="koboSpan" id="kobo.1195.1">keys. </span><span class="koboSpan" id="kobo.1195.2">The Azure Key Vault configuration provider is used to read the secrets from an Azure Key Vault. </span><span class="koboSpan" id="kobo.1195.3">It is a good choice for running the application </span><span class="No-Break"><span class="koboSpan" id="kobo.1196.1">in production.</span></span></p>
<p><span class="koboSpan" id="kobo.1197.1">To use it, you need to install the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1198.1">NuGet packages:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1199.1">Azure.Extensions.AspNetCore.Configuration.Secrets</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1200.1">Azure.Identity</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1201.1">Azure App Configuration is a cloud-based service that provides a centralized configuration store for managing application settings and feature flags. </span><span class="koboSpan" id="kobo.1201.2">App Configuration complements Azure Key Vault. </span><span class="koboSpan" id="kobo.1201.3">It aims to simplify tasks of working with complex application settings. </span><span class="koboSpan" id="kobo.1201.4">You need to install the following NuGet packages to use the Azure App </span><span class="No-Break"><span class="koboSpan" id="kobo.1202.1">Configuration provider:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1203.1">Microsoft.Azure.AppConfiguration.AspNetCore</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1204.1">We will not cover details of the Azure Key Vault and Azure App Configuration providers in this book. </span><span class="koboSpan" id="kobo.1204.2">For more information, please refer to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1205.1">following links:</span></span></p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/key-vault/general/"><span class="No-Break"><span class="koboSpan" id="kobo.1206.1">https://learn.microsoft.com/en-us/azure/key-vault/general/</span></span></a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/azure-app-configuration/"><span class="No-Break"><span class="koboSpan" id="kobo.1207.1">https://docs.microsoft.com/en-us/azure/azure-</span><span id="_idTextAnchor155"/><span class="koboSpan" id="kobo.1208.1">app-configuration/</span></span></a></li>
</ul>
<h1 id="_idParaDest-80"><a id="_idTextAnchor156"/><span class="koboSpan" id="kobo.1209.1">Environments</span></h1>
<p><span class="koboSpan" id="kobo.1210.1">In the previous section, we introduced how to read the configuration settings from various resources, including the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1211.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1212.1"> file, user secrets, environment variables, and command-line arguments. </span><span class="koboSpan" id="kobo.1212.2">In this section, we will discuss</span><a id="_idIndexMarker329"/><span class="koboSpan" id="kobo.1213.1"> environments in </span><span class="No-Break"><span class="koboSpan" id="kobo.1214.1">more detail.</span></span></p>
<p><span class="koboSpan" id="kobo.1215.1">Run the following command to create a new ASP.NET Core web </span><span class="No-Break"><span class="koboSpan" id="kobo.1216.1">API project:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1217.1">
dotnet new webapi -n EnvironmentDemo -controllers</span></pre> <p><span class="koboSpan" id="kobo.1218.1">You can download the example project named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1219.1">EnvironmentDemo</span></strong><span class="koboSpan" id="kobo.1220.1"> from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1221.1">/samples/chapter3/EnvironmentsDemo</span></strong><span class="koboSpan" id="kobo.1222.1"> folder in the chapter's </span><span class="No-Break"><span class="koboSpan" id="kobo.1223.1">GitHub repository.</span></span></p>
<p><span class="koboSpan" id="kobo.1224.1">We have mentioned the default ASP.NET Core web API template contains an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1225.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1226.1"> file and an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1227.1">appsettings.Development.json</span></strong><span class="koboSpan" id="kobo.1228.1"> file. </span><span class="koboSpan" id="kobo.1228.2">When we run the application using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1229.1">dotnet run</span></strong><span class="koboSpan" id="kobo.1230.1">, the application runs in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1231.1">Development</span></strong><span class="koboSpan" id="kobo.1232.1"> environment. </span><span class="koboSpan" id="kobo.1232.2">So the configuration settings in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1233.1">appsettings.Development.json</span></strong><span class="koboSpan" id="kobo.1234.1"> file override the configuration settings in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1235.1">appsettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1236.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.1237.1">Add the </span><a id="_idIndexMarker330"/><span class="koboSpan" id="kobo.1238.1">following section to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1239.1">appsettings.Development.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1240.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1241.1">
{  // Omitted for brevity
  "Database": {
    "Type": "SQL Server",
    "ConnectionString": "This is the database connection string from base appsettings.json."
</span><span class="koboSpan" id="kobo.1241.2">  }
}</span></pre>
<p><span class="koboSpan" id="kobo.1242.1">Then, add the following section to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1243.1">appsettings.Development.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1244.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1245.1">
{  // Omitted for brevity
  "Database": {
    "Type": "LocalDB",
    "ConnectionString": "This is the database connection string from appsettings.Development.json"
  }
}</span></pre>
<p class="callout-heading"><span class="koboSpan" id="kobo.1246.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1247.1">Note that user secrets have higher priority than the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1248.1">appsettings.Development.json</span></strong><span class="koboSpan" id="kobo.1249.1"> file. </span><span class="koboSpan" id="kobo.1249.2">So, if you configured the local user secrets in the previous section, please clear </span><span class="No-Break"><span class="koboSpan" id="kobo.1250.1">the secrets.</span></span></p>
<p><span class="koboSpan" id="kobo.1251.1">Create a</span><a id="_idIndexMarker331"/><span class="koboSpan" id="kobo.1252.1"> new controller named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1253.1">ConfigurationController.cs</span></strong><span class="koboSpan" id="kobo.1254.1"> and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1255.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1256.1">
using Microsoft.AspNetCore.Mvc;namespace EnvironmentsDemo.Controllers;
[ApiController]
[Route("[controller]")]
public class ConfigurationController(IConfiguration configuration) : ControllerBase
{
    private readonly IConfiguration _configuration;
    public ConfigurationController(IConfiguration configuration)
    {
        _configuration = configuration;
    }
    [HttpGet]
    [Route("database-configuration")]
    public ActionResult GetDatabaseConfiguration()
    {
        var type = configuration["database:Type"];
        var connectionString = configuration["Database:ConnectionString"];
        return Ok(new { Type = type, ConnectionString = connectionString });
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.1257.1">Run the </span><a id="_idIndexMarker332"/><span class="koboSpan" id="kobo.1258.1">application using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1259.1">dotnet run</span></strong><span class="koboSpan" id="kobo.1260.1">. </span><span class="koboSpan" id="kobo.1260.2">Send the request to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1261.1">/Configuration/database-configuration</span></strong><span class="koboSpan" id="kobo.1262.1"> endpoint. </span><span class="koboSpan" id="kobo.1262.2">You will find the response contains a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1263.1">LocalDB</span></strong><span class="koboSpan" id="kobo.1264.1"> value, which means the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1265.1">appsettings.Development.json</span></strong><span class="koboSpan" id="kobo.1266.1"> file overrides the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1267.1">appsettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1268.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.1269.1">So, where is the environment</span><a id="_idTextAnchor157"/><span class="koboSpan" id="kobo.1270.1"> name </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1271.1">Development</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1272.1"> set?</span></span></p>
<h2 id="_idParaDest-81"><a id="_idTextAnchor158"/><span class="koboSpan" id="kobo.1273.1">Understanding the launchSettings.json file</span></h2>
<p><span class="koboSpan" id="kobo.1274.1">Open </span><a id="_idIndexMarker333"/><span class="koboSpan" id="kobo.1275.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1276.1">launchSettings.json</span></strong><span class="koboSpan" id="kobo.1277.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1278.1">Properties</span></strong><span class="koboSpan" id="kobo.1279.1"> folder. </span><span class="koboSpan" id="kobo.1279.2">You will find the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1280.1">ASPNETCORE_ENVIRONMENT</span></strong><span class="koboSpan" id="kobo.1281.1"> environment variable is set </span><span class="No-Break"><span class="koboSpan" id="kobo.1282.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1283.1">Development</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1284.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1285.1">
  "profiles": {    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:5161",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:7096;http://localhost:5161",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }</span></pre>
<p><span class="koboSpan" id="kobo.1286.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1287.1">launchSettings.json</span></strong><span class="koboSpan" id="kobo.1288.1"> file is used to configure the local development environment. </span><span class="koboSpan" id="kobo.1288.2">It is not deployable. </span><span class="koboSpan" id="kobo.1288.3">The default </span><strong class="source-inline"><span class="koboSpan" id="kobo.1289.1">launchSettings.json</span></strong><span class="koboSpan" id="kobo.1290.1"> file contains three </span><a id="_idIndexMarker334"/><span class="koboSpan" id="kobo.1291.1">profiles: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1292.1">http</span></strong><span class="koboSpan" id="kobo.1293.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1294.1">https</span></strong><span class="koboSpan" id="kobo.1295.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1296.1">IIS Express</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1297.1">:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1298.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1299.1">http</span></strong><span class="koboSpan" id="kobo.1300.1"> profile is used to run the application with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1301.1">HTTP protocol</span></span></li>
<li><span class="koboSpan" id="kobo.1302.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1303.1">https</span></strong><span class="koboSpan" id="kobo.1304.1"> profile is used to run the application with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1305.1">HTTPS protocol</span></span></li>
<li><span class="koboSpan" id="kobo.1306.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1307.1">IIS Express</span></strong><span class="koboSpan" id="kobo.1308.1"> profile is used to run the application in </span><span class="No-Break"><span class="koboSpan" id="kobo.1309.1">IIS Express</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1310.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1311.1">commandName</span></strong><span class="koboSpan" id="kobo.1312.1"> field in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1313.1">http</span></strong><span class="koboSpan" id="kobo.1314.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1315.1">https</span></strong><span class="koboSpan" id="kobo.1316.1"> profiles is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1317.1">Project</span></strong><span class="koboSpan" id="kobo.1318.1">, which means the Kestrel server is launched to run the application. </span><span class="koboSpan" id="kobo.1318.2">Similarly, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1319.1">IISExpress</span></strong><span class="koboSpan" id="kobo.1320.1"> value in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1321.1">IIS Express</span></strong><span class="koboSpan" id="kobo.1322.1"> profile means the application expects IIS Express to be the </span><span class="No-Break"><span class="koboSpan" id="kobo.1323.1">web server.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1324.1">What is the Kestrel server?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1325.1">Kestrel is a cross-platform web server for ASP.NET Core. </span><span class="koboSpan" id="kobo.1325.2">Kestrel is included and enabled by default in ASP.NET Core project templates. </span><span class="koboSpan" id="kobo.1325.3">ASP.NET Core can also be hosted in IIS (or IIS Express), but IIS is not cross-platform. </span><span class="koboSpan" id="kobo.1325.4">So, Kestrel is the preferred web server for ASP.NET </span><span class="No-Break"><span class="koboSpan" id="kobo.1326.1">Core applications.</span></span></p>
<p><span class="koboSpan" id="kobo.1327.1">When </span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.1328.1">running </span><strong class="source-inline"><span class="koboSpan" id="kobo.1329.1">dotnet run</span></strong><span class="koboSpan" id="kobo.1330.1">, the first profile with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1331.1">commandName</span></strong><span class="koboSpan" id="kobo.1332.1"> value, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1333.1">Project</span></strong><span class="koboSpan" id="kobo.1334.1">, is used. </span><span class="koboSpan" id="kobo.1334.2">For the demo project, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1335.1">http</span></strong><span class="koboSpan" id="kobo.1336.1"> profile is used. </span><span class="koboSpan" id="kobo.1336.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1337.1">ASPNETCORE_ENVIRONMENT</span></strong><span class="koboSpan" id="kobo.1338.1"> environment variable is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1339.1">Development</span></strong><span class="koboSpan" id="kobo.1340.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1341.1">http</span></strong><span class="koboSpan" id="kobo.1342.1"> profile. </span><span class="koboSpan" id="kobo.1342.2">So, the application runs in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1343.1">Development</span></strong><span class="koboSpan" id="kobo.1344.1"> environment. </span><span class="koboSpan" id="kobo.1344.2">You can see the output in </span><span class="No-Break"><span class="koboSpan" id="kobo.1345.1">the console:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1346.1">
Building...info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5161
info: Microsoft.Hosting.Lifetime[0]
      Application started. </span><span class="koboSpan" id="kobo.1346.2">Press Ctrl+C to shut down.
</span><span class="koboSpan" id="kobo.1346.3">info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\dev\web-api-with-asp-net\example_code\chapter3\EnvironmentsDemo</span></pre>
<p><span class="koboSpan" id="kobo.1347.1">We can specify the profile to use when running the application using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1348.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1349.1">launch-profile</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1350.1"> argument:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1351.1">
dotnet run --launch-profile https</span></pre> <p><span class="koboSpan" id="kobo.1352.1">Note that this approach is only available for Kestrel profiles. </span><span class="koboSpan" id="kobo.1352.2">You cannot use this argument to run the application in </span><span class="No-Break"><span class="koboSpan" id="kobo.1353.1">IIS Express.</span></span></p>
<p><span class="koboSpan" id="kobo.1354.1">If you use </span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.1355.1">VS 2022 to open the project, you can choose which profile to use, </span><span class="No-Break"><span class="koboSpan" id="kobo.1356.1">like this:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer028">
<span class="koboSpan" id="kobo.1357.1"><img alt="Figure 3.1 – Choosing a profile to ﻿use in Visual Studio 2022" src="image/Figure_3.1_B18971.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1358.1">Figure 3.1 – Choosing a profile to </span><a id="_idTextAnchor159"/><span class="koboSpan" id="kobo.1359.1">use in Visual Studio 2022</span></p>
<p><span class="koboSpan" id="kobo.1360.1">Next, let's explore how to configure the application to run in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1361.1">Production</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1362.1"> environment.</span></span></p>
<h2 id="_idParaDest-82"><a id="_idTextAnchor160"/><span class="koboSpan" id="kobo.1363.1">Setting the environment</span></h2>
<p><span class="koboSpan" id="kobo.1364.1">There</span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.1365.1"> are several ways to change the environment. </span><span class="koboSpan" id="kobo.1365.2">Let's create a new file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1366.1">appsettings.Production.json</span></strong><span class="koboSpan" id="kobo.1367.1">. </span><span class="koboSpan" id="kobo.1367.2">This configuration file will be used for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1368.1">Production</span></strong><span class="koboSpan" id="kobo.1369.1"> environment. </span><span class="koboSpan" id="kobo.1369.2">Add the following section to </span><span class="No-Break"><span class="koboSpan" id="kobo.1370.1">the file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1371.1">
{  // Omitted for brevity
  "Database": {
    "Type": "PostgreSQL",
    "ConnectionString": "This is the database connection string from appsettings.Production.json"
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.1372.1">Next, we </span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.1373.1">will specify the environment as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1374.1">Production</span></strong><span class="koboSpan" id="kobo.1375.1"> t</span><a id="_idTextAnchor161"/><span class="koboSpan" id="kobo.1376.1">o apply </span><span class="No-Break"><span class="koboSpan" id="kobo.1377.1">this configuration.</span></span></p>
<h3><span class="koboSpan" id="kobo.1378.1">Using the launchSettings.json file</span></h3>
<p><span class="koboSpan" id="kobo.1379.1">For development purposes, we </span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.1380.1">can create a new profile in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1381.1">launchSettings.json</span></strong><span class="koboSpan" id="kobo.1382.1"> file, which specifies the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1383.1">ASPNETCORE_ENVIRONMENT</span></strong><span class="koboSpan" id="kobo.1384.1"> variable as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1385.1">Production</span></strong><span class="koboSpan" id="kobo.1386.1">. </span><span class="koboSpan" id="kobo.1386.2">Add the following section to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1387.1">launchSettings.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1388.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1389.1">
// Omitted for brevity  "profiles": {
    // Omitted for brevity
    "production": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:7096;http://localhost:5161",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Production"
      }
    }
    // Omitted for brevity
  }</span></pre>
<p><span class="koboSpan" id="kobo.1390.1">Use the following command to run the application in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1391.1">Production</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1392.1"> environment:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1393.1">
dotnet run --launch-profile production</span></pre> <p><span class="koboSpan" id="kobo.1394.1">You will </span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.1395.1">see in the console that the application runs in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1396.1">Production</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1397.1"> environment:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1398.1">
PS C:\dev\web-api-with-asp-net\example_code\chapter3\EnvironmentsDemo&gt; dotnet run --launch-profile productionBuilding...
</span><span class="koboSpan" id="kobo.1398.2">warn: Microsoft.AspNetCore.Server.Kestrel.Core.KestrelServer[8]
      The ASP.NET Core developer certificate is not trusted. </span><span class="koboSpan" id="kobo.1398.3">For information about trusting the ASP.NET Core developer certificate, see https://aka.ms/aspnet/https-trust-dev-cert.
</span><span class="koboSpan" id="kobo.1398.4">info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:7096
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5161
info: Microsoft.Hosting.Lifetime[0]
      Application started. </span><span class="koboSpan" id="kobo.1398.5">Press Ctrl+C to shut down.
</span><span class="koboSpan" id="kobo.1398.6">info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\dev\web-api-with-asp-net\example_code\chapter3\EnvironmentsDemo</span></pre>
<p><span class="koboSpan" id="kobo.1399.1">It looks good. </span><span class="koboSpan" id="kobo.1399.2">Let's try to access the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1400.1">/Configuration/database-configuration</span></strong><span class="koboSpan" id="kobo.1401.1"> endpoint. </span><span class="koboSpan" id="kobo.1401.2">You will see the response is from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1402.1">appsettin</span><a id="_idTextAnchor162"/><span class="koboSpan" id="kobo.1403.1">gs.Production.json</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1404.1"> file.</span></span></p>
<h3><span class="koboSpan" id="kobo.1405.1">Using the ASPNETCORE_ENVIRONMENT  environment variable</span></h3>
<p><span class="koboSpan" id="kobo.1406.1">You can also set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1407.1">ASPNETCORE_ENVIRONMENT</span></strong><span class="koboSpan" id="kobo.1408.1"> environment variable to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1409.1">Production</span></strong><span class="koboSpan" id="kobo.1410.1"> in the current session, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1411.1">shown next:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1412.1">
$Env:ASPNETCORE_ENVIRONMENT = "Production"dotnet run --no-launch-profile</span></pre>
<p><span class="koboSpan" id="kobo.1413.1">Furthermore, you </span><a id="_idIndexMarker341"/><span class="koboSpan" id="kobo.1414.1">can set the environment variable globally in your system. </span><span class="koboSpan" id="kobo.1414.2">Use the following command to set the environment </span><span class="No-Break"><span class="koboSpan" id="kobo.1415.1">variable globally:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1416.1">
[Environment]::SetEnvironmentVariable("ASPNETCORE_ENVIRONMENT", "Production", "Machine")</span></pre> <p><span class="koboSpan" id="kobo.1417.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1418.1">Machine</span></strong><span class="koboSpan" id="kobo.1419.1"> argument sets the environment variable globally. </span><span class="koboSpan" id="kobo.1419.2">You can also set the environment variable for the current user by usi</span><a id="_idTextAnchor163"/><span class="koboSpan" id="kobo.1420.1">ng the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1421.1">User</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1422.1"> argument.</span></span></p>
<h3><span class="koboSpan" id="kobo.1423.1">Using the --environment argument</span></h3>
<p><span class="koboSpan" id="kobo.1424.1">Another</span><a id="_idIndexMarker342"/><span class="koboSpan" id="kobo.1425.1"> way is to set the environment with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1426.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1427.1">environment</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1428.1"> argument:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1429.1">
dotn</span><a id="_idTextAnchor164"/><span class="koboSpan" id="kobo.1430.1">et run --environment Production</span></pre> <h3><span class="koboSpan" id="kobo.1431.1">Using the launch.json file in VS Code</span></h3>
<p><span class="koboSpan" id="kobo.1432.1">If you use</span><a id="_idIndexMarker343"/><span class="koboSpan" id="kobo.1433.1"> VS Code to open the project, you can set the environment in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1434.1">launch.json</span></strong><span class="koboSpan" id="kobo.1435.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1436.1">.vscode</span></strong><span class="koboSpan" id="kobo.1437.1"> folder. </span><span class="koboSpan" id="kobo.1437.2">When you open an ASP.NET Core project, VS Code will prompt you to add required assets to debug the project. </span><span class="koboSpan" id="kobo.1437.3">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.1438.1">launch.json</span></strong><span class="koboSpan" id="kobo.1439.1"> file and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1440.1">tasks.json</span></strong><span class="koboSpan" id="kobo.1441.1"> file will be added to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1442.1">.vscode</span></strong><span class="koboSpan" id="kobo.1443.1"> folder. </span><span class="koboSpan" id="kobo.1443.2">If you do not see the prompt, you can open the Command Palette and run the </span><strong class="bold"><span class="koboSpan" id="kobo.1444.1">.NET: Generate Assets for Build and </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1445.1">Debug</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1446.1"> command.</span></span></p>
<p><span class="koboSpan" id="kobo.1447.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1448.1">launch.json</span></strong><span class="koboSpan" id="kobo.1449.1"> file and you will find the </span><span class="No-Break"><span class="koboSpan" id="kobo.1450.1">following content:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1451.1">
{  // Omitted for brevity
  "configurations": [
    {
      "name": ".NET Core Launch (web)",
      "type": "coreclr",
      // Omitted for brevity
      "env": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      },
      // Omitted for brevity
    }
  ]
}</span></pre>
<p><span class="koboSpan" id="kobo.1452.1">You can </span><a id="_idIndexMarker344"/><span class="koboSpan" id="kobo.1453.1">add a new configuration following the existing one. </span><span class="koboSpan" id="kobo.1453.2">Change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1454.1">ASPNETCORE_ENVIRONMENT</span></strong><span class="koboSpan" id="kobo.1455.1"> field to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1456.1">Production</span></strong><span class="koboSpan" id="kobo.1457.1"> and use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1458.1">.NET Core Launch (Production)</span></strong><span class="koboSpan" id="kobo.1459.1"> as the name. </span><span class="koboSpan" id="kobo.1459.2">Save the file. </span><span class="koboSpan" id="kobo.1459.3">You can now run the application in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1460.1">Production</span></strong><span class="koboSpan" id="kobo.1461.1"> environment by clicking the green arrow in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1462.1">debug panel:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer029">
<span class="koboSpan" id="kobo.1463.1"><img alt="Figure 3.2 – Running the application in a specific environment in VS Code" src="image/Figure_3.2_B18971.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1464.1">Figure 3.2 – Running the application in a specific environment in VS Code</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1465.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1466.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1467.1">launch.json</span></strong><span class="koboSpan" id="kobo.1468.1"> file is only used in VS Code </span><strong class="bold"><span class="koboSpan" id="kobo.1469.1">RUN AND DEBUG</span></strong><span class="koboSpan" id="kobo.1470.1">. </span><span class="koboSpan" id="kobo.1470.2">It is not used when you run the applicati</span><a id="_idTextAnchor165"/><span class="koboSpan" id="kobo.1471.1">on using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1472.1">dotnet </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1473.1">run</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1474.1"> command.</span></span></p>
<h3><span class="koboSpan" id="kobo.1475.1">Using the launchSettings.json file in Visual Studio 2022</span></h3>
<p><span class="koboSpan" id="kobo.1476.1">Visual Studio 2022 </span><a id="_idIndexMarker345"/><span class="koboSpan" id="kobo.1477.1">provides a </span><strong class="bold"><span class="koboSpan" id="kobo.1478.1">Launch Profiles</span></strong><span class="koboSpan" id="kobo.1479.1"> dialog to set up the environment variables. </span><span class="koboSpan" id="kobo.1479.2">You have multiple ways to open the </span><strong class="bold"><span class="koboSpan" id="kobo.1480.1">Launch </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1481.1">Profiles</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1482.1"> dialog:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1483.1">Open the </span><strong class="bold"><span class="koboSpan" id="kobo.1484.1">Debug</span></strong><span class="koboSpan" id="kobo.1485.1"> menu | </span><em class="italic"><span class="koboSpan" id="kobo.1486.1">&lt;Your project name&gt;</span></em> <span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1487.1">Debug Properties</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1488.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1489.1">Click the arrow next to the green arrow in the debug panel and select </span><em class="italic"><span class="koboSpan" id="kobo.1490.1">&lt;Your project name&gt;</span></em> <span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1491.1">Debug Properties</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1492.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1493.1">Right-click the project in the </span><strong class="bold"><span class="koboSpan" id="kobo.1494.1">Solution Explorer</span></strong><span class="koboSpan" id="kobo.1495.1"> window and select </span><strong class="bold"><span class="koboSpan" id="kobo.1496.1">Properties</span></strong><span class="koboSpan" id="kobo.1497.1">. </span><span class="koboSpan" id="kobo.1497.2">In the </span><strong class="bold"><span class="koboSpan" id="kobo.1498.1">Debug / General</span></strong><span class="koboSpan" id="kobo.1499.1"> tab, click the </span><strong class="bold"><span class="koboSpan" id="kobo.1500.1">Open debug launch profiles </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1501.1">UI</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1502.1"> link.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1503.1">Then, you can see the </span><strong class="bold"><span class="koboSpan" id="kobo.1504.1">Launch </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1505.1">Profiles</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1506.1"> dialog:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer030">
<span class="koboSpan" id="kobo.1507.1"><img alt="Figure 3.3 – The Launch Profiles dialog in Visual Studio 2022" src="image/Figure_3.3_B18971.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1508.1">Figure 3.3 – The Launch Profiles dialog in Visual Studio 2022</span></p>
<p><span class="koboSpan" id="kobo.1509.1">If you </span><a id="_idIndexMarker346"/><span class="koboSpan" id="kobo.1510.1">make changes here, you need to restart the application to apply </span><span class="No-Break"><span class="koboSpan" id="kobo.1511.1">the changes.</span></span></p>
<p><span class="koboSpan" id="kobo.1512.1">We have learned how to set the environment. </span><span class="koboSpan" id="kobo.1512.2">With the environment set, we can use different configurat</span><a id="_idTextAnchor166"/><span class="koboSpan" id="kobo.1513.1">ions for </span><span class="No-Break"><span class="koboSpan" id="kobo.1514.1">different environments.</span></span></p>
<h2 id="_idParaDest-83"><a id="_idTextAnchor167"/><span class="koboSpan" id="kobo.1515.1">Understanding the priorities of configuration and environment variables</span></h2>
<p><span class="koboSpan" id="kobo.1516.1">We introduced </span><a id="_idIndexMarker347"/><span class="koboSpan" id="kobo.1517.1">quite a few different ways to read configuration values and environment variables. </span><span class="koboSpan" id="kobo.1517.2">Let us see how configuration and environment variables </span><span class="No-Break"><span class="koboSpan" id="kobo.1518.1">are prioritized.</span></span></p>
<p><span class="koboSpan" id="kobo.1519.1">The following table shows the priorities of the configuration sources (the lowest number has the </span><span class="No-Break"><span class="koboSpan" id="kobo.1520.1">highest priority):</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table002-2">
<colgroup>
<col/>
<col/>
</colgroup>
<thead>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1521.1">Source</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1522.1">Priority</span></strong></span></p>
</td>
</tr>
</thead>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.1523.1">Command-line arguments</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1524.1">1</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1525.1">Non-prefixed </span><span class="No-Break"><span class="koboSpan" id="kobo.1526.1">environment variables</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1527.1">2</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1528.1">User secrets (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1529.1">Development</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1530.1">environment only)</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1531.1">3</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1532.1">appsettings.{Environment}.json</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1533.1">4</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1534.1">appsettings.json</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1535.1">5</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.1536.1">Table 3.2 – Priorities of configuration sources</span></p>
<p><span class="koboSpan" id="kobo.1537.1">If other configuration providers are registered in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1538.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1539.1"> file, the later registered providers have higher priority than the earlier </span><span class="No-Break"><span class="koboSpan" id="kobo.1540.1">registered providers.</span></span></p>
<p><span class="koboSpan" id="kobo.1541.1">In </span><a id="_idIndexMarker348"/><span class="koboSpan" id="kobo.1542.1">terms of environment variables such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1543.1">ASPNETCORE_ENVIRONMENT</span></strong><span class="koboSpan" id="kobo.1544.1">, the following table shows </span><span class="No-Break"><span class="koboSpan" id="kobo.1545.1">the priorities:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table003-2">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1546.1">Source</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1547.1">Priority</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.1548.1">Command-line arguments</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1549.1">1</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1550.1">launchSettings.json</span></strong><span class="koboSpan" id="kobo.1551.1"> (development </span><span class="No-Break"><span class="koboSpan" id="kobo.1552.1">purposes only)</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1553.1">2</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1554.1">Environment variable in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1555.1">current process</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1556.1">3</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1557.1">System </span><span class="No-Break"><span class="koboSpan" id="kobo.1558.1">environment variable</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1559.1">4</span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.1560.1">Table 3.3 – Priorities of environment variables</span></p>
<p><span class="koboSpan" id="kobo.1561.1">Note that there are some other ways to configure the environment that are not listed in the preceding table. </span><span class="koboSpan" id="kobo.1561.2">For example, if you deploy the ASP.NET Core application to Azure App Service, you can set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1562.1">ASPNETCORE_ENVIRONMENT</span></strong><span class="koboSpan" id="kobo.1563.1"> environment variable in the App Service configuration. </span><span class="koboSpan" id="kobo.1563.2">For Linux apps and container apps, Azure App Service passes these settings to the container using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1564.1">--env</span></strong><span class="koboSpan" id="kobo.1565.1"> flag to set the environment variable in </span><span class="No-Break"><span class="koboSpan" id="kobo.1566.1">the container.</span></span></p>
<h2 id="_idParaDest-84"><a id="_idTextAnchor168"/><span class="koboSpan" id="kobo.1567.1">Checking the environment in the code</span></h2>
<p><span class="koboSpan" id="kobo.1568.1">Keep </span><a id="_idIndexMarker349"/><span class="koboSpan" id="kobo.1569.1">running the application in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1570.1">Production</span></strong><span class="koboSpan" id="kobo.1571.1"> environment. </span><span class="koboSpan" id="kobo.1571.2">Let's try to access the Swagger UI page: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1572.1">http://localhost:5161/swagger</span></strong><span class="koboSpan" id="kobo.1573.1">. </span><span class="koboSpan" id="kobo.1573.2">You will find it shows a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1574.1">404 Not Found</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1575.1">error. </span><span class="koboSpan" id="kobo.1575.2">Why?</span></span></p>
<p><span class="koboSpan" id="kobo.1576.1">This is because the Swagger UI page is only enabled in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1577.1">Development</span></strong><span class="koboSpan" id="kobo.1578.1"> environment. </span><span class="koboSpan" id="kobo.1578.2">You can see the code in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1579.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1580.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1581.1">
if (app.Environment.IsDevelopment()){
    app.UseSwagger();
    app.UseSwaggerUI();
}</span></pre>
<p><span class="koboSpan" id="kobo.1582.1">The preceding code means that the Swagger UI page is enabled for the development </span><span class="No-Break"><span class="koboSpan" id="kobo.1583.1">environment only.</span></span></p>
<p><span class="koboSpan" id="kobo.1584.1">The three environment names, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1585.1">Development</span></strong><span class="koboSpan" id="kobo.1586.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1587.1">Staging</span></strong><span class="koboSpan" id="kobo.1588.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1589.1">Production</span></strong><span class="koboSpan" id="kobo.1590.1">, are predefined in the ASP.NET Core framework, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1591.1">shown next:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1592.1">
public static class Environments{
    public static readonly string Development = "Development";
    public static readonly string Staging = "Staging";
    public static readonly string Production = "Production";
}</span></pre>
<p><span class="koboSpan" id="kobo.1593.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1594.1">app.Environment.IsDevelopment()</span></strong><span class="koboSpan" id="kobo.1595.1"> method checks the current environment. </span><span class="koboSpan" id="kobo.1595.2">If the current environment is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1596.1">Development</span></strong><span class="koboSpan" id="kobo.1597.1">, the Swagger UI page is enabled. </span><span class="koboSpan" id="kobo.1597.2">Otherwise, it </span><span class="No-Break"><span class="koboSpan" id="kobo.1598.1">is disabled.</span></span></p>
<p><span class="koboSpan" id="kobo.1599.1">To set the environment in code, use the following code when </span><span class="No-Break"><span class="koboSpan" id="kobo.1600.1">creating </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1601.1">WebApplicationBuilder</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1602.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1603.1">
var builder = WebApplication.CreateBuilder(new WebApplicationOptions{
    EnvironmentName = Environments.Staging
});</span></pre>
<p><span class="koboSpan" id="kobo.1604.1">The</span><a id="_idIndexMarker350"/><span class="koboSpan" id="kobo.1605.1"> environment name is stored in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1606.1">IHostEnvironment.EnvironmentName</span></strong><span class="koboSpan" id="kobo.1607.1"> property. </span><span class="koboSpan" id="kobo.1607.2">You can define your own environment names. </span><span class="koboSpan" id="kobo.1607.3">For example, you can define an environment name such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1608.1">Test</span></strong><span class="koboSpan" id="kobo.1609.1">. </span><span class="koboSpan" id="kobo.1609.2">But the framework provides built-in methods, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1610.1">IsDevelopment()</span></strong><span class="koboSpan" id="kobo.1611.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1612.1">IsStaging()</span></strong><span class="koboSpan" id="kobo.1613.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1614.1">IsProduction()</span></strong><span class="koboSpan" id="kobo.1615.1">, to check the environment. </span><span class="koboSpan" id="kobo.1615.2">If you define your own environment names, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1616.1">IHostEnvironment.IsEnvironment(string environmentName)</span></strong><span class="koboSpan" id="kobo.1617.1"> method to check </span><span class="No-Break"><span class="koboSpan" id="kobo.1618.1">the environment.</span></span></p>
<p><span class="koboSpan" id="kobo.1619.1">We can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1620.1">System.Environment</span></strong><span class="koboSpan" id="kobo.1621.1"> class to get the environment variable in the code, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1622.1">ASPNETCORE_ENVIRONMENT</span></strong><span class="koboSpan" id="kobo.1623.1">. </span><span class="koboSpan" id="kobo.1623.2">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1624.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1625.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1626.1">
// Omitted for brevityvar app = builder.Build();
// Read the environment variable ASPNETCORE_ENVIRONMENT
var environmentName = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT");
Console.WriteLine($"ASPNETCORE_ENVIRONMENT is {environmentName}");</span></pre>
<p><span class="koboSpan" id="kobo.1627.1">Run the application, and you can see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1628.1">ASPNETCORE_ENVIRONMENT</span></strong><span class="koboSpan" id="kobo.1629.1"> environment variable in </span><span class="No-Break"><span class="koboSpan" id="kobo.1630.1">the console:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1631.1">
PS C:\dev\web-api-with-asp-net\example_code\chapter3\EnvironmentsDemo&gt; dotnet runBuilding...
</span><span class="koboSpan" id="kobo.1631.2">ASPNETCORE_ENVIRONMENT is Development
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5161
# Omitted for brevity</span></pre>
<p class="callout-heading"><span class="koboSpan" id="kobo.1632.1">What should we do for different environments?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1633.1">For the development environment, we can enable the Swagger UI page, show detailed error messages, output debugging information, and so on. </span><span class="koboSpan" id="kobo.1633.2">For the production environment, we should configure the application for best performance and maximum security. </span><span class="koboSpan" id="kobo.1633.3">Consider the following points for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1634.1">production environment:</span></span></p>
<ul>
<li class="callout"><span class="koboSpan" id="kobo.1635.1">Disable the Swagger </span><span class="No-Break"><span class="koboSpan" id="kobo.1636.1">UI page.</span></span></li>
<li class="callout"><span class="koboSpan" id="kobo.1637.1">Disable detailed </span><span class="No-Break"><span class="koboSpan" id="kobo.1638.1">error messages.</span></span></li>
<li class="callout"><span class="koboSpan" id="kobo.1639.1">Show a friendly </span><span class="No-Break"><span class="koboSpan" id="kobo.1640.1">error message.</span></span></li>
<li class="callout"><span class="koboSpan" id="kobo.1641.1">Do not output </span><span class="No-Break"><span class="koboSpan" id="kobo.1642.1">debugging information.</span></span></li>
<li class="callout"><span class="No-Break"><span class="koboSpan" id="kobo.1643.1">Enable cache.</span></span></li>
<li class="callout"><span class="No-Break"><span class="koboSpan" id="kobo.1644.1">Enable HTTPS.</span></span></li>
<li class="callout"><span class="koboSpan" id="kobo.1645.1">Enable the </span><span class="No-Break"><span class="koboSpan" id="kobo.1646.1">response compression.</span></span></li>
<li class="callout"><span class="koboSpan" id="kobo.1647.1">Enable monitoring </span><span class="No-Break"><span class="koboSpan" id="kobo.1648.1">and logging.</span></span></li>
</ul>
<h1 id="_idParaDest-85"><a id="_idTextAnchor169"/><span class="koboSpan" id="kobo.1649.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1650.1">In this chapter, we explored three important components of ASP.NET Core: routing, configuration, and environments. </span><span class="koboSpan" id="kobo.1650.2">We discussed how to configure routing for an ASP.NET Core web API application and how to read parameters from the request. </span><span class="koboSpan" id="kobo.1650.3">Additionally, we learned how to read configuration values from various sources, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1651.1">appsettings.json</span></strong><span class="koboSpan" id="kobo.1652.1">, environment variables, and command-line arguments. </span><span class="koboSpan" id="kobo.1652.2">We also explored how to read configurations based on the environment, allowing us to enable different features for </span><span class="No-Break"><span class="koboSpan" id="kobo.1653.1">different environments.</span></span></p>
<p><span class="koboSpan" id="kobo.1654.1">In the next chapter, we will learn about two more essential components of ASP.NET Core: logging </span><span class="No-Break"><span class="koboSpan" id="kobo.1655.1">and middleware.</span></span></p>
</div>
</body></html>