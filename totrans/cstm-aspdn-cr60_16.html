<html><head></head><body>
		<div><h1 id="_idParaDest-131"><em class="italic"><a id="_idTextAnchor231"/>Chapter 16</em>: Creating Custom TagHelper</h1>
			<p>In this chapter, we're going to talk about <code>TagHelper</code> are pretty useful and make Razor<a id="_idIndexMarker233"/> much prettier and more readable. Creating custom <code>TagHelper</code> will make your life much easier.</p>
			<p>In this chapter, we will be covering the following topics:</p>
			<ul>
				<li>Introducing <code>TagHelper</code></li>
				<li>Creating custom <code>TagHelper</code></li>
			</ul>
			<p>The topics in this chapter refer to the MVC layer of the ASP.NET Core architecture:</p>
			<div><div><img src="img/Figure_16.1_B17996.jpg" alt="Figure 16.1 – ASP.NET Core architecture &#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.1 – ASP.NET Core architecture </p>
			<h1 id="_idParaDest-132"><a id="_idTextAnchor232"/>Technical requirements</h1>
			<p>To follow the examples in this chapter, you will need to create an ASP.NET Core MVC application. Open your console, shell, or Bash terminal and change to your working directory. Use the following command to create a new MVC application:</p>
			<pre>dotnet new mvc -n TagHelperSample -o TagHelperSample</pre>
			<p>Now, open the project in Visual Studio by double-clicking the project file, or in Visual Studio Code by typing the following command in the already-open console:</p>
			<pre>cd TagHelperSample
code .</pre>
			<p>All of the code samples in this chapter can be found in the GitHub repository for this book at: <a href="https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter16">https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter16</a>.</p>
			<h1 id="_idParaDest-133"><a id="_idTextAnchor233"/><a id="_idTextAnchor234"/>Introducing TagHelper</h1>
			<p>With <code>TagHelper</code> are a kind of shortcut to write easier (and less) HTML or Razor code on the server side. <code>TagHelper</code> will be interpreted on the server and produce "real" HTML code for browsers.</p>
			<p><code>TagHelper</code> are not a new thing in ASP.NET Core. They have been present since the framework's first version. Most existing and built-in <code>TagHelper</code> are a replacement for the old-fashioned HTML helpers, which still exist and work in ASP.NET Core to keep the Razor views compatible with ASP.NET Core.</p>
			<p>A very basic example of extending HTML tags is the<a id="_idIndexMarker235"/> built-in <code>AnchorTagHelper</code>:</p>
			<pre>&lt;!-- old fashioned HtmlHelper --&gt;
@Html.ActionLink("Home", "Index", "Home")
&lt;!-- new TagHelper --&gt;
&lt;a asp-controller="Home" asp-action="Index"&gt;Home&lt;/a&gt;</pre>
			<p>Many HTML developers find it a bit strange to<a id="_idIndexMarker236"/> have <code>HtmlHelper</code> between the HTML tags. It is hard to read and is kind of disruptive while reading the code. Perhaps not for ASP.NET Core developers who are used to reading that kind of code, but compared to <code>TagHelper</code>, it is really ugly. <code>TagHelper</code> feel more natural and more like HTML, even if they are not, and even if they are getting rendered on the server.</p>
			<p>Many HTML helpers can be replaced with a <code>TagHelper</code>.</p>
			<p>There are also some new tags that have been built with <code>TagHelper</code>, tags that are not in HTML but look like HTML. One <a id="_idIndexMarker237"/>example is <code>EnvironmentTagHelper</code>:</p>
			<pre>&lt;environment include="Development"&gt;
    &lt;link rel="stylesheet" 
        href="~/lib/bootstrap/dist/css/bootstrap.css" /&gt;
    &lt;link rel="stylesheet" href="~/css/site.css" /&gt;
&lt;/environment&gt;
&lt;environment exclude="Development"&gt;
    &lt;link rel="stylesheet" 
        href="https://ajax.aspnetcdn.com/ajax/bootstrap/
              3.3.7/css/bootstrap.min.css"
            asp-fallback-href=
              "~/lib/bootstrap/dist/css/bootstrap.min.css"
            asp-fallback-test-class="sr-only" 
            asp-fallback-test-property="position" 
            asp-fallback-test-value="absolute" /&gt;
    &lt;link rel="stylesheet" 
        href="~/css/site.min.css" 
        asp-append-version="true" /&gt;
&lt;/environment&gt;</pre>
			<p>This <code>TagHelper</code> renders (or doesn't render) the contents depending on the current runtime environment. In <a id="_idIndexMarker238"/>this case, the target environment is the development mode. The first environment tag renders the contents if the current runtime environment is set to <code>Development</code>, and the second one renders the contents if it is <em class="italic">not</em> set to <code>Development</code>. This makes it a useful helper in rendering debuggable scripts or styles in <code>Development</code> mode and minified and optimized code in any other runtime environment.</p>
			<p>Let's now see how we can create our own custom <code>TagHelp<a id="_idTextAnchor235"/><a id="_idTextAnchor236"/>er</code>.</p>
			<h1 id="_idParaDest-134"><a id="_idTextAnchor237"/>Creating custom Tag Helpers</h1>
			<p>To use all the<a id="_idIndexMarker239"/> custom <code>TagHelper</code> that we will create in this chapter, you need to refer to the current assembly to tell the framework where to find the <code>TagHelper</code>. Open the <code>_ViewImports.cshtml</code> file in the <code>View/</code> folder and add the following line at the end of the file:</p>
			<pre>@addTagHelper *, TagHelperSample</pre>
			<p>Here's a quick example showing how to extend an existing tag using a <code>TagHelper</code>: </p>
			<ol>
				<li>Let's assume we need to have a tag configured in bold and colored in a specific color:<pre>&lt;p strong color="red"&gt;Use this area to provide 
  additional information.&lt;/p&gt;</pre><p>This looks like pretty old-fashioned HTML from the 90s, but this is just to demonstrate a simple <code>TagHelper</code>. </p></li>
				<li>The current method to do this task is to use a <code>TagHelper</code> to extend any tag that has an attribute called <code>strong</code>, as shown in the following code snippet:<pre>using Microsoft.AspNetCore.Razor.TagHelpers;
 
namespace TagHelperSample.TagHelpers;
[HtmlTargetElement(Attributes = "strong")]
public class StrongTagHelper : TagHelper
{
    public string Color { get; set; }
    public override void Process(
        TagHelperContext context, 
        TagHelperOutput output)
    {
        output.Attributes.RemoveAll("strong");
        output.Attributes.Add("style", 
            "font-weight:bold;");
        if (!String.IsNullOrWhiteSpace(Color))
        {
            output.Attributes.RemoveAll("style");
            output.Attributes.Add("style", 
                $"font-weight:bold;color:{Color};");
        }
    }
}</pre><p>The first<a id="_idIndexMarker240"/> line tells the tag helper to work on tags with a target attribute of <code>strong</code>. This <code>TagHelper</code> doesn't define its own tag, but it does provide an additional attribute to specify the color.</p><p>The <code>Process</code> method defines how to render the HTML to the output stream. In this case, it adds some CSS inline styles to the current tag. It also removes the target attribute from the current tag. The <code>color</code> attribute won't show up.</p><p>This will appear as follows:</p><pre>&lt;p style="font-weight:bold;color:red;"&gt;Use this area 
  to provide additional information.&lt;/p&gt;</pre></li>
			</ol>
			<p>The next example shows how to define a custom tag using a <code>TagHelper</code>:</p>
			<ol>
				<li value="1">Let's create this class, called <code>GreeterTagHelper</code>:<pre>using Microsoft.AspNetCore.Razor.TagHelpers;
 
namespace TagHelperSample.TagHelpers;
public class GreeterTagHelper : TagHelper
{
    [HtmlAttributeName("name")]
    public string Name { get; set; }
    public override void Process(
        TagHelperContext context, 
        TagHelperOutput output)
    {
        output.TagName = "p";
        output.Content.SetContent($"Hello {Name}");
    }
2</pre></li>
				<li>This <code>TagHelper</code> handles a <code>greeter</code> tag that has a property name. In the <code>Process</code> method, the current tag will be changed to a <code>p</code> tag and the new content is set<a id="_idIndexMarker241"/> as the current output:<pre>&lt;greeter name="Readers"&gt;&lt;/greeter&gt;</pre><p>The result looks like this:</p><pre>&lt;p&gt;Hello Readers&lt;/p&gt;</pre></li>
			</ol>
			<p>But what if you need to do something a bit more complicated? Let's explore f<a id="_idTextAnchor238"/><a id="_idTextAnchor239"/>urther.</p>
			<h2 id="_idParaDest-135"><a id="_idTextAnchor240"/>Examining a more complex scenario</h2>
			<p>The <code>TagHelper</code> in the <a id="_idIndexMarker242"/>last section were pretty basic, simply designed to show how <code>TagHelper</code> work. The next example is a little more complex and shows a real scenario. This <code>TagHelper</code> renders a table with a list of items. This is a generic <code>TagHelper</code> and shows a real reason to create your own custom <code>TagHelper</code>. With this, you are able to reuse an isolated piece of view code. For example, you can wrap <code>div</code> tags. Alternatively, you can just simplify your Razor views:</p>
			<ol>
				<li value="1">Let's start by creating the <code>DataGridTagHelper</code> class. This next code snippet isn't complete, but we <a id="_idIndexMarker243"/>will complete the <code>DataGridTagHelper</code> class in the following steps:<pre>using Microsoft.AspNetCore.Razor.TagHelpers;
 
namespace TagHelperSample.TagHelpers;
public class DataGridTagHelper : TagHelper
{
    [HtmlAttributeName("Items")]
    public IEnumerable&lt;object&gt; Items { get; set; }
    public override void Process(
        TagHelperContext context, 
        TagHelperOutput output)
    {
        output.TagName = "table";
        output.Attributes.Add("class", "table");
        var props = GetItemProperties();
        TableHeader(output, props);
        TableBody(output, props);
    }
}</pre><p>In the <code>Process</code> method, we call private sub-methods that do the actual work to make the class a little more readable. </p><p>You might need to add the following <code>using</code> statements at the beginning of the file:</p><pre>using System.Reflection;
using System.ComponentModel;</pre></li>
				<li>Because this is a generic <code>TagHelper</code>, incoming objects need to be analyzed. The <code>GetItemProperties</code> method gets the type of the property items and loads the <code>PropertyInfo</code> from the type. <code>PropertyInfo</code> will be used to get the table <a id="_idIndexMarker244"/>headers and the values:<pre>private PropertyInfo[] GetItemProperties()
{
    var listType = Items.GetType();
    Type itemType;
    if (listType.IsGenericType)
    {
        itemType = listType.GetGenericArguments()
            .First();
        return itemType.GetProperties(
            BindingFlags.Public | 
            BindingFlags.Instance);
    }
    return new PropertyInfo[] { };
}</pre></li>
				<li>The following code snippet shows the generation of the table headers. The <code>TableHeader</code> method writes the requisite HTML tags directly to <code>TagHelperOutput</code>. It also uses the list of <code>PropertyInfo</code> to get the property names that will be used as table header names:<pre>private void TableHeader(
    TagHelperOutput output, 
    PropertyInfo[] props)
{
    output.Content.AppendHtml("&lt;thead&gt;");
    output.Content.AppendHtml("&lt;tr&gt;");
    foreach (var prop in props)
    {
        var name = GetPropertyName(prop);
        output.Content.AppendHtml($"&lt;th&gt;{name}&lt;/th&gt;");
    }
    output.Content.AppendHtml("&lt;/tr&gt;");
    output.Content.AppendHtml("&lt;/thead&gt;");
}</pre></li>
				<li>Using property<a id="_idIndexMarker245"/> names as table header names is not always useful. This is why the <code>GetPropertyName</code> method also tries to read the value from <code>DisplayNameAttribute</code>, which is part of the <code>DataAnnotation</code> that is heavily used in data models that are displayed in MVC user interfaces. Therefore, it makes sense to support this attribute:<pre>private string GetPropertyName(
    PropertyInfo property)
{
    var attribute = property
        .GetCustomAttribute&lt;DisplayNameAttribute&gt;();
    if (attribute != null)
    {
        return attribute.DisplayName;
    }
    return property.Name;
}</pre></li>
				<li>Also, values<a id="_idIndexMarker246"/> need to be displayed. The <code>TableBody</code> method does that job:<pre>private void TableBody(
    TagHelperOutput output, 
    PropertyInfo[] props)
{
    output.Content.AppendHtml("&lt;tbody&gt;");
    foreach (var item in Items)
    {
        output.Content.AppendHtml("&lt;tr&gt;");
        foreach (var prop in props)
        {
            var value = GetPropertyValue(prop, item);
            output.Content.AppendHtml(
                $"&lt;td&gt;{value}&lt;/td&gt;");
        }
        output.Content.AppendHtml("&lt;/tr&gt;");
    }
    output.Content.AppendHtml("&lt;/tbody&gt;");
}</pre></li>
				<li>To get the values from the actual object, the <code>GetPropertyValue</code> method is used:<pre>private object GetPropertyValue(
    PropertyInfo property, 
    object instance)
{
    return property.GetValue(instance);
}</pre></li>
				<li>To use this <code>TagHelper</code>, you just need to assign a list of items to this tag:<pre>&lt;data-grid items="Model.Persons"&gt;&lt;/data-grid&gt;</pre><p>In this case, it<a id="_idIndexMarker247"/> is a list of people, which we get in the <code>Persons</code> property of our current model. </p></li>
				<li>The <code>Person</code> class we are using here looks like this:<pre>using System.ComponentModel;
 
namespace TagHelperSample.Models;
public class Person
{
    [DisplayName("First name")]
    public string FirstName { get; set; }
    [DisplayName("Last name")]
    public string LastName { get; set; }
    public int Age { get; set; }
    [DisplayName("Email address")]
    public string EmailAddress { get; set; }
}</pre><p>Not all of the properties have  <code>DisplayNameAttribute</code>, so the fallback in the <code>GetPropertyName</code> method is needed to get the actual property name instead of the <code>DisplayName</code> value.</p><p>Put the <code>Person</code> class into a <code>Person.cs</code> inside the <code>Models</code> folder.</p></li>
				<li>You also need a service to load the data into the <code>Index</code> action of the <code>HomeController</code>. Create a <code>Services</code> folder and place a file called <code>PersonService.cs</code> into it. Put the following snippet inside the file:<pre>using TagHelperSample.Models;
using GenFu;
 
namespace TagHelperSample.Services;
 
public interface IService
{
    IEnumerable&lt;Person&gt; AllPersons();
}
internal class PersonService : IService
{
    public IEnumerable&lt;Person&gt; AllPersons()
    {
        return A.ListOf&lt;Person&gt;(25);
    }
}</pre><p>Here, again, we use <code>GenFu</code> to auto-generate the list of persons. If you didn't already install it, you need to execute the following command to load the NuGet package:</p><pre>dotnet add package GenFu</pre><p>If this is done you should add <code>PersonService</code> to <code>ServiceCollection</code> in the <code>Program.cs</code> file:</p><pre>builder.Services.AddTransient&lt;IService, PersonService&gt;();</pre><p>And, last but not least, <code>PersonService</code> should be used in <code>HomeController</code>:</p><pre>using Microsoft.AspNetCore.Mvc;
using TagHelperSample.Models;
using TagHelperSample.Services;
 
namespace TagHelperSample.Controllers;
 
public class HomeController : Controller
{
    private readonly IService _service;
 
    public HomeController(
        IService service)
    {
        _service = service;
    }
 
    public IActionResult Index()
    {
        ViewData["Message"] = "Your application           description page.";
 
        var persons = _service.AllPersons();
        return View(new IndexViewModel
        {
            Persons = persons
        });
    }</pre></li>
				<li>This <code>TagHelper</code> needs <a id="_idIndexMarker248"/>some more checks and validations before you can use it in production, but it works. It displays a list of fake data that is generated using <code>GenFu</code> (see <a href="B17996_12_ePub.xhtml#_idTextAnchor172"><em class="italic">Chapter 12</em></a>, <em class="italic">Content Negotiation Using a Custom OutputFormatter</em>, to learn about <code>GenFu</code>):</li>
			</ol>
			<div><div><img src="img/Figure_16.2_B17996.jpg" alt="Figure 16.2 – The TagHelper sample in action&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.2 – The TagHelper sample in action</p>
			<p>Now, you are able to extend this <code>TagHelper</code> with a lot more features, including sorting, filtering, and paging. Feel free to try it out in a variety<a id="_idTextAnchor241"/> of contexts.</p>
			<h1 id="_idParaDest-136"><a id="_idTextAnchor242"/>Summary</h1>
			<p>Tag Helpers are pretty useful when it comes to reusing parts of the view and simplifying and cleaning up your views, as in the example with <code>DataGridTagHelper</code>. You can also provide a library with useful view elements. There are some more examples of pre-existing <code>TagHelper</code> libraries and samples that you can try out in the <em class="italic">Further reading</em> section.</p>
			<p>This is the last chapter of the second edition of <em class="italic">Customizing ASP.NET Core</em>. We're glad you read all the chapters. We hope you found the chapters useful and that they will help you optimize your applications.</p>
			<h1 id="_idParaDest-137"><a id="_idTextAnchor243"/>Further reading</h1>
			<ul>
				<li>Damian Edwards, <em class="italic">TagHelperPack</em>: <a href="https://github.com/DamianEdwards/TagHelperPack">https://github.com/DamianEdwards/TagHelperPack</a></li>
				<li>David Paquette, <em class="italic">TagHelperSamples</em>: <a href="https://github.com/dpaquette/TagHelperSamples">https://github.com/dpaquette/TagHelperSamples</a></li>
				<li><em class="italic">TagHelpers for Bootstrap by Teleric</em>: <a href="https://www.red-gate.com/simple-talk/dotnet/asp-net/asp-net-core-tag-helpers-bootstrap/">https://www.red-gate.com/simple-talk/dotnet/asp-net/asp-net-core-tag-helpers-bootstrap/</a></li>
				<li><em class="italic">TagHelpers for jQuery</em>: <a href="https://www.jqwidgets.com/asp.net-core-mvc-tag-helpers/">https://www.jqwidgets.com/asp.net-core-mvc-tag-helpers/</a></li>
			</ul>
		</div>
	</body></html>