

# 推动变革

在整本书中，我们讨论了可观测性的技术方面，并讨论了如何追踪调用、记录指标、报告事件或使用平台和库提供的自动收集遥测数据。在这里，我们将讨论实施可观测性解决方案的组织方面。

首先，我们将探讨改变现有解决方案的好处和原因，并讨论相关的成本。然后，我们将通过实施阶段并制定一个简要概述。最后，我们将看看如何利用可观测性来推动和改进开发过程。

在本章中，你将学习以下内容：

+   决定你是否需要一个更好的可观测性解决方案以及适合你的级别

+   制定一个入职计划并开始实施

+   使用可观测性帮助处理日常开发任务

到本章结束时，你应该准备好为你的组织提出一个可观测性解决方案和入职计划。

# 理解可观测性的重要性

如果你正在阅读这本书，你很可能至少在考虑改善你应用程序的可观测性故事。也许很难理解客户如何使用你的系统，或者当有人报告问题时，理解到底发生了什么可能需要花费很多时间。在最坏的情况下，可能需要花费很多时间才能注意到系统不健康并且用户受到影响。或者，也许你希望在未来项目中最小化此类风险。

在任何情况下，这些痛点让你来到这里，它们应该指导你进一步找到适合你系统的正确可观测性级别和方法。

即使我们可以清楚地看到问题以及如何通过更好的可观测性来解决它，我们通常仍然需要让其他正在系统上工作的人接受这个愿景。令人惊讶的是，他们可能对同样的问题有不同的看法，并且可能认为它们不值得解决。

让我分享一些我听到的常见观点，认为问题并不重要：

+   当客户报告问题时，我们可以要求提供时间戳，并通过客户标识符找到当时的服务操作。然后我们可以找到任何可疑的日志，获取请求 ID，然后在其他服务上找到相关的日志。

+   当我们在生产中看到问题时，我们会打开相关的仪表板，并开始直观地关联指标，直到我们可以猜测出什么出了问题，然后减轻它。我们有一支专家团队和一套优秀的运行手册来处理典型问题。

+   我们可以进行用户研究或客户研究，以获取有关人们如何使用系统的广泛信息。

+   我们要求客户启用详细日志并重现问题，然后将日志发送给我们，我们将根据我们对系统的专业知识来解析这些日志。

注意

这些方法都是完全有效的。它们*已经*解决了问题，你的团队*已经*知道如何使用它们，而且其中一些即使在完美的可观测性解决方案中也是必要的并且非常有用。

因此，本质上，当我们考虑观察力的方法时，我们需要打破现状，并说服自己和我们的组织，这是值得的。为了实现这一点，我们首先需要清楚地概述痛点并了解保持现状的成本。

## 观察力不足的成本

您的组织可能已经建立了一些常见的指标来衡量事件，我们可以依赖这些指标，例如**MTTM**（平均缓解时间），**MTTR**（平均恢复时间），**MTBF**（平均故障间隔时间），或其他指标。它们在一定程度上是主观的，取决于什么构成事件，或者恢复意味着什么，但大致显示了我们可以多快地调查事件以及它们发生的频率。

如果事件需要花费大量时间来解决并且频繁发生，那么很可能我们的组织对这些事件非常关心，并且有兴趣改善这种情况。

具有讽刺意味的是，我们需要至少达到一定程度的观察力才能注意到事件的发生并测量解决事件所需的时间。如果我们连这一点都没有，我们可以开始手动跟踪事情何时出错以及我们花费多少时间来发现和解决问题。尽管它可能很主观，但总比没有好。

有些事情并没有直接出现在这些指标中：您的值班体验有多糟糕？在某人能够独立值班之前，入职需要花费多少时间？有多少问题最终以“无法重现”、“信息不足”、“可能是网络或硬件错误”等方式关闭；在团队之间打乒乓球；或者被移至待办事项列表中，永远无法解决？

测量一些这样的东西应该是可行的。例如，我们可以标记由于缺乏遥测而无法进一步调查的问题。如果这些问题代表了您错误报告的很大一部分，那么这值得改进。

作为团队，你们还可以进行一周或两周的实验，大致测量调查问题所花费的时间。当有足够的数据时，调查需要花费多少时间？或者，由于缺乏遥测或发现微不足道的短暂网络问题，调查问题并遇到死胡同浪费了多少时间？

通过最小化找到问题根本原因所需的时间，我们提高了用户体验。我们更早地注意到事件并更快地解决它们。我们还改善了我们的工作与生活平衡，并专注于创造性工作，而不是在日志中搜索兆字节的日志。

注意

可能还有其他数据，例如业务分析、支持统计、公开评论或其他任何东西，表明由于未解决的技术问题，有显著数量的用户正在离开我们。如果您需要说服您的组织投资于观察力，找到这样的数据并展示更好的观察力故事如何改善情况，这可能是一个好的方法。

因此，第一步是了解当前的工具和流程是否有效，并对更好的可观察性如何改善事物有一个大致的了解。下一步是了解解决方案的成本。

## 可观察性解决方案的成本

我们可以将成本大致分为两组：实施和遥测后端成本。

我们需要添加仪表，调整和定制遥测收集，学习如何使用新工具，创建警报和仪表板，并围绕它们建立新的流程。当引入一个成熟且稳定的系统时，我们还应该考虑风险——我们可能会破坏某些东西，使其暂时变得不太可靠。

如我们在*第九章*“最佳实践”中讨论的那样，我们总是可以选择详细程度和定制化程度，以帮助我们控制成本在预算范围内。

最小化方法是从网络级别的自动仪表化开始，为积极开发的服务添加上下文、定制和手动仪表化。

通过使用 OpenTelemetry 和共享仪表化库，我们还可以依赖供应商为我们提供常见的可视化、警报、仪表板、查询和分析，对于典型技术来说，几乎可以免费开始。

### 遥测后端

我们可以自己托管可观察性堆栈或使用可用的平台之一。无论如何，使用该解决方案都会产生相关的持续成本。

这些成本取决于遥测量、保留期、服务和服务实例的数量以及许多其他因素，包括支持计划。

在整本书中，我们讨论了如何在保持系统足够可观察以满足我们需求的同时优化遥测收集：跟踪可以采样，指标应该具有低基数，事件和日志也可以采样或保存在冷存储但已索引的存储中。

尝试几个不同的后端是一个好主意——幸运的是，许多平台都有免费层或试用期，最重要的是，你可以使用 OpenTelemetry 一次性对系统进行仪表化，并将数据泵入多个后端以比较体验，并了解使用它们的成本。一旦你开始依赖特定的后端进行警报或日常任务，切换供应商就会变得更加困难。

在这个实验中，你还将更好地理解必要的数据保留期、采样率以及其他参数，并将能够与供应商一起选择它们。

注意

当在规模下运行现代云应用时，没有可观察性解决方案是无法操作的，因此问题不在于你是否需要它，而在于你需要收集多少细节，以及哪个可观察性供应商最适合你的系统和预算。

实际上，我们可以从小处着手，逐步调整收集以添加或删除细节，同时保持它在合理的预算内。

我们还应该定义成功意味着什么——它可能是一个 MTTR 改善，主观的用户体验，值班工程师的满意度，对你组织来说任何其他重要的事情，或者这些的组合。

现在我们来更多地讨论实施细节，并尝试让这次旅程不那么痛苦。

# 入门流程

系统各部分分布式跟踪和可见性的需求源于现代应用的复杂性。例如，我们需要知道无服务器环境如何与云存储交互，以便调试配置问题或优化性能。或者，我们可能想知道为什么某些请求在下游服务中失败，而不需要别人帮忙。

为了充分利用分布式跟踪，我们必须将整个系统（或至少其重要部分）纳入，确保所有服务创建相关且一致的遥测数据，将其写入不同团队可以访问的地方，并重用相同的工具进行分析。

因此，实施可观察性解决方案是一个组织范围内的努力，从对系统一小部分进行仪表化的试点项目开始是有意义的。让我们概述其范围和目标。

## 试点阶段

本项目的目标是获得对可观察性的实际经验，尽早发现任何重大的技术或流程问题，并更好地理解整个系统的范围和所需的工作量。

我们需要几个（至少两个）服务来开始仪表化：

+   正在积极开发中

+   互相交互

+   没有或只有很少的内部依赖，除了相互之间

+   有团队在紧密合作地工作

从技术角度来看，我们将利用这个阶段做出以下决定：

+   **仪表化 SDK**：我希望我已经说服你使用 .NET 平台功能和 OpenTelemetry，但你可能需要决定如何处理现有的仪表化代码和工具。

+   **上下文传播标准**：使用 W3C Trace Context 是一个好的开始。我们可能还需要决定是否以及如何传播负载，或者如何通过非 HTTP/专有协议传递上下文。

+   **采样策略**：基于速率、基于百分比、基于父级、基于尾部——这些都是早期决定的好事情，并确定你是否需要 OpenTelemetry 收集器或可以依赖可观察性供应商。

+   **选择哪个供应商以及从当前供应商迁移的计划**：在 *第十五章* 的 *仪表化* *现有应用程序* 中，我们将讨论仪表化现有系统时的技术方面和权衡。

到试点阶段结束时，我们应该清楚地了解入门需要什么，挑战是什么，以及我们将如何解决它们。

我们还将对系统的一部分进行仪表化——这是一个检查是否看到任何改进的好时机。

### 跟踪进度

在理想的世界里，在配置部署之后，我们能够立即解决所有事件，并调查我们几个月来一直在追踪的复杂错误。我希望情况是这样的。

在这个过程中至少有几个挑战：

+   **改变是困难的**：人们更喜欢使用他们熟悉的工具，尤其是在处理生产中的事件时。在事件解决后，用新的可观察性解决方案进行相同的调查，并比较经验，这将是一个很好的练习。

最好在开发时间或调查低优先级故障时开始尝试新工具。无论如何，了解和信任新工具需要时间和实践。

+   **你会发现新的问题**：第一次查看跟踪或服务图时，我总是能从我的代码中学到一些新东西。发现意外的外部系统调用（例如，在底层进行的身份验证调用）、不必要的网络调用、错误的重试逻辑、本应并行运行的调用却顺序执行，等等，这些都是常见的情况。

+   **基本的自动配置不足以满足需求**：没有应用程序上下文或对某些库和场景的手动配置，我们找到、理解和汇总相关遥测数据的能力受到限制。

需要几次迭代才能看到改进——请确保收集反馈并了解哪些有效，哪些无效。

这也需要时间和奉献。演示、成功案例、共享案例研究和如何开始的文档应该提高人们的意识，并帮助他们更快地好奇和学习。

### 迭代

因此，在初始配置之后，我们还没有完全准备好将其推广到整个系统中。首先需要做几件事情：

+   **调整配置库**：移除冗长和嘈杂的信号或启用默认关闭的有用属性。如果您的堆栈中某些部分没有可用的自动配置，请开始编写自己的配置。

+   **添加必要的应用程序上下文**：找到共同属性并在整个组织中标准化属性名称或行李键将对未来产生巨大影响。我们将在*第十四章*中更多地讨论它，*创建您的* *自己的约定*。

+   **开始构建特定于后端的工具**：警报、仪表板和工作簿将帮助我们验证我们是否有足够的上下文和遥测数据来运行我们的系统并迁移到新解决方案。

注意

到这个阶段结束时，你应该能够看到积极的成果。可能还不足以对整个系统产生显著影响，并且可能没有足够的数据来支持实验中的服务，但至少你应该看到一些成功的案例，并能够展示新解决方案的亮点。

如果你看到新可观察性故事应该有所帮助但并未帮助的情况，那么调查原因并进一步调整仪表化是一个好主意。在迭代过程中，还值得注意后端成本，并在看到潜在的重大减少而没有明显影响的情况下优化遥测收集。

这里的目标是创建一个足够好的仪表化方法及其周围必要的工具。我们快速迭代并保持参与服务的数量较小，这样我们仍然可以改变方向并做出破坏性更改。

一旦我们完成了所有决策，并在系统的小部分上实施和验证了它们，我们就应该能够依赖新的可观察性解决方案来满足大部分的监控和调试需求。在我们推出它们之前，我们仍然需要记录它们并创建可重用的工件。

### 记录和标准化。

试点阶段的主要成果是明确如何使系统的其余部分可观察，以及它将带来的具体好处。

为了最大化这一阶段的影响，我们需要让其他服务更容易上线。我们可以通过以下方式帮助他们：

+   记录新的解决方案和流程。

+   提供演示和入门指南，展示如何使用后端并对其进行配置，以及添加警报和仪表板。

+   生成包含任何自定义的通用工件：

    +   上下文传播器、采样器或仪表化。

    +   属性名称或高效填充它们的辅助工具。

    +   带来所有 OpenTelemetry 依赖项的入门包，并统一启用遥测收集。

    +   通用配置选项。

最后，我们准备好对系统的其余部分进行仪表化和上线。可能需要一些时间来对齐属性名称、配置或后端计划。我们还需要继续跟踪向原始目标的进展，并在事情不顺利时应用必要的更改。让我们谈谈可能让我们放慢脚步的一些事情。

## 避免陷阱。

分布式跟踪和可观察性的挑战在于，它们在分布式应用程序产生一致的信号时最为有效：跟踪上下文被传播，采样算法对齐以生成完整跟踪，所有信号使用相同的属性名称，等等。

虽然 OpenTelemetry 解决了这些担忧中的大部分，但它仍然依赖于应用程序将所有部件组合在一起并使用一致的信号。对于大型组织来说，一个服务偏离标准就会破坏整个系统的相关性，这成为一个问题。

在系统上线时，以下是一些需要避免的事项：

+   **起点过大**：如果多个团队独立进行仪表化工作，他们不可避免地会开发出针对其服务优化的不同解决方案。在上线后对解决方案进行对齐本身就是一个艰巨的项目。每个团队都会有这样的印象，即事情对他们来说都奏效，但端到端客户问题仍需数月才能解决。

+   **不在整个系统中共享遥测数据**：在调查问题或分析性能和用法时，能够看到其他服务如何处理请求是有益的。如果不这样做，我们最终会陷入每个跨服务问题都涉及一些 ping-pong，并且问题不能快速得到解决的地方。

+   **不强制执行标准**：不一致的遥测数据会使我们回到 grep 日志，并使客户和我们自己都不高兴。

+   **不使用新的工具和能力**：我们讨论了从熟悉的工具迁移是困难的。我们需要投入足够的努力来倡导、推广、解释、记录和改进事物，以确保人们使用它们。一旦新工具更强大且更快，淘汰旧工具（有时不受欢迎）是确保每个人都切换的一种方式。

+   **不在开发或测试时使用可观测性堆栈**：调查不可靠的测试是调试棘手问题的最便宜方式之一。跟踪信息可以帮助很多，所以请确保测试默认发送跟踪信息和日志，并且启用跟踪在开发机器上非常简单。

+   **构建难以使用或不可靠的事物**：虽然可以预期会有一些摩擦，但我们应确保大多数摩擦发生在试点阶段。如果你决定基于开源解决方案构建自己的可观测性堆栈，你应该预计某些事情，如跨工具导航，将会很困难，并且你需要投入相当多的努力来使它们可用。另一个大的投资是构建和维护可靠的遥测管道。

希望我们能避免这些问题中的大多数，并将系统的大部分功能上线到我们的新可观测性堆栈。

随着我们继续上线，我们应该看到向我们的初始目标迈进，可能需要调整它们。在这个过程中，我们可能对我们的系统有了很多了解，现在正在处理由于可观测性不足而之前无法看到的新的挑战。

旅程不会在这里结束。就像我们永远不会停止编写测试一样，我们应该在日常任务中融入并利用可观测性。

# 持续可观测性

可观测性不应该在服务或功能开发完成后才作为事后考虑。当在多个服务中实现复杂功能或添加新的外部依赖项时，我们不能依赖用户告诉我们何时出现故障。测试通常不会涵盖每个方面，也不能代表用户行为。

如果我们没有可靠的遥测信号，我们就无法说该功能是否工作，或者客户是否使用它。

## 将可观测性融入设计过程

确保我们有遥测数据是功能设计工作的一部分。遥测数据应该回答的主要问题是以下这些：

+   谁使用这个功能以及使用量有多大？

+   它是否工作？它是否破坏了其他东西？

+   它是否按预期工作？它是否按预期改进了事物？

如果我们可以依赖现有的遥测数据来回答这些问题，那就太棒了！

我们应该以一次覆盖多个内容的方式设计仪表化。例如，当我们从外部 HTTP 依赖项切换到新的依赖项时，我们可以利用现有的自动收集的跟踪和指标。一个常见的处理器会在所有跨度上打上应用程序上下文，从而处理新的依赖项的跟踪。

如果我们使用功能标志，我们应该确保记录它们在参与实验的操作的遥测中。例如，我们可以在事件或跨度上记录它们，遵循[`github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/semantic_conventions/feature-flags.md`](https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/semantic_conventions/feature-flags.md)中提供的 OpenTelemetry 语义约定。

在某些情况下，默认遥测可能不足，我们需要添加自定义事件、跟踪、指标，或者至少额外的属性。除非我们以结构化和可聚合的方式编写，否则限制仪表化到新的日志记录通常不是一个好主意。

一旦一个功能被证明是有用的并且完全推广，我们可能希望移除这个额外的遥测以及功能标志。如果我们确信它不再必要，这是一个很好的方法。清理和迭代仪表化是另一个重要的方面。

## 清理工作

就像任何其他代码一样，当忽视时，仪表化代码会退化并变得不那么有用。

与测试代码类似，我们编写的任何可观察性代码都比应用程序代码不可靠——当它报告错误时也难以注意到，因为没有功能性问题。因此，通过测试或手动检查来验证它并及时修复它是很重要的。

这是使用流行的仪表化库的一个原因——它们已经经过了其他人的过度测试。保持您的仪表化库更新，并在公司内部（或开源）共享自定义库，这将导致更好的仪表化质量。

另一个重要部分是在注意到问题时进行小的改进：添加缺失的事件、跨度属性（不要忘记检查是否有共同的属性），结构化和优化日志，并调整它们的详细程度。

这些更改可能会有风险。我们可能会移除人们用于警报或分析所依赖的内容。可能会有一些额外的防护措施来防止这种情况发生——代码审查、文档和测试，但很少可能考虑到所有情况，因此在删除或重命名内容时要谨慎。

另一个风险是添加一些昂贵或冗长的内容，这可能会影响应用程序的可用性，压倒遥测管道，或者显著增加您的可观察性账单。关注开发和测试遥测以及了解热点路径应该可以防止明显的错误。

建立具有速率限制的可靠遥测管道可以在它们进入生产时降低此类事件的严重性。

如您所见，可观测性代码与其他任何基础设施代码并没有很大区别。实施它始于一些研究和实验，并且在我们与应用程序一起调整和改进时效果最佳。

# 摘要

在本章中，我们讨论了如何在您的组织中实施和推广可观测性解决方案。这些努力可以通过当前监控基础设施在调查和解决客户问题时效率不高来激发和证明其合理性。

我们讨论了如何依靠现有的指标或数据来了解是否还有改进的空间，并估计不采取行动的成本。然后我们研究了实施和运行现代可观测性解决方案的常见成本——最简单的方法是运行一个小实验并比较不同的供应商。

我们探讨了如何通过在一个系统的小部分上启动试点项目，并在推广到整个系统之前迭代和验证结果，来着手进行入职。最后，我们讨论了将可观测性融入日常任务并随着代码一起演化的重要性。

本章应有助于您证明初始可观测性投资的合理性，并逐步在整个系统中实施解决方案。在下一章中，我们将更多地讨论统一遥测收集和引入您自己的标准。

# 问题

1.  我们应该寻找一个用于所有遥测信号的单一后端，还是寻找针对单个遥测信号优化的它们的组合？

1.  您将如何处理在您的系统中标准化行李传播和使用的标准化？

1.  您正在向服务中添加缓存。您何时会添加仪表？您将如何处理？

# 进一步阅读

+   *《成为摇滚明星 SRE》*，作者：Jeremy Proffitt 和 Rod Anami
