<html><head></head><body>
  <div><h1 class="chapterNumber">3</h1>
    <h1 class="chapterTitle" id="_idParaDest-127">Building Entity Models for SQL Server Using EF Core</h1>
    <p class="normal">This chapter is about managing relational data stored in SQL Server, Azure SQL Database, or Azure SQL Edge<a id="_idIndexMarker212"/> by using the higher-level object-to-data store mapping technology named <strong class="keyWord">Entity Framework Core</strong> (<strong class="keyWord">EF Core</strong>). Then, you will learn how to store entity models that use inheritance hierarchies using three different mapping strategies. Finally, you will build class libraries for a SQL Server database that will be used in code examples throughout the rest of this book.</p>
    <p class="normal">This chapter will cover the following topics:</p>
    <ul>
      <li class="bulletList">Managing SQL Server data with EF Core</li>
      <li class="bulletList">Mapping inheritance hierarchies with EF Core</li>
      <li class="bulletList">Building a reusable entity data model</li>
    </ul>
    <h1 class="heading-1" id="_idParaDest-128">Managing data with EF Core</h1>
    <p class="normal">EF Core is an <strong class="keyWord">object-relational mapper </strong>(<strong class="keyWord">ORM</strong>) that uses ADO.NET underneath when working with<a id="_idIndexMarker213"/> SQL Server. Because<a id="_idIndexMarker214"/> it is a higher-level<a id="_idIndexMarker215"/> technology, it is not as efficient as using ADO.NET directly, but it can be easier for developers to work with because they can treat the data as objects instead of rows in multiple tables. This should feel more natural for an object-oriented developer.</p>
    <p class="normal">EF Core 8 only<a id="_idIndexMarker216"/> targets .NET 8. EF Core 7 targeted .NET 6, so it could<a id="_idIndexMarker217"/> be used with both the <strong class="keyWord">Long Term Support</strong> (<strong class="keyWord">LTS</strong>) release of .NET 6 and the <strong class="keyWord">Standard Term Support</strong> (<strong class="keyWord">STS</strong>) release of.NET 7, as shown in <em class="italic">Figure 3.1</em>:</p>
    <figure class="mediaobject"><img alt="" src="img/B19587_03_01.png"/></figure>
    <p class="packt_figref">Figure 3.1: EF Core 7 targeted .NET 6 or later</p>
    <p class="normal">When EF Core 9 is released<a id="_idIndexMarker218"/> in November 2024, we can expect it to target .NET 8 or later, so you<a id="_idIndexMarker219"/> can upgrade EF Core while still getting long-term support for the .NET 8 platform. The EF Core team is responsible for making sure that you will be able to swap 8 for 9 in the version number of their packages and your code should still work. They are usually very good at that, and they will document any needed changes to your code in the official release notes for EF Core 9.</p>
    <h2 class="heading-2" id="_idParaDest-129">Understanding Entity Framework Core</h2>
    <p class="normal">As well as traditional RDBMSs like SQL<a id="_idIndexMarker220"/> Server, EF Core supports modern cloud-based, nonrelational, schema-less data stores, such as Azure Cosmos DB and MongoDB, sometimes with third-party providers.</p>
    <p class="normal">There are two approaches<a id="_idIndexMarker221"/> to working with EF Core:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Database First</strong>: A database already exists, so you build a model that matches its structure and features.</li>
      <li class="bulletList"><strong class="keyWord">Code First</strong>: No database exists, so you build a model and then use EF Core to create a database that matches its structure and features.</li>
    </ul>
    <p class="normal">We will use EF Core with an existing database because that is the most common scenario. You will also see an example of Code First later in this chapter that will create its database at runtime.</p>
    <h2 class="heading-2" id="_idParaDest-130">Scaffolding models using an existing database</h2>
    <p class="normal">Scaffolding is the process of using a tool<a id="_idIndexMarker222"/> to create classes that represent the model of an existing database <a id="_idIndexMarker223"/>using reverse engineering. A good scaffolding tool allows you to extend the automatically generated classes and then regenerate those classes without losing your extended classes.</p>
    <p class="normal">If you know that you will never regenerate the classes using the tool, then feel free to change the code for the automatically generated classes as much as you want. The code generated by the tool is just the best approximation.</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Do not be afraid to overrule a tool when you know better. For example, when using SQLite for the Northwind database, date/time columns are mapped to <code class="inlineCode">string</code> properties, and <code class="inlineCode">money</code> columns are mapped to <code class="inlineCode">double</code> properties. In the Northwind database, these would be better mapped to <code class="inlineCode">DateTime</code> and <code class="inlineCode">decimal</code> respectively, but in another database, they might need more flexibility. As another example, in the Northwind database, a <code class="inlineCode">CustomerId</code> should always be five uppercase alphabetic characters. The tool cannot infer this automatically, so you could add a regular expression to validate it. Keep in mind that tool behavior is one of the more volatile components of .NET, so these examples may not be valid by the time you read this book.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-131">Setting up the dotnet-ef tool</h2>
    <p class="normal">.NET has a command-line tool<a id="_idIndexMarker224"/> named <code class="inlineCode">dotnet</code>. It can be extended with capabilities useful for working with EF Core. It can perform design-time tasks like creating and applying migrations from an older model to a newer model and generating code for a model from an existing database.</p>
    <p class="normal">The <code class="inlineCode">dotnet</code> <code class="inlineCode">ef</code> command-line tool is not automatically installed. You must install this package as either a <strong class="keyWord">global</strong> or <strong class="keyWord">local tool</strong>. If you have already installed an older version of the tool, then you should uninstall any existing version.</p>
    <p class="normal">Let’s make sure you have the latest version of the tool installed:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">At a command prompt or terminal, check if you have already installed <code class="inlineCode">dotnet-ef</code> as a global tool, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet tool list --global
</code></pre>
      </li>
      <li class="numberedList">Check in the list if an older version of the tool has been installed, like the one for .NET 7, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Package Id                            Version      Commands
-----------------------------------------------------------------
dotnet-ef                             7.0.0        dotnet-ef
microsoft.web.librarymanager.cli      2.1.175      libman
redth.net.maui.check                  0.5.6        maui-check
</code></pre>
      </li>
      <li class="numberedList">If an older version is already installed, then uninstall the tool, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet tool uninstall --global dotnet-ef
</code></pre>
      </li>
      <li class="numberedList">Install the latest version, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet tool install --global dotnet-ef
</code></pre>
      </li>
      <li class="numberedList">If necessary, follow any OS-specific instructions to add the <code class="inlineCode">dotnet tools</code> directory to your <code class="inlineCode">PATH</code> environment variable, as described in the output of installing the <code class="inlineCode">dotnet-ef</code> tool.
    <div><p class="normal">If you want to install a preview version, you can specify a version wildcard, for example, for EF Core 9 previews, as shown in the following command:</p>
      <p class="programlisting con"><code class="hljs-con">dotnet tool install --global dotnet-ef --version 9-*</code></p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Instead of uninstalling<a id="_idIndexMarker225"/> and then installing, you can update using the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet tool update --global dotnet-ef
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-132">Defining EF Core models</h2>
    <p class="normal">EF Core uses<a id="_idIndexMarker226"/> a combination of <strong class="keyWord">conventions</strong>, <strong class="keyWord">annotation attributes</strong>, and <strong class="keyWord">Fluent API</strong> statements to build an <strong class="keyWord">entity model</strong> at runtime so that any actions performed on the classes<a id="_idIndexMarker227"/> can later be automatically translated into actions performed on the actual database. An <strong class="keyWord">entity class</strong> represents the structure of a table, and an instance of the class<a id="_idIndexMarker228"/> represents a row in that table.</p>
    <p class="normal">First, we will review the three ways to define a model, with code examples, and then we will create some classes that implement those techniques.</p>
    <h2 class="heading-2" id="_idParaDest-133">Using EF Core conventions to define the model</h2>
    <p class="normal">The code we will write<a id="_idIndexMarker229"/> will use the following<a id="_idIndexMarker230"/> conventions:</p>
    <ul>
      <li class="bulletList">The name of a table is assumed to match the name of a <code class="inlineCode">DbSet&lt;T&gt;</code> property in the <code class="inlineCode">DbContext</code> class, for example, <code class="inlineCode">Products</code>.</li>
      <li class="bulletList">The names of the columns are assumed to match the names of properties in the entity model class, for example, <code class="inlineCode">ProductId</code>.</li>
      <li class="bulletList">The <code class="inlineCode">string</code> .NET type is assumed to be an <code class="inlineCode">nvarchar</code> type in the database.</li>
      <li class="bulletList">The <code class="inlineCode">int</code> .NET type is assumed to be an <code class="inlineCode">int</code> type in the database.</li>
      <li class="bulletList">The primary key is assumed to be a property that is named <code class="inlineCode">Id</code> or <code class="inlineCode">ID</code>. Or, when the entity model class is named <code class="inlineCode">Product</code>, then the property can be named <code class="inlineCode">ProductId</code> or <code class="inlineCode">ProductID</code>. If this property is of an integer type or the <code class="inlineCode">Guid</code> type, then it is also assumed to be an <code class="inlineCode">IDENTITY</code> column (a column type that automatically assigns a value when inserting).</li>
    </ul>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: There are many other conventions that you should know, and you can even define your own, but that is beyond the scope of this book. You can read about<a id="_idIndexMarker231"/> them at the following link: <a href="https://learn.microsoft.com/en-us/ef/core/modeling/">https://learn.microsoft.com/en-us/ef/core/modeling/</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-134">Using EF Core annotation attributes to define the model</h2>
    <p class="normal">Conventions often aren’t enough to completely<a id="_idIndexMarker232"/> map the classes to the database<a id="_idIndexMarker233"/> objects. For example, some databases like SQLite use dynamic column types so the tool has to guess about what property types its columns should map to, based on the current data values in that column.</p>
    <p class="normal">A simple way of adding more smarts to your model is to apply annotation attributes, as shown in <em class="italic">Table 3.1</em>:</p>
    <table class="table-container" id="table001-2">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Attribute</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Description</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[Required]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Ensures the value is not null.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[StringLength(50)]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Ensures the value is up to 50 characters in length.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[RegularExpression(expression)]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Ensures the value matches the specified regular expression.</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">[Column(TypeName = "money", Name = "UnitPrice")]</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">Specifies the column type and column name used in the table.</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.1: Common EF Core annotation attributes</p>
    <p class="normal">For example, in the database, the maximum length of a product name is 40, and the value cannot be null, as shown highlighted in the following partial DDL code, which defines how to create a table named <code class="inlineCode">Products</code>:</p>
    <pre class="programlisting code"><code class="hljs-code">CREATE TABLE Products (
    ProductId       INTEGER       PRIMARY KEY,
    <strong class="hljs-slc">ProductName     NVARCHAR (</strong><strong class="hljs-number-slc">40</strong><strong class="hljs-slc">) </strong><strong class="hljs-keyword-slc">NOT</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">NULL</strong><strong class="hljs-slc">,</strong>
    SupplierId      "INT",
    ...
);
</code></pre>
    <p class="normal">In a <code class="inlineCode">Product</code> class, we could apply attributes to specify this, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">[Required] 
[StringLength(40)]
public string ProductName { get; set; }
</code></pre>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: If you have nullability checks enabled, then you do not need to decorate a non-nullable reference type with the <code class="inlineCode">[Required]</code> attribute as shown above. This is because the C# nullability will flow to the EF Core model. A <code class="inlineCode">string</code> property<a id="_idIndexMarker234"/> will be required; a <code class="inlineCode">string?</code> property will be optional, in other words, nullable. You can read more about this at the following link: <a href="https://learn.microsoft.com/en-us/ef/core/modeling/entity-properties?tabs=data-annotations%2Cwith-nrt#required-and-optional-properties">https://learn.microsoft.com/en-us/ef/core/modeling/entity-properties?tabs=data-annotations%2Cwith-nrt#required-and-optional-properties</a>.</p>
    </div>
    <p class="normal">When there isn’t an obvious map between .NET types and database types, an attribute can be used.</p>
    <p class="normal">For example, in the database, the column<a id="_idIndexMarker235"/> type of <code class="inlineCode">UnitPrice</code> for the <code class="inlineCode">Products</code> table<a id="_idIndexMarker236"/> is <code class="inlineCode">money</code>. .NET does not have a <code class="inlineCode">money</code> type, so it should use <code class="inlineCode">decimal</code> instead, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">[Column(TypeName = "money")]
public decimal? UnitPrice { get; set; }
</code></pre>
    <p class="normal">Another example is for the <code class="inlineCode">Categories</code> table, as shown highlighted in the following DDL code:</p>
    <pre class="programlisting code"><code class="hljs-code">CREATE TABLE Categories (
    CategoryId   INTEGER       PRIMARY KEY,
    CategoryName NVARCHAR (15) NOT NULL,
    <strong class="hljs-slc">Description  "NTEXT",</strong>
    Picture      "IMAGE"
);
</code></pre>
    <p class="normal">The <code class="inlineCode">Description</code> column can be longer than the maximum 8,000 characters that can be stored in an <code class="inlineCode">nvarchar</code> variable, so it needs<a id="_idIndexMarker237"/> to map to <code class="inlineCode">ntext</code> instead, as shown<a id="_idIndexMarker238"/> in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">[Column(TypeName = "ntext")]
public string? Description { get; set; }
</code></pre>
    <h2 class="heading-2" id="_idParaDest-135">Using the EF Core Fluent API to define the model</h2>
    <p class="normal">The last way that the model<a id="_idIndexMarker239"/> can be defined is by using the Fluent API. This API<a id="_idIndexMarker240"/> can be used instead of attributes, as well as being used in addition to them. One reason you might need to do this is if the entity models need to be defined in a .NET Standard 2.0 class library so they can be used on legacy platforms. In this case, the class library should not include references to data annotation libraries. Another reason is that your team might have a policy to separate raw data models from validation rules. </p>
    <p class="normal">For example, to define the <code class="inlineCode">ProductName</code> property, instead of decorating the property with two attributes, an equivalent Fluent API statement could be written in the <code class="inlineCode">OnModelCreating</code> method of the database context class, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">modelBuilder.Entity&lt;Product&gt;()
  .Property(product =&gt; product.ProductName)
  .IsRequired() // only needed if you have disabled nullability checks
  .HasMaxLength(40);
</code></pre>
    <p class="normal">This keeps the entity model class simpler. You will see an example of this in the coding task below.</p>
    <h2 class="heading-2" id="_idParaDest-136">Understanding data seeding with the Fluent API</h2>
    <p class="normal">Another benefit of the Fluent API<a id="_idIndexMarker241"/> is to provide initial data to populate a database. EF Core<a id="_idIndexMarker242"/> automatically works out what insert, update, or delete operations must be executed.</p>
    <p class="normal">For example, if we wanted to make sure that a new database has at least one row in the <code class="inlineCode">Product</code> table, then we would call the <code class="inlineCode">HasData</code> method, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">modelBuilder.Entity&lt;Product&gt;()
  .HasData(new Product
  {
    ProductId = 1,
    ProductName = "Chai",
    UnitPrice = 8.99M
  });
</code></pre>
    <p class="normal">Calls to <code class="inlineCode">HasData</code> take effect either during a data migration executed by the <code class="inlineCode">dotnet ef database update</code> command or when you call the <code class="inlineCode">Database.EnsureCreated</code> method.</p>
    <p class="normal">Our model will map to an existing<a id="_idIndexMarker243"/> database that is already populated with data, so we will not need<a id="_idIndexMarker244"/> to use this technique in our code.</p>
    <h2 class="heading-2" id="_idParaDest-137">Defining the Northwind database model</h2>
    <p class="normal">A <code class="inlineCode">Northwind</code> class will be used to represent<a id="_idIndexMarker245"/> the database. To use EF Core, the class must inherit from <code class="inlineCode">DbContext</code>. This class understands how to communicate with databases and dynamically generate SQL statements to query and manipulate data.</p>
    <p class="normal">Your <code class="inlineCode">DbContext</code>-derived class should have an overridden method named <code class="inlineCode">OnConfiguring</code>, which will set the database connection string.</p>
    <p class="normal">Inside your <code class="inlineCode">DbContext</code>-derived class, you must define at least one property of the <code class="inlineCode">DbSet&lt;T&gt;</code> type. These properties represent the tables. To tell EF Core what columns each table has, the <code class="inlineCode">DbSet&lt;T&gt;</code> properties use generics to specify a class that represents a row in the table. That entity model class has properties that represent its columns.</p>
    <p class="normal">The <code class="inlineCode">DbContext</code>-derived class can optionally have an overridden method named <code class="inlineCode">OnModelCreating</code>. This is where you can write Fluent API statements as an alternative to decorating your entity classes with attributes. This can enhance the clarity and maintainability of the model configuration because all of it could be in one place instead of scattered throughout your code base. You can also mix and match both techniques, but then you’d lose this primary benefit.</p>
    <div><p class="normal">If you did not create the Northwind database, or if you deleted it, then you will need to create it now. Instructions are in <em class="chapterRef">Chapter 2, Managing Relational Data Using SQL Server</em>.</p>
    </div>
    <p class="normal">Let’s build the model for the Northwind database in a console app:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to create a console app project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Console App</strong> / <code class="inlineCode">console</code>.</li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter03</code>.</li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Console.EFCore</code>.</li>
          <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared.</li>
          <li class="bulletList"><strong class="screenText">Enable native AOT publish</strong>: Cleared.</li>
        </ul>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Console.EFCore</code> project, add package references to the EF Core data provider for SQL<a id="_idIndexMarker246"/> Server, and globally and statically import the <code class="inlineCode">System.Console</code> class, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference
    Include="Microsoft.EntityFrameworkCore.Design" 
    Version="8.0.0" /&gt;
  &lt;PackageReference
    Include="Microsoft.EntityFrameworkCore.SqlServer" 
    Version="8.0.0" /&gt;
&lt;/ItemGroup&gt;
&lt;ItemGroup&gt;
  &lt;Using Include="System.Console" Static="true" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the project to restore packages.
    <div><p class="normal">The next step assumes a database connection string for a local SQL Server authenticated with Windows integrated security. Modify it for Azure SQL Database or Azure SQL Edge with a user ID and password if necessary.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">At a command prompt or terminal in the <code class="inlineCode">Northwind.Console.EFCore</code> folder, generate a model for all the tables in a new folder named <code class="inlineCode">Models</code>, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet ef dbcontext scaffold "Data Source=.;Initial Catalog=Northwind;Integrated Security=true;TrustServerCertificate=true;" Microsoft.EntityFrameworkCore.SqlServer --output-dir Models --namespace Northwind.Models --data-annotations --context NorthwindDb
</code></pre>
      
    <div><p class="normal">Command-line tools need to have their commands entered all in one line. The <code class="inlineCode">dotnet-ef</code> tool often needs long commands to be entered. I recommend that you type from the print book or copy and paste long commands like this from the eBook into a plain text editor like Notepad. Then make sure that the whole command is properly formatted as a single line with correct spacing before you then copy and paste it to the command line. Copying and pasting directly from the eBook is likely to include newline characters, missing spaces, and so on that break the command. All command lines that must be entered from this book are available to copy from as a single line at the following link: <a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/command-lines.md">https://github.com/markjprice/apps-services-net8/blob/main/docs/command-lines.md</a>.</p>
    </div>
    <p class="normal">Note the following:</p>
    <ul>
      <li class="bulletList">The command<a id="_idIndexMarker247"/> action: <code class="inlineCode">dbcontext scaffold</code>.</li>
      <li class="bulletList">The connection string: This will be different depending on whether you are connecting to a local SQL Server (with or without an instance name) or Azure SQL Database.</li>
      <li class="bulletList">The database provider: <code class="inlineCode">Microsoft.EntityFrameworkCore.SqlServer</code>.</li>
      <li class="bulletList">The output folder: <code class="inlineCode">--output-dir Models</code>.</li>
      <li class="bulletList">The namespace: <code class="inlineCode">--namespace Northwind.Models</code>.</li>
      <li class="bulletList">The use of data annotations as well as the Fluent API: <code class="inlineCode">--data-annotations</code>.</li>
      <li class="bulletList">Renaming the context from <code class="inlineCode">[database_name]Context</code>: <code class="inlineCode">--context NorthwindDb</code>.</li>
    </ul></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Note the build messages and warnings, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Build started…
Build succeeded.
To protect potentially sensitive information in your connection string, you should move it out of source code. You can avoid scaffolding the connection string by using the Name= syntax to read it from configuration - see https://go.microsoft.com/fwlink/?linkid=2131148. For more guidance on storing connection strings, see http://go.microsoft.com/fwlink/?LinkId=723263.
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Do not commit your project to Git until you have fixed this warning. If you used a username and password to connect to your SQL Server database, then that information is now in your source code! We will fix this by replacing the fixed connection string with a dynamically generated one that reads the sensitive values from environment variables.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">Open the <code class="inlineCode">Models</code> folder<a id="_idIndexMarker248"/> and note the 28 class files that were automatically generated. </li>
      <li class="numberedList">Open <code class="inlineCode">Category.cs</code> and note that it represents a row in the <code class="inlineCode">Categories</code> table, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;
using Microsoft.EntityFrameworkCore;
namespace Northwind.Models;
[Index("CategoryName", Name = "CategoryName")]
public partial class Category
{
  [Key]
  public int CategoryId { get; set; }
  [StringLength(15)]
  public string CategoryName { get; set; } = null!;
  [Column(TypeName = "ntext")]
  public string? Description { get; set; }
  [Column(TypeName = "image")]
  public byte[]? Picture { get; set; }
  [InverseProperty("Category")]
  public virtual ICollection&lt;Product&gt; Products { get; set; } 
    = new List&lt;Product&gt;();
}
</code></pre>
      
    <p class="normal">Note the following:</p>
    <ul>
      <li class="bulletList">It decorates the entity class with the <code class="inlineCode">[Index]</code> attribute that was introduced in EF Core 5. This indicates properties that should have an index for its column in the table. In earlier versions, only the Fluent API was supported for defining indexes. Since we are working with an existing database, this attribute is not needed. But if we want to recreate a new empty Northwind database from our code, then this information will be used to create indexes in the <code class="inlineCode">Categories</code> table.</li>
      <li class="bulletList">The table name in the<a id="_idIndexMarker249"/> database is <code class="inlineCode">Categories</code> but the <code class="inlineCode">dotnet-ef</code> tool used the <strong class="keyWord">Humanizer</strong> third-party library to automatically singularize the class name to <code class="inlineCode">Category</code>, which is a more natural name when creating a single entity.</li>
      <li class="bulletList">The entity class is declared using the <code class="inlineCode">partial</code> keyword so that you can create a matching <code class="inlineCode">partial</code> class for adding additional code. This allows you to rerun the tool and regenerate the entity class without losing that extra code you wrote in your <code class="inlineCode">partial</code> class.</li>
      <li class="bulletList">The <code class="inlineCode">CategoryId</code> property is decorated with the <code class="inlineCode">[Key]</code> attribute to explicitly indicate that it is the primary key for this entity although its name follows the primary key convention too.</li>
      <li class="bulletList">The <code class="inlineCode">Products</code> property uses the <code class="inlineCode">[InverseProperty]</code> attribute to define the foreign key relationship to the <code class="inlineCode">Category</code> property on the <code class="inlineCode">Product</code> entity class.</li>
    </ul></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">Open <code class="inlineCode">ProductsAboveAveragePrice.cs</code> and note<a id="_idIndexMarker250"/> that it represents a row returned by a database view rather than a table, so it is decorated with the <code class="inlineCode">[Keyless]</code> attribute.</li>
      <li class="numberedList">Open <code class="inlineCode">NorthwindDb.cs</code> and review the class, as shown in the following edited-for-space code:
        <pre class="programlisting code"><code class="hljs-code">using System;
using System.Collections.Generic;
using Microsoft.EntityFrameworkCore;
namespace Northwind.Models;
public partial class NorthwindDb : DbContext
{
  public NorthwindDb()
  {
  }
  public NorthwindDb(DbContextOptions&lt;NorthwindDb&gt; options)
    : base(options)
  {
  }
  public virtual DbSet&lt;AlphabeticalListOfProduct&gt; 
    AlphabeticalListOfProducts { get; set; }
  public virtual DbSet&lt;Category&gt; Categories { get; set; }
...
  public virtual DbSet&lt;Territory&gt; Territories { get; set; }
  protected override void OnConfiguring(
    DbContextOptionsBuilder optionsBuilder)
#warning To protect potentially sensitive information in your connection string, you should move it out of source code. You can avoid scaffolding the connection string by using the Name= syntax to read it from configuration - see https://go.microsoft.com/fwlink/?linkid=2131148. For more guidance on storing connection strings, see http://go.microsoft.com/fwlink/?LinkId=723263.
        =&gt; optionsBuilder.UseSqlServer("Data Source=.;Initial Catalog=Northwind;Integrated Security=true;TrustServerCertificate=true;");
  protected override void OnModelCreating(ModelBuilder modelBuilder)
  {
    modelBuilder.Entity&lt;AlphabeticalListOfProduct&gt;(entity =&gt;
    {
      entity.ToView("Alphabetical list of products");
    });
...
    OnModelCreatingPartial(modelBuilder);
  }
  partial void OnModelCreatingPartial(ModelBuilder modelBuilder);
}
</code></pre>
     
    <p class="normal">Note the following:</p>
    <ul>
      <li class="bulletList">The <code class="inlineCode">NorthwindDb</code> data context<a id="_idIndexMarker251"/> class is <code class="inlineCode">partial</code> to allow you to extend it and regenerate it in the future. We used the name <code class="inlineCode">NorthwindDb</code> because <code class="inlineCode">Northwind</code> is used for a namespace.</li>
      <li class="bulletList"><code class="inlineCode">NorthwindDb</code> has two constructors: a default parameter-less one and one that allows options to be passed in. This is useful in apps where you want to specify the connection string at runtime.</li>
      <li class="bulletList">The <code class="inlineCode">DbSet&lt;T&gt;</code> properties that represent tables like <code class="inlineCode">Categories</code>.</li>
      <li class="bulletList">In the <code class="inlineCode">OnConfiguring</code> method, if options have not been specified in the constructor, then it defaults to using the connection string used during scaffolding. It has a compiler warning to remind you that you should not hardcode security information in this connection string.</li>
      <li class="bulletList">In the <code class="inlineCode">OnModelCreating</code> method, the Fluent API is used to configure the entity classes, and then a partial method named <code class="inlineCode">OnModelCreatingPartial</code> is invoked. This allows you to implement that partial method in your own partial <code class="inlineCode">Northwind</code> class to add your own Fluent API configuration, which will not be lost if you regenerate the model classes.</li>
    </ul> </li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">At the top of the <code class="inlineCode">NorthwindDb.cs</code> file, import the namespace for working with ADO.NET types, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Data.SqlClient; // To use SqlConnectionStringBuilder.
</code></pre>
      </li>
      <li class="numberedList">Modify the <code class="inlineCode">OnConfiguring</code> method to dynamically set the connection string and set any sensitive parameters using environment variables, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">protected override void OnConfiguring(
  DbContextOptionsBuilder optionsBuilder)
{
  if (!optionsBuilder.IsConfigured)
  {
    SqlConnectionStringBuilder builder = new();
    builder.DataSource = "."; // "ServerName\InstanceName" e.g. @".\sqlexpress"
    builder.InitialCatalog = "Northwind";
    builder.TrustServerCertificate = true;
    builder.MultipleActiveResultSets = true;
    // Because we want to fail faster. Default is 15 seconds.
    builder.ConnectTimeout = 3;
    // If using Windows Integrated authentication.
    builder.IntegratedSecurity = true;
    // If using SQL Server authentication.
    // builder.UserID = Environment.GetEnvironmentVariable("MY_SQL_USR");
    // builder.Password = Environment.GetEnvironmentVariable("MY_SQL_PWD");
    optionsBuilder.UseSqlServer(builder.ConnectionString);
  }
}
</code></pre>
      </li>
      <li class="numberedList">Close the automatically<a id="_idIndexMarker252"/> generated class files.</li>
    </ol>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: If you have not worked with environment variables before, then you can learn about them from an online section available at the following link: <a href="https://github.com/markjprice/cs12dotnet8/blob/main/docs/ch09-environment-variables.md">https://github.com/markjprice/cs12dotnet8/blob/main/docs/ch09-environment-variables.md</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-138">Querying the Northwind model</h2>
    <p class="normal">Now we can query<a id="_idIndexMarker253"/> the model:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Program.cs</code>, delete the existing statements. Add statements to create an instance of the <code class="inlineCode">NorthwindDb</code> data context class and use it to query the products table for those that cost more than a given price, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Data.SqlClient; // To use SqlConnectionStringBuilder.
using Microsoft.EntityFrameworkCore; // ToQueryString, GetConnectionString
using Northwind.Models; // To use NorthwindDb.
SqlConnectionStringBuilder builder = new();
builder.InitialCatalog = "Northwind";
builder.MultipleActiveResultSets = true;
builder.Encrypt = true;
builder.TrustServerCertificate = true;
builder.ConnectTimeout = 10;
WriteLine("Connect to:");
WriteLine("  1 - SQL Server on local machine");
WriteLine("  2 - Azure SQL Database");
WriteLine("  3 - Azure SQL Edge");
WriteLine();
Write("Press a key: ");
ConsoleKey key = ReadKey().Key;
WriteLine(); WriteLine();
if (key is ConsoleKey.D1 or ConsoleKey.NumPad1)
{
  builder.DataSource = "."; // Local SQL Server
  // @".\apps-services-book"; // Local SQL Server with an instance name
}
else if (key is ConsoleKey.D2 or ConsoleKey.NumPad2)
{
  builder.DataSource = // Azure SQL Database
    "tcp:apps-services-book.database.windows.net,1433";
}
else if (key is ConsoleKey.D3 or ConsoleKey.NumPad3)
{
  builder.DataSource = "tcp:127.0.0.1,1433"; // Azure SQL Edge
}
else
{
  WriteLine("No data source selected.");
  return;
}
WriteLine("Authenticate using:");
WriteLine("  1 - Windows Integrated Security");
WriteLine("  2 - SQL Login, for example, sa");
WriteLine();
Write("Press a key: ");
key = ReadKey().Key;
WriteLine(); WriteLine();
if (key is ConsoleKey.D1 or ConsoleKey.NumPad1)
{
  builder.IntegratedSecurity = true;
}
else if (key is ConsoleKey.D2 or ConsoleKey.NumPad2)
{
  Write("Enter your SQL Server user ID: ");
  string? userId = ReadLine();
  if (string.IsNullOrWhiteSpace(userId))
  {
    WriteLine("User ID cannot be empty or null.");
    return;
  }
  builder.UserID = userId;
  Write("Enter your SQL Server password: ");
  string? password = ReadLine();
  if (string.IsNullOrWhiteSpace(password))
  {
    WriteLine("Password cannot be empty or null.");
    return;
  }
  builder.Password = password;
  builder.PersistSecurityInfo = false;
}
else
{
  WriteLine("No authentication selected.");
  return;
}
DbContextOptionsBuilder&lt;NorthwindDb&gt; options = new();
options.UseSqlServer(builder.ConnectionString);
using (NorthwindDb db = new(options.Options))
{
  Write("Enter a unit price: ");
  string? priceText = ReadLine();
  if (!decimal.TryParse(priceText, out decimal price))
  {
    WriteLine("You must enter a valid unit price.");
    return;
  }
  // We have to use var because we are projecting into an anonymous type.
  var products = db.Products
    .Where(p =&gt; p.UnitPrice &gt; price)
    .Select(p =&gt; new { p.ProductId, p.ProductName, p.UnitPrice });
  WriteLine("----------------------------------------------------------");
  WriteLine("| {0,5} | {1,-35} | {2,8} |", "Id", "Name", "Price");
  WriteLine("----------------------------------------------------------");
  foreach (var p in products)
  {
    WriteLine("| {0,5} | {1,-35} | {2,8:C} |",
      p.ProductId, p.ProductName, p.UnitPrice);
  }
  WriteLine("----------------------------------------------------------");
  WriteLine(products.ToQueryString());
  WriteLine();
  WriteLine($"Provider:   {db.Database.ProviderName}");
  WriteLine($"Connection: {db.Database.GetConnectionString()}");
}
</code></pre>
      </li>
      <li class="numberedList">Run the console app and <a id="_idIndexMarker254"/>note the results, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">Enter a unit price: --
|    Id | Name                                |    Price--
|     9 | Mishi Kobe Niku                     |   £97.00 |
|    18 | Carnarvon Tigers                    |   £62.50 |
|    20 | Sir Rodney's Marmalade              |   £81.00 |
|    29 | Thüringer Rostbratwurst             |  £123.79 |
|    38 | Côte de Blaye                       |  £263.50--
DECLARE @__price_0 decimal(2) = 60.0;
SELECT [p].[ProductId], [p].[ProductName], [p].[UnitPrice]
FROM [Products] AS [p]
WHERE [p].[UnitPrice] &gt; @__price_0
Provider:   Microsoft.EntityFrameworkCore.SqlServer
Connection: Data Source=tcp:apps-services-book.database.windows.net,1433;Initial Catalog=Northwind;Persist Security Info=False;User ID=&lt;censored&gt;;Password=&lt;censored&gt;;Multiple Active Result Sets=False;Encrypt=True;Trust Server Certificate=False;Connection Timeout=10;
</code></pre>
      </li>
    </ol>
    <div><p class="normal">The output of your connection string will be different.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-139">Controlling the tracking of entities</h2>
    <p class="normal">We need to start<a id="_idIndexMarker255"/> with the definition of entity <strong class="keyWord">identity resolution</strong>. EF Core resolves each entity instance by reading its unique<a id="_idIndexMarker256"/> primary key value. This ensures no ambiguities about the identities of entities or relationships between them.</p>
    <div><p class="normal">EF Core can only track entities with keys because it uses a key to uniquely identify the entity in the database. Keyless entities, like those returned by views, are never tracked.</p>
    </div>
    <p class="normal">By default, EF Core assumes that you want to track entities in local memory so that if you make changes, like adding a new entity, modifying an existing entity, or removing an existing entity, then you can call <code class="inlineCode">SaveChanges</code> and all those changes will be made in the underlying data store.</p>
    <p class="normal">If you execute a query within a data context, like getting all customers in Germany, and then execute another query within the same data context, like getting all customers whose name starts with A, if one of those customer entities already exists in the context, it will be identified and not replaced or loaded twice. However, if the telephone number of that customer is updated in the database between the executions of the two queries, then the entity being tracked in the data context is not refreshed with the new telephone number.</p>
    <p class="normal">If you do not need to track<a id="_idIndexMarker257"/> these changes, or you want to load new instances of an entity for every query execution with the latest data values, even if the entity is already loaded, then you can disable tracking. </p>
    <p class="normal">To disable tracking for an individual query, call the <code class="inlineCode">AsNoTracking</code> method as part of the query, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">var products = db.Products
  .AsNoTracking()
  .Where(p =&gt; p.UnitPrice &gt; price)
  .Select(p =&gt; new { p.ProductId, p.ProductName, p.UnitPrice });
</code></pre>
    <p class="normal">To disable tracking by default for the data context, set the change tracker’s query tracking behavior to <code class="inlineCode">NoTracking</code>, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">db.ChangeTracker.QueryTrackingBehavior = QueryTrackingBehavior.NoTracking;
</code></pre>
    <p class="normal">To disable tracking for an individual query, but retain identity resolution, call the <code class="inlineCode">AsNoTrackingWithIdentityResolution</code> method as part of the query, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">var products = db.Products
  .AsNoTrackingWithIdentityResolution()
  .Where(p =&gt; p.UnitPrice &gt; price)
  .Select(p =&gt; new { p.ProductId, p.ProductName, p.UnitPrice });
</code></pre>
    <p class="normal">To disable tracking but perform identity resolution by default for the data context, set the change tracker’s query-tracking behavior to <code class="inlineCode">NoTrackingWithIdentityResolution</code>, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">db.ChangeTracker.QueryTrackingBehavior = 
  QueryTrackingBehavior.NoTrackingWithIdentityResolution;
</code></pre>
    <p class="normal">To set defaults for all new instances <a id="_idIndexMarker258"/>of a data context, in the <code class="inlineCode">OnConfiguring</code> method, call the <code class="inlineCode">UseQueryTrackingBehavior</code> method, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
{
  optionsBuilder.UseSqlServer(connectionString)
    .UseQueryTrackingBehavior(QueryTrackingBehavior.NoTracking);
}
</code></pre>
    <h3 class="heading-3" id="_idParaDest-140">A scenario using default tracking</h3>
    <p class="normal">The default is <strong class="keyWord">change tracking</strong> with identity resolution. Once an entity<a id="_idIndexMarker259"/> is loaded into the data context, underlying changes are not reflected and only one copy exists. Entities have local changes tracked and a call to <code class="inlineCode">SaveChanges</code> updates the database, as shown in <em class="italic">Table 3.2</em>:</p>
    <table class="table-container" id="table002-2">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Action</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Entity in data context</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Row in database</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Query for customers in Germany</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Change telephone in database</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Query for customers starting with A</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Query for customers in Germany</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Change telephone in entity</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-1928</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Save changes</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-1928</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-1928</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.2: Default tracking scenario</p>
    <h3 class="heading-3" id="_idParaDest-141">The same scenario using no tracking</h3>
    <p class="normal"><strong class="keyWord">No tracking</strong> and no identity resolution. Every query loads<a id="_idIndexMarker260"/> another instance of a database row into the data context, including underlying changes, allowing duplicates and mixed out-of-date and updated data. No local entity changes are tracked, so <code class="inlineCode">SaveChanges</code> does nothing, as shown in <em class="italic">Table 3.3</em>:</p>
    <table class="table-container" id="table003-2">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Action</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Entities in data context</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Row in database</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Query for customers in Germany</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Change telephone in database</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Query for customers starting with A</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Query for customers in Germany</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Change telephone in entity</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
            <p class="normal">Alfred’s Futterkiste, 123-1928</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Save changes</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
            <p class="normal">Alfred’s Futterkiste, 123-1928</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.3: No tracking scenario</p>
    <h3 class="heading-3" id="_idParaDest-142">The same scenario using no tracking with identity resolution</h3>
    <p class="normal">No tracking with identity<a id="_idIndexMarker261"/> resolution. Once an entity is loaded into the data context, underlying changes are not reflected and only one copy exists. No local entity changes are tracked, so <code class="inlineCode">SaveChanges</code> does nothing, as shown in <em class="italic">Table 3.4</em>:</p>
    <table class="table-container" id="table004-2">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Action</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Entities in data context</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Row in database</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Query for customers in Germany</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Change telephone in database</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Query for customers starting with A</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Query for customers in Germany</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-4567</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Change telephone in entity</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-1928</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Save changes</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-1928</p>
          </td>
          <td class="table-cell">
            <p class="normal">Alfred’s Futterkiste, 123-9876</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.4: Identity resolution scenario</p>
    <h3 class="heading-3" id="_idParaDest-143">Summary of tracking</h3>
    <p class="normal">Which should you choose? Of course, it depends on your specific scenario.</p>
    <p class="normal">You will sometimes read blogs<a id="_idIndexMarker262"/> that excitedly tell you that you can dramatically improve your EF Core queries by calling <code class="inlineCode">AsNoTracking</code>. But if you run a query that returns thousands of entities and then run the same query again within the same data context, you now have thousands of duplicates! This wastes memory and impacts performance.</p>
    <p class="normal">Understand how the three tracking choices work and select the best for your data context or individual queries. In the next topic, you will learn how to map inheritance hierarchies.</p>
    <h1 class="heading-1" id="_idParaDest-144">Mapping inheritance hierarchies with EF Core</h1>
    <p class="normal">Imagine that you have an inheritance hierarchy<a id="_idIndexMarker263"/> for some C# classes to store information<a id="_idIndexMarker264"/> about students and employees, both of which are types of people. All people have a name and an ID to uniquely identify them, students have a subject they are studying, and employees have a hire date, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">public abstract class Person
{
  public int Id { get; set; }
  public string? Name { get; set; }
}
public class Student : Person
{
  public string? Subject { get; set; }
}
public class Employee : Person
{
  public DateTime HireDate { get; set; }
}
</code></pre>
    <p class="normal">By default, EF Core will map these to a single table using the <strong class="keyWord">table-per-hierarchy </strong>(<strong class="keyWord">TPH</strong>) mapping strategy. EF Core 5 introduced support for the <strong class="keyWord">table-per-type </strong>(<strong class="keyWord">TPT</strong>) mapping strategy. EF Core 7 introduced support for the <strong class="keyWord">table-per-concrete-type </strong>(<strong class="keyWord">TPC</strong>) mapping strategy. Let’s explore<a id="_idIndexMarker265"/> the differences between<a id="_idIndexMarker266"/> these mapping strategies.</p>
    <h2 class="heading-2" id="_idParaDest-145">Table-per-hierarchy (TPH) mapping strategy</h2>
    <p class="normal">For the <code class="inlineCode">Person</code>-<code class="inlineCode">Student</code>-<code class="inlineCode">Employee</code> hierarchy, TPH will use a single table structure with a discriminator column<a id="_idIndexMarker267"/> to indicate which type of person, a student or employee, the row is, with nullable columns for extra values that only apply to some of the types, as shown highlighted in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">CREATE TABLE [People] (
  [Id] int NOT NULL IDENTITY,
  [Name] nvarchar(max) NOT NULL,
<strong class="hljs-slc">  [Discriminator] nvarchar(max) </strong><strong class="hljs-keyword-slc">NOT</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">NULL</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">  [Subject] nvarchar(max) </strong><strong class="hljs-keyword-slc">NULL</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">  [HireDate] nvarchar(max) </strong><strong class="hljs-keyword-slc">NULL</strong><strong class="hljs-slc">,</strong>
  CONSTRAINT [PK_People] PRIMARY KEY ([Id])
);
</code></pre>
    <p class="normal">Some data in the table might look like <em class="italic">Table 3.5</em>:</p>
    <table class="table-container" id="table005-2">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Id</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Name</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Discriminator</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Subject</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">HireDate</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">1</p>
          </td>
          <td class="table-cell">
            <p class="normal">Roman Roy</p>
          </td>
          <td class="table-cell">
            <p class="normal">Student</p>
          </td>
          <td class="table-cell">
            <p class="normal">History</p>
          </td>
          <td class="table-cell">
            <p class="normal">NULL</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">2</p>
          </td>
          <td class="table-cell">
            <p class="normal">Kendall Roy</p>
          </td>
          <td class="table-cell">
            <p class="normal">Employee</p>
          </td>
          <td class="table-cell">
            <p class="normal">NULL</p>
          </td>
          <td class="table-cell">
            <p class="normal">02/04/2014</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">3</p>
          </td>
          <td class="table-cell">
            <p class="normal">Siobhan Roy</p>
          </td>
          <td class="table-cell">
            <p class="normal">Employee</p>
          </td>
          <td class="table-cell">
            <p class="normal">NULL</p>
          </td>
          <td class="table-cell">
            <p class="normal">12/09/2020</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.5: Sample data in the People table</p>
    <p class="normal">TPH requires the <code class="inlineCode">Discriminator</code> column to store the class name of the type for each row. TPH requires the columns for properties of derived types to be nullable, like <code class="inlineCode">Subject</code> and <code class="inlineCode">HireDate</code>. This will cause an issue if those properties are required (non-null) at the class level. EF Core does not handle this by default.</p>
    <p class="normal">The main benefits of the TPH mapping<a id="_idIndexMarker268"/> strategy are simplicity and performance, which is why it is used by default.</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: If the discriminator column has many different values, then you can improve performance even more by defining an index on the discriminator. But if there are only a few different values, an index may make overall performance worse because it affects updating time. In this case, there are only two potential values, <code class="inlineCode">Student</code> and <code class="inlineCode">Employee</code>, so in a table with 100,000 rows, an index would make little difference.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-146">Table-per-type (TPT) mapping strategy</h2>
    <p class="normal">For the <code class="inlineCode">Person</code>-<code class="inlineCode">Student</code>-<code class="inlineCode">Employee</code> hierarchy, TPT will use<a id="_idIndexMarker269"/> a table for every type, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">CREATE TABLE [People] (
  [Id] int NOT NULL IDENTITY,
  [Name] nvarchar(max) NOT NULL,
  CONSTRAINT [PK_People] PRIMARY KEY ([Id])
);
CREATE TABLE [Students] (
  [Id] int NOT NULL,
  [Subject] nvarchar(max) NULL,
  CONSTRAINT [PK_Students] PRIMARY KEY ([Id])
  CONSTRAINT [FK_Students_People] FOREIGN KEY ([Id]) REFERENCES [People] ([Id])
);
CREATE TABLE [Employees] (
  [Id] int NOT NULL,
  [HireDate] nvarchar(max) NULL,
  CONSTRAINT [PK_Employees] PRIMARY KEY ([Id])
  CONSTRAINT [FK_Employees_People] FOREIGN KEY ([Id]) REFERENCES [People] ([Id])
);
</code></pre>
    <p class="normal">Some data in the tables might look like the following:</p>
    <table class="table-container" id="table006-2">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Id</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Name</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">1</p>
          </td>
          <td class="table-cell">
            <p class="normal">Roman Roy</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">2</p>
          </td>
          <td class="table-cell">
            <p class="normal">Kendall Roy</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">3</p>
          </td>
          <td class="table-cell">
            <p class="normal">Siobhan Roy</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.6: People table</p>
    <table class="table-container" id="table007-2">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Id</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Subject</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">1</p>
          </td>
          <td class="table-cell">
            <p class="normal">History</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.7: Students table</p>
    <table class="table-container" id="table008-1">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Id</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">HireDate</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">2</p>
          </td>
          <td class="table-cell">
            <p class="normal">02/04/2014</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">3</p>
          </td>
          <td class="table-cell">
            <p class="normal">12/09/2020</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.8: Employees table</p>
    <p class="normal">The main benefit of the TPT mapping strategy is reduced storage due to the full normalization of the data. The main disadvantage is that a single entity is spread over multiple tables and reconstructing it takes more effort and therefore reduces overall performance. TPT is usually a poor<a id="_idIndexMarker270"/> choice, so only use it if the table structure is already normalized and cannot be restructured.</p>
    <h2 class="heading-2" id="_idParaDest-147">Table-per-concrete-type (TPC) mapping strategy</h2>
    <p class="normal">For the <code class="inlineCode">Person</code>-<code class="inlineCode">Student</code>-<code class="inlineCode">Employee</code> hierarchy, TPC<a id="_idIndexMarker271"/> will use a table for each non-abstract type, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">CREATE TABLE [Students] (
  [Id] int NOT NULL DEFAULT (NEXT VALUE FOR [PersonIds]),
  [Name] nvarchar(max) NOT NULL,
  [Subject] nvarchar(max) NULL,
  CONSTRAINT [PK_Students] PRIMARY KEY ([Id])
  CONSTRAINT [FK_Students_People] FOREIGN KEY ([Id]) REFERENCES [People] ([Id])
);
CREATE TABLE [Employees] (
  [Id] int NOT NULL DEFAULT (NEXT VALUE FOR [PersonIds]),
  [Name] nvarchar(max) NOT NULL,
  [HireDate] nvarchar(max) NULL,
  CONSTRAINT [PK_Employees] PRIMARY KEY ([Id])
  CONSTRAINT [FK_Employees_People] FOREIGN KEY ([Id]) REFERENCES [People] ([Id])
);
</code></pre>
    <div><p class="normal">Since there is not a single table with an <code class="inlineCode">IDENTITY</code> column to assign <code class="inlineCode">Id</code> values, we can use the <code class="inlineCode">(NEXT VALUE FOR [PersonIds])</code> command to define a sequence shared between the two tables so they do not assign the same <code class="inlineCode">Id</code> values.</p>
    </div>
    <p class="normal">Some data in the tables might look like the following:</p>
    <table class="table-container" id="table009">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Id</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Name</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Subject</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">1</p>
          </td>
          <td class="table-cell">
            <p class="normal">Roman Roy</p>
          </td>
          <td class="table-cell">
            <p class="normal">History</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.9: Students table</p>
    <table class="table-container" id="table010">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Id</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Name</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">HireDate</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">2</p>
          </td>
          <td class="table-cell">
            <p class="normal">Kendall Roy</p>
          </td>
          <td class="table-cell">
            <p class="normal">02/04/2014</p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">3</p>
          </td>
          <td class="table-cell">
            <p class="normal">Siobhan Roy</p>
          </td>
          <td class="table-cell">
            <p class="normal">12/09/2020</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 3.10: Employees table</p>
    <p class="normal">The main benefit of the TPC mapping strategy is performance because when querying a single concrete type, only one table is needed so we avoid expensive joins. It works best for large inheritance hierarchies<a id="_idIndexMarker272"/> of many concrete types, each with many type-specific properties.</p>
    <h2 class="heading-2" id="_idParaDest-148">Configuring inheritance hierarchy mapping strategies</h2>
    <p class="normal">First, all types must be included<a id="_idIndexMarker273"/> in the model, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">public DbSet&lt;Person&gt; People { get; set; }
public DbSet&lt;Student&gt; Students { get; set; }
public DbSet&lt;Employee&gt; Employees { get; set; }
</code></pre>
    <p class="normal">For TPH, you are now finished, because it is the default! If you want to make this explicit, then in the data context class <code class="inlineCode">OnModelCreating</code> method, call the appropriate “use mapping strategy” method on the base class of the hierarchy. <code class="inlineCode">Person</code> is the base class, so you would call <code class="inlineCode">UseTphMappingStrategy</code> on that entity type, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">modelBuilder.Entity&lt;Person&gt;().UseTphMappingStrategy();
</code></pre>
    <p class="normal">To use either of the other two mapping strategies, call the appropriate method, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">modelBuilder.Entity&lt;Person&gt;().UseTptMappingStrategy();
modelBuilder.Entity&lt;Person&gt;().UseTpcMappingStrategy();
</code></pre>
    <p class="normal">Next, you can optionally specify the table name to use for each entity class, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">modelBuilder.Entity&lt;Student&gt;().ToTable("Students");
modelBuilder.Entity&lt;Employee&gt;().ToTable("Employees");
</code></pre>
    <p class="normal">The TPC strategy should have a shared<a id="_idIndexMarker274"/> sequence, so we should configure that too, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">modelBuilder.HasSequence&lt;int&gt;("PersonIds");
modelBuilder.Entity&lt;Person&gt;().UseTpcMappingStrategy()
  .Property(e =&gt; e.Id).HasDefaultValueSql("NEXT VALUE FOR [PersonIds]");
</code></pre>
    <h2 class="heading-2" id="_idParaDest-149">Example of hierarchy mapping strategies</h2>
    <p class="normal">Now let’s see this in action<a id="_idIndexMarker275"/> using a new database and project named <code class="inlineCode">HierarchyMapping</code>:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to add a console app project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Console App</strong> / <code class="inlineCode">console</code>.</li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter03</code>.</li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Console.HierarchyMapping</code>.</li>
          <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared.</li>
          <li class="bulletList"><strong class="screenText">Enable native AOT publish</strong>: Cleared.</li>
        </ul>
      </li>
      <li class="numberedList">Configure the startup project to run <code class="inlineCode">Northwind.Console.HierarchyMapping</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Console.HierarchyMapping</code> project, add package references to the EF Core data provider for SQL Server, and globally and statically import the <code class="inlineCode">System.Console</code> class, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference
    Include="Microsoft.EntityFrameworkCore.Design" 
    Version="8.0.0" /&gt;
  &lt;PackageReference
    Include="Microsoft.EntityFrameworkCore.SqlServer" 
    Version="8.0.0" /&gt;
&lt;/ItemGroup&gt;
&lt;ItemGroup&gt;
  &lt;Using Include="System.Console" Static="true" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the project to restore packages.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Console.HierarchyMapping</code> project, add a new folder named <code class="inlineCode">Models</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Models</code>, add a new class<a id="_idIndexMarker276"/> file named <code class="inlineCode">Person.cs</code>, and modify its contents, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using System.ComponentModel.DataAnnotations; // To use [Required].
namespace Northwind.Models;
public abstract class Person
{
  public int Id { get; set; }
  [Required]
  [StringLength(40)]
  public string? Name { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Models</code>, add a new class file named <code class="inlineCode">Student.cs</code>, and modify its contents, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.Models;
public class Student : Person
{
  public string? Subject { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Models</code>, add a new class file named <code class="inlineCode">Employee.cs</code>, and modify its contents, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.Models;
public class Employee : Person
{
  public DateTime HireDate { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Models</code>, add a new class<a id="_idIndexMarker277"/> file named <code class="inlineCode">HierarchyDb.cs</code>, and modify its contents, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.EntityFrameworkCore; // To use DbSet&lt;T&gt;.
namespace Northwind.Models;
public class HierarchyDb : DbContext
{
  public DbSet&lt;Person&gt;? People { get; set; }
  public DbSet&lt;Student&gt;? Students { get; set; }
  public DbSet&lt;Employee&gt;? Employees { get; set; }
  public HierarchyDb(DbContextOptions&lt;HierarchyDb&gt; options)
      : base(options)
  {
  }
  protected override void OnModelCreating(ModelBuilder modelBuilder)
  {
    modelBuilder.Entity&lt;Person&gt;()
      .UseTphMappingStrategy();
    // Populate database with sample data.
    Student p1 = new() { Id = 1, Name = "Roman Roy", 
      Subject = "History" };
    Employee p2 = new() { Id = 2, Name = "Kendall Roy", 
      HireDate = new(year: 2014, month: 4, day: 2) };
    Employee p3 = new() { Id = 3, Name = "Siobhan Roy", 
      HireDate = new(year: 2020, month: 9, day: 12) };
    modelBuilder.Entity&lt;Student&gt;().HasData(p1);
    modelBuilder.Entity&lt;Employee&gt;().HasData(p2, p3);
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, delete the existing<a id="_idIndexMarker278"/> statements. Add statements to configure the connection string for the <code class="inlineCode">HierarchyDb</code> data context and then use it to delete and then create a database named <code class="inlineCode">HierarchyMapping</code> (not <code class="inlineCode">Northwind</code>!), show the automatically generated SQL script, and then output the students, employees, and people, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Data.SqlClient; // To use SqlConnectionStringBuilder.
using Microsoft.Extensions.Options;
using Microsoft.EntityFrameworkCore; // GenerateCreateScript()
using Northwind.Models; // HierarchyDb, Person, Student, Employee
DbContextOptionsBuilder&lt;HierarchyDb&gt; options = new();
SqlConnectionStringBuilder builder = new();
builder.DataSource = "."; // "ServerName\InstanceName" e.g. @".\sqlexpress"
builder.InitialCatalog = "HierarchyMapping";
builder.TrustServerCertificate = true;
builder.MultipleActiveResultSets = true;
// Because we want to fail faster. Default is 15 seconds.
builder.ConnectTimeout = 3;
// If using Windows Integrated authentication.
builder.IntegratedSecurity = true;
// If using SQL Server authentication.
// builder.UserID = Environment.GetEnvironmentVariable("MY_SQL_USR");
// builder.Password = Environment.GetEnvironmentVariable("MY_SQL_PWD");
options.UseSqlServer(builder.ConnectionString);
using (HierarchyDb db = new(options.Options))
{
  bool deleted = await db.Database.EnsureDeletedAsync();
  WriteLine($"Database deleted: {deleted}");
  
  bool created = await db.Database.EnsureCreatedAsync();
  WriteLine($"Database created: {created}");
  WriteLine("SQL script used to create the database:");
  WriteLine(db.Database.GenerateCreateScript());
  if (db.Students is null || !db.Students.Any())
  {
    WriteLine("There are no students.");
  }
  else
  {
    foreach (Student student in db.Students)
    {
      WriteLine("{0} studies {1}",
        student.Name, student.Subject);
    }
  }
  if (db.Employees is null || !db.Employees.Any())
  {
    WriteLine("There are no employees.");
  }
  else
  {
    foreach (Employee employee in db.Employees)
    {
      WriteLine("{0} was hired on {1}",
        employee.Name, employee.HireDate);
    }
  }
  if (db.People is null || !db.People.Any())
  {
    WriteLine("There are no people.");
  }
  else
  {
    foreach (Person person in db.People)
    {
      WriteLine("{0} has ID of {1}",
        person.Name, person.Id);
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">Start the console app, and note the results<a id="_idIndexMarker279"/> including the single table named <code class="inlineCode">People</code> that is created, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Database deleted: False
Database created: True
SQL script used to create the database:
CREATE TABLE [People] (
    [Id] int NOT NULL IDENTITY,
    [Name] nvarchar(40) NOT NULL,
    [Discriminator] nvarchar(8) NOT NULL,
    [HireDate] datetime2 NULL,
    [Subject] nvarchar(max) NULL,
    CONSTRAINT [PK_People] PRIMARY KEY ([Id])
);
GO
IF EXISTS (SELECT * FROM [sys].[identity_columns] WHERE [name] IN (N'Id', N'Discriminator', N'Name', N'Subject') AND [object_id] = OBJECT_ID(N'[People]'))
    SET IDENTITY_INSERT [People] ON;
INSERT INTO [People] ([Id], [Discriminator], [Name], [Subject])
VALUES (1, N'Student', N'Roman Roy', N'History');
IF EXISTS (SELECT * FROM [sys].[identity_columns] WHERE [name] IN (N'Id', N'Discriminator', N'Name', N'Subject') AND [object_id] = OBJECT_ID(N'[People]'))
    SET IDENTITY_INSERT [People] OFF;
GO
IF EXISTS (SELECT * FROM [sys].[identity_columns] WHERE [name] IN (N'Id', N'Discriminator', N'HireDate', N'Name') AND [object_id] = OBJECT_ID(N'[People]'))
    SET IDENTITY_INSERT [People] ON;
INSERT INTO [People] ([Id], [Discriminator], [HireDate], [Name])
VALUES (2, N'Employee', '2014-04-02T00:00:00.0000000', N'Kendall Roy'),
(3, N'Employee', '2020-09-12T00:00:00.0000000', N'Siobhan Roy');
IF EXISTS (SELECT * FROM [sys].[identity_columns] WHERE [name] IN (N'Id', N'Discriminator', N'HireDate', N'Name') AND [object_id] = OBJECT_ID(N'[People]'))
    SET IDENTITY_INSERT [People] OFF;
GO
Roman Roy studies History
Kendall Roy was hired on 02/04/2014 00:00:00
Siobhan Roy was hired on 12/09/2020 00:00:00
Roman Roy has ID of 1
Kendall Roy has ID of 2
Siobhan Roy has ID of 3
</code></pre>
      </li>
      <li class="numberedList">In your preferred database tool, view the contents<a id="_idIndexMarker280"/> of the <code class="inlineCode">People</code> table, as shown in <em class="italic">Figure 3.2</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_03_02.png"/></figure>
    <p class="packt_figref">Figure 3.2: The People table when using the TPH mapping strategy</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="13">Close the connection to the <code class="inlineCode">HierarchyMapping</code> database.</li>
      <li class="numberedList">In <code class="inlineCode">HierarchyDb.cs</code>, comment out the method call that configures TPH and add a call to the method that configures TPT, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">protected override void OnModelCreating(ModelBuilder modelBuilder)
{
  modelBuilder.Entity&lt;Person&gt;()
<strong class="hljs-slc">    </strong><strong class="hljs-comment-slc">// .UseTphMappingStrategy();</strong>
<strong class="hljs-slc">    .UseTptMappingStrategy();</strong>
</code></pre>
      </li>
      <li class="numberedList">Start the console app, and note<a id="_idIndexMarker281"/> the results including the three tables named <code class="inlineCode">People</code>, <code class="inlineCode">Students</code>, and <code class="inlineCode">Employees</code> that are created, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">Database deleted: True
Database created: True
SQL script used to create the database:
CREATE TABLE [People] (
    [Id] int NOT NULL IDENTITY,
    [Name] nvarchar(40) NOT NULL,
    CONSTRAINT [PK_People] PRIMARY KEY ([Id])
);
GO
CREATE TABLE [Employees] (
    [Id] int NOT NULL,
    [HireDate] datetime2 NOT NULL,
    CONSTRAINT [PK_Employees] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_Employees_People_Id] FOREIGN KEY ([Id]) REFERENCES [People] ([Id])
);
GO
CREATE TABLE [Students] (
    [Id] int NOT NULL,
    [Subject] nvarchar(max) NULL,
    CONSTRAINT [PK_Students] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_Students_People_Id] FOREIGN KEY ([Id]) REFERENCES [People] ([Id])
);
GO
</code></pre>
      </li>
      <li class="numberedList">In your preferred database tool, view the contents of the tables, as shown in <em class="italic">Figure 3.3</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_03_03.png"/></figure>
    <p class="packt_figref">Figure 3.3: The tables when using the TPT mapping strategy</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="17">Close the connection to the <code class="inlineCode">HierarchyMapping</code> database.</li>
      <li class="numberedList">In <code class="inlineCode">HierarchyDb.cs</code>, comment out the method call that configures TPT. Add a call to the method that configures TPC<a id="_idIndexMarker282"/> and configure a sequence to track assigned ID values starting at four because we always add three sample rows, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">protected override void OnModelCreating(ModelBuilder modelBuilder)
{
  modelBuilder.Entity&lt;Person&gt;()
<strong class="hljs-slc">    </strong><strong class="hljs-comment-slc">// .UseTphMappingStrategy();</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-comment-slc">// .UseTptMappingStrategy();</strong>
<strong class="hljs-slc">    .UseTpcMappingStrategy()</strong>
<strong class="hljs-slc">    .Property(person =&gt; person.Id)</strong>
<strong class="hljs-slc">    .HasDefaultValueSql(</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">NEXT VALUE FOR [PersonIds]"</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">  modelBuilder.HasSequence&lt;</strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc">&gt;(</strong><strong class="hljs-string-slc">"PersonIds"</strong><strong class="hljs-slc">, builder =&gt;</strong>
<strong class="hljs-slc">  {</strong>
<strong class="hljs-slc">    builder.StartsAt(</strong><strong class="hljs-number-slc">4</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">  });</strong>
</code></pre>
      </li>
      <li class="numberedList">Start the console app, and note the results including the two tables named <code class="inlineCode">Students</code> and <code class="inlineCode">Employees</code> that are created as well as the shared sequence that starts at 4, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">CREATE SEQUENCE [PersonIds] AS int START WITH 4 INCREMENT BY 1 NO MINVALUE NO MAXVALUE NO CYCLE;
GO
CREATE TABLE [Employees] (
    [Id] int NOT NULL DEFAULT (NEXT VALUE FOR [PersonIds]),
    [Name] nvarchar(40) NOT NULL,
    [HireDate] datetime2 NOT NULL,
    CONSTRAINT [PK_Employees] PRIMARY KEY ([Id])
);
GO
CREATE TABLE [Students] (
    [Id] int NOT NULL DEFAULT (NEXT VALUE FOR [PersonIds]),
    [Name] nvarchar(40) NOT NULL,
    [Subject] nvarchar(max) NULL,
    CONSTRAINT [PK_Students] PRIMARY KEY ([Id])
);
GO
</code></pre>
      </li>
      <li class="numberedList">In your preferred database<a id="_idIndexMarker283"/> tool, view the contents of the tables, as shown in <em class="italic">Figure 3.4</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_03_04.png"/></figure>
    <p class="packt_figref">Figure 3.4: The tables when using the TPC mapping strategy</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="21">Close the connection to the <code class="inlineCode">HierarchyMapping</code> database.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after the statement to write the <code class="inlineCode">database create</code> script to the console, add some statements to add two new people using the current database context, as shown highlighted<a id="_idIndexMarker284"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code">WriteLine(db.Database.GenerateCreateScript());
<strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> ((db.Employees </strong><strong class="hljs-keyword-slc">is</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">not</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">) &amp;&amp; (db.Students </strong><strong class="hljs-keyword-slc">is</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">not</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">null</strong><strong class="hljs-slc">))</strong>
<strong class="hljs-slc">{</strong>
<strong class="hljs-slc">  db.Students.Add(</strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> Student { Name = </strong><strong class="hljs-string-slc">"Connor Roy"</strong><strong class="hljs-slc">, </strong>
<strong class="hljs-slc">    Subject = </strong><strong class="hljs-string-slc">"Politics"</strong><strong class="hljs-slc"> });</strong>
<strong class="hljs-slc">  db.Employees.Add(</strong><strong class="hljs-keyword-slc">new</strong><strong class="hljs-slc"> Employee { Name = </strong><strong class="hljs-string-slc">"Kerry Castellabate"</strong><strong class="hljs-slc">, </strong>
<strong class="hljs-slc">    HireDate = DateTime.UtcNow });</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc"> result = db.SaveChanges();</strong>
<strong class="hljs-slc">  WriteLine(</strong><strong class="hljs-string-slc">$"</strong><strong class="hljs-subst-slc">{result}</strong><strong class="hljs-string-slc"> people added."</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">}</strong>
</code></pre>
      </li>
      <li class="numberedList">Start the console app, and note the results, including the two new people added using the database context with IDs that start at 4, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">2 people added.
Roman Roy studies History
Connor Roy studies Politics
Kendall Roy was hired on 02/04/2014 00:00:00
Siobhan Roy was hired on 12/09/2020 00:00:00
Kerry Castellabate was hired on 19/05/2023 10:13:53
Kendall Roy has ID of 2
Siobhan Roy has ID of 3
Kerry Castellabate has ID of 4
Roman Roy has ID of 1
Connor Roy has ID of 5
</code></pre>
      </li>
    </ol>
    <p class="normal">You’ve now seen how an object-relational mapper like EF Core can define an object inheritance hierarchy and map it in three different ways to an underlying database structure with one or more related tables. You’ve also seen how Code First works especially well with this since it is so easy<a id="_idIndexMarker285"/> to delete and recreate the database each time the project starts.</p>
    <h1 class="heading-1" id="_idParaDest-150">Building a reusable entity data model</h1>
    <p class="normal">Practical applications<a id="_idIndexMarker286"/> usually need to work with data in a relational database or another data store. Earlier in this chapter, we defined EF Core models in the same console app project that we used them in. </p>
    <p class="normal">Now, we will define an entity data model for the Northwind database as a pair of reusable class libraries. One part of the pair will define the entities, like <code class="inlineCode">Product</code> and <code class="inlineCode">Customer</code>. The second part of the pair will define the tables in the database and the default configuration for how to connect to the database, and use the Fluent API to configure additional options for the model. This pair of class libraries will be used in many of the apps and services that you create in subsequent chapters.</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: You should create a separate class library project for your entity data models. This allows easier sharing between backend web servers and frontend desktop, mobile, and Blazor clients.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-151">Creating a class library for entity models using SQL Server</h2>
    <p class="normal">You will now create<a id="_idIndexMarker287"/> the entity<a id="_idIndexMarker288"/> models using<a id="_idIndexMarker289"/> the <code class="inlineCode">dotnet-ef</code> tool:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Add a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Class Library </strong>/ <code class="inlineCode">classlib</code>.</li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Common.EntityModels.SqlServer</code>.</li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter03</code>.</li>
        </ul>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Common.EntityModels.SqlServer</code> project, treat warnings as errors, and add package references for the SQL Server database provider and EF Core design-time support, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;Project Sdk="Microsoft.NET.Sdk"&gt;
  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
<strong class="hljs-slc">    &lt;TreatWarningsAsErrors&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/TreatWarningsAsErrors&gt;</strong>
  &lt;/PropertyGroup&gt;
<strong class="hljs-slc">  &lt;ItemGroup&gt;</strong>
<strong class="hljs-slc">    &lt;PackageReference</strong>
<strong class="hljs-slc">      Include="Microsoft.EntityFrameworkCore.SqlServer" Version="</strong><strong class="hljs-number-slc">8.0.0</strong><strong class="hljs-slc">" /&gt;</strong>
<strong class="hljs-slc">    &lt;PackageReference </strong>
<strong class="hljs-slc">      Include="Microsoft.EntityFrameworkCore.Design" Version="</strong><strong class="hljs-number-slc">8.0.0</strong><strong class="hljs-slc">"&gt;</strong>
<strong class="hljs-slc">      &lt;PrivateAssets&gt;all&lt;/PrivateAssets&gt;</strong>
<strong class="hljs-slc">      &lt;IncludeAssets&gt;runtime; build; native; contentfiles; analyzers; buildtransitive&lt;/IncludeAssets&gt;</strong>
<strong class="hljs-slc">    &lt;/PackageReference&gt;  </strong>
<strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong>
&lt;/Project&gt;
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">More Information</strong>: If you are unfamiliar with how packages like <code class="inlineCode">Microsoft.EntityFrameworkCore.Design</code> can manage their assets, then you can learn<a id="_idIndexMarker290"/> more at the following link: <a href="https://learn.microsoft.com/en-us/nuget/consume-packages/package-references-in-project-files#controlling-dependency-assets">https://learn.microsoft.com/en-us/nuget/consume-packages/package-references-in-project-files#controlling-dependency-assets</a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Delete the <code class="inlineCode">Class1.cs</code> file.</li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.Common.EntityModels.SqlServer</code> project.</li>
      <li class="numberedList">Open<a id="_idIndexMarker291"/> a command <a id="_idIndexMarker292"/>prompt or terminal<a id="_idIndexMarker293"/> for the <code class="inlineCode">Northwind.Common.EntityModels.SqlServer</code> folder.
    <div><p class="normal">The next step assumes a database connection string for a local SQL Server authenticated with Windows integrated security. Modify it for Azure SQL Database or Azure SQL Edge with a user ID and password if necessary.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">At the command line, generate entity class models for all tables, as shown in the following commands:
        <pre class="programlisting con"><code class="hljs-con">dotnet ef dbcontext scaffold "Data Source=.;Initial Catalog=Northwind;Integrated Security=true;TrustServerCertificate=True;" Microsoft.EntityFrameworkCore.SqlServer --namespace Northwind.EntityModels --data-annotations
</code></pre>
      
    <p class="normal">Note the following:</p>
    <ul>
      <li class="bulletList">The command to perform: <code class="inlineCode">dbcontext scaffold</code>.</li>
      <li class="bulletList">The connection string: <code class="inlineCode">"</code><code class="inlineCode">Data Source=.;Initial Catalog=Northwind;Integrated Security=true;TrustServerCertificate=True;"</code> .</li>
      <li class="bulletList">The database provider: <code class="inlineCode">Microsoft.EntityFrameworkCore.SqlServer</code>.</li>
      <li class="bulletList">The namespace for the generated classes: <code class="inlineCode">--namespace Northwind.EntityModels</code>.</li>
      <li class="bulletList">To use data annotations as well as the Fluent API: <code class="inlineCode">--data-annotations</code>.</li>
    </ul></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">Note that <a id="_idIndexMarker294"/>28 classes<a id="_idIndexMarker295"/> were generated, from <code class="inlineCode">AlphabeticalListOfProduct.cs</code> to <code class="inlineCode">Territory.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">NorthwindContext.cs</code>, delete the <code class="inlineCode">OnConfiguring</code> method including the warning and connection<a id="_idIndexMarker296"/> string.</li>
      <li class="numberedList">In <code class="inlineCode">Customer.cs</code>, the <code class="inlineCode">dotnet-ef</code> tool correctly identified that the <code class="inlineCode">CustomerId</code> column is the primary key and it is limited to a maximum of five characters, but we also want the values to always be uppercase. So, add a regular expression to validate its primary key value to only allow uppercase Western characters, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">[Key]
[StringLength(5)]
<strong class="hljs-slc">[</strong><strong class="hljs-meta-slc">RegularExpression(</strong><strong class="hljs-string-slc">"[A-Z]{5}"</strong><strong class="hljs-meta-slc">)</strong><strong class="hljs-slc">]  </strong>
public string CustomerId { get; set; } = null!;
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-152">Creating a class library for the data context using SQL Server</h2>
    <p class="normal">Next, you will move the context model<a id="_idIndexMarker297"/> that represents the database<a id="_idIndexMarker298"/> to a separate class<a id="_idIndexMarker299"/> library:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Add a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Class Library</strong> / <code class="inlineCode">classlib</code>.</li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Common.DataContext.SqlServer</code>.</li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter03</code>.</li>
          <li class="bulletList">In the <code class="inlineCode">DataContext</code> project, add a project reference to the <code class="inlineCode">EntityModels</code> project, and add a package reference to the EF Core data provider for SQL Server, as shown in the following markup:</li>
        </ul>
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference 
    Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.0" /&gt;
&lt;/ItemGroup&gt;
&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\Northwind.Common.EntityModels
.SqlServer\Northwind.Common.EntityModels.SqlServer.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Warning!</strong> The path to the project reference should not have a line break in your project file.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">In the <code class="inlineCode">Northwind.Common.DataContext.SqlServer</code> project, delete the <code class="inlineCode">Class1.cs</code> file.</li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.Common.DataContext.SqlServer</code> project.</li>
      <li class="numberedList">Move the <code class="inlineCode">NorthwindContext.cs</code> file from the <code class="inlineCode">Northwind.Common.EntityModels.SqlServer</code> project/folder to the <code class="inlineCode">Northwind.Common.DataContext.SqlServer</code> project/folder.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Common.DataContext.SqlServer</code> project, add a class named <code class="inlineCode">NorthwindContextExtensions.cs</code>, and modify its contents to define an extension method<a id="_idIndexMarker300"/> that adds the Northwind<a id="_idIndexMarker301"/> database context<a id="_idIndexMarker302"/> to a collection of dependency services, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Data.SqlClient; // SqlConnectionStringBuilder
using Microsoft.EntityFrameworkCore; // UseSqlServer
using Microsoft.Extensions.DependencyInjection; // IServiceCollection
namespace Northwind.EntityModels;
public static class NorthwindContextExtensions
{
  /// &lt;summary&gt;
  /// Adds NorthwindContext to the specified IServiceCollection. Uses the SqlServer database provider.
  /// &lt;/summary&gt;
  /// &lt;param name="services"&gt;The service collection.&lt;/param&gt;
  /// &lt;param name="connectionString"&gt;Set to override the default.&lt;/param&gt;
  /// &lt;returns&gt;An IServiceCollection that can be used to add more services.&lt;/returns&gt;
  public static IServiceCollection AddNorthwindContext(
    this IServiceCollection services,
    string? connectionString = null)
  {
    if (connectionString == null)
    {
      SqlConnectionStringBuilder builder = new();
      builder.DataSource = ".";
      builder.InitialCatalog = "Northwind";
      builder.TrustServerCertificate = true;
      builder.MultipleActiveResultSets = true;
      // If using Azure SQL Edge.
      // builder.DataSource = "tcp:127.0.0.1,1433";
      // Because we want to fail fast. Default is 15 seconds.
      builder.ConnectTimeout = 3;
      // If using Windows Integrated authentication.
      builder.IntegratedSecurity = true;
      // If using SQL Server authentication.
      // builder.UserID = Environment.GetEnvironmentVariable("MY_SQL_USR");
      // builder.Password = Environment.GetEnvironmentVariable("MY_SQL_PWD");
      connectionString = builder.ConnectionString;
    }
    services.AddDbContext&lt;NorthwindContext&gt;(options =&gt;
    {
      options.UseSqlServer(connectionString);
      // Log to console when executing EF Core commands.
      options.LogTo(Console.WriteLine,
        new[] { Microsoft.EntityFrameworkCore
          .Diagnostics.RelationalEventId.CommandExecuting });
    },
    // Register with a transient lifetime to avoid concurrency 
    // issues with Blazor Server projects.
    contextLifetime: ServiceLifetime.Transient, 
    optionsLifetime: ServiceLifetime.Transient);
    return services;
  }
}
</code></pre>
      </li>
      <li class="numberedList">Build the<a id="_idIndexMarker303"/> two class libraries<a id="_idIndexMarker304"/> and fix any compiler<a id="_idIndexMarker305"/> errors.</li>
    </ol>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: We have provided an optional argument for the <code class="inlineCode">AddNorthwindContext</code> method so that we can override the SQL Server database connection string. This will allow us more flexibility, for example, to load these values from a configuration file.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-153">Calculated properties on entity creation</h2>
    <p class="normal">EF Core 7 added an <code class="inlineCode">IMaterializationInterceptor</code> interface that allows interception before and after<a id="_idIndexMarker306"/> an entity is created, and when properties are initialized. This is useful for calculated values. </p>
    <p class="normal">For example, when a service or client app requests entities to show to the user, it might want to cache a copy of the entity for a period of time. To do this, it needs to know when the entity was last refreshed. It would be useful if this information was automatically generated and stored with each entity at the time of loading.</p>
    <p class="normal">To achieve this goal, we must complete four steps:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">First, define an interface with the extra property.</li>
      <li class="numberedList">Next, at least one entity model class must implement the interface.</li>
      <li class="numberedList">Then, define a class that implements the interceptor interface with a method named <code class="inlineCode">InitializedInstance</code> that will execute on any entity, and if that entity implements the custom interface with the extra property, then it will set its value.</li>
      <li class="numberedList">Finally, we must create an instance of the interceptor and register it in the data context class.</li>
    </ol>
    <p class="normal">Now let’s implement this for Northwind <code class="inlineCode">Employee</code> entities:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Common.EntityModels.SqlServer</code> project, add a new file named <code class="inlineCode">IHasLastRefreshed.cs</code>, and modify its contents to define the interface, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.EntityModels;
public interface IHasLastRefreshed
{
  DateTimeOffset LastRefreshed { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Common.EntityModels.SqlServer</code> project, add a new file named <code class="inlineCode">EmployeePartial.cs</code>, and modify its contents to implement the interface, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">using System.ComponentModel.DataAnnotations.Schema; // [NotMapped]
namespace Northwind.EntityModels;
public partial class Employee <strong class="hljs-slc">: </strong><strong class="hljs-title-slc">IHasLastRefreshed</strong>
{
<strong class="hljs-slc">  [</strong><strong class="hljs-meta-slc">NotMapped</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">public</strong><strong class="hljs-slc"> DateTimeOffset LastRefreshed { </strong><strong class="hljs-keyword-slc">get</strong><strong class="hljs-slc">; </strong><strong class="hljs-keyword-slc">set</strong><strong class="hljs-slc">; }</strong>
}
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Add extension code like this to a separate partial entity class file so that you can later regenerate the <code class="inlineCode">Employee.cs</code> file using the <code class="inlineCode">dotnet-ef</code> tool without overwriting your additional code.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">In the <code class="inlineCode">Northwind.Common.DataContext.SqlServer</code> project, add a new file named <code class="inlineCode">SetLastRefreshedInterceptor.cs</code>, and modify its contents to define the interceptor, as shown<a id="_idIndexMarker307"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code">// IMaterializationInterceptor, MaterializationInterceptionData
using Microsoft.EntityFrameworkCore.Diagnostics;
namespace Northwind.EntityModels;
public class SetLastRefreshedInterceptor : IMaterializationInterceptor
{
  public object InitializedInstance(
    MaterializationInterceptionData materializationData,
    object entity)
  {
    if (entity is IHasLastRefreshed entityWithLastRefreshed)
    {
      entityWithLastRefreshed.LastRefreshed = DateTimeOffset.UtcNow;
    }
    return entity;
  }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Common.DataContext.SqlServer</code> project, in <code class="inlineCode">NorthwindContext.cs</code>, delete the existing <code class="inlineCode">OnConfiguring</code> method.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Common.DataContext.SqlServer</code> project, add a new file named <code class="inlineCode">NorthwindContextPartial.cs</code>, then declare<a id="_idIndexMarker308"/> and register the interceptor in the <code class="inlineCode">OnConfiguring</code> method, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Data.SqlClient; // SqlConnectionStringBuilder
using Microsoft.EntityFrameworkCore; // DbContext
namespace Northwind.EntityModels;
public partial class NorthwindContext : DbContext
{
  private static readonly SetLastRefreshedInterceptor
    setLastRefreshedInterceptor = new();
  protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
  {
    if (!optionsBuilder.IsConfigured)
    {
      SqlConnectionStringBuilder builder = new();
      builder.DataSource = ".";
      builder.InitialCatalog = "Northwind";
      builder.TrustServerCertificate = true;
      builder.MultipleActiveResultSets = true;
      // Because we want to fail fast. Default is 15 seconds.
      builder.ConnectTimeout = 3;
      // If using Windows Integrated authentication.
      builder.IntegratedSecurity = true;
      // If using SQL Server authentication.
      // builder.UserID = Environment.GetEnvironmentVariable("MY_SQL_USR");
      // builder.Password = Environment.GetEnvironmentVariable("MY_SQL_PWD");
      optionsBuilder.UseSqlServer(builder.ConnectionString);
    }
    optionsBuilder.AddInterceptors(setLastRefreshedInterceptor);
  }
}
</code></pre>
      </li>
      <li class="numberedList">Save<a id="_idIndexMarker309"/> the changes.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-154">Creating a test project to check the integration of the class libraries</h2>
    <p class="normal">Since we will not be creating<a id="_idIndexMarker310"/> a client project in this chapter that uses<a id="_idIndexMarker311"/> the EF Core model, we should create a test project to make sure the database context and entity models integrate correctly:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred coding tool to add a new <strong class="screenText">xUnit Test Project [C#]</strong> / <code class="inlineCode">xunit</code> project named <code class="inlineCode">Northwind.Common.EntityModels.Tests</code> to the <code class="inlineCode">Chapter03</code> solution.</li>
      <li class="numberedList">In <code class="inlineCode">Northwind.Common.EntityModels.Tests.csproj</code>, modify the configuration to treat warnings as errors and to add an item group with a project reference to the <code class="inlineCode">Northwind.Common.DataContext.SqlServer</code> project, as shown<a id="_idIndexMarker312"/> in the following<a id="_idIndexMarker313"/> markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\Northwind.Common.DataContext
.SqlServer\Northwind.Common.DataContext.SqlServer.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Warning!</strong> The path to the project reference should not have a line break in your project file.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Build the <code class="inlineCode">Northwind.Common.EntityModels.Tests</code> project to build and restore project dependencies.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-155">Writing unit tests for entity models</h2>
    <p class="normal">A well-written<a id="_idIndexMarker314"/> unit test will have<a id="_idIndexMarker315"/> three parts:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Arrange</strong>: This part will declare and instantiate variables for input and output.</li>
      <li class="bulletList"><strong class="keyWord">Act</strong>: This part will execute the unit that you are testing. In our case, that means calling the method that we want to test.</li>
      <li class="bulletList"><strong class="keyWord">Assert</strong>: This part will make one or more assertions about the output. An assertion is a belief that, if not true, indicates a failed test. For example, when adding 2 and 2, we would expect the result to be 4.</li>
    </ul>
    <p class="normal">Now, we will write some unit tests for the <code class="inlineCode">NorthwindContext</code> and entity model classes:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Rename the file <code class="inlineCode">UnitTest1.cs</code> to <code class="inlineCode">NorthwindEntityModelsTests.cs</code> and then open it.</li>
      <li class="numberedList">In Visual Studio Code, rename the class to <code class="inlineCode">NorthwindEntityModelsTests</code>. (Visual Studio prompts you to rename the class when you rename the file.)</li>
      <li class="numberedList">Modify the <code class="inlineCode">NorthwindEntityModelsTests</code> class to import the <code class="inlineCode">Northwind.EntityModels</code> namespace and have some test methods for ensuring the context class can connect, ensuring the provider is SQL Server, and ensuring the first <a id="_idIndexMarker316"/>product is named <code class="inlineCode">Chai</code>, as shown<a id="_idIndexMarker317"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels;
namespace Northwind.Common.EntityModels.Tests
{
  public class NorthwindEntityModelsTests
  {
    [Fact]
    public void CanConnectIsTrue()
    {
      using (NorthwindContext db = new()) // arrange
      {
        bool canConnect = db.Database.CanConnect(); // act
        Assert.True(canConnect); // assert
      }
    }
    [Fact]
    public void ProviderIsSqlServer()
    {
      using (NorthwindContext db = new())
      {
        string? provider = db.Database.ProviderName;
        Assert.Equal("Microsoft.EntityFrameworkCore.SqlServer", provider);
      }
    }
    [Fact]
    public void ProductId1IsChai()
    {
      using (NorthwindContext db = new())
      {
        Product product1 = db.Products.Single(p =&gt; p.ProductId == 1);
        Assert.Equal("Chai", product1.ProductName);
      }
    }
    [Fact]
    public void EmployeeHasLastRefreshedIn10sWindow()
    {
      using (NorthwindContext db = new())
      {
        Employee employee1 = db.Employees.Single(p =&gt; p.EmployeeId == 1);
        DateTimeOffset now = DateTimeOffset.UtcNow;
        Assert.InRange(actual: employee1.LastRefreshed,
          low: now.Subtract(TimeSpan.FromSeconds(5)),
          high: now.AddSeconds(5));
      }
    }
  }
}
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-156">Running unit tests using Visual Studio 2022</h2>
    <p class="normal">Now we are ready<a id="_idIndexMarker318"/> to run the unit tests and see<a id="_idIndexMarker319"/> the results:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In Visual Studio 2022, navigate to <strong class="screenText">Test</strong> | <strong class="screenText">Run All Tests</strong>.</li>
      <li class="numberedList">In <strong class="screenText">Test Explorer</strong>, note that the results indicate that four tests ran, and all passed, as shown in <em class="italic">Figure 3.5</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_03_05.png"/></figure>
    <p class="packt_figref">Figure 3.5: All unit tests passed</p>
    <h2 class="heading-2" id="_idParaDest-157">Running unit tests using Visual Studio Code</h2>
    <p class="normal">Now we are ready<a id="_idIndexMarker320"/> to run the unit tests and see<a id="_idIndexMarker321"/> the results:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In Visual Studio Code, in the <code class="inlineCode">Northwind.Common.EntityModels.Tests</code> project’s <strong class="screenText">TERMINAL</strong> window, run the tests, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet test
</code></pre>
      
    <div><p class="normal">If you are using <strong class="screenText">C# Dev Kit</strong>, then you can also build the test project and then run the tests from the <strong class="screenText">Testing</strong> section in the <strong class="screenText">Primary Side Bar</strong>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">In the output, note that the results<a id="_idIndexMarker322"/> indicate that four tests<a id="_idIndexMarker323"/> ran, and all passed.
    <div><p class="normal">As an optional task, can you think of other tests you could write to make sure the database context and entity models are correct?</p>
    </div></li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-158">Practicing and exploring</h1>
    <p class="normal">Test your knowledge and understanding by answering some questions, getting some hands-on practice, and exploring this chapter’s topics with deeper research.</p>
    <h2 class="heading-2" id="_idParaDest-159">Exercise 3.1 – Test your knowledge</h2>
    <p class="normal">Answer the following questions:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">What can the <code class="inlineCode">dotnet-ef</code> tool be used for?</li>
      <li class="numberedList">What type would you use for the property that represents a table, for example, the <code class="inlineCode">Products</code> property of a data context?</li>
      <li class="numberedList">What type would you use for the property that represents a one-to-many relationship, for example, the <code class="inlineCode">Products</code> property of a <code class="inlineCode">Category</code> entity?</li>
      <li class="numberedList">What is the EF Core convention for primary keys?</li>
      <li class="numberedList">Why might you choose the Fluent API in preference to annotation attributes?</li>
      <li class="numberedList">Why might you implement the <code class="inlineCode">IMaterializationInterceptor</code> interface in an entity type?</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-160">Exercise 3.2 – Practice benchmarking ADO.NET against EF Core</h2>
    <p class="normal">In the <code class="inlineCode">Chapter03</code> solution, create a console app named <code class="inlineCode">Ch03Ex02_ADONETvsEFCore</code> that uses Benchmark.NET to compare retrieving all the products from the Northwind database using ADO.NET (<code class="inlineCode">SqlClient</code>) and using EF Core.</p>
    <div><p class="normal">You can learn how to use Benchmark.NET by reading the online-only section <em class="chapterRef">Benchmarking Performance and Testing</em> at the following link: <a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/ch01-benchmarking.md">https://github.com/markjprice/apps-services-net8/blob/main/docs/ch01-benchmarking.md</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-161">Exercise 3.3 – Review performance choices</h2>
    <p class="normal">The data tier can have an outsized influence on the overall performance of an app or service. </p>
    <p class="normal">Docs: <a href="https://learn.microsoft.com/en-us/ef/core/performance/">https://learn.microsoft.com/en-us/ef/core/performance/</a></p>
    <h2 class="heading-2" id="_idParaDest-162">Exercise 3.4 – Explore topics</h2>
    <p class="normal">Use the links on the following page to learn more details about the topics covered in this chapter:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-3---building-entity-models-for-sql-server-using-ef-core">https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-3---building-entity-models-for-sql-server-using-ef-core</a></p>
    <h1 class="heading-1" id="_idParaDest-163">Summary</h1>
    <p class="normal">In this chapter, you learned:</p>
    <ul>
      <li class="bulletList">How to execute a simple query and process the results using the slower but more object-oriented EF Core.</li>
      <li class="bulletList">How to configure and decide between three mapping strategies for type hierarchies.</li>
      <li class="bulletList">How to implement calculated properties on entity creation.</li>
    </ul>
    <p class="normal">In the next chapter, you will learn how to use cloud-native data storage with Azure Cosmos DB.</p>
  </div>
  <div><h1 class="heading-1" id="_idParaDest-164">Learn more on Discord</h1>
    <p class="normal">To join the Discord community for this book – where you can share feedback, ask questions to the author, and learn about new releases – follow the QR code below:</p>
    <p class="normal"><a href="https://packt.link/apps_and_services_dotnet8">https://packt.link/apps_and_services_dotnet8</a></p>
    <p class="normal"><img alt="" src="img/QR_Code3048220001028652625.png"/></p>
  </div>
</body></html>