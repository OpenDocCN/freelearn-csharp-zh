<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="packt" name="generator"/>
<title>7 Strategy, Abstract Factory, and Singleton Design Patterns</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<link href="../styles/stylesheet2.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body>
<section class="level1 pkt" data-number="8" id="strategy-abstract-factory-and-singleton-design-patterns">
<h1 data-number="8"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">7 Strategy, Abstract Factory, and Singleton Design Patterns</span></h1>
<section class="level2" data-number="8.1" id="before-you-begin-join-our-book-community-on-discord-6">
<h2 data-number="8.1"><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Before you begin: Join our book community on Discord</span></h2>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">Give your feedback straight to the author himself and chat to other early readers on our Discord server (find the "architecting-aspnet-core-apps-3e" channel under EARLY ACCESS SUBSCRIPTION).</span></p>
<p><a href="https://packt.link/EarlyAccess"><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">https://packt.link/EarlyAccess</span></a></p>
<p><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Qr code Description automatically generated" src="../media/file32.png" style="width:10em"/></span></p>
<p><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">This chapter explores object creation using a few classic, simple, and yet powerful design patterns from the </span><strong><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">Gang of Four</span></strong><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><strong><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">GoF</span></strong><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.10.2" xmlns="http://www.w3.org/1999/xhtml">These patterns allow developers to encapsulate and reuse behaviors, centralize object creation, add flexibility to our designs, or control object lifetime. </span><span class="koboSpan" id="kobo.10.3" xmlns="http://www.w3.org/1999/xhtml">Moreover, you will most likely use some of them in all software you build directly or indirectly in the future.</span></p>
<blockquote>
<p><strong><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml">GoF</span></strong></p>
<blockquote>
<p><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">Erich Gamma, Richard Helm, Ralph Johnson, and John Vlissides are the authors of </span><em><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">Design Patterns: Elements of Reusable Object-Oriented Software</span></em><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml"> (1994), known as the </span><strong><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">Gang of Four</span></strong><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><strong><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">GoF</span></strong><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.18.2" xmlns="http://www.w3.org/1999/xhtml">In that book, they introduce 23 design patterns, some of which we revisit in this book.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml">Why are they that important? </span><span class="koboSpan" id="kobo.19.2" xmlns="http://www.w3.org/1999/xhtml">Because they are the building blocks of robust object composition and help create flexibility and reliability. </span><span class="koboSpan" id="kobo.19.3" xmlns="http://www.w3.org/1999/xhtml">Moreover, in </span><em><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 8</span></em><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">Dependency Injection</span></em><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">, we make those patterns even more powerful!But first things first. </span><span class="koboSpan" id="kobo.23.2" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we cover the following topics:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">The Strategy design pattern</span></li>
<li><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">The Abstract Factory design pattern</span></li>
<li><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">The Singleton design pattern</span></li>
</ul>
</section>
<section class="level2" data-number="8.2" id="the-strategy-design-pattern">
<h2 data-number="8.2"><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml">The Strategy design pattern</span></h2>
<p><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">The Strategy pattern is a behavioral design pattern that allows us to change object behaviors at runtime. </span><span class="koboSpan" id="kobo.28.2" xmlns="http://www.w3.org/1999/xhtml">We can also use this pattern to compose complex object trees and rely on it to follow the </span><strong><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml">Open/Closed Principle</span></strong><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><strong><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml">OCP</span></strong><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml">) without much effort. </span><span class="koboSpan" id="kobo.32.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, it plays a significant role in the </span><em><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">composition over inheritance</span></em><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml"> way of thinking. </span><span class="koboSpan" id="kobo.34.2" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we focus on the behavioral part of the Strategy pattern. </span><span class="koboSpan" id="kobo.34.3" xmlns="http://www.w3.org/1999/xhtml">The next chapter covers how to use the Strategy pattern to compose systems dynamically.</span></p>
<section class="level3" data-number="8.2.1" id="goal-4">
<h3 data-number="8.2.1"><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">Goal</span></h3>
<p><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">The Strategy pattern aims to extract an algorithm (a strategy) from the host class needing it (the context or consumer). </span><span class="koboSpan" id="kobo.36.2" xmlns="http://www.w3.org/1999/xhtml">That allows the consumer to decide on the strategy (algorithm) to use at runtime.For example, we could design a system that fetches data from two different types of databases. </span><span class="koboSpan" id="kobo.36.3" xmlns="http://www.w3.org/1999/xhtml">Then we could apply the same logic to that data and use the same user interface to display it. </span><span class="koboSpan" id="kobo.36.4" xmlns="http://www.w3.org/1999/xhtml">To achieve this, we could use the Strategy pattern to create two strategies, one named </span><code><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">FetchDataFromSql</span></code><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml"> and the other </span><code><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml">FetchDataFromCosmosDb</span></code><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.40.2" xmlns="http://www.w3.org/1999/xhtml">Then we could plug the strategy we need at runtime in the </span><code><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml">context</span></code><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.42.2" xmlns="http://www.w3.org/1999/xhtml">That way, when the consumer calls the </span><code><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml">context</span></code><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml">, the </span><code><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">context</span></code><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml"> does not need to know where the data comes from, how it is fetched, or what strategy is in use; it only gets what it needs to work, delegating the fetching responsibility to an abstracted strategy (an interface).</span></p>
</section>
<section class="level3" data-number="8.2.2" id="design-4">
<h3 data-number="8.2.2"><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml">Design</span></h3>
<p><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml">Before any further explanation, let’s take a look at the following class diagram:</span></p>
<figure>
<span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 7.1: Strategy pattern class diagram" src="../media/file33.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">Figure 7.1: Strategy pattern class diagram</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml">Based on the preceding diagram, the building blocks of the Strategy pattern are the following:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></code><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml"> is a class that depends on the </span><code><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml">IStrategy</span></code><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml"> interface and leverages an implementation of the </span><code><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml">IStrategy</span></code><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml"> interface to execute the </span><code><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">ExecuteAlgo</span></code><span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml"> method.</span></li>
<li><code><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml">IStrategy</span></code><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml"> is an interface defining the strategy API.</span></li>
<li><code><span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml">ConcreteStrategy1</span></code><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">ConcreteStrategy2</span></code><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml"> represent one or more different concrete implementations of the </span><code><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml">IStrategy</span></code><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml"> interface.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml">In the following diagram, we explore what happens at runtime. </span><span class="koboSpan" id="kobo.68.2" xmlns="http://www.w3.org/1999/xhtml">The actor represents any code consuming the </span><code><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></code><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml"> object.</span></p>
<figure>
<span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 7.2: Strategy pattern sequence diagram" src="../media/file34.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">Figure 7.2: Strategy pattern sequence diagram</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml">When the consumer calls the </span><code><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">Context.SomeOperation()</span></code><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml"> method, it does not know which implementation is executed, which is an essential part of this pattern. </span><span class="koboSpan" id="kobo.75.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></code><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml"> class should not be aware of the strategy it uses either. </span><span class="koboSpan" id="kobo.77.2" xmlns="http://www.w3.org/1999/xhtml">It should run the strategy through the interface, unaware of the implementation. </span><span class="koboSpan" id="kobo.77.3" xmlns="http://www.w3.org/1999/xhtml">That is the strength of the Strategy pattern: it abstracts the implementation away from both the </span><code><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></code><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml"> class and its consumers. </span><span class="koboSpan" id="kobo.79.2" xmlns="http://www.w3.org/1999/xhtml">Because of that, we can change the strategy during either the object creation or at runtime without the object knowing, changing its behavior on the fly.</span></p>
<blockquote>
<p><strong><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">Note</span></strong></p>
<blockquote>
<p><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml">We could even generalize that last sentence and extend it to any interface. </span><span class="koboSpan" id="kobo.81.2" xmlns="http://www.w3.org/1999/xhtml">Depending on an interface breaks the ties between the consumer and the implementation by relying on that abstraction instead.</span></p>
</blockquote>
</blockquote>
</section>
<section class="level3" data-number="8.2.3" id="project-strategy">
<h3 data-number="8.2.3"><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml">Project – Strategy</span></h3>
<p><strong><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></strong><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml">: We want to sort a collection differently, eventually even using different sort algorithms (out of the scope of the example but possible). </span><span class="koboSpan" id="kobo.84.2" xmlns="http://www.w3.org/1999/xhtml">Initially, we want to support sorting the elements of any collection in ascending or descending order.To achieve this, we need to implement the following building blocks:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></code><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml"> is the </span><code><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml">SortableCollection</span></code><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml"> class.</span></li>
<li><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml">IStrategy</span></code><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml"> is the </span><code><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml">ISortStrategy</span></code><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml"> interface.</span></li>
<li><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml">The concrete strategies are:</span></li>
</ul>
<ol>
<li><code><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml">SortAscendingStrategy</span></code></li>
<li><code><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml">SortDescendingStrategy</span></code></li>
</ol>
<p><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">The consumer is a small REST API that allows the user to change the strategy, sort the collection, and display the items. </span><span class="koboSpan" id="kobo.98.2" xmlns="http://www.w3.org/1999/xhtml">Let’s start with the </span><code><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml">ISortStrategy</span></code><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml"> interface:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">public interface ISortStrategy
{
    IOrderedEnumerable&lt;string&gt; Sort(IEnumerable&lt;string&gt; input);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml">That interface contains only one method that expects a string collection as input and returns an ordered string collection. </span><span class="koboSpan" id="kobo.102.2" xmlns="http://www.w3.org/1999/xhtml">Now let’s inspect the two implementations:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml">public class SortAscendingStrategy : ISortStrategy
{
    public IOrderedEnumerable&lt;string&gt; Sort(IEnumerable&lt;string&gt; input)
        =&gt; input.OrderBy(x =&gt; x);
}
public class SortDescendingStrategy : ISortStrategy
{
    public IOrderedEnumerable&lt;string&gt; Sort(IEnumerable&lt;string&gt; input)
        =&gt; input.OrderByDescending(x =&gt; x);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">Both implementations are super simple, using </span><strong><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml">Language Integrated Query</span></strong><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><strong><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml">LINQ</span></strong><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml">) to sort the input and return the result directly.</span></p>
<blockquote>
<p><strong><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml">Tip</span></strong></p>
<blockquote>
<p><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml">When using expression-bodied methods, please ensure you do not make the method harder to read for your colleagues (or future you) by creating very complex one-liners. </span><span class="koboSpan" id="kobo.110.2" xmlns="http://www.w3.org/1999/xhtml">Writing multiple lines often makes the code easier to read.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml">The next building block to inspect is the </span><code><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml">SortableCollection</span></code><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.113.2" xmlns="http://www.w3.org/1999/xhtml">It is composed of multiple string items (the </span><code><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml">Items</span></code><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml"> property) and can sort them using an </span><code><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml">ISortStrategy</span></code><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.117.2" xmlns="http://www.w3.org/1999/xhtml">On top of that, it implements the </span><code><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml">IEnumerable&lt;string&gt;</span></code><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml"> interface through its </span><code><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">Items</span></code><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml"> property, making it iterable. </span><span class="koboSpan" id="kobo.121.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml">using System.Collections;
using System.Collections.Immutable;
namespace MySortingMachine;
public sealed class SortableCollection : IEnumerable&lt;string&gt;
{
    private ISortStrategy _sortStrategy;
    private ImmutableArray&lt;string&gt; _items;
    public IEnumerable&lt;string&gt; Items =&gt; _items;
    public SortableCollection(IEnumerable&lt;string&gt; items)
    {
        _items = items.ToImmutableArray();
        _sortStrategy = new SortAscendingStrategy();
    }
    public void SetSortStrategy(ISortStrategy strategy)
        =&gt; _sortStrategy = strategy;
    public void Sort()
    {
        _items = _sortStrategy
            .Sort(Items)
            .ToImmutableArray()
        ;
    }
    public IEnumerator&lt;string&gt; GetEnumerator()
        =&gt; Items.GetEnumerator();
    IEnumerator IEnumerable.GetEnumerator()
        =&gt; ((IEnumerable)Items).GetEnumerator();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">SortableCollection</span></code><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml"> class is the most complex one so far, so let’s take a more in-depth look:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml">_sortStrategy</span></code><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml"> field references the algorithm: an </span><code><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml">ISortStrategy</span></code><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml"> implementation.</span></li>
<li><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml">_items</span></code><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml"> field references the strings themselves.</span></li>
<li><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml">Items</span></code><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml"> property exposes the strings to the consumers of the class.</span></li>
<li><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml">The constructor initializes the </span><code><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml">Items</span></code><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml"> property using the </span><code><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml">items</span></code><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml"> parameter and sets the default sorting strategy.</span></li>
<li><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml">SetSortStrategy</span></code><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml"> method allows consumers to change the strategy at runtime.</span></li>
<li><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">Sort</span></code><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml"> method uses the </span><code><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">_sortStrategy</span></code><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml"> field to sort the items.</span></li>
<li><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml">The two </span><code><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml">GetEnumerator</span></code><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml"> methods represent the implementation of the </span><code><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml">IEnumerable&lt;string&gt;</span></code><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml"> interface and make the class enumerable through the </span><code><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml">Items</span></code><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml"> property.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml">With that code, we can see the Strategy pattern in action. </span><span class="koboSpan" id="kobo.157.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">_sortStrategy</span></code><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml"> field represents the current algorithm, respecting an </span><code><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml">ISortStrategy</span></code><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml"> contract, which is updatable at runtime using the </span><code><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">SetSortStrategy</span></code><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.163.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml">Sort</span></code><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml"> method delegates the work to the </span><code><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml">ISortStrategy</span></code><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml"> implementation (the concrete strategy). </span><span class="koboSpan" id="kobo.167.2" xmlns="http://www.w3.org/1999/xhtml">Therefore, changing the value of the </span><code><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml">_sortStrategy</span></code><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml"> field leads to a change of behavior of the </span><code><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml">Sort</span></code><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml"> method, making this pattern very powerful yet simple. </span><span class="koboSpan" id="kobo.171.2" xmlns="http://www.w3.org/1999/xhtml">The highlighted code represents this pattern.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml">_items</span></code><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml"> field is an </span><code><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">ImmutableArray&lt;string&gt;</span></code><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml">, which makes changing the list impossible from the outside. </span><span class="koboSpan" id="kobo.176.2" xmlns="http://www.w3.org/1999/xhtml">For example, a consumer cannot pass a </span><code><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml">List&lt;string&gt;</span></code><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml"> to the constructor, then change it later. </span><span class="koboSpan" id="kobo.178.2" xmlns="http://www.w3.org/1999/xhtml">Immutability has many advantages.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml">Let’s experiment with this by looking at the </span><code><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">Consumer.API</span></code><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml"> project a REST API application that uses the previous code. </span><span class="koboSpan" id="kobo.181.2" xmlns="http://www.w3.org/1999/xhtml">Next is a breakdown of the </span><code><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml"> file:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">using MySortingMachine;
SortableCollection data = new(new[] { 
    "Lorem", "ipsum", "dolor", "sit", "amet." </span><span class="koboSpan" id="kobo.184.2" xmlns="http://www.w3.org/1999/xhtml">});</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml">data</span></code><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml"> member is the context, our sortable collection of items. </span><span class="koboSpan" id="kobo.187.2" xmlns="http://www.w3.org/1999/xhtml">Next, we look at some boilerplate code to create the application and serialize </span><code><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml">enum</span></code><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml"> values as strings:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml">var builder = WebApplication.CreateBuilder(args);
builder.Services.ConfigureHttpJsonOptions(options =&gt; {
    options.SerializerOptions.Converters
        .Add(new JsonStringEnumConverter());
});
var app = builder.Build();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml">Finally, the last part represents the consumer of the context:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet("/", () =&gt; data);
app.MapPut("/", (ReplaceSortStrategy sortStrategy) =&gt;
{
    ISortStrategy strategy = sortStrategy.SortOrder == SortOrder.Ascending
        ? </span><span class="koboSpan" id="kobo.192.2" xmlns="http://www.w3.org/1999/xhtml">new SortAscendingStrategy()
        : new SortDescendingStrategy();
    data.SetSortStrategy(strategy);
    data.Sort();
    return data;
});
app.Run();
public enum SortOrder
{
    Ascending,
    Descending
}
public record class ReplaceSortStrategy(SortOrder SortOrder);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we declared the following endpoints:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml">The first endpoint returns the </span><code><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml">data</span></code><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml"> object when a client sends a </span><code><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml">GET</span></code><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml"> request.</span></li>
<li><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml">The second endpoint allows changing the sort strategy based on the </span><code><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml">SortOrder</span></code><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml"> enum when a client sends a </span><strong><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml">PUT</span></strong><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml"> request. </span><span class="koboSpan" id="kobo.203.2" xmlns="http://www.w3.org/1999/xhtml">Once the strategy is modified, it sorts the collection and returns the sorted data.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">The highlighted code represents the consumption of this implementation of the strategy pattern.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml">ReplaceSortStrategy</span></code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml"> class is an input DTO. </span><span class="koboSpan" id="kobo.207.2" xmlns="http://www.w3.org/1999/xhtml">Combined with the </span><code><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml">SortOrder</span></code><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml"> enum, they represent the data contract of the second endpoint.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml">When we run the API and request the first endpoint, it responds with the following JSON body:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">[
  "Lorem",
  "ipsum",
  "dolor",
  "sit",
  "amet."
</span><span class="koboSpan" id="kobo.211.2" xmlns="http://www.w3.org/1999/xhtml">]</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">As we can see, the items are in the order we set them because the code never called the </span><code><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml">Sort</span></code><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.214.2" xmlns="http://www.w3.org/1999/xhtml">Next, let’s send the following HTTP request to the API to change the sort strategy to “descending”:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml">PUT https://localhost:7280/
Content-Type: application/json
{
    "sortOrder": "Descending"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml">After the execution, the endpoint responds with the following JSON data:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml">[
  "sit",
  "Lorem",
  "ipsum",
  "dolor",
  "amet."
</span><span class="koboSpan" id="kobo.217.2" xmlns="http://www.w3.org/1999/xhtml">]</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml">As we can see from the content, the sorting algorithm worked. </span><span class="koboSpan" id="kobo.218.2" xmlns="http://www.w3.org/1999/xhtml">Afterward, the list will remain in the same order if we query the GET endpoint. </span><span class="koboSpan" id="kobo.218.3" xmlns="http://www.w3.org/1999/xhtml">Next, let’s look at this use case using a sequence diagram:</span></p>
<figure>
<span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 7.3: Sequence diagram sorting the items using the “sort descending strategy”" src="../media/file35.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml">Figure 7.3: Sequence diagram sorting the items using the “sort descending strategy”</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml">The preceding diagram shows the </span><code><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml">Program</span></code><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml"> creating a strategy and assigning it to </span><code><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">SortableCollection</span></code><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml"> using its </span><code><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml">SetSortStrategy</span></code><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.227.2" xmlns="http://www.w3.org/1999/xhtml">Then, when the </span><code><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml">Program</span></code><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml"> calls the </span><code><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml">Sort()</span></code><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml"> method, the </span><code><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml">SortableCollection</span></code><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml"> instance delegates the sorting computation to the underlying implementation of the </span><code><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml">ISortStrategy</span></code><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.235.2" xmlns="http://www.w3.org/1999/xhtml">That implementation is the </span><code><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml">SortDescendingStrategy</span></code><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml"> class (the </span><strong><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml">strategy</span></strong><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml">) which was set by the </span><code><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml">Program</span></code><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml"> at the beginning.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml">Sending another </span><code><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml">PUT</span></code><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml"> request but specifying the </span><code><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml">Ascending</span></code><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml"> sort order end up in a similar result, but the items would be sorted alphabetically.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml">The HTTP requests are available in the </span><code><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml">Consumer.API.http</span></code><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml"> file.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">From a strategy pattern perspective, the </span><code><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml">SortableCollection</span></code><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml"> class (the </span><strong><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml">context</span></strong><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">) is responsible for referencing and using the current strategy.</span></p>
</section>
<section class="level3" data-number="8.2.4" id="conclusion-8">
<h3 data-number="8.2.4"><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">Conclusion</span></h3>
<p><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml">The Strategy design pattern is very effective at delegating responsibilities to other objects, allowing you to hand over the responsibility of an algorithm to other objects while keeping its usage trivial. </span><span class="koboSpan" id="kobo.256.2" xmlns="http://www.w3.org/1999/xhtml">It also allows having a rich interface (context) with behaviors that can change at runtime.As we can see, the Strategy pattern is excellent at helping us follow the </span><strong><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml">SOLID</span></strong><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml"> principles:</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">S</span></strong><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">: It helps extract responsibilities from external classes and use them interchangeably.</span></li>
<li><strong><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml">O</span></strong><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">: It allows extending classes without updating its code by changing the current strategy at runtime, which is pretty much the actual definition of the OCP.</span></li>
<li><strong><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml">L</span></strong><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">: It does not rely on inheritance. </span><span class="koboSpan" id="kobo.264.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, it plays a large role in the </span><em><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml">composition over inheritance principle</span></em><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml">, helping us avoid inheritance altogether and the LSP.</span></li>
<li><strong><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml">I</span></strong><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml">: By creating smaller strategies based on lean and focused interfaces, the Strategy pattern is an excellent enabler of the ISP.</span></li>
<li><strong><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml">D</span></strong><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml">: The creation of dependencies is moved from the class using the strategy (the context) to the class’s consumer. </span><span class="koboSpan" id="kobo.270.2" xmlns="http://www.w3.org/1999/xhtml">That makes the context depend on abstraction instead of implementation, inverting the flow of control.</span></li>
</ul>
<blockquote>
<p><strong><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml">C# Features</span></strong></p>
<blockquote>
<p><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml">If you noticed C# features you are less familiar with, </span><em><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml">Appendix A</span></em><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml"> explains many of them briefly.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml">Next, let’s explore the Abstract Factory pattern.</span></p>
</section>
</section>
<section class="level2" data-number="8.3" id="the-abstract-factory-design-pattern">
<h2 data-number="8.3"><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml">The Abstract Factory design pattern</span></h2>
<p><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml">The Abstract Factory design pattern is a creational design pattern from the GoF. </span><span class="koboSpan" id="kobo.277.2" xmlns="http://www.w3.org/1999/xhtml">We use creational patterns to create other objects, and factories are a very popular way of doing that.The Strategy pattern is the backbone of dependency injection, enabling the composition of complex object trees, while factories are used to create some of those complex objects that can’t be assembled automatically by a dependency injection library. </span><span class="koboSpan" id="kobo.277.3" xmlns="http://www.w3.org/1999/xhtml">More on that in the next chapter.</span></p>
<section class="level3" data-number="8.3.1" id="goal-5">
<h3 data-number="8.3.1"><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml">Goal</span></h3>
<p><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml">The Abstract Factory pattern is used to abstract the creation of a family of objects. </span><span class="koboSpan" id="kobo.279.2" xmlns="http://www.w3.org/1999/xhtml">It usually implies the creation of multiple object types within that family. </span><span class="koboSpan" id="kobo.279.3" xmlns="http://www.w3.org/1999/xhtml">A family is a group of related or dependent objects (classes).Let’s think about creating automotive vehicles. </span><span class="koboSpan" id="kobo.279.4" xmlns="http://www.w3.org/1999/xhtml">There are multiple vehicle types, and there are multiple models and makes for each type. </span><span class="koboSpan" id="kobo.279.5" xmlns="http://www.w3.org/1999/xhtml">We can use the Abstract Factory pattern to model this sort of scenario.</span></p>
<blockquote>
<p><strong><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml">Note</span></strong></p>
<blockquote>
<p><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml">The </span><em><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">Factory Method</span></em><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml"> pattern also focuses on creating a single type of object instead of a family. </span><span class="koboSpan" id="kobo.283.2" xmlns="http://www.w3.org/1999/xhtml">We only cover Abstract Factory here, but we use other types of factories later in the book.</span></p>
</blockquote>
</blockquote>
</section>
<section class="level3" data-number="8.3.2" id="design-5">
<h3 data-number="8.3.2"><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">Design</span></h3>
<p><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml">With Abstract Factory, the consumer asks for an abstract object and gets one. </span><span class="koboSpan" id="kobo.285.2" xmlns="http://www.w3.org/1999/xhtml">The factory is an abstraction, and the resulting objects are also abstractions, decoupling the creation of an object from its consumers.That allows adding or removing families of objects produced together without impacting the consumers (all actors communicate through abstractions).In our case, the family (the set of objects the factory can produce) is composed of a car and a bike, and each factory (family) must produce both objects.If we think about vehicles, we could have the ability to create low- and high-end models of each vehicle type. </span><span class="koboSpan" id="kobo.285.3" xmlns="http://www.w3.org/1999/xhtml">Here is a diagram representing how to achieve that using the Abstract Factory pattern:</span></p>
<figure>
<span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 7.4: Abstract Factory class diagram" src="../media/file36.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml">Figure 7.4: Abstract Factory class diagram</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">In the diagram, we have the following elements:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml">IVehicleFactory</span></code><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml"> interface represents the Abstract Factory. </span><span class="koboSpan" id="kobo.291.2" xmlns="http://www.w3.org/1999/xhtml">It defines two methods: one that creates cars of type </span><code><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml">ICar</span></code><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml"> and another that creates bikes of type </span><code><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml">IBike</span></code><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml">HighEndVehicleFactory</span></code><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml"> class is a concrete factory implementing the </span><code><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml">IVehicleFactory</span></code><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.300.2" xmlns="http://www.w3.org/1999/xhtml">It handles high-end vehicle model creation, and its methods return </span><code><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">HighEndCar</span></code><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml">HighEndBike</span></code><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml"> instances.</span></li>
<li><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">LowEndVehicleFactory</span></code><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml"> is a second concrete factory implementing the </span><code><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml">IVehicleFactory</span></code><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.309.2" xmlns="http://www.w3.org/1999/xhtml">It handles low-end vehicle model creation, and its methods return </span><code><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">LowEndCar</span></code><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml">LowEndBike</span></code><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml"> instances.</span></li>
<li><code><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml">LowEndCar</span></code><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml">HighEndCar</span></code><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml"> are two implementations of </span><code><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml">ICar</span></code><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><code><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml">LowEndBike</span></code><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml">HighEndBike</span></code><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml"> are two implementations of </span><code><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml">IBike</span></code><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml">Based on that diagram, consumers use the concrete factories through the </span><code><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml">IVehicleFactory</span></code><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml"> interface and should not be aware of the implementation used underneath. </span><span class="koboSpan" id="kobo.328.2" xmlns="http://www.w3.org/1999/xhtml">Applying this pattern abstracts away the vehicle creation process.</span></p>
</section>
<section class="level3" data-number="8.3.3" id="project-abstract-factory">
<h3 data-number="8.3.3"><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml">Project – Abstract Factory</span></h3>
<p><strong><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></strong><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml">: We need to support the creation of multiple models of vehicles. </span><span class="koboSpan" id="kobo.331.2" xmlns="http://www.w3.org/1999/xhtml">We also need to be able to add new models as they become available without impacting the system. </span><span class="koboSpan" id="kobo.331.3" xmlns="http://www.w3.org/1999/xhtml">To begin with, we only support high-end and low-end models, but we know this will change sooner rather than later. </span><span class="koboSpan" id="kobo.331.4" xmlns="http://www.w3.org/1999/xhtml">The program must only support the creation of cars and bikes.For the sake of our demo, the vehicles are just empty classes and interfaces because learning how to model vehicles is not necessary to understand the pattern; that would be noise. </span><span class="koboSpan" id="kobo.331.5" xmlns="http://www.w3.org/1999/xhtml">The following code represents those entities:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml">public interface ICar { }
public interface IBike { }
public class LowEndCar : ICar { }
public class LowEndBike : IBike { }
public class HighEndCar : ICar { }
public class HighEndBike : IBike { }</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml">Next, we look at the part that we want to study—the factories:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml">public interface IVehicleFactory
{
    ICar CreateCar();
    IBike CreateBike();
}
public class LowEndVehicleFactory : IVehicleFactory
{
    public IBike CreateBike() =&gt; new LowEndBike();
    public ICar CreateCar() =&gt; new LowEndCar();
}
public class HighEndVehicleFactory : IVehicleFactory
{
    public IBike CreateBike() =&gt; new HighEndBike();
    public ICar CreateCar() =&gt; new HighEndCar();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml">The factories are simple implementations that describe the pattern well:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml">LowEndVehicleFactory</span></code><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml"> creates low-end models.</span></li>
<li><code><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">HighEndVehicleFactory</span></code><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml"> creates high-end models.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml">The consumer of this code is an xUnit test project. </span><span class="koboSpan" id="kobo.340.2" xmlns="http://www.w3.org/1999/xhtml">Unit tests are often your first consumers, especially if you are doing </span><strong><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml">test-driven development</span></strong><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><strong><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml">TDD</span></strong><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml">).To make the tests easier, I created the following base test class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">using Xunit;
namespace Vehicles;
public abstract class BaseAbstractFactoryTest&lt;TConcreteFactory, TExpectedCar, TExpectedBike&gt;
    where TConcreteFactory : IVehicleFactory, new()
{
    // Test methods here
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml">The key to that class is the following generic parameters:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">TConcreteFactory</span></code><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml"> parameter represents the type of concrete factory we want to test. </span><span class="koboSpan" id="kobo.349.2" xmlns="http://www.w3.org/1999/xhtml">Its generic constraint specifies that it must implement the </span><code><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">IVehicleFactory</span></code><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml"> interface and have a parameterless constructor.</span></li>
<li><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">TExpectedCar</span></code><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml"> parameter represents the type of </span><code><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml">ICar</span></code><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml"> we expect from the </span><code><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml">CreateCar</span></code><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml"> method.</span></li>
<li><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml">TExpectedBike</span></code><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml"> parameter represents the type of </span><code><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml">IBike</span></code><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml"> we expect from the </span><code><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml">CreateBike</span></code><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml"> method.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml">The first test method contained by that class is the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void Should_create_a_ICar_of_type_TExpectedCar()
{
    // Arrange
    IVehicleFactory vehicleFactory = new TConcreteFactory();
    var expectedCarType = typeof(TExpectedCar);
    // Act
    ICar result = vehicleFactory.CreateCar();
    // Assert
    Assert.IsType(expectedCarType, result);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml">The preceding test method creates a vehicle factory using the TConcreteFactory generic parameter, then creates a car using that factory. </span><span class="koboSpan" id="kobo.368.2" xmlns="http://www.w3.org/1999/xhtml">Finally, it asserts ICar instance is of the expected type.The second test method contains by that class is the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void Should_create_a_IBike_of_type_TExpectedBike()
{
    // Arrange
    IVehicleFactory vehicleFactory = new TConcreteFactory();
    var expectedBikeType = typeof(TExpectedBike);
    // Act
    IBike result = vehicleFactory.CreateBike();
    // Assert
    Assert.IsType(expectedBikeType, result);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml">The preceding test method is very similar and creates a vehicle factory using the </span><code><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml">TConcreteFactory</span></code><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml"> generic parameter but then creates a bike instead of a car using that factory. </span><span class="koboSpan" id="kobo.372.2" xmlns="http://www.w3.org/1999/xhtml">Finally, it asserts </span><code><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml">IBike</span></code><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml"> instance is of the expected type.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">I used the </span><code><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">ICar</span></code><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml">IBike</span></code><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml"> interfaces to type the variables instead of </span><code><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml">var</span></code><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">, to clarify the </span><code><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml">result</span></code><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml"> variable type. </span><span class="koboSpan" id="kobo.383.2" xmlns="http://www.w3.org/1999/xhtml">In another context, I would have used </span><code><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml">var</span></code><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml"> instead. </span><span class="koboSpan" id="kobo.385.2" xmlns="http://www.w3.org/1999/xhtml">The same applies to the </span><code><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml">IVehicleFactory</span></code><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml"> interface.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml">Now, to test the low-end factory, we declare the following test class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml">namespace Vehicles.LowEnd;
public class LowEndVehicleFactoryTest : BaseAbstractFactoryTest&lt;LowEndVehicleFactory, LowEndCar, LowEndBike&gt;
{ 
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml">That class solely depends on the </span><code><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml">BaseAbstractFactoryTest</span></code><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml"> class and specifies the types to test for (highlighted).Next, to test the high-end factory, we declare the following test class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml">namespace Vehicles.HighEnd;
public class HighEndVehicleFactoryTest : BaseAbstractFactoryTest&lt;HighEndVehicleFactory, HighEndCar, HighEndBike&gt;
{
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml">Like the low-end factory, that class depends on the </span><code><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">BaseAbstractFactoryTest</span></code><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml"> class and specifies the types to test for (highlighted).</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml">In a more complex scenario where we can’t use the </span><code><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml">new()</span></code><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml"> generic constraint, we can leverage an IoC container to create the instance of </span><code><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml">TConcreteFactory</span></code><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml"> and optionally mock its dependencies.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml">With that test code, we created the following two sets of two tests:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml">A </span><code><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml">LowEndVehicleFactory</span></code><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml"> class that should create a </span><code><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml">LowEndCar</span></code><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml"> instance.</span></li>
<li><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">A </span><code><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml">LowEndVehicleFactory</span></code><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml"> class that should create a </span><code><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml">LowEndBike</span></code><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml"> instance.</span></li>
<li><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml">A </span><code><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml">HighEndVehicleFactory</span></code><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml"> class that should create a </span><code><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml">HighEndCar</span></code><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml"> instance.</span></li>
<li><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">A </span><code><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">HighEndVehicleFactory</span></code><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml"> class that should create a </span><code><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml">HighEndBike</span></code><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml"> instance.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml">We now have four tests: two for bikes and two for cars.If we review the tests’ execution, both test methods are unaware of types. </span><span class="koboSpan" id="kobo.423.2" xmlns="http://www.w3.org/1999/xhtml">They use the Abstract Factory (</span><code><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml">IVehicleFactory</span></code><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml">) and test the </span><code><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml">result</span></code><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml"> against the expected type without knowing what they are testing but the abstraction. </span><span class="koboSpan" id="kobo.427.2" xmlns="http://www.w3.org/1999/xhtml">That shows how loosely coupled the consumers (tests) and the factories are.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml">We would use the </span><code><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml">ICar</span></code><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml"> or the </span><code><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">IBike</span></code><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml"> instances in a real-world program to do something relevant based on the specifications. </span><span class="koboSpan" id="kobo.432.2" xmlns="http://www.w3.org/1999/xhtml">That could be a racing game or a rich person’s garage management system; who knows!</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml">The important part of this project is </span><strong><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml">the abstraction of the object creation process</span></strong><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.435.2" xmlns="http://www.w3.org/1999/xhtml">The test code (consumer) is not aware of the implementations.Next, we extend our implementation.</span></p>
</section>
<section class="level3" data-number="8.3.4" id="project-the-mid-range-vehicle-factory">
<h3 data-number="8.3.4"><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml">Project – The mid-range vehicle factory</span></h3>
<p><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml">To prove the flexibility of our design based on the Abstract Factory pattern, let’s add a new concrete factory named </span><code><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml">MidRangeVehicleFactory</span></code><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.439.2" xmlns="http://www.w3.org/1999/xhtml">That factory should return a </span><code><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml">MidRangeCar</span></code><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml"> or a </span><code><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml">MidRangeBike</span></code><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml"> instance. </span><span class="koboSpan" id="kobo.443.2" xmlns="http://www.w3.org/1999/xhtml">Once again, the car and bike are just empty classes (of course, in your programs, they will do something):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml">public class MiddleGradeCar : ICar { }
public class MiddleGradeBike : IBike { }</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">The new </span><code><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml">MidRangeVehicleFactory</span></code><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml"> looks pretty much the same as the other two:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml">public class MidRangeVehicleFactory : IVehicleFactory
{
    public IBike CreateBike() =&gt; new MiddleGradeBike();
    public ICar CreateCar() =&gt; new MiddleGradeCar();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">Now, to test the mid-range factory, we declare the following test class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml">namespace Vehicles.MidRange;
public class MidRangeVehicleFactoryTest : BaseAbstractFactoryTest&lt;MidRangeVehicleFactory, MidRangeCar, MidRangeBike&gt;
{
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml">Like the low-end and high-end factories, the mid-range test class depends on the </span><code><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml">BaseAbstractFactoryTest</span></code><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml"> class and specifies the types to test for (highlighted).If we run the tests, we now have the following six passing tests:</span></p>
<figure>
<span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 7.5: Visual Studio Test Explorer showcasing the six passing tests." src="../media/file37.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml">Figure 7.5: Visual Studio Test Explorer showcasing the six passing tests.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml">So, without updating the consumer (the </span><code><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml">AbstractFactoryTest</span></code><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml"> class), we added a new family of vehicles, the middle-end cars and bikes; kudos to the Abstract Factory pattern for that wonderfulness!</span></p>
</section>
<section class="level3" data-number="8.3.5" id="impacts-of-the-abstract-factory">
<h3 data-number="8.3.5"><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml">Impacts of the Abstract Factory</span></h3>
<p><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml">Before concluding, what would happen if we packed everything in a large interface instead of using an Abstract Factory (breaking the ISP along the way)? </span><span class="koboSpan" id="kobo.460.2" xmlns="http://www.w3.org/1999/xhtml">We could have created something like the following interface:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml">public interface ILargeVehicleFactory
{
    HighEndBike CreateHighEndBike();
    HighEndCar CreateHighEndCar();
    LowEndBike CreateLowEndBike();
    LowEndCar CreateLowEndCar();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">As we can see, the preceding interface contains four specific methods and seems docile. </span><span class="koboSpan" id="kobo.462.2" xmlns="http://www.w3.org/1999/xhtml">However, the consumers of that code would be tightly coupled with those specific methods. </span><span class="koboSpan" id="kobo.462.3" xmlns="http://www.w3.org/1999/xhtml">For example, to change a consumer's behavior, we’d need to update its code, like changing the call from </span><code><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml">CreateHighEndBike</span></code><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml"> to </span><code><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml">CreateLowEndBike</span></code><span class="koboSpan" id="kobo.466.1" xmlns="http://www.w3.org/1999/xhtml">, which breaks the OCP. </span><span class="koboSpan" id="kobo.466.2" xmlns="http://www.w3.org/1999/xhtml">On the other hand, with the factory method, we can set a different factory for the consumers to spit out different results, which moves the flexibility out of the object itself and becomes a matter of composing the object graph instead (more on that in the next chapter).Moreover, when we want to add mid-range vehicles, we must update the </span><code><span class="koboSpan" id="kobo.467.1" xmlns="http://www.w3.org/1999/xhtml">ILargeVehicleFactory</span></code><span class="koboSpan" id="kobo.468.1" xmlns="http://www.w3.org/1999/xhtml"> interface, which becomes a breaking change (the implementation(s) of the </span><code><span class="koboSpan" id="kobo.469.1" xmlns="http://www.w3.org/1999/xhtml">ILargeVehicleFactory</span></code><span class="koboSpan" id="kobo.470.1" xmlns="http://www.w3.org/1999/xhtml"> must be updated). </span><span class="koboSpan" id="kobo.470.2" xmlns="http://www.w3.org/1999/xhtml">Here’s an example of the two new methods:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.471.1" xmlns="http://www.w3.org/1999/xhtml">public interface ILargeVehicleFactory
{
    HighEndBike CreateHighEndBike();
    HighEndCar CreateHighEndCar();
    LowEndBike CreateLowEndBike();
    LowEndCar CreateLowEndCar();
    MidRangeBike CreateMidRangeBike();
    MidRangeCar CreateMidRangeCar();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.472.1" xmlns="http://www.w3.org/1999/xhtml">From there, once the implementation(s) are updated, if we want to consume the new mid-range vehicles, we need to open each consumer class and apply the changes there, which once again breaks the OCP.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.473.1" xmlns="http://www.w3.org/1999/xhtml">The most crucial part is understanding and seeing the coupling and its impacts. </span><span class="koboSpan" id="kobo.473.2" xmlns="http://www.w3.org/1999/xhtml">Sometimes, it's okay to tightly couple one or more classes together as we don’t always need the added flexibility the SOLID principles and some design patterns can bring.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.474.1" xmlns="http://www.w3.org/1999/xhtml">Now let’s conclude before exploring the last design pattern of the chapter.</span></p>
</section>
<section class="level3" data-number="8.3.6" id="conclusion-9">
<h3 data-number="8.3.6"><span class="koboSpan" id="kobo.475.1" xmlns="http://www.w3.org/1999/xhtml">Conclusion</span></h3>
<p><span class="koboSpan" id="kobo.476.1" xmlns="http://www.w3.org/1999/xhtml">The Abstract Factory pattern is excellent for abstracting away the creation of object families, isolating each family and its concrete implementation, leaving the consumers unaware of the family created at runtime by the factory.We talk more about factories in the next chapter; meanwhile, let’s see how the Abstract Factory pattern can help us follow the </span><strong><span class="koboSpan" id="kobo.477.1" xmlns="http://www.w3.org/1999/xhtml">SOLID</span></strong><span class="koboSpan" id="kobo.478.1" xmlns="http://www.w3.org/1999/xhtml"> principles:</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.479.1" xmlns="http://www.w3.org/1999/xhtml">S</span></strong><span class="koboSpan" id="kobo.480.1" xmlns="http://www.w3.org/1999/xhtml">: Each concrete factory is solely responsible for creating a family of objects. </span><span class="koboSpan" id="kobo.480.2" xmlns="http://www.w3.org/1999/xhtml">You could combine Abstract Factory with other creational patterns, such as the </span><strong><span class="koboSpan" id="kobo.481.1" xmlns="http://www.w3.org/1999/xhtml">Prototype</span></strong><span class="koboSpan" id="kobo.482.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><strong><span class="koboSpan" id="kobo.483.1" xmlns="http://www.w3.org/1999/xhtml">Builder</span></strong><span class="koboSpan" id="kobo.484.1" xmlns="http://www.w3.org/1999/xhtml"> patterns for more complex creational needs.</span></li>
<li><strong><span class="koboSpan" id="kobo.485.1" xmlns="http://www.w3.org/1999/xhtml">O</span></strong><span class="koboSpan" id="kobo.486.1" xmlns="http://www.w3.org/1999/xhtml">: We can create new families of objects, like the mid-range vehicles, without breaking existing client code.</span></li>
<li><strong><span class="koboSpan" id="kobo.487.1" xmlns="http://www.w3.org/1999/xhtml">L</span></strong><span class="koboSpan" id="kobo.488.1" xmlns="http://www.w3.org/1999/xhtml">: We aim at composition, so there’s no need for any inheritance, implicitly discarding the need for the LSP. </span><span class="koboSpan" id="kobo.488.2" xmlns="http://www.w3.org/1999/xhtml">If you use abstract classes in your design, you must ensure you don’t break the LSP when creating new abstract factories.</span></li>
<li><strong><span class="koboSpan" id="kobo.489.1" xmlns="http://www.w3.org/1999/xhtml">I</span></strong><span class="koboSpan" id="kobo.490.1" xmlns="http://www.w3.org/1999/xhtml">: Extracting a small abstraction with many implementations where each concrete factory focuses on one family makes that interface very focused on one task instead of having a large interface that exposes all types of products (like the </span><code><span class="koboSpan" id="kobo.491.1" xmlns="http://www.w3.org/1999/xhtml">ILargeVehicleFactory</span></code><span class="koboSpan" id="kobo.492.1" xmlns="http://www.w3.org/1999/xhtml"> interface).</span></li>
<li><strong><span class="koboSpan" id="kobo.493.1" xmlns="http://www.w3.org/1999/xhtml">D</span></strong><span class="koboSpan" id="kobo.494.1" xmlns="http://www.w3.org/1999/xhtml">: By depending only on interfaces, the consumer is unaware of the concrete types it uses.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.495.1" xmlns="http://www.w3.org/1999/xhtml">Next, we explore the last design pattern of the chapter.</span></p>
</section>
</section>
<section class="level2" data-number="8.4" id="the-singleton-design-pattern">
<h2 data-number="8.4"><span class="koboSpan" id="kobo.496.1" xmlns="http://www.w3.org/1999/xhtml">The Singleton design pattern</span></h2>
<p><span class="koboSpan" id="kobo.497.1" xmlns="http://www.w3.org/1999/xhtml">The Singleton design pattern allows creating and reusing a single instance of a class. </span><span class="koboSpan" id="kobo.497.2" xmlns="http://www.w3.org/1999/xhtml">We could use a static class to achieve almost the same goal, but not everything is doable using static classes. </span><span class="koboSpan" id="kobo.497.3" xmlns="http://www.w3.org/1999/xhtml">For example, a static class can’t implement an interface. </span><span class="koboSpan" id="kobo.497.4" xmlns="http://www.w3.org/1999/xhtml">We can’t pass an instance of a static class as an argument because there is no instance. </span><span class="koboSpan" id="kobo.497.5" xmlns="http://www.w3.org/1999/xhtml">We can only use static classes directly, which leads to tight coupling every time.The Singleton pattern in C# is an anti-pattern, and we should rarely use it, if ever, and use dependency injection instead. </span><span class="koboSpan" id="kobo.497.6" xmlns="http://www.w3.org/1999/xhtml">That said, it is a classic design pattern worth learning to at least avoid implementing it. </span><span class="koboSpan" id="kobo.497.7" xmlns="http://www.w3.org/1999/xhtml">We explore a better alternative in the next chapter.Here are a few reasons why we are covering this pattern:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.498.1" xmlns="http://www.w3.org/1999/xhtml">It translates into a singleton scope in the next chapter.</span></li>
<li><span class="koboSpan" id="kobo.499.1" xmlns="http://www.w3.org/1999/xhtml">Without knowing about it, you cannot locate it, try to remove it, or avoid its usage.</span></li>
<li><span class="koboSpan" id="kobo.500.1" xmlns="http://www.w3.org/1999/xhtml">It is a simple pattern to explore.</span></li>
<li><span class="koboSpan" id="kobo.501.1" xmlns="http://www.w3.org/1999/xhtml">It leads to other patterns, such as the </span><strong><span class="koboSpan" id="kobo.502.1" xmlns="http://www.w3.org/1999/xhtml">Ambient Context</span></strong><span class="koboSpan" id="kobo.503.1" xmlns="http://www.w3.org/1999/xhtml"> pattern.</span></li>
</ul>
<section class="level3" data-number="8.4.1" id="goal-6">
<h3 data-number="8.4.1"><span class="koboSpan" id="kobo.504.1" xmlns="http://www.w3.org/1999/xhtml">Goal</span></h3>
<p><span class="koboSpan" id="kobo.505.1" xmlns="http://www.w3.org/1999/xhtml">The Singleton pattern limits the number of instances of a class to one. </span><span class="koboSpan" id="kobo.505.2" xmlns="http://www.w3.org/1999/xhtml">Then, the idea is to reuse the same instance subsequently. </span><span class="koboSpan" id="kobo.505.3" xmlns="http://www.w3.org/1999/xhtml">A singleton encapsulates both the object logic itself and its creational logic. </span><span class="koboSpan" id="kobo.505.4" xmlns="http://www.w3.org/1999/xhtml">For example, the Singleton pattern could lower the cost of instantiating an object with a large memory footprint since the program instantiates it only once.Can you think of a SOLID principle that gets broken right there?The Singleton pattern promotes that one object must have two responsibilities, breaking the </span><strong><span class="koboSpan" id="kobo.506.1" xmlns="http://www.w3.org/1999/xhtml">Single Responsibility Principle</span></strong><span class="koboSpan" id="kobo.507.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><strong><span class="koboSpan" id="kobo.508.1" xmlns="http://www.w3.org/1999/xhtml">SRP</span></strong><span class="koboSpan" id="kobo.509.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.509.2" xmlns="http://www.w3.org/1999/xhtml">A singleton is the object itself and its own factory.</span></p>
</section>
<section class="level3" data-number="8.4.2" id="design-6">
<h3 data-number="8.4.2"><span class="koboSpan" id="kobo.510.1" xmlns="http://www.w3.org/1999/xhtml">Design</span></h3>
<p><span class="koboSpan" id="kobo.511.1" xmlns="http://www.w3.org/1999/xhtml">This design pattern is straightforward and is limited to a single class. </span><span class="koboSpan" id="kobo.511.2" xmlns="http://www.w3.org/1999/xhtml">Let’s start with a class diagram:</span></p>
<figure>
<span class="koboSpan" id="kobo.512.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 7.6: Singleton pattern class diagram" src="../media/file38.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.513.1" xmlns="http://www.w3.org/1999/xhtml">Figure 7.6: Singleton pattern class diagram</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.514.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.515.1" xmlns="http://www.w3.org/1999/xhtml">Singleton</span></code><span class="koboSpan" id="kobo.516.1" xmlns="http://www.w3.org/1999/xhtml"> class is composed of the following:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.517.1" xmlns="http://www.w3.org/1999/xhtml">A private static field that holds its unique instance.</span></li>
<li><span class="koboSpan" id="kobo.518.1" xmlns="http://www.w3.org/1999/xhtml">A public static </span><code><span class="koboSpan" id="kobo.519.1" xmlns="http://www.w3.org/1999/xhtml">Create()</span></code><span class="koboSpan" id="kobo.520.1" xmlns="http://www.w3.org/1999/xhtml"> method that creates or returns the unique instance.</span></li>
<li><span class="koboSpan" id="kobo.521.1" xmlns="http://www.w3.org/1999/xhtml">A private constructor, so external code cannot instantiate it without passing by the </span><code><span class="koboSpan" id="kobo.522.1" xmlns="http://www.w3.org/1999/xhtml">Create</span></code><span class="koboSpan" id="kobo.523.1" xmlns="http://www.w3.org/1999/xhtml"> method.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.524.1" xmlns="http://www.w3.org/1999/xhtml">You can name the </span><code><span class="koboSpan" id="kobo.525.1" xmlns="http://www.w3.org/1999/xhtml">Create()</span></code><span class="koboSpan" id="kobo.526.1" xmlns="http://www.w3.org/1999/xhtml"> method anything or even get rid of it, as we see in the next example. </span><span class="koboSpan" id="kobo.526.2" xmlns="http://www.w3.org/1999/xhtml">We could name it </span><code><span class="koboSpan" id="kobo.527.1" xmlns="http://www.w3.org/1999/xhtml">GetInstance()</span></code><span class="koboSpan" id="kobo.528.1" xmlns="http://www.w3.org/1999/xhtml">, or it could be a static property named </span><code><span class="koboSpan" id="kobo.529.1" xmlns="http://www.w3.org/1999/xhtml">Instance</span></code><span class="koboSpan" id="kobo.530.1" xmlns="http://www.w3.org/1999/xhtml"> or bear any other relevant name.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.531.1" xmlns="http://www.w3.org/1999/xhtml">We can translate the preceding diagram to the following code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.532.1" xmlns="http://www.w3.org/1999/xhtml">public class MySingleton
{
    private static MySingleton? </span><span class="koboSpan" id="kobo.532.2" xmlns="http://www.w3.org/1999/xhtml">_instance;
    private MySingleton() { }
    public static MySingleton Create()
    {
        _instance ??= new MySingleton();
        return _instance;
    }
}</span></code></pre>
</div>
<blockquote>
<p><span class="koboSpan" id="kobo.533.1" xmlns="http://www.w3.org/1999/xhtml">The null-coalescing assignment operator </span><code><span class="koboSpan" id="kobo.534.1" xmlns="http://www.w3.org/1999/xhtml">??=</span></code><span class="koboSpan" id="kobo.535.1" xmlns="http://www.w3.org/1999/xhtml"> assigns the new instance of </span><code><span class="koboSpan" id="kobo.536.1" xmlns="http://www.w3.org/1999/xhtml">MySingleton</span></code><span class="koboSpan" id="kobo.537.1" xmlns="http://www.w3.org/1999/xhtml"> only if the </span><code><span class="koboSpan" id="kobo.538.1" xmlns="http://www.w3.org/1999/xhtml">_instance</span></code><span class="koboSpan" id="kobo.539.1" xmlns="http://www.w3.org/1999/xhtml"> member is </span><code><span class="koboSpan" id="kobo.540.1" xmlns="http://www.w3.org/1999/xhtml">null</span></code><span class="koboSpan" id="kobo.541.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.541.2" xmlns="http://www.w3.org/1999/xhtml">That line is equivalent to writing the following if statement:</span></p>
</blockquote>
<pre><code><span class="koboSpan" id="kobo.542.1" xmlns="http://www.w3.org/1999/xhtml">if (_instance == null)
{
    _instance = new MySingleton();
}</span></code></pre>
<p><span class="koboSpan" id="kobo.543.1" xmlns="http://www.w3.org/1999/xhtml">Before discussing the code more, let’s explore our new class's behavior. </span><span class="koboSpan" id="kobo.543.2" xmlns="http://www.w3.org/1999/xhtml">We can see in the following unit test that </span><code><span class="koboSpan" id="kobo.544.1" xmlns="http://www.w3.org/1999/xhtml">MySingleton.Create()</span></code><span class="koboSpan" id="kobo.545.1" xmlns="http://www.w3.org/1999/xhtml"> always returns the same instance as expected:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.546.1" xmlns="http://www.w3.org/1999/xhtml">public class MySingletonTest
{
    [Fact]
    public void Create_should_always_return_the_same_instance()
    {
        var first = MySingleton.Create();
        var second = MySingleton.Create();
        Assert.Same(first, second);
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.547.1" xmlns="http://www.w3.org/1999/xhtml">And voilà! </span><span class="koboSpan" id="kobo.547.2" xmlns="http://www.w3.org/1999/xhtml">We have a working Singleton pattern, which is extremely simple—probably the most simple design pattern that I can think of.Here is what is happening under the hood:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.548.1" xmlns="http://www.w3.org/1999/xhtml">The first time that a consumer calls </span><code><span class="koboSpan" id="kobo.549.1" xmlns="http://www.w3.org/1999/xhtml">MySingleton.Create()</span></code><span class="koboSpan" id="kobo.550.1" xmlns="http://www.w3.org/1999/xhtml">, it creates the first instance of </span><code><span class="koboSpan" id="kobo.551.1" xmlns="http://www.w3.org/1999/xhtml">MySingleton</span></code><span class="koboSpan" id="kobo.552.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.552.2" xmlns="http://www.w3.org/1999/xhtml">Since the constructor is </span><code><span class="koboSpan" id="kobo.553.1" xmlns="http://www.w3.org/1999/xhtml">private</span></code><span class="koboSpan" id="kobo.554.1" xmlns="http://www.w3.org/1999/xhtml">, it can only be created from the inside.</span></li>
<li><span class="koboSpan" id="kobo.555.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.556.1" xmlns="http://www.w3.org/1999/xhtml">Create</span></code><span class="koboSpan" id="kobo.557.1" xmlns="http://www.w3.org/1999/xhtml"> method then persists that first instance to the </span><code><span class="koboSpan" id="kobo.558.1" xmlns="http://www.w3.org/1999/xhtml">_instance</span></code><span class="koboSpan" id="kobo.559.1" xmlns="http://www.w3.org/1999/xhtml"> field for future use.</span></li>
<li><span class="koboSpan" id="kobo.560.1" xmlns="http://www.w3.org/1999/xhtml">When a consumer calls </span><code><span class="koboSpan" id="kobo.561.1" xmlns="http://www.w3.org/1999/xhtml">MySingleton.Create()</span></code><span class="koboSpan" id="kobo.562.1" xmlns="http://www.w3.org/1999/xhtml"> a second time, it returns the </span><code><span class="koboSpan" id="kobo.563.1" xmlns="http://www.w3.org/1999/xhtml">_instance</span></code><span class="koboSpan" id="kobo.564.1" xmlns="http://www.w3.org/1999/xhtml"> field, reusing the class's previous (and only) instance.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.565.1" xmlns="http://www.w3.org/1999/xhtml">Now that we understand the logic, there is a potential issue with that design: it is not thread-safe. </span><span class="koboSpan" id="kobo.565.2" xmlns="http://www.w3.org/1999/xhtml">If we want our singleton to be thread-safe, we can </span><code><span class="koboSpan" id="kobo.566.1" xmlns="http://www.w3.org/1999/xhtml">lock</span></code><span class="koboSpan" id="kobo.567.1" xmlns="http://www.w3.org/1999/xhtml"> the instance creation like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.568.1" xmlns="http://www.w3.org/1999/xhtml">public class MySingletonWithLock
{
    private static readonly object _myLock = new();
    private static MySingletonWithLock? </span><span class="koboSpan" id="kobo.568.2" xmlns="http://www.w3.org/1999/xhtml">_instance;
    private MySingletonWithLock() { }
    public static MySingletonWithLock Create()
    {
        lock (_myLock)
        {
            _instance ??= new MySingletonWithLock();
        }
        return _instance;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.569.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we ensure two threads are not attempting to access the </span><code><span class="koboSpan" id="kobo.570.1" xmlns="http://www.w3.org/1999/xhtml">Create</span></code><span class="koboSpan" id="kobo.571.1" xmlns="http://www.w3.org/1999/xhtml"> method simultaneously to ensure they are not getting different instances. </span><span class="koboSpan" id="kobo.571.2" xmlns="http://www.w3.org/1999/xhtml">Next, we improve our thread-safe example by making it shorter.</span></p>
</section>
<section class="level3" data-number="8.4.3" id="an-alternate-better-way">
<h3 data-number="8.4.3"><span class="koboSpan" id="kobo.572.1" xmlns="http://www.w3.org/1999/xhtml">An alternate (better) way</span></h3>
<p><span class="koboSpan" id="kobo.573.1" xmlns="http://www.w3.org/1999/xhtml">Previously, we used the “long way” of implementing the Singleton pattern and had to implement a thread-safe mechanism. </span><span class="koboSpan" id="kobo.573.2" xmlns="http://www.w3.org/1999/xhtml">Now that classic is behind us. </span><span class="koboSpan" id="kobo.573.3" xmlns="http://www.w3.org/1999/xhtml">We can shorten that code and even get rid of the </span><code><span class="koboSpan" id="kobo.574.1" xmlns="http://www.w3.org/1999/xhtml">Create()</span></code><span class="koboSpan" id="kobo.575.1" xmlns="http://www.w3.org/1999/xhtml"> method like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.576.1" xmlns="http://www.w3.org/1999/xhtml">public class MySimpleSingleton
{
    public static MySimpleSingleton Instance { get; } = new MySimpleSingleton();
    private MySimpleSingleton() { }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.577.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code relies on the static initializer to ensure that only one instance of the </span><code><span class="koboSpan" id="kobo.578.1" xmlns="http://www.w3.org/1999/xhtml">MySimpleSingleton</span></code><span class="koboSpan" id="kobo.579.1" xmlns="http://www.w3.org/1999/xhtml"> class is created and assigned to the </span><code><span class="koboSpan" id="kobo.580.1" xmlns="http://www.w3.org/1999/xhtml">Instance</span></code><span class="koboSpan" id="kobo.581.1" xmlns="http://www.w3.org/1999/xhtml"> property.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.582.1" xmlns="http://www.w3.org/1999/xhtml">This simple technique should do the trick unless the singleton's constructor executes some heavy processing.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.583.1" xmlns="http://www.w3.org/1999/xhtml">With the property instead of a method, we can use the singleton class like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.584.1" xmlns="http://www.w3.org/1999/xhtml">MySimpleSingleton.Instance.SomeOperation();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.585.1" xmlns="http://www.w3.org/1999/xhtml">We can prove the correctness of that claim by executing the following test method:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.586.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void Create_should_always_return_the_same_instance()
{
    var first = MySimpleSingleton.Instance;
    var second = MySimpleSingleton.Instance;
    Assert.Same(first, second);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.587.1" xmlns="http://www.w3.org/1999/xhtml">It is usually best to delegate responsibilities to the language or the framework whenever possible like we did here with the property initializer. </span><span class="koboSpan" id="kobo.587.2" xmlns="http://www.w3.org/1999/xhtml">Using a static constructor would also be a valid, thread-safe alternative, once again delegating the job to language features.</span></p>
<blockquote>
<p><strong><span class="koboSpan" id="kobo.588.1" xmlns="http://www.w3.org/1999/xhtml">Beware of the arrow operator.</span></strong></p>
<blockquote>
<p><span class="koboSpan" id="kobo.589.1" xmlns="http://www.w3.org/1999/xhtml">It may be tempting to use the arrow operator </span><code><span class="koboSpan" id="kobo.590.1" xmlns="http://www.w3.org/1999/xhtml">=&gt;</span></code><span class="koboSpan" id="kobo.591.1" xmlns="http://www.w3.org/1999/xhtml"> to initialize the </span><code><span class="koboSpan" id="kobo.592.1" xmlns="http://www.w3.org/1999/xhtml">Instance</span></code><span class="koboSpan" id="kobo.593.1" xmlns="http://www.w3.org/1999/xhtml"> property like this: </span><code><span class="koboSpan" id="kobo.594.1" xmlns="http://www.w3.org/1999/xhtml">public static MySimpleSingleton Instance =&gt; new MySimpleSingleton();</span></code><span class="koboSpan" id="kobo.595.1" xmlns="http://www.w3.org/1999/xhtml">, but doing so would return a new instance every time. </span><span class="koboSpan" id="kobo.595.2" xmlns="http://www.w3.org/1999/xhtml">This would defeat the purpose of what we want to achieve. </span><span class="koboSpan" id="kobo.595.3" xmlns="http://www.w3.org/1999/xhtml">On the other hand, the property initializer runs only once.</span></p>
</blockquote>
<blockquote>
<p><span class="koboSpan" id="kobo.596.1" xmlns="http://www.w3.org/1999/xhtml">The arrow operator makes the </span><code><span class="koboSpan" id="kobo.597.1" xmlns="http://www.w3.org/1999/xhtml">Instance</span></code><span class="koboSpan" id="kobo.598.1" xmlns="http://www.w3.org/1999/xhtml"> property an expression-bodied member, equivalent to creating the following getter: </span><code><span class="koboSpan" id="kobo.599.1" xmlns="http://www.w3.org/1999/xhtml">get { return new MySimpleSingleton(); }</span></code><span class="koboSpan" id="kobo.600.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.600.2" xmlns="http://www.w3.org/1999/xhtml">You can consult </span><em><span class="koboSpan" id="kobo.601.1" xmlns="http://www.w3.org/1999/xhtml">Appendix A</span></em><span class="koboSpan" id="kobo.602.1" xmlns="http://www.w3.org/1999/xhtml"> for more information about expression-bodies statements.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.603.1" xmlns="http://www.w3.org/1999/xhtml">Before we conclude the chapter, the Singleton (anti-)pattern also leads to a code smell.</span></p>
</section>
<section class="level3" data-number="8.4.4" id="code-smell-ambient-context">
<h3 data-number="8.4.4"><span class="koboSpan" id="kobo.604.1" xmlns="http://www.w3.org/1999/xhtml">Code smell – Ambient Context</span></h3>
<p><span class="koboSpan" id="kobo.605.1" xmlns="http://www.w3.org/1999/xhtml">That last implementation of the </span><strong><span class="koboSpan" id="kobo.606.1" xmlns="http://www.w3.org/1999/xhtml">Singleton</span></strong><span class="koboSpan" id="kobo.607.1" xmlns="http://www.w3.org/1999/xhtml"> pattern led us to the </span><strong><span class="koboSpan" id="kobo.608.1" xmlns="http://www.w3.org/1999/xhtml">Ambient Context</span></strong><span class="koboSpan" id="kobo.609.1" xmlns="http://www.w3.org/1999/xhtml"> pattern. </span><span class="koboSpan" id="kobo.609.2" xmlns="http://www.w3.org/1999/xhtml">We could even call the Ambient Context an anti-pattern, but let’s just state that it is a consequential code smell.I do not recommend using ambient contexts for multiple reasons. </span><span class="koboSpan" id="kobo.609.3" xmlns="http://www.w3.org/1999/xhtml">First, I do my best to avoid anything global; an ambient context is a global state. </span><span class="koboSpan" id="kobo.609.4" xmlns="http://www.w3.org/1999/xhtml">Globals, like static members in C#, can look very convenient because they are easy to access and use. </span><span class="koboSpan" id="kobo.609.5" xmlns="http://www.w3.org/1999/xhtml">They are always there and accessible whenever needed: easy. </span><span class="koboSpan" id="kobo.609.6" xmlns="http://www.w3.org/1999/xhtml">However, they bring many drawbacks in terms of flexibility and testability.When using an ambient context, the following occurs:</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.610.1" xmlns="http://www.w3.org/1999/xhtml">Tight coupling</span></strong><span class="koboSpan" id="kobo.611.1" xmlns="http://www.w3.org/1999/xhtml">: global states lead to less flexible systems; consumers are tightly coupled with the ambient context.</span></li>
<li><strong><span class="koboSpan" id="kobo.612.1" xmlns="http://www.w3.org/1999/xhtml">Testing difficulty</span></strong><span class="koboSpan" id="kobo.613.1" xmlns="http://www.w3.org/1999/xhtml">: global objects are harder to replace, and we cannot easily swap them for other objects, like a mock.</span></li>
<li><strong><span class="koboSpan" id="kobo.614.1" xmlns="http://www.w3.org/1999/xhtml">Unforseen impacts</span></strong><span class="koboSpan" id="kobo.615.1" xmlns="http://www.w3.org/1999/xhtml">: if some part of your system messes up your global state, that may have unexpected consequences on other parts of your system, and you may have difficulty finding out the root cause of those errors.</span></li>
<li><strong><span class="koboSpan" id="kobo.616.1" xmlns="http://www.w3.org/1999/xhtml">Potential misuse</span></strong><span class="koboSpan" id="kobo.617.1" xmlns="http://www.w3.org/1999/xhtml">: developers could be tempted to add non-global concerns to the ambient context, leading to a bloated component.</span></li>
</ul>
<blockquote>
<p><strong><span class="koboSpan" id="kobo.618.1" xmlns="http://www.w3.org/1999/xhtml">Fun fact</span></strong></p>
<blockquote>
<p><span class="koboSpan" id="kobo.619.1" xmlns="http://www.w3.org/1999/xhtml">Many years ago, before the JavaScript frameworks era, I fixed a bug in a system where some function was overriding the value of </span><code><span class="koboSpan" id="kobo.620.1" xmlns="http://www.w3.org/1999/xhtml">undefined</span></code><span class="koboSpan" id="kobo.621.1" xmlns="http://www.w3.org/1999/xhtml"> due to a subtle error. </span><span class="koboSpan" id="kobo.621.2" xmlns="http://www.w3.org/1999/xhtml">This is an excellent example of how global variables could impact your whole system and make it more brittle. </span><span class="koboSpan" id="kobo.621.3" xmlns="http://www.w3.org/1999/xhtml">The same applies to the Ambient Context and Singleton patterns in C#; globals can be dangerous and annoying.</span></p>
</blockquote>
<blockquote>
<p><span class="koboSpan" id="kobo.622.1" xmlns="http://www.w3.org/1999/xhtml">Rest assured that, nowadays, browsers won’t let developers update the value of </span><code><span class="koboSpan" id="kobo.623.1" xmlns="http://www.w3.org/1999/xhtml">undefined</span></code><span class="koboSpan" id="kobo.624.1" xmlns="http://www.w3.org/1999/xhtml">, but it was possible back then.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.625.1" xmlns="http://www.w3.org/1999/xhtml">Now that we’ve discussed global objects, an ambient context is a global instance, usually available through a static property. </span><span class="koboSpan" id="kobo.625.2" xmlns="http://www.w3.org/1999/xhtml">The Ambient Context pattern can bring good things, but it is a code smell that smells bad.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.626.1" xmlns="http://www.w3.org/1999/xhtml">There are a few examples in .NET Framework, such as </span><code><span class="koboSpan" id="kobo.627.1" xmlns="http://www.w3.org/1999/xhtml">System.Threading.Thread.CurrentPrincipal</span></code><span class="koboSpan" id="kobo.628.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.629.1" xmlns="http://www.w3.org/1999/xhtml">System.Threading.Thread.CurrentThread</span></code><span class="koboSpan" id="kobo.630.1" xmlns="http://www.w3.org/1999/xhtml">, that are scoped to a thread instead of being purely global like most static members. </span><span class="koboSpan" id="kobo.630.2" xmlns="http://www.w3.org/1999/xhtml">An ambient context does not have to be a singleton, but that is what they are most of the time. </span><span class="koboSpan" id="kobo.630.3" xmlns="http://www.w3.org/1999/xhtml">Creating a non-global (scoped) ambient context is harder and requires more work.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.631.1" xmlns="http://www.w3.org/1999/xhtml">Is the Ambient Context pattern good or bad? </span><span class="koboSpan" id="kobo.631.2" xmlns="http://www.w3.org/1999/xhtml">I’d go with both! </span><span class="koboSpan" id="kobo.631.3" xmlns="http://www.w3.org/1999/xhtml">It is useful primarily because of its convenience and ease of use. </span><span class="koboSpan" id="kobo.631.4" xmlns="http://www.w3.org/1999/xhtml">Most of the time, it could and should be designed differently to reduce its drawbacks.There are many ways of implementing an ambient context, but to keep it brief and straightforward, we are focusing only on the singleton version of the ambient context. </span><span class="koboSpan" id="kobo.631.5" xmlns="http://www.w3.org/1999/xhtml">The following code is a good example:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.632.1" xmlns="http://www.w3.org/1999/xhtml">public class MyAmbientContext
{
    public static MyAmbientContext Current { get; } = new MyAmbientContext();
    private MyAmbientContext() { }
    public void WriteSomething(string something)
    {
        Console.WriteLine($"This is your something: {something}");
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.633.1" xmlns="http://www.w3.org/1999/xhtml">That code is an exact copy of the </span><code><span class="koboSpan" id="kobo.634.1" xmlns="http://www.w3.org/1999/xhtml">MySimpleSingleton</span></code><span class="koboSpan" id="kobo.635.1" xmlns="http://www.w3.org/1999/xhtml"> class, with a few subtle changes:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.636.1" xmlns="http://www.w3.org/1999/xhtml">Instance</span></code><span class="koboSpan" id="kobo.637.1" xmlns="http://www.w3.org/1999/xhtml"> is named </span><code><span class="koboSpan" id="kobo.638.1" xmlns="http://www.w3.org/1999/xhtml">Current</span></code><span class="koboSpan" id="kobo.639.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><span class="koboSpan" id="kobo.640.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.641.1" xmlns="http://www.w3.org/1999/xhtml">WriteSomething</span></code><span class="koboSpan" id="kobo.642.1" xmlns="http://www.w3.org/1999/xhtml"> method is new but has nothing to do with the Ambient Context pattern itself; it is just to make the class do something.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.643.1" xmlns="http://www.w3.org/1999/xhtml">If we take a look at the test method that follows, we can see that we use the ambient context by calling </span><code><span class="koboSpan" id="kobo.644.1" xmlns="http://www.w3.org/1999/xhtml">MyAmbientContext.Current</span></code><span class="koboSpan" id="kobo.645.1" xmlns="http://www.w3.org/1999/xhtml">, just like we did with the last singleton implementation:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.646.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public void Should_echo_the_inputted_text_to_the_console()
{
    // Arrange (make the console write to a StringBuilder
    // instead of the actual console)
    var expectedText = "This is your something: Hello World!" </span><span class="koboSpan" id="kobo.646.2" xmlns="http://www.w3.org/1999/xhtml">+ Environment.NewLine;
    var sb = new StringBuilder();
    using (var writer = new StringWriter(sb))
    {
        Console.SetOut(writer);
        // Act
        MyAmbientContext.Current.WriteSomething("Hello World!");
    }
    // Assert
    var actualText = sb.ToString();
    Assert.Equal(expectedText, actualText);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.647.1" xmlns="http://www.w3.org/1999/xhtml">The property could include a public setter or support more complex logic. </span><span class="koboSpan" id="kobo.647.2" xmlns="http://www.w3.org/1999/xhtml">Building the right classes and exposing the right behaviors is up to you and your specifications.To conclude this interlude, avoid ambient contexts and use instantiable classes instead. </span><span class="koboSpan" id="kobo.647.3" xmlns="http://www.w3.org/1999/xhtml">We see how to replace a singleton with a single instance of a class using dependency injection in the next chapter. </span><span class="koboSpan" id="kobo.647.4" xmlns="http://www.w3.org/1999/xhtml">That gives us a more flexible alternative to the Singleton pattern. </span><span class="koboSpan" id="kobo.647.5" xmlns="http://www.w3.org/1999/xhtml">We can also create a single instance per HTTP request, which saves us the trouble of coding it while eliminating the disadvantages.</span></p>
</section>
<section class="level3" data-number="8.4.5" id="conclusion-10">
<h3 data-number="8.4.5"><span class="koboSpan" id="kobo.648.1" xmlns="http://www.w3.org/1999/xhtml">Conclusion</span></h3>
<p><span class="koboSpan" id="kobo.649.1" xmlns="http://www.w3.org/1999/xhtml">The Singleton pattern allows the creation of a single instance of a class for the whole lifetime of the program. </span><span class="koboSpan" id="kobo.649.2" xmlns="http://www.w3.org/1999/xhtml">It leverages a </span><code><span class="koboSpan" id="kobo.650.1" xmlns="http://www.w3.org/1999/xhtml">private static</span></code><span class="koboSpan" id="kobo.651.1" xmlns="http://www.w3.org/1999/xhtml"> field and a </span><code><span class="koboSpan" id="kobo.652.1" xmlns="http://www.w3.org/1999/xhtml">private</span></code><span class="koboSpan" id="kobo.653.1" xmlns="http://www.w3.org/1999/xhtml"> constructor to achieve its goal, exposing the instantiation through a </span><code><span class="koboSpan" id="kobo.654.1" xmlns="http://www.w3.org/1999/xhtml">public static</span></code><span class="koboSpan" id="kobo.655.1" xmlns="http://www.w3.org/1999/xhtml"> method or property. </span><span class="koboSpan" id="kobo.655.2" xmlns="http://www.w3.org/1999/xhtml">We can use a field initializer, the </span><code><span class="koboSpan" id="kobo.656.1" xmlns="http://www.w3.org/1999/xhtml">Create</span></code><span class="koboSpan" id="kobo.657.1" xmlns="http://www.w3.org/1999/xhtml"> method itself, a static constructor, or any other valid C# options to encapsulate the initialization logic.Now let’s see how the Singleton pattern can help us (not) follow the SOLID principles:</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.658.1" xmlns="http://www.w3.org/1999/xhtml">S</span></strong><span class="koboSpan" id="kobo.659.1" xmlns="http://www.w3.org/1999/xhtml">: The singleton violates this principle because it has two clear responsibilities:
</span><ul>
<li><span class="koboSpan" id="kobo.660.1" xmlns="http://www.w3.org/1999/xhtml">It has the responsibility for which it has been created (not illustrated here), like any other class.</span></li>
<li><span class="koboSpan" id="kobo.661.1" xmlns="http://www.w3.org/1999/xhtml">It has the responsibility of creating and managing itself (lifetime management).</span></li>
</ul></li>
<li><strong><span class="koboSpan" id="kobo.662.1" xmlns="http://www.w3.org/1999/xhtml">O</span></strong><span class="koboSpan" id="kobo.663.1" xmlns="http://www.w3.org/1999/xhtml">: The Singleton pattern also violates this principle. </span><span class="koboSpan" id="kobo.663.2" xmlns="http://www.w3.org/1999/xhtml">It enforces a single static instance, locked in place by itself, which limits extensibility. </span><span class="koboSpan" id="kobo.663.3" xmlns="http://www.w3.org/1999/xhtml">It is impossible to extend the class without changing its code.</span></li>
<li><strong><span class="koboSpan" id="kobo.664.1" xmlns="http://www.w3.org/1999/xhtml">L</span></strong><span class="koboSpan" id="kobo.665.1" xmlns="http://www.w3.org/1999/xhtml">: There is no inheritance directly involved, which is the only good point.</span></li>
<li><strong><span class="koboSpan" id="kobo.666.1" xmlns="http://www.w3.org/1999/xhtml">I</span></strong><span class="koboSpan" id="kobo.667.1" xmlns="http://www.w3.org/1999/xhtml">: No C# interface is involved, which violates this principle. </span><span class="koboSpan" id="kobo.667.2" xmlns="http://www.w3.org/1999/xhtml">However, we can look at the class interface instead, so building a small targeted singleton instance would satisfy this principle.</span></li>
<li><strong><span class="koboSpan" id="kobo.668.1" xmlns="http://www.w3.org/1999/xhtml">D</span></strong><span class="koboSpan" id="kobo.669.1" xmlns="http://www.w3.org/1999/xhtml">: The singleton class has a rock-solid hold on itself. </span><span class="koboSpan" id="kobo.669.2" xmlns="http://www.w3.org/1999/xhtml">It also suggests using its static property (or method) directly without using an abstraction, breaking the DIP with a sledgehammer.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.670.1" xmlns="http://www.w3.org/1999/xhtml">As you can see, the Singleton pattern violates all the SOLID principles but the LSP and should be used cautiously. </span><span class="koboSpan" id="kobo.670.2" xmlns="http://www.w3.org/1999/xhtml">Having only a single instance of a class and always using that same instance is a common concept. </span><span class="koboSpan" id="kobo.670.3" xmlns="http://www.w3.org/1999/xhtml">However, we explore more proper ways to do this in the next chapter, leading me to the following advice: do not use the Singleton pattern, and if you see it used somewhere, try refactoring it out.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.671.1" xmlns="http://www.w3.org/1999/xhtml">I suggest avoiding static members that create global states as a general good practice. </span><span class="koboSpan" id="kobo.671.2" xmlns="http://www.w3.org/1999/xhtml">They can make your system less flexible and more brittle. </span><span class="koboSpan" id="kobo.671.3" xmlns="http://www.w3.org/1999/xhtml">There are occasions where </span><code><span class="koboSpan" id="kobo.672.1" xmlns="http://www.w3.org/1999/xhtml">static</span></code><span class="koboSpan" id="kobo.673.1" xmlns="http://www.w3.org/1999/xhtml"> members are worth using, but try keeping their number as low as possible. </span><span class="koboSpan" id="kobo.673.2" xmlns="http://www.w3.org/1999/xhtml">Ask yourself if you can replace that </span><code><span class="koboSpan" id="kobo.674.1" xmlns="http://www.w3.org/1999/xhtml">static</span></code><span class="koboSpan" id="kobo.675.1" xmlns="http://www.w3.org/1999/xhtml"> member or class with something else before coding one.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.676.1" xmlns="http://www.w3.org/1999/xhtml">Some may argue that the Singleton design pattern is a legitimate way of doing things. </span><span class="koboSpan" id="kobo.676.2" xmlns="http://www.w3.org/1999/xhtml">However, in ASP.NET Core, I am afraid I have to disagree: we have a powerful mechanism to do it differently, called dependency injection. </span><span class="koboSpan" id="kobo.676.3" xmlns="http://www.w3.org/1999/xhtml">When using other technologies, maybe, but not with modern .NET.</span></p>
</section>
</section>
<section class="level2" data-number="8.5" id="summary-6">
<h2 data-number="8.5"><span class="koboSpan" id="kobo.677.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.678.1" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we explored our first GoF design patterns. </span><span class="koboSpan" id="kobo.678.2" xmlns="http://www.w3.org/1999/xhtml">These patterns expose some of the essential basics of software engineering, not necessarily the patterns themselves, but the concepts behind them:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.679.1" xmlns="http://www.w3.org/1999/xhtml">The Strategy pattern is a behavioral pattern that we use to compose most of our future classes. </span><span class="koboSpan" id="kobo.679.2" xmlns="http://www.w3.org/1999/xhtml">It allows swapping behavior at runtime by composing an object with small pieces and coding against interfaces, following the SOLID principles.</span></li>
<li><span class="koboSpan" id="kobo.680.1" xmlns="http://www.w3.org/1999/xhtml">The Abstract Factory pattern brings the idea of abstracting away object creation, leading to a better separation of concerns. </span><span class="koboSpan" id="kobo.680.2" xmlns="http://www.w3.org/1999/xhtml">More specifically, it aims to abstract the creation of object families and follow the SOLID principles.</span></li>
<li><span class="koboSpan" id="kobo.681.1" xmlns="http://www.w3.org/1999/xhtml">Even if we defined it as an anti-pattern, the Singleton pattern brings the application-level objects to the table. </span><span class="koboSpan" id="kobo.681.2" xmlns="http://www.w3.org/1999/xhtml">It allows the creation of a single instance of an object that lives for the whole lifetime of a program. </span><span class="koboSpan" id="kobo.681.3" xmlns="http://www.w3.org/1999/xhtml">The pattern violates most SOLID principles.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.682.1" xmlns="http://www.w3.org/1999/xhtml">We also peeked at the Ambient Context code smell, which is used to create an omnipresent entity accessible from everywhere. </span><span class="koboSpan" id="kobo.682.2" xmlns="http://www.w3.org/1999/xhtml">It is often implemented as a singleton and brings a global state object to the program.The next chapter explores how dependency injection helps us compose complex yet maintainable systems. </span><span class="koboSpan" id="kobo.682.3" xmlns="http://www.w3.org/1999/xhtml">We also revisit the Strategy, the Factory, and the Singleton patterns to see how to use them in a dependency-injection-oriented context and how powerful they really are.</span></p>
</section>
<section class="level2" data-number="8.6" id="questions-6">
<h2 data-number="8.6"><span class="koboSpan" id="kobo.683.1" xmlns="http://www.w3.org/1999/xhtml">Questions</span></h2>
<p><span class="koboSpan" id="kobo.684.1" xmlns="http://www.w3.org/1999/xhtml">Let’s take a look at a few practice questions:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.685.1" xmlns="http://www.w3.org/1999/xhtml">Why is the Strategy pattern a behavioral pattern?</span></li>
<li><span class="koboSpan" id="kobo.686.1" xmlns="http://www.w3.org/1999/xhtml">How could we define the goal of the creational patterns?</span></li>
<li><span class="koboSpan" id="kobo.687.1" xmlns="http://www.w3.org/1999/xhtml">If I write the code </span><code><span class="koboSpan" id="kobo.688.1" xmlns="http://www.w3.org/1999/xhtml">public MyType MyProp =&gt; new MyType();</span></code><span class="koboSpan" id="kobo.689.1" xmlns="http://www.w3.org/1999/xhtml">, and I call the property twice (</span><code><span class="koboSpan" id="kobo.690.1" xmlns="http://www.w3.org/1999/xhtml">var v1 = MyProp; var v2 = MyProp;</span></code><span class="koboSpan" id="kobo.691.1" xmlns="http://www.w3.org/1999/xhtml">), are </span><code><span class="koboSpan" id="kobo.692.1" xmlns="http://www.w3.org/1999/xhtml">v1</span></code><span class="koboSpan" id="kobo.693.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.694.1" xmlns="http://www.w3.org/1999/xhtml">v2</span></code><span class="koboSpan" id="kobo.695.1" xmlns="http://www.w3.org/1999/xhtml"> the same instance or two different instances?</span></li>
<li><span class="koboSpan" id="kobo.696.1" xmlns="http://www.w3.org/1999/xhtml">Is it true that the Abstract Factory pattern allows us to add new families of elements without modifying the existing consuming code?</span></li>
<li><span class="koboSpan" id="kobo.697.1" xmlns="http://www.w3.org/1999/xhtml">Why is the Singleton pattern an anti-pattern?</span></li>
</ol>
</section>
<section class="level2" data-number="8.7" id="answers-3">
<h2 data-number="8.7"><span class="koboSpan" id="kobo.698.1" xmlns="http://www.w3.org/1999/xhtml">Answers</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.699.1" xmlns="http://www.w3.org/1999/xhtml">It helps manage behaviors at runtime, such as changing an algorithm in the middle of a running program.</span></li>
<li><span class="koboSpan" id="kobo.700.1" xmlns="http://www.w3.org/1999/xhtml">The creational patterns are responsible for creating objects.</span></li>
<li><code><span class="koboSpan" id="kobo.701.1" xmlns="http://www.w3.org/1999/xhtml">v1</span></code><span class="koboSpan" id="kobo.702.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.703.1" xmlns="http://www.w3.org/1999/xhtml">v2</span></code><span class="koboSpan" id="kobo.704.1" xmlns="http://www.w3.org/1999/xhtml"> are two different instances. </span><span class="koboSpan" id="kobo.704.2" xmlns="http://www.w3.org/1999/xhtml">The code on the right-hand side of the arrow operator is executed every time you call the property’s getter.</span></li>
<li><span class="koboSpan" id="kobo.705.1" xmlns="http://www.w3.org/1999/xhtml">Yes, it is true. </span><span class="koboSpan" id="kobo.705.2" xmlns="http://www.w3.org/1999/xhtml">That’s the primary goal of the pattern, as we demonstrated in the </span><code><span class="koboSpan" id="kobo.706.1" xmlns="http://www.w3.org/1999/xhtml">MidRangeVehicleFactory</span></code><span class="koboSpan" id="kobo.707.1" xmlns="http://www.w3.org/1999/xhtml"> code sample.</span></li>
<li><span class="koboSpan" id="kobo.708.1" xmlns="http://www.w3.org/1999/xhtml">The Singleton pattern violates the SOLID principles and encourages using global (static) state objects. </span><span class="koboSpan" id="kobo.708.2" xmlns="http://www.w3.org/1999/xhtml">We can avoid this pattern most of the time.</span></li>
</ol>
</section>
</section>
</body>
</html>
