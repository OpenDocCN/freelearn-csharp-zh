<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Preparing Xamarin.iOS Apps for Distribution"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Preparing Xamarin.iOS Apps for Distribution</h1></div></div></div><p>In this chapter, we will discuss activities related to preparing a Xamarin.iOS app for distribution and look at the various options for distributing apps. While many of the activities we will discuss are an integral part of any iOS app deployment, we will try and narrow the scope of our coverage to aspects that are unique to developing an app with Xamarin.iOS. We will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">App profiling</li><li class="listitem" style="list-style-type: disc">iOS Build settings for distributing apps</li><li class="listitem" style="list-style-type: disc">App distribution options</li></ul></div><div class="section" title="Preparing for distribution"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec62"/>Preparing for distribution</h1></div></div></div><p>At this point, our <a class="indexterm" id="id751"/>app is built and functioning the way we want; most of the work is done. We now turn our attention to preparing our app for distribution. This section discusses the following three aspects of preparing an app for distribution:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>App profiling</strong></span>: Here <a class="indexterm" id="id752"/>we will be looking at memory <a class="indexterm" id="id753"/>allocation issues and performance bottlenecks</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>iOS Application settings</strong></span>: Here <a class="indexterm" id="id754"/>we will <a class="indexterm" id="id755"/>be updating informational settings such as version and build numbers</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>iOS Build settings</strong></span>: Here <a class="indexterm" id="id756"/>we will be adjusting <a class="indexterm" id="id757"/>settings that affect the code being generated based on target devices, desired performance characteristics, and deployable size</li></ul></div><div class="section" title="Profiling Xamarin.iOS apps"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec92"/>Profiling Xamarin.iOS apps</h2></div></div></div><p>Profiling allows <a class="indexterm" id="id758"/>developers to monitor their apps during execution and identify issues related to memory allocation and performance bottlenecks. The activity of profiling can be performed throughout the life cycle of developing an app, but it is especially beneficial to incorporate profiling into the latter stages of the process as a final verification prior to distribution.</p><p>Xamarin.iOS developers have two tools to choose from for profiling apps: MonoTouch Profiler and Apple's <a class="indexterm" id="id759"/>Instruments app. We will not replicate the existing documentation for these apps but simply provide the following links for reference:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Tool</p>
</th><th style="text-align: left" valign="bottom">
<p>URL</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>MonoTouch Profiler</p>
</td><td style="text-align: left" valign="top">
<p>
<a class="ulink" href="http://docs.xamarin.com/guides/ios/deployment,_testing,_and_metrics/monotouch_profiler/">http://docs.xamarin.com/guides/ios/deployment,_testing,_and_metrics/monotouch_profiler/</a>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Apple's Instruments <a class="indexterm" id="id760"/>app</p>
</td><td style="text-align: left" valign="top">
<p>
<a class="ulink" href="http://docs.xamarin.com/guides/ios/deployment,_testing,_and_metrics/walkthrough_Apples_instrument/">http://docs.xamarin.com/guides/ios/deployment,_testing,_and_metrics/walkthrough_Apples_instrument/</a>
</p>
</td></tr></tbody></table></div></div><div class="section" title="iOS Application (Info.plist) settings"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec93"/>iOS Application (Info.plist) settings</h2></div></div></div><p>It's likely that <a class="indexterm" id="id761"/>most of the settings <a class="indexterm" id="id762"/>you need to make in <code class="literal">Info.plist</code> will have already been made by the time you are ready to start the distribution process. However, there are a few settings you likely need to update, specifically, the version and build settings. The following screenshot shows the <span class="strong"><strong>iOS Application</strong></span> settings screen:</p><div class="mediaobject"><img alt="iOS Application (Info.plist) settings" src="graphics/0838OT_09_04.jpg"/></div></div><div class="section" title="iOS Build settings"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec94"/>iOS Build settings</h2></div></div></div><p>Xamarin.iOS <a class="indexterm" id="id763"/>provides numerous options to optimize the build process based on the devices that are being targeted, the size of the deployable app, and the execution speed. The following sections discuss the most important settings related to producing a final build for distribution.</p><div class="section" title="SDK Options"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec65"/>SDK Options</h3></div></div></div><p>The SDK version <a class="indexterm" id="id764"/>should be set to the minimum <a class="indexterm" id="id765"/>iOS version that the app can be deployed to. It's likely <a class="indexterm" id="id766"/>that this setting would have already been established during the development process.</p></div><div class="section" title="Linker Options"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec66"/>Linker Options</h3></div></div></div><p>The mTouch tool <a class="indexterm" id="id767"/>used to build Xamarin.iOS apps <a class="indexterm" id="id768"/>includes a linker, where the aim of the linker is to reduce the <a class="indexterm" id="id769"/>size of the resulting app. The linker accomplishes this by performing static analysis on the code in your app, evaluating which classes and methods in the referenced assemblies are actually used, and removing classes, methods, and properties that are not used.</p><p>Options for the linker can be set in <span class="strong"><strong>Project Options</strong></span> | <span class="strong"><strong>iOS Build</strong></span> under the <span class="strong"><strong>General</strong></span> tab, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Linker Options" src="graphics/0838OT_09_05.jpg"/></div><p>The following options <a class="indexterm" id="id770"/>can be set to control the linking process:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Don't link</strong></span>: This <a class="indexterm" id="id771"/>option disables the linker and ensures that all referenced assemblies are included without modification. You should note <a class="indexterm" id="id772"/>that this is the default setting for builds that target the iOS simulator because excluding the time-consuming static analysis process saves time. From this, the resulting large DLLs can still be deployed relatively quickly to the simulator.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Link SDK assemblies only</strong></span>: This option tells the linker to operate on only the SDK <a class="indexterm" id="id773"/>assemblies (which are the assemblies that ship with Xamarin.iOS). This is the default setting for builds that target a device.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Link all assemblies</strong></span>: This option tells the linker to operate on the entire app as well as on all referenced assemblies. This allows the linker to use a larger set of <a class="indexterm" id="id774"/>optimizations and results in the smallest possible application. However, when the linker runs in this mode, there is a greater chance that it will break portions of your code due to false assumptions made by the static analysis process. In particular, static analysis can get tripped up through usage of reflection, serialization, or any code where a type or member instance is not statically referenced.</li></ul></div><p>The following table summarizes <a class="indexterm" id="id775"/>the results of linking the two versions of the <code class="literal">NationalParks</code> app produced in <a class="link" href="ch06.html" title="Chapter 6. The Sharing Game">Chapter 6</a>, <span class="emphasis"><em>The Sharing Game</em></span>:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom"> </th><th style="text-align: left" valign="bottom">
<p>File linking version</p>
</th><th style="text-align: left" valign="bottom">
<p>PCL version</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Don't link</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>47.5 MB</p>
</td><td style="text-align: left" valign="top">
<p>48.4 MB</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Link SDK assemblies only</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>6.7 MB</p>
</td><td style="text-align: left" valign="top">
<p>7.3 MB</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Link all assemblies</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>5.8 MB</p>
</td><td style="text-align: left" valign="top">
<p>6.4 MB</p>
</td></tr></tbody></table></div><p>As you can see from the table, the biggest difference in application size is achieved when going from <span class="strong"><strong>Don't link</strong></span> to <span class="strong"><strong>Link SDK assemblies only</strong></span>.</p><div class="section" title="Overriding the linker"><div class="titlepage"><div><div><h4 class="title"><a id="ch09lvl4sec31"/>Overriding the linker</h4></div></div></div><p>The linker <a class="indexterm" id="id776"/>provides great benefits as demonstrated in the previous section. However, there might be times when you need to override the default behavior of the linker as the linker might remove type and member instances that are actually used by your app. This will result in runtime exceptions relating to these types and/or member not being found. The following table describes three ways to alter the behavior of the linker in order to avoid losing important types and members:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Technique</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Preserving code</p>
</td><td style="text-align: left" valign="top">
<p>If you <a class="indexterm" id="id777"/>determine from testing that the linker is removing classes or methods needed by your app, you can explicitly tell the linker to always include them by using the <code class="literal">Preserve</code> attribute on a class and/or method.</p>
<p>To preserve the entire type use:
</p><div class="informalexample"><pre class="programlisting">[Preserve (AllMembers = true)]</pre></div>
<p>To preserve a single member use:
</p><div class="informalexample"><pre class="programlisting">[Preserve (Conditional=true)]</pre></div>
 </td></tr><tr><td style="text-align: left" valign="top">
<p>Skipping assemblies</p>
</td><td style="text-align: left" valign="top">
<p>In <a class="indexterm" id="id778"/>some cases, you might need to tell the linker to skip entire assemblies because you do not have the ability to modify the source code (third-party libraries). This can be accomplished by using the command line option <code class="literal">linkskip</code>. For example:
</p><div class="informalexample"><pre class="programlisting">--linkskip=someassembly</pre></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Disable <span class="strong"><strong>Link Away</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>One <a class="indexterm" id="id779"/>optimization the linker employs is to remove code that is very unlikely to be used on an actual <a class="indexterm" id="id780"/>device; those features that are marked as unsupported or disallowed. On rare occasions, these features might be needed for your app to function. This optimization can be disabled by using the command line option <code class="literal">--nolinkaway</code>.</p>
</td></tr></tbody></table></div></div></div><div class="section" title="Debugging options"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec67"/>Debugging options</h3></div></div></div><p>Debugging options <a class="indexterm" id="id781"/>should always be <a class="indexterm" id="id782"/>disabled for release builds. Enabling <a class="indexterm" id="id783"/>debugging can result in significantly larger binaries.</p></div><div class="section" title="Code generation options"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec68"/>Code generation options</h3></div></div></div><p>Code generation <a class="indexterm" id="id784"/>options control the code being created during the build process based on the processor(s) being targeted <a class="indexterm" id="id785"/>and the performance characteristics <a class="indexterm" id="id786"/>desired. The option we have under this setting are explained in the following sections.</p><div class="section" title="Supported architectures"><div class="titlepage"><div><div><h4 class="title"><a id="ch09lvl4sec32"/>Supported architectures</h4></div></div></div><p>Supported <a class="indexterm" id="id787"/>architectures identify the processor architectures that should be supported by the resulting build. The original iPhone through to the iPhone 3G, used an ARMv6 CPU. Newer models of iPhone and iPad use either the ARMv7 or ARMv7s architecture while the iPhone 5s introduced the use of A7 processor based on the ARMv8a architecture.</p><p>ARMv6 has not <a class="indexterm" id="id788"/>supported Xcode versions prior to Xcode 4.5. If you need to build for older devices, you will need to use an earlier version of Xcode installed.</p></div><div class="section" title="LLVM optimizing compiler"><div class="titlepage"><div><div><h4 class="title"><a id="ch09lvl4sec33"/>LLVM optimizing compiler</h4></div></div></div><p>Xamarin.iOS <a class="indexterm" id="id789"/>comes with two different code generation engines: the normal Mono code generation engine and the one based on the <a class="indexterm" id="id790"/>LLVM optimizing compiler. The LLVM engine produces both faster and smaller code than the Mono engine at the cost of compile time. Thus, the Mono code generation engine is convenient to use as you develop an app, whereas the LLVM engine is preferred for builds that will be distributed.</p></div><div class="section" title="ARM thumb instruction set"><div class="titlepage"><div><div><h4 class="title"><a id="ch09lvl4sec34"/>ARM thumb instruction set</h4></div></div></div><p>The ARM thumb <a class="indexterm" id="id791"/>instruction set is a <a class="indexterm" id="id792"/>more compact instruction set used by ARM processors. By enabling the Thumb support, you can reduce the size of your executable at the expense of slower execution times. Thumb is supported by ARMv6, ARMv7, and ARMv7s.</p></div></div></div></div></div>
<div class="section" title="Distributing Xamarin.iOS apps"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec63"/>Distributing Xamarin.iOS apps</h1></div></div></div><p>Xamarin.iOS <a class="indexterm" id="id793"/>supports all of the traditional distribution methods that iOS developers have access to. There is a great deal of information about distribution of iOS apps on the Xamarin website and the Apple developer website. We make no attempt to replicate those comprehensive repositories. The following sections are intended to provide a general overview from a Xamarin.iOS perspective.</p><div class="section" title="The Ad Hoc and enterprise distributions"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec95"/>The Ad Hoc and enterprise distributions</h2></div></div></div><p>The <a class="indexterm" id="id794"/>Ad Hoc distribution and enterprise distributions allow an app to be distributed without going through the App <a class="indexterm" id="id795"/>Store. Ad Hoc is generally used to support testing efforts leading up to a general release. Enterprise is used to distribute apps that are not intended for the general public, but are instead intended for use by users within a single enterprise. In either case, an iOS App Store Package (IPA) must be created.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note21"/>Note</h3><p>Producing an enterprise distribution requires an Enterprise account from Apple and an Enterprise Xamarin.iOS license.</p></div></div><p>To create an IPA, we will perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create and <a class="indexterm" id="id796"/>install a distribution profile for your app on <a class="ulink" href="http://developer.apple.com">developer.apple.com</a>. Detailed instructions for this procedure can be found in the section titled <span class="emphasis"><em>Creating and Installing a Distribution Profile</em></span> at <a class="ulink" href="http://docs.xamarin.com/guides/ios/deployment,_testing,_and_metrics/app_distribution_overview/publishing_to_the_app_store/">http://docs.xamarin.com/guides/ios/deployment,_testing,_and_metrics/app_distribution_overview/publishing_to_the_app_store/</a>.</li><li class="listitem">Set the <span class="strong"><strong>Provisioning profile</strong></span> option to be used for the build of the newly installed profile by navigating to <span class="strong"><strong>Project Options</strong></span> | <span class="strong"><strong>Build</strong></span> | <span class="strong"><strong>iOS Bundle Signing</strong></span>, as shown in the following screenshot:<div class="mediaobject"><img alt="The Ad Hoc and enterprise distributions" src="graphics/0838OT_09_01.jpg"/></div></li><li class="listitem">Set the <a class="indexterm" id="id797"/><span class="strong"><strong>Bundle Identifier</strong></span> option on <a class="indexterm" id="id798"/>the app to the same value that was used while creating the distribution profile by navigating to <span class="strong"><strong>Project Options</strong></span> | <span class="strong"><strong>Build</strong></span> | <span class="strong"><strong>iOS Application</strong></span>, as shown in the following screenshot:<div class="mediaobject"><img alt="The Ad Hoc and enterprise distributions" src="graphics/0838OT_09_02.jpg"/></div></li><li class="listitem">Once the IPA has been created, simply navigate to the IPA in finder, double-click on it, and <a class="indexterm" id="id799"/>it will be opened in iTunes. iTunes can now be used to sync the app on <a class="indexterm" id="id800"/>devices.</li></ol></div><div class="section" title="TestFlight distribution"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec69"/>TestFlight distribution</h3></div></div></div><p>
<span class="strong"><strong>TestFlight</strong></span> is a <a class="indexterm" id="id801"/>cloud-based app distribution service used to distribute pre-released versions of your app. Xamarin <a class="indexterm" id="id802"/>Studio provides its integration with the <span class="strong"><strong>TestFlight</strong></span> service so that <span class="strong"><strong>Ad Hoc</strong></span> builds can be uploaded to <span class="strong"><strong>TestFlight</strong></span> directly from within the IDE. Prior to uploading a build, you must establish an account and define the testing team(s) and app within the <span class="strong"><strong>TestFlight</strong></span> service. This can be accomplished by <a class="ulink" href="https://www.testflightapp.com">https://www.testflightapp.com</a>.</p><p>To upload a <a class="indexterm" id="id803"/>build to TestFlight, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select <span class="strong"><strong>Ad Hoc</strong></span> for the build type and navigate from <span class="strong"><strong>Project</strong></span> | <span class="strong"><strong>Publish</strong></span> to <span class="strong"><strong>TestFlight</strong></span> from the main menu.</li><li class="listitem">Enter the <span class="strong"><strong>API token</strong></span> and <span class="strong"><strong>Team token</strong></span> values assigned by <span class="strong"><strong>TestFlight</strong></span> when you set up your app and team. You can click on the link next to these fields to display the appropriate value in a browser.<div class="mediaobject"><img alt="TestFlight distribution" src="graphics/0838OT_09_03.jpg"/></div></li><li class="listitem">Enter <span class="strong"><strong>Release notes</strong></span> to let the testers know what has been fixed and/or added in the new release.</li><li class="listitem">Enter <a class="indexterm" id="id804"/><span class="strong"><strong>Distribution lists</strong></span> and turn on <span class="strong"><strong>Notify team members</strong></span> to have an e-mail notification <a class="indexterm" id="id805"/>sent out with the release notes.</li><li class="listitem">Select the options, <span class="strong"><strong>Replace existing binaries with the same name</strong></span> and <span class="strong"><strong>Upload dSYMs</strong></span>, and click on <span class="strong"><strong>Publish</strong></span>. Xamarin Studio will build the app and upload it to TestFlight.</li></ol></div></div></div><div class="section" title="App Store submission"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec96"/>App Store submission</h2></div></div></div><p>Distributing <a class="indexterm" id="id806"/>apps through the App Store is much the same for Xamarin.iOS apps as any other iOS app. With the exception of producing a release build, most of the work is done outside of Xamarin Studio. You do need to enter the <span class="strong"><strong>Provisioning Profile</strong></span> value in the <span class="strong"><strong>iOS Bundle Signing</strong></span> section of the <span class="strong"><strong>Project Options</strong></span> dialog box.</p><p>The following <a class="indexterm" id="id807"/>link provides detailed steps to publish a Xamarin.iOS app to the App Store: <a class="ulink" href="http://docs.xamarin.com/guides/ios/deployment,_testing,_and_metrics/app_distribution_overview/publishing_to_the_app_store/">http://docs.xamarin.com/guides/ios/deployment,_testing,_and_metrics/app_distribution_overview/publishing_to_the_app_store/</a>.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec64"/>Summary</h1></div></div></div><p>In this chapter, we discussed the activities related to preparing an app for distribution, the distribution channels available, and the processes involved in distributing an app. In the next chapter, we will look at the same aspects of distributing a Xamarin.Android app.</p></div></body></html>