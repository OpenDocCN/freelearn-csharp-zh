<html><head></head><body>
		<div id="_idContainer017">
			<h1 id="_idParaDest-46"><em class="italic"><a id="_idTextAnchor077"/>Chapter 5</em>: Configuring WebHostBuilder</h1>
			<p>When reading <a href="B17996_04_ePub.xhtml#_idTextAnchor066"><em class="italic">Chapter 4</em></a>, <em class="italic">Configuring and Customizing HTTPS with Kestrel</em>, you might have asked yourself a question:</p>
			<p><em class="italic">How can I use user secrets to pass the password to the HTTPS configuration?</em> </p>
			<p>You might even be wondering whether you can fetch the configuration from within <strong class="source-inline">Program.cs</strong>.</p>
			<p>In this chapter, we're going to answer these questions through the following topic:</p>
			<ul>
				<li>Re-examining <strong class="source-inline">WebHostBuilderContext</strong></li>
			</ul>
			<p>The topic in this chapter refers to the hosting layer of the ASP.NET Core architecture:</p>
			<div>
				<div id="_idContainer016" class="IMG---Figure">
					<img src="image/Figure_5.1_B17996.jpg" alt="Figure 5.1 – The ASP.NET Core architecture"/>
				</div>
			</div>
			<p class="figure-caption">Figure 5.1 – The ASP.NET Core architecture</p>
			<h1 id="_idParaDest-47"><a id="_idTextAnchor078"/>Technical requirements</h1>
			<p>To follow the descriptions in this chapter, you will need to create an <strong class="bold">ASP.NET</strong> <strong class="bold">Core</strong> application. To do this, open your console, shell, or Bash terminal, and change to your working directory. Then, use the following command to create a new web application:</p>
			<p class="source-code">dotnet new web -n HostBuilderConfig -o HostBuilderConfig</p>
			<p>Now open the project in Visual Studio by double-clicking the project file, or in Visual Studio Code by typing the following command in the already-open console:</p>
			<p class="source-code">cd HostBuilderConfig</p>
			<p class="source-code">code .</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The simple <strong class="source-inline">web</strong> project template changed in .NET 6.0. In version 6.0, Microsoft introduced <strong class="bold">minimal APIs</strong> and changed the project template to use the minimal API approach. I'm going to show you the differences between these templates within this chapter. </p>
			<p>All of the code samples in this chapter can be found in the <strong class="bold">GitHub</strong> repository for this book at <a href="https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter05">https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter05</a>.</p>
			<h1 id="_idParaDest-48">R<a id="_idTextAnchor079"/><a id="_idTextAnchor080"/>e-examining WebHostBuilderContext</h1>
			<p>R<a id="_idTextAnchor081"/>emember the <strong class="source-inline">WebHostBuilder</strong> Kestrel configuration in the <strong class="source-inline">Program.cs</strong> file that we looked at in <a href="B17996_04_ePub.xhtml#_idTextAnchor066"><em class="italic">Chapter 4</em></a>, <em class="italic">Configuring and Customizing HTTPS with Kestrel</em>? In that chapter, we saw that<a id="_idIndexMarker056"/> you should use user secrets to configure the certificates password, as shown in the following code snippet:</p>
			<p class="source-code">public class Program</p>
			<p class="source-code">{</p>
			<p class="source-code">    public static void Main(string[] args)</p>
			<p class="source-code">    {</p>
			<p class="source-code">        CreateHostBuilder(args).Build().Run();</p>
			<p class="source-code">    }</p>
			<p class="source-code">    public static IHostBuilder CreateHostBuilder(</p>
			<p class="source-code">        string[] args) =&gt;</p>
			<p class="source-code">        Host.CreateDefaultBuilder(args)</p>
			<p class="source-code">            .ConfigureWebHostDefaults(webBuilder =&gt;</p>
			<p class="source-code">            {</p>
			<p class="source-code">                webBuilder</p>
			<p class="source-code">                    .UseKestrel(options =&gt;</p>
			<p class="source-code">                    {</p>
			<p class="source-code">                        options.Listen(</p>
			<p class="source-code">                            IPAddress.Loopback, </p>
			<p class="source-code">                            5000);</p>
			<p class="source-code">                        options.Listen(</p>
			<p class="source-code">                            IPAddress.Loopback, </p>
			<p class="source-code">                            5001, </p>
			<p class="source-code">                            listenOptions  =&gt;</p>
			<p class="source-code">                            {</p>
			<p class="source-code">                                listenOptions.UseHttps(</p>
			<p class="source-code">                                    "certificate.pfx", </p>
			<p class="source-code">                                    "topsecret");</p>
			<p class="source-code">                            });</p>
			<p class="source-code">                    })</p>
			<p class="source-code">                    .UseStartup&lt;Startup&gt;();</p>
			<p class="source-code">            });</p>
			<p class="source-code">    }</p>
			<p class="source-code">}</p>
			<p>This snippet is still valid<a id="_idIndexMarker057"/> for .NET 5.0 and prior versions, and it still is valid for almost all web projects in .NET 6.0. But it is not valid for the <strong class="source-inline">web</strong> project template we use in the technical requirements section. The <strong class="source-inline">Program.cs</strong> file for a minimal API looks like this:</p>
			<p class="source-code">var builder = WebApplication.CreateBuilder(args);</p>
			<p class="source-code">var app = builder.Build();</p>
			<p class="source-code">app.MapGet("/", () =&gt; "Hello World!");</p>
			<p class="source-code">app.Run();</p>
			<p>This means the configuration we implemented in the last chapter would look like this within a minimal API:</p>
			<p class="source-code">using System.Net;</p>
			<p class="source-code">var builder = WebApplication.CreateBuilder(args);</p>
			<p class="source-code">builder.WebHost.UseKestrel(options =&gt;</p>
			<p class="source-code">{</p>
			<p class="source-code">    options.Listen(IPAddress.Loopback, 5000);</p>
			<p class="source-code">    options.Listen(IPAddress.Loopback, 5001,</p>
			<p class="source-code">        listenOptions =&gt;</p>
			<p class="source-code">        {</p>
			<p class="source-code">            listenOptions.UseHttps(</p>
			<p class="source-code">                "certificate.pfx",</p>
			<p class="source-code">                "topsecret");</p>
			<p class="source-code">        });</p>
			<p class="source-code">});</p>
			<p>The following is valid for all project templates in .NET 6.0 and prior versions.</p>
			<p>Usually, you are not able to fetch the configuration inside this code. You need to know that the <strong class="source-inline">UseKestrel()</strong> method is overloaded, as you can see here:</p>
			<p class="source-code">.UseKestrel((host, options) =&gt;</p>
			<p class="source-code">{</p>
			<p class="source-code">    // ...</p>
			<p class="source-code">})</p>
			<p>This first argument<a id="_idIndexMarker058"/> is a <strong class="source-inline">WebHostBuilderContext</strong> instance, which you can use to access the configuration. So, let's rewrite the lambda a little bit to use this context:</p>
			<p class="source-code">builder.WebHost.UseKestrel((host, options) =&gt;</p>
			<p class="source-code">{</p>
			<p class="source-code">    var filename = host.Configuration.GetValue(</p>
			<p class="source-code">        "AppSettings:certfilename", "");</p>
			<p class="source-code">    var password = host.Configuration.GetValue(</p>
			<p class="source-code">        "AppSettings:certpassword", "");</p>
			<p class="source-code">    options.Listen(IPAddress.Loopback, 5000);</p>
			<p class="source-code">    options.Listen(IPAddress.Loopback, 5001, </p>
			<p class="source-code">        listenOptions =&gt;</p>
			<p class="source-code">        {</p>
			<p class="source-code">            listenOptions.UseHttps(filename, password);</p>
			<p class="source-code">        });</p>
			<p class="source-code">});</p>
			<p>In this example, we write the keys using the colon divider, as this is the way in which you need to read nested configurations from <strong class="source-inline">appsettings.json</strong>:</p>
			<p class="source-code">{</p>
			<p class="source-code">    "AppSettings": {</p>
			<p class="source-code">        "certfilename": "certificate.pfx",</p>
			<p class="source-code">        "certpassword": "topsecret"</p>
			<p class="source-code">    },</p>
			<p class="source-code">    "Logging": {</p>
			<p class="source-code">        "LogLevel": {</p>
			<p class="source-code">            "Default": "Warning"</p>
			<p class="source-code">        }</p>
			<p class="source-code">    },</p>
			<p class="source-code">    "AllowedHosts": "*"</p>
			<p class="source-code">}</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">This is just a sample of how to read<a id="_idIndexMarker059"/> configurations to configure <strong class="bold">Kestrel</strong>. Please never, <em class="italic">ever</em> store any credentials inside the code. Use the following concepts instead.</p>
			<p>You are also able to read from the user<a id="_idIndexMarker060"/> secrets store where the keys are set<a id="_idIndexMarker061"/> up with the following <strong class="bold">.NET</strong> <strong class="bold">CLI</strong> commands that you need to execute in the project folder:</p>
			<p class="source-code">dotnet user-secrets init</p>
			<p class="source-code">dotnet user-secrets set "AppSettings:certfilename" </p>
			<p class="source-code">  "certificate.pfx"</p>
			<p class="source-code">dotnet user-secrets set "AppSettings:certpassword" </p>
			<p class="source-code">  "topsecret"</p>
			<p>This also applies to environment variables:</p>
			<p class="source-code">SET APPSETTINGS_CERTFILENAME=certificate.pfx</p>
			<p class="source-code">SET APPSETTINGS_CERTPASSWORD=topsecret</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">Since the user secrets store is for local development only, you should pass credentials via environment variables to the application in production, or production-like applications. Also, the app<a id="_idIndexMarker062"/> settings configuration you will make in Azure will be passed as environment variables to your application.</p>
			<p>So, how does this all <a id="_idTextAnchor082"/><a id="_idTextAnchor083"/>work?</p>
			<h2 id="_idParaDest-49"><a id="_idTextAnchor084"/>How does it work?</h2>
			<p>Do you remember the days back when you needed to set app configurations in the <strong class="source-inline">Startup.cs</strong> file in ASP.NET Core 1.0? They were configured in the constructor of the <strong class="source-inline">StartUp</strong> class and looked similar to this if you added user secrets:</p>
			<p class="source-code">var builder = new ConfigurationBuilder()</p>
			<p class="source-code">    .SetBasePath(env.ContentRootPath)</p>
			<p class="source-code">    .AddJsonFile("appsettings.json")</p>
			<p class="source-code">    .AddJsonFile($"appsettings.{env.EnvironmentName}.json",</p>
			<p class="source-code">      optional:  true);</p>
			<p class="source-code">if (env.IsDevelopment())</p>
			<p class="source-code">{</p>
			<p class="source-code">    builder.AddUserSecrets();</p>
			<p class="source-code">}</p>
			<p class="source-code">builder.AddEnvironmentVariables();</p>
			<p class="source-code">Configuration = builder.Build();</p>
			<p>This code is now wrapped<a id="_idIndexMarker063"/> inside the <strong class="source-inline">CreateDefaultBuilder</strong> method (as you can see on GitHub – refer to the <em class="italic">Further reading</em> section for details) and looks like this:</p>
			<p class="source-code">builder.ConfigureAppConfiguration((hostingContext, config) </p>
			<p class="source-code">  =&gt;</p>
			<p class="source-code">{</p>
			<p class="source-code">    var env = hostingContext.HostingEnvironment;</p>
			<p class="source-code">    config</p>
			<p class="source-code">        .AddJsonFile(</p>
			<p class="source-code">            "appsettings.json", </p>
			<p class="source-code">            optional: true, </p>
			<p class="source-code">            reloadOnChange: true)</p>
			<p class="source-code">        .AddJsonFile(</p>
			<p class="source-code">            $"appsettings.{env.EnvironmentName}.json", </p>
			<p class="source-code">            optional:  true,</p>
			<p class="source-code">            reloadOnChange: true);</p>
			<p class="source-code">    if (env.IsDevelopment())</p>
			<p class="source-code">    {</p>
			<p class="source-code">        var appAssembly = Assembly.Load(</p>
			<p class="source-code">            new AssemblyName(env.ApplicationName));</p>
			<p class="source-code">        if (appAssembly != null)</p>
			<p class="source-code">        {</p>
			<p class="source-code">            config.AddUserSecrets(appAssembly, </p>
			<p class="source-code">                optional: true);</p>
			<p class="source-code">        }</p>
			<p class="source-code">    }</p>
			<p class="source-code">    config.AddEnvironmentVariables();</p>
			<p class="source-code">    if (args != null)</p>
			<p class="source-code">    {</p>
			<p class="source-code">        config.AddCommandLine(args);</p>
			<p class="source-code">    }</p>
			<p class="source-code">});</p>
			<p>This is almost the same code, and it is one of the first things that gets executed when building the <strong class="source-inline">WebHost</strong>.</p>
			<p>This needs to be one of the first<a id="_idIndexMarker064"/> things we set up because Kestrel is configurable via the app configuration. You can specify ports, URLs, and more by using environment variables or <strong class="source-inline">appsettings.json</strong>.</p>
			<p>You can find these lines in <strong class="source-inline">WebHost.cs</strong> on GitHub:</p>
			<p class="source-code">builder.UseKestrel((builderContext, options) =&gt;</p>
			<p class="source-code">  {</p>
			<p class="source-code">    options.Configure(</p>
			<p class="source-code">        builderContext.Configuration.GetSection("Kestrel"));</p>
			<p class="source-code">})</p>
			<p>This means that you are able to add these lines to <strong class="source-inline">appsettings.json</strong> to configure Kestrel endpoints:</p>
			<p class="source-code">"Kestrel": {</p>
			<p class="source-code">    "EndPoints": {</p>
			<p class="source-code">        "Http": {</p>
			<p class="source-code">            "Url": "http://localhost:5555"</p>
			<p class="source-code">        }</p>
			<p class="source-code">    }</p>
			<p class="source-code">}</p>
			<p>Alternatively, environment variables such as the following can be used to configure endpoints:</p>
			<p class="source-code">SET KESTREL_ENDPOINTS_HTTP_URL=http://localho<a id="_idTextAnchor085"/><a id="_idTextAnchor086"/>st:5555</p>
			<p>Let's now recap everything<a id="_idIndexMarker065"/> we've covered in this <a id="_idTextAnchor087"/><a id="_idTextAnchor088"/><a id="_idTextAnchor089"/>chapter.</p>
			<h1 id="_idParaDest-50"><a id="_idTextAnchor090"/>Summary</h1>
			<p>Inside <strong class="source-inline">Program.cs</strong>, you are able to make app configurations inside the lambdas of the configuration methods, provided you have access to the <strong class="source-inline">WebHostBuilderContext</strong>. This way, you can use all the configurations you like to configure <strong class="source-inline">WebHostBuilder</strong>.</p>
			<p>In the next chapter, we are going to have a look at the hosting details. You will learn about different hosting models and how to host an ASP.NET Core application in different ways.</p>
			<h1 id="_idParaDest-51"><a id="_idTextAnchor091"/>Further reading</h1>
			<p>The <strong class="source-inline">WebHost.cs</strong> file in the ASP.NET GitHub repository: <a href="https://github.com/aspnet/MetaPackages/blob/d417aacd7c0eff202f7860fe1e686aa5beeedad7/src/Microsoft.AspNetCore/WebHost.cs">https://github.com/aspnet/MetaPackages/blob/d417aacd7c0eff202f7860fe1e686aa5beeedad7/src/Microsoft.AspNetCore/WebHost.cs</a>.</p>
		</div>
	</body></html>