<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Working with External APIs"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Working with External APIs</h1></div></div></div><p>In previous chapters you created a multiplayer air hockey game. One way of expanding it would be making more levels and mechanics for it, but you already know how to do that. The other way would be integrating it with different external services, such as analytics, online scoring platforms, and leaderboards.</p><p>In this chapter we are going to talk about <span class="strong"><strong>application programming interfaces</strong></span> (<span class="strong"><strong>APIs</strong></span>). We will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">API—what it is and what it's used for</li><li class="listitem" style="list-style-type: disc">Existing useful external APIs</li><li class="listitem" style="list-style-type: disc">The way Unity typically communicates with external APIs</li><li class="listitem" style="list-style-type: disc">Integrating a game with one of the existing APIs (Kongregate)</li></ul></div><p>We will look at some code snippets that you are going to use to integrate your game with Kongregate, test the game online, and save the number of times the player wins on Kongregate's servers.</p><div class="section" title="About external application programming interfaces"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec34"/>About external application programming interfaces</h1></div></div></div><p>In simple terms and in the<a id="id168" class="indexterm"/> context of Unity, an external API is an external library of code that can be accessed from a Unity script and provides some additional functionality to your game. Some APIs let you access the JavaScript code of the page your WebPlayer game is on, while others provide a possibility of transferring game data and getting information to remote servers.</p><p>You have already used one API in your air hockey game in the previous chapter: that of Photon Unity Networking. Most of the calls to remote servers are buried deep inside of its source code, but it is nevertheless an API.</p><p>Other APIs that you might encounter include online game platforms, such as Kongregate and Facebook; analytics tools, such as Google Analytics<a id="id169" class="indexterm"/> and<a id="id170" class="indexterm"/> Game Analytics; and online data storage platforms, such as Scoreoid<a id="id171" class="indexterm"/> and<a id="id172" class="indexterm"/> Steamworks.</p><p>In addition to different functions, APIs use different ways to connect to the external code base and different ways to communicate with it later, which may seem like a hard task, but rarely is. There is generally a comprehensive guide to the API on its website, and even when there is not the Unity community often comes to the rescue, putting together its own guides, template files, and code snippets readily available in Unity answers or forums.</p><p>We are going to <a id="id173" class="indexterm"/>integrate our game with Kongregate to show how this works and what kind of code you need to use. Kongregate was chosen as a fairly straightforward, very common, and completely free API.</p></div></div>
<div class="section" title="Uploading your game to Kongregate"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec35"/>Uploading your game to Kongregate</h1></div></div></div><p>Before starting to use the <a id="id174" class="indexterm"/>Kongregate API, you have to see that you can <a id="id175" class="indexterm"/>actually upload your game to the website. To do that, you are going to need a Kongregate account if you do not have one yet.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Go to <a class="ulink" href="http://kongregate.com">http://kongregate.com</a> and<a id="id176" class="indexterm"/> near the top of the page find and click the <span class="strong"><strong>Register</strong></span> link, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/8108OT_07_01.jpg" alt="Uploading your game to Kongregate"/></div></li><li class="listitem">A registration form should appear, offering you to either connect using Facebook or enter your account information manually. Do that and click on the <span class="strong"><strong>Sign Up</strong></span> button.</li><li class="listitem">Now, if you go to the Kongregate main page and hover over the <span class="strong"><strong>GAMES</strong></span> button just under the sign-in block of the website, a submenu should appear, divided into three sections: <span class="strong"><strong>FEATURED</strong></span>, <span class="strong"><strong>CATEGORIES</strong></span>, and <span class="strong"><strong>DEVELOPERS</strong></span>. It is the last one that is of interest to us. Find the <span class="strong"><strong>UPLOAD A GAME </strong></span>button there and click on it.</li><li class="listitem">Open Unity and make a Web build, like you did to test multiplayer in <a class="link" href="ch06.html" title="Chapter 6. Networking and Multiplayer">Chapter 6</a>, <span class="emphasis"><em>Networking and Multiplayer</em></span>; remember where you saved it.</li><li class="listitem">On the Kongregate website, you now should have the game information menu. Enter the game's name, category, and description, then click on <span class="strong"><strong>Continue</strong></span>.</li><li class="listitem">The next step asks you to choose game files and upload them to Kongregate's server. Click on the <span class="strong"><strong>Choose File</strong></span> button next to <span class="strong"><strong>Game File</strong></span>, navigate to the folder where you saved your Web build from Unity, select the file with the <code class="literal">unity3d</code> extension, and click on <span class="strong"><strong>Open</strong></span>.</li><li class="listitem">In the two text fields below, enter the game's resolution (width 960 and height 600).</li><li class="listitem">Upload an <a id="id177" class="indexterm"/>image as an icon. You can test, but<a id="id178" class="indexterm"/> cannot publish a game that does not have an icon.</li><li class="listitem">You can also upload images as screenshots. This is not necessary, and you can do this later.</li><li class="listitem">Check <span class="strong"><strong>This game is exclusive to Kongregate</strong></span> if you are not planning to upload the game anywhere else. This will ensure that you get more ad profits for people playing your game.</li><li class="listitem">Read the <span class="strong"><strong>License Agreement</strong></span> and check the four checkboxes below it.</li><li class="listitem">The <span class="strong"><strong>Statistics API</strong></span> section is what we are going to be using the Kongregate API for. Click on <span class="strong"><strong>Add a statistic</strong></span>.</li><li class="listitem">Set <span class="strong"><strong>Statistic Name</strong></span> to <code class="literal">Wins</code> and select the <span class="strong"><strong>Add Type</strong></span> radio button. This is the statistic type, which determines how the statistic will behave. In our case, we will simply add the player's wins up. If your game had a scoring system, you could create another statistic of <span class="strong"><strong>Max</strong></span> type for it.</li><li class="listitem">Check <span class="strong"><strong>Display in leaderboards</strong></span> to make sure that the statistic shows up on the game's public page.</li><li class="listitem">Click on <span class="strong"><strong>Save</strong></span>, then click on <span class="strong"><strong>Upload</strong></span> on the bottom of the form.</li><li class="listitem">After a short waiting period, the game should show up on your screen, being completely functionally playable. You can test the multiplayer mode to make sure that nothing has changed since you uploaded it to the server.</li></ol></div><p>If everything works correctly, we should integrate our <span class="strong"><strong>Wins</strong></span> parameter with the game itself. To do that, we will need to write a couple of scripts.</p></div>
<div class="section" title="Writing Kongregate API code"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec36"/>Writing Kongregate API code</h1></div></div></div><p>There are two scripts that we are going to have to make in order to get our <span class="strong"><strong>Wins</strong></span> scoring parameter saved and appearing in the leaderboards. The first one will set up Kongregate, make sure that the game is indeed on the Kongregate page, and inform the game about the API connection status.</p><p>The second script is <a id="id179" class="indexterm"/>going to be about incrementing a score for the player who wins based on the goal the puck hits.</p><p>Without any further delay, the following is the code for the handshake script, which is called <code class="literal">KongregateAPI</code>:</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

// You have to add System in order to access the Convert class
using System;

public class KongregateAPI : MonoBehaviour 
{
  // We are going to check this variable to confirm that
  // Kongregate connection is established
  public static bool isKongregate = false;
  
  // Player ID
  public static int userId;
  
  // Player account name. This can be used for greeting the player,
  // for example
  public static string userName;
  
  // Game ID
  public static string gameAuthToken;
  
  void Start()
  {
    // Establishing connection with Kongregate
    // Make sure that the game object this script is attached to
    // is in the first scene that gets loaded,
    // and that the name of the object it is attached to is KongregateAPI
    Application.ExternalEval(
    "if(typeof(kongregateUnitySupport) != 'undefined'){" + " kongregateUnitySupport.initAPI('" + gameObject.name +"','OnKongregateAPILoaded');" + "};" );
  }
  
  // This method gets called if the game is on Kongregate
  void OnKongregateAPILoaded(string userInfoString)
  {
    Debug.Log("Kongregate connection established.");
    
    isKongregate = true;
    
    // Kongregate returns a string of chars that we divide and save into variables
    string[] parms = userInfoString.Split("|"[0]);
    userId = Convert.ToInt32(parms[0]);
    userName = parms[1];
    gameAuthToken = parms[2];
  }
}</pre></div><p>This code is<a id="id180" class="indexterm"/> fairly straightforward and does not require much explanation on top of the comments already given within the script. Only two things should be noted: <code class="literal">Application.ExternalEval</code> is what makes your Unity game communicate with the JavaScript of the page it is on. Unity sends a message in the form of a string of text to the page, which is picked up by Kongregate and interpreted as code. The contents of this string are using the Kongregate API, the full version of which  can be consulted here: <a class="ulink" href="http://www.kongregate.com/developer_center/docs/en/using-the-api-with-unity3d">http://www.kongregate.com/developer_center/docs/en/using-the-api-with-unity3d</a>. <code class="literal">ExternalEval</code> is a very common method for accessing external APIs.</p><p>It is imperative that the game object your script is attached to (as well as the script itself) is called <span class="strong"><strong>KongregateAPI</strong></span>. Create an empty game object in the <span class="strong"><strong>demo_lobby</strong></span> scene and attach the script to it, then save the scene.</p><p>Once the JavaScript code on the page is executed, Kongregate sends a callback message back to Unity. This message always takes the form of the <code class="literal">OnKongregateAPILoaded(string userInfoString)</code> method. This, too, is part of the API. We then separate the string that it gives us using the <code class="literal">|</code> symbol and save parts of it into variables.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip28"/>Tip</h3><p>There is really no point in making the Kongregate API script into a Playmaker action, unless you don't want to use any components other that Playmaker in your game, in which case I will leave it up to you to do it: the process is similar to that which we used in <a class="link" href="ch05.html" title="Chapter 5. Scripting and Custom Actions">Chapter 5</a>, <span class="emphasis"><em>Scripting and Custom Actions</em></span>.</p></div></div><p>Unless you have changed something in the winning condition, the game does not currently distinguish between player 1 and 2 winning, and simply restarts the game no matter what happens. However, due to the fact that we have a multiplayer mode and want to save each player's wins, this does not work for us anymore. We are going to need to make the goal trigger into prefabs and spawn them the way we already spawn the goals and the mallets; then, when the puck hits one of them, detect if it belongs to us, and, if it does not, send the win to Kongregate.</p><p>To begin with, let us prepare a <a id="id181" class="indexterm"/>Playmaker action that sends wins to Kongregate.</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

namespace HutongGames.PlayMaker.Actions
{
  [ActionCategory(ActionCategory.Level)]
  [Tooltip("Increment the Wins variable on Kongregate.")]
  public class KongregateSendAction : FsmStateAction 
  {
    public override void OnEnter()
    {
      if (KongregateAPI.isKongregate)
      Application.ExternalCall("kongregate.stats.submit", "Wins", 1);
    }
  }
}</pre></div><p>Here <code class="literal">Application.ExternalCall</code> is used. It calls an external function in the page as opposed to <code class="literal">ExternalEval</code>, which evaluates a code snippet that may or may not contain function calls.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip29"/>Tip</h3><p><code class="literal">ExternalCall</code> and <code class="literal">ExternalEval</code> both only work in Unity Webplayer.</p></div></div><p>Follow these steps in order to increment the<a id="id182" class="indexterm"/> <span class="strong"><strong>Wins</strong></span> statistic on <a id="id183" class="indexterm"/>Kongregate:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <span class="strong"><strong>demo_room</strong></span> scene.</li><li class="listitem">Create a prefab called <code class="literal">GoalTrigger</code>, then drag the <span class="strong"><strong>GoalTriggerLeft</strong></span> game object to it from <span class="strong"><strong>Hierarchy</strong></span>.</li><li class="listitem">Delete both <span class="strong"><strong>GoalTriggerLeft</strong></span> and <span class="strong"><strong>GoalTriggerRight</strong></span> game objects from the scene; we are going to spawn them on startup.</li><li class="listitem">Select the <span class="strong"><strong>Game</strong></span> game object and, in its <span class="strong"><strong>Game Manager</strong></span> FSM, add a <span class="strong"><strong>GameObject</strong></span> variable called <span class="strong"><strong>goalTriggerRef</strong></span>.</li><li class="listitem">Navigate to this FSM's instantiate player state. Add a new <span class="strong"><strong>Photon Network Instantiate</strong></span> action to this state. Set the <span class="strong"><strong>Game Object</strong></span> property to <span class="strong"><strong>GoalTrigger</strong></span>, <span class="strong"><strong>Position</strong></span> to <code class="literal">(-9</code>, <code class="literal">0.42</code>, <code class="literal">0</code>), <span class="strong"><strong>Rotation</strong></span> to (<code class="literal">0</code>, <code class="literal">90</code>, <code class="literal">0</code>), and <span class="strong"><strong>Store Object</strong></span> to <span class="strong"><strong>goalTriggerRef</strong></span>.</li><li class="listitem">Open the <span class="strong"><strong>Create Puck</strong></span> state and add a <span class="strong"><strong>Set Position</strong></span> action to it. In this action, set the <span class="strong"><strong>Game Object</strong></span> property to <span class="strong"><strong>Specify Game Object</strong></span>, then set it to the <span class="strong"><strong>goalTriggerRef</strong></span> variable. Set <span class="strong"><strong>Vector</strong></span>, <span class="strong"><strong>Y</strong></span>, and <span class="strong"><strong>Z</strong></span> to <span class="strong"><strong>None</strong></span> and <span class="strong"><strong>X</strong></span> to <code class="literal">9</code>.</li><li class="listitem">Now that we have set up the instantiation of our goal triggers, we need to send our scores to Kongregate. Select the <code class="literal">GoalTrigger</code> prefab in the Project panel and add a <span class="strong"><strong>Photon View</strong></span> component to it, then drag its <span class="strong"><strong>Transform</strong></span> component into the <span class="strong"><strong>Observe</strong></span> slot of <span class="strong"><strong>Photon View</strong></span>.</li><li class="listitem">Add a <span class="strong"><strong>PlayMaker Photon GameObject Proxy</strong></span> component to the prefab.</li><li class="listitem">In the <span class="strong"><strong>playMaker</strong></span> panel, make the FSM look as shown in the following figure, adding all the missing states, events, and transitions.<div class="mediaobject"><img src="graphics/8108OT_07_02.jpg" alt="Writing Kongregate API code"/></div></li><li class="listitem">Add a <a id="id184" class="indexterm"/><span class="strong"><strong>Photon View Get Is Mine</strong></span> action to the <span class="strong"><strong>is mine?</strong></span> state. Set <a id="id185" class="indexterm"/><span class="strong"><strong>Is Mine Event</strong></span> to <span class="strong"><strong>YES</strong></span> and <span class="strong"><strong>Is Not Mine Event</strong></span> to <span class="strong"><strong>NO</strong></span>, provided that you have created the <span class="strong"><strong>YES</strong></span> and <span class="strong"><strong>NO</strong></span> events in the <span class="strong"><strong>Events</strong></span> tab before. If you haven't, go ahead and do it now.</li><li class="listitem">Add <span class="strong"><strong>Kongregate Send Action</strong></span> to the <span class="strong"><strong>KongregateSend</strong></span> state. This is the action that we created earlier.</li><li class="listitem">Save the scene.</li></ol></div><p>Now, if you build the game, upload it to Kongregate, play, and win, a score will be added. You should see a <span class="strong"><strong>HIGH SCORE</strong></span> tab appear on the right on your game's page.</p><p>If it does not, don't worry, sometimes it can take some time for the first score to be submitted. If you feel like there is a problem, you can see exactly what commands Kongregate exchanges with your game by opening the JavaScript console of your internet browser while on the game's page.</p><p>Once you are sure that the game is working well and the <span class="strong"><strong>Wins</strong></span> statistic is being submitted properly, you can either try adding some more stats or just publish the game by pressing the appropriate link near the top of the page. Then you can test it by either sending the public link to your friends or by opening it twice yourself and joining the same server.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec37"/>Summary</h1></div></div></div><p>In this chapter, you learned what an external API in Unity is and what kinds of external APIs there are, and then added one to your game. You uploaded your game to Kongregate and saved a game statistic for your multiplayer air hockey game on Kongregate's servers.</p></div></body></html>