<html><head></head><body>
<div id="_idContainer155">
<h1 class="chapterNumber"><a id="_idTextAnchor151"/><span class="koboSpan" id="kobo.1.1">7</span></h1>
<h1 class="chapterTitle" id="_idParaDest-114"><a id="_idTextAnchor152"/><span class="koboSpan" id="kobo.2.1">Microservices in Practice</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">This chapter is dedicated to the practical implementation of each microservice that exists after the design of the general application architecture and after that all interfaces of all Microservices have been defined. </span><span class="koboSpan" id="kobo.3.2">The interaction between, and orchestration of, microservices will be detailed in the remaining chapters of this book. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">All concepts will be illustrated with the example of a worker microservice taken from the book’s case study application that we introduced in the </span><a id="_idTextAnchor153"/><em class="italic"><span class="koboSpan" id="kobo.5.1">Car-sharing example </span></em><span class="koboSpan" id="kobo.6.1">subsection of</span><em class="italic"> </em><a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic"><span class="koboSpan" id="kobo.7.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.8.1">,</span><em class="italic"><span class="koboSpan" id="kobo.9.1"> Demystifying Microservices Applications</span></em><span class="koboSpan" id="kobo.10.1">. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.11.1">After a short description of the example worker microservice specifications, we will describe how to design microservices’ input and output communication subsystems, and how to organize the microservice request-serving logic. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.12.1">Finally, we will discuss the details of how to implement a microservice with the Onion Architecture project templates introduced in the </span><em class="italic"><span class="koboSpan" id="kobo.13.1">A solution template based on the Onion Architecture </span></em><span class="koboSpan" id="kobo.14.1">section of</span><em class="italic"> </em><a href="Chapter_3.xhtml#_idTextAnchor067"><em class="italic"><span class="koboSpan" id="kobo.15.1">Chapter 3</span></em></a><span class="koboSpan" id="kobo.16.1">, </span><em class="italic"><span class="koboSpan" id="kobo.17.1">Setup and Theory: Docker and Onion Architecture</span></em><span class="koboSpan" id="kobo.18.1">. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.19.1">More specifically, this chapter covers the following:</span></p>
<ul>
<li class="bulletList"><a id="_idTextAnchor154"/><span class="koboSpan" id="kobo.20.1">The route-planning microservice of the car-sharing application</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.21.1">Microservice basic design</span></li>
<li class="bulletList"><a id="_idTextAnchor155"/><span class="koboSpan" id="kobo.22.1">Ensuring resilient communication with Polly</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.23.1">From abstraction to implementation details</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-115"><a id="_idTextAnchor156"/><span class="koboSpan" id="kobo.24.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.25.1">This chapter requires the following:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.26.1">Visual Studio 2022, at least the free </span><em class="italic"><span class="koboSpan" id="kobo.27.1">Community </span></em><span class="koboSpan" id="kobo.28.1">edition. </span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.29.1">A SQL instance that accepts TCP/IP requests and user/password authentication since it must communicate with clients running inside Docker containers. </span><span class="koboSpan" id="kobo.29.2">Please note that the SQL instance that comes with the Visual Studio installation doesn’t support TCP/IP, so you need to either install SQL Express or use a cloud instance. </span><span class="koboSpan" id="kobo.29.3">For local installation, both the installer and instructions are available here: </span><a href="https://www.microsoft.com/en-US/download/details.aspx?id=104781"><span class="url"><span class="koboSpan" id="kobo.30.1">https://www.microsoft.com/en-US/download/details.aspx?id=104781</span></span></a><span class="koboSpan" id="kobo.31.1">. </span><span class="koboSpan" id="kobo.31.2">You may also run the SQL Server Developer edition as a Docker image with the following code:
        </span><pre class="programlisting con-one"><code class="hljs-con"><span class="koboSpan" id="kobo.32.1">docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=yourStrong(!)Password" -p 1433:1433 -d mcr.microsoft.com/mssql/server:2022-latest
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.33.1">The username corresponding to the chosen password will be </span><code class="inlineCode"><span class="koboSpan" id="kobo.34.1">sa</span></code><span class="koboSpan" id="kobo.35.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.36.1">Docker Desktop for Windows (</span><a href="https://www.docker.com/products/docker-desktop"><span class="url"><span class="koboSpan" id="kobo.37.1">https://www.docker.com/products/docker-desktop</span></span></a><span class="koboSpan" id="kobo.38.1">).</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.39.1">Docker </span><a id="_idIndexMarker345"/><span class="koboSpan" id="kobo.40.1">Desktop, in turn, requires </span><strong class="keyWord"><span class="koboSpan" id="kobo.41.1">Windows Subsystem for Linux (WSL)</span></strong><span class="koboSpan" id="kobo.42.1">, which can be installed by following these steps:</span><ol class="numberedList level-2" style="list-style-type: decimal;">
<li class="numberedList level-2" value="1"><span class="koboSpan" id="kobo.43.1">Type </span><code class="inlineCode"><span class="koboSpan" id="kobo.44.1">powershell</span></code><span class="koboSpan" id="kobo.45.1"> in the Windows 10/11 search bar.</span></li>
<li class="numberedList level-2"><span class="koboSpan" id="kobo.46.1">When </span><strong class="screenText"><span class="koboSpan" id="kobo.47.1">Windows PowerShell</span></strong><span class="koboSpan" id="kobo.48.1"> is proposed as a search result, click on </span><strong class="screenText"><span class="koboSpan" id="kobo.49.1">Run as an administrator</span></strong><span class="koboSpan" id="kobo.50.1">.</span></li>
<li class="numberedList level-2"><span class="koboSpan" id="kobo.51.1">In the Windows PowerShell administrative console that appears, run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.52.1">wsl --install</span></code><span class="koboSpan" id="kobo.53.1"> command.</span></li>
</ol>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.54.1">You can find the sample code for this chapter at </span><a href="https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp"><span class="url"><span class="koboSpan" id="kobo.55.1">https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp</span></span></a><span class="koboSpan" id="kobo.56.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-116"><a id="_idTextAnchor157"/><span class="koboSpan" id="kobo.57.1">The route-planning microservice of the car-sharing application </span></h1>
<p class="normal"><span class="koboSpan" id="kobo.58.1">In this </span><a id="_idIndexMarker346"/><span class="koboSpan" id="kobo.59.1">section, we describe our example microservice, how to handle security, and how to prepare the solution for its implementation into three separate subsections.</span></p>
<h2 class="heading-2" id="_idParaDest-117"><a id="_idTextAnchor158"/><span class="koboSpan" id="kobo.60.1">Microservice specifications</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.61.1">The </span><a id="_idIndexMarker347"/><span class="koboSpan" id="kobo.62.1">route-planning microservice stores and matches pending requests to move from one town to another with existing routes that are still open to other participants. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.63.1">When an opened route of a car owner is created, it is matched with requests whose start and end towns are close to the car owner’s route and whose date constraints are compatible. </span><span class="koboSpan" id="kobo.63.2">If matches are found, a proposal to modify the route to include them is created and sent to other interested microservices. </span><span class="koboSpan" id="kobo.63.3">A symmetric operation is also done when a new request is inserted.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.64.1">When a proposal to extend the route is accepted, the original route is extended.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.65.1">After the initial match attempt, both requests and routes are stored for possible future matches. </span><span class="koboSpan" id="kobo.65.2">Requests and routes are removed or modified under the following circumstances:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.66.1">A route is removed from possible matches when it is closed to new participants or aborted. </span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.67.1">A route is extended when it is merged with some requests. </span><span class="koboSpan" id="kobo.67.2">No new matches are attempted as a consequence of this operation.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.68.1">A request is removed from possible matches when it is merged with a route.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.69.1">A request becomes available again when the route it was merged with is aborted. </span><span class="koboSpan" id="kobo.69.2">After this operation, new matches are attempted.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.70.1">Both requests and routes are deleted </span><em class="italic"><span class="koboSpan" id="kobo.71.1">N</span></em><span class="koboSpan" id="kobo.72.1"> days after their maximum travel day expires, where </span><em class="italic"><span class="koboSpan" id="kobo.73.1">N</span></em><span class="koboSpan" id="kobo.74.1"> is a parameter to be provided.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.75.1">Matches between routes and requests are done when the following circumstances are met:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.76.1">The route date falls between the minimum and maximum dates associated with the request.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.77.1">Both the request start and end towns are close enough to the route.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.78.1">We will implement most microservice-to-microservice communication with the publisher/subscriber pattern in order to maximize microservice decoupling. </span><span class="koboSpan" id="kobo.78.2">This choice will also minimize the overall communication-related code, since message handlers and their client libraries take care of most of the asynchronous communication problems. </span><span class="koboSpan" id="kobo.78.3">Please refer to the </span><em class="italic"><span class="koboSpan" id="kobo.79.1">Event-based communications </span></em><span class="koboSpan" id="kobo.80.1">subsection of</span><em class="italic"> </em><a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic"><span class="koboSpan" id="kobo.81.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.82.1">, </span><em class="italic"><span class="koboSpan" id="kobo.83.1">Demystifying Microservices Applications</span></em><span class="koboSpan" id="kobo.84.1">, for more details on event-based communication.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.85.1">Moreover, in order to maximize application portability, we will use the </span><strong class="keyWord"><span class="koboSpan" id="kobo.86.1">RabbitMQ</span></strong><span class="koboSpan" id="kobo.87.1"> message broker, which is not </span><a id="_idIndexMarker348"/><span class="koboSpan" id="kobo.88.1">tied to a specific platform or cloud but can be installed in any Kubernetes-based network with an adjustable number of replicas. </span><strong class="keyWord"><span class="koboSpan" id="kobo.89.1">RabbitMQ</span></strong><span class="koboSpan" id="kobo.90.1"> will be described in a dedicated subsection of the next section.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.91.1">Since the car-sharing application doesn’t exchange heavy messages, we may avoid non-standard binary </span><a id="_idIndexMarker349"/><span class="koboSpan" id="kobo.92.1">serializations such as </span><strong class="keyWord"><span class="koboSpan" id="kobo.93.1">gRPC Protobuf</span></strong><span class="koboSpan" id="kobo.94.1"> and opt for a simple </span><strong class="keyWord"><span class="koboSpan" id="kobo.95.1">JSON</span></strong><span class="koboSpan" id="kobo.96.1"> message serialization.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.97.1">Most web servers and communication libraries can be configured to automatically compress JSON data. </span><span class="koboSpan" id="kobo.97.2">Web servers negotiate compression with the client.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.98.1">Finally, since our worker microservice in-out communication is based on message brokers and not </span><a id="_idIndexMarker350"/><span class="koboSpan" id="kobo.99.1">on the usual </span><strong class="keyWord"><span class="koboSpan" id="kobo.100.1">HTTP </span></strong><span class="koboSpan" id="kobo.101.1">and </span><strong class="keyWord"><span class="koboSpan" id="kobo.102.1">gRPC</span></strong><span class="koboSpan" id="kobo.103.1"> ASP.NET Core </span><a id="_idIndexMarker351"/><span class="koboSpan" id="kobo.104.1">protocols, we might consider the ad hoc </span><strong class="screenText"><span class="koboSpan" id="kobo.105.1">Worker service</span></strong><span class="koboSpan" id="kobo.106.1"> project template </span><a id="_idIndexMarker352"/><span class="koboSpan" id="kobo.107.1">based on the so-called </span><strong class="keyWord"><span class="koboSpan" id="kobo.108.1">hosted services</span></strong><span class="koboSpan" id="kobo.109.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.110.1">hosted services</span></strong><span class="koboSpan" id="kobo.111.1"> will be </span><a id="_idIndexMarker353"/><span class="koboSpan" id="kobo.112.1">discussed in the next section). </span><span class="koboSpan" id="kobo.112.2">However, microservices best practices prescribe that each microservice should expose an HTTP endpoint to verify its health status, so we will adopt a minimal API-based ASP.NET Core Web API</span><strong class="screenText"> </strong><span class="koboSpan" id="kobo.113.1">project since it also supports the hosted services that we need for receiving message-broker-based communication.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.114.1">Having clarified the microservice responsibilities, we can move on to security considerations.</span></p>
<h2 class="heading-2" id="_idParaDest-118"><a id="_idTextAnchor159"/><span class="koboSpan" id="kobo.115.1">Handling security and authorization </span></h2>
<p class="normal"><span class="koboSpan" id="kobo.116.1">The authorization of requests coming from actual users is handled with the usual ASP.NET Web API techniques, that is, with </span><a id="_idIndexMarker354"/><span class="koboSpan" id="kobo.117.1">web tokens (typically a </span><strong class="keyWord"><span class="koboSpan" id="kobo.118.1">JSON bearer token</span></strong><span class="koboSpan" id="kobo.119.1">) and </span><code class="inlineCode"><span class="koboSpan" id="kobo.120.1">Authorize</span></code><span class="koboSpan" id="kobo.121.1"> attributes. </span><span class="koboSpan" id="kobo.121.2">Web tokens are provided by the login and token-renew </span><a id="_idIndexMarker355"/><span class="koboSpan" id="kobo.122.1">endpoints of a specialized microservice that acts as the authorization server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.123.1">Requests coming from other services instead are usually secured with mTLS, that is, with certificate-based client authentication. </span><span class="koboSpan" id="kobo.123.2">Client certificates are handled by the lower-level TCP/IP protocol together with the server certificate used for encrypting the HTTPS communication. </span><span class="koboSpan" id="kobo.123.3">Then, the information extracted by the client certificate is passed to the ASP.NET Core authentication middleware to create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.124.1">ClaimsPrincipal </span></code><span class="koboSpan" id="kobo.125.1">(the usual ASP.NET Core </span><strong class="keyWord"><span class="koboSpan" id="kobo.126.1">User</span></strong><span class="koboSpan" id="kobo.127.1"> object). </span><span class="koboSpan" id="kobo.127.2">When the application runs within an orchestrator, it is also possible to use orchestrator-specific authorization, and when the application runs in the cloud, it is possible to use cloud-specific authorization.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.128.1">Luckily, if both communicating microservices are exposed in a private network, or better, in a private network handled by a microservices orchestrator, we may replace user authentication with firewall rules and/or with other communication-securing facilities offered by the orchestrator. </span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.129.1">We will analyze the Kubernetes orchestrator in </span><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.130.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.131.1">, </span><em class="italic"><span class="koboSpan" id="kobo.132.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.133.1">, and its communication-securing facilities in </span><a href="Chapter_10.xhtml#_idTextAnchor297"><em class="italic"><span class="koboSpan" id="kobo.134.1">Chapter 10</span></em></a><span class="koboSpan" id="kobo.135.1">, </span><em class="italic"><span class="koboSpan" id="kobo.136.1">Security and Observability for Serverless and Microservices Applications</span></em><span class="koboSpan" id="kobo.137.1">. </span><span class="koboSpan" id="kobo.137.2">Even in a private network, it is recommended to encrypt internal communication using mTLS or other encryption methods to mitigate insider threats and network attacks, but for the sake of simplicity in this book, we will only secure communication with the outside world. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.138.1">Therefore, if we adequately organize our private network, we need to secure just communication with the outside world, that is, communication with frontend microservices. </span><span class="koboSpan" id="kobo.138.2">However, as discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.139.1">Interfacing the external world </span></em><span class="koboSpan" id="kobo.140.1">subsection of</span><em class="italic"> </em><a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic"><span class="koboSpan" id="kobo.141.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.142.1">, </span><em class="italic"><span class="koboSpan" id="kobo.143.1">Demystifying Microservices Applications</span></em><span class="koboSpan" id="kobo.144.1">, microservices-based applications use API gateways to communicate with the external world. </span><span class="koboSpan" id="kobo.144.2">In the simplest case, the interface with the external world </span><a id="_idIndexMarker356"/><span class="koboSpan" id="kobo.145.1">is just a load-balanced web server that performs HTTPS termination, that is, that receives HTTPS communications from the external world. </span><span class="koboSpan" id="kobo.145.2">While some architectures terminate HTTPS at the API gateway and use HTTP internally, it is recommended to maintain encryption within the private network using mTLS or re-encryption to ensure security within the microservices ecosystem. </span><span class="koboSpan" id="kobo.145.3">This way, we may use just a single HTTPS certificate for the whole application, thus avoiding the whole certificate issuing and renewal procedure for all microservices that compose the application.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.146.1">Summing up, if we use any kind of HTTPS-termination interface to access the microservice application, we may avoid using HTTPS communication in all microservices.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.147.1">Now we are ready to prepare the Visual Studio solution that will host the route-planning microservice!</span></p>
<h2 class="heading-2" id="_idParaDest-119"><a id="_idTextAnchor160"/><span class="koboSpan" id="kobo.148.1">Creating the Visual Studio solution </span></h2>
<p class="normal"><span class="koboSpan" id="kobo.149.1">Since we decided to implement the outermost layer of our worker microservice with an ASP.NET </span><a id="_idIndexMarker357"/><span class="koboSpan" id="kobo.150.1">Core Web API project, let’s create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.151.1">CarSharing</span></code><span class="koboSpan" id="kobo.152.1"> Visual Studio solutio</span><a id="_idTextAnchor161"/><span class="koboSpan" id="kobo.153.1">n containing an ASP.NET Core Web API</span><strong class="screenText"> </strong><span class="koboSpan" id="kobo.154.1">project called </span><code class="inlineCode"><span class="koboSpan" id="kobo.155.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.156.1">. </span><span class="koboSpan" id="kobo.156.2">The </span><strong class="screenText"><span class="koboSpan" id="kobo.157.1">ASP.NET Core Web API </span></strong><span class="koboSpan" id="kobo.158.1">project can be easily found by selecting </span><strong class="screenText"><span class="koboSpan" id="kobo.159.1">C#</span></strong><span class="koboSpan" id="kobo.160.1">, </span><strong class="screenText"><span class="koboSpan" id="kobo.161.1">All platforms</span></strong><span class="koboSpan" id="kobo.162.1">, and</span><strong class="screenText"><span class="koboSpan" id="kobo.163.1"> Web API</span></strong><span class="koboSpan" id="kobo.164.1"> from the dropdowns of the Visual Studio project selection window, as shown here:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.165.1"><img alt="" role="presentation" src="../Images/B31916_07_1.png"/></span> </figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.166.1">Figure 7.1: Project selection</span></p>
<p class="normal"><span class="koboSpan" id="kobo.167.1">As </span><a id="_idIndexMarker358"/><span class="koboSpan" id="kobo.168.1">discussed previously, we may avoid HTTPS communication, and worker microservices do not need authentication. </span><span class="koboSpan" id="kobo.168.2">However, we need Docker support since microservices are usually containerized. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.169.1">Finally, we don’t need controllers but just a minimal API since we need to expose just a couple of trivial endpoints for health checks:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.170.1"><img alt="Figure 7.2: Project settings" src="../Images/B31916_07_2.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.171.1">Figure 7.2: Project settings</span></p>
<p class="normal"><span class="koboSpan" id="kobo.172.1">We will </span><a id="_idIndexMarker359"/><span class="koboSpan" id="kobo.173.1">use the Onion Architecture, so we need to also add a project for the application services and domain layer. </span><span class="koboSpan" id="kobo.173.2">Therefore, let’s add two more </span><strong class="screenText"><span class="koboSpan" id="kobo.174.1">Class Library</span></strong><span class="koboSpan" id="kobo.175.1"> projects, called </span><code class="inlineCode"><span class="koboSpan" id="kobo.176.1">RoutesPlanningApplicationServices</span></code><span class="koboSpan" id="kobo.177.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.178.1">RoutesPlanningDomainLayer</span></code><span class="koboSpan" id="kobo.179.1">. </span><span class="koboSpan" id="kobo.179.2">We will adapt the Onion Architecture template introduced in the</span><em class="italic"><span class="koboSpan" id="kobo.180.1"> A solution template based on the Onion Architecture </span></em><span class="koboSpan" id="kobo.181.1">section of</span><em class="italic"> </em><a href="Chapter_3.xhtml#_idTextAnchor067"><em class="italic"><span class="koboSpan" id="kobo.182.1">Chapter 3</span></em></a><span class="koboSpan" id="kobo.183.1">, </span><em class="italic"><span class="koboSpan" id="kobo.184.1">Setup and Theory: Docker and Onion Architecture</span></em><span class="koboSpan" id="kobo.185.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.186.1">Let’s open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.187.1">OnionArchitectureComplete</span></code><span class="koboSpan" id="kobo.188.1"> project template, which you can find in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.189.1">ch03</span></code><span class="koboSpan" id="kobo.190.1"> folder of the book’s GitHub repository. </span><span class="koboSpan" id="kobo.190.2">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.191.1">RoutesPlanningDomainLayer</span></code><span class="koboSpan" id="kobo.192.1"> project, delete the </span><strong class="screenText"><span class="koboSpan" id="kobo.193.1">Class1.cs</span></strong><span class="koboSpan" id="kobo.194.1"> file, select the three folders in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.195.1">DomainLayer</span></code><span class="koboSpan" id="kobo.196.1"> project of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.197.1">ch03</span></code><span class="koboSpan" id="kobo.198.1"> project template, copy them, and paste them into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.199.1">RoutesPlanningDomainLayer</span></code><span class="koboSpan" id="kobo.200.1"> project. </span><span class="koboSpan" id="kobo.200.2">If you have the latest Visual Studio 2022 version installed, you should be able to perform the copy operation from within Visual Studio Solution Explorer. </span><span class="koboSpan" id="kobo.200.3">Also, add a reference to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.201.1">Microsoft.Extensions.DependencyInjection.Abstractions</span></code><span class="koboSpan" id="kobo.202.1"> NuGet package to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.203.1">RoutesPlanningDomainLayer</span></code><span class="koboSpan" id="kobo.204.1"> project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.205.1">Then, perform the analogous operations on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.206.1">RoutesPlanningApplicationServices</span></code><span class="koboSpan" id="kobo.207.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.208.1">ApplicationServices</span></code><span class="koboSpan" id="kobo.209.1"> projects.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.210.1">Now that you have all the Onion Architecture files in place, you need to add just a reference to </span><code class="inlineCode"><span class="koboSpan" id="kobo.211.1">RoutesPlanningDomainLayer</span></code><span class="koboSpan" id="kobo.212.1"> in </span><code class="inlineCode"><span class="koboSpan" id="kobo.213.1">RoutesPlanningApplicationServices</span></code><span class="koboSpan" id="kobo.214.1"> and a reference to </span><code class="inlineCode"><span class="koboSpan" id="kobo.215.1">RoutesPlanningApplicationServices</span></code><span class="koboSpan" id="kobo.216.1"> in </span><code class="inlineCode"><span class="koboSpan" id="kobo.217.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.218.1">. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.219.1">After the last operation, your solution should compile, but we have not finished preparing our solution yet. </span><span class="koboSpan" id="kobo.219.2">We need to also add an </span><strong class="keyWord"><span class="koboSpan" id="kobo.220.1">Entity Framework Core</span></strong><span class="koboSpan" id="kobo.221.1">-based library in order to provide an implementation driver for our domain layer. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.222.1">Let’s </span><a id="_idIndexMarker360"/><span class="koboSpan" id="kobo.223.1">add a new class library project and call it </span><code class="inlineCode"><span class="koboSpan" id="kobo.224.1">RoutesPlanningDBDriver</span></code><span class="koboSpan" id="kobo.225.1">. </span><span class="koboSpan" id="kobo.225.2">Add references to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.226.1">Microsoft.EntityFrameworkCore.SqlServer</span></code><span class="koboSpan" id="kobo.227.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.228.1">Microsoft.EntityFrameworkCore.Tools</span></code><span class="koboSpan" id="kobo.229.1"> Nuget packages, and to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.230.1">RoutesPlanningDomainLayer</span></code><span class="koboSpan" id="kobo.231.1"> project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.232.1">After that, delete the </span><strong class="screenText"><span class="koboSpan" id="kobo.233.1">Class1.cs</span></strong><span class="koboSpan" id="kobo.234.1"> file and replace it with all code files and folders from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.235.1">DBDriver</span></code><span class="koboSpan" id="kobo.236.1"> project of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.237.1">ch03</span></code><span class="koboSpan" id="kobo.238.1"> project template.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.239.1">Finally, add a reference to </span><code class="inlineCode"><span class="koboSpan" id="kobo.240.1">RoutesPlanningDBDriver</span></code><span class="koboSpan" id="kobo.241.1"> in </span><code class="inlineCode"><span class="koboSpan" id="kobo.242.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.243.1">, and add the following code snippet to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.244.1">RoutesPlanning</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.245.1">Program.cs</span></code><span class="koboSpan" id="kobo.246.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.247.1">builder.Services.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.248.1">AddOpenApi</span></span><span class="koboSpan" id="kobo.249.1">();
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.250.1">//Code snippet start</span></span><span class="koboSpan" id="kobo.251.1">
builder.Services.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.252.1">AddApplicationServices</span></span><span class="koboSpan" id="kobo.253.1">();
builder.Services.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.254.1">AddDbDriver</span></span><span class="koboSpan" id="kobo.255.1">(
    builder.Configuration?.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.256.1">GetConnectionString</span></span><span class="koboSpan" id="kobo.257.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.258.1">"DefaultConnection"</span></span><span class="koboSpan" id="kobo.259.1">) ?? </span><span class="koboSpan" id="kobo.259.2">string.Empty);
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.260.1">//Code snippet end</span></span>
</code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.261.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.262.1"> needs a reference to </span><code class="inlineCode"><span class="koboSpan" id="kobo.263.1">RoutesPlanningDBDriver</span></code><span class="koboSpan" id="kobo.264.1"> because the outermost layer of an Onion Architecture must reference all implementation-specific drivers. </span><code class="inlineCode"><span class="koboSpan" id="kobo.265.1">AddApplicationServices</span></code><span class="koboSpan" id="kobo.266.1"> adds all queries, commands, and event handlers to the dependency injection engine, while </span><code class="inlineCode"><span class="koboSpan" id="kobo.267.1">AddDbDtiver</span></code><span class="koboSpan" id="kobo.268.1"> adds all repository implementations and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.269.1">IUnitOfWork</span></code><span class="koboSpan" id="kobo.270.1"> implementation to the dependency injection.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.271.1">For more information on the Onion Architecture project template that we used to prepare our solution, please refer to the </span><em class="italic"><span class="koboSpan" id="kobo.272.1">A solution template based on the Onion Architecture </span></em><span class="koboSpan" id="kobo.273.1">section of</span><em class="italic"> </em><a href="Chapter_3.xhtml#_idTextAnchor067"><em class="italic"><span class="koboSpan" id="kobo.274.1">Chapter 3</span></em></a><span class="koboSpan" id="kobo.275.1">, </span><em class="italic"><span class="koboSpan" id="kobo.276.1">Setup and Theory: Docker and Onion Architecture</span></em><span class="koboSpan" id="kobo.277.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.278.1">Now, our solution is finally ready! </span><span class="koboSpan" id="kobo.278.2">We can start designing our worker microservice!</span></p>
<h1 class="heading-1" id="_idParaDest-120"><a id="_idTextAnchor162"/><span class="koboSpan" id="kobo.279.1">Microservice basic design </span></h1>
<p class="normal"><span class="koboSpan" id="kobo.280.1">In this section, we will define all the main microservice abstractions, that is, the overall communication strategy, all Onion Architecture commands and events, and the top-level loops of the required hosted services. </span><span class="koboSpan" id="kobo.280.2">We will start with a description of the chosen message broker: </span><strong class="keyWord"><span class="koboSpan" id="kobo.281.1">RabbitMQ</span></strong><span class="koboSpan" id="kobo.282.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-121"><a id="_idTextAnchor163"/><span class="koboSpan" id="kobo.283.1">The message broker: RabbitMQ</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.284.1">Natively, RabbitMQ </span><a id="_idIndexMarker361"/><span class="koboSpan" id="kobo.285.1">supports the </span><strong class="keyWord"><span class="koboSpan" id="kobo.286.1">AMQP</span></strong><span class="koboSpan" id="kobo.287.1"> asynchronous message protocol, which is one of the most used asynchronous protocols, the other being </span><strong class="keyWord"><span class="koboSpan" id="kobo.288.1">MQTT</span></strong><span class="koboSpan" id="kobo.289.1">, which has a specific syntax </span><a id="_idIndexMarker362"/><span class="koboSpan" id="kobo.290.1">for the publisher/subscriber pattern. </span><span class="koboSpan" id="kobo.290.2">Support for </span><strong class="keyWord"><span class="koboSpan" id="kobo.291.1">MQTT</span></strong><span class="koboSpan" id="kobo.292.1"> can be added with a plugin, but RabbitMQ has facilities for easily implementing a publisher/subscriber pattern on top of </span><strong class="keyWord"><span class="koboSpan" id="kobo.293.1">AMQP</span></strong><span class="koboSpan" id="kobo.294.1">. </span><span class="koboSpan" id="kobo.294.2">Moreover, RabbitMQ offers several tools to support scalability, disaster recovery, and redundancy, so it fulfills all requirements to be a first-class actor in cloud and microservices environments. </span><span class="koboSpan" id="kobo.294.3">More specifically, by defining a RabbitMQ cluster, we may achieve both load balancing and data replication which is required in most SQL and NoSQL databases. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.295.1">In this section, we will just describe RabbitMQ’s basic operation, while the installation and usage of RabbitMQ clusters in Kubernetes will be discussed in </span><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.296.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.297.1">, </span><em class="italic"><span class="koboSpan" id="kobo.298.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.299.1">. </span><span class="koboSpan" id="kobo.299.2">You can find more details in the tutorials and documentation </span><a id="_idIndexMarker363"/><span class="koboSpan" id="kobo.300.1">on the RabbitMQ official website: </span><a href="https://www.rabbitmq.com/"><span class="url"><span class="koboSpan" id="kobo.301.1">https://www.rabbitmq.com/</span></span></a><span class="koboSpan" id="kobo.302.1">. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.303.1">RabbitMQ messages must be prepared in binary format, since RabbitMQ messages must be just an array of bytes. </span><span class="koboSpan" id="kobo.303.2">However,</span><a id="_idTextAnchor164"/><span class="koboSpan" id="kobo.304.1"> we will use the </span><strong class="keyWord"><span class="koboSpan" id="kobo.305.1">EasyNetQ</span></strong><span class="koboSpan" id="kobo.306.1"> client, which takes care of object serialization and of most </span><a id="_idIndexMarker364"/><span class="koboSpan" id="kobo.307.1">of the client-server wiring and error recovery. </span><strong class="keyWord"><span class="koboSpan" id="kobo.308.1">EasyNetQ</span></strong><span class="koboSpan" id="kobo.309.1"> is a NuGet </span><a id="_idIndexMarker365"/><span class="koboSpan" id="kobo.310.1">package built on top of RabbitMQ’s low-level </span><strong class="keyWord"><span class="koboSpan" id="kobo.311.1">RabbitMQ.Client</span></strong><span class="koboSpan" id="kobo.312.1"> NuGet client, which makes the usage of RabbitMQ easy while reducing the communication-code overhead and enhancing its modularity and modifiability.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.313.1">Once sent to RabbitMQ, messages are placed in </span><strong class="keyWord"><span class="koboSpan" id="kobo.314.1">queues</span></strong><span class="koboSpan" id="kobo.315.1">. </span><span class="koboSpan" id="kobo.315.2">More specifically, they are placed in one or more </span><strong class="keyWord"><span class="koboSpan" id="kobo.316.1">queues </span></strong><span class="koboSpan" id="kobo.317.1">by passing </span><a id="_idIndexMarker366"/><span class="koboSpan" id="kobo.318.1">through other entities, called </span><strong class="keyWord"><span class="koboSpan" id="kobo.319.1">exchanges</span></strong><span class="koboSpan" id="kobo.320.1">. </span><span class="koboSpan" id="kobo.320.2">The exchanges route the messages to </span><strong class="keyWord"><span class="koboSpan" id="kobo.321.1">queues</span></strong><span class="koboSpan" id="kobo.322.1"> using a routing strategy that depends on the </span><strong class="keyWord"><span class="koboSpan" id="kobo.323.1">exchange</span></strong><span class="koboSpan" id="kobo.324.1"> type. </span><span class="koboSpan" id="kobo.324.2">Exchanges are an </span><strong class="keyWord"><span class="koboSpan" id="kobo.325.1">AMQP</span></strong><span class="koboSpan" id="kobo.326.1">-specific concept, and they are the RabbitMQ way to configure complex communication protocols like the publishing/subscriber protocol, as shown in the following figure: </span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.327.1"><img alt="Figure 7.3: RabbitMQ exchanges" src="../Images/B31916_07_3.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.328.1">Figure 7.3: RabbitMQ exchanges</span></p>
<p class="normal"><span class="koboSpan" id="kobo.329.1">By adequately </span><a id="_idIndexMarker367"/><span class="koboSpan" id="kobo.330.1">defining the exchange routing strategy, we can </span><a id="_idIndexMarker368"/><span class="koboSpan" id="kobo.331.1">implement several patterns. </span><span class="koboSpan" id="kobo.331.2">More specifically, the following apply:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.332.1">When we use a </span><strong class="keyWord"><span class="koboSpan" id="kobo.333.1">default exchange</span></strong><span class="koboSpan" id="kobo.334.1">, the message is sent to a single queue and we can implement asynchronous direct calls.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.335.1">When we use a </span><strong class="keyWord"><span class="koboSpan" id="kobo.336.1">fanout exchange</span></strong><span class="koboSpan" id="kobo.337.1">, the exchange will send the messages to all queues that subscribe to that exchange. </span><span class="koboSpan" id="kobo.337.2">This way, we can implement the publisher/subscriber pattern. </span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.338.1">There is also a </span><strong class="keyWord"><span class="koboSpan" id="kobo.339.1">topic exchange</span></strong><span class="koboSpan" id="kobo.340.1">, which enhances the publisher/subscriber pattern by enabling the matching of named event subclasses called topics. </span><span class="koboSpan" id="kobo.340.2">Matching between receivers and topics also supports wildcard chars. </span><span class="koboSpan" id="kobo.340.3">We will describe its practical usage with enterprise microservices in the </span><em class="italic"><span class="koboSpan" id="kobo.341.1">Ensuring that messages are processed in the proper order</span></em><span class="koboSpan" id="kobo.342.1"> subsection.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.343.1">Whenever several receivers are attached to the same queue, messages are equally distributed among them according to a round-robin pattern. </span><span class="koboSpan" id="kobo.343.2">This is the case of </span><em class="italic"><span class="koboSpan" id="kobo.344.1">N</span></em><span class="koboSpan" id="kobo.345.1"> identical replicas of the same microservice. </span><span class="koboSpan" id="kobo.345.2">Therefore, replicas are automatically load-balanced by RabbitMQ.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.346.1">Luckily, </span><strong class="keyWord"><span class="koboSpan" id="kobo.347.1">EasyNetQ</span></strong><span class="koboSpan" id="kobo.348.1"> directly exposes the publish/subscribe protocol (possibly enriched with topics) and the direct call protocol, together with a request/response asynchronous RPC protocol, taking care of creating and connecting all needed queues and exchanges. </span><span class="koboSpan" id="kobo.348.2">Details on how to use </span><strong class="keyWord"><span class="koboSpan" id="kobo.349.1">EasyNetQ</span></strong><span class="koboSpan" id="kobo.350.1"> will be </span><a id="_idIndexMarker369"/><span class="koboSpan" id="kobo.351.1">provided when describing the code of our route-planning microservice.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.352.1">The easiest way to install RabbitMQ is by using its Docker image. </span><span class="koboSpan" id="kobo.352.2">We will adopt this option since all our microservices will also be containerized, and since in the final Kubernetes version of the overall application, we will use containerized RabbitMQ clusters.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.353.1">We can just run the following command in a Linux shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.354.1">docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:4.0-management
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.355.1">Since we </span><a id="_idIndexMarker370"/><span class="koboSpan" id="kobo.356.1">provided the </span><code class="inlineCode"><span class="koboSpan" id="kobo.357.1">-it</span></code><span class="koboSpan" id="kobo.358.1"> flags, after the image is downloaded and the container is </span><a id="_idIndexMarker371"/><span class="koboSpan" id="kobo.359.1">created and started, the Linux shell remains blocked in the container filesystem. </span><span class="koboSpan" id="kobo.359.2">Moreover, since we also added the </span><code class="inlineCode"><span class="koboSpan" id="kobo.360.1">–-rm</span></code><span class="koboSpan" id="kobo.361.1"> option, the container is destroyed as soon as it is stopped with the following line:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.362.1">docker stop rabbitmq
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.363.1">In order to verify that RabbitMQ is working properly, please navigate to </span><a href="http://localhost:15672"><span class="url"><span class="koboSpan" id="kobo.364.1">http://localhost:15672</span></span></a><span class="koboSpan" id="kobo.365.1">. </span><span class="koboSpan" id="kobo.365.2">The RabbitMQ management console should appear. </span><span class="koboSpan" id="kobo.365.3">You can log in with the startup credentials, which are </span><code class="inlineCode"><span class="koboSpan" id="kobo.366.1">guest</span></code><strong class="screenText"> </strong><span class="koboSpan" id="kobo.367.1">for both the username and password.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.368.1">You don’t need to leave the container running; you can stop it and re-execute the </span><code class="inlineCode"><span class="koboSpan" id="kobo.369.1">run</span></code><span class="koboSpan" id="kobo.370.1"> command when you need RabbitMQ to test the microservice code.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.371.1">The disk space needed by RabbitMQ is mounted as a Docker volume with the following volume statement directly inserted in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.372.1">Dockerfile</span></code><span class="koboSpan" id="kobo.373.1"> image:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.374.1">VOLUME /var/lib/rabbitmq
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.375.1">This means that the disk content is reset when the container is destroyed and run again. </span><span class="koboSpan" id="kobo.375.2">Therefore, if you want to keep the disk content, avoid running the container with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.376.1">–-rm</span></code><span class="koboSpan" id="kobo.377.1"> option, so it will not be destroyed when it is stopped.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.378.1">If you need customized credentials, please add the following environment variables to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.379.1">run</span></code><span class="koboSpan" id="kobo.380.1"> command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.381.1">-e RABBITMQ_DEFAULT_USER=my_user_name -e RABBITMQ_DEFAULT_PASS=my_password
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.382.1">This is necessary when RabbitMQ is accessed outside of </span><code class="inlineCode"><span class="koboSpan" id="kobo.383.1">localhost</span></code><span class="koboSpan" id="kobo.384.1">, because in this case, the default username and password are not accepted for security reasons.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.385.1">Now, we can move on to designing the input and output messages of our worker microservices.</span></p>
<h2 class="heading-2" id="_idParaDest-122"><a id="_idTextAnchor165"/><span class="koboSpan" id="kobo.386.1">Input communication</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.387.1">Since classes that represent intra-microservices messages must be known to both clients and servers, the best </span><a id="_idIndexMarker372"/><span class="koboSpan" id="kobo.388.1">option is defining them during the initial microservices external interfaces design and placing them in one or more shared libraries. </span><span class="koboSpan" id="kobo.388.2">Since our </span><a id="_idIndexMarker373"/><span class="koboSpan" id="kobo.389.1">project contains a reasonably small number of microservices, we may assume that all messages are visible to all microservices, so we can use a single shared library.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.390.1">However, in more complex scenarios containing hundreds or thousands of microservices, their organization must be hierarchical, so we will have level 0 messages, known to all microservices; level 1 messages, known just within level 1 groups of microservices, and so on.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.391.1">Let’s add a new </span><strong class="screenText"><span class="koboSpan" id="kobo.392.1">Class Library</span></strong><span class="koboSpan" id="kobo.393.1"> project called </span><code class="inlineCode"><span class="koboSpan" id="kobo.394.1">SharedMessages</span></code><span class="koboSpan" id="kobo.395.1"> to our solution, and we’ll select </span><strong class="screenText"><span class="koboSpan" id="kobo.396.1">standard 2.1</span></strong><span class="koboSpan" id="kobo.397.1"> for its version. </span><span class="koboSpan" id="kobo.397.2">Then, let’s add a reference to this new project to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.398.1">RoutesPlanningApplicationServices</span></code><span class="koboSpan" id="kobo.399.1"> project. </span><span class="koboSpan" id="kobo.399.2">We will place all application messages here.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.400.1">From the specifications of the route-planning microservice, we have just four messages:</span></p>
<ol>
<li class="numberedList" value="1"><strong class="keyWord"><span class="koboSpan" id="kobo.401.1">New</span><a id="_idTextAnchor166"/><span class="koboSpan" id="kobo.402.1"> request</span></strong><span class="koboSpan" id="kobo.403.1">: It will contain a unique request identifier, an interval of acceptable travel dates, and two unique identifiers for the start and arrival towns, their display names, and their latitude and longitude. </span><span class="koboSpan" id="kobo.403.2">Moreover, it will contain a unique identifier representing the user that issued the request and their display name.</span></li>
<li class="numberedList"><strong class="keyWord"><span class="koboSpan" id="kobo.404.1">New route</span></strong><span class="koboSpan" id="kobo.405.1">: It will contain a unique route identifier, a travel date, and two unique identifiers representing the start and arrival towns, their display names, and their latitude and longitude. </span><span class="koboSpan" id="kobo.405.2">Moreover, it will contain a unique identifier representing the car owner that issued the route proposa</span><a id="_idTextAnchor167"/><span class="koboSpan" id="kobo.406.1">l and their display name.</span></li>
<li class="numberedList"><strong class="keyWord"><span class="koboSpan" id="kobo.407.1">Route closed/aborted</span></strong><span class="koboSpan" id="kobo.408.1">: It will contain just the unique route identifier and a flag specifying whether the route was succes</span><a id="_idTextAnchor168"/><span class="koboSpan" id="kobo.409.1">sfully closed or aborted.</span></li>
<li class="numberedList"><strong class="keyWord"><span class="koboSpan" id="kobo.410.1">Route extension</span></strong><span class="koboSpan" id="kobo.411.1">: It informs that the car owner accepted extending the route with the start and ending towns of other requests. </span><span class="koboSpan" id="kobo.411.2">It contains the same information contained in the new route message as well as new request messages.</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.412.1">It also contains a flag that specifies whether, after the extension, the route has been closed to other participants.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.413.1">The message content might appear redundant for the route-planning microservice. </span><span class="koboSpan" id="kobo.413.2">For instance, most of the information contained in the route extension message is already known to the route-planning microservice. </span><span class="koboSpan" id="kobo.413.3">As a matter of fact, the route-planning microservice needs just the unique identifiers of the request and route to join. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.414.1">However, messages sent with the publisher/subscriber pattern are used by several potentially unknown subscribers, so they can’t assume specific a priori knowledge of the subscribers. </span><span class="koboSpan" id="kobo.414.2">For instance, the route extension message will also be subscribed by the microservice that handles all requests that don’t contain information about all existing route proposals, so all information needed </span><a id="_idIndexMarker374"/><span class="koboSpan" id="kobo.415.1">on the merged route must be received through this message. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.416.1">On the contrary, the route </span><a id="_idIndexMarker375"/><span class="koboSpan" id="kobo.417.1">closed/aborted message doesn’t need to convey the whole route information, since any service interested in the event must already know of this route and must already have all the data it needs about it. </span><span class="koboSpan" id="kobo.417.2">It might lack this data if it has never interacted with this route, but in this case, the event represented by the message can’t modify its state and must simply be ignored.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.418.1">An important question we must always ask about all microservices input is: what happens if the messages arrive in the wrong order, that is, in a different order than they were sent? </span><span class="koboSpan" id="kobo.418.2">If the message order matters, we either ensure that all messages arrive and are processed in the right order or we reorder messages with the technique explained in the </span><em class="italic"><span class="koboSpan" id="kobo.419.1">Efficacious handling of asynchronous communication </span></em><span class="koboSpan" id="kobo.420.1">subsection of </span><a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic"><span class="koboSpan" id="kobo.421.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.422.1">, </span><em class="italic"><span class="koboSpan" id="kobo.423.1">Demystifying Microservices Applications</span></em><span class="koboSpan" id="kobo.424.1">. </span><span class="koboSpan" id="kobo.424.2">Unfortunately, reordering input messages is not enough; we must also process them in the right order. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.425.1">This is not a trivial task if several replicas of the same microservice process these input messages concurrently. </span><span class="koboSpan" id="kobo.425.2">Luckily, no application needs a fixed ordering for all input messages. </span><span class="koboSpan" id="kobo.425.3">But some </span><em class="italic"><span class="koboSpan" id="kobo.426.1">related messages</span></em><span class="koboSpan" id="kobo.427.1">, for instance, all messages that contain the same route, must be processed in the right order. </span><span class="koboSpan" id="kobo.427.2">Therefore, we can avoid </span><em class="italic"><span class="koboSpan" id="kobo.428.1">just</span></em><span class="koboSpan" id="kobo.429.1"> concurrent processing of </span><em class="italic"><span class="koboSpan" id="kobo.430.1">related messages</span></em><span class="koboSpan" id="kobo.431.1"> by passing all related messages to the same replica. </span><span class="koboSpan" id="kobo.431.2">We will analyze techniques for achieving a similar load-balancing strategy of all replicas in the </span><em class="italic"><span class="koboSpan" id="kobo.432.1">Ensuring that messages are processed in the proper order</span></em><span class="koboSpan" id="kobo.433.1"> section.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.434.1">In our case, the order in which new route offers and route requests arrive is not an issue, since we can correctly process out-of-order messages with simple tricks. </span><span class="koboSpan" id="kobo.434.2">We just need to add an update version number to detect past updates. </span><span class="koboSpan" id="kobo.434.3">Update version numbers must be unique and must correspond to the real order in which updates were applied to a given entity. </span><span class="koboSpan" id="kobo.434.4">When the entity is created, it starts with version 0, and then this number is incremented at each new update.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.435.1">As a general rule, if all modification and creation messages contain the entire entity data, and if all deletes are logical, that is, entities are just marked as deleted, then messages don’t need to be ordered. </span></p>
</div>
<p class="normal"> </p>
<p class="normal"><span class="koboSpan" id="kobo.436.1">In fact, we can recognize and apply an incoming modification only if it is more recent than the one already applied. </span><span class="koboSpan" id="kobo.436.2">Moreover, we can always verify whether the entity mentioned in a modification message has already been deleted and discard the modification. </span><span class="koboSpan" id="kobo.436.3">Finally, if an entity mentioned in a modification has not already been created, we can always create it with the data contained in the modification message, since each modification contains the entire entity data. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.437.1">In our case, the order of the route extension messages doesn’t matter, because request merged to a route </span><a id="_idIndexMarker376"/><span class="koboSpan" id="kobo.438.1">simply sum up and it is enough to </span><a id="_idIndexMarker377"/><span class="koboSpan" id="kobo.439.1">select the more recent list of towns of the one stored in the route and the one contained in the message.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.440.1">Inversions of route extensions and route closed/aborted messages do not cause problems, too, since it is enough to ignore extensions of aborted routes, and to merge previous requests that arrived after the closure. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.441.1">Inversions of route creations and extensions can never take place, since only successfully created routes can cause request-route matches that can subsequently cause route extensions.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.442.1">Deleted routes do not cause problems since both route aborted and closed messages are de facto logical deletes. </span><span class="koboSpan" id="kobo.442.2">We can delete them after the travel day has expired by </span><em class="italic"><span class="koboSpan" id="kobo.443.1">N</span></em><span class="koboSpan" id="kobo.444.1"> days, since at that point, previous delayed messages can’t arrive (messages can be delayed by some hours or even a day in the case of severe failures). </span><span class="koboSpan" id="kobo.444.2">This can be done with cron jobs.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.445.1">Possible duplication of messages due to timeouts and resends also do not cause problems since they can always be recognized and ignored. </span><span class="koboSpan" id="kobo.445.2">As an exercise, you can analyze all possibilities in detail.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.446.1">All required messages can be easily defined in terms of some basic types that we will place in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.447.1">BasicTypes</span></code><span class="koboSpan" id="kobo.448.1"> folder of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.449.1">SharedMessages</span></code><span class="koboSpan" id="kobo.450.1"> project. </span><span class="koboSpan" id="kobo.450.2">They are as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.451.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.452.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.453.1">GeoLocalizationMessage</span></span><span class="koboSpan" id="kobo.454.1">
{
    public double </span><span class="hljs-title"><span class="koboSpan" id="kobo.455.1">Latitude</span></span><span class="koboSpan" id="kobo.456.1"> { get; set; }
    public double </span><span class="hljs-title"><span class="koboSpan" id="kobo.457.1">Longitude</span></span><span class="koboSpan" id="kobo.458.1"> { get; set; }
}
public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.459.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.460.1">TimeIntervalMessage</span></span><span class="koboSpan" id="kobo.461.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.462.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.463.1">Start</span></span><span class="koboSpan" id="kobo.464.1"> {  get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.465.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.466.1">End</span></span><span class="koboSpan" id="kobo.467.1"> { get; set; }
}
public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.468.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.469.1">UserBasicInfoMessage</span></span><span class="koboSpan" id="kobo.470.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.471.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.472.1">Id</span></span><span class="koboSpan" id="kobo.473.1"> { get; set; }
    public string? </span><span class="hljs-title"><span class="koboSpan" id="kobo.474.1">DisplayName</span></span><span class="koboSpan" id="kobo.475.1"> { get; set; }
}
public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.476.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.477.1">TownBasicInfoMessage</span></span><span class="koboSpan" id="kobo.478.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.479.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.480.1">Id</span></span><span class="koboSpan" id="kobo.481.1"> { get; set; }
    public string? </span><span class="hljs-title"><span class="koboSpan" id="kobo.482.1">Name</span></span><span class="koboSpan" id="kobo.483.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.484.1">GeoLocalizationMessage</span></span><span class="koboSpan" id="kobo.485.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.486.1">Location</span></span><span class="koboSpan" id="kobo.487.1"> { get; set; }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.488.1">Moreover, since all </span><a id="_idIndexMarker378"/><span class="koboSpan" id="kobo.489.1">messages must contain an update time, we may let all </span><a id="_idIndexMarker379"/><span class="koboSpan" id="kobo.490.1">of them inherit from the following class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.491.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.492.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.493.1">TimedMessage</span></span><span class="koboSpan" id="kobo.494.1">
{
    public long </span><span class="hljs-title"><span class="koboSpan" id="kobo.495.1">TimeStamp</span></span><span class="koboSpan" id="kobo.496.1"> { get; set; }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.497.1">Let’s place this class in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.498.1">BasicTypes</span></code><span class="koboSpan" id="kobo.499.1"> folder, too. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.500.1">Now, all messages can be defined as follows: </span></p>
<ol>
<li class="numberedList" value="1"><strong class="keyWord"><span class="koboSpan" id="kobo.501.1">New request</span></strong><span class="koboSpan" id="kobo.502.1">:
        </span><pre class="programlisting code-one"><code class="hljs-code"><span class="koboSpan" id="kobo.503.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.504.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.505.1">RouteRequestMessage</span></span><span class="koboSpan" id="kobo.506.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.507.1">TimedMessage</span></span><span class="koboSpan" id="kobo.508.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.509.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.510.1">Id</span></span><span class="koboSpan" id="kobo.511.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.512.1">TownBasicInfoMessage</span></span><span class="koboSpan" id="kobo.513.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.514.1">Source</span></span><span class="koboSpan" id="kobo.515.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.516.1">TownBasicInfoMessage</span></span><span class="koboSpan" id="kobo.517.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.518.1">Destination</span></span><span class="koboSpan" id="kobo.519.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.520.1">TimeIntervalMessage</span></span><span class="koboSpan" id="kobo.521.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.522.1">When</span></span><span class="koboSpan" id="kobo.523.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.524.1">UserBasicInfoMessage</span></span><span class="koboSpan" id="kobo.525.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.526.1">User</span></span><span class="koboSpan" id="kobo.527.1"> { get; set; }
}
</span></code></pre>
</li>
<li class="numberedList"><strong class="keyWord"><span class="koboSpan" id="kobo.528.1">New route</span></strong><span class="koboSpan" id="kobo.529.1">:
        </span><pre class="programlisting code-one"><code class="hljs-code"><span class="koboSpan" id="kobo.530.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.531.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.532.1">RouteOfferMessage</span></span><span class="koboSpan" id="kobo.533.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.534.1">TimedMessage</span></span><span class="koboSpan" id="kobo.535.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.536.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.537.1">Id</span></span><span class="koboSpan" id="kobo.538.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.539.1">IList</span></span><span class="koboSpan" id="kobo.540.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.541.1">TownBasicInfoMessage</span></span><span class="koboSpan" id="kobo.542.1">&gt;? </span><span class="hljs-title"><span class="koboSpan" id="kobo.543.1">Path</span></span><span class="koboSpan" id="kobo.544.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.545.1">DateTime</span></span><span class="koboSpan" id="kobo.546.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.547.1">When</span></span><span class="koboSpan" id="kobo.548.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.549.1">UserBasicInfoMessage</span></span><span class="koboSpan" id="kobo.550.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.551.1">User</span></span><span class="koboSpan" id="kobo.552.1"> { get; set; }
}
</span></code></pre>
</li>
<li class="numberedList"><strong class="keyWord"><span class="koboSpan" id="kobo.553.1">Route closed/aborted</span></strong><span class="koboSpan" id="kobo.554.1">:
        </span><pre class="programlisting code-one"><code class="hljs-code"><span class="koboSpan" id="kobo.555.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.556.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.557.1">RouteClosedAbortedMessage</span></span><span class="koboSpan" id="kobo.558.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.559.1">TimedMessage</span></span><span class="koboSpan" id="kobo.560.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.561.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.562.1">RouteId</span></span><span class="koboSpan" id="kobo.563.1"> { get; set; }
    public bool </span><span class="hljs-title"><span class="koboSpan" id="kobo.564.1">IsAborted</span></span><span class="koboSpan" id="kobo.565.1"> { get; set; }
}
</span></code></pre>
</li>
<li class="numberedList"><strong class="keyWord"><span class="koboSpan" id="kobo.566.1">Route extension</span></strong><span class="koboSpan" id="kobo.567.1">:
        </span><pre class="programlisting code-one"><code class="hljs-code"><span class="koboSpan" id="kobo.568.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.569.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.570.1">RouteExtendedMessage</span></span><span class="koboSpan" id="kobo.571.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.572.1">TimedMessage</span></span><span class="koboSpan" id="kobo.573.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.574.1">RouteOfferMessage</span></span><span class="koboSpan" id="kobo.575.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.576.1">ExtendedRoute</span></span><span class="koboSpan" id="kobo.577.1"> {  get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.578.1">IList</span></span><span class="koboSpan" id="kobo.579.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.580.1">RouteRequestMessage</span></span><span class="koboSpan" id="kobo.581.1">&gt;? </span><span class="hljs-title"><span class="koboSpan" id="kobo.582.1">AddedRequests</span></span><span class="koboSpan" id="kobo.583.1"> { get; set; }
    public bool </span><span class="hljs-title"><span class="koboSpan" id="kobo.584.1">Closed</span></span><span class="koboSpan" id="kobo.585.1"> { get; set; }
}
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.586.1">Place them </span><a id="_idIndexMarker380"/><span class="koboSpan" id="kobo.587.1">in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.588.1">SharedMessages</span></code><span class="koboSpan" id="kobo.589.1"> project folder </span><a id="_idIndexMarker381"/><span class="koboSpan" id="kobo.590.1">called </span><code class="inlineCode"><span class="koboSpan" id="kobo.591.1">RouteNegotiation</span></code><span class="koboSpan" id="kobo.592.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.593.1">We have just </span><a id="_idIndexMarker382"/><span class="koboSpan" id="kobo.594.1">finished with the microservice input design! </span><span class="koboSpan" id="kobo.594.2">Let’s move on to the output.</span></p>
<h2 class="heading-2" id="_idParaDest-123"><a id="_idTextAnchor169"/><span class="koboSpan" id="kobo.595.1">Output communication</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.596.1">The output of the route-planning microservice consists of proposals to augment routes with matching requests. </span><span class="koboSpan" id="kobo.596.2">These </span><a id="_idIndexMarker383"/><span class="koboSpan" id="kobo.597.1">proposals must be accepted by the users that </span><a id="_idIndexMarker384"/><span class="koboSpan" id="kobo.598.1">own the routes. </span><span class="koboSpan" id="kobo.598.2">A single route extension message contains the unique identifier of the route and all its newly discovered matching requests:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.599.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.600.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.601.1">RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.602.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.603.1">TimedMessage</span></span><span class="koboSpan" id="kobo.604.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.605.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.606.1">RouteId</span></span><span class="koboSpan" id="kobo.607.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.608.1">IList</span></span><span class="koboSpan" id="kobo.609.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.610.1">RouteRequestMessage</span></span><span class="koboSpan" id="kobo.611.1">&gt;? </span><span class="hljs-title"><span class="koboSpan" id="kobo.612.1">Proposals</span></span><span class="koboSpan" id="kobo.613.1"> { get; set; }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.614.1">Let’s place this class in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.615.1">RouteNegotiation</span></code><span class="koboSpan" id="kobo.616.1"> folder of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.617.1">SharedMessages</span></code><span class="koboSpan" id="kobo.618.1"> project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.619.1">Please notice that the timestamp associated with this message is the more recent timestamp associated with the route that this worker microservice received. </span><span class="koboSpan" id="kobo.619.2">In fact, this microservice doesn’t perform actual route updates, but just computes update proposals, which might be turned intoactual updates by another microservice. </span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.620.1">As a rule of thumb, all updates to an entity must be performed on a single database replica. </span><span class="koboSpan" id="kobo.620.2">This way, computing entity versions becomes a feasible task that requires just a simple database transaction. </span><span class="koboSpan" id="kobo.620.3">Otherwise, each update should be coordinated among </span><em class="italic"><span class="koboSpan" id="kobo.621.1">N</span></em><span class="koboSpan" id="kobo.622.1"> different microservices with a complex distributed transaction. </span><span class="koboSpan" id="kobo.622.2">Therefore, if several microservices have different views of the same conceptual entity in their databases, each of them can change the entity private data it uses without needing to version them. </span><span class="koboSpan" id="kobo.622.3">But there should be a single microservice that is in charge of updating all shared properties of the entity, versioning them, and sending them to all interested microservices.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.623.1">Unfortunately, sometimes distributed transactions are unavoidable, but still, in these cases, a single microservice replica proposes a new version number that is accepted by all microservices involved in the transaction if the transaction succeeds.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.624.1">Output messages </span><a id="_idIndexMarker385"/><span class="koboSpan" id="kobo.625.1">can be placed in an internal queue </span><a id="_idIndexMarker386"/><span class="koboSpan" id="kobo.626.1">implemented with permanent storage immediately after their creation, as explained in the </span><em class="italic"><span class="koboSpan" id="kobo.627.1">Efficacious handling of asynchronous communication</span></em><span class="koboSpan" id="kobo.628.1"> section of </span><a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic"><span class="koboSpan" id="kobo.629.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.630.1">, </span><em class="italic"><span class="koboSpan" id="kobo.631.1">Demystifying Microservices Applications</span></em><span class="koboSpan" id="kobo.632.1">. </span><span class="koboSpan" id="kobo.632.2">However, if we use a broker, that strategy needs to be modified a little bit. </span><span class="koboSpan" id="kobo.632.3">There, we applied an exponential retry strategy, by retrying the failed messages after an exponentially increasing time, while continuing to send other messages from the internal queue. </span><span class="koboSpan" id="kobo.632.4">When messages are not mediated by a message broker, this strategy makes sense, since the failure is connected either to the destination or to some component in the path between the source and destination. </span><span class="koboSpan" id="kobo.632.5">So, if the next message has a different destination, it would probably succeed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.633.1">If we use a message broker, the failure depends on the message broker itself since the confirmation simply states that the message broker successfully received the message, not that the message was received and confirmed by the destination. </span><span class="koboSpan" id="kobo.633.2">Therefore, immediately attempting a new message transmission would probably result in another failure. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.634.1">We may conclude that when communication is mediated by a message broker, we don’t need to delay the single faulty message; instead, we must stop sending messages to the message broker applying both exponential retry and circuit break strategies. </span><span class="koboSpan" id="kobo.634.2">Moreover, since keeping too many threads waiting for confirmations might congest the system, we must also apply a Bulkhead Isolation strategy to limit the number of pending tasks. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.635.1">At this point, you might ask: why do we need an internal queue if we already have the message broker external queue? </span><span class="koboSpan" id="kobo.635.2">There are two reasons; the first one, in particular, is quite compelling:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.636.1">The internal queue is implemented with a database table, so it is populated in the same database transaction as the database update that triggered the output event. </span><span class="koboSpan" id="kobo.636.2">Therefore, if something goes wrong, the whole transaction is aborted, thus giving the possibility to retry it at a later time. </span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.637.1">The performance cost for achieving the same result directly with the message broker queue is higher: we should keep the database transaction open until we receive a confirmation, an error, or a timeout from the message transmission to the message broker. </span><span class="koboSpan" id="kobo.637.2">This time becomes several orders of magnitude higher if we use exponential retry.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.638.1">Once the message is in the internal queue, in case of failures, we don’t need to undo the database update but we need simply to retry the message transmission at a later time.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.639.1">Due to the different </span><a id="_idIndexMarker387"/><span class="koboSpan" id="kobo.640.1">ways databases and message brokers are </span><a id="_idIndexMarker388"/><span class="koboSpan" id="kobo.641.1">implemented, and due to the fact that the database is shared just by the microservice replicas, the confirmation of the successful execution of the whole database transaction (required update plus registration of the output message in the internal queue) is faster than the message broker confirmation.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.642.1">Now that we have clarified how to handle both input and output messages, in general and for our route-planning microservice, we can discuss how to recover and maint</span><a id="_idTextAnchor170"/><span class="koboSpan" id="kobo.643.1">ain the proper message-processing order.</span></p>
<h2 class="heading-2" id="_idParaDest-124"><a id="_idTextAnchor171"/><span class="koboSpan" id="kobo.644.1">Ensuring that messages are processed in the proper order</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.645.1">As discussed in the previous subsections, our route-planning microservice doesn’t need to enforce the </span><a id="_idIndexMarker389"/><span class="koboSpan" id="kobo.646.1">correct message-processing order. </span><span class="koboSpan" id="kobo.646.2">However, there are cases where processing all messages in the right order is unavoidable, so in this </span><a id="_idIndexMarker390"/><span class="koboSpan" id="kobo.647.1">subsection, we will discuss how they are usually handled.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.648.1">It is worth pointing out that strategies for enforcing the right message-processing order have a non-negligible impact on performance and scalability, so any trick to avoid their usage is welcome.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.649.1">Usually, order constraints must be enforced just within the same group of related messages, so it is enough to ensure the following:</span></p>
<ol>
<li class="alphabeticList" value="1"><span class="koboSpan" id="kobo.650.1">All messages belonging to the same group of related messages are processed by the same microservice replica, so concurrence between replicas can’t shuffle the message-processing order.</span></li>
<li class="alphabeticList"><span class="koboSpan" id="kobo.651.1">Each replica processes a message only after all previous messages have been successfully processed. </span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.652.1">Proper operation of the preceding technique requires that each message contains its sequence number in its group.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.653.1">Often, groups coincide with database entities, or better, with database aggregates. </span><span class="koboSpan" id="kobo.653.2">That is, two messages belong to the same group if they represent different operations performed on the same entity. </span><span class="koboSpan" id="kobo.653.3">Thus, in the case of our route-planning service, we might have a group for each request and for each route. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.654.1">Now suppose that </span><a id="_idIndexMarker391"/><span class="koboSpan" id="kobo.655.1">that there are </span><em class="italic"><span class="koboSpan" id="kobo.656.1">N</span></em><span class="koboSpan" id="kobo.657.1"> microservice replicas, indexed by the integers from 1 to </span><em class="italic"><span class="koboSpan" id="kobo.658.1">N</span></em><span class="koboSpan" id="kobo.659.1">. </span><span class="koboSpan" id="kobo.659.2">We can define a hash function that, given a </span><a id="_idIndexMarker392"/><span class="koboSpan" id="kobo.660.1">group identifier, returns a number between 1 and </span><em class="italic"><span class="koboSpan" id="kobo.661.1">N</span></em><span class="koboSpan" id="kobo.662.1">. </span><span class="koboSpan" id="kobo.662.2">This way, if we route each message to the replica indexed by the result of the hash function applied to the group of the message, all messages in the same group will be processed by the same replica. </span><span class="koboSpan" id="kobo.662.3">The following figure exemplifies the message-routing strategy:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.663.1"><img alt="Figure 7.4: Message sharding" src="../Images/B31916_07_4.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.664.1">Figure 7.4: Message sharding</span></p>
<p class="normal"><span class="koboSpan" id="kobo.665.1">This technique </span><a id="_idIndexMarker393"/><span class="koboSpan" id="kobo.666.1">is called </span><strong class="keyWord"><span class="koboSpan" id="kobo.667.1">sharding</span></strong><span class="koboSpan" id="kobo.668.1">, and if the hash function is fair, each replica will receive the same </span><em class="italic"><span class="koboSpan" id="kobo.669.1">average</span></em><span class="koboSpan" id="kobo.670.1"> load. </span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.671.1">Thus, if we have no order constraints, we achieve exact load-balancing with a round-robin strategy, while with order constraints, we can just achieve </span><em class="italic"><span class="koboSpan" id="kobo.672.1">average</span></em><span class="koboSpan" id="kobo.673.1"> load-balancing with sharding. </span><span class="koboSpan" id="kobo.673.2">This means that probabilistic balancing fluctuations will for sure cause temporary congestion.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.674.1">Sharding will also cause a loss of flexibility in scaling the number of replicas. </span><span class="koboSpan" id="kobo.674.2">In fact, changing the number of replicas changes both the hash function and the group of messages received by each replica. </span><span class="koboSpan" id="kobo.674.3">For these reasons, scaling operations will have a higher cost and consequently can be performed less frequently. </span><span class="koboSpan" id="kobo.674.4">In practice, most orchestrators automatically scale non-indexed replicas according to customizable criteria, but don’t offer the same service for replicas that need to be indexed. </span><span class="koboSpan" id="kobo.674.5">We will analyze in more detail the difference between these different sets of replicas and automating scaling in </span><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.675.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.676.1">, </span><em class="italic"><span class="koboSpan" id="kobo.677.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.678.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.679.1">Sharding can be implemented with a single-replica microservice that receives all messages from the message broker and routes them to the appropriate replicas by sending them to a replica-specific </span><a id="_idIndexMarker394"/><span class="koboSpan" id="kobo.680.1">message broker queue. </span><span class="koboSpan" id="kobo.680.2">This technique is more complex and requires more coding, but it is more flexible. </span><span class="koboSpan" id="kobo.680.3">In fact, for instance, if it is </span><a id="_idIndexMarker395"/><span class="koboSpan" id="kobo.681.1">informed by changes in the number of replicas, it can dynamically adapt its behavior to the number of replicas.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.682.1">Sharding can also be achieved with RabbitMQ topics. </span><span class="koboSpan" id="kobo.682.2">Basically, a topic is a string attached to a message, and event subscribers can be enabled just for some topics. </span><span class="koboSpan" id="kobo.682.3">Therefore, if we attach the result of the hash function to each message as a topic, then each replica can subscribe just to the topic equal to its index, thus implementing sharding with no need for an extra component. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.683.1">The disadvantage of the topic-based sharding technique is that the number of replicas must be known to all senders and can be changed just by restarting the whole application. </span><span class="koboSpan" id="kobo.683.2">Moreover, since the topic to assign to each message depends on both how the destination microservice defines message groups and the destination microservice, the number of replicas technique can’t be used with the publisher/subscriber pattern where messages are received by several heterogeneous microservices.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.684.1">RabbitMQ </span><a id="_idIndexMarker396"/><span class="koboSpan" id="kobo.685.1">also has a sharding plugin (</span><a href="https://github.com/rabbitmq/rabbitmq-server/tree/main/deps/rabbitmq_sharding"><span class="url"><span class="koboSpan" id="kobo.686.1">https://github.com/rabbitmq/rabbitmq-server/tree/main/deps/rabbitmq_sharding</span></span></a><span class="koboSpan" id="kobo.687.1">) that computes a modulo </span><em class="italic"><span class="koboSpan" id="kobo.688.1">N</span></em><span class="koboSpan" id="kobo.689.1"> hash. </span><span class="koboSpan" id="kobo.689.2">This plugin defines a new type of exchange with a sharding-based routing strategy that we can attach immediately before each separate subscriber queue. </span><span class="koboSpan" id="kobo.689.3">Moreover, the plugin takes care of splitting the unique subscriber queue into </span><em class="italic"><span class="koboSpan" id="kobo.690.1">N</span></em><span class="koboSpan" id="kobo.691.1"> different sharded queues and distributing all subscribers among the </span><em class="italic"><span class="koboSpan" id="kobo.692.1">N</span></em><span class="koboSpan" id="kobo.693.1"> sharded queue</span><a id="_idTextAnchor172"/><span class="koboSpan" id="kobo.694.1">. </span><span class="koboSpan" id="kobo.694.2">This technique is completely analogous to the single-replica routing microservice technique, but being integrated inside the message broker requires trading reduced flexibility for better performance. </span><span class="koboSpan" id="kobo.694.3">This technique solves all the problems of the </span><a id="_idIndexMarker397"/><span class="koboSpan" id="kobo.695.1">topics-based technique but is not supported by the high-level </span><strong class="keyWord"><span class="koboSpan" id="kobo.696.1">EasyNetQ</span></strong><span class="koboSpan" id="kobo.697.1"> interface, so it increases the code complexity and maintainability. </span><span class="koboSpan" id="kobo.697.2">Moreover, it requires a broker configuration that depends on the exact topology of all subscribers, thus undermining the application’s extensibility.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.698.1">Summing up, when using publisher/subscriber communication, the best option is almost always the single-replica routing microservice technique.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.699.1">Having discussed microservices input and output, we can now move on to the design of the microservice container input parameters.</span></p>
<h2 class="heading-2" id="_idParaDest-125"><a id="_idTextAnchor173"/><span class="koboSpan" id="kobo.700.1">Designing Docker image environment parameters</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.701.1">As already hinted at in the </span><em class="italic"><span class="koboSpan" id="kobo.702.1">A few more Docker commands and options </span></em><span class="koboSpan" id="kobo.703.1">subsection of</span><em class="italic"> </em><a href="Chapter_3.xhtml#_idTextAnchor067"><em class="italic"><span class="koboSpan" id="kobo.704.1">Chapter 3</span></em></a><span class="koboSpan" id="kobo.705.1">, </span><em class="italic"><span class="koboSpan" id="kobo.706.1">Setup and Theory: Docker and Onion Architecture</span></em><span class="koboSpan" id="kobo.707.1">, containers usually adapt to their deployment </span><a id="_idIndexMarker398"/><span class="koboSpan" id="kobo.708.1">environment by being passed as environment variables of the container’s virtual filesystem. </span><span class="koboSpan" id="kobo.708.2">In a .NET environment, parameters </span><a id="_idIndexMarker399"/><span class="koboSpan" id="kobo.709.1">are available through the </span><code class="inlineCode"><span class="koboSpan" id="kobo.710.1">IConfiguration</span></code><span class="koboSpan" id="kobo.711.1"> interface together with all parameters defined in the .NET configuration files, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.712.1">appsettings.json</span></code><span class="koboSpan" id="kobo.713.1">. </span><span class="koboSpan" id="kobo.713.2">Nested JSON paths are represented in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.714.1">IConfiguration</span></code><span class="koboSpan" id="kobo.715.1"> dictionary arguments by separating all segments with colons, as is the case for </span><code class="inlineCode"><span class="koboSpan" id="kobo.716.1">IConfiguration[“ConnectionStrings:DefaultConnection”]</span></code><span class="koboSpan" id="kobo.717.1">, which represents the usual default database connection string. </span><span class="koboSpan" id="kobo.717.2">When nested paths are represented by environment variables, colons are replaced with double underscores, in order to get valid environment variables names. </span><span class="koboSpan" id="kobo.717.3">Therefore, </span><code class="inlineCode"><span class="koboSpan" id="kobo.718.1">ConnectionStrings:DefaultConnection</span></code><span class="koboSpan" id="kobo.719.1"> must be defined with an environment variable named </span><code class="inlineCode"><span class="koboSpan" id="kobo.720.1">ConnectionStrings__DefaultConnection</span></code><span class="koboSpan" id="kobo.721.1">. </span><span class="koboSpan" id="kobo.721.2">If environment variable names are prefixed with </span><code class="inlineCode"><span class="koboSpan" id="kobo.722.1">ASPNETCORE_</span></code><span class="koboSpan" id="kobo.723.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.724.1">DOTNET_</span></code><span class="koboSpan" id="kobo.725.1">, these prefixes are removed; therefore, </span><code class="inlineCode"><span class="koboSpan" id="kobo.726.1">ASPNETCORE_ENVIRONMENT</span></code><span class="koboSpan" id="kobo.727.1"> can be accessed with </span><code class="inlineCode"><span class="koboSpan" id="kobo.728.1">IConfiguration[“ENVIRONMENT”]</span></code><span class="koboSpan" id="kobo.729.1">. </span><span class="koboSpan" id="kobo.729.2">These prefixes are used to pass ASP.NET Core- and .NET-specific settings, such as staging, production, or development environment, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.730.1">ASPNETCORE_HTTP_PORTS</span></code><span class="koboSpan" id="kobo.731.1"> is also used, which contains a semicolon-separated list of all ports that Kestrel must listen on.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.732.1">You can also define your own custom prefix to apply to all your environment variables to avoid name collisions. </span><span class="koboSpan" id="kobo.732.2">However, since each microservice has a private container, collisions between environment variables used by different applications are impossible. </span><span class="koboSpan" id="kobo.732.3">Anyway, a new environment variable’s custom prefix can be defined inside the application services definition section with code analogous to the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.733.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.734.1">Configuration</span></span><span class="koboSpan" id="kobo.735.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.736.1">AddEnvironmentVariables</span></span><span class="koboSpan" id="kobo.737.1">(</span><span class="hljs-attr"><span class="koboSpan" id="kobo.738.1">prefix</span></span><span class="koboSpan" id="kobo.739.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.740.1">"MyCustomPrefix_"</span></span><span class="koboSpan" id="kobo.741.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.742.1">As we will see in </span><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.743.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.744.1">, </span><em class="italic"><span class="koboSpan" id="kobo.745.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.746.1">, defining configuration settings with environment variables allows the easy specification of their values in the code files for the chosen orchestrator.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.747.1">During development, environment variable values can be specified in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.748.1">Properties -&gt; launchSettings.json</span></code><span class="koboSpan" id="kobo.749.1"> file of the top-level project of the Onion Architecture, which, in our case, is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.750.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.751.1"> project. </span><span class="koboSpan" id="kobo.751.2">The following snippet shows where to place your environment variable values:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.752.1">"Container (Dockerfile)"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.753.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.754.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.755.1">"commandName"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.756.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.757.1">"Docker"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.758.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.759.1">"</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.760.1">launchUrl"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.761.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.762.1">"{Scheme}://{ServiceHost}:{ServicePort}"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.763.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.764.1">"environmentVariables"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.765.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.766.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.767.1">"ASPNETCORE_HTTP_PORTS"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.768.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.769.1">"8080"</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.770.1">//place here your application specific environment variables</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.771.1">},</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.772.1">In our case, we need the following:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.773.1">The database connection string</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.774.1">The RabbitMQ connection string.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.775.1">The maximum distance for proposing a match between a request and a route, and the maximum number of best matches to retrieve from the database.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.776.1">The subscription ID prefix for all our microservice replicas. </span><span class="koboSpan" id="kobo.776.2">This string is used as a prefix for all subscription queue names in our microservice replicas. </span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.777.1">You don’t </span><a id="_idIndexMarker400"/><span class="koboSpan" id="kobo.778.1">need to discover all the settings </span><a id="_idIndexMarker401"/><span class="koboSpan" id="kobo.779.1">you need at this stage, just the ones that play a fundamental role in your microservice. </span><span class="koboSpan" id="kobo.779.2">Further settings can be easily added at a later time. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.780.1">Therefore, let’s define all settings in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.781.1">launchSettings.json</span></code><span class="koboSpan" id="kobo.782.1"> file as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.783.1">"environmentVariables"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.784.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.785.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.786.1">"ASPNETCORE_HTTP_PORTS"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.787.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.788.1">"8080"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.789.1">,</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.790.1">//place here your environment variables</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.791.1">"ConnectionStrings__DefaultConnection"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.792.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.793.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.794.1">"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.795.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.796.1">"ConnectionStrings__RabbitMQConnection"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.797.1">:</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.798.1">"host=localhost:5672;username=guest;password=guest;publisherConfirms=true;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.799.1">timeout=10"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.800.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.801.1">"Messages__SubscriptionIdPrefix"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.802.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.803.1">"routesPlanning"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.804.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.805.1">"Topology__MaxDistanceKm"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.806.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.807.1">"50"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.808.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.809.1">"Topology__MaxMatches"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.810.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.811.1">"5"</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.812.1">},</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.813.1">We left the database connection string empty. </span><span class="koboSpan" id="kobo.813.2">We will fill it once we have defined the SQL Server development database. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.814.1">The RabbitMQ connection string contains the server URL and the default credential. </span><span class="koboSpan" id="kobo.814.2">Note that the </span><a id="_idIndexMarker402"/><span class="koboSpan" id="kobo.815.1">default credentials are accepted just </span><a id="_idIndexMarker403"/><span class="koboSpan" id="kobo.816.1">when RabbitMQ is accessed from </span><code class="inlineCode"><span class="koboSpan" id="kobo.817.1">localhost</span></code><span class="koboSpan" id="kobo.818.1">, so you are encouraged to change them once you have installed the server. </span><code class="inlineCode"><span class="koboSpan" id="kobo.819.1">publisherConfirms=true</span></code><span class="koboSpan" id="kobo.820.1"> informs RabbitMQ that it must confirm that the message was safely received, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.821.1">timeout=10</span></code><span class="koboSpan" id="kobo.822.1"> specifies the connection timeout in seconds.</span></p>
<h2 class="heading-2" id="_idParaDest-126"><a id="_idTextAnchor174"/><span class="koboSpan" id="kobo.823.1">The microservice main service</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.824.1">All modern .NET applications based </span><a id="_idIndexMarker404"/><span class="koboSpan" id="kobo.825.1">on a host allow the definition of the so-called </span><strong class="keyWord"><span class="koboSpan" id="kobo.826.1">hosted services</span></strong><span class="koboSpan" id="kobo.827.1">, which </span><a id="_idIndexMarker405"/><span class="koboSpan" id="kobo.828.1">are services similar to Windows services running for the entire application lifetime. </span><span class="koboSpan" id="kobo.828.2">They can be defined by </span><a id="_idIndexMarker406"/><span class="koboSpan" id="kobo.829.1">implementing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.830.1">IHostedService</span></code><span class="koboSpan" id="kobo.831.1"> interface and adding them to the services definition section of the application with the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.832.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.833.1">Services</span></span><span class="koboSpan" id="kobo.834.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.835.1">AddHostedService</span></span><span class="koboSpan" id="kobo.836.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.837.1">MyHostedService</span></span><span class="koboSpan" id="kobo.838.1">&gt;();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.839.1">In practice, hosted services are defined by inheriting from </span><code class="inlineCode"><span class="koboSpan" id="kobo.840.1">BackgroundService</span></code><span class="koboSpan" id="kobo.841.1">, which contains a partial implementation of the service and exposes a single </span><code class="inlineCode"><span class="koboSpan" id="kobo.842.1">ExecuteAsync</span></code><span class="koboSpan" id="kobo.843.1"> method that we must override.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.844.1">Our microservice needs three hosted services. </span><span class="koboSpan" id="kobo.844.2">The main one listens to all input messages arriving from the message broker and processes them. </span><span class="koboSpan" id="kobo.844.3">Another hosted service extracts messages from the output internal queue and sends them to the message broker. </span><span class="koboSpan" id="kobo.844.4">Finally, the third hosted service performs housekeeping jobs, such as deleting expired requests and routes.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.845.1">This subsection describes the main hosted service. </span><span class="koboSpan" id="kobo.845.2">The job of this hosted service is quite simple it listens for all four input messages we defined, and once it has received a message, it will create a command specific to that message and invoke the command handler associated with that command. </span><span class="koboSpan" id="kobo.845.3">Commands and command handlers are Onion Architecture building blocks that were discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.846.1">Commands </span></em><span class="koboSpan" id="kobo.847.1">subsection of</span><em class="italic"> </em><a href="Chapter_3.xhtml#_idTextAnchor067"><em class="italic"><span class="koboSpan" id="kobo.848.1">Chapter 3</span></em></a><span class="koboSpan" id="kobo.849.1">, </span><em class="italic"><span class="koboSpan" id="kobo.850.1">Setup and Theory: Docker and Onion Architecture</span></em><span class="koboSpan" id="kobo.851.1">. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.852.1">Let’s create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.853.1">HostedServices</span></code><span class="koboSpan" id="kobo.854.1"> folder in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.855.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.856.1"> project. </span><span class="koboSpan" id="kobo.856.2">Then, add a class named </span><code class="inlineCode"><span class="koboSpan" id="kobo.857.1">MainService</span></code><span class="koboSpan" id="kobo.858.1"> that inherits from </span><code class="inlineCode"><span class="koboSpan" id="kobo.859.1">BackgroundService</span></code><span class="koboSpan" id="kobo.860.1"> to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.861.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.862.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.863.1">MainService</span></span><span class="koboSpan" id="kobo.864.1">() : </span><span class="hljs-title"><span class="koboSpan" id="kobo.865.1">BackgroundService</span></span><span class="koboSpan" id="kobo.866.1">
{
    protected override </span><span class="hljs-title"><span class="koboSpan" id="kobo.867.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.868.1">ExecuteAsync</span></span><span class="koboSpan" id="kobo.869.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.870.1">CancellationToken</span></span><span class="koboSpan" id="kobo.871.1"> stoppingToken)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.872.1">throw</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.873.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.874.1">NotImplementedException</span></span><span class="koboSpan" id="kobo.875.1">();
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.876.1">The class name is followed by a couple of parentheses since it is the principal constructor where we will add parameters. </span><span class="koboSpan" id="kobo.876.2">In fact, all parameters of a hosted service constructor are automatically </span><a id="_idIndexMarker407"/><span class="koboSpan" id="kobo.877.1">taken from the dependency engine container, so we can put all services it needs to perform its job there: an </span><code class="inlineCode"><span class="koboSpan" id="kobo.878.1">IConfiguration</span></code><span class="koboSpan" id="kobo.879.1"> parameter, and an </span><code class="inlineCode"><span class="koboSpan" id="kobo.880.1">IServiceProvider</span></code><span class="koboSpan" id="kobo.881.1"> interface that we will use to get scoped services. </span><span class="koboSpan" id="kobo.881.2">In fact, command handlers are </span><a id="_idIndexMarker408"/><span class="koboSpan" id="kobo.882.1">scoped services, so we need to create a request scope before requiring them for the dependency injection container.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.883.1">Summing up our principal constructor, it looks as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.884.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.885.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.886.1">MainService</span></span><span class="koboSpan" id="kobo.887.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.888.1">IConfiguration</span></span><span class="koboSpan" id="kobo.889.1"> configuration, </span><span class="hljs-title"><span class="koboSpan" id="kobo.890.1">IServiceProvider</span></span><span class="koboSpan" id="kobo.891.1"> services) : </span><span class="hljs-title"><span class="koboSpan" id="kobo.892.1">BackgroundService</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.893.1">Before proceeding, let’s add this hosted service to the dependency injection container, so it will be immediately executed at the start of the program. </span><span class="koboSpan" id="kobo.893.2">We just need to add the following instruction to </span><code class="inlineCode"><span class="koboSpan" id="kobo.894.1">Program.cs</span></code><span class="koboSpan" id="kobo.895.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.896.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.897.1">Services</span></span><span class="koboSpan" id="kobo.898.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.899.1">AddHostedService</span></span><span class="koboSpan" id="kobo.900.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.901.1">MainService</span></span><span class="koboSpan" id="kobo.902.1">&gt;();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.903.1">In the case of the worker microservice, there is a one-to-one mapping between messages and commands, and all input needed by the command is contained in the message, so a unique generic command called </span><code class="inlineCode"><span class="koboSpan" id="kobo.904.1">MessageCommand&lt;T&gt;</span></code><span class="koboSpan" id="kobo.905.1"> suffices. </span><span class="koboSpan" id="kobo.905.2">Let’s define it in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.906.1">Commands</span></code><span class="koboSpan" id="kobo.907.1"> folder of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.908.1">RoutesPlanningApplicationServices</span></code><span class="koboSpan" id="kobo.909.1"> project:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.910.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.911.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.912.1">MessageCommand</span></span><span class="koboSpan" id="kobo.913.1">&lt;T&gt;(T message): </span><span class="hljs-title"><span class="koboSpan" id="kobo.914.1">ICommand</span></span><span class="koboSpan" id="kobo.915.1">
{
    public T </span><span class="hljs-title"><span class="koboSpan" id="kobo.916.1">Message</span></span><span class="koboSpan" id="kobo.917.1"> =&gt; message;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.918.1">Now, let’s define a method that given a message of type </span><code class="inlineCode"><span class="koboSpan" id="kobo.919.1">T</span></code><span class="koboSpan" id="kobo.920.1"> creates a scope, requires the appropriate command handler, and executes it: </span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.921.1">protected </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.922.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.923.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.924.1">ProcessMessage</span></span><span class="koboSpan" id="kobo.925.1">&lt;T&gt;(T message)
{
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.926.1">using</span></span><span class="koboSpan" id="kobo.927.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.928.1">var</span></span><span class="koboSpan" id="kobo.929.1"> scope = services.</span><span class="hljs-title"><span class="koboSpan" id="kobo.930.1">CreateScope</span></span><span class="koboSpan" id="kobo.931.1">()) 
    {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.932.1">var</span></span><span class="koboSpan" id="kobo.933.1"> handler=scope.</span><span class="hljs-property"><span class="koboSpan" id="kobo.934.1">ServiceProvider</span></span><span class="koboSpan" id="kobo.935.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.936.1">GetRequiredService</span></span><span class="koboSpan" id="kobo.937.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.938.1">ICommandHandler</span></span><span class="koboSpan" id="kobo.939.1">&lt;
                                                    </span><span class="hljs-title"><span class="koboSpan" id="kobo.940.1">MessageCommand</span></span><span class="koboSpan" id="kobo.941.1">&lt;T&gt;&gt;&gt;();
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.942.1">await</span></span><span class="koboSpan" id="kobo.943.1"> handler.</span><span class="hljs-title"><span class="koboSpan" id="kobo.944.1">HandleAsync</span></span><span class="koboSpan" id="kobo.945.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.946.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.947.1">MessageCommand</span></span><span class="koboSpan" id="kobo.948.1">&lt;T&gt;(message));
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.949.1">Errors, that is, exceptions thrown during a </span><code class="inlineCode"><span class="koboSpan" id="kobo.950.1">ProcessMessage&lt;T&gt;</span></code><span class="koboSpan" id="kobo.951.1"> execution, are handled by counting the number of consecutive errors and then rethrowing the exception. </span><span class="koboSpan" id="kobo.951.2">As we will see, rethrowing the </span><a id="_idIndexMarker409"/><span class="koboSpan" id="kobo.952.1">exception basically undoes the </span><a id="_idIndexMarker410"/><span class="koboSpan" id="kobo.953.1">extraction of the messages from the message broker queue so it can be processed again. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.954.1">Error counting can be performed with a thread-safe critical region, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.955.1">private readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.956.1">Lock</span></span><span class="koboSpan" id="kobo.957.1"> _countErrorsLock = </span><span class="hljs-title"><span class="koboSpan" id="kobo.958.1">new</span></span><span class="koboSpan" id="kobo.959.1">();
private </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.960.1">static</span></span><span class="koboSpan" id="kobo.961.1"> int _errorCount = </span><span class="hljs-number"><span class="koboSpan" id="kobo.962.1">0</span></span><span class="koboSpan" id="kobo.963.1">;
public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.964.1">static</span></span><span class="koboSpan" id="kobo.965.1"> int </span><span class="hljs-title"><span class="koboSpan" id="kobo.966.1">ErrorsCount</span></span><span class="koboSpan" id="kobo.967.1"> =&gt; _errorCount;
private </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.968.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.969.1">DeclareSuccessFailure</span></span><span class="koboSpan" id="kobo.970.1">(bool isFailure=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.971.1">false</span></span><span class="koboSpan" id="kobo.972.1">)
{
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.973.1">using</span></span><span class="koboSpan" id="kobo.974.1"> (_countErrorsLock.</span><span class="hljs-title"><span class="koboSpan" id="kobo.975.1">EnterScope</span></span><span class="koboSpan" id="kobo.976.1">())
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.977.1">if</span></span><span class="koboSpan" id="kobo.978.1"> (isFailure) _errorCount++;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.979.1">else</span></span><span class="koboSpan" id="kobo.980.1"> _errorCount = </span><span class="hljs-number"><span class="koboSpan" id="kobo.981.1">0</span></span><span class="koboSpan" id="kobo.982.1">;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.983.1">Consecutive error counts can be used to define the microservice health state. </span><span class="koboSpan" id="kobo.983.2">Now, we can define an error-protected wrapper of </span><code class="inlineCode"><span class="koboSpan" id="kobo.984.1">ProcessMessage&lt;T&gt;</span></code><span class="koboSpan" id="kobo.985.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.986.1">protected </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.987.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.988.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.989.1">SafeProcessMessage</span></span><span class="koboSpan" id="kobo.990.1">&lt;T&gt;(T message)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.991.1">try</span></span><span class="koboSpan" id="kobo.992.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.993.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.994.1">ProcessMessage</span></span><span class="koboSpan" id="kobo.995.1">(message);
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.996.1">DeclareSuccessFailure</span></span><span class="koboSpan" id="kobo.997.1">();
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.998.1">catch</span></span><span class="koboSpan" id="kobo.999.1"> 
    {
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.1000.1">DeclareSuccessFailure</span></span><span class="koboSpan" id="kobo.1001.1">(</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1002.1">true</span></span><span class="koboSpan" id="kobo.1003.1">);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1004.1">throw</span></span><span class="koboSpan" id="kobo.1005.1">;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1006.1">Let’s also define a small method that computes the subscription ID to use for each message:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1007.1">string </span><span class="hljs-title"><span class="koboSpan" id="kobo.1008.1">SubscriptionId</span></span><span class="koboSpan" id="kobo.1009.1">&lt;T&gt;()
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1010.1">return</span></span><span class="koboSpan" id="kobo.1011.1"> string.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1012.1">Format</span></span><span class="koboSpan" id="kobo.1013.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1014.1">"{0}_{1}"</span></span><span class="koboSpan" id="kobo.1015.1">,
        configuration[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1016.1">"Messages__SubscriptionIdPrefix"</span><a id="_idTextAnchor175"/></span><span class="koboSpan" id="kobo.1017.1">],
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.1018.1">typeof</span></span><span class="koboSpan" id="kobo.1019.1">(T).</span><span class="hljs-property"><span class="koboSpan" id="kobo.1020.1">Name</span></span><span class="koboSpan" id="kobo.1021.1">);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1022.1">Now, we are ready to define our main </span><code class="inlineCode"><span class="koboSpan" id="kobo.1023.1">ExecuteAsync</span></code><span class="koboSpan" id="kobo.1024.1"> method; but before doing that, we must add a reference to the EasyNetQ NuGet package. </span><span class="koboSpan" id="kobo.1024.2">Please select a version greater than or equal to 8, also if it is a prerelease. </span><span class="koboSpan" id="kobo.1024.3">Once we have installed this package, we need to add its services to dependency injection in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1025.1">Program.cs</span></code><span class="koboSpan" id="kobo.1026.1"> by calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1027.1">AddEasyNetQ</span></code><span class="koboSpan" id="kobo.1028.1"> extension method and passing it the RabbitMQ connection string:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1029.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1030.1">Services</span></span><span class="koboSpan" id="kobo.1031.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1032.1">AddEasyNetQ</span></span><span class="koboSpan" id="kobo.1033.1">(
    builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1034.1">Configuration</span></span><span class="koboSpan" id="kobo.1035.1">?.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1036.1">GetConnectionString</span></span><span class="koboSpan" id="kobo.1037.1">(
</span><span class="hljs-string"><span class="koboSpan" id="kobo.1038.1">"RabbitMQConnection"</span></span><span class="koboSpan" id="kobo.1039.1">)??string.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1040.1">Empty</span></span><span class="koboSpan" id="kobo.1041.1">)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1042.1">UseAlwaysNackWithRequeueConsumerErrorStrategy</span></span><span class="koboSpan" id="kobo.1043.1">();;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1044.1">The chained </span><a id="_idIndexMarker411"/><span class="koboSpan" id="kobo.1045.1">call defines how to handle errors in the received message handlers. </span><span class="koboSpan" id="kobo.1045.2">We decided to requeue faulty messages so that they can be retried. </span><span class="koboSpan" id="kobo.1045.3">If a microservice </span><a id="_idIndexMarker412"/><span class="koboSpan" id="kobo.1046.1">replica is faulty and generates an error on all messages, the message will eventually be processed by a healthy replica, while the unhealthy replica will eventually be discovered thanks to the consecutive error count that we will expose on a health endpoint. </span><span class="koboSpan" id="kobo.1046.2">Unhealthy replicas are killed and recreated by all microservice orchestrators. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1047.1">The requeue strategy is usually the best error-handling strategy for enterprise microservices. </span><span class="koboSpan" id="kobo.1047.2">Anyway, there are other strategies available. </span><span class="koboSpan" id="kobo.1047.3">If no strategy is specified, faulty messages, that is, messages whose handlers throw exceptions, are enqueued in a special error queue where they can be handled manually with administrative tools (see </span><a href="https://github.com/EasyNetQ/EasyNetQ/wiki/Re-Submitting-Error-Messages-With-EasyNetQ.Hosepipe"><span class="url"><span class="koboSpan" id="kobo.1048.1">https://github.com/EasyNetQ/EasyNetQ/wiki/Re-Submitting-Error-Messages-With-EasyNetQ.Hosepipe</span></span></a><span class="koboSpan" id="kobo.1049.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1050.1">Access to all EasyNetQ communication facilities is done through an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1051.1">IBus</span></code><span class="koboSpan" id="kobo.1052.1"> interface. </span><span class="koboSpan" id="kobo.1052.2">Let’s add it to our hosted service main constructor:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1053.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1054.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1055.1">MainService</span></span><span class="koboSpan" id="kobo.1056.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1057.1">IConfiguration</span></span><span class="koboSpan" id="kobo.1058.1"> configuration, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1059.1">IBus</span></span><span class="koboSpan" id="kobo.1060.1"> bus,  
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1061.1">IServiceProvider</span></span><span class="koboSpan" id="kobo.1062.1"> services): </span><span class="hljs-title"><span class="koboSpan" id="kobo.1063.1">BackgroundService</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1064.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1065.1">IBus</span></code><span class="koboSpan" id="kobo.1066.1"> interface handles all communication with three properties:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1067.1">PubSub</span></code><span class="koboSpan" id="kobo.1068.1">: This contains all methods for sending and receiving messages with the publisher/subscriber pattern</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1069.1">SendReceive</span></code><span class="koboSpan" id="kobo.1070.1">: This contains all methods for sending and receiving messages with direct communication</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1071.1">Rpc</span></code><span class="koboSpan" id="kobo.1072.1">: This contains all methods for issuing asynchronous remote procedure calls and returning their responses</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1073.1">Here, we will describe </span><code class="inlineCode"><span class="koboSpan" id="kobo.1074.1">PubSub</span></code><span class="koboSpan" id="kobo.1075.1">, but </span><code class="inlineCode"><span class="koboSpan" id="kobo.1076.1">SendReceive</span></code><span class="koboSpan" id="kobo.1077.1"> is completely analogous. </span><span class="koboSpan" id="kobo.1077.2">The only difference is that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1078.1">Send</span></code><span class="koboSpan" id="kobo.1079.1"> method explicitly specifies the name of the destination queue, while </span><code class="inlineCode"><span class="koboSpan" id="kobo.1080.1">Publish</span></code><span class="koboSpan" id="kobo.1081.1"> does not. </span><span class="koboSpan" id="kobo.1081.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1082.1">Publish</span></code><span class="koboSpan" id="kobo.1083.1"> RabbitMQ exchange name is implicitly defined through the type of the message.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1084.1">The following are the publish methods:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-title"><span class="koboSpan" id="kobo.1085.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1086.1">PublishAsync</span></span><span class="koboSpan" id="kobo.1087.1">(T message, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1088.1">CancelationToken</span></span><span class="koboSpan" id="kobo.1089.1"> cancel = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1090.1">default</span></span><span class="koboSpan" id="kobo.1091.1">)
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1092.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1093.1">PublishAsync</span></span><span class="koboSpan" id="kobo.1094.1">(T message, string topic, 
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.1095.1">CancelationToken</span></span><span class="koboSpan" id="kobo.1096.1"> cancel = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1097.1">default</span></span><span class="koboSpan" id="kobo.1098.1">)
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1099.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1100.1">PublishAsync</span></span><span class="koboSpan" id="kobo.1101.1">(T message, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1102.1">Action</span></span><span class="koboSpan" id="kobo.1103.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1104.1">IPublishConfiguration</span></span><span class="koboSpan" id="kobo.1105.1"> &gt; configuration, 
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1106.1">    CancelationToken</span></span><span class="koboSpan" id="kobo.1107.1"> cancel = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1108.1">default</span></span><span class="koboSpan" id="kobo.1109.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1110.1">The second </span><a id="_idIndexMarker413"/><span class="koboSpan" id="kobo.1111.1">overload lets you specify a message topic, while the </span><a id="_idIndexMarker414"/><span class="koboSpan" id="kobo.1112.1">third lets you specify various configuration settings that may also include the message topic. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1113.1">The following are the subscribe methods:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-title"><span class="koboSpan" id="kobo.1114.1">SubscriptionResult</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1115.1">Subscribe</span></span><span class="koboSpan" id="kobo.1116.1">&lt;T&gt;(string subscriptionId,  
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1117.1">Func</span></span><span class="koboSpan" id="kobo.1118.1">&lt;T, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1119.1">Task</span></span><span class="koboSpan" id="kobo.1120.1">&gt; messageHandler, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1121.1">CancelationToken</span></span><span class="koboSpan" id="kobo.1122.1"> cancel = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1123.1">default</span></span><span class="koboSpan" id="kobo.1124.1">)
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1125.1">SubscriptionResult</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1126.1">Subscribe</span></span><span class="koboSpan" id="kobo.1127.1">&lt;T&gt;(string subscriptionId,  
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1128.1">Func</span></span><span class="koboSpan" id="kobo.1129.1">&lt;T, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1130.1">CancelationToken</span></span><span class="koboSpan" id="kobo.1131.1"> , </span><span class="hljs-title"><span class="koboSpan" id="kobo.1132.1">Task</span></span><span class="koboSpan" id="kobo.1133.1">&gt; messageHandler, 
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1134.1">Action</span></span><span class="koboSpan" id="kobo.1135.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1136.1">IsubscriptionConfiguration</span></span><span class="koboSpan" id="kobo.1137.1">&gt; configuration, 
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.1138.1">CancelationToken</span></span><span class="koboSpan" id="kobo.1139.1"> cancel = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1140.1">default</span></span><span class="koboSpan" id="kobo.1141.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1142.1">The returned value must be disposed of to unsubscribe. </span><span class="koboSpan" id="kobo.1142.2">The second overload accepts a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1143.1">CancelationToken</span></code><span class="koboSpan" id="kobo.1144.1"> in the message handler, and also accepts a configuration action. </span><span class="koboSpan" id="kobo.1144.2">The configuration of the receiver contains more useful settings, among them the following: </span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1145.1">conf =&gt; conf.WithTopic(“mytopic”).WithTopic(“anothertopic”)</span></code><span class="koboSpan" id="kobo.1146.1">: The consumer will receive just the messages tagged with one of the selected topics.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1147.1">conf =&gt; conf.WithPrefetchCount(N)</span></code><span class="koboSpan" id="kobo.1148.1">: </span><code class="inlineCode"><span class="koboSpan" id="kobo.1149.1">N</span></code><span class="koboSpan" id="kobo.1150.1"> is the maximum number of messages extracted from the queue by the consumer and waiting to be processed. </span><em class="italic"><span class="koboSpan" id="kobo.1151.1">N</span></em><span class="koboSpan" id="kobo.1152.1"> defaults to 20.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1153.1">Conf =&gt; conf.WithDurable(durable)</span></code><span class="koboSpan" id="kobo.1154.1">: If </span><code class="inlineCode"><span class="koboSpan" id="kobo.1155.1">durable</span></code><span class="koboSpan" id="kobo.1156.1"> is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1157.1">true</span></code><span class="koboSpan" id="kobo.1158.1">, all consumer queue messages are recorded on disk by RabbitMQ. </span><span class="koboSpan" id="kobo.1158.2">The default is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1159.1">true</span></code><span class="koboSpan" id="kobo.1160.1">.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1161.1">If messages must be processed in the same order that they were inserted in the queue, the prefetch count must be set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1162.1">1</span></code><span class="koboSpan" id="kobo.1163.1"> and we must also apply one of the strategies described in the </span><em class="italic"><span class="koboSpan" id="kobo.1164.1">Ensuring that messages are processed in the proper order</span></em><span class="koboSpan" id="kobo.1165.1"> subsection.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1166.1">If we use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1167.1">Subscribe</span></code><span class="koboSpan" id="kobo.1168.1">, all prefetched messages are put in an internal in-memory queue and processed </span><a id="_idTextAnchor176"/><span class="koboSpan" id="kobo.1169.1">in a unique thread. </span><span class="koboSpan" id="kobo.1169.2">However, there is also a completely analogous </span><code class="inlineCode"><span class="koboSpan" id="kobo.1170.1">SubscribeAsync</span></code><span class="koboSpan" id="kobo.1171.1"> that creates several parallel threads. </span><span class="koboSpan" id="kobo.1171.2">Moreover, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1172.1">SubscribeAsync</span></code><span class="koboSpan" id="kobo.1173.1">, as usual, returns </span><code class="inlineCode"><span class="koboSpan" id="kobo.1174.1">Task&lt;SubscriptionResult&gt;</span></code><span class="koboSpan" id="kobo.1175.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1176.1">We will use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1177.1">SubscribeAsync</span></code><span class="koboSpan" id="kobo.1178.1"> to better exploit processor cores, and parallelism between disk/database operations and processor operations, but the simple fact of using several microservice replicas </span><a id="_idIndexMarker415"/><span class="koboSpan" id="kobo.1179.1">already exploits parallelism. </span><span class="koboSpan" id="kobo.1179.2">The advantage of </span><a id="_idIndexMarker416"/><span class="koboSpan" id="kobo.1180.1">using several threads is that creating a thread costs less than creating another replica, so each replica should use several threads to optimize performance.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1181.1">When the message handler successfully completes the task, a confirmation is automatically sent to RabbitMQ that deletes the message from the queue. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1182.1">On the contrary, if the message handler throws an unhandled exception, the configured consumer error strategy is applied. </span><span class="koboSpan" id="kobo.1182.2">In our case, we requeue the message.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1183.1">Now, we are finally ready to write the main </span><code class="inlineCode"><span class="koboSpan" id="kobo.1184.1">ExecuteAsync</span></code><span class="koboSpan" id="kobo.1185.1"> method. </span><span class="koboSpan" id="kobo.1185.2">After our configuration and preparation methods, it became straightforward:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1186.1">protected override </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1187.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1188.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1189.1">ExecuteAsync</span></span><span class="koboSpan" id="kobo.1190.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1191.1">CancellationToken</span></span><span class="koboSpan" id="kobo.1192.1"> stoppingToken)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1193.1">var</span></span><span class="koboSpan" id="kobo.1194.1"> routeOfferSubscription = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1195.1">await</span></span><span class="koboSpan" id="kobo.1196.1"> bus.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1197.1">PubSub</span></span><span class="koboSpan" id="kobo.1198.1">.
        </span><span class="hljs-property"><span class="koboSpan" id="kobo.1199.1">SubscribeAsync</span></span><span class="koboSpan" id="kobo.1200.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1201.1">RouteOfferMessage</span></span><span class="koboSpan" id="kobo.1202.1">&gt;(
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.1203.1">SubscriptionId</span></span><span class="koboSpan" id="kobo.1204.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1205.1">RouteOfferMessage</span></span><span class="koboSpan" id="kobo.1206.1">&gt;(),</span><span class="hljs-title"><span class="koboSpan" id="kobo.1207.1">SafeProcessMessage</span></span><span class="koboSpan" id="kobo.1208.1">, 
        stoppingToken);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1209.1">var</span></span><span class="koboSpan" id="kobo.1210.1"> routeClosedAbortedSubscription = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1211.1">await</span></span><span class="koboSpan" id="kobo.1212.1"> bus.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1213.1">PubSub</span></span><span class="koboSpan" id="kobo.1214.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1215.1">SubscribeAsync</span></span><span class="koboSpan" id="kobo.1216.1">&lt;
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.1217.1">RouteClosedAbortedMessage</span></span><span class="koboSpan" id="kobo.1218.1">&gt;(
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.1219.1">SubscriptionId</span></span><span class="koboSpan" id="kobo.1220.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1221.1">RouteClosedAbortedMessage</span></span><span class="koboSpan" id="kobo.1222.1">&gt;(), </span><span class="hljs-title"><span class="koboSpan" id="kobo.1223.1">SafeProcessMessage</span></span><span class="koboSpan" id="kobo.1224.1">, 
            stoppingToken);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1225.1">var</span></span><span class="koboSpan" id="kobo.1226.1"> routeExtendedSubscription = 
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1227.1">await</span></span><span class="koboSpan" id="kobo.1228.1"> bus.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1229.1">PubSub</span></span><span class="koboSpan" id="kobo.1230.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1231.1">SubscribeAsync</span></span><span class="koboSpan" id="kobo.1232.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1233.1">RouteExtendedMessage</span></span><span class="koboSpan" id="kobo.1234.1">&gt;(
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.1235.1">SubscriptionId</span></span><span class="koboSpan" id="kobo.1236.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1237.1">RouteExtendedMessage</span></span><span class="koboSpan" id="kobo.1238.1">&gt;(), </span><span class="hljs-title"><span class="koboSpan" id="kobo.1239.1">SafeProcessMessage</span></span><span class="koboSpan" id="kobo.1240.1">, 
           stoppingToken);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1241.1">var</span></span><span class="koboSpan" id="kobo.1242.1"> routeRequestSubscription = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1243.1">await</span></span><span class="koboSpan" id="kobo.1244.1"> bus.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1245.1">PubSub</span></span><span class="koboSpan" id="kobo.1246.1">.
        </span><span class="hljs-property"><span class="koboSpan" id="kobo.1247.1">SubscribeAsync</span></span><span class="koboSpan" id="kobo.1248.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1249.1">RouteRequestMessage</span></span><span class="koboSpan" id="kobo.1250.1">&gt;(
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.1251.1">SubscriptionId</span></span><span class="koboSpan" id="kobo.1252.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1253.1">RouteRequestMessage</span></span><span class="koboSpan" id="kobo.1254.1">&gt;(), </span><span class="hljs-title"><span class="koboSpan" id="kobo.1255.1">SafeProcessMessage</span></span><span class="koboSpan" id="kobo.1256.1">, 
           stoppingToken);
     
    stoppingToken.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1257.1">WaitHandle</span></span><span class="koboSpan" id="kobo.1258.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1259.1">WaitOne</span></span><span class="koboSpan" id="kobo.1260.1">();
    routeRequestSubscription.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1261.1">Dispose</span></span><span class="koboSpan" id="kobo.1262.1">();
    routeExtendedSubscription.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1263.1">Dispose</span></span><span class="koboSpan" id="kobo.1264.1">();
    routeClosedAbortedSubscription.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1265.1">Dispose</span></span><span class="koboSpan" id="kobo.1266.1">();
    routeOfferSubscription.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1267.1">Dispose</span></span><span class="koboSpan" id="kobo.1268.1">();
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1269.1">We just subscribe to all messages using our unique generic message handler, and then wait for the replica </span><a id="_idIndexMarker417"/><span class="koboSpan" id="kobo.1270.1">termination on the wait handle </span><code class="inlineCode"><span class="koboSpan" id="kobo.1271.1">stoppingToken.WaitHandle</span></code><span class="koboSpan" id="kobo.1272.1">. </span><span class="koboSpan" id="kobo.1272.2">As soon as we receive notification that the replica is being terminated through </span><code class="inlineCode"><span class="koboSpan" id="kobo.1273.1">WaitOne()</span></code><span class="koboSpan" id="kobo.1274.1">, the wait handle is unblocked and we unsubscribe all messages by </span><a id="_idIndexMarker418"/><span class="koboSpan" id="kobo.1275.1">calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1276.1">Dispose</span></code><span class="koboSpan" id="kobo.1277.1"> methods of all </span><code class="inlineCode"><span class="koboSpan" id="kobo.1278.1">SubscriptionResult</span></code><span class="koboSpan" id="kobo.1279.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1280.1">Before moving on to the implementation of the two remaining hosted services, for completeness, we will also describe the EasyNetQ RPC facilities.</span></p>
<h2 class="heading-2" id="_idParaDest-127"><a id="_idTextAnchor177"/><span class="koboSpan" id="kobo.1281.1">EasyNetQ’s RPC facilities</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1282.1">An RPC </span><a id="_idIndexMarker419"/><span class="koboSpan" id="kobo.1283.1">request can be issued with the following methods:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-title"><span class="koboSpan" id="kobo.1284.1">Task</span></span><span class="koboSpan" id="kobo.1285.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1286.1">TResponse</span></span><span class="koboSpan" id="kobo.1287.1">&gt; bus.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1288.1">Rpc</span></span><span class="koboSpan" id="kobo.1289.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1290.1">RequestAsync</span></span><span class="koboSpan" id="kobo.1291.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1292.1">TRequest</span></span><span class="koboSpan" id="kobo.1293.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1294.1">TResponse</span></span><span class="koboSpan" id="kobo.1295.1">&gt;(
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1296.1">TRequest</span></span><span class="koboSpan" id="kobo.1297.1"> request, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1298.1">CancelationToken</span></span><span class="koboSpan" id="kobo.1299.1"> cancel = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1300.1">default</span></span><span class="koboSpan" id="kobo.1301.1">)
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1302.1">Task</span></span><span class="koboSpan" id="kobo.1303.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1304.1">TResponse</span></span><span class="koboSpan" id="kobo.1305.1">&gt; bus.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1306.1">Rpc</span></span><span class="koboSpan" id="kobo.1307.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1308.1">RequestAsync</span></span><span class="koboSpan" id="kobo.1309.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1310.1">TRequest</span></span><span class="koboSpan" id="kobo.1311.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1312.1">TResponse</span></span><span class="koboSpan" id="kobo.1313.1">&gt;(
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1314.1">TRequest</span></span><span class="koboSpan" id="kobo.1315.1"> request,  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1316.1">Action</span></span><span class="koboSpan" id="kobo.1317.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1318.1">IRequestConfiguration</span></span><span class="koboSpan" id="kobo.1319.1">&gt; configuration, 
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1320.1">CancelationToken</span></span><span class="koboSpan" id="kobo.1321.1"> cancel = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1322.1">default</span></span><span class="koboSpan" id="kobo.1323.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1324.1">Once the </span><a id="_idIndexMarker420"/><span class="koboSpan" id="kobo.1325.1">request is issued, the returned task will eventually provide the response. </span><span class="koboSpan" id="kobo.1325.2">We can wait it with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1326.1">await</span></code><span class="koboSpan" id="kobo.1327.1"> or specify a callback by calling </span><code class="inlineCode"><span class="koboSpan" id="kobo.1328.1">Task&lt;T&gt;.ContinueWith</span></code><span class="koboSpan" id="kobo.1329.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1330.1">The recipient can listen for requests and provide responses with the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-title"><span class="koboSpan" id="kobo.1331.1">Task</span></span><span class="koboSpan" id="kobo.1332.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1333.1">IDisposable</span></span><span class="koboSpan" id="kobo.1334.1">&gt; bus.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1335.1">Rpc</span></span><span class="koboSpan" id="kobo.1336.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1337.1">RequestAsync</span></span><span class="koboSpan" id="kobo.1338.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1339.1">TRequest</span></span><span class="koboSpan" id="kobo.1340.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1341.1">TResponse</span></span><span class="koboSpan" id="kobo.1342.1">&gt;(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.1343.1">Func</span></span><span class="koboSpan" id="kobo.1344.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1345.1">TRequest</span></span><span class="koboSpan" id="kobo.1346.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1347.1">Task</span></span><span class="koboSpan" id="kobo.1348.1">&lt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.1349.1">TResponse</span></span><span class="koboSpan" id="kobo.1350.1"> &gt;&gt; handler, 
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.1351.1">CancelationToken</span></span><span class="koboSpan" id="kobo.1352.1"> cancel = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1353.1">default</span></span><span class="koboSpan" id="kobo.1354.1">);
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1355.1">Task</span></span><span class="koboSpan" id="kobo.1356.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1357.1">IDisposable</span></span><span class="koboSpan" id="kobo.1358.1">&gt; bus.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1359.1">Rpc</span></span><span class="koboSpan" id="kobo.1360.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1361.1">RequestAsync</span></span><span class="koboSpan" id="kobo.1362.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1363.1">TRequest</span></span><span class="koboSpan" id="kobo.1364.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1365.1">TResponse</span></span><span class="koboSpan" id="kobo.1366.1">&gt;(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.1367.1">Func</span></span><span class="koboSpan" id="kobo.1368.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1369.1">TRequest</span></span><span class="koboSpan" id="kobo.1370.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1371.1">Task</span></span><span class="koboSpan" id="kobo.1372.1">&lt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.1373.1">TResponse</span></span><span class="koboSpan" id="kobo.1374.1"> &gt;&gt; handler, 
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.1375.1">Action</span></span><span class="koboSpan" id="kobo.1376.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1377.1">IResponderConfiguration</span></span><span class="koboSpan" id="kobo.1378.1">&gt; configuration,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.1379.1">CancelationToken</span></span><span class="koboSpan" id="kobo.1380.1"> cancel = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1381.1">default</span></span><span class="koboSpan" id="kobo.1382.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1383.1">The recipient can stop handling requests by disposing of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1384.1">IDisposable</span></code><span class="koboSpan" id="kobo.1385.1"> returned by the preceding methods.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1386.1">Now, let’s move on to the remaining hosted services.</span></p>
<h2 class="heading-2" id="_idParaDest-128"><a id="_idTextAnchor178"/><span class="koboSpan" id="kobo.1387.1">Other required hosted services</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1388.1">We will </span><a id="_idIndexMarker421"/><span class="koboSpan" id="kobo.1389.1">start with the housekeeping hosted service. </span><span class="koboSpan" id="kobo.1389.2">Let’s call it </span><code class="inlineCode"><span class="koboSpan" id="kobo.1390.1">HouseKeepingService</span></code><span class="koboSpan" id="kobo.1391.1"> and place it in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1392.1">HostedServices</span></code><span class="koboSpan" id="kobo.1393.1"> folder together with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1394.1">MainService</span></code><span class="koboSpan" id="kobo.1395.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1396.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1397.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1398.1">HouseKeepingService</span></span><span class="koboSpan" id="kobo.1399.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1400.1">IConfiguration</span></span><span class="koboSpan" id="kobo.1401.1"> configuration, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1402.1">IBus</span></span><span class="koboSpan" id="kobo.1403.1"> bus, 
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.1404.1">IServiceProvider</span></span><span class="koboSpan" id="kobo.1405.1"> services): </span><span class="hljs-title"><span class="koboSpan" id="kobo.1406.1">BackgroundService</span></span><span class="koboSpan" id="kobo.1407.1">
{
    protected override </span><span class="hljs-title"><span class="koboSpan" id="kobo.1408.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1409.1">ExecuteAsync</span></span><span class="koboSpan" id="kobo.1410.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1411.1">CancellationToken</span></span><span class="koboSpan" id="kobo.1412.1"> stoppingToken)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1413.1">throw</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1414.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1415.1">NotImplementedException</span></span><span class="koboSpan" id="kobo.1416.1">();
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1417.1">Before proceeding, let’s add the new hosted service to the dependency injection container, so it will </span><a id="_idIndexMarker422"/><span class="koboSpan" id="kobo.1418.1">be immediately executed at program start. </span><span class="koboSpan" id="kobo.1418.2">We just need to add the following instruction to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1419.1">Program.cs</span></code><span class="koboSpan" id="kobo.1420.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1421.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1422.1">Services</span></span><span class="koboSpan" id="kobo.1423.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1424.1">AddHostedService</span></span><span class="koboSpan" id="kobo.1425.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1426.1">HouseKeepingService</span></span><span class="koboSpan" id="kobo.1427.1">&gt;();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1428.1">We need a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1429.1">HouseKeepingCommand</span></code><span class="koboSpan" id="kobo.1430.1"> whose constructor specifies the number of days to wait after a route or request expiration before deleting it. </span><span class="koboSpan" id="kobo.1430.2">As usual, let’s define it in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1431.1">Commands</span></code><span class="koboSpan" id="kobo.1432.1"> folder of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1433.1">RoutesPlanningApplicationServices</span></code><span class="koboSpan" id="kobo.1434.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1435.1">public record </span><span class="hljs-title"><span class="koboSpan" id="kobo.1436.1">H</span><a id="_idTextAnchor179"/><span class="koboSpan" id="kobo.1437.1">ouseKeepingCommand</span></span><span class="koboSpan" id="kobo.1438.1">(int </span><span class="hljs-title"><span class="koboSpan" id="kobo.1439.1">DeleteDelay</span></span><span class="koboSpan" id="kobo.1440.1">): </span><span class="hljs-title"><span class="koboSpan" id="kobo.1441.1">ICommand</span></span><span class="koboSpan" id="kobo.1442.1">;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1443.1">We also need to define the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1444.1">Timing__HousekeepingIntervalHours</span></code><span class="koboSpan" id="kobo.1445.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1446.1">Timing__HousekeepingDelayDays</span></code><span class="koboSpan" id="kobo.1447.1"> environment variables in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1448.1">launchSettings.json</span></code><span class="koboSpan" id="kobo.1449.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.1450.1">"Topology__MaxDistanceKm"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1451.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1452.1">"50"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1453.1">,</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1454.1">//new environment variables</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1455.1">"Timing__HousekeepingIntervalHours"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1456.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1457.1">"4"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1458.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1459.1">"Timing__HousekeepingDelayDays"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1460.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1461.1">"10"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1462.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1463.1">ExecuteAsync</span></code><span class="koboSpan" id="kobo.1464.1"> method must </span><a id="_idIndexMarker423"/><span class="koboSpan" id="kobo.1465.1">execute a loop until the application signals </span><a id="_idIndexMarker424"/><span class="koboSpan" id="kobo.1466.1">termination. </span><span class="koboSpan" id="kobo.1466.2">Inside this loop, it executes the handler and then sleeps </span><a id="_idIndexMarker425"/><span class="koboSpan" id="kobo.1467.1">for the time specified by </span><code class="inlineCode"><span class="koboSpan" id="kobo.1468.1">Timing__HousekeepingIntervalHours</span></code><span class="koboSpan" id="kobo.1469.1"> or until the replica terminates:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1470.1">protected override </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1471.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1472.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1473.1">ExecuteAsync</span></span><span class="koboSpan" id="kobo.1474.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1475.1">CancellationToken</span></span><span class="koboSpan" id="kobo.1476.1"> stoppingToken)
{
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1477.1">//update interval in milliseconds</span></span><span class="koboSpan" id="kobo.1478.1">
    int updateInterval = configuration.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1479.1">GetValue</span></span><span class="koboSpan" id="kobo.1480.1">&lt;int&gt;(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1481.1">"Timing:HousekeepingIntervalHours"</span></span><span class="koboSpan" id="kobo.1482.1">)*</span><span class="hljs-number"><span class="koboSpan" id="kobo.1483.1">3600000</span></span><span class="koboSpan" id="kobo.1484.1">;
    int deleteDelayDays = configuration.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1485.1">GetValue</span></span><span class="koboSpan" id="kobo.1486.1">&lt;int&gt;(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1487.1">"Timing:HousekeepingDelayDays"</span></span><span class="koboSpan" id="kobo.1488.1">);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1489.1">while</span></span><span class="koboSpan" id="kobo.1490.1"> (!stoppingToken.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1491.1">IsCancellationRequested</span></span><span class="koboSpan" id="kobo.1492.1">)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1493.1">try</span></span><span class="koboSpan" id="kobo.1494.1">
        {
            </span><span class="hljs-title"><span class="koboSpan" id="kobo.1495.1">using</span></span><span class="koboSpan" id="kobo.1496.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1497.1">var</span></span><span class="koboSpan" id="kobo.1498.1"> scope = services.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1499.1">CreateScope</span></span><span class="koboSpan" id="kobo.1500.1">())
            {
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1501.1">var</span></span><span class="koboSpan" id="kobo.1502.1"> handler = scope.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1503.1">ServiceProvider</span></span><span class="koboSpan" id="kobo.1504.1">
                    .</span><span class="hljs-property"><span class="koboSpan" id="kobo.1505.1">GetRequiredService</span></span><span class="koboSpan" id="kobo.1506.1">&lt;
                        </span><span class="hljs-title"><span class="koboSpan" id="kobo.1507.1">ICommandHandler</span></span><span class="koboSpan" id="kobo.1508.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1509.1">HouseKeepingCommand</span></span><span class="koboSpan" id="kobo.1510.1">&gt;&gt;();
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1511.1">await</span></span><span class="koboSpan" id="kobo.1512.1"> handler.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1513.1">HandleAsync</span></span><span class="koboSpan" id="kobo.1514.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1515.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1516.1">HouseKeepingCommand</span></span><span class="koboSpan" id="kobo.1517.1">(
                    deleteDelayDays));
            }
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1518.1">catch</span></span><span class="koboSpan" id="kobo.1519.1"> { 
          </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1520.1">// actual production application should log the error</span></span><span class="koboSpan" id="kobo.1521.1">
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1522.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1523.1">Task</span></span><span class="koboSpan" id="kobo.1524.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1525.1">Delay</span></span><span class="koboSpan" id="kobo.1526.1">(updateInterval, stoppingToken);
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1527.1">In case of errors, we simply do nothing and repeat the operation at the next iteration. </span><span class="koboSpan" id="kobo.1527.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1528.1">Task.Delay</span></code><span class="koboSpan" id="kobo.1529.1"> instruction at the end of the iteration leaves the thread sleeping until either the configured interval expires or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1530.1">stoppingToken</span></code><span class="koboSpan" id="kobo.1531.1"> signals the replica termination.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1532.1">Let’s move on to the last hosted service. </span><span class="koboSpan" id="kobo.1532.2">Let’s repeat the same steps to create it and call it </span><code class="inlineCode"><span class="koboSpan" id="kobo.1533.1">OutputSendingService</span></code><span class="koboSpan" id="kobo.1534.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1535.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1536.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1537.1">OutputSendingService</span></span><span class="koboSpan" id="kobo.1538.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1539.1">IConfiguration</span></span><span class="koboSpan" id="kobo.1540.1"> configuration, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1541.1">IBus</span></span><span class="koboSpan" id="kobo.1542.1"> bus,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.1543.1">IServiceProvider</span></span><span class="koboSpan" id="kobo.1544.1"> services) : </span><span class="hljs-title"><span class="koboSpan" id="kobo.1545.1">BackgroundService</span></span><span class="koboSpan" id="kobo.1546.1">
{
    protected override </span><span class="hljs-title"><span class="koboSpan" id="kobo.1547.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1548.1">ExecuteAsync</span></span><span class="koboSpan" id="kobo.1549.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1550.1">CancellationToken</span></span><span class="koboSpan" id="kobo.1551.1"> stoppingToken)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1552.1">throw</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1553.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1554.1">NotImplementedException</span></span><span class="koboSpan" id="kobo.1555.1">();
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1556.1">As usual, let’s add the new hosted service to the dependency injection container:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1557.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1558.1">Services</span></span><span class="koboSpan" id="kobo.1559.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1560.1">AddHost</span><a id="_idTextAnchor180"/><a id="_idTextAnchor181"/><span class="koboSpan" id="kobo.1561.1">edService</span></span><span class="koboSpan" id="kobo.1562.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1563.1">OutputSendingService</span></span><span class="koboSpan" id="kobo.1564.1">&gt;();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1565.1">This time, we need a command that accepts </span><code class="inlineCode"><span class="koboSpan" id="kobo.1566.1">Func&lt;RouteExtensionProposalsMessage,Task&gt;</span></code><span class="koboSpan" id="kobo.1567.1"> as input. </span><span class="koboSpan" id="kobo.1567.2">This input action wraps the code for sending </span><code class="inlineCode"><span class="koboSpan" id="kobo.1568.1">RouteExtensionProposalsMessage</span></code><span class="koboSpan" id="kobo.1569.1"> to RabbitMQ because commands can contain code that depends on a specific driver, which in our case is the RabbitMQ client. </span><span class="koboSpan" id="kobo.1569.2">It also needs a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1570.1">batchCount</span></code><span class="koboSpan" id="kobo.1571.1"> parameter, which specifies how many output messages are simultaneously extracted from the output queue, and a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1572.1">requeueDelay</span></code><span class="koboSpan" id="kobo.1573.1"> parameter, which specifies the </span><a id="_idIndexMarker426"/><span class="koboSpan" id="kobo.1574.1">overall timeout after which a message is requeued if it is not successfully received by the message broker.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1575.1">We can define a </span><a id="_idIndexMarker427"/><span class="koboSpan" id="kobo.1576.1">generic command that receives just </span><code class="inlineCode"><span class="koboSpan" id="kobo.1577.1">Func&lt;T,Task&gt;</span></code><span class="koboSpan" id="kobo.1578.1">, so we can reuse it with other output messages; let’s call it </span><code class="inlineCode"><span class="koboSpan" id="kobo.1579.1">OutputSendingCommand</span></code><span class="koboSpan" id="kobo.1580.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1581.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1582.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1583.1">OutputSendingCommand</span></span><span class="koboSpan" id="kobo.1584.1">&lt;T&gt;(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1585.1">Func</span></span><span class="koboSpan" id="kobo.1586.1">&lt;T, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1587.1">Task</span></span><span class="koboSpan" id="kobo.1588.1">&gt; sender, 
int batchCount, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1589.1">TimeSpan</span></span><span class="koboSpan" id="kobo.1590.1"> requeueDelay): </span><span class="hljs-title"><span class="koboSpan" id="kobo.1591.1">ICommand</span></span><span class="koboSpan" id="kobo.1592.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.1593.1">Func</span></span><span class="koboSpan" id="kobo.1594.1">&lt;T, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1595.1">Task</span></span><span class="koboSpan" id="kobo.1596.1">&gt; </span><span class="hljs-params"><span class="koboSpan" id="kobo.1597.1">Sender</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1598.1"> =&gt;</span></span><span class="koboSpan" id="kobo.1599.1"> sender;
    public int </span><span class="hljs-title"><span class="koboSpan" id="kobo.1600.1">BatchCount</span></span><span class="koboSpan" id="kobo.1601.1"> =&gt; batchCount;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.1602.1">TimeSpan</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1603.1">RequeueDelay</span></span><span class="koboSpan" id="kobo.1604.1"> =&gt; requeueDelay;
    public bool </span><span class="hljs-title"><span class="koboSpan" id="kobo.1605.1">OutPutEmpty</span></span><span class="koboSpan" id="kobo.1606.1"> { get; set; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1607.1">false</span></span><span class="koboSpan" id="kobo.1608.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1609.1">The command contains a flag where its handler will signal whether the output queue was found empty. </span><span class="koboSpan" id="kobo.1609.2">We will use this flag to put the hosted service thread to sleep for a certain interval to avoid wasting resources.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1610.1">Again, we need a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1611.1">Timing__OutputEmptyDelayMS</span></code><span class="koboSpan" id="kobo.1612.1"> environment variable to configure the time to wait when the output queue is empty. </span><span class="koboSpan" id="kobo.1612.2">Let add it to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1613.1">launchSettings.json</span></code><span class="koboSpan" id="kobo.1614.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.1615.1">"Timing__OutputEmptyDelayMS"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1616.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1617.1">"500"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1618.1">We need also the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1619.1">batchCount</span></code><span class="koboSpan" id="kobo.1620.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1621.1">requeueDelay</span></code><span class="koboSpan" id="kobo.1622.1"> values to pass to the command:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.1623.1">"Timing__OutputBatchCount"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1624.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1625.1">"10"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1626.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1627.1">"Timing__OutputRequeueDelayMin"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1628.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1629.1">"5"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1630.1">Suppose we have a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1631.1">SafeInvokeCommand</span></code><span class="koboSpan" id="kobo.1632.1"> we need to implement that also returns whether the output queue is empty:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1633.1">protected </span><span class="hljs-title"><span class="koboSpan" id="kobo.1634.1">Task</span></span><span class="koboSpan" id="kobo.1635.1">&lt;bool&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.1636.1">SafeInvokeCommand</span></span><span class="koboSpan" id="kobo.1637.1">()
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1638.1">throw</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1639.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1640.1">NotImplementedException</span></span><span class="koboSpan" id="kobo.1641.1">();
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1642.1">Then, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1643.1">ExetuteAsync</span></code><span class="koboSpan" id="kobo.1644.1"> method can be implemented as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1645.1">readonly int updateBatchCount =
        configuration.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1646.1">GetValue</span></span><span class="koboSpan" id="kobo.1647.1">&lt;int&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1648.1">"Timing:OutputBatchCount"</span></span><span class="koboSpan" id="kobo.1649.1">);
readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.1650.1">TimeSpan</span></span><span class="koboSpan" id="kobo.1651.1"> requeueDelay = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1652.1">TimeSpan</span></span><span class="koboSpan" id="kobo.1653.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1654.1">FromMinutes</span></span><span class="koboSpan" id="kobo.1655.1">(
        configuration.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1656.1">GetValue</span></span><span class="koboSpan" id="kobo.1657.1">&lt;int&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1658.1">"Timing:OutputRequeueDelayMin"</span></span><span class="koboSpan" id="kobo.1659.1">));
protected override </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1660.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1661.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1662.1">ExecuteAsync</span></span><span class="koboSpan" id="kobo.1663.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1664.1">CancellationToken</span></span><span class="koboSpan" id="kobo.1665.1"> stoppingToken)
{
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1666.1">//update interval in milliseconds</span></span><span class="koboSpan" id="kobo.1667.1">
    int updateInterval =
        configuration.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1668.1">GetValue</span></span><span class="koboSpan" id="kobo.1669.1">&lt;int&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1670.1">"Timing:HousekeepingIntervalHours"</span></span><span class="koboSpan" id="kobo.1671.1">) ;
    bool queueEmpty = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1672.1">false</span></span><span class="koboSpan" id="kobo.1673.1">;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1674.1">while</span></span><span class="koboSpan" id="kobo.1675.1"> (!stoppingToken.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1676.1">IsCancellationRequested</span></span><span class="koboSpan" id="kobo.1677.1">)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1678.1">while</span></span><span class="koboSpan" id="kobo.1679.1"> (!queueEmpty &amp;&amp; !stoppingToken.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1680.1">IsCancellationRequested</span></span><span class="koboSpan" id="kobo.1681.1">)
        {
            queueEmpty=</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1682.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1683.1">SafeInvokeCommand</span></span><span class="koboSpan" id="kobo.1684.1">();
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1685.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1686.1">Task</span></span><span class="koboSpan" id="kobo.1687.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1688.1">Delay</span></span><span class="koboSpan" id="kobo.1689.1">(updateInterval, stoppingToken);
        queueEmpty = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1690.1">false</span></span><span class="koboSpan" id="kobo.1691.1">;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1692.1">An outermost </span><a id="_idIndexMarker428"/><span class="koboSpan" id="kobo.1693.1">loop that exits only when the replica is going to be terminated, and an </span><a id="_idIndexMarker429"/><span class="koboSpan" id="kobo.1694.1">inner loop that reads the internal output queue and sends messages to the messages broker until the output queue is empty. </span><span class="koboSpan" id="kobo.1694.2">When the output queue is empty, the service sleeps to wait for new messages being inserted in the internal output queue.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1695.1">Before implementing </span><code class="inlineCode"><span class="koboSpan" id="kobo.1696.1">SafeInvokeCommand</span></code><span class="koboSpan" id="kobo.1697.1">, we must code the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1698.1">Func&lt;T,Task&gt;</span></code><span class="koboSpan" id="kobo.1699.1"> wrapper to pass to the command:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1700.1">protected  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1701.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1702.1">SendMessage</span></span><span class="koboSpan" id="kobo.1703.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1704.1">RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.1705.1"> message)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1706.1">return</span></span><span class="koboSpan" id="kobo.1707.1"> bus.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1708.1">PubSub</span></span><span class="koboSpan" id="kobo.1709.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1710.1">PublishAsync</span></span><span class="koboSpan" id="kobo.1711.1">&lt;
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.1712.1">RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.1713.1">&gt;(message);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1714.1">Now, the implementation </span><a id="_idIndexMarker430"/><span class="koboSpan" id="kobo.1715.1">is analogous to the command </span><a id="_idIndexMarker431"/><span class="koboSpan" id="kobo.1716.1">invoker of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1717.1">MainService</span></code><span class="koboSpan" id="kobo.1718.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1719.1">protected </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1720.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1721.1">Task</span></span><span class="koboSpan" id="kobo.1722.1">&lt;bool&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.1723.1">InvokeCommand</span></span><span class="koboSpan" id="kobo.1724.1">()
{
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.1725.1">using</span></span><span class="koboSpan" id="kobo.1726.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1727.1">var</span></span><span class="koboSpan" id="kobo.1728.1"> scope = services.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1729.1">CreateScope</span></span><span class="koboSpan" id="kobo.1730.1">())
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1731.1">var</span></span><span class="koboSpan" id="kobo.1732.1"> handler = scope.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1733.1">ServiceProvider</span></span><span class="koboSpan" id="kobo.1734.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1735.1">GetRequiredService</span></span><span class="koboSpan" id="kobo.1736.1">&lt;
            </span><span class="hljs-title"><span class="koboSpan" id="kobo.1737.1">ICommandHandler</span></span><span class="koboSpan" id="kobo.1738.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1739.1">OutputSendingCommand</span></span><span class="koboSpan" id="kobo.1740.1">&lt;
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1741.1">                RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.1742.1">&gt;&gt;&gt;();
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1743.1">var</span></span><span class="koboSpan" id="kobo.1744.1"> command = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1745.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1746.1">OutputSendingCommand</span></span><span class="koboSpan" id="kobo.1747.1">&lt;
            </span><span class="hljs-title"><span class="koboSpan" id="kobo.1748.1">RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.1749.1">&gt;(
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1750.1">                SendMessage</span></span><span class="koboSpan" id="kobo.1751.1">,updateBatchCount, requeueDelay);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1752.1">await</span></span><span class="koboSpan" id="kobo.1753.1"> handler.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1754.1">HandleAsync</span></span><span class="koboSpan" id="kobo.1755.1">(command);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1756.1">return</span></span><span class="koboSpan" id="kobo.1757.1"> command.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1758.1">OutPutEmpty</span></span><span class="koboSpan" id="kobo.1759.1">;
    }
}
protected </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1760.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1761.1">Task</span></span><span class="koboSpan" id="kobo.1762.1">&lt;bool&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.1763.1">SafeInvokeCommand</span></span><span class="koboSpan" id="kobo.1764.1">()
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1765.1">try</span></span><span class="koboSpan" id="kobo.1766.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1767.1">return</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1768.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1769.1">InvokeCommand</span></span><span class="koboSpan" id="kobo.1770.1">();
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1771.1">catch</span></span><span class="koboSpan" id="kobo.1772.1">
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1773.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1774.1">true</span></span><span class="koboSpan" id="kobo.1775.1">;
    };
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1776.1">In case of exceptions, we simply return </span><code class="inlineCode"><span class="koboSpan" id="kobo.1777.1">true</span></code><span class="koboSpan" id="kobo.1778.1"> to put the thread to sleep for some time. </span><span class="koboSpan" id="kobo.1778.2">In the next section, we will use the Polly library to define retry strategies.</span></p>
<h1 class="heading-1" id="_idParaDest-129"><a id="_idTextAnchor182"/><span class="koboSpan" id="kobo.1779.1">Ensuring resilient task execution with Polly </span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1780.1">Message sending </span><a id="_idIndexMarker432"/><span class="koboSpan" id="kobo.1781.1">should always be protected </span><a id="_idIndexMarker433"/><span class="koboSpan" id="kobo.1782.1">with at least exponential retry and the circuit break strategies that we analyzed in the </span><em class="italic"><span class="koboSpan" id="kobo.1783.1">Resilient task execution </span></em><span class="koboSpan" id="kobo.1784.1">subsection of</span><em class="italic"> </em><a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic"><span class="koboSpan" id="kobo.1785.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.1786.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1787.1">Demystifying Microservices Applications</span></em><span class="koboSpan" id="kobo.1788.1">. </span><span class="koboSpan" id="kobo.1788.2">In this section, we will first describe the Polly library, which became a kind of standard for handling resilient task execution, and then we will apply it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1789.1">SendMessage</span></code><span class="koboSpan" id="kobo.1790.1"> method of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1791.1">OutputSendingService</span></code><span class="koboSpan" id="kobo.1792.1">. </span></p>
<h2 class="heading-2" id="_idParaDest-130"><a id="_idTextAnchor183"/><span class="koboSpan" id="kobo.1793.1">The Polly library</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1794.1">Resilient </span><a id="_idIndexMarker434"/><span class="koboSpan" id="kobo.1795.1">communication and, in general, resilient task execution can be implemented easily with the help of a .NET library called </span><strong class="keyWord"><span class="koboSpan" id="kobo.1796.1">Polly</span></strong><span class="koboSpan" id="kobo.1797.1">, whose project is a member of the .NET Foundation. </span><span class="koboSpan" id="kobo.1797.2">Polly is available through the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1798.1">Polly</span></code><span class="koboSpan" id="kobo.1799.1"> NuGet package.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1800.1">In Polly, you define policies and then execute tasks in the context of those policies, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1801.1">var</span></span><span class="koboSpan" id="kobo.1802.1"> myPolicy = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1803.1">Policy</span></span><span class="koboSpan" id="kobo.1804.1">
  .</span><span class="hljs-property"><span class="koboSpan" id="kobo.1805.1">Handle</span></span><span class="koboSpan" id="kobo.1806.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1807.1">HttpRequestException</span></span><span class="koboSpan" id="kobo.1808.1">&gt;()
  .</span><span class="hljs-property"><span class="koboSpan" id="kobo.1809.1">Or</span></span><span class="koboSpan" id="kobo.1810.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1811.1">OperationCanceledException</span></span><span class="koboSpan" id="kobo.1812.1">&gt;()
  .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1813.1">RetryAsync</span></span><span class="koboSpan" id="kobo.1814.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1815.1">3</span></span><span class="koboSpan" id="kobo.1816.1">);
....
</span><span class="koboSpan" id="kobo.1816.2">....
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1817.1">await</span></span><span class="koboSpan" id="kobo.1818.1"> myPolicy.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1819.1">ExecuteAsync</span></span><span class="koboSpan" id="kobo.1820.1">(</span><span class="hljs-function"><span class="koboSpan" id="kobo.1821.1">()=&gt;</span></span><span class="koboSpan" id="kobo.1822.1">{
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1823.1">//your code here</span></span><span class="koboSpan" id="kobo.1824.1">
});
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1825.1">The first part of each policy specifies the exceptions that must be handled. </span><span class="koboSpan" id="kobo.1825.2">Then, you specify what to do when one of those exceptions is captured. </span><span class="koboSpan" id="kobo.1825.3">In the preceding code, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1826.1">Execute</span></code><span class="koboSpan" id="kobo.1827.1"> method is retried up to three times if a failure is reported by either an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1828.1">HttpRequestException</span></code><span class="koboSpan" id="kobo.1829.1"> exception or an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1830.1">OperationCanceledException</span></code><span class="koboSpan" id="kobo.1831.1"> exception.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1832.1">The following is the implementation of an exponential retry policy:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1833.1">var</span></span><span class="koboSpan" id="kobo.1834.1"> retryPolicy= </span><span class="hljs-title"><span class="koboSpan" id="kobo.1835.1">Policy</span></span><span class="koboSpan" id="kobo.1836.1">
...
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1837.1">//Exceptions to handle here</span></span><span class="koboSpan" id="kobo.1838.1">
.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1839.1">WaitAndRetryAsync</span></span><span class="koboSpan" id="kobo.1840.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1841.1">6</span></span><span class="koboSpan" id="kobo.1842.1">,</span><span class="hljs-params"><span class="koboSpan" id="kobo.1843.1">retryAttempt</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1844.1"> =&gt;</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1845.1">TimeSpan</span></span><span class="koboSpan" id="kobo.1846.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1847.1">FromSeconds</span></span><span class="koboSpan" id="kobo.1848.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1849.1">Math</span></span><span class="koboSpan" id="kobo.1850.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1851.1">Pow</span></span><span class="koboSpan" id="kobo.1852.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1853.1">2</span></span><span class="koboSpan" id="kobo.1854.1">, retryAttempt)));
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1855.1">The first argument of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1856.1">WaitAndRetryAsync</span></code><span class="koboSpan" id="kobo.1857.1"> specifies that a maximum of six retries is performed in the event of failure. </span><span class="koboSpan" id="kobo.1857.2">The lambda function passed as the second argument specifies how much time to wait before the next attempt. </span><span class="koboSpan" id="kobo.1857.3">In this specific example, this time grows exponentially with the number of attempts by a power of 2 (two seconds for the first retry, four seconds for the second retry, and so on). </span><span class="koboSpan" id="kobo.1857.4">The following is a simple circuit breaker policy:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1858.1">var</span></span><span class="koboSpan" id="kobo.1859.1"> breakerPolicy =</span><span class="hljs-title"><span class="koboSpan" id="kobo.1860.1">Policy</span></span><span class="koboSpan" id="kobo.1861.1">
.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1862.1">Handle</span></span><span class="koboSpan" id="kobo.1863.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1864.1">SomeExceptionType</span></span><span class="koboSpan" id="kobo.1865.1">&gt;()
.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1866.1">CircuitBreakerAsync</span></span><span class="koboSpan" id="kobo.1867.1"> (</span><span class="hljs-number"><span class="koboSpan" id="kobo.1868.1">6</span></span><span class="koboSpan" id="kobo.1869.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.1870.1">TimeSpan</span></span><span class="koboSpan" id="kobo.1871.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1872.1">FromMinutes</span></span><span class="koboSpan" id="kobo.1873.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1874.1">1</span></span><span class="koboSpan" id="kobo.1875.1">));
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1876.1">After six failures, the task can’t be executed for one minute since an exception is returned.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1877.1">The following is the implementation of the Bulkhead Isolation policy:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-title"><span class="koboSpan" id="kobo.1878.1">Policy</span></span><span class="koboSpan" id="kobo.1879.1">
.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1880.1">BulkheadAsync</span></span><span class="koboSpan" id="kobo.1881.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1882.1">10</span></span><span class="koboSpan" id="kobo.1883.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1884.1">15</span></span><span class="koboSpan" id="kobo.1885.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1886.1">A maximum of 10 parallel executions is allowed in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1887.1">Execute</span></code><span class="koboSpan" id="kobo.1888.1"> method. </span><span class="koboSpan" id="kobo.1888.2">Further tasks are inserted in an execution queue. </span><span class="koboSpan" id="kobo.1888.3">This has a limit of 15 tasks. </span><span class="koboSpan" id="kobo.1888.4">If the queue limit is exceeded, an exception is thrown. </span><span class="koboSpan" id="kobo.1888.5">For the Bulkhead Isolation policy to work properly and, in general, for every strategy to </span><a id="_idIndexMarker435"/><span class="koboSpan" id="kobo.1889.1">work properly, task executions must be triggered through the same policy instance; otherwise, Polly is unable to count how many executions of a specific task are active.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1890.1">Policies can be combined with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1891.1">Wrap</span></code><span class="koboSpan" id="kobo.1892.1"> method:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1893.1">var</span></span><span class="koboSpan" id="kobo.1894.1"> combinedPolicy = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1895.1">Policy</span></span><span class="koboSpan" id="kobo.1896.1">
.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1897.1">WrapAsync</span></span><span class="koboSpan" id="kobo.1898.1">(retryPolicy, breakerPolicy);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1899.1">Polly offers several more options, such as generic methods for tasks that return a specific type, timeout policies, task result caching, the ability to define custom policies, and so on. </span><span class="koboSpan" id="kobo.1899.2">It is also possible to configure Polly as part of an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1900.1">HttpClient</span></code><span class="koboSpan" id="kobo.1901.1"> definition in the dependency injection section of any ASP. </span><span class="koboSpan" id="kobo.1901.2">NET Core and .NET application. </span><span class="koboSpan" id="kobo.1901.3">This way, it is quite immediate to define resilient HTTP clients. </span><span class="koboSpan" id="kobo.1901.4">Finally, version 8 also introduced a new API based on creating pipelines of strategies.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1902.1">Polly’s official documentation can be found in its GitHub repository here: </span><a href="https://github.com/App-vNext/Polly"><span class="url"><span class="koboSpan" id="kobo.1903.1">https://github.com/App-vNext/Polly</span></span></a><span class="koboSpan" id="kobo.1904.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1905.1">In the next subsection, we will install and use Polly for a resilient transmission of the microservices output messages to the message broker.</span></p>
<h2 class="heading-2" id="_idParaDest-131"><a id="_idTextAnchor184"/><span class="koboSpan" id="kobo.1906.1">Adding Polly to our project</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1907.1">Using Polly in our project is straightforward. </span><span class="koboSpan" id="kobo.1907.2">First of all, you must add a reference to the last version of </span><a id="_idIndexMarker436"/><span class="koboSpan" id="kobo.1908.1">the Polly NuGet package in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1909.1">RoutesPlanning</span></code><span class="koboSpan" id="kobo.1910.1"> project. </span><span class="koboSpan" id="kobo.1910.2">Then, you must modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1911.1">SendMessage</span></code><span class="koboSpan" id="kobo.1912.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1913.1">OutputSendingService</span></code><span class="koboSpan" id="kobo.1914.1"> class as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1915.1">protected  </span><span class="hljs-title"><span class="koboSpan" id="kobo.1916.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1917.1">SendMessage</span></span><span class="koboSpan" id="kobo.1918.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1919.1">RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.1920.1"> message)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1921.1">var</span></span><span class="koboSpan" id="kobo.1922.1"> retryPolicy = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1923.1">Policy</span></span><span class="koboSpan" id="kobo.1924.1">
            .</span><span class="hljs-property"><span class="koboSpan" id="kobo.1925.1">Handle</span></span><span class="koboSpan" id="kobo.1926.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1927.1">Exception</span></span><span class="koboSpan" id="kobo.1928.1">&gt;()
            .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1929.1">WaitAndRetryAsync</span></span><span class="koboSpan" id="kobo.1930.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1931.1">4</span></span><span class="koboSpan" id="kobo.1932.1">,
               </span><span class="hljs-params"><span class="koboSpan" id="kobo.1933.1">retryAttempt</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1934.1"> =&gt;</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1935.1">TimeSpan</span></span><span class="koboSpan" id="kobo.1936.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1937.1">FromSeconds</span></span><span class="koboSpan" id="kobo.1938.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1939.1">Math</span></span><span class="koboSpan" id="kobo.1940.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1941.1">Pow</span></span><span class="koboSpan" id="kobo.1942.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1943.1">1</span></span><span class="koboSpan" id="kobo.1944.1">,
                retryAttempt)));
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1945.1">var</span></span><span class="koboSpan" id="kobo.1946.1"> circuitBreakerPolicy = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1947.1">Policy</span></span><span class="koboSpan" id="kobo.1948.1">
        .</span><span class="hljs-property"><span class="koboSpan" id="kobo.1949.1">Handle</span></span><span class="koboSpan" id="kobo.1950.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.1951.1">Exception</span></span><span class="koboSpan" id="kobo.1952.1">&gt;()
        .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1953.1">CircuitBreakerAsync</span></span><span class="koboSpan" id="kobo.1954.1">(</span><span class="hljs-number"><span class="koboSpan" id="kobo.1955.1">4</span></span><span class="koboSpan" id="kobo.1956.1">, circuitBreakDelay);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1957.1">var</span></span><span class="koboSpan" id="kobo.1958.1"> combinedPolicy = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1959.1">Policy</span></span><span class="koboSpan" id="kobo.1960.1">
        .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1961.1">WrapAsync</span></span><span class="koboSpan" id="kobo.1962.1">(retryPolicy, circuitBreakerPolicy);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1963.1">return</span></span><span class="koboSpan" id="kobo.1964.1"> combinedPolicy.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1965.1">ExecuteAsync</span></span><span class="koboSpan" id="kobo.1966.1">(
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.1967.1">async</span></span><span class="koboSpan" id="kobo.1968.1"> () =&gt; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1969.1">await</span></span><span class="koboSpan" id="kobo.1970.1"> bus.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1971.1">PubSub</span></span><span class="koboSpan" id="kobo.1972.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1973.1">PublishAsync</span></span><span class="koboSpan" id="kobo.1974.1">&lt;
</span><span class="hljs-title"><span class="koboSpan" id="kobo.1975.1">RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.1976.1">&gt;(message));
    
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1977.1">We first define an exponential retry policy, then a circuit breaker policy, and finally combine them and </span><a id="_idIndexMarker437"/><span class="koboSpan" id="kobo.1978.1">execute the message sending inside </span><code class="inlineCode"><span class="koboSpan" id="kobo.1979.1">combinedPolicy.ExecuteAsync</span></code><span class="koboSpan" id="kobo.1980.1">. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1981.1">All strategies’ parameters could be s</span><a id="_idTextAnchor185"/><span class="koboSpan" id="kobo.1982.1">pecified with environment variables, but for simplicity, we left constant all values but </span><code class="inlineCode"><span class="koboSpan" id="kobo.1983.1">circuitBreakDelay</span></code><span class="koboSpan" id="kobo.1984.1">, that is, the time a circuit break should last. </span><span class="koboSpan" id="kobo.1984.2">In fact, this is the only critical parameter that might need to be tuned.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.1985.1">circuitBreakDelay</span></code><span class="koboSpan" id="kobo.1986.1"> can be configured in an environment variable in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1987.1">launchSettings.json</span></code><span class="koboSpan" id="kobo.1988.1"> as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.1989.1">"Timing:OutputCircuitBreakMin"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.1990.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1991.1">"4"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1992.1">Then, it can be defined as an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1993.1">OutputSendingService</span></code><span class="koboSpan" id="kobo.1994.1"> field with the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1995.1">readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.1996.1">TimeSpan</span></span><span class="koboSpan" id="kobo.1997.1"> circuitBreakDelay = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1998.1">TimeSpan</span></span><span class="koboSpan" id="kobo.1999.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.2000.1">FromMinutes</span></span><span class="koboSpan" id="kobo.2001.1">(
        configuration.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2002.1">GetValue</span></span><span class="koboSpan" id="kobo.2003.1">&lt;int&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2004.1">"Timing:OutputCircuitBreakMin"</span></span><span class="koboSpan" id="kobo.2005.1">));
</span></code></pre>
<h1 class="heading-1" id="_idParaDest-132"><a id="_idTextAnchor186"/><span class="koboSpan" id="kobo.2006.1">From abstraction to implementation details </span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2007.1">In the previous sections, we defined the overall organization of the route-planning microservice. </span><span class="koboSpan" id="kobo.2007.2">In this final section, we will fill in all the details by first defining the domain layer and the database driver, and then defining all commands. </span></p>
<h2 class="heading-2" id="_idParaDest-133"><a id="_idTextAnchor187"/><span class="koboSpan" id="kobo.2008.1">The domain layer</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2009.1">We will define </span><a id="_idIndexMarker438"/><span class="koboSpan" id="kobo.2010.1">each aggregate in a separate folder that will contain the aggregate, the interface that defines the aggregate state, and the repository interface associated with the aggregate. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.2011.1">However, before starting the definition of all aggregates, we need to add a famous library for handling both geometric and GIS calculations: </span><code class="inlineCode"><span class="koboSpan" id="kobo.2012.1">NetTopologySuite</span></code><span class="koboSpan" id="kobo.2013.1">. </span><span class="koboSpan" id="kobo.2013.2">It is available in both Java and .NET and all its types conform to a standard recognized by all main databases.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2014.1">The .NET version is available through the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2015.1">NetTopologySuite</span></code><span class="koboSpan" id="kobo.2016.1"> NuGet package. </span><span class="koboSpan" id="kobo.2016.2">Therefore, let’s add this package to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2017.1">RoutesPlanningDomainLayer</span></code><span class="koboSpan" id="kobo.2018.1"> project. </span><span class="koboSpan" id="kobo.2018.2">The meaning of GIS object coordinates is </span><a id="_idIndexMarker439"/><span class="koboSpan" id="kobo.2019.1">defined in documents classified with integers called </span><strong class="keyWord"><span class="koboSpan" id="kobo.2020.1">Spatial Reference Identifiers </span></strong><span class="koboSpan" id="kobo.2021.1">(</span><strong class="keyWord"><span class="koboSpan" id="kobo.2022.1">SRIDs</span></strong><span class="koboSpan" id="kobo.2023.1">). </span><span class="koboSpan" id="kobo.2023.2">Each document specifies the meaning of the </span><em class="italic"><span class="koboSpan" id="kobo.2024.1">x</span></em><span class="koboSpan" id="kobo.2025.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.2026.1">y</span></em><span class="koboSpan" id="kobo.2027.1"> coordinates, how to compute the distance between two points, and the part of the Earth’s surface it applies to. </span><span class="koboSpan" id="kobo.2027.2">Each GIS object must specify the SRID used by its coordinates, and only </span><a id="_idIndexMarker440"/><span class="koboSpan" id="kobo.2028.1">objects with the same SRID can be used in the same computation.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2029.1">We will use SRID 4326, which applies to the entire surface of the Earth. </span><code class="inlineCode"><span class="koboSpan" id="kobo.2030.1">X</span></code><span class="koboSpan" id="kobo.2031.1"> is the longitude in degrees and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2032.1">Y</span></code><span class="koboSpan" id="kobo.2033.1"> is the latitude in degrees; the distance is computed in meters by approximating the Earth’s surface with an ellipsoid. </span><span class="koboSpan" id="kobo.2033.2">More precise results can be obtained with SRIDs that apply to smaller portions of the Earth’s surface, but SRID 4326 is supported by all main databases.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2034.1">Let’s define our overall default SRID in a static class defined in the root of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2035.1">RoutesPlanningDomainLayer</span></code><span class="koboSpan" id="kobo.2036.1"> project:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2037.1">namespace </span><span class="hljs-title"><span class="koboSpan" id="kobo.2038.1">RoutesPlanningDomainLayer</span></span><span class="koboSpan" id="kobo.2039.1">
{
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2040.1">static</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2041.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2042.1">GeometryConstants</span></span><span class="koboSpan" id="kobo.2043.1">
    {
        public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2044.1">static</span></span><span class="koboSpan" id="kobo.2045.1"> int </span><span class="hljs-title"><span class="koboSpan" id="kobo.2046.1">DefaultSRID</span></span><span class="koboSpan" id="kobo.2047.1"> =&gt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.2048.1">4326</span></span><span class="koboSpan" id="kobo.2049.1">;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2050.1">As in the case of messages, we need intermediate types. </span><span class="koboSpan" id="kobo.2050.2">Let’s define them in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2051.1">RoutesPlanningDomainLayer -&gt; Models -&gt; BasicTypes</span></code><span class="koboSpan" id="kobo.2052.1"> folder:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.2053.1">Route status</span></strong><span class="koboSpan" id="kobo.2054.1">:
        </span><pre class="programlisting code-one"><code class="hljs-code"><span class="koboSpan" id="kobo.2055.1">public enum </span><span class="hljs-title"><span class="koboSpan" id="kobo.2056.1">RouteStatus</span></span><span class="koboSpan" id="kobo.2057.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.2058.1">Open</span></span><span class="koboSpan" id="kobo.2059.1">=</span><span class="hljs-number"><span class="koboSpan" id="kobo.2060.1">0</span></span><span class="koboSpan" id="kobo.2061.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2062.1">Closed</span></span><span class="koboSpan" id="kobo.2063.1">=</span><span class="hljs-number"><span class="koboSpan" id="kobo.2064.1">1</span></span><span class="koboSpan" id="kobo.2065.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2066.1">Aborted</span></span><span class="koboSpan" id="kobo.2067.1">=</span><span class="hljs-number"><span class="koboSpan" id="kobo.2068.1">2</span></span><span class="koboSpan" id="kobo.2069.1"> };
</span></code></pre>
</li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.2070.1">Time interval</span></strong><span class="koboSpan" id="kobo.2071.1">:
        </span><pre class="programlisting code-one"><code class="hljs-code"><span class="koboSpan" id="kobo.2072.1">public record </span><span class="hljs-title"><span class="koboSpan" id="kobo.2073.1">TimeInterval</span></span><span class="koboSpan" id="kobo.2074.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2075.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2076.1">Start</span></span><span class="koboSpan" id="kobo.2077.1"> { get; init; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2078.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2079.1">End</span></span><span class="koboSpan" id="kobo.2080.1"> { get; init; }   
}
</span></code></pre>
</li>
<li class="bulletList"><span class="koboSpan" id="kobo.2081.1">Town info:
        </span><pre class="programlisting code-one"><code class="hljs-code"><span class="koboSpan" id="kobo.2082.1">public record </span><span class="hljs-title"><span class="koboSpan" id="kobo.2083.1">TownBasicInfo</span></span><span class="koboSpan" id="kobo.2084.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2085.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2086.1">Id</span></span><span class="koboSpan" id="kobo.2087.1"> { get; init; }
    public string </span><span class="hljs-title"><span class="koboSpan" id="kobo.2088.1">Name</span></span><span class="koboSpan" id="kobo.2089.1"> { get; init; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2090.1">null</span></span><span class="koboSpan" id="kobo.2091.1">!;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2092.1">Point</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2093.1">Location</span></span><span class="koboSpan" id="kobo.2094.1"> { get; init; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2095.1">null</span></span><span class="koboSpan" id="kobo.2096.1">!;
}
</span></code></pre>
</li>
<li class="bulletList"><span class="koboSpan" id="kobo.2097.1">User info:
        </span><pre class="programlisting code-one"><code class="hljs-code"><span class="koboSpan" id="kobo.2098.1">public record </span><span class="hljs-title"><span class="koboSpan" id="kobo.2099.1">UserBasicInfo</span></span><span class="koboSpan" id="kobo.2100.1">()
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2101.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2102.1">Id</span></span><span class="koboSpan" id="kobo.2103.1"> { get; init; }
    public string </span><span class="hljs-title"><span class="koboSpan" id="kobo.2104.1">DisplayName</span></span><span class="koboSpan" id="kobo.2105.1"> { get; init; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2106.1">null</span></span><span class="koboSpan" id="kobo.2107.1">!;
}
</span></code></pre>
</li>
</ul>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.2108.1">Point</span></code><span class="koboSpan" id="kobo.2109.1"> is a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2110.1">NetTopologySuite</span></code><span class="koboSpan" id="kobo.2111.1"> type that specifies a point on the Earth’s surface. </span><span class="koboSpan" id="kobo.2111.2">Please note that all of the preceding types are what we called value objects in the </span><em class="italic"><span class="koboSpan" id="kobo.2112.1">The domain layer </span></em><span class="koboSpan" id="kobo.2113.1">subsection of</span><em class="italic"> </em><a href="Chapter_3.xhtml#_idTextAnchor067"><em class="italic"><span class="koboSpan" id="kobo.2114.1">Chapter 3</span></em></a><span class="koboSpan" id="kobo.2115.1">,</span><em class="italic"><span class="koboSpan" id="kobo.2116.1"> Setup and Theory: Docker and Onion Architecture</span></em><span class="koboSpan" id="kobo.2117.1">. </span><span class="koboSpan" id="kobo.2117.2">Therefore, as suggested there, we defined them as .NET record types.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2118.1">Now, we can start </span><a id="_idIndexMarker441"/><span class="koboSpan" id="kobo.2119.1">defining our aggregates. </span><span class="koboSpan" id="kobo.2119.2">For each of them, we will first define its status interface, then the aggregate, and finally, the associated repository interface. </span><span class="koboSpan" id="kobo.2119.3">Usually, the definition of all these data types is iterative; that is, we start with a first draft, and then, when we realize we need another property or method, we add it.</span></p>
<h3 class="heading-3" id="_idParaDest-134"><a id="_idTextAnchor188"/><span class="koboSpan" id="kobo.2120.1">The route request aggregate</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.2121.1">Let’s </span><a id="_idIndexMarker442"/><span class="koboSpan" id="kobo.2122.1">create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2123.1">Models -&gt; Request</span></code><span class="koboSpan" id="kobo.2124.1"> folder for all types related </span><a id="_idIndexMarker443"/><span class="koboSpan" id="kobo.2125.1">to a user request. </span><span class="koboSpan" id="kobo.2125.2">The status of a user request can be represented as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2126.1">public interface </span><span class="hljs-title"><span class="koboSpan" id="kobo.2127.1">IRouteRequestState</span></span><span class="koboSpan" id="kobo.2128.1">
{
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2129.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2130.1">Id</span></span><span class="koboSpan" id="kobo.2131.1"> { get; }
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2132.1">TownBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2133.1">Source</span></span><span class="koboSpan" id="kobo.2134.1"> { get; }
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2135.1">TownBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2136.1">Destination</span></span><span class="koboSpan" id="kobo.2137.1"> { get;  }
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2138.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2139.1">WhenStart</span></span><span class="koboSpan" id="kobo.2140.1"> { get; }
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2141.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2142.1">WhenEnd</span></span><span class="koboSpan" id="kobo.2143.1"> { get; }
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2144.1">UserBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2145.1">User</span></span><span class="koboSpan" id="kobo.2146.1"> { get; }
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2147.1">Guid</span></span><span class="koboSpan" id="kobo.2148.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.2149.1">RouteId</span></span><span class="koboSpan" id="kobo.2150.1"> { get; set; }
    public long </span><span class="hljs-title"><span class="koboSpan" id="kobo.2151.1">TimeStamp</span></span><span class="koboSpan" id="kobo.2152.1"> { get; set; }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2153.1">All properties that cannot be changed by aggregates have been defined as get-only properties. </span><code class="inlineCode"><span class="koboSpan" id="kobo.2154.1">Id</span></code><span class="koboSpan" id="kobo.2155.1"> uniquely identifies each request in the overall application. </span><code class="inlineCode"><span class="koboSpan" id="kobo.2156.1">Source</span></code><span class="koboSpan" id="kobo.2157.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2158.1">Destination</span></code><span class="koboSpan" id="kobo.2159.1"> are, respectively, the desired departure and arrival towns, while </span><code class="inlineCode"><span class="koboSpan" id="kobo.2160.1">WhenStart</span></code><span class="koboSpan" id="kobo.2161.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2162.1">WhenEnd</span></code><span class="koboSpan" id="kobo.2163.1"> define the acceptable days for travel. </span><span class="koboSpan" id="kobo.2163.2">Then, we have information on the user that issued the request and the current timestamp associated with the request. </span><span class="koboSpan" id="kobo.2163.3">Finally, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2164.1">RouteId</span></code><span class="koboSpan" id="kobo.2165.1"> is the unique identifier of the </span><a id="_idIndexMarker444"/><span class="koboSpan" id="kobo.2166.1">route that the request has been added to, if any. </span><span class="koboSpan" id="kobo.2166.2">If the </span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.2167.1">request is still open, this property is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2168.1">null</span></code><span class="koboSpan" id="kobo.2169.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2170.1">The aggregate can be defined as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2171.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2172.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2173.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.2174.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2175.1">IRouteRequestState</span></span><span class="koboSpan" id="kobo.2176.1"> state): 
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2177.1">Entity</span></span><span class="koboSpan" id="kobo.2178.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2179.1">Guid</span></span><span class="koboSpan" id="kobo.2180.1">&gt;
{
    public override </span><span class="hljs-title"><span class="koboSpan" id="kobo.2181.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2182.1">Id</span></span><span class="koboSpan" id="kobo.2183.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2184.1">Id</span></span><span class="koboSpan" id="kobo.2185.1">;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2186.1">TownBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2187.1">Source</span></span><span class="koboSpan" id="kobo.2188.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2189.1">Source</span></span><span class="koboSpan" id="kobo.2190.1">;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2191.1">TownBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2192.1">Destination</span></span><span class="koboSpan" id="kobo.2193.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2194.1">Destination</span></span><span class="koboSpan" id="kobo.2195.1">;
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2196.1">TimeInterval</span></span><span class="koboSpan" id="kobo.2197.1"> _When = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2198.1">null</span></span><span class="koboSpan" id="kobo.2199.1">!;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2200.1">TimeInterval</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2201.1">When</span></span><span class="koboSpan" id="kobo.2202.1"> =&gt; _When ?? 
        </span><span class="koboSpan" id="kobo.2202.2">(_When=</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2203.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2204.1">TimeInterval</span></span><span class="koboSpan" id="kobo.2205.1"> {</span><span class="hljs-title"><span class="koboSpan" id="kobo.2206.1">Start</span></span><span class="koboSpan" id="kobo.2207.1"> = state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2208.1">WhenStart</span></span><span class="koboSpan" id="kobo.2209.1">, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2210.1">End</span></span><span class="koboSpan" id="kobo.2211.1"> = state.
                                 </span><span class="hljs-property"><span class="koboSpan" id="kobo.2212.1">WhenEnd</span></span><span class="koboSpan" id="kobo.2213.1"> });    
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2214.1">UserBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2215.1">User</span></span><span class="koboSpan" id="kobo.2216.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2217.1">User</span></span><span class="koboSpan" id="kobo.2218.1">;
    public bool </span><span class="hljs-title"><span class="koboSpan" id="kobo.2219.1">Open</span></span><span class="koboSpan" id="kobo.2220.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2221.1">RouteId</span></span><span class="koboSpan" id="kobo.2222.1"> == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2223.1">null</span></span><span class="koboSpan" id="kobo.2224.1">; 
    public long </span><span class="hljs-title"><span class="koboSpan" id="kobo.2225.1">TimeStamp</span></span><span class="koboSpan" id="kobo.2226.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2227.1">TimeStamp</span></span><span class="koboSpan" id="kobo.2228.1">;
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2229.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2230.1">DetachFromRoute</span></span><span class="koboSpan" id="kobo.2231.1">() =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2232.1">RouteId</span></span><span class="koboSpan" id="kobo.2233.1"> = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2234.1">null</span></span><span class="koboSpan" id="kobo.2235.1">;
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2236.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2237.1">AttachToRoute</span></span><span class="koboSpan" id="kobo.2238.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2239.1">Guid</span></span><span class="koboSpan" id="kobo.2240.1"> routeId) =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2241.1">RouteId</span></span><span class="koboSpan" id="kobo.2242.1"> = routeId;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2243.1">It is worth pointing out that once a request has been created, only its </span><code class="inlineCode"><span class="koboSpan" id="kobo.2244.1">state.RouteId</span></code><span class="koboSpan" id="kobo.2245.1"> can be changed. </span><span class="koboSpan" id="kobo.2245.2">This is because once issued, each request cannot be modified but just matched with existing routes.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2246.1">The repository interface is as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2247.1">public interface </span><span class="hljs-title"><span class="koboSpan" id="kobo.2248.1">IRouteRequestRepository</span></span><span class="koboSpan" id="kobo.2249.1"> : </span><span class="hljs-title"><span class="koboSpan" id="kobo.2250.1">IRepository</span></span><span class="koboSpan" id="kobo.2251.1">
{
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2252.1">RouteRequestAggregate</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2253.1">New</span></span><span class="koboSpan" id="kobo.2254.1">(
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2255.1">Guid</span></span><span class="koboSpan" id="kobo.2256.1"> id,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2257.1">TownBasicInfo</span></span><span class="koboSpan" id="kobo.2258.1"> source, 
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2259.1">TownBasicInfo</span></span><span class="koboSpan" id="kobo.2260.1"> destination,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2261.1">TimeInterval</span></span><span class="koboSpan" id="kobo.2262.1"> when,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2263.1">UserBasicInfo</span></span><span class="koboSpan" id="kobo.2264.1"> user
        );
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2265.1">Task</span></span><span class="koboSpan" id="kobo.2266.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2267.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.2268.1">?&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2269.1">Get</span></span><span class="koboSpan" id="kobo.2270.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2271.1">Guid</span></span><span class="koboSpan" id="kobo.2272.1"> id);
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2273.1">Task</span></span><span class="koboSpan" id="kobo.2274.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2275.1">IList</span></span><span class="koboSpan" id="kobo.2276.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2277.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.2278.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2279.1">Get</span></span><span class="koboSpan" id="kobo.2280.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2281.1">Guid</span></span><span class="koboSpan" id="kobo.2282.1">[] ids);
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2283.1">Task</span></span><span class="koboSpan" id="kobo.2284.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2285.1">IList</span></span><span class="koboSpan" id="kobo.2286.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2287.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.2288.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2289.1">GetInRoute</span></span><span class="koboSpan" id="kobo.2290.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2291.1">Guid</span></span><span class="koboSpan" id="kobo.2292.1"> routeId);
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2293.1">Task</span></span><span class="koboSpan" id="kobo.2294.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2295.1">IList</span></span><span class="koboSpan" id="kobo.2296.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2297.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.2298.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2299.1">GetMatch</span></span><span class="koboSpan" id="kobo.2300.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2301.1">IEnumerable</span></span><span class="koboSpan" id="kobo.2302.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2303.1">Coordinate</span></span><span class="koboSpan" id="kobo.2304.1">&gt; 
        geometry, 
       </span><span class="hljs-title"><span class="koboSpan" id="kobo.2305.1">DateTime</span></span><span class="koboSpan" id="kobo.2306.1"> when, double distance, int maxResults);
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2307.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2308.1">DeleteBefore</span></span><span class="koboSpan" id="kobo.2309.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2310.1">DateTime</span></span><span class="koboSpan" id="kobo.2311.1"> milestone);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2312.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2313.1">New</span></code><span class="koboSpan" id="kobo.2314.1"> method creates a new instance of the aggregate and its database-attached state. </span><span class="koboSpan" id="kobo.2314.2">Then, we have </span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.2315.1">methods for getting a single or more existing aggregates from their </span><code class="inlineCode"><span class="koboSpan" id="kobo.2316.1">Id</span></code><span class="koboSpan" id="kobo.2317.1">, and all aggregates that are served by the same route.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2318.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2319.1">GetMatch</span></code><span class="koboSpan" id="kobo.2320.1"> method </span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.2321.1">returns </span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.2322.1">all aggregates that are the best match with a route. </span><span class="koboSpan" id="kobo.2322.2">The route is specified by the coordinates of the towns it passes through (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2323.1">geometry</span></code><span class="koboSpan" id="kobo.2324.1">), and by its date (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2325.1">When</span></code><span class="koboSpan" id="kobo.2326.1">). </span><code class="inlineCode"><span class="koboSpan" id="kobo.2327.1">Coordinate</span></code><span class="koboSpan" id="kobo.2328.1"> is a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2329.1">NetTopologySuite</span></code><span class="koboSpan" id="kobo.2330.1"> type that contains just the </span><em class="italic"><span class="koboSpan" id="kobo.2331.1">X</span></em><span class="koboSpan" id="kobo.2332.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.2333.1">Y</span></em><span class="koboSpan" id="kobo.2334.1"> coordinates of a location without its SRID (the default SRID defined before is implicit). </span><code class="inlineCode"><span class="koboSpan" id="kobo.2335.1">distance</span></code><span class="koboSpan" id="kobo.2336.1"> specifies the maximum distance between the request and a route for a match to occur. </span><span class="koboSpan" id="kobo.2336.2">All results are ordered according to their distance from the route, and a maximum of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2337.1">maxResults</span></code><span class="koboSpan" id="kobo.2338.1"> requests is returned.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2339.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2340.1">DeleteBefore</span></code><span class="koboSpan" id="kobo.2341.1"> method is used to perform some housekeeping by deleting old, expired requests.</span></p>
<h3 class="heading-3" id="_idParaDest-135"><a id="_idTextAnchor189"/><span class="koboSpan" id="kobo.2342.1">The route offer aggregate</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.2343.1">Let’s create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2344.1">Models -&gt; Route</span></code><span class="koboSpan" id="kobo.2345.1"> folder </span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.2346.1">for all types related to a user route </span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.2347.1">offer. </span><span class="koboSpan" id="kobo.2347.2">The status of a user request can be represented as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2348.1">public interface </span><span class="hljs-title"><span class="koboSpan" id="kobo.2349.1">IRouteOfferState</span></span><span class="koboSpan" id="kobo.2350.1">
{
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2351.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2352.1">Id</span></span><span class="koboSpan" id="kobo.2353.1"> { get; }
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2354.1">LineString</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2355.1">Path</span></span><span class="koboSpan" id="kobo.2356.1"> { get; set; }
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2357.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2358.1">When</span></span><span class="koboSpan" id="kobo.2359.1"> { get; }
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2360.1">UserBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2361.1">User</span></span><span class="koboSpan" id="kobo.2362.1"> { get; }
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2363.1">RouteStatus</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2364.1">Status</span></span><span class="koboSpan" id="kobo.2365.1"> { get; set; }
    public long </span><span class="hljs-title"><span class="koboSpan" id="kobo.2366.1">TimeStamp</span></span><span class="koboSpan" id="kobo.2367.1"> { get; set; }
}
</span></code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.2368.1">LineString</span></code><span class="koboSpan" id="kobo.2369.1"> is a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2370.1">NetTopologySuite</span></code><span class="koboSpan" id="kobo.2371.1"> type that represents a path made of consecutive segments on the Earth’s surface. </span><span class="koboSpan" id="kobo.2371.2">Basically, it is a sequence of coordinates with an attached SRID. </span><code class="inlineCode"><span class="koboSpan" id="kobo.2372.1">Status</span></code><span class="koboSpan" id="kobo.2373.1"> is the status of the route (open to other participants, closed, or aborted).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2374.1">The aggregate can be defined as follows: </span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2375.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2376.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2377.1">RouteOfferAggregate</span></span><span class="koboSpan" id="kobo.2378.1">
    (</span><span class="hljs-title"><span class="koboSpan" id="kobo.2379.1">IRouteOfferState</span></span><span class="koboSpan" id="kobo.2380.1"> state): </span><span class="hljs-title"><span class="koboSpan" id="kobo.2381.1">Entity</span></span><span class="koboSpan" id="kobo.2382.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2383.1">Guid</span></span><span class="koboSpan" id="kobo.2384.1">&gt;
{
    public override </span><span class="hljs-title"><span class="koboSpan" id="kobo.2385.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2386.1">Id</span></span><span class="koboSpan" id="kobo.2387.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2388.1">Id</span></span><span class="koboSpan" id="kobo.2389.1">;
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2390.1">IReadOnlyList</span></span><span class="koboSpan" id="kobo.2391.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2392.1">Coordinate</span></span><span class="koboSpan" id="kobo.2393.1">&gt;? </span><span class="koboSpan" id="kobo.2393.2">_Path=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.2394.1">null</span></span><span class="koboSpan" id="kobo.2395.1">;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2396.1">IReadOnlyList</span></span><span class="koboSpan" id="kobo.2397.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2398.1">Coordinate</span></span><span class="koboSpan" id="kobo.2399.1">&gt; </span><span class="hljs-params"><span class="koboSpan" id="kobo.2400.1">Path</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2401.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2402.1"> _Path != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2403.1">null</span></span><span class="koboSpan" id="kobo.2404.1"> ? </span><span class="koboSpan" id="kobo.2404.2">_Path : (
        _Path = state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2405.1">Path</span></span><span class="koboSpan" id="kobo.2406.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2407.1">Coordinates</span></span><span class="koboSpan" id="kobo.2408.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.2409.1">ToImmutableList</span></span><span class="koboSpan" id="kobo.2410.1">());
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2411.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2412.1">When</span></span><span class="koboSpan" id="kobo.2413.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2414.1">When</span></span><span class="koboSpan" id="kobo.2415.1">;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2416.1">UserBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2417.1">User</span></span><span class="koboSpan" id="kobo.2418.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2419.1">User</span></span><span class="koboSpan" id="kobo.2420.1">;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2421.1">RouteStatus</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2422.1">Status</span></span><span class="koboSpan" id="kobo.2423.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2424.1">Status</span></span><span class="koboSpan" id="kobo.2425.1">;
    public long </span><span class="hljs-title"><span class="koboSpan" id="kobo.2426.1">TimeStamp</span></span><span class="koboSpan" id="kobo.2427.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2428.1">TimeStamp</span></span><span class="koboSpan" id="kobo.2429.1">;
    …
    …
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2430.1">Here, dots have been added in place of methods we will analyze shortly. </span><span class="koboSpan" id="kobo.2430.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2431.1">LineString</span></code><span class="koboSpan" id="kobo.2432.1"> path contained in the </span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.2433.1">aggregate state is exposed as an immutable </span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.2434.1">list of its coordinates so that it can’t be modified directly, and can’t have its SRID changed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2435.1">It contains an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2436.1">Extend</span></code><span class="koboSpan" id="kobo.2437.1"> method that is called when a message requiring the extension of the route is received. </span><span class="koboSpan" id="kobo.2437.2">The data contained in the message is passed as its parameters:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2438.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2439.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2440.1">Extend</span></span><span class="koboSpan" id="kobo.2441.1">(long timestamp, 
</span><span class="hljs-title"><span class="koboSpan" id="kobo.2442.1">IEnumerable</span></span><span class="koboSpan" id="kobo.2443.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2444.1">Guid</span></span><span class="koboSpan" id="kobo.2445.1">&gt; addedRequests, 
</span><span class="hljs-title"><span class="koboSpan" id="kobo.2446.1">Coordinate</span></span><span class="koboSpan" id="kobo.2447.1">[] newRoute, bool closed)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2448.1">if</span></span><span class="koboSpan" id="kobo.2449.1"> (timestamp &gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2450.1">TimeStamp</span></span><span class="koboSpan" id="kobo.2451.1">)
    {
        state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2452.1">Path</span></span><span class="koboSpan" id="kobo.2453.1"> = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2454.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2455.1">LineString</span></span><span class="koboSpan" id="kobo.2456.1">(newRoute)
            { </span><span class="hljs-variable"><span class="koboSpan" id="kobo.2457.1">SRID</span></span><span class="koboSpan" id="kobo.2458.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.2459.1">GeometryConstants</span></span><span class="koboSpan" id="kobo.2460.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2461.1">DefaultSRID</span></span><span class="koboSpan" id="kobo.2462.1"> };
        _Path = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2463.1">null</span></span><span class="koboSpan" id="kobo.2464.1">;
        state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2465.1">TimeStamp</span></span><span class="koboSpan" id="kobo.2466.1"> = timestamp;
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2467.1">if</span></span><span class="koboSpan" id="kobo.2468.1">(state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2469.1">Status</span></span><span class="koboSpan" id="kobo.2470.1"> != </span><span class="hljs-title"><span class="koboSpan" id="kobo.2471.1">RouteStatus</span></span><span class="koboSpan" id="kobo.2472.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2473.1">Aborted</span></span><span class="koboSpan" id="kobo.2474.1">)
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2475.1">AddDomainEvent</span></span><span class="koboSpan" id="kobo.2476.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2477.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2478.1">AttachedRequestEvent</span></span><span class="koboSpan" id="kobo.2479.1"> { 
            </span><span class="hljs-title"><span class="koboSpan" id="kobo.2480.1">AddedRequests</span></span><span class="koboSpan" id="kobo.2481.1"> = addedRequests,
            </span><span class="hljs-title"><span class="koboSpan" id="kobo.2482.1">RouteOffer</span></span><span class="koboSpan" id="kobo.2483.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.2484.1">Id</span></span><span class="koboSpan" id="kobo.2485.1">
        });
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2486.1">Close</span></span><span class="koboSpan" id="kobo.2487.1">();
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2488.1">The path is updated only if it is more recent than the path stored in the aggregate, while the requests contained in the extension message are always attached to the route offer, because each message doesn’t contain all matched requests but just the newly added ones, so they must also be added if we received an old message. </span><span class="koboSpan" id="kobo.2488.2">The only case when the requests must not be added is when </span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.2489.1">the route has already been aborted, because aborted routes release all their attached requests.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2490.1">The task of </span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.2491.1">attaching the requests to the aggregate is left to an event handler for better modularity. </span><span class="koboSpan" id="kobo.2491.2">Thus, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2492.1">Extend</span></code><span class="koboSpan" id="kobo.2493.1"> method adds an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2494.1">AttachedRequestEvent</span></code><span class="koboSpan" id="kobo.2495.1"> event to the aggregate list of events. </span><span class="koboSpan" id="kobo.2495.2">The event definition must be placed in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2496.1">Events</span></code><span class="koboSpan" id="kobo.2497.1"> folder and is defined as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2498.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2499.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2500.1">AttachedRequestEvent</span></span><span class="koboSpan" id="kobo.2501.1"> : </span><span class="hljs-title"><span class="koboSpan" id="kobo.2502.1">IEventNotification</span></span><span class="koboSpan" id="kobo.2503.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2504.1">IEnumerable</span></span><span class="koboSpan" id="kobo.2505.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2506.1">Guid</span></span><span class="koboSpan" id="kobo.2507.1">&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2508.1">AddedRequests</span></span><span class="koboSpan" id="kobo.2509.1"> { get; set; } = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2510.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2511.1">List</span></span><span class="koboSpan" id="kobo.2512.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2513.1">Guid</span></span><span class="koboSpan" id="kobo.2514.1">&gt;();
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2515.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2516.1">RouteOffer</span></span><span class="koboSpan" id="kobo.2517.1"> { get; set; } 
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2518.1">Finally, if the extension message declares the route closed, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2519.1">Extend</span></code><span class="koboSpan" id="kobo.2520.1"> method closes it by calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2521.1">Close()</span></code><span class="koboSpan" id="kobo.2522.1"> method, which is defined as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2523.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2524.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2525.1">Close</span></span><span class="koboSpan" id="kobo.2526.1">()
{
    state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2527.1">Status</span></span><span class="koboSpan" id="kobo.2528.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.2529.1">RouteStatus</span></span><span class="koboSpan" id="kobo.2530.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2531.1">Closed</span></span><span class="koboSpan" id="kobo.2532.1">;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2533.1">There is also an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2534.1">Abort</span></code><span class="koboSpan" id="kobo.2535.1"> method, which declares the route aborted:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2536.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2537.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2538.1">Abort</span></span><span class="koboSpan" id="kobo.2539.1">()
{
    state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2540.1">Status</span></span><span class="koboSpan" id="kobo.2541.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.2542.1">RouteStatus</span></span><span class="koboSpan" id="kobo.2543.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2544.1">Aborted</span></span><span class="koboSpan" id="kobo.2545.1">;
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2546.1">AddDomainEvent</span></span><span class="koboSpan" id="kobo.2547.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2548.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2549.1">ReleasedRequestsEvent</span></span><span class="koboSpan" id="kobo.2550.1">
    {
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2551.1">AbortedRoute</span></span><span class="koboSpan" id="kobo.2552.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.2553.1">Id</span></span><span class="koboSpan" id="kobo.2554.1">
    });
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2555.1">It sets the aggregate status to aborted and then leaves the task of releasing all attached requests to an event handler for better modularity, with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2556.1">ReleasedRequestsEvent</span></code><span class="koboSpan" id="kobo.2557.1"> event:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2558.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2559.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2560.1">ReleasedRequestsEvent</span></span><span class="koboSpan" id="kobo.2561.1">:</span><span class="hljs-title"><span class="koboSpan" id="kobo.2562.1">IEventNotification</span></span><span class="koboSpan" id="kobo.2563.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2564.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2565.1">AbortedRoute</span></span><span class="koboSpan" id="kobo.2566.1"> {  get; set; }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2567.1">Let’s move </span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.2568.1">on to the repository interface:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2569.1">public interface </span><span class="hljs-title"><span class="koboSpan" id="kobo.2570.1">IRouteOfferRepository</span></span><span class="koboSpan" id="kobo.2571.1"> : </span><span class="hljs-title"><span class="koboSpan" id="kobo.2572.1">IRepository</span></span><span class="koboSpan" id="kobo.2573.1">
{
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2574.1">RouteOfferAggregate</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2575.1">New</span></span><span class="koboSpan" id="kobo.2576.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2577.1">Guid</span></span><span class="koboSpan" id="kobo.2578.1"> id, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2579.1">Coordinate</span></span><span class="koboSpan" id="kobo.2580.1">[] path, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2581.1">UserBasicInfo</span></span><span class="koboSpan" id="kobo.2582.1"> 
        user, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2583.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2584.1">When</span></span><span class="koboSpan" id="kobo.2585.1">);
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2586.1">Task</span></span><span class="koboSpan" id="kobo.2587.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2588.1">RouteOfferAggregate</span></span><span class="koboSpan" id="kobo.2589.1">?&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2590.1">Get</span></span><span class="koboSpan" id="kobo.2591.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2592.1">Guid</span></span><span class="koboSpan" id="kobo.2593.1"> id);
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2594.1">Task</span></span><span class="koboSpan" id="kobo.2595.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2596.1">IList</span></span><span class="koboSpan" id="kobo.2597.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2598.1">RouteOfferAggregate</span></span><span class="koboSpan" id="kobo.2599.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2600.1">GetMatch</span></span><span class="koboSpan" id="kobo.2601.1">(
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.2602.1">Point</span></span><span class="koboSpan" id="kobo.2603.1"> source, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2604.1">Point</span></span><span class="koboSpan" id="kobo.2605.1"> destination, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2606.1">TimeInterval</span></span><span class="koboSpan" id="kobo.2607.1"> when, 
        double distance, int maxResults);
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2608.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2609.1">DeleteBefore</span></span><span class="koboSpan" id="kobo.2610.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2611.1">DateTime</span></span><span class="koboSpan" id="kobo.2612.1"> milestone);
} 
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2613.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2614.1">New</span></code><span class="koboSpan" id="kobo.2615.1"> method creates </span><a id="_idIndexMarker456"/><span class="koboSpan" id="kobo.2616.1">a new aggregate, then we have a method to get an aggregate from its unique identifier. </span><span class="koboSpan" id="kobo.2616.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2617.1">GetMatch</span></code><span class="koboSpan" id="kobo.2618.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2619.1">DeleteBefore</span></code><span class="koboSpan" id="kobo.2620.1"> methods are completely analogous to the one of requests, but in this case, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2621.1">GetMatch</span></code><span class="koboSpan" id="kobo.2622.1"> returns all route offers matching a given request.</span></p>
<h3 class="heading-3" id="_idParaDest-136"><a id="_idTextAnchor190"/><span class="koboSpan" id="kobo.2623.1">The output queue item aggregate</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.2624.1">This aggregate </span><a id="_idIndexMarker457"/><span class="koboSpan" id="kobo.2625.1">represents a generic output queue item. </span><span class="koboSpan" id="kobo.2625.2">Files will </span><a id="_idIndexMarker458"/><span class="koboSpan" id="kobo.2626.1">be placed in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2627.1">Models -&gt; OutputQueue</span></code><span class="koboSpan" id="kobo.2628.1"> folder. </span><span class="koboSpan" id="kobo.2628.2">The aggregate state can be defined as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2629.1">public  interface </span><span class="hljs-title"><span class="koboSpan" id="kobo.2630.1">IQueueItemState</span></span><span class="koboSpan" id="kobo.2631.1">
{
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2632.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2633.1">Id</span></span><span class="koboSpan" id="kobo.2634.1"> { get; }
    int </span><span class="hljs-title"><span class="koboSpan" id="kobo.2635.1">MessageCode</span></span><span class="koboSpan" id="kobo.2636.1"> { get; }
    public string </span><span class="hljs-title"><span class="koboSpan" id="kobo.2637.1">MessageContent</span></span><span class="koboSpan" id="kobo.2638.1"> { get; }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2639.1">Each queue item has a unique ID and a message code that specifies which message type is stored in the item. </span><span class="koboSpan" id="kobo.2639.2">While the message content is the JSON representation of the output messages. </span><span class="koboSpan" id="kobo.2639.3">The aggregate is trivial:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2640.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2641.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2642.1">QueueItem</span></span><span class="koboSpan" id="kobo.2643.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2644.1">IQueueItemState</span></span><span class="koboSpan" id="kobo.2645.1"> state): </span><span class="hljs-title"><span class="koboSpan" id="kobo.2646.1">Entity</span></span><span class="koboSpan" id="kobo.2647.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2648.1">Guid</span></span><span class="koboSpan" id="kobo.2649.1">&gt;
{
    public override </span><span class="hljs-title"><span class="koboSpan" id="kobo.2650.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2651.1">Id</span></span><span class="koboSpan" id="kobo.2652.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2653.1">Id</span></span><span class="koboSpan" id="kobo.2654.1">;
    public int </span><span class="hljs-title"><span class="koboSpan" id="kobo.2655.1">MessageCode</span></span><span class="koboSpan" id="kobo.2656.1"> =&gt; state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2657.1">MessageCode</span></span><span class="koboSpan" id="kobo.2658.1">;
    public T? </span><span class="hljs-title"><span class="koboSpan" id="kobo.2659.1">GetMessage</span></span><span class="koboSpan" id="kobo.2660.1">&lt;T&gt;() 
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2661.1">if</span></span><span class="koboSpan" id="kobo.2662.1"> (string.</span><span class="hljs-title"><span class="koboSpan" id="kobo.2663.1">IsNullOrWhiteSpace</span></span><span class="koboSpan" id="kobo.2664.1">(state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2665.1">MessageContent</span></span><span class="koboSpan" id="kobo.2666.1">)) 
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2667.1">return</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2668.1">default</span></span><span class="koboSpan" id="kobo.2669.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2670.1">return</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2671.1">JsonSerializer</span></span><span class="koboSpan" id="kobo.2672.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2673.1">Deserialize</span></span><span class="koboSpan" id="kobo.2674.1">&lt;T&gt;(state.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2675.1">MessageContent</span></span><span class="koboSpan" id="kobo.2676.1">);
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2677.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2678.1">GetMessage</span></code><span class="koboSpan" id="kobo.2679.1"> method </span><a id="_idIndexMarker459"/><span class="koboSpan" id="kobo.2680.1">deserializes the message contained in the item.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2681.1">Finally, the repository interface is as follows: </span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2682.1">public interface </span><span class="hljs-title"><span class="koboSpan" id="kobo.2683.1">IOutputQueueRepository</span></span><span class="koboSpan" id="kobo.2684.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.2685.1">IRepository</span></span><span class="koboSpan" id="kobo.2686.1">
{
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2687.1">Task</span></span><span class="koboSpan" id="kobo.2688.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2689.1">IList</span></span><span class="koboSpan" id="kobo.2690.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2691.1">QueueItem</span></span><span class="koboSpan" id="kobo.2692.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2693.1">Take</span></span><span class="koboSpan" id="kobo.2694.1">(int N, </span><span class="hljs-title"><span class="koboSpan" id="kobo.2695.1">TimeSpan</span></span><span class="koboSpan" id="kobo.2696.1"> requeueAfter);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2697.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2698.1">Confirm</span></span><span class="koboSpan" id="kobo.2699.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2700.1">Guid</span></span><span class="koboSpan" id="kobo.2701.1">[] ids);
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.2702.1">QueueItem</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2703.1">New</span></span><span class="koboSpan" id="kobo.2704.1">&lt;T&gt;(T item, int messageCode);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2705.1">Each queue </span><a id="_idIndexMarker460"/><span class="koboSpan" id="kobo.2706.1">item has a time attached to it, and an item can be extracted </span><a id="_idIndexMarker461"/><span class="koboSpan" id="kobo.2707.1">by the queue only after this time expires. </span><span class="koboSpan" id="kobo.2707.2">Moreover, queue items are extracted in increasing time order.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2708.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2709.1">Take</span></code><span class="koboSpan" id="kobo.2710.1"> method extracts the first </span><code class="inlineCode"><span class="koboSpan" id="kobo.2711.1">N</span></code><span class="koboSpan" id="kobo.2712.1"> items from the queue and then immediately requeues them by replacing their time with the time of their extraction plus the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2713.1">requeueAfter</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.2714.1">TimeSpan</span></code><span class="koboSpan" id="kobo.2715.1">. </span><span class="koboSpan" id="kobo.2715.2">This way, if messages are successfully sent before </span><code class="inlineCode"><span class="koboSpan" id="kobo.2716.1">requeueAfter</span></code><span class="koboSpan" id="kobo.2717.1">, they are removed from the queue; otherwise, they become available for extraction from the queue again, and their transmission is retried.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2718.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2719.1">Confirm</span></code><span class="koboSpan" id="kobo.2720.1"> method deletes all successfully sent messages, while the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2721.1">New</span></code><span class="koboSpan" id="kobo.2722.1"> method adds a new item to the output queue.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2723.1">Now, we can move on to the implementation of all aggregate states with Entity Framework entities and to the implementation of all repositories.</span></p>
<h2 class="heading-2" id="_idParaDest-137"><a id="_idTextAnchor191"/><span class="koboSpan" id="kobo.2724.1">The database driver</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2725.1">Before getting </span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.2726.1">started with the implementation of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2727.1">RoutesPlanningDBDriver</span></code><span class="koboSpan" id="kobo.2728.1"> driver, we must add a reference to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2729.1">Microsoft.EntityFrameworkCore.SqlServer.NetTopologySuite</span></code><span class="koboSpan" id="kobo.2730.1"> NuGet package, which adds support for all </span><code class="inlineCode"><span class="koboSpan" id="kobo.2731.1">NetTopolgySuite</span></code><span class="koboSpan" id="kobo.2732.1"> types to Entity Framework Core. </span><span class="koboSpan" id="kobo.2732.2">Then, we must declare the usage of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2733.1">NetTopolgySuite</span></code><span class="koboSpan" id="kobo.2734.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2735.1">Extensions -&gt; DBExtensions.cs</span></code><span class="koboSpan" id="kobo.2736.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2737.1">options.</span><span class="hljs-title"><span class="koboSpan" id="kobo.2738.1">UseSqlServer</span></span><span class="koboSpan" id="kobo.2739.1">(connectionString, 
    </span><span class="hljs-params"><span class="koboSpan" id="kobo.2740.1">b</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2741.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2742.1"> {
        b.</span><span class="hljs-title"><span class="koboSpan" id="kobo.2743.1">MigrationsAssembly</span></span><span class="koboSpan" id="kobo.2744.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2745.1">"DBDriver"</span></span><span class="koboSpan" id="kobo.2746.1">);
       </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2747.1">// added code</span></span><span class="koboSpan" id="kobo.2748.1">
        b.</span><span class="hljs-title"><span class="koboSpan" id="kobo.2749.1">UseNetTopologySuite</span></span><span class="koboSpan" id="kobo.2750.1">();
     }));
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2751.1">Now, we can define </span><a id="_idIndexMarker463"/><span class="koboSpan" id="kobo.2752.1">all the entities we need in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2753.1">Entities</span></code><span class="koboSpan" id="kobo.2754.1"> folder:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2755.1">Route offer:
        </span><pre class="programlisting code-one"><code class="hljs-code"><span class="koboSpan" id="kobo.2756.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2757.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2758.1">RouteOffer</span></span><span class="koboSpan" id="kobo.2759.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.2760.1">IRouteOfferState</span></span><span class="koboSpan" id="kobo.2761.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2762.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2763.1">Id</span></span><span class="koboSpan" id="kobo.2764.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2765.1">LineString</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2766.1">Path</span></span><span class="koboSpan" id="kobo.2767.1"> { get; set; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2768.1">null</span></span><span class="koboSpan" id="kobo.2769.1">!;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2770.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2771.1">When</span></span><span class="koboSpan" id="kobo.2772.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2773.1">UserBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2774.1">User</span></span><span class="koboSpan" id="kobo.2775.1"> { get; set; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2776.1">null</span></span><span class="koboSpan" id="kobo.2777.1">!;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2778.1">RouteStatus</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2779.1">Status</span></span><span class="koboSpan" id="kobo.2780.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2781.1">ICollection</span></span><span class="koboSpan" id="kobo.2782.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2783.1">RouteRequest</span></span><span class="koboSpan" id="kobo.2784.1">&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2785.1">Requests</span></span><span class="koboSpan" id="kobo.2786.1"> { get; set; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2787.1">null</span></span><span class="koboSpan" id="kobo.2788.1">!;
    public long </span><span class="hljs-title"><span class="koboSpan" id="kobo.2789.1">TimeStamp</span></span><span class="koboSpan" id="kobo.2790.1"> { get; set; }
}
</span></code></pre>
</li>
<li class="bulletList"><span class="koboSpan" id="kobo.2791.1">Route request:
        </span><pre class="programlisting code-one"><code class="hljs-code"><span class="koboSpan" id="kobo.2792.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2793.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2794.1">RouteRequest</span></span><span class="koboSpan" id="kobo.2795.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.2796.1">IRouteRequestState</span></span><span class="koboSpan" id="kobo.2797.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2798.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2799.1">Id</span></span><span class="koboSpan" id="kobo.2800.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2801.1">TownBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2802.1">Source</span></span><span class="koboSpan" id="kobo.2803.1"> { get; set; }=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.2804.1">null</span></span><span class="koboSpan" id="kobo.2805.1">!;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2806.1">TownBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2807.1">Destination</span></span><span class="koboSpan" id="kobo.2808.1"> { get; set; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2809.1">null</span></span><span class="koboSpan" id="kobo.2810.1">!;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2811.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2812.1">WhenStart</span></span><span class="koboSpan" id="kobo.2813.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2814.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2815.1">WhenEnd</span></span><span class="koboSpan" id="kobo.2816.1"> { get; set; }
    public long </span><span class="hljs-title"><span class="koboSpan" id="kobo.2817.1">TimeStamp</span></span><span class="koboSpan" id="kobo.2818.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2819.1">UserBasicInfo</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2820.1">User</span></span><span class="koboSpan" id="kobo.2821.1"> { get; set; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2822.1">null</span></span><span class="koboSpan" id="kobo.2823.1">!;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2824.1">Guid</span></span><span class="koboSpan" id="kobo.2825.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.2826.1">RouteId</span></span><span class="koboSpan" id="kobo.2827.1"> { get; set; }
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2828.1">RouteOffer</span></span><span class="koboSpan" id="kobo.2829.1">? </span><span class="hljs-title"><span class="koboSpan" id="kobo.2830.1">Route</span></span><span class="koboSpan" id="kobo.2831.1"> { get; set; }
    
}
</span></code></pre>
</li>
<li class="bulletList"><span class="koboSpan" id="kobo.2832.1">Queue item:
        </span><pre class="programlisting code-one"><code class="hljs-code"><span class="koboSpan" id="kobo.2833.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2834.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2835.1">OutputQueueItem</span></span><span class="koboSpan" id="kobo.2836.1">: </span><span class="hljs-title"><span class="koboSpan" id="kobo.2837.1">IQueueItemState</span></span><span class="koboSpan" id="kobo.2838.1">
{
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2839.1">Guid</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2840.1">Id</span></span><span class="koboSpan" id="kobo.2841.1"> { get; set; }
    public int </span><span class="hljs-title"><span class="koboSpan" id="kobo.2842.1">MessageCode</span></span><span class="koboSpan" id="kobo.2843.1"> { get; set; }
    public string </span><span class="hljs-title"><span class="koboSpan" id="kobo.2844.1">MessageContent</span></span><span class="koboSpan" id="kobo.2845.1"> { get; set; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2846.1">null</span></span><span class="koboSpan" id="kobo.2847.1">!;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2848.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2849.1">ReadyTime</span></span><span class="koboSpan" id="kobo.2850.1"> { get; set; }
}
</span></code></pre>
</li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2851.1">Then, in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2852.1">MainDBContext.cs</span></code><span class="koboSpan" id="kobo.2853.1"> file, we must add the corresponding collections:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2854.1">public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2855.1">DbSet</span></span><span class="koboSpan" id="kobo.2856.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2857.1">RouteRequest</span></span><span class="koboSpan" id="kobo.2858.1">&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2859.1">RouteRequests</span></span><span class="koboSpan" id="kobo.2860.1"> { get; set; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2861.1">null</span></span><span class="koboSpan" id="kobo.2862.1">!;
public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2863.1">DbSet</span></span><span class="koboSpan" id="kobo.2864.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2865.1">RouteOffer</span></span><span class="koboSpan" id="kobo.2866.1">&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2867.1">RouteOffers</span></span><span class="koboSpan" id="kobo.2868.1"> { get; set; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2869.1">null</span></span><span class="koboSpan" id="kobo.2870.1">!;
public </span><span class="hljs-title"><span class="koboSpan" id="kobo.2871.1">DbSet</span></span><span class="koboSpan" id="kobo.2872.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2873.1">OutputQueueItem</span></span><span class="koboSpan" id="kobo.2874.1">&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.2875.1">OutputQueueItems</span></span><span class="koboSpan" id="kobo.2876.1"> { get; set; } = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2877.1">null</span></span><span class="koboSpan" id="kobo.2878.1">!;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2879.1">Finally, in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2880.1">OnModelCreating</span></code><span class="koboSpan" id="kobo.2881.1"> method of </span><a id="_idIndexMarker464"/><span class="koboSpan" id="kobo.2882.1">the same file, we must </span><a id="_idIndexMarker465"/><span class="koboSpan" id="kobo.2883.1">declare the relationship between </span><code class="inlineCode"><span class="koboSpan" id="kobo.2884.1">RouteOffer</span></code><span class="koboSpan" id="kobo.2885.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2886.1">RouteRequest</span></code><span class="koboSpan" id="kobo.2887.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2888.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2889.1">Entity</span></span><span class="koboSpan" id="kobo.2890.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2891.1">RouteOffer</span></span><span class="koboSpan" id="kobo.2892.1">&gt;().</span><span class="hljs-title"><span class="koboSpan" id="kobo.2893.1">HasMany</span></span><span class="koboSpan" id="kobo.2894.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2895.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2896.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2897.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2898.1">Requests</span></span><span class="koboSpan" id="kobo.2899.1">)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.2900.1">WithOne</span></span><span class="koboSpan" id="kobo.2901.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2902.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2903.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2904.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2905.1">Route</span></span><span class="koboSpan" id="kobo.2906.1">)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.2907.1">HasForeignKey</span></span><span class="koboSpan" id="kobo.2908.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2909.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2910.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2911.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2912.1">RouteId</span></span><span class="koboSpan" id="kobo.2913.1">)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.2914.1">OnDelete</span></span><span class="koboSpan" id="kobo.2915.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2916.1">DeleteBehavior</span></span><span class="koboSpan" id="kobo.2917.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2918.1">Cascade</span></span><span class="koboSpan" id="kobo.2919.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2920.1">We must also declare some indices and the usage of value objects (with their indices) with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2921.1">OwnsOne</span></code><span class="koboSpan" id="kobo.2922.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2923.1">builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2924.1">Entity</span></span><span class="koboSpan" id="kobo.2925.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2926.1">RouteRequest</span></span><span class="koboSpan" id="kobo.2927.1">&gt;().</span><span class="hljs-title"><span class="koboSpan" id="kobo.2928.1">OwnsOne</span></span><span class="koboSpan" id="kobo.2929.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2930.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2931.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2932.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2933.1">Source</span></span><span class="koboSpan" id="kobo.2934.1">);
builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2935.1">Entity</span></span><span class="koboSpan" id="kobo.2936.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2937.1">RouteRequest</span></span><span class="koboSpan" id="kobo.2938.1">&gt;().</span><span class="hljs-title"><span class="koboSpan" id="kobo.2939.1">OwnsOne</span></span><span class="koboSpan" id="kobo.2940.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2941.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2942.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2943.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2944.1">Destination</span></span><span class="koboSpan" id="kobo.2945.1">);
builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2946.1">Entity</span></span><span class="koboSpan" id="kobo.2947.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2948.1">RouteRequest</span></span><span class="koboSpan" id="kobo.2949.1">&gt;().</span><span class="hljs-title"><span class="koboSpan" id="kobo.2950.1">OwnsOne</span></span><span class="koboSpan" id="kobo.2951.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2952.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2953.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2954.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2955.1">User</span></span><span class="koboSpan" id="kobo.2956.1">);
builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2957.1">Entity</span></span><span class="koboSpan" id="kobo.2958.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2959.1">RouteRequest</span></span><span class="koboSpan" id="kobo.2960.1">&gt;().</span><span class="hljs-title"><span class="koboSpan" id="kobo.2961.1">HasIndex</span></span><span class="koboSpan" id="kobo.2962.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2963.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2964.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2965.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2966.1">WhenStart</span></span><span class="koboSpan" id="kobo.2967.1">);
builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2968.1">Entity</span></span><span class="koboSpan" id="kobo.2969.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2970.1">RouteRequest</span></span><span class="koboSpan" id="kobo.2971.1">&gt;().</span><span class="hljs-title"><span class="koboSpan" id="kobo.2972.1">HasIndex</span></span><span class="koboSpan" id="kobo.2973.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2974.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2975.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2976.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2977.1">WhenEnd</span></span><span class="koboSpan" id="kobo.2978.1">);
builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2979.1">Entity</span></span><span class="koboSpan" id="kobo.2980.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2981.1">RouteOffer</span></span><span class="koboSpan" id="kobo.2982.1">&gt;().</span><span class="hljs-title"><span class="koboSpan" id="kobo.2983.1">OwnsOne</span></span><span class="koboSpan" id="kobo.2984.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2985.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2986.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2987.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2988.1">User</span></span><span class="koboSpan" id="kobo.2989.1">);
builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2990.1">Entity</span></span><span class="koboSpan" id="kobo.2991.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.2992.1">RouteOffer</span></span><span class="koboSpan" id="kobo.2993.1">&gt;().</span><span class="hljs-title"><span class="koboSpan" id="kobo.2994.1">HasIndex</span></span><span class="koboSpan" id="kobo.2995.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2996.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.2997.1"> =&gt;</span></span><span class="koboSpan" id="kobo.2998.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.2999.1">When</span></span><span class="koboSpan" id="kobo.3000.1">);
builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3001.1">Entity</span></span><span class="koboSpan" id="kobo.3002.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3003.1">RouteOffer</span></span><span class="koboSpan" id="kobo.3004.1">&gt;().</span><span class="hljs-title"><span class="koboSpan" id="kobo.3005.1">HasIndex</span></span><span class="koboSpan" id="kobo.3006.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3007.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3008.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3009.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3010.1">Status</span></span><span class="koboSpan" id="kobo.3011.1">);
builde</span><a id="_idTextAnchor192"/><span class="koboSpan" id="kobo.3012.1">r.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3013.1">Entity</span></span><span class="koboSpan" id="kobo.3014.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3015.1">OutputQueueItem</span></span><span class="koboSpan" id="kobo.3016.1">&gt;().</span><span class="hljs-title"><span class="koboSpan" id="kobo.3017.1">HasIndex</span></span><span class="koboSpan" id="kobo.3018.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3019.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3020.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3021.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3022.1">ReadyTime</span></span><span class="koboSpan" id="kobo.3023.1">);
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3024.1">Let’s now move on to the implementation of all repositories.</span></p>
<h3 class="heading-3" id="_idParaDest-138"><a id="_idTextAnchor193"/><span class="koboSpan" id="kobo.3025.1">The IOutputQueueRepository implementation</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.3026.1">All </span><a id="_idIndexMarker466"/><span class="koboSpan" id="kobo.3027.1">repository implementations </span><a id="_idIndexMarker467"/><span class="koboSpan" id="kobo.3028.1">follow the same basic pattern:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3029.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3030.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3031.1">OutputQueueRepository</span></span><span class="koboSpan" id="kobo.3032.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3033.1">IUnitOfWork</span></span><span class="koboSpan" id="kobo.3034.1"> uow) : </span><span class="hljs-title"><span class="koboSpan" id="kobo.3035.1">IOutputQueueRepository</span></span><span class="koboSpan" id="kobo.3036.1">
{
    readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.3037.1">MainDbContext</span></span><span class="koboSpan" id="kobo.3038.1"> ctx = (uow </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3039.1">as</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3040.1">MainDbContext</span></span><span class="koboSpan" id="kobo.3041.1">)!;
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3042.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3043.1">Confirm</span></span><span class="koboSpan" id="kobo.3044.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3045.1">Guid</span></span><span class="koboSpan" id="kobo.3046.1">[] ids)
    …
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.3047.1">QueueItem</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3048.1">New</span></span><span class="koboSpan" id="kobo.3049.1">&lt;T&gt;(T item, int messageCode)
    …
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3050.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3051.1">Task</span></span><span class="koboSpan" id="kobo.3052.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3053.1">IList</span></span><span class="koboSpan" id="kobo.3054.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3055.1">QueueItem</span></span><span class="koboSpan" id="kobo.3056.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.3057.1">Take</span></span><span class="koboSpan" id="kobo.3058.1">(int N, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3059.1">TimeSpan</span></span><span class="koboSpan" id="kobo.3060.1"> requeueAfter)
    …
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3061.1">They take </span><code class="inlineCode"><span class="koboSpan" id="kobo.3062.1">IUnitOfWork</span></code><span class="koboSpan" id="kobo.3063.1"> from </span><a id="_idIndexMarker468"/><span class="koboSpan" id="kobo.3064.1">their main constructor </span><a id="_idIndexMarker469"/><span class="koboSpan" id="kobo.3065.1">and cast it to the database context.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3066.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3067.1">New</span></code><span class="koboSpan" id="kobo.3068.1"> method implementation is as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3069.1">public </span><span class="hljs-title"><span class="koboSpan" id="kobo.3070.1">QueueItem</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3071.1">New</span></span><span class="koboSpan" id="kobo.3072.1">&lt;T&gt;(T item, int messageCode)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3073.1">var</span></span><span class="koboSpan" id="kobo.3074.1"> entity = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3075.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3076.1">OutputQueueItem</span></span><span class="koboSpan" id="kobo.3077.1">()
    {
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.3078.1">Id</span></span><span class="koboSpan" id="kobo.3079.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.3080.1">Guid</span></span><span class="koboSpan" id="kobo.3081.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3082.1">NewGuid</span></span><span class="koboSpan" id="kobo.3083.1">(),
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.3084.1">MessageCode</span></span><span class="koboSpan" id="kobo.3085.1"> = messageCode,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.3086.1">MessageContent</span></span><span class="koboSpan" id="kobo.3087.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.3088.1">JsonSerializer</span></span><span class="koboSpan" id="kobo.3089.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3090.1">Serialize</span></span><span class="koboSpan" id="kobo.3091.1">(item)
    };
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3092.1">var</span></span><span class="koboSpan" id="kobo.3093.1"> res = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3094.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3095.1">QueueItem</span></span><span class="koboSpan" id="kobo.3096.1">(entity);
    ctx.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3097.1">OutputQueueItems</span></span><span class="koboSpan" id="kobo.3098.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3099.1">Add</span></span><span class="koboSpan" id="kobo.3100.1">(entity);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3101.1">return</span></span><span class="koboSpan" id="kobo.3102.1"> res;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3103.1">The implementation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3104.1">Confirm</span></code><span class="koboSpan" id="kobo.3105.1"> is straightforward, too:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3106.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3107.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3108.1">Confirm</span></span><span class="koboSpan" id="kobo.3109.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3110.1">Guid</span></span><span class="koboSpan" id="kobo.3111.1">[] ids)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3112.1">var</span></span><span class="koboSpan" id="kobo.3113.1"> entities = ctx.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3114.1">ChangeTracker</span></span><span class="koboSpan" id="kobo.3115.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3116.1">Entries</span></span><span class="koboSpan" id="kobo.3117.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3118.1">OutputQueueItem</span></span><span class="koboSpan" id="kobo.3119.1">&gt;()
        .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3120.1">Where</span></span><span class="koboSpan" id="kobo.3121.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3122.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3123.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3124.1"> ids.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3125.1">Contains</span></span><span class="koboSpan" id="kobo.3126.1">(m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3127.1">Entity</span></span><span class="koboSpan" id="kobo.3128.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3129.1">Id</span></span><span class="koboSpan" id="kobo.3130.1">)).</span><span class="hljs-title"><span class="koboSpan" id="kobo.3131.1">Select</span></span><span class="koboSpan" id="kobo.3132.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3133.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3134.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3135.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3136.1">Entity</span></span><span class="koboSpan" id="kobo.3137.1">);
    ctx.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3138.1">OutputQueueItems</span></span><span class="koboSpan" id="kobo.3139.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3140.1">RemoveRange</span></span><span class="koboSpan" id="kobo.3141.1">(entities);
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3142.1">It uses the changes tracker to get all already-loaded entities with the given IDs.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3143.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3144.1">Take</span></code><span class="koboSpan" id="kobo.3145.1"> implementation is a little bit more complex, because it requires a transaction to handle the competition between the various microservice replicas, since they all use the same database:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3146.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3147.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3148.1">Task</span></span><span class="koboSpan" id="kobo.3149.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3150.1">IList</span></span><span class="koboSpan" id="kobo.3151.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3152.1">QueueItem</span></span><span class="koboSpan" id="kobo.3153.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.3154.1">Take</span></span><span class="koboSpan" id="kobo.3155.1">(int N, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3156.1">TimeSpan</span></span><span class="koboSpan" id="kobo.3157.1"> requeueAfter)
{
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.3158.1">List</span></span><span class="koboSpan" id="kobo.3159.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3160.1">OutputQueueItem</span></span><span class="koboSpan" id="kobo.3161.1">&gt; entities;
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.3162.1">using</span></span><span class="koboSpan" id="kobo.3163.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3164.1">var</span></span><span class="koboSpan" id="kobo.3165.1"> tx = 
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3166.1">await</span></span><span class="koboSpan" id="kobo.3167.1"> ctx.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3168.1">Database</span></span><span class="koboSpan" id="kobo.3169.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3170.1">BeginTransactionAsync</span></span><span class="koboSpan" id="kobo.3171.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3172.1">IsolationLevel</span></span><span class="koboSpan" id="kobo.3173.1">.
            </span><span class="hljs-property"><span class="koboSpan" id="kobo.3174.1">Serializable</span></span><span class="koboSpan" id="kobo.3175.1">))
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3176.1">var</span></span><span class="koboSpan" id="kobo.3177.1"> now = </span><span class="hljs-title"><span class="koboSpan" id="kobo.3178.1">DateTime</span></span><span class="koboSpan" id="kobo.3179.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3180.1">Now</span></span><span class="koboSpan" id="kobo.3181.1">;
        entities = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3182.1">await</span></span><span class="koboSpan" id="kobo.3183.1"> ctx.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3184.1">OutputQueueItems</span></span><span class="koboSpan" id="kobo.3185.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3186.1">Where</span></span><span class="koboSpan" id="kobo.3187.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3188.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3189.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3190.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3191.1">ReadyTime</span></span><span class="koboSpan" id="kobo.3192.1"> &lt;= 
                                                    now)
            .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3193.1">OrderBy</span></span><span class="koboSpan" id="kobo.3194.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3195.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3196.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3197.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3198.1">ReadyTime</span></span><span class="koboSpan" id="kobo.3199.1">)
            .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3200.1">Take</span></span><span class="koboSpan" id="kobo.3201.1">(N)
            .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3202.1">ToListAsync</span></span><span class="koboSpan" id="kobo.3203.1">();
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3204.1">if</span></span><span class="koboSpan" id="kobo.3205.1"> (entities.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3206.1">Count</span></span><span class="koboSpan" id="kobo.3207.1"> &gt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.3208.1">0</span></span><span class="koboSpan" id="kobo.3209.1">)
        {
            </span><span class="hljs-title"><span class="koboSpan" id="kobo.3210.1">foreach</span></span><span class="koboSpan" id="kobo.3211.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3212.1">var</span></span><span class="koboSpan" id="kobo.3213.1"> entity </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3214.1">in</span></span><span class="koboSpan" id="kobo.3215.1"> entities) 
                { entity.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3216.1">ReadyTime</span></span><span class="koboSpan" id="kobo.3217.1"> = now + requeueAfter; }
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3218.1">await</span></span><span class="koboSpan" id="kobo.3219.1"> ctx.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3220.1">SaveChangesAsync</span></span><span class="koboSpan" id="kobo.3221.1">();
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3222.1">await</span></span><span class="koboSpan" id="kobo.3223.1"> tx.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3224.1">CommitAsync</span></span><span class="koboSpan" id="kobo.3225.1">();
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3226.1">return</span></span><span class="koboSpan" id="kobo.3227.1"> entities.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3228.1">Select</span></span><span class="koboSpan" id="kobo.3229.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3230.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3231.1"> =&gt;</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3232.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3233.1">QueueItem</span></span><span class="koboSpan" id="kobo.3234.1">(m)).</span><span class="hljs-title"><span class="koboSpan" id="kobo.3235.1">ToList</span></span><span class="koboSpan" id="kobo.3236.1">();
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3237.1">Once all </span><a id="_idIndexMarker470"/><span class="koboSpan" id="kobo.3238.1">entities are extracted, </span><code class="inlineCode"><span class="koboSpan" id="kobo.3239.1">ReadyTime</span></code><span class="koboSpan" id="kobo.3240.1"> is moved to a future time to prevent their usage from other replicas till </span><code class="inlineCode"><span class="koboSpan" id="kobo.3241.1">requeueAfter</span></code><span class="koboSpan" id="kobo.3242.1"> expires and </span><a id="_idIndexMarker471"/><span class="koboSpan" id="kobo.3243.1">they become available again if they were not removed by </span><code class="inlineCode"><span class="koboSpan" id="kobo.3244.1">Confirm</span></code><span class="koboSpan" id="kobo.3245.1">. </span><span class="koboSpan" id="kobo.3245.2">This way, if all retry and circuit break strategies fail in getting a successful transmission, the same operation can be retried after </span><code class="inlineCode"><span class="koboSpan" id="kobo.3246.1">requeueAfter</span></code><span class="koboSpan" id="kobo.3247.1">. </span><span class="koboSpan" id="kobo.3247.2">Both read and update must be part of the same serializable transaction to prevent interferences from other replicas.</span></p>
<h3 class="heading-3" id="_idParaDest-139"><a id="_idTextAnchor194"/><span class="koboSpan" id="kobo.3248.1">The IRouteRequestRepositoryimplementation</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.3249.1">The </span><a id="_idIndexMarker472"/><span class="koboSpan" id="kobo.3250.1">repository structure is completely analogous </span><a id="_idIndexMarker473"/><span class="koboSpan" id="kobo.3251.1">to the one of the previous repository:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3252.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3253.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3254.1">RouteRequestRepository</span></span><span class="koboSpan" id="kobo.3255.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3256.1">IUnitOfWork</span></span><span class="koboSpan" id="kobo.3257.1"> uow) : </span><span class="hljs-title"><span class="koboSpan" id="kobo.3258.1">IRouteRequestRepository</span></span><span class="koboSpan" id="kobo.3259.1">
{
    readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.3260.1">MainDbContext</span></span><span class="koboSpan" id="kobo.3261.1"> ctx = (uow </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3262.1">as</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3263.1">MainDbContext</span></span><span class="koboSpan" id="kobo.3264.1">)!;
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3265.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3266.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3267.1">DeleteBefore</span></span><span class="koboSpan" id="kobo.3268.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3269.1">DateTime</span></span><span class="koboSpan" id="kobo.3270.1"> milestone)
    …
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3271.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3272.1">Task</span></span><span class="koboSpan" id="kobo.3273.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3274.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.3275.1">?&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.3276.1">Get</span></span><span class="koboSpan" id="kobo.3277.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3278.1">Guid</span></span><span class="koboSpan" id="kobo.3279.1"> id)
    …
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3280.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3281.1">Task</span></span><span class="koboSpan" id="kobo.3282.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3283.1">IList</span></span><span class="koboSpan" id="kobo.3284.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3285.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.3286.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.3287.1">GetInRoute</span></span><span class="koboSpan" id="kobo.3288.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3289.1">Guid</span></span><span class="koboSpan" id="kobo.3290.1"> 
        routeId)
    …
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3291.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3292.1">Task</span></span><span class="koboSpan" id="kobo.3293.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3294.1">IList</span></span><span class="koboSpan" id="kobo.3295.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3296.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.3297.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.3298.1">GetMatch</span></span><span class="koboSpan" id="kobo.3299.1">(
</span><span class="hljs-title"><span class="koboSpan" id="kobo.3300.1">        IEnumerable</span></span><span class="koboSpan" id="kobo.3301.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3302.1">Coordinate</span></span><span class="koboSpan" id="kobo.3303.1">&gt; geometry, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3304.1">DateTime</span></span><span class="koboSpan" id="kobo.3305.1"> when, 
        double distance, int maxResults)
    …
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.3306.1">RouteRequestAggregate</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3307.1">New</span></span><span class="koboSpan" id="kobo.3308.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3309.1">Guid</span></span><span class="koboSpan" id="kobo.3310.1"> id, 
</span><span class="hljs-title"><span class="koboSpan" id="kobo.3311.1">        TownBasicInfo</span></span><span class="koboSpan" id="kobo.3312.1"> source, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3313.1">TownBasicInfo</span></span><span class="koboSpan" id="kobo.3314.1"> destination, 
</span><span class="hljs-title"><span class="koboSpan" id="kobo.3315.1">        TimeInterval</span></span><span class="koboSpan" id="kobo.3316.1"> when, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3317.1">UserBasicInfo</span></span><span class="koboSpan" id="kobo.3318.1"> user)
    …
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3319.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3320.1">DeleteBefore</span></code><span class="koboSpan" id="kobo.3321.1"> method is </span><a id="_idIndexMarker474"/><span class="koboSpan" id="kobo.3322.1">easily implemented with the recent </span><code class="inlineCode"><span class="koboSpan" id="kobo.3323.1">ExecuteDeleteAsync</span></code><span class="koboSpan" id="kobo.3324.1"> Entity Framework Core extension:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3325.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3326.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3327.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3328.1">DeleteBefore</span></span><span class="koboSpan" id="kobo.3329.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3330.1">DateTime</span></span><span class="koboSpan" id="kobo.3331.1"> milestone)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3332.1">await</span></span><span class="koboSpan" id="kobo.3333.1"> ctx.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3334.1">RouteRequests</span></span><span class="koboSpan" id="kobo.3335.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3336.1">Where</span></span><span class="koboSpan" id="kobo.3337.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3338.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3339.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3340.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3341.1">WhenEnd</span></span><span class="koboSpan" id="kobo.3342.1"> &lt; milestone).</span><span class="hljs-title"><span class="koboSpan" id="kobo.3343.1">ExecuteDeleteAsync</span></span><span class="koboSpan" id="kobo.3344.1">(); 
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3345.1">In the </span><a id="_idIndexMarker475"/><span class="koboSpan" id="kobo.3346.1">following code blocks, we </span><a id="_idIndexMarker476"/><span class="koboSpan" id="kobo.3347.1">can see the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3348.1">New</span></code><span class="koboSpan" id="kobo.3349.1"> method: </span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3350.1">public </span><span class="hljs-title"><span class="koboSpan" id="kobo.3351.1">RouteRequestAggregate</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3352.1">New</span></span><span class="koboSpan" id="kobo.3353.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3354.1">Guid</span></span><span class="koboSpan" id="kobo.3355.1"> id, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3356.1">TownBasicInfo</span></span><span class="koboSpan" id="kobo.3357.1"> source, 
</span><span class="hljs-title"><span class="koboSpan" id="kobo.3358.1">TownBasicInfo</span></span><span class="koboSpan" id="kobo.3359.1"> destination, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3360.1">TimeInterval</span></span><span class="koboSpan" id="kobo.3361.1"> when, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3362.1">UserBasicInfo</span></span><span class="koboSpan" id="kobo.3363.1"> user)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3364.1">var</span></span><span class="koboSpan" id="kobo.3365.1"> entity = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3366.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3367.1">RouteRequest</span></span><span class="koboSpan" id="kobo.3368.1">()
    {
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.3369.1">Id</span></span><span class="koboSpan" id="kobo.3370.1"> = id,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.3371.1">Source</span></span><span class="koboSpan" id="kobo.3372.1"> = source,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.3373.1">Destination</span></span><span class="koboSpan" id="kobo.3374.1"> = destination,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.3375.1">WhenStart</span></span><span class="koboSpan" id="kobo.3376.1"> = when.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3377.1">Start</span></span><span class="koboSpan" id="kobo.3378.1">,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.3379.1">WhenEnd</span></span><span class="koboSpan" id="kobo.3380.1"> = when.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3381.1">End</span></span><span class="koboSpan" id="kobo.3382.1">,
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.3383.1">User</span></span><span class="koboSpan" id="kobo.3384.1"> = user
    };
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3385.1">var</span></span><span class="koboSpan" id="kobo.3386.1"> res = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3387.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3388.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.3389.1">(entity);
    res.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3390.1">AddDomainEvent</span></span><span class="koboSpan" id="kobo.3391.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3392.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3393.1">NewMatchCandidateEvent</span></span><span class="koboSpan" id="kobo.3394.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3395.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.3396.1">&gt;(res));
    ctx.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3397.1">RouteRequests</span></span><span class="koboSpan" id="kobo.3398.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3399.1">Add</span></span><span class="koboSpan" id="kobo.3400.1">(entity);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3401.1">return</span></span><span class="koboSpan" id="kobo.3402.1"> res;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3403.1">It creates an Entity Framework Core entity, adds it to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3404.1">ctx.RouteRequests</span></code><span class="koboSpan" id="kobo.3405.1">, and uses it as the state to create </span><code class="inlineCode"><span class="koboSpan" id="kobo.3406.1">RouteRequestAggregate</span></code><span class="koboSpan" id="kobo.3407.1">. </span><span class="koboSpan" id="kobo.3407.2">It adds also a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3408.1">NewMatchCandidateEvent&lt;RouteRequestAggregate&gt;</span></code><span class="koboSpan" id="kobo.3409.1"> event to the aggregate. </span><span class="koboSpan" id="kobo.3409.2">The associated event handler will take care of finding all routes that match the request and creating an output message for each of them. </span><code class="inlineCode"><span class="koboSpan" id="kobo.3410.1">NewMatchCandidateEvent&lt;T&gt;</span></code><span class="koboSpan" id="kobo.3411.1"> is defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3412.1">Events</span></code><span class="koboSpan" id="kobo.3413.1"> folder of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3414.1">RoutesPlanningDomainLayer</span></code><span class="koboSpan" id="kobo.3415.1"> project, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3416.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3417.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3418.1">NewMatchCandidateEvent</span></span><span class="koboSpan" id="kobo.3419.1">&lt;T&gt;(T matchCandidate):
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.3420.1">IEventNotification</span></span><span class="koboSpan" id="kobo.3421.1">
{
    public T </span><span class="hljs-title"><span class="koboSpan" id="kobo.3422.1">MatchCandidate</span></span><span class="koboSpan" id="kobo.3423.1"> =&gt; matchCandidate;
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3424.1">All other </span><a id="_idIndexMarker477"/><span class="koboSpan" id="kobo.3425.1">methods contain quite standard Entity Framework </span><a id="_idIndexMarker478"/><span class="koboSpan" id="kobo.3426.1">Core code, so we will describe here just the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3427.1">GetMatch</span></code><span class="koboSpan" id="kobo.3428.1"> method since it uses the Entity Framework special queries extensions. </span><span class="koboSpan" id="kobo.3428.2">The code of all other methods is available in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3429.1">ch07</span></code><span class="koboSpan" id="kobo.3430.1"> folder of the book’s GitHub repository (</span><a href="https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp"><span class="url"><span class="koboSpan" id="kobo.3431.1">https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp</span></span></a><span class="koboSpan" id="kobo.3432.1">):</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3433.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3434.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3435.1">Task</span></span><span class="koboSpan" id="kobo.3436.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3437.1">IList</span></span><span class="koboSpan" id="kobo.3438.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3439.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.3440.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.3441.1">GetMatch</span></span><span class="koboSpan" id="kobo.3442.1">(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.3443.1">IEnumerable</span></span><span class="koboSpan" id="kobo.3444.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3445.1">Coordinate</span></span><span class="koboSpan" id="kobo.3446.1">&gt; geometry, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3447.1">DateTime</span></span><span class="koboSpan" id="kobo.3448.1"> when, 
    double distance, int maxResults)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3449.1">var</span></span><span class="koboSpan" id="kobo.3450.1"> lineString = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3451.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3452.1">LineString</span></span><span class="koboSpan" id="kobo.3453.1">(geometry.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3454.1">ToArray</span></span><span class="koboSpan" id="kobo.3455.1">())
        { </span><span class="hljs-variable"><span class="koboSpan" id="kobo.3456.1">SRID</span></span><span class="koboSpan" id="kobo.3457.1"> = </span><span class="hljs-title"><span class="koboSpan" id="kobo.3458.1">GeometryConstants</span></span><span class="koboSpan" id="kobo.3459.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3460.1">DefaultSRID</span></span><span class="koboSpan" id="kobo.3461.1"> };
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3462.1">var</span></span><span class="koboSpan" id="kobo.3463.1"> entities = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3464.1">await</span></span><span class="koboSpan" id="kobo.3465.1"> ctx.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3466.1">RouteRequests</span></span><span class="koboSpan" id="kobo.3467.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3468.1">Where</span></span><span class="koboSpan" id="kobo.3469.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3470.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3471.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3472.1">
        m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3473.1">RouteId</span></span><span class="koboSpan" id="kobo.3474.1"> == </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3475.1">null</span></span><span class="koboSpan" id="kobo.3476.1"> &amp;&amp;
        when &lt;= m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3477.1">WhenEnd</span></span><span class="koboSpan" id="kobo.3478.1"> &amp;&amp; when &gt;= m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3479.1">WhenStart</span></span><span class="koboSpan" id="kobo.3480.1"> &amp;&amp;
        lineString.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3481.1">Distance</span></span><span class="koboSpan" id="kobo.3482.1">(m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3483.1">Source</span></span><span class="koboSpan" id="kobo.3484.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3485.1">Location</span></span><span class="koboSpan" id="kobo.3486.1">) &lt; distance &amp;&amp;
        lineString.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3487.1">Distance</span></span><span class="koboSpan" id="kobo.3488.1">(m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3489.1">Destination</span></span><span class="koboSpan" id="kobo.3490.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3491.1">Location</span></span><span class="koboSpan" id="kobo.3492.1">) &lt; distance)
        .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3493.1">Select</span></span><span class="koboSpan" id="kobo.3494.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3495.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3496.1"> =&gt;</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3497.1">new</span></span><span class="koboSpan" id="kobo.3498.1">
        {
            </span><span class="hljs-title"><span class="koboSpan" id="kobo.3499.1">Distance</span></span><span class="koboSpan" id="kobo.3500.1"> = lineString.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3501.1">Distance</span></span><span class="koboSpan" id="kobo.3502.1">(m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3503.1">Source</span></span><span class="koboSpan" id="kobo.3504.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3505.1">Location</span></span><span class="koboSpan" id="kobo.3506.1">),
            </span><span class="hljs-title"><span class="koboSpan" id="kobo.3507.1">Entity</span></span><span class="koboSpan" id="kobo.3508.1"> = m
        })
        .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3509.1">OrderBy</span></span><span class="koboSpan" id="kobo.3510.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3511.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3512.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3513.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3514.1">Distance</span></span><span class="koboSpan" id="kobo.3515.1">)
        .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3516.1">Take</span></span><span class="koboSpan" id="kobo.3517.1">(maxResults).</span><span class="hljs-title"><span class="koboSpan" id="kobo.3518.1">ToListAsync</span></span><span class="koboSpan" id="kobo.3519.1">();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3520.1">return</span></span><span class="koboSpan" id="kobo.3521.1"> entities
       .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3522.1">Select</span></span><span class="koboSpan" id="kobo.3523.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3524.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3525.1"> =&gt;</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3526.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3527.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.3528.1">(m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3529.1">Entity</span></span><span class="koboSpan" id="kobo.3530.1">))
       .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3531.1">ToList</span></span><span class="koboSpan" id="kobo.3532.1">();
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3533.1">First of all, we create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3534.1">LineString</span></code><span class="koboSpan" id="kobo.3535.1"> geometry from the route path, and then we start the query. </span><span class="koboSpan" id="kobo.3535.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3536.1">Where</span></code><span class="koboSpan" id="kobo.3537.1"> clause first restricts the search to requests that are not already attached to other routes. </span><span class="koboSpan" id="kobo.3537.2">Then, it verifies time compatibility and, finally, distance compatibility by using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3538.1">LineString.Distance</span></code><span class="koboSpan" id="kobo.3539.1"> method. </span><span class="koboSpan" id="kobo.3539.2">All geometry objects have a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3540.1">Distance</span></code><span class="koboSpan" id="kobo.3541.1"> method, so we can perform </span><a id="_idIndexMarker479"/><span class="koboSpan" id="kobo.3542.1">geometric queries </span><a id="_idIndexMarker480"/><span class="koboSpan" id="kobo.3543.1">involving any kind of geometric object. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.3544.1">Finally, we return an anonymous object with both the distance and the retrieved entity. </span><span class="koboSpan" id="kobo.3544.2">This way, we can sort data by distance and extract the best </span><code class="inlineCode"><span class="koboSpan" id="kobo.3545.1">maxResults</span></code><span class="koboSpan" id="kobo.3546.1"> matches.</span></p>
<h3 class="heading-3" id="_idParaDest-140"><a id="_idTextAnchor195"/><span class="koboSpan" id="kobo.3547.1">The IRouteOfferRepository implementation</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.3548.1">Again, the </span><a id="_idIndexMarker481"/><span class="koboSpan" id="kobo.3549.1">repository structure is the same as the </span><a id="_idIndexMarker482"/><span class="koboSpan" id="kobo.3550.1">one of all previous repositories:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3551.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3552.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3553.1">RouteOfferRepository</span></span><span class="koboSpan" id="kobo.3554.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3555.1">IUnitOfWork</span></span><span class="koboSpan" id="kobo.3556.1"> uow) : </span><span class="hljs-title"><span class="koboSpan" id="kobo.3557.1">IRouteOfferRepository</span></span><span class="koboSpan" id="kobo.3558.1">
{
    readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.3559.1">MainDbContext</span></span><span class="koboSpan" id="kobo.3560.1"> ctx = (uow </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3561.1">as</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3562.1">MainDbContext</span></span><span class="koboSpan" id="kobo.3563.1">)!;
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3564.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3565.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3566.1">DeleteBefore</span></span><span class="koboSpan" id="kobo.3567.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3568.1">DateTime</span></span><span class="koboSpan" id="kobo.3569.1"> milestone)
    …
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3570.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3571.1">Task</span></span><span class="koboSpan" id="kobo.3572.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3573.1">RouteOfferAggregate</span></span><span class="koboSpan" id="kobo.3574.1">?&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.3575.1">Get</span></span><span class="koboSpan" id="kobo.3576.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3577.1">Guid</span></span><span class="koboSpan" id="kobo.3578.1"> id)
    …
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3579.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3580.1">Task</span></span><span class="koboSpan" id="kobo.3581.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3582.1">IList</span></span><span class="koboSpan" id="kobo.3583.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3584.1">RouteOfferAggregate</span></span><span class="koboSpan" id="kobo.3585.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.3586.1">GetMatch</span></span><span class="koboSpan" id="kobo.3587.1">(
</span><span class="hljs-title"><span class="koboSpan" id="kobo.3588.1">        Point</span></span><span class="koboSpan" id="kobo.3589.1"> source, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3590.1">Point</span></span><span class="koboSpan" id="kobo.3591.1"> destination, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3592.1">TimeInterval</span></span><span class="koboSpan" id="kobo.3593.1"> when, 
</span><span class="hljs-title"> </span><span class="koboSpan" id="kobo.3594.1">double distance, int maxResults)
    …
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.3595.1">RouteOfferAggregate</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3596.1">New</span></span><span class="koboSpan" id="kobo.3597.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3598.1">Guid</span></span><span class="koboSpan" id="kobo.3599.1"> id, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3600.1">Coordinate</span></span><span class="koboSpan" id="kobo.3601.1">[] path, 
</span><span class="hljs-title"><span class="koboSpan" id="kobo.3602.1">        UserBasicInfo</span></span><span class="koboSpan" id="kobo.3603.1"> user, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3604.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3605.1">When</span></span><span class="koboSpan" id="kobo.3606.1">)
    …   
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3607.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3608.1">DeleteBefore</span></code><span class="koboSpan" id="kobo.3609.1"> method is analogous to the one of the previous repository:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3610.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3611.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3612.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3613.1">DeleteBefore</span></span><span class="koboSpan" id="kobo.3614.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3615.1">DateTime</span></span><span class="koboSpan" id="kobo.3616.1"> milestone)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3617.1">await</span></span><span class="koboSpan" id="kobo.3618.1"> ctx.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3619.1">RouteOffers</span></span><span class="koboSpan" id="kobo.3620.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3621.1">Where</span></span><span class="koboSpan" id="kobo.3622.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3623.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3624.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3625.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3626.1">When</span></span><span class="koboSpan" id="kobo.3627.1"> &lt; milestone).</span><span class="hljs-title"><span class="koboSpan" id="kobo.3628.1">ExecuteDeleteAsync</span></span><span class="koboSpan" id="kobo.3629.1">();
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3630.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3631.1">New</span></code><span class="koboSpan" id="kobo.3632.1"> method is also the same as the one of the requests repository, but it generates the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3633.1">NewMatchCandidateEvent&lt;</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.3634.1">RouteOfferAggregate&gt;</span></code><span class="koboSpan" id="kobo.3635.1"> event, whose handler looks for matching requests.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3636.1">Again, we </span><a id="_idIndexMarker483"/><span class="koboSpan" id="kobo.3637.1">describe just the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3638.1">GetMatch</span></code><span class="koboSpan" id="kobo.3639.1"> method since all other methods are quite standard:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3640.1">public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3641.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3642.1">Task</span></span><span class="koboSpan" id="kobo.3643.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3644.1">IList</span></span><span class="koboSpan" id="kobo.3645.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3646.1">RouteOfferAggregate</span></span><span class="koboSpan" id="kobo.3647.1">&gt;&gt; </span><span class="hljs-title"><span class="koboSpan" id="kobo.3648.1">GetMatch</span></span><span class="koboSpan" id="kobo.3649.1">(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.3650.1">Point</span></span><span class="koboSpan" id="kobo.3651.1"> source, </span><span class="hljs-title"><span class="koboSpan" id="kobo.3652.1">Point</span></span><span class="koboSpan" id="kobo.3653.1"> destination, 
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.3654.1">TimeInterval</span></span><span class="koboSpan" id="kobo.3655.1"> when, double distance, int maxResults)
{
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3656.1">var</span></span><span class="koboSpan" id="kobo.3657.1"> entities = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3658.1">await</span></span><span class="koboSpan" id="kobo.3659.1"> ctx.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3660.1">RouteOffers</span></span><span class="koboSpan" id="kobo.3661.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3662.1">Where</span></span><span class="koboSpan" id="kobo.3663.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3664.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3665.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3666.1"> 
         m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3667.1">Status</span></span><span class="koboSpan" id="kobo.3668.1"> == </span><span class="hljs-title"><span class="koboSpan" id="kobo.3669.1">RouteStatus</span></span><span class="koboSpan" id="kobo.3670.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3671.1">Open</span></span><span class="koboSpan" id="kobo.3672.1"> &amp;&amp;
        m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3673.1">When</span></span><span class="koboSpan" id="kobo.3674.1"> &lt;= when.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3675.1">End</span></span><span class="koboSpan" id="kobo.3676.1"> &amp;&amp; m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3677.1">When</span></span><span class="koboSpan" id="kobo.3678.1"> &gt;= when.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3679.1">Start</span></span><span class="koboSpan" id="kobo.3680.1"> &amp;&amp;
        source.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3681.1">Distance</span></span><span class="koboSpan" id="kobo.3682.1">(m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3683.1">Path</span></span><span class="koboSpan" id="kobo.3684.1">) &lt; distance)
        .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3685.1">Select</span></span><span class="koboSpan" id="kobo.3686.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3687.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3688.1"> =&gt;</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3689.1">new</span></span><span class="koboSpan" id="kobo.3690.1">
        {
            </span><span class="hljs-title"><span class="koboSpan" id="kobo.3691.1">Distance</span></span><span class="koboSpan" id="kobo.3692.1"> = source.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3693.1">Distance</span></span><span class="koboSpan" id="kobo.3694.1">(m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3695.1">Path</span></span><span class="koboSpan" id="kobo.3696.1">),
            </span><span class="hljs-title"><span class="koboSpan" id="kobo.3697.1">Entity</span></span><span class="koboSpan" id="kobo.3698.1"> = m
        })
        .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3699.1">OrderBy</span></span><span class="koboSpan" id="kobo.3700.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3701.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3702.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3703.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3704.1">Distance</span></span><span class="koboSpan" id="kobo.3705.1">)
        .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3706.1">Take</span></span><span class="koboSpan" id="kobo.3707.1">(maxResults).</span><span class="hljs-title"><span class="koboSpan" id="kobo.3708.1">ToListAsync</span></span><span class="koboSpan" id="kobo.3709.1">();
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3710.1">return</span></span><span class="koboSpan" id="kobo.3711.1"> entities
        .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3712.1">Select</span></span><span class="koboSpan" id="kobo.3713.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3714.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3715.1"> =&gt;</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3716.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3717.1">RouteOfferAggregate</span></span><span class="koboSpan" id="kobo.3718.1">(m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3719.1">Entity</span></span><span class="koboSpan" id="kobo.3720.1">))
        .</span><span class="hljs-title"><span class="koboSpan" id="kobo.3721.1">ToList</span></span><span class="koboSpan" id="kobo.3722.1">();
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3723.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3724.1">Where</span></code><span class="koboSpan" id="kobo.3725.1"> clause first </span><a id="_idIndexMarker484"/><span class="koboSpan" id="kobo.3726.1">restricts the search just to all open routes. </span><span class="koboSpan" id="kobo.3726.2">Then, it verifies time and distance constraints as in the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.3727.1">GetMatch</span></code><span class="koboSpan" id="kobo.3728.1"> method of the previous repository. </span><span class="koboSpan" id="kobo.3728.2">Also, sorting is the same as that in the previous repository.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3729.1">Having defined everything, we can now move on to migration.</span></p>
<h3 class="heading-3" id="_idParaDest-141"><a id="_idTextAnchor196"/><span class="koboSpan" id="kobo.3730.1">Creating migrations and databases</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.3731.1">Before generating database migrations, we must implement the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3732.1">IDesignTimeDbContextFactory&lt;MainDbContext&gt;</span></code><span class="koboSpan" id="kobo.3733.1"> interface inside the database driver. </span><span class="koboSpan" id="kobo.3733.2">All migration tools look </span><a id="_idIndexMarker485"/><span class="koboSpan" id="kobo.3734.1">for this implementation to create the instance </span><a id="_idIndexMarker486"/><span class="koboSpan" id="kobo.3735.1">of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3736.1">MainDbContext</span></code><span class="koboSpan" id="kobo.3737.1"> needed to get information on both the dat</span><a id="_idTextAnchor197"/><span class="koboSpan" id="kobo.3738.1">abase configuration and the database connection string. </span><span class="koboSpan" id="kobo.3738.2">Therefore, let’s add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3739.1">LibraryDesignTimeDbContextFactory</span></code><span class="koboSpan" id="kobo.3740.1"> class to the root of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3741.1">RoutesPlanningDBDriver</span></code><span class="koboSpan" id="kobo.3742.1"> project:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3743.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3744.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3745.1">LibraryDesignTimeDbContextFactory</span></span><span class="koboSpan" id="kobo.3746.1"> : 
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.3747.1">IDesignTimeDbContextFactory</span></span><span class="koboSpan" id="kobo.3748.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3749.1">MainDbContext</span></span><span class="koboSpan" id="kobo.3750.1">&gt;
{
    private </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3751.1">const</span></span><span class="koboSpan" id="kobo.3752.1"> string connectionString =
        @</span><span class="hljs-string"><span class="koboSpan" id="kobo.3753.1">"Server=&lt;your sql server instance name&gt;;Database=RoutesPlanning;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.3754.1">        User Id=sa;Password=&lt;your password&gt;;Trust Server Certificate=True;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.3755.1">        MultipleActiveResultSets=true "</span></span><span class="koboSpan" id="kobo.3756.1">;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.3757.1">MainDbContext</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3758.1">CreateDbContext</span></span><span class="koboSpan" id="kobo.3759.1">(string[] args)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3760.1">var</span></span><span class="koboSpan" id="kobo.3761.1"> builder = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3762.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3763.1">DbContextOptionsBuilder</span></span><span class="koboSpan" id="kobo.3764.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3765.1">MainDbContext</span></span><span class="koboSpan" id="kobo.3766.1">&gt;();
        builder.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3767.1">UseSqlServer</span></span><span class="koboSpan" id="kobo.3768.1">(
            connectionString, 
            </span><span class="hljs-params"><span class="koboSpan" id="kobo.3769.1">x</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3770.1"> =&gt;</span></span><span class="koboSpan" id="kobo.3771.1"> x.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3772.1">UseNetTopologySuite</span></span><span class="koboSpan" id="kobo.3773.1">());
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3774.1">return</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3775.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3776.1">MainDbContext</span></span><span class="koboSpan" id="kobo.3777.1">(builder.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3778.1">Options</span></span><span class="koboSpan" id="kobo.3779.1">);
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3780.1">Please replace the placeholders I left in the string with your SQL Server instance name and password. </span><span class="koboSpan" id="kobo.3780.2">The simplest way to get a connection string is by connecting to the database from within Visual </span><a id="_idIndexMarker487"/><span class="koboSpan" id="kobo.3781.1">Studio and then by copying the connection </span><a id="_idIndexMarker488"/><span class="koboSpan" id="kobo.3782.1">strings from the properties tab. </span><span class="koboSpan" id="kobo.3782.2">Please don’t forget you can’t use the SQL database installed with Visual Studio since it is not able to listen to TCP/IP connections, so it cannot be accessed from within Docker images.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3783.1">Now, we can also add the SQL Server connection string we left empty in </span><code class="inlineCode"><span class="koboSpan" id="kobo.3784.1">launchSettings.json</span></code><span class="koboSpan" id="kobo.3785.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.3786.1">"ConnectionStrings__DefaultConnection"</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.3787.1">:</span></span>
<span class="hljs-attr"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3788.1">"Server=host.docker.internal;Database=RoutesPlanning;User Id=sa;</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.3789.1">    Password=&lt;our password&gt;;Trust Server Certificate=True;MultipleActiveResultSets=true"</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3790.1">Again, please add your password. </span><code class="inlineCode"><span class="koboSpan" id="kobo.3791.1">host.docker.internal</span></code><span class="koboSpan" id="kobo.3792.1"> is the network name of your development computer that hosts Docker or a local Kubernetes simulator. </span><span class="koboSpan" id="kobo.3792.2">Use it if you performed a direct installation on your machine or if you ran a SQL Server Docker image on your computer. </span><span class="koboSpan" id="kobo.3792.3">Replace it with the appropriate name if you are using a cloud or other network instance.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3793.1">Now, let’s make </span><code class="inlineCode"><span class="koboSpan" id="kobo.3794.1">RoutesPlanningDBDriver</span></code><span class="koboSpan" id="kobo.3795.1"> our Visual Studio startup project, and select it in the Visual Studio </span><strong class="screenText"><span class="koboSpan" id="kobo.3796.1">Package Manager Console</span></strong><span class="koboSpan" id="kobo.3797.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3798.1"><img alt="" role="presentation" src="../Images/B31916_07_5.png"/></span> </figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3799.1">Figure 7.5: Selecting the project in Package Manager Console</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3800.1">We are ready </span><a id="_idIndexMarker489"/><span class="koboSpan" id="kobo.3801.1">to issue our first migration in </span><strong class="screenText"><span class="koboSpan" id="kobo.3802.1">Package Manager Console</span></strong><span class="koboSpan" id="kobo.3803.1">:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3804.1">Add-Migration initial
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.3805.1">Please note that if you copied the project from the GitHub repository associated with the book, you don’t need to execute the preceding command since migrations have already been created there. </span><span class="koboSpan" id="kobo.3805.2">You just need to create the database with the following command.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.3806.1">If the previous </span><a id="_idIndexMarker490"/><span class="koboSpan" id="kobo.3807.1">command was successful, you can create the database with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3808.1">Update-Database
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3809.1">Done! </span><span class="koboSpan" id="kobo.3809.2">We can now move on to the implementation of all command and event handlers.</span></p>
<h2 class="heading-2" id="_idParaDest-142"><a id="_idTextAnchor198"/><span class="koboSpan" id="kobo.3810.1">The application services: Defining all command and event handlers</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3811.1">In this section, we will define all the required command and event handlers. </span><span class="koboSpan" id="kobo.3811.2">Before starting, we need </span><a id="_idIndexMarker491"/><span class="koboSpan" id="kobo.3812.1">to add a reference to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3813.1">Microsoft.Extensions.Configuration.Abstractions</span></code><span class="koboSpan" id="kobo.3814.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3815.1">Microsoft.Extensions.Configuration.Binder</span></code><span class="koboSpan" id="kobo.3816.1"> NuGet packages in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3817.1">RoutesPlanningApplicationServices</span></code><span class="koboSpan" id="kobo.3818.1"> project. </span><span class="koboSpan" id="kobo.3818.2">This way, we enable all handlers to receive configuration data from the dependency injection engine through the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3819.1">IConfiguration</span></code><span class="koboSpan" id="kobo.3820.1"> interface.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3821.1">All command handler </span><a id="_idIndexMarker492"/><span class="koboSpan" id="kobo.3822.1">constructors require some repository interfaces, </span><code class="inlineCode"><span class="koboSpan" id="kobo.3823.1">IUnitofWork</span></code><span class="koboSpan" id="kobo.3824.1"> for finalizing </span><a id="_idIndexMarker493"/><span class="koboSpan" id="kobo.3825.1">modifications and handling transactions, and an </span><code class="inlineCode"><span class="koboSpan" id="kobo.3826.1">EventMediator</span></code><span class="koboSpan" id="kobo.3827.1"> instance for triggering all events added to the aggregates. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.3828.1">We will not describe all handlers, just the ones with a didactic added value. </span><span class="koboSpan" id="kobo.3828.2">You can find the entire code in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3829.1">ch07</span></code><span class="koboSpan" id="kobo.3830.1"> folder of the book’s GitHub repository (</span><a href="https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp"><span class="url"><span class="koboSpan" id="kobo.3831.1">https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp</span></span></a><span class="koboSpan" id="kobo.3832.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3833.1">We will place all command handlers that process messages in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3834.1">CommandHandlers -&gt; Messages</span></code><span class="koboSpan" id="kobo.3835.1"> folder.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3836.1">Let’s start with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3837.1">RouterOfferMessage</span></code><span class="koboSpan" id="kobo.3838.1"> handler: </span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3839.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3840.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3841.1">RouterOfferMessageHandler</span></span><span class="koboSpan" id="kobo.3842.1">(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.3843.1">IRouteOfferRepository</span></span><span class="koboSpan" id="kobo.3844.1"> repo,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.3845.1">IUnitOfWork</span></span><span class="koboSpan" id="kobo.3846.1"> uow,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.3847.1">EventMediator</span></span><span class="koboSpan" id="kobo.3848.1"> mediator
    ) : </span><span class="hljs-title"><span class="koboSpan" id="kobo.3849.1">ICommandHandler</span></span><span class="koboSpan" id="kobo.3850.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3851.1">MessageCommand</span></span><span class="koboSpan" id="kobo.3852.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3853.1">RouteOfferMessage</span></span><span class="koboSpan" id="kobo.3854.1">&gt;&gt;
{
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3855.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3856.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3857.1">HandleAsync</span></span><span class="koboSpan" id="kobo.3858.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3859.1">MessageCommand</span></span><span class="koboSpan" id="kobo.3860.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3861.1">RouteOfferMessage</span></span><span class="koboSpan" id="kobo.3862.1">&gt; 
        command)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3863.1">var</span></span><span class="koboSpan" id="kobo.3864.1"> message = command.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3865.1">Message</span></span><span class="koboSpan" id="kobo.3866.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3867.1">var</span></span><span class="koboSpan" id="kobo.3868.1"> toCreate = repo.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3869.1">New</span></span><span class="koboSpan" id="kobo.3870.1">(message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3871.1">Id</span></span><span class="koboSpan" id="kobo.3872.1">,
          message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3873.1">Path</span></span><span class="koboSpan" id="kobo.3874.1">!.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3875.1">Select</span></span><span class="koboSpan" id="kobo.3876.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3877.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.3878.1"> =&gt;</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3879.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3880.1">Coordinate</span></span><span class="koboSpan" id="kobo.3881.1">(m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3882.1">Location</span></span><span class="koboSpan" id="kobo.3883.1">!.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3884.1">Longitude</span></span><span class="koboSpan" id="kobo.3885.1">, m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3886.1">Location</span></span><span class="koboSpan" id="kobo.3887.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3888.1">Latitude</span></span><span class="koboSpan" id="kobo.3889.1">)).
                           </span><span class="hljs-title"><span class="koboSpan" id="kobo.3890.1">ToArray</span></span><span class="koboSpan" id="kobo.3891.1">(),
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3892.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3893.1">UserBasicInfo</span></span><span class="koboSpan" id="kobo.3894.1"> { </span><span class="hljs-title"><span class="koboSpan" id="kobo.3895.1">Id</span></span><span class="koboSpan" id="kobo.3896.1"> = message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3897.1">User</span></span><span class="koboSpan" id="kobo.3898.1">!.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3899.1">Id</span></span><span class="koboSpan" id="kobo.3900.1">, 
</span><span class="hljs-title"><span class="koboSpan" id="kobo.3901.1">                DisplayName</span></span><span class="koboSpan" id="kobo.3902.1"> = message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3903.1">User</span></span><span class="koboSpan" id="kobo.3904.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3905.1">DisplayName</span></span><span class="koboSpan" id="kobo.3906.1">! </span><span class="koboSpan" id="kobo.3906.2">},
            message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3907.1">When</span></span><span class="koboSpan" id="kobo.3908.1">!.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3909.1">Value</span></span><span class="koboSpan" id="kobo.3910.1">
           );
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3911.1">if</span></span><span class="koboSpan" id="kobo.3912.1"> (toCreate.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3913.1">DomainEvents</span></span><span class="koboSpan" id="kobo.3914.1"> != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3915.1">null</span></span><span class="koboSpan" id="kobo.3916.1"> &amp;&amp; toCreate.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3917.1">DomainEvents</span></span><span class="koboSpan" id="kobo.3918.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3919.1">Count</span></span><span class="koboSpan" id="kobo.3920.1"> &gt; 
</span><a id="_idTextAnchor199"/> <span class="hljs-number"><span class="koboSpan" id="kobo.3921.1">0</span></span><span class="koboSpan" id="kobo.3922.1">)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3923.1">await</span></span><span class="koboSpan" id="kobo.3924.1"> mediator.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3925.1">TriggerEvents</span></span><span class="koboSpan" id="kobo.3926.1">(toCreate.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3927.1">DomainEvents</span></span><span class="koboSpan" id="kobo.3928.1">);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3929.1">try</span></span><span class="koboSpan" id="kobo.3930.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3931.1">await</span></span><span class="koboSpan" id="kobo.3932.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3933.1">SaveEntitiesAsync</span></span><span class="koboSpan" id="kobo.3934.1">();
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3935.1">catch</span></span><span class="koboSpan" id="kobo.3936.1"> (</span><span class="hljs-title"><span class="koboSpan" id="kobo.3937.1">ConstraintViolationException</span></span><span class="koboSpan" id="kobo.3938.1">) { }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3939.1">The handler extracts </span><a id="_idIndexMarker494"/><span class="koboSpan" id="kobo.3940.1">all data needed to create a new aggregate from the </span><a id="_idIndexMarker495"/><span class="koboSpan" id="kobo.3941.1">message and then passes it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3942.1">New</span></code><span class="koboSpan" id="kobo.3943.1"> repository method. </span><span class="koboSpan" id="kobo.3943.2">Then, it verifies whether the created aggregate contains events and uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3944.1">EventMediator</span></code><span class="koboSpan" id="kobo.3945.1"> instances to trigger all associated event handlers. </span><code class="inlineCode"><span class="koboSpan" id="kobo.3946.1">ConstraintViolationException</span></code><span class="koboSpan" id="kobo.3947.1"> is created by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3948.1">IUnitOdWork</span></code><span class="koboSpan" id="kobo.3949.1"> implementation in case of unique key violations. </span><span class="koboSpan" id="kobo.3949.2">In our case, this exception can be thrown just when we receive a duplicate </span><code class="inlineCode"><span class="koboSpan" id="kobo.3950.1">RouterOfferMessage</span></code><span class="koboSpan" id="kobo.3951.1">. </span><span class="koboSpan" id="kobo.3951.2">Therefore, we simply capture it and do nothing, since duplicate messages must be ignored.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.3952.1">RouteRequestMessageHandler</span></code><span class="koboSpan" id="kobo.3953.1"> is completely analogous, so we will not describe it. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.3954.1">Let’s move </span><a id="_idIndexMarker496"/><span class="koboSpan" id="kobo.3955.1">on to </span><a id="_idIndexMarker497"/><span class="koboSpan" id="kobo.3956.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3957.1">RouteClosedAbortedMessage</span></code><span class="koboSpan" id="kobo.3958.1"> handler:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3959.1">    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3960.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3961.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3962.1">HandleAsync</span></span><span class="koboSpan" id="kobo.3963.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3964.1">MessageCommand</span></span><span class="koboSpan" id="kobo.3965.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.3966.1">RouteClosedAbortedMessage</span></span><span class="koboSpan" id="kobo.3967.1">&gt; command)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3968.1">var</span></span><span class="koboSpan" id="kobo.3969.1"> message = command.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3970.1">Message</span></span><span class="koboSpan" id="kobo.3971.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3972.1">await</span></span><span class="koboSpan" id="kobo.3973.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3974.1">StartAsync</span></span><span class="koboSpan" id="kobo.3975.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.3976.1">System</span></span><span class="koboSpan" id="kobo.3977.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3978.1">Data</span></span><span class="koboSpan" id="kobo.3979.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3980.1">IsolationLevel</span></span><span class="koboSpan" id="kobo.3981.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3982.1">Serializable</span></span><span class="koboSpan" id="kobo.3983.1">);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3984.1">try</span></span><span class="koboSpan" id="kobo.3985.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3986.1">var</span></span><span class="koboSpan" id="kobo.3987.1"> route = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3988.1">await</span></span><span class="koboSpan" id="kobo.3989.1"> repo.</span><span class="hljs-title"><span class="koboSpan" id="kobo.3990.1">Get</span></span><span class="koboSpan" id="kobo.3991.1">(message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.3992.1">RouteId</span></span><span class="koboSpan" id="kobo.3993.1">);
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3994.1">if</span></span><span class="koboSpan" id="kobo.3995.1"> (route is not </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3996.1">null</span></span><span class="koboSpan" id="kobo.3997.1">)
            {
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3998.1">if</span></span><span class="koboSpan" id="kobo.3999.1">(!message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4000.1">IsAborted</span></span><span class="koboSpan" id="kobo.4001.1">)
                {
                    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4002.1">if</span></span><span class="koboSpan" id="kobo.4003.1">(route.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4004.1">Status</span></span><span class="koboSpan" id="kobo.4005.1"> != </span><span class="hljs-title"><span class="koboSpan" id="kobo.4006.1">RouteStatus</span></span><span class="koboSpan" id="kobo.4007.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4008.1">Open</span></span><span class="koboSpan" id="kobo.4009.1">)
                    {
                        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4010.1">await</span></span><span class="koboSpan" id="kobo.4011.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4012.1">RollbackAsync</span></span><span class="koboSpan" id="kobo.4013.1">();
                        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4014.1">return</span></span><span class="koboSpan" id="kobo.4015.1">;
                    }
                    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4016.1">else</span></span><span class="koboSpan" id="kobo.4017.1"> route.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4018.1">Close</span></span><span class="koboSpan" id="kobo.4019.1">();
                }
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4020.1">else</span></span><span class="koboSpan" id="kobo.4021.1">
                {
                    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4022.1">if</span></span><span class="koboSpan" id="kobo.4023.1">(route.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4024.1">Status</span></span><span class="koboSpan" id="kobo.4025.1"> == </span><span class="hljs-title"><span class="koboSpan" id="kobo.4026.1">RouteStatus</span></span><span class="koboSpan" id="kobo.4027.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4028.1">Aborted</span></span><span class="koboSpan" id="kobo.4029.1">)
                    {
                        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4030.1">await</span></span><span class="koboSpan" id="kobo.4031.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4032.1">RollbackAsync</span></span><span class="koboSpan" id="kobo.4033.1">();
                        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4034.1">return</span></span><span class="koboSpan" id="kobo.4035.1">;
                    }
                    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4036.1">else</span></span><span class="koboSpan" id="kobo.4037.1"> route.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4038.1">Abort</span></span><span class="koboSpan" id="kobo.4039.1">();
                }
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4040.1">if</span></span><span class="koboSpan" id="kobo.4041.1"> (route.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4042.1">DomainEvents</span></span><span class="koboSpan" id="kobo.4043.1"> != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.4044.1">null</span></span><span class="koboSpan" id="kobo.4045.1"> &amp;&amp; route.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4046.1">DomainEvents</span></span><span class="koboSpan" id="kobo.4047.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4048.1">Count</span></span><span class="koboSpan" id="kobo.4049.1"> 
                    &gt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.4050.1">0</span></span><span class="koboSpan" id="kobo.4051.1">)
                    mediator.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4052.1">Equals</span></span><span class="koboSpan" id="kobo.4053.1">(route.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4054.1">DomainEvents</span></span><span class="koboSpan" id="kobo.4055.1">);
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4056.1">await</span></span><span class="koboSpan" id="kobo.4057.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4058.1">SaveEntitiesAsync</span></span><span class="koboSpan" id="kobo.4059.1">();
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4060.1">await</span></span><span class="koboSpan" id="kobo.4061.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4062.1">CommitAsync</span></span><span class="koboSpan" id="kobo.4063.1">();
            }
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4064.1">else</span></span><span class="koboSpan" id="kobo.4065.1">
            {
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4066.1">await</span></span><span class="koboSpan" id="kobo.4067.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4068.1">RollbackAsync</span></span><span class="koboSpan" id="kobo.4069.1">();
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4070.1">return</span></span><span class="koboSpan" id="kobo.4071.1">;
            }
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4072.1">catch</span></span><span class="koboSpan" id="kobo.4073.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4074.1">await</span></span><span class="koboSpan" id="kobo.4075.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4076.1">RollbackAsync</span></span><span class="koboSpan" id="kobo.4077.1">();
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4078.1">throw</span></span><span class="koboSpan" id="kobo.4079.1">;
        }
        
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4080.1">The whole operation is enclosed in a serializable transaction to avoid interferences with other microservice replicas that might receive older or future messages concerning the same route offer. </span><span class="koboSpan" id="kobo.4080.2">In fact, they might modify the same entity after it has been read but before it has been modified. </span><span class="koboSpan" id="kobo.4080.3">The serializable transaction prevents this possibility.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4081.1">If we don’t find the entity, we do nothing and simply abort the transaction. </span><span class="koboSpan" id="kobo.4081.2">In fact, this eventuality might take place only if the route expires and is deleted. </span><span class="koboSpan" id="kobo.4081.3">However, if entities are deleted after enough time has passed since they expired, this should be a substantially impossible event.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4082.1">If the message specifies </span><a id="_idIndexMarker498"/><span class="koboSpan" id="kobo.4083.1">that the route must be closed, we put the aggregate </span><a id="_idIndexMarker499"/><span class="koboSpan" id="kobo.4084.1">in the closed state by calling </span><code class="inlineCode"><span class="koboSpan" id="kobo.4085.1">Close()</span></code><span class="koboSpan" id="kobo.4086.1"> only if the aggregate is still open. </span><span class="koboSpan" id="kobo.4086.2">In fact, if it is either already closed or aborted, this will be an old message or a duplicate that must be ignored.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4087.1">Similarly, if the message specifies that the route should be aborted, it is processed only if the aggregate is not already in an aborted state.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4088.1">Finally, in case of errors, we abort the transaction and rethrow the exception, so the message will not be confirmed and the message will be processed again at a later time, possibly by a different replica.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4089.1">Now, let’s move on to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4090.1">RouteExtendedMessage</span></code><span class="koboSpan" id="kobo.4091.1"> handler:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4092.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4093.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4094.1">RouteExtendedMessageHandler</span></span><span class="koboSpan" id="kobo.4095.1">(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4096.1">IRouteOfferRepository</span></span><span class="koboSpan" id="kobo.4097.1"> repo,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4098.1">IUnitOfWork</span></span><span class="koboSpan" id="kobo.4099.1"> uow,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4100.1">EventMediator</span></span><span class="koboSpan" id="kobo.4101.1"> mediator
    ) : </span><span class="hljs-title"><span class="koboSpan" id="kobo.4102.1">ICommandHandler</span></span><span class="koboSpan" id="kobo.4103.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.4104.1">MessageCommand</span></span><span class="koboSpan" id="kobo.4105.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.4106.1">RouteExtendedMessage</span></span><span class="koboSpan" id="kobo.4107.1">&gt;&gt;
{
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4108.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4109.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4110.1">HandleAsync</span></span><span class="koboSpan" id="kobo.4111.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.4112.1">MessageCommand</span></span><span class="koboSpan" id="kobo.4113.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.4114.1">RouteExtendedMessage</span></span><span class="koboSpan" id="kobo.4115.1">&gt; command)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4116.1">var</span></span><span class="koboSpan" id="kobo.4117.1"> message = command.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4118.1">Message</span></span><span class="koboSpan" id="kobo.4119.1">;
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4120.1">await</span></span><span class="koboSpan" id="kobo.4121.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4122.1">StartAsync</span></span><span class="koboSpan" id="kobo.4123.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.4124.1">System</span></span><span class="koboSpan" id="kobo.4125.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4126.1">Data</span></span><span class="koboSpan" id="kobo.4127.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4128.1">IsolationLevel</span></span><span class="koboSpan" id="kobo.4129.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4130.1">Serializable</span></span><span class="koboSpan" id="kobo.4131.1">);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4132.1">try</span></span><span class="koboSpan" id="kobo.4133.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4134.1">var</span></span><span class="koboSpan" id="kobo.4135.1"> route = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4136.1">await</span></span><span class="koboSpan" id="kobo.4137.1"> repo.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4138.1">Get</span></span><span class="koboSpan" id="kobo.4139.1">(message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4140.1">ExtendedRoute</span></span><span class="koboSpan" id="kobo.4141.1">!.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4142.1">Id</span></span><span class="koboSpan" id="kobo.4143.1">);
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4144.1">if</span></span><span class="koboSpan" id="kobo.4145.1"> (route is not </span><span class="hljs-literal"><span class="koboSpan" id="kobo.4146.1">null</span></span><span class="koboSpan" id="kobo.4147.1"> &amp;&amp; route.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4148.1">TimeStamp</span></span><span class="koboSpan" id="kobo.4149.1"> != message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4150.1">TimeStamp</span></span><span class="koboSpan" id="kobo.4151.1">)
            {
                route.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4152.1">Extend</span></span><span class="koboSpan" id="kobo.4153.1">(message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4154.1">TimeStamp</span></span><span class="koboSpan" id="kobo.4155.1">,
                    message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4156.1">AddedRequests</span></span><span class="koboSpan" id="kobo.4157.1">!.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4158.1">Select</span></span><span class="koboSpan" id="kobo.4159.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.4160.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4161.1"> =&gt;</span></span><span class="koboSpan" id="kobo.4162.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4163.1">Id</span></span><span class="koboSpan" id="kobo.4164.1">),
                    message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4165.1">ExtendedRoute</span></span><span class="koboSpan" id="kobo.4166.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4167.1">Path</span></span><span class="koboSpan" id="kobo.4168.1">!
                        </span><span class="koboSpan" id="kobo.4168.2">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4169.1">Select</span></span><span class="koboSpan" id="kobo.4170.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.4171.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4172.1"> =&gt;</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.4173.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4174.1">Coordinate</span></span><span class="koboSpan" id="kobo.4175.1">(m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4176.1">Location</span></span><span class="koboSpan" id="kobo.4177.1">!.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4178.1">Longitude</span></span><span class="koboSpan" id="kobo.4179.1">,
                            m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4180.1">Location</span></span><span class="koboSpan" id="kobo.4181.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4182.1">Latitude</span></span><span class="koboSpan" id="kobo.4183.1">)).</span><span class="hljs-title"><span class="koboSpan" id="kobo.4184.1">ToArray</span></span><span class="koboSpan" id="kobo.4185.1">(),message.
                              </span><span class="hljs-property"><span class="koboSpan" id="kobo.4186.1">Closed</span></span><span class="koboSpan" id="kobo.4187.1">);
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4188.1">if</span></span><span class="koboSpan" id="kobo.4189.1"> (route.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4190.1">DomainEvents</span></span><span class="koboSpan" id="kobo.4191.1"> != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.4192.1">null</span></span><span class="koboSpan" id="kobo.4193.1"> &amp;&amp; route.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4194.1">DomainEvents</span></span><span class="koboSpan" id="kobo.4195.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4196.1">Count</span></span><span class="koboSpan" id="kobo.4197.1"> 
                    &gt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.4198.1">0</span></span><span class="koboSpan" id="kobo.4199.1">)
                    mediator.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4200.1">Equals</span></span><span class="koboSpan" id="kobo.4201.1">(route.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4202.1">DomainEvents</span></span><span class="koboSpan" id="kobo.4203.1">);
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4204.1">await</span></span><span class="koboSpan" id="kobo.4205.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4206.1">SaveEntitiesAsync</span></span><span class="koboSpan" id="kobo.4207.1">();
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4208.1">await</span></span><span class="koboSpan" id="kobo.4209.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4210.1">CommitAsync</span></span><span class="koboSpan" id="kobo.4211.1">();
            }
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4212.1">else</span></span><span class="koboSpan" id="kobo.4213.1">
            {
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4214.1">await</span></span><span class="koboSpan" id="kobo.4215.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4216.1">RollbackAsync</span></span><span class="koboSpan" id="kobo.4217.1">();
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4218.1">return</span></span><span class="koboSpan" id="kobo.4219.1">;
            }
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4220.1">catch</span></span><span class="koboSpan" id="kobo.4221.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4222.1">await</span></span><span class="koboSpan" id="kobo.4223.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4224.1">RollbackAsync</span></span><span class="koboSpan" id="kobo.4225.1">();
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4226.1">throw</span></span><span class="koboSpan" id="kobo.4227.1">;
        }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4228.1">Also, in this case, since the </span><a id="_idIndexMarker500"/><span class="koboSpan" id="kobo.4229.1">command handler performs both a read </span><a id="_idIndexMarker501"/><span class="koboSpan" id="kobo.4230.1">and a modification, we need an explicit transaction. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.4231.1">Again, if no entity is found, we do nothing for the same reasons explained for the previous handler. </span><span class="koboSpan" id="kobo.4231.2">We also do nothing if the message timestamp is identical to the one contained in the entity, because in this case, the message is a duplicate. </span><span class="koboSpan" id="kobo.4231.3">Otherwise, we simply call the aggregate </span><code class="inlineCode"><span class="koboSpan" id="kobo.4232.1">Extend</span></code><span class="koboSpan" id="kobo.4233.1"> method, and then trigger possible events generated by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4234.1">Extend</span></code><span class="koboSpan" id="kobo.4235.1"> method.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4236.1">Let’s now move on to handlers that are not related to messages. </span><span class="koboSpan" id="kobo.4236.2">They are placed in the root of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4237.1">CommandHandlers</span></code><span class="koboSpan" id="kobo.4238.1"> folder.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4239.1">Let’s start with </span><code class="inlineCode"><span class="koboSpan" id="kobo.4240.1">HouseKeepingCommandHandler</span></code><span class="koboSpan" id="kobo.4241.1">, which deletes old expired requests and routes:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4242.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4243.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4244.1">HouseKeepingCommandHandler</span></span><span class="koboSpan" id="kobo.4245.1">(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4246.1">IRouteRequestRepository</span></span><span class="koboSpan" id="kobo.4247.1"> requestRepo,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4248.1">IRouteOfferRepository</span></span><span class="koboSpan" id="kobo.4249.1"> offerRepo
    ) : </span><span class="hljs-title"><span class="koboSpan" id="kobo.4250.1">ICommandHandler</span></span><span class="koboSpan" id="kobo.4251.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.4252.1">HouseKeepingCommand</span></span><span class="koboSpan" id="kobo.4253.1">&gt;
{
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4254.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4255.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4256.1">HandleAsync</span></span><span class="koboSpan" id="kobo.4257.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.4258.1">HouseKeepingCommand</span></span><span class="koboSpan" id="kobo.4259.1"> command)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4260.1">var</span></span><span class="koboSpan" id="kobo.4261.1"> deleteTrigger = </span><span class="hljs-title"><span class="koboSpan" id="kobo.4262.1">DateTime</span></span><span class="koboSpan" id="kobo.4263.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4264.1">Now</span></span><span class="koboSpan" id="kobo.4265.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4266.1">AddDays</span></span><span class="koboSpan" id="kobo.4267.1">( -command.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4268.1">DeleteDelay</span></span><span class="koboSpan" id="kobo.4269.1"> );
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4270.1">await</span></span><span class="koboSpan" id="kobo.4271.1"> offerRepo.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4272.1">DeleteBefore</span></span><span class="koboSpan" id="kobo.4273.1">(deleteTrigger);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4274.1">await</span></span><span class="koboSpan" id="kobo.4275.1"> requestRepo.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4276.1">DeleteBefore</span></span><span class="koboSpan" id="kobo.4277.1">(deleteTrigger);
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4278.1">It is very simple, since it just subtracts the delay or the deletion of all expired entities from the current time and </span><a id="_idIndexMarker502"/><span class="koboSpan" id="kobo.4279.1">then calls the repository methods for deleting routes </span><a id="_idIndexMarker503"/><span class="koboSpan" id="kobo.4280.1">and requests. </span><span class="koboSpan" id="kobo.4280.2">It doesn’t need to save changes since each of these methods already interacts with the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4281.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.4282.1">OutputSendingCommandHandler</span></code><span class="koboSpan" id="kobo.4283.1"> that handles the output queue is a little bit more complex:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4284.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4285.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4286.1">OutputSendingCommandHandler</span></span><span class="koboSpan" id="kobo.4287.1">(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4288.1">IOutputQueueRepository</span></span><span class="koboSpan" id="kobo.4289.1"> repo,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4290.1">IUnitOfWork</span></span><span class="koboSpan" id="kobo.4291.1"> uow
    ): </span><span class="hljs-title"><span class="koboSpan" id="kobo.4292.1">ICommandHandler</span></span><span class="koboSpan" id="kobo.4293.1">&lt;
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.4294.1">OutputSendingCommand</span></span><span class="koboSpan" id="kobo.4295.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.4296.1">RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.4297.1">&gt;&gt;
{
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4298.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4299.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4300.1">HandleAsync</span></span><span class="koboSpan" id="kobo.4301.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.4302.1">OutputSendingCommand</span></span><span class="koboSpan" id="kobo.4303.1">&lt;
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.4304.1">RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.4305.1">&gt; command)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4306.1">var</span></span><span class="koboSpan" id="kobo.4307.1"> aggregates =</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4308.1">await</span></span><span class="koboSpan" id="kobo.4309.1"> repo.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4310.1">Take</span></span><span class="koboSpan" id="kobo.4311.1">
            (command.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4312.1">BatchCount</span></span><span class="koboSpan" id="kobo.4313.1">, command.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4314.1">RequeueDelay</span></span><span class="koboSpan" id="kobo.4315.1">);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4316.1">if</span></span><span class="koboSpan" id="kobo.4317.1">(aggregates.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4318.1">Count</span></span><span class="koboSpan" id="kobo.4319.1">==</span><span class="hljs-number"><span class="koboSpan" id="kobo.4320.1">0</span></span><span class="koboSpan" id="kobo.4321.1">)
        {
            command.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4322.1">OutPutEmpty</span></span><span class="koboSpan" id="kobo.4323.1"> = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.4324.1">true</span></span><span class="koboSpan" id="kobo.4325.1">;
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4326.1">return</span></span><span class="koboSpan" id="kobo.4327.1">;
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4328.1">var</span></span><span class="koboSpan" id="kobo.4329.1"> allTasks = aggregates.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4330.1">Select</span></span><span class="koboSpan" id="kobo.4331.1">(
            </span><span class="hljs-params"><span class="koboSpan" id="kobo.4332.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4333.1"> =&gt;</span></span><span class="koboSpan" id="kobo.4334.1"> (m, command.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4335.1">Sender</span></span><span class="koboSpan" id="kobo.4336.1">(m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4337.1">GetMessage</span></span><span class="koboSpan" id="kobo.4338.1">&lt;
                </span><span class="hljs-title"><span class="koboSpan" id="kobo.4339.1">RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.4340.1">&gt;()!)))
            .</span><span class="hljs-title"><span class="koboSpan" id="kobo.4341.1">ToDictionary</span></span><span class="koboSpan" id="kobo.4342.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.4343.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4344.1"> =&gt;</span></span><span class="koboSpan" id="kobo.4345.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4346.1">Item1</span></span><span class="koboSpan" id="kobo.4347.1">!, </span><span class="hljs-params"><span class="koboSpan" id="kobo.4348.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4349.1"> =&gt;</span></span><span class="koboSpan" id="kobo.4350.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4351.1">Item2</span></span><span class="koboSpan" id="kobo.4352.1"> );
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4353.1">try</span></span><span class="koboSpan" id="kobo.4354.1">
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4355.1">await</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4356.1">Task</span></span><span class="koboSpan" id="kobo.4357.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4358.1">WhenAll</span></span><span class="koboSpan" id="kobo.4359.1">(allTasks.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4360.1">Values</span></span><span class="koboSpan" id="kobo.4361.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4362.1">ToArray</span></span><span class="koboSpan" id="kobo.4363.1">());
        }
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4364.1">catch</span></span><span class="koboSpan" id="kobo.4365.1">
        {
        }
        repo.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4366.1">Confirm</span></span><span class="koboSpan" id="kobo.4367.1">(aggregates
            .</span><span class="hljs-title"><span class="koboSpan" id="kobo.4368.1">Where</span></span><span class="koboSpan" id="kobo.4369.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.4370.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4371.1"> =&gt;</span></span><span class="koboSpan" id="kobo.4372.1">!allTasks[m].</span><span class="hljs-property"><span class="koboSpan" id="kobo.4373.1">IsFaulted</span></span><span class="koboSpan" id="kobo.4374.1"> &amp;&amp; !allTasks[m].</span><span class="hljs-property"><span class="koboSpan" id="kobo.4375.1">IsFaulted</span></span><span class="koboSpan" id="kobo.4376.1">)
            .</span><span class="hljs-title"><span class="koboSpan" id="kobo.4377.1">Select</span></span><span class="koboSpan" id="kobo.4378.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.4379.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4380.1"> =&gt;</span></span><span class="koboSpan" id="kobo.4381.1"> m.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4382.1">Id</span></span><span class="koboSpan" id="kobo.4383.1">).</span><span class="hljs-title"><span class="koboSpan" id="kobo.4384.1">ToArray</span></span><span class="koboSpan" id="kobo.4385.1">());
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4386.1">await</span></span><span class="koboSpan" id="kobo.4387.1"> uow.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4388.1">SaveEntitiesAsync</span></span><span class="koboSpan" id="kobo.4389.1">();
    } 
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4390.1">It tries to take </span><code class="inlineCode"><span class="koboSpan" id="kobo.4391.1">command.BatchCount</span></code><span class="koboSpan" id="kobo.4392.1"> items from the output queue. </span><span class="koboSpan" id="kobo.4392.2">If no item is found, it informs the command that the queue is empty, which, in turn, informs the queue-handling hosted service that it can sleep for a little while. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.4393.1">Then, it deserializes all </span><a id="_idIndexMarker504"/><span class="koboSpan" id="kobo.4394.1">messages and passes them to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4395.1">Sender</span></code><span class="koboSpan" id="kobo.4396.1"> delegate. </span><span class="koboSpan" id="kobo.4396.2">However, instead of awaiting each task returned by this method, it collects all of them, puts them </span><a id="_idIndexMarker505"/><span class="koboSpan" id="kobo.4397.1">in an array, and awaits the whole array with </span><code class="inlineCode"><span class="koboSpan" id="kobo.4398.1">Task.WhenAll</span></code><span class="koboSpan" id="kobo.4399.1">. </span><span class="koboSpan" id="kobo.4399.2">This way, all messages are sent concurrently, thus improving performance. </span><span class="koboSpan" id="kobo.4399.3">In case of exceptions, it simply does nothing, because unsent messages are detected in the LINQ instruction inside </span><code class="inlineCode"><span class="koboSpan" id="kobo.4400.1">repo.Confirm</span></code><span class="koboSpan" id="kobo.4401.1"> and their associated queue items are excluded from the array of all items to confirm, so they will be retried at a later time.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4402.1">We are done with all the command handlers. </span><span class="koboSpan" id="kobo.4402.2">Let’s move on to the event handlers.</span></p>
<h3 class="heading-3" id="_idParaDest-143"><a id="_idTextAnchor200"/><span class="koboSpan" id="kobo.4403.1">Coding all event handlers</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.4404.1">Usually, event handlers do not create transactions and do not attempt to store modifications in the database, since they </span><a id="_idIndexMarker506"/><span class="koboSpan" id="kobo.4405.1">are invoked by command handlers, which do this task for them; so, their code tends to be a little bit simpler. </span><span class="koboSpan" id="kobo.4405.2">We have four event handlers, which are all placed in the root of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4406.1">EventHandlers</span></code><span class="koboSpan" id="kobo.4407.1"> folder.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4408.1">Let’s start with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4409.1">AttachedRequestEvent</span></code><span class="koboSpan" id="kobo.4410.1"> handler:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4411.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4412.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4413.1">AttachedRequestEventHandler</span></span><span class="koboSpan" id="kobo.4414.1">(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4415.1">IRouteRequestRepository</span></span><span class="koboSpan" id="kobo.4416.1"> repo
    ) : </span><span class="hljs-title"><span class="koboSpan" id="kobo.4417.1">IEventHandler</span></span><span class="koboSpan" id="kobo.4418.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.4419.1">AttachedRequestEvent</span></span><span class="koboSpan" id="kobo.4420.1">&gt;
{
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4421.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4422.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4423.1">HandleAsync</span></span><span class="koboSpan" id="kobo.4424.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.4425.1">AttachedRequestEvent</span></span><span class="koboSpan" id="kobo.4426.1"> ev)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4427.1">var</span></span><span class="koboSpan" id="kobo.4428.1"> requests = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4429.1">await</span></span><span class="koboSpan" id="kobo.4430.1"> repo.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4431.1">Get</span></span><span class="koboSpan" id="kobo.4432.1">(ev.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4433.1">AddedRequests</span></span><span class="koboSpan" id="kobo.4434.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4435.1">ToArray</span></span><span class="koboSpan" id="kobo.4436.1">());
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.4437.1">foreach</span></span><span class="koboSpan" id="kobo.4438.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4439.1">var</span></span><span class="koboSpan" id="kobo.4440.1"> request </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4441.1">in</span></span><span class="koboSpan" id="kobo.4442.1"> requests) request.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4443.1">AttachToRoute</span></span><span class="koboSpan" id="kobo.4444.1">(
            ev.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4445.1">RouteOffer</span></span><span class="koboSpan" id="kobo.4446.1">);
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4447.1">This handler is responsible for attaching requests to a route. </span><span class="koboSpan" id="kobo.4447.2">Its code is trivial: it just retrieves all aggregates from their keys and then attaches them to the route referenced in the event.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4448.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.4449.1">ReleasedRequestsEvent</span></code><span class="koboSpan" id="kobo.4450.1"> handler is responsible for releasing all requests attached to an aborted route. </span><span class="koboSpan" id="kobo.4450.2">Its code is trivial, too:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4451.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4452.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4453.1">ReleasedRequestsEventHandler</span></span><span class="koboSpan" id="kobo.4454.1">(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4455.1">IRouteRequestRepository</span></span><span class="koboSpan" id="kobo.4456.1"> repo
    ) : </span><span class="hljs-title"><span class="koboSpan" id="kobo.4457.1">IEventHandler</span></span><span class="koboSpan" id="kobo.4458.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.4459.1">ReleasedRequestsEvent</span></span><span class="koboSpan" id="kobo.4460.1">&gt;
{
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4461.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4462.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4463.1">HandleAsync</span></span><span class="koboSpan" id="kobo.4464.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.4465.1">ReleasedRequestsEvent</span></span><span class="koboSpan" id="kobo.4466.1"> ev)
    {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4467.1">var</span></span><span class="koboSpan" id="kobo.4468.1"> requests=</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4469.1">await</span></span><span class="koboSpan" id="kobo.4470.1"> repo.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4471.1">GetInRoute</span></span><span class="koboSpan" id="kobo.4472.1">(ev.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4473.1">AbortedRoute</span></span><span class="koboSpan" id="kobo.4474.1">);
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.4475.1">foreach</span></span><span class="koboSpan" id="kobo.4476.1">(</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4477.1">var</span></span><span class="koboSpan" id="kobo.4478.1"> request </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4479.1">in</span></span><span class="koboSpan" id="kobo.4480.1"> requests) request.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4481.1">DetachFromRoute</span></span><span class="koboSpan" id="kobo.4482.1">();
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4483.1">It retrieves all requests attached to the route and simply detaches each of them.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4484.1">Finally, we have two </span><a id="_idIndexMarker507"/><span class="koboSpan" id="kobo.4485.1">event handlers that discover route-request matches and add them to the microservice output queue. </span><span class="koboSpan" id="kobo.4485.2">The first one is triggered when a new request is added, while the second one is triggered when a new offer is added. </span><span class="koboSpan" id="kobo.4485.3">Since they are very similar, we will describe just the first one:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.4486.1">internal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4487.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4488.1">RequestMatchCandidateEventHandler</span></span><span class="koboSpan" id="kobo.4489.1">(
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4490.1">IRouteOfferRepository</span></span><span class="koboSpan" id="kobo.4491.1"> offerRepo,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4492.1">IOutputQueueRepository</span></span><span class="koboSpan" id="kobo.4493.1"> queueRepo,
    </span><span class="hljs-title"><span class="koboSpan" id="kobo.4494.1">IConfiguration</span></span><span class="koboSpan" id="kobo.4495.1"> configuration) : 
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.4496.1">IEventHandler</span></span><span class="koboSpan" id="kobo.4497.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.4498.1">NewMatchCandidateEvent</span></span><span class="koboSpan" id="kobo.4499.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.4500.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.4501.1">&gt;&gt;
{
    private </span><span class="hljs-title"><span class="koboSpan" id="kobo.4502.1">RouteRequestMessage</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4503.1">PrepareMessage</span></span><span class="koboSpan" id="kobo.4504.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.4505.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.4506.1"> m)
        =&gt; </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4507.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4508.1">RouteRequestMessage</span></span><span class="koboSpan" id="kobo.4509.1">
        …
         …
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4510.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4511.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4512.1">HandleAsync</span></span><span class="koboSpan" id="kobo.4513.1">(
</span><span class="hljs-title"><span class="koboSpan" id="kobo.4514.1">NewMatchCandidateEvent</span></span><span class="koboSpan" id="kobo.4515.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.4516.1">RouteRequestAggregate</span></span><span class="koboSpan" id="kobo.4517.1">&gt; ev)
    {
        double maxDistance = configuration
            .</span><span class="hljs-property"><span class="koboSpan" id="kobo.4518.1">GetValue</span></span><span class="koboSpan" id="kobo.4519.1">&lt;double&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.4520.1">"Topology:MaxDistanceKm"</span></span><span class="koboSpan" id="kobo.4521.1">) * 1000d;
        int maxResults = configuration
            .</span><span class="hljs-property"><span class="koboSpan" id="kobo.4522.1">GetValue</span></span><span class="koboSpan" id="kobo.4523.1">&lt;int&gt;(</span><span class="hljs-string"><span class="koboSpan" id="kobo.4524.1">"Topology:MaxMatches"</span></span><span class="koboSpan" id="kobo.4525.1">);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4526.1">var</span></span><span class="koboSpan" id="kobo.4527.1"> offers = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4528.1">await</span></span><span class="koboSpan" id="kobo.4529.1"> offerRepo.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4530.1">GetMatch</span></span><span class="koboSpan" id="kobo.4531.1">(
            ev.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4532.1">MatchCandidate</span></span><span class="koboSpan" id="kobo.4533.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4534.1">Source</span></span><span class="koboSpan" id="kobo.4535.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4536.1">Location</span></span><span class="koboSpan" id="kobo.4537.1">, 
            ev.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4538.1">MatchCandidate</span></span><span class="koboSpan" id="kobo.4539.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4540.1">Destination</span></span><span class="koboSpan" id="kobo.4541.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4542.1">Location</span></span><span class="koboSpan" id="kobo.4543.1">,
            ev.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4544.1">MatchCandidate</span></span><span class="koboSpan" id="kobo.4545.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4546.1">When</span></span><span class="koboSpan" id="kobo.4547.1">, maxDistance, maxResults);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4548.1">var</span></span><span class="koboSpan" id="kobo.4549.1"> proposals = </span><span class="hljs-title"><span class="koboSpan" id="kobo.4550.1">Enumerable</span></span><span class="koboSpan" id="kobo.4551.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.4552.1">Repeat</span></span><span class="koboSpan" id="kobo.4553.1">(ev.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4554.1">MatchCandidate</span></span><span class="koboSpan" id="kobo.4555.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.4556.1">1</span></span><span class="koboSpan" id="kobo.4557.1">)
            .</span><span class="hljs-title"><span class="koboSpan" id="kobo.4558.1">Select</span></span><span class="koboSpan" id="kobo.4559.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.4560.1">m</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.4561.1"> =&gt;</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4562.1">PrepareMessage</span></span><span class="koboSpan" id="kobo.4563.1">(m)).</span><span class="hljs-title"><span class="koboSpan" id="kobo.4564.1">ToList</span></span><span class="koboSpan" id="kobo.4565.1">();
        </span><span class="hljs-title"><span class="koboSpan" id="kobo.4566.1">foreach</span></span><span class="koboSpan" id="kobo.4567.1"> (</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4568.1">var</span></span><span class="koboSpan" id="kobo.4569.1"> offer </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4570.1">in</span></span><span class="koboSpan" id="kobo.4571.1"> offers)
        {
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4572.1">var</span></span><span class="koboSpan" id="kobo.4573.1"> message = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.4574.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.4575.1">RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.4576.1">
            {
                </span><span class="hljs-title"><span class="koboSpan" id="kobo.4577.1">RouteId</span></span><span class="koboSpan" id="kobo.4578.1"> = offer.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4579.1">Id</span></span><span class="koboSpan" id="kobo.4580.1">,
                </span><span class="hljs-title"><span class="koboSpan" id="kobo.4581.1">Proposals</span></span><span class="koboSpan" id="kobo.4582.1"> = proposals,
            };
            queueRepo.</span><span class="hljs-property"><span class="koboSpan" id="kobo.4583.1">New</span></span><span class="koboSpan" id="kobo.4584.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.4585.1">RouteExtensionProposalsMessage</span></span><span class="koboSpan" id="kobo.4586.1">&gt;(message, </span><span class="hljs-number"><span class="koboSpan" id="kobo.4587.1">1</span></span><span class="koboSpan" id="kobo.4588.1">);
        }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.4589.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.4590.1">PrepareMessage</span></code><span class="koboSpan" id="kobo.4591.1"> method </span><a id="_idIndexMarker508"/><span class="koboSpan" id="kobo.4592.1">just fills a </span><code class="inlineCode"><span class="koboSpan" id="kobo.4593.1">RouteRequestMessage</span></code><span class="koboSpan" id="kobo.4594.1"> using data contained in the corresponding </span><code class="inlineCode"><span class="koboSpan" id="kobo.4595.1">RouteRequest\regate</span></code><span class="koboSpan" id="kobo.4596.1">. </span><span class="koboSpan" id="kobo.4596.2">We will not describe it, since it is trivial.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4597.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.4598.1">HandleAsync</span></code><span class="koboSpan" id="kobo.4599.1"> method first </span><a id="_idIndexMarker509"/><span class="koboSpan" id="kobo.4600.1">extracts the parameters needed for the search </span><a id="_idIndexMarker510"/><span class="koboSpan" id="kobo.4601.1">from configuration data. </span><span class="koboSpan" id="kobo.4601.2">Then, it calls the repository </span><code class="inlineCode"><span class="koboSpan" id="kobo.4602.1">GetMatch</span></code><span class="koboSpan" id="kobo.4603.1"> method to find all matches. </span><span class="koboSpan" id="kobo.4603.2">Finally, for each route retrieved, it creates an output message and adds it to the internal queue. </span><span class="koboSpan" id="kobo.4603.3">The request is turned into a singleton list since the output message requires a list.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4604.1">The code of our microservice is finished! </span><span class="koboSpan" id="kobo.4604.2">We will test it in the next chapter after connecting it with message sources and message receivers. </span><span class="koboSpan" id="kobo.4604.3">There, we will also implement the microservice health check endpoints and connect them to the orchestrator.</span></p>
<h1 class="heading-1" id="_idParaDest-144"><a id="_idTextAnchor201"/><span class="koboSpan" id="kobo.4605.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.4606.1">This chapter described in detail how to design and code a </span><strong class="keyWord"><span class="koboSpan" id="kobo.4607.1">Dockerized</span></strong><span class="koboSpan" id="kobo.4608.1"> microservice. </span><span class="koboSpan" id="kobo.4608.2">In particular, it described how to design its input and output messages and endpoints, as well as how to use a message broker to implement event-based communication. </span><span class="koboSpan" id="kobo.4608.3">It also described how to handle out-of-order and duplicated messages, concurrent output production with several microservice replicas, and transactional outputs with a database internal queue.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4609.1">Then, it described how the organization of worker services is based on hosted services and how in this case, commands are carried out in one-to-one correspondence with all input messages. </span><span class="koboSpan" id="kobo.4609.2">Finally, it described how to code all of the Onion Architecture levels of any microservice.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4610.1">All concepts were explained through the practical example of the route-planning worker microservice of the book’s case study application. </span><span class="koboSpan" id="kobo.4610.2">You should now understand the practical usage of the RabbitMQ message broker and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4611.1">NetTopologySuite</span></code><span class="koboSpan" id="kobo.4612.1"> library for implementing spatial calculations and queries.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4613.1">The next chapter describes orchestrators with a specific focus on Kubernetes. </span><span class="koboSpan" id="kobo.4613.2">There, we will test the microservice coded in this chapter by connecting it with other microservices, and by using an orchestrator to manage all microservices.</span></p>
<h1 class="heading-1" id="_idParaDest-145"><a id="_idTextAnchor202"/><span class="koboSpan" id="kobo.4614.1">Questions</span></h1>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.4615.1">Do worker microservices typically need authentication and authorization? </span><span class="koboSpan" id="kobo.4615.2">What about encrypted communication protocols?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.4616.1">They don’t need authentication because their processing is not connected to a specific application user. </span><span class="koboSpan" id="kobo.4616.2">Encrypted communication is advised but not always necessary since they run in an isolated environment.</span></p>
<ol>
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.4617.1">Where is it advised to place all microservices’ input and output messages?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.4618.1">In some kind of queues.</span></p>
<ol>
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.4619.1">What is the name of the technique for maintaining the right processing order of messages while using several microservice replicas?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.4620.1">Sharding.</span></p>
<ol>
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.4621.1">Is it true that if modification messages contain the whole updated entities, and if deletes are logical, then the order of messages doesn’t matter? </span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.4622.1">Yes, it is true.</span></p>
<ol>
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.4623.1">Which library is typically used in .NET for handling failures with retry policies?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.4624.1">Polly is used in .NET for handling failures with retry policies.</span></p>
<ol>
<li class="numberedList" value="6"><span class="koboSpan" id="kobo.4625.1">Where are domain events created? </span><span class="koboSpan" id="kobo.4625.2">Where are they before their handlers are fired?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.4626.1">In a list contained in the aggregates that created them.</span></p>
<ol>
<li class="numberedList" value="7"><span class="koboSpan" id="kobo.4627.1">Why do event handlers typically not use transactions and </span><code class="inlineCode"><span class="koboSpan" id="kobo.4628.1">IUnitOfWork.SaveEntitiesAsync</span></code><span class="koboSpan" id="kobo.4629.1">?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.4630.1">Because transactions are created and handled by the Command Handlers that caused the events.</span></p>
<ol>
<li class="numberedList" value="8"><span class="koboSpan" id="kobo.4631.1">When sending several concurrent output messages, how can we discover which ones succeeded, which ones failed, and which ones were canceled?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.4632.1">Through acknowledgments.</span></p>
<ol>
<li class="numberedList" value="9"><span class="koboSpan" id="kobo.4633.1">What is an SRID?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.4634.1">Spatial Reference Identifiers. </span><span class="koboSpan" id="kobo.4634.2">They name geographic coordinate systems.</span></p>
<ol>
<li class="numberedList" value="10"><span class="koboSpan" id="kobo.4635.1">Can the </span><code class="inlineCode"><span class="koboSpan" id="kobo.4636.1">Distance</span></code><span class="koboSpan" id="kobo.4637.1"> method of all </span><code class="inlineCode"><span class="koboSpan" id="kobo.4638.1">NetTopologySuite</span></code><span class="koboSpan" id="kobo.4639.1"> geometric objects be used in LINQ queries to a SQL Server database?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.4640.1">Yes.</span></p>
<h1 class="heading-1" id="_idParaDest-146"><a id="_idTextAnchor203"/><span class="koboSpan" id="kobo.4641.1">Further reading</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.4642.1">RabbitMQ official documentation: </span><a href="https://www.rabbitmq.com/"><span class="url"><span class="koboSpan" id="kobo.4643.1">https://www.rabbitmq.com/</span></span></a><span class="koboSpan" id="kobo.4644.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.4645.1">EasyNetQ official documentation: </span><a href="https://github.com/EasyNetQ/EasyNetQ/wiki/Introduction"><span class="url"><span class="koboSpan" id="kobo.4646.1">https://github.com/EasyNetQ/EasyNetQ/wiki/Introduction</span></span></a><span class="koboSpan" id="kobo.4647.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.4648.1">Polly documentation: </span><a href="https://github.com/App-vNext/Polly"><span class="url"><span class="koboSpan" id="kobo.4649.1">https://github.com/App-vNext/Polly</span></span></a><span class="koboSpan" id="kobo.4650.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.4651.1">RabbitMQ sharding plugin: </span><a href="https://github.com/rabbitmq/rabbitmq-server/tree/main/deps/rabbitmq_sharding"><span class="url"><span class="koboSpan" id="kobo.4652.1">https://github.com/rabbitmq/rabbitmq-server/tree/main/deps/rabbitmq_sharding</span></span></a><span class="koboSpan" id="kobo.4653.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.4654.1">Spatial data extensions for Entity Framework Core: </span><a href="https://learn.microsoft.com/en-us/ef/core/modeling/spatial"><span class="url"><span class="koboSpan" id="kobo.4655.1">https://learn.microsoft.com/en-us/ef/core/modeling/spatial</span></span></a><span class="koboSpan" id="kobo.4656.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.4657.1">NetTopologySuite: </span><a href="https://nettopologysuite.github.io/NetTopologySuite/"><span class="url"><span class="koboSpan" id="kobo.4658.1">https://nettopologysuite.github.io/NetTopologySuite/</span></span></a><span class="koboSpan" id="kobo.4659.1">.</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-147"><a id="_idTextAnchor204"/><span class="koboSpan" id="kobo.4660.1">Join our community on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.4661.1">Join our community’s Discord space for discussions with the author and other readers:</span></p>
<p class="normal"><a href="https://packt.link/PSMCSharp"><span class="url"><span class="koboSpan" id="kobo.4662.1">https://packt.link/PSMCSharp</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.4663.1"><img alt="A qr code with black squares  AI-generated content may be incorrect." src="../Images/B31916_Discord-QR-Code.png"/></span></p>
</div>
</body></html>