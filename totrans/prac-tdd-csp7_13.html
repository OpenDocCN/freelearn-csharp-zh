<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Unraveling a Mess</h1>
                
            
            <article>
                
<p class="calibre2">Not all applications were written with testing in mind. Few were originally developed using TDD. Often, the original developers are long gone, and documentation is incorrect, incomplete, or missing entirely. </p>
<p class="calibre2">In this chapter, we will gain an understanding of:</p>
<ul class="calibre7">
<li class="calibre8">Dealing with inherited code</li>
<li class="calibre8"><span>Characterization tests</span></li>
<li class="calibre8">Refactoring with tests</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Inheriting code</h1>
                
            
            <article>
                
<p class="calibre2">This chapter is a case study of legacy code that needs (what should be) a minor change. We will quickly find out that the change is not so minor. To begin, let's look at what the legacy application does.</p>
<p class="calibre2">Here is some sample output from a run of this code:</p>
<pre class="calibre19">Take a guess: AAAA<br class="title-page-name"/>---+<br class="title-page-name"/>Take a guess: BBBA<br class="title-page-name"/>-+-+<br class="title-page-name"/>Take a guess: CBCA<br class="title-page-name"/>++<br class="title-page-name"/>Take a guess: DBDA<br class="title-page-name"/>++-+</pre>
<pre class="calibre19">Take a guess: DBEA<br class="title-page-name"/>++++<br class="title-page-name"/>Congratulations you guessed the password in 5 tries.<br class="title-page-name"/>Press any key to quit.</pre>
<p class="calibre2">Looking at the interactions, this program doesn't look that bad. In speaking with the business analyst, the application was explained as a game.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">The game</h1>
                
            
            <article>
                
<p class="calibre2">This particular game is called <em class="calibre12">Mastermind</em> and is a code breaking puzzle. According to the business analyst, the code consists of the letters A through F and contains four of the letters chosen at random. It is the goal of the player to determine the passcode.</p>
<p class="calibre2">The player is given hints along the way. For a correctly placed letter, the player receives a plus symbol. For a correct letter in the wrong position, the player receives a minus symbol. If the letter is incorrect, the player receives no symbol.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">A change is requested</h1>
                
            
            <article>
                
<p class="calibre2">During play testing, it was determined that players were discovering the passcodes too quickly. As a result, the game wasn't as much fun as it could be. The suggested solution was to make the passcode more complex by allowing more than six letters to be used. It is our job to extend the character range to A through Z.</p>
<p class="calibre2">We can start by looking at the existing code to determine where we might have to make the change. That is where we discover this!</p>
<p class="calibre2">In the file <kbd class="calibre11">Program.cs</kbd>:</p>
<pre class="calibre19">class Program<br class="title-page-name"/>{<br class="title-page-name"/>  static void Main(string[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    char[] g;<br class="title-page-name"/>    char[] p = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/>    int i = 0;<br class="title-page-name"/>    int j = 0;<br class="title-page-name"/>    int x = 0;<br class="title-page-name"/>    int c = 0;<br class="title-page-name"/>    Random rand = new Random(DateTime.Now.Millisecond);<br class="title-page-name"/>    if (args.Length &gt; 0 &amp;&amp; args[0] != null) p = args[0].ToCharArray();<br class="title-page-name"/>    else goto randomize_password;<br class="title-page-name"/>    guess: Console.Write("Take a guess: ");<br class="title-page-name"/>    g = Console.ReadLine().ToArray();<br class="title-page-name"/>    i = i + 1;<br class="title-page-name"/>    if (g.Length != 4) goto wrong_size;<br class="title-page-name"/>    if (g == p) goto success;<br class="title-page-name"/>    x = 0;<br class="title-page-name"/>    c = 0;<br class="title-page-name"/>    check_loop:<br class="title-page-name"/>    if (g[x] &gt; 65 + 26) g[x] = (char)(g[x] - 32);<br class="title-page-name"/>    if (g[x] == p[x]) Console.Write("+", c = c + 1);<br class="title-page-name"/>    else if (p.Contains(g[x])) Console.Write("-");<br class="title-page-name"/>    x = x + 1;<br class="title-page-name"/>    if (x &lt; 4) goto check_loop;<br class="title-page-name"/>    Console.WriteLine();<br class="title-page-name"/>    if (c == 4) goto success;<br class="title-page-name"/>    goto guess;<br class="title-page-name"/>    success: Console.WriteLine("Congratulations you guessed the   <br class="title-page-name"/>    password in " + i + " tries.");<br class="title-page-name"/>    goto end;<br class="title-page-name"/>    wrong_size: Console.WriteLine("Password length is 4.");<br class="title-page-name"/>    goto guess;<br class="title-page-name"/>    randomize_password: j = 0;<br class="title-page-name"/>    password_loop: p[j] = (char)(rand.Next(6) + 65);<br class="title-page-name"/>    j = j + 1;<br class="title-page-name"/>    if (j &lt; 4) goto password_loop;<br class="title-page-name"/>    goto guess;<br class="title-page-name"/>    end: Console.WriteLine("Press any key to quit.");<br class="title-page-name"/>    Console.ReadKey();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">We now have several problems. Firstly, it's not exactly clear where the letters are coming from. Secondly, there is no way this code is tested. Lastly, even if making the change were straight forward, making sure we didn't break something would not be. We have to do a full manual regression test to verify that any of this is working, and trying to verify that all letters, A through Z, are possible may take a very long time.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Life sometimes hands you lemons</h1>
                
            
            <article>
                
<p class="calibre2">While I hope you never receive code this bad, we are going to walk through what is needed to turn even this into readable, maintainable, and fully tested code. The best part, the part you aren't going to believe, is that transforming this code is actually safe and fairly easy.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Getting started</h1>
                
            
            <article>
                
<p class="calibre2">In any code situation like this, the first thing we must do is remove the code in question from the environment where we have no control. In this case, we can't test the code if it is sitting in <kbd class="calibre11">Program.main</kbd>. So, let's grab the whole thing and put it into a class named <kbd class="calibre11">Mastermind</kbd>. We will have a single function named <kbd class="calibre11">Play</kbd> that will run the game. This is considered a safe refactoring, because we are not changing any of the existing code, simply moving it somewhere else.</p>
<p class="calibre2">In the file <kbd class="calibre11">Program.cs</kbd>:</p>
<pre class="calibre19">class Program<br class="title-page-name"/>{<br class="title-page-name"/>  static void Main(string[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    var game = new Mastermind();<br class="title-page-name"/>    game.Play(args);<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">Mastermind.cs</kbd>:</p>
<pre class="calibre19">class Mastermind<br class="title-page-name"/>{<br class="title-page-name"/>  public void Play(string[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    char[] g;<br class="title-page-name"/>    char[] p = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/>    int i = 0;<br class="title-page-name"/>    int j = 0;<br class="title-page-name"/>    int x = 0;<br class="title-page-name"/>    int c = 0;<br class="title-page-name"/>    Random rand = new Random(DateTime.Now.Millisecond);<br class="title-page-name"/>    if (args.Length &gt; 0 &amp;&amp; args[0] != null) p = args[0].ToCharArray();<br class="title-page-name"/>    else goto randomize_password;<br class="title-page-name"/>    guess: Console.Write("Take a guess: ");<br class="title-page-name"/>    g = Console.ReadLine().ToArray();<br class="title-page-name"/>    i = i + 1;<br class="title-page-name"/>    if (g.Length != 4) goto wrong_size;<br class="title-page-name"/>    if (g == p) goto success;<br class="title-page-name"/>    x = 0;<br class="title-page-name"/>    c = 0;<br class="title-page-name"/>    check_loop:<br class="title-page-name"/>    if (g[x] &gt; 65 + 26) g[x] = (char)(g[x] - 32);<br class="title-page-name"/>    if (g[x] == p[x]) Console.Write("+", c = c + 1);<br class="title-page-name"/>    else if (p.Contains(g[x])) Console.Write("-");<br class="title-page-name"/>    x = x + 1;<br class="title-page-name"/>    if (x &lt; 4) goto check_loop;<br class="title-page-name"/>    Console.WriteLine();<br class="title-page-name"/>    if (c == 4) goto success;<br class="title-page-name"/>    goto guess;<br class="title-page-name"/>    success: Console.WriteLine("Congratulations you guessed the <br class="title-page-name"/>    password in " + i + " tries.");<br class="title-page-name"/>    goto end;<br class="title-page-name"/>    wrong_size: Console.WriteLine("Password length is 4.");<br class="title-page-name"/>    goto guess;<br class="title-page-name"/>    randomize_password: j = 0;<br class="title-page-name"/>    password_loop: p[j] = (char)(rand.Next(6) + 65);<br class="title-page-name"/>    j = j + 1;<br class="title-page-name"/>    if (j &lt; 4) goto password_loop;<br class="title-page-name"/>    goto guess;<br class="title-page-name"/>    end: Console.WriteLine("Press any key to quit.");<br class="title-page-name"/>    Console.ReadKey();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">Running the code again at this point shows that everything still works. The next step is a cosmetic one; let's spread the <kbd class="calibre11">Play</kbd> method out into sections. This should help us determine what private methods exist inside the large public method.</p>
<p class="calibre2">In the file <kbd class="calibre11">Mastermind.cs</kbd>:</p>
<pre class="calibre19">class Mastermind<br class="title-page-name"/>{<br class="title-page-name"/>  public void Play(string[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    // Variable Declarations - Global??<br class="title-page-name"/>    char[] g;<br class="title-page-name"/>    char[] p = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/>    int i = 0;<br class="title-page-name"/>    int j = 0;<br class="title-page-name"/>    int x = 0;<br class="title-page-name"/>    int c = 0;<br class="title-page-name"/>    // Initialize randomness<br class="title-page-name"/>    Random rand = new Random(DateTime.Now.Millisecond);<br class="title-page-name"/>    // Determine if a password was passed in?<br class="title-page-name"/>    if (args.Length &gt; 0 &amp;&amp; args[0] != null) p = args[0].ToCharArray();<br class="title-page-name"/>    else goto randomize_password; // Create a password if one was not <br class="title-page-name"/>    provided<br class="title-page-name"/>    // Player move - guess the password<br class="title-page-name"/>    guess: Console.Write("Take a guess: ");<br class="title-page-name"/>    g = Console.ReadLine().ToArray();<br class="title-page-name"/>    i = i + 1;<br class="title-page-name"/>    if (g.Length != 4) goto wrong_size;<br class="title-page-name"/>    if (g == p) goto success;<br class="title-page-name"/>    x = 0;<br class="title-page-name"/>    c = 0;<br class="title-page-name"/>    // Check if the password provided by the player is correct<br class="title-page-name"/>    check_loop:<br class="title-page-name"/>    if (g[x] &gt; 65 + 26) g[x] = (char)(g[x] - 32);<br class="title-page-name"/>    if (g[x] == p[x]) Console.Write("+", c = c + 1);<br class="title-page-name"/>    else if (p.Contains(g[x])) Console.Write("-");<br class="title-page-name"/>    x = x + 1;<br class="title-page-name"/>    if (x &lt; 4) goto check_loop; // Still checking??<br class="title-page-name"/>    Console.WriteLine();<br class="title-page-name"/>    if (c == 4) goto success; // Password must have been correct<br class="title-page-name"/>    goto guess; // No correct, try again<br class="title-page-name"/>    // Game over you win<br class="title-page-name"/>    success: Console.WriteLine("Congratulations you guessed the <br class="title-page-name"/>    password in " + i + " tries.");<br class="title-page-name"/>    goto end;<br class="title-page-name"/>    // Password guess was wrong size - Error Message<br class="title-page-name"/>    wrong_size: Console.WriteLine("Password length is 4.");<br class="title-page-name"/>    goto guess;<br class="title-page-name"/>    // Create a random password<br class="title-page-name"/>    randomize_password: j = 0;<br class="title-page-name"/>    password_loop: p[j] = (char)(rand.Next(6) + 65);<br class="title-page-name"/>    j = j + 1;<br class="title-page-name"/>    if (j &lt; 4) goto password_loop;<br class="title-page-name"/>    goto guess; // Start the game<br class="title-page-name"/>    // Game is complete - exit<br class="title-page-name"/>    end: Console.WriteLine("Press any key to quit.");<br class="title-page-name"/>    Console.ReadKey();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">We have now used whitespace to split the program into several pieces and added comments explaining what we think each piece is doing. At this point, we are almost ready to begin testing. We have just a couple things in the way, the worst of which is the <kbd class="calibre11">Console</kbd> class.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Abstracting a third-party class</h1>
                
            
            <article>
                
<p class="calibre2">If we tried to test right now, the application would hit the first <kbd class="calibre11">ReadLine</kbd> call and the test would time out. Console has the ability to redirect the input and output, but we are not going to use this feature, because it is specific to Console and we want to demonstrate a more generic solution that you can apply anywhere.</p>
<p class="calibre2">What we need is a class that gives us a similar interface to Console. Then we can dependency inject our class for the tests and a thin wrapper for the production code. Let's test drive that interface now.</p>
<p class="calibre2">In the file <kbd class="calibre11">InputOutputTests.cs</kbd>:</p>
<pre class="calibre19">public class InputOutputTests<br class="title-page-name"/>{<br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItExists()<br class="title-page-name"/>  {<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">ReadLineTests.cs</kbd>:</p>
<pre class="calibre19">public class ReadLineTests<br class="title-page-name"/>{<br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItCanBeReadFrom()<br class="title-page-name"/>  {<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>    inout.InFeed.Enqueue("Test");<br class="title-page-name"/>    <br class="title-page-name"/>    // Act<br class="title-page-name"/>    var input = inout.ReadLine();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ProvidedInputCanBeRetrieved()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>    inout.InFeed.Enqueue("Test");<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var input = inout.ReadLine();<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    Assert.Equal("Test", input);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ProvidedInputCanBeRetrievedInSuccession()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>    inout.InFeed.Enqueue("Test 1");<br class="title-page-name"/>    inout.InFeed.Enqueue("Test 2");<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var input1 = inout.ReadLine();<br class="title-page-name"/>    var input2 = inout.ReadLine();<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    Assert.Equal("Test 1", input1);<br class="title-page-name"/>    Assert.Equal("Test 2", input2);<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">ReadTests.cs</kbd>:</p>
<pre class="calibre19">public class ReadTests<br class="title-page-name"/>{<br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItCanBeReadFrom() <br class="title-page-name"/>  {<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>    inout.InFeed.Enqueue("T");<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var input = inout.Read();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ProvidedInputCanBeRetrieved()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>    inout.InFeed.Enqueue("T");<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var input = inout.Read();<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    Assert.Equal('T', input);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ProvidedInputCanBeRetrievedInSuccession()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>    inout.InFeed.Enqueue("T");<br class="title-page-name"/>    inout.InFeed.Enqueue("E");<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var input1 = inout.Read();<br class="title-page-name"/>    var input2 = inout.Read();<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    Assert.Equal('T', input1);<br class="title-page-name"/>    Assert.Equal('E', input2);<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">WriteTests.cs</kbd>:</p>
<pre class="calibre19">public class WriteTests<br class="title-page-name"/>{<br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItCanBeWrittenTo()<br class="title-page-name"/>  {<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    inout.Write("Text");<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void WrittenTextCanBeRetrieved()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>    inout.Write("Text");<br class="title-page-name"/><br class="title-page-name"/>    // Act    <br class="title-page-name"/>    var writtenText = inout.OutFeed;<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    Assert.Single(writtenText);<br class="title-page-name"/>    Assert.Equal("Text", writtenText.First());<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">WriteLineTests.cs</kbd>:</p>
<pre class="calibre19">public class WriteLineTests<br class="title-page-name"/>{<br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItCanBeWrittenTo()<br class="title-page-name"/>  {<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    inout.WriteLine("Text");<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void WrittenTextCanBeRetrieved()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>    inout.WriteLine("Text");<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var writtenText = inout.OutFeed;<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    Assert.Single(writtenText);<br class="title-page-name"/>    Assert.Equal("Text" + Environment.NewLine, writtenText.First());<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">IInputOutput.cs</kbd>:</p>
<pre class="calibre19">public interface IInputOutput<br class="title-page-name"/>{<br class="title-page-name"/>  void Write(string text);<br class="title-page-name"/>  void WriteLine(string text);<br class="title-page-name"/>  char Read();<br class="title-page-name"/>  string ReadLine();<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">MockInputOutput.cs</kbd>:</p>
<pre class="calibre19">public class MockInputOutput : IInputOutput<br class="title-page-name"/>{<br class="title-page-name"/>  public List&lt;string&gt; OutFeed { get; set; }<br class="title-page-name"/>  public Queue&lt;string&gt; InFeed { get; set; }<br class="title-page-name"/><br class="title-page-name"/>  public MockInputOutput()<br class="title-page-name"/>  {<br class="title-page-name"/>    OutFeed = new List&lt;string&gt;();<br class="title-page-name"/>    InFeed = new Queue&lt;string&gt;();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public void Write(string text)<br class="title-page-name"/>  {<br class="title-page-name"/>    OutFeed.Add(text);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public void WriteLine(string text)<br class="title-page-name"/>  {<br class="title-page-name"/>    OutFeed.Add(text + Environment.NewLine);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public char Read()<br class="title-page-name"/>  {<br class="title-page-name"/>    return InFeed.Dequeue().ToCharArray().First();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public string ReadLine()<br class="title-page-name"/>  {<br class="title-page-name"/>    return InFeed.Dequeue();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">That handles our mock input and output, but we need to create the production wrapper class for Console, and we need to use <kbd class="calibre11">Program.cs</kbd> to inject that class into the <kbd class="calibre11">Mastermind</kbd> class.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Unexpected Input</h1>
                
            
            <article>
                
<p class="calibre2">While replacing calls to Console with calls to our injected class, we found two use cases that we did not plan for. The first use case is fairly involved and has a couple parameters we need to handle:</p>
<pre class="calibre19">Console.Write("+", c = c + 1);</pre>
<p class="calibre2">The second use case is more simple and doesn't take any parameters:</p>
<pre class="calibre19">Console.WriteLine();</pre>
<p class="calibre2">The second use case is the easiest to deal with, so let us write a quick test for that now.</p>
<p class="calibre2">In the file <kbd class="calibre11">WriteLineTests.cs</kbd>:</p>
<pre class="calibre19">[Fact]<br class="title-page-name"/>public void ItCanWriteABlankLine()<br class="title-page-name"/>{<br class="title-page-name"/>  // Arrange<br class="title-page-name"/>  var inout = new MockInputOutput();<br class="title-page-name"/><br class="title-page-name"/>  // Act<br class="title-page-name"/>  inout.WriteLine();<br class="title-page-name"/><br class="title-page-name"/>  // Assert<br class="title-page-name"/>  Assert.Single(inout.OutFeed);<br class="title-page-name"/>  Assert.Equal(Environment.NewLine, inout.OutFeed.First());<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">IInputOutput.cs</kbd>:</p>
<pre class="calibre19">void WriteLine(string text = null);</pre>
<p class="calibre2">In the file <kbd class="calibre11">MockInputOutput.cs</kbd>:</p>
<pre class="calibre19">public void WriteLine(string text = null)<br class="title-page-name"/>{<br class="title-page-name"/>  OutFeed.Add((text ?? "") + Environment.NewLine);<br class="title-page-name"/>}</pre>
<p class="calibre2">The next issue is slightly more complicated. If we want to handle it accurately, we will need to do quite a bit of regular expression and string manipulation. However, we don't need it to be "correct"; we only need it to work as expected by the application. In the singular case where this is being used, the value that should be placed into the string being written, isn't. The original developer abused the functionality of <kbd class="calibre11">Console.Write</kbd> to reduce the number of lines in the if statement so they could avoid brackets. So, all we need to do for the code to continue to work is allow for the input to take place. A simple interface extension should provide that for us.</p>
<p class="calibre2">In the file <kbd class="calibre11">IInputOutput.cs</kbd>:</p>
<pre class="calibre19">void Write(string text, params object[] args);</pre>
<p class="calibre2">In the file <kbd class="calibre11">MockInputOutput.cs</kbd>:</p>
<pre class="calibre19">public void Write(string text, params object[] args)<br class="title-page-name"/>{<br class="title-page-name"/>  OutFeed.Add(text);<br class="title-page-name"/>}</pre>
<p class="calibre2">Back in the application code, we can finish making our changes. Here is the updated application.</p>
<p class="calibre2">In the file <kbd class="calibre11">ConsoleInputOutput.cs</kbd>:</p>
<pre class="calibre19">public class ConsoleInputOutput : IInputOutput<br class="title-page-name"/>{<br class="title-page-name"/>  public void Write(string text, params object[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    Console.Write(text, args);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public void WriteLine(string text)<br class="title-page-name"/>  {<br class="title-page-name"/>    Console.WriteLine(text);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public char Read()<br class="title-page-name"/>  {<br class="title-page-name"/>    return Console.ReadKey().KeyChar;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public string ReadLine()<br class="title-page-name"/>  {<br class="title-page-name"/>    return Console.ReadLine();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">Program.cs</kbd>:</p>
<pre class="calibre19">class Program<br class="title-page-name"/>{<br class="title-page-name"/>  static void Main(string[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    var inout = new ConsoleInputOutput();<br class="title-page-name"/>    var game = new Mastermind(inout);<br class="title-page-name"/>    game.Play(args);<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">Mastermind.cs</kbd>:</p>
<pre class="calibre19">public class Mastermind<br class="title-page-name"/>{<br class="title-page-name"/>  private readonly IInputOutput _inout;<br class="title-page-name"/><br class="title-page-name"/>  public Mastermind(IInputOutput inout)<br class="title-page-name"/>  {<br class="title-page-name"/>    _inout = inout;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public void Play(string[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    // Variable Declarations - Global??<br class="title-page-name"/>    char[] g;<br class="title-page-name"/>    char[] p = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/>    int i = 0;<br class="title-page-name"/>    int j = 0;<br class="title-page-name"/>    int x = 0;<br class="title-page-name"/>    int c = 0;<br class="title-page-name"/><br class="title-page-name"/>    // Initialize randomness<br class="title-page-name"/>    Random rand = new Random(DateTime.Now.Millisecond);<br class="title-page-name"/><br class="title-page-name"/>    // Determine if a password was passed in?<br class="title-page-name"/>    if (args.Length &gt; 0 &amp;&amp; args[0] != null) p = args[0].ToCharArray();<br class="title-page-name"/>    else goto randomize_password; // Create a password if one was not <br class="title-page-name"/>    provided<br class="title-page-name"/>    // Player move - guess the password<br class="title-page-name"/>    guess: _inout.Write("Take a guess: ");<br class="title-page-name"/>    g = _inout.ReadLine().ToArray();<br class="title-page-name"/>    i = i + 1;<br class="title-page-name"/>    if (g.Length != 4) goto wrong_size;<br class="title-page-name"/>    if (g == p) goto success;<br class="title-page-name"/>    x = 0;<br class="title-page-name"/>    c = 0;<br class="title-page-name"/><br class="title-page-name"/>    // Check if the password provided by the player is correct<br class="title-page-name"/>    check_loop:<br class="title-page-name"/>    if (g[x] &gt; 65 + 26) g[x] = (char)(g[x] - 32);<br class="title-page-name"/>    if (g[x] == p[x]) _inout.Write("+", c = c + 1);<br class="title-page-name"/>    else if (p.Contains(g[x])) _inout.Write("-");<br class="title-page-name"/>    x = x + 1;<br class="title-page-name"/>    if (x &lt; 4) goto check_loop; // Still checking??<br class="title-page-name"/>    _inout.WriteLine();<br class="title-page-name"/>    if (c == 4) goto success; // Password must have been correct<br class="title-page-name"/>    goto guess; // No correct, try again<br class="title-page-name"/><br class="title-page-name"/>    // Game over you win<br class="title-page-name"/>    success: _inout.WriteLine("Congratulations you guessed the password <br class="title-page-name"/>    in " + i + " tries.");<br class="title-page-name"/>    goto end;<br class="title-page-name"/>    // Password guess was wrong size - Error Message<br class="title-page-name"/>    wrong_size: _inout.WriteLine("Password length is 4.");<br class="title-page-name"/>    goto guess;<br class="title-page-name"/><br class="title-page-name"/>    // Create a random password<br class="title-page-name"/>    randomize_password: j = 0;<br class="title-page-name"/>    password_loop: p[j] = (char)(rand.Next(6) + 65);<br class="title-page-name"/>    j = j + 1;<br class="title-page-name"/>    if (j &lt; 4) goto password_loop;<br class="title-page-name"/>    goto guess; // Start the game<br class="title-page-name"/><br class="title-page-name"/>    // Game is complete - exit<br class="title-page-name"/>    end: _inout.WriteLine("Press any key to quit.");<br class="title-page-name"/>    _inout.Read();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">A quick test run confirms that the application is working correctly:</p>
<pre class="calibre19">Take a guess: AAAA<br class="title-page-name"/>Take a guess: BBBB<br class="title-page-name"/>Take a guess: CCCC<br class="title-page-name"/>Take a guess: DDDD<br class="title-page-name"/>+-++<br class="title-page-name"/>Take a guess: DEDD<br class="title-page-name"/>+++<br class="title-page-name"/>Take a guess: DFDD<br class="title-page-name"/>++++<br class="title-page-name"/>Congratulations you guessed the password in 6 tries.<br class="title-page-name"/><br class="title-page-name"/>Press any key to quit.</pre>
<p class="calibre2">Now, we can write a gold standard or characterization test that will verify all the parts of the code are working correctly. The only piece of the code this test will not cover is the random password generation:</p>
<pre class="calibre19">public class GoldStandardTests<br class="title-page-name"/>{<br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void StandardTestRun()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>    var game = new Mastermind(inout);<br class="title-page-name"/><br class="title-page-name"/>    // Arrange - Inputs<br class="title-page-name"/>    inout.InFeed.Enqueue("AAA");<br class="title-page-name"/>    inout.InFeed.Enqueue("AAAA");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABBB");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABCC");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABCD");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABCF");<br class="title-page-name"/>    inout.InFeed.Enqueue(" ");<br class="title-page-name"/><br class="title-page-name"/>    // Arrange - Outputs<br class="title-page-name"/>    var expectedOutputs = new Queue&lt;string&gt;();<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("Password length is 4." + <br class="title-page-name"/>     Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue("-");<br class="title-page-name"/>    expectedOutputs.Enqueue("-");<br class="title-page-name"/>    expectedOutputs.Enqueue("-");<br class="title-page-name"/>    expectedOutputs.Enqueue(Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue("-");<br class="title-page-name"/>    expectedOutputs.Enqueue("-");<br class="title-page-name"/>    expectedOutputs.Enqueue(Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue("-");<br class="title-page-name"/>    expectedOutputs.Enqueue(Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue(Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue("+");<br class="title-page-name"/>    expectedOutputs.Enqueue(Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Congratulations you guessed the password <br class="title-page-name"/>     in 6 tries." + Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Press any key to quit." + <br class="title-page-name"/>     Environment.NewLine);<br class="title-page-name"/>    // Act<br class="title-page-name"/>    game.Play(new[] { "ABCF" });<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    inout.OutFeed.ForEach((text) =&gt;<br class="title-page-name"/>    {    <br class="title-page-name"/>      Assert.Equal(expectedOutputs.Dequeue(), text);<br class="title-page-name"/>    });<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">This is an extremely long test, and it has an out of the ordinary structure, but this single test runs through almost all the logic in the application. You may not always be able to do this with a single test, but before beginning any heavy refactoring, these tests must exist.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Making sense of the madness</h1>
                
            
            <article>
                
<p class="calibre2">Now that we have the gold standard test written, we can begin to safely refactor the code. Any changes that we try to make that break the gold standard test will have to be undone and a new approach will have to be taken.</p>
<p class="calibre2">Looking at the <kbd class="calibre11">Mastermind</kbd> class, all those variables at the top of the <kbd class="calibre11">Play</kbd> method can be moved out to be class level fields. This will make them available to all the code within the class and help to both figure out what they are for and how often they are used in the app:</p>
<pre class="calibre19">private char[] g;<br class="title-page-name"/>private char[] p = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/>private int i = 0;<br class="title-page-name"/>private int j = 0;<br class="title-page-name"/>private int x = 0;<br class="title-page-name"/>private int c = 0;</pre>
<p class="calibre2">Next, we will just work our way down the <kbd class="calibre11">Play</kbd> method, extracting all that we can into tiny private methods. We are only able to do some tiny refactoring before we need to switch gears and start fixing some of the antiquated logic in this application:</p>
<pre class="calibre19">public class Mastermind<br class="title-page-name"/>{<br class="title-page-name"/>  private readonly IInputOutput _inout;<br class="title-page-name"/>  private char[] g;<br class="title-page-name"/>  private char[] p = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/>  private int i = 0;<br class="title-page-name"/>  private int j = 0;<br class="title-page-name"/>  private int x = 0;<br class="title-page-name"/>  private int c = 0;<br class="title-page-name"/><br class="title-page-name"/>  public Mastermind(IInputOutput inout)<br class="title-page-name"/>  {<br class="title-page-name"/>    _inout = inout;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public void Play(string[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    // Determine if a password was passed in?<br class="title-page-name"/>    if (args.Length &gt; 0 &amp;&amp; args[0] != null) p = args[0].ToCharArray();<br class="title-page-name"/>    else CreateRandomPassword(); // Create a password if one was not <br class="title-page-name"/>    provided<br class="title-page-name"/>    // Player move - guess the password<br class="title-page-name"/>    guess:<br class="title-page-name"/>    _inout.Write("Take a guess: ");<br class="title-page-name"/>    g = _inout.ReadLine().ToArray();<br class="title-page-name"/>    i = i + 1;<br class="title-page-name"/>    if (g.Length != 4) goto wrong_size;<br class="title-page-name"/>    if (g == p) goto success;<br class="title-page-name"/>    x = 0;<br class="title-page-name"/>    c = 0;<br class="title-page-name"/><br class="title-page-name"/>    // Check if the password provided by the player is correct<br class="title-page-name"/>    check_loop:<br class="title-page-name"/>    if (g[x] &gt; 65 + 26) g[x] = (char)(g[x] - 32);<br class="title-page-name"/>    if (g[x] == p[x]) _inout.Write("+", c = c + 1);<br class="title-page-name"/>    else if (p.Contains(g[x])) _inout.Write("-");<br class="title-page-name"/>    x = x + 1;<br class="title-page-name"/>    if (x &lt; 4) goto check_loop; // Still checking??<br class="title-page-name"/>    _inout.WriteLine();<br class="title-page-name"/>    if (c == 4) goto success; // Password must have been correct<br class="title-page-name"/>    goto guess; // No correct, try again<br class="title-page-name"/><br class="title-page-name"/>    // Password guess was wrong size - Error Message<br class="title-page-name"/>    wrong_size: _inout.WriteLine("Password length is 4.");<br class="title-page-name"/>    goto guess;<br class="title-page-name"/><br class="title-page-name"/>    // Game over you win<br class="title-page-name"/>    success: _inout.WriteLine("Congratulations you guessed the password <br class="title-page-name"/>     in " + i + " tries.");<br class="title-page-name"/>    _inout.WriteLine("Press any key to quit.");<br class="title-page-name"/>    _inout.Read();<br class="title-page-name"/>  }<br class="title-page-name"/>  private void CreateRandomPassword()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Initialize randomness<br class="title-page-name"/>    Random rand = new Random(DateTime.Now.Millisecond);<br class="title-page-name"/><br class="title-page-name"/>    j = 0;<br class="title-page-name"/><br class="title-page-name"/>    password_loop:<br class="title-page-name"/>    p[j] = (char)(rand.Next(6) + 65);<br class="title-page-name"/>    j = j + 1;   <br class="title-page-name"/>    if (j &lt; 4) goto password_loop;<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">We were able to break out a password generation method. We were also able to simplify the structure of the success code. We cannot, however, proceed without addressing the complexity of the chosen looping structures. The developer that wrote this did not use general looping structures, such as while and for loops. We need to fix that in order to better understand and work with this code:</p>
<pre class="calibre19">public void Play(string[] args)<br class="title-page-name"/>{<br class="title-page-name"/>  // Determine if a password was passed in?<br class="title-page-name"/>  if (args.Length &gt; 0 &amp;&amp; args[0] != null) p = args[0].ToCharArray();<br class="title-page-name"/>  else CreateRandomPassword(); // Create a password if one was not <br class="title-page-name"/>   provided<br class="title-page-name"/>  // Player move - guess the password           <br class="title-page-name"/>  while (c != 4)<br class="title-page-name"/>  {<br class="title-page-name"/>    _inout.Write("Take a guess: ");<br class="title-page-name"/>    g = _inout.ReadLine().ToArray();<br class="title-page-name"/><br class="title-page-name"/>    i = i + 1;<br class="title-page-name"/><br class="title-page-name"/>    if (g.Length != 4)<br class="title-page-name"/>    {<br class="title-page-name"/>      // Password guess was wrong size - Error Message<br class="title-page-name"/>      _inout.WriteLine("Password length is 4.");<br class="title-page-name"/>    }<br class="title-page-name"/>    else<br class="title-page-name"/>    {<br class="title-page-name"/>      // Check if the password provided by the player is correct<br class="title-page-name"/>      for (x = 0, c = 0; g.Length == 4 &amp;&amp; x &lt; 4; x++)<br class="title-page-name"/>      {<br class="title-page-name"/>        if (g[x] &gt; 65 + 26) g[x] = (char)(g[x] - 32);<br class="title-page-name"/>        if (g[x] == p[x]) _inout.Write("+", c = c + 1);<br class="title-page-name"/>        else if (p.Contains(g[x])) _inout.Write("-");<br class="title-page-name"/>      }<br class="title-page-name"/>    <br class="title-page-name"/>      _inout.WriteLine();<br class="title-page-name"/>    }<br class="title-page-name"/>  }           <br class="title-page-name"/><br class="title-page-name"/>  // Game over you win<br class="title-page-name"/>  _inout.WriteLine("Congratulations you guessed the password in " + i +   <br class="title-page-name"/>  " tries.");<br class="title-page-name"/>  _inout.WriteLine("Press any key to quit.");<br class="title-page-name"/>  _inout.Read();<br class="title-page-name"/>}</pre>
<p class="calibre2">We now have a structure that we can begin to work with. Let's start by making some sense of these variable names:</p>
<pre class="calibre19">C ~= Correct Letter Guesses<br class="title-page-name"/>G ~= Current Guess<br class="title-page-name"/>P ~= Password<br class="title-page-name"/>I ~= Tries<br class="title-page-name"/>X ~= Loop Index / Pointer to Guess Character being checked<br class="title-page-name"/>J ~= Loop Index / Pointer to Password Character being generated</pre>
<p class="cdpalignleft1">We will want to make updates to the <kbd class="calibre11">Play</kbd> method that reflect our determinations for what the variables mean. Following we have replaced the single letter variable names with names that more appropriately represent what the variables are used for:</p>
<pre class="calibre19">public void Play(string[] args)<br class="title-page-name"/>{<br class="title-page-name"/>  // Determine if a password was passed in?<br class="title-page-name"/>  if (args.Length &gt; 0 &amp;&amp; args[0] != null) password =   <br class="title-page-name"/>   args[0].ToCharArray();<br class="title-page-name"/>  else CreateRandomPassword(); // Create a password if one was not <br class="title-page-name"/>   provided<br class="title-page-name"/>  // Player move - guess the password           <br class="title-page-name"/>  while (correctPositions != 4)<br class="title-page-name"/>  {<br class="title-page-name"/>    _inout.Write("Take a guess: ");<br class="title-page-name"/>    guess = _inout.ReadLine().ToArray();<br class="title-page-name"/><br class="title-page-name"/>    tries = tries + 1;<br class="title-page-name"/><br class="title-page-name"/>    if (guess.Length != 4)<br class="title-page-name"/>    {<br class="title-page-name"/>      // Password guess was wrong size - Error Message<br class="title-page-name"/>      _inout.WriteLine("Password length is 4.");<br class="title-page-name"/>    }<br class="title-page-name"/>    else<br class="title-page-name"/>    {<br class="title-page-name"/>      // Check if the password provided by the player is correct<br class="title-page-name"/>      for (x = 0, correctPositions = 0; x &lt; 4; x++)<br class="title-page-name"/>      {<br class="title-page-name"/>        if (guess[x] &gt; 65 + 26) guess[x] = (char)(guess[x] - 32);<br class="title-page-name"/>        if (guess[x] == password[x]) _inout.Write("+", correctPositions <br class="title-page-name"/>          = correctPositions + 1);<br class="title-page-name"/>        else if (password.Contains(guess[x])) _inout.Write("-");<br class="title-page-name"/>      }<br class="title-page-name"/>      _inout.WriteLine();<br class="title-page-name"/>    }<br class="title-page-name"/>  }           <br class="title-page-name"/>  // Game over you win<br class="title-page-name"/>  _inout.WriteLine("Congratulations you guessed the password in " + <br class="title-page-name"/>   tries + " tries.");<br class="title-page-name"/>  _inout.WriteLine("Press any key to quit.");<br class="title-page-name"/>  _inout.Read();<br class="title-page-name"/>}</pre>
<p class="calibre2">Next, it would be nice if we could update the interface now that we understand the application a little better. Two things that we would like to change are the input and the very end of the game. It would be nice if the input was a simple string instead of a character array. The <kbd class="calibre11">Play</kbd> method could take a string and the program could figure out how to get the password string from the arguments.</p>
<p class="calibre2">Along those same lines, we could reduce the overall number of writes and turn the consecutive plus and minus <kbd class="calibre11">Write</kbd> commands into a single <kbd class="calibre11">WriteLine</kbd> command. This would break our gold standard test, but wouldn't actually change the functionality of the code. It would still print the pluses and minuses on a single line.</p>
<p class="calibre2">To convert the guess from a character array to a string, we must first understand what is happening on this line:</p>
<pre class="calibre19">if (guess[x] &gt; 65 + 26) guess[x] = (char)(guess[x] - 32);</pre>
<p class="calibre2">Analyzing the line, we see the numbers <kbd class="calibre11">65</kbd>, <kbd class="calibre11">26</kbd>, and <kbd class="calibre11">32</kbd>. If you are familiar with ASCII codes, then these lines might make sense to you. The number <kbd class="calibre11">65</kbd> is the starting point of the alphabet characters on the ASCII tables. There are 26 letters in the English alphabet. And, there are 32 values between "a" and "A". So, it is to be assumed that this code is either uppercasing or lowercasing the character at the specified index. We can approximate this in C# using the <kbd class="calibre11">String.ToUpper()</kbd> method.</p>
<p class="calibre2">While we are doing a small bit of gold standard changes, we should also remove the last two lines of the <kbd class="calibre11">Play</kbd> method and move them to <kbd class="calibre11">Program.cs</kbd>, as they are more related to a Console application than anything else.</p>
<p class="calibre2">In the file <kbd class="calibre11">Program.cs</kbd>:</p>
<pre class="calibre19">class Program<br class="title-page-name"/>{<br class="title-page-name"/>  static void Main(string[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    var inout = new ConsoleInputOutput();<br class="title-page-name"/>    var game = new Mastermind(inout);<br class="title-page-name"/>    <br class="title-page-name"/>    var password = args.Length &gt; 0 ? args[0] : null;<br class="title-page-name"/>    game.Play(password);<br class="title-page-name"/><br class="title-page-name"/>    inout.WriteLine("Press any key to quit.");<br class="title-page-name"/>    inout.Read();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">Mastermind.cs</kbd>:</p>
<pre class="calibre19">public class Mastermind<br class="title-page-name"/>{<br class="title-page-name"/>  private readonly IInputOutput _inout;<br class="title-page-name"/>  private string guess;<br class="title-page-name"/>  private int tries;<br class="title-page-name"/>  private int correctPositions;<br class="title-page-name"/><br class="title-page-name"/>  public Mastermind(IInputOutput inout)<br class="title-page-name"/>  {<br class="title-page-name"/>    _inout = inout;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public void Play(string password = null)<br class="title-page-name"/>  {<br class="title-page-name"/>    // Determine if a password was passed in?<br class="title-page-name"/>    password = password ?? CreateRandomPassword();           <br class="title-page-name"/><br class="title-page-name"/>    // Player move - guess the password           <br class="title-page-name"/>    while (correctPositions != 4)<br class="title-page-name"/>    {<br class="title-page-name"/>      _inout.Write("Take a guess: ");<br class="title-page-name"/>      guess = _inout.ReadLine();<br class="title-page-name"/>      tries = tries + 1;<br class="title-page-name"/><br class="title-page-name"/>      if (guess.Length != 4)<br class="title-page-name"/>      {<br class="title-page-name"/>        // Password guess was wrong size - Error Message<br class="title-page-name"/>        _inout.WriteLine("Password length is 4.");<br class="title-page-name"/>      }<br class="title-page-name"/>      else<br class="title-page-name"/>      {<br class="title-page-name"/>        // Check if the password provided by the player is correct<br class="title-page-name"/>        guess = guess.ToUpper();<br class="title-page-name"/>        var guessResult = "";<br class="title-page-name"/><br class="title-page-name"/>        for (var x = 0; x &lt; 4; x++)<br class="title-page-name"/>        {<br class="title-page-name"/>          if (guess[x] == password[x])<br class="title-page-name"/>          {                            <br class="title-page-name"/>            guessResult += "+";<br class="title-page-name"/>          }<br class="title-page-name"/>          else if (password.Contains(guess[x]))<br class="title-page-name"/>          {<br class="title-page-name"/>            guessResult += "-";<br class="title-page-name"/>          }<br class="title-page-name"/>        }<br class="title-page-name"/><br class="title-page-name"/>        correctPositions = guessResult.Count(c =&gt; c == '+');<br class="title-page-name"/>        _inout.WriteLine(guessResult);<br class="title-page-name"/>      }<br class="title-page-name"/>    }<br class="title-page-name"/><br class="title-page-name"/>    // Game over you win<br class="title-page-name"/>    _inout.WriteLine("Congratulations you guessed the password in " + <br class="title-page-name"/>     tries + " tries.");           <br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  private string CreateRandomPassword()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Initialize randomness<br class="title-page-name"/>    Random rand = new Random(DateTime.Now.Millisecond);<br class="title-page-name"/>    <br class="title-page-name"/>    var password = new [] {'A', 'A', 'A', 'A'};<br class="title-page-name"/><br class="title-page-name"/>    var j = 0;<br class="title-page-name"/><br class="title-page-name"/>    password_loop:<br class="title-page-name"/>    password[j] = (char)(rand.Next(6) + 65);<br class="title-page-name"/>    j = j + 1;<br class="title-page-name"/><br class="title-page-name"/>    if (j &lt; 4) goto password_loop;<br class="title-page-name"/>    return password.ToString();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">GoldStandardTests.cs</kbd>:</p>
<pre class="calibre19">public class GoldStandardTests<br class="title-page-name"/>{<br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void StandardTestRun()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>    var game = new Mastermind(inout);<br class="title-page-name"/><br class="title-page-name"/>    // Arrange - Inputs<br class="title-page-name"/>    inout.InFeed.Enqueue("AAA");<br class="title-page-name"/>    inout.InFeed.Enqueue("AAAA");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABBB");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABCC");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABCD");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABCF");<br class="title-page-name"/>    inout.InFeed.Enqueue(" ");<br class="title-page-name"/><br class="title-page-name"/>    // Arrange - Outputs<br class="title-page-name"/>    var expectedOutputs = new Queue&lt;string&gt;();<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("Password length is 4." + <br class="title-page-name"/>    Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("+---" + Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("++--" + Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("+++-" + Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("+++" + Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("++++" + Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Congratulations you guessed the password <br class="title-page-name"/>    in 6 tries." + Environment.NewLine);<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    game.Play("ABCF");<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    inout.OutFeed.ForEach(text =&gt;<br class="title-page-name"/>    {<br class="title-page-name"/>      Assert.Equal(expectedOutputs.Dequeue(), text);<br class="title-page-name"/>    });<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Final beautification</h1>
                
            
            <article>
                
<p class="calibre2">Now that everything else is done and the code is working correctly, it is time for the last refactoring before we start our enhancement. We want our methods to be as small as possible. In this case, that means that the <kbd class="calibre11">Play</kbd> function should have practically no logic outside the main game loop.</p>
<p class="calibre2">In general, if a method has any kind of block in it (for example, if, while, for, and so on), we want that block to be the only thing in the method. Often, there are also guard statements checking input, but that should be it. Let's refactor to follow that convention and see what the code looks like afterwards.</p>
<p class="calibre2"> In the file <kbd class="calibre11">Mastermind.cs</kbd>:</p>
<pre class="calibre19">public class Mastermind<br class="title-page-name"/>{<br class="title-page-name"/>  private readonly IInputOutput _inout;<br class="title-page-name"/>  private int _tries;<br class="title-page-name"/><br class="title-page-name"/>  public Mastermind(IInputOutput inout)<br class="title-page-name"/>  {<br class="title-page-name"/>    _inout = inout;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public void Play(string password = null)<br class="title-page-name"/>  {<br class="title-page-name"/>    password = password ?? CreateRandomPassword();<br class="title-page-name"/>    var correctPositions = 0;<br class="title-page-name"/><br class="title-page-name"/>    while (correctPositions != 4)<br class="title-page-name"/>    {<br class="title-page-name"/>      correctPositions = GuessPasswordAndCheck(password);<br class="title-page-name"/>    }<br class="title-page-name"/><br class="title-page-name"/>    _inout.WriteLine("Congratulations you guessed the password in " + <br class="title-page-name"/>    _tries + " tries.");<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  private int GuessPasswordAndCheck(string password)<br class="title-page-name"/>  {<br class="title-page-name"/>    var guess = Guess();                        <br class="title-page-name"/>    return Check(guess, password);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  private int Check(string guess, string password)<br class="title-page-name"/>  {<br class="title-page-name"/>    var checkResult = "";<br class="title-page-name"/><br class="title-page-name"/>    for (var x = 0; x &lt; 4; x++)<br class="title-page-name"/>    {<br class="title-page-name"/>      if (guess[x] == password[x])<br class="title-page-name"/>      {<br class="title-page-name"/>        checkResult += "+";<br class="title-page-name"/>      }<br class="title-page-name"/>      else if (password.Contains(guess[x]))<br class="title-page-name"/>      {<br class="title-page-name"/>        checkResult += "-";<br class="title-page-name"/>      }<br class="title-page-name"/>    }<br class="title-page-name"/><br class="title-page-name"/>    _inout.WriteLine(checkResult);<br class="title-page-name"/>    return checkResult.Count(c =&gt; c == '+');<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  private string Guess()<br class="title-page-name"/>  {<br class="title-page-name"/>    _tries = _tries + 1;<br class="title-page-name"/>    <br class="title-page-name"/>    _inout.Write("Take a guess: ");<br class="title-page-name"/>    var guess = _inout.ReadLine();<br class="title-page-name"/><br class="title-page-name"/>    if (guess.Length == 4)<br class="title-page-name"/>    {<br class="title-page-name"/>      return guess.ToUpper();<br class="title-page-name"/>    }<br class="title-page-name"/><br class="title-page-name"/>    // Password guess was wrong size - Error Message<br class="title-page-name"/>    _inout.WriteLine("Password length is 4.");<br class="title-page-name"/>    return Guess();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  private string CreateRandomPassword()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Initialize randomness<br class="title-page-name"/>    Random rand = new Random(DateTime.Now.Millisecond);<br class="title-page-name"/><br class="title-page-name"/>    var password = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/><br class="title-page-name"/>    var j = 0;<br class="title-page-name"/><br class="title-page-name"/>    password_loop:<br class="title-page-name"/>    password[j] = (char)(rand.Next(6) + 65);<br class="title-page-name"/>    j = j + 1;<br class="title-page-name"/><br class="title-page-name"/>    if (j &lt; 4) goto password_loop;<br class="title-page-name"/><br class="title-page-name"/>    return password.ToString();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">There are many ways that this code could have been refactored; this is just one. Now that the code is refactored, we are ready to move on and begin working on enhancements.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Ready for enhancements</h1>
                
            
            <article>
                
<p class="calibre2">We are now to a point where the code makes enough sense that we can begin to work on our change requests. We have broken the random password generation portion of the code into its own method, so now we can work on it independently.</p>
<p class="calibre2">One of the first things we need to do is to stop using <kbd class="calibre11">Random</kbd>. <kbd class="calibre11">Random</kbd> is, by nature, unpredictable and outside of our control. We need a way to feed the number generation to verify that we can get the expected outputs when <kbd class="calibre11">Random</kbd> provides specific inputs.</p>
<p class="calibre2">We will extract an interface and mock class similar to what we did for Console. Here is the first round of tests, the mock class, and the interface that were created.</p>
<p class="calibre2">In the file <kbd class="calibre11">RandomNumberTests.cs</kbd>:</p>
<pre class="calibre19">public class RandomNumberTests<br class="title-page-name"/>{<br class="title-page-name"/>  private readonly MockRandomGenerator _rand;<br class="title-page-name"/><br class="title-page-name"/>  public RandomNumberTests()<br class="title-page-name"/>  {<br class="title-page-name"/>    _rand = new MockRandomGenerator();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItExists()<br class="title-page-name"/>  {<br class="title-page-name"/>    _rand.Number();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItReturnsDefaultValue()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Act<br class="title-page-name"/>    var result = _rand.Number();<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    Assert.Equal(0, result);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItCanReturnPredeterminedNumbers()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    _rand.SetNumbers(1, 2, 3, 4, 5);<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var a = _rand.Number();<br class="title-page-name"/>    var b = _rand.Number();<br class="title-page-name"/>    var c = _rand.Number();<br class="title-page-name"/>    var d = _rand.Number();<br class="title-page-name"/>    var e = _rand.Number();<br class="title-page-name"/><br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    Assert.Equal(1, a);<br class="title-page-name"/>    Assert.Equal(2, b);<br class="title-page-name"/>    Assert.Equal(3, c);<br class="title-page-name"/>    Assert.Equal(4, d);<br class="title-page-name"/>    Assert.Equal(5, e);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItCanHaveAMaxRange()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    const int maxRange = 3;<br class="title-page-name"/>    _rand.SetNumbers(1, 2, 3, 4, 5);<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var a = _rand.Number(maxRange);<br class="title-page-name"/>    var b = _rand.Number(maxRange);<br class="title-page-name"/>    var c = _rand.Number(maxRange);<br class="title-page-name"/>    var d = _rand.Number(maxRange);<br class="title-page-name"/>    var e = _rand.Number(maxRange);<br class="title-page-name"/><br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    Assert.Equal(1, a);<br class="title-page-name"/>    Assert.Equal(2, b);<br class="title-page-name"/>    Assert.Equal(3, c);<br class="title-page-name"/>    Assert.Equal(3, d);<br class="title-page-name"/>    Assert.Equal(3, e);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItCanHaveAMinMaxRange()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    const int minRange = 2;<br class="title-page-name"/>    const int maxRange = 3;<br class="title-page-name"/>    _rand.SetNumbers(1, 2, 3, 4, 5);<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var a = _rand.Number(minRange, maxRange);<br class="title-page-name"/>    var b = _rand.Number(minRange, maxRange);<br class="title-page-name"/>    var c = _rand.Number(minRange, maxRange);<br class="title-page-name"/>    var d = _rand.Number(minRange, maxRange);<br class="title-page-name"/>    var e = _rand.Number(minRange, maxRange);<br class="title-page-name"/><br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    Assert.Equal(2, a);<br class="title-page-name"/>    Assert.Equal(2, b);<br class="title-page-name"/>    Assert.Equal(3, c);<br class="title-page-name"/>    Assert.Equal(3, d);<br class="title-page-name"/>    Assert.Equal(3, e);<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">IRandomGenerator.cs</kbd>:</p>
<pre class="calibre19">public interface IRandomGenerator<br class="title-page-name"/>{<br class="title-page-name"/>  int Number(int max = 100);<br class="title-page-name"/>  int Number(int min, int max);<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">MockRandomGenerator.cs</kbd>:</p>
<pre class="calibre19">public class MockRandomGenerator : IRandomGenerator<br class="title-page-name"/>{<br class="title-page-name"/>  private readonly List&lt;int&gt; _numbers;<br class="title-page-name"/>  private List&lt;int&gt;.Enumerator _numbersEnumerator;<br class="title-page-name"/><br class="title-page-name"/>  public MockRandomGenerator(List&lt;int&gt; numbers = null)<br class="title-page-name"/>  {<br class="title-page-name"/>    _numbers = numbers ?? new List&lt;int&gt;();<br class="title-page-name"/>    _numbersEnumerator = _numbers.GetEnumerator();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public int Number(int min, int max)<br class="title-page-name"/>  {<br class="title-page-name"/>    var result = Number(max);<br class="title-page-name"/><br class="title-page-name"/>    return result &lt; min ? min : result;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public int Number(int max = 100)<br class="title-page-name"/>  {<br class="title-page-name"/>    _numbersEnumerator.MoveNext();<br class="title-page-name"/>    var result = _numbersEnumerator.Current;<br class="title-page-name"/><br class="title-page-name"/>    return result &gt; max ? max : result;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public void SetNumbers(params int[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    _numbers.AddRange(args);<br class="title-page-name"/>    _numbersEnumerator = _numbers.GetEnumerator();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">Now, to create the production <kbd class="calibre11">RandomGenerator</kbd> class and inject it into our application.</p>
<p class="calibre2">In the file <kbd class="calibre11">RandomGenerator.cs</kbd>:</p>
<pre class="calibre19">public class RandomGenerator : IRandomGenerator<br class="title-page-name"/>{<br class="title-page-name"/>  private readonly Random _rand;<br class="title-page-name"/><br class="title-page-name"/>  public RandomGenerator()<br class="title-page-name"/>  {<br class="title-page-name"/>    _rand = new Random();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public int Number(int max = 100)<br class="title-page-name"/>  {<br class="title-page-name"/>    return _rand.Next(0, max);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public int Number(int min, int max)<br class="title-page-name"/>  {<br class="title-page-name"/>    return _rand.Next(min, max);<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">Program.cs</kbd>:</p>
<pre class="calibre19">class Program<br class="title-page-name"/>{<br class="title-page-name"/>  static void Main(string[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    var rand = new RandomGenerator();<br class="title-page-name"/>    var inout = new ConsoleInputOutput();<br class="title-page-name"/>    var game = new Mastermind(inout, rand);<br class="title-page-name"/>    <br class="title-page-name"/>    var password = args.Length &gt; 0 ? args[0] : null;<br class="title-page-name"/>    game.Play(password);<br class="title-page-name"/><br class="title-page-name"/>    inout.WriteLine("Press any key to quit.");<br class="title-page-name"/>    inout.Read();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">Mastermind.cs</kbd>:</p>
<pre class="calibre19">public class Mastermind<br class="title-page-name"/>{<br class="title-page-name"/>  private readonly IInputOutput _inout;<br class="title-page-name"/>  private readonly IRandomGenerator _random;<br class="title-page-name"/><br class="title-page-name"/>  private int _tries;<br class="title-page-name"/>    <br class="title-page-name"/>  public Mastermind(IInputOutput inout, IRandomGenerator random)<br class="title-page-name"/>  {<br class="title-page-name"/>    _inout = inout;<br class="title-page-name"/>    _random = random;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public void Play(string password = null)<br class="title-page-name"/>  {<br class="title-page-name"/>    password = password ?? CreateRandomPassword();<br class="title-page-name"/>    var correctPositions = 0;<br class="title-page-name"/><br class="title-page-name"/>    while (correctPositions != 4)<br class="title-page-name"/>    {<br class="title-page-name"/>      correctPositions = GuessPasswordAndCheck(password);<br class="title-page-name"/>    }<br class="title-page-name"/><br class="title-page-name"/>    _inout.WriteLine("Congratulations you guessed the password in " + <br class="title-page-name"/>    _tries + " tries.");<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  private int GuessPasswordAndCheck(string password)<br class="title-page-name"/>  {<br class="title-page-name"/>    var guess = Guess();<br class="title-page-name"/>    return Check(guess, password);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  private int Check(string guess, string password)<br class="title-page-name"/>  {<br class="title-page-name"/>    var checkResult = "";<br class="title-page-name"/><br class="title-page-name"/>    for (var x = 0; x &lt; 4; x++)<br class="title-page-name"/>    {<br class="title-page-name"/>      if (guess[x] == password[x])<br class="title-page-name"/>      {<br class="title-page-name"/>        checkResult += "+";<br class="title-page-name"/>      }<br class="title-page-name"/>      else if (password.Contains(guess[x]))<br class="title-page-name"/>      {<br class="title-page-name"/>        checkResult += "-";<br class="title-page-name"/>      }<br class="title-page-name"/>    }<br class="title-page-name"/><br class="title-page-name"/>    _inout.WriteLine(checkResult);<br class="title-page-name"/>    return checkResult.Count(c =&gt; c == '+');<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  private string Guess()<br class="title-page-name"/>  {<br class="title-page-name"/>    _tries = _tries + 1;<br class="title-page-name"/><br class="title-page-name"/>    _inout.Write("Take a guess: ");<br class="title-page-name"/>    var guess = _inout.ReadLine();<br class="title-page-name"/><br class="title-page-name"/>    if (guess.Length == 4)<br class="title-page-name"/>    {<br class="title-page-name"/>      return guess.ToUpper();<br class="title-page-name"/>    }<br class="title-page-name"/><br class="title-page-name"/>    // Password guess was wrong size - Error Message<br class="title-page-name"/>    _inout.WriteLine("Password length is 4.");<br class="title-page-name"/>    return Guess();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  private string CreateRandomPassword()<br class="title-page-name"/>  {<br class="title-page-name"/>    var password = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/><br class="title-page-name"/>    var j = 0;<br class="title-page-name"/><br class="title-page-name"/>    password_loop:<br class="title-page-name"/>    password[j] = (char)(_random.Number(6) + 65);<br class="title-page-name"/>    j = j + 1;<br class="title-page-name"/><br class="title-page-name"/>    if (j &lt; 4) goto password_loop;<br class="title-page-name"/><br class="title-page-name"/>    return new string(password);<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">And lastly, let's modify the gold standard test to use random password generation.</p>
<p class="calibre2">In the file <kbd class="calibre11">GoldStandardTests.cs</kbd>:</p>
<pre class="calibre19">public class GoldStandardTests<br class="title-page-name"/>{<br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void StandardTestRun()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    var inout = new MockInputOutput();<br class="title-page-name"/>    var rand = new MockRandomGenerator();<br class="title-page-name"/>    var game = new Mastermind(inout, rand);<br class="title-page-name"/><br class="title-page-name"/>    // Arrange - Inputs<br class="title-page-name"/>    rand.SetNumbers(0, 1, 2, 5);<br class="title-page-name"/>    inout.InFeed.Enqueue("AAA");<br class="title-page-name"/>    inout.InFeed.Enqueue("AAAA");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABBB");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABCC");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABCD");<br class="title-page-name"/>    inout.InFeed.Enqueue("ABCF");<br class="title-page-name"/>    inout.InFeed.Enqueue(" ");<br class="title-page-name"/><br class="title-page-name"/>    // Arrange - Outputs<br class="title-page-name"/>    var expectedOutputs = new Queue&lt;string&gt;();<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("Password length is 4." + <br class="title-page-name"/>    Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("+---" + Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("++--" + Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("+++-" + Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("+++" + Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Take a guess: ");<br class="title-page-name"/>    expectedOutputs.Enqueue("++++" + Environment.NewLine);<br class="title-page-name"/>    expectedOutputs.Enqueue("Congratulations you guessed the password <br class="title-page-name"/>    in 6 tries." + Environment.NewLine);<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    game.Play();<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    inout.OutFeed.ForEach(text =&gt;<br class="title-page-name"/>    {<br class="title-page-name"/>      Assert.Equal(expectedOutputs.Dequeue(), text);<br class="title-page-name"/>    });<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">Now we are ready to refactor the password generation method and extend it to provide us with the requested change. First, there is a looping structure that is not core to the language. Let's focus in on the <kbd class="calibre11">CreateRandomPassword</kbd> method and fix the looping structure:</p>
<pre class="calibre19">private string CreateRandomPassword()<br class="title-page-name"/>{<br class="title-page-name"/>  var password = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/><br class="title-page-name"/>  for(var j = 0; j &lt; 4; j++)<br class="title-page-name"/>  {<br class="title-page-name"/>    password[j] = (char)(_random.Number(6) + 65);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  return new string(password);<br class="title-page-name"/>}</pre>
<p class="calibre2">Next, for fun, let's see if we can generalize and compress this loop, since we have a very similar loop in the <kbd class="calibre11">Check</kbd> method. While not necessary, this is fun example of reducing duplication of code. Here is what that refactoring looks like:</p>
<pre class="calibre19">private int Check(string guess, string password)<br class="title-page-name"/>{<br class="title-page-name"/>  var checkResult = "";<br class="title-page-name"/><br class="title-page-name"/>  Times(4, x =&gt; {<br class="title-page-name"/>    if (guess[x] == password[x])<br class="title-page-name"/>    {<br class="title-page-name"/>      checkResult += "+";<br class="title-page-name"/>    }<br class="title-page-name"/>    else if (password.Contains(guess[x]))<br class="title-page-name"/>    {<br class="title-page-name"/>      checkResult += "-";<br class="title-page-name"/>    }<br class="title-page-name"/>  });<br class="title-page-name"/><br class="title-page-name"/>  _inout.WriteLine(checkResult);<br class="title-page-name"/>  return checkResult.Count(c =&gt; c == '+');<br class="title-page-name"/>}<br class="title-page-name"/><br class="title-page-name"/>private string CreateRandomPassword()<br class="title-page-name"/>{<br class="title-page-name"/>  var password = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/><br class="title-page-name"/>  Times(4, x =&gt; password[x] = (char)(_random.Number(6) + 65));<br class="title-page-name"/><br class="title-page-name"/>  return new string(password);<br class="title-page-name"/>}<br class="title-page-name"/><br class="title-page-name"/>private static void Times(int count, Action&lt;int&gt; act)<br class="title-page-name"/>{<br class="title-page-name"/>  for (var index = 0; index &lt; count; index++)<br class="title-page-name"/>  {<br class="title-page-name"/>    act(index);<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">Now let's do one more refactoring before we extend the application. Looking at how the characters are generated, it is not very obvious what is going on. Instead, we would like the code to be as straightforward as possible. There is no reason that the random generator class can't just directly return letters, so let's add that functionality.</p>
<p class="calibre2">In the file <kbd class="calibre11">RandomLetterTests.cs</kbd>:</p>
<pre class="calibre19">public class RandomLetterTests<br class="title-page-name"/>{<br class="title-page-name"/>  private readonly MockRandomGenerator _rand;<br class="title-page-name"/><br class="title-page-name"/>  public RandomLetterTests()<br class="title-page-name"/>  {<br class="title-page-name"/>    _rand = new MockRandomGenerator();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItExists()<br class="title-page-name"/>  {<br class="title-page-name"/>    _rand.Letter();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItReturnsDefaultValue()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Act<br class="title-page-name"/>    var result = _rand.Letter();<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    Assert.Equal('A', result);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItCanReturnPredeterminedLetters()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    _rand.SetLetters('A', 'B', 'C', 'D', 'E');<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var a = _rand.Letter();<br class="title-page-name"/>    var b = _rand.Letter();<br class="title-page-name"/>    var c = _rand.Letter();<br class="title-page-name"/>    var d = _rand.Letter();<br class="title-page-name"/>    var e = _rand.Letter();<br class="title-page-name"/><br class="title-page-name"/>    // Assert<br class="title-page-name"/>    Assert.Equal('A', a);<br class="title-page-name"/>    Assert.Equal('B', b);<br class="title-page-name"/>    Assert.Equal('C', c);<br class="title-page-name"/>    Assert.Equal('D', d);<br class="title-page-name"/>    Assert.Equal('E', e);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItCanHaveAMaxRange()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    const char maxRange = 'C';<br class="title-page-name"/>    _rand.SetLetters('A', 'B', 'C', 'D', 'E');<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var a = _rand.Letter(maxRange);<br class="title-page-name"/>    var b = _rand.Letter(maxRange);<br class="title-page-name"/>    var c = _rand.Letter(maxRange);<br class="title-page-name"/>    var d = _rand.Letter(maxRange);<br class="title-page-name"/>    var e = _rand.Letter(maxRange);<br class="title-page-name"/><br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    Assert.Equal('A', a);<br class="title-page-name"/>    Assert.Equal('B', b);<br class="title-page-name"/>    Assert.Equal('C', c);<br class="title-page-name"/>    Assert.Equal('C', d);<br class="title-page-name"/>    Assert.Equal('C', e);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  [Fact]<br class="title-page-name"/>  public void ItCanHaveAMinMaxRange()<br class="title-page-name"/>  {<br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    const char minRange = 'B';<br class="title-page-name"/>    const char maxRange = 'C';<br class="title-page-name"/>    _rand.SetLetters('A', 'B', 'C', 'D', 'E');<br class="title-page-name"/><br class="title-page-name"/>    // Act<br class="title-page-name"/>    var a = _rand.Letter(minRange, maxRange);<br class="title-page-name"/>    var b = _rand.Letter(minRange, maxRange);<br class="title-page-name"/>    var c = _rand.Letter(minRange, maxRange);<br class="title-page-name"/>    var d = _rand.Letter(minRange, maxRange);<br class="title-page-name"/>    var e = _rand.Letter(minRange, maxRange);<br class="title-page-name"/><br class="title-page-name"/>    // Arrange<br class="title-page-name"/>    Assert.Equal('B', a);<br class="title-page-name"/>    Assert.Equal('B', b);<br class="title-page-name"/>    Assert.Equal('C', c);<br class="title-page-name"/>    Assert.Equal('C', d);<br class="title-page-name"/>    Assert.Equal('C', e);<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">MockRandomGenerator.cs</kbd>:</p>
<pre class="calibre19">public class MockRandomGenerator : IRandomGenerator<br class="title-page-name"/>{<br class="title-page-name"/>  private readonly List&lt;int&gt; _numbers;<br class="title-page-name"/>  private List&lt;int&gt;.Enumerator _numbersEnumerator;<br class="title-page-name"/><br class="title-page-name"/>  private readonly List&lt;char&gt; _letters;<br class="title-page-name"/>  private List&lt;char&gt;.Enumerator _lettersEnumerator;<br class="title-page-name"/><br class="title-page-name"/>  private const char NullChar = '\0';<br class="title-page-name"/><br class="title-page-name"/>  public MockRandomGenerator(List&lt;int&gt; numbers = null, List&lt;char&gt; <br class="title-page-name"/>  letters = null)<br class="title-page-name"/>  {<br class="title-page-name"/>    _numbers = numbers ?? new List&lt;int&gt;();<br class="title-page-name"/>    _numbersEnumerator = _numbers.GetEnumerator();<br class="title-page-name"/><br class="title-page-name"/>    _letters = letters ?? new List&lt;char&gt;();<br class="title-page-name"/>    _lettersEnumerator = _letters.GetEnumerator();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public int Number(int min, int max)<br class="title-page-name"/>  {<br class="title-page-name"/>    var result = Number(max);<br class="title-page-name"/><br class="title-page-name"/>    return result &lt; min ? min : result;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public int Number(int max = 100)<br class="title-page-name"/>  {<br class="title-page-name"/>    _numbersEnumerator.MoveNext();<br class="title-page-name"/>    var result = _numbersEnumerator.Current;<br class="title-page-name"/><br class="title-page-name"/>    return result &gt; max ? max : result;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public void SetNumbers(params int[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    _numbers.AddRange(args);<br class="title-page-name"/>    _numbersEnumerator = _numbers.GetEnumerator();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public int Letter(char min, char max)<br class="title-page-name"/>  {<br class="title-page-name"/>    var result = Letter(max);<br class="title-page-name"/><br class="title-page-name"/>    return result &lt; min ? min : result;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public char Letter(char max = 'Z')<br class="title-page-name"/>  {<br class="title-page-name"/>    _lettersEnumerator.MoveNext();           <br class="title-page-name"/>    var result = _lettersEnumerator.Current;<br class="title-page-name"/>    result = result == NullChar ? 'A' : result;<br class="title-page-name"/><br class="title-page-name"/>    return result &gt; max ? max : result;<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public void SetLetters(params char[] args)<br class="title-page-name"/>  {<br class="title-page-name"/>    _letters.AddRange(args);<br class="title-page-name"/>    _lettersEnumerator = _letters.GetEnumerator();<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">IRandomGenerator.cs</kbd>:</p>
<pre class="calibre19">public interface IRandomGenerator<br class="title-page-name"/>{<br class="title-page-name"/>  int Number(int max = 100);<br class="title-page-name"/>  int Number(int min, int max);<br class="title-page-name"/>  char Letter(char max = 'Z');<br class="title-page-name"/>  char Letter(char min, char max);<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">RandomGenerator.cs</kbd>:</p>
<pre class="calibre19">public class RandomGenerator : IRandomGenerator<br class="title-page-name"/>{<br class="title-page-name"/>  private readonly Random _rand;<br class="title-page-name"/><br class="title-page-name"/>  public RandomGenerator()<br class="title-page-name"/>  {<br class="title-page-name"/>    _rand = new Random();<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public int Number(int max = 100)<br class="title-page-name"/>  {<br class="title-page-name"/>    return Number(0, max);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public int Number(int min, int max)<br class="title-page-name"/>  {<br class="title-page-name"/>    return _rand.Next(min, max);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public char Letter(char max = 'Z')<br class="title-page-name"/>  {<br class="title-page-name"/>    return Letter('A', max);<br class="title-page-name"/>  }<br class="title-page-name"/><br class="title-page-name"/>  public char Letter(char min, char max)<br class="title-page-name"/>  {<br class="title-page-name"/>    return (char) _rand.Next(min, max);<br class="title-page-name"/>  }<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">Mastermind.cs</kbd>:</p>
<pre class="calibre19">private string CreateRandomPassword()<br class="title-page-name"/>{<br class="title-page-name"/>  var password = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/><br class="title-page-name"/>  Times(4, x =&gt; password[x] = _random.Letter('F'));<br class="title-page-name"/><br class="title-page-name"/>  return new string(password);<br class="title-page-name"/>}</pre>
<p class="calibre2">In the file <kbd class="calibre11">GoldStandardTests.cs</kbd>:</p>
<pre class="calibre19">// Arrange - Inputs<br class="title-page-name"/>rand.SetLetters('A', 'B', 'C', 'F');</pre>
<p class="calibre2">That is the final refactoring for this exercise. We only have one thing to do, and that is to extend the application to generate passwords using the full range of the English alphabet. Because of the effort we put into testing and refactoring, this is now a trivial matter, and, in fact, only requires the removal of three characters in the <kbd class="calibre11">Mastermind</kbd> class.</p>
<p class="calibre2">In the file <kbd class="calibre11">Mastermind.cs</kbd>:</p>
<pre class="calibre19">private string CreateRandomPassword()<br class="title-page-name"/>{<br class="title-page-name"/>  var password = new[] { 'A', 'A', 'A', 'A' };<br class="title-page-name"/><br class="title-page-name"/>  Times(4, x =&gt; password[x] = _random.Letter());<br class="title-page-name"/><br class="title-page-name"/>  return new string(password);<br class="title-page-name"/>}</pre>
<p class="calibre2">Now a more complicated password, consisting of the full range of the alphabet, is created. This causes a much more difficult password, and a game with output similar to the following:</p>
<pre class="calibre19">Take a guess: AAAA<br class="title-page-name"/>Take a guess: BBBB<br class="title-page-name"/>Take a guess: CCCC<br class="title-page-name"/>---+<br class="title-page-name"/>Take a guess: DDDC<br class="title-page-name"/>+<br class="title-page-name"/>Take a guess: EEEC<br class="title-page-name"/>+<br class="title-page-name"/>Take a guess: FFFC<br class="title-page-name"/>+<br class="title-page-name"/>Take a guess: GGGC<br class="title-page-name"/>+<br class="title-page-name"/>Take a guess: HHHC<br class="title-page-name"/>+<br class="title-page-name"/>Take a guess: IIIC<br class="title-page-name"/>+<br class="title-page-name"/>Take a guess: JJJC<br class="title-page-name"/>+<br class="title-page-name"/>Take a guess: KKKC<br class="title-page-name"/>+<br class="title-page-name"/>Take a guess: LLLC<br class="title-page-name"/>+<br class="title-page-name"/>Take a guess: mmmc<br class="title-page-name"/>+<br class="title-page-name"/>Take a guess: nnnc<br class="title-page-name"/>+<br class="title-page-name"/>Take a guess: oooc<br class="title-page-name"/>+--+<br class="title-page-name"/>Take a guess: oppc<br class="title-page-name"/>++-+<br class="title-page-name"/>Take a guess: opqc<br class="title-page-name"/>+++<br class="title-page-name"/>Take a guess: oprc<br class="title-page-name"/>+++<br class="title-page-name"/>Take a guess: opsc<br class="title-page-name"/>+++<br class="title-page-name"/>Take a guess: optc<br class="title-page-name"/>+++<br class="title-page-name"/>Take a guess: opuc<br class="title-page-name"/>+++<br class="title-page-name"/>Take a guess: opvc<br class="title-page-name"/>+++<br class="title-page-name"/>Take a guess: opwc<br class="title-page-name"/>++++<br class="title-page-name"/>Congratulations you guessed the password in 23 tries.<br class="title-page-name"/><br class="title-page-name"/>Press any key to quit.</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">You now have a well-written example, covered by tests. The effort involved can be daunting, but for anything more than a trivial application, it can be well worth the effort.</p>
<p class="calibre2">In <a target="_blank" href="part0430.html#CQ2HS0-d186949d2da74f5c95dd1712efae1195" class="calibre10">Chapter 14</a>, <em class="calibre12">A Better Foot Forward</em>, we'll summarize what we've learned as well as give you some pointers on how to rejoin the world as a TDD expert.</p>


            </article>

            
        </section>
    </body></html>