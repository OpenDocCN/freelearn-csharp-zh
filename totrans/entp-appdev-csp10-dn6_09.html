<html><head></head><body>
		<div><h1 id="_idParaDest-130"><em class="italic"><a id="_idTextAnchor596"/>Chapter 7</em>: Logging in .NET 6</h1>
			<p>Logging helps you to record your application's behavior for different data at runtime and you can control what you want to record and where you want to record it. Once the development of your feature is complete, you can unit test it thoroughly on a development PC, deploy it in a test environment for thorough integration testing, then deploy it in production, and finally, open it up for many users. The context in which your application is running (such as servers, data, and load) is different in test environments and production environments when you compare it with the development box, and you might face unexpected issues in the test and production environments in the initial days.</p>
			<p>This is where logging plays a very important role in recording what happens during runtime when different components in the end-to-end flow perform their functions and interact with each other. With the log information available, we can debug production issues and build very useful insights. We will learn about logging best practices and the different logging providers available, such as Azure App Service logging and Application Insights logging, and will build a reusable logging library that can be used in different projects.</p>
			<p>In this chapter, we will cover the following topics:</p>
			<ul>
				<li>Characteristics of good logging</li>
				<li>Understanding the available logging providers</li>
				<li>Working with Azure App Service</li>
				<li>Real-time telemetry in Application Insights</li>
				<li>Creating a .NET 6 logging class library</li>
			</ul>
			<p>By the end of the chapter, you'll have a good idea about logging as well as some of the platform-level concepts from Azure App Service and Application Insights that can be applied when working on deployment.</p>
			<h1 id="_idParaDest-131"><a id="_idTextAnchor597"/><a id="_idTextAnchor598"/>Technical requirements</h1>
			<p>A basic understanding of Microsoft .NET and Azure is required.</p>
			<p>The code for the chapter can be found here: <a href="https://github.com/PacktPublishing/Enterprise-Application-Development-with-C-10-and-.NET-6-Second-Edition/tree/main/Chapter07">https://github.com/PacktPublishing/Enterprise-Application-Development-with-C-10-and-.NET-6-Second-Edition/tree/main/Chapter07</a>.</p>
			<h1 id="_idParaDest-132"><a id="_idTextAnchor599"/><a id="_idTextAnchor600"/>Characteristics of good logging</h1>
			<p>Logging is implemented<a id="_idIndexMarker513"/> but the information in the logs is not useful for building insights or debugging production issues. How many time<a id="_idTextAnchor601"/>s have you seen this issue? </p>
			<p>That's where best practices come into the picture, to implement good logging in your application. Some of the characteristics of good logging are as follows:</p>
			<ul>
				<li>It should not affect the actual application performance.</li>
				<li>It should be accurate and complete.</li>
				<li>It should be leveraged for data analytics and learning about application usages, such as concurrent users, peak load time, and most/least used features.</li>
				<li>It should help us reproduce the issue reported for root cause analysis and minimize <em class="italic">unable to reproduce</em> instances.</li>
				<li>It should be distributed and easily accessible by everyone â€“ development, product owner, and support.</li>
				<li>It should not contain protected<a id="_idIndexMarker514"/> o<a id="_idTextAnchor602"/>r sensitive information, <strong class="bold">personally identifiable information</strong> (<strong class="bold">PII</strong>), or duplicate or unnecessary logs.</li>
			</ul>
			<p>In addition to these, it should capture some<a id="_idIndexMarker515"/> of the following key information:</p>
			<ul>
				<li><strong class="bold">Correlation ID</strong>: A unique identifier for an issue that can be used to search in the log store.</li>
				<li><strong class="bold">Log level</strong>: Information, warning, and error, for example.</li>
				<li><strong class="bold">Timestamp</strong>: Time of the log entry (always use one agreed standard format, such as UTC or server time, and don't mix both).</li>
				<li><strong class="bold">Message</strong>: Message to be logged. This <a id="_idIndexMarker516"/>could be an information or custom error message, an actual exception message, or a combination of a custom and actual error message.</li>
				<li><strong class="bold">Machine/server/instance name</strong>: There could be multiple servers in the load balancer. This would help us with finding the server where the log occurred.</li>
				<li><strong class="bold">Assembly</strong>: Name of the asse<a id="_idTextAnchor603"/>mbly where the log occurred.</li>
			</ul>
			<p>What do you want to record? This<a id="_idTextAnchor604"/> is where log-level guidance<a id="_idIndexMarker517"/> comes into the pictu<a id="_idTextAnchor605"/>re:</p>
			<div><div><img src="img/Table_7.1.jpg" alt="Table 7.1&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Table 7.1</p>
			<p>The log leve<a id="_idTextAnchor606"/>l is configurable and based on the level specified; it will be enabled from that specified l<a id="_idTextAnchor607"/>evel to all higher levels. For example, if you specify the log level as <strong class="bold">Information</strong> in your configuration, all log messages from <strong class="bold">Information</strong>, <strong class="bold">Warning</strong>, <strong class="bold">Error</strong>, and <strong class="bold">Fatal</strong> will be logged, and <strong class="bold">Debug</strong> and <strong class="bold">Trace</strong> messages will not be logged, as shown in the following table. If no log level is specified, logging defaults to the <strong class="bold">Information</strong> leve<a id="_idTextAnchor608"/>l:</p>
			<div><div><img src="img/Table_7.2.jpg" alt="Table 7.2&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Table 7.2</p>
			<p>Where do you want to record? This is where logging providers come into the picture. Let's look at them in the next sectio<a id="_idTextAnchor609"/><a id="_idTextAnchor610"/>n.</p>
			<h1 id="_idParaDest-133"><a id="_idTextAnchor611"/>Understanding the available logging providers</h1>
			<p>.NET 6 supports multiple built-in logg<a id="_idTextAnchor612"/>ing providers<a id="_idIndexMarker518"/> as well as several third-party logging providers. APIs exposed by these providers help in writing log output to different sources, such as a file or event log supported by the providers. Your code can also enable multiple providers, which is a very common scenario when you are moving from one provider to another, where you can keep the old one, monitor the new one, and once you are good, you can retire the old provider. Let's discuss both types of providers in deta<a id="_idTextAnchor613"/><a id="_idTextAnchor614"/>il.</p>
			<h2 id="_idParaDest-134"><a id="_idTextAnchor615"/>Built-in logging providers</h2>
			<p><a id="_idTextAnchor616"/>All built-in logg<a id="_idTextAnchor617"/>ing providers<a id="_idIndexMarker519"/><a id="_idTextAnchor618"/> are support<a id="_idTextAnchor619"/>ed in the <code>Microsoft.Extensions.Logging</code> namespace. <a id="_idTextAnchor620"/>Let's have a<a id="_idTextAnchor621"/> look at so<a id="_idTextAnchor622"/>me of th<a id="_idTextAnchor623"/>em:<a id="_idTextAnchor624"/></p>
			<div><div><img src="img/Table_7.3(a).jpg" alt="Table 7.3&#13;&#10;"/>
				</div>
			</div>
			<div><div><img src="img/Table_7.3(b).jpg" alt="Table 7.3&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Table 7<a id="_idTextAnchor625"/><a id="_idTextAnchor626"/>.3</p>
			<h2 id="_idParaDest-135"><a id="_idTextAnchor627"/>Third-party logging providers</h2>
			<p>While .NET 6 provides sever<a id="_idTextAnchor628"/>al powerful<a id="_idIndexMarker520"/> inbu<a id="_idTextAnchor629"/>ilt logging providers, it also suppo<a id="_idTextAnchor630"/>rts third-party logg<a id="_idTextAnchor631"/>ing providers. Let's look<a id="_idTextAnchor632"/> at the<a id="_idTextAnchor633"/>m:</p>
			<div><div><img src="img/Table_7.4.jpg" alt="Table 7.4&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Table 7.4</p>
			<p>Having taken a brief look at the multiple<a id="_idIndexMarker521"/> built-in and third-party providers, let's take a deeper look at Azure App Service and Application Insights in the next secti<a id="_idTextAnchor634"/><a id="_idTextAnchor635"/>on.</p>
			<h1 id="_idParaDest-136"><a id="_idTextAnchor636"/>Working with Azure App Service</h1>
			<p>In an <strong class="bold">Infrastructure as a Service</strong> (<strong class="bold">IaaS</strong>) hosting model, you have full control<a id="_idIndexMarker522"/> over the operating sy<a id="_idTextAnchor637"/>stem<a id="_idIndexMarker523"/> and software instal<a id="_idTextAnchor638"/>led on the machine. It is very similar to the on-premises deployments that many of us are used to. You can access the servers via remote desktop, go through IIS logs, Windows Event Viewer, or files. When you move to the <strong class="bold">Platform as a Service</strong> (<strong class="bold">PaaS</strong>) hosting model, Azure takes care of managing<a id="_idIndexMarker524"/> the instances completely. This helps in s<a id="_idTextAnchor639"/>aving a considerable amount of time as your engineers don't have to spend time managing the servers to keep up to date with respect to the operating systems, infrastructure, and security updates.</p>
			<p>In this section, we will see how to do extensive logging and monitoring when you deploy your app in an Azure App Service plan (one of the important PaaS offerings from Micro<a id="_idTextAnchor640"/><a id="_idTextAnchor641"/>soft).</p>
			<h2 id="_idParaDest-137"><a id="_idTextAnchor642"/>Enabling application logging in Azure App Service</h2>
			<p>To enable application<a id="_idIndexMarker525"/> logging, you <a id="_idTextAnchor643"/>need<a id="_idIndexMarker526"/> to perform the following steps:</p>
			<ol>
				<li><code>AzureAppServices</code> package in any of your existing .NET 6 projects using the <code>dotnet add &lt;.csproj&gt;Â Â package &lt;Nuget package&gt; -v &lt;Version number&gt;</code> command, as<a id="_idTextAnchor644"/> shown:</li>
			</ol>
			<div><div><img src="img/Figure_7.1_B18507.jpg" alt="Figure 7.1 â€“ Installing a package from the CLI&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.1 â€“ Installing a package from the CLI</p>
			<p>You can <a id="_idTextAnchor645"/>get more details<a id="_idIndexMarker527"/> about .NET CLI commands from <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet">https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet</a>.</p>
			<p>You can also right-click on <code>Microsoft.Extensions.Logging.AzureAppServices</code> package and install it as shown in the following scre<a id="_idTextAnchor647"/>enshot:</p>
			<div><div><img src="img/Figure_7.2_B18507.jpg" alt="Figure 7.2 â€“ Installing a package from the IDE&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.2 â€“ Installing a package from the IDE</p>
			<ol>
				<li value="2"><code>Program.cs</code> file of your .NET 6 app, add<a id="_idIndexMarker528"/> the following highlighted<a id="_idIndexMarker529"/> code in the <code>CreateHostBuilder</code> method:<pre>//Removed code for brevity
<strong class="bold">builder.Logging.AddAzureWebAppDiagnostics();</strong>
//Removed code for brevityÂ Â Â Â Â Â Â Â Â Â Â Â Â Â  </pre></li>
			</ol>
			<p><code>CreateHostBuilder</code> does the default configuration for the app we are developing. Let's add<a id="_idTextAnchor648"/> a logging configuration<a id="_idIndexMarker530"/> h<a id="_idTextAnchor649"/>ere, which will also dynamically inject <code>_logger</code> (object creation happens using <strong class="bold">dependency injection</strong> (<strong class="bold">DI</strong>), as explained in <a href="B18507_05_Epub.xhtml#_idTextAnchor445"><em class="italic">Chapter 5</em></a>, <em class="italic">Dependency Injection in .NET 6</em>).</p>
			<ol>
				<li value="3"><strong class="bold">Adding logging</strong>: Add the following highlighted logging code to your methods in any of the controllers where<a id="_idTextAnchor650"/> core logic resides generally to test whether logging works:<pre>[ApiController]
[Route("[controller]")]
public class WeatherForecastController : ControllerBase
 {
Â Â Â Â Â Â Â Â private static readonly string[] Summaries = new[]
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â "Freezing", "Bracing", "Chilly", "Cool", "Mild", "Warm", "Balmy", "Hot", "Sweltering", "Scorching"
Â Â Â Â Â Â Â Â };
Â Â Â Â Â Â Â Â private readonly ILogger&lt;WeatherForecast Controller&gt; _logger;
Â Â Â Â Â Â Â Â public WeatherForecastController(ILogger&lt;WeatherForecast Controller&gt; logger)
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â _logger = logger;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â [HttpGet]
Â Â Â Â Â Â Â Â public IEnumerable&lt;WeatherForecast&gt; Get()
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â <strong class="bold">_logger.LogInformation("Logging Information for testing");</strong>
<strong class="bold">Â Â Â Â Â Â Â Â Â Â Â Â _logger.LogWarning("Logging Warning for testing");</strong>
<strong class="bold">Â Â Â Â Â Â Â Â Â Â Â Â _logger.LogError("Logging Error for testing");</strong>
Â Â Â Â Â Â Â Â Â Â Â Â var rng = new Random();
Â Â Â Â Â Â Â Â Â Â Â Â return Enumerable.Range(1, 5).Select(index =&gt; new WeatherForecast
Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Date = DateTime.Now.AddDays(index),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â TemperatureC = rng.Next(-20, 55),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Summary = Summaries[rng.Next(Summaries.Length)]
Â Â Â Â Â Â Â Â Â Â Â Â })
Â Â Â Â Â Â Â Â Â Â Â Â .ToArray();
Â Â Â Â Â Â Â Â }
}</pre></li>
				<li><code>TestAppServiceForLoggingDemo</code>. For more information<a id="_idIndexMarker533"/> on how to publish, refer to <a href="https://docs.microsoft.com/en-us/visualstudio/deployment/quickstart-deploy-to-azure?view=vs-2022">https://docs.microsoft.com/en-us/visualstudio/deployment/quickstart-deploy-to-azure?view=vs-2022</a>. For this example, we have leveraged the Windows-based App Service plan.</li>
				<li><strong class="bold">Enabling logging</strong>: Go to the Azure portal | <strong class="bold">Your subscription</strong> | <strong class="bold">Resource Group</strong> | <strong class="bold">App servic<a id="_idTextAnchor651"/>e</strong> where it is deployed, and select <strong class="bold">App Service logs</strong> under <strong class="bold">Monitoring</strong>. You can see different logging option<a id="_idTextAnchor652"/>s, as shown:</li>
			</ol>
			<div><div><img src="img/Figure_7.3_B18507.jpg" alt="Figure 7.3 â€“ App Service logs default state&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.3 â€“ App Service logs default state</p>
			<p>All logging options are <a id="_idTextAnchor653"/>turned<a id="_idIndexMarker534"/> off by default, as shown in the previous<a id="_idIndexMarker535"/> screenshot. Let's see what those options are:</p>
			<ul>
				<li><strong class="bold">Application Logging (Filesystem)</strong>: Writes log messages from the application to the local filesystem on the web server. This will be enabled for 12 hours once you turn it on and will be disabled automatically after that. Therefore, this option is for temporary debugging purposes.</li>
				<li><strong class="bold">Application Logging (Blob)</strong>: Writes log messages from the application to Blob storage for persistent logs for a configured retention period. Logging in blobs is for long-term debugging purposes. You would need a Blob storage container to write logs to. You can read more about Blob storage containers here: <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction">https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction</a>. Once you select <strong class="bold">On</strong>, you will get<a id="_idIndexMarker536"/> an option to create a new storage account or search for an existing storage<a id="_idIndexMarker537"/> account where you can write the logs. Click on <strong class="bold">+ Storage account</strong> and specify a name to create a new account, as shown in the follow<a id="_idTextAnchor655"/>ing screenshot:</li>
			</ul>
			<div><div><img src="img/Figure_7.4_B18507.jpg" alt="Figure 7.4 â€“ Storage account configuration&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.4 â€“ Storage account configuration</p>
			<ul>
				<li><strong class="bold">Web server logging</strong>: IIS logs on servers that give diagnostic information such as the HTTP method, resource URI, client IP, client port, user agent, and response code. You can store the logs in Blob storage or on the filesystem. In <strong class="bold">Retention Period (Days)</strong>, you can configure the number of days for which the logs should be retained.</li>
				<li><code>400</code> responses from the server, which can help you determine why the server returned this error. <p class="callout-heading">Note</p><p class="callout">For security reasons, we don't send detailed error pages to clients in production, but App Service can save this error in the filesystem each time an application error occurs that has HTTP code <code>400</code> or greater.</p></li>
				<li><strong class="bold">Failed request tracing</strong>: Detailed information<a id="_idIndexMarker538"/> on failed requests, including<a id="_idIndexMarker539"/> IIS trace an<a id="_idTextAnchor656"/>d so on. For each failed request, a folder is generated that contains the XML log file and the XSL stylesheet to view the log file.</li>
			</ul>
			<p>The following screenshot shows how it will look when you turn it on and enable all the log options:</p>
			<div><div><img src="img/Figure_7.5_B18507.jpg" alt="Figure 7.5 â€“ App Service logs enabled&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.5 â€“ App Service logs enabled</p>
			<ol>
				<li value="6">You can verify logs<a id="_idIndexMarker540"/> from any of the logging options<a id="_idIndexMarker541"/> we have enabled by browsing the site hosted on App Service and navigating to the page that hits the controller where logging is done. For example, let's check <strong class="bold">Application Logging (Blob<a id="_idTextAnchor657"/>)</strong> by accessing the Blob storage where we configured one of the logging options, as shown in the foll<a id="_idTextAnchor658"/>owing screenshot:</li>
			</ol>
			<div><div><img src="img/Figure_7.6_B18507.jpg" alt="Figure 7.6 â€“ App Service logs from Blob storage&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.6 â€“ App Service logs from Blob storage</p>
			<p>You can also see the logs in the log stream in real-time from the controller where we added test logs by navigating to <strong class="bold">Log stream</strong> u<a id="_idTextAnchor659"/>nder <strong class="bold">Monitoring</strong>:</p>
			<div><div><img src="img/Figure_7.7_B18507.jpg" alt="Figure 7.7 â€“ App Service logs in Log stream&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.7 â€“ App Service logs in Log stream</p>
			<p>We saw how to enable<a id="_idIndexMarker542"/> <a id="_idTextAnchor660"/>different logs in Azure App Service<a id="_idIndexMarker543"/> and verified logs in <strong class="bold">Application Logging (Blob)</strong> and <strong class="bold">Log stream</strong>. In the next section, we will see how we can monitor<a id="_idTextAnchor661"/><a id="_idTextAnchor662"/> and raise alerts.</p>
			<h2 id="_idParaDest-138"><a id="_idTextAnchor663"/>Monitoring using metrics</h2>
			<p>You can monitor you<a id="_idTextAnchor664"/>r App Service plan<a id="_idIndexMarker544"/> and app services using<a id="_idIndexMarker545"/> metrics in Azure Monitor.</p>
			<p>Navigate to your App Service plan and check the overview, as shown in the following screenshot. You can see standard<a id="_idIndexMarker546"/> charts for CPU, memory, data<a id="_idIndexMarker547"/> in,<a id="_idTextAnchor665"/> data out, and so on:</p>
			<div><div><img src="img/Figure_7.8_B18507.jpg" alt="Figure 7.8 â€“ App Service plan overview&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.8 â€“ App Service plan o<a id="_idTextAnchor666"/>verview</p>
			<p>Now, click on any of the charts, for example, the <strong class="bold">CPU Percentage</strong> chart. You will get the view shown in the following screenshot (the default <a id="_idTextAnchor667"/>duration is 1 hour):</p>
			<div><div><img src="img/Figure_7.9_B18507.jpg" alt="Figure 7.9 â€“ App Service metrics overview&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.9 â€“ App Service metrics overview</p>
			<p>I have highlighted three important<a id="_idIndexMarker548"/> sections in the chart shown in the previous<a id="_idIndexMarker549"/> screenshot. Let's discuss them:</p>
			<ul>
				<li><strong class="bold">Local Time</strong>: When you click on <strong class="bold">Local Time</strong>, you will get options as<a id="_idTextAnchor668"/> shown in the following screenshot. You can change the value of the time range for which this c<a id="_idTextAnchor669"/>hart should represent:</li>
			</ul>
			<p class="figure-caption"> </p>
			<div><div><img src="img/Figure_7.10_B18507.jpg" alt="Figure 7.10 â€“ App Service metrics time range&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.10 â€“ App Service metrics time range</p>
			<ul>
				<li><strong class="bold">Add metric</strong>: When you click<a id="_idIndexMarker550"/> on <strong class="bold">Add metric</strong>, you will get the options<a id="_idIndexMarker551"/> shown in the following screenshot. You can select the metric you wan<a id="_idTextAnchor670"/>t the chart to display:</li>
			</ul>
			<p class="figure-caption"> </p>
			<div><div><img src="img/Figure_7.11_B18507.jpg" alt="Figure 7.11 â€“ App Service â€“ Add metric&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.11 â€“ App Service â€“ Add metric</p>
			<ul>
				<li><strong class="bold">Pin to dashboard</strong>: You can click on <strong class="bold">Pin to dashboard</strong> and add the chart to the dashboard so that you can see updates when you log in to the Azure portal.</li>
			</ul>
			<p>When you click on the left portal menu, you can see <strong class="bold">Dashboard</strong>, and you can click on that to see all <a id="_idTextAnchor671"/>the pinned dashboards:</p>
			<p class="figure-caption"> </p>
			<div><div><img src="img/Figure_7.12_B18507.jpg" alt="Figure 7.12 â€“ Left portal menu option for Dashboard&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.12 â€“ Left portal menu<a id="_idTextAnchor672"/><a id="_idTextAnchor673"/> option for Dashboard</p>
			<p>In the next section, let's see how<a id="_idIndexMarker552"/> to enable real-time telemetry<a id="_idIndexMarker553"/> in Azure Application insights.</p>
			<h1 id="_idParaDest-139"><a id="_idTextAnchor674"/>Real-time telemetry in Azure Application Insights</h1>
			<p>Applicatio<a id="_idTextAnchor675"/>n Insights<a id="_idIndexMarker554"/> is one of the best telemetry offerings<a id="_idIndexMarker555"/> provided by Microsoft Azure for developers<a id="_idIndexMarker556"/> <a id="_idTextAnchor676"/>and DevOps professionals as an extensible <strong class="bold">application performance management</strong> (<strong class="bold">APM</strong>) service to do the following:</p>
			<ul>
				<li>Monitor your applications live.</li>
				<li>Automatically detect performance anomalies.</li>
				<li>Include powerful analytics tools to help you diagnose issues.</li>
				<li>Understand what users do with your app.</li>
				<li>Help you continuously improve performance and usability.</li>
			</ul>
			<p><code>Microsoft.Extensions.Logging.ApplicationInsights</code> is included as a dependency of <code>Microsoft.ApplicationInsights.AspNetCore</code>. The <code>Microsoft.ApplicationInsights.AspNetCore</code> package is used in ASP.NET Core applications for telemetry, and when you use this, you don't need to install <code>Microsoft.Extensions.Logging.ApplicationInsights</code>.</p>
			<p>As shown in the following figure, you can<a id="_idIndexMarker557"/> install this package<a id="_idIndexMarker558"/> in your application to <a id="_idTextAnchor677"/>enable and write telemetry:</p>
			<p class="figure-caption"><img src="img/Figure_7.13_B18507.png" alt="Figure 7.13 â€“ Application Insights instrumentation for telemetry&#13;&#10;"/></p>
			<p class="figure-caption">Figure 7.13 â€“ Application Insights instrumentation for telemetry</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Th<a id="_idTextAnchor678"/>ere is no impact on your app performance. Calls to Application Insights are non-blocking and sent in s<a id="_idTextAnchor679"/><a id="_idTextAnchor680"/>eparate threads in batches.</p>
			<h2 id="_idParaDest-140">Enabling application logging in Application <a id="_idTextAnchor681"/>Insights</h2>
			<p>The steps to enable application<a id="_idIndexMarker559"/> l<a id="_idTextAnchor682"/>ogging when using Application<a id="_idIndexMarker560"/> Insights are as follows:</p>
			<ol>
				<li value="1"><code>Microsoft.ApplicationInsights.AspNetCore</code> package<a id="_idIndexMarker562"/> from <code>Install-Package &lt;Package name&gt; -ver<a id="_idTextAnchor683"/>sion &lt;Version number&gt;</code> command:</li>
			</ol>
			<div><div><img src="img/Figure_7.14_B18507.jpg" alt="Figure 7.14 - Installing packages from Package Manager Console&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.14 - Installing packages from Package Manager Console</p>
			<ol>
				<li value="2"><code>appsettings.json</code> so that al<a id="_idTextAnchor685"/>l telemetry data is written to <a id="_idTextAnchor686"/>your Azure Application Insights resource. If you don't have an Azure Application Insights resource, go ahead and create one, and then add it to <code>appsettings.json</code>:<pre>{
Â Â "Logging": {
Â Â Â Â "LogLevel": {
Â Â Â Â Â Â "Default": "Information",
Â Â Â Â Â Â "Microsoft": "Warning",
Â Â Â Â Â Â "Microsoft.Hosting.Lifetime": "Information"
Â Â Â Â }
Â Â },
Â Â "Telemetry": {
Â Â Â Â <strong class="bold">"InstrumentationKey": "Your AppInsights Instrumentation Key "</strong>
Â Â }</pre></li>
				<li><code>Progra<a id="_idTextAnchor688"/>m.cs</code> file, add<a id="_idIndexMarker563"/> the highlighted<a id="_idIndexMarker564"/> code:<pre><strong class="bold">string InstrumentationKey = builder.Configuration["Telemetry:InstrumentationKey"];</strong>
// The following line enables Application Insights telemetry collection.
<strong class="bold">builder.Services.AddApplicationInsightsTelemetry(InstrumentationKey);</strong>Â Â Â Â Â Â Â Â Â </pre></li>
			</ol>
			<p>Now, you can build and run the application. Out of the box, you will get a lot of telemetry data.</p>
			<p>Navigate to <strong class="bold">Application Insights</strong> | <strong class="bold">Overview</strong> and you can see any failed requests, the server response time, and server requests, as sho<a id="_idTextAnchor689"/>wn in the following screenshot:</p>
			<div><div><img src="img/Figure_7.15_B18507.jpg" alt="Figure 7.15 â€“ Application Insights overview&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.15 â€“ Application Insights overview</p>
			<p>You can navigate<a id="_idIndexMarker565"/> to <strong class="bold">Application Insig<a id="_idTextAnchor690"/>hts</strong> | <strong class="bold">Live Metrics</strong> for re<a id="_idTextAnchor691"/>al-time<a id="_idIndexMarker566"/> performance counters, a<a id="_idTextAnchor692"/>s shown in the following figure:</p>
			<div><div><img src="img/Figure_7.16_B18507.jpg" alt="Figure 7.16 - Application Insights live metrics&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.16 - Application Insights live metrics</p>
			<p>You can navigate to <strong class="bold">Application Insights</strong> | <strong class="bold">Metrics</strong> to get diffe<a id="_idTextAnchor693"/>rent<a id="_idIndexMarker567"/> metrics and<a id="_idTextAnchor694"/> charts, a<a id="_idTextAnchor695"/>s shown<a id="_idIndexMarker568"/> in the following figure:</p>
			<div><div><img src="img/Figure_7.17_B18507.jpg" alt="Figure 7.17 â€“ Application Insights metrics&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.17 â€“ Application Insights metrics</p>
			<p>You can navigate to <strong class="bold">Application Insights</strong> | <strong class="bold">Performance</strong> and analyze<a id="_idIndexMarker569"/> operation duration, dependency response<a id="_idIndexMarker570"/> time, and so on,<a id="_idTextAnchor696"/> as shown in the following figure:</p>
			<div><div><img src="img/Figure_7.18_B18507.jpg" alt="Figure 7.18 â€“ Application Insights performance&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.18 â€“ Application Insights performance</p>
			<p>You can navigate to <strong class="bold">Application Insights</strong> | <strong class="bold">Failures</strong> and analyze o<a id="_idTextAnchor697"/>perations, failed requests,<a id="_idTextAnchor698"/> failed dependencies, the top three response codes, exception types, and dependency failures, <a id="_idTextAnchor699"/>as shown in the following figure:</p>
			<div><div><img src="img/Figure_7.19_B18507.jpg" alt="Figure 7.19 â€“ Application Insights failures&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.19 â€“ Application Insights failures</p>
			<p>We have seen the telemetry<a id="_idIndexMarker571"/> and alerts available out<a id="_idIndexMarker572"/> of the box. How do we add logs for information, errors, or warnings? You can use the logger (object creation happens using DI, which was covered in <a href="B18507_05_Epub.xhtml#_idTextAnchor445"><em class="italic">Chapter 5</em></a>, <em class="italic">Dependency Injection in .NET 6</em>). DI is enabled by the second (<em class="italic">App settings configuration</em>) and third (<em class="italic">Enabling the Application Insights telemetry</em>) steps that we saw in the preceding set of steps to enable logging in Application Insights. For testing purposes, to see whether it's working, you can add the following code to your controller and run the application:</p>
			<pre class="source-code">[HttpGet]</pre>
			<pre class="source-code">Â Â Â Â Â Â Â Â public IEnumerable&lt;WeatherForecast&gt; Get()</pre>
			<pre class="source-code">Â Â Â Â Â Â Â Â {</pre>
			<pre class="source-code">Â Â Â Â //Removed code for brevity</pre>
			<pre class="source-code">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </pre>
			<pre class="source-code">Â Â Â Â Â Â Â Â Â Â Â Â _logger.LogWarning("Logging Warning for</pre>
			<pre class="source-code">Â Â Â Â Â Â Â Â Â Â Â Â Â Â  testing");</pre>
			<pre class="source-code">Â Â Â Â Â Â Â Â Â Â Â Â _logger.LogError("Logging Error for testing");</pre>
			<pre class="source-code">Â Â Â Â Â Â Â Â Â Â Â Â //Removed code for brevity</pre>
			<p>You can navigate to <strong class="bold">Application Insights</strong> | <strong class="bold">Logs</strong> and check traces, wher<a id="_idTextAnchor700"/>e you can see bo<a id="_idTextAnchor701"/>th the warnings and errors<a id="_idIndexMarker573"/> that were logged<a id="_idTextAnchor702"/>, as shown<a id="_idIndexMarker574"/> in the following figure:</p>
			<div><div><img src="img/Figure_7.20_B18507.jpg" alt="Figure 7.20 â€“ Application Insights logs&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.20 â€“ Application Insights logs</p>
			<p>Application Insights is very simple to use and a very powerful log provider. We saw the rich telemetry it provides out-of-the-box and added our own logs. In the next section, we will develop a custom logging class library. The default logger provided in .NET 6 is more than enough for your application telemetry. If you need custom metrics and events to be logged on top of what's provided by default in .NET 6, you can leverage <a id="_idTextAnchor703"/><a id="_idTextAnchor704"/>the following custom logger library.</p>
			<h1 id="_idParaDest-141"><a id="_idTextAnchor705"/>Creating a .NET 6 logging class library</h1>
			<p>We will create a class library (DLL) that will support <a id="_idIndexMarker575"/>Application Insights logging and can be extended to support logging to other sources if needed. Perform the following steps for this:</p>
			<ol>
				<li value="1">Create a new .NET 6 class library with the name <code>Logger</code>.</li>
				<li>Install the <code>Microsoft.ApplicationInsights</code> package.</li>
				<li>Create a new class<a id="_idIndexMarker576"/> called <code>ICustomLogger.cs</code> and add the following code:<pre>using System;
using System.Collections.Generic;
namespace Logger
{
Â Â Â Â public interface ICustomLogger
Â Â Â Â {
Â Â Â Â Â Â Â Â void Dependency(string dependencyTypeName,
Â Â Â Â Â Â Â Â  string dependencyName, string data,
Â Â Â Â Â Â Â Â  DateTimeOffset startTime, TimeSpan duration,
Â Â Â Â Â Â Â Â  bool success);
Â Â Â Â Â Â Â Â void Error(string message, IDictionary&lt;string,
Â Â Â Â Â Â Â Â Â Â string&gt; properties = null);
Â Â Â Â Â Â Â Â void Event(string eventName,
Â Â Â Â Â Â Â Â IDictionary&lt;string, string&gt; properties = null,
Â Â Â Â Â Â Â Â IDictionary&lt;string, double&gt; metrics = null);
Â Â Â Â Â Â Â Â void Metric(string name, long value,
Â Â Â Â Â Â Â Â  IDictionary&lt;string, string&gt; properties =
Â Â Â Â Â Â Â Â  null);
Â Â Â Â Â Â Â Â void Exception(Exception exception,
Â Â Â Â Â Â Â Â  IDictionary&lt;string, string&gt; properties =
Â Â Â Â Â Â Â Â  null);
Â Â Â Â Â Â Â Â void Information(string message,
Â Â Â Â Â Â Â Â  IDictionary&lt;string, string&gt; properties =
Â Â Â Â Â Â Â Â  null);
Â Â Â Â Â Â Â Â void Request(string name, DateTimeOffset
Â Â Â Â Â Â Â Â  startTime, TimeSpan duration, string
Â Â Â Â Â Â Â Â  responseCode, bool success);
Â Â Â Â Â Â Â Â void Verbose(string message,
Â Â Â Â Â Â Â Â  IDictionary&lt;string, string&gt; properties =
Â Â Â Â Â Â Â Â  null);
Â Â Â Â Â Â Â Â void Warning(string message,
Â Â Â Â Â Â Â Â  IDictionary&lt;string, string&gt; properties <a id="_idTextAnchor706"/>=
Â Â Â Â Â Â Â Â  null);
Â Â Â Â }
}</pre></li>
				<li>Create a new class called <code>AiLogger.cs</code> and add<a id="_idIndexMarker577"/> the following code to log custom events and metrics:<ul><li><strong class="bold">Namespaces and Constructor</strong>:<pre>using Microsoft.ApplicationInsights;
using Microsoft.ApplicationInsights.DataContracts;
using System;
using System.Collections.Generic;
namespace Logger
{
Â Â Â Â public class AiLogger : ICustomLogger
Â Â Â Â {
Â Â Â Â Â Â Â Â private TelemetryClient client;
Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â public AiLogger(TelemetryClient client)
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â if (client is null)
Â Â Â Â Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â throw new ArgumentNullException(nameof(client));
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â this.client = client;
Â Â Â Â Â Â Â Â }</pre></li><li><strong class="bold">Code to log warning, error, and exception</strong>:<pre>Â Â Â Â Â Â Â Â public void Warning(string message, IDictionary&lt;string, string&gt; properties = null)
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â this.client.TrackTrace(message, SeverityLevel.Warning, properties);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â public void Error(string message, IDictionary&lt;string, string&gt; properties = null)
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â this.client.TrackTrace(message, SeverityLevel.Error, properties);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â public void Exception(Exception exception, IDictionary&lt;string, string&gt; properties = null)
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â this.client.TrackException(exception, properties);
Â Â Â Â Â Â Â Â }Â Â Â Â Â Â Â Â </pre></li><li><strong class="bold">Code to log custom event, metric, information, request, and dependency</strong>:<pre>public void Event(string eventName, IDictionary&lt;string, string&gt; properties = null, IDictionary&lt;string, double&gt; metrics = null)
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â this.client.TrackEvent(eventName, properties, metrics);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â public void Metric(string name, long value, IDictionary&lt;string, string&gt; properties = null)
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â this.client.TrackMetric(name, value, properties);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â public void Information(string message, IDictionary&lt;string, string&gt; properties = null)
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â this.client.TrackTrace(message, SeverityLevel.Information, properties);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â public void Request(string name, DateTimeOffset startTime, TimeSpan duration, string responseCode, bool success)
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â Â Â this.client.TrackRequest(name, startTime, duration, responseCode, success);
Â Â Â Â Â Â Â Â }Â Â Â Â Â Â Â Â 
Â Â Â Â }
public void Dependency(string dependencyTypeName, string dependencyName, string data, DateTimeOffset startTime, TimeSpan duration, bool success)
Â Â Â Â Â Â Â Â {Â Â Â Â Â Â Â Â Â Â Â Â this.client.TrackDependency(dependencyTypeName, dependencyName, data, startTime, duration, success);
Â Â Â Â Â Â Â Â }</pre></li></ul></li>
			</ol>
			<p><code>AiLogger</code> uses the <code>TelemetryClient</code> class, which sends telemetry to Azure Application Insights.</p>
			<ol>
				<li value="5">Build the library, and your custom .NET 6 logger<a id="_idIndexMarker578"/> is ready to consume events in y<a id="_idTextAnchor707"/>our project.</li>
			</ol>
			<p>In the upcoming chapters, we will be consuming the logging library as part of our enterprise application development. In the example provided for this chapter, you can see how we have dynamically injected this custom lo<a id="_idTextAnchor708"/><a id="_idTextAnchor709"/>gger into the <code>LoggerDemoService</code> project.</p>
			<h1 id="_idParaDest-142"><a id="_idTextAnchor710"/>Summary</h1>
			<p>In this chapter, we learned about the characteristics of good logging, the different logging providers available, such as the Azure App Service logging provider and the Azure Application Insights logging provider, and how to create a reusable logger library.</p>
			<p>You now have the necessary knowledge of logging that will help you to implement a reusable logger or extend a current logger in your project, with the right level of logging and key information to debug issues and build analytics on production data.</p>
			<p>In the next chapter, we will learn about various techniques to cache data in .NET 6 applications, as well as various caching components and the platforms available that ca<a id="_idTextAnchor711"/><a id="_idTextAnchor712"/>n be integrated with a .NET application.</p>
			<h1 id="_idParaDest-143"><a id="_idTextAnchor713"/>Questions</h1>
			<ol>
				<li value="1">Which logs highlight when the current flow of execution has stopped due to a failure? These should indicate a failure in the current activity, not an application-wide failure:</li>
			</ol>
			<p>a. Warning</p>
			<p>b. Error</p>
			<p>c. Critical</p>
			<p>d. Information</p>
			<p><strong class="bold">Answer : b</strong></p>
			<ol>
				<li value="2">What can be leveraged by applications and components running anywhere, on Azure, AWS, your own on-premises servers, or a mobile platform, for logging?</li>
			</ol>
			<p>a. Application Insights</p>
			<p>b. Azure App Service</p>
			<p>c. EventLog</p>
			<p>d. Serilog</p>
			<p><strong class="bold">Answer: a</strong></p>
			<ol>
				<li value="3">What are the logging options available in Azure App Service?</li>
			</ol>
			<p>a. <strong class="bold">Application Logging (Filesystem)</strong> and <strong class="bold">Application Logging (Blob</strong><strong class="bold">)</strong></p>
			<p>b. <strong class="bold">Web server logging</strong> and <strong class="bold">Detailed error messages</strong></p>
			<p>c. <strong class="bold">Failed request tracing</strong></p>
			<p>d. All the above</p>
			<p><strong class="bold">Answer:  d</strong></p>
			<ol>
				<li value="4">Application Insights is an extensible APM service to do which of the following?</li>
			</ol>
			<p>a. Monitor your live applications.</p>
			<p>b. Automatically detect performance anomalies.</p>
			<p>c. Include powerful analytics tools to help you diagnose issues.</p>
			<p>d. All the above.</p>
			<p><strong class="bold">Answer: d</strong></p>
		</div>
	</body></html>