<html><head></head><body>
<div id="_idContainer186">
<h1 class="chapter-number" id="_idParaDest-162"><a id="_idTextAnchor867"/><span class="koboSpan" id="kobo.1.1">10</span></h1>
<h1 id="_idParaDest-163"><a id="_idTextAnchor868"/><span class="koboSpan" id="kobo.2.1">Building a Real-Time Game</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we will build a multi-player, head-to-head game app with real-time communication. </span><span class="koboSpan" id="kobo.3.2">In the app, you will be able to connect to a game server and view a list of other players that are also connected. </span><span class="koboSpan" id="kobo.3.3">You can then select a player to request a game with them and, provided they accept, play a game of </span><em class="italic"><span class="koboSpan" id="kobo.4.1">Sticks &amp; Stones</span></em><span class="koboSpan" id="kobo.5.1">. </span><span class="koboSpan" id="kobo.5.2">We will look at how we can use SignalR to implement a real-time connection with </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">the server.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">The following topics will be covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.9.1">How to use SignalR in a .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">MAUI app</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">How to use control templates </span></li>
<li><span class="koboSpan" id="kobo.12.1">How to use XAML triggers to update </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">the interface</span></span></li>
<li><span class="koboSpan" id="kobo.14.1">How to use XAML styling in a .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">MAUI app</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.16.1">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">get started.</span></span></p>
<h1 id="_idParaDest-164"><a id="_idTextAnchor869"/><span class="koboSpan" id="kobo.18.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.19.1">Before you start building the app for this project, you need to build the backend that we detailed in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.20.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.21.1">, </span><em class="italic"><span class="koboSpan" id="kobo.22.1">Setting Up a Backend for a Game Using Azure Services</span></em><span class="koboSpan" id="kobo.23.1">. </span><span class="koboSpan" id="kobo.23.2">You will also need to have Visual Studio for Mac or PC installed, as well as the .NET MAUI components. </span><span class="koboSpan" id="kobo.23.3">See </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.24.1">Chapter 1</span></em></span><span class="koboSpan" id="kobo.25.1">, </span><em class="italic"><span class="koboSpan" id="kobo.26.1">Introduction to .NET MAUI</span></em><span class="koboSpan" id="kobo.27.1">, for more details on how to set up your environment. </span><span class="koboSpan" id="kobo.27.2">The source code for this chapter is available in this book’s GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">repository: </span></span><a href="https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition/tree/chapters/ten/main"><span class="No-Break"><span class="koboSpan" id="kobo.29.1">https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition/tree/chapters/ten/main</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.30.1">.</span></span></p>
<h1 id="_idParaDest-165"><a id="_idTextAnchor870"/><a id="_idTextAnchor871"/><span class="koboSpan" id="kobo.31.1">Project overview</span></h1>
<p><span class="koboSpan" id="kobo.32.1">When building a </span><a id="_idIndexMarker991"/><span class="koboSpan" id="kobo.33.1">head-to-head game app, it is really important to have real-time communication because the user expects the other players’ moves to arrive more or less immediately. </span><span class="koboSpan" id="kobo.33.2">To achieve this, we will use SignalR, which is a library for real-time communication. </span><span class="koboSpan" id="kobo.33.3">SignalR will use WebSockets if they are available and, if not, it will have several fallback options it can use instead. </span><span class="koboSpan" id="kobo.33.4">In the app, we will use SignalR to send updates on player and game status through the Azure Functions that we built in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.34.1">Chapter 9</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.36.1">The build time for this project is about </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">180 minutes.</span></span><a id="_idTextAnchor872"/></p>
<h1 id="_idParaDest-166"><a id="_idTextAnchor873"/><span class="koboSpan" id="kobo.38.1">Getting started</span></h1>
<p><span class="koboSpan" id="kobo.39.1">We can use either Visual Studio on a PC or Mac to complete this project. </span><span class="koboSpan" id="kobo.39.2">To build an iOS app using Visual Studio for PC, you have to have a Mac connected. </span><span class="koboSpan" id="kobo.39.3">If you don’t have access to a Mac at all, you can choose to just build the Android part of </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">the</span><a id="_idTextAnchor874"/><span class="koboSpan" id="kobo.41.1"> app.</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">Let’s review from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.43.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.44.1"> what the game is </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">all about.</span></span></p>
<h2 id="_idParaDest-167"><a id="_idTextAnchor875"/><span class="koboSpan" id="kobo.46.1">An overview of the game</span></h2>
<p><em class="italic"><span class="koboSpan" id="kobo.47.1">Sticks &amp; Stones</span></em><span class="koboSpan" id="kobo.48.1"> is a turn-based </span><a id="_idIndexMarker992"/><span class="koboSpan" id="kobo.49.1">social game based on the concepts of two childhood games mashed into one, Dots and Boxes (</span><a href="https://en.wikipedia.org/wiki/Dots_and_boxes"><span class="koboSpan" id="kobo.50.1">https://en.wikipedia.org/wiki/Dots_and_boxes</span></a><span class="koboSpan" id="kobo.51.1">) and Tic-Tac-Toe (</span><a href="https://en.wikipedia.org/wiki/Tic-tac-toe"><span class="koboSpan" id="kobo.52.1">https://en.wikipedia.org/wiki/Tic-tac-toe</span></a><span class="koboSpan" id="kobo.53.1">). </span><span class="koboSpan" id="kobo.53.2">The game board is laid out in a three-by-three grid. </span><span class="koboSpan" id="kobo.53.3">Each player will take a turn placing a stick along the side of a box, between two dots, to earn one point. </span><span class="koboSpan" id="kobo.53.4">If a stick completes a box, then the player takes ownership of the box, earning five points. </span><span class="koboSpan" id="kobo.53.5">The game is won when a player owns three boxes in a row, horizontally, vertically, or diagonally. </span><span class="koboSpan" id="kobo.53.6">If no player can own three boxes in a row, the winner of the game is determined by the player with the </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">highest score.</span></span></p>
<p><span class="koboSpan" id="kobo.55.1">To keep the app and the service side relatively simple, we will eliminate a lot of state management. </span><span class="koboSpan" id="kobo.55.2">When the player opens the app, they will have to connect to the game service. </span><span class="koboSpan" id="kobo.55.3">They will have to provide a gamer tag, or username, and an email address. </span><span class="koboSpan" id="kobo.55.4">Optionally, they can upload a picture of themselves to use as a </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">profile picture.</span></span></p>
<p><span class="koboSpan" id="kobo.57.1">Once connected, the player will then see a list of all the other players connected to the same game service; this is called the Lobby. </span><span class="koboSpan" id="kobo.57.2">The player’s status of either </span><strong class="bold"><span class="koboSpan" id="kobo.58.1">Ready to play</span></strong><span class="koboSpan" id="kobo.59.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.60.1">In a match</span></strong><span class="koboSpan" id="kobo.61.1"> is displayed along with the player’s gamer tag and profile picture. </span><span class="koboSpan" id="kobo.61.2">If the player is not in a match, a button is available to challenge the player to </span><span class="No-Break"><span class="koboSpan" id="kobo.62.1">a match.</span></span></p>
<p><span class="koboSpan" id="kobo.63.1">Challenging a player to a match will cause the app to prompt the opponent to respond to the challenge, either accept or decline it. </span><span class="koboSpan" id="kobo.63.2">If the opponent accepts the challenge, then both players are navigated to a new game board where the player who received the challenge will have the first turn. </span><span class="koboSpan" id="kobo.63.3">Both players’ statuses will update to </span><strong class="bold"><span class="koboSpan" id="kobo.64.1">In a match</span></strong><span class="koboSpan" id="kobo.65.1"> in all the other </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">players’ lobbies.</span></span></p>
<p><span class="koboSpan" id="kobo.67.1">Play will alternate between players as they choose a location to place a single stick. </span><span class="koboSpan" id="kobo.67.2">Each time a stick is placed by a player, the game board and score will update on both players’ devices. </span><span class="koboSpan" id="kobo.67.3">When a stick is placed that completes one or more squares, the player then wins that square, and a pile of stones is placed in the center of the square. </span><span class="koboSpan" id="kobo.67.4">When all sticks have been placed, or a player owns three stones in a row, the game is over, the players navigate back to the Lobby, and their status is updated to “Ready </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">to play.”</span></span></p>
<p><span class="koboSpan" id="kobo.69.1">If a player </span><a id="_idIndexMarker993"/><span class="koboSpan" id="kobo.70.1">leaves the app during a game, then they will have forfeited the match and the remaining opponent will be credited with the win and navigated back to </span><span class="No-Break"><span class="koboSpan" id="kobo.71.1">the Lobby.</span></span></p>
<p><span class="koboSpan" id="kobo.72.1">Now that we understand what we want to build, let’s get down to </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">the details.</span></span></p>
<p><span class="koboSpan" id="kobo.74.1">We recommend that you use the same solution we used in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.75.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.76.1">, </span><em class="italic"><span class="koboSpan" id="kobo.77.1">Setting Up a Backend for a Game Using Azure Services</span></em><span class="koboSpan" id="kobo.78.1">, because this will make code sharing easier. </span><span class="koboSpan" id="kobo.78.2">If you don’t want to go through all of </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.79.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.80.1">, you can get the completed source from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.81.1">Chapter 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.82.1">, </span></em><span class="No-Break"><span class="koboSpan" id="kobo.83.1">at </span></span><a href="https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition/tree/chapters/nine/main"><span class="No-Break"><span class="koboSpan" id="kobo.84.1">https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition/tree/chapters/nine/main</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.85.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.86.1">We will build this app in </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">four sections:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.88.1">Services</span></strong><span class="koboSpan" id="kobo.89.1"> – All the </span><a id="_idIndexMarker994"/><span class="koboSpan" id="kobo.90.1">classes that are needed to connect and interact with the Azure Functions backend that was built in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.91.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.92.1">, </span><em class="italic"><span class="koboSpan" id="kobo.93.1">Setting Up a Backend for a Game Using </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.94.1">Azure Services</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.96.1">Connect page</span></strong><span class="koboSpan" id="kobo.97.1"> – This </span><a id="_idIndexMarker995"/><span class="koboSpan" id="kobo.98.1">will consist of the view and view model needed to allow a user to connect to the game server as </span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">a player.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.100.1">Lobby page</span></strong><span class="koboSpan" id="kobo.101.1"> – The </span><a id="_idIndexMarker996"/><span class="koboSpan" id="kobo.102.1">Lobby is where the player can send and receive challenges with other players. </span><span class="koboSpan" id="kobo.102.2">In this section, we will build the view and view model for </span><span class="No-Break"><span class="koboSpan" id="kobo.103.1">the lobby.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.104.1">Game page</span></strong><span class="koboSpan" id="kobo.105.1"> – This is </span><a id="_idIndexMarker997"/><span class="koboSpan" id="kobo.106.1">where players can take turns playing a game of </span><em class="italic"><span class="koboSpan" id="kobo.107.1">Sticks and Stones</span></em><span class="koboSpan" id="kobo.108.1">. </span><span class="koboSpan" id="kobo.108.2">In this section, we will build the view and view model needed to make </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">that happen.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.110.1">Let’s start by creating the project for the .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">MAU</span><a id="_idTextAnchor876"/><span class="koboSpan" id="kobo.112.1">I app.</span></span></p>
<h1 id="_idParaDest-168"><a id="_idTextAnchor877"/><span class="koboSpan" id="kobo.113.1">Building the game app</span></h1>
<p><span class="koboSpan" id="kobo.114.1">It’s time </span><a id="_idIndexMarker998"/><span class="koboSpan" id="kobo.115.1">to start building the app. </span><span class="koboSpan" id="kobo.115.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">SticksAndStones</span></strong><span class="koboSpan" id="kobo.117.1"> solution from the previous chapter and follow these steps to create </span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">the project:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.119.1">Open the </span><strong class="bold"><span class="koboSpan" id="kobo.120.1">Create a new project</span></strong><span class="koboSpan" id="kobo.121.1"> wizard by selecting </span><strong class="bold"><span class="koboSpan" id="kobo.122.1">File</span></strong><span class="koboSpan" id="kobo.123.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.124.1">Add</span></strong><span class="koboSpan" id="kobo.125.1">, then </span><strong class="bold"><span class="koboSpan" id="kobo.126.1">New Project…</span></strong><span class="koboSpan" id="kobo.127.1"> from the Visual </span><span class="No-Break"><span class="koboSpan" id="kobo.128.1">Studio menu:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer166">
<span class="koboSpan" id="kobo.129.1"><img alt="Figure 10.1 – File | Add | New Project…" src="image/B19214_10_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.130.1">Figure 10.1 – File | Add | New Project…</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.131.1">In the search field, type </span><strong class="source-inline"><span class="koboSpan" id="kobo.132.1">maui</span></strong><span class="koboSpan" id="kobo.133.1"> and select the </span><strong class="bold"><span class="koboSpan" id="kobo.134.1">.NET MAUI App</span></strong><span class="koboSpan" id="kobo.135.1"> item from the list, or select </span><a id="_idIndexMarker999"/><span class="koboSpan" id="kobo.136.1">it from </span><strong class="bold"><span class="koboSpan" id="kobo.137.1">Recent project templates</span></strong><span class="koboSpan" id="kobo.138.1"> if it </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">is listed:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer167">
<span class="koboSpan" id="kobo.140.1"><img alt="Figure 10.2 – Create a new p﻿roject" src="image/B19214_10_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.141.1">Figure 10.2 – Create a new p</span><a id="_idTextAnchor878"/><span class="koboSpan" id="kobo.142.1">roject</span></p>
<ol>
<li value="3"><span class="No-Break"><span class="koboSpan" id="kobo.143.1">Click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.144.1">Next</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.146.1">Enter </span><strong class="source-inline"><span class="koboSpan" id="kobo.147.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.148.1"> as the name of the app and, under </span><strong class="bold"><span class="koboSpan" id="kobo.149.1">Solution</span></strong><span class="koboSpan" id="kobo.150.1">, select </span><strong class="bold"><span class="koboSpan" id="kobo.151.1">Add to solution</span></strong><span class="koboSpan" id="kobo.152.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.153.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer168">
<span class="koboSpan" id="kobo.154.1"><img alt="Figure 10.3 – Configure your new project" src="image/B19214_10_3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.155.1">Figure 10.3 – Configure your new project</span></p>
<ol>
<li value="5"><span class="No-Break"><span class="koboSpan" id="kobo.156.1">Click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.157.1">Next</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.158.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.159.1">The last </span><a id="_idIndexMarker1000"/><span class="koboSpan" id="kobo.160.1">step will prompt you for the version </span><a id="_idIndexMarker1001"/><span class="koboSpan" id="kobo.161.1">of .NET Core to support. </span><span class="koboSpan" id="kobo.161.2">At the time of writing, .NET 6 is </span><a id="_idIndexMarker1002"/><span class="koboSpan" id="kobo.162.1">available as </span><strong class="bold"><span class="koboSpan" id="kobo.163.1">Long-Term Support</span></strong><span class="koboSpan" id="kobo.164.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.165.1">LTS</span></strong><span class="koboSpan" id="kobo.166.1">), and .NET 7 is available as </span><strong class="bold"><span class="koboSpan" id="kobo.167.1">Standard Term Support</span></strong><span class="koboSpan" id="kobo.168.1">. </span><span class="koboSpan" id="kobo.168.2">For the purposes of this book, we will assume that you will be using .</span><span class="No-Break"><span class="koboSpan" id="kobo.169.1">NET 7:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer169">
<span class="koboSpan" id="kobo.170.1"><img alt="Figure 10.4 – Additional information" src="image/B19214_10_4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.171.1">Figure 10.4 – Additional information</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.172.1">Finalize the setup by clicking </span><strong class="bold"><span class="koboSpan" id="kobo.173.1">Create</span></strong><span class="koboSpan" id="kobo.174.1"> and wait for Visual Studio to create </span><span class="No-Break"><span class="koboSpan" id="kobo.175.1">the project.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.176.1">Now we </span><a id="_idIndexMarker1003"/><span class="koboSpan" id="kobo.177.1">have created the .NET MAUI project for our game screens, let’s configure it so that it’s ready to add the services and views. </span><span class="koboSpan" id="kobo.177.2">We will need to add a project reference to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">SticksAndStones.Shared</span></strong><span class="koboSpan" id="kobo.179.1"> project, as well as a few NuGet packages. </span><span class="koboSpan" id="kobo.179.2">Follow these steps to complete the setup of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">SticksAndStones.App</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.181.1"> project:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.182.1">Right-click the </span><strong class="source-inline"><span class="koboSpan" id="kobo.183.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.184.1"> project in </span><strong class="bold"><span class="koboSpan" id="kobo.185.1">Solution Explorer</span></strong><span class="koboSpan" id="kobo.186.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.187.1">select </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.188.1">Properties</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.189.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.190.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.191.1">Properties</span></strong><span class="koboSpan" id="kobo.192.1"> window, use the search box at the top to search for </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">Default namespace</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.195.1">Change the </span><strong class="bold"><span class="koboSpan" id="kobo.196.1">Default namespace</span></strong><span class="koboSpan" id="kobo.197.1"> property value to </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">$(MSBuildProjectName.Split(".")[0].Replace(" ", "</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">_"))</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.201.1">This will split the project name on </span><strong class="source-inline"><span class="koboSpan" id="kobo.202.1">"."</span></strong><span class="koboSpan" id="kobo.203.1">, using only the first part and replacing any spaces with underscores. </span></p></li>
<li><span class="koboSpan" id="kobo.204.1">Add a NuGet Package reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.205.1">CommunityToolkit.Mvvm</span></strong><span class="koboSpan" id="kobo.206.1"> as, in other chapters, we will be using this package to simplify the implementation of data bindings to properties </span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">and commands.</span></span></li>
<li><span class="koboSpan" id="kobo.208.1">Add a NuGet Package reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.209.1">CommunityToolkit.Maui</span></strong><span class="koboSpan" id="kobo.210.1">. </span><span class="koboSpan" id="kobo.210.2">We will be using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">GravatarImageSource</span></strong><span class="koboSpan" id="kobo.212.1"> class from this package to render an avatar for </span><a id="_idIndexMarker1004"/><span class="koboSpan" id="kobo.213.1">the user. </span><span class="koboSpan" id="kobo.213.2">For .NET 7, you will need to use version 6.1.0 of the NuGet package. </span><span class="koboSpan" id="kobo.213.3">7.0+ has .NET 8 as </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">a dependency.</span></span></li>
<li><span class="koboSpan" id="kobo.215.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">MauiProgram.cs</span></strong><span class="koboSpan" id="kobo.217.1"> file and add the highlighted line </span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">shown here:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.219.1">using CommunityToolkit.Maui;</span></strong><span class="koboSpan" id="kobo.220.1">
using Microsoft.Extensions.Logging;
namespace SticksAndStones.App
{
    public static class MauiProgram
    {
        public static MauiApp CreateMauiApp()
        {
            var builder = MauiApp.CreateBuilder();
            builder
                .UseMauiApp&lt;App&gt;()
                .ConfigureFonts(fonts =&gt;
                {
                    fonts.AddFont("OpenSans-Regular.ttf", "OpenSansRegular");
                    fonts.AddFont("OpenSans-Semibold.ttf", "OpenSansSemibold");
                })
                </span><strong class="bold"><span class="koboSpan" id="kobo.221.1">.UseMauiCommunityToolkit();</span></strong><span class="koboSpan" id="kobo.222.1">
#if DEBUG
            builder.Logging.AddDebug();
#endif
            return builder.Build();
        }
    }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.223.1">This will </span><a id="_idIndexMarker1005"/><span class="koboSpan" id="kobo.224.1">configure </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">CommunityToolkit</span></strong><span class="koboSpan" id="kobo.226.1"> for use within </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">the app.</span></span></p></li> <li><span class="koboSpan" id="kobo.228.1">Add a NuGet package reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">Microsoft.Extensions.Logging.Abstractions</span></strong><span class="koboSpan" id="kobo.230.1">. </span><span class="koboSpan" id="kobo.230.2">This package is used to log messages from the Azure Functions functions </span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">for debugging.</span></span></li>
<li><span class="koboSpan" id="kobo.232.1">Add a NuGet package reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">Microsoft.Extensions.Logging.Debugging</span></strong><span class="koboSpan" id="kobo.234.1">. </span><span class="koboSpan" id="kobo.234.2">This package is used to log messages from the Azure Functions functions </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">for debugging.</span></span></li>
<li><span class="koboSpan" id="kobo.236.1">Add a NuGet package reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.237.1">Microsoft.AspNetCore.SignalR.Client</span></strong><span class="koboSpan" id="kobo.238.1">. </span><span class="koboSpan" id="kobo.238.2">This package is required for the app to connect to the SignalR Hub we created in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.239.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.240.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">receive messages.</span></span></li>
<li><span class="koboSpan" id="kobo.242.1">Add a Project reference to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">SticksAndStones.Shared</span></strong><span class="koboSpan" id="kobo.244.1"> project. </span><span class="koboSpan" id="kobo.244.2">This will give us access to the messages and objects we created in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.245.1">Chapter 9</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.246.1">.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.247.1">That’s it for projec</span><a id="_idTextAnchor879"/><a id="_idTextAnchor880"/><a id="_idTextAnchor881"/><span class="koboSpan" id="kobo.248.1">t creation. </span><span class="koboSpan" id="kobo.248.2">Next, we will start with creating classes that interact directly with </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">ou</span><a id="_idTextAnchor882"/><a id="_idTextAnchor883"/><span class="koboSpan" id="kobo.250.1">r service.</span></span></p>
<h2 id="_idParaDest-169"><a id="_idTextAnchor884"/><span class="koboSpan" id="kobo.251.1">Creating the game services</span></h2>
<p><span class="koboSpan" id="kobo.252.1">The first </span><a id="_idIndexMarker1006"/><span class="koboSpan" id="kobo.253.1">thing we will do is create a service that will be used to communicate with the Azure Functions functions service created in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.254.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.255.1">, </span><em class="italic"><span class="koboSpan" id="kobo.256.1">Setting Up a Backend for a Game Using Azure Services</span></em><span class="koboSpan" id="kobo.257.1">. </span><span class="koboSpan" id="kobo.257.2">The service will be broken down into three </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">main classes:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">GameService</span></strong><span class="koboSpan" id="kobo.260.1"> – Methods and properties for calling the Azure Functions and receiving </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">SignalR messages.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.263.1"> – Holds the references to </span><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">HttpClient</span></strong><span class="koboSpan" id="kobo.265.1"> and SignalR Hub instances. </span><span class="koboSpan" id="kobo.265.2">Also provides methods for safely making calls </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">HttpClient</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">Settings</span></strong><span class="koboSpan" id="kobo.270.1"> – Stores and retrieves the URL for the server used by </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">HttpClient</span></strong><span class="koboSpan" id="kobo.272.1">. </span><span class="koboSpan" id="kobo.272.2">It also stores the connection details provided by </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">the user.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.274.1">We will start with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">Settings</span></strong><span class="koboSpan" id="kobo.276.1"> class since both </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">GameService</span></strong><span class="koboSpan" id="kobo.278.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.280.1"> will depend on </span><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">Settings</span></strong><span class="koboSpan" id="kobo.282.1">. </span></p>
<h3><span class="koboSpan" id="kobo.283.1">Creating the Settings service</span></h3>
<p><span class="koboSpan" id="kobo.284.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">Settings</span></strong><span class="koboSpan" id="kobo.286.1"> service is used to store values that are needed between app runs. </span><span class="koboSpan" id="kobo.286.2">It will use </span><a id="_idIndexMarker1007"/><span class="koboSpan" id="kobo.287.1">the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">Preferences</span></strong><span class="koboSpan" id="kobo.289.1"> class to store these values in a cross-platform manner. </span><span class="koboSpan" id="kobo.289.2">Use the following steps to implement the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">Settings</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.291.1"> class:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.292.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.294.1"> project, create a new folder </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.297.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.298.1">In the newly created </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">Services</span></strong><span class="koboSpan" id="kobo.300.1"> folder, create a new class </span><span class="No-Break"><span class="koboSpan" id="kobo.301.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">Settings</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.303.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.304.1">Make the </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">class public.</span></span></li>
<li><span class="koboSpan" id="kobo.306.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">const string</span></strong><span class="koboSpan" id="kobo.308.1"> field named </span><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">LastPlayerKey</span></strong><span class="koboSpan" id="kobo.310.1"> and initialize it </span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">like so:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.312.1">
private const string LastPlayerKey = nameof(LastPlayerKey);</span></pre></li> <li><span class="koboSpan" id="kobo.313.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">const string</span></strong><span class="koboSpan" id="kobo.315.1"> field named </span><strong class="source-inline"><span class="koboSpan" id="kobo.316.1">ServerUrlKey</span></strong><span class="koboSpan" id="kobo.317.1"> and initialize it </span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">like this:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.319.1">
private const string ServerUrlKey = nameof(ServerUrlKey);</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.320.1">These </span><a id="_idIndexMarker1008"/><span class="koboSpan" id="kobo.321.1">two fields are used by the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">Preferences</span></strong><span class="koboSpan" id="kobo.323.1"> class to store the values for the server URL and the login details for the last time the user </span><span class="No-Break"><span class="koboSpan" id="kobo.324.1">logged in.</span></span></p></li> <li><span class="koboSpan" id="kobo.325.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">private const string</span></strong><span class="koboSpan" id="kobo.327.1"> field named </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">ServerUrlDefault</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.329.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.330.1">
#if DEBUG &amp;&amp; ANDROID
    private const string ServerUrlDefault = "http://10.0.2.2:</span><strong class="bold"><span class="koboSpan" id="kobo.331.1">7071</span></strong><span class="koboSpan" id="kobo.332.1">/api";
#else
    private const string ServerUrlDefault = "http://localhost:</span><strong class="bold"><span class="koboSpan" id="kobo.333.1">7071</span></strong><span class="koboSpan" id="kobo.334.1">/api";
#endif</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.335.1">This snippet uses the conditional compilation features of C# to switch the </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">ServerlUrlDefault</span></strong><span class="koboSpan" id="kobo.337.1"> value for Android devices. </span><span class="koboSpan" id="kobo.337.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">10.0.2.2</span></strong><span class="koboSpan" id="kobo.339.1"> IP address is a special value used by the Android emulators to be able to access the host computer’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.340.1">localhost</span></strong><span class="koboSpan" id="kobo.341.1"> address. </span><span class="koboSpan" id="kobo.341.2">This is very useful when testing the app using the </span><strong class="bold"><span class="koboSpan" id="kobo.342.1">Azurite</span></strong><span class="koboSpan" id="kobo.343.1"> development environment for </span><span class="No-Break"><span class="koboSpan" id="kobo.344.1">Azure Functions.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.345.1">You may need to adjust the port number, highlighted in the preceding listing, for your specific development environment. </span><span class="koboSpan" id="kobo.345.2">Azure Functions will display the server URL when started from Visual Studio, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">following screenshot:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer170">
<span class="koboSpan" id="kobo.347.1"><img alt="Figure 10.5 – Azure Functions console output" src="image/B19214_10_5.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.348.1">Figure 10.5 – Azure Functions console output</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.349.1">Using the Azure Functions hosted in Azure</span></p>
<p class="callout"><span class="koboSpan" id="kobo.350.1">If you followed the steps in the </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.351.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.352.1"> section called </span><em class="italic"><span class="koboSpan" id="kobo.353.1">Deploying the functions to Azure</span></em><span class="koboSpan" id="kobo.354.1">, then you can use the URL for the Azure Function App created in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.355.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.356.1">, in the </span><em class="italic"><span class="koboSpan" id="kobo.357.1">Creating the Azure service for functions</span></em><span class="koboSpan" id="kobo.358.1"> section. </span><span class="koboSpan" id="kobo.358.2">The URL is displayed on the </span><strong class="bold"><span class="koboSpan" id="kobo.359.1">Overview</span></strong><span class="koboSpan" id="kobo.360.1"> tab of the Azure Functions App. </span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.361.1">Now, add </span><a id="_idIndexMarker1009"/><span class="koboSpan" id="kobo.362.1">a </span><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">public string</span></strong><span class="koboSpan" id="kobo.364.1"> property named </span><strong class="source-inline"><span class="koboSpan" id="kobo.365.1">ServerUrl</span></strong><span class="koboSpan" id="kobo.366.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">following implementation:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.368.1">
public string ServerUrl
{
    get =&gt; Preferences.ContainsKey(ServerUrlKey) ?
</span><span class="koboSpan" id="kobo.368.2">                Preferences.Get(ServerUrlKey, ServerUrlDefault) :
                ServerUrlDefault;
    set =&gt; Preferences.Set(ServerUrlKey, value);
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.369.1">This code will get the server URL from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">Preferences</span></strong><span class="koboSpan" id="kobo.371.1"> store if it is present; if not, it will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">serverUrlDefault</span></strong><span class="koboSpan" id="kobo.373.1"> value. </span><span class="koboSpan" id="kobo.373.2">The property will store the new value in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">Preferences</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.375.1"> store.</span></span></p></li> <li><span class="koboSpan" id="kobo.376.1">Add the following </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">using</span></strong><span class="koboSpan" id="kobo.378.1"> declarations at the top of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">Settings.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.380.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.381.1">
using SticksAndStones.Models;
using System.Text.Json;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.382.1">This will enable us to use our model and the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">JsonSerializer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.384.1"> classes.</span></span></p></li> <li><span class="koboSpan" id="kobo.385.1">Create </span><a id="_idIndexMarker1010"/><span class="koboSpan" id="kobo.386.1">a new property named </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">LastPlayer</span></strong><span class="koboSpan" id="kobo.388.1"> that is of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">Player</span></strong><span class="koboSpan" id="kobo.390.1"> type, </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.392.1">
public Player LastPlayer
{
    get
    {
        if (Preferences.ContainsKey(LastPlayerKey))
        {
            var playerJson = Preferences.Get(LastPlayerKey, string.Empty);
            return JsonSerializer.Deserialize&lt;Player&gt;(playerJson, new JsonSerializerOptions(JsonSerializerDefaults.Web)) ?? </span><span class="koboSpan" id="kobo.392.2">new();
        }
        return new();
    }
    set =&gt; Preferences.Set(LastPlayerKey, JsonSerializer.Serialize(value, new JsonSerializerOptions(JsonSerializerDefaults.Web)));
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.393.1">Here, the property </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">set</span></strong><span class="koboSpan" id="kobo.395.1"> method will convert the </span><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">Player</span></strong><span class="koboSpan" id="kobo.397.1"> object to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.398.1">Json</span></strong><span class="koboSpan" id="kobo.399.1"> string </span><a id="_idIndexMarker1011"/><span class="koboSpan" id="kobo.400.1">before storing it in </span><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">Preferences</span></strong><span class="koboSpan" id="kobo.402.1"> and, when getting the property, if it exists in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.403.1">Preferences</span></strong><span class="koboSpan" id="kobo.404.1"> store, convert the stored </span><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">Json</span></strong><span class="koboSpan" id="kobo.406.1"> to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.407.1">Player</span></strong><span class="koboSpan" id="kobo.408.1"> object. </span><span class="koboSpan" id="kobo.408.2">If there is no value in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.409.1">Preferences</span></strong><span class="koboSpan" id="kobo.410.1"> store, then the </span><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">get</span></strong><span class="koboSpan" id="kobo.412.1"> method will return an empty </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">Player</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.414.1"> object.</span></span></p></li> <li><span class="koboSpan" id="kobo.415.1">The final step for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">Settings</span></strong><span class="koboSpan" id="kobo.417.1"> class is to register it with the dependency injection container. </span><span class="koboSpan" id="kobo.417.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">MauiProgram.cs</span></strong><span class="koboSpan" id="kobo.419.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.421.1"> project, then add the following highlighted code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.422.1">CreateMauiApp</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.423.1"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.424.1">
public static MauiApp CreateMauiApp()
{
    var builder = MauiApp.CreateBuilder();
    builder
        .UseMauiApp&lt;App&gt;()
        .ConfigureFonts(fonts =&gt;
        {
            fonts.AddFont("OpenSans-Regular.ttf", "OpenSansRegular");
            fonts.AddFont("OpenSans-Semibold.ttf", "OpenSansSemibold");
        });
#if DEBUG
        builder.Logging.AddDebug();
#endif
</span><strong class="bold"><span class="koboSpan" id="kobo.425.1">    builder.Services.AddSingleton&lt;Services.Settings&gt;();</span></strong><span class="koboSpan" id="kobo.426.1">
        return builder.Build();
    }</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.427.1">With </span><a id="_idIndexMarker1012"/><span class="koboSpan" id="kobo.428.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">Settings</span></strong><span class="koboSpan" id="kobo.430.1"> class complete, we can now focus on the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">ServiceConnection</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.432.1"> class.</span></span></p>
<h3><span class="koboSpan" id="kobo.433.1">Creating the ServiceConnection class</span></h3>
<p><span class="koboSpan" id="kobo.434.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.435.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.436.1"> class encapsulates the functionality needed to communicate with the Azure Functions service. </span><span class="koboSpan" id="kobo.436.2">It has methods to call the function methods and return the results, with appropriate error handling. </span><span class="koboSpan" id="kobo.436.3">It is also responsible for </span><a id="_idIndexMarker1013"/><span class="koboSpan" id="kobo.437.1">initializing the SignalR Hub instance that is used for real-time communication. </span><span class="koboSpan" id="kobo.437.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.438.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.439.1"> class has a couple of dependencies that we need, so let’s put them </span><span class="No-Break"><span class="koboSpan" id="kobo.440.1">together first.</span></span></p>
<p><span class="koboSpan" id="kobo.441.1">The first thing to add is logging. </span><span class="koboSpan" id="kobo.441.2">Having logging during debugging can be very helpful in figuring out problems, especially when dealing with asynchronous processes. </span><span class="koboSpan" id="kobo.441.3">Communicating with Azure Functions will have a lot of asynchronous operations. </span><span class="koboSpan" id="kobo.441.4">To enable logging while debugging, add the highlighted code to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">CreateMauiApp</span></strong><span class="koboSpan" id="kobo.443.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">MauiProgram</span></strong><span class="koboSpan" id="kobo.445.1"> class in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">SticksAndStones.App</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.447.1"> project:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.448.1">
#if DEBUG
        builder.Logging.AddDebug();       
</span><strong class="bold"><span class="koboSpan" id="kobo.449.1">        builder.Services.AddLogging(configure =&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.450.1">        {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.451.1">            configure.AddDebug();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.452.1">        });</span></strong><span class="koboSpan" id="kobo.453.1">
#endif
        builder.Services.AddSingleton&lt;Services.Settings&gt;();
        return builder.Build();</span></pre> <p><span class="koboSpan" id="kobo.454.1">This </span><a id="_idIndexMarker1014"/><span class="koboSpan" id="kobo.455.1">will add an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">ILoggingProvider</span></strong><span class="koboSpan" id="kobo.457.1"> to the services container. </span><span class="koboSpan" id="kobo.457.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.458.1">ILoggerProvider</span></strong><span class="koboSpan" id="kobo.459.1"> instance will provide instances of </span><strong class="source-inline"><span class="koboSpan" id="kobo.460.1">ILogger&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.461.1">. </span><span class="koboSpan" id="kobo.461.2">This will enable the use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.462.1">ILogger&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.463.1"> as a dependency in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">ServiceConnection</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.465.1">class constructor.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.466.1">More on logging providers</span></p>
<p class="callout"><span class="koboSpan" id="kobo.467.1">Read more </span><a id="_idIndexMarker1015"/><span class="koboSpan" id="kobo.468.1">about how logging providers work, and logging in general, </span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">at </span></span><a href="https://learn.microsoft.com/en-us/dotnet/core/extensions/logging-providers"><span class="No-Break"><span class="koboSpan" id="kobo.470.1">https://learn.microsoft.com/en-us/dotnet/core/extensions/logging-providers</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.471.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.472.1">Now, when making requests to APIs using HTTP, it is a common and good practice to use asynchronous calls so that you do not block the main or UI thread. </span><span class="koboSpan" id="kobo.472.2">All UI updates, such as animation, button clicks, taps on the screen, or text changes, happen on the UI thread. </span><span class="koboSpan" id="kobo.472.3">HTTP calls can take a non-trivial amount of time to complete, which can cause the app to become unresponsive to </span><span class="No-Break"><span class="koboSpan" id="kobo.473.1">a user.</span></span></p>
<p><span class="koboSpan" id="kobo.474.1">Error handling in asynchronous programming can be difficult. </span><span class="koboSpan" id="kobo.474.2">To help with errors when making API calls, we are going to use a couple of classes to encapsulate the exceptions; these classes are </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">AsyncError</span></strong><span class="koboSpan" id="kobo.476.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">AsyncExceptionError</span></strong><span class="koboSpan" id="kobo.478.1">. </span><span class="koboSpan" id="kobo.478.2">We need </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">AsyncError</span></strong><span class="koboSpan" id="kobo.480.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">AsyncExceptionError</span></strong><span class="koboSpan" id="kobo.482.1"> because it is a bad practice to serialize and deserialize any class instances that derive from </span><strong class="source-inline"><span class="koboSpan" id="kobo.483.1">System.Exception</span></strong><span class="koboSpan" id="kobo.484.1">. </span><span class="koboSpan" id="kobo.484.2">Not all classes derived from </span><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">System.Exception</span></strong><span class="koboSpan" id="kobo.486.1"> are serializable, and even if they are, you may not be able to deserialize them due to a missing type – for example, the type is available on the server but not on the client. </span><span class="koboSpan" id="kobo.486.2">Create a new file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">AsyncError.cs</span></strong><span class="koboSpan" id="kobo.488.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.490.1"> project and replace the contents with the </span><span class="No-Break"><span class="koboSpan" id="kobo.491.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.492.1">
using System.Text.Json.Serialization;
namespace SticksAndStones;
public record AsyncError
{
    [JsonPropertyName("message")]
    public string Message { get; set; }
}
public record AsyncExceptionError : AsyncError
{
    [JsonPropertyName("innerException")]
    public string InnerException { get; set; }
}</span></pre> <p><span class="koboSpan" id="kobo.493.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1">AsyncError</span></strong><span class="koboSpan" id="kobo.495.1"> class has a single property, </span><strong class="source-inline"><span class="koboSpan" id="kobo.496.1">Message</span></strong><span class="koboSpan" id="kobo.497.1">. </span><span class="koboSpan" id="kobo.497.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.498.1">Message</span></strong><span class="koboSpan" id="kobo.499.1"> property is decorated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">JsonPropertyName</span></strong><span class="koboSpan" id="kobo.501.1"> attribute so that it can be serialized if needed, using a lowercase version of the property name. </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">AsyncExceptionError</span></strong><span class="koboSpan" id="kobo.503.1"> inherits from </span><strong class="source-inline"><span class="koboSpan" id="kobo.504.1">AsyncError</span></strong><span class="koboSpan" id="kobo.505.1"> and adds an additional property, </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">InnerException</span></strong><span class="koboSpan" id="kobo.507.1">. </span><span class="koboSpan" id="kobo.507.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.508.1">InnerException</span></strong><span class="koboSpan" id="kobo.509.1"> property is also attributed </span><span class="No-Break"><span class="koboSpan" id="kobo.510.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.511.1">JsonPropertyName</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.513.1">The last class we will need is </span><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">AsyncLazy&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.515.1">. </span><span class="koboSpan" id="kobo.515.2">You may have already used </span><strong class="source-inline"><span class="koboSpan" id="kobo.516.1">Lazy&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.517.1"> in other </span><a id="_idIndexMarker1016"/><span class="koboSpan" id="kobo.518.1">applications you have written. </span><span class="koboSpan" id="kobo.518.2">It’s very handy when you want to delay the creation of a class until right before you need it. </span><span class="koboSpan" id="kobo.518.3">If you never need it, it doesn’t get created. </span><span class="koboSpan" id="kobo.518.4">But </span><strong class="source-inline"><span class="koboSpan" id="kobo.519.1">Lazy&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.520.1"> does not work great with asynchronous programming, so if you wanted to lazy instantiate a class that is created asynchronously, that becomes tedious. </span><span class="koboSpan" id="kobo.520.2">Luckily for us, Stephen Toub, who works for Microsoft on the .NET team, created </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">AsyncLazy&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.522.1">. </span><span class="koboSpan" id="kobo.522.2">To add it to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.524.1"> project, create a new file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">AsyncLazy~1.cs</span></strong><span class="koboSpan" id="kobo.526.1"> and replace the contents with </span><span class="No-Break"><span class="koboSpan" id="kobo.527.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.528.1">
using System.Runtime.CompilerServices;
namespace SticksAndStones;
// AsyncLazy&lt;T&gt;, Microsoft, Stephen Toub, .NET Parallel Programming Blog, https://devblogs.microsoft.com/pfxteam/asynclazyt/
public class AsyncLazy&lt;T&gt; : Lazy&lt;Task&lt;T&gt;&gt;
{
    public AsyncLazy(Func&lt;T&gt; valueFactory) :
        base(() =&gt; Task.Factory.StartNew(valueFactory))
    { }
    public AsyncLazy(Func&lt;Task&lt;T&gt;&gt; taskFactory) :
        base(() =&gt; Task.Factory.StartNew(() =&gt; taskFactory()).Unwrap())
    { }
    public TaskAwaiter&lt;T&gt; GetAwaiter() { return Value.GetAwaiter(); }
}</span></pre> <p class="callout-heading"><span class="koboSpan" id="kobo.529.1">Learn more about AsyncLazy&lt;T&gt;</span></p>
<p class="callout"><span class="koboSpan" id="kobo.530.1">Visit </span><a id="_idIndexMarker1017"/><span class="koboSpan" id="kobo.531.1">the .NET blog to learn more about how Stephen Toub created the </span><strong class="source-inline"><span class="koboSpan" id="kobo.532.1">AsyncLazy&lt;T&gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.533.1">class: </span></span><a href="https://devblogs.microsoft.com/pfxteam/asynclazyt/"><span class="No-Break"><span class="koboSpan" id="kobo.534.1">https://devblogs.microsoft.com/pfxteam/asynclazyt/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.535.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.536.1">That </span><a id="_idIndexMarker1018"/><span class="koboSpan" id="kobo.537.1">completes the changes needed to start implementing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.538.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.539.1"> class. </span><span class="koboSpan" id="kobo.539.2">To create the class, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.540.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.541.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.542.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.543.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.544.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.545.1"> project in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.546.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.547.1"> folder.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.548.1">Change the class to </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1">public sealed</span></strong><span class="koboSpan" id="kobo.550.1"> and inherit </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.552.1">IDisposable</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.553.1">:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.554.1">public sealed</span></strong><span class="koboSpan" id="kobo.555.1"> class ServiceConnection </span><strong class="bold"><span class="koboSpan" id="kobo.556.1">: IDisposable</span></strong></pre></li> <li><span class="koboSpan" id="kobo.557.1">Modify </span><a id="_idIndexMarker1019"/><span class="koboSpan" id="kobo.558.1">the namespace declarations at the top of the file to </span><span class="No-Break"><span class="koboSpan" id="kobo.559.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.560.1">
using Microsoft.AspNetCore.Http.Connections.Client;
using Microsoft.AspNetCore.SignalR.Client;
using Microsoft.Extensions.Logging;
using SticksAndStones.Models;
using System.Net;
using System.Net.Http.Json;
using System.Text.Json;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.561.1">These are needed to reference the types needed in the </span><span class="No-Break"><span class="koboSpan" id="kobo.562.1">following steps.</span></span></p></li> <li><span class="koboSpan" id="kobo.563.1">Add the following </span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">private</span></strong><span class="koboSpan" id="kobo.565.1"> fields to </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">the class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.567.1">
private readonly ILogger log;
private readonly HttpClient httpClient;
private readonly JsonSerializerOptions serializerOptions;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.568.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">serializerOptions</span></strong><span class="koboSpan" id="kobo.570.1"> is used to make sure the JSON that is sent and received from the Azure Functions functions can be serialized and </span><span class="No-Break"><span class="koboSpan" id="kobo.571.1">deserialized properly.</span></span></p></li> <li><span class="koboSpan" id="kobo.572.1">Now, add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">public</span></strong><span class="koboSpan" id="kobo.574.1"> property named </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">Hub</span></strong><span class="koboSpan" id="kobo.576.1">. </span><span class="koboSpan" id="kobo.576.2">The type for </span><strong class="source-inline"><span class="koboSpan" id="kobo.577.1">Hub</span></strong><span class="koboSpan" id="kobo.578.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.579.1">AsyncLazy&lt;HubConnection&gt;</span></strong><span class="koboSpan" id="kobo.580.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">HubConnection</span></strong><span class="koboSpan" id="kobo.582.1"> is the type from the SignalR client library that is used to receive messages from the SignalR service. </span><span class="koboSpan" id="kobo.582.2">The property should look like </span><span class="No-Break"><span class="koboSpan" id="kobo.583.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.584.1">
public AsyncLazy&lt;HubConnection&gt; Hub { get; private set; }</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">HubConnection</span></strong><span class="koboSpan" id="kobo.586.1"> is initialized in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">ConnectHub</span></strong><span class="koboSpan" id="kobo.588.1"> method. </span><span class="koboSpan" id="kobo.588.2">But first, let’s add </span><span class="No-Break"><span class="koboSpan" id="kobo.589.1">the constructor.</span></span></p></li> <li><span class="koboSpan" id="kobo.590.1">The </span><a id="_idIndexMarker1020"/><span class="koboSpan" id="kobo.591.1">constructor for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.593.1"> class has two </span><span class="No-Break"><span class="koboSpan" id="kobo.594.1">parameters: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">ILogger</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">
&lt;ServiceConnection&gt;</span></strong><span class="koboSpan" id="kobo.597.1"> and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.598.1">Settings</span></strong><span class="koboSpan" id="kobo.599.1"> parameter. </span><span class="koboSpan" id="kobo.599.2">In the body of the constructor, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">private</span></strong><span class="koboSpan" id="kobo.601.1"> fields created in </span><em class="italic"><span class="koboSpan" id="kobo.602.1">step 3</span></em><span class="koboSpan" id="kobo.603.1"> are initialized </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.605.1">
public ServiceConnection(ILogger&lt;ServiceConnection&gt; logger, Settings settings)
{
    httpClient = new()
    {
        BaseAddress = new Uri(settings.ServerUrl)
    };
    httpClient.DefaultRequestHeaders.Accept.Add(new("application/json"));
    serializerOptions = new JsonSerializerOptions(JsonSerializerDefaults.Web);
    log = logger;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.606.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.607.1">logger</span></strong><span class="koboSpan" id="kobo.608.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">settings</span></strong><span class="koboSpan" id="kobo.610.1"> parameters are provided by the .NET MAUI dependency injection service. </span><span class="koboSpan" id="kobo.610.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.611.1">httpClient</span></strong><span class="koboSpan" id="kobo.612.1"> field is initialized and it’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.613.1">BaseAddress</span></strong><span class="koboSpan" id="kobo.614.1"> is assigned the settings </span><strong class="source-inline"><span class="koboSpan" id="kobo.615.1">ServerUrl</span></strong><span class="koboSpan" id="kobo.616.1"> property as a URI. </span><span class="koboSpan" id="kobo.616.2">Then, </span><strong class="source-inline"><span class="koboSpan" id="kobo.617.1">DefaultHeaders</span></strong><span class="koboSpan" id="kobo.618.1"> is modified to indicate to the server that the results are expected to be in JSON format. </span><span class="koboSpan" id="kobo.618.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.619.1">serializerOptions</span></strong><span class="koboSpan" id="kobo.620.1"> instance is initialized to the defaults for </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">Web</span></strong><span class="koboSpan" id="kobo.622.1">, which is consistent with the formatting used by Azure Functions. </span><span class="koboSpan" id="kobo.622.2">Finally, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.623.1">log</span></strong><span class="koboSpan" id="kobo.624.1"> field is initialized with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.625.1">logger</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.626.1">parameter value.</span></span></p></li> <li><span class="koboSpan" id="kobo.627.1">Now, let’s implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">Dispose</span></strong><span class="koboSpan" id="kobo.629.1"> method. </span><span class="koboSpan" id="kobo.629.2">It will clean up any values that will potentially hold on to any native resources, such as networks, file handles, and so on. </span><span class="koboSpan" id="kobo.629.3">The two values that this class has references to that need to be disposed of are </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">httpClient</span></strong><span class="koboSpan" id="kobo.631.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.632.1">Hub</span></strong><span class="koboSpan" id="kobo.633.1">. </span><span class="koboSpan" id="kobo.633.2">Note that we will not have to call </span><strong class="source-inline"><span class="koboSpan" id="kobo.634.1">Dispose</span></strong><span class="koboSpan" id="kobo.635.1"> ourselves as the .NET MAUI dependency injection system will do that. </span><span class="koboSpan" id="kobo.635.2">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.636.1">ServiceConnection</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.637.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.638.1">
public void Dispose()
{
    httpClient?.Dispose();
    Hub?.Value?.Dispose();
    GC.SuppressFinalize(this);
}</span></pre></li> <li><span class="koboSpan" id="kobo.639.1">Now, add the class to dependency injection by adding the following highlighted line </span><a id="_idIndexMarker1021"/><span class="koboSpan" id="kobo.640.1">of code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.641.1">MauiProgram.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.642.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.643.1">
builder.Services.AddSingleton&lt;Services.Settings&gt;();
</span><strong class="bold"><span class="koboSpan" id="kobo.644.1">builder.Services.AddSingleton&lt;Services.ServiceConnection&gt;();</span></strong><span class="koboSpan" id="kobo.645.1">
return builder.Build();</span></pre></li> <li><span class="koboSpan" id="kobo.646.1">Initializing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.647.1">Hub</span></strong><span class="koboSpan" id="kobo.648.1"> property will happen in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.649.1">ConnectHub</span></strong><span class="koboSpan" id="kobo.650.1"> method. </span><span class="koboSpan" id="kobo.650.2">The configuration for the SignalR SignalR Hub connection is returned to the app in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.651.1">Connect</span></strong><span class="koboSpan" id="kobo.652.1"> function result. </span><span class="koboSpan" id="kobo.652.2">Since we haven’t and won’t make that call before this class is constructed, we can’t create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.653.1">Hub</span></strong><span class="koboSpan" id="kobo.654.1"> in the constructor. </span><span class="koboSpan" id="kobo.654.2">The configuration is needed before you can initialize the </span><strong class="source-inline"><span class="koboSpan" id="kobo.655.1">Hub</span></strong><span class="koboSpan" id="kobo.656.1"> instance. </span><span class="koboSpan" id="kobo.656.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.657.1">ConnectHub</span></strong><span class="koboSpan" id="kobo.658.1"> method has a single parameter of </span><strong class="source-inline"><span class="koboSpan" id="kobo.659.1">ConnectionInfo</span></strong><span class="koboSpan" id="kobo.660.1">. </span><span class="koboSpan" id="kobo.660.2">Add the method </span><a id="_idIndexMarker1022"/><span class="koboSpan" id="kobo.661.1">using the following </span><span class="No-Break"><span class="koboSpan" id="kobo.662.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.663.1">
public void ConnectHub(ConnectionInfo config)
{
    Hub = new(async () =&gt;
    {
        var connectionBuilder = new HubConnectionBuilder();
        connectionBuilder.WithUrl(config.Url, (HttpConnectionOptions obj) =&gt;
        {
            obj.AccessTokenProvider = async () =&gt; await Task.FromResult(config.AccessToken);
        });
        connectionBuilder.WithAutomaticReconnect();
        var hub = connectionBuilder.Build();
        await hub.StartAsync();
        return hub;
    });
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.664.1">This method initializes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.665.1">Hub</span></strong><span class="koboSpan" id="kobo.666.1"> property to a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">AsyncLazy&lt;HubConnection&gt;</span></strong><span class="koboSpan" id="kobo.668.1"> instance. </span><span class="koboSpan" id="kobo.668.2">The constructor for </span><strong class="source-inline"><span class="koboSpan" id="kobo.669.1">AsyncLazy&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.670.1"> takes </span><strong class="source-inline"><span class="koboSpan" id="kobo.671.1">Func&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.672.1">, which is provided using the anonymous method syntax. </span><span class="koboSpan" id="kobo.672.2">The anonymous method is also decorated as an </span><strong class="source-inline"><span class="koboSpan" id="kobo.673.1">async</span></strong><span class="koboSpan" id="kobo.674.1"> method, meaning that it will contain an awaited method call. </span><span class="koboSpan" id="kobo.674.2">The anonymous method takes no parameters and, in the body, starts by creating a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.675.1">HubConnectionBuilder</span></strong><span class="koboSpan" id="kobo.676.1">. </span><span class="koboSpan" id="kobo.676.2">Then, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.677.1">WithUrl</span></strong><span class="koboSpan" id="kobo.678.1"> extension method is called on </span><strong class="source-inline"><span class="koboSpan" id="kobo.679.1">HubConnectionBuilder</span></strong><span class="koboSpan" id="kobo.680.1"> to set the URL for the SignalR service and provide the </span><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">AccessToken</span></strong><span class="koboSpan" id="kobo.682.1"> value needed to make the connection. </span><strong class="source-inline"><span class="koboSpan" id="kobo.683.1">AccessTokenProvider</span></strong><span class="koboSpan" id="kobo.684.1"> is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.685.1">Task&lt;string&gt;</span></strong><span class="koboSpan" id="kobo.686.1"> so the </span><strong class="source-inline"><span class="koboSpan" id="kobo.687.1">config.AccessToken</span></strong><span class="koboSpan" id="kobo.688.1"> is provided through another </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">async</span></strong><span class="koboSpan" id="kobo.690.1"> anonymous function. </span><span class="koboSpan" id="kobo.690.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.691.1">WithAutomaticReconnect</span></strong><span class="koboSpan" id="kobo.692.1"> method sets </span><strong class="source-inline"><span class="koboSpan" id="kobo.693.1">HubConnection</span></strong><span class="koboSpan" id="kobo.694.1"> instance to automatically try reconnecting the SignalR service if the connection is lost. </span><span class="koboSpan" id="kobo.694.2">If </span><strong class="source-inline"><span class="koboSpan" id="kobo.695.1">WithAutomaticReconnect</span></strong><span class="koboSpan" id="kobo.696.1"> isn’t called, then the app is responsible for reconnecting if the connection is lost. </span><span class="koboSpan" id="kobo.696.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.697.1">HubConnection</span></strong><span class="koboSpan" id="kobo.698.1"> instance is created by calling </span><strong class="source-inline"><span class="koboSpan" id="kobo.699.1">HubConnectionBuilder.Build</span></strong><span class="koboSpan" id="kobo.700.1">. </span><span class="koboSpan" id="kobo.700.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.701.1">Hub</span></strong><span class="koboSpan" id="kobo.702.1"> instance is then started with </span><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">StartAsync</span></strong><span class="koboSpan" id="kobo.704.1">, which is awaited, and then the </span><strong class="source-inline"><span class="koboSpan" id="kobo.705.1">Hub</span></strong><span class="koboSpan" id="kobo.706.1"> is returned. </span><span class="koboSpan" id="kobo.706.2">The </span><a id="_idIndexMarker1023"/><span class="koboSpan" id="kobo.707.1">thing to remember here is that when </span><strong class="source-inline"><span class="koboSpan" id="kobo.708.1">ConnectHub</span></strong><span class="koboSpan" id="kobo.709.1"> is called, the anonymous function isn’t executed. </span><span class="koboSpan" id="kobo.709.2">The method won’t be called until the first time a property or method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.710.1">Hub</span></strong><span class="koboSpan" id="kobo.711.1"> property </span><span class="No-Break"><span class="koboSpan" id="kobo.712.1">is accessed.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.713.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.714.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.715.1"> class contains two helper functions that are used from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.716.1">GameService</span></strong><span class="koboSpan" id="kobo.717.1"> class to make HTTP requests to the Azure Functions service. </span><span class="koboSpan" id="kobo.717.2">The first, </span><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">GetAsync&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.719.1">, takes two parameters: a URL and a dictionary of query parameters to pass along with the URL. </span><span class="koboSpan" id="kobo.719.2">It returns an instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">T</span></strong><span class="koboSpan" id="kobo.721.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.722.1">AsyncError</span></strong><span class="koboSpan" id="kobo.723.1"> as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.724.1">Tuple</span></strong><span class="koboSpan" id="kobo.725.1">. </span><span class="koboSpan" id="kobo.725.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">GetAsync</span></strong><span class="koboSpan" id="kobo.727.1"> method will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.728.1">GET</span></strong><span class="koboSpan" id="kobo.729.1"> HTTP method when making the HTTP request. </span><span class="koboSpan" id="kobo.729.2">The other helper method, </span><strong class="source-inline"><span class="koboSpan" id="kobo.730.1">PostAsync&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.731.1">, uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.732.1">POST</span></strong><span class="koboSpan" id="kobo.733.1"> HTTP method and accepts two parameters: a URL, and an object to send in the body of the request formatted as JSON. </span><span class="koboSpan" id="kobo.733.2">It will return an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.734.1">T</span></strong><span class="koboSpan" id="kobo.735.1"> from </span><span class="No-Break"><span class="koboSpan" id="kobo.736.1">the response.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.737.1">The</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.738.1">GetAsync&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.739.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.740.1">PostAsync&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.741.1"> use a couple of helper methods; use the following code snippet to add them to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.742.1">ServiceConnection</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.743.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.744.1">
UriBuilder GetUriBuilder(Uri uri, Dictionary&lt;string, string&gt; parameters)
=&gt; new(uri)
{
    Query = string.Join("&amp;",
    parameters.Select(kvp =&gt;
            $"{kvp.Key}={kvp.Value}"))
};
async ValueTask&lt;AsyncError?&gt; GetError(HttpResponseMessage responseMessage, Stream content)
{
    AsyncError? </span><span class="koboSpan" id="kobo.744.2">error;
    if (responseMessage.StatusCode == HttpStatusCode.Unauthorized)
    {
        log.LogError("Unauthorized request {@Uri}", responseMessage.RequestMessage?.RequestUri);
        return new()
        {
            Message = "Unauthorized request."
</span><span class="koboSpan" id="kobo.744.3">        };
    }
    try
    {
        error = await JsonSerializer.DeserializeAsync&lt;AsyncError&gt;(content, serializerOptions);
    }
    catch (Exception e)
    {
        error = new AsyncExceptionError()
        {
            Message = e.Message,
            InnerException = e.InnerException?.Message,
        };
    }
    log.LogError("{@Error} {@Message} for {@Uri}", responseMessage.StatusCode, error?.Message, responseMessage?.RequestMessage?.RequestUri);
    return error;
}</span></pre> <p><span class="koboSpan" id="kobo.745.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.746.1">GetUriBuilder</span></strong><span class="koboSpan" id="kobo.747.1"> method will return a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.748.1">UriBuilder</span></strong><span class="koboSpan" id="kobo.749.1"> from the provided URL and </span><strong class="source-inline"><span class="koboSpan" id="kobo.750.1">Dictionary</span></strong><span class="koboSpan" id="kobo.751.1"> of key-value pairs to use in the query string. </span><span class="koboSpan" id="kobo.751.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.752.1">GetError</span></strong><span class="koboSpan" id="kobo.753.1"> method will return either an </span><strong class="source-inline"><span class="koboSpan" id="kobo.754.1">AsyncError</span></strong><span class="koboSpan" id="kobo.755.1"> object or </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">AsyncExceptionError</span></strong><span class="koboSpan" id="kobo.757.1"> object based </span><a id="_idIndexMarker1024"/><span class="koboSpan" id="kobo.758.1">on the status code or the contents of the response from the HTTP method call. </span></p>
<p><span class="koboSpan" id="kobo.759.1">Now, we can add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">GetAsync&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.761.1"> method to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.763.1"> class using the </span><span class="No-Break"><span class="koboSpan" id="kobo.764.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.765.1">
public async Task&lt;(T Result, AsyncError Exception)&gt; GetAsync&lt;T&gt;(Uri uri, Dictionary&lt;string, string&gt; parameters)
{
    var builder = GetUriBuilder(uri, parameters);
    var fullUri = builder.ToString();
    log.LogDebug("{@ObjectType} Get REST call @{RestUrl}", typeof(T).Name, fullUri);
    try
    {
        var responseMessage = await httpClient.GetAsync(fullUri);
        log.LogDebug("Response {@ResponseCode} for {@RestUrl}", responseMessage.StatusCode, fullUri);
        if (responseMessage.IsSuccessStatusCode)
        {
            try
            {
                var content = await responseMessage.Content.ReadFromJsonAsync&lt;T&gt;();
                log.LogDebug("Object of type {@ObjectType} parsed for {@RestUrl}", typeof(T).Name, fullUri);
                return (content, null);
            }
            catch (Exception e)
            {
                log.LogError("Error {@ErrorMessage} for when parsing ${ObjectType} for {@RestUrl}", e.Message, typeof(T).Name, fullUri);
                return (default, new AsyncExceptionError()
                {
                    InnerException = e.InnerException?.Message,
                    Message = e.Message
                });
            }
        }
        log.LogDebug("Returning error for @{RestUrl}", fullUri);
        return (default, await GetError(responseMessage, await responseMessage.Content.ReadAsStreamAsync()));
    }
    catch (Exception e)
    {
        log.LogError("Error {@ErrorMessage} for REST call ${ResUrl}", e.Message, fullUri);
        // The service might not be happy with us, we might have connection issues etc..
</span><span class="koboSpan" id="kobo.765.2">        return (default, new AsyncExceptionError()
        {
            InnerException = e.InnerException?.Message,
            Message = e.Message
        });
    }
}</span></pre> <p><span class="koboSpan" id="kobo.766.1">While this method is a little long, what it is doing is not all that complicated. </span><span class="koboSpan" id="kobo.766.2">First, it uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.767.1">GetUriBuilder</span></strong><span class="koboSpan" id="kobo.768.1"> method to create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.769.1">UriBuilder</span></strong><span class="koboSpan" id="kobo.770.1"> instance and build the </span><strong class="source-inline"><span class="koboSpan" id="kobo.771.1">fullUri</span></strong><span class="koboSpan" id="kobo.772.1"> string value from that. </span><span class="koboSpan" id="kobo.772.2">Then, it makes an HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.773.1">GET</span></strong><span class="koboSpan" id="kobo.774.1"> call using </span><strong class="source-inline"><span class="koboSpan" id="kobo.775.1">the HttpClient</span></strong><span class="koboSpan" id="kobo.776.1"> instance to the URL. </span><span class="koboSpan" id="kobo.776.2">If there is any failure, the exception handler will catch it and return an </span><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">AsynExceptionError</span></strong><span class="koboSpan" id="kobo.778.1">. </span><span class="koboSpan" id="kobo.778.2">If there are no errors in making the request and the response code indicates success, then the result is processed and returned. </span><span class="koboSpan" id="kobo.778.3">Otherwise, the result content is read for an error, and if it is found, it is returned. </span><span class="koboSpan" id="kobo.778.4">When the </span><strong class="source-inline"><span class="koboSpan" id="kobo.779.1">GetAsync&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.780.1"> method returns, it will always return two items: the response of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.781.1">T</span></strong><span class="koboSpan" id="kobo.782.1"> type and </span><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">AsyncError</span></strong><span class="koboSpan" id="kobo.784.1">. </span><span class="koboSpan" id="kobo.784.2">If either one of them isn’t present, then their default value is returned </span><span class="No-Break"><span class="koboSpan" id="kobo.785.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.786.1">null</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.787.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.788.1">Review </span><a id="_idIndexMarker1025"/><span class="koboSpan" id="kobo.789.1">and add the following code snippet to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.790.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.791.1"> class to implement the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.792.1">PostAsync&lt;T&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.793.1"> method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.794.1">
public async Task&lt;(T Result, AsyncError Exception)&gt; PostAsync&lt;T&gt;(Uri uri, object parameter)
{
    log.LogDebug("{@ObjectType} Post REST call @{RestUrl}", typeof(T).Name, uri);
    try
    {
        var responseMessage = await httpClient.PostAsJsonAsync(uri, parameter, serializerOptions);
        log.LogDebug("Response {@ResponseCode} for {@RestUrl}", responseMessage.StatusCode, uri);
        await using var content = await responseMessage.Content.ReadAsStreamAsync();
        if (responseMessage.IsSuccessStatusCode)
        {                
            if(string.IsNullOrEmpty(await.responseMessage.Content.ReadAsStringAsync()))
                return (default, null);
            try
            {
                log.LogDebug("Parse {@ObjectType} SUCCESS for {@RestUrl}", typeof(T).Name, uri);
                var result = await responseMessage.Content.ReadFromJsonAsync&lt;T&gt;();
                log.LogDebug("Object of type {@ObjectType} parsed for {@RestUrl}", typeof(T).Name, uri);
                return (result, null);
            }
            catch (Exception e)
            {
                log.LogError("Error {@ErrorMessage} for when parsing ${ObjectType} for {@RestUrl}", e.Message, typeof(T).Name, uri);
                return (default, new AsyncExceptionError()
                {
                    InnerException = e.InnerException?.Message,
                    Message = e.Message
                });
            }
        }
        log.LogDebug("Returning error for @{RestUrl}", uri);
        return (default, await GetError(responseMessage, content));
    }
    catch (Exception e)
    {
        log.LogError("Error {@ErrorMessage} for REST call ${ResUrl}", e.Message, uri);
        // The service might not be happy with us, we might have connection issues etc..
</span><span class="koboSpan" id="kobo.794.2">        return (default, new AsyncExceptionError()
        {
            InnerException = e.InnerException?.Message,
            Message = e.Message
        });
    }
}</span></pre> <p><span class="koboSpan" id="kobo.795.1">This </span><a id="_idIndexMarker1026"/><span class="koboSpan" id="kobo.796.1">method is mostly the same as </span><strong class="source-inline"><span class="koboSpan" id="kobo.797.1">GetAsync&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.798.1"> with a couple of minor changes. </span><span class="koboSpan" id="kobo.798.2">First, it does not need to call </span><strong class="source-inline"><span class="koboSpan" id="kobo.799.1">GetUriBuilder</span></strong><span class="koboSpan" id="kobo.800.1"> to add the parameters to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">Uri</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.802.1">QueryString</span></strong><span class="koboSpan" id="kobo.803.1">, as the parameters are sent as part of the request body. </span><span class="koboSpan" id="kobo.803.2">Second, it uses the HTTP </span><strong class="source-inline"><span class="koboSpan" id="kobo.804.1">POST</span></strong><span class="koboSpan" id="kobo.805.1"> method instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.806.1">GET</span></strong><span class="koboSpan" id="kobo.807.1">. </span><span class="koboSpan" id="kobo.807.2">With those changes, much of the method is error handling to make sure that we return the </span><span class="No-Break"><span class="koboSpan" id="kobo.808.1">right data.</span></span></p>
<p><span class="koboSpan" id="kobo.809.1">And that completes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.810.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.811.1"> class. </span><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.813.1"> and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">Settings</span></strong><span class="koboSpan" id="kobo.815.1"> service classes will be used in the next section, where we create the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.816.1">GameService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.817.1"> class.</span></span></p>
<h3><span class="koboSpan" id="kobo.818.1">Creating the GameService class</span></h3>
<p><span class="koboSpan" id="kobo.819.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.820.1">GameService</span></strong><span class="koboSpan" id="kobo.821.1"> class is a layer between the UI and the network. </span><span class="koboSpan" id="kobo.821.2">It uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.822.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.823.1"> class, which handles the specific network calls to create the logic </span><a id="_idIndexMarker1027"/><span class="koboSpan" id="kobo.824.1">we need to interact with the Azure Functions functions. </span><span class="koboSpan" id="kobo.824.2">For each of the functions that we created in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.825.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.826.1">, there is a corresponding method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.827.1">GameService</span></strong><span class="koboSpan" id="kobo.828.1"> class to make the call to the function and return the result, </span><span class="No-Break"><span class="koboSpan" id="kobo.829.1">if any.</span></span></p>
<p><span class="koboSpan" id="kobo.830.1">Follow these steps to create and initialize </span><span class="No-Break"><span class="koboSpan" id="kobo.831.1">the class:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.832.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.833.1">GameService</span></strong><span class="koboSpan" id="kobo.834.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.835.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.836.1"> project under the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.837.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.838.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.839.1">Change the class definition to </span><strong class="source-inline"><span class="koboSpan" id="kobo.840.1">public sealed</span></strong><span class="koboSpan" id="kobo.841.1"> and inherit from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.842.1">IDisposable</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.843.1"> interface:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.844.1">public sealed</span></strong><span class="koboSpan" id="kobo.845.1"> class GameService </span><strong class="bold"><span class="koboSpan" id="kobo.846.1">: IDisposable</span></strong></pre></li> <li><span class="koboSpan" id="kobo.847.1">Add </span><a id="_idIndexMarker1028"/><span class="koboSpan" id="kobo.848.1">the following namespace declarations to the top of </span><span class="No-Break"><span class="koboSpan" id="kobo.849.1">the file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.850.1">
using System.Collections.ObjectModel;
using CommunityToolkit.Mvvm.Messaging;
using Microsoft.AspNetCore.SignalR.Client;
using SticksAndStones.Messages;
using SticksAndStones.Models;</span></pre></li> <li><span class="koboSpan" id="kobo.851.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.852.1">GameService</span></strong><span class="koboSpan" id="kobo.853.1"> class will depend on both the </span><strong class="source-inline"><span class="koboSpan" id="kobo.854.1">Settings</span></strong><span class="koboSpan" id="kobo.855.1"> service and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.856.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.857.1"> service, so we need to add them to the constructor and store the references in class fields, as </span><span class="No-Break"><span class="koboSpan" id="kobo.858.1">shown here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.859.1">
private readonly ServiceConnection service;
private readonly Settings settings;
public GameService(Settings settings, ServiceConnection service)
{
    this.service = service;
    this.settings = settings;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.860.1">Add the preceding code snippet to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.861.1">GameService</span></strong><span class="koboSpan" id="kobo.862.1"> class. </span><span class="koboSpan" id="kobo.862.2">.NET MAUI will provide the </span><strong class="source-inline"><span class="koboSpan" id="kobo.863.1">Settings</span></strong><span class="koboSpan" id="kobo.864.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.865.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.866.1"> instances through </span><span class="No-Break"><span class="koboSpan" id="kobo.867.1">dependency injection.</span></span></p></li> <li><span class="koboSpan" id="kobo.868.1">Implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.869.1">IDisposable</span></strong><span class="koboSpan" id="kobo.870.1"> interface by adding the following method to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.871.1">GameService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.872.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.873.1">
public void Dispose()
{
    service.Dispose();
    GC.SuppressFinalize(this);
}</span></pre></li> <li><span class="koboSpan" id="kobo.874.1">Now, add </span><a id="_idIndexMarker1029"/><span class="koboSpan" id="kobo.875.1">the class to dependency injection by adding the following highlighted line of code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.876.1">MauiProgram.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.877.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.878.1">
#if DEBUG
            builder.Logging.AddDebug();
#endif
            builder.Services.AddSingleton&lt;Services.Settings&gt;();
           builder.Services.AddSingleton&lt;Services.ServiceConnection&gt;();
</span><strong class="bold"><span class="koboSpan" id="kobo.879.1">            builder.Services.AddSingleton&lt;Services.GameService&gt;();</span></strong><span class="koboSpan" id="kobo.880.1">
            return builder.Build();</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.881.1">We will start with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.882.1">Connect</span></strong><span class="koboSpan" id="kobo.883.1"> method. </span><strong class="source-inline"><span class="koboSpan" id="kobo.884.1">Connect</span></strong><span class="koboSpan" id="kobo.885.1"> will accept a </span><strong class="source-inline"><span class="koboSpan" id="kobo.886.1">Player</span></strong><span class="koboSpan" id="kobo.887.1"> object to connect as and return an updated </span><strong class="source-inline"><span class="koboSpan" id="kobo.888.1">Player</span></strong><span class="koboSpan" id="kobo.889.1"> object. </span><span class="koboSpan" id="kobo.889.2">Additionally, if the connection is successful, it will configure the SignalR Hub. </span><span class="koboSpan" id="kobo.889.3">To create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.890.1">Connect</span></strong><span class="koboSpan" id="kobo.891.1"> function, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.892.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.893.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.894.1">private</span></strong><span class="koboSpan" id="kobo.895.1"> field of </span><strong class="source-inline"><span class="koboSpan" id="kobo.896.1">SemaphoreSlim</span></strong><span class="koboSpan" id="kobo.897.1"> called </span><strong class="source-inline"><span class="koboSpan" id="kobo.898.1">semaphoreSlim</span></strong><span class="koboSpan" id="kobo.899.1"> and initialize the field with a new instance with an initial and maximum count </span><span class="No-Break"><span class="koboSpan" id="kobo.900.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.901.1">1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.902.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.903.1">
public sealed class GameService : IDisposable
{
</span><strong class="bold"><span class="koboSpan" id="kobo.904.1">    private readonly SemaphoreSlim semaphoreSlim = new(1, 1);</span></strong><span class="koboSpan" id="kobo.905.1">
    private readonly ServiceConnection service;</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.906.1">The SemaphoreSlim</span></strong><span class="koboSpan" id="kobo.907.1"> class is a great way to limit the number of threads performing an operation </span><a id="_idIndexMarker1030"/><span class="koboSpan" id="kobo.908.1">at a time. </span><span class="koboSpan" id="kobo.908.2">In our case, we only want one thread making the network calls at a time. </span><span class="koboSpan" id="kobo.908.3">It will be used in all the methods that make network calls from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.909.1">GameService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.910.1"> class.</span></span></p></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.911.1">GameService</span></strong><span class="koboSpan" id="kobo.912.1"> will track the current player in a </span><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">public</span></strong><span class="koboSpan" id="kobo.914.1"> property called </span><strong class="source-inline"><span class="koboSpan" id="kobo.915.1">CurrentPlayer</span></strong><span class="koboSpan" id="kobo.916.1">; add the property to the class using the </span><span class="No-Break"><span class="koboSpan" id="kobo.917.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.918.1">
private readonly Settings settings;
public Player CurrentPlayer { get; private set; } = new Player() { Id = Guid.Empty, GameId = Guid.Empty };</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.919.1">The property is initialized to an empty </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.920.1">Player</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.921.1"> object.</span></span></p></li> <li><span class="koboSpan" id="kobo.922.1">Once the user has connected as a player, we will also need somewhere to store the list of online players. </span><span class="koboSpan" id="kobo.922.2">To do that, add the following property to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.923.1">GameService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.924.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.925.1">
public ObservableCollection&lt;Player&gt; Players { get; } = new();</span></pre></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.926.1">The GameService</span></strong><span class="koboSpan" id="kobo.927.1"> class also tracks the current status of the connection in a property called </span><strong class="source-inline"><span class="koboSpan" id="kobo.928.1">IsConnected</span></strong><span class="koboSpan" id="kobo.929.1">; add the property using the following code snippet to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.930.1">GameService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.931.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.932.1">
public bool IsConnected { get; private set; }</span></pre></li> <li><span class="koboSpan" id="kobo.933.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.934.1">public async</span></strong><span class="koboSpan" id="kobo.935.1"> method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.936.1">Connect</span></strong><span class="koboSpan" id="kobo.937.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.938.1">GameService</span></strong><span class="koboSpan" id="kobo.939.1"> class. </span><span class="koboSpan" id="kobo.939.2">It should </span><a id="_idIndexMarker1031"/><span class="koboSpan" id="kobo.940.1">return </span><strong class="source-inline"><span class="koboSpan" id="kobo.941.1">Task&lt;Player&gt;</span></strong><span class="koboSpan" id="kobo.942.1"> and take a single </span><strong class="source-inline"><span class="koboSpan" id="kobo.943.1">Player</span></strong><span class="koboSpan" id="kobo.944.1"> as a parameter, </span><span class="No-Break"><span class="koboSpan" id="kobo.945.1">as shown:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.946.1">
public async Task&lt;Player&gt; Connect(Player player)
{
}</span></pre></li> <li><span class="koboSpan" id="kobo.947.1">Within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.948.1">Connect</span></strong><span class="koboSpan" id="kobo.949.1"> method, the first step is to make sure there is only one thread operating in the method at </span><span class="No-Break"><span class="koboSpan" id="kobo.950.1">a time:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.951.1">
await semaphoreSlim.WaitAsync();</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.952.1">This uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.953.1">async</span></strong><span class="koboSpan" id="kobo.954.1">/</span><strong class="source-inline"><span class="koboSpan" id="kobo.955.1">await</span></strong><span class="koboSpan" id="kobo.956.1"> structures in C# to create a lock that only releases when there are enough open slots in </span><strong class="source-inline"><span class="koboSpan" id="kobo.957.1">SemaphoreSlim</span></strong><span class="koboSpan" id="kobo.958.1">. </span><span class="koboSpan" id="kobo.958.2">Since </span><strong class="source-inline"><span class="koboSpan" id="kobo.959.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.960.1">SemaphoreSlim</span></strong><span class="koboSpan" id="kobo.961.1"> instance was only initialized with a single slot, only one thread can process the </span><strong class="source-inline"><span class="koboSpan" id="kobo.962.1">Connect</span></strong><span class="koboSpan" id="kobo.963.1"> method at </span><span class="No-Break"><span class="koboSpan" id="kobo.964.1">a time.</span></span></p></li> <li><span class="koboSpan" id="kobo.965.1">To make sure </span><strong class="source-inline"><span class="koboSpan" id="kobo.966.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.967.1">SemaphoreSlim</span></strong><span class="koboSpan" id="kobo.968.1"> instance releases the slot, we need to add exception handling around the rest of the method and call </span><strong class="source-inline"><span class="koboSpan" id="kobo.969.1">Release</span></strong><span class="koboSpan" id="kobo.970.1"> at the end. </span><span class="koboSpan" id="kobo.970.2">Add the following code snippet to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.971.1">Connect</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.972.1"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.973.1">
try
{
}
finally
{
    semaphoreSlim.Release();
}
return CurrentPlayer;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.974.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.975.1">try</span></strong><span class="koboSpan" id="kobo.976.1">/</span><strong class="source-inline"><span class="koboSpan" id="kobo.977.1">finally</span></strong><span class="koboSpan" id="kobo.978.1"> block ensures that we will always call </span><strong class="source-inline"><span class="koboSpan" id="kobo.979.1">Release</span></strong><span class="koboSpan" id="kobo.980.1"> at the conclusion </span><a id="_idIndexMarker1032"/><span class="koboSpan" id="kobo.981.1">of the method, which will prevent </span><strong class="source-inline"><span class="koboSpan" id="kobo.982.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.983.1">SemaphoreSlim</span></strong><span class="koboSpan" id="kobo.984.1"> instance from being starved, preventing any additional thread from entering the method. </span><span class="koboSpan" id="kobo.984.2">Lastly, we return the value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.985.1">CurrentPlayer</span></strong><span class="koboSpan" id="kobo.986.1">, which we will set next within the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.987.1">try</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.988.1"> block.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.989.1">There is another way to handle SemaphoreSlim</span></p>
<p class="callout"><span class="koboSpan" id="kobo.990.1">Using a </span><strong class="source-inline"><span class="koboSpan" id="kobo.991.1">try</span></strong><span class="koboSpan" id="kobo.992.1">/</span><strong class="source-inline"><span class="koboSpan" id="kobo.993.1">catch</span></strong><span class="koboSpan" id="kobo.994.1">/</span><strong class="source-inline"><span class="koboSpan" id="kobo.995.1">finally</span></strong><span class="koboSpan" id="kobo.996.1"> block works, but it is a little clunky if you handle all your exceptions properly, or don’t have any. </span><span class="koboSpan" id="kobo.996.2">Tom Dupont has published a helper class on his blog that </span><a id="_idIndexMarker1033"/><span class="koboSpan" id="kobo.997.1">allows you to use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.998.1">using</span></strong><span class="koboSpan" id="kobo.999.1"> statement to manage the lifetime of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1000.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1001.1">SemaphoreSlim</span></strong><span class="koboSpan" id="kobo.1002.1"> instance. </span><span class="koboSpan" id="kobo.1002.2">You can read his post at </span><a href="http://www.tomdupont.net/2016/03/how-to-release-semaphore-with-using.html"><span class="koboSpan" id="kobo.1003.1">http://www.tomdupont.net/2016/03/how-to-release-semaphore-with-using.html</span></a><span class="koboSpan" id="kobo.1004.1">. </span><span class="koboSpan" id="kobo.1004.2">Here is an example of using </span><span class="No-Break"><span class="koboSpan" id="kobo.1005.1">his extension:</span></span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.1006.1">using var handle = </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1007.1">semaphoreSlim.UseWaitAsync();</span></strong></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.1008.1">Within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1009.1">try</span></strong><span class="koboSpan" id="kobo.1010.1"> block, add the following lines </span><span class="No-Break"><span class="koboSpan" id="kobo.1011.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1012.1">
CurrentPlayer = player;
var (response, error) = await service.PostAsync&lt;ConnectResponse&gt;(new($"{settings.ServerUrl}/Connect"), new ConnectRequest(player));
if (error is null)
{
    service.ConnectHub(response.ConnectionInfo);
    response.Players.ForEach(Players.Add);
    CurrentPlayer = response.Player;
    IsConnected = true;
}
else
{
    WeakReferenceMessenger.Default.Send&lt;ServiceError&gt;(new(error));
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1013.1">This </span><a id="_idIndexMarker1034"/><span class="koboSpan" id="kobo.1014.1">block of code handles the call to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1015.1">Connect</span></strong><span class="koboSpan" id="kobo.1016.1"> function in the Azure Functions service. </span><span class="koboSpan" id="kobo.1016.2">We start by setting the passed-in player details as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1017.1">CurrentPlayer</span></strong><span class="koboSpan" id="kobo.1018.1"> property. </span><span class="koboSpan" id="kobo.1018.2">Then, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1019.1">the player</span></strong><span class="koboSpan" id="kobo.1020.1"> instance is packaged into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1021.1">ConnectRequest</span></strong><span class="koboSpan" id="kobo.1022.1"> object and we pass that into a call to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1023.1">PostAsync&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.1024.1"> on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1025.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.1026.1"> instance. </span><span class="koboSpan" id="kobo.1026.2">The URL is created from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1027.1">ServerUrl</span></strong><span class="koboSpan" id="kobo.1028.1"> property stored in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1029.1">Settings</span></strong><span class="koboSpan" id="kobo.1030.1"> service concatenated with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1031.1">/Connect</span></strong><span class="koboSpan" id="kobo.1032.1">. </span><span class="koboSpan" id="kobo.1032.2">The response is expected to be of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1033.1">ConnectResponse</span></strong><span class="koboSpan" id="kobo.1034.1"> type and we store that in response. </span><span class="koboSpan" id="kobo.1034.2">If we do not get any error, then we can call </span><strong class="source-inline"><span class="koboSpan" id="kobo.1035.1">ConnectHub</span></strong><span class="koboSpan" id="kobo.1036.1"> on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1037.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.1038.1"> instance, populate our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1039.1">Players</span></strong><span class="koboSpan" id="kobo.1040.1"> collection, and set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1041.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1042.1">CurrentPlayer</span></strong><span class="koboSpan" id="kobo.1043.1"> property to the returned </span><strong class="source-inline"><span class="koboSpan" id="kobo.1044.1">Player</span></strong><span class="koboSpan" id="kobo.1045.1"> instance, which will have additional details from the server. </span><span class="koboSpan" id="kobo.1045.2">If anything goes awry, then the error object will be populated, and we will send a message that contains that error to </span><span class="No-Break"><span class="koboSpan" id="kobo.1046.1">the UI.</span></span></p><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.1047.1">ServiceError</span></strong><span class="koboSpan" id="kobo.1048.1"> is the first message that we need to send to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1049.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1050.1"> instances from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1051.1">the GameService</span></strong><span class="koboSpan" id="kobo.1052.1"> class. </span><span class="koboSpan" id="kobo.1052.2">It is used to send errors from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1053.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1054.1">ServiceConnection </span></strong><span class="koboSpan" id="kobo.1055.1">instance to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1056.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1057.1"> instances. </span><span class="koboSpan" id="kobo.1057.2">We will add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1058.1">ServiceError</span></strong><span class="koboSpan" id="kobo.1059.1"> class in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1060.1">next steps.</span></span></p></li> </ol>
<ol>
<li value="1"><span class="koboSpan" id="kobo.1061.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1062.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.1063.1"> project, create a new folder </span><span class="No-Break"><span class="koboSpan" id="kobo.1064.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1065.1">Messages</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1066.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1067.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1068.1">ServiceError</span></strong><span class="koboSpan" id="kobo.1069.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1070.1">Messages</span></strong><span class="koboSpan" id="kobo.1071.1"> folder of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1072.1">SticksAndStones.App</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1073.1"> project.</span></span></li>
<li><span class="koboSpan" id="kobo.1074.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1075.1">ServiceError</span></strong><span class="koboSpan" id="kobo.1076.1"> message is a simple wrapper around the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1077.1">AyncError</span></strong><span class="koboSpan" id="kobo.1078.1"> object </span><a id="_idIndexMarker1035"/><span class="koboSpan" id="kobo.1079.1">that can be used to send a message back to a view model. </span><span class="koboSpan" id="kobo.1079.2">Replace the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1080.1">ServiceError.cs</span></strong><span class="koboSpan" id="kobo.1081.1"> file with </span><span class="No-Break"><span class="koboSpan" id="kobo.1082.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1083.1">
using CommunityToolkit.Mvvm.Messaging.Messages;
namespace SticksAndStones.Messages;
internal class ServiceError : ValueChangedMessage&lt;AsyncError&gt;
{
    public ServiceError(AsyncError error) : base(error)
    {
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.1084.1">Finally, since we are using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1085.1">SemaphoreSlim</span></strong><span class="koboSpan" id="kobo.1086.1"> and it can hold onto native resources, we should make sure that those are released properly. </span><span class="koboSpan" id="kobo.1086.2">Add the following highlighted code to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1087.1">Dispose</span></strong><span class="koboSpan" id="kobo.1088.1"> method to clean up the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1089.1">semaphoreSlim</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1090.1"> field:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1091.1">
public void Dispose()
{
</span><strong class="bold"><span class="koboSpan" id="kobo.1092.1">    semaphoreSlim.Release();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1093.1">    semaphoreSlim.Dispose();</span></strong><span class="koboSpan" id="kobo.1094.1">
    service.Dispose();
    GC.SuppressFinalize(this);
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1095.1">The concludes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1096.1">Connect</span></strong><span class="koboSpan" id="kobo.1097.1"> method for now. </span></p>
<p><span class="koboSpan" id="kobo.1098.1">The </span><a id="_idIndexMarker1036"/><span class="koboSpan" id="kobo.1099.1">next three methods are called from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1100.1">Lobby</span></strong><span class="koboSpan" id="kobo.1101.1"> page. </span><span class="koboSpan" id="kobo.1101.2">The first method is used to refresh the list of players. </span><span class="koboSpan" id="kobo.1101.3">It is called when the user pulls down the list causing a refresh, or if the SignalR Hub is reconnected. </span><span class="koboSpan" id="kobo.1101.4">To implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.1102.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1103.1">RefreshPlayerList</span></strong><span class="koboSpan" id="kobo.1104.1"> method, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1105.1">these steps:</span></span></p>
<ol>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1106.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1107.1">RefreshPlayerList</span></strong><span class="koboSpan" id="kobo.1108.1"> method takes no arguments and returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.1109.1">Task</span></strong><span class="koboSpan" id="kobo.1110.1">; add the method to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1111.1">GameService</span></strong><span class="koboSpan" id="kobo.1112.1"> class </span><span class="No-Break"><span class="koboSpan" id="kobo.1113.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1114.1">
public async Task RefreshPlayerList()
{
    await semaphoreSlim.WaitAsync();
    try
    {
        var getAllPlayers = service.GetAsync&lt;GetAllPlayersResponse&gt;(new($"{settings.ServerUrl}/Players/GetAll"), new Dictionary&lt;string, string&gt; { { "id", $"{CurrentPlayer.Id}" } });
        var (response, error) = await getAllPlayers;
        if (error is null)
        {
            Players.Clear();
            response.Players.ForEach(Players.Add);
        }
        else
        {      WeakReferenceMessenger.Default.Send&lt;ServiceError&gt;(new(error));
        }
    }
    finally
    {
        semaphoreSlim.Release();
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.1115.1">To refresh </span><a id="_idIndexMarker1037"/><span class="koboSpan" id="kobo.1116.1">the list of players when the SignalR Hub reconnects, add the following highlighted code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1117.1">Connect</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1118.1"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1119.1">
if (error is null)
{
    service.ConnectHub(response.ConnectionInfo);
    response.Players.ForEach(Players.Add);
    CurrentPlayer = response.Player;
    </span><strong class="bold"><span class="koboSpan" id="kobo.1120.1">(await service.Hub).Reconnected += (s) =&gt; { return RefreshPlayerList(); };</span></strong><span class="koboSpan" id="kobo.1121.1">
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1122.1">This line of code is interesting. </span><span class="koboSpan" id="kobo.1122.2">First, we await </span><strong class="source-inline"><span class="koboSpan" id="kobo.1123.1">service.Hub</span></strong><span class="koboSpan" id="kobo.1124.1">, then set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1125.1">Reconnected</span></strong><span class="koboSpan" id="kobo.1126.1"> event to an anonymous function that calls </span><strong class="source-inline"><span class="koboSpan" id="kobo.1127.1">RefreshPlayerList</span></strong><span class="koboSpan" id="kobo.1128.1">. </span><span class="koboSpan" id="kobo.1128.2">If you recall, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1129.1">Hub</span></strong><span class="koboSpan" id="kobo.1130.1"> property in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1131.1">ServiceConnection</span></strong><span class="koboSpan" id="kobo.1132.1"> class is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1133.1">AsyncLazy&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.1134.1">. </span><span class="koboSpan" id="kobo.1134.2">The first time we reference the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1135.1">Hub</span></strong><span class="koboSpan" id="kobo.1136.1"> property, it will initialize itself, asynchronously, hence the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1137.1">await</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1138.1"> call.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.1139.1">The next method that is used from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1140.1">Lobby</span></strong><span class="koboSpan" id="kobo.1141.1"> page is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1142.1">IssueChallenge</span></strong><span class="koboSpan" id="kobo.1143.1">. </span><span class="koboSpan" id="kobo.1143.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1144.1">IssueChallenge</span></strong><span class="koboSpan" id="kobo.1145.1"> method is called from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1146.1">Lobby</span></strong><span class="koboSpan" id="kobo.1147.1"> page when a player wishes to play a match against another player. </span><span class="koboSpan" id="kobo.1147.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1148.1">IssueChallenge</span></strong><span class="koboSpan" id="kobo.1149.1"> method does not return any </span><a id="_idIndexMarker1038"/><span class="koboSpan" id="kobo.1150.1">value since the actual response to the challenge will come back through the SignalR Hub. </span><span class="koboSpan" id="kobo.1150.2">The method will send the request to the server and handle any errors, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1151.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1152.1">
public async Task IssueChallenge(Player opponent)
{
    await semaphoreSlim.WaitAsync();
    try
    {
        var (response, error) = await service.PostAsync&lt;IssueChallengeResponse&gt;(new($"{settings.ServerUrl}/Challenge/Issue"), new IssueChallengeRequest(CurrentPlayer, opponent));
        if (error is not null)
        {         WeakReferenceMessenger.Default.Send&lt;ServiceError&gt;(new(error));
        }
    }
    finally
    {
        semaphoreSlim.Release();
    }
}</span></pre> <p><span class="koboSpan" id="kobo.1153.1">Add the preceding code to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1154.1">GameService</span></strong><span class="koboSpan" id="kobo.1155.1"> class. </span><span class="koboSpan" id="kobo.1155.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1156.1">SendChallengeResponse</span></strong><span class="koboSpan" id="kobo.1157.1"> method, which is called when the opposing player responds to a challenge, is very similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1158.1">IssueChallenge</span></strong><span class="koboSpan" id="kobo.1159.1"> method, </span><span class="No-Break"><span class="koboSpan" id="kobo.1160.1">as shown:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1161.1">
public async Task SendChallengeResponse(Guid challengeId, Models.ChallengeResponse challengeResponse)
{
    await semaphoreSlim.WaitAsync();
    try
    {
        var (response, error) = await service.PostAsync&lt;string&gt;(new($"{settings.ServerUrl}/Challenge/Ack"), new AcknowledgeChallengeRequest(challengeId, challengeResponse));
        if (error is not null)
        {         WeakReferenceMessenger.Default.Send&lt;ServiceError&gt;(new(error));
        }
    }
    finally
    {
        semaphoreSlim.Release();
    }
}</span></pre> <p><span class="koboSpan" id="kobo.1162.1">Add </span><a id="_idIndexMarker1039"/><span class="koboSpan" id="kobo.1163.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1164.1">SendChallengeResponse</span></strong><span class="koboSpan" id="kobo.1165.1"> method to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1166.1">GameService</span></strong><span class="koboSpan" id="kobo.1167.1"> class. </span><span class="koboSpan" id="kobo.1167.2">That completes the methods needed to support the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1168.1">Lobby</span></strong><span class="koboSpan" id="kobo.1169.1"> page. </span><span class="koboSpan" id="kobo.1169.2">The final page in our app is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1170.1">Game</span></strong><span class="koboSpan" id="kobo.1171.1"> page. </span><span class="koboSpan" id="kobo.1171.2">There are three more methods that are needed by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1172.1">Game</span></strong><span class="koboSpan" id="kobo.1173.1"> page. </span><span class="koboSpan" id="kobo.1173.2">Follow these steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.1174.1">add them:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1175.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1176.1">EndTurn</span></strong><span class="koboSpan" id="kobo.1177.1"> method, which will send the player’s move to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1178.1">Game</span></strong><span class="koboSpan" id="kobo.1179.1"> server, using the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1180.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1181.1">
public async Task&lt;(Game?, string?)&gt; EndTurn(Guid gameId, int position)
{
    await semaphoreSlim.WaitAsync();
    try
    {
        var (response, error) = await service.PostAsync&lt;ProcessTurnResponse&gt;(new($"{settings.ServerUrl}/Game/Move"), new ProcessTurnRequest(gameId, CurrentPlayer, position));
        if (error is not null)
        {
            return (null, error.Message);
        }
        else return (response.Game, null);
    }
    finally
    {
        semaphoreSlim.Release();
    }
}</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.1182.1">EndTurn</span></strong><span class="koboSpan" id="kobo.1183.1"> is very </span><a id="_idIndexMarker1040"/><span class="koboSpan" id="kobo.1184.1">similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1185.1">IssueChallenge</span></strong><span class="koboSpan" id="kobo.1186.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1187.1">SendChallengeResponse</span></strong><span class="koboSpan" id="kobo.1188.1"> methods, with a minor exception: it returns the updated </span><strong class="source-inline"><span class="koboSpan" id="kobo.1189.1">Game</span></strong><span class="koboSpan" id="kobo.1190.1"> object and an error message </span><span class="No-Break"><span class="koboSpan" id="kobo.1191.1">if present.</span></span></p></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.1192.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1193.1">GetPlayerId</span></strong><span class="koboSpan" id="kobo.1194.1"> method is a small helper function to search the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1195.1">Players</span></strong><span class="koboSpan" id="kobo.1196.1"> list and return the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1197.1">Player</span></strong><span class="koboSpan" id="kobo.1198.1"> instance that matches the ID passed in. </span><span class="koboSpan" id="kobo.1198.2">Use the following code snippet to add the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1199.1">GetPlayerById</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1200.1"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1201.1">
public Player? </span><span class="koboSpan" id="kobo.1201.2">GetPlayerById(Guid playerId)
{
    if (playerId == CurrentPlayer.Id)
        return CurrentPlayer;
    return (from p in Players where p.Id == playerId select p).FirstOrDefault();
}</span></pre></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.1202.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1203.1">GetMatchById</span></strong><span class="koboSpan" id="kobo.1204.1"> method is the last method that will make a call to the backend. </span><span class="koboSpan" id="kobo.1204.2">In this case, it will </span><a id="_idIndexMarker1041"/><span class="koboSpan" id="kobo.1205.1">retrieve a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1206.1">Match</span></strong><span class="koboSpan" id="kobo.1207.1"> object given an ID. </span><span class="koboSpan" id="kobo.1207.2">Using the following code snippet, add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1208.1">GetMatchById</span></strong><span class="koboSpan" id="kobo.1209.1"> to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1210.1">GameService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1211.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1212.1">
public async Task&lt;Match&gt; GetMatchById(Guid matchId)
{
    await semaphoreSlim.WaitAsync();
    try
    {
        var (response, error) = await service.GetAsync&lt;GetMatchResponse&gt;(new($"{settings.ServerUrl}/Match/{matchId}"), new());
        if (error != null) { }
        if (response.Match != null)
            return response.Match;
        return new Match();
    }
    finally
    {
        semaphoreSlim.Release();
    }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1213.1">The </span><a id="_idIndexMarker1042"/><span class="koboSpan" id="kobo.1214.1">final piece to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1215.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1216.1">GameService</span></strong><span class="koboSpan" id="kobo.1217.1"> class is the handling of the events received through the SignalR Hub. </span><span class="koboSpan" id="kobo.1217.2">To refresh our memory from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1218.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.1219.1">, the backend functions will send the following events to the clients </span><span class="No-Break"><span class="koboSpan" id="kobo.1220.1">via SignalR:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1221.1">PlayerUpdatedEventArgs</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1222.1">ChallengeEventArgs</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1223.1">GameStartedEventArgs</span></strong></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1224.1">GameUpdatedEventArgs</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1225.1">We will handle each of these events in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1226.1">GameService</span></strong><span class="koboSpan" id="kobo.1227.1"> method. </span><span class="koboSpan" id="kobo.1227.2">To implement the handlers for these events, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1228.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1229.1">When the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1230.1">Hub</span></strong><span class="koboSpan" id="kobo.1231.1"> receives </span><strong class="source-inline"><span class="koboSpan" id="kobo.1232.1">PlayerUpdatedEventArgs</span></strong><span class="koboSpan" id="kobo.1233.1">, we will need to update </span><strong class="source-inline"><span class="koboSpan" id="kobo.1234.1">Player</span></strong><span class="koboSpan" id="kobo.1235.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1236.1">Players</span></strong><span class="koboSpan" id="kobo.1237.1"> collection with the new values. </span><span class="koboSpan" id="kobo.1237.2">We will create a helper function to handle that work, </span><span class="No-Break"><span class="koboSpan" id="kobo.1238.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1239.1">
private void PlayerStatusChangedHandler(PlayerUpdatedEventArgs args)
{
    var changedPlayer = (from player in Players
                         where player.Id == args.Player.Id
                         select player).FirstOrDefault();
    if (changedPlayer is not null)
    {
        changedPlayer.MatchId = args.Player.MatchId;
    }
    else if (args.Player.Id != CurrentPlayer.Id)
    {
        Players.Add(args.Player);
    }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1240.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1241.1">PlayerStatusChangedHandler</span></strong><span class="koboSpan" id="kobo.1242.1"> method will locate the changed player </span><a id="_idIndexMarker1043"/><span class="koboSpan" id="kobo.1243.1">in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1244.1">Players</span></strong><span class="koboSpan" id="kobo.1245.1"> collection and update the relevant fields of the instance or add it if it </span><span class="No-Break"><span class="koboSpan" id="kobo.1246.1">doesn’t exist.</span></span></p></li> <li><span class="koboSpan" id="kobo.1247.1">To call </span><strong class="source-inline"><span class="koboSpan" id="kobo.1248.1">the</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1249.1">PlayerStatusUpdateHandler</span></strong><span class="koboSpan" id="kobo.1250.1"> class when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1251.1">PlayerUpdated</span></strong><span class="koboSpan" id="kobo.1252.1"> event is received, add the following highlighted code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1253.1">Connect</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1254.1"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1255.1">
if (error is null)
{
    service.ConnectHub(response.ConnectionInfo);
    response.Players.ForEach(Players.Add);
    CurrentPlayer = response.Player;
    IsConnected = true;
</span><strong class="bold"><span class="koboSpan" id="kobo.1256.1">    (await service.Hub).On&lt;PlayerUpdatedEventArgs&gt;(Constants.Events.PlayerUpdated, PlayerStatusChangedHandler);</span></strong><span class="koboSpan" id="kobo.1257.1">
    (await service.Hub).Reconnected += (s) =&gt; { return RefreshPlayerList(); };
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1258.1">The </span><a id="_idIndexMarker1044"/><span class="koboSpan" id="kobo.1259.1">other three events will send messages to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1260.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1261.1"> instance using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1262.1">WeakReferenceManager</span></strong><span class="koboSpan" id="kobo.1263.1">. </span><span class="koboSpan" id="kobo.1263.2">First, we need to add the message types, using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1264.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1265.1">Add a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1266.1">ChallengeReceived</span></strong><span class="koboSpan" id="kobo.1267.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1268.1">Messages</span></strong><span class="koboSpan" id="kobo.1269.1"> folder in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1270.1">SticksAndStones.App</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1271.1"> project.</span></span></li>
<li><span class="koboSpan" id="kobo.1272.1">Replace the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1273.1">ChallengeReceived.cs</span></strong><span class="koboSpan" id="kobo.1274.1"> file with </span><span class="No-Break"><span class="koboSpan" id="kobo.1275.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1276.1">
using CommunityToolkit.Mvvm.Messaging.Messages;
using SticksAndStones.Models;
namespace SticksAndStones.Messages;
public class ChallengeRecieved : ValueChangedMessage&lt;Player&gt;
{
    public Guid Id { get; init; }
    public ChallengeRecieved(Guid id, Player challenger) : base(challenger)
    {
        Id = id;
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.1277.1">Add a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1278.1">MatchStarted</span></strong><span class="koboSpan" id="kobo.1279.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1280.1">Messages</span></strong><span class="koboSpan" id="kobo.1281.1"> folder of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1282.1">SticksAndStones.App</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1283.1"> project.</span></span></li>
<li><span class="koboSpan" id="kobo.1284.1">Replace </span><a id="_idIndexMarker1045"/><span class="koboSpan" id="kobo.1285.1">the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1286.1">MatchStarted.cs</span></strong><span class="koboSpan" id="kobo.1287.1"> file with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1288.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1289.1">
using CommunityToolkit.Mvvm.Messaging.Messages;
using SticksAndStones.Models;
namespace SticksAndStones.Messages;
public class MatchStarted : ValueChangedMessage&lt;Match&gt;
{
    public MatchStarted(Match match) : base(match)
    {
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.1290.1">Add a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1291.1">MatchUpdated</span></strong><span class="koboSpan" id="kobo.1292.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1293.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.1294.1"> project in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1295.1">Messages</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1296.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.1297.1">Replace the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1298.1">MatchUpdated.cs</span></strong><span class="koboSpan" id="kobo.1299.1"> file with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1300.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1301.1">
using CommunityToolkit.Mvvm.Messaging.Messages;
using SticksAndStones.Models;
namespace SticksAndStones.Messages;
class MatchUpdated : ValueChangedMessage&lt;Match&gt;
{
    public MatchUpdated(Match match) : base(match)
    {
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.1302.1">To send </span><a id="_idIndexMarker1046"/><span class="koboSpan" id="kobo.1303.1">a message when the event is received, add the following highlighted code to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1304.1">Connect</span></strong><span class="koboSpan" id="kobo.1305.1"> method in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1306.1">GameService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1307.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1308.1">
service.ConnectHub(response.ConnectionInfo);
response.Players.ForEach(Players.Add);
CurrentPlayer = response.Player;
IsConnected = true;
(await service.Hub).On&lt;PlayerUpdatedEventArgs&gt;(Constants.Events.PlayerUpdated, PlayerStatusChangedHandler);
</span><strong class="bold"><span class="koboSpan" id="kobo.1309.1">(await service.Hub).On&lt;ChallengeEventArgs&gt;(Constants.Events.Challenge, (args) =&gt; WeakReferenceMessenger.Default.Send(new ChallengeRecieved(args.Id, args.Challenger)));</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1310.1">(await service.Hub).On&lt;MatchStartedEventArgs&gt;(Constants.Events.MatchStarted, (args) =&gt; WeakReferenceMessenger.Default.Send(new MatchStarted(args.Game)));</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1311.1">(await service.Hub).On&lt;MatchUpdatedEventArgs&gt;(Constants.Events.MatchUpdated, (args) =&gt; WeakReferenceMessenger.Default.Send(new MatchUpdated(args.Game)));</span></strong><span class="koboSpan" id="kobo.1312.1">
(await service.Hub).Reconnected += (s) =&gt; { return RefreshPlayerList(); };</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1313.1">That </span><a id="_idIndexMarker1047"/><span class="koboSpan" id="kobo.1314.1">concludes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1315.1">GameService</span></strong><span class="koboSpan" id="kobo.1316.1"> class. </span><span class="koboSpan" id="kobo.1316.2">We have all the methods needed to interact with the backend functions and we are handling the events that are being sent to the clients. </span><span class="koboSpan" id="kobo.1316.3">The next portion of the chapter will add the pages needed to present the </span><a id="_idTextAnchor885"/><a id="_idTextAnchor886"/><span class="koboSpan" id="kobo.1317.1">screens to the user, starting with the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1318.1">Connect</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1319.1"> page.</span></span></p>
<h2 id="_idParaDest-170"><a id="_idTextAnchor887"/><span class="koboSpan" id="kobo.1320.1">Creating the Connect page</span></h2>
<p><span class="koboSpan" id="kobo.1321.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.1322.1">Connect</span></strong><span class="koboSpan" id="kobo.1323.1"> page, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1324.1">Figure 10</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1325.1">.6</span></em><span class="koboSpan" id="kobo.1326.1">, is the first screen a user is presented with after </span><a id="_idIndexMarker1048"/><span class="koboSpan" id="kobo.1327.1">the app loads. </span><span class="koboSpan" id="kobo.1327.2">The page contains four main elements: an entry box for the player’s gamer tag, an entry box for the player’s email address, an image control for the player’s avatar, and the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1328.1">Connect</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1329.1"> button.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer171">
<span class="koboSpan" id="kobo.1330.1"><img alt="Figure 10.6 – The Connect page" src="image/B19214_10_6.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1331.1">Figure 10.6 – The Connect page</span></p>
<p><span class="koboSpan" id="kobo.1332.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.1333.1">Connect</span></strong><span class="koboSpan" id="kobo.1334.1"> page will consist of </span><span class="No-Break"><span class="koboSpan" id="kobo.1335.1">several parts:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1336.1">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.1337.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1338.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1339.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1340.1">ConnectViewModel.cs</span></strong></span></li>
<li><span class="koboSpan" id="kobo.1341.1">A XAML file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1342.1">ConnectView.xaml</span></strong><span class="koboSpan" id="kobo.1343.1">, which contains </span><span class="No-Break"><span class="koboSpan" id="kobo.1344.1">the layout</span></span></li>
<li><span class="koboSpan" id="kobo.1345.1">A code-behind file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1346.1">ConnectView.xaml.cs</span></strong><span class="koboSpan" id="kobo.1347.1">, which will carry out the </span><span class="No-Break"><span class="koboSpan" id="kobo.1348.1">data-binding process</span></span></li>
<li><span class="koboSpan" id="kobo.1349.1">A XAML file containing the layout for a custom button control, </span><span class="No-Break"><span class="koboSpan" id="kobo.1350.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1351.1">ActivityButton.xaml</span></strong></span></li>
<li><span class="koboSpan" id="kobo.1352.1">The code-behind for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1353.1">ActivityButton</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1354.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1355.1">ActivityButton.xaml.cs</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1356.1">We will </span><a id="_idIndexMarker1049"/><span class="koboSpan" id="kobo.1357.1">begin the implementation of the </span><strong class="bold"><span class="koboSpan" id="kobo.1358.1">Connect</span></strong><span class="koboSpan" id="kobo.1359.1"> page by implementing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1360.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1361.1"> first. </span></p>
<h3><span class="koboSpan" id="kobo.1362.1">Adding ConnectViewModel</span></h3>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1363.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1364.1"> – along with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1365.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.1366.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1367.1">GameView</span></strong><span class="koboSpan" id="kobo.1368.1"> model – will inherit </span><a id="_idIndexMarker1050"/><span class="koboSpan" id="kobo.1369.1">from a single base class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1370.1">ViewModelBase</span></strong><span class="koboSpan" id="kobo.1371.1">. </span><span class="koboSpan" id="kobo.1371.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1372.1">ViewModelBase</span></strong><span class="koboSpan" id="kobo.1373.1"> class provides the necessary functionality to implement refreshing the page. </span><span class="koboSpan" id="kobo.1373.2">Not all pages will use this feature, but it will be available. </span><span class="koboSpan" id="kobo.1373.3">To add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1374.1">ViewModelBase</span></strong><span class="koboSpan" id="kobo.1375.1">, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1376.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1377.1">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1378.1">ViewModels</span></strong><span class="koboSpan" id="kobo.1379.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1380.1">SticksAndStones.App</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1381.1"> project.</span></span></li>
<li><span class="koboSpan" id="kobo.1382.1">Add a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1383.1">ViewModelBase</span></strong><span class="koboSpan" id="kobo.1384.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1385.1">ViewModels</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1386.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.1387.1">Add the following namespace declarations at the top of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1388.1">ViewModelBase.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1389.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1390.1">
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;</span></pre></li> <li><span class="koboSpan" id="kobo.1391.1">Change the class declaration to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1392.1">public abstract partial</span></strong><span class="koboSpan" id="kobo.1393.1"> and derive the class </span><span class="No-Break"><span class="koboSpan" id="kobo.1394.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1395.1">ObservableRecipient</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1396.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1397.1">public abstract partial</span></strong><span class="koboSpan" id="kobo.1398.1"> class ViewModelBase </span><strong class="bold"><span class="koboSpan" id="kobo.1399.1">: ObservableRecipient</span></strong></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.1400.1">ObservableRecipient</span></strong><span class="koboSpan" id="kobo.1401.1"> comes from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1402.1">CommunityToolkit</span></strong><span class="koboSpan" id="kobo.1403.1">. </span><span class="koboSpan" id="kobo.1403.2">If you have worked through the other chapters in this book, you will have seen view models that derive from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1404.1">ObservableObject</span></strong><span class="koboSpan" id="kobo.1405.1">, which implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.1406.1">INotifyPropertyChanged</span></strong><span class="koboSpan" id="kobo.1407.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1408.1">ObservableRecipient</span></strong><span class="koboSpan" id="kobo.1409.1"> extends </span><strong class="source-inline"><span class="koboSpan" id="kobo.1410.1">ObservableObject</span></strong><span class="koboSpan" id="kobo.1411.1"> and adds built-in support for working with implementations of the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.1412.1">IMessage</span></strong><span class="koboSpan" id="kobo.1413.1"> interface. </span><span class="koboSpan" id="kobo.1413.2">To learn more about </span><strong class="source-inline"><span class="koboSpan" id="kobo.1414.1">ObservableRecipient</span></strong><span class="koboSpan" id="kobo.1415.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1416.1">visit </span></span><a href="https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/observablerecipient"><span class="No-Break"><span class="koboSpan" id="kobo.1417.1">https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/observablerecipient</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1418.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.1419.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1420.1">private bool</span></strong><span class="koboSpan" id="kobo.1421.1"> field named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1422.1">canRefresh</span></strong><span class="koboSpan" id="kobo.1423.1"> with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1424.1">ObservableProperty</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1425.1"> attribute:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1426.1">
[ObservableProperty]
private bool canRefresh;</span></pre></li> <li><span class="koboSpan" id="kobo.1427.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1428.1">private bool</span></strong><span class="koboSpan" id="kobo.1429.1"> field named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1430.1">isRefreshing</span></strong><span class="koboSpan" id="kobo.1431.1"> with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1432.1">ObservableProperty</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1433.1"> attribute:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1434.1">
[ObservableProperty]
private bool isRefreshing;</span></pre></li> <li><span class="koboSpan" id="kobo.1435.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1436.1">private</span></strong><span class="koboSpan" id="kobo.1437.1"> method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1438.1">CanExecuteRefresh</span></strong><span class="koboSpan" id="kobo.1439.1"> that takes no parameters </span><a id="_idIndexMarker1051"/><span class="koboSpan" id="kobo.1440.1">and returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1441.1">bool</span></strong><span class="koboSpan" id="kobo.1442.1">. </span><span class="koboSpan" id="kobo.1442.2">The method signature and implementation are in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1443.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1444.1">
private bool CanExecuteRefresh() =&gt; CanRefresh &amp;&amp; !IsRefreshing;</span></pre></li> <li><span class="koboSpan" id="kobo.1445.1">Add a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1446.1">protected virtual</span></strong><span class="koboSpan" id="kobo.1447.1"> method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1448.1">RefreshInternal</span></strong><span class="koboSpan" id="kobo.1449.1"> that returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1450.1">Task</span></strong><span class="koboSpan" id="kobo.1451.1"> and its implementation returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.1452.1">Task.CompletedTask</span></strong><span class="koboSpan" id="kobo.1453.1">, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1454.1">shown here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1455.1">
protected virtual Task RefreshInternal() =&gt; Task.CompletedTask;</span></pre></li> <li><span class="koboSpan" id="kobo.1456.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1457.1">Refresh</span></strong><span class="koboSpan" id="kobo.1458.1"> method as </span><span class="No-Break"><span class="koboSpan" id="kobo.1459.1">shown here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1460.1">
[RelayCommand(CanExecute = nameof(CanExecuteRefresh))]
public async Task Refresh()
{
    IsRefreshing = true;
    await RefreshInternal();
    IsRefreshing = false;
    return;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1461.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1462.1">Refresh</span></strong><span class="koboSpan" id="kobo.1463.1"> method is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1464.1">Command</span></strong><span class="koboSpan" id="kobo.1465.1">, meaning that it can be bound to XAML elements as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1466.1">RefreshCommand</span></strong><span class="koboSpan" id="kobo.1467.1">. </span><span class="koboSpan" id="kobo.1467.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1468.1">CanExecuteRefresh</span></strong><span class="koboSpan" id="kobo.1469.1"> method is used to determine </span><a id="_idIndexMarker1052"/><span class="koboSpan" id="kobo.1470.1">the enabled/disabled state for the command. </span><span class="koboSpan" id="kobo.1470.2">The command itself flips the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1471.1">IsRefreshing</span></strong><span class="koboSpan" id="kobo.1472.1"> Boolean and calls the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1473.1">RefreshInternal</span></strong><span class="koboSpan" id="kobo.1474.1"> method where classes derived from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1475.1">ViewModelBase</span></strong><span class="koboSpan" id="kobo.1476.1"> would put the </span><span class="No-Break"><span class="koboSpan" id="kobo.1477.1">specific implementation.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.1478.1">Now that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1479.1">ViewModelBase</span></strong><span class="koboSpan" id="kobo.1480.1"> has been implemented, we can implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.1481.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1482.1">. </span><span class="koboSpan" id="kobo.1482.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1483.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1484.1"> class has bindable properties for the player’s gamer tag and email address and various states for commands. </span><span class="koboSpan" id="kobo.1484.2">Finally, there is a command to establish a connection to the game services. </span><span class="koboSpan" id="kobo.1484.3">Let’s implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1485.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1486.1"> class by following </span><span class="No-Break"><span class="koboSpan" id="kobo.1487.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1488.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1489.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1490.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1491.1">ViewModels</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1492.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.1493.1">Alter the class definition to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1494.1">public partial</span></strong><span class="koboSpan" id="kobo.1495.1"> and derive from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1496.1">ViewModelBase</span></strong><span class="koboSpan" id="kobo.1497.1">, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1498.1">shown here:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1499.1">public partial</span></strong><span class="koboSpan" id="kobo.1500.1"> class ConnectViewModel : </span><strong class="bold"><span class="koboSpan" id="kobo.1501.1">ViewModelBase</span></strong><span class="koboSpan" id="kobo.1502.1">
{
}</span></pre></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.1503.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1504.1"> depends on </span><strong class="source-inline"><span class="koboSpan" id="kobo.1505.1">GameService</span></strong><span class="koboSpan" id="kobo.1506.1"> and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1507.1">Settings</span></strong><span class="koboSpan" id="kobo.1508.1"> service so let’s add a constructor to acquire them through dependency injection and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1509.1">private</span></strong><span class="koboSpan" id="kobo.1510.1"> fields to store their values, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1511.1">shown here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1512.1">
public partial class ConnectViewModel : ViewModelBase
{
    private readonly GameService gameService;
    private readonly Settings settings;
    public ConnectViewModel(GameService gameService, Settings settings)
    {
        this.gameService = gameService;
        this.settings = settings;
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.1513.1">To use </span><a id="_idIndexMarker1053"/><span class="koboSpan" id="kobo.1514.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1515.1">GameService</span></strong><span class="koboSpan" id="kobo.1516.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1517.1">Settings</span></strong><span class="koboSpan" id="kobo.1518.1"> classes, you’ll need to add a namespace declaration to the top of </span><span class="No-Break"><span class="koboSpan" id="kobo.1519.1">the file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1520.1">
using SticksAndStones.Services;</span></pre></li> <li><span class="koboSpan" id="kobo.1521.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1522.1">private string</span></strong><span class="koboSpan" id="kobo.1523.1"> field named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1524.1">gamerTag</span></strong><span class="koboSpan" id="kobo.1525.1"> attributed with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1526.1">ObservableProperty</span></strong><span class="koboSpan" id="kobo.1527.1"> to make it bindable, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1528.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1529.1">
[ObservableProperty]
private string gamerTag;</span></pre></li> <li><span class="koboSpan" id="kobo.1530.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1531.1">private string</span></strong><span class="koboSpan" id="kobo.1532.1"> field named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1533.1">emailAddress</span></strong><span class="koboSpan" id="kobo.1534.1"> attributed with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1535.1">ObservableProperty</span></strong><span class="koboSpan" id="kobo.1536.1"> to make it bindable, as shown in this </span><span class="No-Break"><span class="koboSpan" id="kobo.1537.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1538.1">
[ObservableProperty]
private string emailAddress;</span></pre></li> <li><span class="koboSpan" id="kobo.1539.1">In the </span><a id="_idIndexMarker1054"/><span class="koboSpan" id="kobo.1540.1">constructor for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1541.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1542.1">, initialize the bindable properties from the last time the user connected, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1543.1">following snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1544.1">
{
    this.gameService = gameService;
    this.settings = settings;
    // Load Player settings
    var player = settings.LastPlayer;
    Username = player.GamerTag;
    EmailAddress = player.EmailAddress;
}</span></pre></li> <li><span class="koboSpan" id="kobo.1545.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.1546.1">Connect</span></strong><span class="koboSpan" id="kobo.1547.1"> page does not need to refresh the view, so disable that functionality by adding the following line of code to the beginning of </span><span class="No-Break"><span class="koboSpan" id="kobo.1548.1">the constructor:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1549.1">
CanRefresh = false;</span></pre></li> <li><span class="koboSpan" id="kobo.1550.1">To implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1551.1">Connect</span></strong><span class="koboSpan" id="kobo.1552.1"> command, we will need four things: a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1553.1">string</span></strong><span class="koboSpan" id="kobo.1554.1"> indicating the status of the command, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1555.1">bool</span></strong><span class="koboSpan" id="kobo.1556.1"> to indicate the current state of the command, a method to return if the command is enabled, and the method for the command itself. </span><span class="koboSpan" id="kobo.1556.2">To add the status as a string, add the following code above the constructor in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1557.1">ConnectViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1558.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1559.1">
[ObservableProperty]
private string connectStatus;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1560.1">We mark this field with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1561.1">ObservableProperty</span></strong><span class="koboSpan" id="kobo.1562.1"> so that it is bindable into </span><span class="No-Break"><span class="koboSpan" id="kobo.1563.1">the view.</span></span></p></li> <li><span class="koboSpan" id="kobo.1564.1">To add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1565.1">isConnecting</span></strong><span class="koboSpan" id="kobo.1566.1"> field to track the state of the command, add the following code under the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1567.1">connectStatus</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1568.1"> field:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1569.1">
[ObservableProperty]
private bool isConnecting;</span></pre></li> <li><span class="koboSpan" id="kobo.1570.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1571.1">CanExecuteConnect</span></strong><span class="koboSpan" id="kobo.1572.1"> method will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.1573.1">true</span></strong><span class="koboSpan" id="kobo.1574.1"> if the command is enabled, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1575.1">false</span></strong><span class="koboSpan" id="kobo.1576.1"> if not. </span><span class="koboSpan" id="kobo.1576.2">Add the method using the following code snippet under the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1577.1">isConnecting</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1578.1"> field:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1579.1">
private bool CanExecuteConnect() =&gt; !string.IsNullOrEmpty(GamerTag) &amp;&amp; !string.IsNullOrEmpty(EmailAddress) &amp;&amp; !IsConnecting;</span></pre></li> <li><span class="koboSpan" id="kobo.1580.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1581.1">Connect</span></strong><span class="koboSpan" id="kobo.1582.1"> command will call a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1583.1">Connect</span></strong><span class="koboSpan" id="kobo.1584.1"> method to establish the connection </span><a id="_idIndexMarker1055"/><span class="koboSpan" id="kobo.1585.1">with the game server. </span><span class="koboSpan" id="kobo.1585.2">This is mostly just to keep the methods small and manageable. </span><span class="koboSpan" id="kobo.1585.3">Add the following private </span><strong class="source-inline"><span class="koboSpan" id="kobo.1586.1">Connect</span></strong><span class="koboSpan" id="kobo.1587.1"> method to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1588.1">ConnectViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1589.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1590.1">
private async Task&lt;Player&gt; Connect(Player player)
{
    // Get SignalR Connection
    var playerUpdate = await gameService.Connect(player);
    if (gameService.IsConnected)
    {
        // If the player has an in progress match, take them to it.
</span><span class="koboSpan" id="kobo.1590.2">        if (gameService.CurrentPlayer?.MatchId != Guid.Empty)
        {
            await Shell.Current.GoToAsync($"///Match", new Dictionary&lt;string, object&gt;() { { "MatchId", gameService.CurrentPlayer.MatchId } });
        }
        else
        {
            await Shell.Current.GoToAsync($"///Lobby");
        }
    }
    return playerUpdate;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1591.1">This method will call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1592.1">Connect</span></strong><span class="koboSpan" id="kobo.1593.1"> method on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1594.1">GameService</span></strong><span class="koboSpan" id="kobo.1595.1"> class passing </span><a id="_idIndexMarker1056"/><span class="koboSpan" id="kobo.1596.1">in the player details. </span><span class="koboSpan" id="kobo.1596.2">If the connection is successful, then the user is navigated to the Lobby page, unless they are currently in a game, in which case, they are navigated to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1597.1">Game page.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1598.1">Navigation in .NET MAUI Shell</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1599.1">In .NET MAUI, navigation </span><a id="_idIndexMarker1057"/><span class="koboSpan" id="kobo.1600.1">is performed by calling </span><strong class="source-inline"><span class="koboSpan" id="kobo.1601.1">GotoAsync</span></strong><span class="koboSpan" id="kobo.1602.1"> from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1603.1">Shell</span></strong><span class="koboSpan" id="kobo.1604.1"> object. </span><span class="koboSpan" id="kobo.1604.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1605.1">Shell</span></strong><span class="koboSpan" id="kobo.1606.1"> object can be obtained by either casting </span><strong class="source-inline"><span class="koboSpan" id="kobo.1607.1">App.Current.MainPage</span></strong><span class="koboSpan" id="kobo.1608.1"> to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1609.1">Shell</span></strong><span class="koboSpan" id="kobo.1610.1"> object, or by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1611.1">Shell.Current</span></strong><span class="koboSpan" id="kobo.1612.1"> property. </span><span class="koboSpan" id="kobo.1612.2">The route passed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1613.1">GotoAsync</span></strong><span class="koboSpan" id="kobo.1614.1"> can be either relative to the current location or absolute. </span><span class="koboSpan" id="kobo.1614.2">The valid forms of relative and absolute routes are </span><span class="No-Break"><span class="koboSpan" id="kobo.1615.1">as follows:</span></span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.1616.1">• route</span></strong><span class="koboSpan" id="kobo.1617.1"> – The route will be searched for upward from the current position and, if found,  pushed onto the </span><span class="No-Break"><span class="koboSpan" id="kobo.1618.1">navigation stack</span></span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.1619.1">• /route</span></strong><span class="koboSpan" id="kobo.1620.1"> – The route will be searched for downward from the current position and, if found, pushed onto the </span><span class="No-Break"><span class="koboSpan" id="kobo.1621.1">navigation stack</span></span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.1622.1">• //route</span></strong><span class="koboSpan" id="kobo.1623.1"> – The route will be searched for upward from the current position and, if found, will replace the </span><span class="No-Break"><span class="koboSpan" id="kobo.1624.1">navigation stack</span></span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.1625.1">• ///route</span></strong><span class="koboSpan" id="kobo.1626.1"> – The route will be searched for downward from the current position and, if found, will replace the </span><span class="No-Break"><span class="koboSpan" id="kobo.1627.1">navigation stack</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.1628.1">To learn more about routes and navigation, </span><span class="No-Break"><span class="koboSpan" id="kobo.1629.1">visit </span></span><a href="https://learn.microsoft.com/en-us/dotnet/maui/fundamentals/shell/navigation"><span class="No-Break"><span class="koboSpan" id="kobo.1630.1">https://learn.microsoft.com/en-us/dotnet/maui/fundamentals/shell/navigation</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1631.1">.</span></span></p>
<ol>
<li value="13"><span class="koboSpan" id="kobo.1632.1">Add the </span><a id="_idIndexMarker1058"/><span class="koboSpan" id="kobo.1633.1">method implementing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1634.1">Connect</span></strong><span class="koboSpan" id="kobo.1635.1"> command to the bottom of </span><span class="No-Break"><span class="koboSpan" id="kobo.1636.1">the </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1637.1">Connect</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.1638.1">
ViewModel</span></strong><span class="koboSpan" id="kobo.1639.1"> class using the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1640.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1641.1">
    [RelayCommand(CanExecute = nameof(CanExecuteConnect))]
    public async Task Connect()
    {
        IsConnecting = true;
        ConnectStatus = "Connecting...";
        var player = settings.LastPlayer;
        player.GamerTag = GamerTag;
        player.EmailAddress = EmailAddress;
        player.Id = (await Connect(player)).Id;
        settings.LastPlayer = player;
        ConnectStatus = "Connect";
        IsConnecting = false;
    }</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1642.1">The command is very straightforward. </span><span class="koboSpan" id="kobo.1642.2">It sets the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1643.1">IsConnecting</span></strong><span class="koboSpan" id="kobo.1644.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1645.1">ConnectStatus</span></strong><span class="koboSpan" id="kobo.1646.1"> properties, then updates the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1647.1">Player</span></strong><span class="koboSpan" id="kobo.1648.1"> values from the view. </span><span class="koboSpan" id="kobo.1648.2">Then, it calls </span><strong class="source-inline"><span class="koboSpan" id="kobo.1649.1">Connect</span></strong><span class="koboSpan" id="kobo.1650.1">, passing in the current </span><strong class="source-inline"><span class="koboSpan" id="kobo.1651.1">Player</span></strong><span class="koboSpan" id="kobo.1652.1"> instance. </span><span class="koboSpan" id="kobo.1652.2">The ID of the returned player is captured and set back on </span><strong class="source-inline"><span class="koboSpan" id="kobo.1653.1">LastPlayer</span></strong><span class="koboSpan" id="kobo.1654.1"> in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1655.1">Settings</span></strong><span class="koboSpan" id="kobo.1656.1">. </span><span class="koboSpan" id="kobo.1656.2">Finally, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1657.1">ConnectStatus</span></strong><span class="koboSpan" id="kobo.1658.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1659.1">IsConnecting</span></strong><span class="koboSpan" id="kobo.1660.1"> properties are set back to </span><span class="No-Break"><span class="koboSpan" id="kobo.1661.1">their defaults.</span></span></p></li> <li><span class="koboSpan" id="kobo.1662.1">To wrap </span><a id="_idIndexMarker1059"/><span class="koboSpan" id="kobo.1663.1">things up, we need to add a couple of attributes to make sure that properties are updated appropriately as values change. </span><span class="koboSpan" id="kobo.1663.2">For instance, when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1664.1">IsConnecting</span></strong><span class="koboSpan" id="kobo.1665.1"> property is changed, we need to ensure that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1666.1">CanExecuteConnect</span></strong><span class="koboSpan" id="kobo.1667.1"> method is evaluated again. </span><span class="koboSpan" id="kobo.1667.2">To do this, we add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1668.1">NotifyCanExecuteChangeFor</span></strong><span class="koboSpan" id="kobo.1669.1"> attribute to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1670.1">IsConnecting</span></strong><span class="koboSpan" id="kobo.1671.1"> field, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1672.1">shown here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1673.1">
[ObservableProperty]
</span><strong class="bold"><span class="koboSpan" id="kobo.1674.1">[NotifyCanExecuteChangedFor(nameof(ConnectCommand))]</span></strong><span class="koboSpan" id="kobo.1675.1">
private bool isConnecting;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1676.1">Since the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1677.1">gamerTag</span></strong><span class="koboSpan" id="kobo.1678.1"> field and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1679.1">emailAddress</span></strong><span class="koboSpan" id="kobo.1680.1"> field are also referenced in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1681.1">CanExecuteConnect</span></strong><span class="koboSpan" id="kobo.1682.1"> method, we should add the attribute to those fields as well, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1683.1">shown here:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1684.1">[ObservableProperty]
</span><strong class="bold"><span class="koboSpan" id="kobo.1685.1">[NotifyCanExecuteChangedFor(nameof(ConnectCommand))]</span></strong><span class="koboSpan" id="kobo.1686.1">
private string gamerTag;
[ObservableProperty]
</span><strong class="bold"><span class="koboSpan" id="kobo.1687.1">[NotifyCanExecuteChangedFor(nameof(ConnectCommand))]</span></strong><span class="koboSpan" id="kobo.1688.1">
private string emailAddress;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1689.1">We have </span><a id="_idIndexMarker1060"/><span class="koboSpan" id="kobo.1690.1">nearly completed </span><strong class="source-inline"><span class="koboSpan" id="kobo.1691.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1692.1">. </span><span class="koboSpan" id="kobo.1692.2">The final feature to implement is the handling of messages that we may receive from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1693.1">GameService</span></strong><span class="koboSpan" id="kobo.1694.1">. </span><span class="koboSpan" id="kobo.1694.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1695.1">ObservableObject</span></strong><span class="koboSpan" id="kobo.1696.1"> implementation from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1697.1">CommunityToolkit</span></strong><span class="koboSpan" id="kobo.1698.1"> provides a feature to make subscribing and unsubscribing to these messages clean. </span><span class="koboSpan" id="kobo.1698.2">To implement the message handlers, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1699.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1700.1">Add a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1701.1">private</span></strong><span class="koboSpan" id="kobo.1702.1"> method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1703.1">OnServiceError</span></strong><span class="koboSpan" id="kobo.1704.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1705.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1706.1"> class, using the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1707.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1708.1">
private void OnServiceError(AsyncError error)
{
    MainThread.BeginInvokeOnMainThread(async () =&gt;
    {
        await Shell.Current.CurrentPage.DisplayAlert("There is a problem...", error.Message, "Ok");
    });
}</span></pre></li> <li><span class="koboSpan" id="kobo.1709.1">We will subscribe to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1710.1">ServiceError</span></strong><span class="koboSpan" id="kobo.1711.1"> messages from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1712.1">OnActivated</span></strong><span class="koboSpan" id="kobo.1713.1"> event method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1714.1">ObservableObject</span></strong><span class="koboSpan" id="kobo.1715.1"> class, Add the following method to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1716.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1717.1"> class to subscribe to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1718.1">ServiceError</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1719.1"> message:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1720.1">
protected override void OnActivated() =&gt; Messenger.Register&lt;ServiceError&gt;(this, (r, m) =&gt; OnServiceError(m.Value));</span></pre></li> <li><span class="koboSpan" id="kobo.1721.1">To unsubscribe from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1722.1">ServiceError</span></strong><span class="koboSpan" id="kobo.1723.1"> messages, add the following method to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1724.1">ConnectViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1725.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1726.1">
protected override void OnDeactivated() =&gt; Messenger.Unregister&lt;ServiceError&gt;(this);</span></pre></li> <li><span class="koboSpan" id="kobo.1727.1">In the constructor for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1728.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1729.1">, we need to enable the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1730.1">OnActivated</span></strong><span class="koboSpan" id="kobo.1731.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1732.1">OnDeactivated</span></strong><span class="koboSpan" id="kobo.1733.1"> events that are raised by </span><strong class="source-inline"><span class="koboSpan" id="kobo.1734.1">ObservableObject</span></strong><span class="koboSpan" id="kobo.1735.1">. </span><span class="koboSpan" id="kobo.1735.2">These events are the recommended places to subscribe and unsubscribe to messages. </span><span class="koboSpan" id="kobo.1735.3">Add the following line of code to the end of the constructor to enable </span><span class="No-Break"><span class="koboSpan" id="kobo.1736.1">the events:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1737.1">
IsActive = true;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1738.1">Setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.1739.1">IsActive</span></strong><span class="koboSpan" id="kobo.1740.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1741.1">true</span></strong><span class="koboSpan" id="kobo.1742.1"> will cause the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1743.1">OnActivated</span></strong><span class="koboSpan" id="kobo.1744.1"> event to fire. </span><span class="koboSpan" id="kobo.1744.2">Setting it to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1745.1">false</span></strong><span class="koboSpan" id="kobo.1746.1"> will cause the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1747.1">OnDeactivated</span></strong><span class="koboSpan" id="kobo.1748.1"> event </span><span class="No-Break"><span class="koboSpan" id="kobo.1749.1">to fire.</span></span></p></li> <li><span class="koboSpan" id="kobo.1750.1">To have </span><a id="_idIndexMarker1061"/><span class="koboSpan" id="kobo.1751.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1752.1">OnDeactivated</span></strong><span class="koboSpan" id="kobo.1753.1"> event fire, we need to set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1754.1">IsActive</span></strong><span class="koboSpan" id="kobo.1755.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1756.1">false</span></strong><span class="koboSpan" id="kobo.1757.1">. </span><span class="koboSpan" id="kobo.1757.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1758.1">Connect</span></strong><span class="koboSpan" id="kobo.1759.1"> method, add the highlighted line </span><span class="No-Break"><span class="koboSpan" id="kobo.1760.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1761.1">
private async Task&lt;Player&gt; Connect(Player player)
{
    // Get SignalR Connection
    var playerUpdate = await gameService.Connect(player);
    if (gameService.IsConnected)
    {
</span><strong class="bold"><span class="koboSpan" id="kobo.1762.1">        IsActive = false;</span></strong><span class="koboSpan" id="kobo.1763.1">
        // If the player has an in progress match, take them to it.
</span><span class="koboSpan" id="kobo.1763.2">        if (gameService.CurrentPlayer?.MatchId != Guid.Empty)
        {
            await Shell.Current.GoToAsync($"///Match", new Dictionary&lt;string, object&gt;() { { "MatchId", gameService.CurrentPlayer.MatchId } });
        }
        else
        {
            await Shell.Current.GoToAsync($"///Lobby");
        }
    }
    return playerUpdate;
}</span></pre></li> <li><span class="koboSpan" id="kobo.1764.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1765.1">MauiProgram.cs</span></strong><span class="koboSpan" id="kobo.1766.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1767.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.1768.1"> project and </span><a id="_idIndexMarker1062"/><span class="koboSpan" id="kobo.1769.1">add the following highlighted line to register </span><strong class="source-inline"><span class="koboSpan" id="kobo.1770.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1771.1"> with </span><span class="No-Break"><span class="koboSpan" id="kobo.1772.1">dependency injection:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1773.1">
builder.Services.AddSingleton&lt;Services.GameService&gt;();
</span><strong class="bold"><span class="koboSpan" id="kobo.1774.1">builder.Services.AddTransient&lt;ViewModels.ConnectViewModel&gt;();</span></strong><span class="koboSpan" id="kobo.1775.1">
return builder.Build();</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1776.1">This concludes the implementation of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1777.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1778.1">. </span><span class="koboSpan" id="kobo.1778.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1779.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.1780.1"> class controls the entry of the user’s gamer tag and email. </span><span class="koboSpan" id="kobo.1780.2">It connects the user to the game server using their </span><span class="No-Break"><span class="koboSpan" id="kobo.1781.1">player details.</span></span></p>
<h3><span class="koboSpan" id="kobo.1782.1">Adding the Connect view</span></h3>
<p><span class="koboSpan" id="kobo.1783.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1784.1">Connect</span></strong><span class="koboSpan" id="kobo.1785.1"> view </span><a id="_idIndexMarker1063"/><span class="koboSpan" id="kobo.1786.1">looks fairly </span><a id="_idIndexMarker1064"/><span class="koboSpan" id="kobo.1787.1">simple, but there is a lot to it. </span><span class="koboSpan" id="kobo.1787.2">We will break down the creation of the view into three sections: </span></p>
<ul>
<li><span class="koboSpan" id="kobo.1788.1">Creating the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1789.1">ActivityButton</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1790.1"> control:</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1791.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1792.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.1793.1"> control is the button used to initiate a connection to the backend services. </span><span class="koboSpan" id="kobo.1793.2">While a simple button might do the trick, what if we had an animation that indicated the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1794.1">connect</span></strong><span class="koboSpan" id="kobo.1795.1"> operation was in progress and the text of the button updated as well? </span><span class="koboSpan" id="kobo.1795.2">That is what </span><strong class="source-inline"><span class="koboSpan" id="kobo.1796.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.1797.1"> will do, in a </span><span class="No-Break"><span class="koboSpan" id="kobo.1798.1">reusable control.</span></span></p></li>
<li><span class="koboSpan" id="kobo.1799.1">Creating </span><span class="No-Break"><span class="koboSpan" id="kobo.1800.1">the images:</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1801.1">There are a few images used on this page. </span><span class="koboSpan" id="kobo.1801.2">All of them were generated using AI. </span><span class="koboSpan" id="kobo.1801.3">We’ll explore how that </span><span class="No-Break"><span class="koboSpan" id="kobo.1802.1">was done.</span></span></p></li>
<li><span class="koboSpan" id="kobo.1803.1">Building </span><span class="No-Break"><span class="koboSpan" id="kobo.1804.1">the view:</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1805.1">This is where we bring </span><strong class="source-inline"><span class="koboSpan" id="kobo.1806.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.1807.1"> together with our custom images and the built-in controls of .NET MAUI to make </span><strong class="source-inline"><span class="koboSpan" id="kobo.1808.1">ConnectView</span></strong><span class="koboSpan" id="kobo.1809.1"> appear as it does in </span><span class="No-Break"><span class="koboSpan" id="kobo.1810.1">the figures.</span></span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.1811.1">Let’s start by building the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1812.1">ActivityButton</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1813.1"> control.</span></span></p>
<h4><span class="koboSpan" id="kobo.1814.1">Creating the ActivityButton control</span></h4>
<p><span class="koboSpan" id="kobo.1815.1">So, what </span><a id="_idIndexMarker1065"/><span class="koboSpan" id="kobo.1816.1">is this </span><strong class="source-inline"><span class="koboSpan" id="kobo.1817.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.1818.1"> control? </span><span class="koboSpan" id="kobo.1818.2">It’s basically a button with an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1819.1">ActivityIndicator</span></strong><span class="koboSpan" id="kobo.1820.1"> that will only show up while the task behind the button is doing its work. </span><span class="koboSpan" id="kobo.1820.2">The complexity of this control comes from the fact that we are making a general-purpose control instead of a specialized control. </span><span class="koboSpan" id="kobo.1820.3">So, for all intents and purposes, it needs to act like a normal </span><strong class="source-inline"><span class="koboSpan" id="kobo.1821.1">Button</span></strong><span class="koboSpan" id="kobo.1822.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1823.1">ActivityIndicator</span></strong><span class="koboSpan" id="kobo.1824.1">. </span><span class="koboSpan" id="kobo.1824.2">We are only going to implement the feature that we need for this application, but even then, it’s still a reusable control. </span></p>
<p><span class="koboSpan" id="kobo.1825.1">From </span><strong class="source-inline"><span class="koboSpan" id="kobo.1826.1">Button</span></strong><span class="koboSpan" id="kobo.1827.1">, we want to have the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1828.1">XAML attributes:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1829.1">Text</span></strong><span class="koboSpan" id="kobo.1830.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1831.1">FontFamily</span></strong><span class="koboSpan" id="kobo.1832.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1833.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1834.1">FontSize</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1835.1">Command</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1836.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1837.1">CommandParameter</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1838.1">From </span><strong class="source-inline"><span class="koboSpan" id="kobo.1839.1">ActivityIndicator</span></strong><span class="koboSpan" id="kobo.1840.1">, we will </span><span class="No-Break"><span class="koboSpan" id="kobo.1841.1">have </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1842.1">IsRunning</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1843.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1844.1">Each of these XAML elements will be bindable, like their original properties. </span><span class="koboSpan" id="kobo.1844.2">An example of what </span><a id="_idIndexMarker1066"/><span class="koboSpan" id="kobo.1845.1">the XAML might look like for declaring this control as an element would be </span><span class="No-Break"><span class="koboSpan" id="kobo.1846.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1847.1">
&lt;controls:ActivityButton IsRunning="{Binding IsConnecting}" 
                         Text="{Binding ConnectStatus}" 
                         BackgroundColor="#e8bc65" 
                         Command="{Binding ConnectCommand}" 
                         HorizontalOptions="Center"
                         WidthRequest="200"
                         HeightRequest="48"/&gt;</span></pre> <p><span class="koboSpan" id="kobo.1848.1">This listing comes from the actual XAML we will be creating for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1849.1">ConnectView.xaml</span></strong><span class="koboSpan" id="kobo.1850.1"> later in </span><span class="No-Break"><span class="koboSpan" id="kobo.1851.1">this section.</span></span></p>
<p><span class="koboSpan" id="kobo.1852.1">The attributes that are copied from the two underlying controls need to be able to bind to the view model. </span><span class="koboSpan" id="kobo.1852.2">This requires that they are implemented as bound properties. </span><span class="koboSpan" id="kobo.1852.3">To create a bound property, you need two things: a property and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1853.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1854.1"> that references the property. </span><span class="koboSpan" id="kobo.1854.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1855.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1856.1"> provides the functionality to keep the view model property, which implements </span><strong class="source-inline"><span class="koboSpan" id="kobo.1857.1">INotifyPropertyChanged</span></strong><span class="koboSpan" id="kobo.1858.1">, with the property of the control. </span><span class="koboSpan" id="kobo.1858.2">Let’s create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1859.1">Command</span></strong><span class="koboSpan" id="kobo.1860.1"> bindable property as </span><span class="No-Break"><span class="koboSpan" id="kobo.1861.1">an example:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1862.1">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1863.1">Controls</span></strong><span class="koboSpan" id="kobo.1864.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1865.1">SticksAndStones.App</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1866.1"> project.</span></span></li>
<li><span class="koboSpan" id="kobo.1867.1">Add a new .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.1868.1">ContentView</span></strong><span class="koboSpan" id="kobo.1869.1"> (XAML) </span><span class="No-Break"><span class="koboSpan" id="kobo.1870.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1871.1">ActivityButton</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1872.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1873.1">Open the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1874.1">ActivityButton.xaml.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1875.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.1876.1">Create a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1877.1">public ICommand</span></strong><span class="koboSpan" id="kobo.1878.1"> property named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1879.1">Command</span></strong><span class="koboSpan" id="kobo.1880.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1881.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1882.1">
public ICommand Command
{
    get =&gt; (ICommand)GetValue(CommandProperty);
    set { SetValue(CommandProperty, value); }
}</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.1883.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1884.1"> properties have a circular reference with the properties they are </span><a id="_idIndexMarker1067"/><span class="koboSpan" id="kobo.1885.1">bound to, so you will get red squigglies until we complete the next step. </span><span class="koboSpan" id="kobo.1885.2">This looks like almost every other property we have created, except that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1886.1">get</span></strong><span class="koboSpan" id="kobo.1887.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1888.1">set</span></strong><span class="koboSpan" id="kobo.1889.1"> methods are just delegating to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1890.1">GetValue</span></strong><span class="koboSpan" id="kobo.1891.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1892.1">SetValue</span></strong><span class="koboSpan" id="kobo.1893.1"> methods, respectively. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1894.1">GetValue</span></strong><span class="koboSpan" id="kobo.1895.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1896.1">SetValue</span></strong><span class="koboSpan" id="kobo.1897.1"> are provided by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1898.1">BindableObject</span></strong><span class="koboSpan" id="kobo.1899.1"> class, which </span><strong class="source-inline"><span class="koboSpan" id="kobo.1900.1">ContentView</span></strong><span class="koboSpan" id="kobo.1901.1"> ultimately inherits from. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1902.1">GetValue</span></strong><span class="koboSpan" id="kobo.1903.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1904.1">SetValue</span></strong><span class="koboSpan" id="kobo.1905.1"> are the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1906.1">BindableObject</span></strong><span class="koboSpan" id="kobo.1907.1"> equivalents to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1908.1">INotifyPropertyChanged</span></strong><span class="koboSpan" id="kobo.1909.1"> for view models. </span><span class="koboSpan" id="kobo.1909.2">Calling them not only stores the values but also sends notifications that the value </span><span class="No-Break"><span class="koboSpan" id="kobo.1910.1">has changed.</span></span></p></li> <li><span class="koboSpan" id="kobo.1911.1">Now, add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1912.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1913.1"> property for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1914.1">Command</span></strong><span class="koboSpan" id="kobo.1915.1"> property, using the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1916.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1917.1">
public static readonly BindableProperty CommandProperty = BindableProperty.Create(
    propertyName: nameof(Command),
    returnType: typeof(ICommand),
    declaringType: typeof(ActivityButton),
    defaultBindingMode: BindingMode.TwoWay);</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.1918.1">CommandProperty</span></strong><span class="koboSpan" id="kobo.1919.1"> is of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1920.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1921.1"> type and is created by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1922.1">Create</span></strong><span class="koboSpan" id="kobo.1923.1"> factory method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1924.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1925.1"> class. </span><span class="koboSpan" id="kobo.1925.2">We pass in the name of the property we are binding to (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1926.1">Command</span></strong><span class="koboSpan" id="kobo.1927.1">), the type that property returns (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1928.1">Icommand</span></strong><span class="koboSpan" id="kobo.1929.1">), the declaring type (which is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1930.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.1931.1"> in this case), and then what mode we want the binding to have. </span><span class="koboSpan" id="kobo.1931.2">There are four options </span><span class="No-Break"><span class="koboSpan" id="kobo.1932.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1933.1">BindingMode</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1934.1">:</span></span></p><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.1935.1">OneWay</span></strong><span class="koboSpan" id="kobo.1936.1"> – The default, propagates changes from the source (the view model) to the target (</span><span class="No-Break"><span class="koboSpan" id="kobo.1937.1">the control)</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1938.1">OneWayToSource</span></strong><span class="koboSpan" id="kobo.1939.1"> – This is the reverse of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1940.1">OneWay</span></strong><span class="koboSpan" id="kobo.1941.1">, propagating changes from the target (the control) to the source (the </span><span class="No-Break"><span class="koboSpan" id="kobo.1942.1">view model)</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1943.1">TwoWay</span></strong><span class="koboSpan" id="kobo.1944.1"> – This propagates changes in </span><span class="No-Break"><span class="koboSpan" id="kobo.1945.1">both directions</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1946.1">OneTime</span></strong><span class="koboSpan" id="kobo.1947.1"> – This propagates the changes only when </span><strong class="source-inline"><span class="koboSpan" id="kobo.1948.1">BindingContext</span></strong><span class="koboSpan" id="kobo.1949.1"> changes and all </span><strong class="source-inline"><span class="koboSpan" id="kobo.1950.1">INotifyPropertyChanged</span></strong><span class="koboSpan" id="kobo.1951.1"> events </span><span class="No-Break"><span class="koboSpan" id="kobo.1952.1">are ignored</span></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.1953.1">These two pieces – the normal property that you would use in most of your C# classes, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1954.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1955.1"> – provide the complete functionality we need to create the custom control. </span></p></li> </ol>
<p><span class="koboSpan" id="kobo.1956.1">Now that </span><a id="_idIndexMarker1068"/><span class="koboSpan" id="kobo.1957.1">we understand how to implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.1958.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1959.1"> on a XAML control, we can complete the implementation </span><span class="No-Break"><span class="koboSpan" id="kobo.1960.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1961.1">ActivityButton</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1962.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1963.1">Let’s start by updating the XAML and then we will follow that with the remaining </span><strong class="source-inline"><span class="koboSpan" id="kobo.1964.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1965.1"> implementations. </span><span class="koboSpan" id="kobo.1965.2">The following steps will walk you through creating </span><span class="No-Break"><span class="koboSpan" id="kobo.1966.1">the control:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1967.1">The template we chose to create the XAML and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1968.1">.cs</span></strong><span class="koboSpan" id="kobo.1969.1"> files is not quite what we need for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1970.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.1971.1">. </span><span class="koboSpan" id="kobo.1971.2">We will need to alter the underlying root control from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1972.1">ContentView</span></strong><span class="koboSpan" id="kobo.1973.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1974.1">Frame</span></strong><span class="koboSpan" id="kobo.1975.1">. </span><span class="koboSpan" id="kobo.1975.2">We use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1976.1">Frame</span></strong><span class="koboSpan" id="kobo.1977.1"> to wrap our layout with a border. </span><span class="koboSpan" id="kobo.1977.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1978.1">ActivityButton.cs</span></strong><span class="koboSpan" id="kobo.1979.1"> file and update the class definition to inherit from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1980.1">Frame</span></strong><span class="koboSpan" id="kobo.1981.1"> instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1982.1">ContentView</span></strong><span class="koboSpan" id="kobo.1983.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1984.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1985.1">
public partial class ActivityButton : </span><strong class="bold"><span class="koboSpan" id="kobo.1986.1">Frame</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1987.1">Now, open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1988.1">ActivityButton.xaml</span></strong><span class="koboSpan" id="kobo.1989.1"> file and modify it to look like </span><span class="No-Break"><span class="koboSpan" id="kobo.1990.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1991.1">
&lt;</span><strong class="bold"><span class="koboSpan" id="kobo.1992.1">Frame</span></strong><span class="koboSpan" id="kobo.1993.1">  
             
             x:Class="SticksAndStones.Controls.ActivityButton"&gt;
&lt;/</span><strong class="bold"><span class="koboSpan" id="kobo.1994.1">Frame</span></strong><span class="koboSpan" id="kobo.1995.1">&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1996.1">In addition to changing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1997.1">ContentView</span></strong><span class="koboSpan" id="kobo.1998.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1999.1">Frame</span></strong><span class="koboSpan" id="kobo.2000.1">, also remove the contents of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2001.1">Frame</span></strong><span class="koboSpan" id="kobo.2002.1"> as we won’t be </span><span class="No-Break"><span class="koboSpan" id="kobo.2003.1">reusing it.</span></span></p></li> <li><span class="koboSpan" id="kobo.2004.1">Let’s name our control to make it easier to reference it later. </span><span class="koboSpan" id="kobo.2004.2">Typically, in C#, if you want </span><a id="_idIndexMarker1069"/><span class="koboSpan" id="kobo.2005.1">to reference the instance of the class, you will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2006.1">this</span></strong><span class="koboSpan" id="kobo.2007.1"> keyword. </span><span class="koboSpan" id="kobo.2007.2">That doesn’t exist by default in XAML so add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2008.1">x:Name</span></strong><span class="koboSpan" id="kobo.2009.1"> attribute with the value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2010.1">this</span></strong><span class="koboSpan" id="kobo.2011.1"> to </span><span class="No-Break"><span class="koboSpan" id="kobo.2012.1">mimic C#.</span></span></li>
<li><span class="koboSpan" id="kobo.2013.1">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2014.1">Frame</span></strong><span class="koboSpan" id="kobo.2015.1"> element and add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2016.1">BackgroundColor</span></strong><span class="koboSpan" id="kobo.2017.1"> attribute with a value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2018.1">{x:StaticResource Primary}</span></strong><span class="koboSpan" id="kobo.2019.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2020.1">Primary</span></strong><span class="koboSpan" id="kobo.2021.1"> is defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2022.1">Resources/Styles/Colors.xaml</span></strong><span class="koboSpan" id="kobo.2023.1"> file and we can reference it using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2024.1">StaticResource</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2025.1">extension method.</span></span></li>
<li><span class="koboSpan" id="kobo.2026.1">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2027.1">Frame</span></strong><span class="koboSpan" id="kobo.2028.1"> element and add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2029.1">CornerRadius</span></strong><span class="koboSpan" id="kobo.2030.1"> attribute with a value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2031.1">5</span></strong><span class="koboSpan" id="kobo.2032.1">. </span><span class="koboSpan" id="kobo.2032.2">This will give our button </span><span class="No-Break"><span class="koboSpan" id="kobo.2033.1">rounded corners.</span></span></li>
<li><span class="koboSpan" id="kobo.2034.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2035.1">Padding</span></strong><span class="koboSpan" id="kobo.2036.1"> attribute with a value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2037.1">12</span></strong><span class="koboSpan" id="kobo.2038.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2039.1">Frame</span></strong><span class="koboSpan" id="kobo.2040.1"> element. </span><span class="koboSpan" id="kobo.2040.2">This will ensure that there is plenty of whitespace around the control. </span><span class="koboSpan" id="kobo.2040.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2041.1">Frame</span></strong><span class="koboSpan" id="kobo.2042.1"> element should now look like </span><span class="No-Break"><span class="koboSpan" id="kobo.2043.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2044.1">
&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;Frame 
             
             x:Class="SticksAndStones.Controls.ActivityButton"
        </span><strong class="bold"><span class="koboSpan" id="kobo.2045.1">x:Name="this"</span></strong><span class="koboSpan" id="kobo.2046.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.2047.1">BackgroundColor="{x:StaticResource Primary}"</span></strong><span class="koboSpan" id="kobo.2048.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.2049.1">CornerRadius="5"</span></strong><span class="koboSpan" id="kobo.2050.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.2051.1">Padding="12"</span></strong><span class="koboSpan" id="kobo.2052.1">&gt;
&lt;/Frame&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.2053.1">To get </span><strong class="source-inline"><span class="koboSpan" id="kobo.2054.1">ActivityIndicator</span></strong><span class="koboSpan" id="kobo.2055.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2056.1">Label</span></strong><span class="koboSpan" id="kobo.2057.1"> centered side by side within </span><strong class="source-inline"><span class="koboSpan" id="kobo.2058.1">Frame</span></strong><span class="koboSpan" id="kobo.2059.1">, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2060.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.2061.1"> contained in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2062.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.2063.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2064.1">StackLayout</span></strong><span class="koboSpan" id="kobo.2065.1"> controls ignore the alignment options </span><a id="_idIndexMarker1070"/><span class="koboSpan" id="kobo.2066.1">for the direction of the control, so, for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2067.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.2068.1"> ignores the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2069.1">VerticalOptions</span></strong><span class="koboSpan" id="kobo.2070.1"> property of its children and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2071.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.2072.1"> ignores the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2073.1">HorizontalOptions</span></strong><span class="koboSpan" id="kobo.2074.1"> property of its children. </span><span class="koboSpan" id="kobo.2074.2">This is because, by its nature, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2075.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.2076.1"> is in control of laying out its children in the horizontal plane, and the same is true for </span><strong class="source-inline"><span class="koboSpan" id="kobo.2077.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.2078.1">, except in the vertical plane. </span><span class="koboSpan" id="kobo.2078.2">Add the following highlighted code to </span><span class="No-Break"><span class="koboSpan" id="kobo.2079.1">the XAML:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2080.1">
&lt;Frame 
             
             x:Class="SticksAndStones.Controls.ActivityButton"
        BackgroundColor="{x:StaticResource Primary}"
        CornerRadius="5"
        Padding="12"&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.2081.1">    &lt;VerticalStackLayout&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2082.1">        &lt;HorizontalStackLayout HorizontalOptions="CenterAndExpand" Spacing="10"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2083.1">        &lt;/HorizontalStackLayout&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2084.1">    &lt;/VerticalStackLayout&gt;</span></strong><span class="koboSpan" id="kobo.2085.1">
&lt;/Frame&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.2086.1">Within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2087.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.2088.1"> element, add the </span><span class="No-Break"><span class="koboSpan" id="kobo.2089.1">following XAML:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2090.1">
&lt;ActivityIndicator HeightRequest="15" WidthRequest="15"
                   Color="{x:StaticResource White}" 
                   IsRunning="{Binding Source={x:Reference this},Path=IsRunning}"
                   IsVisible="{Binding Source={x:Reference this},Path=IsRunning}"
                   VerticalOptions="CenterAndExpand"/&gt;</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.2091.1">ActivityIndicator</span></strong><span class="koboSpan" id="kobo.2092.1"> will have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2093.1">Height</span></strong><span class="koboSpan" id="kobo.2094.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2095.1">Width</span></strong><span class="koboSpan" id="kobo.2096.1"> value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2097.1">15</span></strong><span class="koboSpan" id="kobo.2098.1"> and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2099.1">Color</span></strong><span class="koboSpan" id="kobo.2100.1"> value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2101.1">White</span></strong><span class="koboSpan" id="kobo.2102.1">. </span><span class="koboSpan" id="kobo.2102.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2103.1">IsRunning</span></strong><span class="koboSpan" id="kobo.2104.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2105.1">IsVisible</span></strong><span class="koboSpan" id="kobo.2106.1"> properties are bound to </span><a id="_idIndexMarker1071"/><span class="koboSpan" id="kobo.2107.1">the control’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.2108.1">IsRunning</span></strong><span class="koboSpan" id="kobo.2109.1"> property. </span><span class="koboSpan" id="kobo.2109.2">We haven’t created the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2110.1">IsRunning</span></strong><span class="koboSpan" id="kobo.2111.1"> property yet, so this won’t work until we do. </span><span class="koboSpan" id="kobo.2111.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2112.1">x:Reference</span></strong><span class="koboSpan" id="kobo.2113.1"> markup extension allows us to bind the property to the parent control, which we named </span><strong class="source-inline"><span class="koboSpan" id="kobo.2114.1">this</span></strong><span class="koboSpan" id="kobo.2115.1"> in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2116.1">step 3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2117.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.2118.1">Now, we can add </span><strong class="source-inline"><span class="koboSpan" id="kobo.2119.1">Label</span></strong><span class="koboSpan" id="kobo.2120.1"> within </span><strong class="source-inline"><span class="koboSpan" id="kobo.2121.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.2122.1"> using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2123.1">following XAML:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2124.1">
&lt;Label x:Name="buttonLabel" TextColor="{x:StaticResource White}" 
       Text="{Binding Source={x:Reference this},Path=Text}" 
       FontSize="15"
       VerticalOptions="CenterAndExpand"
       VerticalTextAlignment="Center" 
       HorizontalTextAlignment="Start" /&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.2125.1">When the </span><a id="_idIndexMarker1072"/><span class="koboSpan" id="kobo.2126.1">user taps or clicks anywhere in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2127.1">Frame</span></strong><span class="koboSpan" id="kobo.2128.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2129.1">Command</span></strong><span class="koboSpan" id="kobo.2130.1"> should be run. </span><span class="koboSpan" id="kobo.2130.2">To configure that, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2131.1">GestureRecognizer</span></strong><span class="koboSpan" id="kobo.2132.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2133.1">GestureRecognizer</span></strong><span class="koboSpan" id="kobo.2134.1"> is XAML’s way of providing event handlers. </span><span class="koboSpan" id="kobo.2134.2">There are several different kinds </span><span class="No-Break"><span class="koboSpan" id="kobo.2135.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2136.1">GestureRecognizer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2137.1">:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.2138.1">DragGestureRecognizer</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2139.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2140.1">DropGestureRecognizer</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2141.1">PanGestureRecognizer</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2142.1">PinchGestureRecognizer</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2143.1">PointerGestureRecognizer</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2144.1">SwipeGestureRecognizer</span></strong></span></li><li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2145.1">TapGestureRecognizer</span></strong></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.2146.1">For </span><strong class="source-inline"><span class="koboSpan" id="kobo.2147.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.2148.1">, we are interested in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2149.1">TapGestureRecognizer</span></strong><span class="koboSpan" id="kobo.2150.1">. </span><span class="koboSpan" id="kobo.2150.2">Since the action to take is undefined until this control is used on a view, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2151.1">TapGestureRecognizer</span></strong><span class="koboSpan" id="kobo.2152.1"> will invoke a command when </span><strong class="source-inline"><span class="koboSpan" id="kobo.2153.1">Frame</span></strong><span class="koboSpan" id="kobo.2154.1"> is tapped. </span><span class="koboSpan" id="kobo.2154.2">Add the following XAML to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2155.1">Frame</span></strong><span class="koboSpan" id="kobo.2156.1"> element to </span><span class="No-Break"><span class="koboSpan" id="kobo.2157.1">create </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2158.1">TapGestureRecognizer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2159.1">:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2160.1">
&lt;Frame.GestureRecognizers&gt;
    &lt;TapGestureRecognizer Command="{Binding Source={x:Reference this},Path=Command}" CommandParameter="{Binding Source={x:Reference this},Path=CommandParameter}" /&gt;
&lt;/Frame.GestureRecognizers&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2161.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2162.1">Command</span></strong><span class="koboSpan" id="kobo.2163.1"> attribute and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2164.1">CommandParameter</span></strong><span class="koboSpan" id="kobo.2165.1"> attribute of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2166.1">TapGestureRecognizer</span></strong><span class="koboSpan" id="kobo.2167.1"> are set to bind to the parent controls’ </span><strong class="source-inline"><span class="koboSpan" id="kobo.2168.1">Command</span></strong><span class="koboSpan" id="kobo.2169.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2170.1">CommandParameter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2171.1"> properties.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.2172.1">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2173.1">IsRunning</span></strong><span class="koboSpan" id="kobo.2174.1"> property is </span><strong class="source-inline"><span class="koboSpan" id="kobo.2175.1">true</span></strong><span class="koboSpan" id="kobo.2176.1">, then </span><strong class="source-inline"><span class="koboSpan" id="kobo.2177.1">Frame</span></strong><span class="koboSpan" id="kobo.2178.1"> should be disabled, and the reverse is true as well. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2179.1">DataTrigger</span></strong><span class="koboSpan" id="kobo.2180.1"> is a XAML way of setting properties of one control </span><a id="_idIndexMarker1073"/><span class="koboSpan" id="kobo.2181.1">based on changes in another control’s properties. </span><span class="koboSpan" id="kobo.2181.2">To add the triggers for </span><strong class="source-inline"><span class="koboSpan" id="kobo.2182.1">Frame</span></strong><span class="koboSpan" id="kobo.2183.1">, add the highlighted XAML to </span><span class="No-Break"><span class="koboSpan" id="kobo.2184.1">the control:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2185.1">&lt;Frame.Triggers&gt;
    &lt;DataTrigger TargetType="Frame" Binding="{Binding Source={x:Reference this},Path=IsBusy}" Value="True"&gt;
        &lt;Setter Property="IsEnabled" Value="False" /&gt;
    &lt;/DataTrigger&gt;
    &lt;DataTrigger TargetType="Frame" Binding="{Binding Source={x:Reference this},Path=IsBusy}" Value="False"&gt;
        &lt;Setter Property="IsEnabled" Value="True" /&gt;
    &lt;/DataTrigger&gt;
&lt;/Frame.Triggers&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.2186.1">That concludes the XAML portion of the control. </span><span class="koboSpan" id="kobo.2186.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2187.1">ActivityButton.xaml.cs</span></strong><span class="koboSpan" id="kobo.2188.1"> file and we can add the missing properties, starting </span><span class="No-Break"><span class="koboSpan" id="kobo.2189.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2190.1">CommandParameter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2191.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2192.1">
public static readonly BindableProperty CommandParameterProperty = BindableProperty.Create(
    propertyName: nameof(CommandParameter),
    returnType: typeof(object),
    declaringType: typeof(ActivityButton),
    defaultBindingMode: BindingMode.TwoWay);
public object CommandParameter
{
    get =&gt; GetValue(CommandParameterProperty);
    set { SetValue(CommandParameterProperty, value); }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2193.1">Add the previous code listing to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2194.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.2195.1"> class. </span><span class="koboSpan" id="kobo.2195.2">Other than the name, there isn’t anything significant about this property from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2196.1">Command</span></strong><span class="koboSpan" id="kobo.2197.1"> property. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2198.1">CommandParameter</span></strong><span class="koboSpan" id="kobo.2199.1"> allows you to specify parameters to pass to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2200.1">Command</span></strong><span class="koboSpan" id="kobo.2201.1">, but </span><span class="No-Break"><span class="koboSpan" id="kobo.2202.1">using XAML.</span></span></p></li> <li><span class="koboSpan" id="kobo.2203.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2204.1">Label</span></strong> <a id="_idIndexMarker1074"/><span class="koboSpan" id="kobo.2205.1">control is populated from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2206.1">Text</span></strong><span class="koboSpan" id="kobo.2207.1"> property. </span><span class="koboSpan" id="kobo.2207.2">To add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2208.1">Text</span></strong><span class="koboSpan" id="kobo.2209.1"> property, add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2210.1">ActivityButton</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2211.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2212.1">
public static readonly BindableProperty TextProperty = BindableProperty.Create(
    propertyName: nameof(Text),
    returnType: typeof(string),
    declaringType: typeof(ActivityButton),
    defaultValue: string.Empty,
    defaultBindingMode: BindingMode.TwoWay);
public string Text
{
    get =&gt; (string)GetValue(TextProperty);
    set { SetValue(TextProperty, value); }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2213.1">In the case of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2214.1">Text</span></strong><span class="koboSpan" id="kobo.2215.1"> property, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2216.1">returnType</span></strong><span class="koboSpan" id="kobo.2217.1"> has changed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2218.1">string</span></strong><span class="koboSpan" id="kobo.2219.1">, but otherwise, it’s similar to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2220.1">Command</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2221.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2222.1">CommandParameter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2223.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.2224.1">The next property we need to implement is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2225.1">IsRunning</span></strong><span class="koboSpan" id="kobo.2226.1"> property, </span><span class="No-Break"><span class="koboSpan" id="kobo.2227.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2228.1">
public static readonly BindableProperty IsRunningProperty = BindableProperty.Create(
    propertyName: nameof(IsRunning),
    returnType: typeof(bool),
    declaringType: typeof(ActivityButton),
    defaultValue: false);
public bool IsRunning
{
    get =&gt; (bool)GetValue(IsRunningProperty);
    set { SetValue(IsRunningProperty, value); }
}</span></pre></li> <li><span class="koboSpan" id="kobo.2229.1">To allow </span><a id="_idIndexMarker1075"/><span class="koboSpan" id="kobo.2230.1">the size and font of the text to be changed, we implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2231.1">FontSize</span></strong><span class="koboSpan" id="kobo.2232.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2233.1">FontFamily</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2234.1"> properties:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2235.1">
public static readonly BindableProperty FontFamilyProperty = BindableProperty.Create(
    propertyName: nameof(FontFamily),
    returnType: typeof(string),
    declaringType: typeof(ActivityButton),
    defaultValue: string.Empty,
    defaultBindingMode: BindingMode.TwoWay);
public string FontFamily
{
    get =&gt; (string)GetValue(Label.FontFamilyProperty);
    set { SetValue(Label.FontFamilyProperty, value); }
}
public static readonly BindableProperty FontSizeProperty = BindableProperty.Create(
    nameof(FontSize),
    typeof(double),
    typeof(ActivityButton),
    Device.GetNamedSize(NamedSize.Small, typeof(Label)),
    BindingMode.TwoWay);
public double FontSize
{
    set { SetValue(FontSizeProperty, value); }
    get { return (double)GetValue(FontSizeProperty); }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.2236.1">That </span><a id="_idIndexMarker1076"/><span class="koboSpan" id="kobo.2237.1">completed </span><strong class="source-inline"><span class="koboSpan" id="kobo.2238.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.2239.1">. </span><span class="koboSpan" id="kobo.2239.2">We will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2240.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.2241.1"> in the </span><em class="italic"><span class="koboSpan" id="kobo.2242.1">Creating the Connect view</span></em><span class="koboSpan" id="kobo.2243.1"> section right after we create the images we need for </span><span class="No-Break"><span class="koboSpan" id="kobo.2244.1">the game.</span></span></p>
<h4><span class="koboSpan" id="kobo.2245.1">Creating images using Bing Image Creator</span></h4>
<p><span class="koboSpan" id="kobo.2246.1">There </span><a id="_idIndexMarker1077"/><span class="koboSpan" id="kobo.2247.1">are a few images that are used in the game. </span><span class="koboSpan" id="kobo.2247.2">They are </span><span class="No-Break"><span class="koboSpan" id="kobo.2248.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2249.1">A </span><span class="No-Break"><span class="koboSpan" id="kobo.2250.1">horizontal stick</span></span></li>
<li><span class="koboSpan" id="kobo.2251.1">A </span><span class="No-Break"><span class="koboSpan" id="kobo.2252.1">vertical stick</span></span></li>
<li><span class="koboSpan" id="kobo.2253.1">A pile </span><span class="No-Break"><span class="koboSpan" id="kobo.2254.1">of stones</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2255.1">Creating these images can be quite time-consuming and, based on your artistic abilities, not quite what you expected. </span><span class="koboSpan" id="kobo.2255.2">It is quite possible that for your app you may opt to hire a graphics </span><a id="_idIndexMarker1078"/><span class="koboSpan" id="kobo.2256.1">designer or artist to create your digital assets for you. </span><span class="koboSpan" id="kobo.2256.2">Recently, a new option has become available, and that is to </span><a id="_idIndexMarker1079"/><span class="koboSpan" id="kobo.2257.1">use AI to generate images. </span><span class="koboSpan" id="kobo.2257.2">In this section, we will look at how to use </span><strong class="bold"><span class="koboSpan" id="kobo.2258.1">Bing Image Creator</span></strong><span class="koboSpan" id="kobo.2259.1"> to create the images that are needed for </span><span class="No-Break"><span class="koboSpan" id="kobo.2260.1">the game.</span></span></p>
<p><span class="koboSpan" id="kobo.2261.1">Bing Image Creator uses an English description of the scene that you would like to see and attempts to create it. </span><span class="koboSpan" id="kobo.2261.2">There are a few keywords that you can use to direct the Image Creator in the artistic style of the image to create, such as </span><em class="italic"><span class="koboSpan" id="kobo.2262.1">game art</span></em><span class="koboSpan" id="kobo.2263.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2264.1">digital art</span></em><span class="koboSpan" id="kobo.2265.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.2266.1">or </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2267.1">photorealistic</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2268.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.2269.1">Let’s get started by creating the </span><span class="No-Break"><span class="koboSpan" id="kobo.2270.1">stick image:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2271.1">Open </span><a href="https://bing.com/create"><span class="koboSpan" id="kobo.2272.1">https://bing.com/create</span></a><span class="koboSpan" id="kobo.2273.1"> in Microsoft Edge or your favorite </span><span class="No-Break"><span class="koboSpan" id="kobo.2274.1">web browser.</span></span></li>
<li><span class="koboSpan" id="kobo.2275.1">If asked, log in with your Microsoft account. </span><span class="koboSpan" id="kobo.2275.2">This can be the same account that you used in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2276.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.2277.1"> to log in to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2278.1">Azure portal.</span></span></li>
<li><span class="koboSpan" id="kobo.2279.1">In the prompt box, type in the following prompt, then </span><span class="No-Break"><span class="koboSpan" id="kobo.2280.1">press </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2281.1">Create</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2282.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2283.1">
A single wood stick, positioned horizontally, with five stubs where branches would be and no leaves, no background, game art</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2284.1">Image Creator will generate four different images based on your description. </span><span class="koboSpan" id="kobo.2284.2">If you aren’t satisfied with the result, adjust the description slightly and try again. </span><span class="koboSpan" id="kobo.2284.3">The more descriptive you are, the better your result. </span><span class="koboSpan" id="kobo.2284.4">Try to get a stick that is nearly vertical or horizontal since it will be easier to rotate and crop the image. </span><span class="koboSpan" id="kobo.2284.5">It will also look much better if it is on a bright </span><span class="No-Break"><span class="koboSpan" id="kobo.2285.1">white background.</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer172">
<span class="koboSpan" id="kobo.2286.1"><img alt="Figure 10.7 – An Image Creator sample set of images" src="image/B19214_10_7.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2287.1">Figure 10.7 – An Image Creator sample set of images</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2288.1">Once </span><a id="_idIndexMarker1080"/><span class="koboSpan" id="kobo.2289.1">you have an image you are satisfied with, click on the image to open </span><span class="No-Break"><span class="koboSpan" id="kobo.2290.1">it up.</span></span></li>
<li><span class="koboSpan" id="kobo.2291.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2292.1">Download</span></strong><span class="koboSpan" id="kobo.2293.1"> button to save the image to your </span><span class="No-Break"><span class="koboSpan" id="kobo.2294.1">local computer.</span></span></li>
<li><span class="koboSpan" id="kobo.2295.1">Now, open the downloaded file in your favorite image editor. </span><span class="koboSpan" id="kobo.2295.2">The images created by Image Creator are roughly 1024 x 1024, and ideally, the image should be a 3:9 ratio, or around 300 x 900 pixels. </span><span class="koboSpan" id="kobo.2295.3">Using your image editor tools, crop the image so that it is roughly 300 x </span><span class="No-Break"><span class="koboSpan" id="kobo.2296.1">900 pixels.</span></span></li>
<li><span class="koboSpan" id="kobo.2297.1">Save the image as either </span><strong class="source-inline"><span class="koboSpan" id="kobo.2298.1">hstick.jpeg</span></strong><span class="koboSpan" id="kobo.2299.1"> if the stick is orientated horizontally, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.2300.1">vstick.jpeg</span></strong><span class="koboSpan" id="kobo.2301.1"> if vertically, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2302.1">Resources/Images</span></strong><span class="koboSpan" id="kobo.2303.1"> folder of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2304.1">SticksAndStones.App</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2305.1"> project.</span></span></li>
<li><span class="koboSpan" id="kobo.2306.1">Using the same image editing tools, rotate the image 90 degrees so that it is the opposite orientation and save the image in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2307.1">Resources/</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.2308.1">I</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.2309.1">mages</span></strong><span class="koboSpan" id="kobo.2310.1"> folder as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2311.1">hstick.jpeg</span></strong><span class="koboSpan" id="kobo.2312.1"> if the stick is now orientated horizontally, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.2313.1">vstick.jpeg</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2314.1">if vertically.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.2315.1">We </span><a id="_idIndexMarker1081"/><span class="koboSpan" id="kobo.2316.1">have nearly half of the images that we need to create. </span><span class="koboSpan" id="kobo.2316.2">Let’s work on creating the </span><span class="No-Break"><span class="koboSpan" id="kobo.2317.1">stones next:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2318.1">Open </span><a href="https://bing.com/create"><span class="koboSpan" id="kobo.2319.1">https://bing.com/create</span></a><span class="koboSpan" id="kobo.2320.1"> in Microsoft Edge or your favorite </span><span class="No-Break"><span class="koboSpan" id="kobo.2321.1">web browser.</span></span></li>
<li><span class="koboSpan" id="kobo.2322.1">If asked, log in with your Microsoft account. </span><span class="koboSpan" id="kobo.2322.2">This can be the same account that you used in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2323.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.2324.1"> to log in to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2325.1">Azure portal.</span></span></li>
<li><span class="koboSpan" id="kobo.2326.1">In the prompt box, type in the following prompt, then </span><span class="No-Break"><span class="koboSpan" id="kobo.2327.1">press </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2328.1">Create</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2329.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2330.1">
3 grey stones, arranged closely together, no background, game art</span></pre></li> <li><span class="koboSpan" id="kobo.2331.1">Work the prompt to get three stones nicely piled together, preferably on a white background, as </span><span class="No-Break"><span class="koboSpan" id="kobo.2332.1">shown here:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer173">
<span class="koboSpan" id="kobo.2333.1"><img alt="Figure 10.8 – Three stones on a white background" src="image/B19214_10_8.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2334.1">Figure 10.8 – Three stones on a white background</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.2335.1">When </span><a id="_idIndexMarker1082"/><span class="koboSpan" id="kobo.2336.1">you are satisfied with the generated image, click the image to </span><span class="No-Break"><span class="koboSpan" id="kobo.2337.1">open it.</span></span></li>
<li><span class="koboSpan" id="kobo.2338.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.2339.1">Download</span></strong><span class="koboSpan" id="kobo.2340.1"> button to save the image to your </span><span class="No-Break"><span class="koboSpan" id="kobo.2341.1">local computer.</span></span></li>
<li><span class="koboSpan" id="kobo.2342.1">Now, open the downloaded file in your favorite image editor. </span><span class="koboSpan" id="kobo.2342.2">Since the stones are supposed to be a square image, we can just save the file into the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2343.1">Resources/Images</span></strong><span class="koboSpan" id="kobo.2344.1"> folder </span><span class="No-Break"><span class="koboSpan" id="kobo.2345.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2346.1">stones.jpeg</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2347.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.2348.1">Don’t have an image editor?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2349.1">Don’t have a favorite image editor? </span><span class="koboSpan" id="kobo.2349.2">If you are on Windows, Paint does the job nicely, or you can use Visual Studio to edit images. </span><span class="koboSpan" id="kobo.2349.3">On macOS, you can </span><span class="No-Break"><span class="koboSpan" id="kobo.2350.1">use Preview.</span></span></p>
<p><span class="koboSpan" id="kobo.2351.1">Excellent, we now have the sticks and the stones needed to play the game, and that concludes </span><a id="_idIndexMarker1083"/><span class="koboSpan" id="kobo.2352.1">the use of Image Creator to generate our game’s images. </span><span class="koboSpan" id="kobo.2352.2">You can always go back to the site and review previous results, which is a nice feature. </span><span class="koboSpan" id="kobo.2352.3">Now, we can move forward with creating the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2353.1">Connect</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2354.1"> view.</span></span></p>
<h4><span class="koboSpan" id="kobo.2355.1">Creating the Connect view</span></h4>
<p><span class="koboSpan" id="kobo.2356.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2357.1">Connect</span></strong><span class="koboSpan" id="kobo.2358.1"> view is the first UI other than the splash screen the user is going to see in the app. </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2359.1">Figure 10</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2360.1">.6</span></em><span class="koboSpan" id="kobo.2361.1"> provides a representation of what the final view will look like. </span><span class="koboSpan" id="kobo.2361.2">The images may be different if you decide to generate your own of course. </span><span class="koboSpan" id="kobo.2361.3">We will break this section </span><a id="_idIndexMarker1084"/><span class="koboSpan" id="kobo.2362.1">into three parts. </span><span class="koboSpan" id="kobo.2362.2">First, we will create the top portion of the view containing the static content, then move on to creating the middle portion of the view containing the entry controls, and then, finally, the </span><strong class="bold"><span class="koboSpan" id="kobo.2363.1">Connect</span></strong><span class="koboSpan" id="kobo.2364.1"> button. </span><span class="koboSpan" id="kobo.2364.2">Let’s get started with the top section of the view by following </span><span class="No-Break"><span class="koboSpan" id="kobo.2365.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2366.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2367.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.2368.1"> project, create a folder </span><span class="No-Break"><span class="koboSpan" id="kobo.2369.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2370.1">Views</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2371.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2372.1">Right-click on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2373.1">Views</span></strong><span class="koboSpan" id="kobo.2374.1"> folder, select </span><strong class="bold"><span class="koboSpan" id="kobo.2375.1">Add</span></strong><span class="koboSpan" id="kobo.2376.1">, and then click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2377.1">New Item...</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2378.1">.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.2379.1">If you are using Visual Studio 17.7 or later, click the </span><strong class="bold"><span class="koboSpan" id="kobo.2380.1">Show </span></strong><strong class="bold"><span class="koboSpan" id="kobo.2381.1">All</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2382.1"> Templates</span></strong><span class="koboSpan" id="kobo.2383.1"> button in the dialog that pops up; otherwise, move to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2384.1">next step.</span></span></p></li>
<li><span class="koboSpan" id="kobo.2385.1">Under the </span><strong class="bold"><span class="koboSpan" id="kobo.2386.1">C# Items</span></strong><span class="koboSpan" id="kobo.2387.1"> node on the left, select </span><strong class="bold"><span class="koboSpan" id="kobo.2388.1">.</span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2389.1">NET MAUI</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2390.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2391.1">Selec</span><a id="_idTextAnchor888"/><span class="koboSpan" id="kobo.2392.1">t </span><strong class="bold"><span class="koboSpan" id="kobo.2393.1">.NET MAUI </span></strong><strong class="bold"><span class="koboSpan" id="kobo.2394.1">ContentPage</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2395.1"> (XAML)</span></strong><span class="koboSpan" id="kobo.2396.1"> and name </span><span class="No-Break"><span class="koboSpan" id="kobo.2397.1">it </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2398.1">ConnectView.xaml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2399.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2400.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.2401.1">Add</span></strong><span class="koboSpan" id="kobo.2402.1"> to create </span><span class="No-Break"><span class="koboSpan" id="kobo.2403.1">the page.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.2404.1">Refer to the following screenshot to view the </span><span class="No-Break"><span class="koboSpan" id="kobo.2405.1">preceding information:</span></span></p></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer174">
<span class="koboSpan" id="kobo.2406.1"><img alt="Figure 10.9 – Adding a new .NET MAUI ContentPage (XAML)" src="image/B19214_10_9.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2407.1">Figure 10.9 – Adding a new .NET MAUI ContentPage (XAML)</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2408.1">Change the title of the view to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2409.1">Sticks &amp;amp; Stones</span></strong><span class="koboSpan" id="kobo.2410.1">. </span><span class="koboSpan" id="kobo.2410.2">Since XAML is a dialect of XML, the ampersand (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2411.1">&amp;</span></strong><span class="koboSpan" id="kobo.2412.1">) must be escaped as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2413.1">&amp;amp;</span></strong><span class="koboSpan" id="kobo.2414.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.2415.1">the string.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.2416.1">Add the </span><a id="_idIndexMarker1085"/><span class="koboSpan" id="kobo.2417.1">following highlighted namespaces to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2418.1">ContentView</span></strong><span class="koboSpan" id="kobo.2419.1"> element. </span><span class="koboSpan" id="kobo.2419.2">They will provide us access to the classes in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2420.1">ViewModels</span></strong><span class="koboSpan" id="kobo.2421.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2422.1">Controls</span></strong><span class="koboSpan" id="kobo.2423.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2424.1">Toolkit</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2425.1"> namespaces:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.2426.1">
&lt;ContentPage xmlns=“http://schemas.microsoft.com/dotnet/2021/maui”
             xmlns:x=“http://schemas.microsoft.com/winfx/2009/xaml”
</span><strong class="bold"><span class="koboSpan" id="kobo.2427.1">        xmlns:viewModels=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2428.1">“</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2429.1">clr-namespace:SticksAndStones.ViewModels”</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2430.1">        xmlns:controls=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2431.1">“</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2432.1">clr-namespace:SticksAndStones.Controls”</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2433.1">              xmlns:toolkit=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2434.1">“</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2435.1">http://schemas.microsoft.com/dotnet/2022/maui/toolkit”</span></strong><span class="koboSpan" id="kobo.2436.1">
             x:Class=“SticksAndStones.Views.ConnectView”
             Title=“Sticks and Stones”&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.2437.1">To make </span><a id="_idIndexMarker1086"/><span class="koboSpan" id="kobo.2438.1">IntelliSense happy with the bindings we will be adding, define the view model that the view is using by adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2439.1">x:DataType</span></strong><span class="koboSpan" id="kobo.2440.1"> attribute to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2441.1">ContentView</span></strong><span class="koboSpan" id="kobo.2442.1"> element, </span><span class="No-Break"><span class="koboSpan" id="kobo.2443.1">as shown:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2444.1">
&lt;ContentPage  xmlns=“http://schemas.microsoft.com/dotnet/2021/maui”
             xmlns:x=“http://schemas.microsoft.com/winfx/2009/xaml”
        xmlns:viewModels=“clr-namespace:SticksAndStones.ViewModels”
        xmlns:controls=“clr-namespace:SticksAndStones.Controls”
             xmlns:toolkit=“http://schemas.microsoft.com/dotnet/2022/maui/toolkit”
             x:Class=“SticksAndStones.Views.ConnectView”
        </span><strong class="bold"><span class="koboSpan" id="kobo.2445.1">x:DataType=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2446.1">“</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2447.1">viewModels:ConnectViewModel”</span></strong><span class="koboSpan" id="kobo.2448.1">
        Title=“Sticks and Stones”&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.2449.1">We don’t want the user to use any navigation, such as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2450.1">Shell</span></strong><span class="koboSpan" id="kobo.2451.1">-provided </span><strong class="source-inline"><span class="koboSpan" id="kobo.2452.1">Back</span></strong><span class="koboSpan" id="kobo.2453.1"> button, other than what is provided on this page, so disable it using the highlighted code in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2454.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2455.1">
&lt;ContentPage xmlns=“http://schemas.microsoft.com/dotnet/2021/maui”
             xmlns:x=“http://schemas.microsoft.com/winfx/2009/xaml”
        xmlns:viewModels=“clr-namespace:SticksAndStones.ViewModels”
        xmlns:controls=“clr-namespace:SticksAndStones.Controls”
             xmlns:toolkit=“http://schemas.microsoft.com/dotnet/2022/maui/toolkit”
             x:Class=“SticksAndStones.Views.ConnectView”
        x:DataType=“viewModels:ConnectViewModel”
        Title=“Sticks and Stones”
        </span><strong class="bold"><span class="koboSpan" id="kobo.2456.1">NavigationPage.HasNavigationBar=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2457.1">“</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2458.1">False”</span></strong><span class="koboSpan" id="kobo.2459.1">&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.2460.1">Finally, set </span><strong class="source-inline"><span class="koboSpan" id="kobo.2461.1">BackgroundColor</span></strong><span class="koboSpan" id="kobo.2462.1"> of the entire view to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2463.1">White</span></strong><span class="koboSpan" id="kobo.2464.1">, which will make the images </span><a id="_idIndexMarker1087"/><span class="koboSpan" id="kobo.2465.1">blend better, by adding the following </span><span class="No-Break"><span class="koboSpan" id="kobo.2466.1">highlighted code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2467.1">
&lt;ContentPage xmlns=“http://schemas.microsoft.com/dotnet/2021/maui”
             xmlns:x=“http://schemas.microsoft.com/winfx/2009/xaml”
        xmlns:viewModels=“clr-namespace:SticksAndStones.ViewModels”
        xmlns:controls=“clr-namespace:SticksAndStones.Controls”
             xmlns:toolkit=“http://schemas.microsoft.com/dotnet/2022/maui/toolkit”
             x:Class=“SticksAndStones.Views.ConnectView”
        x:DataType=“viewModels:ConnectViewModel”
        Title=“Sticks &amp;amp; Stones”
        NavigationPage.HasNavigationBar=“False”
        </span><strong class="bold"><span class="koboSpan" id="kobo.2468.1">BackgroundColor=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2469.1">“</span></strong><strong class="bold"><span class="koboSpan" id="kobo.2470.1">White”</span></strong><span class="koboSpan" id="kobo.2471.1">&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.2472.1">To lay out </span><a id="_idIndexMarker1088"/><span class="koboSpan" id="kobo.2473.1">the view, use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2474.1">Grid</span></strong><span class="koboSpan" id="kobo.2475.1"> control that has four rows defined; add the following code within the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2476.1">ContentPage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2477.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2478.1">
&lt;Grid Margin=“40”&gt;
    &lt;Grid.RowDefinitions&gt;
        &lt;RowDefinition Height=“8*”/&gt;
        &lt;RowDefinition Height=“2*”/&gt;
        &lt;RowDefinition Height=“8*”/&gt;
        &lt;RowDefinition Height=“1*”/&gt;
    &lt;/Grid.RowDefinitions&gt;
&lt;/Grid&gt;</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.2479.1">Grid</span></strong><span class="koboSpan" id="kobo.2480.1"> uses a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2481.1">Margin</span></strong><span class="koboSpan" id="kobo.2482.1"> value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2483.1">40</span></strong><span class="koboSpan" id="kobo.2484.1"> to provide plenty of whitespace around the images and controls. </span><span class="koboSpan" id="kobo.2484.2">The first row at </span><strong class="source-inline"><span class="koboSpan" id="kobo.2485.1">8</span></strong><span class="koboSpan" id="kobo.2486.1"> units will contain the logo for the app. </span><span class="koboSpan" id="kobo.2486.2">The second row will contain the text </span><strong class="source-inline"><span class="koboSpan" id="kobo.2487.1">Sticks &amp; Stones</span></strong><span class="koboSpan" id="kobo.2488.1">. </span><span class="koboSpan" id="kobo.2488.2">The third row will have the avatar image, email, and gamer tag entry controls. </span><span class="koboSpan" id="kobo.2488.3">The final row will contain the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2489.1">Connect</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2490.1"> button.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.2491.1">Recall that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2492.1">Height</span></strong><span class="koboSpan" id="kobo.2493.1"> units are relative, so row </span><strong class="source-inline"><span class="koboSpan" id="kobo.2494.1">0</span></strong><span class="koboSpan" id="kobo.2495.1">, the first row, will be four times higher than row </span><strong class="source-inline"><span class="koboSpan" id="kobo.2496.1">1</span></strong><span class="koboSpan" id="kobo.2497.1"> and eight times higher than row </span><strong class="source-inline"><span class="koboSpan" id="kobo.2498.1">3</span></strong><span class="koboSpan" id="kobo.2499.1">, the final row. </span><span class="koboSpan" id="kobo.2499.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2500.1">*</span></strong><span class="koboSpan" id="kobo.2501.1"> symbol in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2502.1">Height</span></strong><span class="koboSpan" id="kobo.2503.1"> value indicates that the row can expand </span><span class="No-Break"><span class="koboSpan" id="kobo.2504.1">if needed.</span></span></p></li> <li><span class="koboSpan" id="kobo.2505.1">To arrange our generated images into a box-like layout, another </span><strong class="source-inline"><span class="koboSpan" id="kobo.2506.1">Grid</span></strong><span class="koboSpan" id="kobo.2507.1"> control is used. </span><span class="koboSpan" id="kobo.2507.2">Add the following listing to the view between the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2508.1">&lt;/Grid.RowDefinitions&gt;</span></strong><span class="koboSpan" id="kobo.2509.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2510.1">&lt;/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2511.1">Grid&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2512.1"> tags:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2513.1">
&lt;Grid Grid.Row=“0” WidthRequest=“150” HeightRequest=“150”&gt;
    &lt;Grid.ColumnDefinitions&gt;
        &lt;ColumnDefinition Width=“1*” /&gt;
        &lt;ColumnDefinition Width=“5*” /&gt;
        &lt;ColumnDefinition Width=“1*” /&gt;
    &lt;/Grid.ColumnDefinitions&gt;
    &lt;Grid.RowDefinitions&gt;
        &lt;RowDefinition Height=“1*” /&gt;
        &lt;RowDefinition Height=“4*” /&gt;
        &lt;RowDefinition Height=“1*” /&gt;
    &lt;/Grid.RowDefinitions&gt;
    &lt;Image Grid.Row=“0” Grid.Column=“1” Source=“hstick.jpeg” Aspect=“Fill”/&gt;
    &lt;Image Grid.Row=“1” Grid.Column=“0” Source=“vstick.jpeg” Aspect=“Fill”/&gt;
    &lt;Image Grid.Row=“1” Grid.Column=“1” Source=“stones.jpeg” Aspect=“AspectFit”/&gt;
    &lt;Image Grid.Row=“1” Grid.Column=“2” Source=“vstick.jpeg” Aspect=“Fill”/&gt;
    &lt;Image Grid.Row=“2” Grid.Column=“1” Source=“hstick.jpeg” Aspect=“Fill”/&gt;
&lt;/Grid&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2514.1">This </span><strong class="source-inline"><span class="koboSpan" id="kobo.2515.1">Grid</span></strong><span class="koboSpan" id="kobo.2516.1"> control defines three rows and three columns. </span><span class="koboSpan" id="kobo.2516.2">The content of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2517.1">Grid</span></strong><span class="koboSpan" id="kobo.2518.1"> is entirely </span><a id="_idIndexMarker1089"/><span class="koboSpan" id="kobo.2519.1">made up of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2520.1">Image</span></strong><span class="koboSpan" id="kobo.2521.1"> controls. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2522.1">Grid</span></strong><span class="koboSpan" id="kobo.2523.1"> is positioned in row </span><strong class="source-inline"><span class="koboSpan" id="kobo.2524.1">0</span></strong><span class="koboSpan" id="kobo.2525.1"> of its parent </span><strong class="source-inline"><span class="koboSpan" id="kobo.2526.1">Grid</span></strong><span class="koboSpan" id="kobo.2527.1">. </span><span class="koboSpan" id="kobo.2527.2">The children of the grid, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2528.1">Image</span></strong><span class="koboSpan" id="kobo.2529.1"> controls, are positioned by setting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2530.1">Grid.Row</span></strong><span class="koboSpan" id="kobo.2531.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2532.1">Grid.Column</span></strong><span class="koboSpan" id="kobo.2533.1"> attributes on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2534.1">Image</span></strong><span class="koboSpan" id="kobo.2535.1"> control. </span><span class="koboSpan" id="kobo.2535.2">The stick images use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2536.1">Aspect</span></strong><span class="koboSpan" id="kobo.2537.1"> attribute set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2538.1">Fill</span></strong><span class="koboSpan" id="kobo.2539.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2540.1">Fill</span></strong><span class="koboSpan" id="kobo.2541.1"> allows the image to scale to completely fill the content area; to do so, it may not scale uniformly along both the </span><em class="italic"><span class="koboSpan" id="kobo.2542.1">x</span></em><span class="koboSpan" id="kobo.2543.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.2544.1">y</span></em><span class="koboSpan" id="kobo.2545.1"> axis. </span><span class="koboSpan" id="kobo.2545.2">The stones use an </span><strong class="source-inline"><span class="koboSpan" id="kobo.2546.1">Aspect</span></strong><span class="koboSpan" id="kobo.2547.1"> value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2548.1">AspectFit</span></strong><span class="koboSpan" id="kobo.2549.1">. </span><span class="koboSpan" id="kobo.2549.2">This will uniformly scale the image till at least one side fits, which may cause letterboxing. </span><span class="koboSpan" id="kobo.2549.3">There are two more options for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2550.1">Aspect</span></strong><span class="koboSpan" id="kobo.2551.1"> property: </span><strong class="source-inline"><span class="koboSpan" id="kobo.2552.1">Center</span></strong><span class="koboSpan" id="kobo.2553.1">, which does no scaling, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2554.1">AspectFill</span></strong><span class="koboSpan" id="kobo.2555.1">, which will scale until both axes have filled the view, which may </span><span class="No-Break"><span class="koboSpan" id="kobo.2556.1">cause clipping.</span></span></p></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.2557.1">A Label</span></strong><span class="koboSpan" id="kobo.2558.1"> element containing the text </span><strong class="source-inline"><span class="koboSpan" id="kobo.2559.1">Connect to Sticks &amp; Stones</span></strong><span class="koboSpan" id="kobo.2560.1"> is added to the outer </span><strong class="source-inline"><span class="koboSpan" id="kobo.2561.1">Grid</span></strong><span class="koboSpan" id="kobo.2562.1"> control and it’s placed in row </span><strong class="source-inline"><span class="koboSpan" id="kobo.2563.1">1</span></strong><span class="koboSpan" id="kobo.2564.1">, which is the second row of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2565.1">Grid</span></strong><span class="koboSpan" id="kobo.2566.1">. </span><span class="koboSpan" id="kobo.2566.2">Add the following code to the outer </span><strong class="source-inline"><span class="koboSpan" id="kobo.2567.1">Grid</span></strong><span class="koboSpan" id="kobo.2568.1"> control after the inner </span><strong class="source-inline"><span class="koboSpan" id="kobo.2569.1">Grid</span></strong><span class="koboSpan" id="kobo.2570.1"> control added in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2571.1">step 11</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2572.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2573.1">
&lt;Label Grid.Row="1" Text="Connect to Sticks &amp;amp; Stones" FontSize="20" TextColor="Black" FontAttributes="Bold" Margin="0,0,0,20" HorizontalOptions="Center"/&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.2574.1">The next </span><a id="_idIndexMarker1090"/><span class="koboSpan" id="kobo.2575.1">section of the page contains the avatar image, gamer tag entry, and email entry controls. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2576.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.2577.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2578.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.2579.1"> controls are used to arrange the controls. </span><span class="koboSpan" id="kobo.2579.2">Add the following snippet to the outer </span><strong class="source-inline"><span class="koboSpan" id="kobo.2580.1">Grid</span></strong><span class="koboSpan" id="kobo.2581.1"> control after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2582.1">Label</span></strong><span class="koboSpan" id="kobo.2583.1"> control added in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2584.1">step 12</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2585.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2586.1">
&lt;HorizontalStackLayout Grid.Row="2" HorizontalOptions="Center"&gt;
    &lt;VerticalStackLayout Spacing="10" &gt; 
        &lt;Image HeightRequest="96" WidthRequest="96" BackgroundColor="LightGrey"&gt;
            &lt;Image.Source&gt;
                &lt;toolkit:GravatarImageSource
                    Email="{Binding EmailAddress}"
                    Image="MysteryPerson" /&gt;
            &lt;/Image.Source&gt;
        &lt;/Image&gt;
    &lt;/VerticalStackLayout&gt;
    &lt;VerticalStackLayout Spacing="10" &gt;
        &lt;Entry Placeholder="username" Keyboard="Email" Text="{Binding Username}" HorizontalTextAlignment="Start" HorizontalOptions="FillAndExpand"/&gt;
        &lt;Entry Placeholder="user@someaddress.com" Keyboard="Email" Text="{Binding EmailAddress}" HorizontalTextAlignment="Start" HorizontalOptions="FillAndExpand"/&gt;
    &lt;/VerticalStackLayout&gt;
&lt;/HorizontalStackLayout&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2587.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2588.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.2589.1"> control is assigned to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2590.1">Grid</span></strong><span class="koboSpan" id="kobo.2591.1"> row </span><strong class="source-inline"><span class="koboSpan" id="kobo.2592.1">2</span></strong><span class="koboSpan" id="kobo.2593.1">, the third row. </span><span class="koboSpan" id="kobo.2593.2">It is also </span><a id="_idIndexMarker1091"/><span class="koboSpan" id="kobo.2594.1">centered horizontally within the row. </span><span class="koboSpan" id="kobo.2594.2">The first </span><strong class="source-inline"><span class="koboSpan" id="kobo.2595.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.2596.1"> arranges the controls that make up the </span><a id="_idIndexMarker1092"/><span class="koboSpan" id="kobo.2597.1">avatar. </span><span class="koboSpan" id="kobo.2597.2">It contains an </span><strong class="source-inline"><span class="koboSpan" id="kobo.2598.1">Image</span></strong><span class="koboSpan" id="kobo.2599.1"> element, whose source is set to an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2600.1">GravatarImageSource</span></strong><span class="koboSpan" id="kobo.2601.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2602.1">GravatarImageSource</span></strong><span class="koboSpan" id="kobo.2603.1"> uses the </span><strong class="bold"><span class="koboSpan" id="kobo.2604.1">Gravatar</span></strong><span class="koboSpan" id="kobo.2605.1"> service (</span><a href="https://gravatar.com"><span class="koboSpan" id="kobo.2606.1">https://gravatar.com</span></a><span class="koboSpan" id="kobo.2607.1">) to provide avatars when given an email address. </span><span class="koboSpan" id="kobo.2607.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2608.1">EmailAddress</span></strong><span class="koboSpan" id="kobo.2609.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2610.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.2611.1"> is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2612.1">Email</span></strong><span class="koboSpan" id="kobo.2613.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2614.1">GravatarImageSource</span></strong><span class="koboSpan" id="kobo.2615.1">. </span><span class="koboSpan" id="kobo.2615.2">The image will automatically update on changes to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2616.1">EmailAddress</span></strong><span class="koboSpan" id="kobo.2617.1">. </span><span class="koboSpan" id="kobo.2617.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2618.1">Image</span></strong><span class="koboSpan" id="kobo.2619.1"> property uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2620.1">MysteryPerson</span></strong><span class="koboSpan" id="kobo.2621.1"> value to provide a plain profile when there isn’t a Gravatar available for the email address. </span><span class="koboSpan" id="kobo.2621.2">The second </span><strong class="source-inline"><span class="koboSpan" id="kobo.2622.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.2623.1"> contains two </span><strong class="source-inline"><span class="koboSpan" id="kobo.2624.1">Entry</span></strong><span class="koboSpan" id="kobo.2625.1"> controls: the first, for the gamer tag, is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2626.1">Username</span></strong><span class="koboSpan" id="kobo.2627.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2628.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.2629.1">, and the second is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2630.1">EmailAddress</span></strong><span class="koboSpan" id="kobo.2631.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2632.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.2633.1">. </span><span class="koboSpan" id="kobo.2633.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2634.1">Keyboard</span></strong><span class="koboSpan" id="kobo.2635.1"> attribute determines which virtual keyboard is displayed when the focus is on the control. </span><span class="koboSpan" id="kobo.2635.2">See </span><a href="https://learn.microsoft.com/en-us/dotnet/maui/user-interface/controls/entry#customize-the-keyboard"><span class="koboSpan" id="kobo.2636.1">https://learn.microsoft.com/en-us/dotnet/maui/user-interface/controls/entry#customize-the-keyboard</span></a><span class="koboSpan" id="kobo.2637.1"> for more information on customizing </span><span class="No-Break"><span class="koboSpan" id="kobo.2638.1">the keyboard.</span></span></p></li> <li><span class="koboSpan" id="kobo.2639.1">The final control to add to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2640.1">ConnectView</span></strong><span class="koboSpan" id="kobo.2641.1"> is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2642.1">Connect</span></strong><span class="koboSpan" id="kobo.2643.1"> button. </span><span class="koboSpan" id="kobo.2643.2">Use the following snippet to add the button to </span><span class="No-Break"><span class="koboSpan" id="kobo.2644.1">the view:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2645.1">
&lt;controls:ActivityButton Grid.Row="3" 
                         IsRunning="{Binding IsConnecting}" 
                         Text="{Binding ConnectStatus}" 
                         BackgroundColor="#e8bc65" 
                         Command="{Binding ConnectCommand}" 
                         HorizontalOptions="Center" 
                         WidthRequest="200" 
                         HeightRequest="48"/&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2646.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2647.1">Connect</span></strong><span class="koboSpan" id="kobo.2648.1"> button </span><a id="_idIndexMarker1093"/><span class="koboSpan" id="kobo.2649.1">uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2650.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.2651.1"> control created in the </span><em class="italic"><span class="koboSpan" id="kobo.2652.1">Creating the ActivityButton control</span></em><span class="koboSpan" id="kobo.2653.1">. </span><span class="koboSpan" id="kobo.2653.2">The control is positioned in row </span><strong class="source-inline"><span class="koboSpan" id="kobo.2654.1">3</span></strong><span class="koboSpan" id="kobo.2655.1">, the fourth row, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2656.1">IsRunning</span></strong><span class="koboSpan" id="kobo.2657.1"> attribute is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2658.1">ConnectViewModel.IsConnecting</span></strong><span class="koboSpan" id="kobo.2659.1"> method. </span><span class="koboSpan" id="kobo.2659.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2660.1">Text</span></strong><span class="koboSpan" id="kobo.2661.1"> attribute of the button is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2662.1">ConnectViewModel.ConnectStatus</span></strong><span class="koboSpan" id="kobo.2663.1"> property, and finally, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2664.1">Command</span></strong><span class="koboSpan" id="kobo.2665.1"> is bound to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2666.1">ConnectViewModel.Connect</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2667.1"> method.</span></span></p></li> <li><span class="koboSpan" id="kobo.2668.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2669.1">MauiProgram.cs</span></strong><span class="koboSpan" id="kobo.2670.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2671.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.2672.1"> project and add the following highlighted line to register </span><strong class="source-inline"><span class="koboSpan" id="kobo.2673.1">ConnectView</span></strong><span class="koboSpan" id="kobo.2674.1"> with </span><span class="No-Break"><span class="koboSpan" id="kobo.2675.1">dependency injection:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2676.1">
builder.Services.AddSingleton&lt;Services.GameService&gt;();
builder.Services.AddTransient&lt;ViewModels.ConnectViewModel&gt;();
</span><strong class="bold"><span class="koboSpan" id="kobo.2677.1">builder.Services.AddTransient&lt;Views.ConnectView&gt;();</span></strong><span class="koboSpan" id="kobo.2678.1">
return builder.Build();</span></pre></li> <li><span class="koboSpan" id="kobo.2679.1">Now, we need to consume the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2680.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.2681.1"> instance through dependency </span><a id="_idIndexMarker1094"/><span class="koboSpan" id="kobo.2682.1">injection and set it as the binding object. </span><span class="koboSpan" id="kobo.2682.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2683.1">ConnectView.Xaml.cs</span></strong><span class="koboSpan" id="kobo.2684.1"> file and modify it </span><span class="No-Break"><span class="koboSpan" id="kobo.2685.1">as follows:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2686.1">using SticksAndStones.ViewModels;</span></strong><span class="koboSpan" id="kobo.2687.1">
namespace SticksAndStones.Views;
public partial class ConnectView : ContentPage
{
    public ConnectView(</span><strong class="bold"><span class="koboSpan" id="kobo.2688.1">ConnectViewModel viewModel</span></strong><span class="koboSpan" id="kobo.2689.1">)
    {
        </span><strong class="bold"><span class="koboSpan" id="kobo.2690.1">this.BindingContext = viewModel;</span></strong><span class="koboSpan" id="kobo.2691.1">
        InitializeComponent();
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.2692.1">Finally, we need to set </span><strong class="source-inline"><span class="koboSpan" id="kobo.2693.1">ConnectView</span></strong><span class="koboSpan" id="kobo.2694.1"> as the first view displayed. </span><span class="koboSpan" id="kobo.2694.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2695.1">AppShell.xaml</span></strong><span class="koboSpan" id="kobo.2696.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2697.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.2698.1"> project and update the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2699.1">Shell</span></strong><span class="koboSpan" id="kobo.2700.1"> element </span><span class="No-Break"><span class="koboSpan" id="kobo.2701.1">as shown:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2702.1">
&lt;Shell
    x:Class="SticksAndStones.App.AppShell"
    
    
    
    </span><strong class="bold"><span class="koboSpan" id="kobo.2703.1"/></strong><span class="koboSpan" id="kobo.2704.1">
    Shell.FlyoutBehavior="Disabled"&gt;
    &lt;ShellItem Route="Connect"&gt;
        &lt;ShellContent ContentTemplate="{DataTemplate views:ConnectView}" /&gt;
    &lt;/ShellItem&gt;
&lt;/Shell&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.2705.1">The first </span><a id="_idIndexMarker1095"/><span class="koboSpan" id="kobo.2706.1">of the three views in the app is complete. </span><span class="koboSpan" id="kobo.2706.2">To test it out, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.2707.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2708.1">In Visual Studio, right-click the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2709.1">SticksAndStones.Functions</span></strong><span class="koboSpan" id="kobo.2710.1"> project in </span><strong class="bold"><span class="koboSpan" id="kobo.2711.1">Solution Explorer</span></strong><span class="koboSpan" id="kobo.2712.1">, then select </span><strong class="bold"><span class="koboSpan" id="kobo.2713.1">Debug</span></strong><span class="koboSpan" id="kobo.2714.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.2715.1">Start </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2716.1">Without Debugging</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2717.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2718.1">In </span><strong class="bold"><span class="koboSpan" id="kobo.2719.1">Solution Explorer</span></strong><span class="koboSpan" id="kobo.2720.1">, right-click the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2721.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.2722.1"> project and select </span><strong class="bold"><span class="koboSpan" id="kobo.2723.1">Set as </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2724.1">Startup Project</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2725.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2726.1">Press </span><em class="italic"><span class="koboSpan" id="kobo.2727.1">F5</span></em><span class="koboSpan" id="kobo.2728.1"> to start the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2729.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.2730.1"> project using </span><span class="No-Break"><span class="koboSpan" id="kobo.2731.1">the debugger.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.2732.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.2733.1">Connect</span></strong><span class="koboSpan" id="kobo.2734.1"> page is the first page our users will see when they launch the app. </span><span class="koboSpan" id="kobo.2734.2">We have added image controls and entry controls, used data binding to bind to our view model, and extended XAML by creating a custom control and a converter. </span><span class="koboSpan" id="kobo.2734.3">In the next section, we will add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2735.1">Lobby</span></strong><span class="koboSpan" id="kobo.2736.1"> page, which will allow us to start games with </span><span class="No-Break"><span class="koboSpan" id="kobo.2737.1">other players.</span></span></p>
<h2 id="_idParaDest-171"><a id="_idTextAnchor889"/><span class="koboSpan" id="kobo.2738.1">Creating the Lobby page</span></h2>
<p><span class="koboSpan" id="kobo.2739.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2740.1">Lobby</span></strong><span class="koboSpan" id="kobo.2741.1"> page displays the list of connected players and allows a player to challenge another to </span><a id="_idIndexMarker1096"/><span class="koboSpan" id="kobo.2742.1">a match. </span><span class="koboSpan" id="kobo.2742.2">As additional players connect to the server, they are added to the list of available players. </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2743.1">Figure 10</span></em></span><em class="italic"><span class="koboSpan" id="kobo.2744.1">.10</span></em><span class="koboSpan" id="kobo.2745.1"> shows the two views for the page, one with connected players, and the empty view when there are no additional </span><span class="No-Break"><span class="koboSpan" id="kobo.2746.1">players connected.</span></span></p>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer175">
<span class="koboSpan" id="kobo.2747.1"><img alt="Figure 10.10 – The Lobby views" src="image/B19214_10_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2748.1">Figure 10.10 – The Lobby views</span></p>
<p><span class="koboSpan" id="kobo.2749.1">Each player is displayed on a card with their avatar image, gamer tag, status, and a button to allow the player to challenge the other to </span><span class="No-Break"><span class="koboSpan" id="kobo.2750.1">a match.</span></span></p>
<p><span class="koboSpan" id="kobo.2751.1">This page is comprised of two </span><strong class="source-inline"><span class="koboSpan" id="kobo.2752.1">ViewModel</span></strong><span class="koboSpan" id="kobo.2753.1"> classes, not one. </span><span class="koboSpan" id="kobo.2753.2">As you might expect, there is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2754.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.2755.1"> class, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2756.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.2757.1"> which class has a collection of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2758.1">PlayerViewModel</span></strong><span class="koboSpan" id="kobo.2759.1"> instances. </span><span class="koboSpan" id="kobo.2759.2">In addition to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2760.1">ViewModel</span></strong><span class="koboSpan" id="kobo.2761.1"> classes, there is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2762.1">LobbyView</span></strong><span class="koboSpan" id="kobo.2763.1"> class. </span><span class="koboSpan" id="kobo.2763.2">Let’s get started by creating the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2764.1">PlayerViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2765.1"> class.</span></span></p>
<h3><span class="koboSpan" id="kobo.2766.1">Adding PlayerViewModel</span></h3>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.2767.1">PlayerViewModel</span></strong><span class="koboSpan" id="kobo.2768.1"> is very much like all our other </span><strong class="source-inline"><span class="koboSpan" id="kobo.2769.1">ViewModel</span></strong><span class="koboSpan" id="kobo.2770.1"> classes but with one slight </span><a id="_idIndexMarker1097"/><span class="koboSpan" id="kobo.2771.1">difference: it isn’t bound directly to a view in the same way. </span><span class="koboSpan" id="kobo.2771.2">Otherwise, it has the same purpose: abstract the model, in this case, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2772.1">Player</span></strong><span class="koboSpan" id="kobo.2773.1">, away from the UI that displays it. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2774.1">PlayerViewModel</span></strong><span class="koboSpan" id="kobo.2775.1"> provides all the needed binding properties to display each individual player card in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2776.1">LobbyView</span></strong><span class="koboSpan" id="kobo.2777.1">. </span><span class="koboSpan" id="kobo.2777.2">To add </span><strong class="source-inline"><span class="koboSpan" id="kobo.2778.1">PlayerViewModel</span></strong><span class="koboSpan" id="kobo.2779.1">, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.2780.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2781.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2782.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.2783.1"> project, under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2784.1">ViewModels</span></strong><span class="koboSpan" id="kobo.2785.1"> folder, create a new class </span><span class="No-Break"><span class="koboSpan" id="kobo.2786.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2787.1">PlayerViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2788.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2789.1">Add the following namespaces to the top of </span><span class="No-Break"><span class="koboSpan" id="kobo.2790.1">the file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2791.1">
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using SticksAndStones.Models;
using SticksAndStones.Services;</span></pre></li> <li><span class="koboSpan" id="kobo.2792.1">Add the following code to </span><span class="No-Break"><span class="koboSpan" id="kobo.2793.1">the class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2794.1">
private readonly Player playerModel;
private readonly GameService gameService;
public PlayerViewModel(Player player, GameService gameService)
{
    playerModel = player;
    this.gameService = gameService;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2795.1">This adds two </span><strong class="source-inline"><span class="koboSpan" id="kobo.2796.1">private</span></strong><span class="koboSpan" id="kobo.2797.1"> fields to hold the values of the arguments passed to the constructor. </span><span class="koboSpan" id="kobo.2797.2">As with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2798.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.2799.1">, the constructor arguments are provided by dependency injection. </span></p></li> <li><span class="koboSpan" id="kobo.2800.1">The player card displays the player’s gamer tag, avatar, and status. </span><span class="koboSpan" id="kobo.2800.2">Add the following code to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2801.1">PlayerViewModel</span></strong><span class="koboSpan" id="kobo.2802.1"> class to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2803.1">Id</span></strong><span class="koboSpan" id="kobo.2804.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2805.1">GamerTag</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2806.1"> properties:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2807.1">
public Guid Id =&gt; playermodel.Id;
public string GamerTag =&gt; playerModel.GamerTag;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2808.1">For </span><strong class="source-inline"><span class="koboSpan" id="kobo.2809.1">PlayerViewModel</span></strong><span class="koboSpan" id="kobo.2810.1">, some of the properties that we bind to are not implemented with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2811.1">ObservablePropertyAttribute</span></strong><span class="koboSpan" id="kobo.2812.1">. </span><span class="koboSpan" id="kobo.2812.2">That is because we are providing their values from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2813.1">Player</span></strong><span class="koboSpan" id="kobo.2814.1"> model directly. </span><span class="koboSpan" id="kobo.2814.2">So, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2815.1">get</span></strong><span class="koboSpan" id="kobo.2816.1"> method </span><a id="_idIndexMarker1098"/><span class="koboSpan" id="kobo.2817.1">of the property just returns the corresponding property of the model object. </span><span class="koboSpan" id="kobo.2817.2">There is no defined </span><strong class="source-inline"><span class="koboSpan" id="kobo.2818.1">set</span></strong><span class="koboSpan" id="kobo.2819.1"> method, so this property is essentially a one-way </span><span class="No-Break"><span class="koboSpan" id="kobo.2820.1">data binding.</span></span></p></li> <li><span class="koboSpan" id="kobo.2821.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2822.1">Status</span></strong><span class="koboSpan" id="kobo.2823.1"> property is a little different since it does not exist on our </span><strong class="source-inline"><span class="koboSpan" id="kobo.2824.1">Player</span></strong><span class="koboSpan" id="kobo.2825.1"> model. </span><span class="koboSpan" id="kobo.2825.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2826.1">Status</span></strong><span class="koboSpan" id="kobo.2827.1"> property is a textual indication of whether the player is in a match or not. </span><span class="koboSpan" id="kobo.2827.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2828.1">Player</span></strong><span class="koboSpan" id="kobo.2829.1"> model does have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2830.1">MatchId</span></strong><span class="koboSpan" id="kobo.2831.1"> property, so if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2832.1">Player</span></strong><span class="koboSpan" id="kobo.2833.1"> model has a valid </span><strong class="source-inline"><span class="koboSpan" id="kobo.2834.1">MatchId</span></strong><span class="koboSpan" id="kobo.2835.1"> (i.e., not </span><strong class="source-inline"><span class="koboSpan" id="kobo.2836.1">Guid.Empty</span></strong><span class="koboSpan" id="kobo.2837.1">), then the status would be </span><strong class="source-inline"><span class="koboSpan" id="kobo.2838.1">"In a match"</span></strong><span class="koboSpan" id="kobo.2839.1">; otherwise, that status would be </span><strong class="source-inline"><span class="koboSpan" id="kobo.2840.1">"Waiting for opponent"</span></strong><span class="koboSpan" id="kobo.2841.1">. </span><span class="koboSpan" id="kobo.2841.2">Add the following code to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2842.1">PlayerViewModel</span></strong><span class="koboSpan" id="kobo.2843.1"> to implement the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2844.1">Status</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2845.1"> property:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2846.1">
public bool IsInMatch =&gt; !(playerModel.MatchId == Guid.Empty);
public string Status =&gt; IsInMatch switch
{
    true =&gt; "In a match",
    false =&gt; "Waiting for opponent"
};</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2847.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2848.1">IsInMatch</span></strong><span class="koboSpan" id="kobo.2849.1"> property is used to simplify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2850.1">Status</span></strong><span class="koboSpan" id="kobo.2851.1"> property implementation. </span><span class="koboSpan" id="kobo.2851.2">It will also be used later in the class. </span><span class="koboSpan" id="kobo.2851.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2852.1">Status</span></strong><span class="koboSpan" id="kobo.2853.1"> property is a simple switch on </span><strong class="source-inline"><span class="koboSpan" id="kobo.2854.1">IsInMatch</span></strong><span class="koboSpan" id="kobo.2855.1"> and returns the proper </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2856.1">string</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2857.1"> value.</span></span></p></li> <li><span class="koboSpan" id="kobo.2858.1">To add </span><a id="_idIndexMarker1099"/><span class="koboSpan" id="kobo.2859.1">a command to handle the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2860.1">Challenge</span></strong><span class="koboSpan" id="kobo.2861.1"> button, add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2862.1">PlayerViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2863.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2864.1">
[ObservableProperty]
[NotifyPropertyChangedFor(nameof(ChallengeStatus))]
private bool isChallenging = false;
public string ChallengeStatus =&gt; IsChallenging switch
{
    true =&gt; "Challenging...",
    false =&gt; "Challenge"
};
public bool CanChallenge =&gt; !IsInMatch &amp;&amp; !IsChallenging;
[RelayCommand(CanExecute = nameof(CanChallenge))]
public void Challenge(PlayerViewModel opponent)
{
    MainThread.BeginInvokeOnMainThread(async () =&gt;
    {
        IsChallenging = true;
        bool answer = await Shell.Current.CurrentPage.DisplayAlert("Issue Challenge!", $" You are about to challenge {GamerTag} to a match!\nAre you sure?", "Yes", "No");
        if (answer)
        {
            await gameService.IssueChallenge(opponent.Player);
        }
        IsChallenging = false;
    });
    return;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2865.1">The command is prevented from executing while it is currently waiting for a challenge response, which makes sense – no need to nag the other player. </span><span class="koboSpan" id="kobo.2865.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2866.1">IsChallenging</span></strong><span class="koboSpan" id="kobo.2867.1"> property is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2868.1">true</span></strong><span class="koboSpan" id="kobo.2869.1"> while challenging and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2870.1">false</span></strong><span class="koboSpan" id="kobo.2871.1"> when it is complete. </span><span class="koboSpan" id="kobo.2871.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2872.1">CanChallenge</span></strong><span class="koboSpan" id="kobo.2873.1"> property is a combination of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2874.1">IsInMatch</span></strong><span class="koboSpan" id="kobo.2875.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2876.1">IsChallenging</span></strong><span class="koboSpan" id="kobo.2877.1">, meaning that you can’t challenge the same player while you have an existing challenge in progress, and you can’t challenge a player who is already in a match with another player. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2878.1">ChallengeStatus</span></strong><span class="koboSpan" id="kobo.2879.1">, which is used as the text for the button, is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2880.1">IsChallenging</span></strong><span class="koboSpan" id="kobo.2881.1"> value and updates when that property is updated. </span><span class="koboSpan" id="kobo.2881.2">You may have noticed that our command takes a single parameter. </span><span class="koboSpan" id="kobo.2881.3">This is used to operate on the correct player. </span></p></li> </ol>
<p><span class="koboSpan" id="kobo.2882.1">That </span><a id="_idIndexMarker1100"/><span class="koboSpan" id="kobo.2883.1">completes </span><strong class="source-inline"><span class="koboSpan" id="kobo.2884.1">PlayerViewModel</span></strong><span class="koboSpan" id="kobo.2885.1">. </span><span class="koboSpan" id="kobo.2885.2">Next, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2886.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.2887.1"> is used to encapsulate the collection of </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2888.1">PlayerViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2889.1"> objects.</span></span></p>
<h3><span class="koboSpan" id="kobo.2890.1">Adding LobbyViewModel</span></h3>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.2891.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.2892.1"> is a </span><a id="_idIndexMarker1101"/><span class="koboSpan" id="kobo.2893.1">fairly straightforward implementation. </span><span class="koboSpan" id="kobo.2893.2">It has a collection of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2894.1">PlayerViewModel</span></strong><span class="koboSpan" id="kobo.2895.1"> objects that are exposed to the UI, it allows the user to pull to refresh the view, and it handles the messages of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2896.1">ChallengeReceived</span></strong><span class="koboSpan" id="kobo.2897.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2898.1">MatchStarted</span></strong><span class="koboSpan" id="kobo.2899.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2900.1">ServiceError</span></strong><span class="koboSpan" id="kobo.2901.1">. </span><span class="koboSpan" id="kobo.2901.2">Follow these steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.2902.1">implement </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2903.1">LobbyViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2904.1">:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2905.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2906.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.2907.1"> project, inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2908.1">ViewModels</span></strong><span class="koboSpan" id="kobo.2909.1"> folder, create a new class </span><span class="No-Break"><span class="koboSpan" id="kobo.2910.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2911.1">LobbyViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2912.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2913.1">Add the following namespaces to the top of </span><span class="No-Break"><span class="koboSpan" id="kobo.2914.1">the file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2915.1">
using System.Collections.ObjectModel;
using System.Collections.Specialized;
using CommunityToolkit.Mvvm.Messaging;
using SticksAndStones.Messages;
using SticksAndStones.Models;
using SticksAndStones.Services;</span></pre></li> <li><span class="koboSpan" id="kobo.2916.1">Modify </span><a id="_idIndexMarker1102"/><span class="koboSpan" id="kobo.2917.1">the class declaration to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2918.1">public partial</span></strong><span class="koboSpan" id="kobo.2919.1"> class that inherits from </span><strong class="source-inline"><span class="koboSpan" id="kobo.2920.1">ViewModelBase</span></strong><span class="koboSpan" id="kobo.2921.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.2922.1">as shown:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2923.1">public partial</span></strong><span class="koboSpan" id="kobo.2924.1"> class LobbyViewModel </span><strong class="bold"><span class="koboSpan" id="kobo.2925.1">: ViewModelBase</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2926.1">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2927.1">LobbyViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2928.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2929.1">
private readonly GameService gameService;
public ObservableCollection&lt;PlayerViewModel&gt; Players { get; init; }
public LobbyViewModel(GameService gameService)
{
    this.gameService = gameService;
    Players = new(from p in gameService.Players
                  where p.Id != gameService.CurrentPlayer.Id
                  select new PlayerViewModel(p, gameService));
    CanRefresh = true;
    IsActive = true;
}</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.2930.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.2931.1"> receives an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2932.1">GameService</span></strong><span class="koboSpan" id="kobo.2933.1"> via dependency injection. </span><span class="koboSpan" id="kobo.2933.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2934.1">gameService</span></strong><span class="koboSpan" id="kobo.2935.1"> instance is used to initialize the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2936.1">Players</span></strong><span class="koboSpan" id="kobo.2937.1"> list. </span><span class="koboSpan" id="kobo.2937.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2938.1">Players</span></strong><span class="koboSpan" id="kobo.2939.1"> property from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2940.1">GameService</span></strong><span class="koboSpan" id="kobo.2941.1"> class is a collection of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2942.1">Player</span></strong><span class="koboSpan" id="kobo.2943.1"> model, whereas </span><strong class="source-inline"><span class="koboSpan" id="kobo.2944.1">Players</span></strong><span class="koboSpan" id="kobo.2945.1"> in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2946.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.2947.1"> is an </span><strong class="source-inline"><span class="koboSpan" id="kobo.2948.1">ObservableCollection</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.2949.1">instance</span></strong><span class="koboSpan" id="kobo.2950.1"> of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2951.1">PlayerViewModel</span></strong><span class="koboSpan" id="kobo.2952.1">. </span><span class="koboSpan" id="kobo.2952.2">We use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2953.1">ObservableCollection</span></strong><span class="koboSpan" id="kobo.2954.1"> because it provides support for </span><strong class="source-inline"><span class="koboSpan" id="kobo.2955.1">INotifyPropertyChanged</span></strong><span class="koboSpan" id="kobo.2956.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2957.1">INotifyCollectionChanged</span></strong><span class="koboSpan" id="kobo.2958.1"> when it is </span><a id="_idIndexMarker1103"/><span class="koboSpan" id="kobo.2959.1">bound automatically. </span><span class="koboSpan" id="kobo.2959.2">A LINQ query is used to get all the current players and add them to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2960.1">Players</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.2961.1">ObservableCollection</span></strong><span class="koboSpan" id="kobo.2962.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2963.1">CanRefresh</span></strong><span class="koboSpan" id="kobo.2964.1"> from </span><strong class="source-inline"><span class="koboSpan" id="kobo.2965.1">ViewModelBase</span></strong><span class="koboSpan" id="kobo.2966.1"> is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2967.1">true</span></strong><span class="koboSpan" id="kobo.2968.1">, which enables </span><strong class="source-inline"><span class="koboSpan" id="kobo.2969.1">RefreshCommand</span></strong><span class="koboSpan" id="kobo.2970.1">. </span><span class="koboSpan" id="kobo.2970.2">Finally, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2971.1">IsActive</span></strong><span class="koboSpan" id="kobo.2972.1"> is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2973.1">true</span></strong><span class="koboSpan" id="kobo.2974.1">, which enables the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2975.1">OnActivated</span></strong><span class="koboSpan" id="kobo.2976.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2977.1">OnDeactivated</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2978.1"> events.</span></span></p></li> <li><span class="koboSpan" id="kobo.2979.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2980.1">GameService.Players</span></strong><span class="koboSpan" id="kobo.2981.1"> list will be updated as players connect to the server. </span><span class="koboSpan" id="kobo.2981.2">However, these changes do not get propagated to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2982.1">LobbyViewModel.Players</span></strong><span class="koboSpan" id="kobo.2983.1"> collection automatically. </span><span class="koboSpan" id="kobo.2983.2">By implementing a handler for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2984.1">CollectionChanged</span></strong><span class="koboSpan" id="kobo.2985.1"> event of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2986.1">GameService.Players</span></strong><span class="koboSpan" id="kobo.2987.1"> property, we can then update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2988.1">LobbyViewModel.Players</span></strong><span class="koboSpan" id="kobo.2989.1"> collection appropriately. </span><span class="koboSpan" id="kobo.2989.2">Add the following method to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2990.1">LobbyViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2991.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2992.1">
private void OnPlayersCollectionChanged(object? </span><span class="koboSpan" id="kobo.2992.2">sender, 
NotifyCollectionChangedEventArgs e)
{
    if (e.Action == NotifyCollectionChangedAction.Add)
    {
        foreach (var player in e.NewItems.Cast&lt;Player&gt;())
        {
            Players.Add(new PlayerViewModel(player, gameService));
        }
    }
    else if (e.Action == NotifyCollectionChangedAction.Remove)
    {
        foreach (var player in e.OldItems.Cast&lt;Player&gt;())
        {
            var toRemove = Players.FirstOrDefault(p =&gt; p.Id == player.Id);
            Players.Remove(toRemove);
        }
    }
    else if (e.Action == NotifyCollectionChangedAction.Replace)
    {
    }
    else if (e.Action == NotifyCollectionChangedAction.Reset)
    {
        Players.Clear();
    }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.2993.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2994.1">OnPlayersCollectionChanged</span></strong><span class="koboSpan" id="kobo.2995.1"> method is an implementation </span><span class="No-Break"><span class="koboSpan" id="kobo.2996.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2997.1">Notify</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.2998.1">
CollectionChangedEventHandler</span></strong><span class="koboSpan" id="kobo.2999.1">. </span><span class="koboSpan" id="kobo.2999.2">It is called by </span><span class="No-Break"><span class="koboSpan" id="kobo.3000.1">the </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3001.1">Observable</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.3002.1">
Collection.CollectionChanged</span></strong><span class="koboSpan" id="kobo.3003.1"> event. </span><span class="koboSpan" id="kobo.3003.2">The event is called </span><a id="_idIndexMarker1104"/><span class="koboSpan" id="kobo.3004.1">whenever an item in the collection is added, removed, or updated. </span><span class="koboSpan" id="kobo.3004.2">It is also called when the entire collection is cleared. </span><span class="koboSpan" id="kobo.3004.3">This method handled the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3005.1">NotifyCollectionChangedAction</span></strong><span class="koboSpan" id="kobo.3006.1"> values of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3007.1">Add</span></strong><span class="koboSpan" id="kobo.3008.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3009.1">Remove</span></strong><span class="koboSpan" id="kobo.3010.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.3011.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3012.1">Reset</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3013.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.3014.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3015.1">Players.CollectionChanged</span></strong><span class="koboSpan" id="kobo.3016.1"> event is assigned to </span><span class="No-Break"><span class="koboSpan" id="kobo.3017.1">the </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3018.1">OnPlayers</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.3019.1">
CollectionChanged</span></strong><span class="koboSpan" id="kobo.3020.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3021.1">OnActivated</span></strong><span class="koboSpan" id="kobo.3022.1"> event handler. </span><span class="koboSpan" id="kobo.3022.2">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3023.1">OnActivated</span></strong><span class="koboSpan" id="kobo.3024.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3025.1">OnDeactivated</span></strong><span class="koboSpan" id="kobo.3026.1"> methods using the </span><span class="No-Break"><span class="koboSpan" id="kobo.3027.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3028.1">
protected override void OnActivated()
{
    gameService.Players.CollectionChanged += OnPlayersCollectionChanged;
    // If the player has an in progress match, take them to it.
</span><span class="koboSpan" id="kobo.3028.2">    if (gameService.CurrentPlayer?.MatchId != Guid.Empty)
    {
        MainThread.InvokeOnMainThreadAsync(async () =&gt;
        {
            IsActive = false;
            await Shell.Current.GoToAsync(Constants.ArgumentNames.MatchId, new Dictionary&lt;string, object&gt;() { { "MatchId", gameService.CurrentPlayer.MatchId } });
        });
    }
}
protected override void OnDeactivated()
{
    gameService.Players.CollectionChanged -= OnPlayersCollectionChanged;
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3029.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3030.1">OnActivated</span></strong><span class="koboSpan" id="kobo.3031.1"> method, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3032.1">CollectionChanged</span></strong><span class="koboSpan" id="kobo.3033.1"> event is assigned to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3034.1">OnPlayersCollectionChanged</span></strong><span class="koboSpan" id="kobo.3035.1"> method and unassigned in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3036.1">OnDeactivated</span></strong><span class="koboSpan" id="kobo.3037.1"> method. </span><span class="koboSpan" id="kobo.3037.2">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.3038.1">OnActivated</span></strong><span class="koboSpan" id="kobo.3039.1">, there is also a check to see whether </span><a id="_idIndexMarker1105"/><span class="koboSpan" id="kobo.3040.1">the player is already in a match. </span><span class="koboSpan" id="kobo.3040.2">If they are, then the app navigates to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3041.1">Match</span></strong><span class="koboSpan" id="kobo.3042.1"> view immediately. </span><span class="koboSpan" id="kobo.3042.2">When navigating to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3043.1">Match</span></strong><span class="koboSpan" id="kobo.3044.1"> view, we send an argument for </span><strong class="source-inline"><span class="koboSpan" id="kobo.3045.1">Match</span></strong><span class="koboSpan" id="kobo.3046.1">. </span><span class="koboSpan" id="kobo.3046.2">This will be either the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3047.1">MatchId</span></strong><span class="koboSpan" id="kobo.3048.1"> or the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3049.1">Match</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3050.1"> model.</span></span></p></li> <li><span class="koboSpan" id="kobo.3051.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3052.1">Constants.cs</span></strong><span class="koboSpan" id="kobo.3053.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3054.1">SticksAndStones.Shared</span></strong><span class="koboSpan" id="kobo.3055.1"> project to add the following code snippet to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3056.1">Constants</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3057.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3058.1">
public class ArgumentNames
{
    public static readonly string Match = nameof(Match);
    public static readonly string MatchId = nameof(MatchId);
}</span></pre></li> <li><span class="koboSpan" id="kobo.3059.1">While </span><a id="_idIndexMarker1106"/><span class="koboSpan" id="kobo.3060.1">in the Lobby, there are three messages that need to be handled: </span><strong class="source-inline"><span class="koboSpan" id="kobo.3061.1">ChallengeReceived</span></strong><span class="koboSpan" id="kobo.3062.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3063.1">MatchStarted</span></strong><span class="koboSpan" id="kobo.3064.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3065.1">ServerError</span></strong><span class="koboSpan" id="kobo.3066.1">. </span><span class="koboSpan" id="kobo.3066.2">Add the code in the following listing to add the handlers for each of </span><span class="No-Break"><span class="koboSpan" id="kobo.3067.1">these messages:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3068.1">
private void OnChallengeReceived(Guid challengeId, Player opponent)
{
    MainThread.BeginInvokeOnMainThread(async () =&gt;
    {
        bool answer = await Shell.Current.CurrentPage.DisplayAlert("You have been challenged!", $"{opponent.GamerTag} has challenged you to a match of Sticks &amp; Stones, do you accept?", "Yes", "No");
        await gameService.SendChallengeResponse(challengeId, answer ? </span><span class="koboSpan" id="kobo.3068.2">Models.ChallengeResponse.Accepted : Models.ChallengeResponse.Declined);
    });
}
private void OnMatchStarted(Match match)
{
    MainThread.BeginInvokeOnMainThread(async () =&gt;
    {
        IsActive = false;
        await Shell.Current.GoToAsync($"///Match", new Dictionary&lt;string, object&gt;() { { Constants.ArgumentNames.Match, match } });
    });
}
private void OnServiceError(AsyncError error)
{
    MainThread.BeginInvokeOnMainThread(async () =&gt;
    {
        IsActive = false;
        await Shell.Current.CurrentPage.DisplayAlert("There is a problem...",error.Message, "Ok");
    });
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3069.1">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.3070.1">OnChallengeReceived</span></strong><span class="koboSpan" id="kobo.3071.1">, the user is prompted to accept or decline the challenge. </span><span class="koboSpan" id="kobo.3071.2">Their response is then sent to the challenger via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3072.1">SendChallengeResponse</span></strong><span class="koboSpan" id="kobo.3073.1"> method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3074.1">GameService</span></strong><span class="koboSpan" id="kobo.3075.1"> class. </span><strong class="source-inline"><span class="koboSpan" id="kobo.3076.1">OnMatchStarted</span></strong><span class="koboSpan" id="kobo.3077.1"> will navigate the user to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3078.1">Match</span></strong><span class="koboSpan" id="kobo.3079.1"> view. </span><span class="koboSpan" id="kobo.3079.2">Finally, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3080.1">OnServiceError</span></strong><span class="koboSpan" id="kobo.3081.1"> will display the error to </span><span class="No-Break"><span class="koboSpan" id="kobo.3082.1">the user.</span></span></p></li> <li><span class="koboSpan" id="kobo.3083.1">Add </span><a id="_idIndexMarker1107"/><span class="koboSpan" id="kobo.3084.1">the following snippet to the top of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3085.1">OnActivated</span></strong><span class="koboSpan" id="kobo.3086.1"> method to register to receive </span><span class="No-Break"><span class="koboSpan" id="kobo.3087.1">the messages:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3088.1">
Messenger.Register&lt;ChallengeRecieved&gt;(this, (r, m) =&gt; OnChallengeReceived(m.Id, m.Value));
Messenger.Register&lt;MatchStarted&gt;(this, (r, m) =&gt; OnMatchStarted(m.Value));
Messenger.Register&lt;ServiceError&gt;(this, (r, m) =&gt; OnServiceError(m.Value));</span></pre></li> <li><span class="koboSpan" id="kobo.3089.1">Add the following snippet to the end of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3090.1">OnDecactived</span></strong><span class="koboSpan" id="kobo.3091.1"> method to stop </span><span class="No-Break"><span class="koboSpan" id="kobo.3092.1">receiving messages:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3093.1">
Messenger.Unregister&lt;ChallengeRecieved&gt;(this);
Messenger.Unregister&lt;MatchStarted&gt;(this);
Messenger.Unregister&lt;ServiceError&gt;(this);</span></pre></li> <li><span class="koboSpan" id="kobo.3094.1">To refresh the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3095.1">Players</span></strong><span class="koboSpan" id="kobo.3096.1"> list when the user pulls down on the list in the UI, add the </span><a id="_idIndexMarker1108"/><span class="koboSpan" id="kobo.3097.1">following method to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3098.1">LobbyViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3099.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3100.1">
protected override async Task RefreshInternal()
{
    await gameService.RefreshPlayerList();
    return;
}</span></pre></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.3101.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.3102.1"> needs to be registered with dependency injection, so open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3103.1">MauiProgram.cs</span></strong><span class="koboSpan" id="kobo.3104.1"> file and add the following highlighted line </span><span class="No-Break"><span class="koboSpan" id="kobo.3105.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3106.1">
builder.Services.AddTransient&lt;ViewModels.ConnectViewModel&gt;();
</span><strong class="bold"><span class="koboSpan" id="kobo.3107.1">builder.Services.AddTransient&lt;ViewModels.LobbyViewModel&gt;();</span></strong><span class="koboSpan" id="kobo.3108.1">
builder.Services.AddTransient&lt;Views.ConnectView&gt;();</span></pre></li> </ol>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.3109.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.3110.1"> is now complete, and it is time to create </span><span class="No-Break"><span class="koboSpan" id="kobo.3111.1">the view!</span></span></p>
<h3><span class="koboSpan" id="kobo.3112.1">Adding the Lobby view</span></h3>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.3113.1">The Lobby</span></strong><span class="koboSpan" id="kobo.3114.1"> view simply displays a list of connected players with their avatar, gamertag and current status. </span><span class="koboSpan" id="kobo.3114.2">To build the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3115.1">LobbyView</span></strong><span class="koboSpan" id="kobo.3116.1"> follow </span><span class="No-Break"><span class="koboSpan" id="kobo.3117.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.3118.1">Right-click on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3119.1">Views</span></strong><span class="koboSpan" id="kobo.3120.1"> folder of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3121.1">SticksAndStone.App</span></strong><span class="koboSpan" id="kobo.3122.1"> project, select </span><strong class="bold"><span class="koboSpan" id="kobo.3123.1">Add</span></strong><span class="koboSpan" id="kobo.3124.1">, and then click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.3125.1">New Item...</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3126.1">.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.3127.1">If you </span><a id="_idIndexMarker1109"/><span class="koboSpan" id="kobo.3128.1">are using Visual Studio 17.7 or later, click the </span><strong class="bold"><span class="koboSpan" id="kobo.3129.1">Show all Templates</span></strong><span class="koboSpan" id="kobo.3130.1"> button in the dialog that pops up; otherwise, move to the </span><span class="No-Break"><span class="koboSpan" id="kobo.3131.1">next step.</span></span></p></li>
<li><span class="koboSpan" id="kobo.3132.1">Under the </span><strong class="bold"><span class="koboSpan" id="kobo.3133.1">C# Items</span></strong><span class="koboSpan" id="kobo.3134.1"> node on the left, select </span><strong class="bold"><span class="koboSpan" id="kobo.3135.1">.</span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.3136.1">NET MAUI</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3137.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.3138.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.3139.1">.NET MAUI </span></strong><strong class="bold"><span class="koboSpan" id="kobo.3140.1">ContentPage</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3141.1"> (XAML)</span></strong><span class="koboSpan" id="kobo.3142.1"> and name </span><span class="No-Break"><span class="koboSpan" id="kobo.3143.1">it </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3144.1">LobbyView.xaml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3145.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.3146.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.3147.1">Add</span></strong><span class="koboSpan" id="kobo.3148.1"> to create </span><span class="No-Break"><span class="koboSpan" id="kobo.3149.1">the page.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.3150.1">Refer to the following screenshot to view the </span><span class="No-Break"><span class="koboSpan" id="kobo.3151.1">preceding information:</span></span></p><div class="IMG---Figure" id="_idContainer176"><span class="koboSpan" id="kobo.3152.1"><img alt="" role="presentation" src="image/B19214_10_11.jpg"/></span></div></li>
</ol>
<p class="IMG---Figure"> </p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3153.1">Figure 10.11 – Adding a new .NET MAUI ContentPage (XAML)</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.3154.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3155.1">LobbyView.xaml.cs</span></strong><span class="koboSpan" id="kobo.3156.1"> file and add the following </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3157.1">using</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3158.1"> declaration:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3159.1">
using SticksAndStones.ViewModels;</span></pre></li> <li><span class="koboSpan" id="kobo.3160.1">Make the following highlighted changes to </span><span class="No-Break"><span class="koboSpan" id="kobo.3161.1">the constructor:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3162.1">
public LobbyView(</span><strong class="bold"><span class="koboSpan" id="kobo.3163.1">LobbyViewModel viewModel</span></strong><span class="koboSpan" id="kobo.3164.1">)
{
</span><strong class="bold"><span class="koboSpan" id="kobo.3165.1">    this.BindingContext = viewModel;</span></strong><span class="koboSpan" id="kobo.3166.1">
    InitializeComponent();
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3167.1">These </span><a id="_idIndexMarker1110"/><span class="koboSpan" id="kobo.3168.1">changes allow for dependency injection to supply the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3169.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.3170.1"> instance to the view, which is then assigned </span><span class="No-Break"><span class="koboSpan" id="kobo.3171.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3172.1">BindingContext</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3173.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.3174.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3175.1">AppShell.xaml</span></strong><span class="koboSpan" id="kobo.3176.1"> file and add the following code snippet to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3177.1">ContentPage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3178.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3179.1">
&lt;ShellItem Route="Lobby"&gt;
    &lt;ShellContent ContentTemplate="{DataTemplate views:LobbyView}" /&gt;
&lt;/ShellItem&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3180.1">This registers the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3181.1">"Lobby"</span></strong><span class="koboSpan" id="kobo.3182.1"> route and directs it </span><span class="No-Break"><span class="koboSpan" id="kobo.3183.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3184.1">LobbyView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3185.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.3186.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3187.1">MauiProgram.cs</span></strong><span class="koboSpan" id="kobo.3188.1"> file and add the following highlighted line </span><span class="No-Break"><span class="koboSpan" id="kobo.3189.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3190.1">
builder.Services.AddTransient&lt;Views.ConnectView&gt;();
</span><strong class="bold"><span class="koboSpan" id="kobo.3191.1">builder.Services.AddTransient&lt;Views.LobbyView&gt;();</span></strong><span class="koboSpan" id="kobo.3192.1">
return builder.Build();</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3193.1">This will register </span><strong class="source-inline"><span class="koboSpan" id="kobo.3194.1">LobbyView</span></strong><span class="koboSpan" id="kobo.3195.1"> with dependency injection so that </span><strong class="source-inline"><span class="koboSpan" id="kobo.3196.1">DataTemplate</span></strong><span class="koboSpan" id="kobo.3197.1"> can </span><span class="No-Break"><span class="koboSpan" id="kobo.3198.1">locate it.</span></span></p></li> <li><span class="koboSpan" id="kobo.3199.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3200.1">LobbyView.xaml</span></strong><span class="koboSpan" id="kobo.3201.1"> file and change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3202.1">Title</span></strong><span class="koboSpan" id="kobo.3203.1"> attribute of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3204.1">ContentPage</span></strong><span class="koboSpan" id="kobo.3205.1"> element </span><span class="No-Break"><span class="koboSpan" id="kobo.3206.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3207.1">"Lobby"</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3208.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.3209.1">Add </span><a id="_idIndexMarker1111"/><span class="koboSpan" id="kobo.3210.1">the following highlighted namespaces to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3211.1">LobbyView</span></strong><span class="koboSpan" id="kobo.3212.1"> element; they will provide us access to the classes in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3213.1">ViewModels</span></strong><span class="koboSpan" id="kobo.3214.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3215.1">Controls</span></strong><span class="koboSpan" id="kobo.3216.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3217.1">Toolkit</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3218.1"> namespaces:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3219.1">
&lt;ContentPage xmlns=“http://schemas.microsoft.com/dotnet/2021/maui”
             xmlns:x=“http://schemas.microsoft.com/winfx/2009/xaml”
</span><strong class="bold"><span class="koboSpan" id="kobo.3220.1">        xmlns:viewModels=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3221.1">“</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3222.1">clr-namespace:SticksAndStones.ViewModels</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3223.1">”</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.3224.1">        xmlns:controls=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3225.1">“</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3226.1">clr-namespace:SticksAndStones.Controls</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3227.1">”</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.3228.1">        xmlns:toolkit=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3229.1">“</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.3230.1">http://schemas.microsoft.com/dotnet/2022/maui/toolkit</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3231.1">”</span></strong><span class="koboSpan" id="kobo.3232.1">
             x:Class=“SticksAndStones.Views.LobbyView”&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.3233.1">To make IntelliSense happy with the bindings we will be adding, define the view model that the view is using by adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3234.1">x:DataType</span></strong><span class="koboSpan" id="kobo.3235.1"> attribute to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3236.1">LobbyView</span></strong><span class="koboSpan" id="kobo.3237.1"> element, </span><span class="No-Break"><span class="koboSpan" id="kobo.3238.1">as shown:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3239.1">
&lt;ContentPage xmlns=“http://schemas.microsoft.com/dotnet/2021/maui”
             xmlns:x=“http://schemas.microsoft.com/winfx/2009/xaml”
        xmlns:viewModels=“clr-namespace:SticksAndStones.ViewModels”
        xmlns:controls=“clr-namespace:SticksAndStones.Controls”
        xmlns:toolkit=“ http://schemas.microsoft.com/dotnet/2022/maui/toolkit”
        </span><strong class="bold"><span class="koboSpan" id="kobo.3240.1">x:DataType=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3241.1">“</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3242.1">viewModels:LobbyViewModel</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3243.1">”</span></strong><span class="koboSpan" id="kobo.3244.1">
             x:Class=“SticksAndStones.Views.LobbyView”&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.3245.1">We </span><a id="_idIndexMarker1112"/><span class="koboSpan" id="kobo.3246.1">don’t want the user to use any navigation, such as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3247.1">Shell</span></strong><span class="koboSpan" id="kobo.3248.1">-provided </span><strong class="source-inline"><span class="koboSpan" id="kobo.3249.1">Back</span></strong><span class="koboSpan" id="kobo.3250.1"> button, other than what is provided on this page, so disable it using the highlighted code in the </span><span class="No-Break"><span class="koboSpan" id="kobo.3251.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3252.1">
&lt;ContentPage xmlns=“http://schemas.microsoft.com/dotnet/2021/maui”
             xmlns:x=“http://schemas.microsoft.com/winfx/2009/xaml”
        xmlns:viewModels=“clr-namespace:SticksAndStones.ViewModels”
        xmlns:controls=“clr-namespace:SticksAndStones.Controls”
        xmlns:toolkit=“ http://schemas.microsoft.com/dotnet/2022/maui/toolkit”
        x:Class=“SticksAndStones.Views.LobbyView”
        x:DataType=“viewModels:LobbyViewModel”
        </span><strong class="bold"><span class="koboSpan" id="kobo.3253.1">NavigationPage.HasNavigationBar=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3254.1">“</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3255.1">False</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3256.1">”</span></strong><span class="koboSpan" id="kobo.3257.1">&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.3258.1">Finally, set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3259.1">BackgroundColor</span></strong><span class="koboSpan" id="kobo.3260.1"> value of the entire view to </span><strong class="source-inline"><span class="koboSpan" id="kobo.3261.1">White</span></strong><span class="koboSpan" id="kobo.3262.1">, which will make the images blend better, by adding the following </span><span class="No-Break"><span class="koboSpan" id="kobo.3263.1">highlighted code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3264.1">
&lt;ContentPage xmlns=“http://schemas.microsoft.com/dotnet/2021/maui”
              xmlns:x=“http://schemas.microsoft.com/winfx/2009/xaml”
        xmlns:viewModels=“clr-namespace:SticksAndStones.ViewModels”
        xmlns:controls=“clr-namespace:SticksAndStones.Controls”
        xmlns:toolkit=“ http://schemas.microsoft.com/dotnet/2022/maui/toolkit”
             x:Class=“SticksAndStones.Views.ConnectView”
        x:DataType=“viewModels:ConnectViewModel”
        Title=“ConnectView”
        NavigationPage.HasNavigationBar=“False”
        </span><strong class="bold"><span class="koboSpan" id="kobo.3265.1">BackgroundColor=</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3266.1">“</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3267.1">White</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3268.1">”</span></strong><span class="koboSpan" id="kobo.3269.1">&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.3270.1">Replace </span><a id="_idIndexMarker1113"/><span class="koboSpan" id="kobo.3271.1">the contents of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3272.1">ContentPage</span></strong><span class="koboSpan" id="kobo.3273.1"> with the following </span><span class="No-Break"><span class="koboSpan" id="kobo.3274.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3275.1">
&lt;RefreshView IsRefreshing=“{Binding IsRefreshing}” Command=“{Binding RefreshCommand}”&gt;
    &lt;ScrollView Padding=“5”&gt;
        &lt;CollectionView ItemsSource=“{Binding Players}” Margin=”5,5,5,0 SelectionMode=“None”&gt;
        &lt;/CollectionView&gt;
    &lt;/ScrollView&gt;
&lt;/RefreshView&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3276.1">For </span><strong class="source-inline"><span class="koboSpan" id="kobo.3277.1">LobbyView</span></strong><span class="koboSpan" id="kobo.3278.1">, there is a vertical scrolling list of players. </span><span class="koboSpan" id="kobo.3278.2">The root element is </span><strong class="source-inline"><span class="koboSpan" id="kobo.3279.1">RefreshView</span></strong><span class="koboSpan" id="kobo.3280.1">. </span><span class="koboSpan" id="kobo.3280.2">Its </span><strong class="source-inline"><span class="koboSpan" id="kobo.3281.1">IsRefreshing</span></strong><span class="koboSpan" id="kobo.3282.1"> attribute is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3283.1">IsRefreshing</span></strong><span class="koboSpan" id="kobo.3284.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3285.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.3286.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.3287.1">The</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.3288.1">Command</span></strong><span class="koboSpan" id="kobo.3289.1"> attribute for </span><strong class="source-inline"><span class="koboSpan" id="kobo.3290.1">RefreshView</span></strong><span class="koboSpan" id="kobo.3291.1"> is bound to </span><strong class="source-inline"><span class="koboSpan" id="kobo.3292.1">RefreshCommand</span></strong><span class="koboSpan" id="kobo.3293.1">, which will end up executing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3294.1">RefreshInternal</span></strong><span class="koboSpan" id="kobo.3295.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3296.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.3297.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.3298.1">IsRefreshing</span></strong><span class="koboSpan" id="kobo.3299.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3300.1">RefreshCommand</span></strong><span class="koboSpan" id="kobo.3301.1"> are implemented in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3302.1">BaseViewModel</span></strong><span class="koboSpan" id="kobo.3303.1"> class. </span><span class="koboSpan" id="kobo.3303.2">Inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.3304.1">RefreshView</span></strong><span class="koboSpan" id="kobo.3305.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.3306.1">ScrollView</span></strong><span class="koboSpan" id="kobo.3307.1">, which provides scrolling capability to have a large list. </span><span class="koboSpan" id="kobo.3307.2">Inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.3308.1">ScrollView</span></strong><span class="koboSpan" id="kobo.3309.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.3310.1">CollectionView</span></strong><span class="koboSpan" id="kobo.3311.1">, which will display each </span><strong class="source-inline"><span class="koboSpan" id="kobo.3312.1">Player</span></strong><span class="koboSpan" id="kobo.3313.1"> instance as an individual item, so </span><strong class="source-inline"><span class="koboSpan" id="kobo.3314.1">ItemsSource</span></strong><span class="koboSpan" id="kobo.3315.1"> is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3316.1">Players</span></strong><span class="koboSpan" id="kobo.3317.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3318.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.3319.1">. </span><span class="koboSpan" id="kobo.3319.2">As there is no real need to select individual </span><strong class="source-inline"><span class="koboSpan" id="kobo.3320.1">Player</span></strong><span class="koboSpan" id="kobo.3321.1"> items, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3322.1">SelectionMode</span></strong><span class="koboSpan" id="kobo.3323.1"> is set </span><span class="No-Break"><span class="koboSpan" id="kobo.3324.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3325.1">none</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3326.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.3327.1">When the list is empty, it is nice to display something to the user so that they aren’t left wondering what happened. </span><strong class="source-inline"><span class="koboSpan" id="kobo.3328.1">CollectionView</span></strong><span class="koboSpan" id="kobo.3329.1"> has an </span><strong class="source-inline"><span class="koboSpan" id="kobo.3330.1">EmptyView</span></strong><span class="koboSpan" id="kobo.3331.1"> property </span><a id="_idIndexMarker1114"/><span class="koboSpan" id="kobo.3332.1">that is used to configure what is displayed when there are no items. </span><span class="koboSpan" id="kobo.3332.2">Add the following code snippet immediately following the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3333.1">ContentPage</span></strong><span class="koboSpan" id="kobo.3334.1"> start </span><span class="No-Break"><span class="koboSpan" id="kobo.3335.1">opening tag</span></span><span class="No-Break"><span class="koboSpan" id="kobo.3336.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3337.1">
&lt;ContentPage.Resources&gt;
    &lt;ContentView x:Key="BasicEmptyView"&gt;
        &lt;StackLayout&gt;
            &lt;Label Text="No players available"
                   Margin="10,25,10,10"
                   FontAttributes="Bold"
                   FontSize="18"
                   HorizontalOptions="Fill"
                   HorizontalTextAlignment="Center" /&gt;
        &lt;/StackLayout&gt;
    &lt;/ContentView&gt;
&lt;/ContentPage.Resources&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3338.1">This defines a page resource containing </span><strong class="source-inline"><span class="koboSpan" id="kobo.3339.1">ContentView</span></strong><span class="koboSpan" id="kobo.3340.1"> with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.3341.1">Key</span></strong><span class="koboSpan" id="kobo.3342.1"> value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3343.1">"BasicEmptyView"</span></strong><span class="koboSpan" id="kobo.3344.1">. </span><span class="koboSpan" id="kobo.3344.2">The view contains </span><strong class="source-inline"><span class="koboSpan" id="kobo.3345.1">StackLayout</span></strong><span class="koboSpan" id="kobo.3346.1">, which has </span><strong class="source-inline"><span class="koboSpan" id="kobo.3347.1">Label</span></strong><span class="koboSpan" id="kobo.3348.1"> as a child with the text </span><strong class="source-inline"><span class="koboSpan" id="kobo.3349.1">"No players available"</span></strong><span class="koboSpan" id="kobo.3350.1">. </span><span class="koboSpan" id="kobo.3350.2">Appropriate styling is applied to make sure it’s large enough and has enough </span><span class="No-Break"><span class="koboSpan" id="kobo.3351.1">surrounding whitespace.</span></span></p></li> <li><span class="koboSpan" id="kobo.3352.1"> Add the </span><a id="_idIndexMarker1115"/><span class="koboSpan" id="kobo.3353.1">following attribute to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3354.1">CollectionView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3355.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3356.1">
EmptyView="{StaticResource BasicEmptyView}"</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3357.1">This binds </span><strong class="source-inline"><span class="koboSpan" id="kobo.3358.1">BasicEmptyView</span></strong><span class="koboSpan" id="kobo.3359.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3360.1">EmptyView</span></strong><span class="koboSpan" id="kobo.3361.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3362.1">CollectionView</span></strong><span class="koboSpan" id="kobo.3363.1">. </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3364.1">Figure 10</span></em></span><em class="italic"><span class="koboSpan" id="kobo.3365.1">.12</span></em><span class="koboSpan" id="kobo.3366.1"> shows the result if you run the app and </span><span class="No-Break"><span class="koboSpan" id="kobo.3367.1">log in:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer177">
<span class="koboSpan" id="kobo.3368.1"><img alt="Figure 10.12 – Lobby with no players" src="image/B19214_10_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3369.1">Figure 10.12 – Lobby with no players</span></p>
<ol>
<li value="17"><span class="koboSpan" id="kobo.3370.1">The player card will also use a static resource, which just makes the file a little easier to read, and less indenting. </span><span class="koboSpan" id="kobo.3370.2">Add the following code snippet to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3371.1">ContentView.Resources</span></strong><span class="koboSpan" id="kobo.3372.1"> element, under the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3373.1">BasicEmptyView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3374.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3375.1">
&lt;DataTemplate x:Key="PlayerCardViewTemplate" x:DataType="viewModels:PlayerViewModel"&gt;
    &lt;ContentView&gt;
        &lt;Border StrokeShape="RoundRectangle 10,10,10,10" BackgroundColor="AntiqueWhite" Padding="3,3,3,3" Margin="5,5,5,5"&gt;
            &lt;Grid&gt;
                &lt;Grid.ColumnDefinitions&gt;
                    &lt;ColumnDefinition Width="50" /&gt;
                    &lt;ColumnDefinition Width="4*" /&gt;
                    &lt;ColumnDefinition Width="2*" /&gt;
                &lt;/Grid.ColumnDefinitions&gt;
                &lt;toolkit:AvatarView Grid.Column="0" Margin="0" BackgroundColor="LightGrey" HeightRequest="48" WidthRequest="48" CornerRadius="25" VerticalOptions="Center" HorizontalOptions="Center"&gt;
                    &lt;toolkit:AvatarView.ImageSource&gt;
                        &lt;toolkit:GravatarImageSource
                            Email="{Binding EmailAddress}"
                            Image="MysteryPerson" /&gt;
                    &lt;/toolkit:AvatarView.ImageSource&gt;
                &lt;/toolkit:AvatarView&gt;
                &lt;VerticalStackLayout Grid.Column="1" Margin="10,0,0,0"&gt;
                    &lt;Label Text="{Binding GamerTag}" HorizontalTextAlignment="Start" FontSize="Large" BackgroundColor="AntiqueWhite" /&gt;
                    &lt;Label Text="{Binding Status}" HorizontalTextAlignment="Start" FontSize="Caption" BackgroundColor="AntiqueWhite"/&gt;
                &lt;/VerticalStackLayout&gt;
                &lt;controls:ActivityButton Grid.Column="2" IsRunning="{Binding IsChallenging}" Text="{Binding ChallengeStatus}" BackgroundColor="#e8bc65" Command="{Binding ChallengeCommand}" CommandParameter="{Binding .}" IsVisible="{Binding CanChallenge}" Margin="5"/&gt;
            &lt;/Grid&gt;
        &lt;/Border&gt;
    &lt;/ContentView&gt;
&lt;/DataTemplate&gt;</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.3376.1">DataTemplate</span></strong><span class="koboSpan" id="kobo.3377.1"> will display the player’s avatar. </span><span class="koboSpan" id="kobo.3377.2">To do so, it will use an </span><strong class="source-inline"><span class="koboSpan" id="kobo.3378.1">Image</span></strong><span class="koboSpan" id="kobo.3379.1"> control </span><a id="_idIndexMarker1116"/><span class="koboSpan" id="kobo.3380.1">and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3381.1">GravatarImageSource</span></strong><span class="koboSpan" id="kobo.3382.1"> the same way as was done in the </span><em class="italic"><span class="koboSpan" id="kobo.3383.1">Creating the Connect view</span></em><span class="koboSpan" id="kobo.3384.1"> section. </span><span class="koboSpan" id="kobo.3384.2">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.3385.1">DataTemplate</span></strong><span class="koboSpan" id="kobo.3386.1"> element is needed since this is used for </span><strong class="source-inline"><span class="koboSpan" id="kobo.3387.1">ItemTemplate</span></strong><span class="koboSpan" id="kobo.3388.1">, then the obligatory </span><strong class="source-inline"><span class="koboSpan" id="kobo.3389.1">ContentView</span></strong><span class="koboSpan" id="kobo.3390.1">. </span><span class="koboSpan" id="kobo.3390.2">Then, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3391.1">Border</span></strong><span class="koboSpan" id="kobo.3392.1"> is defined. </span><span class="koboSpan" id="kobo.3392.2">It uses a special </span><strong class="source-inline"><span class="koboSpan" id="kobo.3393.1">Stroke</span></strong><span class="koboSpan" id="kobo.3394.1"> shape to round out the edges of the rectangle instead of having square corners, and a color of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3395.1">AntiqueWhite</span></strong><span class="koboSpan" id="kobo.3396.1"> is applied as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3397.1">BackgroundColor</span></strong><span class="koboSpan" id="kobo.3398.1"> value. </span><span class="koboSpan" id="kobo.3398.2">Additional shapes to use for </span><strong class="source-inline"><span class="koboSpan" id="kobo.3399.1">Border</span></strong><span class="koboSpan" id="kobo.3400.1"> include </span><strong class="source-inline"><span class="koboSpan" id="kobo.3401.1">Ellipse</span></strong><span class="koboSpan" id="kobo.3402.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3403.1">Line</span></strong><span class="koboSpan" id="kobo.3404.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3405.1">Path</span></strong><span class="koboSpan" id="kobo.3406.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3407.1">Polygon</span></strong><span class="koboSpan" id="kobo.3408.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3409.1">Polyline</span></strong><span class="koboSpan" id="kobo.3410.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3411.1">Rectangle</span></strong><span class="koboSpan" id="kobo.3412.1">. </span><span class="koboSpan" id="kobo.3412.2">See the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3413.1">Border</span></strong><span class="koboSpan" id="kobo.3414.1"> documentation at </span><a href="https://learn.microsoft.com/en-us/dotnet/maui/user-interface/controls/border"><span class="koboSpan" id="kobo.3415.1">https://learn.microsoft.com/en-us/dotnet/maui/user-interface/controls/border</span></a><span class="koboSpan" id="kobo.3416.1"> for more details. </span><span class="koboSpan" id="kobo.3416.2">Inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.3417.1">Border</span></strong><span class="koboSpan" id="kobo.3418.1">, there is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.3419.1">Grid</span></strong><span class="koboSpan" id="kobo.3420.1"> control that defines three columns. </span><span class="koboSpan" id="kobo.3420.2">The first column contains the avatar image and has a width of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3421.1">50</span></strong><span class="koboSpan" id="kobo.3422.1">, the next column contains the gamer tag and the status of the player, stacked vertically, and the third column contains the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3423.1">Challenge</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3424.1"> button.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.3425.1">For the avatar, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3426.1">AvatarView</span></strong><span class="koboSpan" id="kobo.3427.1"> control from </span><strong class="source-inline"><span class="koboSpan" id="kobo.3428.1">CommunityToolkit</span></strong><span class="koboSpan" id="kobo.3429.1"> is used. </span><span class="koboSpan" id="kobo.3429.2">It provides a round version of </span><span class="No-Break"><span class="koboSpan" id="kobo.3430.1">the image.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.3431.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3432.1">Challenge</span></strong><span class="koboSpan" id="kobo.3433.1"> button uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3434.1">ActivityButton</span></strong><span class="koboSpan" id="kobo.3435.1"> control, and is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3436.1">IsChallenging</span></strong><span class="koboSpan" id="kobo.3437.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3438.1">CanChallenge</span></strong><span class="koboSpan" id="kobo.3439.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3440.1">ChallengeStatus</span></strong><span class="koboSpan" id="kobo.3441.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3442.1">ChallengeCommand</span></strong><span class="koboSpan" id="kobo.3443.1"> properties </span><span class="No-Break"><span class="koboSpan" id="kobo.3444.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3445.1">PlayerViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3446.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.3447.1">To use </span><strong class="source-inline"><span class="koboSpan" id="kobo.3448.1">PlayerCardViewTemplate</span></strong><span class="koboSpan" id="kobo.3449.1"> as </span><strong class="source-inline"><span class="koboSpan" id="kobo.3450.1">ItemTemplate</span></strong><span class="koboSpan" id="kobo.3451.1"> of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3452.1">CollectionView</span></strong><span class="koboSpan" id="kobo.3453.1">, add the following attribute to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3454.1">CollectionView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3455.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3456.1">
ItemTemplate="{StaticResource PlayerCardViewTemplate}"</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.3457.1">That </span><a id="_idIndexMarker1117"/><span class="koboSpan" id="kobo.3458.1">completes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3459.1">Lobby</span></strong><span class="koboSpan" id="kobo.3460.1"> page. </span><span class="koboSpan" id="kobo.3460.2">At this point, you should be able to launch </span><strong class="source-inline"><span class="koboSpan" id="kobo.3461.1">SticksAndStone.Functions</span></strong><span class="koboSpan" id="kobo.3462.1"> and connect with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3463.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.3464.1"> project to see the different layouts provided by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3465.1">Lobby</span></strong><span class="koboSpan" id="kobo.3466.1"> view. </span><span class="koboSpan" id="kobo.3466.2">There is only one more page to create to complete the game, and that is the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3467.1">Match</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3468.1"> page.</span></span></p>
<h2 id="_idParaDest-172"><a id="_idTextAnchor890"/><span class="koboSpan" id="kobo.3469.1">Creating the Match page</span></h2>
<p><span class="koboSpan" id="kobo.3470.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3471.1">Match</span></strong><span class="koboSpan" id="kobo.3472.1"> page displays the game board with the players and score. </span><span class="koboSpan" id="kobo.3472.2">It also manages the </span><a id="_idIndexMarker1118"/><span class="koboSpan" id="kobo.3473.1">gameplay, allowing each player to take their turn placing a stick. </span><span class="koboSpan" id="kobo.3473.2">As each player takes their turn, the board updates to show the current state of the match. </span><span class="koboSpan" id="kobo.3473.3">Let’s get started with creating the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3474.1">ViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3475.1"> classes.</span></span></p>
<h3><span class="koboSpan" id="kobo.3476.1">Creating the ViewModel classes</span></h3>
<p><span class="koboSpan" id="kobo.3477.1">There </span><a id="_idIndexMarker1119"/><span class="koboSpan" id="kobo.3478.1">are two </span><a id="_idIndexMarker1120"/><span class="koboSpan" id="kobo.3479.1">different </span><strong class="source-inline"><span class="koboSpan" id="kobo.3480.1">ViewModel</span></strong><span class="koboSpan" id="kobo.3481.1"> classes used in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3482.1">Match</span></strong><span class="koboSpan" id="kobo.3483.1"> page, just as there were in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3484.1">Lobby</span></strong><span class="koboSpan" id="kobo.3485.1"> page, one for the game and a second for the </span><span class="No-Break"><span class="koboSpan" id="kobo.3486.1">player details.</span></span></p>
<h4><span class="koboSpan" id="kobo.3487.1">Adding MatchPlayerViewModel</span></h4>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.3488.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.3489.1"> is the </span><a id="_idIndexMarker1121"/><span class="koboSpan" id="kobo.3490.1">abstraction between the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3491.1">Player</span></strong><span class="koboSpan" id="kobo.3492.1"> model and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3493.1">MatchView</span></strong><span class="koboSpan" id="kobo.3494.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.3495.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.3496.1"> needs to expose the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3497.1">Id</span></strong><span class="koboSpan" id="kobo.3498.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3499.1">GamerTag</span></strong><span class="koboSpan" id="kobo.3500.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3501.1">EmailAddress</span></strong><span class="koboSpan" id="kobo.3502.1"> values from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3503.1">Player</span></strong><span class="koboSpan" id="kobo.3504.1"> model to </span><strong class="source-inline"><span class="koboSpan" id="kobo.3505.1">MatchView</span></strong><span class="koboSpan" id="kobo.3506.1">. </span><span class="koboSpan" id="kobo.3506.2">In addition, since each player has a score, the player’s score from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3507.1">Match</span></strong><span class="koboSpan" id="kobo.3508.1"> model is exposed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.3509.1">MatchView</span></strong><span class="koboSpan" id="kobo.3510.1">. </span><span class="koboSpan" id="kobo.3510.2">There are a couple of additional properties that are needed </span><span class="No-Break"><span class="koboSpan" id="kobo.3511.1">as well:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3512.1">IsPlayersTurn</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3513.1">:</span></span><p class="list-inset"><span class="koboSpan" id="kobo.3514.1">This is used to determine whether </span><strong class="source-inline"><span class="koboSpan" id="kobo.3515.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.3516.1"> is the </span><span class="No-Break"><span class="koboSpan" id="kobo.3517.1">current player.</span></span></p></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3518.1">PlayerToken</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3519.1">:</span></span><p class="list-inset"><span class="koboSpan" id="kobo.3520.1">This is used to map each player to a token to track which player has placed which stick. </span><span class="koboSpan" id="kobo.3520.2">A token, either </span><strong class="source-inline"><span class="koboSpan" id="kobo.3521.1">-1</span></strong><span class="koboSpan" id="kobo.3522.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.3523.1">1</span></strong><span class="koboSpan" id="kobo.3524.1">, is used because it makes determining a winner easier than if it was using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3525.1">Id</span></strong><span class="koboSpan" id="kobo.3526.1"> property, which is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.3527.1">Guid</span></strong><span class="koboSpan" id="kobo.3528.1">. </span><span class="koboSpan" id="kobo.3528.2">Review the </span><em class="italic"><span class="koboSpan" id="kobo.3529.1">Processing turns section of </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3530.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.3531.1">, for a refresher on how the winner </span><span class="No-Break"><span class="koboSpan" id="kobo.3532.1">is determined</span></span><span class="No-Break"><span class="koboSpan" id="kobo.3533.1">.</span></span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.3534.1"> To </span><a id="_idIndexMarker1122"/><span class="koboSpan" id="kobo.3535.1">create </span><strong class="source-inline"><span class="koboSpan" id="kobo.3536.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.3537.1">, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.3538.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.3539.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.3540.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.3541.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3542.1">ViewModels</span></strong><span class="koboSpan" id="kobo.3543.1"> folder of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3544.1">SticksAndStones.App</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3545.1"> project.</span></span></li>
<li><span class="koboSpan" id="kobo.3546.1">Modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3547.1">using</span></strong><span class="koboSpan" id="kobo.3548.1"> declarations to the following at the top of </span><span class="No-Break"><span class="koboSpan" id="kobo.3549.1">the file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3550.1">
using CommunityToolkit.Mvvm.ComponentModel;
using SticksAndStones.Models;</span></pre></li> <li><span class="koboSpan" id="kobo.3551.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3552.1">public</span></strong><span class="koboSpan" id="kobo.3553.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3554.1">partial</span></strong><span class="koboSpan" id="kobo.3555.1"> modifiers to the class and make it inherit from </span><strong class="source-inline"><span class="koboSpan" id="kobo.3556.1">ObservableObject</span></strong><span class="koboSpan" id="kobo.3557.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.3558.1">as shown:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.3559.1">public partial</span></strong><span class="koboSpan" id="kobo.3560.1"> class MatchPlayerViewModel: </span><strong class="bold"><span class="koboSpan" id="kobo.3561.1">ObservableObject</span></strong><span class="koboSpan" id="kobo.3562.1">
{
}</span></pre></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.3563.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.3564.1"> is an abstraction of both the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3565.1">Player</span></strong><span class="koboSpan" id="kobo.3566.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3567.1">Match</span></strong><span class="koboSpan" id="kobo.3568.1"> models, which will be passed in through the constructor. </span><span class="koboSpan" id="kobo.3568.2">Create the fields and the constructor, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.3569.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3570.1">
private readonly Player playerModel;
private readonly Match matchModel;
public MatchPlayerViewModel(Player player, Match match)
{
    this.playerModel = player;
    this.matchModel = match;
}</span></pre></li> <li><span class="koboSpan" id="kobo.3571.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3572.1">PlayerToken</span></strong><span class="koboSpan" id="kobo.3573.1"> property is </span><strong class="source-inline"><span class="koboSpan" id="kobo.3574.1">1</span></strong><span class="koboSpan" id="kobo.3575.1"> if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3576.1">Player</span></strong><span class="koboSpan" id="kobo.3577.1"> model is </span><strong class="source-inline"><span class="koboSpan" id="kobo.3578.1">PlayerOne</span></strong><span class="koboSpan" id="kobo.3579.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3580.1">Match</span></strong><span class="koboSpan" id="kobo.3581.1"> model; otherwise, it is </span><strong class="source-inline"><span class="koboSpan" id="kobo.3582.1">-1</span></strong><span class="koboSpan" id="kobo.3583.1">. </span><span class="koboSpan" id="kobo.3583.2">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3584.1">PlayerToken</span></strong><span class="koboSpan" id="kobo.3585.1"> property using as </span><span class="No-Break"><span class="koboSpan" id="kobo.3586.1">shown here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3587.1">
public int PlayerToken =&gt; playerModel.Id == matchModel.PlayerOneId ? </span><span class="koboSpan" id="kobo.3587.2">1 : -1;</span></pre></li> <li><span class="koboSpan" id="kobo.3588.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3589.1">IsPlayersTurn</span></strong><span class="koboSpan" id="kobo.3590.1"> property </span><a id="_idIndexMarker1123"/><span class="koboSpan" id="kobo.3591.1">will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.3592.1">true</span></strong><span class="koboSpan" id="kobo.3593.1"> if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3594.1">Player</span></strong><span class="koboSpan" id="kobo.3595.1"> model is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3596.1">NextPlayer</span></strong><span class="koboSpan" id="kobo.3597.1"> of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3598.1">Match</span></strong><span class="koboSpan" id="kobo.3599.1"> model, as </span><span class="No-Break"><span class="koboSpan" id="kobo.3600.1">shown here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3601.1">
public bool IsPlayersTurn =&gt; playerModel.Id == matchModel.NextPlayerId;</span></pre></li> <li><span class="koboSpan" id="kobo.3602.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3603.1">Id</span></strong><span class="koboSpan" id="kobo.3604.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3605.1">GamerTag</span></strong><span class="koboSpan" id="kobo.3606.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3607.1">EmailAddress</span></strong><span class="koboSpan" id="kobo.3608.1"> properties all just map directly to the corresponding property from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3609.1">Player</span></strong><span class="koboSpan" id="kobo.3610.1"> model. </span><span class="koboSpan" id="kobo.3610.2">This is the same implementation that was used in </span><strong class="source-inline"><span class="koboSpan" id="kobo.3611.1">PlayerViewModel</span></strong><span class="koboSpan" id="kobo.3612.1"> for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3613.1">Lobby</span></strong><span class="koboSpan" id="kobo.3614.1"> page. </span><span class="koboSpan" id="kobo.3614.2">Use the following listing to add the properties </span><span class="No-Break"><span class="koboSpan" id="kobo.3615.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3616.1">MatchPlayerViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3617.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3618.1">
public Guid Id =&gt; playerModel.Id;
public string GamerTag =&gt; playerModel.GamerTag;
public string EmailAddress =&gt; playerModel.EmailAddress;</span></pre></li> <li><span class="koboSpan" id="kobo.3619.1">The final </span><a id="_idIndexMarker1124"/><span class="koboSpan" id="kobo.3620.1">property that is needed for </span><strong class="source-inline"><span class="koboSpan" id="kobo.3621.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.3622.1"> is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3623.1">Score</span></strong><span class="koboSpan" id="kobo.3624.1"> property. </span><span class="koboSpan" id="kobo.3624.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3625.1">Score</span></strong><span class="koboSpan" id="kobo.3626.1"> property is mapped to either the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3627.1">PlayerOneScore</span></strong><span class="koboSpan" id="kobo.3628.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.3629.1">PlayerTwoScore</span></strong><span class="koboSpan" id="kobo.3630.1"> property from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3631.1">Match</span></strong><span class="koboSpan" id="kobo.3632.1"> model, depending on which player the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3633.1">Player</span></strong><span class="koboSpan" id="kobo.3634.1"> model is. </span><span class="koboSpan" id="kobo.3634.2">Use the following listing to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3635.1">Score</span></strong><span class="koboSpan" id="kobo.3636.1"> property </span><span class="No-Break"><span class="koboSpan" id="kobo.3637.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3638.1">MatchPlayerViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3639.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3640.1">
public int Score =&gt; playerModel.Id == matchModel.PlayerOneId ? </span><span class="koboSpan" id="kobo.3640.2">matchModel.PlayerOneScore : matchModel.PlayerTwoScore;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.3641.1">That is all there is to </span><strong class="source-inline"><span class="koboSpan" id="kobo.3642.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.3643.1">. </span><span class="koboSpan" id="kobo.3643.2">The next section will walk you through </span><span class="No-Break"><span class="koboSpan" id="kobo.3644.1">creating </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3645.1">MatchViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3646.1">.</span></span></p>
<h4><span class="koboSpan" id="kobo.3647.1">Adding MatchViewModel</span></h4>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.3648.1">MatchViewModel</span></strong><span class="koboSpan" id="kobo.3649.1"> needs to provide the functionality for all the gameplay. </span><span class="koboSpan" id="kobo.3649.2">It provides the two </span><strong class="source-inline"><span class="koboSpan" id="kobo.3650.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.3651.1"> objects for display in the header of the page, and the board </span><a id="_idIndexMarker1125"/><span class="koboSpan" id="kobo.3652.1">to display where sticks have been played and which stones have been captured. </span><span class="koboSpan" id="kobo.3652.2">It also provides the needed functionality for players to take their turn and forfeit the game if they choose. </span><span class="koboSpan" id="kobo.3652.3">To implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.3653.1">MatchViewModel</span></strong><span class="koboSpan" id="kobo.3654.1">, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.3655.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.3656.1">Create a new class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3657.1">ViewModels</span></strong><span class="koboSpan" id="kobo.3658.1"> folder of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3659.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.3660.1"> project </span><span class="No-Break"><span class="koboSpan" id="kobo.3661.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3662.1">MatchViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3663.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.3664.1">Modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3665.1">using</span></strong><span class="koboSpan" id="kobo.3666.1"> declarations section at the top of the page to match the </span><span class="No-Break"><span class="koboSpan" id="kobo.3667.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3668.1">
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using CommunityToolkit.Mvvm.Messaging;
using SticksAndStones.Models;
using SticksAndStones.Services;</span></pre></li> <li><span class="koboSpan" id="kobo.3669.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3670.1">public</span></strong><span class="koboSpan" id="kobo.3671.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3672.1">partial</span></strong><span class="koboSpan" id="kobo.3673.1"> class modifiers to the class, inherit from </span><strong class="source-inline"><span class="koboSpan" id="kobo.3674.1">ViewModelBase</span></strong><span class="koboSpan" id="kobo.3675.1">, and implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.3676.1">IQueryAttributable</span></strong><span class="koboSpan" id="kobo.3677.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.3678.1">as shown:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3679.1">
public partial class MatchViewModel : ViewModelBase, IQueryAttributable</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3680.1">Recall </span><a id="_idIndexMarker1126"/><span class="koboSpan" id="kobo.3681.1">that in </span><strong class="source-inline"><span class="koboSpan" id="kobo.3682.1">ConnectViewModel</span></strong><span class="koboSpan" id="kobo.3683.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3684.1">LobbyViewModel</span></strong><span class="koboSpan" id="kobo.3685.1">, when they navigate to </span><strong class="source-inline"><span class="koboSpan" id="kobo.3686.1">Match</span></strong><span class="koboSpan" id="kobo.3687.1">, they pass an argument – either </span><strong class="source-inline"><span class="koboSpan" id="kobo.3688.1">MatchId</span></strong><span class="koboSpan" id="kobo.3689.1"> or the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3690.1">Match</span></strong><span class="koboSpan" id="kobo.3691.1"> instance itself. </span><strong class="source-inline"><span class="koboSpan" id="kobo.3692.1">IQueryAttributable</span></strong><span class="koboSpan" id="kobo.3693.1"> is how that argument is passed to </span><strong class="source-inline"><span class="koboSpan" id="kobo.3694.1">MatchViewModel</span></strong><span class="koboSpan" id="kobo.3695.1">. </span><span class="koboSpan" id="kobo.3695.2">The implementation for </span><strong class="source-inline"><span class="koboSpan" id="kobo.3696.1">IQueryAttributable</span></strong><span class="koboSpan" id="kobo.3697.1"> is provided in a </span><span class="No-Break"><span class="koboSpan" id="kobo.3698.1">later step.</span></span></p></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.3699.1">MatchViewModel</span></strong><span class="koboSpan" id="kobo.3700.1"> only has a single dependency, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3701.1">GameService</span></strong><span class="koboSpan" id="kobo.3702.1">, so add a field to store the instance and a constructor to accept the instance as a parameter, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.3703.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3704.1">
private readonly GameService gameService;
public MatchViewModel(GameService gameService)
{
    this.gameService = gameService;
}</span></pre></li> <li><span class="koboSpan" id="kobo.3705.1">When </span><strong class="source-inline"><span class="koboSpan" id="kobo.3706.1">MatchViewModel</span></strong><span class="koboSpan" id="kobo.3707.1"> is loaded, it will need to process the arguments, either the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3708.1">Match</span></strong><span class="koboSpan" id="kobo.3709.1"> instance or a </span><strong class="source-inline"><span class="koboSpan" id="kobo.3710.1">MatchId</span></strong><span class="koboSpan" id="kobo.3711.1"> value. </span><span class="koboSpan" id="kobo.3711.2">Either argument will end up with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.3712.1">Match</span></strong><span class="koboSpan" id="kobo.3713.1"> instance that is used for displaying the board in the view, and from that, create two instances of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3714.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.3715.1"> for player one and player two. </span><span class="koboSpan" id="kobo.3715.2">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.3716.1">match</span></strong><span class="koboSpan" id="kobo.3717.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3718.1">playerOne</span></strong><span class="koboSpan" id="kobo.3719.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3720.1">playerTwo</span></strong><span class="koboSpan" id="kobo.3721.1"> fields to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3722.1">MatchViewModel</span></strong><span class="koboSpan" id="kobo.3723.1"> class to hold those instances, as </span><span class="No-Break"><span class="koboSpan" id="kobo.3724.1">shown here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3725.1">
[ObservableProperty]
private Match match;
[ObservableProperty]
private MatchPlayerViewModel playerOne;
[ObservableProperty]
private MatchPlayerViewModel playerTwo;</span></pre></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.3726.1">IQueryAttributable</span></strong><span class="koboSpan" id="kobo.3727.1"> is used to process the arguments passed to the view model. </span><span class="koboSpan" id="kobo.3727.2">Well, it is one way of doing it. </span><span class="koboSpan" id="kobo.3727.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3728.1">IQueryAttributable</span></strong><span class="koboSpan" id="kobo.3729.1"> interface has only </span><a id="_idIndexMarker1127"/><span class="koboSpan" id="kobo.3730.1">one method defined, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3731.1">ApplyQueryAttributes</span></strong><span class="koboSpan" id="kobo.3732.1">. </span><span class="koboSpan" id="kobo.3732.2">The .NET MAUI routing system will automatically call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3733.1">ApplyQueryAttributes</span></strong><span class="koboSpan" id="kobo.3734.1"> method if the view model implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3735.1">IQueryAttributable</span></strong><span class="koboSpan" id="kobo.3736.1"> interface. </span><span class="koboSpan" id="kobo.3736.2">To add the implementation for </span><strong class="source-inline"><span class="koboSpan" id="kobo.3737.1">IQueryAttributable</span></strong><span class="koboSpan" id="kobo.3738.1">, use the </span><span class="No-Break"><span class="koboSpan" id="kobo.3739.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3740.1">
public async Task ApplyQueryAttributes(IDictionary&lt;string, object&gt; query)
{
    Match match = null;
    if (query.ContainsKey(Constants.ArgumentNames.Match))
    {
        match = query[Constants.ArgumentNames.Match] as Match;
    }
    if (query.ContainsKey(Constants.ArgumentNames.MatchId))
    {
        var matchId = new Guid($"{query[Constants.ArgumentNames.MatchId]}");
        if (matchId != Guid.Empty)
        {
            match = await gameService.GetMatchById(matchId);
        }
    }
        LoadMatch(match);
    });
}
private void LoadMatch(Match match)
{ 
    if (match is null) return;
    PlayerOne = new MatchPlayerViewModel(gameService.GetPlayerById(match.PlayerOneId), match);
    PlayerTwo = new MatchPlayerViewModel(gameService.GetPlayerById(match.PlayerTwoId), match);
    this.Match = match;
}</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.3741.1">ApplyQueryAttributes</span></strong><span class="koboSpan" id="kobo.3742.1"> has a single parameter query, which is a dictionary of key-value pairs with the key as a string and the value as an object. </span><span class="koboSpan" id="kobo.3742.2">The key ID is the name of the parameter as was passed in – for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3743.1">"Match"</span></strong><span class="koboSpan" id="kobo.3744.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.3745.1">"MatchId"</span></strong><span class="koboSpan" id="kobo.3746.1">. </span><span class="koboSpan" id="kobo.3746.2">The method will check for the existence of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3747.1">"Match"</span></strong><span class="koboSpan" id="kobo.3748.1"> key being present and get the value as </span><strong class="source-inline"><span class="koboSpan" id="kobo.3749.1">Match</span></strong><span class="koboSpan" id="kobo.3750.1"> if it is. </span><span class="koboSpan" id="kobo.3750.2">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3751.1">"MatchId"</span></strong><span class="koboSpan" id="kobo.3752.1"> key is present, then </span><strong class="source-inline"><span class="koboSpan" id="kobo.3753.1">GameService</span></strong><span class="koboSpan" id="kobo.3754.1"> is used to get the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3755.1">Match</span></strong><span class="koboSpan" id="kobo.3756.1"> model from </span><strong class="source-inline"><span class="koboSpan" id="kobo.3757.1">Id</span></strong><span class="koboSpan" id="kobo.3758.1">. </span><span class="koboSpan" id="kobo.3758.2">If there is no value for </span><strong class="source-inline"><span class="koboSpan" id="kobo.3759.1">match</span></strong><span class="koboSpan" id="kobo.3760.1">, then the method returns; otherwise; initialize the two instances of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3761.1">GamePlayerViewModel</span></strong><span class="koboSpan" id="kobo.3762.1"> and store them and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3763.1">Match</span></strong><span class="koboSpan" id="kobo.3764.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3765.1">ViewModel</span></strong><span class="koboSpan" id="kobo.3766.1"> properties. </span><span class="koboSpan" id="kobo.3766.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3767.1">LoadMatch</span></strong><span class="koboSpan" id="kobo.3768.1"> method is called from </span><strong class="source-inline"><span class="koboSpan" id="kobo.3769.1">ApplyQueryAttributes</span></strong><span class="koboSpan" id="kobo.3770.1"> since we will need the same functionality when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3771.1">UpdateMatch</span></strong><span class="koboSpan" id="kobo.3772.1"> event is received. </span></p></li> <li><span class="koboSpan" id="kobo.3773.1">Before we </span><a id="_idIndexMarker1128"/><span class="koboSpan" id="kobo.3774.1">can allow a player to choose a location to place a stick, it must be their turn. </span><span class="koboSpan" id="kobo.3774.2">Create a property named </span><strong class="source-inline"><span class="koboSpan" id="kobo.3775.1">IsCurrentPlayersTurn</span></strong><span class="koboSpan" id="kobo.3776.1"> using the </span><span class="No-Break"><span class="koboSpan" id="kobo.3777.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3778.1">
public bool IsCurrentPlayersTurn =&gt; gameService.CurrentPlayer.Id == (Match?.NextPlayerId ?? </span><span class="koboSpan" id="kobo.3778.2">Guid.Empty);</span></pre></li> <li><span class="koboSpan" id="kobo.3779.1">Anytime the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3780.1">Match</span></strong><span class="koboSpan" id="kobo.3781.1"> object is updated, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3782.1">IsCurrentPlayersTurn</span></strong><span class="koboSpan" id="kobo.3783.1"> needs to be updated as well, since it depends on values in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3784.1">Match</span></strong><span class="koboSpan" id="kobo.3785.1"> property. </span><span class="koboSpan" id="kobo.3785.2">To have this happen automatically, use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3786.1">NotifyPropertyChangedFor</span></strong><span class="koboSpan" id="kobo.3787.1"> attribute from </span><strong class="source-inline"><span class="koboSpan" id="kobo.3788.1">CommunityToolkit</span></strong><span class="koboSpan" id="kobo.3789.1">. </span><span class="koboSpan" id="kobo.3789.2">Add the highlighted line in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.3790.1">code listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3791.1">
[ObservableProperty]
</span><strong class="bold"><span class="koboSpan" id="kobo.3792.1">[NotifyPropertyChangedFor(nameof(IsCurrentPlayersTurn))]</span></strong><span class="koboSpan" id="kobo.3793.1">
private Match match;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3794.1">Now, whenever the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3795.1">Match</span></strong><span class="koboSpan" id="kobo.3796.1"> property is changed, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3797.1">NotfiyPropertyChanged</span></strong><span class="koboSpan" id="kobo.3798.1"> method will also be called for </span><strong class="source-inline"><span class="koboSpan" id="kobo.3799.1">IsCurrentPlayersTurn</span></strong><span class="koboSpan" id="kobo.3800.1">. </span><span class="koboSpan" id="kobo.3800.2">See </span><em class="italic"><span class="koboSpan" id="kobo.3801.1">the Defining a ViewModel base class</span></em><span class="koboSpan" id="kobo.3802.1"> section</span><em class="italic"> </em><span class="koboSpan" id="kobo.3803.1">in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3804.1">Chapter 2</span></em></span><span class="koboSpan" id="kobo.3805.1">, for a refresher on implementing the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3806.1">INotifyPropertyChanged</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3807.1"> interface.</span></span></p></li> <li><span class="koboSpan" id="kobo.3808.1">The game allows the player to try out different positions of the stick before committing. </span><span class="koboSpan" id="kobo.3808.2">If this is the current player’s turn, the one connected and using the app, then the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3809.1">SelectStick</span></strong><span class="koboSpan" id="kobo.3810.1"> method will place a stick at the location chosen by the user. </span><span class="koboSpan" id="kobo.3810.2">The choice is not sent to the server until the user clicks the </span><strong class="bold"><span class="koboSpan" id="kobo.3811.1">Send</span></strong><span class="koboSpan" id="kobo.3812.1"> button in the view; this allows the player a little time to think and try out different </span><a id="_idIndexMarker1129"/><span class="koboSpan" id="kobo.3813.1">plays before committing. </span><span class="koboSpan" id="kobo.3813.2">The last choice made by the player is captured in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3814.1">lastSelectedStick</span></strong><span class="koboSpan" id="kobo.3815.1"> field. </span><span class="koboSpan" id="kobo.3815.2">Add the following listing to implement the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3816.1">SelectStick</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3817.1"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3818.1">
int lastSelectedStick = -1;
[RelayCommand(CanExecute = nameof(IsCurrentPlayersTurn))]
private void SelectStick(string arg)
{
    if (gameService.CurrentPlayer is null) return;
    if (Match is null) return;
    
    if (int.TryParse(arg, out var pos))
    {
        pos--; // adjust for 0 based indexes
        if (lastSelectedStick != -1 &amp;&amp; lastSelectedStick != pos)
            Match.Sticks[lastSelectedStick] = 0;
        if (Match.Sticks[pos] != 0)
            return;
        Match.Sticks[pos] = gameService.CurrentPlayer.Id == PlayerOne.Id ? </span><span class="koboSpan" id="kobo.3818.2">PlayerOne.PlayerToken : PlayerTwo.PlayerToken;
        lastSelectedStick = pos;
        OnPropertyChanged(nameof(Match));
    }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3819.1">The value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3820.1">-1</span></strong><span class="koboSpan" id="kobo.3821.1"> for </span><strong class="source-inline"><span class="koboSpan" id="kobo.3822.1">lastSelectedStick</span></strong><span class="koboSpan" id="kobo.3823.1"> is used to mean no stick. </span><span class="koboSpan" id="kobo.3823.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3824.1">SelectStick</span></strong><span class="koboSpan" id="kobo.3825.1"> method is exposed as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.3826.1">Command</span></strong><span class="koboSpan" id="kobo.3827.1"> instance via </span><strong class="source-inline"><span class="koboSpan" id="kobo.3828.1">RelayCommandAttribute</span></strong><span class="koboSpan" id="kobo.3829.1">. </span><span class="No-Break"><span class="koboSpan" id="kobo.3830.1">The </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3831.1">Is</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.3832.1">
CurrentPlayersTurn</span></strong><span class="koboSpan" id="kobo.3833.1"> property is used to </span><a id="_idIndexMarker1130"/><span class="koboSpan" id="kobo.3834.1">determine whether the command can execute. </span><span class="koboSpan" id="kobo.3834.2">Recall from </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3835.1">Chapter 9</span></em></span><span class="koboSpan" id="kobo.3836.1"> that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3837.1">Sticks</span></strong><span class="koboSpan" id="kobo.3838.1"> elements will have one of three values: </span><strong class="source-inline"><span class="koboSpan" id="kobo.3839.1">-1</span></strong><span class="koboSpan" id="kobo.3840.1"> for player one, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3841.1">0</span></strong><span class="koboSpan" id="kobo.3842.1"> for empty, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3843.1">1</span></strong><span class="koboSpan" id="kobo.3844.1"> for player two. </span><span class="koboSpan" id="kobo.3844.2">After determining whether the stick position is valid, the method raises the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3845.1">OnPropertyChanged</span></strong><span class="koboSpan" id="kobo.3846.1"> event for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3847.1">Match</span></strong><span class="koboSpan" id="kobo.3848.1"> property, which causes the bindings </span><span class="No-Break"><span class="koboSpan" id="kobo.3849.1">to update.</span></span></p></li> <li><span class="koboSpan" id="kobo.3850.1">After deliberating on which position to place their next stick, the player has three options: send their move to the server and end their turn, be indecisive and undo their move, or give up and exit the match. </span><span class="koboSpan" id="kobo.3850.2">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3851.1">Play</span></strong><span class="koboSpan" id="kobo.3852.1"> method to </span><strong class="source-inline"><span class="koboSpan" id="kobo.3853.1">MatchViewModel</span></strong><span class="koboSpan" id="kobo.3854.1"> using the following </span><span class="No-Break"><span class="koboSpan" id="kobo.3855.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3856.1">
[RelayCommand]
private async Task Play()
{
    if (lastSelectedStick == -1)
    {
        await Shell.Current.CurrentPage.DisplayAlert("Make a move", "You must make a move before you play.", "Ok");
        return;
    }
    if (await Shell.Current.CurrentPage.DisplayAlert("Make a move", "Are you sure this is the move you want, this can't be undone.", "Yes", "No"))
    {
        var (newMatch, error) = await gameService.EndTurn(Match.Id, lastSelectedStick);
        if (error is not null)
        {
            await Shell.Current.CurrentPage.DisplayAlert("Error in move", error, "Ok");
            return;
        }
        lastSelectedStick = -1;
    }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3857.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3858.1">Play</span></strong><span class="koboSpan" id="kobo.3859.1"> method </span><a id="_idIndexMarker1131"/><span class="koboSpan" id="kobo.3860.1">is exposed as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.3861.1">Command</span></strong><span class="koboSpan" id="kobo.3862.1"> so that it can be bound to by </span><span class="No-Break"><span class="koboSpan" id="kobo.3863.1">UI elements.</span></span></p></li> <li><span class="koboSpan" id="kobo.3864.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3865.1">Undo</span></strong><span class="koboSpan" id="kobo.3866.1"> method is called when the player taps the </span><strong class="bold"><span class="koboSpan" id="kobo.3867.1">Undo</span></strong><span class="koboSpan" id="kobo.3868.1"> button. </span><span class="koboSpan" id="kobo.3868.2">This method resets the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3869.1">lastSelectedStick</span></strong><span class="koboSpan" id="kobo.3870.1"> position and the value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3871.1">lastSelectedStick</span></strong><span class="koboSpan" id="kobo.3872.1">. </span><span class="koboSpan" id="kobo.3872.2">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3873.1">Undo</span></strong><span class="koboSpan" id="kobo.3874.1"> method, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.3875.1">code listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3876.1">
[RelayCommand]
private async Task Undo()
{
    if (lastSelectedStick != -1)
    {
        if (await Shell.Current.CurrentPage.DisplayAlert("Undo your move", "Are you sure you don't want to play this move?", "Yes", "No"))
        {
            OnPropertyChanging(nameof(Match));
            Match.Sticks[lastSelectedStick] = 0;
            OnPropertyChanged(nameof(Match));
            lastSelectedStick = -1;
            return;
        }
    }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.3877.1">Again, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3878.1">RelayCommand</span></strong><span class="koboSpan" id="kobo.3879.1"> attribute is applied to the method to allow it to be bound to by </span><span class="No-Break"><span class="koboSpan" id="kobo.3880.1">UI elements.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.3881.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3882.1">Forfeit</span></strong><span class="koboSpan" id="kobo.3883.1"> method is called when the player uses the </span><strong class="bold"><span class="koboSpan" id="kobo.3884.1">Back</span></strong><span class="koboSpan" id="kobo.3885.1"> button to go back to </span><a id="_idIndexMarker1132"/><span class="koboSpan" id="kobo.3886.1">the Lobby. </span><span class="koboSpan" id="kobo.3886.2">If the match is still in progress, then the player is warned that leaving the match forfeits to the opposing player. </span><span class="koboSpan" id="kobo.3886.3">Use the following code listing to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3887.1">Forfeit</span></strong><span class="koboSpan" id="kobo.3888.1"> method to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3889.1">MatchViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3890.1"> class:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.3891.1">[RelayCommand]
private async Task Forfeit()
{
    var returnToLobby = true;
    if (!Match.Completed)
    {
        returnToLobby = await Shell.Current.CurrentPage.DisplayAlert("W A I T", "Returning to the Lobby will forfeit your match, are you sure you want to do that?", "Yes", "No"))
    if (returnToLobby)
    {
        await Shell.Current.GoToAsync("///Lobby");
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.3892.1">When the </span><a id="_idIndexMarker1133"/><span class="koboSpan" id="kobo.3893.1">opposing player sends their move to the server, it is received in the app as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.3894.1">MatchUpdated</span></strong><span class="koboSpan" id="kobo.3895.1"> event from the SignalR service. </span><span class="koboSpan" id="kobo.3895.2">Add the handler for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3896.1">MatchUpdated</span></strong><span class="koboSpan" id="kobo.3897.1"> event using the </span><span class="No-Break"><span class="koboSpan" id="kobo.3898.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3899.1">
void OnMatchUpdated(object r, Messages.MatchUpdated m)
{
    LoadMatch(m.Value);
    if (Match.WinnerId != Guid.Empty &amp;&amp; Match.Completed == true)
    {
        MainThread.InvokeOnMainThreadAsync(async () =&gt;
        {
            if (Match.WinnerId == gameService.CurrentPlayer.Id)
            {
                await Shell.Current.CurrentPage.DisplayAlert("Congratulations!", $"You are victorious!\nPress the back button to return to the lobby.", "Ok");
            }
            else
            {
                await Shell.Current.CurrentPage.DisplayAlert("Bummer!", $"You were defeated, better luck next time!\nPress the back button to return to the lobby.", "Ok");
            }
        });
        return;
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.3900.1">To register the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3901.1">MatchUpdated</span></strong><span class="koboSpan" id="kobo.3902.1"> event handler, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3903.1">Register</span></strong><span class="koboSpan" id="kobo.3904.1"> method is called </span><a id="_idIndexMarker1134"/><span class="koboSpan" id="kobo.3905.1">from </span><strong class="source-inline"><span class="koboSpan" id="kobo.3906.1">OnActivated</span></strong><span class="koboSpan" id="kobo.3907.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3908.1">UnRegister</span></strong><span class="koboSpan" id="kobo.3909.1"> is called from </span><strong class="source-inline"><span class="koboSpan" id="kobo.3910.1">OnDeactivated</span></strong><span class="koboSpan" id="kobo.3911.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.3912.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3913.1">
protected override void OnActivated()
{
    Messenger.Register(this, (MessageHandler&lt;object, Messages.MatchUpdated&gt;)OnMatchUpdated);
}
protected override void OnDeactivated()
{
    Messenger.Unregister&lt;Messages.MatchUpdated&gt;(this);
}</span></pre></li> <li><span class="koboSpan" id="kobo.3914.1">Register </span><strong class="source-inline"><span class="koboSpan" id="kobo.3915.1">MatchViewModel</span></strong><span class="koboSpan" id="kobo.3916.1"> with dependency injection by adding the following highlighted </span><a id="_idIndexMarker1135"/><span class="koboSpan" id="kobo.3917.1">line of code to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3918.1">CreateMauiApp</span></strong><span class="koboSpan" id="kobo.3919.1"> method in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3920.1">MauiProgram.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3921.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3922.1">
builder.Services.AddTransient&lt;ViewModels.ConnectViewModel&gt;();
builder.Services.AddTransient&lt;ViewModels.LobbyViewModel&gt;();
</span><strong class="bold"><span class="koboSpan" id="kobo.3923.1">builder.Services.AddTransient&lt;ViewModels.MatchViewModel&gt;();</span></strong><span class="koboSpan" id="kobo.3924.1">
builder.Services.AddTransient&lt;Views.ConnectView&gt;();
builder.Services.AddTransient&lt;Views.LobbyView&gt;();</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.3925.1">Why is it called IQueryAttributable? </span><span class="koboSpan" id="kobo.3925.2">That feels awkward</span></p>
<p class="callout"><span class="koboSpan" id="kobo.3926.1">The reason </span><a id="_idIndexMarker1136"/><span class="koboSpan" id="kobo.3927.1">behind the name of the interface is that naming things is hard. </span><span class="koboSpan" id="kobo.3927.2">The system for passing arguments to a view model can be either declarative or not. </span><span class="koboSpan" id="kobo.3927.3">The declarative way uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.3928.1">QueryPropertyAttribute</span></strong><span class="koboSpan" id="kobo.3929.1"> to map the query parameter to a property on the view model. </span><span class="koboSpan" id="kobo.3929.2">If you choose not to use the attributes, but instead handle the mapping yourself manually, you declare your class </span><strong class="source-inline"><span class="koboSpan" id="kobo.3930.1">IQueryAttributable</span></strong><span class="koboSpan" id="kobo.3931.1">, as in I could have used </span><strong class="source-inline"><span class="koboSpan" id="kobo.3932.1">QueryPropertyAttribute</span></strong><span class="koboSpan" id="kobo.3933.1"> but I choose not to. </span><span class="koboSpan" id="kobo.3933.2">For more information, </span><span class="No-Break"><span class="koboSpan" id="kobo.3934.1">visit </span></span><a href="https://learn.microsoft.com/en-us/dotnet/maui/fundamentals/shell/navigation#pass-data"><span class="No-Break"><span class="koboSpan" id="kobo.3935.1">https://learn.microsoft.com/en-us/dotnet/maui/fundamentals/shell/navigation#pass-data</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3936.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.3937.1">Adding the Match view</span></h3>
<p><span class="koboSpan" id="kobo.3938.1">This page </span><a id="_idIndexMarker1137"/><span class="koboSpan" id="kobo.3939.1">is complex, so we are going to break it down into smaller, more manageable chunks. </span><span class="koboSpan" id="kobo.3939.2">First, the basic page layout is defined including the commands that are available to the player: </span><strong class="source-inline"><span class="koboSpan" id="kobo.3940.1">Play</span></strong><span class="koboSpan" id="kobo.3941.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3942.1">Undo</span></strong><span class="koboSpan" id="kobo.3943.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3944.1">Forfeit</span></strong><span class="koboSpan" id="kobo.3945.1">. </span><span class="koboSpan" id="kobo.3945.2">Next, the scoreboard area is defined with the player’s gamer tag, Gravatar, and scores. </span><span class="koboSpan" id="kobo.3945.3">Finally, the game board is defined and laid out in a three-by-three grid. </span><span class="koboSpan" id="kobo.3945.4">Let’s get started by creating the view and </span><span class="No-Break"><span class="koboSpan" id="kobo.3946.1">the layout.</span></span></p>
<h4><span class="koboSpan" id="kobo.3947.1">Create the view</span></h4>
<p><span class="koboSpan" id="kobo.3948.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3949.1">Match</span></strong><span class="koboSpan" id="kobo.3950.1"> view is not unlike any of the other views that have been created except that it has </span><a id="_idIndexMarker1138"/><span class="koboSpan" id="kobo.3951.1">many more elements than preview views. </span><span class="koboSpan" id="kobo.3951.2">Let’s get started by creating the view and some basic elements by following </span><span class="No-Break"><span class="koboSpan" id="kobo.3952.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.3953.1">Right-click on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3954.1">Views</span></strong><span class="koboSpan" id="kobo.3955.1"> folder of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3956.1">SticksAndStone.App</span></strong><span class="koboSpan" id="kobo.3957.1"> project, select </span><strong class="bold"><span class="koboSpan" id="kobo.3958.1">Add</span></strong><span class="koboSpan" id="kobo.3959.1">, and then click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.3960.1">New Item...</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3961.1">.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.3962.1">If you are using Visual Studio 17.7 or later, click the </span><strong class="bold"><span class="koboSpan" id="kobo.3963.1">Show all Templates</span></strong><span class="koboSpan" id="kobo.3964.1"> button in the dialog that pops up; otherwise, move to the </span><span class="No-Break"><span class="koboSpan" id="kobo.3965.1">next step.</span></span></p></li>
<li><span class="koboSpan" id="kobo.3966.1">Under the </span><strong class="bold"><span class="koboSpan" id="kobo.3967.1">C# Items</span></strong><span class="koboSpan" id="kobo.3968.1"> node on the left, select </span><strong class="bold"><span class="koboSpan" id="kobo.3969.1">.</span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.3970.1">NET MAUI</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3971.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.3972.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.3973.1">.NET MAUI </span></strong><strong class="bold"><span class="koboSpan" id="kobo.3974.1">ContentPage</span></strong><strong class="bold"><span class="koboSpan" id="kobo.3975.1"> (XAML)</span></strong><span class="koboSpan" id="kobo.3976.1"> and name </span><span class="No-Break"><span class="koboSpan" id="kobo.3977.1">it </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3978.1">MatchView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3979.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.3980.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.3981.1">Add</span></strong><span class="koboSpan" id="kobo.3982.1"> to create </span><span class="No-Break"><span class="koboSpan" id="kobo.3983.1">the page.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.3984.1">Refer to the following screenshot to view the </span><span class="No-Break"><span class="koboSpan" id="kobo.3985.1">preceding information:</span></span></p></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer178">
<span class="koboSpan" id="kobo.3986.1"><img alt="Figure 10.13 – Adding a new .NET MAUI ContentPage (XAML)" src="image/B19214_10_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3987.1">Figure 10.13 – Adding a new .NET MAUI ContentPage (XAML)</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.3988.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3989.1">MatchView.xaml.cs</span></strong><span class="koboSpan" id="kobo.3990.1"> file and add the following </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3991.1">using</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3992.1"> declaration:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3993.1">
using SticksAndStones.ViewModels;</span></pre></li> <li><span class="koboSpan" id="kobo.3994.1">Make </span><a id="_idIndexMarker1139"/><span class="koboSpan" id="kobo.3995.1">the following highlighted changes to </span><span class="No-Break"><span class="koboSpan" id="kobo.3996.1">the constructor:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.3997.1">
public MatchView(</span><strong class="bold"><span class="koboSpan" id="kobo.3998.1">MatchViewModel viewModel</span></strong><span class="koboSpan" id="kobo.3999.1">)
{
</span><strong class="bold"><span class="koboSpan" id="kobo.4000.1">    this.BindingContext = viewModel;</span></strong><span class="koboSpan" id="kobo.4001.1">
    InitializeComponent();
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4002.1">These changes allow for dependency injection to supply the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4003.1">MatchViewModel</span></strong><span class="koboSpan" id="kobo.4004.1"> instance to the view, which is then assigned </span><span class="No-Break"><span class="koboSpan" id="kobo.4005.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4006.1">BindingContext</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4007.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.4008.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4009.1">AppShell.xaml</span></strong><span class="koboSpan" id="kobo.4010.1"> file and add the following code snippet to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4011.1">ContentPage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4012.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4013.1">
&lt;ShellItem Route="Match"&gt;
    &lt;ShellContent ContentTemplate="{DataTemplate views:MatchView}" /&gt;
&lt;/ShellItem&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4014.1">This </span><a id="_idIndexMarker1140"/><span class="koboSpan" id="kobo.4015.1">registers the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4016.1">"Match"</span></strong><span class="koboSpan" id="kobo.4017.1"> route and directs it </span><span class="No-Break"><span class="koboSpan" id="kobo.4018.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4019.1">MatchView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4020.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.4021.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4022.1">MauiProgram.cs</span></strong><span class="koboSpan" id="kobo.4023.1"> file and add the following highlighted line </span><span class="No-Break"><span class="koboSpan" id="kobo.4024.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4025.1">
builder.Services.AddTransient&lt;Views.ConnectView&gt;();
builder.Services.AddTransient&lt;Views.LobbyView&gt;();
</span><strong class="bold"><span class="koboSpan" id="kobo.4026.1">builder.Services.AddTransient&lt;Views.MatchView&gt;();</span></strong><span class="koboSpan" id="kobo.4027.1">
return builder.Build();</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4028.1">This will register </span><strong class="source-inline"><span class="koboSpan" id="kobo.4029.1">MatchView</span></strong><span class="koboSpan" id="kobo.4030.1"> with dependency injection so that </span><strong class="source-inline"><span class="koboSpan" id="kobo.4031.1">DataTemplate</span></strong><span class="koboSpan" id="kobo.4032.1"> can </span><span class="No-Break"><span class="koboSpan" id="kobo.4033.1">locate it.</span></span></p></li> <li><span class="koboSpan" id="kobo.4034.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4035.1">MatchView.xaml</span></strong><span class="koboSpan" id="kobo.4036.1"> file and remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4037.1">Title</span></strong><span class="koboSpan" id="kobo.4038.1"> attribute of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4039.1">ContentPage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4040.1"> element.</span></span></li>
<li><span class="koboSpan" id="kobo.4041.1">Add the following highlighted namespaces to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4042.1">MatchView</span></strong><span class="koboSpan" id="kobo.4043.1"> element. </span><span class="koboSpan" id="kobo.4043.2">They will provide us access to the classes in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4044.1">ViewModels</span></strong><span class="koboSpan" id="kobo.4045.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4046.1">Converters</span></strong><span class="koboSpan" id="kobo.4047.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4048.1">Controls</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4049.1"> namespaces:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4050.1">
&lt;ContentPage 
             
</span><strong class="bold"><span class="koboSpan" id="kobo.4051.1">        </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4052.1">        </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4053.1">        </span></strong><span class="koboSpan" id="kobo.4054.1">
        x:Class="SticksAndStones.Views.GameView"&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.4055.1">To make </span><a id="_idIndexMarker1141"/><span class="koboSpan" id="kobo.4056.1">IntelliSense happy with the bindings we will be adding, define the view model that the view is using by adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4057.1">x:DataType</span></strong><span class="koboSpan" id="kobo.4058.1"> attribute to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4059.1">MatchView</span></strong><span class="koboSpan" id="kobo.4060.1"> element, </span><span class="No-Break"><span class="koboSpan" id="kobo.4061.1">as shown:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4062.1">
&lt;ContentPage 
             
        
        
        
        </span><strong class="bold"><span class="koboSpan" id="kobo.4063.1">x:DataType="viewModels:GameViewModel"</span></strong><span class="koboSpan" id="kobo.4064.1">
        x:Class="SticksAndStones.Views.GameView"&gt;</span></pre></li> </ol>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.4065.1">MatchView</span></strong><span class="koboSpan" id="kobo.4066.1"> uses a few icons from the Font Awesome font library, so we will need to download and install the library so that it is available in </span><span class="No-Break"><span class="koboSpan" id="kobo.4067.1">the app.</span></span></p>
<h4><span class="koboSpan" id="kobo.4068.1">Downloading and configuring Font Awesome</span></h4>
<p><span class="koboSpan" id="kobo.4069.1">Font Awesome is a free collection of images packaged into a font. </span><span class="koboSpan" id="kobo.4069.2">.NET MAUI has excellent </span><a id="_idIndexMarker1142"/><span class="koboSpan" id="kobo.4070.1">support for using Font Awesome in toolbars, navigation bars, and all over the place. </span><span class="koboSpan" id="kobo.4070.2">It’s not strictly needed to make </span><a id="_idIndexMarker1143"/><span class="koboSpan" id="kobo.4071.1">this</span><a id="_idTextAnchor891"/><span class="koboSpan" id="kobo.4072.1"> app, but we think that it’s worth the extra round trip since you are most likely going to need something like this in your new </span><span class="No-Break"><span class="koboSpan" id="kobo.4073.1">killer app.</span></span></p>
<p><span class="koboSpan" id="kobo.4074.1">Downloading the font is straightforward. </span><span class="koboSpan" id="kobo.4074.2">Please note the renaming of the file – it is not really needed but it’s easier to edit configuration files and such if they have a simpler name. </span><span class="koboSpan" id="kobo.4074.3">Follow these steps to acquire and copy the font to </span><span class="No-Break"><span class="koboSpan" id="kobo.4075.1">each project:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.4076.1">Browse </span><span class="No-Break"><span class="koboSpan" id="kobo.4077.1">to </span></span><a href="https://fontawesome.com/download"><span class="No-Break"><span class="koboSpan" id="kobo.4078.1">https://fontawesome.com/download</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.4079.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.4080.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.4081.1">Free for Desktop</span></strong><span class="koboSpan" id="kobo.4082.1"> button to download </span><span class="No-Break"><span class="koboSpan" id="kobo.4083.1">Font Awesome.</span></span></li>
<li><span class="koboSpan" id="kobo.4084.1">Unzip the downloaded file, then locate the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4085.1">otfs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4086.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.4087.1">Rename the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4088.1">Font Awesome 5 Free-Solid-900.otf</span></strong><span class="koboSpan" id="kobo.4089.1"> file to </span><strong class="source-inline"><span class="koboSpan" id="kobo.4090.1">FontAwesome.otf</span></strong><span class="koboSpan" id="kobo.4091.1"> (you can keep the original name, but it’s just less to type if you rename it). </span><span class="koboSpan" id="kobo.4091.2">Your filename may be different since Font Awesome is continually updating but it should </span><span class="No-Break"><span class="koboSpan" id="kobo.4092.1">be similar.</span></span></li>
<li><span class="koboSpan" id="kobo.4093.1">Copy </span><strong class="source-inline"><span class="koboSpan" id="kobo.4094.1">FontAwesome.otf</span></strong><span class="koboSpan" id="kobo.4095.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4096.1">Resources/Fonts</span></strong><span class="koboSpan" id="kobo.4097.1"> folder in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4098.1">SticksAndStones.App</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4099.1"> project.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.4100.1">It would be nice if all that was needed was to copy the font file into the project folders. </span><span class="koboSpan" id="kobo.4100.2">A lot does happen with just that action. </span><span class="koboSpan" id="kobo.4100.3">The default .NET MAUI template includes all the fonts in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4101.1">Resources/Fonts</span></strong><span class="koboSpan" id="kobo.4102.1"> folder with the following item definition in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4103.1">News.csproj</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4104.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.4105.1">
&lt;!-- Custom Fonts --&gt;
&lt;MauiFont Include="Resources\Fonts\*" /&gt;</span></pre> <p><span class="koboSpan" id="kobo.4106.1">This ensures that the font files are processed and included in the app package automatically. </span><span class="koboSpan" id="kobo.4106.2">What is left is to register the font with the .NET MAUI runtime so it is available to our XAML resources. </span><span class="koboSpan" id="kobo.4106.3">To do that, add the following highlighted line to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4107.1">MauiProgram.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4108.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.4109.1">
.ConfigureFonts(fonts =&gt;
{
    fonts.AddFont("OpenSans-Regular.ttf", "OpenSansRegular");
    fonts.AddFont("OpenSans-Semibold.ttf", "OpenSansSemibold");
    </span><strong class="bold"><span class="koboSpan" id="kobo.4110.1">fonts.AddFont("FontAwesome.otf", "FontAwesome");</span></strong><span class="koboSpan" id="kobo.4111.1">
})</span></pre> <p><span class="koboSpan" id="kobo.4112.1">This line </span><a id="_idIndexMarker1144"/><span class="koboSpan" id="kobo.4113.1">adds an alias that we can use in the </span><a id="_idIndexMarker1145"/><span class="koboSpan" id="kobo.4114.1">next section to create static resources. </span><span class="koboSpan" id="kobo.4114.2">The first parameter is the filename for the font file, and the second is the alias for the font that you can use in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4115.1">FontFamily</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4116.1"> attribute.</span></span></p>
<h4><span class="koboSpan" id="kobo.4117.1">Defining the layout</span></h4>
<p><span class="koboSpan" id="kobo.4118.1">Now that </span><a id="_idIndexMarker1146"/><span class="koboSpan" id="kobo.4119.1">Font Awesome is installed and configured in .NET MAUI, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4120.1">TitleView</span></strong><span class="koboSpan" id="kobo.4121.1"> can use it. </span><span class="koboSpan" id="kobo.4121.2">Add the custom title area and the main layout by following </span><span class="No-Break"><span class="koboSpan" id="kobo.4122.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.4123.1">First, override </span><strong class="source-inline"><span class="koboSpan" id="kobo.4124.1">TitleView</span></strong><span class="koboSpan" id="kobo.4125.1"> of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4126.1">Shell</span></strong><span class="koboSpan" id="kobo.4127.1"> element and provide a new container to hold </span><span class="No-Break"><span class="koboSpan" id="kobo.4128.1">the buttons:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4129.1">
&lt;Shell.TitleView&gt;
    &lt;Grid&gt;
        &lt;HorizontalStackLayout HorizontalOptions="Start"&gt;
        &lt;/HorizontalStackLayout&gt;
        &lt;HorizontalStackLayout HorizontalOptions="End"&gt;
        &lt;/HorizontalStackLayout&gt;
    &lt;/Grid&gt;
&lt;/Shell.TitleView&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4130.1">The buttons are arranged in two segments, one aligned to the left or start of the window and the other aligned to the right or end of </span><span class="No-Break"><span class="koboSpan" id="kobo.4131.1">the window.</span></span></p></li> <li><span class="koboSpan" id="kobo.4132.1">The player can at any point decide they no longer wish to continue playing. </span><span class="koboSpan" id="kobo.4132.2">To exit the match, the player can use the </span><strong class="bold"><span class="koboSpan" id="kobo.4133.1">Back</span></strong><span class="koboSpan" id="kobo.4134.1"> button to return to the Lobby. </span><span class="koboSpan" id="kobo.4134.2">When the </span><a id="_idIndexMarker1147"/><span class="koboSpan" id="kobo.4135.1">button is tapped, the player is prompted to ensure that they no longer wish to continue playing. </span><span class="koboSpan" id="kobo.4135.2">To add the </span><strong class="bold"><span class="koboSpan" id="kobo.4136.1">Back</span></strong><span class="koboSpan" id="kobo.4137.1"> button to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4138.1">Start</span></strong><span class="koboSpan" id="kobo.4139.1"> section of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4140.1">TitleView</span></strong><span class="koboSpan" id="kobo.4141.1"> and bind </span><strong class="source-inline"><span class="koboSpan" id="kobo.4142.1">ForfeitCommand</span></strong><span class="koboSpan" id="kobo.4143.1"> in </span><strong class="source-inline"><span class="koboSpan" id="kobo.4144.1">MatchViewModel</span></strong><span class="koboSpan" id="kobo.4145.1">, add the highlighted code from the following </span><span class="No-Break"><span class="koboSpan" id="kobo.4146.1">snippet :</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4147.1">
&lt;HorizontalStackLayout HorizontalOptions="Start"&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.4148.1">    &lt;ImageButton Command="{Binding ForfeitCommand}" ToolTipProperties.Text="Return to the </span></strong><strong class="bold"><span class="koboSpan" id="kobo.4149.1">l</span></strong><strong class="bold"><span class="koboSpan" id="kobo.4150.1">obby."&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4151.1">        &lt;ImageButton.Source&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4152.1">            &lt;FontImageSource Glyph="&amp;#xf0a8;" FontFamily="FontAwesome" Color="White" Size="28" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4153.1">        &lt;/ImageButton.Source&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4154.1">    &lt;/ImageButton&gt;</span></strong><span class="koboSpan" id="kobo.4155.1">
&lt;/HorizontalStackLayout&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.4156.1">When it is the player’s turn, they have two buttons that are enabled, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4157.1">Play</span></strong><span class="koboSpan" id="kobo.4158.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4159.1">Undo</span></strong><span class="koboSpan" id="kobo.4160.1">. </span><span class="koboSpan" id="kobo.4160.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.4161.1">Play</span></strong><span class="koboSpan" id="kobo.4162.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4163.1">Undo</span></strong><span class="koboSpan" id="kobo.4164.1"> buttons are placed in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4165.1">TitleView</span></strong><span class="koboSpan" id="kobo.4166.1"> area of the .NET MAUI page. </span><span class="koboSpan" id="kobo.4166.2">Add the following highlighted code to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4167.1">Play</span></strong><span class="koboSpan" id="kobo.4168.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4169.1">Undo</span></strong><span class="koboSpan" id="kobo.4170.1"> buttons </span><span class="No-Break"><span class="koboSpan" id="kobo.4171.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4172.1">TitleView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4173.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4174.1">
&lt;HorizontalStackLayout HorizontalOptions="End"&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.4175.1">    &lt;ImageButton Command="{Binding UndoCommand}" IsVisible="{Binding IsCurrentPlayersTurn}" ToolTipProperties.Text="Undo the last stick placement."&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4176.1">        &lt;ImageButton.Source&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4177.1">            &lt;FontImageSource Glyph="&amp;#xf0e2;" FontFamily="FontAwesome" Color="White" Size="28" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4178.1">        &lt;/ImageButton.Source&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4179.1">    &lt;/ImageButton&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4180.1">    &lt;ImageButton Command="{Binding PlayCommand}" IsVisible="{Binding IsCurrentPlayersTurn}" ToolTipProperties.Text="Send the stick placement, and end my turn."&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4181.1">        &lt;ImageButton.Source&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4182.1">            &lt;FontImageSource Glyph="&amp;#xf1d8;" FontFamily="FontAwesome" Color="White" Size="28" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4183.1">        &lt;/ImageButton.Source&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4184.1">    &lt;/ImageButton&gt;</span></strong><span class="koboSpan" id="kobo.4185.1">
&lt;/HorizontalStackLayout&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.4186.1">Remove </span><a id="_idIndexMarker1148"/><span class="koboSpan" id="kobo.4187.1">the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.4188.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.4189.1"> element in </span><strong class="source-inline"><span class="koboSpan" id="kobo.4190.1">ContentView</span></strong><span class="koboSpan" id="kobo.4191.1"> and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.4192.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4193.1">
&lt;ContentView&gt;
    &lt;Grid&gt;
        &lt;Grid.RowDefinitions&gt;
            &lt;RowDefinition Height="4*" /&gt;
            &lt;RowDefinition Height="2*" /&gt;
            &lt;RowDefinition Height="6*" /&gt;
            &lt;RowDefinition Height="2*" /&gt;
        &lt;/Grid.RowDefinitions&gt;
    &lt;/Grid&gt;
&lt;/ContentView&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4194.1">This adds a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4195.1">Grid</span></strong><span class="koboSpan" id="kobo.4196.1"> control with four rows. </span><span class="koboSpan" id="kobo.4196.2">The first and third rows will contain the scoreboard and the game board, respectively, while the second and fourth rows </span><span class="No-Break"><span class="koboSpan" id="kobo.4197.1">are padding.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.4198.1">The main </span><a id="_idIndexMarker1149"/><span class="koboSpan" id="kobo.4199.1">layout is ready. </span><span class="koboSpan" id="kobo.4199.2">Next, the scoreboard is added to the first row of </span><span class="No-Break"><span class="koboSpan" id="kobo.4200.1">the layout.</span></span></p>
<h4><span class="koboSpan" id="kobo.4201.1">Creating the scoreboard</span></h4>
<p><span class="koboSpan" id="kobo.4202.1">The scoreboard contains each player’s avatar, gamer tag, and score. </span><span class="koboSpan" id="kobo.4202.2">The elements are bound to </span><a id="_idIndexMarker1150"/><span class="koboSpan" id="kobo.4203.1">the respective fields of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4204.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.4205.1"> for the player. </span><span class="koboSpan" id="kobo.4205.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.4206.1">Match</span></strong><span class="koboSpan" id="kobo.4207.1"> object has two properties, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4208.1">PlayerOne</span></strong><span class="koboSpan" id="kobo.4209.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4210.1">PlayerTwo</span></strong><span class="koboSpan" id="kobo.4211.1">, each of which is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4212.1">MatchPlayerViewModel</span></strong><span class="koboSpan" id="kobo.4213.1">. </span><span class="koboSpan" id="kobo.4213.2">To add the scoreboard, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.4214.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.4215.1">Each player is identified by a different color. </span><span class="koboSpan" id="kobo.4215.2">To add each color as a resource, open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4216.1">Colors.xaml</span></strong><span class="koboSpan" id="kobo.4217.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4218.1">Resources/Styles</span></strong><span class="koboSpan" id="kobo.4219.1"> folder of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4220.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.4221.1"> project and add the following lines to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4222.1">ResourceDictionary</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4223.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4224.1">
&lt;Color x:Key="PlayerOne"&gt;#6495ED&lt;/Color&gt;
&lt;Color x:Key="PlayerTwo"&gt;#CD5C5C&lt;/Color&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.4225.1">The scoreboard uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.4226.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.4227.1"> for the outer container. </span><span class="koboSpan" id="kobo.4227.2">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4228.1">Grid</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4229.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4230.1">
&lt;HorizontalStackLayout Grid.Row="0" HorizontalOptions="CenterAndExpand" Margin="10" BindableLayout.ItemsSource="{Binding Players}"&gt;
&lt;/HorizontalStackLayout&gt;</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.4231.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.4232.1"> is assigned to row </span><strong class="source-inline"><span class="koboSpan" id="kobo.4233.1">0</span></strong><span class="koboSpan" id="kobo.4234.1"> of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4235.1">Grid</span></strong><span class="koboSpan" id="kobo.4236.1">, and its contents are bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4237.1">Players</span></strong><span class="koboSpan" id="kobo.4238.1"> property of the view model, using </span><strong class="source-inline"><span class="koboSpan" id="kobo.4239.1">BindableLayout.ItemsSource</span></strong><span class="koboSpan" id="kobo.4240.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.4241.1">BindableLayout</span></strong><span class="koboSpan" id="kobo.4242.1"> is the underlying interface that supports all layout controls, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.4243.1">AbsoluteLayout</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.4244.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4245.1">FlexLayout</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4246.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.4247.1">Each player will have their own card within </span><strong class="source-inline"><span class="koboSpan" id="kobo.4248.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.4249.1">. </span><span class="koboSpan" id="kobo.4249.2">Since the control is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4250.1">Players</span></strong><span class="koboSpan" id="kobo.4251.1"> property, which is an array of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4252.1">MatchPlayerViewModels</span></strong><span class="koboSpan" id="kobo.4253.1">, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4254.1">BindableLayout.ItemTemplate</span></strong><span class="koboSpan" id="kobo.4255.1"> property </span><a id="_idIndexMarker1151"/><span class="koboSpan" id="kobo.4256.1">provides the view that each item in </span><strong class="source-inline"><span class="koboSpan" id="kobo.4257.1">Players</span></strong><span class="koboSpan" id="kobo.4258.1"> is displayed with. </span><span class="koboSpan" id="kobo.4258.2">The cards are laid out using a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4259.1">Border</span></strong><span class="koboSpan" id="kobo.4260.1"> element and nested </span><strong class="source-inline"><span class="koboSpan" id="kobo.4261.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.4262.1"> elements. </span><span class="koboSpan" id="kobo.4262.2">Add the following highlighted code </span><span class="No-Break"><span class="koboSpan" id="kobo.4263.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4264.1">HorizontalStackLayout</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4265.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4266.1">
&lt;HorizontalStackLayout Grid.Row="0" HorizontalOptions="CenterAndExpand" Margin="10"&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.4267.1">    &lt;BindableLayout.ItemTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4268.1">        &lt;DataTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4269.1">            &lt;Border x:DataType="viewModels:MatchPlayerViewModel" Padding="0" Margin="2" StrokeShape="RoundRectangle 10,10,10,10" HeightRequest="175"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4270.1">                &lt;VerticalStackLayout Padding="2" HorizontalOptions="Center"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4271.1">                &lt;/VerticalStackLayout&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4272.1">            &lt;/Border&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4273.1">        &lt;/DataTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4274.1">    &lt;/BindableLayout.ItemTemplate&gt;</span></strong><span class="koboSpan" id="kobo.4275.1">
&lt;/HorizontalStackLayout&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.4276.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.4277.1">Border</span></strong><span class="koboSpan" id="kobo.4278.1"> element is the outermost container for the player card. </span><span class="koboSpan" id="kobo.4278.2">To set the border color and background color of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4279.1">Border</span></strong><span class="koboSpan" id="kobo.4280.1"> element based on </span><strong class="source-inline"><span class="koboSpan" id="kobo.4281.1">PlayerToken</span></strong><span class="koboSpan" id="kobo.4282.1">, triggers are used (</span><a href="https://learn.microsoft.com/en-us/dotnet/maui/fundamentals/triggers"><span class="koboSpan" id="kobo.4283.1">https://learn.microsoft.com/en-us/dotnet/maui/fundamentals/triggers</span></a><span class="koboSpan" id="kobo.4284.1">) – specifically, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4285.1">DataTrigger</span></strong><span class="koboSpan" id="kobo.4286.1"> is used to set attribute values based on some other value. </span><span class="koboSpan" id="kobo.4286.2">Add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4287.1">Border</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4288.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4289.1">
&lt;Border.Triggers&gt;
    &lt;DataTrigger TargetType="Border" Binding="{Binding PlayerToken}" Value="1" &gt;
        &lt;Setter Property="Stroke" Value="{StaticResource PlayerOne}" /&gt;
        &lt;Setter Property="BackgroundColor" Value="{StaticResource PlayerOne}" /&gt;
    &lt;/DataTrigger&gt;
    &lt;DataTrigger TargetType="Border" Binding="{Binding PlayerToken}" Value="-1" &gt;
        &lt;Setter Property="Stroke" Value="{StaticResource PlayerTwo}" /&gt;
        &lt;Setter Property="BackgroundColor" Value="{StaticResource PlayerTwo}" /&gt;
    &lt;/DataTrigger&gt;
&lt;/Border.Triggers&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4290.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.4291.1">DataTrigger</span></strong><span class="koboSpan" id="kobo.4292.1"> binding </span><a id="_idIndexMarker1152"/><span class="koboSpan" id="kobo.4293.1">attribute is compared to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4294.1">Value</span></strong><span class="koboSpan" id="kobo.4295.1"> attribute. </span><span class="koboSpan" id="kobo.4295.2">If they are equal, then the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4296.1">Setter</span></strong><span class="koboSpan" id="kobo.4297.1"> elements of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4298.1">DataTrigger</span></strong><span class="koboSpan" id="kobo.4299.1"> are executed. </span><span class="koboSpan" id="kobo.4299.2">In this case, if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4300.1">PlayerToken</span></strong><span class="koboSpan" id="kobo.4301.1"> property is </span><strong class="source-inline"><span class="koboSpan" id="kobo.4302.1">-1</span></strong><span class="koboSpan" id="kobo.4303.1">, then set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4304.1">Stroke</span></strong><span class="koboSpan" id="kobo.4305.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4306.1">BackgroundColor</span></strong><span class="koboSpan" id="kobo.4307.1"> attributes of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4308.1">Border</span></strong><span class="koboSpan" id="kobo.4309.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4310.1">PlayerOne</span></strong><span class="koboSpan" id="kobo.4311.1"> color that was defined in </span><em class="italic"><span class="koboSpan" id="kobo.4312.1">step 1</span></em><span class="koboSpan" id="kobo.4313.1">. </span><span class="koboSpan" id="kobo.4313.2">Otherwise, if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4314.1">PlayerToken</span></strong><span class="koboSpan" id="kobo.4315.1"> property is equal to </span><strong class="source-inline"><span class="koboSpan" id="kobo.4316.1">-1</span></strong><span class="koboSpan" id="kobo.4317.1">, then set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4318.1">Stroke</span></strong><span class="koboSpan" id="kobo.4319.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4320.1">BackgroundColor</span></strong><span class="koboSpan" id="kobo.4321.1"> attributes to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4322.1">PlayerTwo</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4323.1"> color.</span></span></p></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.4324.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.4325.1"> contains another </span><strong class="source-inline"><span class="koboSpan" id="kobo.4326.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.4327.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4328.1">Border</span></strong><span class="koboSpan" id="kobo.4329.1"> element, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.4330.1">highlighted code:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.4331.1">&lt;VerticalStackLayout BackgroundColor="{Binding PlayerToken, Converter={StaticResource PlayerToColor}}" Padding="2" HorizontalOptions="Center"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4332.1">    &lt;VerticalStackLayout&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4333.1">    &lt;/VerticalStackLayout&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4334.1">    &lt;Border Padding="0" WidthRequest="96" StrokeShape="RoundRectangle 10,10,10,10" StrokeThickness="0"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4335.1">        &lt;Image IsVisible="{Binding IsPlayersTurn}" Source="hstick.jpeg" Aspect="AspectFit" MaximumHeightRequest="36"/&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4336.1">    &lt;/Border&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4337.1">&lt;/VerticalStackLayout&gt;</span></strong></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.4338.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.4339.1"> will be used to hold </span><strong class="source-inline"><span class="koboSpan" id="kobo.4340.1">GamerTag</span></strong><span class="koboSpan" id="kobo.4341.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4342.1">AvatarImage</span></strong><span class="koboSpan" id="kobo.4343.1">, and the player’s score, which is added in the next step. </span><strong class="source-inline"><span class="koboSpan" id="kobo.4344.1">Border</span></strong><span class="koboSpan" id="kobo.4345.1"> contains a horizontal </span><a id="_idIndexMarker1153"/><span class="koboSpan" id="kobo.4346.1">stick image whose </span><strong class="source-inline"><span class="koboSpan" id="kobo.4347.1">IsVisible</span></strong><span class="koboSpan" id="kobo.4348.1"> attribute is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4349.1">IsPlayersTurn</span></strong><span class="koboSpan" id="kobo.4350.1"> property. </span><span class="koboSpan" id="kobo.4350.2">The stick is used as a visual indicator of which player’s turn it is. </span><span class="koboSpan" id="kobo.4350.3">If it is not the player’s turn, the image is </span><span class="No-Break"><span class="koboSpan" id="kobo.4351.1">not displayed.</span></span></p></li> <li><span class="koboSpan" id="kobo.4352.1">Within the second </span><strong class="source-inline"><span class="koboSpan" id="kobo.4353.1">VerticalStackLayout</span></strong><span class="koboSpan" id="kobo.4354.1"> are a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4355.1">Label</span></strong><span class="koboSpan" id="kobo.4356.1"> and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4357.1">FlexLayout</span></strong><span class="koboSpan" id="kobo.4358.1">. </span><span class="koboSpan" id="kobo.4358.2">Add the following </span><span class="No-Break"><span class="koboSpan" id="kobo.4359.1">highlighted code:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.4360.1">&lt;VerticalStackLayout&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4361.1">    &lt;Label Text="{Binding GamerTag}" HorizontalOptions="FillAndExpand" HorizontalTextAlignment="Center" FontSize="18" FontFamily="OpenSansSemibold"/&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4362.1">    &lt;FlexLayout Margin="3"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4363.1">    &lt;/FlexLayout&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4364.1">&lt;/VerticalStackLayout&gt;</span></strong></pre></li> <li><strong class="source-inline"><span class="koboSpan" id="kobo.4365.1">FlexLayout</span></strong><span class="koboSpan" id="kobo.4366.1"> contains the visual elements to display </span><strong class="source-inline"><span class="koboSpan" id="kobo.4367.1">AvatarImage</span></strong><span class="koboSpan" id="kobo.4368.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4369.1">Score</span></strong><span class="koboSpan" id="kobo.4370.1">. </span><span class="koboSpan" id="kobo.4370.2">Add the </span><a id="_idIndexMarker1154"/><span class="koboSpan" id="kobo.4371.1">following highlighted code </span><span class="No-Break"><span class="koboSpan" id="kobo.4372.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4373.1">FlexLayout</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4374.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.4375.1">&lt;FlexLayout Margin="3"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4376.1">    &lt;toolkit:AvatarView FlexLayout.Order="0" Margin="0" BackgroundColor="LightGrey" HeightRequest="85" WidthRequest="85" CornerRadius="50" VerticalOptions="Center" HorizontalOptions="Center"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4377.1">        &lt;toolkit:AvatarView.ImageSource&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4378.1">            &lt;toolkit:GravatarImageSource</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4379.1">                Email="{Binding EmailAddress}"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4380.1">                Image="MysteryPerson" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4381.1">        &lt;/toolkit:AvatarView.ImageSource&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4382.1">        &lt;toolkit:AvatarView.Triggers&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4383.1">            &lt;DataTrigger TargetType="toolkit:AvatarView" Binding="{Binding Path=PlayerToken}" Value="-1"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4384.1">                &lt;Setter Property="FlexLayout.Order" Value="1" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4385.1">            &lt;/DataTrigger&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4386.1">        &lt;/toolkit:AvatarView.Triggers&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4387.1">    &lt;/toolkit:AvatarView&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4388.1">    &lt;Label FlexLayout.Order="1" Text="{Binding Score}" FontSize="48" Padding="5" MinimumWidthRequest="65" HorizontalTextAlignment="Center"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4389.1">        &lt;Label.Triggers&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4390.1">            &lt;DataTrigger TargetType="Label" Binding="{Binding Path=PlayerToken}" Value="-1"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4391.1">                &lt;Setter Property="FlexLayout.Order" Value="0" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4392.1">            &lt;/DataTrigger&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4393.1">        &lt;/Label.Triggers&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4394.1">    &lt;/Label&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.4395.1">&lt;/FlexLayout&gt;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.4396.1">By using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4397.1">FlexLayout</span></strong><span class="koboSpan" id="kobo.4398.1"> control, the order in which the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4399.1">FlexLayout</span></strong><span class="koboSpan" id="kobo.4400.1"> children </span><a id="_idIndexMarker1155"/><span class="koboSpan" id="kobo.4401.1">are displayed is governed by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4402.1">FlexLayout.Order</span></strong><span class="koboSpan" id="kobo.4403.1"> attribute. </span><span class="koboSpan" id="kobo.4403.2">Similar to </span><strong class="source-inline"><span class="koboSpan" id="kobo.4404.1">Grid</span></strong><span class="koboSpan" id="kobo.4405.1"> with its </span><strong class="source-inline"><span class="koboSpan" id="kobo.4406.1">Grid.Row</span></strong><span class="koboSpan" id="kobo.4407.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4408.1">Grid.Column</span></strong><span class="koboSpan" id="kobo.4409.1"> properties on its children, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4410.1">Order</span></strong><span class="koboSpan" id="kobo.4411.1"> attribute is set on the child. </span><span class="koboSpan" id="kobo.4411.2">The order of the children in </span><strong class="source-inline"><span class="koboSpan" id="kobo.4412.1">FlexLayout</span></strong><span class="koboSpan" id="kobo.4413.1"> is changed through the use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4414.1">Trigger</span></strong><span class="koboSpan" id="kobo.4415.1">. </span><span class="koboSpan" id="kobo.4415.2">On </span><strong class="source-inline"><span class="koboSpan" id="kobo.4416.1">AvatarView</span></strong><span class="koboSpan" id="kobo.4417.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4418.1">DataTrigger</span></strong><span class="koboSpan" id="kobo.4419.1"> will set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4420.1">FlexLayout.Order</span></strong><span class="koboSpan" id="kobo.4421.1"> attribute to </span><strong class="source-inline"><span class="koboSpan" id="kobo.4422.1">"1"</span></strong><span class="koboSpan" id="kobo.4423.1"> if the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4424.1">PlayerToken</span></strong><span class="koboSpan" id="kobo.4425.1"> property is equal to </span><strong class="source-inline"><span class="koboSpan" id="kobo.4426.1">-1</span></strong><span class="koboSpan" id="kobo.4427.1">, which is </span><strong class="source-inline"><span class="koboSpan" id="kobo.4428.1">PlayerTwo</span></strong><span class="koboSpan" id="kobo.4429.1">. </span><span class="koboSpan" id="kobo.4429.2">On the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4430.1">Label</span></strong><span class="koboSpan" id="kobo.4431.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4432.1">DataTrigger</span></strong><span class="koboSpan" id="kobo.4433.1"> sets the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4434.1">FlexLayout.Order</span></strong><span class="koboSpan" id="kobo.4435.1"> attribute to </span><strong class="source-inline"><span class="koboSpan" id="kobo.4436.1">"0"</span></strong><span class="koboSpan" id="kobo.4437.1">, effectively swapping the </span><span class="No-Break"><span class="koboSpan" id="kobo.4438.1">two elements.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.4439.1">And that concludes the scoreboard. </span><span class="koboSpan" id="kobo.4439.2">The final part of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4440.1">MatchView</span></strong><span class="koboSpan" id="kobo.4441.1"> is the largest: the board. </span><span class="koboSpan" id="kobo.4441.2">Read on to learn how to create the </span><span class="No-Break"><span class="koboSpan" id="kobo.4442.1">board visuals.</span></span></p>
<h4><span class="koboSpan" id="kobo.4443.1">Creating the game board</span></h4>
<p><span class="koboSpan" id="kobo.4444.1">The game </span><a id="_idIndexMarker1156"/><span class="koboSpan" id="kobo.4445.1">board is composed of three different elements. </span><span class="koboSpan" id="kobo.4445.2">These elements are dots in the corners of each square, sticks (both horizontal and vertical), and stones. </span><span class="koboSpan" id="kobo.4445.3">These elements are laid out as </span><span class="No-Break"><span class="koboSpan" id="kobo.4446.1">shown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer179">
<span class="koboSpan" id="kobo.4447.1"><img alt="Figure 10.14 – The game board" src="image/B19214_10_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.4448.1">Figure 10.14 – The game board</span></p>
<p><span class="koboSpan" id="kobo.4449.1">The board uses a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4450.1">Grid</span></strong><span class="koboSpan" id="kobo.4451.1"> control to provide the basic layout. </span><span class="koboSpan" id="kobo.4451.2">Using 7 columns and 7 rows will provide cells for each of the elements: 16 dots, 9 stones, and 24 sticks. </span><span class="koboSpan" id="kobo.4451.3">Add the following </span><a id="_idIndexMarker1157"/><span class="koboSpan" id="kobo.4452.1">code to provide the basic layout of the game board to the top-level </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4453.1">Grid</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4454.1"> element:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.4455.1">
&lt;Grid Grid.Row="2" BackgroundColor="White" Margin="10,40,10,0" MaximumHeightRequest="410" MaximumWidthRequest="400" &gt;
    &lt;Grid.ColumnDefinitions&gt;
        &lt;ColumnDefinition Width="1*" /&gt;
        &lt;ColumnDefinition Width="5*" /&gt;
        &lt;ColumnDefinition Width="1*" /&gt;
        &lt;ColumnDefinition Width="5*" /&gt;
        &lt;ColumnDefinition Width="1*" /&gt;
        &lt;ColumnDefinition Width="5*" /&gt;
        &lt;ColumnDefinition Width="1*" /&gt;
    &lt;/Grid.ColumnDefinitions&gt;
    &lt;Grid.RowDefinitions&gt;
        &lt;RowDefinition Height="1*" /&gt;
        &lt;RowDefinition Height="4*" /&gt;
        &lt;RowDefinition Height="1*" /&gt;
        &lt;RowDefinition Height="4*" /&gt;
        &lt;RowDefinition Height="1*" /&gt;
        &lt;RowDefinition Height="4*" /&gt;
        &lt;RowDefinition Height="1*" /&gt;
    &lt;/Grid.RowDefinitions&gt; 
&lt;/Grid&gt;</span></pre> <p><span class="koboSpan" id="kobo.4456.1">Let’s start by adding the corners to the grid, since they are the simplest. </span><span class="koboSpan" id="kobo.4456.2">To define a corner, use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4457.1">Label</span></strong><span class="koboSpan" id="kobo.4458.1"> with the text </span><strong class="source-inline"><span class="koboSpan" id="kobo.4459.1">"&amp;#x26AB;"</span></strong><span class="koboSpan" id="kobo.4460.1">, which is the hexadecimal character code for a dot. </span><span class="koboSpan" id="kobo.4460.2">To center the dot horizontally and vertically, set </span><strong class="source-inline"><span class="koboSpan" id="kobo.4461.1">HorizontalOptions</span></strong><span class="koboSpan" id="kobo.4462.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4463.1">VerticalOptions</span></strong><span class="koboSpan" id="kobo.4464.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.4465.1">"Center"</span></strong><span class="koboSpan" id="kobo.4466.1">. </span><span class="koboSpan" id="kobo.4466.2">Your basic element would look like </span><span class="No-Break"><span class="koboSpan" id="kobo.4467.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.4468.1">
&lt;Label Text="&amp;#x26AB" HorizontalOptions="Center" VerticalOptions="Center" /&gt;</span></pre> <p><span class="koboSpan" id="kobo.4469.1">Without the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4470.1">Grid.Row</span></strong><span class="koboSpan" id="kobo.4471.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4472.1">Grid.Column</span></strong><span class="koboSpan" id="kobo.4473.1"> attributes, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4474.1">Label</span></strong><span class="koboSpan" id="kobo.4475.1"> will be put into row </span><strong class="source-inline"><span class="koboSpan" id="kobo.4476.1">0</span></strong><span class="koboSpan" id="kobo.4477.1"> and column </span><strong class="source-inline"><span class="koboSpan" id="kobo.4478.1">0</span></strong><span class="koboSpan" id="kobo.4479.1">. </span><span class="koboSpan" id="kobo.4479.2">There are 16 corners in the grid, and they occupy all the even-numbered cells, so </span><strong class="source-inline"><span class="koboSpan" id="kobo.4480.1">(0,0)</span></strong><span class="koboSpan" id="kobo.4481.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4482.1">(0,2)</span></strong><span class="koboSpan" id="kobo.4483.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4484.1">(0,4)</span></strong><span class="koboSpan" id="kobo.4485.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4486.1">(0,6)</span></strong><span class="koboSpan" id="kobo.4487.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4488.1">(2,0)</span></strong><span class="koboSpan" id="kobo.4489.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4490.1">(2,2)</span></strong><span class="koboSpan" id="kobo.4491.1">, and so on. </span><span class="koboSpan" id="kobo.4491.2">Fully defined labels </span><a id="_idIndexMarker1158"/><span class="koboSpan" id="kobo.4492.1">for the first row would look like </span><span class="No-Break"><span class="koboSpan" id="kobo.4493.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.4494.1">
            &lt;Label Grid.Row="0" Grid.Column="0" Text="&amp;#x26AB" HorizontalOptions="Center" VerticalOptions="Center" /&gt;
            &lt;Label Grid.Row="0" Grid.Column="2" Text="&amp;#x26AB" HorizontalOptions="Center" VerticalOptions="Center" /&gt;
            &lt;Label Grid.Row="0" Grid.Column="4" Text="&amp;#x26AB" HorizontalOptions="Center" VerticalOptions="Center" /&gt;
            &lt;Label Grid.Row="0" Grid.Column="6" Text="&amp;#x26AB" HorizontalOptions="Center" VerticalOptions="Center" /&gt;</span></pre> <p><span class="koboSpan" id="kobo.4495.1">When you work this out for all 16 rows, that’s a lot of duplication of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4496.1">Text</span></strong><span class="koboSpan" id="kobo.4497.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4498.1">HorizontalOptions</span></strong><span class="koboSpan" id="kobo.4499.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4500.1">VerticalOptions</span></strong><span class="koboSpan" id="kobo.4501.1"> attributes. </span><span class="koboSpan" id="kobo.4501.2">By using a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4502.1">Style</span></strong><span class="koboSpan" id="kobo.4503.1"> element, that duplication can be eliminated. </span><span class="koboSpan" id="kobo.4503.2">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.4504.1">Style</span></strong><span class="koboSpan" id="kobo.4505.1"> element contains </span><strong class="source-inline"><span class="koboSpan" id="kobo.4506.1">Setter</span></strong><span class="koboSpan" id="kobo.4507.1"> elements such as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4508.1">DataTrigger</span></strong><span class="koboSpan" id="kobo.4509.1"> elements. </span><span class="koboSpan" id="kobo.4509.2">When </span><strong class="source-inline"><span class="koboSpan" id="kobo.4510.1">Style</span></strong><span class="koboSpan" id="kobo.4511.1"> is applied to the element, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4512.1">Setter</span></strong><span class="koboSpan" id="kobo.4513.1"> elements are used to update the target element’s attributes. </span><span class="koboSpan" id="kobo.4513.2">Use the following steps to add the corner elements to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4514.1">Grid</span></strong><span class="koboSpan" id="kobo.4515.1"> control </span><span class="No-Break"><span class="koboSpan" id="kobo.4516.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4517.1">Style</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4518.1">:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.4519.1">Add the following </span><strong class="source-inline"><span class="koboSpan" id="kobo.4520.1">Style</span></strong><span class="koboSpan" id="kobo.4521.1"> element to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4522.1">ContentPage.Resources</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4523.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4524.1">
&lt;Style x:Key="dotLabel"
        TargetType="Label"&gt;
    &lt;Setter Property="Text" Value="&amp;#x26AB;" /&gt;
    &lt;Setter Property="HorizontalOptions" Value="Center" /&gt;
    &lt;Setter Property="VerticalOptions" Value="Center" /&gt;
&lt;/Style&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4525.1">This </span><strong class="source-inline"><span class="koboSpan" id="kobo.4526.1">Style</span></strong><span class="koboSpan" id="kobo.4527.1"> element is identified by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4528.1">x:Key</span></strong><span class="koboSpan" id="kobo.4529.1"> attribute. </span></p></li> <li><span class="koboSpan" id="kobo.4530.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4531.1">Label</span></strong><span class="koboSpan" id="kobo.4532.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4533.1">Grid</span></strong><span class="koboSpan" id="kobo.4534.1"> control created at the start of this section. </span></li>
<li><span class="koboSpan" id="kobo.4535.1">Set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4536.1">Grid.Row</span></strong><span class="koboSpan" id="kobo.4537.1"> attribute of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4538.1">Label</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.4539.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4540.1">0</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4541.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.4542.1">Set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4543.1">Grid.Column</span></strong><span class="koboSpan" id="kobo.4544.1"> attribute of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4545.1">Label</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.4546.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4547.1">0</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4548.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.4549.1">Set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4550.1">Style</span></strong><span class="koboSpan" id="kobo.4551.1"> attribute to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4552.1">{StaticResource dotLabel}</span></strong><span class="koboSpan" id="kobo.4553.1"> value. </span><span class="koboSpan" id="kobo.4553.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.4554.1">Style</span></strong><span class="koboSpan" id="kobo.4555.1"> attribute is </span><a id="_idIndexMarker1159"/><span class="koboSpan" id="kobo.4556.1">used to specify which style should be applied to the element. </span><span class="koboSpan" id="kobo.4556.2">Since </span><strong class="source-inline"><span class="koboSpan" id="kobo.4557.1">Style</span></strong><span class="koboSpan" id="kobo.4558.1"> is defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4559.1">ContentView.Resources</span></strong><span class="koboSpan" id="kobo.4560.1"> element, it is </span><span class="No-Break"><span class="koboSpan" id="kobo.4561.1">a </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4562.1">StaticResource</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4563.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.4564.1">The completed </span><strong class="source-inline"><span class="koboSpan" id="kobo.4565.1">Label</span></strong><span class="koboSpan" id="kobo.4566.1"> should look like </span><span class="No-Break"><span class="koboSpan" id="kobo.4567.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4568.1">
&lt;Label Grid.Row="0" Grid.Column="0" Style="{StaticResource dotLabel}" /&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.4569.1">Now, copy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4570.1">Label</span></strong><span class="koboSpan" id="kobo.4571.1"> just created and increase the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4572.1">Grid.Column</span></strong><span class="koboSpan" id="kobo.4573.1"> value by two, and repeat this step until you have four </span><strong class="source-inline"><span class="koboSpan" id="kobo.4574.1">Label</span></strong><span class="koboSpan" id="kobo.4575.1"> elements with the same </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4576.1">Grid.Row</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4577.1"> value.</span></span></li>
<li><span class="koboSpan" id="kobo.4578.1">Copy the last </span><strong class="source-inline"><span class="koboSpan" id="kobo.4579.1">Label</span></strong><span class="koboSpan" id="kobo.4580.1"> created in </span><em class="italic"><span class="koboSpan" id="kobo.4581.1">step 7</span></em><span class="koboSpan" id="kobo.4582.1"> and increase the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4583.1">Grid.Row</span></strong><span class="koboSpan" id="kobo.4584.1"> value by two and reset the value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4585.1">Grid.Column</span></strong><span class="koboSpan" id="kobo.4586.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.4587.1">0</span></strong><span class="koboSpan" id="kobo.4588.1">. </span><span class="koboSpan" id="kobo.4588.2">Now, repeat </span><em class="italic"><span class="koboSpan" id="kobo.4589.1">step 7</span></em><span class="koboSpan" id="kobo.4590.1"> using the updated </span><strong class="source-inline"><span class="koboSpan" id="kobo.4591.1">Grid.Row</span></strong><span class="koboSpan" id="kobo.4592.1"> value, and stop when there are four labels with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4593.1">Grid.Row</span></strong><span class="koboSpan" id="kobo.4594.1"> value </span><span class="No-Break"><span class="koboSpan" id="kobo.4595.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4596.1">6</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4597.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.4598.1">The labels </span><a id="_idIndexMarker1160"/><span class="koboSpan" id="kobo.4599.1">should look like the </span><span class="No-Break"><span class="koboSpan" id="kobo.4600.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4601.1">
&lt;Label Grid.Row="0" Grid.Column="0" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="0" Grid.Column="2" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="0" Grid.Column="4" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="0" Grid.Column="6" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="2" Grid.Column="0" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="2" Grid.Column="2" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="2" Grid.Column="4" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="2" Grid.Column="6" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="4" Grid.Column="0" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="4" Grid.Column="2" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="4" Grid.Column="4" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="4" Grid.Column="6" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="6" Grid.Column="0" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="6" Grid.Column="2" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="6" Grid.Column="4" Style="{StaticResource dotLabel}" /&gt;
&lt;Label Grid.Row="6" Grid.Column="6" Style="{StaticResource dotLabel}" /&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.4602.1">Now that the corners are done, we can start on the game pieces: the sticks and stones. </span><span class="koboSpan" id="kobo.4602.2">Since the sticks and stones have some similarities, we can create a common control to help display them all. </span><span class="koboSpan" id="kobo.4602.3">However, they are visualized entirely differently. </span><span class="koboSpan" id="kobo.4602.4">What is needed is a common </span><a id="_idIndexMarker1161"/><span class="koboSpan" id="kobo.4603.1">interface to define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4604.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.4605.1"> properties and use that on different layouts.</span><strong class="source-inline"><span class="koboSpan" id="kobo.4606.1">.NET</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.4607.1">MAUI</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.4608.1">uses</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.4609.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4610.1"> resources to allow for the customization, or even complete replacement, of the visual elements that comprise a control. </span><span class="koboSpan" id="kobo.4610.2">Many controls in .NET MAUI can be customized using a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4611.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4612.1">, if they derive from </span><strong class="source-inline"><span class="koboSpan" id="kobo.4613.1">ContentView</span></strong><span class="koboSpan" id="kobo.4614.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.4615.1">ContentPage</span></strong><span class="koboSpan" id="kobo.4616.1">. </span><span class="koboSpan" id="kobo.4616.2">Let’s get started with the sticks and stones by adding the custom control, then the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4617.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4618.1"> resources for sticks and stones, by following </span><span class="No-Break"><span class="koboSpan" id="kobo.4619.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.4620.1">Create a new class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4621.1">Controls</span></strong><span class="koboSpan" id="kobo.4622.1"> folder of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4623.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.4624.1"> project </span><span class="No-Break"><span class="koboSpan" id="kobo.4625.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4626.1">GamePieceView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4627.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.4628.1">Update the class definition to match the </span><span class="No-Break"><span class="koboSpan" id="kobo.4629.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4630.1">
namespace SticksAndStones.Controls;
</span><strong class="bold"><span class="koboSpan" id="kobo.4631.1">public partial</span></strong><span class="koboSpan" id="kobo.4632.1"> class GamePieceView </span><strong class="bold"><span class="koboSpan" id="kobo.4633.1">: ContentView</span></strong><span class="koboSpan" id="kobo.4634.1">
{
}</span></pre></li> <li><span class="koboSpan" id="kobo.4635.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4636.1">string</span></strong><span class="koboSpan" id="kobo.4637.1"> property and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4638.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.4639.1"> property named </span><strong class="source-inline"><span class="koboSpan" id="kobo.4640.1">GamePiecePosition</span></strong><span class="koboSpan" id="kobo.4641.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4642.1">GamePiecePositionProperty</span></strong><span class="koboSpan" id="kobo.4643.1">, respectively, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.4644.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4645.1">
public static readonly BindableProperty GamePiecePositionProperty = BindableProperty.Create(nameof(GamePiecePosition), typeof(string), typeof(GamePieceView), string.Empty);
public string GamePiecePosition
{
    get =&gt; (string)GetValue(GamePiecePositionProperty);
    set =&gt; SetValue(GamePiecePositionProperty, value);
}</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.4646.1">GamePiecePosition</span></strong><span class="koboSpan" id="kobo.4647.1"> is used </span><a id="_idIndexMarker1162"/><span class="koboSpan" id="kobo.4648.1">to determine the array index in either </span><strong class="source-inline"><span class="koboSpan" id="kobo.4649.1">Sticks</span></strong><span class="koboSpan" id="kobo.4650.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.4651.1">Stones</span></strong><span class="koboSpan" id="kobo.4652.1"> properties </span><span class="No-Break"><span class="koboSpan" id="kobo.4653.1">on </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4654.1">GameViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4655.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.4656.1">Add an </span><strong class="source-inline"><span class="koboSpan" id="kobo.4657.1">int</span></strong><span class="koboSpan" id="kobo.4658.1"> property and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4659.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.4660.1"> named </span><strong class="source-inline"><span class="koboSpan" id="kobo.4661.1">GamePieceState</span></strong><span class="koboSpan" id="kobo.4662.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4663.1">GamePieceStateProperty</span></strong><span class="koboSpan" id="kobo.4664.1">, respectively, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.4665.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4666.1">
public static readonly BindableProperty GamePieceStateProperty = BindableProperty.Create(nameof(GamePieceState), typeof(int), typeof(GamePieceView), 0, BindingMode.TwoWay);
public int GamePieceState
{
    get =&gt; (int)GetValue(GamePieceStateProperty);
    set =&gt; SetValue(GamePieceStateProperty, value);
}</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.4667.1">GamePieceState</span></strong><span class="koboSpan" id="kobo.4668.1"> is the owner of the piece: </span><strong class="source-inline"><span class="koboSpan" id="kobo.4669.1">1</span></strong><span class="koboSpan" id="kobo.4670.1"> for </span><strong class="source-inline"><span class="koboSpan" id="kobo.4671.1">PlayerOne</span></strong><span class="koboSpan" id="kobo.4672.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4673.1">0</span></strong><span class="koboSpan" id="kobo.4674.1"> for no one, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4675.1">-1</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.4676.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4677.1">PlayerTwo</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4678.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.4679.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4680.1">string</span></strong><span class="koboSpan" id="kobo.4681.1"> property and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4682.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.4683.1"> named </span><strong class="source-inline"><span class="koboSpan" id="kobo.4684.1">GamePieceDirection</span></strong><span class="koboSpan" id="kobo.4685.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4686.1">GamePieceDirectionProperty</span></strong><span class="koboSpan" id="kobo.4687.1">, respectively, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.4688.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4689.1">
public static readonly BindableProperty GamePieceDirectionProperty = BindableProperty.Create(nameof(GamePieceDirection), typeof(string), typeof(GamePieceView), null);
public string GamePieceDirection
{
    get =&gt; (string)GetValue(GamePieceDirectionProperty);
    set =&gt; SetValue(GamePieceDirectionProperty, value);
}</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.4690.1">GamePieceDirection</span></strong><span class="koboSpan" id="kobo.4691.1"> is only needed for </span><strong class="source-inline"><span class="koboSpan" id="kobo.4692.1">Sticks</span></strong><span class="koboSpan" id="kobo.4693.1"> and is either </span><strong class="source-inline"><span class="koboSpan" id="kobo.4694.1">Horizontal</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.4695.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4696.1">Vertical</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4697.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.4698.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4699.1">MatchView.Xaml</span></strong><span class="koboSpan" id="kobo.4700.1"> file again and let’s add a control template for all the sticks. </span><span class="koboSpan" id="kobo.4700.2">Add </span><a id="_idIndexMarker1163"/><span class="koboSpan" id="kobo.4701.1">the following snippet to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4702.1">ContentView.Resources</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4703.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4704.1">
&lt;ControlTemplate x:Key="StickViewControlTemplate"&gt;
&lt;/ControlTemplate&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4705.1">This defines a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4706.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4707.1"> element with a key of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4708.1">StickViewControlTemplate</span></strong><span class="koboSpan" id="kobo.4709.1">. </span><span class="koboSpan" id="kobo.4709.2">The key is used to apply the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4710.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4711.1"> element to </span><span class="No-Break"><span class="koboSpan" id="kobo.4712.1">the control.</span></span></p></li> <li><span class="koboSpan" id="kobo.4713.1">There are two elements to each stick visual: the number displayed on a label, and the stick image, which uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4714.1">Image</span></strong><span class="koboSpan" id="kobo.4715.1"> control inside a border to give it the outline, colored by the player that placed the stick. </span><span class="koboSpan" id="kobo.4715.2">The other interesting aspect is that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4716.1">Label</span></strong><span class="koboSpan" id="kobo.4717.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4718.1">Border</span></strong><span class="koboSpan" id="kobo.4719.1"> controls need to be layered on top of one another. </span><span class="koboSpan" id="kobo.4719.2">To accomplish this, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4720.1">Grid</span></strong><span class="koboSpan" id="kobo.4721.1"> control is used and both elements are placed in the same cell. </span><span class="koboSpan" id="kobo.4721.2">To add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4722.1">Grid</span></strong><span class="koboSpan" id="kobo.4723.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4724.1">Label</span></strong><span class="koboSpan" id="kobo.4725.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4726.1">Border</span></strong><span class="koboSpan" id="kobo.4727.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4728.1">Image</span></strong><span class="koboSpan" id="kobo.4729.1"> controls, use the following listing, and add them to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4730.1">ControlTemplate</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4731.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4732.1">
&lt;Grid Margin="0" Padding="0"&gt;
    &lt;Label Text="{TemplateBinding GamePiecePosition}" IsVisible="False" HorizontalTextAlignment="Center" VerticalTextAlignment="Center" TextColor="Red" FontAttributes="Bold" &gt;
    &lt;/Label&gt;
    &lt;Border Padding="3" BackgroundColor="Transparent" StrokeShape="RoundRectangle 5" Stroke="Transparent"&gt;
        &lt;Image Aspect="Fill"&gt;
        &lt;/Image&gt;
    &lt;/Border&gt;
&lt;/Grid&gt;</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.4733.1">Grid</span></strong><span class="koboSpan" id="kobo.4734.1"> has </span><strong class="source-inline"><span class="koboSpan" id="kobo.4735.1">Margin</span></strong><span class="koboSpan" id="kobo.4736.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4737.1">Padding</span></strong><span class="koboSpan" id="kobo.4738.1"> values of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4739.1">0</span></strong><span class="koboSpan" id="kobo.4740.1"> so that it doesn’t occupy any screen </span><a id="_idIndexMarker1164"/><span class="koboSpan" id="kobo.4741.1">real estate. </span><span class="koboSpan" id="kobo.4741.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.4742.1">Label</span></strong><span class="koboSpan" id="kobo.4743.1"> control’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.4744.1">Text</span></strong><span class="koboSpan" id="kobo.4745.1"> attribute is bound using </span><strong class="source-inline"><span class="koboSpan" id="kobo.4746.1">TemplateBinding</span></strong><span class="koboSpan" id="kobo.4747.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4748.1">GamePiecePosition</span></strong><span class="koboSpan" id="kobo.4749.1"> property. </span><strong class="source-inline"><span class="koboSpan" id="kobo.4750.1">TemplateBinding</span></strong><span class="koboSpan" id="kobo.4751.1"> differs slightly from </span><strong class="source-inline"><span class="koboSpan" id="kobo.4752.1">Binding</span></strong><span class="koboSpan" id="kobo.4753.1"> in that </span><strong class="source-inline"><span class="koboSpan" id="kobo.4754.1">TemplateBinding</span></strong><span class="koboSpan" id="kobo.4755.1"> uses the control this </span><strong class="source-inline"><span class="koboSpan" id="kobo.4756.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4757.1"> is applied to as </span><strong class="source-inline"><span class="koboSpan" id="kobo.4758.1">DataContext</span></strong><span class="koboSpan" id="kobo.4759.1">. </span><span class="koboSpan" id="kobo.4759.2">Since this </span><strong class="source-inline"><span class="koboSpan" id="kobo.4760.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4761.1"> will be applied to instances of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4762.1">GamePieceView</span></strong><span class="koboSpan" id="kobo.4763.1">, it will bind to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4764.1">Bindable</span></strong><span class="koboSpan" id="kobo.4765.1"> properties of </span><span class="No-Break"><span class="koboSpan" id="kobo.4766.1">those controls.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.4767.1">Inspecting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4768.1">Image</span></strong><span class="koboSpan" id="kobo.4769.1"> control from </span><em class="italic"><span class="koboSpan" id="kobo.4770.1">step 7</span></em><span class="koboSpan" id="kobo.4771.1">, you’ll find that it doesn’t specify which image is displayed. </span><span class="koboSpan" id="kobo.4771.2">For </span><strong class="source-inline"><span class="koboSpan" id="kobo.4772.1">Sticks</span></strong><span class="koboSpan" id="kobo.4773.1">, one of two images is displayed: either </span><strong class="source-inline"><span class="koboSpan" id="kobo.4774.1">hstick.jpeg</span></strong><span class="koboSpan" id="kobo.4775.1"> for horizontal sticks or </span><strong class="source-inline"><span class="koboSpan" id="kobo.4776.1">vstick.jpeg</span></strong><span class="koboSpan" id="kobo.4777.1"> for vertical sticks, and if there is no stick at that location, then the control should not be visible. </span><span class="koboSpan" id="kobo.4777.2">The following listing uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.4778.1">DataTrigger</span></strong><span class="koboSpan" id="kobo.4779.1"> to set the values of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4780.1">IsVisible</span></strong><span class="koboSpan" id="kobo.4781.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4782.1">Source</span></strong><span class="koboSpan" id="kobo.4783.1"> of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4784.1">Image</span></strong><span class="koboSpan" id="kobo.4785.1"> control using </span><strong class="source-inline"><span class="koboSpan" id="kobo.4786.1">TemplateBinding</span></strong><span class="koboSpan" id="kobo.4787.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4788.1">GamePieceState</span></strong><span class="koboSpan" id="kobo.4789.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4790.1">GamePieceDirection</span></strong><span class="koboSpan" id="kobo.4791.1"> properties. </span><span class="koboSpan" id="kobo.4791.2">Add this code to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4792.1">Image</span></strong><span class="koboSpan" id="kobo.4793.1"> control of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4794.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4795.1">: </span></p><pre class="source-code"><span class="koboSpan" id="kobo.4796.1">&lt;Image.Triggers&gt;
    &lt;DataTrigger TargetType="Image" Binding="{TemplateBinding Path=GamePieceState}" Value="0"&gt;
        &lt;Setter Property="IsVisible" Value="False" /&gt;
    &lt;/DataTrigger&gt;
    &lt;DataTrigger TargetType="Image" Binding="{TemplateBinding Path=GamePieceDirection}" Value="Horizontal"&gt;
         &lt;Setter Property="Source" Value="hstick.jpeg" /&gt;
    &lt;/DataTrigger&gt;
    &lt;DataTrigger TargetType="Image" Binding="{TemplateBinding Path=GamePieceDirection}" Value="Vertical"&gt;
         &lt;Setter Property="Source" Value="vstick.jpeg" /&gt;
    &lt;/DataTrigger&gt;
&lt;/Image.Triggers&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.4797.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.4798.1">Border</span></strong><span class="koboSpan" id="kobo.4799.1"> control also uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.4800.1">DataTrigger</span></strong><span class="koboSpan" id="kobo.4801.1"> to outline the stick in the color of the player </span><a id="_idIndexMarker1165"/><span class="koboSpan" id="kobo.4802.1">that placed the stick. </span><span class="koboSpan" id="kobo.4802.2">Add the following code to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4803.1">Border</span></strong><span class="koboSpan" id="kobo.4804.1"> element, </span><span class="No-Break"><span class="koboSpan" id="kobo.4805.1">after </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4806.1">Image</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4807.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4808.1">
&lt;Border.Triggers&gt;
    &lt;DataTrigger TargetType="Border" Binding="{TemplateBinding GamePieceState}" Value="1" &gt;
        &lt;Setter Property="Stroke" Value="{StaticResource PlayerOne}" /&gt;
    &lt;/DataTrigger&gt;
    &lt;DataTrigger TargetType="Border" Binding="{TemplateBinding GamePieceState}" Value="-1" &gt;
        &lt;Setter Property="Stroke" Value="{StaticResource PlayerTwo}" /&gt;
    &lt;/DataTrigger&gt;
&lt;/Border.Triggers&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4809.1">Two triggers are needed to switch between </span><strong class="source-inline"><span class="koboSpan" id="kobo.4810.1">PlayerOne</span></strong><span class="koboSpan" id="kobo.4811.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.4812.1">1</span></strong><span class="koboSpan" id="kobo.4813.1">) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4814.1">PlayerTwo</span></strong><span class="koboSpan" id="kobo.4815.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.4816.1">-1</span></strong><span class="koboSpan" id="kobo.4817.1">). </span><span class="koboSpan" id="kobo.4817.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.4818.1">Stroke</span></strong><span class="koboSpan" id="kobo.4819.1"> attribute of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4820.1">Border</span></strong><span class="koboSpan" id="kobo.4821.1"> control is set to the color resource of the player. </span><span class="koboSpan" id="kobo.4821.2">If neither trigger is active, then the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.4822.1">Stroke</span></strong><span class="koboSpan" id="kobo.4823.1"> value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4824.1">Transparent</span></strong><span class="koboSpan" id="kobo.4825.1"> from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4826.1">Border</span></strong><span class="koboSpan" id="kobo.4827.1"> element is used. </span><span class="koboSpan" id="kobo.4827.2">In this way, if there is no stick, </span><strong class="source-inline"><span class="koboSpan" id="kobo.4828.1">GamePieceState</span></strong><span class="koboSpan" id="kobo.4829.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.4830.1">0</span></strong><span class="koboSpan" id="kobo.4831.1">, and the border is transparent. </span><span class="koboSpan" id="kobo.4831.2">If </span><strong class="source-inline"><span class="koboSpan" id="kobo.4832.1">GamePieceState</span></strong><span class="koboSpan" id="kobo.4833.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.4834.1">1</span></strong><span class="koboSpan" id="kobo.4835.1">, then </span><strong class="source-inline"><span class="koboSpan" id="kobo.4836.1">Stroke</span></strong><span class="koboSpan" id="kobo.4837.1"> will have the color defined by the resource named </span><strong class="source-inline"><span class="koboSpan" id="kobo.4838.1">PlayerOne</span></strong><span class="koboSpan" id="kobo.4839.1">, and if </span><strong class="source-inline"><span class="koboSpan" id="kobo.4840.1">GamePieceState</span></strong><span class="koboSpan" id="kobo.4841.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.4842.1">-1</span></strong><span class="koboSpan" id="kobo.4843.1">, then the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4844.1">Stroke</span></strong><span class="koboSpan" id="kobo.4845.1"> value will be the resource </span><span class="No-Break"><span class="koboSpan" id="kobo.4846.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4847.1">PlayerTwo</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4848.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.4849.1">When the </span><a id="_idIndexMarker1166"/><span class="koboSpan" id="kobo.4850.1">user is making their move during their turn, they will tap or click on the label to place their stick in that position. </span><span class="koboSpan" id="kobo.4850.2">To call </span><strong class="source-inline"><span class="koboSpan" id="kobo.4851.1">SelectStickCommand</span></strong><span class="koboSpan" id="kobo.4852.1"> when that occurs, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4853.1">Border</span></strong><span class="koboSpan" id="kobo.4854.1"> control binds </span><strong class="source-inline"><span class="koboSpan" id="kobo.4855.1">TapGestureRecognizer</span></strong><span class="koboSpan" id="kobo.4856.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4857.1">GameViewModel.SelectStickCommand</span></strong><span class="koboSpan" id="kobo.4858.1"> property and passes </span><strong class="source-inline"><span class="koboSpan" id="kobo.4859.1">GamePiecePosition</span></strong><span class="koboSpan" id="kobo.4860.1"> along as a parameter. </span><span class="koboSpan" id="kobo.4860.2">Add the following listing to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4861.1">Border</span></strong><span class="koboSpan" id="kobo.4862.1"> element, after the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4863.1">Border.Triggers</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4864.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4865.1">
&lt;Border.GestureRecognizers&gt;
    &lt;TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:GameViewModel}}, Path=SelectStickCommand}" CommandParameter="{TemplateBinding GamePiecePosition}" /&gt;
&lt;/Border.GestureRecognizers&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.4866.1">Finally, take a close look at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4867.1">Label</span></strong><span class="koboSpan" id="kobo.4868.1"> element; you will see that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4869.1">IsVisible</span></strong><span class="koboSpan" id="kobo.4870.1"> attribute is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.4871.1">False</span></strong><span class="koboSpan" id="kobo.4872.1">. </span><span class="koboSpan" id="kobo.4872.2">If there is no stick placed at this position, then we </span><a id="_idIndexMarker1167"/><span class="koboSpan" id="kobo.4873.1">need the label with the position displayed. </span><span class="koboSpan" id="kobo.4873.2">That can be accomplished by using </span><strong class="source-inline"><span class="koboSpan" id="kobo.4874.1">DataTrigger</span></strong><span class="koboSpan" id="kobo.4875.1">; the label’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.4876.1">IsVisible</span></strong><span class="koboSpan" id="kobo.4877.1"> property can be set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.4878.1">True</span></strong><span class="koboSpan" id="kobo.4879.1">, making the label visible if </span><strong class="source-inline"><span class="koboSpan" id="kobo.4880.1">GamePieceState</span></strong><span class="koboSpan" id="kobo.4881.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.4882.1">0</span></strong><span class="koboSpan" id="kobo.4883.1">, meaning no stick has been placed there yet. </span><span class="koboSpan" id="kobo.4883.2">Add the following listing to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.4884.1">Label</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.4885.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4886.1">
&lt;Label.Triggers&gt;
    &lt;DataTrigger TargetType="Label" Binding="{TemplateBinding Path=GamePieceState}" Value="0"&gt;
        &lt;Setter Property="IsVisible" Value="True" /&gt;
    &lt;/DataTrigger&gt;
&lt;/Label.Triggers&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.4887.1">That completes the control template for the sticks. </span><span class="koboSpan" id="kobo.4887.2">Next, create the control template for </span><strong class="source-inline"><span class="koboSpan" id="kobo.4888.1">Stones</span></strong><span class="koboSpan" id="kobo.4889.1"> by following </span><span class="No-Break"><span class="koboSpan" id="kobo.4890.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.4891.1">Right below the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4892.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4893.1"> created for the sticks, add the </span><span class="No-Break"><span class="koboSpan" id="kobo.4894.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4895.1">
&lt;ControlTemplate x:Key="StoneViewControlTemplate"&gt;
&lt;/ControlTemplate&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4896.1">Just like with the control template for sticks, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4897.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4898.1"> uses a key to locate the </span><span class="No-Break"><span class="koboSpan" id="kobo.4899.1">right template.</span></span></p></li> <li><span class="koboSpan" id="kobo.4900.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.4901.1">Stones</span></strong><span class="koboSpan" id="kobo.4902.1"> template is a little less complex than the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4903.1">Sticks</span></strong><span class="koboSpan" id="kobo.4904.1"> template. </span><span class="koboSpan" id="kobo.4904.2">Here, we just have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4905.1">Border</span></strong><span class="koboSpan" id="kobo.4906.1"> control with an </span><strong class="source-inline"><span class="koboSpan" id="kobo.4907.1">Image</span></strong><span class="koboSpan" id="kobo.4908.1"> control as a child. </span><strong class="source-inline"><span class="koboSpan" id="kobo.4909.1">DataTrigger</span></strong><span class="koboSpan" id="kobo.4910.1"> is used again to select the right border color, and if the stones are not present, then the border is not visible. </span><span class="koboSpan" id="kobo.4910.2">Use the following code sample and add it to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4911.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4912.1"> created in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.4913.1">step 1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.4914.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4915.1">
&lt;Border Margin="3" Padding="5" HorizontalOptions="Center" VerticalOptions="Center" StrokeShape="RoundRectangle 5" StrokeThickness="3"&gt;
    &lt;Border.Triggers&gt;
        &lt;DataTrigger TargetType="Border" Binding="{TemplateBinding GamePieceState}" Value="0"&gt;
            &lt;Setter Property="IsVisible" Value="False" /&gt;
        &lt;/DataTrigger&gt;
        &lt;DataTrigger TargetType="Border" Binding="{TemplateBinding GamePieceState}" Value="1" &gt;
            &lt;Setter Property="Stroke" Value="{StaticResource PlayerOne}" /&gt;
        &lt;/DataTrigger&gt;
        &lt;DataTrigger TargetType="Border" Binding="{TemplateBinding GamePieceState}" Value="-1" &gt;
            &lt;Setter Property="Stroke" Value="{StaticResource PlayerTwo}" /&gt;
        &lt;/DataTrigger&gt;
    &lt;/Border.Triggers&gt;
    &lt;Image Source="stones.jpeg" Aspect="Fill" /&gt;
&lt;/Border&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4916.1">You may </span><a id="_idIndexMarker1168"/><span class="koboSpan" id="kobo.4917.1">have noticed a difference between the triggers in this listing versus the triggers in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4918.1">Sticks</span></strong><span class="koboSpan" id="kobo.4919.1"> control template. </span><span class="koboSpan" id="kobo.4919.2">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.4920.1">Sticks</span></strong><span class="koboSpan" id="kobo.4921.1">, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4922.1">IsVisible</span></strong><span class="koboSpan" id="kobo.4923.1"> attribute was set on </span><strong class="source-inline"><span class="koboSpan" id="kobo.4924.1">Image</span></strong><span class="koboSpan" id="kobo.4925.1">, not </span><strong class="source-inline"><span class="koboSpan" id="kobo.4926.1">Border</span></strong><span class="koboSpan" id="kobo.4927.1">, and you may want to know why that is. </span><span class="koboSpan" id="kobo.4927.2">The explanation is simple; if the border is not visible, it will not receive </span><strong class="source-inline"><span class="koboSpan" id="kobo.4928.1">TapGuesture</span></strong><span class="koboSpan" id="kobo.4929.1"> events. </span><span class="koboSpan" id="kobo.4929.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.4930.1">Grid</span></strong><span class="koboSpan" id="kobo.4931.1"> element cannot register </span><strong class="source-inline"><span class="koboSpan" id="kobo.4932.1">GestureRecognizer</span></strong><span class="koboSpan" id="kobo.4933.1">, so the event cannot be captured there either. </span></p></li> </ol>
<p><span class="koboSpan" id="kobo.4934.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.4935.1">ControlTemplates</span></strong><span class="koboSpan" id="kobo.4936.1"> that are needed for the stick and stone images are in place; now, they need to be associated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4937.1">GamePieceView</span></strong><span class="koboSpan" id="kobo.4938.1"> control elements. </span><span class="koboSpan" id="kobo.4938.2">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.4939.1">Style</span></strong><span class="koboSpan" id="kobo.4940.1"> can set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4941.1">ControlTemplate</span></strong><span class="koboSpan" id="kobo.4942.1"> property of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4943.1">GamePieceView</span></strong><span class="koboSpan" id="kobo.4944.1"> element, but how will it determine that this element is a stick or a stone? </span><strong class="source-inline"><span class="koboSpan" id="kobo.4945.1">Style</span></strong><span class="koboSpan" id="kobo.4946.1"> elements have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.4947.1">Class</span></strong><span class="koboSpan" id="kobo.4948.1"> property that can be used to further refine which styles are applied to a control. </span><span class="koboSpan" id="kobo.4948.2">If the control </span><a id="_idIndexMarker1169"/><span class="koboSpan" id="kobo.4949.1">has a matching class name listed in its </span><strong class="source-inline"><span class="koboSpan" id="kobo.4950.1">StyleClass</span></strong><span class="koboSpan" id="kobo.4951.1"> attribute, then that </span><strong class="source-inline"><span class="koboSpan" id="kobo.4952.1">Style</span></strong><span class="koboSpan" id="kobo.4953.1"> element is applied. </span><span class="koboSpan" id="kobo.4953.2">Let’s use sticks as an example, by following </span><span class="No-Break"><span class="koboSpan" id="kobo.4954.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.4955.1">Add a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.4956.1">Style</span></strong><span class="koboSpan" id="kobo.4957.1"> element to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4958.1">ContentView.Resources</span></strong><span class="koboSpan" id="kobo.4959.1"> element, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.4960.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4961.1">
&lt;Style TargetType="controls:GamePieceView"
        Class="Stick"&gt;
    &lt;Setter Property="ControlTemplate"
            Value="{StaticResource StickViewControlTemplate}" /&gt;
&lt;/Style&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4962.1">This style is only applied to elements that are of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4963.1">GamePiece</span></strong><span class="koboSpan" id="kobo.4964.1"> type and have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4965.1">Stick</span></strong><span class="koboSpan" id="kobo.4966.1"> class listed in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4967.1">StyleClass</span></strong><span class="koboSpan" id="kobo.4968.1"> attribute. </span><span class="koboSpan" id="kobo.4968.2">A matching element might look like </span><span class="No-Break"><span class="koboSpan" id="kobo.4969.1">the following:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.4970.1">&lt;</span><strong class="bold"><span class="koboSpan" id="kobo.4971.1">controls:GamePieceView</span></strong><span class="koboSpan" id="kobo.4972.1"> Grid.Row="0" Grid.Column="1" </span><strong class="bold"><span class="koboSpan" id="kobo.4973.1">StyleClass="Stick"</span></strong><span class="koboSpan" id="kobo.4974.1"> 
                        GamePiecePosition="01" GamePieceState="{Binding Game.Sticks[0]}" GamePieceDirection="Horizontal" /&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4975.1">The highlighted sections show the parts of the control that are used to match the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4976.1">Style</span></strong><span class="koboSpan" id="kobo.4977.1"> element. </span><strong class="source-inline"><span class="koboSpan" id="kobo.4978.1">StyleClass</span></strong><span class="koboSpan" id="kobo.4979.1"> can have more than one name listed; just use a comma to separate </span><span class="No-Break"><span class="koboSpan" id="kobo.4980.1">the names.</span></span></p></li> <li><span class="koboSpan" id="kobo.4981.1">Add a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.4982.1">Style</span></strong><span class="koboSpan" id="kobo.4983.1"> element. </span><span class="koboSpan" id="kobo.4983.2">This time, it will be to apply </span><strong class="source-inline"><span class="koboSpan" id="kobo.4984.1">StoneViewControlTemplate</span></strong><span class="koboSpan" id="kobo.4985.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.4986.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4987.1">
&lt;Style TargetType="controls:GamePieceView"
        Class="Stone"&gt;
    &lt;Setter Property="ControlTemplate"
            Value="{StaticResource StoneViewControlTemplate}" /&gt;
&lt;/Style&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.4988.1">That is all </span><a id="_idIndexMarker1170"/><span class="koboSpan" id="kobo.4989.1">that is required for the stick and stone elements to be added to the game board grid. </span><span class="koboSpan" id="kobo.4989.2">To add the remaining elements, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.4990.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.4991.1">There are seven rows of sticks: four rows of three and three rows of four. </span><span class="koboSpan" id="kobo.4991.2">They are nearly identical, but not quite. </span><span class="koboSpan" id="kobo.4991.3">Locate the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4992.1">Grid</span></strong><span class="koboSpan" id="kobo.4993.1"> that defines the gameboard; it will already have the corner dots added. </span><span class="koboSpan" id="kobo.4993.2">Right after the 16 dot elements, add the following listing for the first row </span><span class="No-Break"><span class="koboSpan" id="kobo.4994.1">of sticks:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.4995.1">
&lt;controls:GamePieceView Grid.Row="0" Grid.Column="1" StyleClass="Stick"
                        GamePiecePosition="01" GamePieceState="{Binding Game.Sticks[0]}" GamePieceDirection="Horizontal" /&gt;
&lt;controls:GamePieceView Grid.Row="0" Grid.Column="3" StyleClass="Stick" 
                        GamePiecePosition="02" GamePieceState="{Binding Game.Sticks[1]}" GamePieceDirection="Horizontal" /&gt;
&lt;controls:GamePieceView Grid.Row="0" Grid.Column="5" StyleClass="Stick" 
                        GamePiecePosition="03" GamePieceState="{Binding Game.Sticks[2]}" GamePieceDirection="Horizontal" /&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.4996.1">Each stick in the first row is displayed horizontally. </span><span class="koboSpan" id="kobo.4996.2">Each stick is given its own position in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.4997.1">GamePiecePosition</span></strong><span class="koboSpan" id="kobo.4998.1"> attribute and </span><strong class="source-inline"><span class="koboSpan" id="kobo.4999.1">GamePieceState</span></strong><span class="koboSpan" id="kobo.5000.1"> is bound to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.5001.1">Game.Sticks</span></strong><span class="koboSpan" id="kobo.5002.1"> object for this stick. </span><span class="koboSpan" id="kobo.5002.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.5003.1">Sticks</span></strong><span class="koboSpan" id="kobo.5004.1"> array is zero-based so the indexes for the array are one less </span><span class="No-Break"><span class="koboSpan" id="kobo.5005.1">than </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.5006.1">GamePiecePosition</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.5007.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.5008.1">Add the </span><a id="_idIndexMarker1171"/><span class="koboSpan" id="kobo.5009.1">code for the second row of sticks using the </span><span class="No-Break"><span class="koboSpan" id="kobo.5010.1">following listing:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.5011.1">
&lt;controls:GamePieceView Grid.Row="1" Grid.Column="0" StyleClass="Stick"
                        GamePiecePosition="04" GamePieceState="{Binding Game.Sticks[3]}" GamePieceDirection="Vertical" /&gt;
&lt;controls:GamePieceView Grid.Row="1" Grid.Column="2" StyleClass="Stick" 
                        GamePiecePosition="05" GamePieceState="{Binding Game.Sticks[4]}" GamePieceDirection="Vertical" /&gt;
&lt;controls:GamePieceView Grid.Row="1" Grid.Column="4" StyleClass="Stick" 
                        GamePiecePosition="06" GamePieceState="{Binding Game.Sticks[5]}" GamePieceDirection="Vertical" /&gt;
&lt;controls:GamePieceView Grid.Row="1" Grid.Column="6" StyleClass="Stick"
                        GamePiecePosition="07" GamePieceState="{Binding Game.Sticks[6]}" GamePieceDirection="Vertical" /&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.5012.1">These elements are all </span><strong class="source-inline"><span class="koboSpan" id="kobo.5013.1">Vertical</span></strong><span class="koboSpan" id="kobo.5014.1"> instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.5015.1">Horizontal</span></strong><span class="koboSpan" id="kobo.5016.1">; otherwise, they follow the same pattern as the previous step. </span><span class="koboSpan" id="kobo.5016.2">Keep on going to add the </span><span class="No-Break"><span class="koboSpan" id="kobo.5017.1">remaining rows.</span></span></p></li> <li><span class="koboSpan" id="kobo.5018.1">Use the </span><a id="_idIndexMarker1172"/><span class="koboSpan" id="kobo.5019.1">following listing to add the third row </span><span class="No-Break"><span class="koboSpan" id="kobo.5020.1">of sticks:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.5021.1">
&lt;controls:GamePieceView Grid.Row="2" Grid.Column="1" StyleClass="Stick"
                        GamePiecePosition="08" GamePieceState="{Binding Game.Sticks[7]}" GamePieceDirection="Horizontal" /&gt;
&lt;controls:GamePieceView Grid.Row="2" Grid.Column="3" StyleClass="Stick"
                        GamePiecePosition="09" GamePieceState="{Binding Game.Sticks[8]}" GamePieceDirection="Horizontal" /&gt;
&lt;controls:GamePieceView Grid.Row="2" Grid.Column="5" StyleClass="Stick"
                        GamePiecePosition="10" GamePieceState="{Binding Game.Sticks[9]}" GamePieceDirection="Horizontal" /&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.5022.1">Use the following listing to add the fourth row </span><span class="No-Break"><span class="koboSpan" id="kobo.5023.1">of sticks:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.5024.1">
&lt;controls:GamePieceView Grid.Row="3" Grid.Column="0" StyleClass="Stick"
                        GamePiecePosition="11" GamePieceState="{Binding Game.Sticks[10]}" GamePieceDirection="Vertical" /&gt;
&lt;controls:GamePieceView Grid.Row="3" Grid.Column="2" StyleClass="Stick"
                        GamePiecePosition="12" GamePieceState="{Binding Game.Sticks[11]}" GamePieceDirection="Vertical" /&gt;
&lt;controls:GamePieceView Grid.Row="3" Grid.Column="4" StyleClass="Stick"
                        GamePiecePosition="13" GamePieceState="{Binding Game.Sticks[12]}" GamePieceDirection="Vertical" /&gt;
&lt;controls:GamePieceView Grid.Row="3" Grid.Column="6" StyleClass="Stick"
                        GamePiecePosition="14" GamePieceState="{Binding Game.Sticks[13]}" GamePieceDirection="Vertical" /&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.5025.1">Use the </span><a id="_idIndexMarker1173"/><span class="koboSpan" id="kobo.5026.1">following listing to add the fifth row </span><span class="No-Break"><span class="koboSpan" id="kobo.5027.1">of sticks:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.5028.1">
&lt;controls:GamePieceView Grid.Row="4" Grid.Column="1" StyleClass="Stick"
                        GamePiecePosition="15" GamePieceState="{Binding Game.Sticks[14]}" GamePieceDirection="Horizontal" /&gt;
&lt;controls:GamePieceView Grid.Row="4" Grid.Column="3" StyleClass="Stick"
                        GamePiecePosition="16" GamePieceState="{Binding Game.Sticks[15]}" GamePieceDirection="Horizontal" /&gt;
&lt;controls:GamePieceView Grid.Row="4" Grid.Column="5" StyleClass="Stick" 
                        GamePiecePosition="17" GamePieceState="{Binding Game.Sticks[16]}" GamePieceDirection="Horizontal" /&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.5029.1">Use the </span><a id="_idIndexMarker1174"/><span class="koboSpan" id="kobo.5030.1">following listing to add the sixth row </span><span class="No-Break"><span class="koboSpan" id="kobo.5031.1">of sticks:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.5032.1">
&lt;controls:GamePieceView Grid.Row="5" Grid.Column="0" StyleClass="Stick"
                        GamePiecePosition="18" GamePieceState="{Binding Game.Sticks[17]}" GamePieceDirection="Vertical" /&gt;
&lt;controls:GamePieceView Grid.Row="5" Grid.Column="2" StyleClass="Stick"
                        GamePiecePosition="19" GamePieceState="{Binding Game.Sticks[18]}" GamePieceDirection="Vertical" /&gt;
&lt;controls:GamePieceView Grid.Row="5" Grid.Column="4" StyleClass="Stick"
                        GamePiecePosition="20" GamePieceState="{Binding Game.Sticks[19]}" GamePieceDirection="Vertical" /&gt;
&lt;controls:GamePieceView Grid.Row="5" Grid.Column="6" StyleClass="Stick" 
                        GamePiecePosition="21" GamePieceState="{Binding Game.Sticks[20]}" amePieceDirection="Vertical" /&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.5033.1">Use the following listing to add the seventh row </span><span class="No-Break"><span class="koboSpan" id="kobo.5034.1">of sticks:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.5035.1">
&lt;controls:GamePieceView Grid.Row="6" Grid.Column="1" StyleClass="Stick"
                        GamePiecePosition="22" GamePieceState="{Binding Game.Sticks[21]}" GamePieceDirection="Horizontal" /&gt;
&lt;controls:GamePieceView Grid.Row="6" Grid.Column="3" StyleClass="Stick"
                        GamePiecePosition="23" GamePieceState="{Binding Game.Sticks[22]}" GamePieceDirection="Horizontal" /&gt;
&lt;controls:GamePieceView Grid.Row="6" Grid.Column="5" StyleClass="Stick" 
                        GamePiecePosition="24" GamePieceState="{Binding Game.Sticks[23]}" GamePieceDirection="Horizontal" /&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.5036.1">The sticks </span><a id="_idIndexMarker1175"/><span class="koboSpan" id="kobo.5037.1">are all added, so now we need to add the stones. </span><span class="koboSpan" id="kobo.5037.2">Use the following listing to add the nine </span><strong class="source-inline"><span class="koboSpan" id="kobo.5038.1">Stone</span></strong><span class="koboSpan" id="kobo.5039.1"> elements to the game board </span><strong class="source-inline"><span class="koboSpan" id="kobo.5040.1">Grid</span></strong><span class="koboSpan" id="kobo.5041.1"> control following </span><span class="No-Break"><span class="koboSpan" id="kobo.5042.1">the sticks:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.5043.1">
&lt;controls:GamePieceView Grid.Row="1" Grid.Column="1" StyleClass="Stone" GamePieceState="{Binding Game.Stones[0]}" /&gt;
&lt;controls:GamePieceView Grid.Row="1" Grid.Column="3" StyleClass="Stone" GamePieceState="{Binding Game.Stones[1]}" /&gt;
&lt;controls:GamePieceView Grid.Row="1" Grid.Column="5" StyleClass="Stone" GamePieceState="{Binding Game.Stones[2]}" /&gt;
&lt;controls:GamePieceView Grid.Row="3" Grid.Column="1" StyleClass="Stone" GamePieceState="{Binding Game.Stones[3]}" /&gt;
&lt;controls:GamePieceView Grid.Row="3" Grid.Column="3" StyleClass="Stone" GamePieceState="{Binding Game.Stones[4]}" /&gt;
&lt;controls:GamePieceView Grid.Row="3" Grid.Column="5" StyleClass="Stone" GamePieceState="{Binding Game.Stones[5]}" /&gt;
&lt;controls:GamePieceView Grid.Row="5" Grid.Column="1" StyleClass="Stone" GamePieceState="{Binding Game.Stones[6]}" /&gt;
&lt;controls:GamePieceView Grid.Row="5" Grid.Column="3" StyleClass="Stone" GamePieceState="{Binding Game.Stones[7]}" /&gt;
&lt;controls:GamePieceView Grid.Row="5" Grid.Column="5" StyleClass="Stone" GamePieceState="{Binding Game.Stones[8]}" /&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.5044.1">This is a </span><a id="_idIndexMarker1176"/><span class="koboSpan" id="kobo.5045.1">wrap on the game app. </span><span class="koboSpan" id="kobo.5045.2">You can now test out the project in the </span><span class="No-Break"><span class="koboSpan" id="kobo.5046.1">next section.</span></span></p>
<h2 id="_idParaDest-173"><a id="_idTextAnchor892"/><span class="koboSpan" id="kobo.5047.1">Testing the completed project</span></h2>
<p><span class="koboSpan" id="kobo.5048.1">This project </span><a id="_idIndexMarker1177"/><span class="koboSpan" id="kobo.5049.1">has spanned two chapters, with </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.5050.1">Chapter 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.5051.1">, Setting Up a Backend for a Game Using Azure Services , and this chapter, Building a Real-Time Game</span></em><span class="koboSpan" id="kobo.5052.1">. </span><span class="koboSpan" id="kobo.5052.2">Since this is a two-player turn-based game, getting all the components configured correctly can be a challenge. </span><span class="koboSpan" id="kobo.5052.3">Follow these steps to test out your game locally </span><span class="No-Break"><span class="koboSpan" id="kobo.5053.1">on Windows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.5054.1">The first step is to get the service running in the background. </span><span class="koboSpan" id="kobo.5054.2">In Visual Studio, right-click the </span><strong class="source-inline"><span class="koboSpan" id="kobo.5055.1">SticksAndStones.Functions</span></strong><span class="koboSpan" id="kobo.5056.1"> project and select </span><strong class="bold"><span class="koboSpan" id="kobo.5057.1">Debug</span></strong><span class="koboSpan" id="kobo.5058.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.5059.1">Start Without Debugging</span></strong><span class="koboSpan" id="kobo.5060.1"> or press </span><em class="italic"><span class="koboSpan" id="kobo.5061.1">Ctrl</span></em><span class="koboSpan" id="kobo.5062.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.5063.1">F5</span></em><span class="koboSpan" id="kobo.5064.1">. </span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer180">
<span class="koboSpan" id="kobo.5065.1"><img alt="Figure 10.15 – Starting the Azure Functions service" src="image/B19214_10_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.5066.1">Figure 10.15 – Starting the Azure Functions service</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.5067.1">That should </span><a id="_idIndexMarker1178"/><span class="koboSpan" id="kobo.5068.1">launch a terminal window with the Azure Functions </span><span class="No-Break"><span class="koboSpan" id="kobo.5069.1">service running.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.5070.1">Now, two clients are needed to play the game. </span><span class="koboSpan" id="kobo.5070.2">On Windows, that means the Windows client and the Android client. </span><span class="koboSpan" id="kobo.5070.3">Start with the Windows client first, and use the same method that was used for Functions. </span><span class="koboSpan" id="kobo.5070.4">Make sure the Windows target is selected in the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.5071.1">Debug</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.5072.1"> options:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer181">
<span class="koboSpan" id="kobo.5073.1"><img alt="Figure 10.16 – Selecting Windows as the Debug target" src="image/B19214_10_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.5074.1">Figure 10.16 – Selecting Windows as the Debug target</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.5075.1">Right-click </span><a id="_idIndexMarker1179"/><span class="koboSpan" id="kobo.5076.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.5077.1">SticksAndStones.App</span></strong><span class="koboSpan" id="kobo.5078.1"> project and then select </span><strong class="bold"><span class="koboSpan" id="kobo.5079.1">Debug</span></strong><span class="koboSpan" id="kobo.5080.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.5081.1">Start Without Debugging</span></strong><span class="koboSpan" id="kobo.5082.1"> or press </span><em class="italic"><span class="koboSpan" id="kobo.5083.1">Ctrl</span></em><span class="koboSpan" id="kobo.5084.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.5085.1">F5</span></em><span class="koboSpan" id="kobo.5086.1">. </span><span class="koboSpan" id="kobo.5086.2">A new window should open with the login </span><span class="No-Break"><span class="koboSpan" id="kobo.5087.1">page displayed.</span></span></li>
<li><span class="koboSpan" id="kobo.5088.1">Now, switch the </span><strong class="bold"><span class="koboSpan" id="kobo.5089.1">Debug</span></strong><span class="koboSpan" id="kobo.5090.1"> target </span><span class="No-Break"><span class="koboSpan" id="kobo.5091.1">to Android:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer182">
<span class="koboSpan" id="kobo.5092.1"><img alt="Figure 10.17 – Selecting Android as the Debug target" src="image/B19214_10_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.5093.1">Figure 10.17 – Selecting Android as the Debug target</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.5094.1">Now, either use </span><em class="italic"><span class="koboSpan" id="kobo.5095.1">F5</span></em><span class="koboSpan" id="kobo.5096.1"> to debug the app in an Android emulator, or </span><em class="italic"><span class="koboSpan" id="kobo.5097.1">Ctrl</span></em><span class="koboSpan" id="kobo.5098.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.5099.1">F5</span></em><span class="koboSpan" id="kobo.5100.1"> to just run </span><span class="No-Break"><span class="koboSpan" id="kobo.5101.1">the app.</span></span></li>
<li><span class="koboSpan" id="kobo.5102.1">Log in to each app using a different email and </span><span class="No-Break"><span class="koboSpan" id="kobo.5103.1">gamer tag.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer183">
<span class="koboSpan" id="kobo.5104.1"><img alt="Figure 10.18 – Log in to the game" src="image/B19214_10_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.5105.1">Figure 10.18 – Log in to the game</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.5106.1">Challenge </span><a id="_idIndexMarker1180"/><span class="koboSpan" id="kobo.5107.1">the other player to </span><span class="No-Break"><span class="koboSpan" id="kobo.5108.1">a match!</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer184">
<span class="koboSpan" id="kobo.5109.1"><img alt="Figure 10.19 – Challenge issued" src="image/B19214_10_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.5110.1">Figure 10.19 – Challenge issued</span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.5111.1">Try to </span><a id="_idIndexMarker1181"/><span class="koboSpan" id="kobo.5112.1">best yourself in a game of </span><em class="italic"><span class="koboSpan" id="kobo.5113.1">Sticks </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.5114.1">and Stones</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.5115.1">!</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer185">
<span class="koboSpan" id="kobo.5116.1"><img alt="Figure 10.20 – The match has started" src="image/B19214_10_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.5117.1">Figure 10.20 – The match has started</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.5118.1">Android: cleartext http traffic to 10.0.2.2 not permitted</span></p>
<p class="callout"><span class="koboSpan" id="kobo.5119.1">If you are attempting to test the game using the Android client, you will probably hit this error when you try to send a move to the server. </span><span class="koboSpan" id="kobo.5119.2">Fortunately, the resolution is easy. </span><span class="koboSpan" id="kobo.5119.3">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.5120.1">MainApplication.cs</span></strong><span class="koboSpan" id="kobo.5121.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.5122.1">Platforms/Android</span></strong><span class="koboSpan" id="kobo.5123.1"> folder and modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.5124.1">Application</span></strong><span class="koboSpan" id="kobo.5125.1"> attribute on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.5126.1">MainApplication</span></strong><span class="koboSpan" id="kobo.5127.1"> class to match </span><span class="No-Break"><span class="koboSpan" id="kobo.5128.1">the following:</span></span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.5129.1">[Application(UsesCleartextTraffic = </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.5130.1">true)]</span></strong></span></p>
<p><span class="koboSpan" id="kobo.5131.1">If you </span><a id="_idIndexMarker1182"/><span class="koboSpan" id="kobo.5132.1">encounter any errors or something just</span><a id="_idTextAnchor893"/><span class="koboSpan" id="kobo.5133.1"> doesn’t work the way you expect it to, go back through all the steps and make sure you didn’t miss anything. </span><span class="koboSpan" id="kobo.5133.2">Otherwise, congratulations on making it through </span><span class="No-Break"><span class="koboSpan" id="kobo.5134.1">this project.</span></span></p>
<h1 id="_idParaDest-174"><a id="_idTextAnchor894"/><span class="koboSpan" id="kobo.5135.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.5136.1">That’s that! </span><span class="koboSpan" id="kobo.5136.2">Excellent work! </span><span class="koboSpan" id="kobo.5136.3">There is so much in the chapter that it is hard to keep this summary short. </span><span class="koboSpan" id="kobo.5136.4">In this chapter, we created a game app that connects to our backend. </span><span class="koboSpan" id="kobo.5136.5">We created a service that managed the calls to the backend service and handled errors, all asynchronously. </span><span class="koboSpan" id="kobo.5136.6">We have learned how to respond to messages from SignalR, and how to send and receive messages within the app using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.5137.1">IMessenger</span></strong><span class="koboSpan" id="kobo.5138.1"> interface. </span><span class="koboSpan" id="kobo.5138.2">We created custom controls and used them across multiple pages. </span><span class="koboSpan" id="kobo.5138.3">We learned how to style an app with XAML styling, how to use control templates, and how to select them using styles. </span><span class="koboSpan" id="kobo.5138.4">We explored routes and how they work in a multi-page .NET MAUI app. </span><span class="koboSpan" id="kobo.5138.5">We examined triggers and how we can use them to update the interface without using C# code </span><span class="No-Break"><span class="koboSpan" id="kobo.5139.1">and converters.</span></span></p>
<p><span class="koboSpan" id="kobo.5140.1">Now, reward yourself and challenge a friend to a match in your </span><span class="No-Break"><span class="koboSpan" id="kobo.5141.1">new game.</span></span></p>
<p><span class="koboSpan" id="kobo.5142.1">In the next chapter, we will dive into Blazor and .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.5143.1">MAUI together.</span></span></p>
</div>
</body></html>