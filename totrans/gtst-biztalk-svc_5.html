<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Business-to-business Integration"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Business-to-business Integration</h1></div></div></div><p>A transaction between two companies in a buyer-seller relationship is business-to-business (B2B) as opposed to a B2C relationship between a company and its consumer. In the context of integration, B2B is about two organizations agreeing on a set of well-defined transactions for the exchange of business information. The B2B process starts off with a business negotiation or an agreement, which further translates into the technical details at the message flow level.</p><p>In this chapter, we will focus on the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Understanding B2B integration in the context of Azure</li><li class="listitem" style="list-style-type: disc">Understanding the capabilities of the service with partner, agreement, batching, and tracking</li><li class="listitem" style="list-style-type: disc">Walkthrough of a real-world B2B scenario using BizTalk Services on Azure</li></ul></div><div class="section" title="Basic concepts of B2B"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec48"/>Basic concepts of B2B</h1></div></div></div><p>Consider <a id="id254" class="indexterm"/>a retailer, Contoso, who wishes to procure stock from a supplier, Northwind. From a technology standpoint, the message flow between Contoso and Northwind can be explained using the following flow:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Contoso and Northwind agree to enter into a business relationship (usually over phone/e-mail/meetings). The legal teams draft the memorandum of understanding (MoU) between the partners.</li><li class="listitem" style="list-style-type: disc">The partners exchange information on how one would receive/send payments, including cheque and bank details.</li><li class="listitem" style="list-style-type: disc">Both partners enter a setup phase where each of their IT departments configures the B2B system to enable the exchange of electronic data interchange (EDI).</li><li class="listitem" style="list-style-type: disc">Both partners exchange sample test messages to validate the configuration, and after sufficient testing, they agree to move ahead with production.</li><li class="listitem" style="list-style-type: disc">In production, the following steps are carried out:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Contoso raises a purchase order from their Dynamics AX ERP system and sends it to Northwind</li><li class="listitem" style="list-style-type: disc">Northwind receives the order and acknowledges that they have received the order</li><li class="listitem" style="list-style-type: disc">Northwind processes the order and looks up the inventory in their SAP ERP to determine whether they can service the request</li><li class="listitem" style="list-style-type: disc">If the order can be serviced, Northwind send the goods to a third-party logistics company (3PL) who handles the shipment of goods</li><li class="listitem" style="list-style-type: disc">Northwind replies with the shipment details to Contoso</li><li class="listitem" style="list-style-type: disc">Contoso can optionally acknowledge the receipt of the shipment notice</li><li class="listitem" style="list-style-type: disc">Northwind sends an invoice to Contoso for the cost of goods sold</li></ul></div></li><li class="listitem" style="list-style-type: disc">Contoso <a id="id255" class="indexterm"/>sends payment to Northwind based on the financial terms agreed upon.</li></ul></div><p>The preceding flow can be visually represented as follows:</p><div class="mediaobject"><img src="graphics/7401EN_05_01.jpg" alt="Basic concepts of B2B"/></div><p>Each of the arrows in the preceding diagram represents a set of messages exchanged between Contoso and Northwind. Each message type is identified by a document name or transaction set (for example, PO/X12 850) and has a defined format based on the protocol used. The protocol, in addition to the structure of the message, governs the set of messages<a id="id256" class="indexterm"/> exchanged back and forth. In the preceding example, we can write the first transaction as "Contoso raises an EDI X12 purchase order (850) to Northwind". Here, X12 is the EDI format and 850 is the purchase order message type.</p></div></div>
<div class="section" title="Common interaction models"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec49"/>Common interaction models</h1></div></div></div><p>There are two common ways to integrate trading partners for B2B. They are listed as follows.</p><div class="section" title="Direct enterprise integration"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec30"/>Direct enterprise integration</h2></div></div></div><p>In <a id="id257" class="indexterm"/>this model, both trading partner <a id="id258" class="indexterm"/>organizations have in-house IT and can directly transact EDI messages. There are systems in place to send and receive EDI transactions over point-to-point protocols without any mediator or middleman.</p></div><div class="section" title="Service provider integration"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec31"/>Service provider integration</h2></div></div></div><p>In this <a id="id259" class="indexterm"/>model, one of the trading<a id="id260" class="indexterm"/> partners is a small-to-medium business player who cannot afford in-house IT. In order to facilitate EDI interactions, there is a middleman, or the EDI service provider, who acts as a liaison between the two partners. The service provider talks about EDI to a trading partner on one end and transacts non-EDI (such as XLS/XML) with the other trading partner. The service provider charges a fee based on transaction size/volume or the complexity of the protocols used.</p><p><span class="strong"><strong>Value Added Networks</strong></span> (<span class="strong"><strong>VANs</strong></span>)<a id="id261" class="indexterm"/> are specialized networks offering end-to-end B2B services in a service provider integration. VANs manage the hosting of servers and software to process EDI traffic and usually charge based on message volume. They could specialize solutions for a particular vertical or offer generic message processing services.</p></div></div>
<div class="section" title="Industry standards and protocols"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec50"/>Industry standards and protocols</h1></div></div></div><p>Various organizations define protocols for different industry verticals. Each protocol governs the set of messages exchanged, the acknowledgements transferred, and the error behavior between trading partners.</p><p>The following are some of the most common protocols and their standards organization supported in BizTalk today:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Standards body</p>
</th><th style="text-align: left" valign="bottom">
<p>Website</p>
</th><th style="text-align: left" valign="bottom">
<p>Protocol</p>
</th><th style="text-align: left" valign="bottom">
<p>Industries</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>ANSI ASC X12</p>
</td><td style="text-align: left" valign="top">
<p><a class="ulink" href="http://www.x12.org/">http://www.x12.org/</a></p>
</td><td style="text-align: left" valign="top">
<p>X12</p>
</td><td style="text-align: left" valign="top">
<p>In the<a id="id262" class="indexterm"/> US: manufacturing,<a id="id263" class="indexterm"/> retail, government, and transportation</p>
</td></tr><tr><td style="text-align: left" valign="top">
</td><td style="text-align: left" valign="top">
</td><td style="text-align: left" valign="top">
<p>HIPAA</p>
</td><td style="text-align: left" valign="top">
<p>Healthcare,<a id="id264" class="indexterm"/> insurance</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UN/CEFACT</p>
</td><td style="text-align: left" valign="top">
<p><a class="ulink" href="http://www.unece.org/cefact/edifact">http://www.unece.org/cefact/edifact</a></p>
<p><a class="ulink" href="http://www.gefeg.com/jswg/">http://www.gefeg.com/jswg/</a></p>
</td><td style="text-align: left" valign="top">
<p>UN/ EDIFACT</p>
</td><td style="text-align: left" valign="top">
<p>In<a id="id265" class="indexterm"/> Europe: manufacturing,<a id="id266" class="indexterm"/> retail, government, and transportation</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>SWIFT</p>
</td><td style="text-align: left" valign="top">
<p><a class="ulink" href="http://www.swift.com">http://www.swift.com</a></p>
</td><td style="text-align: left" valign="top">
<p>SWIFT</p>
</td><td style="text-align: left" valign="top">
<p>Financial transactions<a id="id267" class="indexterm"/> for treasury, trade, <a id="id268" class="indexterm"/>and<a id="id269" class="indexterm"/> banking</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>RosettaNet</p>
</td><td style="text-align: left" valign="top">
<p><a class="ulink" href="http://www.rosettanet.org/">http://www.rosettanet.org/</a></p>
</td><td style="text-align: left" valign="top">
<p>RosettaNet</p>
</td><td style="text-align: left" valign="top">
<p>Supply<a id="id270" class="indexterm"/> chain</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>OAGi</p>
</td><td style="text-align: left" valign="top">
<p><a class="ulink" href="http://www.oagi.org">http://www.oagi.org</a></p>
</td><td style="text-align: left" valign="top">
<p>CIDX</p>
</td><td style="text-align: left" valign="top">
<p>Horizontal framework <a id="id271" class="indexterm"/>for several <a id="id272" class="indexterm"/>verticals</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>PIDX</p>
</td><td style="text-align: left" valign="top">
<p><a class="ulink" href="http://www.pidx.org/">http://www.pidx.org/</a></p>
</td><td style="text-align: left" valign="top">
<p>PIDX</p>
</td><td style="text-align: left" valign="top">
<p>Oil <a id="id273" class="indexterm"/>and Natural Gas<a id="id274" class="indexterm"/></p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>HL7</p>
</td><td style="text-align: left" valign="top">
<p><a class="ulink" href="http://www.hl7.org/">http://www.hl7.org/</a></p>
</td><td style="text-align: left" valign="top">
<p>HL7</p>
</td><td style="text-align: left" valign="top">
<p>Healthcare</p>
</td></tr></tbody></table></div><p>X12 is heavily used in the US, while EDIFACT is more popular in Europe and Asian countries. Both these protocols are supported in BizTalk Services today. The remaining protocols are available in BizTalk Server.</p></div>
<div class="section" title="Concepts in BizTalk Services B2B"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec51"/>Concepts in BizTalk Services B2B</h1></div></div></div><p>B2B<a id="id275" class="indexterm"/> in BizTalk Services is all about processing EDI and non-EDI messages between trading partners. It is meant to make B2B integration simple, powerful, and flexible using Azure. B2B, by its nature of protocols, formats, and transport, tends to be complex in configuration; with Azure, service configuration of an agreement between partners is simple. It's easy to extend the service and connect with other technologies such as SharePoint and mobile services to build a rich and powerful solution.</p><p>The top-level concepts in B2B/EDI include the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">EDI message structure</li><li class="listitem" style="list-style-type: disc">Partners and agreements</li><li class="listitem" style="list-style-type: disc">Property promotion in EDI</li><li class="listitem" style="list-style-type: disc">Batching</li><li class="listitem" style="list-style-type: disc">Tracking and archiving</li><li class="listitem" style="list-style-type: disc">Extensibility and object model API</li></ul></div><div class="section" title="EDI message structure"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec32"/>EDI message structure</h2></div></div></div><p>EDI <a id="id276" class="indexterm"/>messages (either X12 or EDIFACT) have a nested structure, compartmentalizing transactions for ease of understanding by the receiver. Every structure has a header and trailer to identify the start and end of the nested structure. The following outlines the nesting structure:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Interchange</strong></span>: This<a id="id277" class="indexterm"/> is the outermost <a id="id278" class="indexterm"/>envelope with a header and trailer. It identifies the sender and receiver of the message as well as the date/time when the message was sent. In the case of X12, the ISA and IEA are the header and trailer respectively; in EDIFACT, the UNB and UNZ form the header and trailer.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Group</strong></span>: A<a id="id279" class="indexterm"/> group segment in an interchange<a id="id280" class="indexterm"/> is a set of transactions clubbed together by their function. A group starts with a header (GS in X12 and UNG in EDIFACT) and ends with a trailer (GE in X12 and UNE in EDIFACT). Unlike X12, groups are optional in EDIFACT; but when groups are present, they must <a id="id281" class="indexterm"/>contain all transactions <a id="id282" class="indexterm"/>of the same type (for example, all purchase orders).</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Transaction set</strong></span>: A transaction set in a group is the message of a given type (for <a id="id283" class="indexterm"/>example, a purchase order message) with <a id="id284" class="indexterm"/>segments detailing transactions such as<a id="id285" class="indexterm"/> item quantity or price. A transaction set starts with a header (ST in X12 and UNH in EDIFACT) and ends with a trailer (SE in X12 and UNT in EDIFACT).</li></ul></div><p>The following table illustrates the X12 and EDIFACT headers and trailers:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>X12 header and trailer</p>
</th><th style="text-align: left" valign="bottom">
<p>EDIFACT header and trailer</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>ISA <a id="id286" class="indexterm"/>Interchange Control Header</p>
</td><td style="text-align: left" valign="top">
<p>UNA<a id="id287" class="indexterm"/> Optional Advice</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>GS Functional Group Header</p>
</td><td style="text-align: left" valign="top">
<p>UNB Interchange Control Header</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>ST Transaction Set Header</p>
</td><td style="text-align: left" valign="top">
<p>UNG Functional Group Header</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>SE Transaction Set Trailer</p>
</td><td style="text-align: left" valign="top">
<p>UNH Message Header</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>GE Functional Group Trailer</p>
</td><td style="text-align: left" valign="top">
<p>UNT Message Trailer</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>IEA Interchange Control Trailer</p>
</td><td style="text-align: left" valign="top">
<p>UNE Functional Group Trailer</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>UNZ Interchange Control Trailer</p>
</td></tr></tbody></table></div></div><div class="section" title="Partners and agreements"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec33"/>Partners and agreements</h2></div></div></div><p>The following are the key concepts used with agreements:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Partner</strong></span>: A partner<a id="id288" class="indexterm"/> is an organization with <a id="id289" class="indexterm"/>which a trading relationship is established. Each partner has one or more<a id="id290" class="indexterm"/> business units referred to as <span class="strong"><strong>business profiles</strong></span>. Every business profile has an identifier (for example, a DUNS ID or phone number) that is unique and added to each message exchanged between the partners.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Agreement</strong></span>: An <a id="id291" class="indexterm"/>agreement represents<a id="id292" class="indexterm"/> the technical settings of message exchange between partners. An agreement is established between two business profiles of partners. The agreement is composed of send settings (send of Contoso, receive of Northwind) and receive settings (receive of Contoso and send of Northwind) in the trading partner relationship. An agreement refers to a protocol such as AS2, X12, EDIFACT, and so on, based on messaging requirements. An agreement also identifies the schemas and requirements around tracking and batching. Deployment of the agreement results in two bridge deployments and, therefore, endpoints in Azure that can receive EDI messages and send XML and vice versa. The agreement definition in the BizTalk Portal has the following:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Transport</strong></span>: This<a id="id293" class="indexterm"/> is the send side or the <a id="id294" class="indexterm"/>receive side transport of the bridges.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Protocol</strong></span>: This<a id="id295" class="indexterm"/> is the EDI protocol <a id="id296" class="indexterm"/>under use in the bridge.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Transform</strong></span>: These<a id="id297" class="indexterm"/> are the maps used <a id="id298" class="indexterm"/>while a message is processed in the bridge.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Route</strong></span>: This<a id="id299" class="indexterm"/> is the target destination <a id="id300" class="indexterm"/>where the bridge will route the message to the recipient of the message.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Inbound URI</strong></span>: This<a id="id301" class="indexterm"/> is the address<a id="id302" class="indexterm"/> of the send side bridge which receives messages to be sent to the destination partner.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Suspend endpoint</strong></span>: This <a id="id303" class="indexterm"/>is the<a id="id304" class="indexterm"/> endpoint which would process the message if there are errors in the processing of the EDI message. This endpoint can be used to build repair-resubmit scenarios.</li></ul></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Partnership</strong></span>: At least one agreement between partners constitutes a partnership between the partners. The concept of partnership is exposed only through the trading partner management API.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Agreement template</strong></span>: An agreement template is a unit of re-use where commonly repeated settings can be captured as a template and applied while defining an agreement for rapid configuration. An agreement template is associated with a profile. Each template definition identifies the hosted partner in the definition to determine the direction of settings to be applied while creating an agreement.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>AS2 agreement</strong></span>: AS2 agreement refers to the AS2 transport settings agreed between two partners adhering to the RFC 4130 standard. In a nutshell, AS2 allows messages and acknowledgements to be transmitted in compressed, signed, or encrypted form over HTTP or HTTPS. Signing and encryption is supported using certificates. AS2 is not specific to the payload and can be used for both B2B flat files and EAI XML messages.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>If the endpoints of one partner, say Partner A, require HTTPS for AS2 traffic, then Partner A's deployment certificate needs to be added to the "Trusted People" certificate store of Partner B. Alternately, if the AS2 messaging from Partner A is to an HTTPS endpoint of Partner B, then Partner B's public certificate needs to be added to the certificate store of Partner A's deployment. Both these certificates need to be uploaded to the BizTalk Services deployment certificate store using <code class="literal">PSCmdlet</code> loaded from BizTalk Services Tools. Here is the sample code to add the certificate using PowerShell:</p><div class="informalexample"><pre class="programlisting">PS C:\&gt;Import-Module 'C:\Program Files\Windows Azure BizTalk Services Tools\Microsoft.BizTalk.Services.PowerShell.dll'
PS C:\&gt;Add-AzureBizTalkArtifactCertificate –AcsNamespace myAcs –IssuerName owner –IssuerKey 193194218484a= -FilePath D:\sample.cer –ArtifactPath /sample.cer –certificateStore TrustedPeople</pre></div><p>If self-signed certificates are generated by using <code class="literal">makecert.exe</code>, ensure that you pass the <code class="literal">–pe</code> and <code class="literal">–key</code> exchange parameters to the command to make the certificate exportable and usable for encryption purposes.</p></div></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>X12 and EDIFACT agreement</strong></span>: Both X12 and EDIFACT are supported on BizTalk Services. The choice of the agreement is available through a combobox selection during agreement creation. For each application protocol, the agreement settings consist of a series of schema selection, acknowledgement configuration, control number configuration, batching, character sets and separators configuration, and configuration of message validation.</li></ul></div></div><div class="section" title="Property promotion"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec34"/>Property promotion</h2></div></div></div><p>Certain<a id="id305" class="indexterm"/> properties in the EDI envelopes <a id="id306" class="indexterm"/>we discussed earlier are autopromoted and are available for use in routing and tracking scenarios. They can also be used to determine the agreement endpoints programmatically.</p><p>Listed in the following tables are the <a id="id307" class="indexterm"/>promoted properties in <a id="id308" class="indexterm"/>EDI and AS2:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Property</p>
</th><th style="text-align: left" valign="bottom">
<p>Location</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Message Type</p>
</td><td style="text-align: left" valign="top">
<p>X12 Receive</p>
</td><td style="text-align: left" valign="top">
<p>Numeric value identifies type of message, for example, 850 PO, 810 Invoice</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>AgreementName</p>
</td><td style="text-align: left" valign="top">
<p>X12 Receive</p>
</td><td style="text-align: left" valign="top">
<p>Name of the agreement</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>ISA 5-8</p>
<p>ISA 9, 10, 12, 15</p>
</td><td style="text-align: left" valign="top">
<p>X12 Receive</p>
</td><td style="text-align: left" valign="top">
<p>X12 ISA envelopes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>GS01-08</p>
</td><td style="text-align: left" valign="top">
<p>X12 Receive</p>
</td><td style="text-align: left" valign="top">
<p>X12 GS envelopes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>ST01</p>
</td><td style="text-align: left" valign="top">
<p>X12 Receive</p>
</td><td style="text-align: left" valign="top">
<p>X12 transaction set message type</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>ST03</p>
</td><td style="text-align: left" valign="top">
<p>X12 Receive</p>
</td><td style="text-align: left" valign="top">
<p>X12 transaction set version</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>AS2-To, AS2-Version, Mime-Version, AS2-From</p>
</td><td style="text-align: left" valign="top">
<p>AS2 Send/Receive</p>
</td><td style="text-align: left" valign="top">
<p>AS2 header properties</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Content-ID, Content-Type, Content-Transfer-Encoding</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>Disposition-Notification-To, Disposition-Notification-Options</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>Content-Description, Content-Disposition, Receipt-Delivery-Option</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> </td></tr><tr><td style="text-align: left" valign="top">
<p>SystemRequestID</p>
</td><td style="text-align: left" valign="top">
<p>X12 Send, X12 Receive, AS2 Receive</p>
</td><td style="text-align: left" valign="top">
<p>ID<a id="id309" class="indexterm"/> to track the message flow in the bridge</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>MessageReceivedTime</p>
</td><td style="text-align: left" valign="top">
<p>X12 Send, X12 Receive, AS2 Receive</p>
</td><td style="text-align: left" valign="top">
<p>Date and time <a id="id310" class="indexterm"/>of incoming message</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>SourceType</p>
</td><td style="text-align: left" valign="top">
<p>X12 Send, X12 Receive, AS2 Receive</p>
</td><td style="text-align: left" valign="top">
<p>FTP, HTTP, or AS2 per<a id="id311" class="indexterm"/> configuration</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>SourceName</p>
</td><td style="text-align: left" valign="top">
<p>X12 Send, X12 Receive, AS2 Receive</p>
</td><td style="text-align: left" valign="top">
<p>The <a id="id312" class="indexterm"/>name configured for source; this is an autogenerated name in EDI agreements</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>AgreementID</p>
</td><td style="text-align: left" valign="top">
<p>X12 Send, X12 Receive, AS2 Receive</p>
</td><td style="text-align: left" valign="top">
<p>Agreement ID as displayed<a id="id313" class="indexterm"/> in the agreements list view in the BizTalk portal</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNA_Segment</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>UNA Segment with characters as separators and indicators</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNB_Segment</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Interchange header segment</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNB2_1</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Sender Identification</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNB2_2</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Sender Code qualifier</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNB2_3</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Sender Reverse Routing address</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNB3_1</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Receiver Identification</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNB3_2</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Receiver Code qualifier</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNB11</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Test indicator</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNG_Segment</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Functional group header segment</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNG1</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Functional group identifier</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNG2_1</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Group Application Sender Identifier</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNG3_1</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Group Application Receiver Identifier</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNH2_1</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Message type identifier</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNH2_2</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Message type version number</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>UNH2_3</p>
</td><td style="text-align: left" valign="top">
<p>EDIFACT Receive</p>
</td><td style="text-align: left" valign="top">
<p>Message type release number</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>AS2 Send is sending the message to the  partner; hence, the properties are not usable directly. In the case of X12 Send, we can route the message to a blob store or Service Bus queue and base our action on the properties promoted.</p></div></div></div><div class="section" title="Batching"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec35"/>Batching</h2></div></div></div><p>Batching<a id="id314" class="indexterm"/> is a concept where messages are accumulated based on selection criteria and released once the desired event known as the release criteria is met. Customers use batching of messages to aggregate messages for reasons of cost, compatibility, and convenience. In the early days of VAN, messages were charged on size and customers were optimized by sending batches of messages. An example of this is airlines charging the same for all containers, whether they contain 2000 kg or 5000 kg. It makes sense for freight forwarders to batch requests from multiple shipments into a single container to save costs. Few mainframe systems of trading partners cannot accept messages more than 250 KB. It is important to break messages such as these to sizes less than or equal to 250 KB before sending them to the target system.</p><p>As part of BizTalk Services B2B, customers can configure and manage a batch in an agreement's send side configuration (debatching is already part of the system as the interchange format is implicitly known). An agreement can contain zero or more batch definitions. Every batch has a state—it can be enabled, disabled, or in error. Batches are enabled when the corresponding agreement is deployed or the start command is used explicitly. When batches are stopped, messages in the batch are flushed out. Each batch definition contains the selection and the release criteria.</p><div class="section" title="Selection criteria"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec09"/>Selection criteria</h3></div></div></div><p>The<a id="id315" class="indexterm"/> selection criteria are used to select a message for batching. In <a id="id316" class="indexterm"/>BizTalk Services, customers can promote properties and use them in expressions to select the message to be added to one or more batches. If the property of an incoming batch matches more than one definition, then the message is copied to these many batches.</p></div><div class="section" title="Release criteria"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec10"/>Release criteria</h3></div></div></div><p>The <a id="id317" class="indexterm"/>release criteria determine when the batch should be released. <a id="id318" class="indexterm"/>One of the following can be used as release criteria:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Release criteria</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Size</p>
</td><td style="text-align: left" valign="top">
<p>The maximum size of the message (excluding interchange and groups) in bytes with UTF-8 encoding</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Count</p>
</td><td style="text-align: left" valign="top">
<p>The number of transaction sets in a batched message</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Schedule</p>
</td><td style="text-align: left" valign="top">
<p>The configuration of the occurrence and recurrence values to release messages periodically</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Timeout</p>
</td><td style="text-align: left" valign="top">
<p>Inter-message idle timeout when a batch needs to be released</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Interchange size and schedule</p>
</td><td style="text-align: left" valign="top">
<p>Either size or based on schedule</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Interchange size and timeout</p>
</td><td style="text-align: left" valign="top">
<p>Either size or configured timeout</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Message count and schedule</p>
</td><td style="text-align: left" valign="top">
<p>Either count or based on schedule</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Message count and timeout</p>
</td><td style="text-align: left" valign="top">
<p>Either count or configured timeout</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Interchange size and message count</p>
</td><td style="text-align: left" valign="top">
<p>Either size or count</p>
</td></tr></tbody></table></div><p>Messages from a batch are released when either the release criteria are met or the batch has been stopped from the BizTalk portal. If the release criteria are met but no messages are in the batch, a null message is not sent to the send endpoint. If the send endpoint is not available when the batch releases a message, the message is passed to the suspend endpoint. In the worst case, if the suspend endpoint is also down in spite of retries, the set of unbatched transaction sets are held in the system and released to the suspend endpoint the next<a id="id319" class="indexterm"/> time it becomes available. Also, note that for an agreement to<a id="id320" class="indexterm"/> be deleted, the batches defined in the agreement must not have any messages.</p></div></div><div class="section" title="Tracking and archiving"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec36"/>Tracking and archiving</h2></div></div></div><p>Tracking<a id="id321" class="indexterm"/> helps in storing interesting properties in a message and archiving messages in stores. Both tracking and archiving are settings enabled as part of an agreement configuration. In the case of B2B, the system and user-promoted properties are tracked and written to the Azure SQL Tracking database. In addition to messages, the system tracks properties with which a message can be correlated with its acknowledgement. This would let users know if an X12 has received a technical or a functional acknowledgement and if an AS2 message has received its MDN NACK or ACK message. Tracking identifies the list of batches that are active with the list of messages currently held in the batch. It also identifies the history of batches that were dispatched on the send side.</p><p>Archiving is supported in the following cases for X12 and AS2 as illustrated in the following diagram:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Just before sending a message</li><li class="listitem" style="list-style-type: disc">Immediately after receiving a message<div class="mediaobject"><img src="graphics/7401EN_05_02.jpg" alt="Tracking and archiving"/></div></li></ul></div><p>Archiving is configured in the <span class="strong"><strong>General Settings</strong></span> section in the agreement. The messages can be accessed from the BizTalk portal's tracking view option by clicking on the relevant message entry and choosing <span class="strong"><strong>Details</strong></span>. From the message info pop-up view, you can select<a id="id322" class="indexterm"/> the <a id="id323" class="indexterm"/>entity to download and click on the <span class="strong"><strong>Download</strong></span> option.</p><div class="section" title="Non-repudiation"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec11"/>Non-repudiation</h3></div></div></div><p><span class="strong"><strong>Non-repudiation of Receipt</strong></span> (<span class="strong"><strong>NRR</strong></span>) is supported in AS2 using both tracking and archiving. NRR is required in dispute settlement<a id="id324" class="indexterm"/> scenarios<a id="id325" class="indexterm"/> where, for example, a supplier may not <a id="id326" class="indexterm"/>process <a id="id327" class="indexterm"/>a PO or claim not to have received the order or the payment. NRR ensures that the AS2 message is stored and the incoming Message Integrity Check (MIC) value or hashcode is validated against the MIC of the stored AS2 message. This validates that the other partner has indeed received and processed the message. If the NRR option is turned on and if the tracking or archiving fails, then the message processing also fails (unlike in cases without NRR, where message processing can continue even if there are tracking errors). To enable NRR, check the <span class="strong"><strong>Enable NRR</strong></span> option in the <span class="strong"><strong>General Settings</strong></span> page of the AS2 agreement, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7401EN_05_03.jpg" alt="Non-repudiation"/></div></div></div><div class="section" title="Extensibility"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec37"/>Extensibility</h2></div></div></div><p>Extensibility<a id="id328" class="indexterm"/> in B2B is possible by using the public <a id="id329" class="indexterm"/>API for <span class="strong"><strong>Trading Partner Management Object Model</strong></span> (<span class="strong"><strong>TPM OM</strong></span>)<a id="id330" class="indexterm"/>. We will cover TPM OM as part of the overall extensibility in BizTalk Services using API.</p></div></div>
<div class="section" title="Scenario walk-through"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec52"/>Scenario walk-through</h1></div></div></div><p>Let us revisit the scenario we began with in this chapter; we will add a service provider to illustrate the concepts. A service provider, as we know, is an expert in EDI and will act as a middleman to help suppliers connect to large retailers. In this example, Contoso, a large retailer, wishes to procure stock from supplier Northwind. Since Northwind is not aware of EDI, they approach a service provider, Fabrikam, to help them connect with the retailer Contoso.</p><div class="section" title="Ecosystem players"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec38"/>Ecosystem players</h2></div></div></div><p>There <a id="id331" class="indexterm"/>are three players in our example. Contoso is a large retailer, Northwind is the supplier connecting to Contoso, and finally, Fabrikam is the EDI service provider providing EDI services to Northwind.</p></div><div class="section" title="Provisioning BizTalk Services"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec39"/>Provisioning BizTalk Services</h2></div></div></div><p>Fabrikam <a id="id332" class="indexterm"/>creates a new BizTalk Services deployment. See <a class="link" href="ch01.html" title="Chapter 1. Hello BizTalk Services">Chapter 1</a>, <span class="emphasis"><em>Hello BizTalk Services</em></span>, on creating BizTalk Services deployment and registering the BizTalk Services portal.</p><p>Fabrikam adds Northwind's admin e-mail ID as a registered user in the BizTalk Services portal Settings page. This allows Northwind users to log in to the same view as that of Fabrikam.</p></div><div class="section" title="Configuring partners – Fabrikam, Northwind, and Contoso"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec40"/>Configuring partners – Fabrikam, Northwind, and Contoso</h2></div></div></div><p>We <a id="id333" class="indexterm"/>need <a id="id334" class="indexterm"/>to configure the trading<a id="id335" class="indexterm"/> partners and the agreement in BizTalk Services. The following steps need to be carried out by Fabrikam to add partners:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Once <a id="id336" class="indexterm"/>signed in, click on the <span class="strong"><strong>PARTNERS</strong></span> page and then the <span class="strong"><strong>Add</strong></span> button.</li><li class="listitem">Enter the <span class="strong"><strong>Partner name</strong></span> as <code class="literal">Northwind</code>.</li><li class="listitem">Enter <span class="strong"><strong>First name</strong></span>, <span class="strong"><strong>Last Name</strong></span>, <span class="strong"><strong>Email ID</strong></span>, and <span class="strong"><strong>Phone</strong></span> details, if required.</li><li class="listitem">Click on <span class="strong"><strong>Save</strong></span>.</li><li class="listitem">Repeat the above steps for <code class="literal">Contoso</code> and <code class="literal">Fabrikam</code> as partner names.</li><li class="listitem">Click on each partner, navigate to the default profile, and upload the certificate for AS2 signing and encryption.</li></ol></div><p>The creation of a new partner is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7401EN_05_04.jpg" alt="Configuring partners – Fabrikam, Northwind, and Contoso"/></div></div><div class="section" title="Configuring the AS2 agreement between Fabrikam and Contoso"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec41"/>Configuring the AS2 agreement between Fabrikam and Contoso</h2></div></div></div><p>Once<a id="id337" class="indexterm"/> the partners are created, we<a id="id338" class="indexterm"/> need to add <a id="id339" class="indexterm"/>agreements. The following steps need to be carried out to add the AS2 agreement between Fabrikam and Contoso:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Click on <span class="strong"><strong>AGREEMENTS</strong></span> in the left navigation bar.</li><li class="listitem">Click on the <span class="strong"><strong>AS2</strong></span> tab.</li><li class="listitem">Click on <span class="strong"><strong>Add</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>New Agreement</strong></span> (AS2) page, fill the agreement name as <code class="literal">Fabrikam-Contoso agreement</code> and add a description.</li><li class="listitem">Select <span class="strong"><strong>Hosted Partner</strong></span> as <code class="literal">Fabrikam</code> and <span class="strong"><strong>Guest Partner</strong></span> as <code class="literal">Contoso</code> . Here, <span class="strong"><strong>Hosted Partner</strong></span> is the partner who owns the bridge in BizTalk Services. In this case, <code class="literal">Fabrikam</code> owns the BizTalk Services deployment, and hence is the host partner.</li><li class="listitem">Enter <span class="strong"><strong>AS2 Identity</strong></span> of Fabrikam as <code class="literal">fabrikam</code> and for Contoso as <code class="literal">contoso</code>.</li><li class="listitem">Enable tracking and archiving; the latter is available for Premium SKUs.</li><li class="listitem">Click on <span class="strong"><strong>Continue</strong></span>.</li><li class="listitem">The page is now renamed to <code class="literal">Fabrikam-Contoso agreement</code> and you are on the <span class="strong"><strong>Receive Settings</strong></span> page.</li><li class="listitem">Following<a id="id340" class="indexterm"/> are <a id="id341" class="indexterm"/>the<a id="id342" class="indexterm"/> steps to configure <span class="strong"><strong>Receive Settings</strong></span>:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Under <span class="strong"><strong>Inbound URL</strong></span>, set <span class="strong"><strong>URL Suffix</strong></span> to <code class="literal">endpoint1</code> and note down the complete URL. This is where <code class="literal">Fabrikam</code> would receive messages from <code class="literal">Contoso</code>.</li><li class="listitem" style="list-style-type: disc">Under <span class="strong"><strong>Protocol</strong></span>, open <span class="strong"><strong>Message</strong></span> and choose <span class="strong"><strong>Messages should be signed</strong></span> or <span class="strong"><strong>Messages should be encrypted</strong></span> if applicable. Note that both these options require you to add a certificate in the profiles pages of Contoso and Fabrikam for this purpose. Also, set <span class="strong"><strong>Acknowledgement</strong></span> and select <span class="strong"><strong>Send MDN</strong></span> if required.</li></ul></div></li><li class="listitem">Click on <span class="strong"><strong>Send Settings</strong></span>:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="strong"><strong>Inbound URL</strong></span> is where <code class="literal">Fabrikam</code> would send messages to reach <code class="literal">Contoso</code>. The <code class="literal">&lt;Agreement ID&gt;</code> in the URL would be filled in after the agreement is deployed. The inbound refers to the endpoint where messages need to be delivered from the <code class="literal">Fabrikam</code> system in order to be sent to <code class="literal">Contoso</code> over AS2.</li><li class="listitem" style="list-style-type: disc">Under <span class="strong"><strong>Protocol</strong></span>, similar to <span class="strong"><strong>Send Settings</strong></span>, configure signing and encryption options if required. Also, set <span class="strong"><strong>Acknowledgement</strong></span> and select <span class="strong"><strong>Request MDN</strong></span> (you can leave the other two checkboxes unchecked).</li><li class="listitem" style="list-style-type: disc">Under <span class="strong"><strong>Transport</strong></span>, enter the URL of the <code class="literal">Contoso</code> endpoint. You can create a BizTalk Server or BizTalk Services setup which can mock the other end of the partner, or simply leave the URL to the default <a class="ulink" href="http://www.microsoft.com">http://www.microsoft.com</a>. Note that the prefix <code class="literal">http</code> is required.</li></ul></div></li><li class="listitem">Click on <span class="strong"><strong>Deploy</strong></span>. You should see the following message in the portal:<div class="mediaobject"><img src="graphics/7401EN_05_05.jpg" alt="Configuring the AS2 agreement between Fabrikam and Contoso"/></div></li></ol></div></div><div class="section" title="Configuring the X12 agreement between Northwind and Contoso"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec42"/>Configuring the X12 agreement between Northwind and Contoso</h2></div></div></div><p>Similar<a id="id343" class="indexterm"/> to the AS2 agreement, we now need<a id="id344" class="indexterm"/> to configure<a id="id345" class="indexterm"/> the X12 agreement between Northwind and Contoso. The following steps need to be carried out:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Click on <span class="strong"><strong>AGREEMENTS</strong></span> in the left navigation bar.</li><li class="listitem">Click on <span class="strong"><strong>EDI</strong></span> this time; the (0) indicates there are no X12 or EDIFACT agreements.</li><li class="listitem">Click on <span class="strong"><strong>Add</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>New Agreement</strong></span> option, choose the protocol as <span class="strong"><strong>X12</strong></span> and fill the agreement name as <code class="literal">Northwind-Contoso agreement</code>, and also add a description. You can also create an EDIFACT agreement. The next set of steps configure the specific X12 settings.</li><li class="listitem">Select <span class="strong"><strong>Hosted Partner</strong></span> as <code class="literal">Northwind</code> and <span class="strong"><strong>Guest Partner</strong></span> as <code class="literal">Contoso</code>. Here, <span class="strong"><strong>Hosted Partner</strong></span> is the partner who directly/indirectly owns the bridge in BizTalk Services.</li><li class="listitem">Select <span class="strong"><strong>Qualifier</strong></span> as <span class="strong"><strong>ZZ - Mutually Defined (X12)</strong></span> and enter the value for Northwind as <code class="literal">northwind</code> and for Contoso as <code class="literal">contoso</code>.</li><li class="listitem">Enable tracking <a id="id346" class="indexterm"/>and archiving<a id="id347" class="indexterm"/> on <a id="id348" class="indexterm"/>both sides; the latter is available for Premium SKUs.</li><li class="listitem">Click on <span class="strong"><strong>Continue</strong></span>.</li><li class="listitem">The page is now renamed to <code class="literal">Fabrikam-Contoso agreement</code> and you are on <span class="strong"><strong>Receive Settings</strong></span>.</li><li class="listitem">The<a id="id349" class="indexterm"/> following are the steps to configure <span class="strong"><strong>Receive Settings</strong></span>:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Under <span class="strong"><strong>Transport</strong></span>, choose <span class="strong"><strong>Transport type</strong></span> as <span class="strong"><strong>AS2</strong></span> and <span class="strong"><strong>AS2 Agreement</strong></span> as <code class="literal">Fabrikam-Contoso agreement</code>. This means all messages from the X12 agreement will be received from the AS2 channel configured earlier. In future, <code class="literal">Fabrikam</code> can create multiple such X12 agreements and reuse the same AS2 agreement to connect with the retailer <code class="literal">Contoso</code>. This is possible as only the X12 configuration changes across suppliers while the <code class="literal">Fabrikam</code> connectivity to <code class="literal">Contoso</code> is mostly constant.</li><li class="listitem" style="list-style-type: disc">Under <span class="strong"><strong>Protocol</strong></span>, select <span class="strong"><strong>TA1 expected</strong></span> and <span class="strong"><strong>997 expected</strong></span>. Assuming you have downloaded the B2B schemas from the BizTalk Services download page, click on <span class="strong"><strong>Upload</strong></span> and add <code class="literal">X12_00401_810.xsd</code> and <code class="literal">X12_00401_850.xsd</code> one after the other. They will be listed post upload, as shown in the following screenshot:</li></ul></div><div class="mediaobject"><img src="graphics/7401EN_05_06.jpg" alt="Configuring the X12 agreement between Northwind and Contoso"/></div></li><li class="listitem">Leave the <span class="strong"><strong>Transform</strong></span> settings as they are for now.</li><li class="listitem">Under <span class="strong"><strong>Route</strong></span>, click on <span class="strong"><strong>Add</strong></span> to add the success route rule:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Enter the rule name as <code class="literal">default</code>.</li><li class="listitem" style="list-style-type: disc">Click on <span class="strong"><strong>Advanced Settings</strong></span> and<a id="id350" class="indexterm"/> enter <code class="literal">1=1</code> in the<a id="id351" class="indexterm"/> expression <a id="id352" class="indexterm"/>window. This means we will route all successful messages to this endpoint.</li><li class="listitem" style="list-style-type: disc">Select <span class="strong"><strong>Transport type</strong></span> as <span class="strong"><strong>Azure Service Bus</strong></span>.</li><li class="listitem" style="list-style-type: disc">Select <span class="strong"><strong>Route destination type</strong></span> as <span class="strong"><strong>BasicHttpRelay</strong></span>. Add the <span class="strong"><strong>BasicHttpRelay URL</strong></span>, <span class="strong"><strong>issuer name</strong></span>, and <span class="strong"><strong>issuer key</strong></span>. This is the URL where the BasicHttpRelay service will be listening for successful messages routed from this agreement.</li><li class="listitem" style="list-style-type: disc">Click on <span class="strong"><strong>Save</strong></span>.</li></ul></div></li><li class="listitem">Add the <span class="strong"><strong>Message Suspension Settings</strong></span>. The suspend settings refer to the target URL if messages fail to successfully reach Northwind. We can configure Azure Service Bus with Queue, Topic, or Relay. Queues and Topics need to be pre created with Shared Access Signature or Issuer Name and Secret:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Select <span class="strong"><strong>Transport type</strong></span> as <span class="strong"><strong>Azure Service Bus</strong></span>.</li><li class="listitem" style="list-style-type: disc">Select <span class="strong"><strong>Route destination type</strong></span> as <span class="strong"><strong>BasicHttpRelay</strong></span>. Add the <span class="strong"><strong>BasicHttpRelay URL</strong></span>, <span class="strong"><strong>issuer name</strong></span>, and <span class="strong"><strong>issuer key</strong></span>. This is the URL where the BasicHttpRelay service will be listening for failed messages from this agreement.</li><li class="listitem" style="list-style-type: disc">Click on <span class="strong"><strong>Save</strong></span>.</li></ul></div></li><li class="listitem">Click on <span class="strong"><strong>Send Settings</strong></span>:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Under <span class="strong"><strong>Inbound URL</strong></span>, note the <span class="strong"><strong>Endpoint</strong></span> value—the <code class="literal">&lt;Agreement-ID&gt;</code> in the URL will be updated after the agreement is deployed. We will return to this view later.</li><li class="listitem" style="list-style-type: disc">Leave the <span class="strong"><strong>Transform</strong></span> settings on the send side as the are for now.</li><li class="listitem" style="list-style-type: disc">Under <span class="strong"><strong>Batching</strong></span>, you can configure to send a batch of messages instead of a single message.</li><li class="listitem" style="list-style-type: disc">Click on <span class="strong"><strong>Add Batch</strong></span>, enter <code class="literal">batch of 3 messages</code> as the name, and add a description. Click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem" style="list-style-type: disc">In <span class="strong"><strong>Batch criteria</strong></span>, choose <span class="strong"><strong>Use advanced definitions</strong></span> and enter <code class="literal">1=1</code> in the textbox. This implies all messages will be batches. Click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem" style="list-style-type: disc">In <span class="strong"><strong>Batch release criteria</strong></span>, choose <span class="strong"><strong>MessageCountBased</strong></span> and enter <code class="literal">3</code> as the value of <span class="strong"><strong>Count</strong></span>.</li><li class="listitem" style="list-style-type: disc">Click on <span class="strong"><strong>Next,</strong></span> and finally, <span class="strong"><strong>Save</strong></span>.</li><li class="listitem" style="list-style-type: disc">You don't have to click on <span class="strong"><strong>Start Batch</strong></span>; the batch will be started automatically once the agreement is deployed.</li></ul></div></li><li class="listitem">Under <span class="strong"><strong>Protocol</strong></span>, select <span class="strong"><strong>TA1 expected</strong></span> and <span class="strong"><strong>997 expected</strong></span>. Also, click on the <span class="strong"><strong>+</strong></span> symbol under the <span class="strong"><strong>Schemas</strong></span> section and choose the existing <span class="strong"><strong>X12_00401_810.xsd</strong></span> option from the <span class="strong"><strong>Schema</strong></span> dropdown. This should already be listed if the same was uploaded in the previous <span class="strong"><strong>Receive Settings</strong></span> section.</li><li class="listitem">Under <span class="strong"><strong>Transport</strong></span>, fill both<a id="id353" class="indexterm"/> the<a id="id354" class="indexterm"/> <span class="strong"><strong>Transport Settings</strong></span> and <span class="strong"><strong>Message Suspension Settings</strong></span>. Under <span class="strong"><strong>Transport</strong></span>, choose<a id="id355" class="indexterm"/> <span class="strong"><strong>Transport type</strong></span> as <span class="strong"><strong>AS2</strong></span> and <span class="strong"><strong>AS2 Agreement</strong></span> as <code class="literal">Fabrikam-Contoso agreement</code>. This means all messages from the X12 agreement will be sent to the AS2 channel configured earlier.</li><li class="listitem">Add the <span class="strong"><strong>Message Suspension Settings</strong></span>. The suspend settings refer to the target URL if messages fail to reach Contoso. We can configure Azure Service Bus with Queue, Topic, or Relay. Queues and Topics need to be precreated with Shared Access Signature or Issuer Name and Secret. In this case, we configure a service running with BasicHttpRelay binding:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Select <span class="strong"><strong>Transport type</strong></span> as <span class="strong"><strong>Azure Service Bus</strong></span>.</li><li class="listitem" style="list-style-type: disc">Select <span class="strong"><strong>Route destination type</strong></span> as <span class="strong"><strong>BasicHttpRelay</strong></span>.</li><li class="listitem" style="list-style-type: disc">Add the <span class="strong"><strong>BasicHttpRelay URL</strong></span>, <span class="strong"><strong>issuer name</strong></span>, and <span class="strong"><strong>issuer key</strong></span>. This is the URL where the BasicHttpRelay service will be listening for messages which could not be sent to <code class="literal">Contoso</code>.</li></ul></div></li><li class="listitem">Click on <span class="strong"><strong>Deploy</strong></span>:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A success message, <code class="literal">The agreement between Northwind and Contoso was successfully deployed</code> should be shown. If not, check for errors and click on <span class="strong"><strong>Deploy</strong></span> again.</li><li class="listitem" style="list-style-type: disc">Navigate<a id="id356" class="indexterm"/> to the<a id="id357" class="indexterm"/> agreement's <span class="strong"><strong>Send Settings</strong></span> page<a id="id358" class="indexterm"/> and note down the <span class="strong"><strong>Inbound URL</strong></span> value. This will be used to send messages to the agreement.</li></ul></div></li></ol></div></div><div class="section" title="Sending messages"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec43"/>Sending messages</h2></div></div></div><p><span class="strong"><strong>Web Sender</strong></span><a id="id359" class="indexterm"/> is a tool available in MSDN Code Gallery for BizTalk Services' samples. It can be used to send messages to AS2 receive endpoints. Since in this example the AS2 is tied to X12 endpoints, all messages sent to AS2 receive should be routed to the success endpoint of X12 receive (the Azure Service Bus relay endpoint in this case). <span class="strong"><strong>Message Receiver</strong></span><a id="id360" class="indexterm"/> is a tool in MSDN Code Gallery to receive messages on relay endpoints; it needs to listen on the configured address in the X12 agreement route address.</p><p>Use <span class="strong"><strong>Web Sender</strong></span> from MSDN Code Gallery to test the AS2 message with sample 850. You can generate an instance of the Purchase Order EDI 850 using Visual Studio <span class="strong"><strong>Generate Instance</strong></span><a id="id361" class="indexterm"/> command from the <a id="id362" class="indexterm"/>BizTalk Services project.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>You can download the<a id="id363" class="indexterm"/> Message Receiver C# sample at the following link:</p><p><a class="ulink" href="http://code.msdn.microsoft.com/Windows-Azure-BizTalk-EAI-e01a5b64">http://code.msdn.microsoft.com/Windows-Azure-BizTalk-EAI-e01a5b64</a></p><p>You can download the<a id="id364" class="indexterm"/> Web Sender C# sample at the following link:</p><p><a class="ulink" href="http://code.msdn.microsoft.com/Windows-Azure-BizTalk-a0d12dca">http://code.msdn.microsoft.com/Windows-Azure-BizTalk-a0d12dca</a></p></div></div></div><div class="section" title="Viewing tracking data"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec44"/>Viewing tracking data</h2></div></div></div><p>Click <a id="id365" class="indexterm"/>on the <span class="strong"><strong>TRACKING</strong></span> view in the navigation bar to see the status of message flow on the agreement.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec53"/>Summary</h1></div></div></div><p>In this chapter, we started with the basic concepts around B2B and its relevance in the context of Azure. We introduced key concepts of B2B on Azure, notably partners, agreements, templates, batching, tracking, and archiving. We also walked through a simple agreement configuration for AS2 and X12 in BizTalk Services. Trading partners can also be managed using API—this is covered in detail in the extensibility chapter later.</p></div></body></html>