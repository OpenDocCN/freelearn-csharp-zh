<html><head></head><body>
  <div class="Basic-Text-Frame" id="_idContainer357">
    <h1 class="chapterNumber">11</h1>
    <h1 class="chapterTitle" id="_idParaDest-411">Broadcasting Real-Time Communication Using SignalR</h1>
    <p class="normal">In this chapter, you will be introduced to SignalR, a technology that enables a developer to create a service that can have multiple clients and broadcast messages to all of them or a subset of them live in real time. The canonical example is a group chat app. Other examples include notification systems and dashboards that need instantly up-to-date information like stock prices.</p>
    <p class="normal">This chapter will cover the following topics:</p>
    <ul>
      <li class="bulletList">Understanding SignalR</li>
      <li class="bulletList">Building a live communication service using SignalR</li>
      <li class="bulletList">Building a web client using the SignalR JavaScript library</li>
      <li class="bulletList">Building a .NET console app client</li>
      <li class="bulletList">Streaming data using SignalR</li>
    </ul>
    <h1 class="heading-1" id="_idParaDest-412">Understanding SignalR</h1>
    <p class="normal">To understand the problem that <a id="_idIndexMarker1140"/>SignalR solves, we need to understand what web development is like without it. The foundation of the web is HTTP, which for more than 30 years has been great for building general-purpose websites and services. However, the web was not designed for specialized scenarios that require a web page to be instantaneously updated with new information as it becomes available. </p>
    <h2 class="heading-2" id="_idParaDest-413">The history of real-time communication on the web</h2>
    <p class="normal">To understand the benefits of SignalR, it helps to know the history of HTTP and how organizations worked to <a id="_idIndexMarker1141"/>make it better for real-time communication between clients and servers. </p>
    <p class="normal">In the early days of the Web in the 1990s, browsers had to make a full-page HTTP <code class="inlineCode">GET</code> request to the web server to get fresh information to show to the visitor. </p>
    <p class="normal">In late 1999, Microsoft released Internet Explorer 5 with a component named <strong class="keyWord">XMLHttpRequest</strong> that could <a id="_idIndexMarker1142"/>make asynchronous HTTP calls in the background. This, alongside <strong class="keyWord">dynamic HTML</strong> (<strong class="keyWord">DHTML</strong>), allowed<a id="_idIndexMarker1143"/> parts of the web page to be updated with fresh data smoothly.</p>
    <p class="normal">The benefits of this technique were obvious, and soon, all browsers added the same component.</p>
    <h2 class="heading-2" id="_idParaDest-414">AJAX</h2>
    <p class="normal">Google took maximum advantage of this capability to build clever web applications such as Google Maps and Gmail. A few years later, the technique became popularly known as <strong class="keyWord">Asynchronous JavaScript and XML </strong>(<strong class="keyWord">AJAX</strong>).</p>
    <p class="normal">AJAX still uses HTTP to communicate, however, and that <a id="_idIndexMarker1144"/>has limitations:</p>
    <ul>
      <li class="bulletList">First, HTTP is a request-response communication protocol, meaning that the server cannot push data to the client. It must wait for the client to make a request. </li>
      <li class="bulletList">Second, HTTP request and response messages have headers with lots of potentially unnecessary overhead. </li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-415">WebSocket</h2>
    <p class="normal"><strong class="keyWord">WebSocket</strong> is full-duplex, meaning <a id="_idIndexMarker1145"/>that either the client or server can initiate communicating new data. WebSocket uses the same TCP connection for the life cycle of the connection. It is also more efficient in the message sizes that it sends because they are minimally framed with 2 bytes.</p>
    <p class="normal">WebSocket works over HTTP ports <code class="inlineCode">80</code> and <code class="inlineCode">443</code> so it is compatible with the HTTP protocol, and the WebSocket handshake uses the HTTP <strong class="screenText">Upgrade</strong> header to switch from the HTTP protocol to the WebSocket protocol.</p>
    <p class="normal">Modern web apps are expected to deliver up-to-date information. Live chat is the canonical example, but there are lots of potential applications, from stock prices to games.</p>
    <p class="normal">Whenever you need the server to push updates to the web page, you need a web-compatible, real-time <a id="_idIndexMarker1146"/>communication technology. WebSocket could be used, but it is not supported by all clients. You can check which clients support WebSocket using the<a id="_idIndexMarker1147"/> web page found at the following link: <a href="https://caniuse.com/websockets"><span class="url">https://caniuse.com/websockets</span></a>.</p>
    <div class="note">
      <p class="normal">WebSocket or WebSockets? “The <strong class="keyWord">WebSocket</strong> protocol was standardized by the IETF as RFC 6455 in 2011. The<a id="_idIndexMarker1148"/> current API specification allowing web applications to use this protocol is known as <em class="italic">WebSockets</em>.” From the Wikipedia page found at the following link: <a href="https://en.wikipedia.org/wiki/WebSocket"><span class="url">https://en.wikipedia.org/wiki/WebSocket</span></a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-416">Introducing SignalR</h2>
    <p class="normal"><strong class="keyWord">ASP.NET Core SignalR</strong> is an open-source<a id="_idIndexMarker1149"/> library that simplifies adding real-time web functionality to apps by being an abstraction over multiple underlying communication technologies, which allows you to add real-time communication capabilities using C# code.</p>
    <p class="normal">The developer does not need to understand or implement the underlying technology used, and SignalR will automatically switch between underlying technologies depending on what the visitor’s web browser supports. For example, SignalR will use WebSocket when it’s available and gracefully falls back on other technologies such as AJAX long polling when it isn’t, while your application code stays the same.</p>
    <p class="normal">SignalR is an API for <a id="_idIndexMarker1150"/>server-to-client <strong class="keyWord">remote procedure calls</strong> (<strong class="keyWord">RPCs</strong>). The RPCs call JavaScript functions on clients from server-side .NET code. SignalR has hubs to define the pipeline and handles the message dispatching automatically using two built-in hub protocols: JSON and a binary one based on MessagePack.</p>
    <p class="normal">On the server side, SignalR runs everywhere that ASP.NET Core runs: Windows, macOS, or Linux servers. SignalR supports the following client platforms:</p>
    <ul>
      <li class="bulletList">JavaScript <a id="_idIndexMarker1151"/>clients for current browsers including Chrome, Firefox, Safari, and Edge.</li>
      <li class="bulletList">.NET clients including Blazor, .NET MAUI, and Xamarin for Android and iOS mobile apps.</li>
      <li class="bulletList">Java 8 and later.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-417">Azure SignalR Service</h2>
    <p class="normal">Earlier, I mentioned that it would be good practice to separate the SignalR service hosting project from the web project that uses the JavaScript library to act as a client. This is because a SignalR service potentially needs to handle lots of simultaneous client requests and respond quickly to them all.</p>
    <p class="normal">Once you separate the<a id="_idIndexMarker1152"/> SignalR hosting, you can take advantage of <strong class="keyWord">Azure SignalR Service</strong>. This offers global reach and a world-class data center and network, and it scales to millions of connections while meeting SLAs like providing compliance and high security.</p>
    <div class="note">
      <p class="normal">You can learn more about Azure SignalR Service at the following link: <a href="https://learn.microsoft.com/en-us/azure/azure-signalr/signalr-overview"><span class="url">https://learn.microsoft.com/en-us/azure/azure-signalr/signalr-overview</span></a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-418">Designing method signatures</h2>
    <p class="normal">When designing the method signatures for a SignalR service, it is good practice to define methods with a<a id="_idIndexMarker1153"/> single message parameter rather than multiple simple type parameters. This good practice is not enforced by the technology with SignalR, so you will have to be disciplined.</p>
    <p class="normal">For example, instead of passing multiple <code class="inlineCode">string</code> (or other type) values, define a type with multiple properties to use as the single <code class="inlineCode">Message</code> parameter, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Bad practice: RPC method with multiple parameters.</span>
<span class="hljs-keyword">public</span><span class="hljs-function"> </span><span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">SendMessage</span><span class="hljs-function">(</span><span class="hljs-built_in">string</span><span class="hljs-params"> to, </span><span class="hljs-built_in">string</span><span class="hljs-params"> body</span><span class="hljs-function">)</span>
<span class="hljs-comment">// Good practice: single parameter using a complex type.</span>
<span class="hljs-keyword">public</span><span class="hljs-function"> </span><span class="hljs-keyword">class</span><span class="hljs-function"> Message</span>
{
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> To { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Body { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
<span class="hljs-keyword">public</span><span class="hljs-function"> </span><span class="hljs-keyword">void</span><span class="hljs-function"> </span><span class="hljs-title">SendMessage</span><span class="hljs-function">(</span><span class="hljs-params">Message message</span><span class="hljs-function">)</span>
</code></pre>
    <p class="normal">The reason for this good practice is that it allows future changes like adding a third property for the message <code class="inlineCode">Title</code>. For the bad practice example, a third <code class="inlineCode">string</code> parameter named <code class="inlineCode">title</code> would need to be added and existing clients would get errors because they are not sending the extra <code class="inlineCode">string</code> value. But using the good practice example will not break the method signature so existing clients can continue to call it as before the change. On the server side, the extra <code class="inlineCode">Title</code> property will just have a <code class="inlineCode">null</code> value that can be checked for, and <a id="_idIndexMarker1154"/>perhaps be set to a default value. </p>
    <p class="normal">SignalR method parameters are serialized as JSON, so all nested objects are accessible in JavaScript if needed.</p>
    <p class="normal">Now that we’ve explored the fundamentals of SignalR and its various aspects like good practices for method signature design, let’s walk through how to build a live communication service using SignalR.</p>
    <h1 class="heading-1" id="_idParaDest-419">Building a live communication service using SignalR</h1>
    <p class="normal">The SignalR <em class="italic">server</em> library is included in ASP.NET Core, but the JavaScript <em class="italic">client</em> library is not automatically included in the <a id="_idIndexMarker1155"/>project. Remember, SignalR supports multiple client types, and a web page using JavaScript is just one of them.</p>
    <p class="normal">We will use the <strong class="keyWord">Library Manager CLI</strong> to get the client<a id="_idIndexMarker1156"/> library from <strong class="keyWord">unpkg</strong>, a <strong class="keyWord">content delivery network</strong> (<strong class="keyWord">CDN</strong>) that can deliver anything found in the Node.js<a id="_idIndexMarker1157"/> package manager.</p>
    <p class="normal">Let’s add a SignalR server-side<a id="_idIndexMarker1158"/> hub and client-side JavaScript to <a id="_idIndexMarker1159"/>an ASP.NET Core MVC project to implement a chat feature that allows visitors to send messages to:</p>
    <ul>
      <li class="bulletList">Everyone currently using the website.</li>
      <li class="bulletList">Dynamically defined groups.</li>
      <li class="bulletList">A single specified user.</li>
    </ul>
    <div class="packt_tip">
      <p class="normal"><strong class="keyWord">Good Practice</strong>: In a production solution, it would be better to host the SignalR hub in a separate web project so that it can be hosted and scaled independently from the rest of the website. Live communication can often put excessive load on a<a id="_idIndexMarker1160"/> website.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-420">Defining some shared models</h2>
    <p class="normal">First, we will define two<a id="_idIndexMarker1161"/> shared models that can be used on both the server-side and client-side .NET projects that will work with our chat service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to create a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Class Library</strong> / <code class="inlineCode">classlib</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter11</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.Common</code></li>
        </ul>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.Common</code> project, rename the <code class="inlineCode">Class1.cs</code> file to <code class="inlineCode">UserModel.cs</code>.</li>
      <li class="numberedList">Modify its contents to define a model for registering a user’s name, unique connection ID, and the groups that they belong to, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Northwind.Chat.Models</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UserModel</span>
{
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">null</span>!;
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> ConnectionId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">null</span>!;
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Groups { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } <span class="hljs-comment">// comma-separated list</span>
}
</code></pre>
      
    <div class="packt_tip">
      <p class="normal"><strong class="keyWord">Good Practice</strong>: In a real-world app, you would want to use a collection of <code class="inlineCode">string</code> values for the <code class="inlineCode">Groups</code> property, but this coding task is not about how to provide a web user experience for editing multiple <code class="inlineCode">string</code> values. We will provide a simple text box instead and focus on learning SignalR.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">In the <code class="inlineCode">Northwind.Common</code> project, add a class file named <code class="inlineCode">MessageModel.cs</code>. Modify its contents to define a message model with properties for whom the message is <a id="_idIndexMarker1162"/>sent to and who the message was sent from, and the message body, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Northwind.Chat.Models</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MessageModel</span>
{
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> From { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">null</span>!;
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> To { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">null</span>!;
  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Body { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-421">Enabling a server-side SignalR hub</h2>
    <p class="normal">Next, we will enable a SignalR<a id="_idIndexMarker1163"/> hub on the server side in an ASP.NET Core MVC project:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to<a id="_idIndexMarker1164"/> add a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">ASP.NET Core Web App (Model-View-Controller)</strong> / <code class="inlineCode">mvc</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter11</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.SignalR.Service.Client.Mvc</code></li>
          <li class="bulletList">Authentication type: None.</li>
          <li class="bulletList">Configure for HTTPS: Selected.</li>
          <li class="bulletList">Enable Docker: Cleared.</li>
          <li class="bulletList">Do not use top-level statements: Cleared.</li>
        </ul>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.SignalR.Service.Client.Mvc</code> project, treat warnings as errors and add a project reference to the <code class="inlineCode">Northwind.Common</code> project, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference
    Include=<span class="hljs-string">"..\Northwind.Common\Northwind.Common.csproj"</span> /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Properties</code> folder, in <code class="inlineCode">launchSettings.json</code>, in the <code class="inlineCode">https</code> profile, modify the <code class="inlineCode">applicationUrl</code> to use port <code class="inlineCode">5111</code> for <code class="inlineCode">https</code> and <code class="inlineCode">5112</code> for <code class="inlineCode">http</code>, as shown highlighted in the following configuration:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">"</span><span class="code-highlight"><strong class="hljs-attr-slc">https</strong></span><span class="hljs-attr">"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"commandName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Project"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dotnetRunMessages"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"launchBrowser"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
<span class="code-highlight"><strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"applicationUrl"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"https://localhost:5111;http://localhost:5112"</strong><strong class="hljs-punctuation-slc">,</strong></span>
  <span class="hljs-attr">"environmentVariables"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ASPNETCORE_ENVIRONMENT"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Development"</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.SignalR.Service.Client.Mvc</code> project, add a class file named <code class="inlineCode">ChatHub.cs</code>. </li>
      <li class="numberedList">In <code class="inlineCode">ChatHub.cs</code>, modify<a id="_idIndexMarker1165"/> its contents to inherit from the <code class="inlineCode">Hub</code> class and implement<a id="_idIndexMarker1166"/> two methods that can be called by a client, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.SignalR; <span class="hljs-comment">// To use Hub.</span>
<span class="hljs-keyword">using</span> Northwind.Chat.Models; <span class="hljs-comment">// To use UserModel, MessageModel.</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Northwind.SignalR.Service.Hubs</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ChatHub</span> : <span class="hljs-title">Hub</span>
{
  <span class="hljs-comment">// A new instance of ChatHub is created to process each method so we</span>
  <span class="hljs-comment">// must store user names, connection IDs, and groups in a static field.</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Dictionary&lt;<span class="hljs-built_in">string</span>, UserModel&gt; Users = <span class="hljs-keyword">new</span>();
  <span class="hljs-keyword">public</span><span class="hljs-function"> </span><span class="hljs-keyword">async</span><span class="hljs-function"> Task </span><span class="hljs-title">Register</span><span class="hljs-function">(</span><span class="hljs-params">UserModel newUser</span><span class="hljs-function">)</span>
  {
    UserModel user;
    <span class="hljs-built_in">string</span> action = <span class="hljs-string">"</span><span class="hljs-string">registered as a new user"</span>;
    <span class="hljs-comment">// Try to get a stored user with a match on new user.</span>
    <span class="hljs-keyword">if</span> (Users.ContainsKey(newUser.Name))
    {
      user = Users[newUser.Name];
      <span class="hljs-comment">// Remove any existing group registrations.</span>
      <span class="hljs-keyword">if</span> (user.Groups <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>)
      {
        <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">in</span> user.Groups.Split(<span class="hljs-string">','</span>))
        {
          <span class="hljs-keyword">await</span> Groups.RemoveFromGroupAsync(user.ConnectionId, <span class="hljs-keyword">group</span>);
        }
      }
      user.Groups = newUser.Groups;
      <span class="hljs-comment">// Connection ID might have changed if the browser </span>
      <span class="hljs-comment">// refreshed so update it.</span>
      user.ConnectionId = Context.ConnectionId;
      action = <span class="hljs-string">"updated your registered user"</span>;
    }
    <span class="hljs-keyword">else</span>
    {
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(newUser.Name))
      {
        <span class="hljs-comment">// Assign a GUID for name if they are anonymous.</span>
        newUser.Name = Guid.NewGuid().ToString();
      }
      newUser.ConnectionId = Context.ConnectionId;
      Users.Add(key: newUser.Name, <span class="hljs-keyword">value</span>: newUser);
      user = newUser;
    }
    <span class="hljs-keyword">if</span> (user.Groups <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>)
    {
      <span class="hljs-comment">// A user does not have to belong to any groups</span>
      <span class="hljs-comment">// but if they do, register them with the Hub.</span>
      <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">in</span> user.Groups.Split(<span class="hljs-string">','</span>))
      {
        <span class="hljs-keyword">await</span> Groups.AddToGroupAsync(user.ConnectionId, <span class="hljs-keyword">group</span>);
      }
    }
    <span class="hljs-comment">// Send a message to the registering user informing of success.</span>
    MessageModel message = <span class="hljs-keyword">new</span>() 
    { 
      From = <span class="hljs-string">"SignalR Hub"</span>, To = user.Name, 
      Body = <span class="hljs-built_in">string</span>.Format(
        <span class="hljs-string">"</span><span class="hljs-string">You have successfully {0} with connection ID {1}."</span>,
        arg0: action, arg1: user.ConnectionId)
    };
    IClientProxy proxy = Clients.Client(user.ConnectionId);
    <span class="hljs-keyword">await</span> proxy.SendAsync(<span class="hljs-string">"ReceiveMessage"</span>, message);
  }
  <span class="hljs-keyword">public</span><span class="hljs-function"> </span><span class="hljs-keyword">async</span><span class="hljs-function"> Task </span><span class="hljs-title">SendMessage</span><span class="hljs-function">(</span><span class="hljs-params">MessageModel message</span><span class="hljs-function">)</span>
  {
    IClientProxy proxy;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(message.To))
    {
      message.To = <span class="hljs-string">"Everyone"</span>;
      proxy = Clients.All;
      <span class="hljs-keyword">await</span> proxy.SendAsync(<span class="hljs-string">"ReceiveMessage"</span>, message);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">// Split To into a list of user and group names.</span>
    <span class="hljs-built_in">string</span>[] userAndGroupList = message.To.Split(<span class="hljs-string">','</span>);
    <span class="hljs-comment">// Each item could be a user or group name.</span>
    <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> userOrGroup <span class="hljs-keyword">in</span> userAndGroupList)
    {
      <span class="hljs-keyword">if</span> (Users.ContainsKey(userOrGroup))
      {
        <span class="hljs-comment">// If the item is in Users then send the message to that user</span>
        <span class="hljs-comment">// by looking up their connection ID in the dictionary.</span>
        message.To = <span class="hljs-string">$"User: </span><span class="hljs-subst">{Users[userOrGroup].Name}</span><span class="hljs-string">"</span>;
        proxy = Clients.Client(Users[userOrGroup].ConnectionId);
      }
      <span class="hljs-keyword">else</span> <span class="hljs-comment">// Assume the item is a group name to send the message to.</span>
      {
        message.To = <span class="hljs-string">$"Group: </span><span class="hljs-subst">{userOrGroup}</span><span class="hljs-string">"</span>;
        proxy = Clients.Group(userOrGroup);
      }
      <span class="hljs-keyword">await</span> proxy.SendAsync(<span class="hljs-string">"ReceiveMessage"</span>, message);
    }
  }
}
</code></pre>
      
    <p class="normal">Note the following:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">ChatHub</code> has a private field to store a list of registered users. It is a dictionary with their name as a unique key.</li>
      <li class="bulletList"><code class="inlineCode">ChatHub</code> has two methods that a client can call: <code class="inlineCode">Register</code> and <code class="inlineCode">SendMessage</code>.</li>
      <li class="bulletList"><code class="inlineCode">Register</code> has a single parameter of type <code class="inlineCode">UserModel</code>. The user’s name, connection ID, and groups are stored in the static dictionary so that the user’s name<a id="_idIndexMarker1167"/> can be used to look up the connection ID later and send messages directly to that one user. After registering a new user or updating the registration of an existing user, a message is sent back to the client informing them of success.</li>
      <li class="bulletList"><code class="inlineCode">SendMessage</code> has a single parameter of type <code class="inlineCode">MessageModel</code>. The method branches based on the value of the <code class="inlineCode">To</code> property. If <code class="inlineCode">To</code> does not have a value, it calls the <code class="inlineCode">All</code> property to get a proxy that will communicate with every client. If <code class="inlineCode">To</code> has a value, the <code class="inlineCode">string</code> is split using comma separators into an array. Each item in the array is checked to see if it matches a user in <code class="inlineCode">Users</code>. If it matches, it calls<a id="_idIndexMarker1168"/> the <code class="inlineCode">Client</code> method to get a proxy that will communicate just with that one client. If it does not match, the item might be a group, so it calls the <code class="inlineCode">Group</code> method to get a proxy that will communicate with just the members of that group. Finally, it sends the message asynchronously using the proxy.</li>
    </ul></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">In <code class="inlineCode">Program.cs</code>, import the namespace for your SignalR hub, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">using</span> Northwind.SignalR.Service.Hubs; <span class="hljs-comment">// To use ChatHub.</span>
</code></pre>
      </li>
      <li class="numberedList">In the section that configures services, add a statement to add support for SignalR to the services collection, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddSignalR();
</code></pre>
      </li>
      <li class="numberedList">In the section that configures the HTTP pipeline, before the call to map controller <a id="_idIndexMarker1169"/>routes, add a statement to map the relative URL path <code class="inlineCode">/chat</code> to<a id="_idIndexMarker1170"/> your SignalR hub, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.MapHub&lt;ChatHub&gt;(<span class="hljs-string">"/chat"</span>);
</code></pre>
      </li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-422">Building a web client using the SignalR JavaScript library</h1>
    <p class="normal">Next, we will add the<a id="_idIndexMarker1171"/> SignalR client-side JavaScript library so that <a id="_idIndexMarker1172"/>we can use it on a web page:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Open a command prompt or terminal for the <code class="inlineCode">Northwind.SignalR.Service.Client.Mvc</code> project/folder.</li>
      <li class="numberedList">Install the Library Manager CLI tool, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet tool install -g Microsoft.Web.LibraryManager.Cli
</code></pre>
      
    <div class="note">
      <p class="normal">This tool might already be installed globally. To update it to the latest version, repeat the command but replace <code class="inlineCode">install</code> with <code class="inlineCode">update</code>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Enter a command to add the <code class="inlineCode">signalr.js</code> and <code class="inlineCode">signalr.min.js</code> libraries to the project from the <code class="inlineCode">unpkg</code> source, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">libman install @microsoft/signalr@latest -p unpkg -d wwwroot/js/signalr --files dist/browser/signalr.js --files dist/browser/signalr.min.js
</code></pre>
      
    <div class="note">
      <p class="normal">Never copy long commands from a PDF and paste them directly to the command prompt. Always clean them up in a basic text editor to remove extraneous new lines and so on and then recopy them. To make it easier to enter long command lines, you can copy them from the following link: <a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/command-lines.md"><span class="url">https://github.com/markjprice/apps-services-net8/blob/main/docs/command-lines.md</span></a></p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Note the success message, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">wwwroot/js/signalr/dist/browser/signalr.js written to disk
wwwroot/js/signalr/dist/browser/signalr.min.js written to disk
Installed library "@microsoft/signalr@latest" to "wwwroot/js/signalr"
</code></pre>
      </li>
    </ol>
    <div class="note">
      <p class="normal">Visual Studio 2022 also has a GUI for adding client-side JavaScript libraries. To use it, right-click a web <a id="_idIndexMarker1173"/>project and then navigate to <strong class="screenText">Add</strong> | <strong class="screenText">Client Side Libraries</strong>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-423">Adding a chat page to the MVC website</h2>
    <p class="normal">Next, we will add <a id="_idIndexMarker1174"/>chat functionality to<a id="_idIndexMarker1175"/> the home page:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">Views/Home</code>, in <code class="inlineCode">Index.cshtml</code>, modify its contents, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">@using Northwind.Chat.Models
@{
  ViewData["Title"] = "SignalR Chat";
}
<span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"container"</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>@ViewData["Title"]<span class="hljs-tag">&lt;/</span><span class="hljs-name">h1</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">hr</span><span class="hljs-tag"> /&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"col"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">h2</span><span class="hljs-tag">&gt;</span>Register User<span class="hljs-tag">&lt;/</span><span class="hljs-name">h2</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mb-3"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">label</span><span class="hljs-tag"> </span><span class="hljs-attr">for</span><span class="hljs-tag">=</span><span class="hljs-string">"myName"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-label"</span><span class="hljs-tag">&gt;</span>My name<span class="hljs-tag">&lt;/</span><span class="hljs-name">label</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"text"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-control"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">               </span><span class="hljs-attr">id</span><span class="hljs-tag">=</span><span class="hljs-string">"myName"</span><span class="hljs-tag"> </span><span class="hljs-attr">value</span><span class="hljs-tag">=</span><span class="hljs-string">"Alice"</span><span class="hljs-tag"> </span><span class="hljs-attr">required</span><span class="hljs-tag"> /&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mb-3"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">label</span><span class="hljs-tag"> </span><span class="hljs-attr">for</span><span class="hljs-tag">=</span><span class="hljs-string">"myGroups"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-label"</span><span class="hljs-tag">&gt;</span>My groups<span class="hljs-tag">&lt;/</span><span class="hljs-name">label</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"text"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-control"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">               </span><span class="hljs-attr">id</span><span class="hljs-tag">=</span><span class="hljs-string">"myGroups"</span><span class="hljs-tag"> </span><span class="hljs-attr">value</span><span class="hljs-tag">=</span><span class="hljs-string">"Sales,IT"</span><span class="hljs-tag"> /&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mb-3"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"button"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-control"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">               </span><span class="hljs-attr">id</span><span class="hljs-tag">=</span><span class="hljs-string">"registerButton"</span><span class="hljs-tag"> </span><span class="hljs-attr">value</span><span class="hljs-tag">=</span><span class="hljs-string">"Register User"</span><span class="hljs-tag"> /&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"col"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">h2</span><span class="hljs-tag">&gt;</span>Send Message<span class="hljs-tag">&lt;/</span><span class="hljs-name">h2</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mb-3"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">label</span><span class="hljs-tag"> </span><span class="hljs-attr">for</span><span class="hljs-tag">=</span><span class="hljs-string">"from"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-label"</span><span class="hljs-tag">&gt;</span>From<span class="hljs-tag">&lt;/</span><span class="hljs-name">label</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"text"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-control"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">               </span><span class="hljs-attr">id</span><span class="hljs-tag">=</span><span class="hljs-string">"from"</span><span class="hljs-tag"> </span><span class="hljs-attr">value</span><span class="hljs-tag">=</span><span class="hljs-string">"Alice"</span><span class="hljs-tag"> </span><span class="hljs-attr">readonly</span><span class="hljs-tag"> /&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mb-3"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">label</span><span class="hljs-tag"> </span><span class="hljs-attr">for</span><span class="hljs-tag">=</span><span class="hljs-string">"to"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-label"</span><span class="hljs-tag">&gt;</span>To<span class="hljs-tag">&lt;/</span><span class="hljs-name">label</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"text"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-control"</span><span class="hljs-tag"> </span><span class="hljs-attr">id</span><span class="hljs-tag">=</span><span class="hljs-string">"to"</span><span class="hljs-tag"> /&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mb-3"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">label</span><span class="hljs-tag"> </span><span class="hljs-attr">for</span><span class="hljs-tag">=</span><span class="hljs-string">"body"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-label"</span><span class="hljs-tag">&gt;</span>Body<span class="hljs-tag">&lt;/</span><span class="hljs-name">label</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"text"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-control"</span><span class="hljs-tag"> </span><span class="hljs-attr">id</span><span class="hljs-tag">=</span><span class="hljs-string">"body"</span><span class="hljs-tag"> /&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"mb-3"</span><span class="hljs-tag">&gt;</span>
        <span class="hljs-tag">&lt;</span><span class="hljs-name">input</span><span class="hljs-tag"> </span><span class="hljs-attr">type</span><span class="hljs-tag">=</span><span class="hljs-string">"button"</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"form-control"</span><span class="hljs-tag"> </span>
<span class="hljs-tag">               </span><span class="hljs-attr">id</span><span class="hljs-tag">=</span><span class="hljs-string">"sendButton"</span><span class="hljs-tag"> </span><span class="hljs-attr">value</span><span class="hljs-tag">=</span><span class="hljs-string">"Send Message"</span><span class="hljs-tag"> /&gt;</span>
      <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"row"</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;</span><span class="hljs-name">div</span><span class="hljs-tag"> </span><span class="hljs-attr">class</span><span class="hljs-tag">=</span><span class="hljs-string">"col"</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">hr</span><span class="hljs-tag"> /&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">h2</span><span class="hljs-tag">&gt;</span>Messages received<span class="hljs-tag">&lt;/</span><span class="hljs-name">h2</span><span class="hljs-tag">&gt;</span>
      <span class="hljs-tag">&lt;</span><span class="hljs-name">ul</span><span class="hljs-tag"> </span><span class="hljs-attr">id</span><span class="hljs-tag">=</span><span class="hljs-string">"messages"</span><span class="hljs-tag">&gt;&lt;/</span><span class="hljs-name">ul</span><span class="hljs-tag">&gt;</span>
    <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
  <span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;/</span><span class="hljs-name">div</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">script</span><span class="hljs-tag"> </span><span class="hljs-attr">src</span><span class="hljs-tag">=</span><span class="hljs-string">"~/js/signalr/dist/browser/signalr.js"</span><span class="hljs-tag">&gt;&lt;/</span><span class="hljs-name">script</span><span class="hljs-tag">&gt;</span>
<span class="hljs-tag">&lt;</span><span class="hljs-name">script</span><span class="hljs-tag"> </span><span class="hljs-attr">src</span><span class="hljs-tag">=</span><span class="hljs-string">"~/js/chat.js"</span><span class="hljs-tag">&gt;&lt;/</span><span class="hljs-name">script</span><span class="hljs-tag">&gt;</span>
</code></pre>
      
    <p class="normal">Note the following:</p>
    <ul>
      <li class="bulletList">There are <a id="_idIndexMarker1176"/>three sections on the page: <strong class="screenText">Register User</strong>, <strong class="screenText">Send</strong> <strong class="screenText">Message</strong>, and <strong class="screenText">Messages received</strong>.</li>
      <li class="bulletList">The <strong class="screenText">Register User</strong> section has two inputs for the visitor’s name, a comma-separated list of the groups that they want to be a member of, and a<a id="_idIndexMarker1177"/> button to click to register.</li>
      <li class="bulletList">The <strong class="screenText">Send Message</strong> section has three inputs for the name of the user that the message is from, the names of users and groups that the message will be sent to, and the body of the message – and a button to click to send the message. </li>
      <li class="bulletList">The <strong class="screenText">Messages received</strong> section has a bullet list element that will be dynamically populated with a list item when a message is received.</li>
      <li class="bulletList">There are two script elements for the SignalR JavaScript client-side library and the<a id="_idIndexMarker1178"/> JavaScript implementation of the chat client.</li>
    </ul></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="2">In <code class="inlineCode">wwwroot/js</code>, add a new JavaScript file named <code class="inlineCode">chat.js</code> and modify its contents, as shown<a id="_idIndexMarker1179"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta">"use strict"</span>;
<span class="hljs-keyword">var</span> connection = <span class="hljs-keyword">new</span> signalR.<span class="hljs-title">HubConnectionBuilder</span>()
  .<span class="hljs-title">withUrl</span>(<span class="hljs-string">"/chat"</span>).<span class="hljs-title">build</span>();
<span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"registerButton"</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
<span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"sendButton"</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
<span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"myName"</span>).<span class="hljs-title">addEventListener</span>(<span class="hljs-string">"input"</span>,
  <span class="hljs-keyword">function</span> () {
    <span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"from"</span>).<span class="hljs-property">value</span> = 
      <span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"myName"</span>).<span class="hljs-property">value</span>;
  }
);
connection.<span class="hljs-title">start</span>().<span class="hljs-title">then</span>(<span class="hljs-keyword">function</span> () {
  <span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"registerButton"</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"sendButton"</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
}).<span class="hljs-title">catch</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable">console</span>.<span class="hljs-title">error</span>(err.<span class="hljs-title">toString</span>());
});
connection.<span class="hljs-title">on</span>(<span class="hljs-string">"ReceiveMessage"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">received</span>) {
  <span class="hljs-keyword">var</span> li = <span class="hljs-variable">document</span>.<span class="hljs-title">createElement</span>(<span class="hljs-string">"li"</span>);
  <span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"messages"</span>).<span class="hljs-title">appendChild</span>(li);
  li.<span class="hljs-property">textContent</span> =
    <span class="hljs-comment">// This string must use backticks ` to enable an interpolated </span>
    <span class="hljs-comment">// string. If you use single quotes ' then it will not work!</span>
    <span class="hljs-string">`To </span><span class="hljs-subst">${received.to}</span><span class="hljs-string">, From </span><span class="hljs-subst">${received.</span><span class="hljs-keyword">from</span><span class="hljs-subst">}</span><span class="hljs-string">: </span><span class="hljs-subst">${received.body}</span><span class="hljs-string">`</span>;
});
<span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"registerButton"</span>).<span class="hljs-title">addEventListener</span>(<span class="hljs-string">"click"</span>,
  <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">var</span> registermodel = {
      <span class="hljs-attr">name</span>: <span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"myName"</span>).<span class="hljs-property">value</span>,
      <span class="hljs-attr">groups</span>: <span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"myGroups"</span>).<span class="hljs-property">value</span>
    };
    connection.<span class="hljs-title">invoke</span>(<span class="hljs-string">"Register"</span>, registermodel).<span class="hljs-title">catch</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable">console</span>.<span class="hljs-title">error</span>(err.<span class="hljs-title">toString</span>());
    });
    event.<span class="hljs-title">preventDefault</span>();
  });
<span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"sendButton"</span>).<span class="hljs-title">addEventListener</span>(<span class="hljs-string">"click"</span>,
  <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">var</span> messagemodel = {
      <span class="hljs-attr">from</span>: <span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"from"</span>).<span class="hljs-property">value</span>,
      <span class="hljs-attr">to</span>: <span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"to"</span>).<span class="hljs-property">value</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-variable">document</span>.<span class="hljs-title">getElementById</span>(<span class="hljs-string">"body"</span>).<span class="hljs-property">value</span>
    };
    connection.<span class="hljs-title">invoke</span>(<span class="hljs-string">"SendMessage"</span>, messagemodel).<span class="hljs-title">catch</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable">console</span>.<span class="hljs-title">error</span>(err.<span class="hljs-title">toString</span>());
    });
    event.<span class="hljs-title">preventDefault</span>();
});
</code></pre>
      
    <p class="normal">Note the<a id="_idIndexMarker1180"/> following:</p>
    <ul>
      <li class="bulletList">The script creates a SignalR hub connection builder specifying the relative URL path to the chat hub on the server <code class="inlineCode">/chat</code>.</li>
      <li class="bulletList">The script <a id="_idIndexMarker1181"/>disables the <strong class="screenText">Register</strong> and <strong class="screenText">Send</strong> buttons until the connection is successfully established to the server-side hub.</li>
      <li class="bulletList">An <code class="inlineCode">input</code> event handler is added to the <strong class="screenText">My name</strong> text box to keep it synchronized with the <strong class="screenText">From</strong> text box.</li>
      <li class="bulletList">When the connection gets a <code class="inlineCode">ReceiveMessage</code> call from the server-side hub, it adds a list item element to the <code class="inlineCode">messages</code> bullet list. The content of the list item contains details of the message like <code class="inlineCode">from</code>, <code class="inlineCode">to</code>, and <code class="inlineCode">body</code>. For the two models that we defined in C#, note that JavaScript uses<a id="_idIndexMarker1182"/> camelCase compared to C#, which uses PascalCase. </li>
    </ul>
    <div class="note">
      <p class="normal">The message is formatted using a JavaScript interpolated <code class="inlineCode">string</code>. This feature requires backticks <code class="inlineCode">`</code> at the start and end of the <code class="inlineCode">string</code> value and the use of curly brackets <code class="inlineCode">${}</code> for dynamic placeholders.</p>
    </div>
    <ul>
      <li class="bulletList">A <code class="inlineCode">click</code> event handler is added to the <strong class="screenText">Register User</strong> button that creates a <a id="_idIndexMarker1183"/>register model with the user’s name and their groups and then invokes the <code class="inlineCode">Register</code> method on the server side.</li>
      <li class="bulletList">A <code class="inlineCode">click</code> event handler is added to the <strong class="screenText">Send Message</strong> button that creates a message model with the <code class="inlineCode">from</code>, <code class="inlineCode">to</code>, and <code class="inlineCode">body</code>, and then invokes the <code class="inlineCode">SendMessage</code> method on the server side.</li>
    </ul></li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-424">Testing the chat feature</h2>
    <p class="normal">Now we are ready to<a id="_idIndexMarker1184"/> try sending chat messages between multiple website visitors:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start the <code class="inlineCode">Northwind.SignalR.Service.Client.Mvc</code> project website using the <code class="inlineCode">https</code> profile:<ul>
          <li class="bulletList">If you are using Visual Studio 2022, then select the <strong class="screenText">https</strong> profile in the toolbar, and then start the <code class="inlineCode">Northwind.SignalR.Service.Client.Mvc</code> project without debugging.</li>
          <li class="bulletList">If you are using Visual Studio Code, then at the command prompt or terminal, enter the following command:
            <pre class="programlisting con"><code class="hljs-con">dotnet run --launch-profile https
</code></pre>
          </li>
          <li class="bulletList">On Windows, if Windows Defender Firewall blocks access, then click <strong class="screenText">Allow access</strong>.</li>
        </ul>
      </li>
      <li class="numberedList">Start Chrome and navigate to <code class="codeHighlighted" style="font-weight: bold;">https://localhost:5111/</code>.</li>
      <li class="numberedList">Note that <code class="inlineCode">Alice</code> is already entered for the name, and <code class="inlineCode">Sales,IT</code> is already entered for her groups. Click <strong class="screenText">Register User</strong>, and note the response back from the <strong class="screenText">SignalR Chat</strong>, as<a id="_idIndexMarker1185"/> shown in <em class="italic">Figure 11.1</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_11_01.png"/></figure>
    <p class="packt_figref">Figure 11.1: Registering a new user in chat</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">Open a new Chrome window or start another browser like Firefox or Edge.</li>
      <li class="numberedList">Navigate to <code class="inlineCode">https://localhost:5111/</code>.</li>
      <li class="numberedList">Enter <code class="inlineCode">Bob</code> for the name, <code class="inlineCode">Sales</code> for his groups, and then click <strong class="screenText">Register User</strong>.</li>
      <li class="numberedList">Open a new Chrome window or start another browser like Firefox or Edge.</li>
      <li class="numberedList">Navigate to <code class="inlineCode">https://localhost:5111/</code>.</li>
      <li class="numberedList">Enter <code class="inlineCode">Charlie</code> for the name, <code class="inlineCode">IT</code> for his groups, and then click <strong class="screenText">Register User</strong>.</li>
      <li class="numberedList">Arrange the browser windows so that you can see all three simultaneously.
    <div class="note">
      <p class="normal">A great tool for arranging windows is PowerToys and its FancyZones feature. Learn more at the following link: <a href="https://learn.microsoft.com/en-us/windows/powertoys/"><span class="url">https://learn.microsoft.com/en-us/windows/powertoys/</span></a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="11">In Alice’s browser, enter<a id="_idIndexMarker1186"/> the following:<ul>
          <li class="bulletList"><strong class="screenText">To</strong>: <code class="inlineCode">Sales</code></li>
          <li class="bulletList"><strong class="screenText">Body</strong>: <code class="inlineCode">Sell more!</code> </li>
        </ul>
      </li>
      <li class="numberedList">Click <strong class="screenText">Send Message</strong>.</li>
      <li class="numberedList">Note that Alice and Bob receive the message, as shown in <em class="italic">Figure 11.2</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_11_02.png"/></figure>
    <p class="packt_figref">Figure 11.2: Alice sends a message to the Sales group</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="14">In Bob’s browser, enter the following:<ul>
          <li class="bulletList"><strong class="screenText">To</strong>: <code class="inlineCode">IT</code></li>
          <li class="bulletList"><strong class="screenText">Body</strong>: <code class="inlineCode">Fix more bugs!</code></li>
        </ul>
      </li>
      <li class="numberedList">Click <strong class="screenText">Send Message</strong>.</li>
      <li class="numberedList">Note that Alice and Charlie receive the message, as shown in <em class="italic">Figure 11.3</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_11_03.png"/></figure>
    <p class="packt_figref">Figure 11.3: Bob sends a message to the IT group</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="17">In Alice’s browser, enter <a id="_idIndexMarker1187"/>the following:<ul>
          <li class="bulletList"><strong class="screenText">To</strong>: <code class="inlineCode">Bob</code></li>
          <li class="bulletList"><strong class="screenText">Body</strong>: <code class="inlineCode">Bonjour Bob!</code></li>
        </ul>
      </li>
      <li class="numberedList">Click <strong class="screenText">Send Message</strong>.</li>
      <li class="numberedList">Note that only Bob receives the message.</li>
      <li class="numberedList">In Charlie’s browser, enter the following:<ul>
          <li class="bulletList"><strong class="screenText">To</strong>: Leave it empty.</li>
          <li class="bulletList"><strong class="screenText">Body</strong>: <code class="inlineCode">Everybody dance now!</code></li>
        </ul>
      </li>
      <li class="numberedList">Click <strong class="screenText">Send Message</strong>.</li>
      <li class="numberedList">Note that everyone receives the message, as shown in <em class="italic">Figure 11.4</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_11_04.png"/></figure>
    <p class="packt_figref">Figure 11.4: Charlie sends a message to everyone</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="23">In Charlie’s browser, enter <a id="_idIndexMarker1188"/>the following:<ul>
          <li class="bulletList"><strong class="screenText">To</strong>: <code class="inlineCode">HR,Alice</code> </li>
          <li class="bulletList"><strong class="screenText">Body</strong>: <code class="inlineCode">Is anyone in HR listening?</code> </li>
        </ul>
      </li>
      <li class="numberedList">Click <strong class="screenText">Send Message</strong>.</li>
      <li class="numberedList">Note that Alice receives the message sent directly to her, but since the HR group does not exist, no one receives the message sent to that group, as shown in <em class="italic">Figure 11.5</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_11_05.png"/></figure>
    <p class="packt_figref">Figure 11.5: Charlie sends a message to Alice and a group that does not exist</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="26">Close the<a id="_idIndexMarker1189"/> browsers and shut down the web server.</li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-425">Building a .NET console app client</h1>
    <p class="normal">You have just <a id="_idIndexMarker1190"/>seen a .NET service hosting a SignalR hub, and a JavaScript client exchanging messages with other clients via that SignalR hub. Now, let’s create a .NET client for SignalR. </p>
    <h2 class="heading-2" id="_idParaDest-426">Creating a .NET client for SignalR</h2>
    <p class="normal">We will use a console app, although any .NET project type would need the same package reference<a id="_idIndexMarker1191"/> and implementation <a id="_idIndexMarker1192"/>code:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to add a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Console Application </strong>/ <code class="inlineCode">console</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter11</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.SignalR.Client.Console</code></li>
        </ul>
      </li>
      <li class="numberedList">Add a package reference for the ASP.NET Core SignalR client and a project reference for <code class="inlineCode">Northwind.Common</code>, treat warnings as errors, and globally and statically import the <code class="inlineCode">System.Console</code> class, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference Include=<span class="hljs-string">"Microsoft.AspNetCore.SignalR.Client"</span> 
                    Version=<span class="hljs-string">"8.0.0"</span> /&gt;
&lt;/ItemGroup&gt;
&lt;ItemGroup&gt;
  &lt;ProjectReference 
    Include=<span class="hljs-string">"..\Northwind.Common\Northwind.Common.csproj"</span> /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the project to restore<a id="_idIndexMarker1193"/> packages and build referenced projects.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, delete <a id="_idIndexMarker1194"/>the existing statements, import namespaces for working with SignalR as a client and the chat models, and then add statements to prompt the user to enter a username and groups to register with, create a hub connection, and finally, listen for received messages, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.SignalR.Client; <span class="hljs-comment">// To use HubConnection.</span>
<span class="hljs-keyword">using</span> Northwind.Chat.Models; <span class="hljs-comment">// To use UserModel, MessageModel.</span>
Write(<span class="hljs-string">"Enter a username (required): "</span>);
<span class="hljs-built_in">string</span>? username = ReadLine();
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(username))
{
  WriteLine(<span class="hljs-string">"You must enter a username to register with chat!"</span>);
  <span class="hljs-keyword">return</span>;
}
Write(<span class="hljs-string">"Enter your groups (optional): "</span>);
<span class="hljs-built_in">string</span>? groups = ReadLine();
HubConnection hubConnection = <span class="hljs-keyword">new</span> HubConnectionBuilder()
  .WithUrl(<span class="hljs-string">"https://localhost:5111/chat"</span>)
  .Build();
hubConnection.On&lt;MessageModel&gt;(<span class="hljs-string">"ReceiveMessage"</span>, message =&gt;
{
  WriteLine(<span class="hljs-string">$"To </span><span class="hljs-subst">{message.To}</span><span class="hljs-string">, From </span><span class="hljs-subst">{message.From}</span><span class="hljs-string">: </span><span class="hljs-subst">{message.Body}</span><span class="hljs-string">"</span>);
});
<span class="hljs-keyword">await</span> hubConnection.StartAsync();
WriteLine(<span class="hljs-string">"Successfully started."</span>);
UserModel registration = <span class="hljs-keyword">new</span>()
{
  Name = username,
  Groups = groups
};
<span class="hljs-keyword">await</span> hubConnection.InvokeAsync(<span class="hljs-string">"Register"</span>, registration);
WriteLine(<span class="hljs-string">"Successfully registered."</span>);
WriteLine(<span class="hljs-string">"Listening... (press ENTER to stop.)"</span>);
ReadLine();
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-427">Testing the .NET console app client</h2>
    <p class="normal">Let’s start the SignalR <a id="_idIndexMarker1195"/>service and call it from the console app:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start the <code class="inlineCode">Northwind.SignalR.Service.Client.Mvc</code> project website using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start Chrome and navigate to <code class="inlineCode">https://localhost:5111/</code>.</li>
      <li class="numberedList">Click <strong class="screenText">Register User</strong>.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.SignalR.Client.Console</code> project.</li>
      <li class="numberedList">Enter your name and the groups: <code class="inlineCode">Sales,Admins</code>.</li>
      <li class="numberedList">Arrange the browser and console app windows so that you can see both simultaneously.</li>
      <li class="numberedList">In Alice’s browser, enter the following:<ul>
          <li class="bulletList"><strong class="screenText">To</strong>: <code class="inlineCode">Sales</code> </li>
          <li class="bulletList"><strong class="screenText">Body</strong>: <code class="inlineCode">Go team!</code></li>
        </ul>
      </li>
      <li class="numberedList"><strong class="screenText">C</strong>lick <strong class="screenText">Send Message</strong>, and note<a id="_idIndexMarker1196"/> that Alice and you receive the message, as shown in <em class="italic">Figure 11.6</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="../Images/B19587_11_06.png"/></figure>
    <p class="packt_figref">Figure 11.6: Alice sends a message to the Sales team including a user in a console app</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">In the console app, press <em class="italic">Enter</em> to stop it from listening.</li>
      <li class="numberedList">Close Chrome and shut down the web server.</li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-428">Streaming data using SignalR</h1>
    <p class="normal">So far, we have seen how SignalR can broadcast structured messages to one or more clients. This works well with data that is relatively small and structured and exists completely at a<a id="_idIndexMarker1197"/> point in time. But what about data that comes in parts over time? </p>
    <p class="normal"><strong class="keyWord">Streams</strong> can be used for<a id="_idIndexMarker1198"/> these scenarios. SignalR supports<a id="_idIndexMarker1199"/> both service-to-client (downloading data from a stream) and client-to-service (uploading data to a stream).</p>
    <p class="normal">To enable download streaming, a hub method must return <code class="inlineCode">IAsyncEnumerable&lt;T&gt;</code> (only supported by C# 8 or later) or <code class="inlineCode">ChannelReader&lt;T&gt;</code>.</p>
    <p class="normal">To enable upload streaming, a hub method must accept a parameter of type <code class="inlineCode">IAsyncEnumerable&lt;T&gt;</code> (only supported by C# 8 or later) or <code class="inlineCode">ChannelReader&lt;T&gt;</code>.</p>
    <h2 class="heading-2" id="_idParaDest-429">Defining a hub for streaming</h2>
    <p class="normal">Let’s add some streaming <a id="_idIndexMarker1200"/>methods to see how they work in <a id="_idIndexMarker1201"/>action:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.Common</code> project, add a new file named <code class="inlineCode">StockPrice.cs</code> and modify its content to define a <code class="inlineCode">record</code> for stock price data, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">namespace</span> <span class="hljs-title">Northwind.SignalR.Streams</span>;
<span class="hljs-keyword">public</span><span class="hljs-function"> </span><span class="hljs-keyword">record</span><span class="hljs-function"> </span><span class="hljs-title">StockPrice</span><span class="hljs-function">(</span><span class="hljs-built_in">string</span><span class="hljs-params"> Stock, </span><span class="hljs-built_in">double</span><span class="hljs-params"> Price</span><span class="hljs-function">)</span>;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.SignalR.Service.Client.Mvc</code> project to update its referenced projects.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.SignalR.Service.Client.Mvc</code> project, add a new class named <code class="inlineCode">StockPriceHub.cs</code>, and modify its contents to define a hub with two streaming methods, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.SignalR; <span class="hljs-comment">// To use Hub.</span>
<span class="hljs-keyword">using</span> System.Runtime.CompilerServices; <span class="hljs-comment">// To use [EnumeratorCancellation].</span>
<span class="hljs-keyword">using</span> Northwind.SignalR.Streams; <span class="hljs-comment">// To use StockPrice.</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Northwind.SignalR.Service.Hubs</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StockPriceHub</span> : <span class="hljs-title">Hub</span>
{
  <span class="hljs-keyword">public</span><span class="hljs-function"> </span><span class="hljs-keyword">async</span><span class="hljs-function"> IAsyncEnumerable&lt;StockPrice&gt; </span><span class="hljs-title">GetStockPriceUpdates</span><span class="hljs-function">(</span>
<span class="hljs-params">    </span><span class="hljs-built_in">string</span><span class="hljs-params"> stock,</span>
<span class="hljs-params">    [EnumeratorCancellation] CancellationToken cancellationToken</span><span class="hljs-function">)</span>
  {
    <span class="hljs-built_in">double</span> currentPrice = <span class="hljs-number">267.10</span>; <span class="hljs-comment">// Simulated initial price.</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
    {
      <span class="hljs-comment">// Check the cancellation token regularly so that the server will stop</span>
      <span class="hljs-comment">// producing items if the client disconnects.</span>
      cancellationToken.ThrowIfCancellationRequested();
      <span class="hljs-comment">// Increment or decrement the current price by a random amount.</span>
      <span class="hljs-comment">// The compiler does not need the extra parentheses but it</span>
      <span class="hljs-comment">// is clearer for humans if you put them in.</span>
      currentPrice += (Random.Shared.NextDouble() * <span class="hljs-number">10.0</span>) - <span class="hljs-number">5.0</span>;
      StockPrice stockPrice = <span class="hljs-keyword">new</span>(stock, currentPrice);
     Console.WriteLine(<span class="hljs-string">"[{0}] {1} at {2:C}"</span>,
       DateTime.UtcNow, stockPrice.Stock, stockPrice.Price);
      <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> stockPrice;
      <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">4000</span>, cancellationToken); <span class="hljs-comment">// milliseconds</span>
    }
  }
  <span class="hljs-keyword">public</span><span class="hljs-function"> </span><span class="hljs-keyword">async</span><span class="hljs-function"> Task </span><span class="hljs-title">UploadStocks</span><span class="hljs-function">(</span><span class="hljs-params">IAsyncEnumerable&lt;</span><span class="hljs-built_in">string</span><span class="hljs-params">&gt; stocks</span><span class="hljs-function">)</span>
  {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> stock <span class="hljs-keyword">in</span> stocks)
    {
      Console.WriteLine(<span class="hljs-string">$"Receiving </span><span class="hljs-subst">{stock}</span><span class="hljs-string"> from client..."</span>);
    }
  }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.SignalR.Service.Client.Mvc</code> project, in <code class="inlineCode">Program.cs</code>, register the<a id="_idIndexMarker1202"/> stock price hub after the statement that registers the chat hub, as shown in the<a id="_idIndexMarker1203"/> following code:
        <pre class="programlisting code"><code class="hljs-code"><code class="codeHighlighted" style="font-weight: bold;">app.MapHub&lt;StockPriceHub&gt;("/stockprice");</code>
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-430">Creating a .NET console app client for streaming</h2>
    <p class="normal">Now, we can create a simple client to download a stream of data from the SignalR hub and upload a stream<a id="_idIndexMarker1204"/> of data to the SignalR hub:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to add a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">Console Application</strong> / <code class="inlineCode">console</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter11</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.SignalR.Client.Console.Streams</code></li>
        </ul>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.SignalR.Client.Console.Streams</code> project file, treat warnings as errors, add a package reference for the ASP.NET Core SignalR client, add a project reference to <code class="inlineCode">Northwind.Common</code>, and globally and statically import the <code class="inlineCode">System.Console</code> class, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;PackageReference Include=<span class="hljs-string">"Microsoft.AspNetCore.SignalR.Client"</span> 
                    Version=<span class="hljs-string">"8.0.0"</span> /&gt;
&lt;/ItemGroup&gt;
&lt;ItemGroup&gt;
  &lt;ProjectReference 
    Include=<span class="hljs-string">"..\Northwind.Common\Northwind.Common.csproj"</span> /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.SignalR.Client.Console.Streams</code> project, add a new class file named <code class="inlineCode">Program.Methods.cs</code>, and modify its content to define static methods in the partial <code class="inlineCode">Program</code> class to generate ten random four-letter stock <a id="_idIndexMarker1205"/>codes asynchronously, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">// Defined in the empty default namespace to merge with the auto-</span>
<span class="hljs-comment">// generated partial Program class.</span>
<span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
  <span class="hljs-keyword">static</span><span class="hljs-function"> </span><span class="hljs-keyword">async</span><span class="hljs-function"> IAsyncEnumerable&lt;</span><span class="hljs-built_in">string</span><span class="hljs-function">&gt; </span><span class="hljs-title">GetStocksAsync</span><span class="hljs-function">()</span>
  {
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
    {
      <span class="hljs-comment">// Return a random four-letter stock code.</span>
      <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-string">$"</span><span class="hljs-subst">{AtoZ()}{AtoZ()}{AtoZ()}{AtoZ()}</span><span class="hljs-string">"</span>;
      <span class="hljs-keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number">3</span>));
    }
  }
  <span class="hljs-keyword">static</span><span class="hljs-function"> </span><span class="hljs-built_in">string</span><span class="hljs-function"> </span><span class="hljs-title">AtoZ</span><span class="hljs-function">()</span>
  {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">char</span>.ConvertFromUtf32(Random.Shared.Next(<span class="hljs-number">65</span>, <span class="hljs-number">91</span>));
  }
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.SignalR.Client.Console.Streams</code> project, in <code class="inlineCode">Program.cs</code>, delete the existing statements. Import namespaces for working with SignalR as a client, and then add statements to prompt the user to enter a stock, create a hub connection, listen for received streams of stock prices, and then send an asynchronous stream of stocks to the service, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">using</span> Microsoft.AspNetCore.SignalR.Client; <span class="hljs-comment">// To use HubConnection.</span>
<span class="hljs-keyword">using</span> Northwind.SignalR.Streams; <span class="hljs-comment">// To use StockPrice.</span>
Write(<span class="hljs-string">"Enter a stock (press Enter for MSFT): "</span>);
<span class="hljs-built_in">string</span>? stock = ReadLine();
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(stock))
{
  stock = <span class="hljs-string">"MSFT"</span>;
}
HubConnection hubConnection = <span class="hljs-keyword">new</span> HubConnectionBuilder()
  .WithUrl(<span class="hljs-string">"https://localhost:5111/stockprice"</span>)
  .Build();
<span class="hljs-keyword">await</span> hubConnection.StartAsync();
<span class="hljs-keyword">try</span>
{
  CancellationTokenSource cts = <span class="hljs-keyword">new</span>();
  IAsyncEnumerable&lt;StockPrice&gt; stockPrices = 
    hubConnection.StreamAsync&lt;StockPrice&gt;(
      <span class="hljs-string">"GetStockPriceUpdates"</span>, stock, cts.Token);
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (StockPrice sp <span class="hljs-keyword">in</span> stockPrices)
  {
    WriteLine(<span class="hljs-string">$"</span><span class="hljs-subst">{sp.Stock}</span><span class="hljs-string"> is now </span><span class="hljs-subst">{sp.Price:C}</span><span class="hljs-string">."</span>);
    Write(<span class="hljs-string">"Do you want to cancel (y/n)? "</span>);
    ConsoleKey key = ReadKey().Key;
    <span class="hljs-keyword">if</span> (key == ConsoleKey.Y)
    {
      cts.Cancel();
    }
    WriteLine();
  }
}
<span class="hljs-keyword">catch</span> (Exception ex)
{
  WriteLine(<span class="hljs-string">$"</span><span class="hljs-subst">{ex.GetType()}</span><span class="hljs-string"> says </span><span class="hljs-subst">{ex.Message}</span><span class="hljs-string">"</span>);
}
WriteLine();
WriteLine(<span class="hljs-string">"Streaming download completed."</span>);
<span class="hljs-keyword">await</span> hubConnection.SendAsync(<span class="hljs-string">"UploadStocks"</span>, GetStocksAsync());
WriteLine(<span class="hljs-string">"Uploading stocks to service... (press ENTER to stop.)"</span>);
ReadLine();
WriteLine(<span class="hljs-string">"Ending console app."</span>);
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-431">Testing the streaming service and client</h2>
    <p class="normal">Finally, we can test the <a id="_idIndexMarker1206"/>streaming data functionality:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Start the <code class="inlineCode">Northwind.SignalR.Service.Client.Mvc</code> project website using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.SignalR.Client.Console.Streams</code> console app without debugging.</li>
      <li class="numberedList">Arrange the console windows for the ASP.NET Core MVC website and the client console app so that you can see both side by side.</li>
      <li class="numberedList">In the client console app, press <em class="keystroke">Enter</em> to use the Microsoft stock code, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Enter a stock (press Enter for MSFT):
MSFT is now £265.00.
Do you want to cancel (y/n)? 
</code></pre>
      </li>
      <li class="numberedList">In the website console window, wait for about ten seconds, and note that several stock prices have been generated in the service but not yet sent to the client, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:5131
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5132
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\apps-services-net7\Chapter13\Northwind.SignalR.Service.Client.Mvc
[12/09/2022 17:52:26] MSFT at £265.00
[12/09/2022 17:52:30] MSFT at £260.78
[12/09/2022 17:52:34] MSFT at £264.86
[12/09/2022 17:52:38] MSFT at £262.10
</code></pre>
      </li>
      <li class="numberedList">In the client console app, press <em class="keystroke">n</em> to receive the next updated price. Keep pressing <em class="keystroke">n</em> until the prices have been sent from the service and read by the client, and then press <em class="keystroke">y</em>, and note that a cancellation token is received by the SignalR service so it stops, and the client now starts uploading stocks, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">MSFT is now £260.78.
Do you want to cancel (y/n)? n
MSFT is now £264.86.
Do you want to cancel (y/n)? n
MSFT is now £262.10.
Do you want to cancel (y/n)? y
System.Threading.Tasks.TaskCanceledException says A task was canceled.
Streaming download completed.
Uploading stocks to service... (press ENTER to stop.)
</code></pre>
      </li>
      <li class="numberedList">In the website console window, note that the random stock codes are received, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Receiving PJON from client...
Receiving VWJD from client...
Receiving HMOJ from client...
Receiving QQMQ from client...
</code></pre>
      </li>
      <li class="numberedList">Close both <a id="_idIndexMarker1207"/>console windows.</li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-432">Practicing and exploring</h1>
    <p class="normal">Test your knowledge and understanding by answering some questions, getting some hands-on practice, and exploring this chapter’s topics with deeper research.</p>
    <h2 class="heading-2" id="_idParaDest-433">Exercise 11.1 – Test your knowledge</h2>
    <p class="normal">Answer the following questions:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">What transports does SignalR use, and which is the default?</li>
      <li class="numberedList">What is a good practice for RPC method signature design?</li>
      <li class="numberedList">What tool can you use to download the SignalR JavaScript library?</li>
      <li class="numberedList">What happens if you send a SignalR message to a client with a connection ID that does not exist? </li>
      <li class="numberedList">What are the benefits of separating a SignalR service from other ASP.NET Core components? </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-434">Exercise 11.2 – Explore topics</h2>
    <p class="normal">Use the links on the following page to learn more details about the topics covered in this chapter:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-11---broadcasting-real-time-communication-using-signalr"><span class="url">https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-11---broadcasting-real-time-communication-using-signalr</span></a></p>
    <h1 class="heading-1" id="_idParaDest-435">Summary</h1>
    <p class="normal">In this chapter, you learned about:</p>
    <ul>
      <li class="bulletList">The history of technologies before SignalR.</li>
      <li class="bulletList">The concepts and technologies that underpin SignalR.</li>
      <li class="bulletList">Implementing the chat functionality using SignalR, including building a hub hosted in a website project, and clients using JavaScript and a .NET console app.</li>
      <li class="bulletList">Downloading and uploading streams of data using SignalR.</li>
    </ul>
    <p class="normal">In the next chapter, you will learn about GraphQL, another standard that enables client control over the data returned from a service.</p>
  </div>
</body></html>