<html><head></head><body>
		<div><h1 id="_idParaDest-221"><em class="italic"><a id="_idTextAnchor1389"/>Chapter 12</em>: Understanding Authentication</h1>
			<p>So far, we have built the <strong class="bold">user interface</strong> (<strong class="bold">UI</strong>) and service layer of our e-commerce application. In this chapter, we will learn how to secure it. Our e-commerce application should be able to uniquely identify a user and respond to that user's requests. A commonly used pattern for establishing user identity involves the provision of a username and password. These are then verified against the user's profile data, which is stored in a database or an application. If it matches, a cookie or token with the user's identity is generated and stored in the client's browser so that, for subsequent requests, a cookie/token is sent to the server and validated to service requests.</p>
			<p><strong class="bold">Authentication</strong> is a process in which you identify a user or a program accessing protected<a id="_idIndexMarker1112"/> areas of your application. For instance, in our e-commerce application, a user can navigate through different pages and browse the products that are displayed. However, to place an order or view past orders, users need to provide a username and a password to identify themselves. If the user is new, they should create these to continue.</p>
			<p>In this chapter, we will learn about the features offered by ASP.NET Core related to authentication and understand various methods to implement authentication. In this chapter, we will cover the following topics:</p>
			<ul>
				<li>Understanding the elements of authentication</li>
				<li>Introduction to ASP.NET Core Identity</li>
				<li>Understanding OAuth 2.0</li>
				<li>Introduction to <strong class="bold">Azure Active Directory</strong> (<strong class="bold">Azure AD</strong>)</li>
				<li>Introduction to Windows Authentication</li>
				<li>Understanding best practices to secure client and server applications<a id="_idTextAnchor1390"/><a id="_idTextAnchor1391"/></li>
			</ul>
			<h1 id="_idParaDest-222"><a id="_idTextAnchor1392"/>Technical requirements</h1>
			<p>For this chapter, you need basic knowledge of Azure, <strong class="bold">Entity Framework</strong> (<strong class="bold">EF</strong>), Azure AD B2C, and an active Azure subscription with a contributor role. If you don't have one, you can sign up for a free account at <a href="https://azure.microsoft.com/en-in/free/">https://azure.microsoft.com/en-in/free/</a>. Visual Studio 2022 is used to illustrate a few examples. You can download it from <a href="https://visualstudio.microsoft.com">https://visualstudio.microsoft.com</a>.<a id="_idTextAnchor1393"/><a id="_idTextAnchor1394"/></p>
			<h1 id="_idParaDest-223"><a id="_idTextAnchor1395"/>Understanding the elements of authentication in .NET 6</h1>
			<p>Authentication<a id="_idIndexMarker1113"/> in ASP.NET Core i<a id="_idTextAnchor1396"/>s handled by authentication middleware, which uses registered authentication handlers to perform authentication. Registered authentication handlers and their associated configurations are called <strong class="bold">authentication schemes</strong>.</p>
			<p>The following list describes the core elements of an authentication framework:</p>
			<ul>
				<li><code>Program.cs</code>. They comprise an authentication handler and have options to configure this handler. You can register multiple authentication schemes to authenticate, challenge, and forbid actions. Alternatively, you can specify authentication schemes in the authorization policies that you configure. The following is a sample code to register an <code>OpenIdConnect</code> authentication scheme:<pre>services.AddAuthentication(OpenIdConnectDefaults.AuthenticationScheme)
.AddMicrosoftIdentityWebApp(this.Configuration.GetSection("AzureAdB2C"));</pre></li>
			</ul>
			<p>In the preceding code snippet, the authentication service is registered to use the <code>OpenIdConnect</code> authentication scheme with the Microsoft identity platform. Additionally, the necessary settings specified in the configuration file, in the <code>AzureAdB2C</code> section, are used<a id="_idIndexMarker1116"/> to initialize the <a id="_idIndexMarker1117"/>authentication options.</p>
			<p>More details regarding <code>OpenIdConnect</code> and <code>AzureAdB2C</code> will be covered in the <em class="italic">Introduction to Azure AD</em> se<a id="_idTextAnchor1398"/>ction of this chapter.</p>
			<ul>
				<li><strong class="bold">Authentication handler</strong>: Authenti<a id="_idTextAnchor1399"/>cation handlers<a id="_idIndexMarker1118"/> are responsible for <a id="_idIndexMarker1119"/>authenticating a user. Based on the authentication scheme, they either construct an authentication ticket (usually, this is a token/cookie with the user's identity) or reject a request if authentication is unsuccessful.</li>
				<li><strong class="bold">Authenticate</strong>: This<a id="_idIndexMarker1120"/> m<a id="_idTextAnchor1400"/>ethod is responsible for constructing an <a id="_idIndexMarker1121"/>authentication ticket with the user identity. For example, a cookie authentication scheme constructs a cookie, while a <strong class="bold">JavaScript Object Notation</strong> (<strong class="bold">JSON</strong>) <strong class="bold">Web Token</strong> (<strong class="bold">JWT</strong>) bearer scheme c<a id="_idTextAnchor1401"/>onstructs a token.</li>
				<li><strong class="bold">Challenge</strong>: This<a id="_idIndexMarker1122"/> method<a id="_idTextAnchor1402"/> is invoked by authorization when an<a id="_idIndexMarker1123"/> unauthenticated user requests a resource that requires authentication. Based on the configured scheme, the user is then asked to authenticate.</li>
				<li><strong class="bold">Forbid</strong>: This <a id="_idIndexMarker1124"/>method <a id="_idIndexMarker1125"/><a id="_idTextAnchor1403"/>is invoked by authorization when an authenticated user tries to access a resource to which they are not permitted.</li>
			</ul>
			<p>Now, let's understand how to add authentication using the ASP.NET Core Identi<a id="_idTextAnchor1404"/>ty framework.</p>
			<h1 id="_idParaDest-224">Introdu<a id="_idTextAnchor1405"/>ction to ASP.NET Core Identity</h1>
			<p>ASP.NET Core <a id="_idTextAnchor1406"/>Identity<a id="_idIndexMarker1126"/> is a membership-based system that provides an easy way to add login and user management features to your applicatio<a id="_idTextAnchor1407"/>n. It offers UIs and <strong class="bold">application programming interfaces</strong> (<strong class="bold">APIs</strong>) to create new user accounts, provide email <a id="_idIndexMarker1127"/>confirmation, manage user profile data, manage passwords (such as changing or resetting passwords), perform logins, logouts, and more, and enable <strong class="bold">multi-factor authentication</strong> (<strong class="bold">MFA</strong>). Also, it <a id="_idIndexMarker1128"/>allows you to integrate with extern<a id="_idTextAnchor1408"/>al login providers such as Microsoft Account, Google, Facebook, Twitter, and many other social websites. This is so that users can use their existing accounts to sign up instead of having to create new ones, thus enhancing the user experience.</p>
			<p>By default, ASP.NET Core Identity stores user information such as usernames, passwords, and more in a SQL Server database using an EF Code-First approach. Additionally, it allows you to customize table/column names and capture additional user data such as the user's date of birth, phone number, and more. You can also customize it to save data in a different persistent store such as Azure Table Storage or a NoSQL database. It also provides an API to customize password hashing, password validation, and more.</p>
			<p>In the next section, we will learn how to create a simple web application and configure it to use ASP.NET Core Identity for<a id="_idTextAnchor1409"/><a id="_idTextAnchor1410"/> authentication.</p>
			<h2 id="_idParaDest-225"><a id="_idTextAnchor1411"/>Sample implementation</h2>
			<p>In Visual Studi<a id="_idTextAnchor1412"/>o 2022, create<a id="_idIndexMarker1129"/> a new project, select the <strong class="bold">ASP.NET Core Web Application</strong> template, provide your project details to continue, and change <strong class="bold">Authentication type</strong>. You will find the following list of options to choose from:</p>
			<ul>
				<li><strong class="bold">None</strong>: Choose this if no authentication is required for your application.</li>
				<li><strong class="bold">Individual Accounts</strong>: Choose this if you use a local store or SQL database to manage user identities.</li>
				<li><strong class="bold">Microsoft Identity Platform</strong>: Choose this if you wish to authenticate users against Azure AD or Azure AD B2C.</li>
				<li><strong class="bold">Windows</strong>: Choose this if your application is only available on an intranet.</li>
			</ul>
			<p>For this sample<a id="_idIndexMarker1130"/> implementation, we will use a local store to save user data. Select <strong class="bold">Individual Accounts</strong>, and click on <strong class="bold">Create</strong> to create the project, as illustrated i<a id="_idTextAnchor1413"/>n the fo<a id="_idTextAnchor1414"/>llowing screenshot:</p>
			<div><div><img src="img/Figure_12.1_B18507.jpg" alt="Figure 12.1 – Authentication type&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.1 – Authentication type</p>
			<p>Alternatively, you can use the <code>dotnet</code> <code>SQLite</code> as the database store, as follows:</p>
			<pre>dotnet new webapp --auth Individual -o AuthSample</pre>
			<p>To configure a SQL database as<a id="_idTextAnchor1415"/> a store, run the following command, making sure you apply migrations to create the necessary tables in the database:</p>
			<pre>dotnet new webapp --auth Individual -uld -o AuthSample</pre>
			<p>Now, run the following command to build and run the application:</p>
			<pre>dotnet run --project ./AuthSample/AuthSample.csproj</pre>
			<p>You should see output similar t<a id="_idTextAnchor1416"/>o the following:</p>
			<div><div><img src="img/Figure_12.2_B18507.jpg" alt="Figure 12.2 – The dotnet run command output for reference&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.2 – The dotnet run command output for reference</p>
			<p>In the preceding <a id="_idIndexMarker1131"/>screenshot, notice the logs from the console and the <strong class="bold">Uniform Resource Locators</strong> (<strong class="bold">URLs</strong>) with ports at which the application is accessible.</p>
			<p>Now that your <a id="_idTextAnchor1417"/>application is up and running, open the URL in the browser and click on <strong class="bold">Register</strong>. Provide the required details, and click on the <strong class="bold">Register</strong> button. You might see the following error message<a id="_idTextAnchor1418"/> the first time you try this:</p>
			<div><div><img src="img/Figure_12.3_B18507.jpg" alt="Figure 12.3 – A runtime exception due to missing migrations&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.3 – A runtime exception due to missing migrations</p>
			<p>You can click on <code>Update-Database</code> to apply the migrations and rerun the application. Now, you should be able to register and log in to the application. Next, let's examine a project structure that has been created for us.</p>
			<p>Under <strong class="bold">Dependencies Packages</strong>, you will<a id="_idIndexMarker1132"/> notice <a id="_idTextAnchor1419"/>the following NuGet packages:</p>
			<ul>
				<li><code>Microsoft.AspNetCore.Identity.UI</code>: This is a Razor class library, and it contains the entire identity UI with which you can navigate from a browser—for example, <code>/Identity/Account/Register</code> or <code>/Identity/Account/Login</code>.</li>
				<li><code>Microsoft.AspNetCore.Identity.EntityFrameworkCore</code>: This is used by ASP.NET Core Identity to interact with the database store.</li>
				<li><code>Microsoft.EntityFrameworkCore.SqlServer</code>: This is a library that is used to interact with SQLDB.</li>
			</ul>
			<p>The packages can be seen in the follo<a id="_idTextAnchor1420"/>wing screenshot:</p>
			<div><div><img src="img/Figure_12.4_B18507.jpg" alt="Figure 12.4 – The Solution Explorer view of the AuthSample project&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.4 – The Solution Explorer view of the AuthSample project</p>
			<p>Now, let's examine <a id="_idIndexMarker1133"/>the code of <code>Program.cs</code>.</p>
			<p><a id="_idTextAnchor1421"/>The following code registers the authentication middleware that enables the authentication capability:</p>
			<pre class="source-code">app.UseAuthentication();</pre>
			<p><code>ApplicationDbContext</code> is registered as the dependent service by providing an <code>options</code> configuration with a connection string of <code>sql database</code> that is specified in <code>appsettings.json</code>, as follows:</p>
			<pre class="source-code"> var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");</pre>
			<pre class="source-code">builder.Services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer(connectionString));</pre>
			<pre class="source-code">services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt;</pre>
			<pre class="source-code">options.SignIn.RequireConfirmedAccount = true)</pre>
			<pre class="source-code">.AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();</pre>
			<p>The <code>AddDefaultIdentity</code> method registers services that generate a UI and configures a<a id="_idTextAnchor1422"/> default identity system using <code>IdentityUser</code> as a model. </p>
			<p>ASP.NET Core Identity allows us to configure a number of identity options to meet our needs—for example, the following code allows us to disable email confirmations, configure password requirements, and set lock timeout settings:</p>
			<pre class="source-code">services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt;</pre>
			<pre class="source-code">{</pre>
			<pre class="source-code">  options.SignIn.RequireConfirmedAccount = false;</pre>
			<pre class="source-code">  options.Password.RequireDigit = true;</pre>
			<pre class="source-code">  options.Password.RequireNonAlphanumeric = true;</pre>
			<pre class="source-code">  options.Password.RequireUppercase = true;</pre>
			<pre class="source-code">  options.Password.RequiredLength = 8;</pre>
			<pre class="source-code">  options.Lockout.DefaultLockoutTimeSpan =</pre>
			<pre class="source-code">  TimeSpan.FromMinutes(5);</pre>
			<pre class="source-code">  options.Lockout.MaxFailedAccessAttempts = 5;</pre>
			<pre class="source-code">})</pre>
			<pre class="source-code">.AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();</pre>
			<p>For<a id="_idIndexMarker1134"/> more details, you can refer to <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-6.0">https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-6.0</a>.</p>
			<h2 id="_idParaDest-226"><a id="_idTextAnchor1425"/>Scaffolding</h2>
			<p>To further <a id="_idIndexMarker1135"/>customize the UI and any other settings, you can selectively add source code co<a id="_idTextAnchor1426"/>ntained in the Razor class library. Then, you can modify the generated source code to suit your needs. To scaffold, in Solution Explorer, right-click on <strong class="bold">Project</strong> | <strong class="bold">Add</strong> | <strong class="bold">New Scaffolded Item</strong> | <strong class="bold">Identity</strong> | <strong class="bold">Add</strong>.</p>
			<p>This will open a window where you can select the files that you want to override, as illustrated in the foll<a id="_idTextAnchor1427"/>owing screenshot: </p>
			<div><div><img src="img/Figure_12.5_B18507.jpg" alt="Figure 12.5 – Dialog to override the identity modules&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.5 – Dialog to override the identity modules</p>
			<p>You can select to<a id="_idIndexMarker1136"/> override all files or only choose those files that you want to customize. Choose your data context class and click on <code>Identity</code> folder—both Razor and the corresponding C# files will be added. The following screenshot illustrates the files that have been added bas<a id="_idTextAnchor1428"/>ed on the selection:</p>
			<div><div><img src="img/Figure_12.6_B18507.jpg" alt="Figure 12.6 – The Solution Explorer view of the AuthSample project&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.6 – The Solution Explorer view of the AuthSample project</p>
			<p>For more <a id="_idIndexMarker1137"/>details relating to<a id="_idIndexMarker1138"/><a id="_idTextAnchor1429"/> customizations, you can refer to <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/scaffold-identity?view=aspnetcore-6.0">https://docs.microsoft.com/en-us/aspnet/core/security/authentication/scaffold-identity?view=aspnetcore-6.0</a>.</p>
			<p>Now, let's understand how to integrate an ASP.NET Core application with exter<a id="_idTextAnchor1430"/><a id="_idTextAnchor1431"/>nal login providers.</p>
			<h2 id="_idParaDest-227"><a id="_idTextAnchor1432"/>Integration with external login providers</h2>
			<p>In this section, we will learn how to integrate an ASP.NET Core application to use external login providers, such as<a id="_idIndexMarker1139"/> Microsoft Account, Google, Facebook, Twitter, and more. Additionally, we will look a<a id="_idTextAnchor1433"/>t how to authenticate using an OAuth 2.0 flow so that users can use their existing credentials to sign up and access our application. A common pattern to integrate an ASP.NET Core application with any external login provider is given as follows:</p>
			<ol>
				<li>Acquire credentials (usually, the client ID and secret) to access OAuth APIs for authentication from the respective developer portal.</li>
				<li>Configure the credentials in the application settings or user secrets.</li>
				<li>Next, we need to add the respective NuGet package to the project at <strong class="bold">Add Middleware Support</strong> to use the OpenID and OAuth 2.0 flows.</li>
				<li>In <code>Program.cs</code>, add the <code>AddAuthentication</code> method to register the authentication middleware.</li>
			</ol>
			<h3>Configuring Google</h3>
			<p>To<a id="_idIndexMarker1140"/> configure Google as an external login provider, you<a id="_idIndexMarker1141"/> need to perform the following steps:</p>
			<ol>
				<li value="1">Create OAuth credentials<a id="_idIndexMarker1142"/> at <a href="https://developers.google.com/identity/sign-in/web/sign-in">https://developers.google.com/identity/sign-in/web/sign-in</a>.</li>
				<li>Configure the credentials in the user secrets. You can use the <code>dotnet</code> CLI to add secrets to your project, as follows:<pre>dotnet user-secrets set "Authentication:Google:ClientId" "&lt;client-id&gt;"
dotnet user-secrets set "Authentication:Google:ClientSecret" "&lt;client-secret&gt;"</pre></li>
				<li>Add the <code>Microsoft.AspNetCore.Authentication.Google</code> NuGet package to your project, and add the following code to <code>Program.cs</code>:<pre>services.AddAuthentication()
        .AddGoogle(options =&gt;
        {
            IConfigurationSection googleAuthNSection =
               Configuration.GetSection
              ("Authentication:Google");
            options.ClientId =
             googleAuthNSection["ClientId"];
            options.ClientSecret =
             googleAuthNSection["ClientSecret"];
        });</pre></li>
				<li>Similarly, you <a id="_idIndexMarker1143"/>can add multiple <a id="_idIndexMarker1144"/>providers.</li>
			</ol>
			<p>To learn how to integrate with <a id="_idIndexMarker1145"/>other popular external authentication providers, you can refer to <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/social/?view=aspnetcore-6.0">https://docs.microsoft.com/en-us/aspnet/core/security/authentication/social/?view=aspnetcore-6.0</a>.</p>
			<p>After you have completed the preceding steps, you should be able to use Google credentials to log in to your application. This concludes this section on using ASP.NET Core Identity with external login providers in your application for authentication. In the next sectio<a id="_idTextAnchor1434"/><a id="_idTextAnchor1435"/>n, let's see what OAuth is.</p>
			<h1 id="_idParaDest-228">Understanding OAut<a id="_idTextAnchor1436"/>h 2.0</h1>
			<p>OAuth 2.0 is a<a id="_idIndexMarker1146"/> modern and industry-standard protocol for securing web APIs. It simplifies the process by providing specific authorization flows for web apps, single-page apps, mobile apps, and more to access secured APIs.</p>
			<p>Let's consider a use case where you want to build a web portal in which users can sync and view photos/videos from their favorite applications such as Instagram, Facebook, or other third-party applications. Your application should be able to request data from third-party applications on behalf of the user. One approach involves the storing of a user's credentials in relation to each third-party application, and your application sends or requests data on behalf of the us<a id="_idTextAnchor1437"/>er.</p>
			<p>This approach can lead to many problems. They are outlined as follows:</p>
			<ul>
				<li>You need to design your application to securely store user credentials.</li>
				<li>Users might not be comfortable with their credentials being shared and stored by third-party applications in your application.</li>
				<li>If a user changes their credentials, they need to be updated back in your application.</li>
				<li>In the case of a security breach, fraudsters can gain unrestricted access to a user's data in third-party applications. This can lead to potential revenue and reputation loss.</li>
			</ul>
			<p>OAuth 2.0 <a id="_idIndexMarker1147"/>can handle all of the preceding use cases by addressing all of these concerns. Let's see how it does this, a<a id="_idTextAnchor1438"/>s follows:</p>
			<ol>
				<li value="1">The user logs in to your application. To sync pictures/videos, the user will be redirected to a third-party application, and they will need to sign in with their credentials.</li>
				<li>OAuth 2.0 reviews and approves the app's request to fetch resources.</li>
				<li>The user is redirected back to your application with the authorization code.</li>
				<li>To sync pictures/videos, your application can acquire a token by exchanging the authorization code and then making an API call to a third-party application <a id="_idTextAnchor1439"/>along with the token.</li>
				<li>For each request, the<a id="_idIndexMarker1148"/> third-party application validates the token and responds accordingly.</li>
			</ol>
			<p>In OAuth flows, there are four parties involved: <strong class="bold">Client</strong>, <strong class="bold">Resource Owner</strong>, <strong class="bold">Authorization Server</strong>, and <strong class="bold">Resource Server</strong>. Refer<a id="_idTextAnchor1440"/> to the following screenshot:</p>
			<div><div><img src="img/Figure_12.7_B18507.jpg" alt="Figure 12.7 – An OAuth2 flow&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.7 – An OAuth2 flow</p>
			<p>From the preceding screenshot, we can see the following:</p>
			<ul>
				<li><strong class="bold">Client</strong>: This refers to an application that acquires a token from the authorization <a id="_idIndexMarker1149"/>server and makes requests to the resource server on behalf of the resource owner.</li>
				<li><strong class="bold">Resource Owner</strong>: This is <a id="_idIndexMarker1150"/>an entity that owns resources/data and is capable of granting access to clients.</li>
				<li><strong class="bold">Authorization Server</strong>: This <a id="_idIndexMarker1151"/>authenticates the resource owner and issues tokens to clients.</li>
				<li><strong class="bold">Resource Server</strong>: This is the<a id="_idIndexMarker1152"/> server that hosts resources or data relating to the resource owner, uses a bearer token to validate, and responds to or reje<a id="_idTextAnchor1441"/><a id="_idTextAnchor1442"/>cts requests coming from clients.</li>
			</ul>
			<h2 id="_idParaDest-229"><a id="_idTextAnchor1443"/>Tokens</h2>
			<p>The authorization server<a id="_idIndexMarker1153"/> authenticates the user and provides an ID token, access <a id="_idTextAnchor1444"/>token, and refresh <a id="_idIndexMarker1154"/>token, which are used by native/web applications to access protected services. Let's understand each of them a bit more:</p>
			<ul>
				<li><strong class="bold">Access token</strong>: This is issued<a id="_idIndexMarker1155"/> by the authorization server as part of the OAuth flow, usually in JWT format; a Base64-encoded JSON object containing information <a id="_idIndexMarker1156"/>about the issuer, user, scope, expiry, and more.<a id="_idTextAnchor1445"/></li>
				<li><strong class="bold">Refresh token</strong>: This is<a id="_idIndexMarker1157"/> issued by the authorization server along with the access<a id="_idIndexMarker1158"/> token, which is used by the client application to request a new access token before it ex<a id="_idTextAnchor1446"/>pires.</li>
				<li><strong class="bold">ID tokens</strong>: This is <a id="_idIndexMarker1159"/>issued by the authorization server as part of the <a id="_idIndexMarker1160"/>OpenID Connect flow, which can be used to authenticate the user.<p class="callout-heading">Note</p><p class="callout">OpenID Connect is an authentication protocol built on top of OAuth2. It can be used to verify the identi<a id="_idTextAnchor1447"/><a id="_idTextAnchor1448"/>ty of a user on an authentication server.</p></li>
			</ul>
			<h2 id="_idParaDest-230"><a id="_idTextAnchor1449"/>Authorization grant types</h2>
			<p>OAuth 2.0<a id="_idIndexMarker1161"/> defines a number of ways for a client to acquire tokens to <a id="_idIndexMarker1162"/>access secured resourc<a id="_idTextAnchor1450"/>es—these are<a id="_idIndexMarker1163"/> called <strong class="bold">grants</strong>. It defines five grant types: authorization code flow, implicit flow, on-behalf-of flow, client credentials flow, and device grant flow. They are outline<a id="_idTextAnchor1451"/>d here:</p>
			<ul>
				<li><strong class="bold">Authorization code flow</strong>: This <a id="_idIndexMarker1164"/>flow is suitable for web, mobile, and single-page apps, wher<a id="_idTextAnchor1452"/>e your application needs to get your data from another server. The authorization code flow begins with the client redirecting the user to authenticate at the authorization server. If successful, the user gives their consent to permissions required by the client and is redirected back to the client with the authorization code. </li>
			</ul>
			<p>H<a id="_idTextAnchor1453"/>ere, the client's identity is verified by the configured redirection <strong class="bold">Uniform Resource Identifier</strong> (<strong class="bold">URI</strong>) in the<a id="_idIndexMarker1165"/> authorization server. Next, the client requests the access token by passing the authorization code and, in return, gets the access token, the refresh token, and the expiry date. The client can use the access token to call the web API. Since access tokens are short-lived, before they expire, the client should request a new access token by passing the access token <a id="_idTextAnchor1454"/>and the refresh token.</p>
			<ul>
				<li><strong class="bold">Implicit flow</strong>: This is a <a id="_idIndexMarker1166"/>simplified version of code flow suitable for single-page, JavaScript-based applications. With implicit flow, instead of issuing an authorization code, the authorization server only issues an access token. Here, the client identity is not verified, as there is no need to specify a redirect URL.</li>
				<li><strong class="bold">On-behalf-of flow</strong>: This <a id="_idIndexMarker1167"/>flow is best suited to situations where a cli<a id="_idTextAnchor1455"/>ent invokes a call to a web API (say, A) that, in turn, needs to invoke another API (say, on B). The flow goes like this: the user sends a request along with a token to A; A requests a token for B from the authorization server by providing a token of A and credentials such as the client ID and client secret of A. Once it acquires the token for B, it invokes the<a id="_idTextAnchor1456"/> API on B.</li>
				<li><strong class="bold">Client credentials flow</strong>: This <a id="_idIndexMarker1168"/>flow is used in cases where server-to-server interaction is needed (say, A to B, where A acquires the token to interact with B using its credentials—usually, this is the client ID and the client secret—and then invokes the API with the acquired token). This request runs under t<a id="_idTextAnchor1457"/>he context of A instead of the user. The required permissions should be granted to A to perform the necessary actions.</li>
				<li><strong class="bold">Device grant flow</strong>: This<a id="_idIndexMarker1169"/> flow is used in cases where users need to sign in to devices with no browsers, such as smart TVs, IoT devices, or printers. The user visits a web page on mobile or PC to authenticate and enters the code displayed on the device to acquire the token and refresh the token for the device to connect.</li>
			</ul>
			<p>Now that we understand what OAuth is, in the next section, let's understand what Azure AD is, how to integrate it with our e-commerce appl<a id="_idTextAnchor1458"/><a id="_idTextAnchor1459"/>ication, and how to use it as our identity server.</p>
			<h1 id="_idParaDest-231"><a id="_idTextAnchor1460"/>Introduction to Azure AD</h1>
			<p>Azure AD is <a id="_idIndexMarker1170"/>an <strong class="bold">Identity and Access Management</strong> (<strong class="bold">IAM</strong>) cloud servi<a id="_idTextAnchor1461"/>ce offering from Microsoft. <a id="_idTextAnchor1462"/>It is a single<a id="_idIndexMarker1171"/> identity store for both internal and external users so that you can configure applications to use Azure AD for authentication. You can synchronize on-premises Windows AD to Azure AD; therefore, you can enable a <strong class="bold">single sign-on</strong> (<strong class="bold">SSO</strong>) experience for you<a id="_idTextAnchor1463"/>r users. </p>
			<p>Users can log in using their work or school credentials or personal Microsoft accounts such as <code>Outlook.com</code>, Xbox, and Skype. It also allows you to natively add or delete users, create groups, do a self-service password reset, enable Azure MFA, and much more. </p>
			<p>With <strong class="bold">Azure AD B2C</strong>, you can customize how your users sign up, sign in, and manage their profiles. Additionally, it allows your customers to use their existing social credentials such as Facebook and Google to sign in and acce<a id="_idTextAnchor1464"/>ss your applications and APIs.</p>
			<p>Azure AD is<a id="_idIndexMarker1172"/> compliant with industry-standard protocols such as <strong class="bold">OpenID Connect</strong>, also known as <strong class="bold">OIDC</strong> and <strong class="bold">OAuth 2.0</strong>. OIDC is an identity layer built on top of the <a id="_idIndexMarker1173"/>OAuth 2.0 protocol and is used to authenticate and retrieve a user's profile information. OAuth 2.0 is used for authorization to obtain access to an HTTP service using different flows such as implicit grant flow, on-behalf-of flow, client credentials flow, code flow and device grant flow.</p>
			<p>A typical authentication flow in web apps<a id="_idIndexMarker1174"/> goes like this:</p>
			<ol>
				<li value="1">The user tries to access the secure content of an application (say, <strong class="bold">My Orders</strong>).</li>
				<li>The user is redirected to the Azure AD sign-in page if they are not authenticated.</li>
				<li>Once the user has submitted their credentials, they are validated by Azure AD, which sends a token back to the web app.</li>
				<li>A cookie is saved to the user's browser and displays the user-requested page.</li>
				<li>On subsequent requests, a cookie is sent to th<a id="_idTextAnchor1465"/>e server that is used to validate the user.</li>
			</ol>
			<p><strong class="bold">Azure AD B2C</strong> enables <a id="_idIndexMarker1175"/>your customer to use their preferred social, enterprise, or native identities to access your applications or APIs. It can scale to millions of users and billions of authentications per day.</p>
			<p>Let's try to integrate our e-commerce application with Azure <a id="_idTextAnchor1466"/>AD B2C. At a high level, we need to perform the following steps to integrate it:</p>
			<ol>
				<li value="1">Create an Azure AD B2C tenant.</li>
				<li>Register an application.</li>
				<li>Add identity provide<a id="_idTextAnchor1467"/>rs.</li>
				<li>Create user flows.</li>
				<li>Update the app code to integrate.<p class="callout-heading">Note</p><p class="callout">As a prerequisite, you should have an active Azure subscription with a contributor role. If you don't have one, you can sign up for a <a id="_idTextAnchor1468"/><a id="_idTextAnchor1469"/>free account at <a href="https://azure.microsoft.com/en-in/free/">https://azure.microsoft.com/en-in/free/</a>.</p></li>
			</ol>
			<h2 id="_idParaDest-232">The Azur<a id="_idTextAnchor1470"/>e AD B2C setup</h2>
			<p>Using Azure AD B2C<a id="_idIndexMarker1176"/> as an identity service will allow our e-commerce users to sign up, create their own credentials, or use their existing social credentials such as Facebook or Google. Let's look at the steps that we need to perform to configure Azure AD B2C as an identity service for our e-commerce application, as follows:</p>
			<ol>
				<li value="1">Log in to the Azure portal, making sure you are in t<a id="_idTextAnchor1471"/>he same directory that contains your subscription.</li>
				<li>On the <strong class="bold">Home</strong> page, click on <strong class="bold">Create Resource</strong> and search for <strong class="bold">B2C</strong>. Then, select <strong class="bold">Azure Active Directory B2C</strong> from the list of options.</li>
				<li>Select <strong class="bold">Create a new Azure AD<a id="_idTextAnchor1472"/> B2C Tenant</strong>, as illustrated in the following screenshot:</li>
			</ol>
			<div><div><img src="img/Figure_12.8_B18507.jpg" alt="Figure 12.8 – Azure AD B2C&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.8 – Azure AD B2C</p>
			<ol>
				<li value="4">Provide the required details and click on <strong class="bold">Review + create</strong>. Then, complete the following fields:</li>
			</ol>
			<p><strong class="bold">Organization name</strong>: This is the name of your B2C tenant.</p>
			<p><strong class="bold">Internal domain name</strong>: This is the internal domain name of your tenant.</p>
			<p><strong class="bold">Country/Region</strong>: Select the country or region where your tenant should <a id="_idTextAnchor1473"/>be provisioned.</p>
			<p><strong class="bold">Subscription</strong> and <strong class="bold">Resource Group</strong>: Provide subscription and resource group deta<a id="_idTextAnchor1474"/>ils.</p>
			<p>These fields are shown in the following screenshot:</p>
			<div><div><img src="img/Figure_12.9_B18507.jpg" alt="Figure 12.9 – The New Azure AD B2C Configuration section&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.9 –<a id="_idTextAnchor1475"/> The New Azure AD B2C Configuration section</p>
			<ol>
				<li value="5">Review your<a id="_idIndexMarker1177"/> details and click on <strong class="bold">Create</strong>. The creation of your new tenant might take a few minutes. Once it has been created, you will see a confirmation message in the notification section. In the <strong class="bold">Notifications</strong> popup, click on the tenant name to navigate to the newly cre<a id="_idTextAnchor1476"/>ated tenant, as illustrated in the following screenshot:</li>
			</ol>
			<div><div><img src="img/Figure_12.10_B18507.jpg" alt="Figure 12.10 – Confirmation of the creation of the Azure AD B2C service&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.10 – Confirmation of the creation of the Azure AD B2C service</p>
			<ol>
				<li value="6">In the following<a id="_idIndexMarker1178"/> screenshot, note that <strong class="bold">Subscription status</strong> is given as <strong class="bold">No Subscription</strong>. Additionally, a warning message says that you should <strong class="bold">link a subscription to your tenant</strong>. You can click on the link to fix it, else y<a id="_idTextAnchor1477"/>ou can skip to <em class="italic">Step 9</em> to continue to configure Azure AD:</li>
			</ol>
			<div><div><img src="img/Figure_12.11_B18507.jpg" alt="Figure 12.11 – A warning message showing no subscription has been linked&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.11 – A warning message showing no <a id="_idTextAnchor1478"/>subscription has been linked</p>
			<ol>
				<li value="7">The link will open the same screen that you saw in <em class="italic">Step 3</em>. This time, click on <strong class="bold">Link an existing Azure AD B2C Tenant to my Azure subscription</strong> to<a id="_idTextAnchor1479"/> continue, as illustrated in the following screenshot:</li>
			</ol>
			<div><div><img src="img/Figure_12.12_B18507.jpg" alt="Figure 12.12 – Linking an Azure AD B2C tenant to a subscription&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.12 – Linking an Azure AD B2C tenant to a subscription</p>
			<ol>
				<li value="8">Select your B2C <a id="_idIndexMarker1179"/>tenant subscription from the drop-down list, provide a <strong class="bold">Resource group</strong> value, and click on <strong class="bold">Create</strong> to link the subscription and t<a id="_idTextAnchor1480"/>he tenant, as illustrated in the following screenshot:</li>
			</ol>
			<div><div><img src="img/Figure_12.13_B18507.jpg" alt="Figure 12.13 – Subscription selection&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.13 – Subscription selection</p>
			<ol>
				<li value="9">You can <a id="_idIndexMarker1180"/>navigate to your B2C tenant by selecting the <strong class="bold">Open B2C Tenant</strong> link in the overview section of the B2C tenant to continue with the <a id="_idTextAnchor1481"/>next steps of the configuration, as follows:<ul><li>You need to register your application with the Azure AD B2C tenant to use it as the identity service.</li><li>You need to choose the identity providers that users can use to sign in to your application.</li><li>Choose user flows to define the experience for your users to sign up o<a id="_idTextAnchor1482"/>r sign in, as illustrated in the following screenshot:</li></ul></li>
			</ol>
			<div><div><img src="img/Figure_12.14_B18507.jpg" alt="Figure 12.14 – Three steps to configure Azure AD B2C&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.14 – Three steps to configure Azure AD B2C</p>
			<ol>
				<li value="10">Under <strong class="bold">Manage</strong>, click on <strong class="bold">App Registrations</strong> and provide the necessary details as follows. Then, click<a id="_idIndexMarker1181"/> on <strong class="bold">Register</strong> to create the AD application:</li>
			</ol>
			<p><strong class="bold">Name</strong>: Display the name of your application.</p>
			<p><strong class="bold">Supported account types</strong>: Choose <strong class="bold">Accounts in any identity provider or organizational directory</strong> so that we can allow users to use their existing cred<a id="_idTextAnchor1483"/>entials to sign up or sign in.</p>
			<p><strong class="bold">Redirect URI</strong>: You need to provide the URL of your application to which the user will be redirected after successful authentication. For now, we can leave it blank.</p>
			<p><strong class="bold">Permissions</strong>: Select <strong class="bold">Grant admin consent to openid and offline_access permissions</strong>.</p>
			<p>T<a id="_idTextAnchor1484"/>he fields are illu<a id="_idTextAnchor1485"/><a id="_idTextAnchor1486"/>strated in the following screenshot:</p>
			<div><div><img src="img/Figure_12.15_B18507.jpg" alt="Figure 12.15 – Registering a new Azure AD application&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.15 – Registering a new Azure AD application</p>
			<p class="callout-heading">Note</p>
			<p class="callout">To set up and debug locally, we can configure with <code>localhost</code>. This needs to be replaced with the URL where your app is hosted.</p>
			<ol>
				<li value="11">Now, let's <a id="_idIndexMarker1182"/>choose <strong class="bold">Identity Providers</strong> under <strong class="bold">Mana<a id="_idTextAnchor1487"/>ge</strong> to configure, as follows:</li>
			</ol>
			<p><strong class="bold">Local accounts</strong>: This option allows users to register and sign in to our application in a traditional way—with a username an<a id="_idTextAnchor1488"/>d password. The following screenshot illustrates this:</p>
			<div><div><img src="img/Figure_12.16_B18507.jpg" alt="Figure 12.16 – Selecting an identity provider&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.16 – Selecting an identity provider</p>
			<ol>
				<li value="12">Let's configure <a id="_idIndexMarker1183"/>Google as the identity provider for our application. You can follow the steps outlined at <a href="https://docs.microsoft.com/en-in/azure/active-directory-b2c/identity-provider-google">https://docs.microsoft.com/en-in/azure/active-directory-b2c/identity-provider-google</a> to acquire the client ID and secret. The details you <a id="_idTextAnchor1490"/>need to provide are shown in the following screenshot:</li>
			</ol>
			<div><div><img src="img/Figure_12.17_B18507.jpg" alt="Figure 12.17 – Google: New OAuth client&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure<a id="_idTextAnchor1491"/> 12.17 – Google: New OAuth client</p>
			<p>After you provide the <a id="_idIndexMarker1184"/>required details and select save, the client ID and secre<a id="_idTextAnchor1492"/>t are generated, as shown in the following screenshot:</p>
			<div><div><img src="img/Figure_12.18_B18507.jpg" alt="Figure 12.18 – The Google OAuth client&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.18 – The Google OAuth client</p>
			<ol>
				<li value="13">Once you have<a id="_idIndexMarker1185"/> created <strong class="bold">Auth C<a id="_idTextAnchor1493"/>lient</strong>, click on <strong class="bold">Google</strong> from <strong class="bold">identity providers</strong>, and then provide the <strong class="bold">Client ID</strong> and <strong class="bold">Client secret</strong> values to complete th<a id="_idTextAnchor1494"/>e configuration. Refer to the following screenshot: </li>
			</ol>
			<div><div><img src="img/Figure_12.19_B18507.jpg" alt="Figure 12.19 – The identity provider configuration&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.1<a id="_idTextAnchor1495"/>9 – The identity provider configuration</p>
			<ol>
				<li value="14">Let's configure Facebook as another identity provider for our e-commerce application. You can follow the steps outlined at <a href="https://docs.microsoft.com/en-in/azure/active-directory-b2c/identity-provider-facebook">https://docs.microsoft.com/en-in/azure/active-directory-b2c/identity-provider-facebook</a>.</li>
				<li>Once you have created the <strong class="bold">Client Auth</strong> settings, click on <strong class="bold">Facebook</strong> from <strong class="bold">identity providers</strong>, and<a id="_idTextAnchor1496"/> then provide the <strong class="bold">Client Id</strong> and <strong class="bold">Client Secret</strong> values to complete the configuration. Refer to <em class="italic">Figure 12.19</em> for an overview of this.</li>
				<li>Now, let's configure the user flow. The user flow allows you to configure and customize the authentication experience for your users. You can configure multiple flows in your tenant and use them in your application. User flows allow you to add MFA and also customize the information that you capture from a user at the time of registration—for example, their given name, country, postal code, and, optionally, whether you want to add them to claims. You can also customize the UI for a better user experience. To create a flow, click on <strong class="bold">User Flows</strong> under <strong class="bold">Policies</strong> and choose a f<a id="_idTextAnchor1497"/>low type, as illustrated in the following screenshot:<div><img src="img/Figure_12.20_B18507.jpg" alt="Figure 12.20 – A new user flow&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption"><a id="_idTextAnchor1498"/></p>
			<p class="figure-caption">Figure 12.20 – A new user flow</p>
			<ol>
				<li value="17">Provide the <a id="_idIndexMarker1186"/>necessary details, and click on <strong class="bold">Create</strong> to save:</li>
			</ol>
			<p><strong class="bold">Name</strong>: This is the name of your flow to uniquely identify.</p>
			<p><strong class="bold">Identity providers</strong>: Select your identity providers.</p>
			<p>Optionally, you can choose additional user attributes such as <strong class="bold">Name</strong>, <strong class="bold">Postal Code</strong>, and<a id="_idTextAnchor1499"/> more, as illustrated in the following screenshot:</p>
			<p class="figure-caption">  </p>
			<div><div><img src="img/Figure_12.21_B18507.jpg" alt="Figure 12.21 – The user flow configuration&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figu<a id="_idTextAnchor1500"/>re 12.21 – The user flow configuration</p>
			<p>You can choose<a id="_idIndexMarker1187"/> additional attributes in the <strong class="bold">User attributes and token cl<a id="_idTextAnchor1501"/>aims</strong> section, as shown in the following screenshot:  </p>
			<div><div><img src="img/Figure_12.22_B18507.jpg" alt="Figure 12.22 – The additional attribute and claim configuration&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.22 – The additional attribute and claim configuration</p>
			<ol>
				<li value="18">Similarly, we should also set up a password reset policy. This is required for local accounts. To create one, under <strong class="bold">Create User Flow</strong>, choose <strong class="bold">Password Reset</strong> and provide the necessary detail<a id="_idTextAnchor1502"/>s. You can refer to <em class="italic">Figure 12.20</em>.</li>
				<li>Having<a id="_idIndexMarker1188"/> completed the minimum required setup of Azure AD B2C, we are ready to test the flow. Select the user flow that was created and click on <strong class="bold">Run user flow</strong>. You can view the sign-up and sign-in pages that were created for<a id="_idTextAnchor1503"/> you, which you can find in the following screenshot:</li>
			</ol>
			<div><div><img src="img/Figure_12.23_B18507.jpg" alt="Figure 12.23 – The sign-in and sign-up screens&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.23 – The<a id="_idTextAnchor1504"/> sign-in and sign-up screens</p>
			<p>Let's look at the changes that we need to <a id="_idTextAnchor1505"/><a id="_idTextAnchor1506"/>do in <code>Packt.Ecommerce.Web</code> to integrate with Azure AD.</p>
			<h2 id="_idParaDest-233">Integrating our e-commerce application<a id="_idTextAnchor1507"/> with Azure AD B2C</h2>
			<p>We <a id="_idIndexMarker1189"/>will configure authentication <a id="_idIndexMarker1190"/>on the web application to use Azure AD B2C. Let's make the necessary changes to our application to integrate with the B2C tenant, as follows:</p>
			<ol>
				<li value="1">Add the following two NuGet packages to our <code>Packt.Ecommerce.Web</code> project:</li>
			</ol>
			<p><code>Microsoft.Identity.Web</code>: This is the main package required to integrate with Azure AD.</p>
			<p><code>Microsoft.Identity.Web.UI</code>: This package generates the UI for signing in and signing out. <a id="_idTextAnchor1508"/>In <code>Program.cs</code>, we need to add an authentication service using the <code>OpenIdConnect</code> scheme along with the <code>Azure AD B2C</code> configuration, as follows:</p>
			<pre>services.AddAuthentication(OpenIdConnectDefaults.AuthenticationScheme).AddMicrosoftIdentityWebApp(Configuration.GetSection("AzureAdB2C"));
services.AddRazorPages().AddMicrosoftIdentityUI();</pre>
			<ol>
				<li value="2">Under the <code>Configure</code> method, add the following code before the <code>app.UseAuthorization()</code> method:<pre>app.UseAuthentication();</pre></li>
				<li>We need to add <code>AzureAdB2C</code> to <code>appsettings.json</code>, as follows:</li>
			</ol>
			<p><code>Instance</code>: <code>https://&lt;domain&gt;.b2clogin.com/tfp</code>. Replace <code>&lt;domain&gt;</code> with the name you have chosen while creating the B2C tenant.</p>
			<p><code>ClientId</code>: This is the AD application ID that you created while setting up Azure AD B2C.</p>
			<p><code>Domain</code>: <code>&lt;domain&gt;.onmicrosoft.com</code>. Here, replace <code>&lt;domain&gt;</code> with the domain name you chose while creating the B2C tenant.</p>
			<p>Update <code>SignUpSignInPolicyId</code> and <code>ResetPasswordPolicyId</code>, as follows:</p>
			<pre>"AzureAdB2C": {
    "Instance": 
    "https://packtecommerce.b2clogin.com/tfp/",
    "ClientId": "1ae40a96-60d7-4641-bb81-
      bc3a47aad36d",
    "Domain": "packtecommerce.onmicrosoft.com",
    "SignedOutCallbackPath": "/signout/B2C_1_susi",
    "SignUpSignInPolicyId": "B2C_1_packt_commerce",
    "ResetPasswordPolicyId": "B2C_1_password_reset",
    "EditProfilePolicyId": "",
    "CallbackPath": "/signin-oidc"
  }</pre>
			<ol>
				<li value="4">You can <a id="_idIndexMarker1191"/>add an <code>[Authorize]</code> attribute<a id="_idIndexMarker1192"/> to controllers or action methods—for instance, you can add it to <code>OrdersController</code> in <code>OrdersController.cs</code> to force users to authenticate themselves to access the<a id="_idTextAnchor1509"/> <code>Orders</code> information.</li>
				<li>The last step is to update the reply URI. To do so, navigate to <strong class="bold">AD Application</strong> in your tenant. Navigate to the <strong class="bold">Authentication</strong> section under <strong class="bold">Manage</strong>, update <strong class="bold">Reply URI</strong>, and set implicit grant permissions.</li>
			</ol>
			<p>The reply URI is the URL of your application to which users will be redirected after successful authentication. To set up an application and debug them locally, we can configure the localhost URL, but once you deploy the application to a server, you will need to update the URL of the server.</p>
			<p>Under <strong class="bold">Implicit grant</strong>, select <strong class="bold">Access tokens</strong> and <strong class="bold">ID tokens</strong>, which are required for our ASP.NET Core <a id="_idTextAnchor1510"/>application, as illustrated in the following screenshot:</p>
			<div><div><img src="img/Figure_12.24_B18507.jpg" alt="Figure 12.24 – The reply URL configuration&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.24 – The reply URL configuration</p>
			<p>Now, run<a id="_idIndexMarker1193"/> your application <a id="_idIndexMarker1194"/>and try accessing the <strong class="bold">Orders</strong> page. You will be redirected to the sign-in and sign-up pages, as shown in <em class="italic">Figure 12.23</em>. This concludes the integration of our e-c<a id="_idTextAnchor1511"/>ommerce application with Azure AD B2C.</p>
			<p>Azure AD offers<a id="_idIndexMarker1195"/> many more options and customizations to suit your needs. For more details, you can look at <a href="https://docs.microsoft.com/en-in/azure/active-directory-b2c">https://docs.microsoft.com/en-in/azure/active-directory-b2c</a>.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">You can use <a id="_idIndexMarker1196"/>Duende Identity Server to set up your own identity server. This uses OpenID Connect and the OAuth 2.0 framework to establish identity. It is available via NuGet and can be easily integrated with ASP.NET Core applications. For more details, you can refer to <a href="https://docs.duendesoftware.com/identityserver/v6">https://docs.duendesoftware.com/identityserver/v6</a>.</p>
			<p>In th<a id="_idTextAnchor1512"/><a id="_idTextAnchor1513"/>e next section, let's see how to use Windows Authentication.</p>
			<h1 id="_idParaDest-234">Introductio<a id="_idTextAnchor1514"/>n to Windows Authentication</h1>
			<p>ASP.NET Core applications can be<a id="_idIndexMarker1197"/> configured to use Windows Authentication, whereby users are authenticated against their Windows credentials. Windows Authentication is the best choice when your application is hosted on a Windows server and your application is only available on the intranet. In this section, we will learn how to use Windows Authentication in an ASP.NET Core application.</p>
			<p>In Visual Studio, choose <code>--auth Windows</code> parameters to create a new web app using Windows Authentication, as follows:</p>
			<pre>dotnet new webapp --auth Windows -o WinAuthSample</pre>
			<p>If you open <code>launchSettings.json</code>, you will notice that <code>WindowsAuthentication</code> is set to <code>true</code> and <code>anonymousAuthentication</code> is set to <code>false</code>,<a id="_idTextAnchor1515"/> as illustrated in the following code snippet. This setting is only applicable when running an application in <strong class="bold">Internet Information Services Express</strong> (<strong class="bold">IIS Express</strong>):</p>
			<pre class="source-code">"iisSettings": {</pre>
			<pre class="source-code">    "windowsAuthentication": <strong class="bold">true</strong>,</pre>
			<pre class="source-code">    "anonymousAuthentication": <strong class="bold">false</strong>,</pre>
			<pre class="source-code">    "iisExpress": {</pre>
			<pre class="source-code">      "applicationUrl": "http://localhost:21368",</pre>
			<pre class="source-code">      "sslPort": 44384</pre>
			<pre class="source-code">    }</pre>
			<pre class="source-code">  }</pre>
			<p>When you host an application on IIS, you need to configure <code>WindowsAuthentication</code> to <code>true</code> in <code>web.config</code>. By default, <code>web.config</code> is not added to the .NET Core web application, so you need to add it and make the necessary changes, as depicted in the following code snippet:</p>
			<pre class="source-code">&lt;location path="." inheritInChildApplications="false"&gt;</pre>
			<pre class="source-code">    &lt;system.webServer&gt;</pre>
			<pre class="source-code">      &lt;security&gt;</pre>
			<pre class="source-code">        &lt;authentication&gt;</pre>
			<pre class="source-code">          &lt;anonymousAuthentication enabled="false"/&gt;</pre>
			<pre class="source-code">          &lt;windowsAuthentication enabled="true"/&gt;</pre>
			<pre class="source-code">        &lt;/authentication&gt;</pre>
			<pre class="source-code">      &lt;/security&gt;</pre>
			<pre class="source-code">    &lt;/system.webServer&gt;</pre>
			<pre class="source-code">&lt;/location&gt;</pre>
			<p>The preceding<a id="_idIndexMarker1198"/> configuration makes every endpoint secure. There will be no impact, even if we set <code>AllowAnonymous</code> on every controller or action. If you want to make any endpoint anonymously accessible, you need to set <code>ano<a id="_idTextAnchor1516"/>nymousAuthentication</code> to <code>true</code> and set <code>Authorize</code> on the endpoints that you want to make secure. In addition to that, you need to register the authentication service with the scheme as <code>Windows</code>, as follows:</p>
			<pre class="source-code">services.AddAuthentication(IISDefaults.AuthenticationScheme)</pre>
			<p>This is all you need to do to enable <a id="_idIndexMarker1199"/>Windows Authentication in your application. For more details, you can refer to <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/windowsauth?view=aspnetcore-6.0">https://docs.microsoft.com/en-us/aspnet/core/security/authentication/windowsauth?view=aspnetcore-6.0</a>.</p>
			<p>In the next section, we will look at a few best pra<a id="_idTextAnchor1517"/><a id="_idTextAnchor1518"/>ctices to be followed to secure client and server applications.</p>
			<h1 id="_idParaDest-235">Understanding best pract<a id="_idTextAnchor1519"/>ices to secure client and server applications</h1>
			<p>There are several<a id="_idIndexMarker1200"/> best practices that are recommended to secure your web application. The .NET Core and Azure services make it easy to ensure their adoption. The following are key ones you could consider:</p>
			<ul>
				<li>Enforce HTTPS for web applications. Use <code>UseHttpsRedirection</code> middleware to redirect requests from HTTP to HTTPS.</li>
				<li>Use modern authentication frameworks based on OAuth 2.0 and OIDC to secure your web or API app.</li>
				<li>If you are using the Microsoft identity platform, use open source libraries such as MSAL.js and MSAL.NET to acquire or renew tokens.</li>
				<li>Configure strong password requirements and lock your account in the case of continuous failed login attempts—for example, five consecutive failed attempts. This can prevent a brute-force attack.</li>
				<li>Enable MFA for privileged accounts such as back-office admin, back-office staff accounts, and more.</li>
				<li>Configure session timeouts, invalidate your session on logout, and clear cookies.</li>
				<li>Enforce authorization on all secured endpoints and on the client side.</li>
				<li>Store keys/passwords in a secured location such as key vaults.</li>
				<li>If you are using Azure AD, register each logical/environment-specific application separately.</li>
				<li>Do not store sensitive information in plain text.</li>
				<li>Ensure proper exception handling.</li>
				<li>Perform a security/malware scan on files that are uploaded.</li>
				<li>Prevent cross-site scripting attacks—always HTML-encode user input data.</li>
				<li>Prevent SQL injection attacks by parameterizing SQL queries and using stored procedures.</li>
				<li>Prevent cross-site request forgery attacks—use a <code>ValidateAntiForgeryToken</code> filter on an action, a controller<a id="_idTextAnchor1520"/>, or globally.</li>
				<li>Enforce <strong class="bold">Cross-Origin Request<a id="_idTextAnchor1521"/>s</strong> (<strong class="bold">CORS</strong>) in middleware <a id="_idIndexMarker1201"/>using <a id="_idIndexMarker1202"/>this policy.</li>
			</ul>
			<p>While the provided best practices and guidance are good to start with, you need to always consider an application's context and continuously assess and enhance<a id="_idTextAnchor1522"/><a id="_idTextAnchor1523"/> your application to address security vulnerabilities and threats.</p>
			<h1 id="_idParaDest-236"><a id="_idTextAnchor1524"/>Summary</h1>
			<p>In this chapter, we understood what authentication is and the key elements of authentication in ASP.NET Core. We explored the different options offered by the ASP.NET Core framework and learned how ASP.NET Core Identity helps to quickly add authentication to your application. We discussed OAuth 2.0 and grant flows and understood how they make things easier when you need to authenticate and connect to multiple API services. </p>
			<p>Also, we looked at configuring Azure AD as your identity service, using external authentication providers such as Google or Facebook in your application, and using Windows Authentication in an ASP.NET Core application. We concluded this chapter by discussing a few best practices to follow while developing server-side and client-side applications.</p>
			<p>In the next chapter, we will see what auth<a id="_idTextAnchor1525"/><a id="_idTextAnchor1526"/>orization is and how it helps to control access to your resources.</p>
			<h1 id="_idParaDest-237"><a id="_idTextAnchor1527"/>Questions</h1>
			<ol>
				<li value="1">What information can be derived from a JWT?</li>
			</ol>
			<p>a. Issuer</p>
			<p>b. Expiry</p>
			<p>c. Scopes</p>
			<p>d. Subject</p>
			<p>e. All of the above</p>
			<p><strong class="bold">Answer: e</strong></p>
			<ol>
				<li value="2">What are the recommended OAuth grant flows for single-page apps?</li>
			</ol>
			<p>a. Client credentials flow</p>
			<p>b. Implicit flow</p>
			<p>c. Code grant flow</p>
			<p>d. On-behalf-of flow</p>
			<p><strong class="bold">Answer: b and c</strong></p>
			<ol>
				<li value="3">What are the minimum required NuGet packages to integrate with Azure AD?</li>
			</ol>
			<p>a. <code>Microsoft.AspNetCore.Identity</code></p>
			<p>b. <code>Microsoft.Identity.Web.UI</code></p>
			<p>c. <code>Mic<a id="_idTextAnchor1528"/><a id="_idTextAnchor1529"/>rosoft.AspNetCore.Identity.UI</code></p>
			<p>d. <code>Microsoft.Identity.Web</code></p>
			<p><strong class="bold">Answer: d</strong></p>
			<h1 id="_idParaDest-238"><a id="_idTextAnchor1530"/>Further reading</h1>
			<p>To learn more about authentication, you can refer to the following resources:</p>
			<ul>
				<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/?view=aspnetcore-6.0">https://docs.microsoft.com/en-us/aspnet/core/security/authentication/?view=aspnetcore-6.0</a></li>
				<li><a href="https://docs.microsoft.com/en-in/azure/active-directory-b2c">https://docs.microsoft.com/en-in/azure/active-directory-b2c</a></li>
			</ul>
		</div>
	</body></html>