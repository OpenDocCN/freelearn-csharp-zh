<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Bridges</h1></div></div></div><p>In <a class="link" href="ch02.html" title="Chapter 2. Messages and Transforms">Chapter 2</a>, <em>Messages and Transforms</em>, we covered a fundamental aspect of integration and transformation. But transformation is just one of the capabilities that bridges in BizTalk Services provide. In this chapter, we will take a closer look at bridges and the following features:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Pipeline stages</li><li class="listitem" style="list-style-type: disc">Validating, enriching, and formatting messages</li><li class="listitem" style="list-style-type: disc">Lookup data</li><li class="listitem" style="list-style-type: disc">Message routing and filters</li><li class="listitem" style="list-style-type: disc">BizTalk Services Explorer</li></ul></div><p>A <strong>bridge</strong><a id="id140" class="indexterm"/> is actually a<a id="id141" class="indexterm"/> <strong>Windows Workflow Foundation</strong> (<strong>WF4</strong>) behind the scenes. While you cannot create your own bridge definitions, three templates are provided for you:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Type</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p><strong>XML One-Way</strong></p>
</td><td style="text-align: left" valign="top">
<p>Caller <a id="id142" class="indexterm"/>sends<a id="id143" class="indexterm"/> XML-based messages to the bridge and expects no response</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><strong>XML Request-Reply</strong></p>
</td><td style="text-align: left" valign="top">
<p>Caller<a id="id144" class="indexterm"/> sends XML-based messages<a id="id145" class="indexterm"/> and waits for response message</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p><strong>Pass-Through</strong></p>
</td><td style="text-align: left" valign="top">
<p>Caller<a id="id146" class="indexterm"/> sends message in any format<a id="id147" class="indexterm"/> (XML or non-XML) in a one-way pattern</p>
</td></tr></tbody></table></div><p>These templates provide some standard processing steps that you can use to act on or affect messages as they are processed. These steps form a pipeline of processing, with each step following the previous one sequentially. Each step also acts on the state of the message and its context from the previous step as well. There are also opportunities for you to add your own custom pipeline processing as we'll see later in this chapter.</p><p>It is worth remembering that bridges are inherently stateless—there is nothing durably persisted during bridge processing. If a bridge fails during processing, the message could be lost, and so care must be taken to avoid this situation. We'll come back to this in much more detail later in this book in <a class="link" href="ch07.html" title="Chapter 7. Tracking and Troubleshooting">Chapter 7</a>, <em>Tracking and Troubleshooting</em>.</p><div><div><div><div><h1 class="title"><a id="ch03lvl1sec32"/>Pipeline processing</h1></div></div></div><p>Within a bridge's pipeline, there are the following steps:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Stage</p>
</th><th style="text-align: left" valign="bottom">
<p>Direction</p>
</th><th style="text-align: left" valign="bottom">
<p>Purpose</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Message Type</p>
</td><td style="text-align: left" valign="top">
<p>Receive</p>
</td><td style="text-align: left" valign="top">
<p>Match schema to incoming message</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Decode</p>
</td><td style="text-align: left" valign="top">
<p>Receive</p>
</td><td style="text-align: left" valign="top">
<p>Convert incoming message to XML based on schema</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Validate</p>
</td><td style="text-align: left" valign="top">
<p>Receive</p>
</td><td style="text-align: left" valign="top">
<p>Determine if message is valid according to the schema</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Enrich</p>
</td><td style="text-align: left" valign="top">
<p>Receive</p>
</td><td style="text-align: left" valign="top">
<p>Create properties from message or context content</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Transform</p>
</td><td style="text-align: left" valign="top">
<p>Receive/Send</p>
</td><td style="text-align: left" valign="top">
<p>Map the message to another message schema format</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Enrich</p>
</td><td style="text-align: left" valign="top">
<p>Send</p>
</td><td style="text-align: left" valign="top">
<p>Create properties from the message or context content</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Encode</p>
</td><td style="text-align: left" valign="top">
<p>Send</p>
</td><td style="text-align: left" valign="top">
<p>Get the message ready for transmission</p>
</td></tr></tbody></table></div><p>Of course, for two-way and pass-through bridges, things are a little different, as you would expect. For two-way bridges, there are no Decode and Encode stages, and pass-through bridges only have a single stage, Enrich.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec33"/>Message processing</h1></div></div></div><p>As<a id="id148" class="indexterm"/> BizTalk Services hosted<a id="id149" class="indexterm"/> in the cloud exposes default HTTP endpoints to the bridges that you publish, this means that it is possible to submit messages to a bridge by simply posting them to the endpoint and, with the request/reply bridge, receive a response.</p><p>Of course, BizTalk Services provides many more message sources and destinations such as FTP, Service Bus queues and topics, and also line of business systems such as SAP that are covered in detail in <a class="link" href="ch04.html" title="Chapter 4. Enterprise Application Integration">Chapter 4</a>, <em>Enterprise Application Integration</em>. The full list is provided<a id="id150" class="indexterm"/> in<a id="id151" class="indexterm"/> the following table:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Transport</p>
</th><th style="text-align: left" valign="bottom">
<p>Source</p>
</th><th style="text-align: left" valign="bottom">
<p>Destination</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>FTP</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>File Transfer Protocol support</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>SFTP</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Secure File Transfer Protocol</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Service Bus Queue</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Receive and send messages to/from queues</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Service Bus Topic</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Receive and send messages to/from topics</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>HTTP(S)</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Bridges are exposed as HTTPS endpoints by default on the namespace you create the service under. BizTalk Services also supports HTTP as a destination by allowing the calling of web services.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Azure Blob Storage</p>
</td><td style="text-align: left" valign="top">
<p>No</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>Send a message to Azure Blob Storage</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Relay</p>
</td><td style="text-align: left" valign="top">
<p>No</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>The Service Bus relay is used with BizTalk Adapter Services to connect to the following line of business systems:</p>
<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">SQL Server</li><li class="listitem" style="list-style-type: disc">Oracle DB</li><li class="listitem" style="list-style-type: disc">Oracle eBusiness Suite</li><li class="listitem" style="list-style-type: disc">mySAP</li><li class="listitem" style="list-style-type: disc">Siebel</li></ul></div>
<p>This is covered in detail in <a class="link" href="ch04.html" title="Chapter 4. Enterprise Application Integration">Chapter 4</a>, <em>Enterprise Application Integration</em>.</p>
</td></tr></tbody></table></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec34"/>Messaging</h1></div></div></div><p>With <a id="id152" class="indexterm"/>XML<a id="id153" class="indexterm"/> bridges, there are two stages that are used to identify received messages and determine what to do with those that are not expected. In order to know what's not expected, the Message Types section of the bridge allows the specification of message schemas. Any number of schemas can be configured under the <strong>Message Type Picker</strong> dialog box as shown in the following screenshot:</p><div><img src="img/7401EN_03_01.jpg" alt="Messaging"/><div><p>Message Types</p></div></div><p>The first stage in an XML bridge is Decode. This is only applicable for flat files, that is, messages that are not received as XML and have a flat file schema specified (more on flat file schemas in <a class="link" href="ch04.html" title="Chapter 4. Enterprise Application Integration">Chapter 4</a>, <em>Enterprise Application Integration</em>). While processing flat files in an XML bridge may sound strange, the purpose of the bridge is to normalize the message into an XML format as this is what allows uniformity of processing useful features such as transformation and enrichment. In this way, data in any format, for example<a id="id154" class="indexterm"/> JSON, can be received and processed. There is nothing to<a id="id155" class="indexterm"/> configure in the Decode stage; instead, it takes its configuration from the provided message types and applies the matching flat file schema to create an XML representation of the file. The match is made based on the schemas selected in the <strong>Message Type Picker</strong> dialog box as shown in the preceding figure. Only one message type can be chosen.</p><p>After the Decode stage, the message is validated against the schemas provided. The only configurable property here is the Boolean setting <strong>Report Warnings As Errors</strong>. This defaults to <code class="literal">false,</code> meaning that unrecognized or invalid messages are still processed through the rest of the bridge. Setting this property to <code class="literal">true</code> will throw an error in the bridge and the message will not be processed. The caller (if the caller is using HTTP) will receive an <strong>HTTP 500</strong> status code response. This general "Server Error" response is generally returned with a response detailing the problem and providing a tracking ID that can be used to diagnose the cause. Fault diagnosis and troubleshooting is covered in more detail in <a class="link" href="ch07.html" title="Chapter 7. Tracking and Troubleshooting">Chapter 7</a>, <em>Tracking and Troubleshooting</em>. If FTP is the configured source, then the file is left on the FTP server and the bridge will be retried up to three times after waiting a number of minutes (which extends over the number of retries). This behavior is not <a id="id156" class="indexterm"/>currently<a id="id157" class="indexterm"/> configurable in WABS.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec35"/>Enrichment</h1></div></div></div><p>Enrichment<a id="id158" class="indexterm"/> occurs at two points in the bridge: pre and post transformation. The <a id="id159" class="indexterm"/>enrichment stages provide the opportunity to write to message properties that can be used in either transformation (in the first Enrich stage) or in routing (post transformation). Message properties are simply name/value pairs that are moved through the bridge with the message itself and can be created in the Enrich stages.</p><p>There are several sources of data available when writing to a message property, and these are listed in the following table:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Source type</p>
</th><th style="text-align: left" valign="bottom">
<p>Purpose</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Soap</p>
</td><td style="text-align: left" valign="top">
<p>Access SOAP properties of the message such as the Action</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Http</p>
</td><td style="text-align: left" valign="top">
<p>Access HTTP headers sent by the caller</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Lookup</p>
</td><td style="text-align: left" valign="top">
<p>Look up a value in a Windows Azure SQL database</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Xpath</p>
</td><td style="text-align: left" valign="top">
<p>Look up a value using an XPath expression in the message</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Ftp</p>
</td><td style="text-align: left" valign="top">
<p>Access FTP properties such as filename if source is FTP</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Sftp</p>
</td><td style="text-align: left" valign="top">
<p>Access SFTP properties if source is SFTP</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>System</p>
</td><td style="text-align: left" valign="top">
<p>Provides access to the system properties such as the date/time a message was received</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Brokered</p>
</td><td style="text-align: left" valign="top">
<p>Access Service Bus properties if source or destination is queue/topic based</p>
</td></tr></tbody></table></div><p>Using message properties allows bridge processing to be influenced and controlled in two primary ways:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Through transformation</strong>: The message received from the caller can be transformed into a different format that is required by the final receiver. Message properties can be accessed.</li><li class="listitem" style="list-style-type: disc"><strong>Through routing</strong>: We'll look at this in detail in a moment. Message properties can be used to direct a message to a particular destination.</li></ul></div><p>Let's look at a couple of examples. In the following figure, we have a bridge with two destination Service Bus queues configured, <strong>Europe</strong> and <strong>Americas</strong>. Assume that we would like to create a property that holds the value of a field in the incoming message that contains the name of the country the message is from. The routing bridge pattern is shown in the following screenshot:</p><div><img src="img/7401EN_03_02.jpg" alt="Enrichment"/><div><p>Routing bridge pattern</p></div></div><p>The<a id="id160" class="indexterm"/> incoming<a id="id161" class="indexterm"/> message looks like the following XML:</p><div><pre class="programlisting">&lt;ns0:Order &gt;
  &lt;OrderId&gt;123&lt;/OrderId&gt;
  &lt;PaymentType&gt;ACCOUNT&lt;/PaymentType&gt;
  &lt;OrderDate&gt;2/9/2013&lt;/OrderDate&gt;
  &lt;Products&gt;
    &lt;Product&gt;
      &lt;Code&gt;AB12&lt;/Code&gt;
      &lt;Qty&gt;4&lt;/Qty&gt;
      &lt;Price&gt;1.50&lt;/Price&gt;
    &lt;/Product&gt;
    &lt;Product&gt;
      &lt;Code&gt;AC01&lt;/Code&gt;
      &lt;Qty&gt;2&lt;/Qty&gt;
      &lt;Price&gt;3.99&lt;/Price&gt;
    &lt;/Product&gt;
    &lt;Product&gt;
      &lt;Code&gt;DE4&lt;/Code&gt;
      &lt;Qty&gt;10&lt;/Qty&gt;
      &lt;Price&gt;12.25&lt;/Price&gt;
    &lt;/Product&gt;
  &lt;/Products&gt;
  &lt;Customer&gt;
    &lt;Name&gt;John Doe&lt;/Name&gt;
    &lt;Email&gt;john.doe@contoso.com&lt;/Email&gt;
    &lt;Phone&gt;425-123456&lt;/Phone&gt;
  &lt;/Customer&gt;
  &lt;ShippingAddress&gt;
    &lt;Recipient&gt;Jane Smith&lt;/Recipient&gt;
    &lt;Number&gt;1&lt;/Number&gt;
    &lt;Street&gt;East Street&lt;/Street&gt;
    &lt;City&gt;New York&lt;/City&gt;
    &lt;State&gt;New York&lt;/State&gt;
    &lt;Country&gt;UK&lt;/Country&gt;
    &lt;Postcode&gt;NY12345&lt;/Postcode&gt;
  &lt;/ShippingAddress&gt;
&lt;/ns0:Order&gt;</pre></div><p>We can <a id="id162" class="indexterm"/>create <a id="id163" class="indexterm"/>an XPath property against this message as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Click on the first Enrich stage in the designer.</li><li class="listitem">In the <strong>Properties</strong> window, double-click on the <strong>Property Definitions</strong> collection ellipsis.</li><li class="listitem">In the <strong>Property Definitions</strong> dialog box, click on <strong>Add</strong>.</li><li class="listitem">Select a type of XPath.</li><li class="listitem">Enter the following expression in the <strong>Identifier</strong> field:<div><pre class="programlisting">/*[local-name()='Order' and namespace-uri()='http://BizTalkServicesOrderSample.Order']/*[local-name()='ShippingAddress' and namespace-uri()='']/*[local-name()='Country' and namespace-uri()='']</pre></div><div><div><h3 class="title"><a id="tip03"/>Tip</h3><p>To easily get the XPath of an item from an XML schema, open the <code class="literal">.xsd</code> file in the Schema editor, select the item you want, and then look in the <strong>Properties</strong> window. The <strong>Instance XPath</strong> property will contain the XPath expression required to extract it at runtime.</p></div></div></li><li class="listitem">Specify the message type of the <code class="literal">Order</code> instance.</li><li class="listitem">Enter <code class="literal">MappedCountry</code> in the <strong>Property Name</strong> field.</li><li class="listitem">Select <strong>string</strong> for the <strong>Data Type</strong> field.</li><li class="listitem">Click on <strong>OK</strong>.</li></ol></div><p>The <strong>Property Definitions</strong> dialog box should now look like the following screenshot. At runtime, when messages are received by the bridge, the Enrich stage will extract the field from the message using the specified XPath and store the country value in the message property.</p><div><img src="img/7401EN_03_03.jpg" alt="Enrichment"/><div><p>Property Definitions</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec36"/>Lookups</h1></div></div></div><p>Another <a id="id164" class="indexterm"/>usage of message properties is with transformation. Here, a common<a id="id165" class="indexterm"/> requirement is transcoding, where one value needs to be replaced with or mapped to another value. Code tables can be used for this purpose, and we can use the lookup capabilities of BizTalk Services to do this and then feed the values into a transform to replace the value in the message.</p><p>Some preparation is needed to set things up. If you recall, when you provision a new Windows Azure BizTalk Services instance, you can choose to create a new SQL Azure database to hold the various tables needed by the service. We can also create a table in this database to hold the transcoding data for the lookups. To create a table and add data to it, run the following script against the database:</p><div><pre class="programlisting">CREATE TABLE [dbo].[CountryMap](
  [CountryName] [nvarchar](100),
  [ISOCountry] [int] NULL
  CONSTRAINT [PK_CountryName] PRIMARY KEY CLUSTERED
  (
    [CountryName] ASC
  ) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
)
GO
INSERT INTO [dbo].[CountryMap] (CountryName, ISOCountry)VALUES('USA',844),('UK',826),('CANADA',124)</pre></div><p>The easiest <a id="id166" class="indexterm"/>way to do this is to go to the Azure Management Portal at <a class="ulink" href="http://manage.windowsazure.com">http://manage.windowsazure.com</a> and click on the <strong>SQL Databases</strong> tab. The database created for your BizTalk Services instance will be named with the service name you <a id="id167" class="indexterm"/>provided, appended with the <code class="literal">_db</code> extension. Click on this database<a id="id168" class="indexterm"/> and then click on <strong>Manage</strong>. A new window (or tab) will open in the browser as shown in the following screenshot. In this window, you can select <strong>New Query</strong>, paste in the preceding SQL code, and click on <strong>Run</strong> to create the table and populate it with some data.</p><div><img src="img/7401EN_03_04.jpg" alt="Lookups"/><div><p>Windows Azure SQL query editor</p></div></div><p>As shown in the dialog box of <strong>Property Definitions</strong>, we can configure the Enrich stage in the bridge as before by performing the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <strong>Property Definitions</strong> dialog box on the first Enrich stage.</li><li class="listitem">Select <strong>Lookup</strong> for the <strong>Type</strong> field.</li><li class="listitem">Click on the dropdown list for the <strong>Identifier</strong> field and click on <strong>Configure New…</strong>.</li><li class="listitem">The dialog<a id="id169" class="indexterm"/> box will be displayed; complete it as shown<a id="id170" class="indexterm"/> in the following screenshot:<div><img src="img/7401EN_03_05.jpg" alt="Lookups"/><div><p>Provider configuration</p></div></div><div><div><h3 class="title"><a id="note05"/>Note</h3><p>To get the <strong>Connection String</strong> value, log back into the Azure Management Portal, click on the <strong>SQL Databases</strong> tab as you did earlier, and click on the WABS database that was created when you provisioned your service. Click on <strong>Dashboard</strong> and then click on <strong>Show Connection Strings</strong>. Copy the value in the ADO.NET textbox into this field.</p></div></div></li><li class="listitem">Click on <strong>OK</strong> to close the dialog box.</li><li class="listitem">For the <strong>Lookup</strong> property, select <strong>MappedCountry</strong>—this is the context property that was created by the XPath earlier and is used as input to the lookup.</li><li class="listitem">Enter <code class="literal">MappedCountry</code> in the <strong>Property Name</strong> field.</li><li class="listitem">Select <strong>string</strong> in the <strong>Data Type</strong> dropdown.</li><li class="listitem">Check the values as shown in the following screenshot:<div><img src="img/7401EN_03_06.jpg" alt="Lookups"/><div><p>Edit Property dialog box</p></div></div></li><li class="listitem">Click on <strong>OK</strong> to create the property.</li><li class="listitem">Finally, click on <strong>OK</strong> to close the <strong>Property Definitions</strong> dialog box.</li></ol></div><p>Now, when <a id="id171" class="indexterm"/>a message is received, the country name in the message is<a id="id172" class="indexterm"/> looked up in the database and the ISO country code will be returned and stored in the <strong>MappedCountry</strong> property. To finish off, we need to add a transformation to update the message itself with the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Right-click on the project and select <strong>Add</strong> | <strong>New Item…</strong>.</li><li class="listitem">Select <strong>Map</strong> in the templates dialog box and provide a map name of <code class="literal">CountryNameToCountryCode.trfm</code>.</li><li class="listitem">Click on <strong>OK</strong> to create the map.</li><li class="listitem">In the open map, click on the <strong>Open Source Schema</strong> link. Select the <strong>PO.XSD</strong> schema (from <a class="link" href="ch02.html" title="Chapter 2. Messages and Transforms">Chapter 2</a>, <em>Messages and Transforms</em>).</li><li class="listitem">Do the same for the <strong>Open Destination Schema</strong> link.</li><li class="listitem">In the functoids toolbox, drag-and-drop a <strong>Get Context Property</strong> functoid to the designer (it's located in the <strong>Misc Operations</strong> section).</li><li class="listitem">Double-click on the functoid on the map to configure it.</li><li class="listitem">In the <strong>Property Name</strong> field, enter <code class="literal">MappedCountry</code>.</li><li class="listitem">Click on <strong>OK</strong> to close the dialog box.</li><li class="listitem">Hold down the <em>Shift</em> key and click and hold the left mouse button on the <code class="literal">Order</code> node in the left-hand side schema. While still holding the left mouse button and the <em>Shift</em> key, drag across to the <code class="literal">Order</code> node in the right-hand side schema to connect them. In the pop up that is shown, select <strong>Link by Name</strong>. Recall from <a class="link" href="ch02.html" title="Chapter 2. Messages and Transforms">Chapter 2</a>, <em>Messages and Transforms</em>, that this action will map every field from the source to the destination.</li><li class="listitem">Finally, you need to delete the link between the <code class="literal">Country</code> nodes on the left and right as you are now looking up this value in the functoid.</li><li class="listitem">The<a id="id173" class="indexterm"/> map <a id="id174" class="indexterm"/>should now look like the following screenshot.<div><div><h3 class="title"><a id="note204"/>Note</h3><p>There are some limits in the bridge configuration <strong>user interface</strong> (<strong>UI</strong>) that can make <a id="id175" class="indexterm"/>changing configuration difficult. It is worth remembering that the bridge is simply an XML configuration file with associated configuration files for each source and destination present on the bridge.</p><p>For example, there is no way through the UI to change the database details for an existing lookup added in an Enrich stage. To do this, though, you simply need to open the <code class="literal">LookupProviderConfigurations.xml</code> file and edit the connection details. It is also important to notice that the username and password details for the connection are actually stored in this file, and it should therefore be treated with some care.</p></div></div><div><img src="img/7401EN_03_07.jpg" alt="Lookups"/><div><p>The country-code map</p></div></div></li><li class="listitem">The<a id="id176" class="indexterm"/> last<a id="id177" class="indexterm"/> step needed is to associate the map with the bridge. Double-click on the bridge file to open it (the <code class="literal">MessageFlowItinerary.bcs</code> file in the Solution Explorer).</li><li class="listitem">Double-click on the <strong>SimpleBridge</strong> component.</li><li class="listitem">Scroll down to the <strong>Transform</strong> stage and click on the <strong>XMLTransform</strong> box.</li><li class="listitem">In the <strong>Properties</strong> window, click on the elipsis (<strong>…</strong>) next to the <strong>Maps</strong> property.</li><li class="listitem">The map you just created should be shown in the dialog box; just check the <strong>Selected</strong> column to enable it.</li><li class="listitem">Click on <strong>OK</strong>.</li></ol></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec37"/>Routing</h1></div></div></div><p>Now let's<a id="id178" class="indexterm"/> look at another common scenario for messaging—routing. Here, a message needs to be delivered to one of a number of potential endpoints depending on some criteria. That criteria could be based on the property of the message (such as where it came from) or a property in the message (a data item such as <code class="literal">country</code>). Such content-based routing is easily achievable with BizTalk Services, as we'll see.</p><p>It should be noted that a message cannot be sent to more than one endpoint. This is something BizTalk Server is capable of, but currently BizTalk Services is not. Instead, BizTalk Services allows you to choose between destinations based on the routing rules you configure.</p><p>Look at the<a id="id179" class="indexterm"/> design in the <em>Routing bridge pattern</em> figure of the <em>Enrichment</em> section again. Notice that there are two possible destinations. We will now configure the message flow itinerary to route the message to the <code class="literal">Americas</code> destination if the <code class="literal">Country</code> property is <code class="literal">USA</code>; otherwise, we'll route to <code class="literal">Europe</code>. To do this, we need to perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Click on the arrow connecting the bridge to the <code class="literal">Americas</code> destination.</li><li class="listitem">In the <strong>Properties</strong> window, click on the <strong>Filter Condition</strong> property.</li><li class="listitem">Enter <code class="literal">MappedCountry = '844'</code> or <code class="literal">MappedCountry = '124'</code>.</li><li class="listitem">Now click on the arrow connecting to the <code class="literal">Europe</code> destination.</li><li class="listitem">In the <strong>Properties</strong> window, click on the <strong>Filter Condition</strong> property.</li><li class="listitem">Enter <code class="literal">MappedCountry = '826'</code>.</li></ol></div><p>You can change the order in which the routes are evaluated by clicking on the bridge, and in the <strong>Properties</strong> window, click on the ellipsis (<strong>…</strong>) next to the <strong>Route Ordering Table</strong> property. A dialog box, as in the following screenshot, will be shown:</p><div><img src="img/7401EN_03_08.jpg" alt="Routing"/><div><p>Changing the route order</p></div></div><p>By using the up and down arrows, the evaluation order can be changed so that you can ensure that<a id="id180" class="indexterm"/> the first matching condition you want is where the message will be routed to.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec38"/>Trying it out</h1></div></div></div><p>As the bridge sends messages to one of the two Service Bus queues, you need to create these first in the Azure Management Portal. Create two queues, one called <code class="literal">europe</code> and the other <code class="literal">americas</code>. The connection information for these queues then needs to be set on each of the queue destinations on the bridge. The <strong>Runtime Address</strong> property for each takes the following form:</p><p><code class="literal">sb://&lt;your namespace&gt;.servicebus.windows.net/Europe</code></p><p>The Authentication property also needs to be configured. The Token Provider type should be set to Shared Secret and the Issuer Secret set to the ACS Key for your Service Bus namespace.</p><p>You're now ready to deploy the solution. Do this in the normal way, and once deployed, you will have an HTTPS endpoint deployed to which you can post messages.</p><p>To send a message into the deployed bridge, you can use the BizTalk Service Explorer, which provides a number of useful features for managing and testing your solutions. It is an extension to Visual Studio and can be set up as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Launch Visual Studio 2012, and in the <strong>Tools</strong> menu, select <strong>Extensions and Updates…</strong>.</li><li class="listitem">Click on the <strong>Online</strong> link in the top-left corner, and in the search box, enter <code class="literal">biztalk service explorer</code> as shown in the following screenshot:<div><img src="img/7401EN_03_09.jpg" alt="Trying it out"/><div><p>Installing BizTalk Service Explorer</p></div></div></li><li class="listitem">Click on the <strong>Download</strong> button, which will download an MSI file. Double-click on it to install and relaunch Visual Studio.</li><li class="listitem">On the <strong>View</strong> menu, select <strong>Server Explorer</strong>.</li><li class="listitem">The <strong>Server Explorer</strong> window will have a new node, <strong>Windows Azure BizTalk Services</strong>; right-click on it and select <strong>Add BizTalk Service…</strong> as shown in the following screenshot:<div><img src="img/7401EN_03_10.jpg" alt="Trying it out"/><div><p>Adding a BizTalk Service instance</p></div></div></li><li class="listitem">In the dialog box that appears, enter the details of your service instance as shown in the following screenshot, replacing the details with your values as appropriate, and click on <strong>OK</strong>:<div><img src="img/7401EN_03_11.jpg" alt="Trying it out"/><div><p>Configuring the Explorer</p></div></div></li><li class="listitem">Now that you have the Explorer set up, expand the <strong>Bridges</strong> node and right-click on the bridge you just deployed and click on <strong>Send Test Message…</strong>.</li><li class="listitem">In the dialog box that appears, paste the test message from the start of this chapter <a id="id181" class="indexterm"/>as shown in the following screenshot and click on the <strong>Send</strong> button:<div><img src="img/7401EN_03_12.jpg" alt="Trying it out"/><div><p>Testing a bridge</p></div></div></li></ol></div><p>When you do this, remember that depending on the value you set <code class="literal">Country</code> to in the input message, you can direct messages to either the <code class="literal">Europe</code> or the <code class="literal">Americas</code> queue, as shown in the <em>Routing bridge pattern</em> figure of the <em>Enrichment</em> section, by using the values <code class="literal">UK</code>, <code class="literal">USA</code>, or <code class="literal">CANADA</code>.</p><p>To view the contents of a queue, you can use the Service Bus Explorer application that you can download from <a class="ulink" href="http://code.msdn.microsoft.com/windowsazure/Service-Bus-Explorer-f2abca5a">http://code.msdn.microsoft.com/windowsazure/Service-Bus-Explorer-f2abca5a</a>. The<a id="id182" class="indexterm"/> following screenshot shows the <code class="literal">Europe</code> destination queue containing the message we just posted into the bridge. Notice the <code class="literal">Country</code> node in the message contains the value <code class="literal">826</code> from the SQL lookup table, replacing the value <code class="literal">UK</code> that was in the original message.</p><div><img src="img/7401EN_03_13.jpg" alt="Trying it out"/><div><p>Viewing a message in the queue</p></div></div><p>Try changing the test message country to one that is not in the lookup table to see what happens. If you enter a country that does not exist, the lookup will fail. You will actually get a 500 HTTP response code back with a SOAP fault error message <strong>Lookup returned no results</strong>. Now try changing the value of <code class="literal">UK</code> in the lookup table to, say, <code class="literal">123</code>. What will happen now is that the route will fail as there is no match to either destination. You will get back the same HTTP 500 code, but this time with a SOAP fault of <strong>No Filter matched for the message</strong>. Have fun experimenting on your own!</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec39"/>Brokered messaging</h1></div></div></div><p>If you<a id="id183" class="indexterm"/> refer back to the table in the <em>Enrichment</em> section, you may have been intrigued by the Brokered property type. Messages that flow through bridges received from Service Bus<a id="id184" class="indexterm"/> are based on the Service Bus BrokeredMessage type (see <a class="ulink" href="http://msdn.microsoft.com/en-us/library/microsoft.servicebus.messaging.brokeredmessage.aspx">http://msdn.microsoft.com/en-us/library/microsoft.servicebus.messaging.brokeredmessage.aspx</a> for more details). This class provides a number of properties that are exposed in BizTalk Services such as <code class="literal">CorrelationId</code>, <code class="literal">MessageId</code>, and <code class="literal">SessionId</code>. What is really interesting about this is that when you are using the Service Bus Queue or Topic destination, properties you create in the bridge (any property, not just brokered properties) or properties set on received messages when Service Bus is the source are not just accessible inside the bridge, but outside of it as well. This is very useful for passing state from BizTalk Services to a downstream application consuming messages from a queue as that application will be able to see the properties you set in the bridge.</p><p>Note that though this is only applicable for Service Bus sources and destinations, if you were to chain one bridge to another, for example, you would not be able to pass these properties because chaining actually makes calls over HTTP and thus loses the context. Instead, if you wish <a id="id185" class="indexterm"/>to pass properties between bridges and from a bridge to another application, you must write the properties to the message header (in the case of HTTP) in order to preserve them. However, if you are chaining via Service Bus, then properties set in the first sending bridge will be accessible in the second receiving bridge.</p></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec40"/>Summary</h1></div></div></div><p>In this chapter, we have taken a closer look at the fundamental construct of Windows Azure BizTalk Services—the bridge. We've seen how bridges can be configured to perform a range of integration activities and how to perform content and context-based routing. While we have looked at most of what bridges can do, in the next chapter, we'll revisit bridges and look at how to perform custom logic on the stages in a bridge using message inspectors. We'll then look at how to track and record the message properties you create (tracking) and how to batch messages together for sending.</p></div></body></html>