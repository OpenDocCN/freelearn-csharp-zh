<html><head></head><body>
		<div><h1 id="_idParaDest-52"><em class="italic"><a id="_idTextAnchor092"/>Chapter 6</em>: Using Different Hosting Models</h1>
			<p>In this chapter, we will talk about how to customize hosting in ASP.NET Core. We will look into the hosting options and different kinds of hosting, and take a quick look at hosting on IIS. This chapter is just an overview. It is possible to go into much greater detail for each topic, but that would fill a complete book on its own!</p>
			<p>In this chapter, we will be covering the following topics:</p>
			<ul>
				<li>Setting up <code>WebHostBuilder</code></li>
				<li>Setting up Kestrel</li>
				<li>Setting up <code>HTTP.sys</code></li>
				<li>Hosting on IIS</li>
				<li>Using Nginx or Apache on Linux</li>
			</ul>
			<p>The topics in this chapter refer to the hosting layer of the ASP.NET Core architecture:</p>
			<div><div><img src="img/Figure_6.1_B17996.jpg" alt="Figure 6.1 – ASP.NET Core architecture&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.1 – ASP.NET Core architecture</p>
			<p>This chapter tackles the following topics of the server architecture:</p>
			<div><div><img src="img/Figure_6.2_B17996.jpg" alt="Figure 6.2 – ASP.NET server architecture&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.2 – ASP.NET server architecture</p>
			<h1 id="_idParaDest-53"><a id="_idTextAnchor093"/>Technical requirements</h1>
			<p>Fo<a id="_idTextAnchor094"/><a id="_idTextAnchor095"/>r this chapter, we just need to set up a small, empty web application:</p>
			<pre>dotnet new web -n ExploreHosting -o ExploreHosting</pre>
			<p>That's it. Open it with Visual Studio Code:</p>
			<pre>cd ExploreHosting
code .</pre>
			<p><em class="italic">Et voilà</em>! A simple project opens in Visual Studio Code.</p>
			<p>The code for this chapter can be found on GitHub here: <a href="https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter06">https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter06</a>.</p>
			<h1 id="_idParaDest-54">Se<a id="_idTextAnchor096"/><a id="_idTextAnchor097"/>tting up WebHostBuilder</h1>
			<p>As in the<a id="_idIndexMarker066"/> last chapter, we will focus on <code>Program.cs</code> in this section. <code>WebHostBuilder</code> is our friend. This is where we configure and create the web host.</p>
			<p>The following code snippet is the default configuration of every new ASP.NET Core web project we create using <code>dotnet new</code> command with the .NET CLI:</p>
			<pre>var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();
app.MapGet("/", () =&gt; "Hello World!");
app.Run();</pre>
			<p>As we already know from previous chapters, the default builder has all the necessary stuff preconfigured. All you require in order to run an application successfully on Azure or an on-premises IIS is configured for you.</p>
			<p>But you are<a id="_idIndexMarker067"/> able to override almost all of these default configurations, including the hosting configuration.</p>
			<p>Next, let's set up Kestrel.</p>
			<h1 id="_idParaDest-55"><a id="_idTextAnchor098"/>Setting up Kestrel</h1>
			<p>After <code>WebHostBuilder</code> is created, we can use various functions to configure the builder. Here, we <a id="_idIndexMarker068"/>can see one of them, which specifies the <code>Startup</code> class that should be used.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">As discussed in <a href="B17996_04_ePub.xhtml#_idTextAnchor066"><em class="italic">Chapter 4</em></a>, <em class="italic">Configuring and Customizing HTTPS with Kestrel</em>, Kestrel is one possibility when it comes to hosting your application. Kestrel is a web server built into .NET and based on .NET socket implementations. Previously, it was built on top of <strong class="bold">libuv</strong>, which is the same web server that is used by Node.js. Microsoft removed the dependency to <strong class="bold">libuv</strong> and <a id="_idIndexMarker069"/>created their own web server implementation based on .NET sockets.</p>
			<p>In the last chapter, we saw the <code>UseKestrel</code> method to configure the Kestrel options:</p>
			<pre>.UseKestrel((host, options) =&gt;
{
    // ...
})</pre>
			<p>This first argument is <code>WebHostBuilderContext</code> to access already-configured hosting settings or the configuration itself. The second argument is an object to configure Kestrel. This code snippet shows what we did in the last chapter to configure the socket endpoints where the host needs to listen:</p>
			<pre>builder.WebHost.UseKestrel((host, options) =&gt;
{
    var filename = host.Configuration.GetValue(
        "AppSettings:certfilename", "");
    var password = host.Configuration.GetValue(
        "AppSettings:certpassword", "");
    options.Listen(IPAddress.Loopback, 5000);
    options.Listen(IPAddress.Loopback,  5001,  
        listenOptions  =&gt;
        {
            listenOptions.UseHttps(filename, password);
        });
});</pre>
			<p>(You might need to add a <code>using</code> to <code>System.Net</code>.)</p>
			<p>This will<a id="_idIndexMarker070"/> override the default configuration where you are able to pass in URLs, for example, using the <code>applicationUrl</code> property of <code>launchSettings.json</code> or an environment variable.</p>
			<p>Let's now look at how to set up <code>HTTP.sys</code>.</p>
			<h1 id="_idParaDest-56"><a id="_idTextAnchor099"/>Setting up HTTP.sys</h1>
			<p>There is another <a id="_idIndexMarker071"/>hosting option, a different web server implementation. <code>HTTP.sys</code> is a pretty mature library, deep within Windows, that can be used to host your ASP.NET Core application:</p>
			<pre>.UseHttpSys(options =&gt;
{
    // ...
})</pre>
			<p><code>HTTP.sys</code> is different from Kestrel. It cannot be used in IIS because it is not compatible with the ASP.NET Core module for IIS.</p>
			<p>The main <a id="_idIndexMarker072"/>reason for using <code>HTTP.sys</code> instead of Kestrel is <code>HTTP.sys</code> if you need to expose your application to the internet without IIS.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">IIS has been running on top of <code>HTTP.sys</code> for years. This means that <code>UseHttpSys()</code> and IIS are using the same web server implementation. To learn more about <code>HTTP.sys</code>, please read the documentation, links to which can be found in the <em class="italic">Further reading</em> section.</p>
			<p>Next, let's look at using IIS for hosting.</p>
			<h1 id="_idParaDest-57">Hosting o<a id="_idTextAnchor100"/>n IIS</h1>
			<p>An ASP.NET Core application shouldn't be directly exposed to the internet, even if it's supported for Kestrel or <code>HTTP.sys</code>. It would be best to have something such as a reverse proxy in<a id="_idIndexMarker074"/> between, or at least a service that watches the hosting process. For ASP.NET Core, IIS isn't just a reverse proxy. It also takes care of the hosting process, in case it breaks because of an error. If that happens, IIS will restart the process. Nginx may be used as a reverse proxy on Linux that also takes care of the hosting process.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Be sure you created a new project or removed the Kestrel configuration of the previous section. This won't work with IIS.</p>
			<p>To host an ASP.NET Core web on IIS or Azure, you need to publish it first. Publishing doesn't only compile the project; it also prepares the project for hosting on IIS, Azure, or a web server on Linux, such as Nginx.</p>
			<p>The following command will publish the project:</p>
			<pre>dotnet publish -o ..\published -r win-x64</pre>
			<p>When viewed in a<a id="_idIndexMarker075"/> system browser, this should look as follows:</p>
			<div><div><img src="img/Figure_6.3_B17996.jpg" alt="Figure 6.3 – A .NET published folder"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.3 – A .NET published folder</p>
			<p>This produces an output that can be mapped in IIS. It also creates a <code>web.config</code> to add settings for IIS or Azure. It contains the compiled web application as a DLL.</p>
			<p>If you publish a self-contained application, it also contains the runtime itself. A self-contained application brings its own .NET Core runtime, but the size of the delivery increases a lot.</p>
			<p>And on IIS? Just create a new web and map it to the folder where you placed the published ou<a id="_idTextAnchor101"/><a id="_idTextAnchor102"/>tput:</p>
			<div><div><img src="img/Figure_6.4_B17996.jpg" alt="Figure 6.4 – The .NET publishing dialog"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.4 – The .NET publishing dialog</p>
			<p>It gets a little <a id="_idIndexMarker076"/>more complicated if you need to change the security, if you have some database connections, and so on. This could be a topic for a separate chapter on its own. </p>
			<div><div><img src="img/Figure_6.5_B17996.jpg" alt="Figure 6.5 – Hello World! viewed in a browser"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.5 – Hello World! viewed in a browser</p>
			<p><em class="italic">Figure 6.5</em> shows the output of the small <code>MapGet</code> in the <code>Program.cs</code> of the demo project:</p>
			<pre>app.MapGet("/", () =&gt; "Hello World!");</pre>
			<p>Next up, we'll discuss some alternatives for Linux.</p>
			<h1 id="_idParaDest-58"><a id="_idTextAnchor103"/>Using Nginx or Apache on Linux</h1>
			<p>Publishing an ASP.NET Core application on Linux looks very similar to the way it looks on IIS, but preparing it for the reverse proxy requires some additional steps. You will need a web server such as Nginx or Apache as a reverse proxy that forwards the traffic to Kestrel and the ASP.NET Core application: </p>
			<ol>
				<li>First, you <a id="_idIndexMarker077"/>need to allow your app to accept two specific <a id="_idIndexMarker078"/>forwarded headers. To do this, open <code>Startup.cs</code> and<a id="_idIndexMarker079"/> add the following lines to the <code>Configure</code> method<a id="_idIndexMarker080"/> before the <code>UseAuthentication</code> middleware:<pre>app.UseForwardedHeaders(new ForwardedHeadersOptions
{
    ForwardedHeaders = ForwardedHeaders.XForwardedFor 
        | ForwardedHeaders.XForwardedProto
});</pre></li>
				<li>You also need to trust the incoming traffic from the reverse proxy. This requires you to add the following lines to the <code>ConfigureServices</code> method:<pre>Builder.Services.Configure&lt;ForwardedHeadersOptions&gt;(
  options =&gt;
{
    options.KnownProxies.Add(
        IPAddress.Parse("10.0.0.100"));
});</pre><p>You might need to add a <code>using</code> to <code>Microsoft.AspNetCore.HttpOverrides</code>.</p></li>
				<li>Add the IP address of the proxy here. This is just a sample.</li>
				<li>Then, you need to publish the application:<pre><strong class="bold">dotnet publish --configuration Release</strong></pre></li>
				<li>Copy the build output to a folder called <code>/var/www/yourapplication</code>. You should also do a quick test on Linux by calling the following<a id="_idTextAnchor104"/> command:<pre><strong class="bold">dotnet &lt;yourapplication.dll&gt;</strong></pre></li>
				<li>Here, <code>yourapplication.dll</code> is the compiled application, including the path. If it is all working correctly, you should be able to call your web on <code>http://localhost:5000/</code>.<p>If it is working, the<a id="_idIndexMarker081"/> application should run as a service. This requires <a id="_idIndexMarker082"/>you to <a id="_idIndexMarker083"/>create a <a id="_idIndexMarker084"/>service file on <code>/etc/systemd/system/</code>. Call the file <code>kestrel-yourapplication.service</code> and place the following content in it:</p><pre>[Unit]
Description=Example .NET Web API App running on Ubuntu
[Service]
WorkingDirectory=/var/www/yourapplication
ExecStart=/usr/bin/dotnet/var/www/yourapplication/yourapplication.dll
Restart=always
# Restart service after 10 seconds if the dotnet service crashes:
RestartSec=10
KillSignal=SIGINT
SyslogIdentifier=dotnet-example
User=www-data
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false
[Install]
WantedBy=multi-user.target </pre><p>Ensure<a id="_idIndexMarker085"/> that the paths in lines 5 and 6 point to the folder where <a id="_idIndexMarker086"/>you placed the build output. This file defines that your<a id="_idIndexMarker087"/> app should run as a service on the default port. It <a id="_idIndexMarker088"/>also watches the app and restarts it in case it crashes. It also defines environment variables that get passed in to configure your application. See <a href="B17996_01_ePub.xhtml#_idTextAnchor019"><em class="italic">Chapter 1</em></a>, <em class="italic">Customizing Logging</em>, to learn how to configure your application using environment variables.</p></li>
			</ol>
			<p>Next up, we'll see how to configure Nginx.</p>
			<h2 id="_idParaDest-59"><a id="_idTextAnchor105"/>Configuring Nginx</h2>
			<p>Now you can tell <a id="_idIndexMarker089"/>Nginx what to do using the following code:</p>
			<pre>server {
    listen        80;
    server_name   example.com *.example.com;
    location / {
        proxy_pass         http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection keep-alive;
        proxy_set_header   Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header   X-Forwarded-For
                           $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}</pre>
			<p>This tells Nginx<a id="_idIndexMarker090"/> to forward calls on port <code>80</code> to <code>example.com</code>, and subdomains of it to <code>http://localhost:5000</code>, which is the default address of your application.</p>
			<h2 id="_idParaDest-60"><a id="_idTextAnchor106"/>Configuring Apache</h2>
			<p>The Apache<a id="_idIndexMarker091"/> configuration looks pretty similar to the Nginx method, and does the same things at the end:</p>
			<pre>&lt;VirtualHost *:*&gt;
   RequestHeader set "X-Forwarded-Proto 
     expr=%{REQUEST_SCHEME}
&lt;/VirtualHost&gt;
&lt;VirtualHost *:80&gt;
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:5000/
    ProxyPassReverse / http://127.0.0.1:5000/
    ServerName www.example.com
    ServerAlias *.example.com
    ErrorLog ${APACHE_LOG_DIR}yourapplication-error.log
    CustomLog ${APACHE_LOG_DIR}yourapplication-access.log
    common
&lt;/VirtualHost&gt;</pre>
			<p>That's it for Nginx and Apache. Let's now w<a id="_idTextAnchor107"/><a id="_idTextAnchor108"/>rap up this chapter.</p>
			<h1 id="_idParaDest-61"><a id="_idTextAnchor109"/>Summary</h1>
			<p>ASP.NET Core and the .NET CLI already contain all the tools to get them running on various platforms and to set it up to get it ready for Azure and IIS, as well as Nginx. This is super easy and well described in the documentation.</p>
			<p>Currently, we have <code>WebHostBuilder</code>, which creates the hosting environment of the applications. In version 3.0, we have <code>HostBuilder</code>, which is able to create a hosting environment that is completely independent of any web context. </p>
			<p>ASP.NET Core 6.0 has a feature to run tasks in the background inside the application. To learn more about that, read the next chapter.</p>
			<h1 id="_idParaDest-62"><a id="_idTextAnchor110"/>Further reading</h1>
			<p>For more information you can refer to the following links:</p>
			<ul>
				<li><strong class="bold">Kestrel documentation</strong>: <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-6.0">https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-6.0</a></li>
				<li><strong class="bold">HTTP.sys documentation</strong>: <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/httpsys?view=aspnetcore-6.0">https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/httpsys?view=aspnetcore-6.0</a></li>
				<li><strong class="bold">ASP.NET Core</strong>: <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/aspnet-core-module?view=aspnetcore-6.0">https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/aspnet-core-module?view=aspnetcore-6.0</a></li>
			</ul>
		</div>
	</body></html>