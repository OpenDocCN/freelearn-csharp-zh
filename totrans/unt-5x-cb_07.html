<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Controlling 3D Animations"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Controlling 3D Animations</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Configuring a character's Avatar and idle animation</li><li class="listitem" style="list-style-type: disc">Moving your character with root motion and Blend Trees</li><li class="listitem" style="list-style-type: disc">Mixing animations with Layers and Masks</li><li class="listitem" style="list-style-type: disc">Organizing States into Sub-State Machines</li><li class="listitem" style="list-style-type: disc">Transforming the Character Controller via script</li><li class="listitem" style="list-style-type: disc">Adding rigid props to animated characters</li><li class="listitem" style="list-style-type: disc">Using Animation Events to throw an object</li><li class="listitem" style="list-style-type: disc">Applying Ragdoll physics to a character</li><li class="listitem" style="list-style-type: disc">Rotating the character's torso to aim a weapon</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec69"/>Introduction</h1></div></div></div><p>The <span class="strong"><strong>Mecanim</strong></span> animation <a class="indexterm" id="id689"/>system has revolutionized how characters are animated and controlled within Unity. In this chapter, we will learn how to take advantage of its flexibility, power, and friendly and highly visual interface.</p><div class="section" title="The big picture"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec193"/>The big picture</h2></div></div></div><p>Controlling a playable<a class="indexterm" id="id690"/> character with the Mecanim System might look like a complex task, but it is actually very straightforward.</p><div class="mediaobject"><img alt="The big picture" src="graphics/1362OT_07_00.jpg"/></div><p>Hopefully, by<a class="indexterm" id="id691"/> the end of the chapter, you will have gained at least a basic understanding of the Mecanim system. For a more complete overview of the subject, consider taking a look at Jamie Dean's <span class="emphasis"><em>Unity Character Animation</em></span> with Mecanim, also published by Packt Publishing.</p><p>An additional note—all the recipes will make use of <a class="indexterm" id="id692"/><span class="strong"><strong>Mixamo</strong></span> motion packs. Mixamo is a complete solution for character production, rigging, and animation. In fact, the character in use was designed with Mixamo's character creation software called <span class="strong"><strong>Fuse</strong></span>, and rigged <a class="indexterm" id="id693"/>with the Mixamo <span class="strong"><strong>Auto-rigger</strong></span>. You can find out more about Mixamo and their <a class="indexterm" id="id694"/>products at Unity's Asset Store (<a class="ulink" href="https://www.assetstore.unity3d.com/en/#!/publisher/150">https://www.assetstore.unity3d.com/en/#!/publisher/150</a>) or their <a class="indexterm" id="id695"/>website at <a class="ulink" href="https://www.mixamo.com/">https://www.mixamo.com/</a>.</p><p>Please note that although Mixamo offers Mecanim-ready characters and animation clips, we will use, for the recipes in this chapter, unprepared animation clips. The reason is to make you more confident when dealing with assets obtained by other methods and sources.</p></div></div></div>
<div class="section" title="Configuring a character's Avatar and idle animation"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec70"/>Configuring a character's Avatar and idle animation</h1></div></div></div><p>A feature that makes Mecanim so flexible and powerful is the ability of quickly reassigning animation clips from one character to another. This is made possible through the use of <span class="strong"><strong>Avatars</strong></span>, which are basically a layer between your character's original rig and the Unity's <a class="indexterm" id="id696"/><span class="strong"><strong>Animator</strong></span> system.</p><p>In this recipe, we <a class="indexterm" id="id697"/>will learn how to configure an Avatar skeleton on a rigged character.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec194"/>Getting ready</h2></div></div></div><p>For this recipe, you will need the <code class="literal">MsLaser@T-Pose.fbx</code> and <code class="literal">Swat@rifle_aiming_idle.fbx</code> files, which are contained inside the <code class="literal">1362_07_code/character_and_clips/</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec195"/>How to do it...</h2></div></div></div><p>To configure an<a class="indexterm" id="id698"/> Avatar skeleton, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Import the <code class="literal">MsLaser@T-Pose.fbx</code> and <code class="literal">Swat@rifle_aiming_idle.fbx</code> files to your project.</li><li class="listitem">Select from the <span class="strong"><strong>Project</strong></span> view, the <code class="literal">MsLaser@T-Pose</code> model.</li><li class="listitem">In the <span class="strong"><strong>Inspector</strong></span> view, under <span class="strong"><strong>MsLaser@T-Pose Import Settings</strong></span>, activate the <span class="strong"><strong>Rig</strong></span> section. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span>. Then, leave <span class="strong"><strong>Avatar Definition</strong></span> as <span class="strong"><strong>Create From this Model</strong></span>. Finally, click on the <span class="strong"><strong>Configure…</strong></span> button.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_01.jpg"/></div></li><li class="listitem"><span class="strong"><strong>Inspector</strong></span> view will show the newly created Avatar. Observe how Unity correctly mapped the bones of our character into its structure, assigning, for instance, the <span class="strong"><strong>mixamoRig:LeftForeArm</strong></span> bone as the Avatar's <span class="strong"><strong>Lower Arm</strong></span>. We could, of course, reassign bones if needed. For now, just click on the <span class="strong"><strong>Done</strong></span> button to close the view.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_02.jpg"/></div></li><li class="listitem">Now that we have our Avatar ready, let's configure our animation for the <span class="strong"><strong>Idle</strong></span> state. From<a class="indexterm" id="id699"/> the <span class="strong"><strong>Project</strong></span> view, select the <span class="strong"><strong>Swat@rifle_aiming_idle</strong></span> file.</li><li class="listitem">Activate the<a class="indexterm" id="id700"/> <span class="strong"><strong>Rig</strong></span> section, change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span> and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Create From This Model</strong></span>. Confirm by clicking on <span class="strong"><strong>Apply</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_03.jpg"/></div></li><li class="listitem">Activate the <span class="strong"><strong>Animations</strong></span> section (to the right of the <span class="strong"><strong>Rig</strong></span>). Select the <span class="strong"><strong>rifle_aiming_idle</strong></span> clip (from the <span class="strong"><strong>Clips</strong></span> list). The <span class="strong"><strong>Preview area</strong></span> (at the bottom of the Inspector) will display the message as <span class="strong"><strong>No model is available for preview. Please </strong></span><a class="indexterm" id="id701"/><span class="strong"><strong>drag a model into this Preview area</strong></span>. Drag <span class="strong"><strong>MsLaser@T-Pose</strong></span> to the <span class="strong"><strong>Preview</strong></span><a class="indexterm" id="id702"/> area to correct this.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_04.jpg"/></div></li><li class="listitem">With <span class="strong"><strong>rifle_aiming_idle</strong></span> selected from the <span class="strong"><strong>Clips</strong></span> list, check the <span class="strong"><strong>Loop Time</strong></span> and <span class="strong"><strong>Loop Pose</strong></span> options. Also, click on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline to the actual time of the animation clip. Then, under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select<span class="strong"><strong> Baked upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake Into Pose </strong></span>unchecked, and select<span class="strong"><strong> Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Center of Mass</strong></span>. Finally, click on <span class="strong"><strong>Apply</strong></span> to confirm the changes.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_05.jpg"/></div></li><li class="listitem">In order to access animation clips and play them, we need to create a controller. Do<a class="indexterm" id="id703"/> this by clicking on the <span class="strong"><strong>Create</strong></span> button from the <span class="strong"><strong>Project</strong></span> view, and then selecting the <span class="strong"><strong>Animator Controller</strong></span> option. Name it as <code class="literal">MainCharacter</code>.</li><li class="listitem">Double-click on the <span class="strong"><strong>Animator Controller</strong></span> to open the <span class="strong"><strong>Animator</strong></span> view.</li><li class="listitem">From the<a class="indexterm" id="id704"/> <span class="strong"><strong>Animator</strong></span> view, right-click on the grid to open a context menu. Then, select the <span class="strong"><strong>Create State</strong></span> |<span class="strong"><strong> Empty</strong></span> option<span class="strong"><strong>.</strong></span> A new box named <span class="strong"><strong>New State</strong></span> will appear. It will be in orange, indicating that it is the default state.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_06.jpg"/></div></li><li class="listitem">Select <span class="strong"><strong>New State</strong></span> and, in the <span class="strong"><strong>Inspector</strong></span> view, change its name to <code class="literal">Idle</code>. Also, in the <span class="strong"><strong>Motion</strong></span> field, choose <span class="strong"><strong>rifle_aiming_idle</strong></span> by either selecting it from the list or dragging it<a class="indexterm" id="id705"/> from the <span class="strong"><strong>Project</strong></span> view.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_07.jpg"/></div></li><li class="listitem">Drag the<a class="indexterm" id="id706"/> <code class="literal">MsLaser@T-Pose</code> model from the <span class="strong"><strong>Project</strong></span> view into the <span class="strong"><strong>Hierarchy</strong></span> view and place it on the scene.</li><li class="listitem">Select <span class="strong"><strong>MsLaser@T-Pose</strong></span> from the <span class="strong"><strong>Hierarchy</strong></span> view and observe its <span class="strong"><strong>Animator</strong></span> component in the <span class="strong"><strong>Inspector</strong></span> view. Then, assign the newly created <span class="strong"><strong>MainCharacter controller</strong></span> to its <span class="strong"><strong>Controller</strong></span> field.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_08.jpg"/></div></li><li class="listitem">Play your scene to see the character correctly animated.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec196"/>How it works...</h2></div></div></div><p>Preparing our character for animation took many steps. First, we created its <span class="strong"><strong>Avatar</strong></span>, based on the character model's original bone structure. Then, we set <a class="indexterm" id="id707"/>up the <span class="strong"><strong>animation clip</strong></span> (which, as the character mesh, is stored in a <code class="literal">.fbx</code> file), using its own Avatar. After this, we adjusted the<a class="indexterm" id="id708"/> animation clip, clamping its size and making it a loop. We also baked its <span class="strong"><strong>Root Transform Rotation</strong></span> to obey the original file's orientation. Finally, an <a class="indexterm" id="id709"/><span class="strong"><strong>Animator Controller</strong></span> was created, and the edited animation clip was made into its default <span class="strong"><strong>Animation state</strong></span>.</p><p>The concept of the <a class="indexterm" id="id710"/>Avatar is what makes Mecanim so flexible. Once you have a <a class="indexterm" id="id711"/><span class="strong"><strong>Controller</strong></span>, you can apply it to other humanoid characters, as long as they have an Avatar body mask. If you want to try it yourself, import <code class="literal">mascot.fbx</code>, which is also available inside the <code class="literal">charater_and_clips</code> folder, apply steps 3 and 4 into this character, place it on the scene, and apply <span class="strong"><strong>MainCharacter</strong></span> as its <span class="strong"><strong>Controller</strong></span> in the <span class="strong"><strong>Animator</strong></span> component. Then, play the scene to see the mascot playing the <span class="strong"><strong>rifle_aiming_idle</strong></span> animation clip.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec197"/>There's more...</h2></div></div></div><p>To read more<a class="indexterm" id="id712"/> information about the Animator Controller, check out Unity's documentation at <a class="ulink" href="http://docs.unity3d.com/Manual/class-AnimatorController.html">http://docs.unity3d.com/Manual/class-AnimatorController.html</a>.</p></div></div>
<div class="section" title="Moving your character with root motion and Blend Trees"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec71"/>Moving your character with root motion and Blend Trees</h1></div></div></div><p>The Mecanim animation <a class="indexterm" id="id713"/>system is capable of applying Root Motion to characters. In other words, it <span class="emphasis"><em>actually</em></span> moves the character according to the animation clip, as opposed to arbitrarily translating the character model while playing an in-place animation cycle. This <a class="indexterm" id="id714"/>makes most of the Mixamo <a class="indexterm" id="id715"/>animation clips perfect for use with Mecanim.</p><p>Another feature of the animation system is <span class="strong"><strong>Blend Trees</strong></span>, which can blend animation clips smoothly and easily. In this recipe, we will take advantage of these features to make our character walk/run<a class="indexterm" id="id716"/> forward and backwards, and also strafe right and left at different speeds.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec198"/>Getting ready</h2></div></div></div><p>For this recipe, we have prepared a Unity package named <code class="literal">Character_02</code>, containing a character and featuring a basic Animator Controller. The package can be found inside the <code class="literal">1362_07_02</code> folder, along with the <code class="literal">.fbx</code> files for the necessary animation clips.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec199"/>How to do it...</h2></div></div></div><p>To apply the Root Motion to your character using <span class="strong"><strong>Blend Trees</strong></span>, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Import <code class="literal">Character_02.unityPackage</code> into a new project. Also, import <code class="literal">Swat@rifle_run, Swat@run_backwards, Swat@strafe, Swat@strafe_2, Swat@strafe_left, Swat@strafe_right, Swat@walking</code>,<code class="literal"> and Swat@walking_backwards .fbx</code> files.</li><li class="listitem">We need to configure our animation clips. From the <span class="strong"><strong>Project view</strong></span>, select <span class="strong"><strong>Swat@rifle_run</strong></span>.</li><li class="listitem">Activate the <span class="strong"><strong>Rig</strong></span> section. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span> and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Create From this Model</strong></span>. Confirm by clicking on <span class="strong"><strong>Apply</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_09.jpg"/></div></li><li class="listitem">Now, activate the <span class="strong"><strong>Animations</strong></span> section (to the right of <span class="strong"><strong>Rig</strong></span>). Select the <span class="strong"><strong>rifle_run</strong></span> clip (from the <span class="strong"><strong>Clips</strong></span> list). The <span class="strong"><strong>Preview area</strong></span> (at the bottom of the <span class="strong"><strong>Inspector</strong></span> view) will display the message as <span class="strong"><strong>No model is available for preview. Please drag a model into this Preview area</strong></span>. Drag <span class="strong"><strong>MsLaser@T-Pose </strong></span>onto the <span class="strong"><strong>Preview</strong></span> area to correct this.</li><li class="listitem">With <span class="strong"><strong>rifle_run</strong></span> selected<a class="indexterm" id="id717"/> from the <span class="strong"><strong>Clips</strong></span> list, select the <span class="strong"><strong>rifle_run</strong></span> clip (from the <span class="strong"><strong>Clips</strong></span> list) and check the <span class="strong"><strong>Loop Time</strong></span> and <span class="strong"><strong>Loop Pose</strong></span> options. Also, click on the <span class="strong"><strong>Clamp Range</strong></span><a class="indexterm" id="id718"/> button to adjust the timeline to the actual time of the animation clip.</li><li class="listitem">Then, under<a class="indexterm" id="id719"/> <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select<span class="strong"><strong> Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <a class="indexterm" id="id720"/><span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select<span class="strong"><strong> Baked Upon</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake Into Pose </strong></span>unchecked, and select<span class="strong"><strong> Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Center of Mass</strong></span>. Finally, click on <span class="strong"><strong>Apply</strong></span> to confirm the changes.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_10.jpg"/></div></li><li class="listitem">Repeat steps 3 to 6 for each one of the following animation clips: <span class="strong"><strong>Swat@run_backwards</strong></span>, <span class="strong"><strong>Swat@strafe</strong></span>, <span class="strong"><strong>Swat@strafe_2</strong></span>, <span class="strong"><strong>Swat@strafe_left</strong></span>, <span class="strong"><strong>Swat@strafe_right</strong></span>, <span class="strong"><strong>Swat@walking</strong></span>, and <span class="strong"><strong>Swat@walking_backwards</strong></span>.</li><li class="listitem">From the <span class="strong"><strong>Project view</strong></span>, select the <span class="strong"><strong>MsLaser</strong></span> prefab and drag it onto the <span class="strong"><strong>Hierarchy</strong></span> view, placing it on the scene.</li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> GameObject and attach a <span class="strong"><strong>Character Controller</strong></span> component to it (<span class="strong"><strong>menu Component</strong></span> | <span class="strong"><strong>Physics</strong></span> | <span class="strong"><strong>Character Controller</strong></span>). Then, set its <span class="strong"><strong>Skin Width</strong></span> as <code class="literal">0.0001</code>, and its <span class="strong"><strong>Center</strong></span> as <span class="strong"><strong>X</strong></span>: <span class="strong"><strong>0</strong></span>, <span class="strong"><strong>Y</strong></span>: <span class="strong"><strong>0.9</strong></span>, <span class="strong"><strong>Z</strong></span>: <span class="strong"><strong>0</strong></span>; also change its <span class="strong"><strong>Radius</strong></span> to <span class="strong"><strong>0.34</strong></span> and its <span class="strong"><strong>Height</strong></span> to <span class="strong"><strong>1.79</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_11.jpg"/></div></li><li class="listitem">In the <span class="strong"><strong>Project </strong></span><a class="indexterm" id="id721"/><span class="strong"><strong>view</strong></span>, open the <span class="strong"><strong>MainCharacter</strong></span> controller.</li><li class="listitem">In the top-left <a class="indexterm" id="id722"/>corner of the <span class="strong"><strong>Animator</strong></span> view, activate the <span class="strong"><strong>Parameters</strong></span> section and use the <span class="strong"><strong>+</strong></span> sign to create three new <span class="strong"><strong>Parameters (Float) </strong></span>named <code class="literal">xSpeed</code>, <code class="literal">zSpeed</code>, and <a class="indexterm" id="id723"/><code class="literal">Speed</code>.</li><li class="listitem">We do have an <span class="strong"><strong>Idle</strong></span> <a class="indexterm" id="id724"/>state for our character, but we need the new ones. Right-click on the gridded area and, from the context menu, navigate to <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>From New Blend Tree</strong></span>. Change its name, from the <span class="strong"><strong>Inspector</strong></span> view, to <code class="literal">Move</code>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_12.jpg"/></div></li><li class="listitem">Double-click on the <span class="strong"><strong>Move</strong></span> state. You will see the empty blend tree that you have created. Select it and, in the <span class="strong"><strong>Inspector</strong></span> view, rename it to <code class="literal">Move</code>. Then, change its <span class="strong"><strong>Blend Type</strong></span> to <span class="strong"><strong>2D Freeform Directional</strong></span>, also setting <span class="strong"><strong>xSpeed</strong></span> and <span class="strong"><strong>zSpeed</strong></span> in the <span class="strong"><strong>Parameters</strong></span> tab. Finally, using the <span class="strong"><strong>+</strong></span> sign from the bottom<a class="indexterm" id="id725"/> of the <span class="strong"><strong>Motion</strong></span> list, add nine new <span class="strong"><strong>Motion Fields</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_13.jpg"/></div></li><li class="listitem">Now, populate<a class="indexterm" id="id726"/> the <span class="strong"><strong>Motion</strong></span> list with the following motion <a class="indexterm" id="id727"/>clips and respective <span class="strong"><strong>Pos X</strong></span> and <span class="strong"><strong>Pos Y</strong></span> values: <span class="strong"><strong>run_backwards</strong></span>, <code class="literal">0</code>, <code class="literal">-1</code>; <span class="strong"><strong>walking_backwards</strong></span>, <code class="literal">0</code>,<code class="literal">-0.5</code>; <span class="strong"><strong>rifle_aiming_idle</strong></span>, <code class="literal">0</code>, <code class="literal">0</code>; <span class="strong"><strong>walking</strong></span>, <code class="literal">0</code>, <code class="literal">0.5</code>; <span class="strong"><strong>rifle_run</strong></span>, <code class="literal">0</code>, <code class="literal">1</code>; <span class="strong"><strong>strafe</strong></span>, <code class="literal">-1</code>,<code class="literal"> 0</code>; <span class="strong"><strong>strafe_left</strong></span>, -<code class="literal">0.5</code>, <code class="literal">0</code>; <span class="strong"><strong>strafe_right</strong></span>, <code class="literal">0.5</code>, <code class="literal">0</code>; <span class="strong"><strong>strafe_2</strong></span>, <code class="literal">1</code>, <code class="literal">0</code>. You can populate the <span class="strong"><strong>Motion</strong></span> list by selecting it from the list or, if there are more than one clip with the same name, you can <a class="indexterm" id="id728"/>drag it from the <span class="strong"><strong>Project view</strong></span> onto the slot (by expanding the appropriate model icon).<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_14.jpg"/></div></li><li class="listitem">Double-click on<a class="indexterm" id="id729"/> the gridded area to go from the <span class="strong"><strong>Move</strong></span> blend tree back to the <span class="strong"><strong>Base Layer</strong></span>.</li><li class="listitem">Since we <a class="indexterm" id="id730"/>have the <code class="literal">rifle_aiming_idle</code> Motion clip within our <span class="strong"><strong>Move</strong></span> blend tree, we can get rid of the original <span class="strong"><strong>Idle</strong></span> state. Right-click on the <span class="strong"><strong>Idle</strong></span> state box and, from the menu, select <span class="strong"><strong>Delete</strong></span>. The <a class="indexterm" id="id731"/><span class="strong"><strong>Move</strong></span> blend state will become<a class="indexterm" id="id732"/> the new default state, turning orange.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_15.jpg"/></div></li><li class="listitem">Now, we must create the script that will actually transform the player's input into those variables that are created to control the animation.</li><li class="listitem">From<a class="indexterm" id="id733"/> the <span class="strong"><strong>Project view</strong></span>, create a new <span class="strong"><strong>C# Script</strong></span> and name it as <code class="literal">BasicController</code>.</li><li class="listitem">Open your<a class="indexterm" id="id734"/> script <a class="indexterm" id="id735"/>and replace everything with<a class="indexterm" id="id736"/> the following code:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class BasicController: MonoBehaviour {
  private Animator anim;
  private CharacterController controller;
  public float transitionTime = .25f;
  private float speedLimit = 1.0f;
  public bool moveDiagonally = true;
  public bool mouseRotate = true;
  public bool keyboardRotate = false;

  void Start () {
    controller = GetComponent&lt;CharacterController&gt;();
    anim = GetComponent&lt;Animator&gt;();
  }
  
  void Update () {
    if(controller.isGrounded){
      if (Input.GetKey (KeyCode.RightShift) ||Input.GetKey (KeyCode.LeftShift))
        speedLimit = 0.5f;
      else
        speedLimit = 1.0f;
    
      float h = Input.GetAxis("Horizontal");
      float v = Input.GetAxis("Vertical");
      float xSpeed = h * speedLimit;
      float zSpeed = v * speedLimit;
      float speed = Mathf.Sqrt(h*h+v*v);

      if(v!=0 &amp;&amp; !moveDiagonally)
        xSpeed = 0;

      if(v!=0 &amp;&amp; keyboardRotate)
        this.transform.Rotate(Vector3.up * h, Space.World);

      if(mouseRotate)
        this.transform.Rotate(Vector3.up * (Input.GetAxis("Mouse X")) * Mathf.Sign(v), Space.World);

      anim.SetFloat("zSpeed", zSpeed, transitionTime, Time.deltaTime);
      anim.SetFloat("xSpeed", xSpeed, transitionTime, Time.deltaTime);
      anim.SetFloat("Speed", speed, transitionTime, Time.deltaTime);
    }
  }
}</pre></div></li><li class="listitem">Save your <a class="indexterm" id="id737"/>script and attach it to the <span class="strong"><strong>MsLaser</strong></span> GameObject in the <span class="strong"><strong>Hierarchy</strong></span> view. Then, add <span class="strong"><strong>Plane</strong></span> (menu option <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>3D Object</strong></span> | <span class="strong"><strong>Plane</strong></span>) and place it beneath the character.</li><li class="listitem">Play your<a class="indexterm" id="id738"/> scene and test the game. You will be able to control your character with the arrow keys (or <span class="emphasis"><em>WASD</em></span> keys). Keeping<a class="indexterm" id="id739"/> the <span class="emphasis"><em>Shift</em></span> key pressed will slow it down.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec200"/>How it works...</h2></div></div></div><p>Whenever the<a class="indexterm" id="id740"/> <code class="literal">BasicController</code> script detects any directional keys in use, it sets the <code class="literal">Speed</code> variable of the <span class="strong"><strong>Animator</strong></span> state to a value higher than 0, changing the <span class="strong"><strong>Animator</strong></span> state from <span class="strong"><strong>Idle</strong></span> to <span class="strong"><strong>Move</strong></span>. The <span class="strong"><strong>Move</strong></span> state, in its turn, blends the motion clips that it was populated with, according to the input values for <code class="literal">xSpeed</code> (obtained from<a class="indexterm" id="id741"/> <span class="strong"><strong>Horizontal Axis </strong></span>input, typically <span class="emphasis"><em>A</em></span> and <span class="emphasis"><em>D</em></span> keys) and <code class="literal">zSpeed</code> (obtained from<a class="indexterm" id="id742"/> <span class="strong"><strong>Vertical Axis</strong></span> input, typically <span class="emphasis"><em>W</em></span> and <span class="emphasis"><em>S</em></span> keys). Since Mecanim is capable of applying root motion to the characters, our character will actually move in the resulting direction.</p><p>For instance, if <span class="emphasis"><em>W</em></span> and <span class="emphasis"><em>D</em></span> keys are pressed, <code class="literal">xSpeed</code> and <code class="literal">zSpeed</code> values will rise to 1.0. From the <span class="strong"><strong>Inspector</strong></span> view, it is possible to see that such combination will result in a blend between the motion clips called <span class="strong"><strong>rifle_run</strong></span> and <span class="strong"><strong>strafe_2</strong></span>, making the character run diagonally (front + right).</p><div class="mediaobject"><img alt="How it works..." src="graphics/1362OT_07_18.jpg"/></div><p>Our <span class="strong"><strong>BasicController</strong></span><a class="indexterm" id="id743"/> includes three checkboxes for more options: <span class="strong"><strong>Move Diagonally</strong></span>—set as <span class="strong"><strong>true</strong></span>, by default, which allows for blends between forward/backward and left/right clips; <span class="strong"><strong>Mouse Rotate</strong></span>—set as <span class="strong"><strong>true</strong></span>, by default, which allows<a class="indexterm" id="id744"/> for rotating the character with the mouse, changing their direction while moving; <span class="strong"><strong>Keyboard Rotate</strong></span>—set as <span class="strong"><strong>false</strong></span>, by default, which<a class="indexterm" id="id745"/> allows for rotating the character through<a class="indexterm" id="id746"/> simultaneous use of left/right and forward/backwards directional keys.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec201"/>There's more...</h2></div></div></div><p>Our blend tree used the <span class="strong"><strong>2D Freeform Directional Blend Type</strong></span>. However, if we had only four animation clips (forward, backwards, left, and right), <span class="strong"><strong>2D Simple Directional</strong></span> would have been a better option. Learn more on the following links:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learn more about Blend<a class="indexterm" id="id747"/> Trees and 2D blending from Unity's Documentation at: <a class="ulink" href="http://docs.unity3d.com/Manual/BlendTree-2DBlending.html">http://docs.unity3d.com/Manual/BlendTree-2DBlending.html</a>.</li><li class="listitem" style="list-style-type: disc">Also, if you want to learn more about Mecanim Animation System, there are some links that you<a class="indexterm" id="id748"/> might want to check out, such as Unity's documentation at: <a class="ulink" href="http://docs.unity3d.com/Manual/AnimationOverview.html">http://docs.unity3d.com/Manual/AnimationOverview.html</a>.</li><li class="listitem" style="list-style-type: disc">Mecanim <a class="indexterm" id="id749"/>Example Scenes are available at Unity <a class="indexterm" id="id750"/>Asset Store at: <a class="ulink" href="https://www.assetstore.unity3d.com/en/#!/content/5328">https://www.assetstore.unity3d.com/en/#!/content/5328</a>.</li><li class="listitem" style="list-style-type: disc">Mecanim <a class="indexterm" id="id751"/>Video Tutorial are available at: <a class="ulink" href="http://unity3d.com/pt/learn/tutorials/topics/animation">http://unity3d.com/pt/learn/tutorials/topics/animation</a>.</li></ul></div></div></div>
<div class="section" title="Mixing animations with Layers and Masks"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec72"/>Mixing animations with Layers and Masks</h1></div></div></div><p>Mixing animations is a great way of adding complexity to your animated characters without requiring a vast number of animated clips. Using <span class="strong"><strong>Layers</strong></span> and <span class="strong"><strong>Masks</strong></span>, we can combine different animations by playing specific clips for the specific body parts of the character. In this<a class="indexterm" id="id752"/> recipe, we will apply this technique to our animated character, triggering animation clips for firing a rifle, and throwing a<a class="indexterm" id="id753"/> grenade with the character's upper body. We will do this while keeping the lower body moving or idle, according to the player's input.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec202"/>Getting ready</h2></div></div></div><p>For this recipe, we have prepared a Unity Package named <code class="literal">Mixing</code>, containing a basic scene that features an animated character. The package can be found inside the <code class="literal">1362_07_03</code> folder, along with the animation clips called <code class="literal">Swat@firing_rifle.fbx</code> and <code class="literal">Swat@toss_grenade.fbx</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec203"/>How to do it...</h2></div></div></div><p>To mix animations using layers and masks, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new project and import the <code class="literal">Mixing</code> Unity Package. Then, from the <span class="strong"><strong>Project view</strong></span>, open the <span class="strong"><strong>mecanimPlayground</strong></span> level.</li><li class="listitem">Import the <code class="literal">Swat@firing_rifle.fbx</code> and <code class="literal">Swat@toss_grenade.fbx</code> files to the project.</li><li class="listitem">We need to configure the animation clips. From the <span class="strong"><strong>Project view</strong></span>, select the <span class="strong"><strong>Swat@firing_rifle</strong></span> animation clip.</li><li class="listitem">Activate the <span class="strong"><strong>Rig</strong></span> section. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span>, and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Create From this Model</strong></span>. Confirm this by clicking on <span class="strong"><strong>Apply</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_09.jpg"/></div></li><li class="listitem">Now, activate the <span class="strong"><strong>Animations</strong></span> section. Select the <span class="strong"><strong>firing_rifle</strong></span> clip (from the <span class="strong"><strong>Clips</strong></span> list), click <a class="indexterm" id="id754"/>on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline, and check the <span class="strong"><strong>Loop Time </strong></span>and <span class="strong"><strong>Loop Pose</strong></span> <a class="indexterm" id="id755"/>options. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake Into Pose</strong></span> unchecked. Click on<span class="strong"><strong> Apply</strong></span> to confirm the changes.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_19.jpg"/></div></li><li class="listitem">Select the <a class="indexterm" id="id756"/><span class="strong"><strong>Swat@toss_grenade</strong></span><a class="indexterm" id="id757"/> animation clip. Activate the <span class="strong"><strong>Rig</strong></span> section. Then, change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span>, and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Create From this Model</strong></span>. Confirm it by clicking on <span class="strong"><strong>Apply</strong></span>.</li><li class="listitem">Now, activate the <span class="strong"><strong>Animations</strong></span> section. Select the <span class="strong"><strong>toss_grenade</strong></span> clip (from the <span class="strong"><strong>Clips</strong></span> list), click on the button <span class="strong"><strong>Clamp Range</strong></span> to adjust the timeline, and leave the <span class="strong"><strong>Loop Time </strong></span>and <span class="strong"><strong>Loop Pose</strong></span> options unchecked. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original)</strong></span>. Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake Into Pose</strong></span> unchecked. Click on <span class="strong"><strong>Apply</strong></span> to confirm the changes.</li><li class="listitem">Let's create a<a class="indexterm" id="id758"/> Mask. From the <span class="strong"><strong>Project</strong></span> view, click on the <span class="strong"><strong>Create</strong></span> button and add an <span class="strong"><strong>Avatar Mask</strong></span> to the project. Name it <a class="indexterm" id="id759"/>as <span class="strong"><strong>BodyMask</strong></span>.</li><li class="listitem">Select the <span class="strong"><strong>BodyMask</strong></span> tab and, in the <span class="strong"><strong>Inspector</strong></span> view, expand the <span class="strong"><strong>Humanoid</strong></span> section to unselect the character's legs, base, and <span class="strong"><strong>IK</strong></span> spots, turning their outline red.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_20.jpg"/></div></li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Then, from the <span class="strong"><strong>Animator</strong></span> component in the <span class="strong"><strong>Inspector</strong></span> view, double-click on the <span class="strong"><strong>MainCharacter</strong></span> controller to open it.</li><li class="listitem">In the <span class="strong"><strong>Animator</strong></span> view, create a new layer by clicking on the <span class="strong"><strong>+</strong></span> sign at the top-left <span class="strong"><strong>Layers </strong></span>tab, above the <span class="strong"><strong>Base Layer</strong></span>.</li><li class="listitem">Name the new <a class="indexterm" id="id760"/>layer as <span class="strong"><strong>UpperBody</strong></span> and click on the gear icon for the settings. Then, change its <span class="strong"><strong>Weight</strong></span> to <code class="literal">1</code>, and <a class="indexterm" id="id761"/>select the <span class="strong"><strong>BodyMask</strong></span> in the <span class="strong"><strong>Mask</strong></span> slot. Also, change Blending to <span class="strong"><strong>Additive</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_21.jpg"/></div></li><li class="listitem">Now, in the <span class="strong"><strong>Animator</strong></span> view, with the <span class="strong"><strong>UpperBody</strong></span> layer selected, create three new empty states (by right-clicking on the gridded area and navigating to, from the menu, <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>Empty</strong></span>). Name the default (orange) state <span class="strong"><strong>null</strong></span>, and the other two as <span class="strong"><strong>Fire</strong></span> and <span class="strong"><strong>Grenade</strong></span>.</li><li class="listitem">Now, access the <span class="strong"><strong>Parameters</strong></span> tab and add two new parameters of the Boolean type: <code class="literal">Fire</code> and <code class="literal">Grenade</code>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_22.jpg"/></div></li><li class="listitem">Select the <span class="strong"><strong>Fire</strong></span> state and, in the <span class="strong"><strong>Inspector</strong></span> view, add the <span class="strong"><strong>firing_rifle</strong></span> animation clip to the <span class="strong"><strong>Motion</strong></span> field.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_23.jpg"/></div></li><li class="listitem">Now, select the <span class="strong"><strong>Grenade</strong></span> state and, in the <span class="strong"><strong>Inspector</strong></span> view, add the <span class="strong"><strong>toss_grenade</strong></span><a class="indexterm" id="id762"/> animation clip to the <span class="strong"><strong>Motion</strong></span> field.</li><li class="listitem">Right-click on the<a class="indexterm" id="id763"/> <span class="strong"><strong>null</strong></span> state box and, from the menu, select <span class="strong"><strong>Make Transition</strong></span>. Then, drag the white arrow onto the <span class="strong"><strong>Fire</strong></span> box.</li><li class="listitem">Select the arrow (it will turn blue). From the <span class="strong"><strong>Inspector</strong></span> view, uncheck the <span class="strong"><strong>Has Exit Time</strong></span> option. Then, access the <span class="strong"><strong>Conditions</strong></span> list, click on the <span class="strong"><strong>+</strong></span> sign to add a new condition, and set it as <span class="strong"><strong>Fire</strong></span> and <span class="strong"><strong>true</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_24.jpg"/></div></li><li class="listitem">Now, make a transition from <span class="strong"><strong>null</strong></span> to <span class="strong"><strong>Grenade</strong></span>. Select the arrow (it will turn blue). From the <span class="strong"><strong>Inspector</strong></span> view, uncheck the <span class="strong"><strong>Has Exit Time</strong></span> option. Then, access the <a class="indexterm" id="id764"/><span class="strong"><strong>Conditions</strong></span> list, click on the <span class="strong"><strong>+</strong></span> sign to add a new condition, and set it as <span class="strong"><strong>Grenade</strong></span> and <span class="strong"><strong>true</strong></span>.</li><li class="listitem">Now, create<a class="indexterm" id="id765"/> transitions from <span class="strong"><strong>Fire</strong></span> to <span class="strong"><strong>null</strong></span>, and from <span class="strong"><strong>Grenade</strong></span> to <span class="strong"><strong>null</strong></span>. Then, select the arrow that goes from <span class="strong"><strong>Fire</strong></span> to <span class="strong"><strong>null</strong></span> and, in the <span class="strong"><strong>Conditions</strong></span> box, select the <span class="strong"><strong>Fire</strong></span> and <span class="strong"><strong>false</strong></span> options. Leave the <span class="strong"><strong>Has Exit Time </strong></span>option checked.</li><li class="listitem">Finally, select the arrow that goes from <span class="strong"><strong>Grenade</strong></span> to <span class="strong"><strong>null</strong></span>. In the Conditions box, select the options <code class="literal">Grenade</code>, <code class="literal">false</code>. Leave the <span class="strong"><strong>Has Exit Time </strong></span>option checked.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_25.jpg"/></div></li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Locate, in the <span class="strong"><strong>Inspector</strong></span> view, the <span class="strong"><strong>Basic Controller </strong></span>component and open its script.</li><li class="listitem">Immediately<a class="indexterm" id="id766"/> before the end of the<a class="indexterm" id="id767"/> <code class="literal">Update()</code> function, add the following code:<div class="informalexample"><pre class="programlisting">  if(Input.GetKeyDown(KeyCode.F)){
    anim.SetBool("Grenade", true);
  } else {
    anim.SetBool("Grenade", false);
  }
  if(Input.GetButtonDown("Fire1")){
    anim.SetBool("Fire", true);
  }
  if(Input.GetButtonUp("Fire1")){
    anim.SetBool("Fire", false);
  }</pre></div></li><li class="listitem">Save the script and play your scene. You will be able to trigger the <span class="strong"><strong>firing_rifle</strong></span> and <span class="strong"><strong>toss_grenade</strong></span> animations by clicking on the <span class="strong"><strong>fire</strong></span> button and pressing the <span class="emphasis"><em>F</em></span> key. Observe how the character's legs still respond to the <span class="strong"><strong>Move</strong></span> animation state.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec204"/>How it works...</h2></div></div></div><p>Once the Avatar mask is created, it can be used as a way of filtering the body parts that would actually play<a class="indexterm" id="id768"/> the animation states of a particular layer. In our case, we have constrained our <span class="strong"><strong>fire_rifle</strong></span> and <span class="strong"><strong>toss_grenade</strong></span> animation<a class="indexterm" id="id769"/> clips to the upper body of our character, leaving the lower body free to play the movement-related animation clips, such as walking, running, and strafing.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec205"/>There's more...</h2></div></div></div><p>You might have noticed that the <span class="strong"><strong>UpperBody</strong></span> layer has a parameter named <span class="strong"><strong>Blending</strong></span>, which we have set to <span class="strong"><strong>Additive</strong></span>. This means that animation states in this layer will be added to the ones from the lower layers. If changed to <span class="strong"><strong>Override</strong></span>, the animation from this would override animation states from the lower layers when played. In our case, <span class="strong"><strong>Additive</strong></span> helped in keeping the aim stable when firing while running.</p><p>For more information on<a class="indexterm" id="id770"/> <span class="strong"><strong>Animation Layers</strong></span> and <span class="strong"><strong>Avatar Body Masks</strong></span>, check out<a class="indexterm" id="id771"/> Unity's documentation at <a class="ulink" href="http://docs.unity3d.com/Manual/AnimationLayers.html">http://docs.unity3d.com/Manual/AnimationLayers.html</a> and <a class="ulink" href="http://docs.unity3d.com/Manual/class-AvatarMask.html">http://docs.unity3d.com/Manual/class-AvatarMask.html</a>.</p></div></div>
<div class="section" title="Organizing States into Sub-state Machines"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec73"/>Organizing States into Sub-state Machines</h1></div></div></div><p>Whenever the Animator area gets too cluttered, you can always think of organizing your Animation<a class="indexterm" id="id772"/> States into Sub-State Machines. In this recipe, we will use this technique to organize animation states for turning the character. Also, since<a class="indexterm" id="id773"/> the provided animation clips do not include Root Motion, we will use the opportunity to illustrate how to overcome the lack of Root Motion via script, using it to turn the character 45 degrees to the left and right.</p><div class="mediaobject"><img alt="Organizing States into Sub-state Machines" src="graphics/1362OT_07_37.jpg"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec206"/>Getting ready</h2></div></div></div><p>For this recipe, we have prepared a Unity Package named <code class="literal">Turning</code>, containing a basic scene that features an animated character. The package can be found inside the <code class="literal">1362_07_04</code> folder, along with animation clips called <code class="literal">Swat@turn_right_45_degrees.fbx</code> and <code class="literal">Swat@turn_left.fbx</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec207"/>How to do it...</h2></div></div></div><p>To apply Root<a class="indexterm" id="id774"/> Motion via script, please follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new project and import the <code class="literal">Turning</code> Unity Package. Then, from the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>mecanimPlayground</strong></span> level.</li><li class="listitem">Import the <code class="literal">Swat@turn_right_45_degrees.fbx</code> and <code class="literal">Swat@turn_left.fbx</code> files in the project.</li><li class="listitem">We need to configure our animation clips. Select the <span class="strong"><strong>Swat@turn_left</strong></span> file from the <span class="strong"><strong>Project</strong></span> view.</li><li class="listitem">Activate the <a class="indexterm" id="id775"/><span class="strong"><strong>Rig</strong></span> section. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span>, and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Create From this Model</strong></span>. Confirm by clicking on <span class="strong"><strong>Apply</strong></span>.</li><li class="listitem">Now, activate the <span class="strong"><strong>Animations</strong></span> section. Select the <span class="strong"><strong>turn_left</strong></span> clip (from the <span class="strong"><strong>Clips</strong></span> list), click on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline, and check the <span class="strong"><strong>Loop Time</strong></span> option. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and navigate to <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake Into Pose</strong></span> unchecked. Click on <span class="strong"><strong>Apply</strong></span> to confirm the changes.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_26.jpg"/></div></li><li class="listitem">Repeat steps 4 and 5 for <span class="strong"><strong>Swat@turning_right_45_degrees</strong></span>.</li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Then, from the <span class="strong"><strong>Animator</strong></span> <a class="indexterm" id="id776"/>component in the <span class="strong"><strong>Inspector</strong></span> view, open the <span class="strong"><strong>MainCharacter</strong></span> controller.</li><li class="listitem">From the top-left corner <a class="indexterm" id="id777"/>of the <span class="strong"><strong>Animator</strong></span> view, activate the <span class="strong"><strong>Parameters</strong></span> section and use the <span class="strong"><strong>+</strong></span> sign to create the two new <span class="strong"><strong>Parameters (Boolean) </strong></span>named <code class="literal">TurnLeft</code> and <code class="literal">TurnRight</code>.</li><li class="listitem">Right-click on the gridded area. From the context menu, select <span class="strong"><strong>Create Sub-State Machine</strong></span>. From the <span class="strong"><strong>Inspector</strong></span> view, rename it <code class="literal">Turn</code>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_27.jpg"/></div></li><li class="listitem">Double-click on the <span class="strong"><strong>Turn</strong></span> sub-state machine. Right-click on the gridded area, select <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>Empty</strong></span>, and add a new state. Rename it to <code class="literal">Turn Left</code>. Then, add <a class="indexterm" id="id778"/>another state named <code class="literal">Turn Right</code>.</li><li class="listitem">From the <span class="strong"><strong>Inspector</strong></span> <a class="indexterm" id="id779"/>view, populate <code class="literal">Turn Left</code> with the <span class="strong"><strong>turn_left</strong></span> motion clip. Then, populate <code class="literal">Turn Right </code>with <span class="strong"><strong>turning_right_45_degrees</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_28.jpg"/></div></li><li class="listitem">Get out of the <span class="strong"><strong>Turn</strong></span> sub-state machine back into the <span class="strong"><strong>Base Layer</strong></span>. By right-clicking on each state and selecting the option <span class="strong"><strong>Make Transition</strong></span>, create transitions between <span class="strong"><strong>Move </strong></span>and <span class="strong"><strong>Turn Left</strong></span>, and <span class="strong"><strong>Move </strong></span>and <span class="strong"><strong>Turn Right</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_29.jpg"/></div></li><li class="listitem">Enter the <span class="strong"><strong>Turn</strong></span> sub-state machine. Then, create transitions from <span class="strong"><strong>Turn Left</strong></span> and <span class="strong"><strong>Turn Right</strong></span> into the <span class="strong"><strong>Move</strong></span> state.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_30.jpg"/></div></li><li class="listitem">Select the arrow<a class="indexterm" id="id780"/> that goes form <span class="strong"><strong>Turn Right</strong></span> to <span class="strong"><strong>(Up) Base Layer</strong></span>. It will turn blue. From the <span class="strong"><strong>Inspector</strong></span> view, uncheck the <span class="strong"><strong>Has Exit Time</strong></span> option. Then, access the <span class="strong"><strong>Conditions</strong></span> list, click<a class="indexterm" id="id781"/> the <span class="strong"><strong>+</strong></span> sign to add a new condition, and set it as <span class="strong"><strong>TurnRight</strong></span> and <span class="strong"><strong>false</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_31.jpg"/></div></li><li class="listitem">Select the arrow that goes from <span class="strong"><strong>(Up) Base Layer</strong></span> to <span class="strong"><strong>Turn Right</strong></span>. From the <span class="strong"><strong>Inspector</strong></span> view, uncheck the <span class="strong"><strong>Has Exit Time</strong></span> option. Then, access the <span class="strong"><strong>Conditions</strong></span> list, click the <span class="strong"><strong>+</strong></span> sign to add a new condition, and set it as <span class="strong"><strong>TurnRight</strong></span> and <span class="strong"><strong>true</strong></span>.</li><li class="listitem">Repeat steps 14 and 15 with the arrows that go between <span class="strong"><strong>(Up) Base Layer</strong></span> and <span class="strong"><strong>Turn Left</strong></span>, using <span class="strong"><strong>TurnLeft</strong></span> as a condition, this time.</li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Then, from the <span class="strong"><strong>Inspector</strong></span> view, open the script from the <span class="strong"><strong>BasicController</strong></span> component.</li><li class="listitem">Immediately<a class="indexterm" id="id782"/> after the <code class="literal">if(controller.isGrounded){</code> line, add:<div class="informalexample"><pre class="programlisting">if(Input.GetKey(KeyCode.Q)){
  anim.SetBool("TurnLeft", true);
  transform.Rotate(Vector3.up * (Time.deltaTime * -45.0f), Space.World);
}  else {
  anim.SetBool("TurnLeft", false);
}
if(Input.GetKey(KeyCode.E)){
  anim.SetBool("TurnRight", true);
  transform.Rotate(Vector3.up * (Time.deltaTime * 45.0f), Space.World);
} else {
  anim.SetBool("TurnRight", false);
}</pre></div></li><li class="listitem">Save your script. Then, select the <span class="strong"><strong>MsLaser</strong></span> character and, from the <span class="strong"><strong>Inspector</strong></span> view, access the<a class="indexterm" id="id783"/> <span class="strong"><strong>Basic Controller</strong></span> component. Leave the <span class="strong"><strong>Move Diagonally</strong></span> and <span class="strong"><strong>Mouse Rotate</strong></span> options unchecked. Also, leave the <span class="strong"><strong>Keyboard Rotate</strong></span> option checked. Finally, play the scene. You <a class="indexterm" id="id784"/>will be able to turn left and right by using the <span class="emphasis"><em>Q</em></span> and <span class="emphasis"><em>E</em></span> keys, respectively.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec208"/>How it works...</h2></div></div></div><p>As it should be clear from the recipe, the sub-state machines work in a similar way to groups or folders, allowing you to encapsulate a series of state machines into a single entity for easier reference. States from the sub-state machines can be transitioned from external states, in our case, the<a class="indexterm" id="id785"/> <span class="strong"><strong>Move</strong></span> state, or even from different sub-state machines.</p><p>Regarding the character's rotation, we have overcome the lack of root motion by using the <code class="literal">transform.Rotate(Vector3.up * (Time.deltaTime * -45.0f), Space.World);</code> command to make the character actually turn around when the <span class="emphasis"><em>Q</em></span> and <span class="emphasis"><em>E</em></span> keys are being held down. This command was used in conjunction with <code class="literal">animator.SetBool("TurnLeft", true);</code>, which triggers the right animation clip.</p></div></div>
<div class="section" title="Transforming the Character Controller via script"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec74"/>Transforming the Character Controller via script</h1></div></div></div><p>Applying <span class="strong"><strong>Root Motion</strong></span> to your character might be a very practical and accurate way to animate it. However, every now and then, you might need to manually control one or two aspects of the <a class="indexterm" id="id786"/>character movement. Perhaps you only have an in-place animation to work with, or maybe you want the character's movement to be affected by<a class="indexterm" id="id787"/> other variables. In these cases, you will need to override the root motion via script.</p><p>To illustrate this issue, this recipe makes use of an animation clip for jumping, which originally moves the character only in the Y-axis. In order to make her move forward or backwards while jumping, we will learn how to access the character's velocity to inform the jump's direction via the script.</p><div class="mediaobject"><img alt="Transforming the Character Controller via script" src="graphics/1362OT_07_38.jpg"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec209"/>Getting ready</h2></div></div></div><p>For this recipe, we have prepared a Unity Package named <code class="literal">Jumping</code>, containing a basic scene that features an animated character. The package can be found inside the <code class="literal">1362_07_05</code> folder, along with the animation clip called <code class="literal">Swat@rifle_jump</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec210"/>How to do it...</h2></div></div></div><p>To apply the Root Motion via script, please follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new project and import the <code class="literal">Jumping</code> Unity Package. Then, from the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>mecanimPlayground</strong></span> level.</li><li class="listitem">Import the <code class="literal">Swat@rifle_jump.fbx</code> file to the project.</li><li class="listitem">We need to configure our animation clip. From the <span class="strong"><strong>Project </strong></span>view, select the <span class="strong"><strong>Swat@rifle_jump</strong></span> file.</li><li class="listitem">Activate the <span class="strong"><strong>Rig</strong></span> section. Change <span class="strong"><strong>Animation Type</strong></span> to <span class="strong"><strong>Humanoid</strong></span>, and <span class="strong"><strong>Avatar Definition</strong></span> to <span class="strong"><strong>Create From this Model</strong></span>. Confirm this by clicking on <span class="strong"><strong>Apply</strong></span>.</li><li class="listitem">Now, activate the <span class="strong"><strong>Animations</strong></span> section. Select the <span class="strong"><strong>rifle_jump </strong></span>clip (from the <span class="strong"><strong>Clips</strong></span> list), click<a class="indexterm" id="id788"/> on the <span class="strong"><strong>Clamp Range</strong></span> button to adjust the timeline, and check the <span class="strong"><strong>Loop Time </strong></span>and <span class="strong"><strong>Loop Pose</strong></span> options. Under <span class="strong"><strong>Root Transform Rotation</strong></span>, check <span class="strong"><strong>Bake Into Pose</strong></span>, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (Y)</strong></span>, leave <span class="strong"><strong>Bake into Pose </strong></span>unchecked, and select <span class="strong"><strong>Baked Upon (at Start)</strong></span> | <span class="strong"><strong>Original</strong></span>. Under <span class="strong"><strong>Root Transform Position (XZ)</strong></span>, leave <span class="strong"><strong>Bake Into Pose</strong></span> unchecked. Click on<span class="strong"><strong> Apply</strong></span> to confirm the changes.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_32.jpg"/></div></li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Then, from the <span class="strong"><strong>Animator</strong></span> component in the <span class="strong"><strong>Inspector</strong></span> view, open the <span class="strong"><strong>MainCharacter</strong></span> controller.</li><li class="listitem">From the top-left corner of the <span class="strong"><strong>Animator</strong></span> view, activate the <span class="strong"><strong>Parameters</strong></span> section, and use the <span class="strong"><strong>+</strong></span> sign to create a new <span class="strong"><strong>Parameters (Boolean) </strong></span>named <code class="literal">Jump</code>.</li><li class="listitem">Right-click on the <a class="indexterm" id="id789"/>gridded area and, from the context menu, select <span class="strong"><strong>Create State</strong></span> | <span class="strong"><strong>Empty</strong></span>. Change its name, from the <span class="strong"><strong>Inspector</strong></span> view, to <code class="literal">Jump</code>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_33.jpg"/></div></li><li class="listitem">Select the <span class="strong"><strong>Jump</strong></span> state. Then, from the <span class="strong"><strong>Inspector</strong></span> view, populate it with the <span class="strong"><strong>rifle_jump</strong></span> Motion clip.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_34.jpg"/></div></li><li class="listitem">Find and right-click on the <span class="strong"><strong>Any State</strong></span>. Then, selecting the <span class="strong"><strong>Make Transition</strong></span> option, create a transition from <span class="strong"><strong>Any State</strong></span> to <span class="strong"><strong>Jump</strong></span>. Select the transition, uncheck <span class="strong"><strong>Has Exit Time</strong></span>, and use the <span class="strong"><strong>Jump</strong></span> variable as a condition (<span class="strong"><strong>true</strong></span>).</li><li class="listitem">Now, create a transition from <span class="strong"><strong>Jump</strong></span> to <span class="strong"><strong>Move</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_35.jpg"/></div></li><li class="listitem">Configure the<a class="indexterm" id="id790"/> transitions between <span class="strong"><strong>Jump</strong></span> and <span class="strong"><strong>Move</strong></span>, leaving <span class="strong"><strong>Has Exit Time</strong></span> checked, and use the <span class="strong"><strong>Jump</strong></span> variable as a condition (<span class="strong"><strong>false</strong></span>).<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_36.jpg"/></div></li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>MsLaser</strong></span> character. Then, from the <span class="strong"><strong>Inspector</strong></span> view, open the script from the <span class="strong"><strong>BasicController</strong></span> component.</li><li class="listitem">Right before the <code class="literal">Start()</code> function, add the following code:<div class="informalexample"><pre class="programlisting">public float jumpHeight = 3f;
private float verticalSpeed = 0f;
private float xVelocity = 0f;
private float zVelocity = 0f;</pre></div></li><li class="listitem">Inside the <code class="literal">Update()</code> function, find the line containing the following code:<div class="informalexample"><pre class="programlisting">if(controller.isGrounded){</pre></div><p>And add the following lines immediatly after it:</p><div class="informalexample"><pre class="programlisting">if (Input.GetKey (KeyCode.Space)) {
  anim.SetBool ("Jump", true);
  verticalSpeed = jumpHeight;
}</pre></div></li><li class="listitem">Finally, add a<a class="indexterm" id="id791"/> new function, following immediately before the final <code class="literal">}</code> of the code:<div class="informalexample"><pre class="programlisting">  void OnAnimatorMove(){
    Vector3 deltaPosition = anim.deltaPosition;
    if (controller.isGrounded) {
      xVelocity = controller.velocity.x;
      zVelocity = controller.velocity.z;
    } else {
      deltaPosition.x = xVelocity * Time.deltaTime;
      deltaPosition.z = zVelocity * Time.deltaTime;
      anim.SetBool ("Jump", false);
    }
    deltaPosition.y = verticalSpeed * Time.deltaTime;
    controller.Move (deltaPosition);
    verticalSpeed += Physics.gravity.y * Time.deltaTime;
    if ((controller.collisionFlags &amp; CollisionFlags.Below) != 0) {
      verticalSpeed = 0;
    }
  }</pre></div></li><li class="listitem">Save your script and play the scene. You will be able to jump around using the <span class="emphasis"><em>Space</em></span> key. Observe how the character's velocity affects the direction of the jump.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec211"/>How it works...</h2></div></div></div><p>Observe that once this function is added to the script, the <span class="strong"><strong>Apply Root Motion</strong></span> field, in the <span class="strong"><strong>Animator</strong></span> component, changes from a checked box to <span class="strong"><strong>Handled by Script</strong></span>. The reason is that in order to override the animation clip's original movement, we have placed, inside Unity's <code class="literal">OnAnimatorMove()</code> function, a series of commands to move our character controller while jumping. The line of code: <code class="literal">controller.Move (deltaPosition);</code> basically replaces the jump's direction from the original animation with the <code class="literal">deltaPosition</code> 3D Vector, which is made of the character's velocity at the instant before the jump (<span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>z</em></span>-axis) and the calculation between the <code class="literal">jumpHeight</code> variable and gravity<a class="indexterm" id="id792"/> force overtime (<span class="emphasis"><em>y</em></span>-axis).</p></div></div>
<div class="section" title="Adding rigid props to animated characters"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec75"/>Adding rigid props to animated characters</h1></div></div></div><p>In case you<a class="indexterm" id="id793"/> haven't included a sufficient number of props to your character when modeling and animating it, you might want to give her the <a class="indexterm" id="id794"/>chance of collecting new ones at runtime. In this recipe, we will learn how to instantiate a GameObject and assign it to a character, respecting the animation hierarchy.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec212"/>Getting ready</h2></div></div></div><p>For this recipe, we have prepared a Unity Package named <code class="literal">Props</code>, containing a basic scene that features an animated character and a prefab named <span class="strong"><strong>badge</strong></span>. The package can be found inside the <code class="literal">1362_07_06</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec213"/>How to do it...</h2></div></div></div><p>To add a rigid prop at runtime to an animated character, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new project and import the <code class="literal">Props</code> Unity Package. Then, from the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>mecanimPlayground</strong></span> level.</li><li class="listitem">From the <span class="strong"><strong>Project</strong></span> view, add the <span class="strong"><strong>badge</strong></span> prop to the scene by dragging it onto the <span class="strong"><strong>Hierarchy</strong></span> view. Then, make it a child of the <span class="strong"><strong>mixamorig:Spine2</strong></span> transform (use the <span class="strong"><strong>Hierarchy</strong></span> tree to navigate to <span class="strong"><strong>MsLaser</strong></span> | <span class="strong"><strong>mixamorig:Hips</strong></span> | <span class="strong"><strong>mixamorig:Spine</strong></span> | <span class="strong"><strong>mixamorig:Spine1</strong></span> | <span class="strong"><strong>mixamorig:Spine2</strong></span>). Then, make the <span class="strong"><strong>badge</strong></span> object visible above the character's chest by changing its <span class="strong"><strong>Transform Position</strong></span> to <span class="strong"><strong>X</strong></span>: <code class="literal">-0.08</code>, <span class="strong"><strong>Y</strong></span>: <code class="literal">0,</code> <span class="strong"><strong>Z</strong></span>: <code class="literal">0.15</code>; and <span class="strong"><strong>Rotation</strong></span> to <span class="strong"><strong>X</strong></span>: <code class="literal">0.29</code>, <span class="strong"><strong>Y</strong></span>: <code class="literal">0.14</code>, <span class="strong"><strong>Z</strong></span>:<code class="literal">-13.29</code>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_39.jpg"/></div></li><li class="listitem">Make a note of the <span class="strong"><strong>Position</strong></span> and <span class="strong"><strong>Rotation</strong></span> values, and delete the <span class="strong"><strong>badge</strong></span> object from the scene.</li><li class="listitem">Add a new <span class="strong"><strong>Cube</strong></span> to the scene (drop-down <span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>3D Object</strong></span> | <span class="strong"><strong>Cube</strong></span>), rename it as <span class="strong"><strong>PropTrigger</strong></span>, and change its Position to <span class="strong"><strong>X</strong></span>: <code class="literal">0</code>, <span class="strong"><strong>Y</strong></span>: <code class="literal">0.5</code>, <span class="strong"><strong>Z</strong></span>: <code class="literal">2</code>.</li><li class="listitem">From the <span class="strong"><strong>Inspector</strong></span> view's <span class="strong"><strong>Box Collider</strong></span> component, check the <span class="strong"><strong>Is Trigger</strong></span> option.</li><li class="listitem">From the<a class="indexterm" id="id795"/> <span class="strong"><strong>Project</strong></span> view, create a new <span class="strong"><strong>C# Script</strong></span> named <code class="literal">AddProp.cs</code>.</li><li class="listitem">Open the<a class="indexterm" id="id796"/> script and add the following code:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class AddProp : MonoBehaviour {
  public GameObject prop;
  public Transform targetBone;
  public Vector3 positionOffset;
  public Vector3 rotationOffset;
  public bool  destroyTrigger = true;
  
  void  OnTriggerEnter ( Collider collision  ){
    
    if (targetBone.IsChildOf(collision.transform)){
      bool  checkProp = false;
      foreach(Transform child in targetBone){
        if (child.name == prop.name)
          checkProp = true;
      }
      
      if(!checkProp){
        GameObject newprop;
        newprop = Instantiate(prop, targetBone.position, targetBone.rotation) as GameObject;
        newprop.name = prop.name;
        newprop.transform.parent = targetBone;
        newprop.transform.localPosition += positionOffset;
        newprop.transform.localEulerAngles += rotationOffset;
        if(destroyTrigger)
          Destroy(gameObject);
      }
    }
  }
}</pre></div></li><li class="listitem">Save and close the script.</li><li class="listitem">Attach the <span class="strong"><strong>AddProp.cs</strong></span> script to the <span class="strong"><strong>PropTrigger</strong></span> GameObject.</li><li class="listitem">Select the <span class="strong"><strong>PropTrigger</strong></span> textbox and check out its <span class="strong"><strong>Add Prop</strong></span> component. First, populate<a class="indexterm" id="id797"/> the <span class="strong"><strong>Prop</strong></span> field with the <span class="strong"><strong>badge</strong></span> prefab. Then, populate <span class="strong"><strong>Target Bone</strong></span> with the <span class="strong"><strong>mixamorig:Spine2</strong></span> transform. Finally, assign the <span class="strong"><strong>Position</strong></span> and <span class="strong"><strong>Rotation</strong></span> values<a class="indexterm" id="id798"/> that we have previously made a note of to the <span class="strong"><strong>Position Offset</strong></span> and <span class="strong"><strong>Rotation Offset</strong></span> fields, respectively (<span class="strong"><strong>Position Offset</strong></span>: <span class="strong"><strong>X</strong></span>: <code class="literal">-0.08</code>, <span class="strong"><strong>Y</strong></span>: <code class="literal">0,</code> <span class="strong"><strong>Z</strong></span>: <code class="literal">0.15</code>; <span class="strong"><strong>Rotation Offset</strong></span>: <span class="strong"><strong>X</strong></span>: <code class="literal">0.29</code>, <span class="strong"><strong>Y</strong></span>: <code class="literal">0.14</code>, <span class="strong"><strong>Z</strong></span>:<code class="literal">-13.29</code>).<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_40.jpg"/></div></li><li class="listitem">Play the scene. Using the 'WASD' keyboard control scheme, direct the character to the<a class="indexterm" id="id799"/> <span class="strong"><strong>PropTrigger </strong></span>textbox. Colliding with it will add a badge to the character.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_41.jpg"/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec214"/>How it works...</h2></div></div></div><p>Once it's been triggered by the character, the script attached to <span class="strong"><strong>PropTrigger</strong></span> instantiates the assigned prefab, making it a child of the bones that they have been "placed into". The <span class="strong"><strong>Position Offset</strong></span> and <span class="strong"><strong>Rotation Offset</strong></span> can be used to fine-tune the exact position of the prop (relative to its<a class="indexterm" id="id800"/> parent transform). As the props become parented by the bones of the animated character, they will follow and respect its hierarchy and animation. Note that the script checks for the preexisting props of the same name<a class="indexterm" id="id801"/> before actually instantiating a new one.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec215"/>There's more...</h2></div></div></div><p>You can make a similar script to remove the props. In this case, the <code class="literal">OnTriggerEnter</code> function will contain only the following code:</p><div class="informalexample"><pre class="programlisting">if (targetBone.IsChildOf(collision.transform)){
   foreach(Transform child in targetBone){
      if (child.name == prop.name)
        Destroy (child.gameObject);
    }
}</pre></div></div></div>
<div class="section" title="Using Animation Events to throw an object"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec76"/>Using Animation Events to throw an object</h1></div></div></div><p>Now that <a class="indexterm" id="id802"/>your animated character is ready, you might want to coordinate some of her actions with her animation states. In this recipe, we will exemplify this by making the character throw an object whenever the appropriate animation clip reaches the right time. To do so, we will make<a class="indexterm" id="id803"/> use of <span class="strong"><strong>Animation Events</strong></span>, which basically trigger a function from the animation clip's timeline. This feature, recently introduced to the <span class="strong"><strong>Mecanim</strong></span> system, should<a class="indexterm" id="id804"/> feel familiar to those experienced with the<a class="indexterm" id="id805"/> <span class="strong"><strong>Add Event</strong></span> feature of <a class="indexterm" id="id806"/>the classic <span class="strong"><strong>Animation </strong></span>panel.</p><div class="mediaobject"><img alt="Using Animation Events to throw an object" src="graphics/1362OT_07_42.jpg"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec216"/>Getting ready</h2></div></div></div><p>For this recipe, we<a class="indexterm" id="id807"/> have prepared a Unity Package named <code class="literal">Throwing</code>, containing a basic scene that features an animated character and a prefab named <span class="strong"><strong>EasterEgg</strong></span>. The package can be found inside the <code class="literal">1362_07_07</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec217"/>How to do it...</h2></div></div></div><p>To make an animated character throw an Easter egg (!), follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new project and import the <code class="literal">Throwing</code> Unity Package. Then, from the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>mecanimPlayground</strong></span> level.</li><li class="listitem">Play the level and press <span class="emphasis"><em>F</em></span> on your keyboard. The character will move as if she is throwing something with her right hand.</li><li class="listitem"> From the <span class="strong"><strong>Project</strong></span> view, create a new <span class="strong"><strong>C# Script</strong></span> named <code class="literal">ThrowObject.cs.</code></li><li class="listitem">Open the script and add the following code:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class ThrowObject : MonoBehaviour {
  public GameObject prop;
  private GameObject proj;
  public Vector3 posOffset;
  public Vector3 force;
  public Transform hand;
  public float compensationYAngle = 0f;
    
  public void Prepare () {

    proj = Instantiate(prop, hand.position, hand.rotation) as GameObject;
    if(proj.GetComponent&lt;Rigidbody&gt;())
      Destroy(proj.GetComponent&lt;Rigidbody&gt;());
    proj.GetComponent&lt;SphereCollider&gt;().enabled = false;
    proj.name = "projectile";
    proj.transform.parent = hand;
    proj.transform.localPosition = posOffset;
    proj.transform.localEulerAngles = Vector3.zero;
  }

  public void Throw () {

    Vector3 dir = transform.rotation.eulerAngles;
    dir.y += compensationYAngle;
    proj.transform.rotation = Quaternion.Euler(dir);
    proj.transform.parent = null;
    proj.GetComponent&lt;SphereCollider&gt;().enabled = true;
    Rigidbody rig = proj.AddComponent&lt;Rigidbody&gt;();
    Collider projCollider = proj.GetComponent&lt;Collider&gt; ();
    Collider col = GetComponent&lt;Collider&gt; ();
    Physics.IgnoreCollision(projCollider, col);
    rig.AddRelativeForce(force);
  }
}</pre></div></li><li class="listitem">Save and close the script.</li><li class="listitem">Attach the <a class="indexterm" id="id808"/><span class="strong"><strong>ThrowObject.cs</strong></span> script to the character's GameObject named <span class="strong"><strong>MsLaser</strong></span>.</li><li class="listitem">Select the <span class="strong"><strong>MsLaser</strong></span> object. From the <span class="strong"><strong>Inspector</strong></span> view, check out its <span class="strong"><strong>Throw Object</strong></span> component. Then, populate the <span class="strong"><strong>Prop</strong></span> field with a prefab named <span class="strong"><strong>EasterEgg</strong></span>. Populate <span class="strong"><strong>Hand</strong></span> with <span class="strong"><strong>mixamorig:RightHand</strong></span>. Also, change <span class="strong"><strong>Pos Offset</strong></span> to <span class="strong"><strong>X</strong></span>: <code class="literal">0</code>; <span class="strong"><strong>Y</strong></span>: <code class="literal">0.07</code>; <span class="strong"><strong>Z</strong></span>: <code class="literal">0.04</code>. Finally, change <span class="strong"><strong>Force</strong></span> to <span class="strong"><strong>X</strong></span>: <code class="literal">0</code>; <span class="strong"><strong>Y</strong></span>: <code class="literal">200</code>; <span class="strong"><strong>Z</strong></span>: <code class="literal">500</code>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_43.jpg"/></div></li><li class="listitem">From the <span class="strong"><strong>Project</strong></span> view, select the <span class="strong"><strong>Swat@toss_grenade</strong></span> file. Then, from the <span class="strong"><strong>Inspector</strong></span><a class="indexterm" id="id809"/> view, access the <span class="strong"><strong>Animation</strong></span> section and scroll down to the <span class="strong"><strong>Events</strong></span> section.</li><li class="listitem">Expand the <span class="strong"><strong>Events</strong></span> section. Drag the playhead to approximately <span class="strong"><strong>0:17 (017.9%)</strong></span> of the animation timeline. Then, click on the button with the <span class="emphasis"><em>marker +</em></span> icon to add an<a class="indexterm" id="id810"/> <span class="strong"><strong>Animation Event</strong></span>. From the <span class="strong"><strong>Edit Animation Event</strong></span> window, set <span class="strong"><strong>Function</strong></span> as <code class="literal">Prepare</code>. Close the window.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_44.jpg"/></div></li><li class="listitem">Add a new animation event at approximately <span class="strong"><strong>1:24 (057.1%)</strong></span> of the animation timeline. This time, from the <span class="strong"><strong>Edit Animation Event</strong></span> window, set <span class="strong"><strong>Function</strong></span> as <code class="literal">Throw</code>. Close the window.</li><li class="listitem">Click on the <span class="strong"><strong>Apply</strong></span> button to save the changes.</li><li class="listitem">Play your scene. Your character will now be able to throw an Easter egg when you press the <span class="emphasis"><em>F </em></span>key.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec218"/>How it works...</h2></div></div></div><p>Once the <span class="strong"><strong>toss_grenade</strong></span> animation reaches the <a class="indexterm" id="id811"/>moments that we have set our <span class="strong"><strong>Events</strong></span> to, the <code class="literal">Prepare() </code>and<code class="literal"> throw()</code> functions are called. The former instantiates a prefab, now named <span class="strong"><strong>projectile</strong></span>, into the character's hand (<span class="strong"><strong>Projectile Offset</strong></span> values are used to fine-tune its position), also <a class="indexterm" id="id812"/>making it respect the character's hierarchy. Also, it disables the prefab's collider and destroys its <code class="literal">Rigidbody</code> component, provided it has one. The latter function enables the projectile's collider, and adds a <code class="literal">Rigidbody</code> component to it, making it independent from the character's hand. Finally, it adds a relative force to the projectile's <code class="literal">Rigidbody</code> component, so it will behave as if thrown by the character. The <span class="strong"><strong>Compensation YAngle</strong></span> can be used to adjust the direction of the grenade, if necessary.</p></div></div>
<div class="section" title="Applying Ragdoll physics to a character"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec77"/>Applying Ragdoll physics to a character</h1></div></div></div><p>Action games <a class="indexterm" id="id813"/>often make use of <span class="strong"><strong>Ragdoll physics </strong></span>to simulate the character's body reaction to being unconsciously under the effect of a hit or explosion. In this recipe, we will learn how to set up and activate Ragdoll physics to our <a class="indexterm" id="id814"/>character whenever she steps in a landmine object. We will also use the opportunity to reset the character's position and animations a number of seconds after that event has occurred.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec219"/>Getting ready</h2></div></div></div><p>For this recipe, we have prepared a Unity Package named <code class="literal">Ragdoll</code>, containing a basic scene that features an animated character and two prefabs, already placed into the scene, named <span class="strong"><strong>Landmine</strong></span> and <span class="strong"><strong>Spawnpoint</strong></span>. The package can be found inside the <code class="literal">1362_07_08</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec220"/>How to do it...</h2></div></div></div><p>To apply Ragdoll physics to your character, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new project and import the <code class="literal">Ragdoll</code> Unity Package. Then, from the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>mecanimPlayground</strong></span> level.</li><li class="listitem">You will see the animated MsLaser character and two discs: <span class="strong"><strong>Landmine</strong></span> and <span class="strong"><strong>Spawnpoint</strong></span>.</li><li class="listitem">First, let's set up our <a class="indexterm" id="id815"/><span class="strong"><strong>Ragdoll</strong></span>. Access the <span class="strong"><strong>GameObject</strong></span> | <span class="strong"><strong>3D Object</strong></span> | <span class="strong"><strong>Ragdoll...</strong></span> menu<a class="indexterm" id="id816"/> and the <span class="strong"><strong>Ragdoll wizard</strong></span> will<a class="indexterm" id="id817"/> pop-up.</li><li class="listitem">Assign the<a class="indexterm" id="id818"/> transforms as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Pelvis</strong></span>: mixamorig:Hips</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Left Hips</strong></span>: mixamorig:LeftUpLeg</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Left Knee</strong></span>: mixamorig:LeftLeg</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Left Foot</strong></span>: mixamorig:LeftFoot</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Right Hips</strong></span>: mixamorig:RightUpLeg</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Right Knee</strong></span>: mixamorig:RightLeg</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Right Foot</strong></span>: mixamorig:RightFoot</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Left Arm</strong></span>: mixamorig:LeftArm</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Left Elbow</strong></span>: mixamorig:LeftForeArm</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Right Arm</strong></span>: mixamorig:RightArm</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Right Elbow</strong></span>: mixamorig:RightForeArm</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Middle Spine</strong></span>: mixamorig:Spine1</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Head</strong></span>: mixamorig:Head</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Total Mass</strong></span>: 20</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Strength</strong></span>: 50</li></ul></div><div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_45.jpg"/></div></li><li class="listitem">From the <span class="strong"><strong>Project</strong></span> <a class="indexterm" id="id819"/>view, create a new <span class="strong"><strong>C# Script</strong></span> named <code class="literal">RagdollCharacter.cs</code>.</li><li class="listitem">Open the <a class="indexterm" id="id820"/>script and add the following code:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class RagdollCharacter : MonoBehaviour {

  void Start () {
      DeactivateRagdoll();
    }

    public void ActivateRagdoll(){
    gameObject.GetComponent&lt;CharacterController&gt; ().enabled = false;
    gameObject.GetComponent&lt;BasicController&gt; ().enabled = false;
    gameObject.GetComponent&lt;Animator&gt; ().enabled = false;
    foreach (Rigidbody bone in GetComponentsInChildren&lt;Rigidbody&gt;()) {
        bone.isKinematic = false;
        bone.detectCollisions = true;
    }
    foreach (Collider col in GetComponentsInChildren&lt;Collider&gt;()) {
        col.enabled = true;
    }
    StartCoroutine (Restore ());

    }
  public void DeactivateRagdoll(){

    gameObject.GetComponent&lt;BasicController&gt;().enabled = true;
    gameObject.GetComponent&lt;Animator&gt;().enabled = true;
    transform.position = GameObject.Find("Spawnpoint").transform.position;
    transform.rotation = GameObject.Find("Spawnpoint").transform.rotation;
    foreach(Rigidbody bone in GetComponentsInChildren&lt;Rigidbody&gt;()){
        bone.isKinematic = true;
          bone.detectCollisions = false;
      }
    foreach (CharacterJoint joint in GetComponentsInChildren&lt;CharacterJoint&gt;()) {
      joint.enableProjection = true;
    }
    foreach(Collider col in GetComponentsInChildren&lt;Collider&gt;()){
      col.enabled = false;
    }
  gameObject.GetComponent&lt;CharacterController&gt;().enabled= true;

    }

  IEnumerator Restore(){
    yield return new WaitForSeconds(5);
    DeactivateRagdoll();
  }
}</pre></div></li><li class="listitem">Save and close the script.</li><li class="listitem">Attach the <span class="strong"><strong>RagdollCharacter.cs</strong></span> script to the <span class="strong"><strong>MsLaser</strong></span> GameObject. Then, select the <span class="strong"><strong>MsLaser</strong></span> character and, from the top of the <span class="strong"><strong>Inspector</strong></span> view, change its tag to <span class="strong"><strong>Player</strong></span>.</li><li class="listitem">From the <span class="strong"><strong>Project</strong></span> view, create<a class="indexterm" id="id821"/> a new <span class="strong"><strong>C# Script</strong></span> named <code class="literal">Landmine.cs</code>.</li><li class="listitem">Open the script <a class="indexterm" id="id822"/>and add the following code:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class Landmine : MonoBehaviour {
  public float range = 2f;
  public float force = 2f;
  public float up = 4f;
  private bool active = true;

  void  OnTriggerEnter ( Collider collision  ){
    if(collision.gameObject.tag == "Player" &amp;&amp; active){
      active = false;
      StartCoroutine(Reactivate());
      collision.gameObject.GetComponent&lt;RagdollCharacter&gt;().ActivateRagdoll();
      Vector3 explosionPos = transform.position;
            Collider[] colliders = Physics.OverlapSphere(explosionPos, range);
          foreach (Collider hit in colliders) {
        if (hit.GetComponent&lt;Rigidbody&gt;())
                  hit.GetComponent&lt;Rigidbody&gt;().AddExplosionForce(force, explosionPos, range, up);
             }
        }
    }
  IEnumerator Reactivate(){
    yield return new WaitForSeconds(2);
    active = true;
  }
}</pre></div></li><li class="listitem">Save and close the script.</li><li class="listitem">Attach the script to the <span class="strong"><strong>Landmine</strong></span> GameObject.</li><li class="listitem">Play the scene. Using the <span class="emphasis"><em>WASD</em></span> keyboard control scheme, direct the character to the <span class="strong"><strong>Landmine</strong></span> GameObject. Colliding with it will activate the character's Ragdoll physics and apply an explosion force to it. As a result, the character will be thrown away to a considerable distance and will no longer be in the control<a class="indexterm" id="id823"/> of its body movements, akin to a ragdoll.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec221"/>How it works...</h2></div></div></div><p>Unity's <span class="strong"><strong>Ragdoll Wizard</strong></span> assigns, to <a class="indexterm" id="id824"/>selected transforms, the components <code class="literal">Collider</code>, <code class="literal">Rigidbody</code>, and <code class="literal">Character Joint</code>. In conjunction, those components make Ragdoll physics possible. However, those components must be disabled whenever we want our character to be <a class="indexterm" id="id825"/>animated and controlled by the player. In our case, we switch those components on and off using the <code class="literal">RagdollCharacter</code> script and its two functions: <code class="literal">ActivateRagdoll()</code> and <code class="literal">DeactivateRagdoll()</code>, the latter includes instructions to re-spawn our character in the appropriate place.</p><p>For the testing purposes, we have also created the <code class="literal">Landmine</code> script, which calls <code class="literal">RagdollCharacter</code> script's function named <code class="literal">ActivateRagdoll()</code>. It also applies an explosion force to our ragdoll character, throwing it outside the explosion site.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec222"/>There's more...</h2></div></div></div><p>Instead of resetting the character's transform settings, you could have destroyed its GameObject and instantiated a new one<a class="indexterm" id="id826"/> over the respawn point using <span class="strong"><strong>Tags</strong></span>. For more information<a class="indexterm" id="id827"/> on this subject, check Unity's documentation at <a class="ulink" href="http://docs.unity3d.com/ScriptReference/GameObject.FindGameObjectsWithTag.html">http://docs.unity3d.com/ScriptReference/GameObject.FindGameObjectsWithTag.html</a>.</p></div></div>
<div class="section" title="Rotating the character's torso to aim a weapon"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec78"/>Rotating the character's torso to aim a weapon</h1></div></div></div><p>When playing a<a class="indexterm" id="id828"/> third-person character, you might want her to aim her weapon at some target that is not directly in front of her, without making her change her direction. In these <a class="indexterm" id="id829"/>cases, you will need to apply what is called a <span class="emphasis"><em>procedural animation</em></span>, which does not rely on premade animation clips, but rather on the processing of other data, such as player input, to animate the character. In this recipe, we will use this technique to rotate the character's spine by moving the mouse, allowing for adjustments in the character's aim. We will also use this opportunity to cast a ray from the character's weapon and display a crosshair over the nearest object on target. Please note that this approach will work with the cameras standing behind the third-person controlled characters.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec223"/>Getting ready</h2></div></div></div><p>For this recipe, we have prepared a Unity Package named <code class="literal">AimPointer</code>, containing a basic scene that features a character armed with a laser pointer. The package, which also includes the <code class="literal">crossAim</code> sprite that is to be used as a crosshair for aiming, can be found inside the <code class="literal">1362_07_09</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec224"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new<a class="indexterm" id="id830"/> project and import the <code class="literal">AimPointer</code> Unity Package. Then, from the <span class="strong"><strong>Project</strong></span> view, open the <span class="strong"><strong>mecanimPlayground</strong></span> level. You will see an animated character named <span class="strong"><strong>MsLaser</strong></span> holding the <span class="strong"><strong>pointerPrefab</strong></span> object.</li><li class="listitem">From the <span class="strong"><strong>Project</strong></span> view, create a new <span class="strong"><strong>C# Script</strong></span> named <code class="literal">MouseAim.cs</code>.</li><li class="listitem">Open the script and<a class="indexterm" id="id831"/> add the following code:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class MouseAim : MonoBehaviour {
  
  public Transform spine;
  private float xAxis = 0f;
  private float yAxis = 0f;
  public Vector2 xLimit = new Vector2(-30f,30f);
  public Vector2 yLimit= new Vector2(-30f,30f);
  public Transform weapon;
  public GameObject crosshair;
  private Vector2 aimLoc;

  public void LateUpdate(){

    yAxis += Input.GetAxis ("Mouse X");
    yAxis = Mathf.Clamp (yAxis, yLimit.x, yLimit.y);
    xAxis -= Input.GetAxis ("Mouse Y");
    xAxis = Mathf.Clamp (xAxis, xLimit.x, xLimit.y);
    Vector3 corr = new Vector3(xAxis,yAxis, spine.localEulerAngles.z);
    spine.localEulerAngles = corr;
    RaycastHit hit;
    Vector3 fwd = weapon.TransformDirection(Vector3.forward);
    if (Physics.Raycast (weapon.position, fwd, out hit)) {
      print (hit.transform.gameObject.name);
      aimLoc =  Camera.main.WorldToScreenPoint(hit.point);
      crosshair.SetActive(true);
      crosshair.transform.position = aimLoc;
    } else {
     crosshair.SetActive(false);
    }
    Debug.DrawRay (weapon.position, fwd, Color.red);
  }
}</pre></div></li><li class="listitem">Save and close the script.</li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, create a new <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Image</strong></span> GameObject. Then, from the <span class="strong"><strong>Inspector</strong></span> <a class="indexterm" id="id832"/>view, change its name to <code class="literal">crosshair</code>. Also, in <span class="strong"><strong>Rect</strong></span><a class="indexterm" id="id833"/><span class="strong"><strong> Transform</strong></span>, set its <span class="strong"><strong>Width</strong></span> and <span class="strong"><strong>Height</strong></span> to <code class="literal">16</code> and populate <span class="strong"><strong>Source Image</strong></span> field with the <span class="strong"><strong>crossAim</strong></span> sprite.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_46.jpg"/></div></li><li class="listitem">Attach<a class="indexterm" id="id834"/> the <span class="strong"><strong>MouseAim.cs</strong></span> <a class="indexterm" id="id835"/>script to the <span class="strong"><strong>MsLaser</strong></span> GameObject.</li><li class="listitem">Select the <span class="strong"><strong>MsLaser</strong></span> GameObject and from the <span class="strong"><strong>Inspector</strong></span> view's <span class="strong"><strong>Mouse Aim</strong></span> component, populate the <span class="strong"><strong>Spine</strong></span> field with <span class="strong"><strong>mixamorig:Spine</strong></span>; the <span class="strong"><strong>Weapon</strong></span> field with <span class="strong"><strong>pointerPrefab</strong></span>; and the <span class="strong"><strong>Crosshair</strong></span> field with the <span class="strong"><strong>crosshair</strong></span> UI GameObject.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_47.jpg"/></div></li><li class="listitem">Play the scene. You<a class="indexterm" id="id836"/> will now be able to rotate the character's torso by moving the mouse. Even<a class="indexterm" id="id837"/> better, the crosshair GUI texture will be displayed at the top of the object that is being aimed at by the pointer.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_07_48.jpg"/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec225"/>How it works...</h2></div></div></div><p>You might have noticed that all the code for rotating the character's spine is inside the <code class="literal">LateUpdate</code> function, as opposed to the more common <code class="literal">Update</code> function. The reason for this is to make sure that all the transform manipulation will be executed after the original animation clip is played, overriding it.</p><p>Regarding the spine rotation, our script adds the horizontal and vertical speed of the mouse to the <code class="literal">xAxis</code> and <code class="literal">yAxis</code> float variables. These variables are then constrained within the specified limits, avoiding distortions to the character's model. Finally, the <code class="literal">spine</code> object transform rotation for <span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>y</em></span> axes are set to <code class="literal">xAxis</code> and <code class="literal">yAxis</code> respectively. The <span class="emphasis"><em>z</em></span>-axis<a class="indexterm" id="id838"/> is preserved from the original animation clip.</p><p>Additionally, our<a class="indexterm" id="id839"/> script uses a <code class="literal">Raycast</code> command to detect if there is any object's collider within the weapon's aim, in which case a crosshair will be drawn on the screen.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec226"/>There's more...</h2></div></div></div><p>Since this recipe's script was tailored for cameras standing behind the third-person controlled characters, we have included a more generic solution to the problem—in fact, a similar approach to the one presented in <span class="emphasis"><em>Unity 4.x Cookbook</em></span>, <span class="emphasis"><em>Packt Publishing</em></span>. An alternate script named <code class="literal">MouseAimLokkAt</code>, which can be found inside the <code class="literal">1362_07_09</code> folder, starts by converting our bi-dimensional mouse cursor screen's coordinates to the three-dimensional world space coordinates (stored in a <code class="literal">point</code> variable). Then, it rotates the character's torso towards the <span class="emphasis"><em>point</em></span> location, using the <code class="literal">LookAt()</code> command to do so. Additionally, it makes sure that the spine does not extrapolate <code class="literal">minY</code> and <code class="literal">maxY</code> angles, otherwise causing distortions to the character model. Also, we have included a <code class="literal">Compensation YAngle</code> variable that makes it possible for us to fine-tune the character's alignment with the mouse cursor. Another addition is the option to freeze the X-axis rotation, in case you just want the character to rotate the torso laterally, but not look up or down. Again, this script uses a <code class="literal">Raycast</code> command to detect objects in front of the weapon's aim, drawing a crosshair on the screen when they are present.</p></div></div></body></html>