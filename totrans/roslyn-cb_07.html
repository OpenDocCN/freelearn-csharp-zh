<html><head></head><body>
        

                            
                    <h1 class="header-title">C# Interactive and Scripting</h1>
                
            
            
                
<p>In this chapter, we will cover the following recipes:</p>
<ul>
<li>Writing a simple C# script and evaluating it within the Visual Studio interactive window</li>
<li>Using script directives and REPL commands in the C# interactive window</li>
<li>Using keyboard shortcuts for evaluating and navigating through script sessions in the C# interactive window</li>
<li>Initializing a C# interactive session from an existing C# project</li>
<li>Executing a C# script on a Visual Studio developer command prompt using <kbd>csi.exe</kbd></li>
<li>Using the Roslyn scripting API to execute C# code snippets</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Introduction</h1>
                
            
            
                
<p>This chapter gives a basic introduction to one of the most powerful features/tools based on the Roslyn compiler API: <strong>C# interactive and scripting.</strong> You can read an overview about C# scripting at <a href="https://msdn.microsoft.com/en-us/magazine/mt614271.aspx">https://msdn.microsoft.com/en-us/magazine/mt614271.aspx</a>. Here is a small gist of this feature from the preceding article:</p>
<p>C# scripting is a tool for testing out your C# and .NET snippets without the effort of creating multiple unit testing or console projects. It provides an easy means to explore and understand an API without the overhead of a yet another <kbd>CSPROJ</kbd> file in your <kbd>%TEMP%</kbd> directory. The C# read-evaluate-print-loop (REPL) is available as an interactive window within Visual Studio 2015 and after and as a new command-line interface (CLI) called CSI.</p>
<p>Here is a screenshot of the C# interactive window in Visual Studio:</p>
<div><img class="image-border" height="279" src="img/eae90547-838c-4402-89ae-f66ac39072c0.png" width="955"/></div>
<p>The following is a screenshot of the C# interactive command-line interface (<kbd>csi.exe</kbd>) executed from a Visual Studio 2017 developer command prompt:</p>
<div><img class="image-border" height="238" src="img/bb41acbf-d61f-4a28-a65e-2ee2dd022322.png" width="951"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title">Writing a simple C# script and evaluating it within the Visual Studio interactive window</h1>
                
            
            
                
<p>In this section, we will walk you through the basics of C# scripting and show you how to use the Visual Studio interactive window to evaluate a C# script.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting started</h1>
                
            
            
                
<p>You will need to have Visual Studio 2017 Community edition installed on your machine to execute this recipe. You can install a free community edition from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15</a></p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Open Visual Studio and start the C# Interactive window by clicking on View | Other Windows | C# Interactive:</li>
</ol>
<div><img class="image-border" height="255" src="img/ee52c0cc-4925-43f6-8040-2c3cece4c648.png" width="876"/></div>
<ol start="2">
<li>Type <kbd>Console.WriteLine("Hello, World!")</kbd> in the interactive window and hit the <em>Enter</em> key to evaluate the C# expression.</li>
<li>Verify that <kbd>Hello, World!</kbd> is output as a result in the interactive window:</li>
</ol>
<div><img class="image-border" height="161" src="img/e6ac3c5f-ea5d-4e64-b429-9780f12769af.png" width="874"/></div>
<ol start="4">
<li>Now, type a variable declaration statement of type <kbd>List&lt;int&gt;</kbd> with a collection initializer: <kbd>var myList = new List&lt;int&gt; { 3, 2, 7, 4, 9, 0 };</kbd> and press the <em>Enter</em> key.</li>
<li>Next, type an expression statement that accesses the <kbd>myList</kbd> variable declared in the previous statement and filter the list to all the even numbers in the list using a linq expression: <kbd>myList.Where(x =&gt; x % 2 == 0)</kbd>.</li>
<li>Press the <em>Enter</em> key to evaluate the expression and verify that a nicely formatted enumerable list is output as the result of the evaluation: <kbd>Enumerable.WhereListIterator&lt;int&gt; { 2, 4, 0 }</kbd>.</li>
<li>Type the command <kbd>$"The current directory is { Environment.CurrentDirectory }."</kbd>. This accesses the current directory environment variable and verifies your current directory output.</li>
<li>Now, type the following commands into the interactive window and verify that pressing the <em>Enter</em> key leads to a 10-second UI delay as per the entered <kbd>await</kbd> expression:</li>
</ol>
<pre style="padding-left: 90px">
&gt; using System.Threading.Tasks;<br/>&gt; await Task.Delay(10000)<br/>&gt;
</pre>
<ol start="9">
<li>Type the following class declaration in the interactive window and press the <em>Enter</em> key:</li>
</ol>
<pre style="padding-left: 90px">
class C<br/>{<br/>  public void M()<br/>  {<br/>    Console.WriteLine("C.M invoked");<br/>  }<br/>}
</pre>
<ol start="10">
<li>Instantiate type <kbd>C</kbd> declared earlier and invoke method <kbd>M</kbd> on the instance by evaluating the following statement: <kbd>new C().M();</kbd>.</li>
<li>Verify that the output in the interactive window is: <kbd>C.M invoked</kbd>.</li>
</ol>
<p>You can view the entire contents of the interactive window for this recipe in the attached text file <kbd>InteractiveWindowOutput.txt</kbd>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>In this recipe, we wrote a simple set of C# interactive script commands to perform a bunch of operations that are common in regular C# code, but without having to declare a stub type/main method or having to create a source file/project. The operations performed during the interactive session were:</p>
<ol>
<li>Evaluating an expression that outputs a string to the console (<kbd>Console.WriteLine(...)</kbd>).</li>
<li>Declaring a local variable for the lifetime of the interactive session and initialize it with a collection <kbd>initializer (myList)</kbd>.</li>
<li>Accessing the preceding declared variable in a subsequent linq statement and evaluating the resultant value (<kbd>myList.Where(...)</kbd>).</li>
</ol>
<ol start="4">
<li>Accessing environment variables in C# expression evaluations (<kbd>Environment.CurrentDirectory</kbd>).</li>
<li>Importing namespace in the session through a using declaration (<kbd>using System.Threading.Tasks;</kbd>).</li>
<li>Awaiting an async expression (<kbd>await Task.Delay(10000)</kbd>).</li>
<li>Declaring a C# class with a method (<kbd>class C</kbd> and <kbd>method M</kbd>) for the lifetime of the interactive session.</li>
<li>Instantiating the preceding declared class and invoking the method in a subsequent statement (<kbd>new C().M()</kbd>).</li>
</ol>
<p>Let's briefly walk through the implementation of the C# interactive compiler that enables all the preceding regular C# operations in the interactive mode.</p>
<p><kbd>Csi.main</kbd> (<a href="http://source.roslyn.io/#csi/Csi.cs,14">http://source.roslyn.io/#csi/Csi.cs,14</a>) is the primary entry point into the C# interactive compiler. After initialization of the compiler, the control eventually reaches <kbd>CommandLineRunner.RunInteractiveLoop</kbd> (<a href="http://source.roslyn.io/#Microsoft.CodeAnalysis.Scripting/Hosting/CommandLine/CommandLineRunner.cs,7c8c5cedadd34d79">http://source.roslyn.io/#Microsoft.CodeAnalysis.Scripting/Hosting/CommandLine/CommandLineRunner.cs,7c8c5cedadd34d79</a>), which is, the REPL, or read-evaluate-print-loop, that reads interactive commands and evaluates them in a loop until the user exits by pressing <em>Ctrl</em> + <em>C</em>.</p>
<p>For each entered line, the REPL loop executes <kbd>ScriptCompiler.ParseSubmission</kbd> (<a href="http://source.roslyn.io/#Microsoft.CodeAnalysis.Scripting/ScriptCompiler.cs,54b12302e519f660">http://source.roslyn.io/#Microsoft.CodeAnalysis.Scripting/ScriptCompiler.cs,54b12302e519f660</a>) to parse the given source text into a syntax tree. If the submission is incomplete (for example, if the first line of a class declaration has been entered), then it outputs <kbd>.</kbd> and continues waiting for more text for the submission. Otherwise, it creates a script using the current submission text chained to the end of the prior submissions and runs the new submission by invoking into the core C# compiler APIs. The result of the submission is output to the interactive window.</p>
<p>Further details on how the submission chains to the prior submissions and executes within the interactive compiler are out of the scope of this chapter. You may navigate the script compiler's code base at (<a href="http://source.roslyn.io/#q=RunSubmissionsAsync">http://source.roslyn.io/#q=RunSubmissionsAsync</a>) to understand the internal workings.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Using script directives and REPL commands in the C# interactive window</h1>
                
            
            
                
<p>In this section, we will walk you through the common directives and REPL commands available in C# interactive scripting and show you how to use them in the Visual Studio interactive window.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting started</h1>
                
            
            
                
<p>You will need to have the Visual Studio 2017 Community edition installed on your machine to execute this recipe. You can install a free community edition from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15</a>.<a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15"/></p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Open Visual Studio and start the C# Interactive window by clicking on View | Other Windows | C# Interactive.</li>
<li>Copy <kbd>Newtonsoft.Json.dll</kbd> from the attached sample for the recipe into your temp directory <kbd>%TEMP%</kbd>.</li>
<li>Execute the following <kbd>#r</kbd> directive to load this assembly into the interactive session:</li>
</ol>
<pre style="padding-left: 90px">
<strong>#r "&lt;%YOUR_TEMP_DIRECTORY%&gt;\Newtonsoft.Json.dll"</strong>
</pre>
<ol start="4">
<li>Verify that you can now reference types from this assembly as well as create objects and invoke methods. For example, type the following code snippet into the interactive window:</li>
</ol>
<pre style="padding-left: 90px">
using Newtonsoft.Json.Linq;<br/>JArray array = new JArray();<br/>array.Add("Manual text");<br/>array.Add(new DateTime(2000, 5, 23));<br/><br/>JObject o = new JObject();<br/>o["MyArray"] = array;<br/><br/>o.ToString()
</pre>
<ol start="5">
<li>Verify the string representation of the array that is the output to the interactive window:</li>
</ol>
<div><img class="image-border" height="344" src="img/273b2757-5621-4487-85df-5361864399e7.png" width="852"/></div>
<ol start="6">
<li>Execute the REPL command <kbd>#clear</kbd> (or <kbd>#cls</kbd>) and verify this clears all the text from the interactive window.</li>
<li>Copy <kbd>MyScript.csx</kbd> from the attached sample for the recipe into your temp directory <kbd>%TEMP%</kbd>.</li>
<li>Execute the following <kbd>#load</kbd> directive to load and execute this script in the interactive session:</li>
</ol>
<pre style="padding-left: 90px">
<strong>#load "&lt;%YOUR_TEMP_DIRECTORY%&gt;\MyScript.csx"</strong>
</pre>
<ol start="9">
<li>Verify that the script executes, and you get the following output from the execution:</li>
</ol>
<div><img class="image-border" height="143" src="img/36cbf5c2-5ef2-4ec4-b1fd-352b8a8e597c.png" width="847"/></div>
<ol start="10">
<li>Execute the <kbd>#reset</kbd> REPL command to reset the interactive session.</li>
</ol>
<ol start="11">
<li>Now, attempt to refer to the <kbd>Newtonsoft.Json</kbd> namespace in the interactive session, which was added prior to the reset, and verify that you get an error, as the assembly is no longer loaded in the session:</li>
</ol>
<div><img class="image-border" height="165" src="img/882c3609-67a6-48b6-889e-17da609bed02.png" width="849"/></div>
<ol start="12">
<li>Finally, execute the <kbd>#help</kbd> REPL command to print the help text for available keyboard shortcuts, directives, and REPL commands in the interactive window:</li>
</ol>
<div><img class="image-border" height="370" src="img/b894f5a4-4f72-43e5-9bee-9a9d579e48ed.png" width="844"/></div>
<p>You can view the entire contents of the interactive window for this recipe in the attached text file <kbd>InteractiveWindowOutput.txt</kbd>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Using keyboard shortcuts for evaluating and navigating through script sessions in the C# interactive window</h1>
                
            
            
                
<p>In this section, we will walk you through the common keyboard shortcuts available in C# interactive scripting and show you how to use them in the Visual Studio interactive window.</p>
<p>As demonstrated in the last step of the previous recipe, you can use the <em>#help</em> REPL command in the interactive window to see the entire list of keyboard shortcuts available in the C# interactive window.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting started</h1>
                
            
            
                
<p>You will need to have the Visual Studio 2017 Community edition installed on your machine to execute this recipe. You can install a free community edition from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15.</a></p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Open Visual Studio and open the C# Interactive window by clicking on View| Other Windows | C# Interactive<em>.</em></li>
<li>Type the string constant <kbd>"World!"</kbd> and hit the <em>Enter</em> key to evaluate and output the string.</li>
<li>Type <kbd>"Hello, " +</kbd> and move the cursor to the previous submission from the step 2, and hit the <em>Ctrl</em> + <em>Enter</em> keys to append the text from the previous submission to the current submission. The current submission text should change to <kbd>"Hello, " + "World!"</kbd>, and pressing the <em>Enter</em> key should output the text <kbd>"Hello, World!"</kbd>.</li>
</ol>
<ol start="4">
<li>Type <kbd>@"Hello, World</kbd> and press the <em>Shift</em> + <em>Enter</em> keys to add a new line within the current submission. Typing <kbd>with a new line!"</kbd> on the next line and hitting the <em>Enter</em> key should output the text <kbd>"Hello, World\r\nwith a new line!"</kbd>, as shown here:</li>
</ol>
<div><img class="image-border" height="255" src="img/1fefa632-013e-4858-b970-b4d91bb1d6da.png" width="844"/></div>
<ol start="5">
<li>Type <kbd>Hello</kbd> and press the <em>Esc</em> key; this should clear the text on the current line.</li>
<li>Press the <em>Alt</em> + Up arrow keys together; this should change the current submission text to be the same as the previous submission, in our case, <kbd>@"Hello, World</kbd><br/>
<kbd>. with a new line!"</kbd>.</li>
<li>Press the <em>Enter</em> key to output <kbd>"Hello, World\r\nwith a new line!"</kbd> again.</li>
<li>Press the quote key <em>"</em>. This should automatically add another quote for the string. Press the <em>Delete</em> key to remove this automatically and add the second quote.</li>
<li>Now, press the <em>Ctrl</em> + <em>Alt</em> + Up arrow keys together; this should change the current submission text to be the same as the last among the previous submissions that started with the same character, that is, <em>"</em>. In our case, this was the submission <kbd>"Hello, " + "World!"</kbd>.</li>
<li>Press the <em>Enter</em> key to output <kbd>"Hello, World!"</kbd>.</li>
<li>Now, place the cursor on our very first submission in the session, that is, the submission at step 2.</li>
<li>Press the <em>Ctrl</em> + <em>A</em> keys together to select the entire text in the first submission, that is, <kbd>"World!"</kbd>. Then, press the <em>Ctrl</em> + <em>Enter</em> keys together to copy this text into the current submission.</li>
<li>Press the <em>Enter</em> key to output <kbd>"World!"</kbd>.</li>
<li>Place the cursor back on the previous submission and press the <em>Ctrl</em> + <em>A</em> keys twice to select the entire contents of the interactive window.</li>
</ol>
<p>You can view the entire contents of the interactive window for this recipe in the attached text file <kbd>InteractiveWindowOutput.txt</kbd>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Initializing the C# interactive session from the existing C# project</h1>
                
            
            
                
<p>In this section, we will walk you through the steps to initialize a C# interactive scripting session from an existing C# project and then use the types from the project in the Visual Studio interactive window.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting started</h1>
                
            
            
                
<p>You will need to have Visual Studio 2017 Community edition installed on your machine to execute this recipe. You can install a free community edition from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15.</a></p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Open Visual Studio and start the C# Interactive window by clicking on View | Other Windows | C# Interactive.</li>
<li>Declare a local variable <kbd>int x = 0;</kbd> in the interactive window and press the <em>Enter</em> key.</li>
<li>Execute <kbd>Console.WriteLine(x)</kbd> and verify the output <kbd>0</kbd> to confirm that the variable <kbd>x</kbd> is declared in the current session.</li>
<li>Create a new C# class library project, say <kbd>ClassLibrary</kbd>.</li>
<li>Add the following method <kbd>M</kbd> to type <kbd>Class1</kbd> in the created project:</li>
</ol>
<pre style="padding-left: 90px">
public void M()<br/>{<br/>  Console.WriteLine("Executing ClassLibrary.Class1.M()");<br/>}
</pre>
<ol start="6">
<li>Right-click on the project in the solution explorer and click on Initialize Interactive with Project:</li>
</ol>
<div><img class="image-border" height="586" src="img/3948a6dd-e7ba-442c-a196-020065aa464a.png" width="389"/></div>
<ol start="7">
<li>Verify that the project build has started, and that the C# interactive session has been reset with the project references and output assembly (<kbd>ClassLibrary.dll</kbd>):</li>
</ol>
<div><img class="image-border" height="407" src="img/b9b1a12d-5e11-4ecf-8cfa-c559885de8ad.png" width="778"/></div>
<ol start="8">
<li>Type the following text <kbd>new Class1().M();</kbd> in the interactive window and press the <em>Enter</em> key to execute the submission.</li>
<li>Verify that <kbd>Executing ClassLibrary.Class1.M()</kbd> is output as a result, confirming that the interactive session was initialized with the <kbd>ClassLibrary</kbd> project.</li>
<li>Attempt to reference the variable <em>x</em> that was defined in step2, that is, prior to initializing the interactive session with the project by executing <kbd>Console.WriteLine(x);</kbd>.</li>
<li>Verify that this leads to the following compile time error, confirming that the session state was completely reset when we initialized it from the project:</li>
</ol>
<pre style="padding-left: 90px">
<strong>&gt; Console.WriteLine(x);</strong><br/><strong>(1,19): error CS0103: The name 'x' does not exist in the current context</strong>
</pre>
<p>You can view the entire contents of the interactive window for this recipe in the attached text file <kbd>InteractiveWindowOutput.txt</kbd>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Executing the C# script on a Visual Studio developer command prompt using csi.exe</h1>
                
            
            
                
<p>In this section, we will show you how to use the command-line interface for executing C# scripts and their interactive mode. <kbd>csi.exe</kbd> (CSharp Interactive) is the CLI executable for C# interactive that ships with the C# compiler toolset, along with Visual Studio.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting started</h1>
                
            
            
                
<p>You will need to have the Visual Studio 2017 Community edition installed on your machine to execute this recipe. You can install a free community edition from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Start the Visual Studio 2017 develop command prompt and execute the command <kbd>csi.exe</kbd> to start the C# interactive session<em>.</em></li>
<li>Type <kbd>Console.WriteLine("Hello, World!")</kbd> on the console and click on the <em>Enter</em> key to execute the command in interactive mode:</li>
</ol>
<div><img class="image-border" height="205" src="img/c7852ad9-4c20-4356-b701-d9c5e7528d17.png" width="778"/></div>
<ol start="3">
<li>Press <em>Ctrl</em> + <em>C</em> to exit the interactive mode.</li>
<li>Create a script file <kbd>MyScript.csx</kbd> with the following code to output the arguments to the script:</li>
</ol>
<pre style="padding-left: 90px">
var t = System.Environment.GetCommandLineArgs();<br/><br/>foreach (var i in t)<br/>{<br/>  System.Console.WriteLine(i);<br/>}
</pre>
<ol start="5">
<li>Execute the script with arguments <kbd>1 2 3</kbd> and verify the following output. Also, note that after executing the script, we return back to the command prompt, not the interactive session:</li>
</ol>
<pre style="padding-left: 90px">
<strong>c:\&gt;csi MyScript.csx 1 2 3</strong><br/><strong>csi</strong><br/><strong>MyScript.csx</strong><br/><strong>1</strong><br/><strong>2</strong><br/><strong>3</strong>
</pre>
<ol start="6">
<li>Now, execute the same script with an additional <kbd>-i</kbd> argument prepended and verify the same output as earlier, this time however, we return to an interactive prompt:</li>
</ol>
<pre style="padding-left: 90px">
<strong>c:\&gt;csi -i MyScript.csx 1 2 3</strong><br/><strong>csi</strong><br/><strong>-i</strong><br/><strong>MyScript.csx</strong><br/><strong>1</strong><br/><strong>2</strong><br/><strong>3</strong><br/><strong>&gt;</strong>
</pre>
<ol start="7">
<li>Execute <kbd>Console.WriteLine(t.Length)</kbd> and verify that the output is <kbd>6</kbd>, confirming that the variable <em>t</em> declared in the script and initialized with the command-line arguments is still alive in the current interactive session.</li>
<li>Press <em>Ctrl</em> + <em>C</em> to exit the interactive mode.</li>
</ol>
<ol start="9">
<li>Execute <kbd>csi -i</kbd> to start <kbd>csi.exe</kbd> in interactive mode and execute the <em>#help</em> command to get the list of available keyboard shortcuts, REPL commands, and script directives:</li>
</ol>
<div><img class="image-border" height="438" src="img/24dd68e6-500d-48ba-be68-2ef98b2a8a9b.png" width="799"/></div>
<ol start="10">
<li>Note that the set of available keyboard shortcuts, REPL commands, and script directives in <kbd>csi.exe</kbd> is a subset of the corresponding sets in the Visual Studio interactive window. Refer to the earlier recipes <em>Using script directives and REPL commands in the C# interactive window</em> and <em>Using keyboard shortcuts for evaluating and navigating through script sessions in the C# interactive window</em>, in this chapter for available shortcuts, commands, and directives in the Visual Studio interactive window.</li>
<li>Press <em>Ctrl</em> + <em>C</em> to exit the interactive mode.</li>
<li>Attempt to execute <kbd>csi.exe</kbd> with arguments, but no script name, and verify error <em>CS2001</em> about missing source file:</li>
</ol>
<pre style="padding-left: 90px">
<strong>c:\&gt;csi.exe 1</strong><br/><strong>error CS2001: Source file 'c:\1' could not be found.</strong>
</pre>
<div><p>You can read more about the command-line REPL and the arguments to <kbd>csi.exe</kbd> at <a href="https://github.com/dotnet/roslyn/wiki/Interactive-Window#repl">https://github.com/dotnet/roslyn/wiki/Interactive-Window#repl</a>.</p>
</div>


            

            
        
    

        

                            
                    <h1 class="header-title">Using the Roslyn scripting API to execute C# code snippets</h1>
                
            
            
                
<p>In this section, we will show you how to to write a C# console application that uses Roslyn scripting APIs to execute C# code snippets and consume their output. The scripting APIs enable .NET applications to instantiate a C# engine and execute code snippets against host-supplied objects. The scripting APIs can also be used directly in an interactive session.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting started</h1>
                
            
            
                
<p>You will need to have the Visual Studio 2017 Community edition installed on your machine to execute this recipe. You can install a free community edition from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Open Visual Studio and create a new C# console application targeting .NET Framework 4.6 or higher, say <kbd>ConsoleApp</kbd><em>.</em></li>
<li>Install the <kbd>Microsoft.CodeAnalysis.CSharp.Scripting</kbd> NuGet package (at the time of writing, the latest stable version is <em>2.1.0</em>). For guidance on how to search for and install the NuGet package to a project, refer to the recipe, <em>Searching and installing analyzers through the NuGet package manager</em> in <a href="8e0229af-657f-4306-96b5-40511d1fe7b2.xhtml">Chapter 2</a>, <em>Consuming Diagnostic Analyzers in .NET Projects</em>.</li>
<li>Replace the source code in <kbd>Program.cs</kbd> with the source code from the attached code sample <kbd>\ConsoleApp\Program.cs.</kbd></li>
<li>Press <em>Ctrl</em> + <em>F5</em> to build and start the project <kbd>.exe</kbd> without debugging.</li>
<li>Verify the first output from the evaluation of <kbd>EvaluateSimpleAsync</kbd><em>:</em></li>
</ol>
<pre style="padding-left: 90px">
<strong>Executing EvaluateSimpleAsync...</strong><br/><strong>3</strong>
</pre>
<ol start="6">
<li>Press any key to continue the execution.</li>
<li>Verify the second output from the evaluation of <kbd>EvaluateWithReferencesAsync</kbd>:</li>
</ol>
<pre style="padding-left: 90px">
<strong>Executing EvaluateWithReferencesAsync...</strong><br/><strong>&lt;%your_machine_name%&gt;</strong>
</pre>
<ol start="8">
<li>Press any key to continue the execution.</li>
<li>Verify the third output from the evaluation of <kbd>EvaluateWithImportsAsync</kbd>:</li>
</ol>
<pre style="padding-left: 90px">
<strong>Executing EvaluateWithImportsAsync...</strong><br/><strong>1.4142135623731</strong>
</pre>
<ol start="10">
<li>Press any key to continue the execution.</li>
<li>Verify last output from the evaluation of <kbd>EvaluateParameterizedScriptInLoopAsync</kbd>:</li>
</ol>
<pre style="padding-left: 90px">
<strong>Executing EvaluateParameterizedScriptInLoopAsync...</strong><br/><strong>0</strong><br/><strong>1</strong><br/><strong>4</strong><br/><strong>9</strong><br/><strong>16</strong><br/><strong>25</strong><br/><strong>36</strong><br/><strong>49</strong><br/><strong>64</strong><br/><strong>81</strong><br/><strong>Press any key to continue . . .</strong>
</pre>
<ol start="12">
<li>Press any key to exit the console.</li>
</ol>
<p>Refer to the article (<a href="https://github.com/dotnet/roslyn/wiki/Scripting-API-Samples">https://github.com/dotnet/roslyn/wiki/Scripting-API-Samples</a>) for more examples of the scripting API.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>In this recipe, we wrote a C# console application based on Roslyn scripting APIs to perform various common scripting operations. The rich scripting APIs provides a powerful object model for the evaluation, creation, and execution of scripts with configuration options.</p>
<p>Let us walk through the code in this recipe and understand how we implemented some of these operations:</p>
<pre>
public static void Main(string[] args)<br/>{<br/>  EvaluateSimpleAsync().Wait();<br/><br/>  Console.ReadKey();<br/>  EvaluateWithReferencesAsync().Wait();<br/><br/>  Console.ReadKey();<br/>  EvaluateWithImportsAsync().Wait();<br/><br/>  Console.ReadKey();<br/>  EvaluateParameterizedScriptInLoopAsync().Wait();<br/>}
</pre>
<p>The <kbd>Main</kbd> method invokes individual methods to perform following operations:</p>
<ul>
<li><kbd>EvaluateSimpleAsync</kbd>: A simple evaluation of a binary add expression</li>
<li><kbd>EvaluateWithReferencesAsync</kbd>: An evaluation involving a reference assembly passed down to the script options</li>
<li><kbd>EvaluateWithImportsAsync</kbd>: An evaluation involving the importing of a system namespace and invoking an API from the namespace</li>
<li><kbd>EvaluateParameterizedScriptInLoopAsync</kbd>: A creation and evaluation of a script parameterized by parameters and invoked over a loop of values.</li>
</ul>
<p><kbd>EvaluateSimpleAsync</kbd> invokes the most common scripting API, <kbd>CSharpScript.EvaluateAsync</kbd> (<a href="http://source.roslyn.io/#q=CSharpScript.EvaluateAsync">http://source.roslyn.io/#q=CSharpScript.EvaluateAsync</a>), with an expression as the argument to evaluate that expression. In our case, we pass in <kbd>1 + 2</kbd> as the argument to <kbd>EvaluateAsync</kbd>, which outputs the result <kbd>3</kbd>:</p>
<pre>
private static async Task <strong>EvaluateSimpleAsync()</strong><br/>{<br/>  Console.WriteLine("Executing EvaluateSimpleAsync...");<br/>  object result = await CSharpScript.EvaluateAsync("1 + 2");<br/>  Console.WriteLine(result);<br/>}
</pre>
<p><kbd>EvaluateWithReferencesAsync</kbd> invokes the same <kbd>CSharpScript.EvaluateAsync</kbd> API (<a href="http://source.roslyn.io/#q=CSharpScript.EvaluateAsync">http://source.roslyn.io/#q=CSharpScript.EvaluateAsync</a>), but using an additional reference assembly passed down through the script options with the <kbd>ScriptOptions.WithReferences</kbd> API (<a href="http://source.roslyn.io/#q=ScriptOptions.WithReferences">http://source.roslyn.io/#q=ScriptOptions.WithReferences</a>).</p>
<p>In our case, we pass in <kbd>typeof(System.Net.Dns).Assembly</kbd> as an additional reference for the evaluation of <kbd>System.Net.Dns.GetHostName()</kbd>, which outputs the machine name:</p>
<pre>
private static async Task <strong>EvaluateWithReferencesAsync</strong>()<br/>{<br/>  Console.WriteLine("Executing EvaluateWithReferencesAsync...");<br/>  var result = await CSharpScript.EvaluateAsync("System.Net.Dns.GetHostName()",<br/>  ScriptOptions.Default.WithReferences(typeof(System.Net.Dns).Assembly));<br/>  Console.WriteLine(result);<br/>}
</pre>
<p><kbd>EvaluateWithImportsAsync</kbd> invokes the <kbd>CSharpScript.EvaluateAsync</kbd> API (<a href="http://source.roslyn.io/#q=CSharpScript.EvaluateAsync">http://source.roslyn.io/#q=CSharpScript.EvaluateAsync</a>) with a namespace import passed down through the script options with the <kbd>ScriptOptions.WithImports</kbd> API (<a href="http://source.roslyn.io/#q=ScriptOptions.WithImports">http://source.roslyn.io/#q=ScriptOptions.WithImports</a>). In our case, we pass in <kbd>System.Math</kbd> as an additional namespace import for the evaluation of <kbd>Sqrt(2)</kbd>, which outputs the result <kbd>1.4142135623731</kbd>:</p>
<pre>
private static async Task <strong>EvaluateWithReferencesAsync</strong>()<br/>{<br/>  Console.WriteLine("Executing EvaluateWithReferencesAsync...");<br/>  var result = await CSharpScript.EvaluateAsync("System.Net.Dns.GetHostName()",<br/>  ScriptOptions.Default.WithReferences(typeof(System.Net.Dns).Assembly));<br/>  Console.WriteLine(result);<br/>}
</pre>
<p><kbd>EvaluateParameterizedScriptInLoopAsync</kbd> creates a parameterized C# script using the <kbd>CSharpScript.Create</kbd> API (<a href="http://source.roslyn.io/#Microsoft.CodeAnalysis.CSharp.Scripting/CSharpScript.cs,3beb8afb18b9c076">http://source.roslyn.io/#Microsoft.CodeAnalysis.CSharp.Scripting/CSharpScript.cs,3beb8afb18b9c076</a>), which takes the script code to execute and a global type as arguments:</p>
<pre>
private static async Task <strong>EvaluateParameterizedScriptInLoopAsync</strong>()<br/>{<br/>  Console.WriteLine("Executing EvaluateParameterizedScriptInLoopAsync...");<br/>  var script = CSharpScript.Create&lt;int&gt;("X*Y", globalsType: typeof(Globals));<br/>  script.Compile();<br/>  for (int i = 0; i &lt; 10; i++)<br/>  {<br/>    Console.WriteLine((await script.RunAsync(new Globals { X = i, Y = i })).ReturnValue);<br/>  }<br/>}
</pre>
<p>It then invokes the <kbd>Script.Compile</kbd> API (<a href="http://source.roslyn.io/#q=Script.Compile">http://source.roslyn.io/#q=Script.Compile</a>) to compile the script. The compiled script is then executed in a loop using the <kbd>Script.RunAsync</kbd> API (<a href="http://source.roslyn.io/#q=Script.RunAsync">http://source.roslyn.io/#q=Script.RunAsync</a>) with different instances of global type Globals, with incremented values of fields <em>X</em> and <em>Y</em>. Each iteration computes the result of the expression <kbd>X * Y</kbd>, which in our case is just square of all the numbers in the loop from zero to nine.</p>


            

            
        
    </body></html>