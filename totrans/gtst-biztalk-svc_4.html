<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Enterprise Application Integration</h1></div></div></div><p>A middleware system or service that enables applications to connect to each other to exchange data is known as Enterprise Application Integration or EAI. In BizTalk Services, EAI is oriented towards a developer persona and Visual Studio is the primary tool for development and deployment of services. Integration between applications is possible using a bridge for messaging. We will explore the e-commerce example from the first chapter in more detail as we look at the concepts.</p><p>Specifically, in this chapter, we will focus on the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Understanding EAI capabilities in Azure</li><li class="listitem" style="list-style-type: disc">Understanding bridges, sources, and destinations</li><li class="listitem" style="list-style-type: disc">Understanding custom code using message inspectors</li><li class="listitem" style="list-style-type: disc">Understanding hybrid connectivity</li></ul></div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec41"/>Enterprise application integration scenarios</h1></div></div></div><p>Consider<a id="id186" class="indexterm"/> the following scenarios:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Contoso is a movie ticketing company and sells tickets through Point-Of-Sale terminals across different cities. They wish to consolidate their end-of-day sales data from the terminals to their SAP Line-of-Business system. In the absence of any form of middleware, the POS data needs to be collected manually and the data has to be merged and converted to a format matching the target system. Using EAI, the entire process can be automated and set up in a matter of minutes with BizTalk Services.</li><li class="listitem" style="list-style-type: disc">Fabrikam is a software vendor and uses Salesforce to manage their customer pipeline and sales orders. All approved orders from Salesforce need to be managed centrally in their ERP system like Oracle, which resides on-premises. Using hybrid connectivity all connections to Oracle on-premises can be managed using BizTalk Adapter Services.</li><li class="listitem" style="list-style-type: disc">Northwind is an online retailer who manages an e-commerce website for customer purchases. They also receive bulk orders from event firms and corporates for their goods. Northwind needs to develop a solution to validate orders and also route requests to the right inventory location for delivery of the goods. Using EAI in BizTalk Services, they develop a common solution to process purchase orders from consumers over XML as well as purchase orders in EDI from event firms.</li></ul></div><p>Each of<a id="id187" class="indexterm"/> these scenarios can be modelled as an EAI solution on BizTalk Services. The incoming requests (ticketing sales, sales orders, and invoices) can be XML or flat file messages and need to be transformed into a target Line of Business format and routed to the on-premises systems. If the destination is on-premises, then relay endpoints are set up using hybrid connectivity.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec42"/>EAI in BizTalk Services</h1></div></div></div><p>Let's look at each of the concepts in more detail and understand their capabilities.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec18"/>Sources</h2></div></div></div><p>Sources<a id="id188" class="indexterm"/> receive a message from an external application. BizTalk<a id="id189" class="indexterm"/> Services v1 supports five common out-of-the-box sources: <strong>SFTP</strong>, <strong>FTP</strong>, <strong>HTTP</strong>, <strong>Service Bus Queue</strong>, and <strong>Service Bus Subscription</strong>. By default, the bridge exposes the HTTPs endpoint secured by the Access Control service. The various sources of bridges are shown in the following screenshot:</p><div><img src="img/7401EN_04_01.jpg" alt="Sources"/><div><p>Sources of bridges</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec19"/>Bridges and the VETER pattern</h2></div></div></div><p>Bridges<a id="id190" class="indexterm"/> are composed of sources, pipelines, and destinations. Pipelines<a id="id191" class="indexterm"/> connect two messaging<a id="id192" class="indexterm"/> systems and are composed of a series of stages to process the messages<a id="id193" class="indexterm"/> flowing from source to destination. The stages <a id="id194" class="indexterm"/>perform<a id="id195" class="indexterm"/> decoding, validation, enrichment, transformation, and routing of the messages. Each stage can be enabled or disabled for deployment from the Visual Studio properties pane. The set of stages are fixed, and out of the box, BizTalk Services v1 enables the <strong>VETER</strong> pattern. This is shown in the following screenshot:</p><div><img src="img/7401EN_04_02.jpg" alt="Bridges and the VETER pattern"/><div><p>Bridges with VETER pattern</p></div></div><p>The following are the stages of the VETER pattern:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Stage</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Validate (V)</p>
</td><td style="text-align: left" valign="top">
<p>Validate<a id="id196" class="indexterm"/> the <a id="id197" class="indexterm"/>incoming message against the schema</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Enrich (E)</p>
</td><td style="text-align: left" valign="top">
<p>Enrich<a id="id198" class="indexterm"/> the message <a id="id199" class="indexterm"/>with properties promoted from the message header, body, or lookup (see <a class="link" href="ch03.html" title="Chapter 3. Bridges">Chapter 3</a>, <em>Bridges</em>)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Transform (T)</p>
</td><td style="text-align: left" valign="top">
<p>Map<a id="id200" class="indexterm"/> the message from <a id="id201" class="indexterm"/>one format to another (see <a class="link" href="ch02.html" title="Chapter 2. Messages and Transforms">Chapter 2</a>, <em>Messages and Transforms</em>)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Enrich (E)</p>
</td><td style="text-align: left" valign="top">
<p>Enrich the new message post transform</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Route (R)</p>
</td><td style="text-align: left" valign="top">
<a id="id202" class="indexterm"/>
<p>Route<a id="id203" class="indexterm"/> to one of the target destinations</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Decode</p>
</td><td style="text-align: left" valign="top">
<p>For<a id="id204" class="indexterm"/> flat file processing, <a id="id205" class="indexterm"/>decode the message</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec20"/>Destinations</h2></div></div></div><p><strong>Destinations</strong> are <a id="id206" class="indexterm"/>where messages are is submitted<a id="id207" class="indexterm"/> to after pipeline processing. In bridges, the route to a destination is based on the SQL-92 expression syntax. A message will be sent to only one destination whose route rule evaluates to true. The route stage is also explained in <a class="link" href="ch02.html" title="Chapter 2. Messages and Transforms">Chapter 2</a>, <em>Messages and Transforms</em>. The various destinations are shown in the following screenshot:</p><div><img src="img/7401EN_04_03.jpg" alt="Destinations"/><div><p>Destinations with bridges</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec21"/>Attributes of bridges</h2></div></div></div><p>Here are <a id="id208" class="indexterm"/>some interesting attributes of bridges:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>State</strong>: Pipelines as part of bridges are stateless, that is, at no point during the processing is the message persisted. If there is a crash or restart of the system while messages are inflight, the message would have to be resubmitted for processing. This also means message processing is synchronous.</li><li class="listitem" style="list-style-type: disc"><strong>Error handling</strong>: If an error occurs during message processing, a fault is thrown back to the sender of the message to take action. As there is no separate suspend endpoint in EAI bridges, error must be handled at the client side.</li><li class="listitem" style="list-style-type: disc"><strong>One-way/Two-way</strong>: Bridges support both one-way and two-way communication. In the case of one-way communication, only the HTTP codes are passed back to the sender of the message. However, in the case of two-way communication, a response message can be sent back. Two-way bridges in BizTalk Services support the VETER pattern on the request side and ETER on the response side. The message on the response side is assumed to be valid since this is coming from the target Line-of-Business system or service. Note that a pass-through-bridge is a special case of a one-way bridge that has only the E-R of the VETER pattern.</li><li class="listitem" style="list-style-type: disc"><strong>Message formats</strong>: Messages can be sent in plain old XML, SOAP, and flat file formats. Flat file messages can only be used with one-way bridges. Other formats such as JSON may be added in future, but those different formats need custom code to normalize the data to XML before processing. We will discuss custom code later in this chapter.</li><li class="listitem" style="list-style-type: disc"><strong>Chaining</strong>: Multiple bridges can be chained by adding one bridge as the destination of another bridge. This may be used to centralize the processing of messages through a single bridge. For example, multiple bridges may pump<a id="id209" class="indexterm"/> messages from different sources all connecting to a single bridge that routes to an on-premises endpoint. Also, selectively disabling stages can enable newer messaging patterns. For example, ETEVR can be achieved by chaining two VETER bridges.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec43"/>Hybrid connectivity</h1></div></div></div><p>Organizations that have made IT investments in ERPs and services on premises may not transition all of their IT assets to the cloud. There is a need to connect to those services and resources using hybrid connectivity from the cloud.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec22"/>The BizTalk Adapter Service</h2></div></div></div><p>The <strong>BizTalk Adapter Service</strong> (<strong>BAS</strong>) is a service which enables<a id="id210" class="indexterm"/> an application running on-premises to receive data from <a id="id211" class="indexterm"/>the cloud. The on-premises applications such as ERPs and BizTalk Server can be exposed outside of the corporate network using Service Bus relays for hybrid connectivity. The Service Bus Relay service on Azure acts as an intermediary where a client and an on-premises service can connect with each other. The client in this case is the BizTalk Services' bridge and the service running on-premises is the BizTalk Adapter Service talking to an ERP. Once the BizTalk Adapter Service and the bridge authenticate with the Service Bus Relay service, all messages from the bridge are forwarded to the BizTalk Adapter Service.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec23"/>The BAS architecture</h2></div></div></div><p>The overall BAS architecture is shown in the following figure:</p><div><img src="img/7401EN_04_04.jpg" alt="The BAS architecture"/><div><p>The BizTalk Adapter Service architecture</p></div></div><p>The BizTalk <a id="id212" class="indexterm"/>Adapter Service runs on the client machine<a id="id213" class="indexterm"/> and is hosted in IIS to handle management operations such as start/stop of endpoints as well as runtime operations to route messages from the cloud to the on-premises systems. There is one management service along with one or more runtime services that can be managed using the management service. The meta-data of the relay configurations is stored in the storage account of the BizTalk Services deployment specified during installation. The BizTalk Adapter Service relies on the BizTalk Adapter pack to connect to Line-of-Business (LOB) systems such as Oracle DB, Oracle EBS, SAP, Siebel, and SQL Server.</p><p>Management operations are exposed through Visual Studio Server Explorer or through PowerShell cmdlets, both of which talk to the <strong>BAService</strong>, the application hosting the <code class="literal">ManagementService.svc</code> service in IIS on the on-premises machine where BizTalk Adapter Service is installed.</p><p>Runtime operations are managed as per the Service Bus Relay by creating new applications in IIS hosting <code class="literal">RuntimeService.svc</code>. Each LOB can create a new relay or use an existing relay configured for another LOB. When there are more than one LOB per relay, the sub-paths in the runtime address beyond the relay URL help direct the calls to the right adapter.</p><p>When the<a id="id214" class="indexterm"/> LOB relay is created, based on user configuration a new or existing <a id="id215" class="indexterm"/>application is used in IIS as the service host. The generated WSDL contains the message to be relayed as well as the operation action. Operations such as <code class="literal">INSERT</code>, <code class="literal">UPDATE</code>, <code class="literal">DELETE</code>, and <code class="literal">SELECT</code> are passed as part of the <code class="literal">SOAPAction</code> header in the following format: <code class="literal">TableOp/{Operation}/schema/Tablename</code>. The exact SOAP Action string can be determined from the relay configuration's properties window in Visual Studio.</p><p>Every message passing via the relay needs to authenticate with the LOB. Authentication credentials are passed using one of the following four ways:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Username and password preconfigured and stored in the BAS store</li><li class="listitem" style="list-style-type: disc">Active<a id="id216" class="indexterm"/> Directory domain<a id="id217" class="indexterm"/> credentials</li><li class="listitem" style="list-style-type: disc">SOAP header containing credentials of the LOB</li><li class="listitem" style="list-style-type: disc">WS-Security credentials</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec24"/>BAS installation and configuration</h2></div></div></div><p>BAS<a id="id218" class="indexterm"/> installation<a id="id219" class="indexterm"/> is part of the BizTalk Services SDK setup. During setup, the<a id="id220" class="indexterm"/> URL<a id="id221" class="indexterm"/> of the BizTalk Services deployment needs to be entered. This is added to <code class="literal">web.config</code> under <code class="literal">C:\Program Files\Microsoft BizTalk Adapter Service\BAService</code>. In Visual Studio Server Explorer, the on-premises management service URL along with the ACS credentials of the deployment need to be entered. Hybrid connectivity can now be set up for each of the following LOBs using a wizard-driven interface as shown:</p><div><img src="img/7401EN_04_05.jpg" alt="BAS installation and configuration"/><div><p>BizTalk Adapter Service configuration in Visual Studio Server Explorer</p></div></div><p>For example, setting up the relay connectivity with on-premises SQL Server Express running on localhost with DemoDB as the database involves the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">In the <strong>Server Explorer</strong> BAS view, right-click on <strong>LOB Types</strong> | <strong>SQL</strong> and choose <strong>Add SQL Target</strong>.</li><li class="listitem">In the pop-up wizard, read the instructions and click on <strong>Next</strong>.</li><li class="listitem">Enter <a id="id222" class="indexterm"/>values<a id="id223" class="indexterm"/> for the server name, instance, and catalog (say <code class="literal">localhost</code>, <code class="literal">SQLExpress</code>, and <code class="literal">DemoDB</code>, respectively). Use Windows authentication or the username and password as configured and click on <strong>Next</strong>.</li><li class="listitem">Navigate <a id="id224" class="indexterm"/>to <strong>Tables</strong> (or <strong>Views</strong>) is exposed via relay, choose<a id="id225" class="indexterm"/> the table, and select <strong>Insert</strong> as the operation. Click on <strong>Properties</strong> to see the WSDL generated. Click on <strong>Next</strong>.</li><li class="listitem">Configure the <strong>Runtime security type</strong> when the message passes via relay. These are the four options we mentioned earlier. Enter the credentials and click on <strong>Next</strong>.</li><li class="listitem">In <strong>Specify the LOB Relay URL</strong>, choose <strong>Create a new LOB relay</strong> and enter the Service Bus credentials. Enter any name for <strong>LOB relay path</strong> and <strong>LOB relay subpath</strong>. Click on <strong>Next</strong>.</li><li class="listitem">Click on <strong>Create</strong> to complete the creation of the relay and the BAS endpoint.</li></ol></div><p>Once the relay has been successfully set up, each connection will appear under the corresponding LOB Type.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec25"/>Consuming BAS with bridges</h2></div></div></div><p>Create a <a id="id226" class="indexterm"/>new BizTalk Services <a id="id227" class="indexterm"/>project or open an existing one. There are three parts to using the BAS configuration with a bridge:</p><div><ol class="orderedlist arabic"><li class="listitem">From the Server Explorer, we can now right-click on the relay connection configured earlier and choose <strong>Add Schemas to Project</strong>. The relevant schemas to send and receive the target LOB are added in the project. These can be used for mapping and validation purposes within the bridge.</li><li class="listitem">Drag-and-drop the connection from the Server Explorer into the Bridge design surface. This will create the necessary icon to add a destination connection from the bridge.</li><li class="listitem">Click on the relay connection and navigate to the <strong>Operations</strong> field in Visual Studio properties window. Expand the view and note down the values to the right of each of the index [0], [1]. Each of these are the SOAP Action values. To add this value, go the Route Action in VS properties and launch the <strong>Route Actions</strong> window. Click on <strong>Add</strong> and in the <strong>Edit Route Action</strong> pop up, enter Expression as the soap action value copied earlier. Choose <strong>Type</strong> as <strong>Soap</strong> and <strong>Identifier</strong> as <strong>Action</strong>. Click on <strong>OK</strong> to accept the changes.</li></ol></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec44"/>Custom code in EAI</h1></div></div></div><p>Now that <a id="id228" class="indexterm"/>we understand hybrid connectivity, let's look at one more functionality of bridges, which is to support custom code. Not all capabilities will be available out of the box from BizTalk Services. Customization enables developers to plug in new functionality that augments the existing message flow. For example, we can choose to convert an incoming invoice XML to a user-readable PDF format as well as archive the same for legal reasons.</p><p>Customization in a bridge is possible at the stage level, route configuration, or in transforms. Transforms and its customization were covered in <a class="link" href="ch02.html" title="Chapter 2. Messages and Transforms">Chapter 2</a>, <em>Messages and Transforms</em>. In this section, we will look at bridge customization.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec26"/>Message inspectors</h2></div></div></div><p>Message inspectors<a id="id229" class="indexterm"/> are custom code hooks<a id="id230" class="indexterm"/> for every entry or exit of a stage in a bridge. Custom code must implement the <code class="literal">IMessageInspector</code> interface:</p><div><pre class="programlisting">public interface IMessageInspector
{
Task Execute(IMessage message, IMessageInspectorContext context);
}</pre></div><p>Message inspectors are implemented using the Task programming model in the .NET4 Task Parallel Library. Traces in custom code can be emitted using the <code class="literal">ITracer</code> interface in the <code class="literal">IMessageInspectorContext</code> interface.</p><div><pre class="programlisting">public interface ITracer
{
void TraceEvent(TraceEventType eventType, string format, params object[] args);
}</pre></div><div><div><h3 class="title"><a id="note06"/>Note</h3><p>The following are key points to remember when developing custom code:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">User code is expected to be resilient, but in some cases, it could throw an exception. In this case, this is treated as a stage level failure and the corresponding track record is generated.</li><li class="listitem" style="list-style-type: disc">User code in the VS project must have references to <code class="literal">Microsoft.BizTalk.Services.dll</code> from <code class="literal">C:\Program Files (x86)\Microsoft Visual Studio 11.0\Common7\ide\Extensions</code>.</li><li class="listitem" style="list-style-type: disc">User code assemblies must be added as reference in the BizTalk Services project with <code class="literal">Copy Local</code> set to true.</li><li class="listitem" style="list-style-type: disc">Whenever the user code assemblies are deployed in BizTalk Services, the service must be restarted as the DLLs need to be reloaded in the .NET AppDomain. The restart option is available in the VS deploy and in the PS cmdlet.</li><li class="listitem" style="list-style-type: disc">Artifacts<a id="id231" class="indexterm"/> of the bridge such as the schema or map<a id="id232" class="indexterm"/> are not accessible within the user code.</li><li class="listitem" style="list-style-type: disc">Properties can be defined and promoted in the custom code. In code, they must be string property with C# attribute <code class="literal">PipelinePropertyAttribute</code> set with the <code class="literal">Name</code> attribute. This attribute is set in the VS Property Configuration in the Message Inspector configuration window as seen in the <em>Custom code configuration with bridges</em> figure in the <em>Configuring the bridge</em> section.</li></ul></div></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec45"/>Tracking</h1></div></div></div><p>Tracking<a id="id233" class="indexterm"/> helps in storing interesting properties of a message in the tracking store. The tracking store is an Azure SQL database configured during BizTalk Services provisioning time. All message properties are stored in the <code class="literal">PipelineTrackRecords</code> and <code class="literal">SourceTrackRecords</code> tables. Tracking for troubleshooting is detailed in <a class="link" href="ch07.html" title="Chapter 7. Tracking and Troubleshooting">Chapter 7</a>, <em>Tracking and Troubleshooting</em>.</p><p>To enable tracking at the EAI bridge, select the bridge in VS and choose <strong>Track Properties</strong> from the properties window. The tracked properties can be seen in the BizTalk Services portal's Tracking view.</p><div><img src="img/7401EN_04_06.jpg" alt="Tracking"/><div><p>Configure tracking properties with bridges</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec46"/>Scenario walk-through</h1></div></div></div><p>Let's revisit the EAI scenario with the following changes.</p><p>Northwind is an online retailer who manages an e-commerce website for customer purchases. Instead of processing orders, let's say they now receive invoices from their suppliers for the goods sold. For readability and regulatory reasons, they need to store this in PDF format in an on-premises system.</p><div><div><h3 class="title"><a id="note07"/>Note</h3><p>It is assumed that the BizTalk Services SDK has been installed and Visual Studio shows the following projects:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">BizTalk Service project: Create/Deploy bridges, schemas, and maps</li><li class="listitem" style="list-style-type: disc">BizTalk Service artifacts project: Create/Deploy schemas, and maps</li></ul></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec27"/>Prerequisites</h2></div></div></div><p>Northwind <a id="id234" class="indexterm"/>creates a new BizTalk Services deployment. See <a class="link" href="ch01.html" title="Chapter 1. Hello BizTalk Services">Chapter 1</a>, <em>Hello BizTalk Services</em> on creating a BizTalk Services deployment and registering the<a id="id235" class="indexterm"/> BizTalk portal. We are going to use the PDFTemplate utility<a id="id236" class="indexterm"/> from <a class="ulink" href="http://pdftemplate.codeplex.com">pdftemplate.codeplex.com</a> to generate PDF-formatted invoice messages. The utility is available under the GPLv2 license.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec28"/>Solution</h2></div></div></div><p>The solution would take the invoice XML and generate the PDF in a blob store. To get started, let's first create the schema, add the code to generate the PDF, and finally plug that logic into the bridge configuration.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec04"/>Creating a schema</h3></div></div></div><p>Create a <a id="id237" class="indexterm"/>sample schema for use with the incoming message. The<a id="id238" class="indexterm"/> sample used in this flow is provided along with this chapter. Perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Using the Visual Studio schema editor, create a simple schema called <code class="literal">InvoiceSchema.xsd</code> for the invoice.</li><li class="listitem">From the Visual Studio command prompt, run the following command to generate <code class="literal">InvoiceSchema.cs</code> for this xsd:<div><pre class="programlisting">xsd InvoiceSchema.xsd /classes</pre></div></li><li class="listitem">We will load this <code class="literal">InvoiceSchema.cs</code> file in the next step.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec05"/>Creating custom code</h3></div></div></div><p>Let's now <a id="id239" class="indexterm"/>add the custom code to generate the PDF for the invoice<a id="id240" class="indexterm"/> we just created:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a C# class library project and add a reference to <code class="literal">Microsoft.BizTalk.Services.dll</code> and the PDF dependencies.</li><li class="listitem">Implement a class for the <code class="literal">IMessageInspector</code> interface. In the example, we have extracted the message body to the <code class="literal">Order</code> message object as follows:<div><pre class="programlisting">string bodystr = GetMessageBody(message);
Order order = DeserializeMessageToOrder(bodystr);</pre></div></li><li class="listitem">PDFGenerator describes the layout of the PDF structure in <code class="literal">layout.xml</code> as required by the codeplex tool. The XML itself is passed within the custom code DLL as an embedded resource and must be extracted before use as shown in the following code snippet:<div><pre class="programlisting">Stream stream = System.Reflection.Assembly.GetExecutingAssembly().GetManifestResourceStream("layout.xml");
byte[] bytes = new byte[(int)stream.Length];
stream.Read(bytes, 0, bytes.Length);
File.WriteAllBytes(System.IO.Path.GetTempPath(), bytes);</pre></div></li><li class="listitem">Fill in the header, body, loop, and footer data of the PDF file using the data from the <code class="literal">Order</code> object. Use the PDFGenerator using the information shown in the following code snippet:<div><pre class="programlisting">PDFTemplateItextSharp pdfgen = new PDFTemplateItextSharp(xmlToPdfTemplateFilePath);
pdfgen.Draw(GetHeaderData(order), GetLoopData(order), GetBodyData(), GetFooterData());</pre></div></li><li class="listitem">Write<a id="id241" class="indexterm"/> the PDF data back as a new message<a id="id242" class="indexterm"/> shown in the following code snippet:<div><pre class="programlisting">message.Data = new System.IO.MemoryStream(pdfdata);
message.ContentType = new System.Net.Mime.ContentType("text/plain");</pre></div></li><li class="listitem">Sign the assembly output from the project. Note that all the DLL dependencies are needed to be signed.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec06"/>Configuring the bridge</h3></div></div></div><p>Perform the following <a id="id243" class="indexterm"/>steps to configure the bridge:</p><div><ol class="orderedlist arabic"><li class="listitem">Add a <a id="id244" class="indexterm"/>BizTalk Services project to the same solution and add references to the signed custom code.</li><li class="listitem">Add a bridge, in this case, a <strong>Pass-Through</strong> bridge, and call it Invoice2PDF. Also add the route for the message to a Windows Azure blob destination. Let's call the blob storage <strong>PDFArchiveBlobs</strong> as shown in the following figure:<div><img src="img/7401EN_04_07.jpg" alt="Configuring the bridge"/><div><p>Invoice2PDF bridge sample in BizTalk Services project</p></div></div></li><li class="listitem">In the bridge properties, fill the required fields. For the bridge, add the BizTalk Services <strong>Runtime Address</strong> and <strong>Routing Table</strong> values. For the blob, add the <strong>Shared Access Signature URL</strong>. Click on the bridge, and from the properties window, open <strong>Track Properties</strong> on the bridge window to enable tracking.</li><li class="listitem">Get the full qualified assembly name of this custom code. If this is specified incorrectly, you will get an error during deployment. You can use the <strong>GetAssemblyQualifiedTypeName</strong> sample<a id="id245" class="indexterm"/> in MSDN Code Gallery, <a class="ulink" href="http://code.msdn.microsoft.com/windowsazure/Windows-Azure-BizTalk-EAI-56915d1c/view/SourceCode">http://code.msdn.microsoft.com/windowsazure/Windows-Azure-BizTalk-EAI-56915d1c/view/SourceCode</a>, or alternatively, run <code class="literal">sn -T</code> on the DLL to determine the public key and determine the full qualified name. It should look something like this:<div><pre class="programlisting">PDFGenerator.PDFGeneratorUtil, PDFGenerator, Version=1.0.0.0, Culture=neutral, PublicKeyToken=xxxxxxxxxx</pre></div></li><li class="listitem">Double-click<a id="id246" class="indexterm"/> on the pass-through bridge and click on the <a id="id247" class="indexterm"/>Enrich stage. From the properties window, click on <strong>On-Exit Message Inspector</strong> and add the full qualified name in the <strong>Specify Custom Code Inspector</strong> pop-up window, as shown in the following screenshot:<div><img src="img/7401EN_04_08.jpg" alt="Configuring the bridge"/><div><p>Custom code configuration with bridges</p></div></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec07"/>Deploying the bridge</h3></div></div></div><p>We can <a id="id248" class="indexterm"/>now deploy the bridge to the BizTalk Services deployment <a id="id249" class="indexterm"/>with the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Launch<a id="id250" class="indexterm"/> VS and select the <strong>Deploy</strong> command from the <strong>Build</strong> menu and enter the BizTalk Service deployment details.</li><li class="listitem">If the project is being deployed more than once, you need to check the <strong>Refresh Service after deploy</strong> checkbox so that the updated custom code DLLs are picked-up.</li></ol></div><p>The VS output block will be similar to the one shown as follows:</p><div><img src="img/7401EN_04_09.jpg" alt="Deploying the bridge"/><div><p>VS output for bridge deployment</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec08"/>Sending messages</h3></div></div></div><p>Use the<a id="id251" class="indexterm"/> Message Sender tool from MSDN Code Gallery samples for<a id="id252" class="indexterm"/> BizTalk Services to send messages to the bridge, or you can also download the BizTalk Services Explorer plugin for VS Server Explorer. This allows you to explore the deployment and also send test messages.</p><p>Once the messages are sent successfully, go to the container with the SAS URL and save the blob locally. Rename the file to a <code class="literal">.PDF</code> extension and you should be able to view the archived PDFs.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec29"/>Viewing tracking data</h2></div></div></div><p>Click on<a id="id253" class="indexterm"/> the Tracking view in the navigation bar of the BizTalk Services portal to see the status of message flow on the bridge. It's also possible to view this information from the BizTalk Service Explorer in VS on a per-bridge basis.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec47"/>Summary</h1></div></div></div><p>In this chapter, we started with the basic concepts of EAI on Azure, notably bridges, sources, destinations, hybrid connectivity, and custom code. We walked through a simple scenario in BizTalk Services generating PDF invoices and archiving in a blob store. It is possible to encounter an error while using custom code in bridges. We will cover aspects of troubleshooting in <a class="link" href="ch07.html" title="Chapter 7. Tracking and Troubleshooting">Chapter 7</a>, <em>Tracking and Troubleshooting</em>.</p><p>In the next chapter, we will look at another key scenario supported in BizTalk Services—integrating across businesses using B2B capabilities.</p></div></body></html>