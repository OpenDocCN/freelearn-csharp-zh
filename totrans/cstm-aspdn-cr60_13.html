<html><head></head><body>
		<div id="_idContainer055">
			<h1 id="_idParaDest-105"><em class="italic"><a id="_idTextAnchor186"/>Chapter 13</em>: Managing Inputs with Custom ModelBinder</h1>
			<p>In the last chapter regarding <strong class="source-inline">OutputFormatter</strong>, we learned about sending data out to clients in different formats. In this chapter, we are going to do it the other way. This chapter is about data you get in your web API from outside; for instance, what to do if you get data in a special format, or if you get data you need to validate in a special way. <strong class="bold">Model Binders</strong> will help you to handle this.</p>
			<p>In this chapter, we will be covering the following topics:</p>
			<ul>
				<li>Introducing <strong class="source-inline">ModelBinder</strong></li>
				<li>Preparing the test project</li>
				<li>Creating <strong class="source-inline">PersonsCsvBinder</strong></li>
				<li>Using <strong class="source-inline">ModelBinder</strong></li>
				<li>Testing <strong class="source-inline">ModelBinder</strong></li>
			</ul>
			<p>The topics in this chapter refer to the WebAPI layer of the ASP.NET Core architecture:</p>
			<div>
				<div id="_idContainer053" class="IMG---Figure">
					<img src="image/Figure_13.1_B17996.jpg" alt="Figure 13.1 – ASP.NET Core architecture&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.1 – ASP.NET Core architecture</p>
			<h1 id="_idParaDest-106"><a id="_idTextAnchor187"/>Technical requirements</h1>
			<p>To follow the descriptions in this chapter, you will need to create an ASP.NET Core MVC application. Open your console, shell, or Bash terminal, and change to your working directory. Use the following command to create a new MVC application:</p>
			<p class="source-code">dotnet new webapi -n ModelBinderSample -o ModelBinderSample</p>
			<p>Now, open the project in Visual Studio by double-clicking the project file or, in VS Code, by typing the following command in the already open console:</p>
			<p class="source-code">cd ModelBinderSample</p>
			<p class="source-code">code .</p>
			<p>All of the code samples in this chapter can be found in the GitHub repository for this book at: <a href="https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter13">https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/tree/main/Chapter13</a>.</p>
			<h1 id="_idParaDest-107">I<a id="_idTextAnchor188"/><a id="_idTextAnchor189"/>ntroducing ModelBinder</h1>
			<p>Model Binders are responsible for binding the incoming data to specific action method parameters. They bind the data sent with the request to the parameters. The default binders <a id="_idIndexMarker194"/>are able to bind data that is sent via the <strong class="source-inline">QueryString</strong>, or sent within the request body. Within the body, the data can be sent in URL or JSON format.</p>
			<p>The model binding tries to find the values in the request by parameter names. The form values, route data, and query string values are stored as a key-value pair collection and the binding tries to find the parameter name in the keys of the collection.</p>
			<p>Let's demonstrate how this works with a test project.</p>
			<h1 id="_idParaDest-108"><a id="_idTextAnchor190"/><a id="_idTextAnchor191"/>Preparing the test data</h1>
			<p>In this section, we're going <a id="_idIndexMarker195"/>to see how to send CSV data to a web API method. We will reuse the CSV data we created in <a href="B17996_12_ePub.xhtml#_idTextAnchor172"><em class="italic">Chapter 12</em></a>, <em class="italic">Content Negotiation Using a Custom OutputFormatter</em>.</p>
			<p>This is a snippet of the test data we want to use:</p>
			<p class="source-code">Id,FirstName,LastName,Age,EmailAddress,Address,City,Phone</p>
			<p class="source-code">48,Austin,Ward,49,Jake.Timms@live.com,"8814 Gravesend Neck Road ",Daly City,(620) 260-4410</p>
			<p class="source-code">2,Sierra,Smith,15,Elizabeth.Wright@hotmail.com,"1199 Marshall Street ",Whittier,(655) 379-4362</p>
			<p class="source-code">27,Victorina,Radcliff,40,Bryce.Sanders@rogers.ca,"2663 Sutton Street ",Bloomington,(255) 365-0521</p>
			<p class="source-code">78,Melissa,Brandzin,39,Devin.Wright@telus.net,"7439 Knight Court ",Tool,(645) 343-2144</p>
			<p class="source-code">89,Kathryn,Perry,87,Hailey.Jenkins@hotmail.com,"5283 Vanderbilt Street ",Carlsbad,(747) 369-4849</p>
			<p>You can <a id="_idIndexMarker196"/>find the full CSV test data on GitHub at: <a href="https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/blob/main/Chapter13/testdata.csv">https://github.com/PacktPublishing/Customizing-ASP.NET-Core-6.0-Second-Edition/blob/main/Chapter13/testdata.csv</a>.</p>
			<h1 id="_idParaDest-109"><a id="_idTextAnchor192"/>Preparing the test project</h1>
			<p>Let's prepare <a id="_idIndexMarker197"/>the project by following these steps:</p>
			<ol>
				<li>In the already created project (refer to the <em class="italic">Technical requirements</em> section), we will now create a new empty API controller with a small action inside:<p class="source-code">namespace ModelBinderSample.Controllers</p><p class="source-code">{</p><p class="source-code">    [Route("[controller]")]</p><p class="source-code">    [ApiController]</p><p class="source-code">    public class PersonsController : ControllerBase</p><p class="source-code">    {</p><p class="source-code">        public ActionResult&lt;object&gt; Post(</p><p class="source-code">            IEnumerable&lt;Person&gt; persons)</p><p class="source-code">        {</p><p class="source-code">            return new</p><p class="source-code">            {</p><p class="source-code">                ItemsRead = persons.Count(),</p><p class="source-code">                Persons = persons</p><p class="source-code">            };</p><p class="source-code">        }</p><p class="source-code">    }</p><p class="source-code">}</p><p>This looks basically like any other action. It accepts a list of persons and returns an anonymous <a id="_idIndexMarker198"/>object that contains the number of persons as well as the list of persons. This action is pretty useless but helps us to debug <strong class="source-inline">ModelBinder</strong> using Postman.</p></li>
				<li>We also need the <strong class="source-inline">Person</strong> class:<p class="source-code">public class Person</p><p class="source-code">{</p><p class="source-code">    public int Id { get; set; }</p><p class="source-code">    public string? FirstName { get; set; }</p><p class="source-code">    public string? LastName { get; set; }</p><p class="source-code">    public int Age { get; set; }</p><p class="source-code">    public string? EmailAddress { get; set; }</p><p class="source-code">    public string? Address { get; set; }</p><p class="source-code">    public string? City { get; set; }</p><p class="source-code">    public string? Phone { get; set; }</p><p class="source-code">} </p><p>This will actually work fine if we want to send JSON-based data to that action.</p></li>
				<li>As a last preparation step, we need to add the <strong class="source-inline">CsvHelper</strong> NuGet package to parse the <a id="_idIndexMarker199"/>CSV data more easily. The .NET CLI is also useful here:<p class="source-code"><strong class="bold">dotnet add package CsvHelper</strong></p><p class="source-code"><strong class="bold">dotnet add package System.Linq.Async</strong></p><p class="callout-heading">Note</p><p class="callout">The <strong class="source-inline">System.Linq.Async</strong> package is needed to handle the <strong class="source-inline">IAsyncEnumerable</strong> that gets returned by the <strong class="source-inline">GetRecordsAsync()</strong> method.</p></li>
			</ol>
			<p>Now that this is all set up, we can try it out and create <strong class="source-inline">PersonsCsvBinder</strong> in the next sect<a id="_idTextAnchor193"/><a id="_idTextAnchor194"/>ion.</p>
			<h1 id="_idParaDest-110"><a id="_idTextAnchor195"/>Creating PersonsCsvBinder</h1>
			<p>Let's build a binder.</p>
			<p>To create <strong class="source-inline">ModelBinder</strong>, add a <a id="_idIndexMarker200"/>new class called <strong class="source-inline">PersonsCsvBinder</strong>, which implements <strong class="source-inline">IModelBinder</strong>. In the <strong class="source-inline">BindModelAsync</strong> method, we get <strong class="source-inline">ModelBindingContext</strong> with all the information in it that we need in order to get the data and deserialize it. The following code snippets show a generic binder that should work with any list of models. We have split it into sections so that you can clearly see how each part of the binder works:</p>
			<p class="source-code">public class PersonsCsvBinder : IModelBinder</p>
			<p class="source-code">{</p>
			<p class="source-code">    public async Task BindModelAsync(</p>
			<p class="source-code">        ModelBindingContext bindingContext)</p>
			<p class="source-code">    {</p>
			<p class="source-code">        if (bindingContext == null)</p>
			<p class="source-code">        {</p>
			<p class="source-code">            return;</p>
			<p class="source-code">        }</p>
			<p class="source-code">        var modelName = bindingContext.ModelName;</p>
			<p class="source-code">        if (String.IsNullOrEmpty(modelName))</p>
			<p class="source-code">        {</p>
			<p class="source-code">            modelName = bindingContext.OriginalModelName;</p>
			<p class="source-code">        }</p>
			<p class="source-code">        if (String.IsNullOrEmpty(modelName))</p>
			<p class="source-code">        {</p>
			<p class="source-code">            return;</p>
			<p class="source-code">        }</p>
			<p>As you can see from the preceding code block, first, the context is checked against null. After that, we <a id="_idIndexMarker201"/>set a default argument name to the model, if none have already been specified. If this is done, we are able to fetch the value by the name we set previously:</p>
			<p class="source-code">        var valueProviderResult = </p>
			<p class="source-code">          bindingContext.ValueProvider.GetValue(modelName);</p>
			<p class="source-code">        if (valueProviderResult == ValueProviderResult.None)</p>
			<p class="source-code">        {</p>
			<p class="source-code">            return;</p>
			<p class="source-code">        }</p>
			<p>In the next part, if there's no value, we shouldn't throw an exception in this case. The reason is that the next configured <strong class="source-inline">ModelBinder</strong> might be responsible. If we throw an exception, the execution of the current request is canceled and the next configured <strong class="source-inline">ModelBinder</strong> doesn't have the opportunity to be executed:</p>
			<p class="source-code">        bindingContext.ModelState.SetModelValue(</p>
			<p class="source-code">            modelName, valueProviderResult);</p>
			<p class="source-code">        var value = valueProviderResult.FirstValue;</p>
			<p class="source-code">        // Check if the argument value is null or empty</p>
			<p class="source-code">        if (String.IsNullOrEmpty(value))</p>
			<p class="source-code">        {</p>
			<p class="source-code">            return;</p>
			<p class="source-code">        }</p>
			<p>If we have the value, we <a id="_idIndexMarker202"/>can instantiate a new <strong class="source-inline">StringReader</strong> that needs to be passed to <strong class="source-inline">CsvReader</strong>: </p>
			<p class="source-code">        var stringReader = new StringReader(value);</p>
			<p class="source-code">        var reader = new CsvReader(</p>
			<p class="source-code">            stringReader, CultureInfo.InvariantCulture);</p>
			<p>With <strong class="source-inline">CsvReader</strong>, we can deserialize the CSV string value into a list of <strong class="source-inline">Persons</strong>. If we have the list, we need to create a new, successful <strong class="source-inline">ModelBindingResult</strong> that needs to be assigned to the <strong class="source-inline">Result</strong> property of <strong class="source-inline">ModelBindingContext</strong>:</p>
			<p class="source-code">        var asyncModel = reader.GetRecordsAsync&lt;Person&gt;();</p>
			<p class="source-code">        var model = await asyncModel.ToListAsync();</p>
			<p class="source-code">        bindingContext.Result = </p>
			<p class="source-code">           ModelBindingResult.Success(model);</p>
			<p class="source-code">    }</p>
			<p class="source-code">}</p>
			<p>You might need to add the following <strong class="source-inline">using</strong> statements at the beginning of the file:</p>
			<p class="source-code">using Microsoft.AspNetCore.Mvc.ModelBinding;</p>
			<p class="source-code">using System.IO;</p>
			<p class="source-code">using CsvHelper</p>
			<p class="source-code">using System.Globalization;</p>
			<p>Next, we'll <a id="_idIndexMarker203"/>put <strong class="source-inline">ModelBinder</strong> <a id="_idTextAnchor196"/><a id="_idTextAnchor197"/>to work.</p>
			<h1 id="_idParaDest-111"><a id="_idTextAnchor198"/>Using ModelBinder</h1>
			<p>The binder isn't used <a id="_idIndexMarker204"/>automatically because it isn't registered in the dependency injection container and is not configured to be used within the MVC framework.</p>
			<p>The easiest way to use this model binder is to use <strong class="source-inline">ModelBinderAttribute</strong> on the argument of the action where the model should be bound:</p>
			<p class="source-code">[HttpPost]</p>
			<p class="source-code">public ActionResult&lt;object&gt; Post(</p>
			<p class="source-code">    [ModelBinder(binderType: typeof(PersonsCsvBinder))]</p>
			<p class="source-code">    IEnumerable&lt;Person&gt; persons)</p>
			<p class="source-code">{</p>
			<p class="source-code">    return new</p>
			<p class="source-code">    {</p>
			<p class="source-code">        ItemsRead = persons.Count(),</p>
			<p class="source-code">        Persons = persons</p>
			<p class="source-code">    };</p>
			<p class="source-code">} </p>
			<p>Here, the type of our <strong class="source-inline">PersonsCsvBinder</strong> is set as <strong class="source-inline">binderType</strong> to that attribute.</p>
			<p class="callout-heading">Note</p>
			<p class="callout"><strong class="bold">Steve Gordon</strong> wrote about a second option in his blog post, <em class="italic">Custom ModelBinding in ASP.NET MVC Core.</em> He uses a <strong class="source-inline">ModelBinderProvider</strong> to add the <strong class="source-inline">ModelBinder</strong> to the list of existing ones.</p>
			<p>I personally prefer the explicit declaration because most custom <strong class="source-inline">ModelBinder</strong> will be specific to an <a id="_idIndexMarker205"/>action or to a specific type, and it prevents hidden magic in the background.</p>
			<p>Now, let's test out what we<a id="_idTextAnchor199"/><a id="_idTextAnchor200"/>'ve built.</p>
			<h1 id="_idParaDest-112"><a id="_idTextAnchor201"/>Testing ModelBinder</h1>
			<p>To test it, we need to create <a id="_idIndexMarker206"/>a new request in Postman: </p>
			<ol>
				<li value="1">Start the application by running <strong class="source-inline">dotnet run</strong> in the console or by pressing <em class="italic">F5</em> in Visual Studio or VS Code.</li>
				<li>In Postman, we will then set the request type to <strong class="bold">POST</strong> and insert the URL <strong class="source-inline">https://localhost:5001/api/persons</strong> in the address bar. <p>The port number might vary on your side.</p></li>
				<li>Next, we need to add the CSV data to the body of the request. Select <strong class="source-inline">form-data</strong> as the body type, add the <strong class="source-inline">persons</strong> key, and paste the following value lines in the value field:<p class="source-code">Id,FirstName,LastName,Age,EmailAddress,Address,City,Phone</p><p class="source-code">48,Austin,Ward,49,Jake.Timms@live.com,"8814 Gravesend Neck Road ",Daly City,(620) 260-4410</p><p class="source-code">2,Sierra,Smith,15,Elizabeth.Wright@hotmail.com,"1199 Marshall Street ",Whittier,(655) 379-4362</p><p class="source-code">27,Victorina,Radcliff,40,Bryce.Sanders@rogers.ca,"2663 Sutton Street ",Bloomington,(255) 365-0521</p></li>
				<li>After pressing <strong class="bold">Send</strong>, we get the result, as shown in <em class="italic">Fi<a id="_idTextAnchor202"/>gure 13.2</em>:</li>
			</ol>
			<div>
				<div id="_idContainer054" class="IMG---Figure">
					<img src="image/Figure_13.2_B17996.jpg" alt="Figure 13.2 – A screenshot of CSV data in Postman&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.2 – A screenshot of CSV data in Postman</p>
			<p>Now, the clients will <a id="_idIndexMarker207"/>be able to send CSV-based data to <a id="_idTextAnchor203"/>the server.</p>
			<h1 id="_idParaDest-113"><a id="_idTextAnchor204"/>Summary</h1>
			<p>This is a good way to transform the input in a way that the action needs. You could also use <strong class="source-inline">ModelBinder</strong> to do some custom validation against the database or whatever you need to do before the model gets passed to the action.</p>
			<p>In the next chapter, we will see what you can do with <strong class="source-inline">Act<a id="_idTextAnchor205"/>ionFilter</strong>.</p>
			<h1 id="_idParaDest-114"><a id="_idTextAnchor206"/>Further reading</h1>
			<p>To learn more about <strong class="source-inline">ModelBinder</strong>, you should have a look at the following reasonably detailed documentation:</p>
			<ul>
				<li>Steve Gordon, <em class="italic">Custom ModelBinding in ASP.NET MVC Core</em>: https://www.stevejgordon.co.uk/html-encode-string-aspnet-core-model-binding/</li>
				<li><em class="italic">Model Binding in ASP.NET Core</em>: https://docs.microsoft.com/en-us/aspnet/core/mvc/models/model-binding</li>
				<li><em class="italic">Custom Model Binding in ASP.NET Core</em>: https://docs.microsoft.com/en-us/aspnet/core/mvc/advanced/custom-model-binding</li>
			</ul>
		</div>
	</body></html>