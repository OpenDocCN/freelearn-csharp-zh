<html><head></head><body>
  <div id="_idContainer081">
   <h1 class="chapter-number" id="_idParaDest-92">
    <a id="_idTextAnchor093">
    </a>
    <span class="koboSpan" id="kobo.1.1">
     6
    </span>
   </h1>
   <h1 id="_idParaDest-93">
    <a id="_idTextAnchor094">
    </a>
    <span class="koboSpan" id="kobo.2.1">
     Enhancing Security and Quality
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.3.1">
     In the rapidly evolving digital world, where new cyber threats emerge with alarming frequency, web-based application security is not just a feature but a fundamental necessity.
    </span>
    <span class="koboSpan" id="kobo.3.2">
     So that applications are prepared for various existing vulnerabilities, software engineers must consider security as part of the entire development flow of web-based solutions so that they can protect data, guarantee integrity and availability, and minimize threats that can compromise
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.4.1">
      an organization.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.5.1">
     In this chapter, we’ll learn about basic security principles that every web developer should master, especially regarding how ASP.NET Core 9, as a powerful platform, can help us create secure,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.6.1">
      high-level applications.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.7.1">
     First, we’ll explore the essential principles of web security, understanding that security must be taken into consideration in all phases of developing a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.8.1">
      web solution.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.9.1">
     Next, we’ll address the concepts of authentication and authorization, both of which are commonly used when users and applications, as well as applications and external applications, interact with each other.
    </span>
    <span class="koboSpan" id="kobo.9.2">
     Once we have a better understanding of authorization and authentication flows, we’ll use the ASP.NET Core Identity framework to add security to an API project and learn about some important approaches that are available in ASP.NET Core 9 that allow us to strengthen security mechanisms in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.10.1">
      our applications.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.11.1">
     In this chapter, we’ll cover the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.12.1">
      following topics:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.13.1">
      Understanding the security principles of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.14.1">
       web-based applications
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.15.1">
      Comparing authorization
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.16.1">
       and authentication
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.17.1">
      Working with the ASP.NET Core
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.18.1">
       Identity framework
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.19.1">
      Strengthening
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.20.1">
       application security
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.21.1">
     For us to have a great learning experience in this chapter, we must prepare our environment with some tools that will be essential for us to fully utilize the concepts that will
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.22.1">
      be introduced.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-94">
    <a id="_idTextAnchor095">
    </a>
    <span class="koboSpan" id="kobo.23.1">
     Technical requirements
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.24.1">
     To complete this chapter, the following tools must be present in your
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.25.1">
      development environment:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.26.1">
       Docker
      </span>
     </strong>
     <span class="koboSpan" id="kobo.27.1">
      : Docker Engine must be installed on your operating system and have a SQL Server container running.
     </span>
     <span class="koboSpan" id="kobo.27.2">
      You can find more details about Docker and SQL Server in
     </span>
     <a href="B21788_04.xhtml#_idTextAnchor061">
      <span class="No-Break">
       <em class="italic">
        <span class="koboSpan" id="kobo.28.1">
         Chapter 4
        </span>
       </em>
      </span>
     </a>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.29.1">
       .
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.30.1">
       Postman
      </span>
     </strong>
     <span class="koboSpan" id="kobo.31.1">
      : We’ll use this tool to execute requests that are sent to the APIs of the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.32.1">
       developed application.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.33.1">
       Azure Data Studio
      </span>
     </strong>
     <span class="koboSpan" id="kobo.34.1">
      : We’ll use this tool to connect to a SQL Server database so that we can execute
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.35.1">
       SQL scripts.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.36.1">
     The code examples for this chapter can be found in this book’s GitHub
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.37.1">
      repository:
     </span>
    </span>
    <a href="https://github.com/PacktPublishing/ASP.NET-Core-9.0-Essentials/tree/main/Chapter06">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.38.1">
       https://github.com/PacktPublishing/ASP.NET-Core-9.0-Essentials/tree/main/Chapter06
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.39.1">
      .
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-95">
    <a id="_idTextAnchor096">
    </a>
    <span class="koboSpan" id="kobo.40.1">
     Understanding the security principles of web-based applications
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.41.1">
     Every year, new
    </span>
    <a id="_idIndexMarker396">
    </a>
    <span class="koboSpan" id="kobo.42.1">
     approaches to developing solutions emerge for the most diverse types of environments and devices.
    </span>
    <span class="koboSpan" id="kobo.42.2">
     With this comes various challenges.
    </span>
    <span class="koboSpan" id="kobo.42.3">
     Developing web applications that previously focused on technologies such as HTML, CSS, JavaScript, and a programming language of choice is no longer
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.43.1">
      a reality.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.44.1">
     Software engineers began to serve other contexts outside the environment of a programming IDE, often working with iInfrastructure, adding to a multitude of frameworks and tools that emerged along with the DevOps cCulture approach, and constant
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.45.1">
      value delivery.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.46.1">
     The DevOps culture
    </span>
    <a id="_idIndexMarker397">
    </a>
    <span class="koboSpan" id="kobo.47.1">
     has brought a new working model where teams avoid silos and work together while exchanging knowledge and, consequently, learning.
    </span>
    <span class="koboSpan" id="kobo.47.2">
     Therefore, a subject that is becoming increasingly present in the lives of solution developers is
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.48.1">
      security
     </span>
    </strong>
    <span class="koboSpan" id="kobo.49.1">
     .
    </span>
    <span class="koboSpan" id="kobo.49.2">
     The term security
    </span>
    <a id="_idIndexMarker398">
    </a>
    <span class="koboSpan" id="kobo.50.1">
     has long ceased to be an isolated subject directed only at a cybersecurity team.
    </span>
    <span class="koboSpan" id="kobo.50.2">
     It is now essential from the first stages of design and must be considered in all aspects of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.51.1">
      a solution.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.52.1">
     Paying attention to threats in applications and data control and management has become paramount and is even a strategic factor for companies and customers that use applications.
    </span>
    <span class="koboSpan" id="kobo.52.2">
     There are many security standards and policies from a data processing perspective, such as
    </span>
    <a id="_idIndexMarker399">
    </a>
    <span class="koboSpan" id="kobo.53.1">
     the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.54.1">
      General Data Protection Regulation
     </span>
    </strong>
    <span class="koboSpan" id="kobo.55.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.56.1">
      GDPR
     </span>
    </strong>
    <span class="koboSpan" id="kobo.57.1">
     )
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.58.1">
      in Europe.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.59.1">
     Security is
    </span>
    <a id="_idIndexMarker400">
    </a>
    <span class="koboSpan" id="kobo.60.1">
     very important and ASP.NET Core 9 offers several mechanisms that we can use to deal with the challenges proposed by avoiding threats and maintaining secure and
    </span>
    <a id="_idIndexMarker401">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.61.1">
      reliable applications.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.62.1">
     However, we must understand how security aspects are applied to web applications and common vulnerabilities, as well as how ASP.NET Core 9 works to prevent threats from occurring
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.63.1">
      in applications.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-96">
    <a id="_idTextAnchor097">
    </a>
    <span class="koboSpan" id="kobo.64.1">
     Security topics in web applications
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.65.1">
     As we’ve already learned in previous chapters, in general, a web application has two main components: the frontend, which is responsible for interacting with the user, and the backend, which is responsible for processing the application’s business rules, providing control, and interacting with the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.66.1">
      data layer.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.67.1">
     Most web applications, whether they’re client-server
    </span>
    <a id="_idIndexMarker402">
    </a>
    <span class="koboSpan" id="kobo.68.1">
     ones or
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.69.1">
      single-page applications
     </span>
    </strong>
    <span class="koboSpan" id="kobo.70.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.71.1">
      SPAs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.72.1">
     ), use the aforementioned approach in some way.
    </span>
    <span class="koboSpan" id="kobo.72.2">
     As shown in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.73.1">
       Figure 6
      </span>
     </em>
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.74.1">
      .1
     </span>
    </em>
    <span class="koboSpan" id="kobo.75.1">
     , several components are part of how the frontend and backend interact, such as the communication protocol, requests, responses, HTTP headers, the browser, the application server, the database, the TCP protocol, credentials, cookies, and local storage (browser),
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.76.1">
      among others:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer064">
     <span class="koboSpan" id="kobo.77.1">
      <img alt="Figure 6.1 – Components of a SPA" src="image/B21788_06_1.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.78.1">
     Figure 6.1 – Components of a SPA
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.79.1">
     As we can see, several
    </span>
    <a id="_idIndexMarker403">
    </a>
    <span class="koboSpan" id="kobo.80.1">
     components communicate with
    </span>
    <a id="_idIndexMarker404">
    </a>
    <span class="koboSpan" id="kobo.81.1">
     each other.
    </span>
    <span class="koboSpan" id="kobo.81.2">
     Similarly, several vulnerabilities can compromise the integrity of your application.
    </span>
    <span class="koboSpan" id="kobo.81.3">
     In some cases, an information leak can have serious consequences for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.82.1">
      an organization.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.83.1">
     As a premise, software engineers must have a security aspect set out from the initial design stage that can often be associated not only with communication protocols and interactions between systems but also with
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.84.1">
      code development.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.85.1">
     Let’s say that, during the development process, a software engineer made a very important change that was supposed to fix a critical problem in the application.
    </span>
    <span class="koboSpan" id="kobo.85.2">
     To quickly perform the correction, the software engineer created communication with the database using SQL commands and string concatenation.
    </span>
    <span class="koboSpan" id="kobo.85.3">
     After carrying out the tests, the engineer submitted the code to the Git repository so that the system could be updated.
    </span>
    <span class="koboSpan" id="kobo.85.4">
     There was no code review and within a few minutes, the fix was in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.86.1">
      production environment.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.87.1">
     So, what’s wrong in this
    </span>
    <a id="_idIndexMarker405">
    </a>
    <span class="koboSpan" id="kobo.88.1">
     scenario?
    </span>
    <span class="koboSpan" id="kobo.88.2">
     Initially, the software engineer acted correctly in providing a quick response to the problem that was found in the application and corrected it, and everything returned to normal.
    </span>
    <span class="koboSpan" id="kobo.88.3">
     However, the approach they used to communicate with the database contained a vulnerability that could be exploited by malicious users by utilizing what’s
    </span>
    <a id="_idIndexMarker406">
    </a>
    <span class="koboSpan" id="kobo.89.1">
     known as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.90.1">
      SQL
     </span>
    </strong>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.91.1">
       injection attacks
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.92.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.93.1">
     Let’s look at an example of some code that’s vulnerable to SQL
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.94.1">
      injection attacks:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.95.1">
using System;
using System.Data.SqlClient;
public class VulnerableDataAccess
{
  private string connectionString = "TheConnectionString";
  public void GetUserData(string username)
  {
    </span><strong class="bold"><span class="koboSpan" id="kobo.96.1">string query = "SELECT * FROM Users WHERE</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.97.1">      Username = '" + username + "'";</span></strong><span class="koboSpan" id="kobo.98.1">
    using (SqlConnection connection = new
      SqlConnection(connectionString))
    {
      SqlCommand command = new SqlCommand(query,
        connection);
      try
      {
        connection.Open();
        SqlDataReader reader = command.ExecuteReader();
        while (reader.Read())
        {
          Console.WriteLine(String.Format("{0}, {1}",
            reader["Username"], reader["Email"]));
        }
        reader.Close();
      }
      catch (Exception ex)
      {
        Console.WriteLine(ex.Message);
      }
    }
  }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.99.1">
     In the preceding code, the
    </span>
    <a id="_idIndexMarker407">
    </a>
    <span class="koboSpan" id="kobo.100.1">
     SQL query has been constructed by directly concatenating a user’s input (username) into the SQL string.
    </span>
    <span class="koboSpan" id="kobo.100.2">
     This is a dangerous practice because it allows an attacker to alter the intended SQL query by injecting SQL code into the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.101.1">
      username
     </span>
    </strong>
    <span class="koboSpan" id="kobo.102.1">
     variable.
    </span>
    <span class="koboSpan" id="kobo.102.2">
     For example, if a user enters something like
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.103.1">
      '; DROP TABLE users; --
     </span>
    </strong>
    <span class="koboSpan" id="kobo.104.1">
     , the resulting SQL query would be
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.105.1">
      as follows:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.106.1">
SELECT * FROM Users WHERE Username = </span><strong class="bold"><span class="koboSpan" id="kobo.107.1">''; DROP TABLE Users; --'</span></strong></pre>
   <p>
    <span class="koboSpan" id="kobo.108.1">
     This would execute the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.109.1">
      DROP TABLE
     </span>
    </strong>
    <span class="koboSpan" id="kobo.110.1">
     statement, potentially
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.111.1">
      destroying data.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.112.1">
     So, a simple change such as this, even
    </span>
    <a id="_idIndexMarker408">
    </a>
    <span class="koboSpan" id="kobo.113.1">
     with great intentions, could have a big impact.
    </span>
    <span class="koboSpan" id="kobo.113.2">
     Likewise, simple processes can avoid this situation by implementing a code review, a practice where members of the engineering team analyze the code that should be incorporated into the main code to search for any flaws, evaluate code patterns and complexity, and more.
    </span>
    <span class="koboSpan" id="kobo.113.3">
     The code can only be incorporated into the main code if it meets the quality and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.114.1">
      security criteria.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.115.1">
     Furthermore, while integrating the new code into the main code, automated processes can be executed, where it would be possible to
    </span>
    <a id="_idIndexMarker409">
    </a>
    <span class="koboSpan" id="kobo.116.1">
     add
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.117.1">
      static code analysis
     </span>
    </strong>
    <span class="koboSpan" id="kobo.118.1">
     mechanisms.
    </span>
    <span class="koboSpan" id="kobo.118.2">
     If there are any invalid security and quality criteria, the application can’t be delivered to the productive environment.
    </span>
    <span class="koboSpan" id="kobo.118.3">
     We’ll learn more about automated processes in
    </span>
    <a href="B21788_10.xhtml#_idTextAnchor162">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.119.1">
        Chapter 10
       </span>
      </em>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.120.1">
      .
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.121.1">
     Static code analysis
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.122.1">
     Static code analysis
    </span>
    <a id="_idIndexMarker410">
    </a>
    <span class="koboSpan" id="kobo.123.1">
     acts on security checks, coding standards, and cyclomatic complexity analysis, among other aspects, adding value to the application development
    </span>
    <a id="_idIndexMarker411">
    </a>
    <span class="koboSpan" id="kobo.124.1">
     process associated with automation techniques
    </span>
    <a id="_idIndexMarker412">
    </a>
    <span class="koboSpan" id="kobo.125.1">
     that involve
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.126.1">
      continuous integration
     </span>
    </strong>
    <span class="koboSpan" id="kobo.127.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.128.1">
      CI
     </span>
    </strong>
    <span class="koboSpan" id="kobo.129.1">
     ) and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.130.1">
      continuous delivery
     </span>
    </strong>
    <span class="koboSpan" id="kobo.131.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.132.1">
      CD
     </span>
    </strong>
    <span class="koboSpan" id="kobo.133.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.133.2">
     There are several tools available in the market for static code analysis, with the most famous
    </span>
    <a id="_idIndexMarker413">
    </a>
    <span class="koboSpan" id="kobo.134.1">
     being
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.135.1">
      SonarQube
     </span>
    </strong>
    <span class="koboSpan" id="kobo.136.1">
     (
    </span>
    <a href="https://hub.docker.com/_/sonarqube">
     <span class="koboSpan" id="kobo.137.1">
      https://hub.docker.com/_/sonarqube
     </span>
    </a>
    <span class="koboSpan" id="kobo.138.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.138.2">
     It has a community version and can be hosted in any environment.
    </span>
    <span class="koboSpan" id="kobo.138.3">
     However, it does have some limitations regarding how many lines of
    </span>
    <a id="_idIndexMarker414">
    </a>
    <span class="koboSpan" id="kobo.139.1">
     code can be analyzed.
    </span>
    <span class="koboSpan" id="kobo.139.2">
     Alternatively, there’s a version that’s delivered as a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.140.1">
      Software-as-a-Service
     </span>
    </strong>
    <span class="koboSpan" id="kobo.141.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.142.1">
      SaaS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.143.1">
     ) offering
    </span>
    <a id="_idIndexMarker415">
    </a>
    <span class="koboSpan" id="kobo.144.1">
     called
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.145.1">
      Sonar
     </span>
    </strong>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.146.1">
       Cloud
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.147.1">
      (
     </span>
    </span>
    <a href="https://www.sonarsource.com/products/sonarcloud/">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.148.1">
       https://www.sonarsource.com/products/sonarcloud/
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.149.1">
      ).
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.150.1">
     Adding static analysis to the development flow is an
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.151.1">
      excellent practice.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.152.1">
     In this chapter, we’ll explore other ways we can make our applications more secure and talk about various vulnerabilities.
    </span>
    <span class="koboSpan" id="kobo.152.2">
     But first, let’s understand a common security model that’s used by most applications that’s based on two basic processes: authentication
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.153.1">
      and authorization.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-97">
    <a id="_idTextAnchor098">
    </a>
    <span class="koboSpan" id="kobo.154.1">
     Comparing authorization and authentication
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.155.1">
     As we’ve been learning, the security aspect is important throughout the application development flow.
    </span>
    <span class="koboSpan" id="kobo.155.2">
     Despite having good intentions, we can include vulnerabilities in our code that directly affect our users, applications,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.156.1">
      and companies.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.157.1">
     However, in addition to the code, some features require security processes.
    </span>
    <span class="koboSpan" id="kobo.157.2">
     For example, this is the case for some service platforms, such as email managers, which allow users to access their messages privately once they’ve gained access by
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.158.1">
      logging in.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.159.1">
     The login functionality is very important and, although it seems like a simple process, it requires a lot of attention.
    </span>
    <span class="koboSpan" id="kobo.159.2">
     Otherwise, depending on the application, there may
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.160.1">
      be consequences.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.161.1">
     What would happen if there was a vulnerability upon logging into an online banking platform?
    </span>
    <span class="koboSpan" id="kobo.161.2">
     It would probably be a big problem for the users of this bank (and also for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.162.1">
      the bank).
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.163.1">
     Modern systems work with identity management for different aspects.
    </span>
    <span class="koboSpan" id="kobo.163.2">
     As discussed in previous chapters, web applications can make requests to different APIs.
    </span>
    <span class="koboSpan" id="kobo.163.3">
     APIs allow companies to provide business as services, which allows for diverse integrations between different applications.
    </span>
    <span class="koboSpan" id="kobo.163.4">
     With this, it’s possible to have applications with different types of functionalities that add value to the user, such as map APIs, payment gateways, and even APIs that provide
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.164.1">
      AI functionalities.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.165.1">
     For applications and APIs to communicate securely, an identity-based security mechanism is necessary.
    </span>
    <span class="koboSpan" id="kobo.165.2">
     With this, we can find out who is demanding some type of information
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.166.1">
      and why.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.167.1">
     This security
    </span>
    <a id="_idIndexMarker416">
    </a>
    <span class="koboSpan" id="kobo.168.1">
     mechanism is
    </span>
    <a id="_idIndexMarker417">
    </a>
    <span class="koboSpan" id="kobo.169.1">
     divided into two concepts:
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.170.1">
      authentication
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.171.1">
      and
     </span>
    </span>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.172.1">
       authorization
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.173.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.174.1">
     In general, we know that this approach involves a login flow.
    </span>
    <span class="koboSpan" id="kobo.174.2">
     However, it’s essential to understand the difference between authentication
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.175.1">
      and authorization.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-98">
    <a id="_idTextAnchor099">
    </a>
    <span class="koboSpan" id="kobo.176.1">
     Authentication
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.177.1">
     Authentication
    </span>
    <a id="_idIndexMarker418">
    </a>
    <span class="koboSpan" id="kobo.178.1">
     aims to answer the question,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.179.1">
      Who
     </span>
    </em>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.180.1">
       are you?
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.181.1">
      :
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer065">
     <span class="koboSpan" id="kobo.182.1">
      <img alt="Figure 6.2 – The authentication flow" src="image/B21788_06_2.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.183.1">
     Figure 6.2 – The authentication flow
    </span>
   </p>
   <p>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.184.1">
       Figure 6
      </span>
     </em>
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.185.1">
      .2
     </span>
    </em>
    <span class="koboSpan" id="kobo.186.1">
     shows an
    </span>
    <a id="_idIndexMarker419">
    </a>
    <span class="koboSpan" id="kobo.187.1">
     authentication flow where, through a login form, a user’s credentials are provided, such as their email
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.188.1">
      and password.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.189.1">
     By posting this information to the server by clicking the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.190.1">
      log in
     </span>
    </strong>
    <span class="koboSpan" id="kobo.191.1">
     button, the application starts identifying this user by using the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.192.1">
      credentials provided.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.193.1">
     If the user is found according to these credentials, then the application is aware of who wants to access
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.194.1">
      the system.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.195.1">
     However, this is just one part
    </span>
    <a id="_idIndexMarker420">
    </a>
    <span class="koboSpan" id="kobo.196.1">
     of the process.
    </span>
    <span class="koboSpan" id="kobo.196.2">
     Now that the application has identified the user, it’s important to understand what this user can do.
    </span>
    <span class="koboSpan" id="kobo.196.3">
     This is done during the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.197.1">
      authorization process.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-99">
    <a id="_idTextAnchor100">
    </a>
    <span class="koboSpan" id="kobo.198.1">
     Authorization
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.199.1">
     Authorization aims to
    </span>
    <a id="_idIndexMarker421">
    </a>
    <span class="koboSpan" id="kobo.200.1">
     answer the question,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.201.1">
      What can this
     </span>
    </em>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.202.1">
       user do?
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.203.1">
      :
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer066">
     <span class="koboSpan" id="kobo.204.1">
      <img alt="Figure 6.3 – Checking permissions with the authorization flow" src="image/B21788_06_3.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.205.1">
     Figure 6.3 – Checking permissions with the authorization flow
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.206.1">
     After identifying the user, the application starts identifying the user’s permissions, as shown in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.207.1">
       Figure 6
      </span>
     </em>
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.208.1">
       .3
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.209.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.210.1">
     Authorization
    </span>
    <a id="_idIndexMarker422">
    </a>
    <span class="koboSpan" id="kobo.211.1">
     defines the scope in which this user can act, whether in managing some information or accessing a certain type of data, among other aspects.
    </span>
    <span class="koboSpan" id="kobo.211.2">
     The authorization flow often identifies the user through roles, where it’s possible to group access levels within the scope of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.212.1">
      the application.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.213.1">
     It’s very common to use roles because it’s possible to group the different permissions that a user can have within
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.214.1">
      an application.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.215.1">
     In general, the authentication
    </span>
    <a id="_idIndexMarker423">
    </a>
    <span class="koboSpan" id="kobo.216.1">
     and
    </span>
    <a id="_idIndexMarker424">
    </a>
    <span class="koboSpan" id="kobo.217.1">
     authorization processes are simple.
    </span>
    <span class="koboSpan" id="kobo.217.2">
     However, to be able to implement them securely, there are some standards that
    </span>
    <a id="_idIndexMarker425">
    </a>
    <span class="koboSpan" id="kobo.218.1">
     we must be
    </span>
    <a id="_idIndexMarker426">
    </a>
    <span class="koboSpan" id="kobo.219.1">
     aware of: the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.220.1">
      OAuth 2.0
     </span>
    </strong>
    <span class="koboSpan" id="kobo.221.1">
     and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.222.1">
      Open ID Connect
     </span>
    </strong>
    <span class="koboSpan" id="kobo.223.1">
     (
    </span>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.224.1">
       OIDC
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.225.1">
      ) protocols.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-100">
    <a id="_idTextAnchor101">
    </a>
    <span class="koboSpan" id="kobo.226.1">
     Understanding OAuth 2.0 and OIDC
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.227.1">
     Imagine a high-security building.
    </span>
    <span class="koboSpan" id="kobo.227.2">
     Here, authorization can be thought of as acquiring permission to enter, while authentication verifies
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.228.1">
      your identity.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.229.1">
     OAuth 2.0 focuses
    </span>
    <a id="_idIndexMarker427">
    </a>
    <span class="koboSpan" id="kobo.230.1">
     on authorization, allowing users to grant access to their data on one platform (such as a social media account) to another, without the need for them to share their actual passwords.
    </span>
    <span class="koboSpan" id="kobo.230.2">
     In other words, we allow other applications to access a certain scope of our information without us having to provide certain credentials, such as what happens when we log in to some platform using credentials from Microsoft, Google, Facebook, and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.231.1">
      so on.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.232.1">
     The basic OAuth 2.0 flow
    </span>
    <a id="_idIndexMarker428">
    </a>
    <span class="koboSpan" id="kobo.233.1">
     can be defined
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.234.1">
      as follows:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.235.1">
      The user logs in to a new application using their social
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.236.1">
       media account.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.237.1">
      The application redirects the user to the social media platform (the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.238.1">
       authorization server).
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.239.1">
      After logging into the social media account, the user grants the application permission to use their data (such as their name, email, profile photo,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.240.1">
       and more).
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.241.1">
      The authorization server generates special tokens for the application.
     </span>
     <span class="koboSpan" id="kobo.241.2">
      Tokens are used to gain access to user data (access tokens).
     </span>
     <span class="koboSpan" id="kobo.241.3">
      In some cases, refresh tokens are used to provide access to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.242.1">
       new tokens.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.243.1">
      The application uses the access token to retrieve your data from the social media
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.244.1">
       platform securely.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.245.1">
     This process involves negotiating two different applications that share user information, without the need to enter their credentials for each new application, increasing security
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.246.1">
      and convenience.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.247.1">
     On the other hand, OIDC builds on OAuth 2.0, adding an authentication layer.
    </span>
    <span class="koboSpan" id="kobo.247.2">
     It leverages the OAuth authorization framework to verify a user’s identity through trusted providers such as Google
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.248.1">
      or Facebook.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.249.1">
     Let’s see how OIDC complements
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.250.1">
      OAuth 2.0:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.251.1">
      Some applications
     </span>
     <a id="_idIndexMarker429">
     </a>
     <span class="koboSpan" id="kobo.252.1">
      provide the ability to log in using other social media platforms.
     </span>
     <span class="koboSpan" id="kobo.252.2">
      In this case, during the OAuth 2.0 flow, instead of logging into the new application, you’re redirected to your social media login page (the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.253.1">
       OpenID provider).
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.254.1">
      The user authenticates with their social media credentials, proving their identity to the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.255.1">
       OpenID provider.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.256.1">
      With the user’s consent, the OpenID provider shares their basic profile information (such as name and email) with the new application via an
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.257.1">
       ID token.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.258.1">
     OIDC enables features such
    </span>
    <a id="_idIndexMarker430">
    </a>
    <span class="koboSpan" id="kobo.259.1">
     as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.260.1">
      single sign-on
     </span>
    </strong>
    <span class="koboSpan" id="kobo.261.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.262.1">
      SSO
     </span>
    </strong>
    <span class="koboSpan" id="kobo.263.1">
     ), allowing you to access multiple applications using the same login credentials (think of logging into multiple websites with your
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.264.1">
      Google account).
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.265.1">
     Although OAuth 2.0
    </span>
    <a id="_idIndexMarker431">
    </a>
    <span class="koboSpan" id="kobo.266.1">
     and OIDC flows are similar and interconnected, they serve
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.267.1">
      different purposes:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.268.1">
       Focus
      </span>
     </strong>
     <span class="koboSpan" id="kobo.269.1">
      : OAuth 2.0 acts on authorization (granting access to data), while OIDC acts on the authentication layer (verifying
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.270.1">
       user identity).
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.271.1">
       Sharing information
      </span>
     </strong>
     <span class="koboSpan" id="kobo.272.1">
      : OAuth 2.0 mainly deals with access tokens, while OIDC introduces ID tokens containing user
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.273.1">
       profile information.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.274.1">
     We can think of OAuth 2.0 as a key that opens the door to a house, while OIDC provides identity verification so that this key can
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.275.1">
      be received.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.276.1">
     This flow is quite common in several applications we use, as shown in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.277.1">
       Figure 6
      </span>
     </em>
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.278.1">
       .4
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.279.1">
      :
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer067">
     <span class="koboSpan" id="kobo.280.1">
      <img alt="Figure 6.4 – Basic OAuth 2.0 flow" src="image/B21788_06_4.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.281.1">
     Figure 6.4 – Basic OAuth 2.0 flow
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.282.1">
     The authorization
    </span>
    <a id="_idIndexMarker432">
    </a>
    <span class="koboSpan" id="kobo.283.1">
     and authentication flows are constantly used by applications, allowing both to identify who the users are and define the type of permissions that these users can execute in a web system
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.284.1">
      or API.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.285.1">
     Despite this straightforward explanation of the OAuth 2.0 and OIDC protocols, as well as concepts of authorization and authentication, the task of implementing this approach isn’t simple and depends on some important mechanisms to ensure these functionalities are
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.286.1">
      running correctly.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.287.1">
     Due to this, ASP.NET Core 9 has abstractions that support the development of identity management while following the standards outlined so far.
    </span>
    <span class="koboSpan" id="kobo.287.2">
     The abstraction that implements these resources is known
    </span>
    <a id="_idIndexMarker433">
    </a>
    <span class="koboSpan" id="kobo.288.1">
     as ASP.NET Core Identity.
    </span>
    <span class="koboSpan" id="kobo.288.2">
     It has been evolving with each new version of the framework and allows teams to use security best practices in their authorization and authentication flows, as well as integrate with other identity providers while allowing customizations to be made.
    </span>
    <span class="koboSpan" id="kobo.288.3">
     We’ll learn more about this approach in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.289.1">
      next section.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-101">
    <a id="_idTextAnchor102">
    </a>
    <span class="koboSpan" id="kobo.290.1">
     Working with the ASP.NET Core Identity framework
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.291.1">
     Modern applications
    </span>
    <a id="_idIndexMarker434">
    </a>
    <span class="koboSpan" id="kobo.292.1">
     interact with different types of technologies, protocols, and standards.
    </span>
    <span class="koboSpan" id="kobo.292.2">
     As we’ve been learning, security is extremely important at any level of a solution’s implementation flow.
    </span>
    <span class="koboSpan" id="kobo.292.3">
     A book could easily be dedicated to the subject of authorization
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.293.1">
      and authentication.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.294.1">
     However, the ASP.NET Core 9 platform has been evolving every year and as a result, the identity management model has undergone several improvements, in addition to some dependencies
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.295.1">
      being eliminated.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.296.1">
     To be able to implement authorization and authentication in our applications, we have ASP.NET Core Identity.
    </span>
    <span class="koboSpan" id="kobo.296.2">
     It’s a membership system that adds capabilities to web-based applications developed in ASP.NET Core 9 and operates in both authentication and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.297.1">
      authorization flows.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.298.1">
     The set of features available in ASP.NET Core Identity includes APIs, a UI, databases between user identity management and credentials, and the ability to grant and revoke permissions.
    </span>
    <span class="koboSpan" id="kobo.298.2">
     This is in addition to features
    </span>
    <a id="_idIndexMarker435">
    </a>
    <span class="koboSpan" id="kobo.299.1">
     such as integration with external logins,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.300.1">
      two-factor authentication
     </span>
    </strong>
    <span class="koboSpan" id="kobo.301.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.302.1">
      2FA
     </span>
    </strong>
    <span class="koboSpan" id="kobo.303.1">
     ), password management, being able to block and activate accounts, and providing authentication
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.304.1">
      in applications.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.305.1">
     Before we learn how to integrate an application with ASP.NET Core identity, let’s learn more about
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.306.1">
      its structure.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-102">
    <a id="_idTextAnchor103">
    </a>
    <span class="koboSpan" id="kobo.307.1">
     Understanding the ASP.NET Core Identity architecture
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.308.1">
     ASP.NET Core Identity
    </span>
    <a id="_idIndexMarker436">
    </a>
    <span class="koboSpan" id="kobo.309.1">
     has an architectural structure that’s divided into the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.310.1">
      following layers:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.311.1">
       Identity manager
      </span>
     </strong>
     <span class="koboSpan" id="kobo.312.1">
      : These are
     </span>
     <a id="_idIndexMarker437">
     </a>
     <span class="koboSpan" id="kobo.313.1">
      service classes that are responsible for implementing the business logic that involves identities.
     </span>
     <span class="koboSpan" id="kobo.313.2">
      We can find classes such as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.314.1">
       UserManager
      </span>
     </strong>
     <span class="koboSpan" id="kobo.315.1">
      for user management and
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.316.1">
       RoleManager
      </span>
     </strong>
     <span class="koboSpan" id="kobo.317.1">
      for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.318.1">
       role management.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.319.1">
       Identity store
      </span>
     </strong>
     <span class="koboSpan" id="kobo.320.1">
      : The identity store
     </span>
     <a id="_idIndexMarker438">
     </a>
     <span class="koboSpan" id="kobo.321.1">
      is the domain entity that represents each piece of data in a database.
     </span>
     <span class="koboSpan" id="kobo.321.2">
      We can see the identity store as a table in the database that’s mapped to a class such as
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.322.1">
       UserStore
      </span>
     </strong>
     <span class="koboSpan" id="kobo.323.1">
      or
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.324.1">
       RoleStore
      </span>
     </strong>
     <span class="koboSpan" id="kobo.325.1">
      ,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.326.1">
       among others.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.327.1">
       Data access layer
      </span>
     </strong>
     <span class="koboSpan" id="kobo.328.1">
      : These
     </span>
     <a id="_idIndexMarker439">
     </a>
     <span class="koboSpan" id="kobo.329.1">
      are classes that have the necessary logic to interact with the database so that they can persist and retrieve
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.330.1">
       identity-related information.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.331.1">
       Data source
      </span>
     </strong>
     <span class="koboSpan" id="kobo.332.1">
      : The
     </span>
     <a id="_idIndexMarker440">
     </a>
     <span class="koboSpan" id="kobo.333.1">
      data source is the data mechanism that will be used for persistence.
     </span>
     <span class="koboSpan" id="kobo.333.2">
      By default, ASP.NET Core Identity
     </span>
     <a id="_idIndexMarker441">
     </a>
     <span class="koboSpan" id="kobo.334.1">
      uses
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.335.1">
       SQL Server
      </span>
     </strong>
     <span class="koboSpan" id="kobo.336.1">
      .
     </span>
     <span class="koboSpan" id="kobo.336.2">
      However, there are other databases available, and there’s the possibility of customizing other
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.337.1">
       data sources.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.338.1">
     These four layers have well-defined responsibilities and are fully extensible, bringing flexibility to development and allowing the identity mechanism to be customized according to the context required in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.339.1">
      an organization.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.340.1">
     ASP.NET Core Identity manages both authentication and authorization and works with the following types
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.341.1">
      of data:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.342.1">
       Users
      </span>
     </strong>
     <span class="koboSpan" id="kobo.343.1">
      : These
     </span>
     <a id="_idIndexMarker442">
     </a>
     <span class="koboSpan" id="kobo.344.1">
      represent users in the application.
     </span>
     <span class="koboSpan" id="kobo.344.2">
      This entity has some basic attributes implemented, but they can easily
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.345.1">
       be extended.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.346.1">
       User claims
      </span>
     </strong>
     <span class="koboSpan" id="kobo.347.1">
      : These are a
     </span>
     <a id="_idIndexMarker443">
     </a>
     <span class="koboSpan" id="kobo.348.1">
      set of statements (claims) about a user.
     </span>
     <span class="koboSpan" id="kobo.348.2">
      Claims add information to the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.349.1">
       user’s identity.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.350.1">
       User logins
      </span>
     </strong>
     <span class="koboSpan" id="kobo.351.1">
      : These
     </span>
     <a id="_idIndexMarker444">
     </a>
     <span class="koboSpan" id="kobo.352.1">
      provide information about authentication with external providers such as Facebook, Google, Microsoft, and others, if your application has any integration with
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.353.1">
       these providers.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.354.1">
       Roles
      </span>
     </strong>
     <span class="koboSpan" id="kobo.355.1">
      : These are
     </span>
     <a id="_idIndexMarker445">
     </a>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.356.1">
       authorization groups.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.357.1">
     Based on the information that’s managed by the ASP.NET Core Identity platform, we have what we need to implement authorization and authentication flows in our applications.
    </span>
    <span class="koboSpan" id="kobo.357.2">
     However, this is a robust and highly customizable framework that allows various customizations to be implemented across
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.358.1">
      identity types.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.359.1">
     Customizing Identity
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.360.1">
     If you want to customize Identity, please consult the official
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.361.1">
      documentation:
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/aspnet/core/security/authentication/customize-identity-model?view=aspnetcore-9.0">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.362.1">
       https://learn.microsoft.com/en-us/aspnet/core/security/authentication/customize-identity-model?view=aspnetcore-9.0
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.363.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.364.1">
     Now that we know more about the architectural structure of ASP.NET Core Identity, it’s time to add it to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.365.1">
      an application.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-103">
    <a id="_idTextAnchor104">
    </a>
    <span class="koboSpan" id="kobo.366.1">
     Getting started with integrating ASP.NET Core Identity
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.367.1">
     Now that we have
    </span>
    <a id="_idIndexMarker446">
    </a>
    <span class="koboSpan" id="kobo.368.1">
     greater knowledge about some of the security perspectives that are part of the context of an application, it’s time to use ASP.NET Core Identity to add authorization and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.369.1">
      authentication flows.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.370.1">
     As a basis, we’ll use the source code available in this book’s GitHub repository, as mentioned in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.371.1">
      Technical requirements
     </span>
    </em>
    <span class="koboSpan" id="kobo.372.1">
     section, where you’ll be able to download the complete solution.
    </span>
    <span class="koboSpan" id="kobo.372.2">
     The project we’ll be using is a version of the API project that we created in
    </span>
    <a href="B21788_05.xhtml#_idTextAnchor078">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.373.1">
        Chapter 5
       </span>
      </em>
     </span>
    </a>
    <em class="italic">
    </em>
    <span class="koboSpan" id="kobo.374.1">
     since all assumptions related to database configurations have been created.
    </span>
    <span class="koboSpan" id="kobo.374.2">
     Therefore, we’ll leverage the API structure and database structure created earlier.
    </span>
    <span class="koboSpan" id="kobo.374.3">
     The objective is to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.375.1">
      implement Identity.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.376.1">
     Database settings
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.377.1">
     When starting a new project, you’ll need to configure
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.378.1">
      EntityFrameworkCore
     </span>
    </strong>
    <span class="koboSpan" id="kobo.379.1">
     and connect the application to a database, as we learned in
    </span>
    <a href="B21788_05.xhtml#_idTextAnchor078">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.380.1">
        Chapter 5
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.381.1">
     .
    </span>
    <span class="koboSpan" id="kobo.381.2">
     This way, you’ll be able to follow along and configure ASP.NET Core Identity
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.382.1">
      with ease.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.383.1">
     For this application, which
    </span>
    <a id="_idIndexMarker447">
    </a>
    <span class="koboSpan" id="kobo.384.1">
     is a web API that connects to a SQL Server
    </span>
    <a id="_idIndexMarker448">
    </a>
    <span class="koboSpan" id="kobo.385.1">
     database, we’ll use the same model we learned about in
    </span>
    <a href="B21788_05.xhtml#_idTextAnchor078">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.386.1">
        Chapter 5
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.387.1">
     and use
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.388.1">
      EntityFrameworkCore
     </span>
    </strong>
    <span class="koboSpan" id="kobo.389.1">
     .
    </span>
    <span class="koboSpan" id="kobo.389.2">
     To do so, we’ll need to add one more library:
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.390.1">
      Microsoft.AspNetCore.Identity.EntityFrameworkCore
     </span>
    </strong>
    <span class="koboSpan" id="kobo.391.1">
     .
    </span>
    <span class="koboSpan" id="kobo.391.2">
     This library allows Identity to work with
    </span>
    <a id="_idIndexMarker449">
    </a>
    <span class="koboSpan" id="kobo.392.1">
     Entity
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.393.1">
      Framework Core.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.394.1">
     Ensure this library has been added to your project by opening the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.395.1">
      WorkingWithIdentity.csproj
     </span>
    </strong>
    <span class="koboSpan" id="kobo.396.1">
     file or running the following command in your terminal, inside the application directory, to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.397.1">
      install it:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.398.1">
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore -v 8.0.2</span></pre>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.399.1">
     Creating the WorkingWithIdentity.csproj project
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.400.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.401.1">
      WorkingWithIdentity.csproj
     </span>
    </strong>
    <span class="koboSpan" id="kobo.402.1">
     project is a
    </span>
    <a id="_idIndexMarker450">
    </a>
    <span class="koboSpan" id="kobo.403.1">
     web API that will be protected with ASP.NET Core Identity and is available in this book’s GitHub repository, as described in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.404.1">
      Technical requirements
     </span>
    </em>
    <span class="koboSpan" id="kobo.405.1">
     section.
    </span>
    <span class="koboSpan" id="kobo.405.2">
     However, if you want to create the project for yourself, follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.406.1">
      these steps:
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.407.1">
     1.
    </span>
    <span class="koboSpan" id="kobo.407.2">
     Open your operating system’s terminal and access the folder where the project should
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.408.1">
      be created.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.409.1">
     2.
    </span>
    <span class="koboSpan" id="kobo.409.2">
     Run the following command to create
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.410.1">
      the project:
     </span>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.411.1">
      dotnet new webapi -
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.412.1">
       n WorkingWithIdentity
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.413.1">
     3.
    </span>
    <span class="koboSpan" id="kobo.413.2">
     Access the new
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.414.1">
      project folder:
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.415.1">
       cd WorkingWithIdentity
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.416.1">
     4.
    </span>
    <span class="koboSpan" id="kobo.416.2">
     Add the following NuGet packages, all of which are necessary for using the SQL
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.417.1">
      Server database:
     </span>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.418.1">
      dotnet add
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.419.1">
       package Microsoft.EntityFrameworkCore
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.420.1">
      dotnet add
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.421.1">
       package Microsoft.EntityFrameworkCore.SqlServer
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.422.1">
      dotnet add
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.423.1">
       package Microsoft.EntityFrameworkCore.Design
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.424.1">
     5.
    </span>
    <span class="koboSpan" id="kobo.424.2">
     Make sure you have
    </span>
    <a id="_idIndexMarker451">
    </a>
    <span class="koboSpan" id="kobo.425.1">
     the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.426.1">
      dotnet-ef
     </span>
    </strong>
    <span class="koboSpan" id="kobo.427.1">
     tool installed.
    </span>
    <span class="koboSpan" id="kobo.427.2">
     To do so, run the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.428.1">
      following
     </span>
    </span>
    <span class="No-Break">
     <a id="_idIndexMarker452">
     </a>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.429.1">
      command:
     </span>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.430.1">
      dotnet tool install
     </span>
    </strong>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.431.1">
      --
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.432.1">
       global
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.433.1">
       dotnet-ef
      </span>
     </strong>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.434.1">
     By default, the project already contains
    </span>
    <a id="_idIndexMarker453">
    </a>
    <span class="koboSpan" id="kobo.435.1">
     the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.436.1">
      Microsoft.AspNetCore.Identity
     </span>
    </strong>
    <span class="koboSpan" id="kobo.437.1">
     library since we added it when we created the project.
    </span>
    <span class="koboSpan" id="kobo.437.2">
     However, we still
    </span>
    <a id="_idIndexMarker454">
    </a>
    <span class="koboSpan" id="kobo.438.1">
     need to follow a few more steps to configure the project.
    </span>
    <span class="koboSpan" id="kobo.438.2">
     Let’s start by configuring the database context so that the stores and Identity
    </span>
    <a id="_idIndexMarker455">
    </a>
    <span class="koboSpan" id="kobo.439.1">
     models can be mapped
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.440.1">
      by
     </span>
    </span>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.441.1">
       EntityFramework
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.442.1">
      .
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-104">
    <a id="_idTextAnchor105">
    </a>
    <span class="koboSpan" id="kobo.443.1">
     Configuring the database context
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.444.1">
     For ASP.NET
    </span>
    <a id="_idIndexMarker456">
    </a>
    <span class="koboSpan" id="kobo.445.1">
     Core Identity to be able to manage
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.446.1">
      users
     </span>
    </strong>
    <span class="koboSpan" id="kobo.447.1">
     ,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.448.1">
      roles
     </span>
    </strong>
    <span class="koboSpan" id="kobo.449.1">
     ,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.450.1">
      claims
     </span>
    </strong>
    <span class="koboSpan" id="kobo.451.1">
     , and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.452.1">
      tokens
     </span>
    </strong>
    <span class="koboSpan" id="kobo.453.1">
     , we must configure the application by adding this capability to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.454.1">
      DbContext
     </span>
    </strong>
    <span class="koboSpan" id="kobo.455.1">
     class, which is responsible for interacting with the SQL
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.456.1">
      Server database.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.457.1">
     To do this, we must change the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.458.1">
      BankingDbContext
     </span>
    </strong>
    <span class="koboSpan" id="kobo.459.1">
     class, available in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.460.1">
      Context
     </span>
    </strong>
    <span class="koboSpan" id="kobo.461.1">
     directory of the reference project in this
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.462.1">
      chapter’s repository.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.463.1">
     The first step is to change the inheritance class to
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.464.1">
      IdentityDbContext&lt;IdentityUser&gt;
     </span>
    </strong>
    <span class="koboSpan" id="kobo.465.1">
     , which is located in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.466.1">
      Microsoft.AspNetCore.Identity.EntityFrameworkCore
     </span>
    </strong>
    <span class="koboSpan" id="kobo.467.1">
     namespace.
    </span>
    <span class="koboSpan" id="kobo.467.2">
     Once we’ve done this, we’ll have the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.468.1">
      updated class:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.469.1">
namespace WorkingWithIdentity.Context;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using WorkingWithIdentity.Model;
public class BankingDbContext : IdentityDbContext&lt;IdentityUser&gt;
{
    public BankingDbContext(DbContextOptions
      &lt;BankingDbContext&gt; options) : base(options)
    {
    }
     public DbSet&lt;Account&gt; Accounts { get; set; }
     public DbSet&lt;Customer&gt; Customers { get; set; }
     public DbSet&lt;Movement&gt; Movements { get; set; }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.470.1">
     As we learned in
    </span>
    <a href="B21788_05.xhtml#_idTextAnchor078">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.471.1">
        Chapter 5
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.472.1">
     , the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.473.1">
      DbContext
     </span>
    </strong>
    <span class="koboSpan" id="kobo.474.1">
     class is an abstraction of
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.475.1">
      Entity Framework Core
     </span>
    </strong>
    <span class="koboSpan" id="kobo.476.1">
     that allows
    </span>
    <a id="_idIndexMarker457">
    </a>
    <span class="koboSpan" id="kobo.477.1">
     the application to interact with the database, where each entity in the database is represented by properties of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.478.1">
      DbSet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.479.1">
     type.
    </span>
    <span class="koboSpan" id="kobo.479.2">
     This allows classes to be mapped to entities and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.480.1">
      vice versa.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.481.1">
     By changing the inheritance of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.482.1">
      BankingDbContext
     </span>
    </strong>
    <span class="koboSpan" id="kobo.483.1">
     class
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.484.1">
      to
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.485.1">
       IdentityDb
      </span>
     </strong>
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.486.1">
      Context&lt;IdentityUser&gt;
     </span>
    </strong>
    <span class="koboSpan" id="kobo.487.1">
     , we’re reusing the default
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.488.1">
      DbContext
     </span>
    </strong>
    <span class="koboSpan" id="kobo.489.1">
     implementation from ASP.NET Identity Core.
    </span>
    <span class="koboSpan" id="kobo.489.2">
     This contains the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.490.1">
      DbSet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.491.1">
     type for mapping the Identity tables that will be part of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.492.1">
      the database.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.493.1">
     To ensure that all the database settings are available in the application, open the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.494.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.495.1">
     file and make sure that the following line of code exists in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.496.1">
      the file:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.497.1">
builder.Services.AddDbContext&lt;BankingDbContext&gt;(
  options =&gt;   options.UseSqlServer(builder
  .Configuration.GetConnectionString("BankingDbContext")));</span></pre>
   <p>
    <span class="koboSpan" id="kobo.498.1">
     It’s very important to configure the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.499.1">
      DbContext
     </span>
    </strong>
    <span class="koboSpan" id="kobo.500.1">
     class in the ASP.NET Core dependency injection container.
    </span>
    <span class="koboSpan" id="kobo.500.2">
     In this case, we added the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.501.1">
      BankingDbContext
     </span>
    </strong>
    <span class="koboSpan" id="kobo.502.1">
     class to the dependency injection context while also configuring the use of SQL Server, whose connection will be based on the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.503.1">
      ConnectionString
     </span>
    </strong>
    <span class="koboSpan" id="kobo.504.1">
     value, which is passed as a parameter to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.505.1">
      UseSqlServer
     </span>
    </strong>
    <span class="koboSpan" id="kobo.506.1">
     method.
    </span>
    <span class="koboSpan" id="kobo.506.2">
     This
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.507.1">
      ConnectionString
     </span>
    </strong>
    <span class="koboSpan" id="kobo.508.1">
     is obtained through the application
    </span>
    <a id="_idIndexMarker458">
    </a>
    <span class="koboSpan" id="kobo.509.1">
     settings, which in this case can be found in the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.510.1">
       appsettings.json
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.511.1">
      file.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.512.1">
     At this point, we have all the necessary configurations so that ASP.NET Core Identity is configured in the data layer.
    </span>
    <span class="koboSpan" id="kobo.512.2">
     In the next section, we’ll update the database so that we can add the necessary tables for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.513.1">
      identity management.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-105">
    <a id="_idTextAnchor106">
    </a>
    <span class="koboSpan" id="kobo.514.1">
     Updating the database
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.515.1">
     In
    </span>
    <a href="B21788_05.xhtml#_idTextAnchor078">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.516.1">
        Chapter 5
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.517.1">
     , we created an
    </span>
    <a id="_idIndexMarker459">
    </a>
    <span class="koboSpan" id="kobo.518.1">
     API that simulates digital bank operations and connected it to a database using Entity Framework Core.
    </span>
    <span class="koboSpan" id="kobo.518.2">
     For this example, we’ll use the same database – that is,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.519.1">
      dbBanking
     </span>
    </strong>
    <span class="koboSpan" id="kobo.520.1">
     .
    </span>
    <span class="koboSpan" id="kobo.520.2">
     Currently, it has the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.521.1">
      data structure:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer068">
     <span class="koboSpan" id="kobo.522.1">
      <img alt="Figure 6.5 – The structure of the dbBanking database" src="image/B21788_06_5.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.523.1">
     Figure 6.5 – The structure of the dbBanking database
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.524.1">
     The
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.525.1">
      dbBanking
     </span>
    </strong>
    <span class="koboSpan" id="kobo.526.1">
     database
    </span>
    <a id="_idIndexMarker460">
    </a>
    <span class="koboSpan" id="kobo.527.1">
     consists of four tables, three of which are part of the application context – that is,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.528.1">
      dbo.Accounts
     </span>
    </strong>
    <span class="koboSpan" id="kobo.529.1">
     ,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.530.1">
      dbo.Customers
     </span>
    </strong>
    <span class="koboSpan" id="kobo.531.1">
     , and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.532.1">
      dbo.Movements
     </span>
    </strong>
    <span class="koboSpan" id="kobo.533.1">
     .
    </span>
    <span class="koboSpan" id="kobo.533.2">
     The fourth table,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.534.1">
      dbo.EFMigrationsHistory
     </span>
    </strong>
    <span class="koboSpan" id="kobo.535.1">
     , is responsible for managing the status of changes that are made to the database
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.536.1">
      using migrations.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.537.1">
     Database migrations
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.538.1">
     In
    </span>
    <a href="B21788_05.xhtml#_idTextAnchor078">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.539.1">
        Chapter 5
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.540.1">
     , we explored how migrations work, their importance during application development, and changes that can be made dynamically to the database.
    </span>
    <span class="koboSpan" id="kobo.540.2">
     If you want to learn more about how ASP.NET Core 9 migrations
    </span>
    <a id="_idIndexMarker461">
    </a>
    <span class="koboSpan" id="kobo.541.1">
     works, please refer
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.542.1">
      to
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/?tabs=dotnet-core-cli">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.543.1">
       https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/?tabs=dotnet-core-cli
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.544.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.545.1">
     The
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.546.1">
      dbo.EFMigrationsHistory
     </span>
    </strong>
    <span class="koboSpan" id="kobo.547.1">
     table
    </span>
    <a id="_idIndexMarker462">
    </a>
    <span class="koboSpan" id="kobo.548.1">
     contains the history of the first entities that were created for the bank API.
    </span>
    <span class="koboSpan" id="kobo.548.2">
     You can check the history that’s been generated through the code in the application’s directory structure, in the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.549.1">
      Migrations
     </span>
    </strong>
    <span class="koboSpan" id="kobo.550.1">
     folder, as shown in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.551.1">
       Figure 6
      </span>
     </em>
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.552.1">
       .6
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.553.1">
      :
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer069">
     <span class="koboSpan" id="kobo.554.1">
      <img alt="Figure 6.6 – Migrations classes for the API" src="image/B21788_06_6.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.555.1">
     Figure 6.6 – Migrations classes for the API
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.556.1">
     These classes are automatically generated by the Entity Framework Core command-line tool and should not be
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.557.1">
      changed manually.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.558.1">
     After making changes to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.559.1">
      DbContext
     </span>
    </strong>
    <span class="koboSpan" id="kobo.560.1">
     class and adding the ASP.NET Core Identity models, we must change the database.
    </span>
    <span class="koboSpan" id="kobo.560.2">
     To do so, we’ll create a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.561.1">
      new migration.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.562.1">
     To do this, open a terminal of your choice, access the root directory of the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.563.1">
      WorkingWithIdentity
     </span>
    </strong>
    <span class="koboSpan" id="kobo.564.1">
     application, and execute the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.565.1">
      following command:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.566.1">
dotnet ef migrations add IdentityModels</span></pre>
   <p>
    <span class="koboSpan" id="kobo.567.1">
     The preceding command uses Entity Framework Core’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.568.1">
      ef
     </span>
    </strong>
    <span class="koboSpan" id="kobo.569.1">
     tool and adds a migration
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.570.1">
      named
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.571.1">
       IdentityModels
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.572.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.573.1">
     Again, when opening the project’s
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.574.1">
      Migrations
     </span>
    </strong>
    <span class="koboSpan" id="kobo.575.1">
     folder, we can analyze which new classes were created, as shown in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.576.1">
       Figure 6
      </span>
     </em>
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.577.1">
       .7
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.578.1">
      :
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer070">
     <span class="koboSpan" id="kobo.579.1">
      <img alt="Figure 6.7 – Migration classes for the Identity model" src="image/B21788_06_7.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.580.1">
     Figure 6.7 – Migration classes for the Identity model
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.581.1">
     Now that we have the
    </span>
    <a id="_idIndexMarker463">
    </a>
    <span class="koboSpan" id="kobo.582.1">
     migration structure for the database, we must update
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.583.1">
      dbBanking
     </span>
    </strong>
    <span class="koboSpan" id="kobo.584.1">
     so that it includes the Identity tables.
    </span>
    <span class="koboSpan" id="kobo.584.2">
     To do this, in your preferred terminal, run the following command in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.585.1">
      project directory:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.586.1">
dotnet ef database update</span></pre>
   <p>
    <span class="koboSpan" id="kobo.587.1">
     The preceding command reads the migrations available in the project, analyzes the migration history in the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.588.1">
      dbo.EFMigrationsHistory
     </span>
    </strong>
    <span class="koboSpan" id="kobo.589.1">
     table in the database, and applies the updates, which in this case involve creating the tables necessary for ASP.NET Core Identity to work correctly.
    </span>
    <span class="koboSpan" id="kobo.589.2">
     We’ll see the new tables that have
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.590.1">
      been created:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer071">
     <span class="koboSpan" id="kobo.591.1">
      <img alt="Figure 6.8 – The database now contains ASP.NET Core Identity tables" src="image/B21788_06_8.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.592.1">
     Figure 6.8 – The database now contains ASP.NET Core Identity tables
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.593.1">
     With that, all basic ASP.NET Core Identity settings related to the data model have been added successfully.
    </span>
    <span class="koboSpan" id="kobo.593.2">
     However, we still need to add some other configurations to the project so that the application is capable of handling authorization and authentication.
    </span>
    <span class="koboSpan" id="kobo.593.3">
     So, in the next section, we’ll add ASP.NET Core Identity services to the application’s dependency
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.594.1">
      injection context.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-106">
    <a id="_idTextAnchor107">
    </a>
    <span class="koboSpan" id="kobo.595.1">
     Adding ASP.NET Core Identity services and routes
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.596.1">
     Asp.Net Core Identity
    </span>
    <a id="_idIndexMarker464">
    </a>
    <span class="koboSpan" id="kobo.597.1">
     contains the necessary abstractions to deal
    </span>
    <a id="_idIndexMarker465">
    </a>
    <span class="koboSpan" id="kobo.598.1">
     with authorization and authentication mechanisms using the services available in the dependency injection container, in addition to wheels for authentication and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.599.1">
      token generation.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.600.1">
     However, it’s
    </span>
    <a id="_idIndexMarker466">
    </a>
    <span class="koboSpan" id="kobo.601.1">
     necessary to activate these abstractions explicitly.
    </span>
    <span class="koboSpan" id="kobo.601.2">
     To do so, we
    </span>
    <a id="_idIndexMarker467">
    </a>
    <span class="koboSpan" id="kobo.602.1">
     must add a few lines of code to the application.
    </span>
    <span class="koboSpan" id="kobo.602.2">
     Open the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.603.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.604.1">
     file so that we can edit them.
    </span>
    <span class="koboSpan" id="kobo.604.2">
     At this point, we must follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.605.1">
      these steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.606.1">
      Adding the required Identity namespace – that is,
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.607.1">
        using Microsoft.AspNetCore.identity;
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.608.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.609.1">
      Add the authentication services that are responsible for determining the identity of users to the dependency injection container, as well as the authentication method.
     </span>
     <span class="koboSpan" id="kobo.609.2">
      In this case, we’ll be using a bearer
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.610.1">
       token:
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.611.1">
        builder.Services.AddAuthentication().AddBearerToken();
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.612.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.613.1">
      Add the authorization services to the dependency injection container by
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.614.1">
       running
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.615.1">
        builder.Services.AddAuthorization();
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.616.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.617.1">
      Add the Identity APIs and configure data access through Entity Framework Core by
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.618.1">
       running
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.619.1">
        builder.Services.AddIdentityApiEndpoints&lt;IdentityUser&gt;().AddEntityFrameworkStores&lt;BankingDbContext&gt;();
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.620.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.621.1">
      Map the Identity endpoints
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.622.1">
       using
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.623.1">
        app.MapIdentityApi&lt;IdentityUser&gt;();
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.624.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.625.1">
      Add each request authentication middleware to the application’s request processing pipeline, using the settings defined by
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.626.1">
       AddAuthentication()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.627.1">
      to validate and define the user’s
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.628.1">
       identity:
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.629.1">
        app.UseAuthentication();
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.630.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.631.1">
      Add middleware that checks authorization policies against the identity of the authenticated user to determine whether the user is allowed to proceed with the current
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.632.1">
       request:
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.633.1">
        app.UseAuthorization();
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.634.1">
       .
      </span>
     </span>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.635.1">
       By making
      </span>
      <a id="_idIndexMarker468">
      </a>
      <span class="koboSpan" id="kobo.636.1">
       these changes, we’ll have the following
      </span>
      <a id="_idIndexMarker469">
      </a>
      <span class="koboSpan" id="kobo.637.1">
       complete code in the
      </span>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.638.1">
         Program.cs
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.639.1">
        file:
       </span>
      </span>
     </p>
     <pre class="source-code"><span class="koboSpan" id="kobo.640.1">
using Dapper;
</span><strong class="bold"><span class="koboSpan" id="kobo.641.1">using Microsoft.AspNetCore.Identity;</span></strong><span class="koboSpan" id="kobo.642.1">
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.SqlServer;
using WorkingWithIdentity.Context;
using WorkingWithIdentity.Model;
using WorkingWithIdentity.RouteHandler;
var builder = WebApplication.CreateBuilder(args);
</span><strong class="bold"><span class="koboSpan" id="kobo.643.1">builder.Services.AddAuthentication().AddBearerToken();</span></strong><span class="koboSpan" id="kobo.644.1">
// Adding the Authorization Services from the Asp.Net Core Identity
</span><strong class="bold"><span class="koboSpan" id="kobo.645.1">builder.Services.AddAuthorization();</span></strong><span class="koboSpan" id="kobo.646.1">
// Configure the Database access for the Asp.Net Core Identity
</span><strong class="bold"><span class="koboSpan" id="kobo.647.1">builder.Services.AddIdentityApiEndpoints</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.648.1">  &lt;IdentityUser&gt;()</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.649.1">    .AddEntityFrameworkStores&lt;BankingDbContext&gt;();</span></strong><span class="koboSpan" id="kobo.650.1">
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();
builder.Services.AddDbContext&lt;BankingDbContext&gt;
  (options =&gt; options.UseSqlServer(builder
    .Configuration.GetConnectionString(
      "BankingDbContext")));
builder.Services.AddScoped(_ =&gt; new SqlConnection
  (builder.Configuration.GetConnectionString(
    "BankingDbContext")));
var app = builder.Build();
// Configure the HTTP request pipeline adding the ASP.NET Core Identity routes
</span><strong class="bold"><span class="koboSpan" id="kobo.651.1">app.MapIdentityApi&lt;IdentityUser&gt;();</span></strong><span class="koboSpan" id="kobo.652.1">
// Configure the HTTP request pipeline.
</span><span class="koboSpan" id="kobo.652.2">if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}
app.UseHttpsRedirection();
</span><strong class="bold"><span class="koboSpan" id="kobo.653.1">app.RegisterAccountRoutes();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.654.1">app.RegisterCustomerRoutes();</span></strong><span class="koboSpan" id="kobo.655.1">
app.MapGet("GetAllCustomersUsingDapper", async(SqlConnection connection) =&gt;
{
  var customers = await connection
    .QueryAsync&lt;Customer&gt;("SELECT Id,
    Name FROM Customers ORDER BY Name");
    return Results.Ok(customers);
});
app.MapGet("GetCustomerByIdUsingDapper",
  async(int id, SqlConnection connection) =&gt;
{
    var customer = await connection
      .QueryFirstOrDefaultAsync&lt;Customer&gt;(
      "SELECT Id, Name FROM Customers WHERE
      Id = @id", new { id });
    if (customer is null) return Results.NotFound();
    return Results.Ok(customer);
});
</span><strong class="bold"><span class="koboSpan" id="kobo.656.1">app.UseAuthentication();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.657.1">app.UseAuthorization();</span></strong><span class="koboSpan" id="kobo.658.1">
app.Run();</span></pre>
    </li>
   </ol>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.659.1">
     Register account and customer routes
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.660.1">
     The routes that are responsible for processing requests for the Account and Customers APIs were registered through the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.661.1">
      app.RegisterAccountRoutes
     </span>
    </strong>
    <span class="koboSpan" id="kobo.662.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.663.1">
      app.RegisterCustomerRoutes
     </span>
    </strong>
    <span class="koboSpan" id="kobo.664.1">
     extension methods, as highlighted in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.665.1">
      preceding code.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.666.1">
     This is a good practice for correctly separating responsibilities, as well as improving the maintainability of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.667.1">
      Program.cs
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.668.1">
      file code.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.669.1">
     To create these extension methods, two classes were created, as
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.670.1">
      shown here:
     </span>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.671.1">
      public static
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.672.1">
       class AccountRoutes
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.673.1">
      {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.674.1">
      public static
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.675.1">
       void RegisterAccountRoutes(this
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.676.1">
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.677.1">
       IEndpointRouteBuilder routes)
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.678.1">
      {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.679.1">
      var group =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.680.1">
       routes.MapGroup("/accounts");
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.681.1">
      //
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.682.1">
       GET: /accounts
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.683.1">
      group.MapGet("/", async (BankingDbContext
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.684.1">
       dbContext) =&gt;
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.685.1">
      {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.686.1">
      return await
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.687.1">
       dbContext.Accounts.Include(a =&gt;
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.688.1">
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.689.1">
       a.Customer)
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.690.1">
      .Include(a =&gt;
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.691.1">
       a.Movements)
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.692.1">
      .
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.693.1">
       ToListAsync();
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.694.1">
      });
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.695.1">
      //
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.696.1">
       other methods
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.697.1">
      }
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.698.1">
      }
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.699.1">
      public static
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.700.1">
       class CustomerRoutes
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.701.1">
      {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.702.1">
      public static
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.703.1">
       void RegisterCustomerRoutes(this
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.704.1">
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.705.1">
       IEndpointRouteBuilder routes)
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.706.1">
      {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.707.1">
      var group =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.708.1">
       routes.MapGroup("/customers");
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.709.1">
      //
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.710.1">
       GET: /customers
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.711.1">
      group.MapGet("/", async (BankingDbContext
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.712.1">
       dbContext) =&gt;
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.713.1">
      {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.714.1">
      return
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.715.1">
       await dbContext.Customers.ToListAsync();
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.716.1">
      });
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.717.1">
      //
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.718.1">
       other methods
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.719.1">
      }
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.720.1">
      }
     </span>
    </strong>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.721.1">
     The extension classes that were created here have a static method that’s responsible for registering the routes of the respective entities.
    </span>
    <span class="koboSpan" id="kobo.721.2">
     This is a practice that makes code more organized and easier to read and maintain.
    </span>
    <span class="koboSpan" id="kobo.721.3">
     To learn more about creating extension methods, go
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.722.1">
      to
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/how-to-implement-and-call-a-custom-extension-method">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.723.1">
       https://learn.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/how-to-implement-and-call-a-custom-extension-method
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.724.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.725.1">
     When analyzing the preceding code, it’s very important to consider the order of the highlighted lines of code; otherwise, the objects and route mappings won’t
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.726.1">
      work correctly.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.727.1">
     So far, the solution code presents a configuration model that already allows us to benefit from the authorization and authentication features of ASP.NET Core Identity.
    </span>
    <span class="koboSpan" id="kobo.727.2">
     However, there are some cases where there’s a need to customize access types based on user roles.
    </span>
    <span class="koboSpan" id="kobo.727.3">
     Fortunately, ASP.NET Core 9 offers a powerful feature that allows us to segregate the type of access to application resources, as we will see in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.728.1">
      next section.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.729.1">
     Role-based authorization
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.730.1">
     To have greater control over the user authorization flow in the application, we can implement
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.731.1">
      role-based authorization
     </span>
    </strong>
    <span class="koboSpan" id="kobo.732.1">
     .
    </span>
    <span class="koboSpan" id="kobo.732.2">
     This
    </span>
    <a id="_idIndexMarker470">
    </a>
    <span class="koboSpan" id="kobo.733.1">
     role-based control allows you to segregate the type of access to parts of your application based on the roles that have been assigned to users.
    </span>
    <span class="koboSpan" id="kobo.733.2">
     Imagine a scenario where there are two roles:
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.734.1">
      Administrator
     </span>
    </strong>
    <span class="koboSpan" id="kobo.735.1">
     and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.736.1">
      Reader
     </span>
    </strong>
    <span class="koboSpan" id="kobo.737.1">
     .
    </span>
    <span class="koboSpan" id="kobo.737.2">
     By using
    </span>
    <a id="_idIndexMarker471">
    </a>
    <span class="koboSpan" id="kobo.738.1">
     the role-based authorization approach, you can ensure
    </span>
    <a id="_idIndexMarker472">
    </a>
    <span class="koboSpan" id="kobo.739.1">
     that only users authorized to certain areas of the application can access specific resources or perform specific actions in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.740.1">
      an application.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.741.1">
     In ASP.NET Core 9, the role-based authorization approach can be implemented by defining policies, which extend role-based authorization with more complex logic, offering fine-grained control over
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.742.1">
      user permissions.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.743.1">
     Once a policy has been defined, it can be applied to controllers, actions, or even Razor Pages to enforce the desired authorization behavior.
    </span>
    <span class="koboSpan" id="kobo.743.2">
     Policies make your authorization logic more modular and reusable.
    </span>
    <span class="koboSpan" id="kobo.743.3">
     This is especially useful in larger applications, where access control can
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.744.1">
      become complex.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.745.1">
     For example, consider a scenario where you want to create a policy that only allows users with the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.746.1">
      Admin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.747.1">
     role
    </span>
    <a id="_idIndexMarker473">
    </a>
    <span class="koboSpan" id="kobo.748.1">
     to access certain administrative resources.
    </span>
    <span class="koboSpan" id="kobo.748.2">
     Also, you might want to create another policy that only allows users with the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.749.1">
      Manager
     </span>
    </strong>
    <span class="koboSpan" id="kobo.750.1">
     role
    </span>
    <a id="_idIndexMarker474">
    </a>
    <span class="koboSpan" id="kobo.751.1">
     to be employed for over 1 year so that they can access specific reports.
    </span>
    <span class="koboSpan" id="kobo.751.2">
     These policies can be defined in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.752.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.753.1">
     file and then applied to controllers or actions using the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.754.1">
      [
     </span>
    </strong>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.755.1">
       Authorize]
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.756.1">
      attribute.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.757.1">
     Let’s look at a simple example of a policy that could be added to a
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.758.1">
       Program.cs
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.759.1">
      file:
     </span>
    </span>
   </p>
   <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.760.1">builder.Services.AddAuthorization(options =&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.761.1">{    options.AddPolicy("AdminOnly",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.762.1">     policy =&gt; policy.RequireRole("Admin"));</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.763.1">});</span></strong><span class="koboSpan" id="kobo.764.1">
var app = builder.Build();
app.UseAuthorization();
 app.MapGet("/admin", </span><strong class="bold"><span class="koboSpan" id="kobo.765.1">[Authorize(Policy = "AdminOnly")]</span></strong><span class="koboSpan" id="kobo.766.1">
  () =&gt; {
    return Results.Ok("Welcome, Admin!");
});
app.Run();</span></pre>
   <p>
    <span class="koboSpan" id="kobo.767.1">
     In the preceding code, we
    </span>
    <a id="_idIndexMarker475">
    </a>
    <span class="koboSpan" id="kobo.768.1">
     configured a policy called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.769.1">
      AdminOnly
     </span>
    </strong>
    <span class="koboSpan" id="kobo.770.1">
     that sets a rule where the user has the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.771.1">
      Admin
     </span>
    </strong>
    <span class="koboSpan" id="kobo.772.1">
     role.
    </span>
    <span class="koboSpan" id="kobo.772.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.773.1">
      [Authorize]
     </span>
    </strong>
    <span class="koboSpan" id="kobo.774.1">
     attribute is then applied to an endpoint and uses the policy we created earlier, restricting access to users who meet the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.775.1">
      policy criteria.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.776.1">
     Now, let’s look at a more complex example.
    </span>
    <span class="koboSpan" id="kobo.776.2">
     Here, a custom policy has been defined that checks the user’s role and provides an additional claim that requires the user’s employment duration to be
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.777.1">
      1 year:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.778.1">
builder.Services.AddAuthorization(options =&gt;
{
    options.AddPolicy("EmployeeWithExperience",
    policy =&gt;
    {
       </span><strong class="bold"><span class="koboSpan" id="kobo.779.1"> policy.RequireRole("Manager");</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.780.1">        policy.RequireClaim("EmploymentDuration", "1Year");</span></strong><span class="koboSpan" id="kobo.781.1">
    });
});
var app = builder.Build();
app.UseAuthorization();
app.MapGet("/reports",
  [Authorize(Policy = " EmployeeWithExperience ")]
  () =&gt; {    return Results.Ok("Access granted to experienced managers.");
});
app.Run();</span></pre>
   <p>
    <span class="koboSpan" id="kobo.782.1">
     In this example, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.783.1">
      EmployeeWithExperience
     </span>
    </strong>
    <span class="koboSpan" id="kobo.784.1">
     policy requires that the user has the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.785.1">
      Manager
     </span>
    </strong>
    <span class="koboSpan" id="kobo.786.1">
     role and owns a claim named
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.787.1">
      EmploymentDuration
     </span>
    </strong>
    <span class="koboSpan" id="kobo.788.1">
     with a value of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.789.1">
      1Year
     </span>
    </strong>
    <span class="koboSpan" id="kobo.790.1">
     .
    </span>
    <span class="koboSpan" id="kobo.790.2">
     This policy applies to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.791.1">
      /reports
     </span>
    </strong>
    <span class="koboSpan" id="kobo.792.1">
     endpoint, restricting access to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.793.1">
      managers only.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.794.1">
     Role-based authorization
    </span>
    <a id="_idIndexMarker476">
    </a>
    <span class="koboSpan" id="kobo.795.1">
     and policies give you a powerful way to manage access to your application’s resources, allowing you to build complex authorization logic that goes beyond simple role checks and incorporate additional conditions and claims
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.796.1">
      as needed.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.797.1">
     Now that we know more about ASP.NET Core Identity, have integrated it into our application, and know how to segregate access to application resources by implementing authorization policies, it’s time to add restrictions to the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.798.1">
      application’s routes.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-107">
    <a id="_idTextAnchor108">
    </a>
    <span class="koboSpan" id="kobo.799.1">
     Securing APIs with ASP.NET Core Identity
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.800.1">
     At this point, the
    </span>
    <a id="_idIndexMarker477">
    </a>
    <span class="koboSpan" id="kobo.801.1">
     application has been fully integrated with ASP.NET Core Identity.
    </span>
    <span class="koboSpan" id="kobo.801.2">
     Now, we’ll run it so that we can analyze the results.
    </span>
    <span class="koboSpan" id="kobo.801.3">
     Open a terminal of your choice and access the application directory.
    </span>
    <span class="koboSpan" id="kobo.801.4">
     Then, run the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.802.1">
      following command:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.803.1">
dotnet run</span></pre>
   <p>
    <span class="koboSpan" id="kobo.804.1">
     An
    </span>
    <a id="_idIndexMarker478">
    </a>
    <span class="koboSpan" id="kobo.805.1">
     address in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.806.1">
      http://localhost:&lt;port&gt;
     </span>
    </strong>
    <span class="koboSpan" id="kobo.807.1">
     format will be provided.
    </span>
    <span class="koboSpan" id="kobo.807.2">
     The port number may be different from the one shown in this example, but the execution will be the same.
    </span>
    <span class="koboSpan" id="kobo.807.3">
     Access the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.808.1">
      http://localhost:&lt;port&gt;/swagger/index.html
     </span>
    </strong>
    <span class="koboSpan" id="kobo.809.1">
     address; you should see the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.810.1">
      following output:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer072">
     <span class="koboSpan" id="kobo.811.1">
      <img alt="Figure 6.9 – Banking API integrated with ASP.NET Core Identity" src="image/B21788_06_9.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.812.1">
     Figure 6.9 – Banking API integrated with ASP.NET Core Identity
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.813.1">
     As we can see, new routes were added to the API.
    </span>
    <span class="koboSpan" id="kobo.813.2">
     These routes are the APIs that are provided by ASP.NET Core Identity.
    </span>
    <span class="koboSpan" id="kobo.813.3">
     Each API allows us to manage the application’s users and add different capabilities, such as password recovery, user creation, or
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.814.1">
      password reset.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.815.1">
     However, upon attempting to execute an endpoint, such as performing a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.816.1">
      GET
     </span>
    </strong>
    <span class="koboSpan" id="kobo.817.1">
     request on the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.818.1">
      /accounts
     </span>
    </strong>
    <span class="koboSpan" id="kobo.819.1">
     API, we realized that we were able to obtain a valid response.
    </span>
    <span class="koboSpan" id="kobo.819.2">
     To perform the test, simply open the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.820.1">
      GET
     </span>
    </strong>
    <span class="koboSpan" id="kobo.821.1">
     method of the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.822.1">
      /accounts
     </span>
    </strong>
    <span class="koboSpan" id="kobo.823.1">
     API, click the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.824.1">
      Try Out
     </span>
    </strong>
    <span class="koboSpan" id="kobo.825.1">
     button, and then the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.826.1">
      Execute
     </span>
    </strong>
    <span class="koboSpan" id="kobo.827.1">
     button.
    </span>
    <span class="koboSpan" id="kobo.827.2">
     We should get the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.828.1">
      following response:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer073">
     <span class="koboSpan" id="kobo.829.1">
      <img alt="Figure 6.10 – Requesting an API without authentication and authorization" src="image/B21788_06_10.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.830.1">
     Figure 6.10 – Requesting an API without authentication and authorization
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.831.1">
     As we can
    </span>
    <a id="_idIndexMarker479">
    </a>
    <span class="koboSpan" id="kobo.832.1">
     see, we have an HTTP status code of
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.833.1">
      200
     </span>
    </strong>
    <span class="koboSpan" id="kobo.834.1">
     , which means that the request was successful, even if the result didn’t return any existing account records in the database.
    </span>
    <span class="koboSpan" id="kobo.834.2">
     If you have any records registered in this table in your local database, the result will be an array of account objects serialized in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.835.1">
      JSON format.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.836.1">
     However, we want to add authentication and authorization processes to the application’s APIs.
    </span>
    <span class="koboSpan" id="kobo.836.2">
     To do so, we must make some changes to the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.837.1">
      source code.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.838.1">
     As we know, each API has its routes registered in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.839.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.840.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.840.2">
     These routes act as entry points for requests.
    </span>
    <span class="koboSpan" id="kobo.840.3">
     Since we want to protect each route so that only known and authorized users can consume the API, we must add a configuration to the routes so that when someone attempts to request the API without being authenticated, the request must return an HTTP
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.841.1">
      401
     </span>
    </strong>
    <span class="koboSpan" id="kobo.842.1">
     status code, informing the API consumer that there’s a need
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.843.1">
      for authentication.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.844.1">
     In the next section, we’ll learn how to protect routes and prevent
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.845.1">
      unauthorized requests.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-108">
    <a id="_idTextAnchor109">
    </a>
    <span class="koboSpan" id="kobo.846.1">
     Securing application routes
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.847.1">
     Even if all authentication and
    </span>
    <a id="_idIndexMarker480">
    </a>
    <span class="koboSpan" id="kobo.848.1">
     authorization settings are present in the application, it’s necessary to determine what should be protected and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.849.1">
      what shouldn’t.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.850.1">
     One of the ways we can ensure that a given API method is protected by authentication and authorization middleware is by adding an explicit configuration to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.851.1">
      the routes.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.852.1">
     In the application that we’re working on, the API routes were implemented in separate files as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.853.1">
      extension methods
     </span>
    </strong>
    <span class="koboSpan" id="kobo.854.1">
     , as a
    </span>
    <a id="_idIndexMarker481">
    </a>
    <span class="koboSpan" id="kobo.855.1">
     good practice.
    </span>
    <span class="koboSpan" id="kobo.855.2">
     So, let’s make the necessary change in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.856.1">
      AccountHandler.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.857.1">
     file, located in the application’s
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.858.1">
       RouteHandler
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.859.1">
      directory.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.860.1">
     To do this, we’ll configure the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.861.1">
      /accounts
     </span>
    </strong>
    <span class="koboSpan" id="kobo.862.1">
     route so that it only accepts requests if the user is authenticated.
    </span>
    <span class="koboSpan" id="kobo.862.2">
     Let’s look at the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.863.1">
      changed code:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.864.1">
app.MapGet("/accounts", async (BankingDbContext
  dbContext) =&gt; {
    var accounts = await dbContext.Accounts.ToListAsync();
    return Results.Ok(accounts);
}).</span><strong class="bold"><span class="koboSpan" id="kobo.865.1">RequireAuthorization()</span></strong><span class="koboSpan" id="kobo.866.1">;</span></pre>
   <p>
    <span class="koboSpan" id="kobo.867.1">
     Here, we added the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.868.1">
      RequireAuthorization()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.869.1">
     method call.
    </span>
    <span class="koboSpan" id="kobo.869.2">
     We’ve already learned that authorization is a process that validates a user’s permissions, while authentication involves identifying the user.
    </span>
    <span class="koboSpan" id="kobo.869.3">
     In this case, if the user isn’t authenticated, they can’t
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.870.1">
      be authorized.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.871.1">
     Again, in a terminal of your choice, inside the application directory, execute the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.872.1">
      following command:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.873.1">
dotnet run</span></pre>
   <p>
    <span class="koboSpan" id="kobo.874.1">
     Next, we’ll request the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.875.1">
      /accounts
     </span>
    </strong>
    <span class="koboSpan" id="kobo.876.1">
     route.
    </span>
    <span class="koboSpan" id="kobo.876.2">
     However, let’s execute
    </span>
    <a id="_idIndexMarker482">
    </a>
    <span class="koboSpan" id="kobo.877.1">
     the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.878.1">
      Postman
     </span>
    </strong>
    <span class="koboSpan" id="kobo.879.1">
     application first.
    </span>
    <span class="koboSpan" id="kobo.879.2">
     Follow
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.880.1">
      the steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.881.1">
      Go to
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.882.1">
       File
      </span>
     </strong>
     <span class="koboSpan" id="kobo.883.1">
      |
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.884.1">
       New
      </span>
     </strong>
     <span class="koboSpan" id="kobo.885.1">
      |
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.886.1">
        HTTP
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.887.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.888.1">
      A new tab will open where you can make
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.889.1">
       a request.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.890.1">
      Add the URL of the running application – that is,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.891.1">
       http://localhost:&lt;port&gt;/accounts
      </span>
     </strong>
     <span class="koboSpan" id="kobo.892.1">
      – and check whether the selected method
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.893.1">
       is
      </span>
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.894.1">
        GET
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.895.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.896.1">
      Then, click on the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.897.1">
       Send
      </span>
     </strong>
     <span class="koboSpan" id="kobo.898.1">
      button.
     </span>
     <span class="koboSpan" id="kobo.898.2">
      We’ll get
     </span>
     <a id="_idIndexMarker483">
     </a>
     <span class="koboSpan" id="kobo.899.1">
      the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.900.1">
       following output:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer074">
     <span class="koboSpan" id="kobo.901.1">
      <img alt="Figure 6.11 – Requesting the protected route" src="image/B21788_06_11.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.902.1">
     Figure 6.11 – Requesting the protected route
    </span>
   </p>
   <p>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.903.1">
       Figure 6
      </span>
     </em>
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.904.1">
      .11
     </span>
    </em>
    <span class="koboSpan" id="kobo.905.1">
     highlights the return of the request with an HTTP status code of 401, which means that the request
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.906.1">
      wasn’t authorized.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.907.1">
     For a successful request for this route to be made, we must log in and configure the request with the authenticated
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.908.1">
      user’s information.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.909.1">
     Before logging in, we
    </span>
    <a id="_idIndexMarker484">
    </a>
    <span class="koboSpan" id="kobo.910.1">
     must create a user in the application.
    </span>
    <span class="koboSpan" id="kobo.910.2">
     To do this, perform the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.911.1">
      following steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.912.1">
      Create a new HTTP request
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.913.1">
       in Postman.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.914.1">
      Set the request type
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.915.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.916.1">
        POST
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.917.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.918.1">
      Add
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.919.1">
       http://localhost:&lt;port&gt;/register
      </span>
     </strong>
     <span class="koboSpan" id="kobo.920.1">
      as the route.
     </span>
     <span class="koboSpan" id="kobo.920.2">
      This is the default route for creating ASP.NET Core Identity users that will be added to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.921.1">
       the application.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.922.1">
      At this point, we need to define the body of the request.
     </span>
     <span class="koboSpan" id="kobo.922.2">
      To do this, click on the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.923.1">
       Body
      </span>
     </strong>
     <span class="koboSpan" id="kobo.924.1">
      tab, select the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.925.1">
       raw
      </span>
     </strong>
     <span class="koboSpan" id="kobo.926.1">
      option, and add the JSON shown in
     </span>
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.927.1">
        Figure 6
       </span>
      </em>
     </span>
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.928.1">
        .12
       </span>
      </em>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.929.1">
       :
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer075">
     <span class="koboSpan" id="kobo.930.1">
      <img alt="Figure 6.12 – Configuring the body of the register user request" src="image/B21788_06_12.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.931.1">
     Figure 6.12 – Configuring the body of the register user request
    </span>
   </p>
   <ol>
    <li value="5">
     <span class="koboSpan" id="kobo.932.1">
      You can change the properties of the JSON object to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.933.1">
       your liking.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.934.1">
      Finally, click the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.935.1">
       Send
      </span>
     </strong>
     <span class="koboSpan" id="kobo.936.1">
      button to make
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.937.1">
       the request.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.938.1">
     Upon being executed, we should get a response similar to the one shown in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.939.1">
       Figure 6
      </span>
     </em>
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.940.1">
       .13
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.941.1">
      :
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer076">
     <span class="koboSpan" id="kobo.942.1">
      <img alt="Figure 6.13: Registering a new user using ASP.NET Core Identity" src="image/B21788_06_13.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.943.1">
     Figure 6.13: Registering a new user using ASP.NET Core Identity
    </span>
   </p>
   <p>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.944.1">
       Figure 6
      </span>
     </em>
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.945.1">
      .13
     </span>
    </em>
    <span class="koboSpan" id="kobo.946.1">
     displays an
    </span>
    <a id="_idIndexMarker485">
    </a>
    <span class="koboSpan" id="kobo.947.1">
     HTTP status code of 200, informing us that the request was successful and that a new user has been registered in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.948.1">
      the database.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.949.1">
     At this point, we must log in.
    </span>
    <span class="koboSpan" id="kobo.949.2">
     We’ll do so using Postman.
    </span>
    <span class="koboSpan" id="kobo.949.3">
     Create a new HTTP request and perform the following steps to configure
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.950.1">
      the request:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.951.1">
      Set the request type
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.952.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.953.1">
        POST
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.954.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.955.1">
      Set the URL
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.956.1">
       to
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.957.1">
        http://localhost:&lt;port&gt;/login
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.958.1">
       .
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.959.1">
      Select the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.960.1">
       Body
      </span>
     </strong>
     <span class="koboSpan" id="kobo.961.1">
      tab, then the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.962.1">
       raw
      </span>
     </strong>
     <span class="koboSpan" id="kobo.963.1">
      option, and add the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.964.1">
       following JSON:
      </span>
     </span>
     <pre class="source-code"><span class="koboSpan" id="kobo.965.1">
{
  "email": "myuser@myemail.com",
  "password": "P4$$word"
}</span></pre>
    </li>
    <li>
     <span class="koboSpan" id="kobo.966.1">
      Click the
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.967.1">
        Send
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.968.1">
       button.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.969.1">
      Make sure you’ve added the JSON parameters according to the user data you created in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.970.1">
       your environment.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.971.1">
      Upon performing
     </span>
     <a id="_idIndexMarker486">
     </a>
     <span class="koboSpan" id="kobo.972.1">
      the request, you should see the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.973.1">
       following response:
      </span>
     </span>
    </li>
   </ol>
   <div>
    <div class="IMG---Figure" id="_idContainer077">
     <span class="koboSpan" id="kobo.974.1">
      <img alt="Figure 6.14 – Getting a login response" src="image/B21788_06_14.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.975.1">
     Figure 6.14 – Getting a login response
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.976.1">
     In response to the login request, we can see that a JSON object with some important properties has
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.977.1">
      been returned:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.978.1">
       tokenType
      </span>
     </strong>
     <span class="koboSpan" id="kobo.979.1">
      : This value will always be
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.980.1">
       Bearer
      </span>
     </strong>
     <span class="koboSpan" id="kobo.981.1">
      , which indicates that this response provides a
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.982.1">
       Bearer
      </span>
     </strong>
     <span class="koboSpan" id="kobo.983.1">
      token in the form of an opaque
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.984.1">
       accessToken
      </span>
     </strong>
     <span class="koboSpan" id="kobo.985.1">
      , as we configured in the
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.986.1">
        Program.cs
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.987.1">
       file.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.988.1">
       accessToken
      </span>
     </strong>
     <span class="koboSpan" id="kobo.989.1">
      : This is the token that’s generated for the authenticated user.
     </span>
     <span class="koboSpan" id="kobo.989.2">
      It must be sent as part of the authorization
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.990.1">
       request header.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.991.1">
       expiresIn
      </span>
     </strong>
     <span class="koboSpan" id="kobo.992.1">
      : A value in seconds that represents the expiration time
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.993.1">
       of
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.994.1">
        accessToken
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.995.1">
       .
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.996.1">
       refreshToken
      </span>
     </strong>
     <span class="koboSpan" id="kobo.997.1">
      : If set, we can obtain a new
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.998.1">
       access_token
      </span>
     </strong>
     <span class="koboSpan" id="kobo.999.1">
      value upon expiration by using a refresh endpoint without having to re-enter
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1000.1">
       user credentials.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.1001.1">
     The values displayed in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.1002.1">
       Figure 6
      </span>
     </em>
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1003.1">
      .14
     </span>
    </em>
    <span class="koboSpan" id="kobo.1004.1">
     will be
    </span>
    <a id="_idIndexMarker487">
    </a>
    <span class="koboSpan" id="kobo.1005.1">
     different for each request and don’t represent a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1006.1">
      JWT
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1007.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1007.2">
     The
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1008.1">
      access token
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1009.1">
     is generated and encrypted in a proprietary way in this version of
    </span>
    <a id="_idIndexMarker488">
    </a>
    <span class="koboSpan" id="kobo.1010.1">
     ASP.NET Core Identity and doesn’t follow a known convention.
    </span>
    <span class="koboSpan" id="kobo.1010.2">
     However, it’s possible to change to a
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1011.1">
      JWT
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1012.1">
     if you wish, as well as other configuration parameters of the token
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1013.1">
      generation process.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1014.1">
     ASP.NET Core Identity configurations
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1015.1">
     ASP.NET Core Identity offers different authentication options, including
    </span>
    <a id="_idIndexMarker489">
    </a>
    <span class="koboSpan" id="kobo.1016.1">
     JWT (
    </span>
    <a href="https://jwt.io/introduction">
     <span class="koboSpan" id="kobo.1017.1">
      https://jwt.io/introduction
     </span>
    </a>
    <span class="koboSpan" id="kobo.1018.1">
     ), cookies, and other settings.
    </span>
    <span class="koboSpan" id="kobo.1018.2">
     To learn more about the different configuration options, go
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1019.1">
      to
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.identity.identityoptions?view=aspnetcore-9.0">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1020.1">
       https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.identity.identityoptions?view=aspnetcore-9.0
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1021.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1022.1">
     However, the token-based approach we’re using, even though it doesn’t involve a JWT, uses the same configuration process as a request being made with the authenticated user’s credentials.
    </span>
    <span class="koboSpan" id="kobo.1022.2">
     In the next section, we’ll use the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1023.1">
      access token
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1024.1">
     value to make a request on the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1025.1">
      /accounts
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1026.1">
     route and obtain a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1027.1">
      valid response.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-109">
    <a id="_idTextAnchor110">
    </a>
    <span class="koboSpan" id="kobo.1028.1">
     Requesting an API with the access token
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1029.1">
     The access token
    </span>
    <a id="_idIndexMarker490">
    </a>
    <span class="koboSpan" id="kobo.1030.1">
     contains the authenticated user’s information in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1031.1">
      encrypted form.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1032.1">
     For us to make a valid request on the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1033.1">
      /accounts
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1034.1">
     route, we’ll need to pass the token as a parameter in the request header.
    </span>
    <span class="koboSpan" id="kobo.1034.2">
     So, copy the access token value and, in Postman, open the tab that contains the request, as shown in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.1035.1">
       Figure 6
      </span>
     </em>
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1036.1">
      .11
     </span>
    </em>
    <span class="koboSpan" id="kobo.1037.1">
     , for the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1038.1">
      /accounts
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1039.1">
     route.
    </span>
    <span class="koboSpan" id="kobo.1039.2">
     Then, perform the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1040.1">
      following steps:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.1041.1">
      In the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1042.1">
       GET
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1043.1">
      request tab for the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1044.1">
       /accounts
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1045.1">
      route, click on the
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1046.1">
        Authorization
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1047.1">
       tab.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1048.1">
      For
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1049.1">
       Type
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1050.1">
      , select the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1051.1">
       Bearer
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1052.1">
        Token
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1053.1">
       option.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1054.1">
      In the
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1055.1">
       Token
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1056.1">
      field, paste the value of the access token that you obtained via the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1057.1">
       login request.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.1058.1">
      Click the
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1059.1">
        Send
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1060.1">
       button.
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.1061.1">
     As shown in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.1062.1">
       Figure 6
      </span>
     </em>
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1063.1">
      .15
     </span>
    </em>
    <span class="koboSpan" id="kobo.1064.1">
     , an empty
    </span>
    <a id="_idIndexMarker491">
    </a>
    <span class="koboSpan" id="kobo.1065.1">
     array is returned since no accounts have been registered in the database.
    </span>
    <span class="koboSpan" id="kobo.1065.2">
     Note that the HTTP status code is
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1066.1">
      200
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1067.1">
     , which means that it was a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1068.1">
      successful request:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer078">
     <span class="koboSpan" id="kobo.1069.1">
      <img alt="Figure 6.15 – Successful accounts request" src="image/B21788_06_15.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1070.1">
     Figure 6.15 – Successful accounts request
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1071.1">
     So far, the application is working as expected.
    </span>
    <span class="koboSpan" id="kobo.1071.2">
     However, it’s important to understand how this authorization
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1072.1">
      process works.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1073.1">
     When requesting the account route again, we inform the access token, as configured previously.
    </span>
    <span class="koboSpan" id="kobo.1073.2">
     Despite Postman having a user-friendly UI, when selecting the authentication type and entering the access token, Postman automatically adds an HTTP header.
    </span>
    <span class="koboSpan" id="kobo.1073.3">
     HTTP headers are key/value pairs that are part of requests
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1074.1">
      and responses.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1075.1">
     For this request, the header was created with the authorization key and the access token value.
    </span>
    <span class="koboSpan" id="kobo.1075.2">
     You can check this header by clicking on the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1076.1">
      Headers
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1077.1">
     tab and viewing the hidden headers, as shown in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.1078.1">
       Figure 6
      </span>
     </em>
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.1079.1">
       .16
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1080.1">
      :
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer079">
     <span class="koboSpan" id="kobo.1081.1">
      <img alt="Figure 6.16 – The authorization HTTP header" src="image/B21788_06_16.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1082.1">
     Figure 6.16 – The authorization HTTP header
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1083.1">
     When making the
    </span>
    <a id="_idIndexMarker492">
    </a>
    <span class="koboSpan" id="kobo.1084.1">
     request, the authentication and authorization
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1085.1">
      middleware
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1086.1">
     comes
    </span>
    <a id="_idIndexMarker493">
    </a>
    <span class="koboSpan" id="kobo.1087.1">
     into action.
    </span>
    <span class="koboSpan" id="kobo.1087.2">
     The authentication middleware reads the token that was informed in the authorization header and fills in the user credentials for the request in
    </span>
    <a id="_idIndexMarker494">
    </a>
    <span class="koboSpan" id="kobo.1088.1">
     the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1089.1">
      HttpContext.User
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1090.1">
     object, which is part of the request.
    </span>
    <span class="koboSpan" id="kobo.1090.2">
     This object allows us to access information such as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1091.1">
      claims
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1092.1">
     , which
    </span>
    <a id="_idIndexMarker495">
    </a>
    <span class="koboSpan" id="kobo.1093.1">
     contain data such as the user’s name and email, and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1094.1">
      roles
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1095.1">
     , which
    </span>
    <a id="_idIndexMarker496">
    </a>
    <span class="koboSpan" id="kobo.1096.1">
     allow us to determine the user’s access type, such as admin, member, and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1097.1">
      so on.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1098.1">
     The ASP.NET Core 9 HttpContext object
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1099.1">
     In ASP.NET Core,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1100.1">
      HttpContext.User
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1101.1">
     is a
    </span>
    <a id="_idIndexMarker497">
    </a>
    <span class="koboSpan" id="kobo.1102.1">
     core property that represents the user security context associated with an HTTP request.
    </span>
    <span class="koboSpan" id="kobo.1102.2">
     This property is an instance of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1103.1">
      ClaimsPrincipal
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1104.1">
     , a .NET class that contains the user’s identity in the form of claims.
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1105.1">
      HttpContext.User
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1106.1">
     is a key element in handling user authentication and authorization in an ASP.NET
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1107.1">
      Core application.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1108.1">
     During the authentication process, when a request arrives at the application, the authentication middleware reads the authentication tokens or cookies attached to the request, validates them, and constructs a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1109.1">
      ClaimsPrincipal
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1110.1">
     object.
    </span>
    <span class="koboSpan" id="kobo.1110.2">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1111.1">
      ClaimsPrincipal
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1112.1">
     object can contain one or more instances
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1113.1">
      of
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1114.1">
       ClaimsIdentity
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1115.1">
      .
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1116.1">
     Each
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1117.1">
      ClaimsIdentity
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1118.1">
     instance can contain multiple claims.
    </span>
    <span class="koboSpan" id="kobo.1118.2">
     A claim is a statement about a subject that’s been made by an issuer and can represent the user’s identity attributes, such as name, role, email,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1119.1">
      and more.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1120.1">
     This process allows the use of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1121.1">
      HttpContext.User
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1122.1">
     in application-wide authorization checks to determine whether the current user has permission to perform certain operations to ensure that only properly authenticated and authorized users can access certain resources or perform
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1123.1">
      specific actions.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1124.1">
     The following code shows the
    </span>
    <a id="_idIndexMarker498">
    </a>
    <span class="koboSpan" id="kobo.1125.1">
     use of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1126.1">
      HttpContext.User
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1127.1">
     when executing an action.
    </span>
    <span class="koboSpan" id="kobo.1127.2">
     This object is automatically populated by the execution pipeline
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1128.1">
      through middleware:
     </span>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1129.1">
      public
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1130.1">
       IActionResult ExampleAction(){
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1131.1">
      var user =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1132.1">
       HttpContext.User;
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1133.1">
      if (user.Identity.IsAuthenticated)     {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1134.1">
      // Do something for
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1135.1">
       authenticated users
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1136.1">
      var userName =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1137.1">
       user.Identity.Name;
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1138.1">
      // Get the
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1139.1">
       user's name
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1140.1">
      return
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1141.1">
       Content($"Welcome, {userName}");
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1142.1">
      }
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1143.1">
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1144.1">
       else
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1145.1">
      {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1146.1">
      // Handle
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1147.1">
       non-authenticated users
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1148.1">
      return Unauthorized("You must be logged in to
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1149.1">
       access this.");
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1150.1">
      }
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1151.1">
      }
     </span>
    </strong>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1152.1">
     You can learn more
    </span>
    <a id="_idIndexMarker499">
    </a>
    <span class="koboSpan" id="kobo.1153.1">
     about
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1154.1">
      HttpContext
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1155.1">
      at
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/http-context?view=aspnetcore-8.0#httpcontext-user">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1156.1">
       https://learn.microsoft.com/en-us/aspnet/core/fundamentals/http-context?view=aspnetcore-8.0#httpcontext-user
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1157.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1158.1">
     Authorization middleware
    </span>
    <a id="_idIndexMarker500">
    </a>
    <span class="koboSpan" id="kobo.1159.1">
     analyzes whether the requested route requires authorization.
    </span>
    <span class="koboSpan" id="kobo.1159.2">
     If so, it decrypts the token, analyzes whether it’s a valid token, and allows the request on the route to be
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1160.1">
      made correctly.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1161.1">
     What is middleware?
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1162.1">
     During the execution
    </span>
    <a id="_idIndexMarker501">
    </a>
    <span class="koboSpan" id="kobo.1163.1">
     flow of a request in ASP.NET Core 9, several types of processes are carried out, such as identifying the route to be executed, among other functionalities.
    </span>
    <span class="koboSpan" id="kobo.1163.2">
     This flow is called a pipeline.
    </span>
    <span class="koboSpan" id="kobo.1163.3">
     In
    </span>
    <a id="_idIndexMarker502">
    </a>
    <span class="koboSpan" id="kobo.1164.1">
     some cases, there’s a need to add functionality to the execution pipeline.
    </span>
    <span class="koboSpan" id="kobo.1164.2">
     This is done through middleware, something we implemented by adding the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1165.1">
      app.UseAuthtentication()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1166.1">
     and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1167.1">
      app.UseAuthorization()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1168.1">
     method calls to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1169.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1170.1">
     file, which allows us to pre-process the request for authentication and authorization requirements.
    </span>
    <span class="koboSpan" id="kobo.1170.2">
     Through middleware, it’s possible to add functionality to both requests
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1171.1">
      and responses.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1172.1">
     We’ll learn more about middleware in
    </span>
    <a href="B21788_08.xhtml#_idTextAnchor132">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.1173.1">
        Chapter 8
       </span>
      </em>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1174.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1175.1">
     With each API request, the token is sent so that the user information and their respective accesses are loaded during the request execution flow.
    </span>
    <span class="koboSpan" id="kobo.1175.2">
     This is a characteristic of cloud-native applications.
    </span>
    <span class="koboSpan" id="kobo.1175.3">
     The stateless approach allows applications to be scalable and resilient and ensures the server doesn’t retain any information about a client’s state between requests, eliminating the need to manage session state.
    </span>
    <span class="koboSpan" id="kobo.1175.4">
     This leads to easier scaling and load balancing, makes it easier to scale servers when the need arises to handle high user demand, and allows each server instance to be able to handle any request without needing to know the context of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1176.1">
      previous requests.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1177.1">
     By not relying on server-side state, developers can avoid issues related to session management, such as session persistence, synchronization across distributed systems, and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1178.1">
      resource locking.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1179.1">
     Modern applications must have security as a premise by design, and the implementation of authentication and authorization has several advantages within the context of applications.
    </span>
    <span class="koboSpan" id="kobo.1179.2">
     However, other aspects related to security are linked not only to the functionalities available to users but also to the application’s source code.
    </span>
    <span class="koboSpan" id="kobo.1179.3">
     In the next section, we’ll learn how to reinforce security
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1180.1">
      in applications.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-110">
    <a id="_idTextAnchor111">
    </a>
    <span class="koboSpan" id="kobo.1181.1">
     Strengthening application security
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1182.1">
     For us to be
    </span>
    <a id="_idIndexMarker503">
    </a>
    <span class="koboSpan" id="kobo.1183.1">
     able to create secure web-based applications, we must go beyond implementing the use of a security layer based on authentication and authorization, something we implemented when using ASP.NET
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1184.1">
      Core Identity.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1185.1">
     ASP.NET Core 9 allows us to deal with security as a premise when developing applications, providing tools and mechanisms that facilitate the implementation of features that minimize possible loopholes, something that can generate attacks from
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1186.1">
      malicious users.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1187.1">
     Let’s learn about some good security practices that should be part of every software engineer’s toolbox.
    </span>
    <span class="koboSpan" id="kobo.1187.2">
     We’ll start by understanding how we can improve the process of managing sensitive configurations in our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1188.1">
      development environment.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-111">
    <a id="_idTextAnchor112">
    </a>
    <span class="koboSpan" id="kobo.1189.1">
     Managing secrets properly
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1190.1">
     Every application has
    </span>
    <a id="_idIndexMarker504">
    </a>
    <span class="koboSpan" id="kobo.1191.1">
     configurations and some of these can be sensitive, such as database connections, encryption keys, and even security keys for accessing
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1192.1">
      external resources.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1193.1">
     So far, we’ve learned that it’s good practice to keep such settings separate from the C# source code and that we can manage settings through files such as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1194.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1195.1">
     and even environment variables.
    </span>
    <span class="koboSpan" id="kobo.1195.2">
     ASP.NET Core 9 allows us to handle external
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1196.1">
      configuration management.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1197.1">
     Keeping the settings hard-coded is a bad practice since to change any hard-coded parameter, we must recompile the application.
    </span>
    <span class="koboSpan" id="kobo.1197.2">
     In addition, there’s the possibility of malicious users decompiling the application if they have access to the binaries, and then obtaining
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1198.1">
      sensitive data.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1199.1">
     Obfuscator
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1200.1">
     Code obfuscation
    </span>
    <a id="_idIndexMarker505">
    </a>
    <span class="koboSpan" id="kobo.1201.1">
     refers to the process of transforming application source code into a form that’s difficult for humans to understand but can still be executed by a computer.
    </span>
    <span class="koboSpan" id="kobo.1201.2">
     This technique is primarily used to protect intellectual property by making it difficult for attackers or unauthorized users to reverse engineer the code and understand
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1202.1">
      its logic.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1203.1">
     The process of obfuscation involves several techniques, such as renaming variables and methods to meaningless symbols, removing metadata, encrypting strings, and altering the control flow to make the code more
    </span>
    <a id="_idIndexMarker506">
    </a>
    <span class="koboSpan" id="kobo.1204.1">
     complex.
    </span>
    <span class="koboSpan" id="kobo.1204.2">
     For more information, go
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1205.1">
      to
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/visualstudio/ide/dotfuscator/?view=vs-2022">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1206.1">
       https://learn.microsoft.com/en-us/visualstudio/ide/dotfuscator/?view=vs-2022
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1207.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1208.1">
     Imagine a situation where our
    </span>
    <a id="_idIndexMarker507">
    </a>
    <span class="koboSpan" id="kobo.1209.1">
     application uses an API key to connect to a payment gateway to process transactions from an online store, or even the database connection string.
    </span>
    <span class="koboSpan" id="kobo.1209.2">
     If this key is exposed, malicious users can potentially manipulate transaction data, access sensitive information, and even delete
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1210.1">
      your database.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1211.1">
     You might be thinking that since your code is in a private repository, and all settings are being kept in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1212.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1213.1">
     files, this problem
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1214.1">
      is solved.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1215.1">
     Of course, since it’s a private repository, the chances of an attacker gaining access to the data aren’t very high.
    </span>
    <span class="koboSpan" id="kobo.1215.2">
     However, consider that your company may work with employees and third-party companies that can access the data in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1216.1">
      your repository.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1217.1">
     While it’s good practice to manage settings in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1218.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1219.1">
     files, this isn’t a good approach for sensitive information.
    </span>
    <span class="koboSpan" id="kobo.1219.2">
     With this, we avoid synchronizing the source code of applications with external repositories containing information that shouldn’t
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1220.1">
      be shared.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1221.1">
     Fortunately, ASP.NET Core 9 implements the best development practices and provides secret management in your local environment.
    </span>
    <span class="koboSpan" id="kobo.1221.2">
     Proper secret management ensures that sensitive data, such as API keys, isn’t hard-coded into your application’s source code but is stored and accessed securely, protecting your infrastructure and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1222.1">
      data integrity.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1223.1">
     The Secret Manager tool
    </span>
    <a id="_idIndexMarker508">
    </a>
    <span class="koboSpan" id="kobo.1224.1">
     is included in the .NET Core SDK, so you typically don’t need to install anything else if you have
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1225.1">
      the SDK.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1226.1">
     To start using Secret Manager, you need to initialize it for your project.
    </span>
    <span class="koboSpan" id="kobo.1226.2">
     Navigate to the project’s
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1227.1">
      WorkingWithIdentity
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1228.1">
     directory, which we worked on previously, in the Command Prompt or terminal where your
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1229.1">
      .csproj
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1230.1">
     file is located.
    </span>
    <span class="koboSpan" id="kobo.1230.2">
     Then, run the following command to initialize
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1231.1">
      secret storage:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.1232.1">
dotnet user-secrets init</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1233.1">
     The preceding command adds a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1234.1">
      UserSecretsId
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1235.1">
     element within a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1236.1">
      PropertyGroup
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1237.1">
     value to your
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1238.1">
      .csproj
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1239.1">
     (project file).
    </span>
    <span class="koboSpan" id="kobo.1239.2">
     This ID uniquely identifies your
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1240.1">
      project’s secrets.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1241.1">
     You can verify the addition of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1242.1">
      UserSecretsId
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1243.1">
     element by opening the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1244.1">
      .csproj
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1245.1">
     file in your code editor, as shown in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.1246.1">
       Figure 6
      </span>
     </em>
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.1247.1">
       .17
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1248.1">
      :
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer080">
     <span class="koboSpan" id="kobo.1249.1">
      <img alt="Figure 6.17 – The UserSecretsId element configured in the .csproj file" src="image/B21788_06_17.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.1250.1">
     Figure 6.17 – The UserSecretsId element configured in the .csproj file
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1251.1">
     Next, we’ll configure the
    </span>
    <a id="_idIndexMarker509">
    </a>
    <span class="koboSpan" id="kobo.1252.1">
     connection string with the SQL Server database.
    </span>
    <span class="koboSpan" id="kobo.1252.2">
     To do this, we must add some new code by executing the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1253.1">
      following command:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.1254.1">
dotnet user-secrets set "ConnectionStrings:BankingDbContext" "YOUR DATABASE CONNECTION STRING"</span></pre>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1255.1">
     Secrets naming convention
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1256.1">
     The notation commonly uses colons (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1257.1">
      :
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1258.1">
     ) to separate different levels of a hierarchy in the key names of secrets.
    </span>
    <span class="koboSpan" id="kobo.1258.2">
     This structure not only helps in organizing the keys logically but also aligns with how the ASP.NET Core 9 configuration system retrieves values from various configuration sources, such as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1259.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1260.1">
     , environment variables, and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1261.1">
      Secret Manager.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1262.1">
     In the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1263.1">
      WorkingWithIdentity
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1264.1">
     application, we have the following configuration in the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1265.1">
       appsettings.json
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1266.1">
      file:
     </span>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1267.1">
      "
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1268.1">
       ConnectionStrings" {
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1269.1">
      "
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1270.1">
       BankingDbContext": "..."
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1271.1">
      }
     </span>
    </strong>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1272.1">
     The preceding JSON represents a property of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1273.1">
      object
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1274.1">
     type called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1275.1">
      ConnectionStrings
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1276.1">
     that has a string property
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1277.1">
      called
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1278.1">
       BankingDbContext
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1279.1">
      .
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1280.1">
     Based on this, the secret is called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1281.1">
      ConnectionStrings:BankingDbContext
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1282.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1282.2">
     Here,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1283.1">
      ConnectionStrings
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1284.1">
     is the top-level category and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1285.1">
      BankingDbContext
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1286.1">
     is the actual key containing the respective secret – in this case, the SQL Server database connection string.
    </span>
    <span class="koboSpan" id="kobo.1286.2">
     This notation helps to logically group
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1287.1">
      related settings.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1288.1">
     Since this is a convention used by ASP.NET Core 9, there’s no need to change the application’s source code to obtain the database
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1289.1">
      connection string.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1290.1">
     When using environment variables (which don’t allow colons in variable names on some operating systems), colon separators are typically replaced with double underscores (
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1291.1">
      __
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1292.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.1292.2">
     So, if you were defining these secrets via environment variables in a production environment, you would define them
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1293.1">
      like this:
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1294.1">
       ConnectionStrings__BankingDbContext
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1295.1">
     This naming convention ensures that when the ASP.NET Core configuration system reads the environment variables, it can reconstruct the hierarchy and treat them equivalently to secrets defined in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1296.1">
      appsettings.json
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1297.1">
     or
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1298.1">
      Secret Manager.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1299.1">
     There’s no need to change the
    </span>
    <a id="_idIndexMarker510">
    </a>
    <span class="koboSpan" id="kobo.1300.1">
     application code to obtain the secret since this is a feature of ASP.NET Core 9 and works in the same way if you want to use
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1301.1">
      environment variables.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1302.1">
     The secret that’s created is kept in the operating system; its location may vary from environment to environment.
    </span>
    <span class="koboSpan" id="kobo.1302.2">
     However, you can manage secrets using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1303.1">
      user-secrets
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1304.1">
     tool.
    </span>
    <span class="koboSpan" id="kobo.1304.2">
     For example, you can use it to list the secrets that exist on your
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1305.1">
      local machine:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.1306.1">
dotnet user-secrets list</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1307.1">
     You can use the following command to remove a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1308.1">
      specific secret:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.1309.1">
dotnet user-secrets remove "ConnectionStrings:BankingDbContext"</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1310.1">
     You can even clear
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1311.1">
      all secrets:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.1312.1">
dotnet user-secrets clear</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1313.1">
     All secrets information is kept in your operating system.
    </span>
    <span class="koboSpan" id="kobo.1313.2">
     When integrating the source code with your remote code repository, the secrets won’t
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1314.1">
      be shared.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1315.1">
     Keep in mind that the
    </span>
    <a id="_idIndexMarker511">
    </a>
    <span class="koboSpan" id="kobo.1316.1">
     Secret Manager tool is intended for development purposes only.
    </span>
    <span class="koboSpan" id="kobo.1316.2">
     For production environments, you should use a secure vault such
    </span>
    <a id="_idIndexMarker512">
    </a>
    <span class="koboSpan" id="kobo.1317.1">
     as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1318.1">
      Azure Key Vault
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1319.1">
     ,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1320.1">
      AWS Secrets Manager
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1321.1">
     , or another secure means of managing sensitive
    </span>
    <a id="_idIndexMarker513">
    </a>
    <span class="koboSpan" id="kobo.1322.1">
     configuration data.
    </span>
    <span class="koboSpan" id="kobo.1322.2">
     We’ll learn more about configuration management in
    </span>
    <a href="B21788_09.xhtml#_idTextAnchor146">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.1323.1">
        Chapter 9
       </span>
      </em>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1324.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1325.1">
     Now that we know how to better manage application secrets, let’s learn about other good security
    </span>
    <a id="_idIndexMarker514">
    </a>
    <span class="koboSpan" id="kobo.1326.1">
     practices, including
    </span>
    <a id="_idIndexMarker515">
    </a>
    <span class="koboSpan" id="kobo.1327.1">
     the use of
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1328.1">
      Hypertext Transfer Protocol Secure
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1329.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1330.1">
      HTTPS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1331.1">
     ) and
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1332.1">
      Cross-Origin Resource
     </span>
    </strong>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.1333.1">
       Sharing
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1334.1">
      (
     </span>
    </span>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.1335.1">
       CORS
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1336.1">
      ).
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-112">
    <a id="_idTextAnchor113">
    </a>
    <span class="koboSpan" id="kobo.1337.1">
     Enforcing HTTPS and working with CORS
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1338.1">
     HTTPS enforcement
    </span>
    <a id="_idIndexMarker516">
    </a>
    <span class="koboSpan" id="kobo.1339.1">
     is important for ensuring secure communication between clients and servers by encrypting data transmitted over the network.
    </span>
    <span class="koboSpan" id="kobo.1339.2">
     As we’ve already learned, ASP.NET Core 9 provides us with integrated middleware to enforce HTTPS, which can be configured to redirect all HTTP requests
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1340.1">
      to HTTPS.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1341.1">
     To enforce HTTPS in an ASP.NET Core 9 application, simply add the following line of code to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1342.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1343.1">
     file to add a middleware to the application’s
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1344.1">
      execution pipeline:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1345.1">
// Enforce HTTPS
app.UseHttpsRedirection();</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1346.1">
     It’s important to know that adding the middleware that enforces the use of HTTPS is a configuration step for the application.
    </span>
    <span class="koboSpan" id="kobo.1346.2">
     Likewise, you must also configure your web server (for example, IIS, NGINX, Azure
    </span>
    <a id="_idIndexMarker517">
    </a>
    <span class="koboSpan" id="kobo.1347.1">
     App Services, and so on) to enforce HTTPS and obtain a valid SSL/TLS certificate from a trusted
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1348.1">
      certificate authority.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1349.1">
     In addition to enforcing HTTPS, you
    </span>
    <a id="_idIndexMarker518">
    </a>
    <span class="koboSpan" id="kobo.1350.1">
     can configure
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1351.1">
      CORS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1352.1">
     , a feature that’s implemented by browsers to restrict web applications running on one origin from accessing resources on a different origin without explicit permission.
    </span>
    <span class="koboSpan" id="kobo.1352.2">
     It’s more common to see this type of behavior in SPA applications that use technologies such
    </span>
    <a id="_idIndexMarker519">
    </a>
    <span class="koboSpan" id="kobo.1353.1">
     as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1354.1">
      Angular
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1355.1">
     ,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1356.1">
      React
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1357.1">
     , or
    </span>
    <a id="_idIndexMarker520">
    </a>
    <span class="koboSpan" id="kobo.1358.1">
     even
    </span>
    <a id="_idIndexMarker521">
    </a>
    <span class="koboSpan" id="kobo.1359.1">
     pure
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.1360.1">
      JavaScript
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1361.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1361.2">
     When making an HTTP request through JavaScript, it’s executed in the browser, which, through the security mechanism, doesn’t allow a request on one origin server to be made to another server where the resource is hosted.
    </span>
    <span class="koboSpan" id="kobo.1361.3">
     Fortunately, ASP.NET Core 9 provides middleware to configure and manage CORS policies, allowing you to specify which origins, headers, and methods are allowed.
    </span>
    <span class="koboSpan" id="kobo.1361.4">
     This feature is interesting because we can only respond to certain requests based on a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1362.1">
      specific origin.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1363.1">
     To enable and configure
    </span>
    <a id="_idIndexMarker522">
    </a>
    <span class="koboSpan" id="kobo.1364.1">
     CORS in an ASP.NET Core 9 application, you can add the following code to the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1365.1">
       Program.cs
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1366.1">
      file:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1367.1">
var builder = WebApplication.CreateBuilder(args);
// Add services to the container.
</span><span class="koboSpan" id="kobo.1367.2">builder.Services.AddRazorPages();
// Configure CORS policy
</span><strong class="bold"><span class="koboSpan" id="kobo.1368.1">builder.Services.AddCors(options =&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1369.1">{</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1370.1">    options.AddPolicy("AllowSpecificOrigin",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1371.1">        builder =&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1372.1">        {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1373.1">            builder.WithOrigins("https://myapp.com")</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1374.1">                   .AllowAnyHeader()</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1375.1">                   .AllowAnyMethod();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1376.1">        });</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1377.1">});</span></strong><span class="koboSpan" id="kobo.1378.1">
var app = builder.Build();
// Enforce HTTPS
app.UseHttpsRedirection();
// Use CORS policy
</span><strong class="bold"><span class="koboSpan" id="kobo.1379.1">app.UseCors("AllowSpecificOrigin");</span></strong><span class="koboSpan" id="kobo.1380.1">
app.UseStaticFiles();
app.UseRouting();
app.UseAuthorization();
app.MapRazorPages();
app.Run();</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1381.1">
     Let’s understand the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1382.1">
      preceding code:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1383.1">
       builder.Services.AddCors(options =&gt; { ...
      </span>
      <span class="koboSpan" id="kobo.1383.2">
       })
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1384.1">
      : This line adds CORS services
     </span>
     <a id="_idIndexMarker523">
     </a>
     <span class="koboSpan" id="kobo.1385.1">
      to the application’s dependency injection container.
     </span>
     <span class="koboSpan" id="kobo.1385.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1386.1">
       options
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1387.1">
      parameter, which is of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1388.1">
       Action&lt;CorsOptions&gt;
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1389.1">
      type, allows you to configure
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1390.1">
       CORS policies.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1391.1">
       options.AddPolicy
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1392.1">
      : In this line, we’re adding a new policy named
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1393.1">
       AllowSpecificOrigin
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1394.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1394.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1395.1">
       builder
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1396.1">
      parameter in the Lambda expression is an instance of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1397.1">
       CorsPolicyBuilder
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1398.1">
      class, which provides methods to configure
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1399.1">
       the policy.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1400.1">
       builder.WithOrigins("https://myapp.com")
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1401.1">
      : The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1402.1">
       WithOrigins
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1403.1">
      method defines the origins that are allowed to access the application’s resources.
     </span>
     <span class="koboSpan" id="kobo.1403.2">
      In this case, any requests coming from
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1404.1">
       https://myapp.com
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1405.1">
      will be allowed by this
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1406.1">
       CORS policy.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1407.1">
       AllowAnyHeader()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1408.1">
      : The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1409.1">
       AllowAnyHeader
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1410.1">
      method allows any HTTP headers in the request, allowing the specified origin to include any headers without being blocked by the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1411.1">
       CORS policy.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1412.1">
       AllowAnyMethod()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1413.1">
      : This method defines that any HTTP methods (
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1414.1">
       GET
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1415.1">
      ,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1416.1">
       POST
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1417.1">
      ,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1418.1">
       PUT
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1419.1">
      ,
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1420.1">
       DELETE
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1421.1">
      , and others) can be used in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1422.1">
       the request.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.1423.1">
       app.UseCors("AllowSpecificOrigin")
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1424.1">
      : This triggers the CORS middleware in the
     </span>
     <a id="_idIndexMarker524">
     </a>
     <span class="koboSpan" id="kobo.1425.1">
      request pipeline, referencing the previously created policy globally to all HTTP requests of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1426.1">
       the application.
      </span>
     </span>
    </li>
   </ul>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.1427.1">
     Learn more about CORS
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.1428.1">
     As defined earlier, CORS is
    </span>
    <a id="_idIndexMarker525">
    </a>
    <span class="koboSpan" id="kobo.1429.1">
     an HTTP header-based mechanism that lets you tell the browser which origins can load resources.
    </span>
    <span class="koboSpan" id="kobo.1429.2">
     ASP.NET Core 9 has an excellent framework for implementing CORS in your applications.
    </span>
    <span class="koboSpan" id="kobo.1429.3">
     To learn more, go
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1430.1">
      to
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-9.0">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1431.1">
       https://learn.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-9.0
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1432.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1433.1">
     The preceding example illustrates the use of CORS in an ASP.NET Core 9 application.
    </span>
    <span class="koboSpan" id="kobo.1433.2">
     However, apart from the origin, it doesn’t have restrictions on the use of HTTP headers or methods.
    </span>
    <span class="koboSpan" id="kobo.1433.3">
     In some cases, it will be necessary to explicitly define the HTTP headers and methods that an origin
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1434.1">
      can access.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1435.1">
     However, the features available in ASP.NET Core 9 give us great flexibility in defining different policies for different origins, creating more restricted and specific rules for CORS.
    </span>
    <span class="koboSpan" id="kobo.1435.2">
     This is an important mechanism since the browser uses it to allow SPAs or other applications running on the client to be able to consume external
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1436.1">
      resources appropriately.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1437.1">
     CORS is not a
    </span>
    <a id="_idIndexMarker526">
    </a>
    <span class="koboSpan" id="kobo.1438.1">
     security mechanism, but its use is recommended.
    </span>
    <span class="koboSpan" id="kobo.1438.2">
     In the next section, we’ll talk about some security mechanisms we can use to prevent vulnerabilities
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1439.1">
      in applications.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-113">
    <a id="_idTextAnchor114">
    </a>
    <span class="koboSpan" id="kobo.1440.1">
     Preventing common vulnerabilities
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.1441.1">
     When we talk about vulnerabilities
    </span>
    <a id="_idIndexMarker527">
    </a>
    <span class="koboSpan" id="kobo.1442.1">
     in applications, several topics can be taken into consideration, such as source code, servers, credential management, protocols used, and encryption,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1443.1">
      among others.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1444.1">
     Some common vulnerabilities are already well known, but if they aren’t addressed in applications, they can cause some problems for organizations.
    </span>
    <span class="koboSpan" id="kobo.1444.2">
     ASP.NET Core 9 offers mechanisms for dealing with several common threats in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1445.1">
      web applications:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1446.1">
       SQL injection
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1447.1">
       Cross-site
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1448.1">
        scripting
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1449.1">
       (
      </span>
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1450.1">
        XSS
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1451.1">
       )
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.1452.1">
       Cross-site request
      </span>
     </strong>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1453.1">
        forgery
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1454.1">
       (
      </span>
     </span>
     <span class="No-Break">
      <strong class="bold">
       <span class="koboSpan" id="kobo.1455.1">
        CSRF
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1456.1">
       )
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.1457.1">
     Let’s learn how to prevent each of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1458.1">
      these vulnerabilities.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.1459.1">
     SQL injection
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.1460.1">
     SQL injection is a
    </span>
    <a id="_idIndexMarker528">
    </a>
    <span class="koboSpan" id="kobo.1461.1">
     common attack where an attacker inserts malicious SQL code into an
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1462.1">
      SQL query.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1463.1">
     To prevent SQL injection, always use
    </span>
    <a id="_idIndexMarker529">
    </a>
    <span class="koboSpan" id="kobo.1464.1">
     parameterized queries or ORM frameworks such as Entity Framework, which handle query parameters safely and help us avoid string concatenation.
    </span>
    <span class="koboSpan" id="kobo.1464.2">
     We learned about this in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1465.1">
      Security topics in web
     </span>
    </em>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.1466.1">
       applications
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1467.1">
      section.
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.1468.1">
     XSS
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.1469.1">
     XSS attacks
    </span>
    <a id="_idIndexMarker530">
    </a>
    <span class="koboSpan" id="kobo.1470.1">
     occur when an attacker injects malicious scripts into a web page.
    </span>
    <span class="koboSpan" id="kobo.1470.2">
     To prevent XSS, always encode or escape user input before rendering it in the browser.
    </span>
    <span class="koboSpan" id="kobo.1470.3">
     This way, if there’s any code injection in an input, for example, it will be encoded with special characters.
    </span>
    <span class="koboSpan" id="kobo.1470.4">
     ASP.NET Core 9 provides built-in helpers to sanitize the output, as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1471.1">
      following example:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1472.1">
@{
var inputSimulator = "&lt;script&gt;
  alert('Injected Code');&lt;/script&gt;";
}
&lt;p&gt;@inputSimulator&lt;/p&gt;
// output: &amp;lt;script&amp;gt;alert('Injected Code');&amp;lt;/script&amp;gt;</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1473.1">
     In the
    </span>
    <a id="_idIndexMarker531">
    </a>
    <span class="koboSpan" id="kobo.1474.1">
     preceding example, the JavaScript code was encoded, preventing the injected code from being sent and executed since, after encoding, it becomes just a string.
    </span>
    <span class="koboSpan" id="kobo.1474.2">
     To learn more about the vulnerabilities associated with XSS, go
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1475.1">
      to
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/aspnet/core/security/cross-site-scripting?view=aspnetcore-9.0">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1476.1">
       https://learn.microsoft.com/en-us/aspnet/core/security/cross-site-scripting?view=aspnetcore-9.0
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1477.1">
      .
     </span>
    </span>
   </p>
   <h3>
    <span class="koboSpan" id="kobo.1478.1">
     CSRF
    </span>
   </h3>
   <p>
    <span class="koboSpan" id="kobo.1479.1">
     CSRF
    </span>
    <a id="_idIndexMarker532">
    </a>
    <span class="koboSpan" id="kobo.1480.1">
     is a type of security attack in which a malicious website tricks a user’s browser into performing actions on another website where the user is authenticated, without the user’s knowledge.
    </span>
    <span class="koboSpan" id="kobo.1480.2">
     This can lead to unauthorized actions such as changing settings, transferring funds, or making purchases.
    </span>
    <span class="koboSpan" id="kobo.1480.3">
     ASP.NET Core provides built-in anti-forgery tokens to prevent CSRF attacks.
    </span>
    <span class="koboSpan" id="kobo.1480.4">
     These tokens are automatically included in forms and validated on
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1481.1">
      the server.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1482.1">
     To use anti-forgery tokens in a simplified way in Razor Pages or MVC, add the following code to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1483.1">
      your form:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1484.1">
&lt;form method="post"&gt;
@Html.AntiForgeryToken()
&lt;!-- Form fields --&gt;
&lt;input type="submit" value="Submit" /&gt;
&lt;/form&gt;</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1485.1">
     At this point, we
    </span>
    <a id="_idIndexMarker533">
    </a>
    <span class="koboSpan" id="kobo.1486.1">
     must add the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.1487.1">
      ValidateAntiForgeryToken
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1488.1">
     attribute to the action that will process the form request, as
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1489.1">
      shown here:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.1490.1">
[ValidateAntiForgeryToken]
public IActionResult SubmitForm()
{
  // Process the form submission
  return View();
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.1491.1">
     ASP.NET Core 9 also
    </span>
    <a id="_idIndexMarker534">
    </a>
    <span class="koboSpan" id="kobo.1492.1">
     ¢provides other mechanisms for dealing with this vulnerability.
    </span>
    <span class="koboSpan" id="kobo.1492.2">
     You can learn more
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1493.1">
      at
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-9.0">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.1494.1">
       https://learn.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-9.0
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1495.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1496.1">
     As we’ve learned, applications can contain several vulnerabilities that aren’t only associated with the source code but also with the hosting server, communication protocol, and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1497.1">
      many others.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1498.1">
     In any case, the ASP.NET Core 9 platform provides several mechanisms and best practices that, combined and related to the requirements of the applications, allow us to minimize risks and keep our solutions robust, secure, and reliable while following the best practices of modern applications.
    </span>
    <span class="koboSpan" id="kobo.1498.2">
     As we progress through this book, we’ll learn about more mechanisms and approaches we can use to create increasingly
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1499.1">
      robust applications.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-114">
    <a id="_idTextAnchor115">
    </a>
    <span class="koboSpan" id="kobo.1500.1">
     Summary
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.1501.1">
     In this chapter, we learned about the principles of web application security and how they influence the development model and the interaction with users and other applications.
    </span>
    <span class="koboSpan" id="kobo.1501.2">
     In addition, we learned about the authorization and authentication processes, comparing the flows of these processes and getting to know standards such as OAuth 2.0 and OIDC.
    </span>
    <span class="koboSpan" id="kobo.1501.3">
     To reinforce our knowledge about authentication and authorization, we worked with ASP.NET Core Identity, which provides all the mechanisms that support user authentication and authorization in an application, integrated with a database for managing identities securely.
    </span>
    <span class="koboSpan" id="kobo.1501.4">
     To do so, we consumed information securely by providing tokens provided by ASP.NET Core Identity.
    </span>
    <span class="koboSpan" id="kobo.1501.5">
     Finally, we discussed how to strengthen the security of applications, understood secret management, and learned about techniques such as the use of CORS to prevent common vulnerabilities in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1502.1">
      web applications.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.1503.1">
     In the next chapter, we’ll learn how to add more capabilities to applications, understand how to implement best practices, and learn how to use caching
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.1504.1">
      and monitoring.
     </span>
    </span>
   </p>
  </div>
 

  <div class="Content" id="_idContainer082">
   <h1 id="_idParaDest-115" lang="en-US" xml:lang="en-US">
    <a id="_idTextAnchor116">
    </a>
    <span class="koboSpan" id="kobo.1.1">
     Part 3: Applying Best Practices
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.2.1">
     In this section, we assume that you are more familiar with the ASP.NET Core 9 platform and most of the powerful features available in this technology.
    </span>
    <span class="koboSpan" id="kobo.2.2">
     As we advance in the knowledge of the platform and the need to develop increasingly rich solutions, we must stick to best practices.
    </span>
    <span class="koboSpan" id="kobo.2.3">
     Therefore, we will cover topics related to the addition of features that interact with the application, including the challenge strategy, resilience, and best practices.
    </span>
    <span class="koboSpan" id="kobo.2.4">
     We will also learn how to implement monitoring (Logging and Tracing), allowing software engineers the ability to deal with bug fixes, optimizations, and proactive actions.
    </span>
    <span class="koboSpan" id="kobo.2.5">
     We will also explore the use of Middleware to customize the interaction flow in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.3.1">
      the application.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.4.1">
     This part has the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.5.1">
      following chapters:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <a href="B21788_07.xhtml#_idTextAnchor117">
      <em class="italic">
       <span class="koboSpan" id="kobo.6.1">
        Chapter 7
       </span>
      </em>
     </a>
     <span class="koboSpan" id="kobo.7.1">
      ,
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.8.1">
       Adding Capabilities to Applications
      </span>
     </em>
    </li>
    <li>
     <a href="B21788_08.xhtml#_idTextAnchor132">
      <em class="italic">
       <span class="koboSpan" id="kobo.9.1">
        Chapter 8
       </span>
      </em>
     </a>
     <span class="koboSpan" id="kobo.10.1">
      ,
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.11.1">
       Enhancing Applications with Middleware in ASP.NET Core 9
      </span>
     </em>
    </li>
    <li>
     <a href="B21788_09.xhtml#_idTextAnchor146">
      <em class="italic">
       <span class="koboSpan" id="kobo.12.1">
        Chapter 9
       </span>
      </em>
     </a>
     <span class="koboSpan" id="kobo.13.1">
      ,
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.14.1">
       Managing Application Settings
      </span>
     </em>
    </li>
   </ul>
  </div>
  <div>
   <div id="_idContainer083">
   </div>
  </div>
  <div>
   <div class="Basic-Graphics-Frame" id="_idContainer084">
   </div>
  </div>
 </body></html>