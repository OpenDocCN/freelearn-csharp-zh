<html><head></head><body>
<div id="_idContainer206">
<h1 class="chapterNumber"><a id="_idTextAnchor261"/><span class="koboSpan" id="kobo.1.1">9</span></h1>
<h1 class="chapterTitle" id="_idParaDest-180"><a id="_idTextAnchor262"/><span class="koboSpan" id="kobo.2.1">Simplifying Containers and Kubernetes: Azure Container Apps, and Othert Tools</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">While Kubernetes is probably the most complete orchestrator, any transition from monolithic development to microservices on Kubernetes faces two hard difficulties.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">The first difficulty is that the cost of a Kubernetes cluster often is not justified by the initial low traffic of the application. </span><span class="koboSpan" id="kobo.4.2">In fact, a production-grade Kubernetes cluster typically requires multiple nodes for redundancy and reliability. </span><span class="koboSpan" id="kobo.4.3">While self-managed clusters may need at least two master </span><a id="_idIndexMarker725"/><span class="koboSpan" id="kobo.5.1">nodes and three worker nodes, managed </span><a id="_idIndexMarker726"/><span class="koboSpan" id="kobo.6.1">Kubernetes services such as </span><strong class="keyWord"><span class="koboSpan" id="kobo.7.1">Amazon Elastic Kubernetes Service</span></strong><span class="koboSpan" id="kobo.8.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.9.1">Amazon EKS</span></strong><span class="koboSpan" id="kobo.10.1">), </span><strong class="keyWord"><span class="koboSpan" id="kobo.11.1">Azure Kubernetes Service</span></strong><span class="koboSpan" id="kobo.12.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.13.1">AKS</span></strong><span class="koboSpan" id="kobo.14.1">), or </span><strong class="keyWord"><span class="koboSpan" id="kobo.15.1">Google Kubernetes Engine</span></strong><span class="koboSpan" id="kobo.16.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.17.1">GKE</span></strong><span class="koboSpan" id="kobo.18.1">) often handle control plane redundancy at a lower cost (Amazon EKS control </span><a id="_idIndexMarker727"/><span class="koboSpan" id="kobo.19.1">plane costs ~$72/month). </span><span class="koboSpan" id="kobo.19.2">Teams can start with smaller instance </span><a id="_idIndexMarker728"/><span class="koboSpan" id="kobo.20.1">types and scale as needed, reducing the initial burden.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.21.1">Another difficulty is the learning curve of Kubernetes itself. </span><span class="koboSpan" id="kobo.21.2">Moving the whole team to discrete Kubernetes knowledge/expertise might require time that we simply don’t have. </span><span class="koboSpan" id="kobo.21.3">Moreover, if we are transitioning an existing monolithic application, at the beginning of the transition—when the number of microservices is still low and their organization still resembles the same organization of the monolithic application—we simply don’t need all the opportunities and options offered by Kubernetes.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.22.1">The preceding considerations led to the conception of </span><strong class="keyWord"><span class="koboSpan" id="kobo.23.1">Azure Container Apps</span></strong><span class="koboSpan" id="kobo.24.1">, which is a serverless </span><a id="_idIndexMarker729"/><span class="koboSpan" id="kobo.25.1">alternative to Kubernetes. </span><span class="koboSpan" id="kobo.25.2">Being a serverless option, you pay just for what you use and overcome the problem of the initial cluster size threshold. </span><strong class="keyWord"><span class="koboSpan" id="kobo.26.1">Azure Container Apps</span></strong><span class="koboSpan" id="kobo.27.1"> also lowers the learning curve thanks to the following features:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.28.1">While Kubernetes offers all the building blocks for coding both tools and microservices, </span><strong class="keyWord"><span class="koboSpan" id="kobo.29.1">Azure Container Apps</span></strong><span class="koboSpan" id="kobo.30.1"> building blocks are the microservices themselves, so the developer can remain focused on the business logic without spending too much time on technical details. </span><span class="koboSpan" id="kobo.30.2">Tools such as storage solutions, message brokers, and other performance and security tools are taken from the hosting platform—that is, Azure.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.31.1">There are acceptable defaults for everything, so deploying an application may become as simple as deciding on the Docker images to deploy. </span><span class="koboSpan" id="kobo.31.2">Customizations can also be specified at a later time.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.32.1">After a short description of the various tools used to simplify the usage and administration of Kubernetes clusters, this chapter describes </span><strong class="keyWord"><span class="koboSpan" id="kobo.33.1">Azure Container Apps</span></strong><span class="koboSpan" id="kobo.34.1"> in detail and how to use it in practice. </span><span class="koboSpan" id="kobo.34.2">This chapter relies on preexisting knowledge of Kubernetes, so please read it after having studied </span><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.35.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.36.1">, </span><em class="italic"><span class="koboSpan" id="kobo.37.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.38.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.39.1">More specifically, this chapter covers the follow</span><a id="_idTextAnchor263"/><span class="koboSpan" id="kobo.40.1">ing:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.41.1">Tools for simplifying Kubernetes cluster usage and administration</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.42.1">Azure Container Apps</span></strong><span class="koboSpan" id="kobo.43.1"> basics and p</span><a id="_idTextAnchor264"/><span class="koboSpan" id="kobo.44.1">lans</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.45.1">Deploying your microservice application with </span><strong class="keyWord"><span class="koboSpan" id="kobo.46.1">Azure Container Apps</span></strong></li>
</ul>
<h1 class="heading-1" id="_idParaDest-181"><a id="_idTextAnchor265"/><span class="koboSpan" id="kobo.47.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.48.1">This chapter requires the following:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.49.1">Visual Studio 2022 free </span><em class="italic"><span class="koboSpan" id="kobo.50.1">Community Edition</span></em><span class="koboSpan" id="kobo.51.1">, at least.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.52.1">Azure CLI. </span><span class="koboSpan" id="kobo.52.2">Links for both the 32-bit and 64-bit Windows installers can be found at</span><strong class="keyWord"> </strong><a href="https://learn.microsoft.com/bs-latn-ba/cli/azure/install-azure-cli-windows?tabs=azure-cli"><span class="url"><span class="koboSpan" id="kobo.53.1">https://learn.microsoft.com/bs-latn-ba/cli/azure/install-azure-cli-windows?tabs=azure-cli</span></span></a><strong class="keyWord"><span class="koboSpan" id="kobo.54.1">.</span></strong></li>
<li class="numberedList"><span class="koboSpan" id="kobo.55.1">An Azure subscription.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.56.1">minikube and kubectl. </span><span class="koboSpan" id="kobo.56.2">Please refer to the </span><em class="italic"><span class="koboSpan" id="kobo.57.1">Technical requirements</span></em><span class="koboSpan" id="kobo.58.1"> section of </span><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.59.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.60.1">, </span><em class="italic"><span class="koboSpan" id="kobo.61.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.62.1">.</span></li>
</ol>
<h1 class="heading-1" id="_idParaDest-182"><a id="_idTextAnchor266"/><span class="koboSpan" id="kobo.63.1">Tools for simplifying Kubernetes clusters usage and administration</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.64.1">After </span><a id="_idIndexMarker730"/><span class="koboSpan" id="kobo.65.1">the success of Kubernetes, a lot of products, services and open sources connected with it appeared. </span><span class="koboSpan" id="kobo.65.2">In this section, we classify them and provide some relevant examples. </span><span class="koboSpan" id="kobo.65.3">The whole offering related to Kubernetes can be classified as follows:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.66.1">Tools for packaging libraries and applications.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.67.1">Kubernetes graphic UIs.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.68.1">Administrative tools for taking and presenting various cluster metrics, handling alarms, and performing administrative actions.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.69.1">Tools for handling the whole development and deployment of microservices-based applications that include Kubernetes as their target deployment platform.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.70.1">Programming environments built on top of Kubernetes. </span><span class="koboSpan" id="kobo.70.2">These include both vertical applications, such as machine learning and big data tools, and general-purpose programming environments, such as Azure Container Apps.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.71.1">When it comes to packaging tools, the most relevant is </span><strong class="keyWord"><span class="koboSpan" id="kobo.72.1">Helm</span></strong><span class="koboSpan" id="kobo.73.1">, which became a de facto standard for packaging Kubernetes applications and libraries. </span><span class="koboSpan" id="kobo.73.2">We will analyze it in a dedicated subsection next.</span></p>
<h2 class="heading-2" id="_idParaDest-183"><a id="_idTextAnchor267"/><span class="koboSpan" id="kobo.74.1">Helm and Helm charts</span></h2>
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.75.1">Helm</span></strong><span class="koboSpan" id="kobo.76.1"> is a package </span><a id="_idIndexMarker731"/><span class="koboSpan" id="kobo.77.1">manager, and the packages </span><a id="_idIndexMarker732"/><span class="koboSpan" id="kobo.78.1">it manages are called </span><strong class="keyWord"><span class="koboSpan" id="kobo.79.1">Helm charts</span></strong><span class="koboSpan" id="kobo.80.1">. </span><span class="koboSpan" id="kobo.80.2">Helm charts are a way to organize the installation of complex Kubernetes applications </span><a id="_idIndexMarker733"/><span class="koboSpan" id="kobo.81.1">that contain several </span><code class="inlineCode"><span class="koboSpan" id="kobo.82.1">.yaml</span></code><span class="koboSpan" id="kobo.83.1"> files. </span><span class="koboSpan" id="kobo.83.2">A </span><a id="_idIndexMarker734"/><span class="koboSpan" id="kobo.84.1">Helm chart is a set of </span><code class="inlineCode"><span class="koboSpan" id="kobo.85.1">.yaml</span></code><span class="koboSpan" id="kobo.86.1"> files organized into folders and subfolders. </span><span class="koboSpan" id="kobo.86.2">Here is a typical folder structure of a Helm chart taken from the official documentation:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.87.1"><img alt="Figure 9.1: Folder structure of a Helm chart" src="../Images/B31916_09_1.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.88.1">Figure 9.1: Folder structure of a Helm chart</span></p>
<p class="normal"><span class="koboSpan" id="kobo.89.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.90.1">.yaml</span></code><span class="koboSpan" id="kobo.91.1"> files </span><a id="_idIndexMarker735"/><span class="koboSpan" id="kobo.92.1">specific to the application are placed in the top </span><code class="inlineCode"><span class="koboSpan" id="kobo.93.1">templates</span></code><span class="koboSpan" id="kobo.94.1"> directory, while the </span><code class="inlineCode"><span class="koboSpan" id="kobo.95.1">charts</span></code><span class="koboSpan" id="kobo.96.1"> directory </span><a id="_idIndexMarker736"/><span class="koboSpan" id="kobo.97.1">may contain other Helm charts used as helper libraries. </span><span class="koboSpan" id="kobo.97.2">The top-level </span><code class="inlineCode"><span class="koboSpan" id="kobo.98.1">Chart.yaml</span></code><span class="koboSpan" id="kobo.99.1"> file contains general information about the package (name and description), together with both the application version and the Helm chart version. </span><span class="koboSpan" id="kobo.99.2">The following is a typical example:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.100.1">apiVersion:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.101.1">v2</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.102.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.103.1">myhelmdemo</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.104.1">description:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.105.1">My</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.106.1">Helm</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.107.1">chart</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.108.1">type:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.109.1">application</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.110.1">version:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.111.1">1.3.0</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.112.1">appVersion:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.113.1">1.2.0</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.114.1">Here, </span><code class="inlineCode"><span class="koboSpan" id="kobo.115.1">type</span></code><span class="koboSpan" id="kobo.116.1"> can be either </span><code class="inlineCode"><span class="koboSpan" id="kobo.117.1">application</span></code><span class="koboSpan" id="kobo.118.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.119.1">library</span></code><span class="koboSpan" id="kobo.120.1">. </span><span class="koboSpan" id="kobo.120.2">Only </span><code class="inlineCode"><span class="koboSpan" id="kobo.121.1">application</span></code><span class="koboSpan" id="kobo.122.1"> charts can be deployed, while </span><code class="inlineCode"><span class="koboSpan" id="kobo.123.1">library</span></code><span class="koboSpan" id="kobo.124.1"> charts are utilities for developing other charts. </span><code class="inlineCode"><span class="koboSpan" id="kobo.125.1">library</span></code><span class="koboSpan" id="kobo.126.1"> charts are placed in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.127.1">charts</span></code><span class="koboSpan" id="kobo.128.1"> folder of other Helm charts.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.129.1">In order to configure each specific application installation, Helm chart </span><code class="inlineCode"><span class="koboSpan" id="kobo.130.1">.yaml</span></code><span class="koboSpan" id="kobo.131.1"> files contain variables that are specified when Helm charts are installed. </span><span class="koboSpan" id="kobo.131.2">Moreover, Helm charts also provide a simple templating language that allows some declarations to be included only if some conditions depending on the input variables are satisfied. </span><span class="koboSpan" id="kobo.131.3">The top-level </span><code class="inlineCode"><span class="koboSpan" id="kobo.132.1">values.yaml</span></code><span class="koboSpan" id="kobo.133.1"> file declares default values for the input variables, meaning that the developer needs to specify just a few variables for which they require different values from the defaults. </span><span class="koboSpan" id="kobo.133.2">We will not describe the Helm chart templates language because it would be too extensive, but you can find it in the official Helm documentation referred</span><a id="_idTextAnchor268"/><span class="koboSpan" id="kobo.134.1"> to in the </span><em class="italic"><span class="koboSpan" id="kobo.135.1">Further reading</span></em><span class="koboSpan" id="kobo.136.1"> section.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.137.1">Helm charts are usually organized in public or private repositories in a way that is similar to Docker images. </span><span class="koboSpan" id="kobo.137.2">There is a Helm client, which you can use to download packages from a remote repository and install charts in Kubernetes clusters. </span><span class="koboSpan" id="kobo.137.3">The Helm client can be installed on any machine with a kubectl installation through the Chocolatey package manager, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.138.1">choco install kubernetes-helm
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.139.1">In turn, you may find the Chocolatey installation procedure in the </span><em class="italic"><span class="koboSpan" id="kobo.140.1">Technical requirements</span></em><span class="koboSpan" id="kobo.141.1"> section of</span><em class="italic"> </em><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.142.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.143.1">, </span><em class="italic"><span class="koboSpan" id="kobo.144.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.145.1">. </span><span class="koboSpan" id="kobo.145.2">Helm operates with the </span><a id="_idIndexMarker737"/><span class="koboSpan" id="kobo.146.1">current kubectl Kubernetes cluster and user.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.147.1">A remote </span><a id="_idIndexMarker738"/><span class="koboSpan" id="kobo.148.1">repository must be added before using its packages, as shown in the following example:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.149.1">helm repo add &lt;my-repo-local-name&gt; https://mycharts.helm.sh/stable
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.150.1">The previous </span><a id="_idIndexMarker739"/><span class="koboSpan" id="kobo.151.1">command makes the package information of a remote repository </span><a id="_idIndexMarker740"/><span class="koboSpan" id="kobo.152.1">available locally and gives a local name to that remote repository. </span><span class="koboSpan" id="kobo.152.2">The information about all charts available in one or more repositories can be refreshed with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.153.1">helm repo update &lt;my-repo-local-name 1&gt; &lt;my-repo-local-name 2&gt;…
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.154.1">If no repository name is specified, all local repositories are updated.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.155.1">After that, any package from the remote repository can be installed with a command such as the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.156.1">helm install &lt;instance name&gt; &lt;my-repo-local-name&gt;/&lt;package name&gt; -n &lt;namespace&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.157.1">Here, </span><code class="inlineCode"><span class="koboSpan" id="kobo.158.1">&lt;namespace&gt;</span></code><span class="koboSpan" id="kobo.159.1"> is the Kubernetes namespace where to install the application. </span><span class="koboSpan" id="kobo.159.2">As usual, if it’s not provided, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.160.1">default</span></code><span class="koboSpan" id="kobo.161.1"> namespace is assumed. </span><code class="inlineCode"><span class="koboSpan" id="kobo.162.1">&lt;package name&gt;</span></code><span class="koboSpan" id="kobo.163.1"> is the name of the package you would like to install, and finally, </span><code class="inlineCode"><span class="koboSpan" id="kobo.164.1">&lt;instance name&gt;</span></code><span class="koboSpan" id="kobo.165.1"> is the name that you give to the installed application. </span><span class="koboSpan" id="kobo.165.2">You need this name to get information about the installed application with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.166.1">helm status &lt;instance name&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.167.1">You can get also information about all applications installed with Helm with the help of the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.168.1">helm ls
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.169.1">The application name is also needed to delete the application from the cluster using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.170.1">helm delete &lt;instance name&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.171.1">When we install an application, we may also provide a </span><code class="inlineCode"><span class="koboSpan" id="kobo.172.1">.yaml</span></code><span class="koboSpan" id="kobo.173.1"> file with all the default variable values we </span><a id="_idIndexMarker741"/><span class="koboSpan" id="kobo.174.1">want to override. </span><span class="koboSpan" id="kobo.174.2">We can also specify a specific version of the Helm chart; otherwise, the most </span><a id="_idIndexMarker742"/><span class="koboSpan" id="kobo.175.1">recent version is used. </span><span class="koboSpan" id="kobo.175.2">Here is an example with both the version and values overridden:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.176.1">helm install &lt;instance name&gt; &lt;my-repo-local-name&gt;/&lt;package name&gt; -f values.yaml --version &lt;version&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.177.1">Finally, default </span><a id="_idIndexMarker743"/><span class="koboSpan" id="kobo.178.1">value overrides </span><a id="_idIndexMarker744"/><span class="koboSpan" id="kobo.179.1">can also be provided in line with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.180.1">--set</span></code><span class="koboSpan" id="kobo.181.1"> option, as shown here:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.182.1">...--set &lt;variable1&gt;=&lt;value1&gt;,&lt;variable2&gt;=&lt;value2&gt;...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.183.1">We can also upgrade an existing installation with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.184.1">upgrade</span></code><span class="koboSpan" id="kobo.185.1"> command, as shown here:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.186.1">helm upgrade &lt;instance name&gt; &lt;my-repo-local-name&gt;/&lt;package name&gt;...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.187.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.188.1">upgrade</span></code><span class="koboSpan" id="kobo.189.1"> command may specify new value overrides with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.190.1">–f</span></code><span class="koboSpan" id="kobo.191.1"> option or with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.192.1">--set</span></code><span class="koboSpan" id="kobo.193.1"> option, and it can also specify the new version to install with </span><code class="inlineCode"><span class="koboSpan" id="kobo.194.1">--version</span></code><span class="koboSpan" id="kobo.195.1">. </span><span class="koboSpan" id="kobo.195.2">If no version is specified, the more recent version is installed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.196.1">More details on Helm can be found in the official documentation at </span><a href="https://helm.sh/"><span class="url"><span class="koboSpan" id="kobo.197.1">https://helm.sh/</span></span></a><span class="koboSpan" id="kobo.198.1">. </span><span class="koboSpan" id="kobo.198.2">We will show how to use Helm in practice in the later subsection about Kubernetes administrative tools.</span></p>
<h2 class="heading-2" id="_idParaDest-184"><a id="_idTextAnchor269"/><span class="koboSpan" id="kobo.199.1">Kubernetes graphic UIs</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.200.1">There are also tools that help the definition and deployment of Kubernetes resources through user-friendly </span><a id="_idIndexMarker745"/><span class="koboSpan" id="kobo.201.1">graphic interfaces. </span><span class="koboSpan" id="kobo.201.2">Among </span><a id="_idIndexMarker746"/><span class="koboSpan" id="kobo.202.1">them, it is worth mentioning ArgoCD and Rancher UI.</span></p>
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.203.1">ArgoCD</span></strong><span class="koboSpan" id="kobo.204.1"> handles a </span><a id="_idIndexMarker747"/><span class="koboSpan" id="kobo.205.1">database of Kubernetes resources and automatically updates a Kubernetes cluster whenever the code that defines a resource changes. </span><span class="koboSpan" id="kobo.205.2">ArgoCD simplifies a lot of Kubernetes cluster handling but automatic re-deployment of resources may cause issues in production environments that require zero downtime. </span><span class="koboSpan" id="kobo.205.3">We will not describe ArgoCD here, but interested readers can find more details in the </span><em class="italic"><span class="koboSpan" id="kobo.206.1">Further reading</span></em><span class="koboSpan" id="kobo.207.1"> section.</span></p>
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.208.1">Rancher UI</span></strong><span class="koboSpan" id="kobo.209.1"> enables users </span><a id="_idIndexMarker748"/><span class="koboSpan" id="kobo.210.1">to interact with several Kubernetes clusters through a web-based UI. </span><span class="koboSpan" id="kobo.210.2">It has also tools for handling the whole development process, such as the definition of projects.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.211.1">The </span><a id="_idIndexMarker749"/><span class="koboSpan" id="kobo.212.1">Rancher UI web application must be accessible from within each Kubernetes cluster it must handle, and </span><a id="_idIndexMarker750"/><span class="koboSpan" id="kobo.213.1">requires the installation software inside each of the Kubernetes clusters that it must handle.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.214.1">Rancher UI can also be installed on a developer’s local machine, where it can be used to interact with minikube. </span><span class="koboSpan" id="kobo.214.2">The simplest way to perform a local installation is through Docker. </span><span class="koboSpan" id="kobo.214.3">Open a Linux shell and enter the following code:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.215.1">docker run -d \
  --restart unless-stopped \
  -p 80:80 \
  -p 443:443 \
  --privileged \
  --name rancher \
  rancher/rancher:stable
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.216.1">A few minutes after the installation is completed, Rancher UI is available at </span><code class="inlineCode"><span class="koboSpan" id="kobo.217.1">https://localhost</span></code><span class="koboSpan" id="kobo.218.1">. </span><span class="koboSpan" id="kobo.218.2">If you can’t access it, wait a minute and retry.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.219.1">Once the web interface appears for the first time, you need a temporary password. </span><span class="koboSpan" id="kobo.219.2">You can get this password with the following Linux command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.220.1">docker logs rancher 2&gt;&amp;1 | grep "Bootstrap Password:"
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.221.1">Copy the temporary password in the Rancher UI initial page, and press </span><strong class="keyWord"><span class="koboSpan" id="kobo.222.1">Continue</span></strong><span class="koboSpan" id="kobo.223.1">. </span><span class="koboSpan" id="kobo.223.2">The new page that appears should propose a new definitive password for the admin user, and the URL to be used by minikube to access Rancher UI. </span><span class="koboSpan" id="kobo.223.3">Fill this page as shown here:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.224.1"><img alt="Figure 9.2: Rancher initial settings" src="../Images/B31916_09_2.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.225.1">Figure 9.2: Rancher initial settings</span></p>
<p class="normal"><span class="koboSpan" id="kobo.226.1">Accept </span><a id="_idIndexMarker751"/><span class="koboSpan" id="kobo.227.1">the proposed </span><a id="_idIndexMarker752"/><span class="koboSpan" id="kobo.228.1">password, copy it, and store it in a safe place. </span><span class="koboSpan" id="kobo.228.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.229.1">host.docker.internal</span></code><span class="koboSpan" id="kobo.230.1"> hostname enables minikube to connect with our machine localhost.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.231.1">On the dashboard, click the </span><strong class="screenText"><span class="koboSpan" id="kobo.232.1">Import Existing</span></strong><span class="koboSpan" id="kobo.233.1"> button to start the process of connecting an existing cluster with Rancher UI:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.234.1"><img alt="Figure 9.3: Importing an existing cluster" src="../Images/B31916_09_3.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.235.1">Figure 9.3: Importing an existing cluster</span></p>
<p class="normal"><span class="koboSpan" id="kobo.236.1">On the new page that appears, select the </span><a href="https://www.Generic.com"><span class="url"><span class="koboSpan" id="kobo.237.1">Generic</span></span></a><span class="koboSpan" id="kobo.238.1"> cluster option:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.239.1"><img alt="Figure 9.4: Generic cluster option" src="../Images/B31916_09_4.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.240.1">Figure 9.4: Generic cluster option</span></p>
<p class="normal"><span class="koboSpan" id="kobo.241.1">Fill in </span><a id="_idIndexMarker753"/><span class="koboSpan" id="kobo.242.1">just the </span><a id="_idIndexMarker754"/><span class="koboSpan" id="kobo.243.1">cluster name and description on the page that a</span><a id="_idTextAnchor270"/><span class="koboSpan" id="kobo.244.1">ppears, as shown here:</span></p>
<p class="normal"><span class="koboSpan" id="kobo.245.1"><img alt="" role="presentation" src="../Images/B31916_09_5.png"/></span></p>
<p class="packt_figref"><span class="koboSpan" id="kobo.246.1">Figure 9.5: Filling in the cluster information</span></p>
<p class="normal"><span class="koboSpan" id="kobo.247.1">Then, click the </span><strong class="screenText"><span class="koboSpan" id="kobo.248.1">Create</span></strong><span class="koboSpan" id="kobo.249.1"> button. </span><span class="koboSpan" id="kobo.249.2">A page with the code to run in your cluster should appear. </span><span class="koboSpan" id="kobo.249.3">You should select the second code option since the local Rancher installation uses a self-signed certificate, which should be something like this:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.250.1">curl --insecure -sfL https://host.docker.internal/v3/import/6rd2jg4nntmkkw9z9mjhttrjfjj64cz9vl8zr6pr6tskbt6cc98zfz_c-2p47w.yaml | kubectl apply -f -
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.251.1">However, this code must be executed in a Linux shell, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.252.1">kubectl</span></code><span class="koboSpan" id="kobo.253.1"> is installed only on Windows. </span><span class="koboSpan" id="kobo.253.2">Therefore, replace the preceding instruction with the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.254.1">curl --insecure -sfL https://host.docker.internal/v3/import/6rd2jg4nntmkkw9z9mjhttrjfjj64cz9vl8zr6pr6tskbt6cc98zfz_c-2p47w.yaml &gt; install.yaml
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.255.1">Then, execute it in a Linux shell. </span><span class="koboSpan" id="kobo.255.2">It will create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.256.1">install.yaml</span></code><span class="koboSpan" id="kobo.257.1"> file that contains our Kubernetes code.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.258.1">Now, we </span><a id="_idIndexMarker755"/><span class="koboSpan" id="kobo.259.1">can install </span><a id="_idIndexMarker756"/><span class="koboSpan" id="kobo.260.1">Rancher on minikube. </span><span class="koboSpan" id="kobo.260.2">Ensure that minikube is running, open a Windows console, and execute the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.261.1">kubectl apply -f install.yaml
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.262.1">When the installation is complete, return to the dashboard; you should see the newly imported minikube cluster:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.263.1"><img alt="Figure 9.6: Minikube cluster connected" src="../Images/B31916_09_6.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.264.1">Figure 9.6: Minikube cluster connected</span></p>
<p class="normal"><span class="koboSpan" id="kobo.265.1">Click on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.266.1">minikube</span></code><span class="koboSpan" id="kobo.267.1"> link and enjoy the power of interacting with Minikube through a graphic UI! </span><span class="koboSpan" id="kobo.267.2">Here, you can see nodes, Pods, namespaces, and all types of Kubernetes resources, and can also define new resources.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.268.1">When you have finished experimenting, stop minikube and the Rancher container in the Docker UI. </span><span class="koboSpan" id="kobo.268.2">If you don’t need to interact with minikube through Rancher anymore, just execute the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.269.1">kubectl delete -f install.yaml
</span></code></pre>
<h2 class="heading-2" id="_idParaDest-185"><a id="_idTextAnchor271"/><span class="koboSpan" id="kobo.270.1">Kubernetes administrative tools</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.271.1">Each cloud provider offers administrative UIs together with the Kubernetes offering. </span><span class="koboSpan" id="kobo.271.2">These UIs include </span><a id="_idIndexMarker757"/><span class="koboSpan" id="kobo.272.1">the possibility to perform actions on the cluster, such as inspecting Kubernetes resources, collecting various metrics, and both querying </span><a id="_idIndexMarker758"/><span class="koboSpan" id="kobo.273.1">and plotting these metrics. </span><span class="koboSpan" id="kobo.273.2">We will analyze the administrative tools offered by Azure in more detail in </span><a href="Chapter_10.xhtml#_idTextAnchor297"><em class="italic"><span class="koboSpan" id="kobo.274.1">Chapter 10</span></em></a><span class="koboSpan" id="kobo.275.1">, </span><em class="italic"><span class="koboSpan" id="kobo.276.1">Security and Observability for Serverless and Microservices Applications</span></em><span class="koboSpan" id="kobo.277.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.278.1">However, there are also several tools offered by third parties and also several open source projects. </span><span class="koboSpan" id="kobo.278.2">Among the </span><a id="_idIndexMarker759"/><span class="koboSpan" id="kobo.279.1">open source projects, it is worth mentioning the metrics collector called </span><strong class="keyWord"><span class="koboSpan" id="kobo.280.1">Prometheus</span></strong><span class="koboSpan" id="kobo.281.1">, and the UI-based </span><a id="_idIndexMarker760"/><span class="koboSpan" id="kobo.282.1">administrative console called </span><strong class="keyWord"><span class="koboSpan" id="kobo.283.1">Grafana</span></strong><span class="koboSpan" id="kobo.284.1">. </span><span class="koboSpan" id="kobo.284.2">Usually, they are installed together and Prometheus works as a metrics source for Grafana. </span><span class="koboSpan" id="kobo.284.3">They can be installed on any Kubernetes cluster, including minikube.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.285.1">A detailed description of these tools is beyond the purpose of the book, but since they are very common and are also a prerequisite for other tools, we will describe how to install them.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.286.1">If you would like to test these tools on minikube, you need a configuration with more memory, and some other custom settings, so the the best option is to define a new profile while starting minikube with the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.287.1">minikube start --memory=6g --extra-config=kubelet.authentication-token-webhook=true --extra-config=kubelet.authorization-mode=Webhook --extra-config=scheduler.bind-address=0.0.0.0 --extra-config=controller-manager.bind-address=0.0.0.0 -p &lt;your profile name&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.288.1">Here, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.289.1">--extra-config</span></code><span class="koboSpan" id="kobo.290.1"> option allows the configuration of various Kubernetes installation options. </span><span class="koboSpan" id="kobo.290.2">If you don’t use minikube, you must be sure that the Kubernetes cluster is configured with the options passed with </span><code class="inlineCode"><span class="koboSpan" id="kobo.291.1">--extra-config</span></code><span class="koboSpan" id="kobo.292.1"> in the preceding instruction. </span><span class="koboSpan" id="kobo.292.2">These settings enable Webhooks on the controller manager that Prometheus uses to collect its metrics and change the IP addresses exposed by both the controller and scheduler on the master nodes to enforce compatibility with Prometheus.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.293.1">Once all these settings are fixed, we can install both Prometheus and Grafana with Helm:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.294.1">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
helm install prometheus prometheus-community/prometheus --namespace monitoring --create-namespace
helm install grafana grafana/grafana --namespace monitoring
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.295.1">The first two instructions add the repositories containing Prometheus and Grafana, respectively, and the third instruction updates all repository local directories. </span><span class="koboSpan" id="kobo.295.2">The third instruction installs Prometheus in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.296.1">monitoring</span></code><span class="koboSpan" id="kobo.297.1"> namespace, after having created this namespace, and finally, the last instruction installs Grafana in the same namespace.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.298.1">After the installation, we can inspect the </span><code class="inlineCode"><span class="koboSpan" id="kobo.299.1">monitoring</span></code><span class="koboSpan" id="kobo.300.1"> namespace to verify that all resources are ready:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.301.1">kubectl get all -n monitoring
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.302.1">Finally, both the </span><a id="_idIndexMarker761"/><span class="koboSpan" id="kobo.303.1">Prometheus and Grafana UIs can be accessed by port-forwarding adequate </span><a id="_idIndexMarker762"/><span class="koboSpan" id="kobo.304.1">services. </span><span class="koboSpan" id="kobo.304.2">Remember to use a different console window for each port-forward service, since the console freezes while port-forwarding:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.305.1">kubectl --namespace monitoring port-forward service/prometheus-server 9090:80
kubectl --namespace monitoring port-forward service/grafana 3000:80
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.306.1">After that, Prometheus will be available at </span><a href="http://localhost:9090"><span class="url"><span class="koboSpan" id="kobo.307.1">http://localhost:9090</span></span></a><span class="koboSpan" id="kobo.308.1"> and Grafana at </span><span class="url"><span class="koboSpan" id="kobo.309.1">http://localhost:3000</span></span><span class="koboSpan" id="kobo.310.1">. </span><span class="koboSpan" id="kobo.310.2">While Prometheus doesn’t require a login, the default user for Grafana is </span><code class="inlineCode"><span class="koboSpan" id="kobo.311.1">admin</span></code><span class="koboSpan" id="kobo.312.1"> and the password must be extracted from a Kubernetes secret, as shown here:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.313.1">kubectl get secret --namespace monitoring grafana -o jsonpath="{.data.admin-password}"
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.314.1">Copy the string returned by the preceding command; we need to Base64-decode it to get the actual password. </span><span class="koboSpan" id="kobo.314.2">As usual, Base64-decoding can be performed by opening a Linux console and using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.315.1">base64 </span></code><span class="koboSpan" id="kobo.316.1">command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.317.1">echo -n &lt;string to decode&gt; | base64 -d
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.318.1">Once logged in to Grafana, we must declare Prometheus as its metrics data source. </span><span class="koboSpan" id="kobo.318.2">In the Grafana left menu, go to </span><strong class="screenText"><span class="koboSpan" id="kobo.319.1">Connections -&gt; Data sources</span></strong><span class="koboSpan" id="kobo.320.1">, and then select </span><strong class="screenText"><span class="koboSpan" id="kobo.321.1">Add new data source</span></strong><span class="koboSpan" id="kobo.322.1">. </span><span class="koboSpan" id="kobo.322.2">In the page that appears, select </span><strong class="keyWord"><span class="koboSpan" id="kobo.323.1">Prometheus</span></strong><span class="koboSpan" id="kobo.324.1">, as shown in the following figure:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.325.1"><img alt="Figure 9.7: Selecting Prometheus as the data source" src="../Images/B31916_09_7.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.326.1">Figure 9.7: Selecting Prometheus as the data source</span></p>
<p class="normal"><span class="koboSpan" id="kobo.327.1">We need </span><a id="_idIndexMarker763"/><span class="koboSpan" id="kobo.328.1">to configure Prometheus as the default data source </span><a id="_idIndexMarker764"/><span class="koboSpan" id="kobo.329.1">and set the URL at which to retrieve all metrics to </span><a href="http://prometheus-server:80"><span class="url"><span class="koboSpan" id="kobo.330.1">http://prometheus-server:80</span></span></a><span class="koboSpan" id="kobo.331.1">, which corresponds to the address and port of the same Prometheus service we have port-forwarded, as shown here:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.332.1"><img alt="Figure 9.8: Prometheus settings" src="../Images/B31916_09_8.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.333.1">Figure 9.8: Prometheus settings</span></p>
<p class="normal"><span class="koboSpan" id="kobo.334.1">You can </span><a id="_idIndexMarker765"/><span class="koboSpan" id="kobo.335.1">keep all the other default settings; just click the </span><strong class="screenText"><span class="koboSpan" id="kobo.336.1">Save and test</span></strong><span class="koboSpan" id="kobo.337.1"> button. </span><span class="koboSpan" id="kobo.337.2">After </span><a id="_idIndexMarker766"/><span class="koboSpan" id="kobo.338.1">that, click the </span><strong class="screenText"><span class="koboSpan" id="kobo.339.1">Dashboards</span></strong><span class="koboSpan" id="kobo.340.1"> tab and import all proposed dashboards.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.341.1">Then, go to </span><strong class="screenText"><span class="koboSpan" id="kobo.342.1">Dashboards</span></strong><span class="koboSpan" id="kobo.343.1"> in the Grafana left menu and inspect all the imported dashboards by clicking their links:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.344.1"><img alt="Figure 9.9: Available dashboards" src="../Images/B31916_09_9.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.345.1">Figure 9.9: Available dashboards</span></p>
<p class="normal"><span class="koboSpan" id="kobo.346.1">If you </span><a id="_idIndexMarker767"/><span class="koboSpan" id="kobo.347.1">click </span><strong class="screenText"><span class="koboSpan" id="kobo.348.1">new</span></strong><span class="koboSpan" id="kobo.349.1"> and then </span><strong class="screenText"><span class="koboSpan" id="kobo.350.1">import</span></strong><span class="koboSpan" id="kobo.351.1">, you can import a dashboard from grafana.com. </span><span class="koboSpan" id="kobo.351.2">Just follow the </span><code class="inlineCode"><span class="koboSpan" id="kobo.352.1">grafana.com/dashboards</span></code><span class="koboSpan" id="kobo.353.1"> link, select a dashboard, take its ID, and copy it, as shown here:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.354.1"><img alt="Figure 9.10: Importing a dashboard from grafana.com" src="../Images/B31916_09_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.355.1">Figure 9.10: Importing a dashboard from grafana.com</span></p>
<p class="normal"><span class="koboSpan" id="kobo.356.1">You </span><a id="_idIndexMarker768"/><span class="koboSpan" id="kobo.357.1">might be required to subscribe to get a dashboard ID. </span><span class="koboSpan" id="kobo.357.2">Subscription is free. </span><span class="koboSpan" id="kobo.357.3">The dashboard selection pages contain links to the documentation you might be interested in exploring.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.358.1">If you stop minikube with </span><code class="inlineCode"><span class="koboSpan" id="kobo.359.1">minikube stop -p &lt;profle name&gt;</span></code><span class="koboSpan" id="kobo.360.1">, minikube will be stopped but all your data will be saved, so you can continue experimenting with Grafana. </span><span class="koboSpan" id="kobo.360.2">If you want to uninstall Grafana and Prometheus, you can do it with Helm, as shown here:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.361.1">helm delete grafana
helm delete prometheus
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.362.1">Let’s close this section with the remaining tools.</span></p>
<h2 class="heading-2" id="_idParaDest-186"><a id="_idTextAnchor272"/><span class="koboSpan" id="kobo.363.1">Development environments based on Kubernetes</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.364.1">Among the complete development platforms based on Kubernetes, it is worth mentioning </span><strong class="keyWord"><span class="koboSpan" id="kobo.365.1">OpenShift</span></strong><span class="koboSpan" id="kobo.366.1"> (</span><a href="https://www.redhat.com/en/technologies/cloud-computing/openshift"><span class="url"><span class="koboSpan" id="kobo.367.1">https://www.redhat.com/en/technologies/cloud-computing/openshift</span></span></a><span class="koboSpan" id="kobo.368.1">), which includes </span><a id="_idIndexMarker769"/><span class="koboSpan" id="kobo.369.1">tools for the whole development process, including </span><a id="_idIndexMarker770"/><span class="koboSpan" id="kobo.370.1">DevOps automation and cloud services.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.371.1">OpenShift can be installed on-premises or it can be used as a PaaS service available in the main cloud services, Azure included (</span><a href="https://azure.microsoft.com/it-it/products/openshift"><span class="url"><span class="koboSpan" id="kobo.372.1">https://azure.microsoft.com/it-it/products/openshift</span></span></a><span class="koboSpan" id="kobo.373.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.374.1">Big data and </span><a id="_idIndexMarker771"/><span class="koboSpan" id="kobo.375.1">machine learning frameworks use Kubernetes, but we will not discuss them since they are completely beyond the purpose of this book.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.376.1">It is also worth mentioning simple code generators offered by some start-ups that create Kubernetes applications by combining containers with the help of graphic interfaces. </span><span class="koboSpan" id="kobo.376.2">Needless to say, similar tools are just aimed at creating low-cost applications. </span><span class="koboSpan" id="kobo.376.3">We will not describe them because the focus of the book is enterprise high-quality applications and, at the moment, there is neither an emerging general pattern nor an emerging specific framework.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.377.1">Instead, when it comes to higher-level abstraction alternatives to Kubernetes that are built on top of Kubernetes, at the time this book was written, the most relevant option is </span><strong class="keyWord"><span class="koboSpan" id="kobo.378.1">Azure Container Apps,</span></strong><span class="koboSpan" id="kobo.379.1"> which will be described in the remainder of the chapter.</span></p>
<h1 class="heading-1" id="_idParaDest-187"><a id="_idTextAnchor273"/><span class="koboSpan" id="kobo.380.1">Azure Container Apps basics and plans</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.381.1">Azure Container </span><a id="_idIndexMarker772"/><span class="koboSpan" id="kobo.382.1">Apps is available as a serverless offering with </span><strong class="keyWord"><span class="koboSpan" id="kobo.383.1">consumption</span></strong><span class="koboSpan" id="kobo.384.1"> plans but has also </span><strong class="keyWord"><span class="koboSpan" id="kobo.385.1">dedicated</span></strong><span class="koboSpan" id="kobo.386.1"> plans based on the horizontal scaling of virtual machines, called </span><strong class="keyWord"><span class="koboSpan" id="kobo.387.1">workload profiles</span></strong><span class="koboSpan" id="kobo.388.1">. </span><span class="koboSpan" id="kobo.388.2">Some </span><a id="_idIndexMarker773"/><span class="koboSpan" id="kobo.389.1">advanced features are available only with </span><strong class="keyWord"><span class="koboSpan" id="kobo.390.1">workload profiles</span></strong><span class="koboSpan" id="kobo.391.1">. </span><span class="koboSpan" id="kobo.391.2">We will talk more about plans later on in this section.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.392.1">While Kubernetes offers several kinds of independent building blocks, Azure Container Apps is based on just two kinds of building blocks: </span><strong class="keyWord"><span class="koboSpan" id="kobo.393.1">applications/jobs</span></strong><span class="koboSpan" id="kobo.394.1"> and </span><strong class="keyWord"><span class="koboSpan" id="kobo.395.1">environments</span></strong><span class="koboSpan" id="kobo.396.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.397.1">Applications map one-to-one with microservices, while jobs are useful for long-running tasks and will not be discussed in this chapter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.398.1">Applications automatically handle replicas—that is, each application may have several identical replicas exactly like a Kubernetes Deployment. </span><span class="koboSpan" id="kobo.398.2">Applications support the same configuration options as Kubernetes Deployments, as follows:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.399.1">Environment variables</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.400.1">Volume mounts</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.401.1">Health probes</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.402.1">CPU and memory resources configuration</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.403.1">Automatic log collection</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.404.1">They also support communication configuration, secrets, and automatic scaling, but they are not defined as </span><a id="_idIndexMarker774"/><span class="koboSpan" id="kobo.405.1">separate objects as in Kubernetes but inside the application configuration itself. </span><span class="koboSpan" id="kobo.405.2">Moreover, there is no equivalent of StatefulSets—that is, there is no way to implement sharding algorithms.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.406.1">The rationale behind these choices is that the developer must map each microservice into a single resource instead of several coordinated resources, so they can concentrate mainly on business business logic without being overwhelmed by orchestrator-specific configuration.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.407.1">Coordination tools </span><a id="_idIndexMarker775"/><span class="koboSpan" id="kobo.408.1">such as StatefulSets are simply omitted since they don’t include business logic but are just used for solving coordination and parallel update issues. </span><span class="koboSpan" id="kobo.408.2">In fact, StatefulSets are used mainly to implement tools such as storage engines and message brokers, so the basic idea is that the developer should use resources already available in the cloud instead of implementing customized solutions so they can concentrate all their efforts on the business logic.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.409.1">Other resources, such as permissions, users, and roles, are taken from Azure, too. </span><span class="koboSpan" id="kobo.409.2">This way, your microservice application is smoothly integrated into the hosting cloud instead of being a self-contained deployment environment loosely coupled with the hosting cloud, such as Kubernetes.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.410.1">Summing up, we can say that Azure Container Apps simplifies the implementation of a microservice application at the price of decreasing its portability. </span><span class="koboSpan" id="kobo.410.2">Once you implement your application to run in Azure Container Apps and to use Azure cloud resources, the only option to migrate to another cloud is to rewrite the whole orchestrator-related code.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.411.1">Needless to say, if containers are carefully designed, they are not lost in the case of migrations, but the whole logic around them is lost.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.412.1">This is not a big issue if your application is small and consists of a few microservices, but for big applications made of hundreds or thousands of microservices, a migration might imply an unacceptable cost both in terms of time and money.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.413.1">Therefore, Azure Container Apps is a good option for small applications or when you plan to deploy your application on a single cloud (Azure) and when you don’t need too many customizations (custom tools, highly customized tools, complex custom distributed algorithms, and so on). </span><span class="koboSpan" id="kobo.413.2">This makes it a good entry point in the world of distributed computing when you start the conversion of a monolithic application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.414.1">The boundaries of a microservice application are defined by an </span><strong class="keyWord"><span class="koboSpan" id="kobo.415.1">environment</span></strong><span class="koboSpan" id="kobo.416.1">. </span><span class="koboSpan" id="kobo.416.2">Inside each environment, all applications can freely interact, but you can also decide to expose some endpoints to the </span><strong class="keyWord"><span class="koboSpan" id="kobo.417.1">outside world</span></strong><span class="koboSpan" id="kobo.418.1">. </span><span class="koboSpan" id="kobo.418.2">If you use a consumption plan, the outside world is necessarily the internet, but with workload profiles, you can bypass this limitation by associating a subnet of an existing Azure virtual network to your environment. </span><span class="koboSpan" id="kobo.418.3">In fact, in this case, the outside world would be the remainder of the virtual network.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.419.1">There is no equivalent of Kubernetes ingresses for routing communications from a single environment </span><a id="_idIndexMarker776"/><span class="koboSpan" id="kobo.420.1">entry point to all frontend microservices inside the environment, but you can implement a similar functionality by using an application as an API gateway (see the </span><em class="italic"><span class="koboSpan" id="kobo.421.1">Interfacing the external world</span></em><span class="koboSpan" id="kobo.422.1"> subsection of </span><a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic"><span class="koboSpan" id="kobo.423.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.424.1">, </span><em class="italic"><span class="koboSpan" id="kobo.425.1">Demystifying Microservices Applications</span></em><span class="koboSpan" id="kobo.426.1">). </span><span class="koboSpan" id="kobo.426.2">For HTTP and HTTPS termination, you can configure any application for using HTTPS without the burden of creating and handling HTTPS certificates, since Azure will take care of this for you.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.427.1">The following figure illustrates what we said about applications and environments:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.428.1"><img alt="Figure 9.11: Azure Container Apps organization" src="../Images/B31916_09_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.429.1">Figure 9.11: Azure Container Apps organization</span></p>
<p class="normal"><span class="koboSpan" id="kobo.430.1">Take note of the following:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.431.1">Each environment can be defined as either consumption only or a workload profile.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.432.1">Each environment can have profiles added to it. </span><span class="koboSpan" id="kobo.432.2">Consumption-only environments can only have the default consumption profile. </span><span class="koboSpan" id="kobo.432.3">Workload profile environments have the default consumption profile but can also have customizable workload profiles added. </span><span class="koboSpan" id="kobo.432.4">Profiles will be discussed more later on in this section.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.433.1">Each application associated with the environment can specify which of the profiles associated with the environment to run on.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.434.1">Each application is accessible with an </span><code class="inlineCode"><span class="koboSpan" id="kobo.435.1">http://&lt;application name&gt;</span></code><span class="koboSpan" id="kobo.436.1"> URL from inside the environment. </span><span class="koboSpan" id="kobo.436.2">We can also decide that an application is not accessible with a direct link when we use a message broker.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.437.1">Some applications </span><a id="_idIndexMarker777"/><span class="koboSpan" id="kobo.438.1">can be configured for access from outside of the environment, in which case, they receive the </span><code class="inlineCode"><span class="koboSpan" id="kobo.439.1">https://&lt;application name&gt;.&lt;environment name&gt;.&lt;zone&gt;.azurecontainerapps.io</span></code><span class="koboSpan" id="kobo.440.1"> URL. </span><span class="koboSpan" id="kobo.440.2">Here, </span><code class="inlineCode"><span class="koboSpan" id="kobo.441.1">&lt;zone&gt;</span></code><span class="koboSpan" id="kobo.442.1"> is the Azure geographic zone where you defined your environment. </span><em class="italic"><span class="koboSpan" id="kobo.443.1">HTTP traffic must be passed on the usual 80 and 443 ports</span></em><span class="koboSpan" id="kobo.444.1">. </span><span class="koboSpan" id="kobo.444.2">For pure TCP traffic, the developer can specify different ports.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.445.1">Each environment has an associated virtual network. </span><span class="koboSpan" id="kobo.445.2">Only if the environment has a workload profile can you assign it a custom subnet of a virtual network.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.446.1">Environments and applications can access any Azure resources if they are granted the necessary permissions or credentials.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.447.1">The remainder of this section is organized into subsections that describe the following subjects:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.448.1">Consumption-only and</span><a id="_idTextAnchor274"/><span class="koboSpan" id="kobo.449.1"> workload profiles</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.450.1">Application versioning</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.451.1">Interacting with Azure Container Apps</span></li>
</ol>
<h2 class="heading-2" id="_idParaDest-188"><a id="_idTextAnchor275"/><span class="koboSpan" id="kobo.452.1">Consumption-only and workload profiles</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.453.1">Applications </span><a id="_idIndexMarker778"/><span class="koboSpan" id="kobo.454.1">running in a consumption profile are billed as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.455.1">Kcpu*&lt;virtual CPU seconds&gt; + Kmem*&lt;Gigabytes seconds&gt; + Kreq*&lt;requests per seconds&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.456.1">In a few words, the application is billed proportionally to its memory, CPU, and request consumption. </span><span class="koboSpan" id="kobo.456.2">The actual constants for the various countries are available here: </span><a href="https://azure.microsoft.com/en-us/pricing/details/container-apps/. "><span class="url"><span class="koboSpan" id="kobo.457.1">https://azure.microsoft.com/en-us/pricing/details/container-apps/.</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.458.1">With workload profiles, you are billed according to the CPUs and gigabytes of each virtual machine in use and not for the CPU and memory allocated to the applications. </span><span class="koboSpan" id="kobo.458.2">Thus, for instance, notwithstanding you use just 10% of a profile virtual machine, you are billed for the overall virtual machine CPU and memory. </span><span class="koboSpan" id="kobo.458.3">However, for workload profiles, there is no billing quota corresponding to the application requests. </span><span class="koboSpan" id="kobo.458.4">There is also an hourly profile-handling cost to add to the overall cost of each profile. </span><span class="koboSpan" id="kobo.458.5">The actual constants for the various countries are available here: </span><a href="https://azure.microsoft.com/en-us/pricing/details/container-apps/. "><span class="url"><span class="koboSpan" id="kobo.459.1">https://azure.microsoft.com/en-us/pricing/details/container-apps/.</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.460.1">Each profile can be used by several applications, and the number of virtual machines allocated to a profile is computed according to the CPU and memory requested by all applications that run in that profile. </span><span class="koboSpan" id="kobo.460.2">That is, a new virtual machine is allocated whenever the total CPU or memory requested by all applications exceeds the total CPUs and memory of the already allocated machines.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.461.1">Needless to say, one can specify both a maximum number and a minimum number of machines </span><a id="_idIndexMarker779"/><span class="koboSpan" id="kobo.462.1">allocated to each profile. </span><span class="koboSpan" id="kobo.462.2">Since allocating a new virtual machine requires time, it is advised to set the minimum number of instances to at least 1; otherwise, the first requests after a period of inactivity would experience unacceptable response times.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.463.1">The hourly CPU and memory costs of workload profiles are lower than the ones of consumption-only profiles but workload profiles have an hourly management cost. </span><span class="koboSpan" id="kobo.463.2">Workload profiles become convenient when the average workload exceeds 3–4 CPUs with 16 GB of memory. </span><span class="koboSpan" id="kobo.463.3">However, certain features are only available with workload profiles. </span><span class="koboSpan" id="kobo.463.4">For instance, you need a workload profile if you want to customize the virtual network underlying your environment by adding firewalls, or by using a subnet of another virtual network.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.464.1">All available workload profile types are listed on this page: </span><a href="https://learn.microsoft.com/en-us/azure/container-apps/workload-profiles-overview"><span class="url"><span class="koboSpan" id="kobo.465.1">https://learn.microsoft.com/en-us/azure/container-apps/workload-profiles-overview</span></span></a><span class="koboSpan" id="kobo.466.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.467.1">Let’s move on to a useful feature of Azure Container Apps: automatic versioning support.</span></p>
<h2 class="heading-2" id="_idParaDest-189"><a id="_idTextAnchor276"/><span class="koboSpan" id="kobo.468.1">Application versioning</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.469.1">Azure </span><a id="_idIndexMarker780"/><span class="koboSpan" id="kobo.470.1">Container Apps automatically versions your applications. </span><span class="koboSpan" id="kobo.470.2">Each time you modify the containers or scale configuration of your application, a new version is automatically created.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.471.1">Each version is given a name and is called a </span><strong class="keyWord"><span class="koboSpan" id="kobo.472.1">revision</span></strong><span class="koboSpan" id="kobo.473.1"> of the application. </span><span class="koboSpan" id="kobo.473.2">As a default, only the last revision is active and accessible through the application link.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.474.1">However, any application </span><a id="_idIndexMarker781"/><span class="koboSpan" id="kobo.475.1">may be put in </span><strong class="keyWord"><span class="koboSpan" id="kobo.476.1">multiple-revision</span></strong><span class="koboSpan" id="kobo.477.1"> mode, in which case, you may decide manually which revisions are </span><strong class="keyWord"><span class="koboSpan" id="kobo.478.1">active</span></strong><span class="koboSpan" id="kobo.479.1"> and which revisions are connected to the application link.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.480.1">If more than one revision is connected to the application link, you must specify how to split the traffic between them. </span><span class="koboSpan" id="kobo.480.2">If just one revision is attached to the application link but there are multiple active revisions, you may reach each active revision that is not attached to the application URL through its revision name, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.481.1">&lt;application name&gt;-&lt;revision name&gt;.&lt;environment&gt;.&lt;zone&gt;.azurecontainerapps.io
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.482.1">Since revision </span><a id="_idIndexMarker782"/><span class="koboSpan" id="kobo.483.1">names are automatically generated and are not user-friendly, each revision may be attached with friendly labels that can be used to reach the revision with links such as the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.484.1">&lt;application name&gt;--&lt;revision label&gt;.&lt;environment&gt;.&lt;zone&gt;.azurecontainerapps.io
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.485.1">Azure Container Apps revisions logic enables several deployment models, as follows:</span></p>
<ul>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.486.1">Staging/production</span></em><span class="koboSpan" id="kobo.487.1">: The newer revision is not attached to the application link but can be reached just through its revision link, so it can be tested in staging. </span><span class="koboSpan" id="kobo.487.2">As soon as the new revision is approved, it is attached to the application link and the previous revision is deactivated.</span></li>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.488.1">New features preview</span></em><span class="koboSpan" id="kobo.489.1">: The traffic is split among the last two revisions. </span><span class="koboSpan" id="kobo.489.2">Initially, the new revision is passed a low percentage of the overall traffic, so that users can experiment with new features. </span><span class="koboSpan" id="kobo.489.3">Then, gradually, the new version receives more traffic till it reaches 100%, and the previous version is deactivated.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.490.1">During traffic splitting, </span><strong class="keyWord"><span class="koboSpan" id="kobo.491.1">session affinity</span></strong><span class="koboSpan" id="kobo.492.1"> is enabled, so that if a user request is served by a revision, </span><code class="inlineCode"><span class="koboSpan" id="kobo.493.1">r</span></code><span class="koboSpan" id="kobo.494.1">, then all subsequent requests will continue being served by the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.495.1">r</span></code><span class="koboSpan" id="kobo.496.1"> revision. </span><span class="koboSpan" id="kobo.496.2">This way, we avoid users walking randomly between the two revisions.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.497.1">Revisions are useful mainly for frontend services, especially if internal communication relies on message brokers. </span><span class="koboSpan" id="kobo.497.2">Testing a new version of a worker microservice requires a completely separate staging environment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.498.1">We will provide more details on the </span><a id="_idTextAnchor277"/><span class="koboSpan" id="kobo.499.1">practical usage of revisions at the end of the </span><em class="italic"><span class="koboSpan" id="kobo.500.1">Deploying your microservice application with Azure Container Apps</span></em><span class="koboSpan" id="kobo.501.1"> section. </span><span class="koboSpan" id="kobo.501.2">The next subsection explains how to interact with your microservice application in Azure Container Apps.</span></p>
<h2 class="heading-2" id="_idParaDest-190"><a id="_idTextAnchor278"/><span class="koboSpan" id="kobo.502.1">Interacting with Azure Container Apps</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.503.1">There is no equivalent of kubectl to interact with Azure Container Apps environments and applications. </span><span class="koboSpan" id="kobo.503.2">You may </span><a id="_idIndexMarker783"/><span class="koboSpan" id="kobo.504.1">interact with them either through the Azure portal or with </span><strong class="keyWord"><span class="koboSpan" id="kobo.505.1">Azure CLI</span></strong><span class="koboSpan" id="kobo.506.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.507.1">Application and </span><a id="_idIndexMarker784"/><span class="koboSpan" id="kobo.508.1">environment settings can be specified either with command options or through </span><code class="inlineCode"><span class="koboSpan" id="kobo.509.1">.yaml</span></code><span class="koboSpan" id="kobo.510.1"> or JSON files. </span><span class="koboSpan" id="kobo.510.2">We will focus just on command options and </span><code class="inlineCode"><span class="koboSpan" id="kobo.511.1">.yaml</span></code><span class="koboSpan" id="kobo.512.1"> files, describing just the most practical alternatives.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.513.1">The interaction </span><a id="_idIndexMarker785"/><span class="koboSpan" id="kobo.514.1">with Azure Containers Apps requires the installation of the </span><strong class="keyWord"><span class="koboSpan" id="kobo.515.1">containerapp Azure CLI</span></strong><span class="koboSpan" id="kobo.516.1"> extension. </span><span class="koboSpan" id="kobo.516.2">You can install it with the following command after you have logged in with </span><code class="inlineCode"><span class="koboSpan" id="kobo.517.1">az login</span></code><span class="koboSpan" id="kobo.518.1">:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.519.1">az upgrade
az extension add --name containerapp --upgrade
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.520.1">The first </span><code class="inlineCode"><span class="koboSpan" id="kobo.521.1">upgrade</span></code><span class="koboSpan" id="kobo.522.1"> command ensures you have the latest Azure CLI version, while the </span><code class="inlineCode"><span class="koboSpan" id="kobo.523.1">upgrade</span></code><span class="koboSpan" id="kobo.524.1"> option in the second command updates the extension to the latest version. </span><span class="koboSpan" id="kobo.524.2">The preceding commands are needed only once, or each time you would like to update to a new version.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.525.1">Before starting any new session, you must register a couple of namespaces. </span><span class="koboSpan" id="kobo.525.2">Namespaces registration has the same semantics as C# </span><code class="inlineCode"><span class="koboSpan" id="kobo.526.1">using</span></code><span class="koboSpan" id="kobo.527.1"> statements. </span><span class="koboSpan" id="kobo.527.2">Here are the required registration commands:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.528.1">az provider register --namespace Microsoft.App
az provider register --namespace Microsoft.OperationalInsights
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.529.1">Now, we are ready to interact with Azure Container Apps. </span><span class="koboSpan" id="kobo.529.2">The next section explains in detail how to deploy and configure your microservice application on Azure Container Apps.</span></p>
<h1 class="heading-1" id="_idParaDest-191"><a id="_idTextAnchor279"/><span class="koboSpan" id="kobo.530.1">Deploying your microservice application with Azure Container Apps</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.531.1">In this section, we will see how to define and configure your applications in Azure Container Apps. </span><span class="koboSpan" id="kobo.531.2">In </span><a id="_idIndexMarker786"/><span class="koboSpan" id="kobo.532.1">the first subsection, we </span><a id="_idIndexMarker787"/><span class="koboSpan" id="kobo.533.1">will describe the basic commands and operativity, while all configuration options and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.534.1">.yaml</span></code><span class="koboSpan" id="kobo.535.1"> file configuration formats will be described in a later subsection.</span></p>
<h2 class="heading-2" id="_idParaDest-192"><a id="_idTextAnchor280"/><span class="koboSpan" id="kobo.536.1">Basic commands and operativity</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.537.1">All Azure </span><a id="_idIndexMarker788"/><span class="koboSpan" id="kobo.538.1">Container Apps commands start with </span><code class="inlineCode"><span class="koboSpan" id="kobo.539.1">az containerapp</span></code><span class="koboSpan" id="kobo.540.1">. </span><span class="koboSpan" id="kobo.540.2">Then, there is the main command and various configuration options. </span><span class="koboSpan" id="kobo.540.3">Configuration options may be passed each with a different command option or organized in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.541.1">.yaml</span></code><span class="koboSpan" id="kobo.542.1"> or JSON file.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.543.1">In a PowerShell console, you can split a command into several lines with the help of the ` (backquote) character, as shown in all the commands in this subsection.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.544.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.545.1">up</span></code><span class="koboSpan" id="kobo.546.1"> command is the simplest way to define an application together with a new environment. </span><span class="koboSpan" id="kobo.546.2">It is useful to perform a quick test of a container. </span><span class="koboSpan" id="kobo.546.3">The only obligatory parameters are the application name and the container image URL. </span><span class="koboSpan" id="kobo.546.4">For all other options, reasonable defaults are assumed. </span><span class="koboSpan" id="kobo.546.5">If you don’t specify a resource group and an environment, the command creates new ones:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.547.1">az containerapp up '
  --name &lt;CONTAINER_APP_NAME&gt; '
  --image &lt;REGISTRY_SERVER&gt;/&lt;IMAGE_NAME&gt;:&lt;IMAGE TAG&gt; '
  --ingress external '
  --target-port &lt;PORT NUMBER&gt; '
  --registry-server &lt;REGISTRY SERVER URL&gt; '
  --registry-username &lt;REGISTRY USERNAME&gt; '
  --registry-password &lt;REGISTRY PASSWORD&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.548.1">Let’s </span><a id="_idIndexMarker789"/><span class="koboSpan" id="kobo.549.1">break this down:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.550.1">name</span></code><span class="koboSpan" id="kobo.551.1"> is the application name. </span><span class="koboSpan" id="kobo.551.2">It is obligatory.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.552.1">image</span></code><span class="koboSpan" id="kobo.553.1"> is the container image URL. </span><span class="koboSpan" id="kobo.553.2">It is obligatory. </span><span class="koboSpan" id="kobo.553.3">As usual, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.554.1">image</span></code><span class="koboSpan" id="kobo.555.1"> tag is used for image versioning, and if omitted, </span><code class="inlineCode"><span class="koboSpan" id="kobo.556.1">latest</span></code><span class="koboSpan" id="kobo.557.1"> is assumed.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.558.1">ingress</span></code><span class="koboSpan" id="kobo.559.1"> may be </span><code class="inlineCode"><span class="koboSpan" id="kobo.560.1">internal</span></code><span class="koboSpan" id="kobo.561.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.562.1">external</span></code><span class="koboSpan" id="kobo.563.1">. </span><span class="koboSpan" id="kobo.563.2">In the first case, the application will be accessible only from inside its environment, while in the second case, the application will be exposed to the external world. </span><span class="koboSpan" id="kobo.563.3">If this parameter is omitted, the application will not be accessible with a direct link (useful when internal communication relies on a message broker).</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.564.1">target-port</span></code><span class="koboSpan" id="kobo.565.1"> specifies the target port exposed by the container, if any. </span><span class="koboSpan" id="kobo.565.2">The application traffic will be redirected to this container port. </span><span class="koboSpan" id="kobo.565.3">If there are several containers, there should be just one that receives the application traffic, and you must specify its port. </span><span class="koboSpan" id="kobo.565.4">Application HTTP/S traffic must be sent to the usual </span><code class="inlineCode"><span class="koboSpan" id="kobo.566.1">80</span></code><span class="koboSpan" id="kobo.567.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.568.1">443</span></code><span class="koboSpan" id="kobo.569.1"> ports.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.570.1">registry-server</span></code><span class="koboSpan" id="kobo.571.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.572.1">registry-username</span></code><span class="koboSpan" id="kobo.573.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.574.1">registry-password</span></code><span class="koboSpan" id="kobo.575.1"> are parameters that specify the credentials associated with a specific image registry server, which should be the same as used in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.576.1">image</span></code><span class="koboSpan" id="kobo.577.1"> parameter. </span><span class="koboSpan" id="kobo.577.2">If specified, these parameters are added to the application configuration and will be used also in subsequent application updates. </span><span class="koboSpan" id="kobo.577.3">Later on, we will see how assigning an Azure identity to an application allows it to access Azure resources by simply granting adequate privileges to this identity with no need to provide passwords.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.578.1">The preexisting environment and resource group can be specified with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.579.1">--environment</span></code><span class="koboSpan" id="kobo.580.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.581.1">--resource-group</span></code><span class="koboSpan" id="kobo.582.1"> options.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.583.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.584.1">up</span></code><span class="koboSpan" id="kobo.585.1"> commands can be used to update the application configuration or the application container image, but in this case, you must always pass the </span><code class="inlineCode"><span class="koboSpan" id="kobo.586.1">--name</span></code><span class="koboSpan" id="kobo.587.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.588.1">--environment</span></code><span class="koboSpan" id="kobo.589.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.590.1">--resource-group</span></code><span class="koboSpan" id="kobo.591.1"> parameters with the values of the preexisting application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.592.1">You can </span><a id="_idIndexMarker790"/><span class="koboSpan" id="kobo.593.1">test the </span><code class="inlineCode"><span class="koboSpan" id="kobo.594.1">up</span></code><span class="koboSpan" id="kobo.595.1"> command with the simple </span><code class="inlineCode"><span class="koboSpan" id="kobo.596.1">gcr.io/google-samples/hello-app:1.0</span></code><span class="koboSpan" id="kobo.597.1"> image we used in the </span><em class="italic"><span class="koboSpan" id="kobo.598.1">Testing ingresses with minikube </span></em><span class="koboSpan" id="kobo.599.1">subsection of</span><em class="italic"> </em><a href="Chapter_8.xhtml#_idTextAnchor205"><em class="italic"><span class="koboSpan" id="kobo.600.1">Chapter 8</span></em></a><span class="koboSpan" id="kobo.601.1">, </span><em class="italic"><span class="koboSpan" id="kobo.602.1">Practical Microservices Organization with Kubernetes</span></em><span class="koboSpan" id="kobo.603.1">. </span><span class="koboSpan" id="kobo.603.2">You don’t need to specify registry credentials since the registry is public. </span><span class="koboSpan" id="kobo.603.3">The container port is </span><code class="inlineCode"><span class="koboSpan" id="kobo.604.1">8080</span></code><span class="koboSpan" id="kobo.605.1">:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.606.1">az group create '
  --name &lt;resource group name&gt; '
  --location centralus
az containerapp up --name &lt;CONTAINER_APP_NAME&gt; --image gcr.io/google-samples/hello-app:1.0 '
  --resource-group &lt;resource group name&gt; '
  --location centralus '
  --environment &lt;environment name&gt; '
  --ingress external --target-port 8080 '
  --query properties.configuration.ingress.fqdn
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.607.1">We previously created a resource group in order to decide its name. </span><span class="koboSpan" id="kobo.607.2">We also specified the name of the environment to create. </span><span class="koboSpan" id="kobo.607.3">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.608.1">--query properties.configuration.ingress.fqdn</span></code><span class="koboSpan" id="kobo.609.1"> option lets the command return the application URL, which you might also compute manually with the URL format we gave in the previous section. </span><span class="koboSpan" id="kobo.609.2">Once you have tested this simple single HTML page application by going to the application URL with your favorite browser, you can also check all Azure resources created on your Azure portal home page.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.610.1">You can get the whole </span><code class="inlineCode"><span class="koboSpan" id="kobo.611.1">.yaml</span></code><span class="koboSpan" id="kobo.612.1"> config</span><a id="_idTextAnchor281"/><span class="koboSpan" id="kobo.613.1">uration of the application created with the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.614.1">az containerapp show '
  --name &lt;CONTAINER_APP_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt; '
  -o yaml
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.615.1">A good way to arrive at a properly configured application is by starting with default configurations, then getting the </span><code class="inlineCode"><span class="koboSpan" id="kobo.616.1">.yaml</span></code><span class="koboSpan" id="kobo.617.1"> application configuration with the preceding command, modifying this </span><code class="inlineCode"><span class="koboSpan" id="kobo.618.1">.yaml</span></code><span class="koboSpan" id="kobo.619.1"> file, and finally, submitting the modified </span><code class="inlineCode"><span class="koboSpan" id="kobo.620.1">.yaml</span></code><span class="koboSpan" id="kobo.621.1"> file with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.622.1">update</span></code><span class="koboSpan" id="kobo.623.1"> command, as shown here:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.624.1">az containerapp update '
  --name &lt;CONTAINER_APP_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt; '
  --yaml mymodified.yaml
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.625.1">Each application is univocally identified by both its name and its resource group, so each </span><code class="inlineCode"><span class="koboSpan" id="kobo.626.1">update</span></code><span class="koboSpan" id="kobo.627.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.628.1">delete</span></code><span class="koboSpan" id="kobo.629.1"> command must specify both of them.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.630.1">The simplest </span><a id="_idIndexMarker791"/><span class="koboSpan" id="kobo.631.1">way to clean up all resources after the experiment is by deleting the whole resource group, as shown here:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.632.1">az group delete --name &lt;resource group name&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.633.1">When you need to deploy several applications in the same environment, the best way to proceed is to create the environment first with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.634.1">az containerapp env create '
  --name &lt;CONTAINERAPPS_ENVIRONMENT&gt; '
  --resource-group &lt;RESOURCE_GROUP&gt; '
  --location "&lt;AZURE LOCATION NAME&gt;"
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.635.1">If you would like to enable workload profiles on the environment, you must also add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.636.1">--enable-workload-profiles</span></code><span class="koboSpan" id="kobo.637.1"> option.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.638.1">If you want to place all resources involved in your overall microservice application in a new resource group. </span><span class="koboSpan" id="kobo.638.2">you need to create it before creating the environment, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.639.1">az group create '
  --name &lt;RESOURCE_GROUP&gt; '
  --location "&lt;AZURE LOCATION NAME&gt;"
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.640.1">Workload profiles can be added to an environment with the following instruction:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.641.1">az containerapp env workload-profile add '
  --resource-group &lt;RESOURCE_GROUP&gt; '
  --name &lt;ENVIRONMENT_NAME&gt; '
  --workload-profile-type &lt;WORKLOAD_PROFILE_TYPE&gt; </span><a id="_idTextAnchor282"/><span class="koboSpan" id="kobo.642.1">'
  --workload-profile-name &lt;WORKLOAD_PROFILE_NAME&gt; '
  --min-nodes &lt;MIN_INSTANCES&gt; '
  --max-nodes &lt;MAX_INSTANCES&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.643.1">Here, </span><code class="inlineCode"><span class="koboSpan" id="kobo.644.1">--workload-profile-name</span></code><span class="koboSpan" id="kobo.645.1"> is the name you give to the workload profile, while </span><code class="inlineCode"><span class="koboSpan" id="kobo.646.1">--workload-profile-type</span></code><span class="koboSpan" id="kobo.647.1"> is a profile type—that is, a type of virtual machine that you can select from the ones listed here: </span><a href="https://learn.microsoft.com/en-us/azure/container-apps/workload-profiles-overview"><span class="url"><span class="koboSpan" id="kobo.648.1">https://learn.microsoft.com/en-us/azure/container-apps/workload-profiles-overview</span></span></a><span class="koboSpan" id="kobo.649.1">. </span><code class="inlineCode"><span class="koboSpan" id="kobo.650.1">--min-nodes</span></code><span class="koboSpan" id="kobo.651.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.652.1">--max-nodes</span></code><span class="koboSpan" id="kobo.653.1"> are, respectively, the minimum and maximum instances of the virtual machine that can be created.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.654.1">Workload </span><a id="_idIndexMarker792"/><span class="koboSpan" id="kobo.655.1">profiles can also be removed at a later time with the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.656.1">az containerapp env workload-profile delete '
  --resource-group "&lt;RESOURCE_GROUP&gt;" '
  --name &lt;ENVIRONMENT_NAME&gt; '
  --workload-profile-name &lt;WORKLOAD_PROFILE_NAME&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.657.1">When the environment is set up, you can deploy all container images in a common registry, and then you can start creating each application with the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.658.1">az containerapp create '
  --name &lt;CONTAINER_APP_NAME&gt; '
  --image &lt;REGISTRY_SERVER&gt;/&lt;IMAGE_NAME&gt;:&lt;TAG&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt; '
  --environment &lt;ENVIRONMENT_NAME&gt; '
  --ingress &lt;external or internal or omit this option&gt; '
  --target-port &lt;PORT_NUMBER&gt; '
  --registry-server &lt;REGISTRY SERVER URL&gt; '
  --registry-username &lt;REGISTRY USERNAME&gt; '
  --registry-password &lt;REGISTRY PASSWORD&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.659.1">The preceding command creates an application with a default configuration. </span><span class="koboSpan" id="kobo.659.2">If you want the application to run in a workload profile instead of the default consumption profile, you must add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.660.1">--workload-profile-name &lt;WORKLOAD_PROFILE_NAME&gt;</span></code><span class="koboSpan" id="kobo.661.1"> option.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.662.1">Then, you can extract its </span><code class="inlineCode"><span class="koboSpan" id="kobo.663.1">.yaml</span></code><span class="koboSpan" id="kobo.664.1"> and modify it with the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.665.1"> az containerapp show '
  --name &lt;CONTAINER_APP_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt; '
  -o yaml
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.666.1">You will need to use the preceding code with this code, too:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.667.1">az containerapp update '
  --name &lt;CONTAINER_APP_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt; '
  --yaml mymodified.yaml
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.668.1">You can </span><a id="_idIndexMarker793"/><span class="koboSpan" id="kobo.669.1">also opt in for immediately specifying a </span><code class="inlineCode"><span class="koboSpan" id="kobo.670.1">.yaml</span></code><span class="koboSpan" id="kobo.671.1"> file during the application creation, as shown here:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.672.1">az containerapp create '
  --name &lt;CONTAINER_APP_NAME&gt; '
  --environment &lt;ENVIRONMENT_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt; '
  --yaml myapp.yaml
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.673.1">You can get the list of all application revisions with the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.674.1">az containerapp revision list '
  --name &lt;CONTAINER_APP_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.675.1">You can get also all replicas of each revision with the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.676.1">az containerapp replica list '
  --name &lt;CONTAINER_APP_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP&gt; '
  --revision &lt;REVISIONNAME&gt;
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.677.1">You can also get an interactive console in a container of a specific replica of a specific revision, similar to how Kubernetes </span><code class="inlineCode"><span class="koboSpan" id="kobo.678.1">exec</span></code><span class="koboSpan" id="kobo.679.1"> works:</span></p>
</div>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.680.1">az containerapp exec `
  --name &lt;CONTAINER_APP_NAME&gt; `
  --resource-group &lt;RESOURCE_GROUP&gt; `
  --revision &lt;REVISION_NAME&gt; `
  --replica &lt;REPLICA_NAME&gt;
</span></code></pre>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.681.1">If there are several containers, you can specify the container name with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.682.1">--container</span></code><span class="koboSpan" id="kobo.683.1"> option.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.684.1">You can delete an application with the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.685.1">az containerapp delete '
  --name &lt;CONTAINER_APP_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.686.1">You can delete a whole environment and all the applications it contains with the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.687.1">az containerapp env delete '
  --name &lt;ENVIRONMENT_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.688.1">These commands </span><a id="_idIndexMarker794"/><span class="koboSpan" id="kobo.689.1">cover most of the practical use cases. </span><span class="koboSpan" id="kobo.689.2">Other options and commands can be found in the official command reference at </span><a href="https://learn.microsoft.com/it-it/cli/azure/containerapp?view=azure-cli-latest"><span class="url"><span class="koboSpan" id="kobo.690.1">https://learn.microsoft.com/it-it/cli/azure/containerapp?view=azure-cli-latest</span></span></a><span class="koboSpan" id="kobo.691.1">. </span><span class="koboSpan" id="kobo.691.2">In the next subsection, we will describe how to configure your application with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.692.1">.yaml</span></code><span class="koboSpan" id="kobo.693.1"> file.</span></p>
<h2 class="heading-2" id="_idParaDest-193"><a id="_idTextAnchor283"/><span class="koboSpan" id="kobo.694.1">Application configuration options and the .yaml format</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.695.1">The simplest </span><a id="_idIndexMarker795"/><span class="koboSpan" id="kobo.696.1">way to customize the </span><a id="_idIndexMarker796"/><span class="koboSpan" id="kobo.697.1">application configuration is with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.698.1">.yaml</span></code><span class="koboSpan" id="kobo.699.1"> file passed to the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.700.1">az containerapp update '
  --name &lt;CONTAINER_APP_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt; '
  --yaml myappconfiguration.yaml
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.701.1">The organization of an application </span><code class="inlineCode"><span class="koboSpan" id="kobo.702.1">.yaml</span></code><span class="koboSpan" id="kobo.703.1"> file is shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.704.1">identity:</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.705.1">...</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.706.1">properties:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.707.1">environmentId:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.708.1">"/subscriptions/&lt;subscription_id&gt;/resourceGroups/….."</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.709.1">workloadProfileName:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.710.1">My-GP-01</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.711.1">configuration:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.712.1">ingress:</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.713.1">…</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.714.1">maxInactiveRevisions:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.715.1">10</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.716.1">secrets:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.717.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.718.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.719.1">&lt;nome&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.720.1">value:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.721.1">&lt;valore&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.722.1">registries:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.723.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.724.1">server:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.725.1">&lt;server</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.726.1">URL&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.727.1">username:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.728.1">&lt;user</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.729.1">name&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.730.1">passwordSecretRef:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.731.1">&lt;name</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.732.1">of</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.733.1">the</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.734.1">secret</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.735.1">that</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.736.1">contains</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.737.1">the</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.738.1">password&gt;</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.739.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.740.1">server:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.741.1">&lt;server</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.742.1">URL&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.743.1">identity:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.744.1">&lt;application</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.745.1">identity</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.746.1">resource</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.747.1">id&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.748.1">template:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.749.1">containers:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.750.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.751.1">…</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.752.1">initContainers:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.753.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.754.1">...</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.755.1">scale:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.756.1">minReplicas:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.757.1">1</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.758.1">maxReplicas:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.759.1">5</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.760.1">rules:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.761.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.762.1">...</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.763.1">volumes:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.764.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.765.1">...</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.766.1">Let’s </span><a id="_idIndexMarker797"/><span class="koboSpan" id="kobo.767.1">break this down:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.768.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.769.1">identity</span></code><span class="koboSpan" id="kobo.770.1"> section is present only if the application has been attached to an Azure </span><a id="_idIndexMarker798"/><span class="koboSpan" id="kobo.771.1">identity for handling its access to other resources without passwords.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.772.1">environmentId</span></code><span class="koboSpan" id="kobo.773.1"> is the Azure unique ID of the environment the application is in (don’t confuse it with the environment name). </span><span class="koboSpan" id="kobo.773.2">The simplest way to get this and other values is by creating an application with default values and then showing its </span><code class="inlineCode"><span class="koboSpan" id="kobo.774.1">.yaml</span></code><span class="koboSpan" id="kobo.775.1"> file.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.776.1">workloadProfileName</span></code><span class="koboSpan" id="kobo.777.1"> is present only if the application is associated with a workload profile and contains the workload profile name.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.778.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.779.1">ingress</span></code><span class="koboSpan" id="kobo.780.1"> section is present only if the application must be accessible with a direct link from inside or outside its environment. </span><span class="koboSpan" id="kobo.780.2">It contains all its direct communication-related properties, CORS settings, and traffic splitting between versions.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.781.1">maxInactiveRevisions</span></code><span class="koboSpan" id="kobo.782.1"> is the number of previous revisions that are saved and can be activated. </span><span class="koboSpan" id="kobo.782.2">The default is 100.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.783.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.784.1">registries</span></code><span class="koboSpan" id="kobo.785.1"> section contains information about registries that must be accessed with credentials. </span><span class="koboSpan" id="kobo.785.2">Registries that are not private and don’t need credentials should not be listed here. </span><span class="koboSpan" id="kobo.785.3">Each entry specifies either the registry username and password or an Azure identity with permission to access the registry. </span><span class="koboSpan" id="kobo.785.4">The identity must be listed in the i</span><code class="inlineCode"><span class="koboSpan" id="kobo.786.1">dentity</span></code><span class="koboSpan" id="kobo.787.1"> section. </span><span class="koboSpan" id="kobo.787.2">For more details, see the </span><em class="italic"><span class="koboSpan" id="kobo.788.1">Associating an Azure identity to your application</span></em><span class="koboSpan" id="kobo.789.1"> section.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.790.1">secrets</span></code><span class="koboSpan" id="kobo.791.1"> are name-value pairs that are stored safely. </span><span class="koboSpan" id="kobo.791.2">They are equivalent to Kubernetes generic secrets.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.792.1">As in Kubernetes, we have </span><code class="inlineCode"><span class="koboSpan" id="kobo.793.1">containers</span></code><span class="koboSpan" id="kobo.794.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.795.1">initContainers</span></code><span class="koboSpan" id="kobo.796.1">. </span><code class="inlineCode"><span class="koboSpan" id="kobo.797.1">initContainers</span></code><span class="koboSpan" id="kobo.798.1"> work the same as in Kubernetes, but there is no way to declare </span><code class="inlineCode"><span class="koboSpan" id="kobo.799.1">sidecar</span></code><span class="koboSpan" id="kobo.800.1"> containers, so </span><code class="inlineCode"><span class="koboSpan" id="kobo.801.1">sidecar</span></code><span class="koboSpan" id="kobo.802.1"> containers must be included among the standard containers.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.803.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.804.1">scale</span></code><span class="koboSpan" id="kobo.805.1"> section contains the minimum and maximum number of application replicas </span><a id="_idIndexMarker799"/><span class="koboSpan" id="kobo.806.1">and rules for deciding the exact number </span><a id="_idIndexMarker800"/><span class="koboSpan" id="kobo.807.1">of replicas. </span><span class="koboSpan" id="kobo.807.2">The most common rules decide the number of replicas trying to maintain a target number of HTTP requests or TCP/IP connections per replica:
        </span><pre class="programlisting con-one"><code class="hljs-con"><span class="koboSpan" id="kobo.808.1">- name: my-http-rule,
  http:
      metadata:
            concurrentRequests: 100
- name: my-tcp-rule,
  tcp:
      metadata:
            concurrentConnections: 100
</span></code></pre>
</li>
<li class="bulletList"><span class="koboSpan" id="kobo.809.1">Finally, we have a </span><code class="inlineCode"><span class="koboSpan" id="kobo.810.1">volumes</span></code><span class="koboSpan" id="kobo.811.1"> section that declares all volumes mounted by containers. </span><span class="koboSpan" id="kobo.811.2">As in Kubernetes, they are referred to by a </span><code class="inlineCode"><span class="koboSpan" id="kobo.812.1">volumeMounts</span></code><span class="koboSpan" id="kobo.813.1"> section inside the container definitions.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.814.1">All properties that were not fully specified in the previous </span><code class="inlineCode"><span class="koboSpan" id="kobo.815.1">.yaml</span></code><span class="koboSpan" id="kobo.816.1"> file will be described in a separate subsection. </span><span class="koboSpan" id="kobo.816.2">Let’s start with containers.</span></p>
<h3 class="heading-3" id="_idParaDest-194"><a id="_idTextAnchor284"/><span class="koboSpan" id="kobo.817.1">Container configuration</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.818.1">The </span><a id="_idIndexMarker801"/><span class="koboSpan" id="kobo.819.1">configuration of each container is </span><a id="_idIndexMarker802"/><span class="koboSpan" id="kobo.820.1">similar to the one in Kubernetes but there are some simplifications. </span><span class="koboSpan" id="kobo.820.2">The schema is shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-bullet"><span class="koboSpan" id="kobo.821.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.822.1">image:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.823.1">&lt;IMAGE</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.824.1">URL&gt;:&lt;TAG&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.825.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.826.1">&lt;CONTAINER</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.827.1">NAME&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.828.1">env:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.829.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.830.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.831.1">&lt;variable</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.832.1">name&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.833.1">value:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.834.1">&lt;variable</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.835.1">name&gt;</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.836.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.837.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.838.1">&lt;variable</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.839.1">name&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.840.1">secretRef:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.841.1">&lt;secret</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.842.1">name&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.843.1">resources:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.844.1">cpu:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.845.1">0.2</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.846.1">memory:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.847.1">100Mi</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.848.1">probes:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.849.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.850.1">type:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.851.1">liveness</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.852.1">…</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.853.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.854.1">type:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.855.1">readiness</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.856.1">…</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.857.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.858.1">type:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.859.1">startup</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.860.1">…</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.861.1">volumeMounts:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.862.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.863.1">mountPath:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.864.1">/mypath</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.865.1">volumeName:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.866.1">myvolume</span></span>
</code></pre>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.867.1">image</span></code><span class="koboSpan" id="kobo.868.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.869.1">name</span></code><span class="koboSpan" id="kobo.870.1"> are identical to the Kubernetes configuration.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.871.1">Environment </span><a id="_idIndexMarker803"/><span class="koboSpan" id="kobo.872.1">variables can be defined either as name-value pairs or as </span><code class="inlineCode"><span class="koboSpan" id="kobo.873.1">name</span></code><span class="koboSpan" id="kobo.874.1">-</span><code class="inlineCode"><span class="koboSpan" id="kobo.875.1">secretRef</span></code><span class="koboSpan" id="kobo.876.1"> pairs, where </span><code class="inlineCode"><span class="koboSpan" id="kobo.877.1">secretRef</span></code><span class="koboSpan" id="kobo.878.1"> contains the name of a secret defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.879.1">secrets</span></code><span class="koboSpan" id="kobo.880.1"> section. </span><span class="koboSpan" id="kobo.880.2">In the second case, the variable value is the value of the secret.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.881.1">volumeMounts</span></code><span class="koboSpan" id="kobo.882.1"> is similar to Kubernetes, too. </span><span class="koboSpan" id="kobo.882.2">The only difference is that the volume name is called </span><code class="inlineCode"><span class="koboSpan" id="kobo.883.1">name</span></code><span class="koboSpan" id="kobo.884.1"> in Kubernetes while, here, it is called </span><code class="inlineCode"><span class="koboSpan" id="kobo.885.1">volumeName</span></code><span class="koboSpan" id="kobo.886.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.887.1">The Kubernetes </span><code class="inlineCode"><span class="koboSpan" id="kobo.888.1">resources</span></code><span class="koboSpan" id="kobo.889.1"> property has two properties, </span><code class="inlineCode"><span class="koboSpan" id="kobo.890.1">requests</span></code><span class="koboSpan" id="kobo.891.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.892.1">limits</span></code><span class="koboSpan" id="kobo.893.1">, while here we have </span><a id="_idIndexMarker804"/><span class="koboSpan" id="kobo.894.1">just a couple of values that correspond to the Kubernetes </span><code class="inlineCode"><span class="koboSpan" id="kobo.895.1">requests</span></code><span class="koboSpan" id="kobo.896.1"> property. </span><span class="koboSpan" id="kobo.896.2">This means that we cannot specify </span><code class="inlineCode"><span class="koboSpan" id="kobo.897.1">resources</span></code><span class="koboSpan" id="kobo.898.1"> limits as in Kubernetes. </span><span class="koboSpan" id="kobo.898.2">The reason behind this choice is probably connected to the serverless nature of Azure Container Apps. </span><span class="koboSpan" id="kobo.898.3">The meanings and units of measure of both </span><code class="inlineCode"><span class="koboSpan" id="kobo.899.1">cpu</span></code><span class="koboSpan" id="kobo.900.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.901.1">memory</span></code><span class="koboSpan" id="kobo.902.1"> are the same as in Kubernetes.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.903.1">As you can see, liveness, readiness, and startup probes are defined in slightly different ways but their meaning is the same as in Kubernetes. </span><span class="koboSpan" id="kobo.903.2">The syntax and meaning of the properties after </span><code class="inlineCode"><span class="koboSpan" id="kobo.904.1">type: liveness/readiness/startup</span></code><span class="koboSpan" id="kobo.905.1"> is identical to the corresponding Kubernetes configuration.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.906.1">Let’s move on to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.907.1">ingress</span></code><span class="koboSpan" id="kobo.908.1"> configuration.</span></p>
<h3 class="heading-3" id="_idParaDest-195"><a id="_idTextAnchor285"/><span class="koboSpan" id="kobo.909.1">The ingress configuration</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.910.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.911.1">ingress</span></code><span class="koboSpan" id="kobo.912.1"> configuration </span><a id="_idIndexMarker805"/><span class="koboSpan" id="kobo.913.1">mixes some </span><a id="_idIndexMarker806"/><span class="koboSpan" id="kobo.914.1">Kubernetes </span><code class="inlineCode"><span class="koboSpan" id="kobo.915.1">Service</span></code><span class="koboSpan" id="kobo.916.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.917.1">Ingress</span></code><span class="koboSpan" id="kobo.918.1"> settings with the traffic splitting between various revisions, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-attr"><span class="koboSpan" id="kobo.919.1">ingress:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.920.1">external:</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.921.1">true</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.922.1">targetPort:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.923.1">3000</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.924.1"># only for TCP communication. </span><span class="koboSpan" id="kobo.924.2">HTTP/S always use 80 and 443 ports</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.925.1">exposedPort:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.926.1">5000</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.927.1">allowInsecure:</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.928.1">false</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.929.1"># false or true</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.930.1">clientCertificateMode:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.931.1">accept</span></span> <span class="hljs-comment"><span class="koboSpan" id="kobo.932.1"># accept required or ignore</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.933.1">corsPolicy:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.934.1">allowCredentials:</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.935.1">true</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.936.1">maxAge:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.937.1">5000</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.938.1">(pre-flight</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.939.1">caching</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.940.1">time</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.941.1">in</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.942.1">seconds)</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.943.1">allowedOrigins:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.944.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.945.1">"https://example.com"</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.946.1">allowedMethods:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.947.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.948.1">"GET"</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.949.1">-</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.950.1">"POST"</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.951.1">…</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.952.1">allowedHeaders:</span></span><span class="koboSpan" id="kobo.953.1"> []
        </span><span class="hljs-attr"><span class="koboSpan" id="kobo.954.1">exposeHeaders:</span></span><span class="koboSpan" id="kobo.955.1"> []
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.956.1">traffic:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.957.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.958.1">weight:</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.959.1">100</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.960.1">revisionName:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.961.1">testcontainerApp0-ab1234</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.962.1">label:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.963.1">production</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.964.1">stickySessions:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.965.1">affinity:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.966.1">sticky</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.967.1">Let’s </span><a id="_idIndexMarker807"/><span class="koboSpan" id="kobo.968.1">break this down:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.969.1">external</span></code><span class="koboSpan" id="kobo.970.1"> must be set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.971.1">true</span></code><span class="koboSpan" id="kobo.972.1"> to expose the application to the outside world, otherwise, to </span><code class="inlineCode"><span class="koboSpan" id="kobo.973.1">false</span></code><span class="koboSpan" id="kobo.974.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.975.1">targetPort</span></code><span class="koboSpan" id="kobo.976.1"> is the </span><a id="_idIndexMarker808"/><span class="koboSpan" id="kobo.977.1">container port to which to rou</span><a id="_idTextAnchor286"/><span class="koboSpan" id="kobo.978.1">te the application traffic.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.979.1">exposedPort</span></code><span class="koboSpan" id="kobo.980.1"> must be used only in case of non-HTTP/S traffic. </span><span class="koboSpan" id="kobo.980.2">It sets the application listening port. </span><span class="koboSpan" id="kobo.980.3">All traffic received on this port is routed to </span><code class="inlineCode"><span class="koboSpan" id="kobo.981.1">targetPort</span></code><span class="koboSpan" id="kobo.982.1">. </span><span class="koboSpan" id="kobo.982.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.983.1">exposedPort</span></code><span class="koboSpan" id="kobo.984.1"> ports of applications exposed to the outside world must be unique inside the environment.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.985.1">HTTP/S traffic, instead, always uses the usual </span><code class="inlineCode"><span class="koboSpan" id="kobo.986.1">80</span></code><span class="koboSpan" id="kobo.987.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.988.1">443</span></code><span class="koboSpan" id="kobo.989.1"> ports with no customization possibilities.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.990.1">If </span><code class="inlineCode"><span class="koboSpan" id="kobo.991.1">allowInsecure</span></code><span class="koboSpan" id="kobo.992.1"> is </span><code class="inlineCode"><span class="koboSpan" id="kobo.993.1">false</span></code><span class="koboSpan" id="kobo.994.1">, HTTP traffic is automatically redirected to HTTPS. </span><span class="koboSpan" id="kobo.994.2">The default is </span><code class="inlineCode"><span class="koboSpan" id="kobo.995.1">true</span></code><span class="koboSpan" id="kobo.996.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.997.1">clientCertificateMode</span></code><span class="koboSpan" id="kobo.998.1"> specifies whether TCP/IP client certificates are accepted for authentication. </span><span class="koboSpan" id="kobo.998.2">This setting is completely analogous to a similar setting exposed by Kestrel. </span><span class="koboSpan" id="kobo.998.3">If set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.999.1">accept</span></code><span class="koboSpan" id="kobo.1000.1">, client certificates are accepted and processed. </span><span class="koboSpan" id="kobo.1000.2">If set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1001.1">required</span></code><span class="koboSpan" id="kobo.1002.1">, client certificates are obligatory, and if not provided, the connection is refused. </span><span class="koboSpan" id="kobo.1002.2">If set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1003.1">ignore</span></code><span class="koboSpan" id="kobo.1004.1">, client certificates are completely ignored.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1005.1">corsPolicy</span></code><span class="koboSpan" id="kobo.1006.1"> contains standard web server CORS settings, which are the same as those supported by ASP.NET Core. </span><span class="koboSpan" id="kobo.1006.2">For completeness, we describe all the CORS settings here:</span><ul>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.1007.1">If </span><code class="inlineCode"><span class="koboSpan" id="kobo.1008.1">allowCredentials</span></code><span class="koboSpan" id="kobo.1009.1"> is set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1010.1">false</span></code><span class="koboSpan" id="kobo.1011.1">, CORS requests containing credentials are refused. </span><span class="koboSpan" id="kobo.1011.2">The default is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1012.1">false</span></code><span class="koboSpan" id="kobo.1013.1">.</span></li>
<li class="bulletList level-2"><code class="inlineCode"><span class="koboSpan" id="kobo.1014.1">maxAge</span></code><span class="koboSpan" id="kobo.1015.1"> specifies the caching time of the pre-flight request. </span><span class="koboSpan" id="kobo.1015.2">The pre-flight request has the only purpose of verifying whether a CORS request will be accepted before sending actual data.</span></li>
<li class="bulletList level-2"><code class="inlineCode"><span class="koboSpan" id="kobo.1016.1">allowedOrigins</span></code><span class="koboSpan" id="kobo.1017.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1018.1">allowedMethods</span></code><span class="koboSpan" id="kobo.1019.1"> specify, respectively, the origin domains from which to accept CORS requests and the accepted HTTP verbs.</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.1020.1">Regarding </span><code class="inlineCode"><span class="koboSpan" id="kobo.1021.1">allowedHeaders</span></code><span class="koboSpan" id="kobo.1022.1">, as a default, only some safe </span><code class="inlineCode"><span class="koboSpan" id="kobo.1023.1">requests</span></code><span class="koboSpan" id="kobo.1024.1"> headers are allowed. </span><span class="koboSpan" id="kobo.1024.2">This setting adds further </span><code class="inlineCode"><span class="koboSpan" id="kobo.1025.1">requests</span></code><span class="koboSpan" id="kobo.1026.1"> headers to the ones accepted.</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.1027.1">Regarding </span><code class="inlineCode"><span class="koboSpan" id="kobo.1028.1">exposeHeaders</span></code><span class="koboSpan" id="kobo.1029.1">, as a default, only some safe </span><code class="inlineCode"><span class="koboSpan" id="kobo.1030.1">response</span></code><span class="koboSpan" id="kobo.1031.1"> headers are exposed in the responses to CORS requests. </span><span class="koboSpan" id="kobo.1031.2">This setting adds further headers to the ones allowed.</span></li>
</ul>
</li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1032.1">traffic</span></code><span class="koboSpan" id="kobo.1033.1"> specifies the traffic splitting among various revisions. </span><span class="koboSpan" id="kobo.1033.2">If a revision is listed with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1034.1">0</span></code><span class="koboSpan" id="kobo.1035.1"> split, it will receive no application traffic but it will be set to active—that is, it can be reached with its revision-specific links. </span><span class="koboSpan" id="kobo.1035.2">All labels added to an active revision must be specified here.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1036.1">While </span><a id="_idIndexMarker809"/><span class="koboSpan" id="kobo.1037.1">revision handling can be done by </span><a id="_idIndexMarker810"/><span class="koboSpan" id="kobo.1038.1">modifying the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1039.1">traffic</span></code><span class="koboSpan" id="kobo.1040.1"> section, it is more practical to handle it with ad hoc commands.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1041.1">The list of all revisions in table format for a given application can be obtained with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1042.1">az containerapp revision list '
  --name &lt;APPLICATION_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt; '
  -o table
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1043.1">Details about a specific revision can be obtained with the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1044.1">az containerapp revision show '
  --name &lt;APPLICATION_NAME&gt; '
  --revision &lt;REVISION_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1045.1">Labels can be attached or detached from a specific revision with the following commands:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1046.1">az containerapp revision label &lt;add or remove&gt; '
  --revision &lt;REVISION_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt; '
  --label &lt;LABEL_NAME&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1047.1">An application </span><a id="_idIndexMarker811"/><span class="koboSpan" id="kobo.1048.1">can be switched from single revision mode to multiple </span><a id="_idIndexMarker812"/><span class="koboSpan" id="kobo.1049.1">revision mode, and vice versa, with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1050.1">az containerapp revision set-mode '
  --name &lt;APPLICATION_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt; '
  --mode &lt;single or multiple&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1051.1">A given revision can be activated, deactivated, or restarted with the following commands:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1052.1">az containerapp revision &lt;activate or deactivate or restart&gt; '
  --revision &lt;REVISION_NAME&gt; '
  --resource-group &lt;RESOURCE_GROUP_NAME&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1053.1">Finally, traffic splitting between revisions can be changed with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1054.1">az containerapp ingress traffic set \
    --name &lt;APP_NAME&gt; \
    --resource-group &lt;RESOURCE_GROUP&gt; \
    --label-weight &lt;LABEL_1&gt;=80 &lt;LABEL_2&gt;=20 …
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1055.1">The next section focuses on how to define volumes in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1056.1">volumes</span></code><span class="koboSpan" id="kobo.1057.1"> section.</span></p>
<h3 class="heading-3" id="_idParaDest-196"><a id="_idTextAnchor287"/><span class="koboSpan" id="kobo.1058.1">Volume definition and allocation</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.1059.1">Volumes </span><a id="_idIndexMarker813"/><span class="koboSpan" id="kobo.1060.1">can be either </span><code class="inlineCode"><span class="koboSpan" id="kobo.1061.1">EmptyDir</span></code><span class="koboSpan" id="kobo.1062.1"> (which works </span><a id="_idIndexMarker814"/><span class="koboSpan" id="kobo.1063.1">in the same way as Kubernetes </span><code class="inlineCode"><span class="koboSpan" id="kobo.1064.1">EmptyDir</span></code><span class="koboSpan" id="kobo.1065.1">) or file </span><a id="_idIndexMarker815"/><span class="koboSpan" id="kobo.1066.1">shares taken from Azure Files, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-attr"><span class="koboSpan" id="kobo.1067.1">volumes:</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.1068.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.1069.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1070.1">myempty</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1071.1">storageType:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1072.1">EmptyDir</span></span>
<span class="hljs-bullet"><span class="koboSpan" id="kobo.1073.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.1074.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1075.1">my-azure-files-volume</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1076.1">storageType:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1077.1">AzureFile</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1078.1">storageName:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1079.1">mystorage</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1080.1">Here, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1081.1">mystorage</span></code><span class="koboSpan" id="kobo.1082.1"> is the name of a file share you created and attached to the environment. </span><span class="koboSpan" id="kobo.1082.2">Therefore, you must execute the following steps to get </span><code class="inlineCode"><span class="koboSpan" id="kobo.1083.1">mystorage</span></code><span class="koboSpan" id="kobo.1084.1">:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1085.1">Define </span><a id="_idIndexMarker816"/><span class="koboSpan" id="kobo.1086.1">a storage account if you don’t have it:
        </span><pre class="programlisting con-one"><code class="hljs-con"><span class="koboSpan" id="kobo.1087.1">az storage account create '
  --resource-group &lt;RESOURCE GROUP &gt; '
  --nam</span><a id="_idTextAnchor288"/><span class="koboSpan" id="kobo.1088.1">e &lt;STORAGE ACCOUNT NAME&gt; '
  --location &lt;AZURE LOCATION &gt; '
  --kind StorageV2 ' 🡨 type (generic usage type)
  --sku Standard_LRS ' 🡨 performance level (this is a standard level)
  --enable-large-file-share '
  --query provisioningState 🡨 returns the provisioning state
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1089.1">Define a file share:
        </span><pre class="programlisting con-one"><code class="hljs-con"><span class="koboSpan" id="kobo.1090.1">az storage share-rm create '
  --resource-group &lt;RESOURCE GROUP&gt; '
  --storage-account &lt;STORAGE ACCOUNT NAME&gt;'
  --name &lt;STORAGE SHARE NAME&gt; '
  --quota 1024 ' 🡨 megabyte to share
  --enabled-protocols SMB ' 🡨 SMB or NFS, SMB is usually better
  --output table 🡨 return information on the created share in table format
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1091.1">Get the credentials to access the storage account:
        </span><pre class="programlisting con-one"><code class="hljs-con"><span class="koboSpan" id="kobo.1092.1">STORAGE_ACCOUNT_KEY='az storage account keys list -n &lt;STORAGE ACCOUNT NAME&gt; --query "[0].value" -o tsv'
</span></code></pre>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.1093.1">Add a file share name to the environment:
        </span><pre class="programlisting con-one"><code class="hljs-con"><span class="koboSpan" id="kobo.1094.1">az containerapp env storage set '
  --access-mode ReadWrite '
  --azure-file-account-name &lt;STORAGE ACCOUNT NAME&gt; '
  --azure-file-account-key $STORAGE_ACCOU</span><a id="_idTextAnchor289"/><span class="koboSpan" id="kobo.1095.1">NT_KEY '
  --azure-file-share-name &lt;STORAGE SHARE NAME&gt; '
  --storage-name &lt;STORAGE_MOUNT_NAME&gt; '
  --name &lt;ENVIRONMENT NAME&gt; '
  --resource-group &lt;RESOURCE GROUP&gt; '
  --output table 🡨 return details in table format
</span></code></pre>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1096.1">Now, you </span><a id="_idIndexMarker817"/><span class="koboSpan" id="kobo.1097.1">can define the volume in your application using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1098.1">--storage-name</span></code><span class="koboSpan" id="kobo.1099.1"> value passed to the last command, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-bullet"><span class="koboSpan" id="kobo.1100.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.1101.1">name:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1102.1">my-azure-files-volume</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1103.1">storageType:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1104.1">AzureFile</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1105.1">storageName:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1106.1">&lt;STORAGE</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1107.1">MOUNT</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1108.1">NAME&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1109.1">The next subsection explains how to associate an Azure identity to an application, thus enabling it to access Azure resources.</span></p>
<h2 class="heading-2" id="_idParaDest-197"><a id="_idTextAnchor290"/><span class="koboSpan" id="kobo.1110.1">Associating an Azure identity to your application</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1111.1">The Azure identity to associate with an application can be automatically generated and handled </span><a id="_idIndexMarker818"/><span class="koboSpan" id="kobo.1112.1">by Azure or can be defined manually. </span><span class="koboSpan" id="kobo.1112.2">The main advantage of using a user-defined identity is that you can add the same identity to several applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1113.1">Adding a system-assigned identity to an application is very easy:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1114.1">az containerapp identity assign '
--name my-container-app '
--resource-group my-container-app-rg '
--system-assigned
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1115.1">The preceding command returns the Azure resource ID of the created identity. </span><span class="koboSpan" id="kobo.1115.2">A system-assigned identity can be associated with the application also by adding </span><code class="inlineCode"><span class="koboSpan" id="kobo.1116.1">type: SystemAssigned</span></code><span class="koboSpan" id="kobo.1117.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1118.1">identity</span></code><span class="koboSpan" id="kobo.1119.1"> section of the application’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1120.1">.yaml</span></code><span class="koboSpan" id="kobo.1121.1"> file, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.1122.1">identity:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1123.1">type:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1124.1">SystemAssigned</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1125.1">A user-defined identity must be created first and then assigned to the application, so adding a user-defined identity requires two steps.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1126.1">The identity can be created with the simple command shown here:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1127.1">az identity create --resource-group &lt;GROUP_NAME&gt; --name &lt;IDENTITY_NAME&gt; --output json
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1128.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1129.1">--output json</span></code><span class="koboSpan" id="kobo.1130.1"> option forces the command to return information about the created identity in JSON format. </span><span class="koboSpan" id="kobo.1130.2">The returned JSON object contains the Azure resource ID of the created identity. </span><span class="koboSpan" id="kobo.1130.3">You need it to associate the identity with your applications using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1131.1">Az containerapp identi</span><a id="_idTextAnchor291"/><span class="koboSpan" id="kobo.1132.1">ty assign --resource-group &lt;GROUP_NAME&gt; --name &lt;APP_NAME&gt; '
--user-assigned &lt;IDENTITY RESOURCE ID&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1133.1">The last step can be performed b</span><a id="_idTextAnchor292"/><span class="koboSpan" id="kobo.1134.1">y adding the resource ID of one or more identities directly to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1135.1">identity</span></code><span class="koboSpan" id="kobo.1136.1"> section of the application’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1137.1">.yaml</span></code><span class="koboSpan" id="kobo.1138.1"> files, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr"><span class="koboSpan" id="kobo.1139.1">identity:</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1140.1">type:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1141.1">UserAssigned</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1142.1">userAssignedIdentities:</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1143.1">&lt;IDENTITY1_RESOURCE_ID&gt;:</span></span><span class="koboSpan" id="kobo.1144.1"> {}
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1145.1">&lt;IDENTITY2_RESOURCE_ID&gt;:</span></span><span class="koboSpan" id="kobo.1146.1"> {}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1147.1">As an example, let’s see how to enable a created identity to access an Azure container registry. </span><span class="koboSpan" id="kobo.1147.2">This way, we can </span><a id="_idIndexMarker819"/><span class="koboSpan" id="kobo.1148.1">avoid storing registry credentials in the application’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1149.1">.yaml</span></code><span class="koboSpan" id="kobo.1150.1"> file.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1151.1">First of all, we need the container registry resource ID. </span><span class="koboSpan" id="kobo.1151.2">We can get it with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1152.1">az acr show --name &lt;REGISTRY NAME&gt; --query id --output tsv
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1153.1">Then, we can assign the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1154.1">AcrPull</span></code><span class="koboSpan" id="kobo.1155.1"> role on our container registry to our identity with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1156.1">az role assignment create '
--assignee &lt;IDENTITY RESOURCE ID&gt; '
--role AcrPull '
--scope &lt;ACR_RESOURCE_ID&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1157.1">Finally, we must inform the application that it can use its system-assigned or user-assigned identity to access the registry:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1158.1">az containerapp registry set '
--name my-container-app '
--resource-group my-container-app-rg '
--server &lt;ACR_NAME&gt;.azurecr.io '
--identity system 🡨 system if system assigned or the id of the user defined identity
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1159.1">The last step can also be performed by adding an entry to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1160.1">registries</span></code><span class="koboSpan" id="kobo.1161.1"> section of the application’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1162.1">.yaml</span></code><span class="koboSpan" id="kobo.1163.1"> files, as shown here:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-bullet"><span class="koboSpan" id="kobo.1164.1">-</span></span> <span class="hljs-attr"><span class="koboSpan" id="kobo.1165.1">server:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1166.1">&lt;server</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1167.1">URL&gt;</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.1168.1">identity:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1169.1">&lt;application</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1170.1">identity</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1171.1">resource</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1172.1">id&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1173.1">We have finished our Azure Container Apps trip. </span><span class="koboSpan" id="kobo.1173.2">We will return to Azure Container Apps in </span><a href="Chapter_12.xhtml#_idTextAnchor345"><em class="italic"><span class="koboSpan" id="kobo.1174.1">Chapter 12</span></em></a><span class="koboSpan" id="kobo.1175.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1176.1">Simplifying Microservices with .NET Aspire</span></em><span class="koboSpan" id="kobo.1177.1">, where we will see how to automatically </span><a id="_idIndexMarker820"/><span class="koboSpan" id="kobo.1178.1">create all instructions to deploy a whole microservice application to Azure Container Apps, and we will use the book case study application as an example.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1179.1">Our description of Azure Container Apps is fundamentally complete and covers 95% of practical Azure </span><a id="_idIndexMarker821"/><span class="koboSpan" id="kobo.1180.1">Container Apps operativity. </span><span class="koboSpan" id="kobo.1180.2">More details can be found in the official documentation at </span><a href="https://learn.microsoft.com/en-us/azure/container-apps/"><span class="url"><span class="koboSpan" id="kobo.1181.1">https://learn.microsoft.com/en-us/azure/container-apps/</span></span></a><span class="koboSpan" id="kobo.1182.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1183.1">The next chapter focuses on the security and observability of the microservice application.</span></p>
<h1 class="heading-1" id="_idParaDest-198"><a id="_idTextAnchor293"/><span class="koboSpan" id="kobo.1184.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1185.1">This chapter described Kubernetes-related tools that facilitate the administration and coding of distributed applications and then focused on Azure Container Apps.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1186.1">We described the basic ideas behind the Azure Container Apps offering, including its fundamental concepts and principles. </span><span class="koboSpan" id="kobo.1186.2">Then, we described the available plans and how to interact with Azure Container Apps through the Azure portal.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1187.1">In particular, we described the main commands and the</span><code class="inlineCode"><span class="koboSpan" id="kobo.1188.1">.yaml</span></code><span class="koboSpan" id="kobo.1189.1"> format that defines a whole application. </span><span class="koboSpan" id="kobo.1189.2">We showed how all resources in Kubernetes are implemented in Azure Container Apps and compared the two approaches.</span></p>
<h1 class="heading-1" id="_idParaDest-199"><a id="_idTextAnchor294"/><span class="koboSpan" id="kobo.1190.1">Questions</span></h1>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1191.1">Is it true that environments are equivalent to Kubernetes namespaces?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1192.1">They are similar but not equivalent.</span></p>
<ol>
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.1193.1">How does Helm simplify the deployment of Kubernetes applications and tools?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1194.1">Because it allows the simultaneous deployment of several yaml files which can be configured according to selected options and parameters.</span></p>
<ol>
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.1195.1">What are Prometheus and Grafana?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1196.1">They’re administrative tools that collect metrics, and other information and present them to the user.</span></p>
<ol>
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.1197.1">Can you describe the URL composition of an Azure Container Apps application exposed to the external world?</span></li>
</ol>
<p class="normal-one"><code class="inlineCode"><span class="koboSpan" id="kobo.1198.1">&lt;application name&gt;.&lt;Environment name&gt;.&lt;zone&gt;.azurecontainerapps.io</span></code></p>
<ol>
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.1199.1">Do environments provide access to all properties of their underlying networks?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1200.1">No.</span></p>
<ol>
<li class="numberedList" value="6"><span class="koboSpan" id="kobo.1201.1">Which kinds of Azure identities can be associated with Azure Container Apps?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1202.1">User defined and System Assigned.</span></p>
<ol>
<li class="numberedList" value="7"><span class="koboSpan" id="kobo.1203.1">Is it true that, in Azure Container Apps, Azure file storage allocation is automatic (as in Kubernetes) and requires just the declaration of volumes in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1204.1">volumes</span></code><span class="koboSpan" id="kobo.1205.1"> section of the application’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1206.1">.yaml</span></code><span class="koboSpan" id="kobo.1207.1"> file?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1208.1">No.</span></p>
<ol>
<li class="numberedList" value="8"><span class="koboSpan" id="kobo.1209.1">Is it possible to deploy an Azure Container Apps application with a single Azure console command without filling in any configuration file?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1210.1">Yes, in several ways.</span></p>
<ol>
<li class="numberedList" value="9"><span class="koboSpan" id="kobo.1211.1">In which section of an Azure Container Apps </span><code class="inlineCode"><span class="koboSpan" id="kobo.1212.1">.yaml</span></code><span class="koboSpan" id="kobo.1213.1"> file can you define traffic splitting between revisions?</span></li>
</ol>
<p class="normal-one"><code class="inlineCode"><span class="koboSpan" id="kobo.1214.1">ingress-&gt;traffic</span></code></p>
<ol>
<li class="numberedList" value="10"><span class="koboSpan" id="kobo.1215.1">Can the port where an Azure Container Apps application listens to HTTP/S requests be customized?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.1216.1">No.</span></p>
<h1 class="heading-1" id="_idParaDest-200"><a id="_idTextAnchor295"/><span class="koboSpan" id="kobo.1217.1">Further reading</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1218.1">More information on Helm and Helm charts can be found in the official documentation. </span><span class="koboSpan" id="kobo.1218.2">This is extremely well written and contains some good tutorials: </span><a href="https://helm.sh/"><span class="url"><span class="koboSpan" id="kobo.1219.1">https://helm.sh/</span></span></a><span class="koboSpan" id="kobo.1220.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1221.1">Grafana dashboards: </span><a href="https://grafana.com/grafana/dashboards/"><span class="url"><span class="koboSpan" id="kobo.1222.1">https://grafana.com/grafana/dashboards/</span></span></a><span class="koboSpan" id="kobo.1223.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1224.1">ArgoCD: </span><a href="https://argo-cd.readthedocs.io/en/stable/"><span class="url"><span class="koboSpan" id="kobo.1225.1">https://argo-cd.readthedocs.io/en/stable/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1226.1">Rancher UI: </span><a href="https://ranchermanager.docs.rancher.com/ "><span class="url"><span class="koboSpan" id="kobo.1227.1">https://ranchermanager.docs.rancher.com/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1228.1">OpenShift: </span><a href="https://www.redhat.com/en/technologies/cloud-computing/openshift"><span class="url"><span class="koboSpan" id="kobo.1229.1">https://www.redhat.com/en/technologies/cloud-computing/openshift</span></span></a><span class="koboSpan" id="kobo.1230.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1231.1">Azure OpenShift: </span><a href="https://azure.microsoft.com/it-it/products/openshift"><span class="url"><span class="koboSpan" id="kobo.1232.1">https://azure.microsoft.com/it-it/products/openshift</span></span></a><span class="koboSpan" id="kobo.1233.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1234.1">Azure Container Apps pricing: </span><a href="https://azure.microsoft.com/en-us/pricing/details/container-apps/"><span class="url"><span class="koboSpan" id="kobo.1235.1">https://azure.microsoft.com/en-us/pricing/details/container-apps/</span></span></a><span class="url"><span class="koboSpan" id="kobo.1236.1">.</span></span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1237.1">Azure Container Apps custom profiles: </span><a href="https://learn.microsoft.com/en-us/azure/container-apps/workload-profiles-overview"><span class="url"><span class="koboSpan" id="kobo.1238.1">https://learn.microsoft.com/en-us/azure/container-apps/workload-profiles-overview</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1239.1">Azure Container Apps official documentation: </span><a href="https://learn.microsoft.com/en-us/azure/container-apps/"><span class="url"><span class="koboSpan" id="kobo.1240.1">https://learn.microsoft.com/en-us/azure/container-apps/</span></span></a><span class="koboSpan" id="kobo.1241.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1242.1">Azure Container Apps commands reference: </span><a href="https://learn.microsoft.com/it-it/cli/azure/containerapp?view=azure-cli-latest"><span class="url"><span class="koboSpan" id="kobo.1243.1">https://learn.microsoft.com/it-it/cli/azure/containerapp?view=azure-cli-latest</span></span></a><span class="koboSpan" id="kobo.1244.1">.</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-201"><a id="_idTextAnchor296"/><span class="koboSpan" id="kobo.1245.1">Join our community on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1246.1">Join our community’s Discord space for discussions with the author and other readers:</span></p>
<p class="normal"><a href="https://packt.link/PSMCSharp"><span class="url"><span class="koboSpan" id="kobo.1247.1">https://packt.link/PSMCSharp</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.1248.1"><img alt="A qr code with black squares  AI-generated content may be incorrect." src="../Images/B31916_Discord-QR-Code.png"/></span></p>
</div>
</body></html>