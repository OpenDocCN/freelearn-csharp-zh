<html><head></head><body>
<div id="_idContainer179">
<h1 class="chapter-number" id="_idParaDest-298"><a id="_idTextAnchor297"/><span class="koboSpan" id="kobo.1.1">14</span></h1>
<h1 id="_idParaDest-299"><a id="_idTextAnchor298"/><span class="koboSpan" id="kobo.2.1">Refactoring Code with Roslyn Analyzers</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In the last chapter, we saw how you can build Roslyn analyzers to flag issues in your code. </span><span class="koboSpan" id="kobo.3.2">In this chapter, we’ll improve our analyzers by giving them the ability to fix code issues by providing </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">Quick Actions</span></strong><span class="koboSpan" id="kobo.5.1"> the user can invoke to modify their source code. </span><span class="koboSpan" id="kobo.5.2">We’ll also discuss some additional ways of deploying Roslyn analyzers that improve your ability to provide a consistent experience to your </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">team members.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">This chapter covers </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.9.1">Building a Roslyn Analyzer </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">code fix</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Testing code fixes </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">with RoslynTestKit</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Publishing Roslyn analyzers as </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">NuGet packages</span></span></li>
</ul>
<h1 id="_idParaDest-300"><a id="_idTextAnchor299"/><span class="koboSpan" id="kobo.15.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.16.1">In this chapter, we’re starting right where we left off in </span><a href="B21324_13.xhtml#_idTextAnchor275"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.17.1">Chapter 13</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.18.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.19.1">The starting code for this chapter is available from GitHub at </span><a href="https://github.com/PacktPublishing/Refactoring-with-CSharp"><span class="koboSpan" id="kobo.20.1">https://github.com/PacktPublishing/Refactoring-with-CSharp</span></a><span class="koboSpan" id="kobo.21.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.22.1">Chapter14/Ch14BeginningCode</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.23.1"> folder.</span></span></p>
<h1 id="_idParaDest-301"><a id="_idTextAnchor300"/><span class="koboSpan" id="kobo.24.1">Case study – Cloudy Skies Airlines</span></h1>
<p><span class="koboSpan" id="kobo.25.1">In </span><a href="B21324_13.xhtml#_idTextAnchor275"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.26.1">Chapter 13</span></em></span></a><span class="koboSpan" id="kobo.27.1">, we </span><a id="_idIndexMarker830"/><span class="koboSpan" id="kobo.28.1">built a </span><strong class="source-inline"><span class="koboSpan" id="kobo.29.1">ToStringAnalyzer</span></strong><span class="koboSpan" id="kobo.30.1"> that detects classes that do not override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.31.1">ToString</span></strong><span class="koboSpan" id="kobo.32.1"> method. </span><span class="koboSpan" id="kobo.32.2">This results in suggestions in the Visual Studio editor and a message in the </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">error list.</span></span></p>
<p><span class="koboSpan" id="kobo.34.1">Cloudy Skies Airlines has deployed this internally and found it to be generally helpful, but there are a few things that </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">need improvement:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.36.1">Although violations of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.37.1">ToString</span></strong><span class="koboSpan" id="kobo.38.1"> override rule are flagged by the analyzer, not every developer is addressing this issue. </span><span class="koboSpan" id="kobo.38.2">When discussed internally, some developers stated they didn’t want to take the time to address it. </span><span class="koboSpan" id="kobo.38.3">Additionally, some of the newer developers didn’t fully understand the rule or what fixing it would </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">look like.</span></span></li>
<li><span class="koboSpan" id="kobo.40.1">Whenever a new analyzer is created or a bug in an existing analyzer is addressed, a new VSIX file must be created. </span><span class="koboSpan" id="kobo.40.2">Developers then need to download and install it to get the updated version. </span><span class="koboSpan" id="kobo.40.3">Because of this, it’s hard for the team to know which developers have the analyzer installed or which version each developer </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">is using.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.42.1">In this chapter, we’ll address these concerns. </span><span class="koboSpan" id="kobo.42.2">We’ll look at creating and testing a code fix provider that can automatically resolve detected issues. </span><span class="koboSpan" id="kobo.42.3">After that, we’ll explore publishing analyzers </span><a id="_idIndexMarker831"/><span class="koboSpan" id="kobo.43.1">via </span><strong class="bold"><span class="koboSpan" id="kobo.44.1">NuGet packages</span></strong><span class="koboSpan" id="kobo.45.1"> and show how they</span><a id="_idIndexMarker832"/><span class="koboSpan" id="kobo.46.1"> can help your team have a consistent </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">analyzer experience.</span></span></p>
<h1 id="_idParaDest-302"><a id="_idTextAnchor301"/><span class="koboSpan" id="kobo.48.1">Building a Roslyn Analyzer code fix</span></h1>
<p><span class="koboSpan" id="kobo.49.1">Roslyn Analyzers </span><a id="_idIndexMarker833"/><span class="koboSpan" id="kobo.50.1">allow you to provide options for users to automatically fix issues your analyzers detect in your code. </span><span class="koboSpan" id="kobo.50.2">They do this through something </span><a id="_idIndexMarker834"/><span class="koboSpan" id="kobo.51.1">called a </span><strong class="bold"><span class="koboSpan" id="kobo.52.1">code fix provider</span></strong><span class="koboSpan" id="kobo.53.1">, which can modify your document in an automated manner to resolve the </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">diagnostic warning.</span></span></p>
<p><span class="koboSpan" id="kobo.55.1">Think of it this way: diagnostic analyzers, like our </span><strong class="source-inline"><span class="koboSpan" id="kobo.56.1">OverrideToStringAnalyzer</span></strong><span class="koboSpan" id="kobo.57.1">, help </span><em class="italic"><span class="koboSpan" id="kobo.58.1">detect</span></em><span class="koboSpan" id="kobo.59.1"> issues in your team’s code. </span><span class="koboSpan" id="kobo.59.2">On the other hand, code fix providers give you a way of </span><em class="italic"><span class="koboSpan" id="kobo.60.1">fixing</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.61.1">these issues.</span></span></p>
<p><span class="koboSpan" id="kobo.62.1">Not all diagnostic analyzers will have code-fix providers, but in my experience, those that also provide code-fix providers tend to get addressed earlier and </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">more consistently.</span></span></p>
<p><span class="koboSpan" id="kobo.64.1">Let’s see how </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">one works.</span></span></p>
<h2 id="_idParaDest-303"><a id="_idTextAnchor302"/><span class="koboSpan" id="kobo.66.1">Creating a CodeFixProvider</span></h2>
<p><span class="koboSpan" id="kobo.67.1">First, we’ll add a new </span><a id="_idIndexMarker835"/><span class="koboSpan" id="kobo.68.1">class to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.69.1">Packt.Analyzers</span></strong><span class="koboSpan" id="kobo.70.1"> class </span><a id="_idIndexMarker836"/><span class="koboSpan" id="kobo.71.1">library. </span><span class="koboSpan" id="kobo.71.2">We’ll call this class </span><strong class="source-inline"><span class="koboSpan" id="kobo.72.1">ToStringCodeFix</span></strong><span class="koboSpan" id="kobo.73.1">. </span><span class="koboSpan" id="kobo.73.2">Replace its contents with the following code for a basic </span><span class="No-Break"><span class="koboSpan" id="kobo.74.1">code fix:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.75.1">
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CodeActions;
using Microsoft.CodeAnalysis.CodeFixes;
using Microsoft.CodeAnalysis.CSharp;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using Microsoft.CodeAnalysis.Text;
using System.Collections.Immutable;
using System.Composition;
using System.Linq;
using System.Threading.Tasks;
namespace Packt.Analyzers {
</span><strong class="bold"><span class="koboSpan" id="kobo.76.1">  [Shared]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.77.1">  [ExportCodeFixProvider(LanguageNames.CSharp,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.78.1">    Name = nameof(ToStringCodeFix))]</span></strong><span class="koboSpan" id="kobo.79.1">
  public class </span><strong class="bold"><span class="koboSpan" id="kobo.80.1">ToStringCodeFix : CodeFixProvider</span></strong><span class="koboSpan" id="kobo.81.1"> {
    public override ImmutableArray&lt;string&gt;
      </span><strong class="bold"><span class="koboSpan" id="kobo.82.1">FixableDiagnosticIds</span></strong><span class="koboSpan" id="kobo.83.1"> =&gt;
        ImmutableArray.Create(ToStringAnalyzer.Rule.Id);
    public override FixAllProvider </span><strong class="bold"><span class="koboSpan" id="kobo.84.1">GetFixAllProvider</span></strong><span class="koboSpan" id="kobo.85.1">()
      =&gt; WellKnownFixAllProviders.BatchFixer;
    public async override Task </span><strong class="bold"><span class="koboSpan" id="kobo.86.1">RegisterCodeFixesAsync</span></strong><span class="koboSpan" id="kobo.87.1">(
      CodeFixContext context) {
      throw new NotImplementedException();
    }
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.88.1">This is the minimum amount of code we need in order to have a compiling code fix provider. </span><span class="koboSpan" id="kobo.88.2">Before we build out the rest of this class, let’s examine what’s </span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">here already.</span></span></p>
<p><span class="koboSpan" id="kobo.90.1">First, we’re declaring a </span><strong class="source-inline"><span class="koboSpan" id="kobo.91.1">ToStringCodeFix</span></strong><span class="koboSpan" id="kobo.92.1"> class that inherits from </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">CodeFixProvider</span></strong><span class="koboSpan" id="kobo.94.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">CodeFixProvider</span></strong><span class="koboSpan" id="kobo.96.1"> is the abstract class used for providing a fix for one or </span><span class="No-Break"><span class="koboSpan" id="kobo.97.1">more diagnostics.</span></span></p>
<p><span class="koboSpan" id="kobo.98.1">Note that we named our code fix </span><strong class="source-inline"><span class="koboSpan" id="kobo.99.1">ToStringCodeFix</span></strong><span class="koboSpan" id="kobo.100.1"> to pair with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.101.1">ToStringAnalyzer</span></strong><span class="koboSpan" id="kobo.102.1"> class it provides a code fix for. </span><span class="koboSpan" id="kobo.102.2">This is a convention I like to follow to help clearly associate analyzers and their </span><span class="No-Break"><span class="koboSpan" id="kobo.103.1">code fixes.</span></span></p>
<p><span class="koboSpan" id="kobo.104.1">The class has two attributes assigned </span><span class="No-Break"><span class="koboSpan" id="kobo.105.1">to it:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.106.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.107.1">ExportCodeFixProviderAttribute</span></strong><span class="koboSpan" id="kobo.108.1"> tells Roslyn that the class represents a code fix, what the name of the code fix is, and the languages the code fix </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">applies to</span></span></li>
<li><span class="koboSpan" id="kobo.110.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">SharedAttribute</span></strong><span class="koboSpan" id="kobo.112.1"> doesn’t do anything on its own, but it is needed for Roslyn to be comfortable registering your code fix in </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">Visual Studio</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.114.1">These two attributes </span><a id="_idIndexMarker837"/><span class="koboSpan" id="kobo.115.1">should be on every code fix you </span><a id="_idIndexMarker838"/><span class="koboSpan" id="kobo.116.1">create. </span><span class="koboSpan" id="kobo.116.2">Failing to use them will result in your code fix provider not appearing for some users (don’t ask me how </span><span class="No-Break"><span class="koboSpan" id="kobo.117.1">I know).</span></span></p>
<p><span class="koboSpan" id="kobo.118.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.119.1">ToStringCodeFix</span></strong><span class="koboSpan" id="kobo.120.1"> class has three members at </span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">the moment:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.122.1">FixableDiagnosticIds</span></strong><span class="koboSpan" id="kobo.123.1">: This lists the unique identifier of all analyzer rules this code fix can provide solutions to. </span><span class="koboSpan" id="kobo.123.2">In our case, this uses the ID of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.124.1">ToStringAnalyzer</span></strong><span class="koboSpan" id="kobo.125.1"> rule, meaning it says it can fix </span><span class="No-Break"><span class="koboSpan" id="kobo.126.1">that issue.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.127.1">GetFixAllProvider</span></strong><span class="koboSpan" id="kobo.128.1">: By default, code fixes don’t support the “fix-all” functionality in Visual Studio. </span><span class="koboSpan" id="kobo.128.2">By overriding this method and returning </span><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">WellKnownFixAllProviders.BatchFixer</span></strong><span class="koboSpan" id="kobo.130.1">, we tell Visual Studio to allow the user to try to fix all issues of that type in the file, project, or </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">even solution.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.132.1">RegisterCodeFixesAsync</span></strong><span class="koboSpan" id="kobo.133.1">: This is where we can register our code fix and tell Visual Studio what to do if the user chooses to </span><span class="No-Break"><span class="koboSpan" id="kobo.134.1">apply it.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.135.1">The bulk of our</span><a id="_idIndexMarker839"/><span class="koboSpan" id="kobo.136.1"> logic</span><a id="_idIndexMarker840"/><span class="koboSpan" id="kobo.137.1"> will be in </span><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">RegisterCodeFixesAsync</span></strong><span class="koboSpan" id="kobo.139.1">, so let’s implement that </span><span class="No-Break"><span class="koboSpan" id="kobo.140.1">method now.</span></span></p>
<h2 id="_idParaDest-304"><a id="_idTextAnchor303"/><span class="koboSpan" id="kobo.141.1">Registering a code fix</span></h2>
<p><span class="koboSpan" id="kobo.142.1">The job of </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">RegisterCodeFixesAsync</span></strong><span class="koboSpan" id="kobo.144.1"> is to interpret code that violates the diagnostic rule we’ve</span><a id="_idIndexMarker841"/><span class="koboSpan" id="kobo.145.1"> set up and register an action that will let the user </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">fix it.</span></span></p>
<p><span class="koboSpan" id="kobo.147.1">The code to do this is fairly involved, so let’s look at parts of it at a time. </span><span class="koboSpan" id="kobo.147.2">The first part has to do with interpreting where in the document the diagnostic </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">violation occurred:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.149.1">
public async override Task RegisterCodeFixesAsync(
  CodeFixContext context) {
  Diagnostic diagnostic = context.Diagnostics.First();
  TextSpan span = diagnostic.Location.SourceSpan;
  Document doc = context.Document;</span></pre>
<p><span class="koboSpan" id="kobo.150.1">Here, we get a </span><strong class="source-inline"><span class="koboSpan" id="kobo.151.1">CodeFixContext</span></strong><span class="koboSpan" id="kobo.152.1"> object that contains information about the code analysis </span><span class="No-Break"><span class="koboSpan" id="kobo.153.1">diagnostic violations.</span></span></p>
<p><span class="koboSpan" id="kobo.154.1">These </span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">Diagnostic</span></strong><span class="koboSpan" id="kobo.156.1"> objects contain information about the exact span of text within the document that triggered the rule. </span><span class="koboSpan" id="kobo.156.2">In our case, this should be the text for the name of the class that doesn’t </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">override </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.158.1">ToString</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.160.1">Next, we get a reference to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">Document</span></strong><span class="koboSpan" id="kobo.162.1"> containing the violation. </span><span class="koboSpan" id="kobo.162.2">Think of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">Document</span></strong><span class="koboSpan" id="kobo.164.1"> as a file of source code somewhere in your solution. </span><span class="koboSpan" id="kobo.164.2">It’s possible to have analyzers and code fixes that look over your entire solution, so this </span><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">Document</span></strong><span class="koboSpan" id="kobo.166.1"> helps narrow down the scope to the file containing the </span><span class="No-Break"><span class="koboSpan" id="kobo.167.1">offending code.</span></span></p>
<p><span class="koboSpan" id="kobo.168.1">With this </span><strong class="source-inline"><span class="koboSpan" id="kobo.169.1">Document</span></strong><span class="koboSpan" id="kobo.170.1">, we can gain access to the syntax tree and its </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.171.1">type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.172.1"> declarations:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.173.1">
  SyntaxNode root = await doc
    .GetSyntaxRootAsync(context.CancellationToken)
    .ConfigureAwait(false);
  TypeDeclarationSyntax typeDec =
    root.FindToken(</span><strong class="bold"><span class="koboSpan" id="kobo.174.1">span.Start</span></strong><span class="koboSpan" id="kobo.175.1">)
        .Parent
        .AncestorsAndSelf()
        </span><strong class="bold"><span class="koboSpan" id="kobo.176.1">.OfType&lt;TypeDeclarationSyntax&gt;()</span></strong><span class="koboSpan" id="kobo.177.1">
        .First();</span></pre>
<p><span class="koboSpan" id="kobo.178.1">Here, we’re getting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">SyntaxRoot</span></strong><span class="koboSpan" id="kobo.180.1"> element representing the base of our document and then finding the declaration of the class by the location of that span of text within </span><span class="No-Break"><span class="koboSpan" id="kobo.181.1">the document.</span></span></p>
<p><span class="koboSpan" id="kobo.182.1">This lets us jump from the raw text we had in the span to an object representing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.183.1">Type</span></strong><span class="koboSpan" id="kobo.184.1"> declaration. </span><span class="koboSpan" id="kobo.184.2">Having this object allows us to make changes and provide </span><span class="No-Break"><span class="koboSpan" id="kobo.185.1">a fix.</span></span></p>
<p><span class="koboSpan" id="kobo.186.1">The final portion of the </span><a id="_idIndexMarker842"/><span class="koboSpan" id="kobo.187.1">method registers the code action to fix </span><span class="No-Break"><span class="koboSpan" id="kobo.188.1">the issue:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.189.1">
  CodeAction fix = CodeAction.Create(
    title: "Override ToString",
    createChangedDocument: c =&gt; </span><strong class="bold"><span class="koboSpan" id="kobo.190.1">FixAsync(doc, typeDec)</span></strong><span class="koboSpan" id="kobo.191.1">
  );
  </span><strong class="bold"><span class="koboSpan" id="kobo.192.1">context.RegisterCodeFix(fix, diagnostic);</span></strong><span class="koboSpan" id="kobo.193.1">
}</span></pre>
<p><span class="koboSpan" id="kobo.194.1">This code creates a </span><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">CodeAction</span></strong><span class="koboSpan" id="kobo.196.1"> and registers it as a fix for the diagnostic rule. </span><span class="koboSpan" id="kobo.196.2">This fix has a title representing the text the user will see in the </span><strong class="bold"><span class="koboSpan" id="kobo.197.1">Quick Actions</span></strong><span class="koboSpan" id="kobo.198.1"> menu when making the fix and an action to invoke when the user is attempting to invoke the code fix. </span><span class="koboSpan" id="kobo.198.2">In this case, the code fix invokes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">FixAsync</span></strong><span class="koboSpan" id="kobo.200.1"> method we’ve yet </span><span class="No-Break"><span class="koboSpan" id="kobo.201.1">to see.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.202.1">Additional options</span></p>
<p class="callout"><span class="koboSpan" id="kobo.203.1">There are several overloads and optional parameters to </span><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">CodeAction.Create</span></strong><span class="koboSpan" id="kobo.205.1"> that let you change the entire solution instead of a single document or resolve conflicts when multiple code fixes have the </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">same title.</span></span></p>
<p><span class="koboSpan" id="kobo.207.1">Now that we’ve </span><a id="_idIndexMarker843"/><span class="koboSpan" id="kobo.208.1">registered our code fix, let’s see how the fix </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">action works.</span></span></p>
<h2 id="_idParaDest-305"><a id="_idTextAnchor304"/><span class="koboSpan" id="kobo.210.1">Modifying the document with a code fix</span></h2>
<p><span class="koboSpan" id="kobo.211.1">The final step in implementing</span><a id="_idIndexMarker844"/><span class="koboSpan" id="kobo.212.1"> our code fix is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">FixAsync</span></strong><span class="koboSpan" id="kobo.214.1"> method. </span><span class="koboSpan" id="kobo.214.2">This method’s job is to modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">Document</span></strong><span class="koboSpan" id="kobo.216.1"> so that it no longer violates the </span><span class="No-Break"><span class="koboSpan" id="kobo.217.1">diagnostic rule.</span></span></p>
<p><span class="koboSpan" id="kobo.218.1">In our case, the fix will be to generate code such </span><span class="No-Break"><span class="koboSpan" id="kobo.219.1">as this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.220.1">
public override string ToString()
{
  throw new NotImplementedException();
}</span></pre>
<p><span class="koboSpan" id="kobo.221.1">Sadly, it’s a lot easier to write the raw C# here than it is to build it with the </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">Roslyn API.</span></span></p>
<p><span class="koboSpan" id="kobo.223.1">To add this with Roslyn, we’ll follow </span><span class="No-Break"><span class="koboSpan" id="kobo.224.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.225.1">Create a method body that throws </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">a </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.227.1">NotImplementedException</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.229.1">Create a list of modifiers that go with the method (</span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">public</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.231.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">override</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.233.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.234.1">Create a method declaration with the appropriate name and return type and make sure this method has the list of modifiers and the </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">method body.</span></span></li>
<li><span class="koboSpan" id="kobo.236.1">Create a version of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.237.1">Type</span></strong><span class="koboSpan" id="kobo.238.1"> declaration that has the </span><span class="No-Break"><span class="koboSpan" id="kobo.239.1">new method.</span></span></li>
<li><span class="koboSpan" id="kobo.240.1">Find the </span><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">Type</span></strong><span class="koboSpan" id="kobo.242.1"> declaration in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">Document</span></strong><span class="koboSpan" id="kobo.244.1"> and replace it with our </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">new one.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.246.1">Let’s see how this works, starting with the code that declares the new </span><span class="No-Break"><span class="koboSpan" id="kobo.247.1">method body:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.248.1">
private Task&lt;Document&gt; FixAsync(Document doc,
  TypeDeclarationSyntax typeDec) {
  const string exType = "NotImplementedException";
  IdentifierNameSyntax exId =
    SyntaxFactory.IdentifierName(exType);
  BlockSyntax methodBody = SyntaxFactory.Block(
    SyntaxFactory.ThrowStatement(
      SyntaxFactory.ObjectCreationExpression(exId)
        .WithArgumentList(SyntaxFactory.ArgumentList())
    )
  );</span></pre>
<p><span class="koboSpan" id="kobo.249.1">As you can see, the code to declare anything in Roslyn can get a bit dense. </span><span class="koboSpan" id="kobo.249.2">When you take a step back, though, this code is just declaring a method block that instantiates and throws </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">a </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">NotImplementedException</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.252.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.253.1">Next, we’ll define</span><a id="_idIndexMarker845"/><span class="koboSpan" id="kobo.254.1"> the method definition that uses this </span><span class="No-Break"><span class="koboSpan" id="kobo.255.1">method body:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.256.1">
  SyntaxToken[] modifiers = new SyntaxToken[] {
    SyntaxFactory.Token(SyntaxKind.PublicKeyword),
    SyntaxFactory.Token(SyntaxKind.OverrideKeyword)
  };
  SyntaxToken returnType =
    SyntaxFactory.Token(SyntaxKind.StringKeyword);
  MethodDeclarationSyntax newMethod =
    SyntaxFactory.MethodDeclaration(
      SyntaxFactory.PredefinedType(returnType),
      SyntaxFactory.Identifier("ToString")
    )
    .WithModifiers(SyntaxFactory.TokenList(modifiers))
    .WithBody(methodBody);</span></pre>
<p><span class="koboSpan" id="kobo.257.1">This code is almost as dense as the last block, but all it really does is declare the method. </span><span class="koboSpan" id="kobo.257.2">This method brings together a return type of </span><strong class="source-inline"><span class="koboSpan" id="kobo.258.1">string</span></strong><span class="koboSpan" id="kobo.259.1">, a name of </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">ToString</span></strong><span class="koboSpan" id="kobo.261.1">, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">public</span></strong><span class="koboSpan" id="kobo.263.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">override</span></strong><span class="koboSpan" id="kobo.265.1"> modifiers, and the body we declared in the </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">previous block.</span></span></p>
<p><span class="koboSpan" id="kobo.267.1">The final step in the fix is to modify the editor’s code with our code fix. </span><span class="koboSpan" id="kobo.267.2">We do this with the </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.269.1">
  TypeDeclarationSyntax newType =
    </span><strong class="bold"><span class="koboSpan" id="kobo.270.1">typeDec.AddMembers(newMethod)</span></strong><span class="koboSpan" id="kobo.271.1">;
  SyntaxNode root = typeDec.SyntaxTree.GetRoot();
  SyntaxNode newRoot = </span><strong class="bold"><span class="koboSpan" id="kobo.272.1">root.ReplaceNode(typeDec, newType)</span></strong><span class="koboSpan" id="kobo.273.1">;
  Document newDoc = </span><strong class="bold"><span class="koboSpan" id="kobo.274.1">doc.WithSyntaxRoot(newRoot)</span></strong><span class="koboSpan" id="kobo.275.1">;
  return Task.FromResult(newDoc);
}</span></pre>
<p><span class="koboSpan" id="kobo.276.1">This code creates a new version of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">Type</span></strong><span class="koboSpan" id="kobo.278.1"> declaration that has our new method. </span><span class="koboSpan" id="kobo.278.2">We then find the old </span><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">Type</span></strong><span class="koboSpan" id="kobo.280.1"> declaration in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">Document</span></strong><span class="koboSpan" id="kobo.282.1"> and replace it with the new one. </span><span class="koboSpan" id="kobo.282.2">This creates a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.283.1">Document</span></strong><span class="koboSpan" id="kobo.284.1"> that we then return from our code fix, and Visual Studio updates our </span><span class="No-Break"><span class="koboSpan" id="kobo.285.1">code</span></span><span class="No-Break"><a id="_idIndexMarker846"/></span><span class="No-Break"><span class="koboSpan" id="kobo.286.1"> accordingly.</span></span></p>
<p><span class="koboSpan" id="kobo.287.1">With that, we now have a working code fix. </span><span class="koboSpan" id="kobo.287.2">How do we know it’s working? </span><span class="koboSpan" id="kobo.287.3">We </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">test it!</span></span></p>
<h1 id="_idParaDest-306"><a id="_idTextAnchor305"/><span class="koboSpan" id="kobo.289.1">Testing Code Fixes with RoslynTestKit</span></h1>
<p><span class="koboSpan" id="kobo.290.1">In </span><a href="B21324_13.xhtml#_idTextAnchor275"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.291.1">Chapter 13</span></em></span></a><span class="koboSpan" id="kobo.292.1">, we </span><a id="_idIndexMarker847"/><span class="koboSpan" id="kobo.293.1">saw how the </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">RoslynTestKit</span></strong><span class="koboSpan" id="kobo.295.1"> library </span><a id="_idIndexMarker848"/><span class="koboSpan" id="kobo.296.1">helps your diagnostic analyzers flag code issues appropriately. </span><span class="koboSpan" id="kobo.296.2">In this chapter, we’ll revisit the library to verify our new </span><span class="No-Break"><span class="koboSpan" id="kobo.297.1">code fix.</span></span></p>
<p><span class="koboSpan" id="kobo.298.1">We will start by creating a new class in our test project named </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">ToStringCodeFixTests</span></strong><span class="koboSpan" id="kobo.300.1"> due to our common </span><span class="No-Break"><span class="koboSpan" id="kobo.301.1">naming conventions.</span></span></p>
<p><span class="koboSpan" id="kobo.302.1">This class will start by declaring a test fixture like it did with </span><span class="No-Break"><span class="koboSpan" id="kobo.303.1">the analyzer:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.304.1">
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CodeFixes;
using Microsoft.CodeAnalysis.Diagnostics;
using RoslynTestKit;
namespace Packt.Analyzers.Tests;
public class </span><strong class="bold"><span class="koboSpan" id="kobo.305.1">ToStringCodeFixTests : CodeFixTestFixture</span></strong><span class="koboSpan" id="kobo.306.1"> {
 protected override string LanguageName
   =&gt; LanguageNames.CSharp;
 protected override CodeFixProvider </span><strong class="bold"><span class="koboSpan" id="kobo.307.1">CreateProvider</span></strong><span class="koboSpan" id="kobo.308.1">()
   =&gt; </span><strong class="bold"><span class="koboSpan" id="kobo.309.1">new ToStringCodeFix();</span></strong><span class="koboSpan" id="kobo.310.1">
 protected override IReadOnlyCollection&lt;DiagnosticAnalyzer&gt;
   </span><strong class="bold"><span class="koboSpan" id="kobo.311.1">CreateAdditionalAnalyzers</span></strong><span class="koboSpan" id="kobo.312.1">()
   =&gt; new[] { </span><strong class="bold"><span class="koboSpan" id="kobo.313.1">new ToStringAnalyzer()</span></strong><span class="koboSpan" id="kobo.314.1"> };</span></pre>
<p><span class="koboSpan" id="kobo.315.1">Like before, our test class inherits from a test fixture, but this time it’s a </span><strong class="source-inline"><span class="koboSpan" id="kobo.316.1">CodeFixTestFixture</span></strong><span class="koboSpan" id="kobo.317.1"> since we’re testing a </span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">code fix.</span></span></p>
<p><span class="koboSpan" id="kobo.319.1">Also like before, we need to specify that our code fix affects the C# programming language and provide a reference to our class through the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">CreateProvider</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.321.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.322.1">Unlike before, we also need to provide the code analyzer we’re testing through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">CreateAdditionalAnalyzers</span></strong><span class="koboSpan" id="kobo.324.1"> method. </span><span class="koboSpan" id="kobo.324.2">The compiler will allow you to not override this method, but if you forget to do so, your analyzer will never trigger in the steps ahead, so be sure to include your </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">analyzer here.</span></span></p>
<p><span class="koboSpan" id="kobo.326.1">Next, we test our</span><a id="_idIndexMarker849"/><span class="koboSpan" id="kobo.327.1"> code</span><a id="_idIndexMarker850"/><span class="koboSpan" id="kobo.328.1"> fix by providing a block of bad code and a block of good code and verifying that the code fix successfully moves from the bad code to the </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">good code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.330.1">
  public const string BadCode = @"
using System;
public class </span><strong class="bold"><span class="koboSpan" id="kobo.331.1">[|Flight|]</span></strong><span class="koboSpan" id="kobo.332.1">
{
    public string Id {get; set;}
    public string DepartAirport {get; set;}
    public string ArriveAirport {get; set;}
}";
  public const string GoodCode = @"
using System;
public class Flight
{
    public string Id {get; set;}
    public string DepartAirport {get; set;}
    public string ArriveAirport {get; set;}
</span><strong class="bold"><span class="koboSpan" id="kobo.333.1">    public override string ToString()</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.334.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.335.1">        throw new NotImplementedException();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.336.1">    }</span></strong><span class="koboSpan" id="kobo.337.1">
}";
  [Fact]
  public void CodeFixShouldMoveBadCodeToGood() {
    string ruleId = ToStringAnalyzer.Rule.Id;
    </span><strong class="bold"><span class="koboSpan" id="kobo.338.1">TestCodeFix(BadCode, GoodCode, ruleId)</span></strong><span class="koboSpan" id="kobo.339.1">;
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.340.1">This code should </span><a id="_idIndexMarker851"/><span class="koboSpan" id="kobo.341.1">be </span><a id="_idIndexMarker852"/><span class="koboSpan" id="kobo.342.1">somewhat familiar from the last chapter. </span><span class="koboSpan" id="kobo.342.2">Just like with analyzers, we need to denote the location the fix is triggered from using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.343.1">[|</span></strong><span class="koboSpan" id="kobo.344.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">|]</span></strong><span class="koboSpan" id="kobo.346.1"> markers as we see </span><span class="No-Break"><span class="koboSpan" id="kobo.347.1">on </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">[|Flight|]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.349.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.350.1">The actual verification step occurs through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">TestCodeFix</span></strong><span class="koboSpan" id="kobo.352.1"> method call. </span><span class="koboSpan" id="kobo.352.2">This method call will convert your bad code to a new form using the code fix and then compare that result to the expected </span><span class="No-Break"><span class="koboSpan" id="kobo.353.1">good code.</span></span></p>
<p><span class="koboSpan" id="kobo.354.1">This comparison is very sensitive, and any extra space, line breaks, or differences at all will result in a failing test with the observed differences between the two strings highlighted, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.355.1">Figure 14</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.356.1">.1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer172">
<span class="koboSpan" id="kobo.358.1"><img alt="Figure 14.1 – A test failure showing a string difference due to styling choices" src="image/B21324_14_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.359.1">Figure 14.1 – A test failure showing a string difference due to styling choices</span></p>
<p><span class="koboSpan" id="kobo.360.1">Assuming your formatting is consistent, your test should now pass, proving you have a good </span><span class="No-Break"><span class="koboSpan" id="kobo.361.1">code fix.</span></span></p>
<p><span class="koboSpan" id="kobo.362.1">If you want, you can now launch your VSIX extension project and verify the code fix in Visual Studio. </span><span class="koboSpan" id="kobo.362.2">After that, you could share the VSIX file with colleagues or people in the .NET community and they’d have access to your analyzer and </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">its fix.</span></span></p>
<p><span class="koboSpan" id="kobo.364.1">However, VSIX </span><a id="_idIndexMarker853"/><span class="koboSpan" id="kobo.365.1">deployment </span><a id="_idIndexMarker854"/><span class="koboSpan" id="kobo.366.1">has some downsides as we’ll soon see. </span><span class="koboSpan" id="kobo.366.2">Let’s close the chapter by looking at using NuGet packages to share your code fixes in a more </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">controlled manner.</span></span></p>
<h1 id="_idParaDest-307"><a id="_idTextAnchor306"/><span class="koboSpan" id="kobo.368.1">Publishing Roslyn Analyzers as NuGet packages</span></h1>
<p><span class="koboSpan" id="kobo.369.1">Using VSIX files</span><a id="_idIndexMarker855"/><span class="koboSpan" id="kobo.370.1"> to share code analyzers works, but isn’t</span><a id="_idIndexMarker856"/><span class="koboSpan" id="kobo.371.1"> an </span><span class="No-Break"><span class="koboSpan" id="kobo.372.1">ideal solution.</span></span></p>
<p><span class="koboSpan" id="kobo.373.1">Since VSIX files must be manually installed and updated, this means that with a team of software engineers, you’re never sure who has the extension installed at all or who is on which version of </span><span class="No-Break"><span class="koboSpan" id="kobo.374.1">the extension.</span></span></p>
<p><span class="koboSpan" id="kobo.375.1">Because each developer must install the VSIX themselves and keep it updated, this makes it harder to onboard new team members, release new analyzers or code fixes, or issue patches for issues found in your </span><span class="No-Break"><span class="koboSpan" id="kobo.376.1">existing analyzers.</span></span></p>
<p><span class="koboSpan" id="kobo.377.1">Thankfully, there’s a better option: </span><em class="italic"><span class="koboSpan" id="kobo.378.1">NuGet </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.379.1">package deployment</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.380.1">.</span></span></p>
<h2 id="_idParaDest-308"><a id="_idTextAnchor307"/><span class="koboSpan" id="kobo.381.1">Understanding NuGet package deployment</span></h2>
<p><span class="koboSpan" id="kobo.382.1">Analyzers and code fixes</span><a id="_idIndexMarker857"/><span class="koboSpan" id="kobo.383.1"> can be packed into NuGet packages and deployed to a NuGet feed so others can find them. </span><span class="koboSpan" id="kobo.383.2">Once in a NuGet feed, any developer on the team can install the package into one or </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">more projects.</span></span></p>
<p><span class="koboSpan" id="kobo.385.1">Once a NuGet package is installed, any developer who opens the project will automatically have the package downloaded through the largely invisible NuGet package restore step. </span><span class="koboSpan" id="kobo.385.2">If you install a NuGet package and then add, commit, and push the change, other developers will see it automatically installed when they pull your changes and open the project in </span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">Visual Studio.</span></span></p>
<p><span class="koboSpan" id="kobo.387.1">This means that only one developer on your team needs to install any NuGet package, including a package containing Roslyn Analyzers. </span><span class="koboSpan" id="kobo.387.2">Additionally, if you ever need to update the package to include new analyzers, any developer on the team can update the version of the package that </span><span class="No-Break"><span class="koboSpan" id="kobo.388.1">is installed.</span></span></p>
<p><span class="koboSpan" id="kobo.389.1">By using NuGet package deployment for Roslyn Analyzers, your </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">analyzers become:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.391.1">Easy </span><span class="No-Break"><span class="koboSpan" id="kobo.392.1">to install</span></span></li>
<li><span class="koboSpan" id="kobo.393.1">Easy </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">to update</span></span></li>
<li><span class="koboSpan" id="kobo.395.1">Consistently available across all developers on </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">the team</span></span></li>
<li><span class="koboSpan" id="kobo.397.1">Intentionally associated with </span><span class="No-Break"><span class="koboSpan" id="kobo.398.1">the project</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.399.1">That last point is an interesting one. </span><span class="koboSpan" id="kobo.399.2">With VSIX deployment, analyzers apply to any code that a developer opens on their machine. </span><span class="koboSpan" id="kobo.399.3">There is no formal link between the analyzer and your team’s source code, but if a developer has a VSIX analyzer installed, they’ll see </span><span class="No-Break"><span class="koboSpan" id="kobo.400.1">its recommendations.</span></span></p>
<p><span class="koboSpan" id="kobo.401.1">With NuGet packages, you’re explicit about which analyzers should analyze which projects because you explicitly associate them via the NuGet install process. </span><span class="koboSpan" id="kobo.401.2">This means that you can look at any project in your solution and get a sense of what analyzer rules should apply for all developers on your project, which is very hard to accomplish through </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">VSIX deployment.</span></span></p>
<p><span class="koboSpan" id="kobo.403.1">Because of these things, I strongly recommend deploying your analyzers and code fixes as </span><span class="No-Break"><span class="koboSpan" id="kobo.404.1">NuGet packages.</span></span></p>
<p><span class="koboSpan" id="kobo.405.1">Let’s see how </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">that’s done.</span></span></p>
<h2 id="_idParaDest-309"><a id="_idTextAnchor308"/><span class="koboSpan" id="kobo.407.1">Building a NuGet package</span></h2>
<p><span class="koboSpan" id="kobo.408.1">Visual Studio gives you an easy</span><a id="_idIndexMarker858"/><span class="koboSpan" id="kobo.409.1"> way of packaging most .NET projects: just right-click on a project in </span><strong class="bold"><span class="koboSpan" id="kobo.410.1">Solution Explorer</span></strong><span class="koboSpan" id="kobo.411.1">, select </span><strong class="bold"><span class="koboSpan" id="kobo.412.1">Properties</span></strong><span class="koboSpan" id="kobo.413.1">, and then find the </span><strong class="bold"><span class="koboSpan" id="kobo.414.1">General</span></strong><span class="koboSpan" id="kobo.415.1"> blade under </span><strong class="bold"><span class="koboSpan" id="kobo.416.1">Package</span></strong><span class="koboSpan" id="kobo.417.1"> in the navigator. </span><span class="koboSpan" id="kobo.417.2">From there, you can check the </span><strong class="bold"><span class="koboSpan" id="kobo.418.1">Produce a package file during build operations</span></strong><span class="koboSpan" id="kobo.419.1"> checkbox, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.420.1">Figure 14</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.421.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.422.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer173">
<span class="koboSpan" id="kobo.423.1"><img alt="Figure 14.2 – Enabling NuGet package creation in Visual Studio" src="image/B21324_14_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.424.1">Figure 14.2 – Enabling NuGet package creation in Visual Studio</span></p>
<p><span class="koboSpan" id="kobo.425.1">When this box is checked, you should see something like the following in your build output </span><span class="No-Break"><span class="koboSpan" id="kobo.426.1">after building:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.427.1">
1&gt;Successfully created package 'C:\PacktBook\Chapter14\Ch14BeginningCode\Packt.Analyzers\bin\Debug\Packt.Analyzers.1.0.0.nupkg'.
</span><span class="koboSpan" id="kobo.427.2">1&gt;Done building project "Packt.Analyzers.csproj".</span></pre>
<p><span class="koboSpan" id="kobo.428.1">The general blade also lets you configure many of the pieces of metadata associated with the package. </span><span class="koboSpan" id="kobo.428.2">This lets you specify a readme file or a logo, enter any legal information you need, and more. </span><span class="koboSpan" id="kobo.428.3">These pieces of information will later be visible to users considering installing </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">your package.</span></span></p>
<p><span class="koboSpan" id="kobo.430.1">The many things to consider when configuring a NuGet package for publishing to the public are beyond the scope of this book, but additional resources are listed in the </span><em class="italic"><span class="koboSpan" id="kobo.431.1">Further reading</span></em><span class="koboSpan" id="kobo.432.1"> section at the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.434.1">Unfortunately, when building packages for Roslyn Analyzers, you need to customize more than Visual Studio makes available in the properties </span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">user interface.</span></span></p>
<p><span class="koboSpan" id="kobo.436.1">Double-click on </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1">Packt.Analyzers</span></strong><span class="koboSpan" id="kobo.438.1"> in </span><strong class="bold"><span class="koboSpan" id="kobo.439.1">Solution Explorer</span></strong><span class="koboSpan" id="kobo.440.1"> to open its </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">.csproj</span></strong><span class="koboSpan" id="kobo.442.1"> file and replace it </span><span class="No-Break"><span class="koboSpan" id="kobo.443.1">with</span></span><span class="No-Break"><a id="_idIndexMarker859"/></span><span class="No-Break"><span class="koboSpan" id="kobo.444.1"> this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.445.1">
&lt;Project Sdk="Microsoft.NET.Sdk"&gt;
 &lt;PropertyGroup&gt;
   &lt;TargetFramework&gt;netstandard2.0&lt;/TargetFramework&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.446.1">   &lt;GeneratePackageOnBuild&gt;True&lt;/GeneratePackageOnBuild&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.447.1">   &lt;IncludeBuildOutput&gt;false&lt;/IncludeBuildOutput&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.448.1">   &lt;Authors&gt;YourName&lt;/Authors&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.449.1">   &lt;Company&gt;YourCompany&lt;/Company&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.450.1">   &lt;PackageId&gt;YourCompany.Analyzers&lt;/PackageId&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.451.1">   &lt;PackageVersion&gt;1.0.0&lt;/PackageVersion&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.452.1">   &lt;PackageLicenseExpression&gt;MIT&lt;/PackageLicenseExpression&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.453.1">   &lt;Description&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.454.1">      Sample analyzer with fix from "Refactoring with C#"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.455.1">      by Matt Eland via Packt Publishing.</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.456.1">   &lt;/Description&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.457.1">   &lt;PackageProjectUrl&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.458.1">https://github.com/PacktPublishing/Refactoring-with-CSharp</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.459.1">   &lt;/PackageProjectUrl&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.460.1">   &lt;RepositoryUrl&gt;https://github.com/PacktPublishing/</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.461.1">Refactoring-with-CSharp&lt;/RepositoryUrl&gt;</span></strong><span class="koboSpan" id="kobo.462.1">
 &lt;/PropertyGroup&gt;
 &lt;ItemGroup&gt;
   &lt;PackageReference Include="Microsoft.CodeAnalysis"
                     Version="4.0.1" /&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.463.1">   </span></strong><strong class="bold"><span class="koboSpan" id="kobo.464.1">&lt;None Include="$(OutputPath)\Packt.Analyzers.dll"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.465.1">         Pack="true"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.466.1">         PackagePath="analyzers/dotnet/cs"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.467.1">         Visible="false" /&gt;</span></strong><span class="koboSpan" id="kobo.468.1">
 &lt;/ItemGroup&gt;
&lt;/Project&gt;</span></pre>
<p><span class="koboSpan" id="kobo.469.1">These additional pieces of metadata customize how your package will be installed. </span><span class="koboSpan" id="kobo.469.2">Let’s talk about each one of the</span><a id="_idIndexMarker860"/><span class="koboSpan" id="kobo.470.1"> relevant </span><span class="No-Break"><span class="koboSpan" id="kobo.471.1">changes separately:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.472.1">GeneratePackageOnBuild</span></strong><span class="koboSpan" id="kobo.473.1"> is the same thing as checking the box on the properties page to build the package </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">on build.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.475.1">IncludeBuildOutput</span></strong><span class="koboSpan" id="kobo.476.1"> tells the packaging process not to include the results of compilation in the generated package. </span><span class="koboSpan" id="kobo.476.2">Instead, we’ll do something different to include these files using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">ItemGroup</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.478.1"> section.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.479.1">PackageId</span></strong><span class="koboSpan" id="kobo.480.1"> is a unique identifier for your NuGet package. </span><span class="koboSpan" id="kobo.480.2">While the code in this book uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">Packt.Analyzers</span></strong><span class="koboSpan" id="kobo.482.1">, I recommend using your name without spaces or punctuation in place of </span><strong class="source-inline"><span class="koboSpan" id="kobo.483.1">Packt</span></strong><span class="koboSpan" id="kobo.484.1"> to avoid conflicts </span><span class="No-Break"><span class="koboSpan" id="kobo.485.1">publishing this.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.486.1">PackageVersion</span></strong><span class="koboSpan" id="kobo.487.1"> is the release version number of your package. </span><span class="koboSpan" id="kobo.487.2">The latest version of a package is typically what people install </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">using NuGet.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.489.1">PackageLicenseExpression</span></strong><span class="koboSpan" id="kobo.490.1"> is optional, but it allows you to tell others what open-source license, if any, applies to the usage of your package. </span><span class="koboSpan" id="kobo.490.2">The various license types and their legal implications are beyond the scope of </span><span class="No-Break"><span class="koboSpan" id="kobo.491.1">this book.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.492.1">Description</span></strong><span class="koboSpan" id="kobo.493.1"> is a short user-friendly description of what the package does and why someone might want to </span><span class="No-Break"><span class="koboSpan" id="kobo.494.1">install it.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.495.1">RepositoryUrl</span></strong><span class="koboSpan" id="kobo.496.1"> is optional and tells others where the package code </span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">is available.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.498.1">The really critical part of this file is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.499.1">None</span></strong><span class="koboSpan" id="kobo.500.1"> element in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.501.1">ItemGroup</span></strong><span class="koboSpan" id="kobo.502.1">. </span><span class="koboSpan" id="kobo.502.2">This step tells the packaging process to take the compiled DLL of the analyzer project and put it in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.503.1">analyzers/dotnet/cs</span></strong><span class="koboSpan" id="kobo.504.1"> directory of the </span><span class="No-Break"><span class="koboSpan" id="kobo.505.1">NuGet package.</span></span></p>
<p><span class="koboSpan" id="kobo.506.1">This directory is a special directory that .NET looks at when loading Roslyn Analyzers from various sources. </span><span class="koboSpan" id="kobo.506.2">If it doesn’t see your analyzers there, those analyzers will not </span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">be loaded.</span></span></p>
<p><span class="koboSpan" id="kobo.508.1">With these steps configured and the file saved, rebuild the project and you should see your NuGet package created inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.509.1">bin\Debug</span></strong><span class="koboSpan" id="kobo.510.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.511.1">bin\Release</span></strong><span class="koboSpan" id="kobo.512.1"> directory of your </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.513.1">Packt.Analyzers</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.514.1"> project.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.515.1">Debug vs Release builds</span></p>
<p class="callout"><span class="koboSpan" id="kobo.516.1">When publishing</span><a id="_idIndexMarker861"/><span class="koboSpan" id="kobo.517.1"> software, you’ll</span><a id="_idIndexMarker862"/><span class="koboSpan" id="kobo.518.1"> want to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.519.1">Release</span></strong><span class="koboSpan" id="kobo.520.1"> configuration instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">Debug</span></strong><span class="koboSpan" id="kobo.522.1">. </span><span class="koboSpan" id="kobo.522.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">Debug</span></strong><span class="koboSpan" id="kobo.524.1"> configuration suppresses certain compiler optimizations and adds extra build byproducts that help you debug your applications. </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">Release</span></strong><span class="koboSpan" id="kobo.526.1"> builds tend to be smaller and faster and are generally recommended. </span><span class="koboSpan" id="kobo.526.2">You can change which configuration is active using the main toolbar in </span><span class="No-Break"><span class="koboSpan" id="kobo.527.1">Visual Studio.</span></span></p>
<p><span class="koboSpan" id="kobo.528.1">Once your </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">.nupkg</span></strong><span class="koboSpan" id="kobo.530.1"> file is </span><a id="_idIndexMarker863"/><span class="koboSpan" id="kobo.531.1">created, you’re ready to publish it for others </span><span class="No-Break"><span class="koboSpan" id="kobo.532.1">to use.</span></span></p>
<h2 id="_idParaDest-310"><a id="_idTextAnchor309"/><span class="koboSpan" id="kobo.533.1">Deploying the NuGet package</span></h2>
<p><span class="koboSpan" id="kobo.534.1">Now that we </span><a id="_idIndexMarker864"/><span class="koboSpan" id="kobo.535.1">have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.536.1">.nupkg</span></strong><span class="koboSpan" id="kobo.537.1"> file, we can deploy it to any NuGet feed. </span><span class="koboSpan" id="kobo.537.2">This can be a feed you set up yourself at your organization, a private NuGet registry on GitHub, or a public NuGet feed such as the one </span><span class="No-Break"><span class="koboSpan" id="kobo.538.1">at </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">NuGet.org</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.540.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.541.1">Because </span><strong class="source-inline"><span class="koboSpan" id="kobo.542.1">NuGet.org</span></strong><span class="koboSpan" id="kobo.543.1"> is the standard place for sharing open-source code packages, we’ll explore this path in this chapter. </span><span class="koboSpan" id="kobo.543.2">If your code is proprietary and you only want to share it within your organization, it should not go </span><span class="No-Break"><span class="koboSpan" id="kobo.544.1">on </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.545.1">NuGet.org</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.546.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.547.1">NuGet hosting options</span></p>
<p class="callout"><span class="koboSpan" id="kobo.548.1">If you’d like to host</span><a id="_idIndexMarker865"/><span class="koboSpan" id="kobo.549.1"> your NuGet packages outside of </span><strong class="source-inline"><span class="koboSpan" id="kobo.550.1">NuGet.org</span></strong><span class="koboSpan" id="kobo.551.1">, you have a few options including setting up a private NuGet server or using a team-shared NuGet repository service such as those offered on GitHub. </span><span class="koboSpan" id="kobo.551.2">See the </span><em class="italic"><span class="koboSpan" id="kobo.552.1">Further reading</span></em><span class="koboSpan" id="kobo.553.1"> section for </span><span class="No-Break"><span class="koboSpan" id="kobo.554.1">more information.</span></span></p>
<p><span class="koboSpan" id="kobo.555.1">To get started, navigate to </span><a href="http://NuGet.org"><span class="koboSpan" id="kobo.556.1">NuGet.org</span></a><span class="koboSpan" id="kobo.557.1">, create a user, and then log in as </span><span class="No-Break"><span class="koboSpan" id="kobo.558.1">that user.</span></span></p>
<p><span class="koboSpan" id="kobo.559.1">Once you are authenticated, click on the </span><strong class="bold"><span class="koboSpan" id="kobo.560.1">Upload</span></strong><span class="koboSpan" id="kobo.561.1"> tab to begin the process of uploading a NuGet package. </span><span class="koboSpan" id="kobo.561.2">This will allow you to drag and drop or click </span><strong class="bold"><span class="koboSpan" id="kobo.562.1">Browse…</span></strong><span class="koboSpan" id="kobo.563.1"> to find your NuGet package, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.564.1">Figure 14</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.565.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer174">
<span class="koboSpan" id="kobo.567.1"><img alt="Figure 14.3 – Uploading a NuGet package" src="image/B21324_14_3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.568.1">Figure 14.3 – Uploading a NuGet package</span></p>
<p><span class="koboSpan" id="kobo.569.1">If you need help finding your </span><strong class="source-inline"><span class="koboSpan" id="kobo.570.1">.nupkg</span></strong><span class="koboSpan" id="kobo.571.1"> file, it should be inside of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">Packt.Analyzers</span></strong><span class="koboSpan" id="kobo.573.1"> project in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">\bin\Debug</span></strong><span class="koboSpan" id="kobo.575.1"> folder or the </span><strong class="source-inline"><span class="koboSpan" id="kobo.576.1">\bin\Release</span></strong><span class="koboSpan" id="kobo.577.1"> folder depending on if you</span><a id="_idIndexMarker866"/><span class="koboSpan" id="kobo.578.1"> build your project in </span><strong class="source-inline"><span class="koboSpan" id="kobo.579.1">Debug</span></strong><span class="koboSpan" id="kobo.580.1"> or </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">Release</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.582.1"> mode.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.583.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.584.1">It’s always best to publish </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">Release</span></strong><span class="koboSpan" id="kobo.586.1"> builds when sharing code </span><span class="No-Break"><span class="koboSpan" id="kobo.587.1">with others.</span></span></p>
<p><span class="koboSpan" id="kobo.588.1">Once you’ve selected your NuGet package, the page will update with the information it detects about your package. </span><span class="koboSpan" id="kobo.588.2">This includes the version number, license file, readme file, and other information. </span><span class="koboSpan" id="kobo.588.3">While it’s best to configure these values in Visual Studio, some things, such as the readme file, can be customized here </span><span class="No-Break"><span class="koboSpan" id="kobo.589.1">before publishing.</span></span></p>
<p><span class="koboSpan" id="kobo.590.1">If something doesn’t look right, you can create a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">.nupkg</span></strong><span class="koboSpan" id="kobo.592.1"> file and upload </span><span class="No-Break"><span class="koboSpan" id="kobo.593.1">that file.</span></span></p>
<p><span class="koboSpan" id="kobo.594.1">Once you’re satisfied with the information on the preview screen, click </span><strong class="bold"><span class="koboSpan" id="kobo.595.1">Submit</span></strong><span class="koboSpan" id="kobo.596.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.597.1">NuGet.org</span></strong><span class="koboSpan" id="kobo.598.1"> will begin checking your file for anything harmful and indexing the package so others can </span><span class="No-Break"><span class="koboSpan" id="kobo.599.1">import it.</span></span></p>
<p><span class="koboSpan" id="kobo.600.1">This process typically takes 5 to 15 minutes but can vary. </span><span class="koboSpan" id="kobo.600.2">If you want to check on the status of your package, you can refresh the package details page found in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.601.1">Figure 14</span></em></span><em class="italic"><span class="koboSpan" id="kobo.602.1">.4</span></em><span class="koboSpan" id="kobo.603.1"> to check on </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">the status.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer175">
<span class="koboSpan" id="kobo.605.1"><img alt="Figure 14.4 – NuGet.org checking and indexing a package" src="image/B21324_14_4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.606.1">Figure 14.4 – NuGet.org checking and indexing a package</span></p>
<p><span class="koboSpan" id="kobo.607.1">Once this process </span><a id="_idIndexMarker867"/><span class="koboSpan" id="kobo.608.1">finishes, you’re ready to reference the package in </span><span class="No-Break"><span class="koboSpan" id="kobo.609.1">Visual Studio.</span></span></p>
<h2 id="_idParaDest-311"><a id="_idTextAnchor310"/><span class="koboSpan" id="kobo.610.1">Referencing the NuGet package</span></h2>
<p><span class="koboSpan" id="kobo.611.1">Once your package is</span><a id="_idIndexMarker868"/><span class="koboSpan" id="kobo.612.1"> published on </span><strong class="source-inline"><span class="koboSpan" id="kobo.613.1">NuGet.org</span></strong><span class="koboSpan" id="kobo.614.1">, you can reference it in any compatible .</span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">NET project.</span></span></p>
<p><span class="koboSpan" id="kobo.616.1">To prove this, open a solution from a previous chapter or create a new console application. </span><span class="koboSpan" id="kobo.616.2">Next, choose </span><strong class="bold"><span class="koboSpan" id="kobo.617.1">Manage NuGet Packages…</span></strong><span class="koboSpan" id="kobo.618.1"> for that project in </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.619.1">Solution Explorer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.620.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.621.1">Once </span><strong class="bold"><span class="koboSpan" id="kobo.622.1">NuGet Package Manager</span></strong><span class="koboSpan" id="kobo.623.1"> comes up, go to the </span><strong class="bold"><span class="koboSpan" id="kobo.624.1">Browse</span></strong><span class="koboSpan" id="kobo.625.1"> tab and search for your package by its name. </span><span class="koboSpan" id="kobo.625.2">Assuming the name is correct and your package has finished indexing, you should see the package in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.626.1">Figure 14</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.627.1">.5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.628.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer176">
<span class="koboSpan" id="kobo.629.1"><img alt="Figure 14.5 – Referencing your package in NuGet Package Manager" src="image/B21324_14_5.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.630.1">Figure 14.5 – Referencing your package in NuGet Package Manager</span></p>
<p><span class="koboSpan" id="kobo.631.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.632.1">Install</span></strong><span class="koboSpan" id="kobo.633.1"> to install the latest published version of your package and notice the dependencies and license terms that appear based on your choices when creating the </span><span class="No-Break"><span class="koboSpan" id="kobo.634.1">NuGet package.</span></span></p>
<p><span class="koboSpan" id="kobo.635.1">Once your package is</span><a id="_idIndexMarker869"/><span class="koboSpan" id="kobo.636.1"> installed, your analyzer will now be active and will appear inside of the </span><strong class="bold"><span class="koboSpan" id="kobo.637.1">Analyzers</span></strong><span class="koboSpan" id="kobo.638.1"> node nested inside of the project’s </span><strong class="bold"><span class="koboSpan" id="kobo.639.1">Dependencies</span></strong><span class="koboSpan" id="kobo.640.1"> node in </span><strong class="bold"><span class="koboSpan" id="kobo.641.1">Solution Explorer</span></strong><span class="koboSpan" id="kobo.642.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.643.1">Figure 14</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.644.1">.6</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.645.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer177">
<span class="koboSpan" id="kobo.646.1"><img alt="Figure 14.6 – Our analyzers package installed and active in a project" src="image/B21324_14_6.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.647.1">Figure 14.6 – Our analyzers package installed and active in a project</span></p>
<p><span class="koboSpan" id="kobo.648.1">The analyzer will also be active for any class in your project and it will provide suggestions and </span><span class="No-Break"><span class="koboSpan" id="kobo.649.1">code fixes.</span></span></p>
<p><span class="koboSpan" id="kobo.650.1">Once you commit and push your changes to the project, others on your team will pull down the reference to the new NuGet dependency. </span><span class="koboSpan" id="kobo.650.2">Visual Studio will then restore your NuGet packages and install the analyzer locally into that project for </span><span class="No-Break"><span class="koboSpan" id="kobo.651.1">your coworkers.</span></span></p>
<p><span class="koboSpan" id="kobo.652.1">If you ever need to update your NuGet package, you can create a new version of the package and upload it to </span><strong class="source-inline"><span class="koboSpan" id="kobo.653.1">NuGet.org</span></strong><span class="koboSpan" id="kobo.654.1">. </span><span class="koboSpan" id="kobo.654.2">Once the new version is indexed, you’ll be able to update the installed version of the package from NuGet </span><span class="No-Break"><span class="koboSpan" id="kobo.655.1">Package Manager.</span></span></p>
<p><span class="koboSpan" id="kobo.656.1">The NuGet deployment </span><a id="_idIndexMarker870"/><span class="koboSpan" id="kobo.657.1">process makes it easy to install and update packages in your project that are then available to every developer on your team. </span><span class="koboSpan" id="kobo.657.2">This is why this process is my default recommendation for sharing your Roslyn Analyzers with </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">your team.</span></span></p>
<h2 id="_idParaDest-312"><a id="_idTextAnchor311"/><span class="koboSpan" id="kobo.659.1">Packaging a CodeFixProvider as an extension</span></h2>
<p><span class="koboSpan" id="kobo.660.1">If you want to</span><a id="_idIndexMarker871"/><span class="koboSpan" id="kobo.661.1"> package your code fix in a VSIX </span><a id="_idIndexMarker872"/><span class="koboSpan" id="kobo.662.1">extension, you can do that in largely the same way as we did in </span><a href="B21324_13.xhtml#_idTextAnchor275"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.663.1">Chapter 13</span></em></span></a><span class="koboSpan" id="kobo.664.1"> with one </span><span class="No-Break"><span class="koboSpan" id="kobo.665.1">additional change.</span></span></p>
<p><span class="koboSpan" id="kobo.666.1">To get your </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">CodeFixProvider</span></strong><span class="koboSpan" id="kobo.668.1"> to work in the extension, you’ll need to add a </span><strong class="bold"><span class="koboSpan" id="kobo.669.1">Managed Extensibility Framework (MEF)</span></strong><span class="koboSpan" id="kobo.670.1"> asset </span><a id="_idIndexMarker873"/><span class="koboSpan" id="kobo.671.1">to your </span><span class="No-Break"><span class="koboSpan" id="kobo.672.1">installer’s manifest.</span></span></p>
<p><span class="koboSpan" id="kobo.673.1">To do this, go to the </span><strong class="bold"><span class="koboSpan" id="kobo.674.1">Assets</span></strong><span class="koboSpan" id="kobo.675.1"> pane of your Installer project’s manifest and </span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.677.1">New</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.678.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.679.1">Next, select </span><strong class="bold"><span class="koboSpan" id="kobo.680.1">Microsoft.VisualStudio.MefComponent</span></strong><span class="koboSpan" id="kobo.681.1"> as the type, specify the source as </span><strong class="bold"><span class="koboSpan" id="kobo.682.1">A project in current solution</span></strong><span class="koboSpan" id="kobo.683.1">, and specify your analyzers project as the project (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.684.1">Figure 14</span></em></span><em class="italic"><span class="koboSpan" id="kobo.685.1">.7</span></em><span class="koboSpan" id="kobo.686.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.687.1">an example).</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer178">
<span class="koboSpan" id="kobo.688.1"><img alt="Figure 14.7 – Adding an MEF component asset to the installer manifest" src="image/B21324_14_7.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.689.1">Figure 14.7 – Adding an MEF component asset to the installer manifest</span></p>
<p><span class="koboSpan" id="kobo.690.1">This change will ensure your code fix is properly registered by </span><span class="No-Break"><span class="koboSpan" id="kobo.691.1">the installer.</span></span></p>
<p><span class="koboSpan" id="kobo.692.1">In my experience, it’s usually easier to maintain analyzers via a NuGet package than a VSIX installer, but </span><a id="_idIndexMarker874"/><span class="koboSpan" id="kobo.693.1">both </span><a id="_idIndexMarker875"/><span class="koboSpan" id="kobo.694.1">deployment models have their advantages. </span><span class="koboSpan" id="kobo.694.2">Pick the approach that makes the most sense for your installation, updating, and </span><span class="No-Break"><span class="koboSpan" id="kobo.695.1">security needs.</span></span></p>
<h1 id="_idParaDest-313"><a id="_idTextAnchor312"/><span class="koboSpan" id="kobo.696.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.697.1">In this chapter, we saw how Roslyn Analyzers can be extended to provide code fixes along with the diagnostic information they </span><span class="No-Break"><span class="koboSpan" id="kobo.698.1">already provided.</span></span></p>
<p><span class="koboSpan" id="kobo.699.1">Code fixes work by interpreting the tree structure of your code and making modifications to that structure, resulting in a new document or solution. </span><span class="koboSpan" id="kobo.699.2">Visual Studio then reacts to these changes by updating the </span><span class="No-Break"><span class="koboSpan" id="kobo.700.1">source code.</span></span></p>
<p><span class="koboSpan" id="kobo.701.1">This means that code fixes can automatically make pre-configured modifications to your code to address known issues in a repeatable and </span><span class="No-Break"><span class="koboSpan" id="kobo.702.1">safe manner.</span></span></p>
<p><span class="koboSpan" id="kobo.703.1">We also discussed how NuGet package deployment allows you to wrap up your Roslyn Analyzers into a package and share them with other developers – either other developers on your team or other </span><span class="No-Break"><span class="koboSpan" id="kobo.704.1">developers worldwide.</span></span></p>
<p><span class="koboSpan" id="kobo.705.1">This concludes </span><em class="italic"><span class="koboSpan" id="kobo.706.1">Part 3</span></em><span class="koboSpan" id="kobo.707.1"> of this book. </span><span class="koboSpan" id="kobo.707.2">In the final part of this book, we’ll explore some of the unique challenges and opportunities found in refactoring code in real-world organizations </span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">and teams.</span></span></p>
<h1 id="_idParaDest-314"><a id="_idTextAnchor313"/><span class="koboSpan" id="kobo.709.1">Questions</span></h1>
<ol>
<li><span class="koboSpan" id="kobo.710.1">What is the relationship between a </span><strong class="source-inline"><span class="koboSpan" id="kobo.711.1">DiagnosticAnalyzer</span></strong><span class="koboSpan" id="kobo.712.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.713.1">a </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.714.1">CodeFixProvider</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.715.1">?</span></span></li>
<li><span class="koboSpan" id="kobo.716.1">How can you test a </span><span class="No-Break"><span class="koboSpan" id="kobo.717.1">code fix?</span></span></li>
<li><span class="koboSpan" id="kobo.718.1">What are some of the advantages of NuGet deployment versus </span><span class="No-Break"><span class="koboSpan" id="kobo.719.1">VSIX deployment?</span></span></li>
</ol>
<h1 id="_idParaDest-315"><a id="_idTextAnchor314"/><span class="koboSpan" id="kobo.720.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.721.1">You can find more information about materials from this chapter at the </span><span class="No-Break"><span class="koboSpan" id="kobo.722.1">following URLs:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.723.1">Get started with syntax </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.724.1">transformation</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.725.1">: </span></span><a href="https://learn.microsoft.com/en-us/dotnet/csharp/roslyn-sdk/get-started/syntax-transformation"><span class="No-Break"><span class="koboSpan" id="kobo.726.1">https://learn.microsoft.com/en-us/dotnet/csharp/roslyn-sdk/get-started/syntax-transformation</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.727.1">Configuring and Publishing NuGet </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.728.1">Packages</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.729.1">: </span></span><a href="https://learn.microsoft.com/en-us/nuget/quickstart/create-and-publish-a-package-using-visual-studio?tabs=netcore-cli"><span class="No-Break"><span class="koboSpan" id="kobo.730.1">https://learn.microsoft.com/en-us/nuget/quickstart/create-and-publish-a-package-using-visual-studio?tabs=netcore-cli</span></span></a><a href="https://learn.microsoft.com/en-us/nuget/quickstart/create-and-publish-a-package-using-visual-studio "/></li>
<li><em class="italic"><span class="koboSpan" id="kobo.731.1">Hosting your own NuGet </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.732.1">feeds</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.733.1">: </span></span><a href="https://learn.microsoft.com/en-us/nuget/hosting-packages/overview "><span class="No-Break"><span class="koboSpan" id="kobo.734.1">https://learn.microsoft.com/en-us/nuget/hosting-packages/overview</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.735.1">Working with NuGet on </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.736.1">GitHub</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.737.1">: </span></span><a href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-nuget-registry"><span class="No-Break"><span class="koboSpan" id="kobo.738.1">https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-nuget-registry</span></span></a></li>
</ul>
</div>


<div class="Content" id="_idContainer180">
<h1 id="_idParaDest-316" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor315"/><span class="koboSpan" id="kobo.1.1">Part 4: Refactoring in the Enterprise</span></h1>
<p><span class="koboSpan" id="kobo.2.1">In the fourth and final part of the book, we focus on the social aspects of refactoring: communicating technical debt to others, adopting code standards as an engineering organization, and refactoring in </span><span class="No-Break"><span class="koboSpan" id="kobo.3.1">agile environments.</span></span></p>
<p><span class="koboSpan" id="kobo.4.1">Convincing a large team or organization of the importance of refactoring can be a critical battle, and so this part looks at how software engineers can partner with business leaders. </span><span class="koboSpan" id="kobo.4.2">These chapters contain key tips and tricks to ensure that refactoring actually happens and that the right areas of technical debt get </span><span class="No-Break"><span class="koboSpan" id="kobo.5.1">refactored first.</span></span></p>
<p><span class="koboSpan" id="kobo.6.1">We specifically focus on refactoring in an agile environment and how to handle refactoring scenarios that are so large that it feels like a complete rewrite </span><span class="No-Break"><span class="koboSpan" id="kobo.7.1">is necessary.</span></span></p>
<p><span class="koboSpan" id="kobo.8.1">This part contains the </span><span class="No-Break"><span class="koboSpan" id="kobo.9.1">following chapters:</span></span></p>
<ul>
<li><a href="B21324_15.xhtml#_idTextAnchor316"><em class="italic"><span class="koboSpan" id="kobo.10.1">Chapter 15</span></em></a><em class="italic"><span class="koboSpan" id="kobo.11.1">, Communicating Technical Debt</span></em></li>
<li><a href="B21324_16.xhtml#_idTextAnchor341"><em class="italic"><span class="koboSpan" id="kobo.12.1">Chapter 16</span></em></a><em class="italic"><span class="koboSpan" id="kobo.13.1">, Adopting Code Standards</span></em></li>
<li><a href="B21324_17.xhtml#_idTextAnchor354"><em class="italic"><span class="koboSpan" id="kobo.14.1">Chapter 17</span></em></a><em class="italic"><span class="koboSpan" id="kobo.15.1">, Agile Refactoring</span></em></li>
</ul>
</div>
<div>
<div id="_idContainer181">
</div>
</div>
<div>
<div class="Basic-Graphics-Frame" id="_idContainer182">
</div>
</div>
</body></html>