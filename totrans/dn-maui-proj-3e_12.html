<html><head></head><body>
<div id="_idContainer216">
<p><a id="_idTextAnchor916"/><a id="_idTextAnchor917"/><a id="_idTextAnchor918"/></p>
<h1 class="chapter-number" id="_idParaDest-187"><a id="_idTextAnchor919"/><span class="koboSpan" id="kobo.1.1">12</span></h1>
<h1 id="_idParaDest-188"><a id="_idTextAnchor920"/><span class="koboSpan" id="kobo.2.1">Hot Dog or Not Hot Dog Using Machine Learning</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we will learn how to use machine learning to create a model that we can use for image classification. </span><span class="koboSpan" id="kobo.3.2">We will export the model as an </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">Onnx</span></strong><span class="koboSpan" id="kobo.5.1"> model that we can use on all platforms – that is, Android, iOS, macOS, and Windows. </span><span class="koboSpan" id="kobo.5.2">To train and export models, we will use Azure Cognitive Services and the Custom </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">Vision service.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">Once we have exported the models, we will learn how to use them in a .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">MAUI app.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">The following topics will be covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.11.1">Training a model with Azure Cognitive Services and the Custom </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">Vision service</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Using Onnx models for image classification </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">using ML.NET</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Using custom routes in .NET MAUI </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">for navigation</span></span></li>
</ul>
<h1 id="_idParaDest-189"><a id="_idTextAnchor921"/><span class="koboSpan" id="kobo.17.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.18.1">To be able to complete this project, you need to have Visual Studio for Mac or PC installed, as well as the .NET MAUI components. </span><span class="koboSpan" id="kobo.18.2">See </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.19.1">Chapter 1</span></em></span><span class="koboSpan" id="kobo.20.1">, </span><em class="italic"><span class="koboSpan" id="kobo.21.1">Introduction to .NET MAUI</span></em><span class="koboSpan" id="kobo.22.1">, for more details on how to set up your environment. </span><span class="koboSpan" id="kobo.22.2">You also need an Azure account. </span><span class="koboSpan" id="kobo.22.3">If you have a Visual Studio subscription, there are a specific amount of Azure credits included each month. </span><span class="koboSpan" id="kobo.22.4">To activate your Azure benefits, go </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">to </span></span><a href="https://my.visualstudio.com"><span class="No-Break"><span class="koboSpan" id="kobo.24.1">https://my.visualstudio.com</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.25.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.26.1">You can also create a free account, where you can use selected services for free over 12 months. </span><span class="koboSpan" id="kobo.26.2">You will get $200 worth of credit to explore any Azure service for 30 days, and you can also use the free services at any time. </span><span class="koboSpan" id="kobo.26.3">Read more </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">at </span></span><a href="https://azure.microsoft.com/en-us/free/"><span class="No-Break"><span class="koboSpan" id="kobo.28.1">https://azure.microsoft.com/en-us/free/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.29.1">.</span></span><a id="_idTextAnchor922"/></p>
<p><span class="koboSpan" id="kobo.30.1">If you do not have and do not want to sign up for a free Azure account, the trained model is available in the source code for this chapter. </span><span class="koboSpan" id="kobo.30.2">You can download and use the pre-trained </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">model instead.</span></span></p>
<p><span class="koboSpan" id="kobo.32.1">The source code for this chapter is available at the GitHub repository for the book </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">at </span></span><a href="https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition"><span class="No-Break"><span class="koboSpan" id="kobo.34.1">https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.35.1">.</span></span></p>
<h1 id="_idParaDest-190"><a id="_idTextAnchor923"/><span class="koboSpan" id="kobo.36.1">Machine learning</span></h1>
<p><span class="koboSpan" id="kobo.37.1">The term </span><strong class="bold"><span class="koboSpan" id="kobo.38.1">machine learning</span></strong><span class="koboSpan" id="kobo.39.1"> was coined in 1959 by </span><a id="_idIndexMarker1279"/><a id="_idIndexMarker1280"/><span class="koboSpan" id="kobo.40.1">Arthur Samuel, an American pioneer in </span><strong class="bold"><span class="koboSpan" id="kobo.41.1">artificial intelligence</span></strong><span class="koboSpan" id="kobo.42.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.43.1">AI</span></strong><span class="koboSpan" id="kobo.44.1">). </span><span class="koboSpan" id="kobo.44.2">Tom M. </span><span class="koboSpan" id="kobo.44.3">Mitchell, an </span><a id="_idIndexMarker1281"/><a id="_idIndexMarker1282"/><span class="koboSpan" id="kobo.45.1">American computer scientist, provided the following more formal definition of machine </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">learning later:</span></span></p>
<p class="author-quote"><span class="koboSpan" id="kobo.47.1">“A computer program is said to learn from experience E with respect to some class of tasks T and performance measure P if its performance at tasks in T, as measured by P, improves with experience E.”</span></p>
<p><span class="koboSpan" id="kobo.48.1">In simpler terms, this quote describes a computer program that can learn without being explicitly programmed. </span><span class="koboSpan" id="kobo.48.2">In machine learning, algorithms are used to build a mathematical model of sample data or training data. </span><span class="koboSpan" id="kobo.48.3">The models are used for computer programs to make predictions and decisions without being explicitly </span><a id="_idTextAnchor924"/><span class="koboSpan" id="kobo.49.1">programmed for the task </span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">in question.</span></span></p>
<p><span class="koboSpan" id="kobo.51.1">In this section, we will learn about a few different machine learning services and APIs that are available when developing a .NET MAUI application. </span><span class="koboSpan" id="kobo.51.2">Some APIs are only available for specific platforms, such as Core ML, while others </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">are cross-platform.</span></span></p>
<h2 id="_idParaDest-191"><a id="_idTextAnchor925"/><span class="koboSpan" id="kobo.53.1">Azure Cognitive Services – Custom Vision</span></h2>
<p><span class="koboSpan" id="kobo.54.1">Custom Vision is a tool or service that can be</span><a id="_idIndexMarker1283"/><a id="_idIndexMarker1284"/><span class="koboSpan" id="kobo.55.1"> used to train models for image classification and to detect objects in images. </span><span class="koboSpan" id="kobo.55.2">With Custom Vision, we can upload our own images and tag them so that they can be trained for image classification. </span><span class="koboSpan" id="kobo.55.3">If we train a </span><a id="_idIndexMarker1285"/><a id="_idIndexMarker1286"/><span class="koboSpan" id="kobo.56.1">model for object detection, we can also tag specific areas of an image. </span><span class="koboSpan" id="kobo.56.2">Because models are already pre-trained for basic image recognition, we don’t need a large amount of data to get a great result. </span><span class="koboSpan" id="kobo.56.3">The recommendation</span><a id="_idIndexMarker1287"/><a id="_idIndexMarker1288"/><span class="koboSpan" id="kobo.57.1"> is to have at least 30 images </span><span class="No-Break"><span class="koboSpan" id="kobo.58.1">per tag.</span></span></p>
<p><span class="koboSpan" id="kobo.59.1">When we have trained a model, we can use it with an API, which is part of the Custom Vision service. </span><span class="koboSpan" id="kobo.59.2">We can also export models for </span><strong class="bold"><span class="koboSpan" id="kobo.60.1">Core ML</span></strong><span class="koboSpan" id="kobo.61.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.62.1">iOS</span></strong><span class="koboSpan" id="kobo.63.1">), </span><strong class="bold"><span class="koboSpan" id="kobo.64.1">TensorFlow</span></strong><span class="koboSpan" id="kobo.65.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.66.1">Android</span></strong><span class="koboSpan" id="kobo.67.1">), the </span><strong class="bold"><span class="koboSpan" id="kobo.68.1">Open Neural Network Exchange </span></strong><span class="koboSpan" id="kobo.69.1">(</span><strong class="bold"><span class="koboSpan" id="kobo.70.1">ONNX</span></strong><span class="koboSpan" id="kobo.71.1">), and a </span><strong class="bold"><span class="koboSpan" id="kobo.72.1">Dockerfile</span></strong><span class="koboSpan" id="kobo.73.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.74.1">Azure IoT Edge</span></strong><span class="koboSpan" id="kobo.75.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.76.1">Azure Functions</span></strong><span class="koboSpan" id="kobo.77.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.78.1">Azure ML</span></strong><span class="koboSpan" id="kobo.79.1">). </span><span class="koboSpan" id="kobo.79.2">These models can be used to carry out classification or object detection without being connected to the Custom </span><span class="No-Break"><span class="koboSpan" id="kobo.80.1">Vision service.</span></span></p>
<p><a id="_idTextAnchor926"/><span class="koboSpan" id="kobo.81.1">You will need an Azure subscription to use it – go to </span><a href="https://azure.com/free"><span class="koboSpan" id="kobo.82.1">https://azure.com/free</span></a><span class="koboSpan" id="kobo.83.1"> to create a </span><a id="_idTextAnchor927"/><span class="koboSpan" id="kobo.84.1">free subscription, which should be enough to complete </span><span class="No-Break"><span class="koboSpan" id="kobo.85.1">this project.</span></span></p>
<h2 id="_idParaDest-192"><a id="_idTextAnchor928"/><span class="koboSpan" id="kobo.86.1">Core ML</span></h2>
<p><span class="koboSpan" id="kobo.87.1">Core ML is a framework that was introduced</span><a id="_idIndexMarker1289"/><a id="_idIndexMarker1290"/><span class="koboSpan" id="kobo.88.1"> in iOS 11. </span><span class="koboSpan" id="kobo.88.2">Core ML makes it possible to integrate machine learning models into iOS apps. </span><span class="koboSpan" id="kobo.88.3">On top of Core </span><a id="_idIndexMarker1291"/><a id="_idIndexMarker1292"/><span class="koboSpan" id="kobo.89.1">ML, we have high-level APIs, </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.91.1">Vision APIs for </span><span class="No-Break"><span class="koboSpan" id="kobo.92.1">image analysis</span></span></li>
<li><span class="koboSpan" id="kobo.93.1">Natural language APIs for natural </span><span class="No-Break"><span class="koboSpan" id="kobo.94.1">language processing</span></span></li>
<li><span class="koboSpan" id="kobo.95.1">Speech to convert audio </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">to text</span></span></li>
<li><span class="koboSpan" id="kobo.97.1">Sound analysis to identify sounds </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">in audio</span></span></li>
<li><span class="koboSpan" id="kobo.99.1">GameplayKit to evaluate learned decision trees </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">and strategies</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.101.1">More information</span></p>
<p class="callout"><span class="koboSpan" id="kobo.102.1">More information about Core ML can be found in the official documentation from Apple </span><span class="No-Break"><span class="koboSpan" id="kobo.103.1">at </span></span><a href="https://developer.apple.com/documentation/coreml"><span class="No-Break"><span class="koboSpan" id="kobo.104.1">https://developer.apple.com/documentation/coreml</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.105.1">.</span></span></p>
<h2 id="_idParaDest-193"><a id="_idTextAnchor929"/><span class="koboSpan" id="kobo.106.1">TensorFlow</span></h2>
<p><span class="koboSpan" id="kobo.107.1">TensorFlow is an open source machine </span><a id="_idIndexMarker1293"/><a id="_idIndexMarker1294"/><span class="koboSpan" id="kobo.108.1">learning framework. </span><span class="koboSpan" id="kobo.108.2">However, TensorFlow can be used for more than simply running models on mobile devices – it can also be used to train models. </span><span class="koboSpan" id="kobo.108.3">To run it on mobile devices, we have TensorFlow Lite. </span><span class="koboSpan" id="kobo.108.4">The </span><a id="_idIndexMarker1295"/><a id="_idIndexMarker1296"/><span class="koboSpan" id="kobo.109.1">models that are exported from Azure Cognitive Services are for TensorFlow Lite. </span><span class="koboSpan" id="kobo.109.2">There are also C# bindings for TensorFlow Lite that are available as a </span><span class="No-Break"><span class="koboSpan" id="kobo.110.1">NuGet package.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.111.1">More information</span></p>
<p class="callout"><span class="koboSpan" id="kobo.112.1">More information about TensorFlow can be found in the official documentation </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">at </span></span><a href="https://www.tensorflow.org/"><span class="No-Break"><span class="koboSpan" id="kobo.114.1">https://www.tensorflow.org/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.115.1">.</span></span></p>
<h2 id="_idParaDest-194"><a id="_idTextAnchor930"/><span class="koboSpan" id="kobo.116.1">ML.Net</span></h2>
<p><span class="koboSpan" id="kobo.117.1">ML.NET is an open source and</span><a id="_idIndexMarker1297"/><a id="_idIndexMarker1298"/><span class="koboSpan" id="kobo.118.1"> cross-platform machine learning framework with support for iOS, macOS, Android, and Windows, all from a familiar environment – C#. </span><span class="koboSpan" id="kobo.118.2">ML.NET provides </span><strong class="bold"><span class="koboSpan" id="kobo.119.1">AutoML</span></strong><span class="koboSpan" id="kobo.120.1">, a set of productivity tools that make</span><a id="_idIndexMarker1299"/><a id="_idIndexMarker1300"/><span class="koboSpan" id="kobo.121.1"> building, training, and deploying custom models easy. </span><span class="koboSpan" id="kobo.121.2">ML.NET can be used in the following scenarios </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">and more:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.123.1">Sentiment analysis and </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">product recommendation</span></span></li>
<li><span class="koboSpan" id="kobo.125.1">Object detection and </span><span class="No-Break"><span class="koboSpan" id="kobo.126.1">image classification</span></span></li>
<li><span class="koboSpan" id="kobo.127.1">Price prediction, sales spike detection, </span><span class="No-Break"><span class="koboSpan" id="kobo.128.1">and forecasting</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.129.1">Fraud detection</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.130.1">Customer segmentation</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.131.1">Now that we have a broad overview of the technologies at play, we will focus on using ML.NET, since it is a cross-platform framework and built for C#. </span><span class="koboSpan" id="kobo.131.2">Let’s look at the project we are going to </span><span class="No-Break"><span class="koboSpan" id="kobo.132.1">build next.</span></span></p>
<h1 id="_idParaDest-195"><a id="_idTextAnchor931"/><a id="_idTextAnchor932"/><a id="_idTextAnchor933"/><a id="_idTextAnchor934"/><span class="koboSpan" id="kobo.133.1">The project overview</span></h1>
<p><span class="koboSpan" id="kobo.134.1">If you have seen the TV series </span><em class="italic"><span class="koboSpan" id="kobo.135.1">Silicon Valley</span></em><span class="koboSpan" id="kobo.136.1">, you have probably heard of the </span><em class="italic"><span class="koboSpan" id="kobo.137.1">Not Hotdog</span></em><span class="koboSpan" id="kobo.138.1"> application. </span><span class="koboSpan" id="kobo.138.2">In this chapter, we will learn how to</span><a id="_idIndexMarker1301"/><a id="_idIndexMarker1302"/><span class="koboSpan" id="kobo.139.1"> build that app. </span><span class="koboSpan" id="kobo.139.2">The first part of this chapter will involve collecting the data that we will use to create a machine learning model that can detect whether a photo contains a </span><span class="No-Break"><span class="koboSpan" id="kobo.140.1">hot dog.</span></span></p>
<p><a id="_idTextAnchor935"/><span class="koboSpan" id="kobo.141.1">In the second part of the chapter, we will build an app using .NET MAUI and ML.NET, where the user can either take a new photo or pick a photo in the photo library, analyzing it to see whether </span><a id="_idTextAnchor936"/><span class="koboSpan" id="kobo.142.1">it contains a hot dog. </span><span class="koboSpan" id="kobo.142.2">The estimated time for completing this project is </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">120 minutes.</span></span></p>
<h1 id="_idParaDest-196"><a id="_idTextAnchor937"/><span class="koboSpan" id="kobo.144.1">Getting started</span></h1>
<p><span class="koboSpan" id="kobo.145.1">We can use either Visual Studio 2022 on a PC or Visual Studio for Mac to do this project. </span><span class="koboSpan" id="kobo.145.2">To build an iOS app using Visual Studio for PC, you must have a Mac connected. </span><span class="koboSpan" id="kobo.145.3">If you don’t have access to a Mac at all, you can choose to just do the Android and Windows parts of </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">this project.</span></span></p>
<p><span class="koboSpan" id="kobo.147.1">Similarly, if you only have a Mac, you can choose to just do the iOS and macOS or Android parts of </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">this </span><a id="_idTextAnchor938"/><span class="koboSpan" id="kobo.149.1">project.</span></span></p>
<h1 id="_idParaDest-197"><a id="_idTextAnchor939"/><span class="koboSpan" id="kobo.150.1">Building the Hot Dog or Not Hot Dog application using machine learning</span></h1>
<p><span class="koboSpan" id="kobo.151.1">Let’s get started! </span><span class="koboSpan" id="kobo.151.2">We will first train a </span><a id="_idIndexMarker1303"/><a id="_idIndexMarker1304"/><span class="koboSpan" id="kobo.152.1">model for image classification that we can use later in the chapter to decide whether a photo contains a </span><span class="No-Break"><span class="koboSpan" id="kobo.153.1">hot </span></span><span class="No-Break"><a id="_idIndexMarker1305"/><a id="_idIndexMarker1306"/></span><span class="No-Break"><span class="koboSpan" id="kobo.154.1">dog.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.155.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.156.1">If you do not want to go through the effort of training a model, you can download a pre-trained model from the following </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">URL: </span></span><a href="https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition/tree/main/Chapter12/HotdogOrNot/Resources/Raw"><span class="No-Break"><span class="koboSpan" id="kobo.158.1">https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition/tree/main/Chapter12/HotdogOrNot/Resources/Raw</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.159.1">.</span></span></p>
<h2 id="_idParaDest-198"><a id="_idTextAnchor940"/><span class="koboSpan" id="kobo.160.1">Training a model</span></h2>
<p><span class="koboSpan" id="kobo.161.1">To train a model for image classification, we need to collect photos of hot dogs and photos that aren’t of hot dogs. </span><span class="koboSpan" id="kobo.161.2">Because most items in the world are not hot dogs, we need more photos that don’t contain hot dogs. </span><span class="koboSpan" id="kobo.161.3">It’s better if the photos of hot dogs cover a lot of different hot dog scenarios – with bread, ketchup, or mustard. </span><span class="koboSpan" id="kobo.161.4">This is so that the model will </span><a id="_idIndexMarker1307"/><a id="_idIndexMarker1308"/><span class="koboSpan" id="kobo.162.1">be able to recognize hot dogs in different situations. </span><span class="koboSpan" id="kobo.162.2">When we collect photos that aren’t of hot dogs, we also need to have a large variety of photos that are both of items that are like hot dogs and that are completely different from </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">hot dogs.</span></span></p>
<p><span class="koboSpan" id="kobo.164.1">The model that is in the solution on GitHub was</span><a id="_idIndexMarker1309"/><a id="_idIndexMarker1310"/><span class="koboSpan" id="kobo.165.1"> trained with 240 photos, 60 of which were of hot dogs, and 180 of which </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">were not.</span></span></p>
<p><span class="koboSpan" id="kobo.167.1">Once we have collected all the photos, we will be ready to start training the model by following </span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.169.1">Go </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">to </span></span><a href="https://customvision.ai"><span class="No-Break"><span class="koboSpan" id="kobo.171.1">https://customvision.ai</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.172.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.173.1">Log in and create a </span><span class="No-Break"><span class="koboSpan" id="kobo.174.1">new project.</span></span></li>
<li><span class="koboSpan" id="kobo.175.1">Give the project a name – in our </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">case, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">HotDogOrNot</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">.</span></span></li>
<li><a id="_idTextAnchor941"/><span class="koboSpan" id="kobo.179.1">Select a resource or create a new one by clicking </span><strong class="bold"><span class="koboSpan" id="kobo.180.1">Create new</span></strong><span class="koboSpan" id="kobo.181.1">. </span><span class="koboSpan" id="kobo.181.2">Fill in the dialog box, and select </span><strong class="bold"><span class="koboSpan" id="kobo.182.1">CustomVision.Training</span></strong><span class="koboSpan" id="kobo.183.1"> in the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.184.1">Kind</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.185.1"> dropdown.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.186.1">The project type should be </span><strong class="bold"><span class="koboSpan" id="kobo.187.1">Classification</span></strong><span class="koboSpan" id="kobo.188.1">, and the classification type should be </span><strong class="bold"><span class="koboSpan" id="kobo.189.1">Multiclass (Single tag </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.190.1">per image)</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.191.1">.</span></span></p></li>
<li><span class="koboSpan" id="kobo.192.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.193.1">General (compact)</span></strong><span class="koboSpan" id="kobo.194.1"> as the domain. </span><span class="koboSpan" id="kobo.194.2">We use a compact domain if we want to export models and run them on a </span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">mobile device.</span></span></li>
<li><span class="koboSpan" id="kobo.196.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.197.1">Create project</span></strong><span class="koboSpan" id="kobo.198.1"> to </span><a id="_idIndexMarker1311"/><a id="_idIndexMarker1312"/><span class="koboSpan" id="kobo.199.1">continue, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer203">
<span class="koboSpan" id="kobo.201.1"><img alt="Figure 12.1 – Creating a new AI project" src="image/B19214_12_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.202.1">Figure 12.1 – Creating a new AI project</span></p>
<p><span class="koboSpan" id="kobo.203.1">Once </span><a id="_idIndexMarker1313"/><span class="koboSpan" id="kobo.204.1">we </span><a id="_idIndexMarker1314"/><span class="koboSpan" id="kobo.205.1">have created a project, we can start to upload images and </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">tag them.</span></span><a id="_idTextAnchor942"/><a id="_idTextAnchor943"/><a id="_idTextAnchor944"/></p>
<h3><span class="koboSpan" id="kobo.207.1">Tagging images</span></h3>
<p><span class="koboSpan" id="kobo.208.1">The easiest way to get images is to go to Google and search for them. </span><span class="koboSpan" id="kobo.208.2">We will start by adding photos </span><a id="_idIndexMarker1315"/><span class="koboSpan" id="kobo.209.1">of hot dogs by following</span><a id="_idIndexMarker1316"/> <span class="No-Break"><span class="koboSpan" id="kobo.210.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.211.1">Click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.212.1">Add images</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.214.1">Select the photos of hot dogs that should </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">be uploaded.</span></span></li>
<li><span class="koboSpan" id="kobo.216.1">Tag the photos with </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">hotdog</span></strong><span class="koboSpan" id="kobo.218.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.219.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer204">
<span class="koboSpan" id="kobo.220.1"><img alt="Figure 12.2 – Uploading images of hot dogs" src="image/B19214_12_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.221.1">Figure 12.2 – Uploading images of hot dogs</span></p>
<p><span class="koboSpan" id="kobo.222.1">Once we have uploaded all the photos of hot dogs, it’s time to upload photos that aren’t of hot dogs by following the following steps. </span><span class="koboSpan" id="kobo.222.2">For best results, we should also include photos of objects that look similar to hot dogs but </span><span class="No-Break"><span class="koboSpan" id="kobo.223.1">are not:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.224.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.225.1">Add images</span></strong><span class="koboSpan" id="kobo.226.1"> button above the gallery of </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">uploaded images.</span></span></li>
<li><span class="koboSpan" id="kobo.228.1">Select the photos that aren’t of </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">hot dogs.</span></span></li>
<li><span class="koboSpan" id="kobo.230.1">Tag the photos </span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">Negative</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.233.1">.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.234.1">A Negative tag is used for photos that don’t contain any objects that we have created other tags for. </span><span class="koboSpan" id="kobo.234.2">In this case, none of the photos we will upload contain hot dogs, as can</span><a id="_idIndexMarker1317"/><span class="koboSpan" id="kobo.235.1"> be seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">following screenshot:</span></span></p></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer205">
<span class="koboSpan" id="kobo.237.1"><img alt="Figure 12.3 – Uploading images that aren’t hot dogs" src="image/B19214_12_3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.238.1">Figure 12.3 – Uploading images that aren’t hot dogs</span></p>
<p><span class="koboSpan" id="kobo.239.1">Once we</span><a id="_idIndexMarker1318"/><span class="koboSpan" id="kobo.240.1"> have uploaded the photos, it’s time to train </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">a mode</span><a id="_idTextAnchor945"/><a id="_idTextAnchor946"/><a id="_idTextAnchor947"/><span class="koboSpan" id="kobo.242.1">l.</span></span></p>
<h3><span class="koboSpan" id="kobo.243.1">Training a model</span></h3>
<p><span class="koboSpan" id="kobo.244.1">Not all the </span><a id="_idIndexMarker1319"/><span class="koboSpan" id="kobo.245.1">photos that we are uploading will be used for training; some will be used for verification to give us a score about how good the model is. </span><span class="koboSpan" id="kobo.245.2">If we upload photos in chunks and train the model after each chunk, we will be able to see our scores improving. </span><span class="koboSpan" id="kobo.245.3">To train a model, click the green </span><strong class="bold"><span class="koboSpan" id="kobo.246.1">Train</span></strong><span class="koboSpan" id="kobo.247.1"> button at the top of the page, as illustrated in the </span><span class="No-Break"><span class="koboSpan" id="kobo.248.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer206">
<span class="koboSpan" id="kobo.249.1"><img alt="Figure 12.4 – Training the mode﻿l" src="image/B19214_12_4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.250.1">Figure 12.4 – Training the mode</span><a id="_idTextAnchor948"/><span class="koboSpan" id="kobo.251.1">l</span></p>
<p><span class="koboSpan" id="kobo.252.1">The following screenshot shows the result of a training iteration where the precision of the model </span><span class="No-Break"><span class="koboSpan" id="kobo.253.1">is </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.254.1">91.7%</span><a id="_idTextAnchor949"/><a id="_idTextAnchor950"/><a id="_idTextAnchor951"/></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.255.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer207">
<span class="koboSpan" id="kobo.256.1"><img alt="Figure 12.5 – Model verification results" src="image/B19214_12_5.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.257.1">Figure 12.5 – Model verification results</span></p>
<p><span class="koboSpan" id="kobo.258.1">Once we</span><a id="_idIndexMarker1320"/><span class="koboSpan" id="kobo.259.1"> have trained a model, we will export it so that it can be used on </span><span class="No-Break"><span class="koboSpan" id="kobo.260.1">a device.</span></span></p>
<h3><span class="koboSpan" id="kobo.261.1">Exporting a model</span></h3>
<p><span class="koboSpan" id="kobo.262.1">We can </span><a id="_idIndexMarker1321"/><span class="koboSpan" id="kobo.263.1">use the APIs if we want to, but to make fast classifications and to be able to do this offline, we will add the models to the app packages. </span><span class="koboSpan" id="kobo.263.2">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.264.1">Export</span></strong><span class="koboSpan" id="kobo.265.1"> button and then on </span><strong class="bold"><span class="koboSpan" id="kobo.266.1">ONNX</span></strong><span class="koboSpan" id="kobo.267.1"> to download the model, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer208">
<span class="koboSpan" id="kobo.269.1"><img alt="Figure 12.6 – Exporting the model" src="image/B19214_12_6.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.270.1">Figure 12.6 – Exporting the model</span></p>
<p><span class="koboSpan" id="kobo.271.1">Once we</span><a id="_idIndexMarker1322"/><span class="koboSpan" id="kobo.272.1"> have downloaded the ONNX model, it’s time to build </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">the a</span><a id="_idTextAnchor952"/><a id="_idTextAnchor953"/><a id="_idTextAnchor954"/><span class="koboSpan" id="kobo.274.1">pp.</span></span></p>
<h2 id="_idParaDest-199"><a id="_idTextAnchor955"/><span class="koboSpan" id="kobo.275.1">Building the app</span></h2>
<p><span class="koboSpan" id="kobo.276.1">Our app </span><a id="_idIndexMarker1323"/><span class="koboSpan" id="kobo.277.1">will use the trained models to classify photos, according to whether they are photos of hot dogs. </span><span class="koboSpan" id="kobo.277.2">We will use the same ONNX model for all platforms in the .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.278.1">MAUI </span><a id="_idTextAnchor956"/><span class="koboSpan" id="kobo.279.1">app.</span></span></p>
<h3><span class="koboSpan" id="kobo.280.1">Creating the new project</span></h3>
<p><span class="koboSpan" id="kobo.281.1">Let’s begin, </span><span class="No-Break"><span class="koboSpan" id="kobo.282.1">as foll</span><a id="_idTextAnchor957"/><span class="koboSpan" id="kobo.283.1">ows.</span></span></p>
<p><span class="koboSpan" id="kobo.284.1">The </span><a id="_idIndexMarker1324"/><span class="koboSpan" id="kobo.285.1">first step is to create a new .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">MAUI projec:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.287.1">Open Visual Studio 2022, and select </span><strong class="bold"><span class="koboSpan" id="kobo.288.1">Create a </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.289.1">new project</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer209">
<span class="koboSpan" id="kobo.291.1"><img alt="Figure 12.7 – Visual Studio﻿ 2022" src="image/B19214_12_7.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.292.1">Figure 12.7 – Visual Studio</span><a id="_idTextAnchor958"/><span class="koboSpan" id="kobo.293.1"> 2022</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.294.1">This will open the </span><strong class="bold"><span class="koboSpan" id="kobo.295.1">Create a new </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.296.1">project</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.297.1"> wizard.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.298.1">In the</span><a id="_idIndexMarker1325"/><span class="koboSpan" id="kobo.299.1"> search field, type in </span><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">maui</span></strong><span class="koboSpan" id="kobo.301.1">, and select the </span><strong class="bold"><span class="koboSpan" id="kobo.302.1">.NET MAUI App</span></strong><span class="koboSpan" id="kobo.303.1"> item from </span><span class="No-Break"><span class="koboSpan" id="kobo.304.1">the list:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer210">
<span class="koboSpan" id="kobo.305.1"><img alt="Figure 12.8 – Create a new pro﻿ject" src="image/B19214_12_8.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.306.1">Figure 12.8 – Create a new pro</span><a id="_idTextAnchor959"/><span class="koboSpan" id="kobo.307.1">ject</span></p>
<ol>
<li value="3"><span class="No-Break"><span class="koboSpan" id="kobo.308.1">Click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.309.1">Next</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.311.1">Complete </span><a id="_idIndexMarker1326"/><span class="koboSpan" id="kobo.312.1">the next step of the wizard by naming your project. </span><span class="koboSpan" id="kobo.312.2">We will call our application </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">HotdogOrNot</span></strong><span class="koboSpan" id="kobo.314.1"> in this case. </span><span class="koboSpan" id="kobo.314.2">Move on to the next dialog box by clicking </span><strong class="bold"><span class="koboSpan" id="kobo.315.1">Next</span></strong><span class="koboSpan" id="kobo.316.1">, as illustrated in the </span><span class="No-Break"><span class="koboSpan" id="kobo.317.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer211">
<span class="koboSpan" id="kobo.318.1"><img alt="Figure 12.9 – Configure your new pro﻿ject" src="image/B19214_12_9.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.319.1">Figure 12.9 – Configure your new pro</span><a id="_idTextAnchor960"/><span class="koboSpan" id="kobo.320.1">ject</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.321.1">The</span><a id="_idIndexMarker1327"/><span class="koboSpan" id="kobo.322.1"> last step will prompt you for the version of .NET Core to support. </span><span class="koboSpan" id="kobo.322.2">At the time of writing, .NET 6 is available</span><a id="_idIndexMarker1328"/><span class="koboSpan" id="kobo.323.1"> as </span><strong class="bold"><span class="koboSpan" id="kobo.324.1">Long-Term Support</span></strong><span class="koboSpan" id="kobo.325.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.326.1">LTS</span></strong><span class="koboSpan" id="kobo.327.1">), and .NET 7 is </span><a id="_idIndexMarker1329"/><span class="koboSpan" id="kobo.328.1">available as </span><strong class="bold"><span class="koboSpan" id="kobo.329.1">Standard Term Support</span></strong><span class="koboSpan" id="kobo.330.1">. </span><span class="koboSpan" id="kobo.330.2">For the purposes of this book, we will assume that you are using .</span><span class="No-Break"><span class="koboSpan" id="kobo.331.1">NET 7.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer212">
<span class="koboSpan" id="kobo.332.1"><img alt="Figure 12.10 – Additional information" src="image/B19214_12_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.333.1">Figure 12.10 – Additional information</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.334.1">Finalize </span><a id="_idIndexMarker1330"/><span class="koboSpan" id="kobo.335.1">the setup by clicking </span><strong class="bold"><span class="koboSpan" id="kobo.336.1">Create</span></strong><span class="koboSpan" id="kobo.337.1">, and wait for Visual Studio to create </span><span class="No-Break"><span class="koboSpan" id="kobo.338.1">the project.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.339.1">If you run the app now, you should see something like </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer213">
<span class="koboSpan" id="kobo.341.1"><img alt="Figure 12.11 – The HotdogOrNot applicaton" src="image/B19214_12_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.342.1">Figure 12.11 – The HotdogOrNot applicaton</span></p>
<p><span class="koboSpan" id="kobo.343.1">Just like that, the </span><a id="_idIndexMarker1331"/><span class="koboSpan" id="kobo.344.1">app is created. </span><span class="koboSpan" id="kobo.344.2">Next, let’s start creating the </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">image classifier.</span></span></p>
<h3><span class="koboSpan" id="kobo.346.1">Classifying images with machine learning</span></h3>
<p><span class="koboSpan" id="kobo.347.1">The </span><a id="_idIndexMarker1332"/><span class="koboSpan" id="kobo.348.1">first thing we will do is add the ONNX ML model to the project, by following </span><span class="No-Break"><span class="koboSpan" id="kobo.349.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.350.1">Extract the </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">.zip</span></strong><span class="koboSpan" id="kobo.352.1"> file that we got from the Custom </span><span class="No-Break"><span class="koboSpan" id="kobo.353.1">Vision service.</span></span></li>
<li><span class="koboSpan" id="kobo.354.1">Find the </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">.onnx</span></strong><span class="koboSpan" id="kobo.356.1"> file, and rename </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">it </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">hotdog-or-not.onnx</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.360.1">Add it to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.361.1">Resources/Raw</span></strong><span class="koboSpan" id="kobo.362.1"> folder in </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">the project.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.364.1">Once we add the file to the project, we are ready to create the implementation of the image classifier. </span><span class="koboSpan" id="kobo.364.2">The code that we will use for image classification will be shared between the .NET MAUI-supported platforms. </span><span class="koboSpan" id="kobo.364.3">We can create an interface for the classifier by following </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.366.1">Create a new folder </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">ImageClassifier</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.369.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.370.1">Create a new class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">ClassifierOutput</span></strong><span class="koboSpan" id="kobo.372.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">ImageClassifier</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.374.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.375.1">Modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">ClassifierOutput</span></strong><span class="koboSpan" id="kobo.377.1"> class to look like </span><span class="No-Break"><span class="koboSpan" id="kobo.378.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.379.1">
namespace HotdogOrNot.ImageClassifier;
internal sealed class ClassifierOutput
{
    ClassifierOutput() { }
}</span></pre></li> <li><span class="koboSpan" id="kobo.380.1">Create </span><a id="_idIndexMarker1333"/><span class="koboSpan" id="kobo.381.1">a new interface called </span><strong class="source-inline"><span class="koboSpan" id="kobo.382.1">IClassifier</span></strong><span class="koboSpan" id="kobo.383.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.384.1">ImageClassifier</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.385.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.386.1">Add a method called </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">Classify</span></strong><span class="koboSpan" id="kobo.388.1"> that returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">ClassifierOutput</span></strong><span class="koboSpan" id="kobo.390.1"> and takes </span><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">byte[]</span></strong><span class="koboSpan" id="kobo.392.1"> as </span><span class="No-Break"><span class="koboSpan" id="kobo.393.1">an argument.</span></span></li>
<li><span class="koboSpan" id="kobo.394.1">Your interface should look like the following </span><span class="No-Break"><span class="koboSpan" id="kobo.395.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.396.1">
namespace HotdogOrNot.ImageClassifier;
public interface IClassifier
{
    ClassifierOutput Classify(byte[] </span><a id="_idTextAnchor961"/><a id="_idTextAnchor962"/><span class="koboSpan" id="kobo.397.1">bytes);
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.398.1">Now that we have the interface for the classifier, we can move on to </span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">the implementation.</span></span></p>
<h4><span class="koboSpan" id="kobo.400.1">Using ML.NET for image classiﬁcation</span></h4>
<p><span class="koboSpan" id="kobo.401.1">We are now </span><a id="_idIndexMarker1334"/><span class="koboSpan" id="kobo.402.1">ready to create the implementation of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.403.1">IClassifier</span></strong><span class="koboSpan" id="kobo.404.1"> interface. </span><span class="koboSpan" id="kobo.404.2">Before we jump right into the implementation, let’s take a look at the high-level steps that will need to happen so that we understand the flow a </span><span class="No-Break"><span class="koboSpan" id="kobo.405.1">little better.</span></span></p>
<p><span class="koboSpan" id="kobo.406.1">Our trained model, </span><strong class="source-inline"><span class="koboSpan" id="kobo.407.1">hotdog-or-not.onnx</span></strong><span class="koboSpan" id="kobo.408.1">, has specific input and output parameters, and we will need to convert the image that we want to classify into the input format before submitting it to the ML.NET framework. </span><span class="koboSpan" id="kobo.408.2">Additionally, we need to ensure that the image is in the correct shape before submitting it. </span><span class="koboSpan" id="kobo.408.3">The shape of the image is defined by the size, width, height, and color format. </span><span class="koboSpan" id="kobo.408.4">If the image does not match the input format, then it needs to be resized and converted before submission, or you will run the risk of the image being classified incorrectly. </span><span class="koboSpan" id="kobo.408.5">For image classification models that are generated by the Custom Vision service, such as the </span><em class="italic"><span class="koboSpan" id="kobo.409.1">hotdog-or-not</span></em><span class="koboSpan" id="kobo.410.1"> model, the inputs and outputs look like </span><span class="No-Break"><span class="koboSpan" id="kobo.411.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer214">
<span class="koboSpan" id="kobo.412.1"><img alt="Figure 12.12 – Model inputs and outputs from Netron" src="image/B19214_12_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.413.1">Figure 12.12 – Model inputs and outputs from Netron</span></p>
<p><span class="koboSpan" id="kobo.414.1">The input to the model is formatted into a multidimensional array named </span><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">data</span></strong><span class="koboSpan" id="kobo.416.1">. </span><span class="koboSpan" id="kobo.416.2">There are four dimensions that make up </span><span class="No-Break"><span class="koboSpan" id="kobo.417.1">the array:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.418.1">The image</span></strong><span class="koboSpan" id="kobo.419.1">: The format allows you to submit multiple images at once; however, for this app, we will only submit one image at </span><span class="No-Break"><span class="koboSpan" id="kobo.420.1">a time</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.421.1">The color</span></strong><span class="koboSpan" id="kobo.422.1">: Each index in this dimension represents a single-color channel – </span><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">0</span></strong><span class="koboSpan" id="kobo.424.1"> is blue, </span><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">1</span></strong><span class="koboSpan" id="kobo.426.1"> is green, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">2</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.428.1">is red</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.429.1">The height</span></strong><span class="koboSpan" id="kobo.430.1">: Each index is a position along the </span><em class="italic"><span class="koboSpan" id="kobo.431.1">y</span></em><span class="koboSpan" id="kobo.432.1">, or vertical, axis of an image, in the range between 0 </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">and 223</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.434.1">The width</span></strong><span class="koboSpan" id="kobo.435.1">: Each index is a position along the </span><em class="italic"><span class="koboSpan" id="kobo.436.1">x</span></em><span class="koboSpan" id="kobo.437.1">, or horizontal, axis of an image, in the range between 0 </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">and 223</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.439.1">The</span><a id="_idIndexMarker1335"/><span class="koboSpan" id="kobo.440.1"> value is the color value for that specific image, color, and </span><em class="italic"><span class="koboSpan" id="kobo.441.1">x</span></em><span class="koboSpan" id="kobo.442.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.443.1">y</span></em><span class="koboSpan" id="kobo.444.1"> positions. </span><span class="koboSpan" id="kobo.444.2">For example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">data[0,2,64,64]</span></strong><span class="koboSpan" id="kobo.446.1"> would be the value of the green channel in the first image at a position of 64 pixels from the left and 64 pixels from the bottom of </span><span class="No-Break"><span class="koboSpan" id="kobo.447.1">the image.</span></span></p>
<p><span class="koboSpan" id="kobo.448.1">To reduce the number of incorrect classifications, we need to scale all the images for submission to 224 x 224 pixels and order the color </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">channels properly.</span></span></p>
<p><span class="koboSpan" id="kobo.450.1">We can do that by following </span><span class="No-Break"><span class="koboSpan" id="kobo.451.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.452.1">Create a new class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.453.1">MLNetClassifier</span></strong><span class="koboSpan" id="kobo.454.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.455.1">ImageClassifier</span></strong><span class="koboSpan" id="kobo.456.1"> folder of </span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">the project.</span></span></li>
<li><span class="koboSpan" id="kobo.458.1">Add the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.459.1">IClassifier</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.460.1"> interface.</span></span></li>
<li><span class="koboSpan" id="kobo.461.1">Implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.462.1">Classify</span></strong><span class="koboSpan" id="kobo.463.1"> method from the interface, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.464.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.465.1">
namespace HotdogOrNot.ImageClassifier;
internal class MLNetClassifier : Iclassifier
{
    public MLNetClassifier(byte[] model)
    {
        // Initialize Model here
    }
    public ClassifierOutput Classify(byte[] imageBytes)
    {
        // Code will be added here
    }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.466.1">So far, we </span><a id="_idIndexMarker1336"/><span class="koboSpan" id="kobo.467.1">have not referenced any classes from ML.NET. </span><span class="koboSpan" id="kobo.467.2">To use the ML.NET APIs, we will need to add a reference to the NuGet package, by following </span><span class="No-Break"><span class="koboSpan" id="kobo.468.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.469.1">In the project, install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.470.1">Microsoft.ML.OnnxRuntime</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.471.1">NuGet package.</span></span></li>
<li><span class="koboSpan" id="kobo.472.1">Accept any license </span><span class="No-Break"><span class="koboSpan" id="kobo.473.1">dialog boxes.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.474.1">This will install the relevant </span><span class="No-Break"><span class="koboSpan" id="kobo.475.1">NuGet packages.</span></span></p>
<p><span class="koboSpan" id="kobo.476.1">Now that we are referencing the ML.NET package, we can compile the ONNX ML model by following </span><span class="No-Break"><span class="koboSpan" id="kobo.477.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.478.1">At the top of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">MLNetClassifier</span></strong><span class="koboSpan" id="kobo.480.1"> file, add the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">using Microsoft.ML.Onnx</span></strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.482.1">Runtime;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.483.1"> declaration.</span></span></li>
<li><span class="koboSpan" id="kobo.484.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">MLNetClassifier</span></strong><span class="koboSpan" id="kobo.486.1"> class, add the </span><span class="No-Break"><span class="koboSpan" id="kobo.487.1">following fields:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.488.1">
    readonly InferenceSession session;
    readonly bool isBgr;
    readonly bool isRange255;
    readonly string inputName;
    readonly int inputSize;</span></pre></li> <li><span class="koboSpan" id="kobo.489.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.490.1">MLNetClassifier</span></strong><span class="koboSpan" id="kobo.491.1"> constructor, add the following lines of code to initialize the </span><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">OnnxRuntime</span></strong><span class="koboSpan" id="kobo.493.1"> session, replacing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1">// Initialize Model </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">here</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.496.1"> comment:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.497.1">
        Session = new InferenceSession(model);
        isBgr = session.ModelMetadata.CustomMetadataMap["Image.BitmapPixelFormat"] == "Bgr8";
        isRange255 = session.ModelMetadata.CustomMetadataMap["Image.NominalPixelRange"] == "NominalRange_0_255";
        inputName = session.InputMetadata.Keys.First();
        inputSize = session.InputMetadata[inputName].Dimensions[2];</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.498.1">Let’s </span><a id="_idIndexMarker1337"/><span class="koboSpan" id="kobo.499.1">discuss the preceding code before moving on. </span><span class="koboSpan" id="kobo.499.2">The constructor for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">MLNetClassifier</span></strong><span class="koboSpan" id="kobo.501.1"> class accepts </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">byte[]</span></strong><span class="koboSpan" id="kobo.503.1"> as a parameter. </span><span class="koboSpan" id="kobo.503.2">This represents the ML model file. </span><strong class="source-inline"><span class="koboSpan" id="kobo.504.1">byte[]</span></strong><span class="koboSpan" id="kobo.505.1"> is then passed into a new instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">InferenceSession</span></strong><span class="koboSpan" id="kobo.507.1">, which is the main entry point into the ML.NET API. </span><span class="koboSpan" id="kobo.507.2">Once the model is loaded into the session, we can then inspect the model for certain properties, such as the image format (</span><strong class="source-inline"><span class="koboSpan" id="kobo.508.1">isBGR</span></strong><span class="koboSpan" id="kobo.509.1">), the color value range (</span><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">isRange255</span></strong><span class="koboSpan" id="kobo.511.1">), the input name, and the input size. </span><span class="koboSpan" id="kobo.511.2">We cache these values in the class fields for use during classification. </span><span class="koboSpan" id="kobo.511.3">Your </span><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">MLNetClassifier</span></strong><span class="koboSpan" id="kobo.513.1"> class should now look like </span><span class="No-Break"><span class="koboSpan" id="kobo.514.1">the following:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.515.1">using Microsoft.ML.OnnxRuntime;
namespace HotdogOrNot.ImageClassifier;
internal class MLNetClassifier : Iclassifier
{
    readonly InferenceSession session;
    readonly bool isBgr;
    readonly bool isRange255;
    readonly string inputName;
    readonly int inputSize;
    public MLNetClassifier(byte[] model)
    {
        session = new InferenceSession(model);
        isBgr = session.ModelMetadata.CustomMetadataMap["Image.BitmapPixelFormat"] == "Bgr8";
        isRange255 = session.ModelMetadata.CustomMetadataMap["Image.NominalPixelRange"] == "NominalRange_0_255";
        inputName = session.InputMetadata.Keys.First();
        inputSize = session.InputMetadata[inputName].Dimensions[2];
    }
    public ClassifierOutput Classify(byte[] imageBytes)
    {
        // Code will be added </span><a id="_idTextAnchor963"/><span class="koboSpan" id="kobo.516.1">here
    }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.517.1">We can now move on to implementing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.518.1">Classify</span></strong><span class="koboSpan" id="kobo.519.1"> method of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.520.1">MLNetClassifier</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.521.1"> class.</span></span></p>
<p><span class="koboSpan" id="kobo.522.1">The </span><a id="_idIndexMarker1338"/><span class="koboSpan" id="kobo.523.1">first step in running a classification is to get the input into the correct format. </span><span class="koboSpan" id="kobo.523.2">For image classification, that means resizing the image to the right dimensions and organizing the color values into the expected format. </span><span class="koboSpan" id="kobo.523.3">The image data is then loaded into </span><strong class="source-inline"><span class="koboSpan" id="kobo.524.1">Tensor</span></strong><span class="koboSpan" id="kobo.525.1">, which is how we pass data into an ML.NET model. </span><span class="koboSpan" id="kobo.525.2">The following steps will create a method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.526.1">LoadInputTensor</span></strong><span class="koboSpan" id="kobo.527.1"> to do </span><span class="No-Break"><span class="koboSpan" id="kobo.528.1">just that:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.529.1">Add a new method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.530.1">LoadInputTensor</span></strong><span class="koboSpan" id="kobo.531.1"> after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.532.1">Classify</span></strong><span class="koboSpan" id="kobo.533.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.534.1">MLNetClassififier</span></strong><span class="koboSpan" id="kobo.535.1"> class. </span><span class="koboSpan" id="kobo.535.2">This method will accept four parameters, </span><strong class="source-inline"><span class="koboSpan" id="kobo.536.1">byte[]</span></strong><span class="koboSpan" id="kobo.537.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.538.1">int</span></strong><span class="koboSpan" id="kobo.539.1">, and two Booleans, and return a tuple of </span><strong class="source-inline"><span class="koboSpan" id="kobo.540.1">Tensor&lt;float&gt;</span></strong><span class="koboSpan" id="kobo.541.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.542.1">byte[]</span></strong><span class="koboSpan" id="kobo.543.1">. </span><span class="koboSpan" id="kobo.543.2">Your method should look like </span><span class="No-Break"><span class="koboSpan" id="kobo.544.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.545.1">
static (Tensor&lt;float&gt;, byte[] resizedImage) LoadInputTensor(byte[] imageBytes, int imageSize, bool isBgr, bool isRange255)
    {
    }</span></pre></li> <li><span class="koboSpan" id="kobo.546.1">Inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">LoadInputTensor</span></strong><span class="koboSpan" id="kobo.548.1">, we will create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1">return</span></strong><span class="koboSpan" id="kobo.550.1"> objects and add the following highlighted lines </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.552.1">
    {
</span><strong class="bold"><span class="koboSpan" id="kobo.553.1">        var input = new DenseTensor&lt;float&gt;(new[] { 1, 3, imageSize, imageSize });</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.554.1">        byte[] pixelBytes;</span></strong><span class="koboSpan" id="kobo.555.1">
        // Add code here
</span><strong class="bold"><span class="koboSpan" id="kobo.556.1">        return (input, pixelBytes);</span></strong><span class="koboSpan" id="kobo.557.1">
    }</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.558.1">The next step is to resize the image; we will use</span><a id="_idIndexMarker1339"/><span class="koboSpan" id="kobo.559.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.560.1">ImageSharp</span></strong><span class="koboSpan" id="kobo.561.1"> NuGet library to make this </span><span class="No-Break"><span class="koboSpan" id="kobo.562.1">very easy.</span></span></p></li> <li><span class="koboSpan" id="kobo.563.1">Add the ImageSharp NuGet package to </span><span class="No-Break"><span class="koboSpan" id="kobo.564.1">the project.</span></span></li>
<li><span class="koboSpan" id="kobo.565.1">Add </span><a id="_idIndexMarker1340"/><span class="koboSpan" id="kobo.566.1">the following lines of code to resize the image, replacing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">\\ Add code </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.568.1">here</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.569.1"> comment:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.570.1">
using (var image = Image.Load&lt;Rgb24&gt;(imageBytes))
    {
        image.Mutate(x =&gt; x.Resize(imageSize, imageSize));
        pixelBytes = new byte[image.Width * image.Height * Unsafe.SizeOf&lt;Rgba32&gt;()];
        image.ProcessPixelRows(source =&gt;
        {
            // Add Code here
        });
    }</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.571.1">This code uses the ImageSharp library to load the image from </span><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">byte[]</span></strong><span class="koboSpan" id="kobo.573.1">. </span><span class="koboSpan" id="kobo.573.2">The image is then resized to the size required by the model. </span><span class="koboSpan" id="kobo.573.3">We use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">imageSize</span></strong><span class="koboSpan" id="kobo.575.1"> field, whose value captures the model requirement from the constructor. </span><span class="koboSpan" id="kobo.575.2">Finally, we set up a call to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.576.1">ProcessPixelRows</span></strong><span class="koboSpan" id="kobo.577.1"> method that will allow us to manipulate the individual pixels in </span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">the image.</span></span></p></li> <li><span class="koboSpan" id="kobo.579.1">Due to conflicts in naming between .NET MAUI and ImageSharp, we must add a declaration that tells the compiler which class we really want to use at the top of </span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">the file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.581.1">
using Image = SixLabors.ImageSharp.Image;</span></pre></li> <li><span class="koboSpan" id="kobo.582.1">The next section of code will also need the following </span><span class="No-Break"><span class="koboSpan" id="kobo.583.1">highlighted declarations:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.584.1">
using Microsoft.ML.OnnxRuntime;
</span><strong class="bold"><span class="koboSpan" id="kobo.585.1">using SixLabors.ImageSharp.Formats.Png</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.586.1">using Microsoft.ML.OnnxRuntime.Tensors;</span></strong><span class="koboSpan" id="kobo.587.1">
using Image = SixLabors.ImageSharp.Image;</span></pre></li> <li><span class="koboSpan" id="kobo.588.1">To get</span><a id="_idIndexMarker1341"/><span class="koboSpan" id="kobo.589.1"> the input image into the correct color format required by the model, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.590.1">ProcessPixelRows</span></strong><span class="koboSpan" id="kobo.591.1"> method from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">ImageSharp</span></strong><span class="koboSpan" id="kobo.593.1"> library. </span><span class="koboSpan" id="kobo.593.2">This method provides a writable buffer for us to manipulate. </span><span class="koboSpan" id="kobo.593.3">Use the following highlighted code, in place of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">// Add Code here</span></strong><span class="koboSpan" id="kobo.595.1"> comment, to iterate over the resized image data, putting the color values into the right order and clamping the values between 0 and 255, </span><span class="No-Break"><span class="koboSpan" id="kobo.596.1">if required:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.597.1">
image.ProcessPixelRows(source =&gt;
{
</span><strong class="bold"><span class="koboSpan" id="kobo.598.1">    for (int y = 0; y &lt; image.Height; y++)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.599.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.600.1">        Span&lt;Rgb24&gt; pixelSpan = source.GetRowSpan(y);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.601.1">        for (int x = 0; x &lt; image.Width; x++)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.602.1">        {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.603.1">            if (isBgr)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.604.1">            {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.605.1">                input[0, 0, y, x] = pixelSpan[x].B;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.606.1">                input[0, 1, y, x] = pixelSpan[x].G;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.607.1">                input[0, 2, y, x] = pixelSpan[x].R;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.608.1">            }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.609.1">            else</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.610.1">            {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.611.1">                input[0, 0, y, x] = pixelSpan[x].R;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.612.1">                input[0, 1, y, x] = pixelSpan[x].G;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.613.1">                input[0, 2, y, x] = pixelSpan[x].B;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.614.1">            }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.615.1">            if (!isRange255)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.616.1">            {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.617.1">                input[0, 0, y, x] = input[0, 0, y, x] / 255;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.618.1">                input[0, 1, y, x] = input[0, 1, y, x] / 255;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.619.1">                input[0, 2, y, x] = input[0, 2, y, x] / 255;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.620.1">             }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.621.1">         }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.622.1">     }</span></strong><span class="koboSpan" id="kobo.623.1">
});</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.624.1">What </span><a id="_idIndexMarker1342"/><span class="koboSpan" id="kobo.625.1">this code does is simple – using the provided source variable, it iterates over each row in the image, and each pixel in the row. </span><span class="koboSpan" id="kobo.625.2">If the model expects the colors to be in the blue, green, and red order, </span><strong class="source-inline"><span class="koboSpan" id="kobo.626.1">isBGR</span></strong><span class="koboSpan" id="kobo.627.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">true</span></strong><span class="koboSpan" id="kobo.629.1">, and then the extracted color values are placed in the input tensor in that order; otherwise, they are added to the input tensor in the red, green, and blue order. </span><span class="koboSpan" id="kobo.629.2">The tricky part here is accessing the correct element for each pixel. </span><span class="koboSpan" id="kobo.629.3">The tensor is organized into four dimensions, as explained previously. </span><span class="koboSpan" id="kobo.629.4">The first element will always be zero for this model, since we are only processing one image at a time. </span><span class="koboSpan" id="kobo.629.5">The second dimension is the color channel, so you will see that change for the red, green, and blue </span><span class="No-Break"><span class="koboSpan" id="kobo.630.1">color values.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.631.1">Finally, if the model expects color values to be in the range of 0 to 255, </span><strong class="source-inline"><span class="koboSpan" id="kobo.632.1">isRange255</span></strong><span class="koboSpan" id="kobo.633.1">, then each color channel is clamped to </span><span class="No-Break"><span class="koboSpan" id="kobo.634.1">that range.</span></span></p></li> <li><span class="koboSpan" id="kobo.635.1">The last </span><a id="_idIndexMarker1343"/><span class="koboSpan" id="kobo.636.1">thing that we will do is copy the contents of the resized image to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.637.1">pixelBytes</span></strong><span class="koboSpan" id="kobo.638.1"> array so that we can display the image to the user. </span><span class="koboSpan" id="kobo.638.2">Add the following highlighted code to do this; note that the previous code has been omitted </span><span class="No-Break"><span class="koboSpan" id="kobo.639.1">for brevity:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.640.1">
            });
</span><strong class="bold"><span class="koboSpan" id="kobo.641.1">            var outStream = new MemoryStream();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.642.1">            image.Save(outStream, new PngEncoder());</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.643.1">            pixelBytes = outStream.ToArray();</span></strong><span class="koboSpan" id="kobo.644.1">
        }
        return (input, pixelBytes);</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.645.1">Now that we have written the code to process the image and populate the input tensor, we can complete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.646.1">Classify</span></strong><span class="koboSpan" id="kobo.647.1"> method by following </span><span class="No-Break"><span class="koboSpan" id="kobo.648.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.649.1">Replace the </span><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">// Code will be added here</span></strong><span class="koboSpan" id="kobo.651.1"> comment with a call to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.652.1">LoadInputTensor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.653.1"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.654.1">
    public ClassifierOutput Classify(byte[] imageBytes)
    {
</span><strong class="bold"><span class="koboSpan" id="kobo.655.1">        (Tensor&lt;float&gt; tensor, byte[] resizedImage) = LoadInputTensor(imageBytes, inputSize, isBgr, isRange255);</span></strong><span class="koboSpan" id="kobo.656.1">
    }</span></pre></li> <li><span class="koboSpan" id="kobo.657.1">Next, we can run the session, passing in the newly created input tensor and capturing </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">the result:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.659.1">
    public ClassifierOutput Classify(byte[] imageBytes)
    {
        (Tensor&lt;float&gt; tensor, byte[] resizedImage) = LoadInputTensor(imageBytes, inputSize, isBgr, isRange255);
</span><strong class="bold"><span class="koboSpan" id="kobo.660.1">        var resultsCollection = session.Run(new List&lt;NamedOnnxValue&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.661.1">        {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.662.1">                    NamedOnnxValue.CreateFromTensor&lt;float&gt;(inputName, tensor)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.663.1">         });</span></strong><span class="koboSpan" id="kobo.664.1">
    }</span></pre></li> <li><span class="koboSpan" id="kobo.665.1">We </span><a id="_idIndexMarker1344"/><span class="koboSpan" id="kobo.666.1">grab the label from the output result, which will be used to determine whether this image contains a hotdog </span><span class="No-Break"><span class="koboSpan" id="kobo.667.1">or not:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.668.1">
    public ClassifierOutput Classify(byte[] imageBytes)
    {
        (Tensor&lt;float&gt; tensor, byte[] resizedImage) = LoadInputTensor(imageBytes, inputSize, isBgr, isRange255);
        var resultsCollection = session.Run(new List&lt;NamedOnnxValue&gt;
                {
                    NamedOnnxValue.CreateFromTensor&lt;float&gt;(inputName, tensor)
                });
</span><strong class="bold"><span class="koboSpan" id="kobo.669.1">        var topLabel = resultsCollection</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.670.1">            ?.FirstOrDefault(i =&gt; i.Name == "classLabel")</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.671.1">            ?.AsTensor&lt;string&gt;()</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.672.1">            ?.First();</span></strong><span class="koboSpan" id="kobo.673.1">
    }</span></pre></li> <li><span class="koboSpan" id="kobo.674.1">Then, we </span><a id="_idIndexMarker1345"/><span class="koboSpan" id="kobo.675.1">can get the confidence level of the result, which tells us how sure the model is of the classification. </span><span class="koboSpan" id="kobo.675.2">This will be used when we</span><a id="_idTextAnchor964"/><span class="koboSpan" id="kobo.676.1"> display </span><span class="No-Break"><span class="koboSpan" id="kobo.677.1">the result:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.678.1">
    public ClassifierOutput Classify(byte[] imageBytes)
    {
        (Tensor&lt;float&gt; tensor, byte[] resizedImage) = LoadInputTensor(imageBytes, inputSize, isBgr, isRange255);
        var resultsCollection = session.Run(new List&lt;NamedOnnxValue&gt;
                {
                    NamedOnnxValue.CreateFromTensor&lt;float&gt;(inputName, tensor)
                });
        var topLabel = resultsCollection
            ?.FirstOrDefault(i =&gt; i.Name == "classLabel")
            ?.AsTensor&lt;string&gt;()
            ?.First();
</span><strong class="bold"><span class="koboSpan" id="kobo.679.1">        var labelScores = resultsCollection</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.680.1">            ?.FirstOrDefault(i =&gt; i.Name == "loss")</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.681.1">            ?.AsEnumerable&lt;NamedOnnxValue&gt;()</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.682.1">            ?.First()</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.683.1">            ?.AsDictionary&lt;string, float&gt;();</span></strong><span class="koboSpan" id="kobo.684.1">
    }</span></pre></li> <li><span class="koboSpan" id="kobo.685.1">Finally, we</span><a id="_idIndexMarker1346"/><span class="koboSpan" id="kobo.686.1"> can return the result of the classification using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.687.1">ClassifierOutput</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.688.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.689.1">
    public ClassifierOutput Classify(byte[] imageBytes)
    {
        (Tensor&lt;float&gt; tensor, byte[] resizedImage) = LoadInputTensor(imageBytes, inputSize, isBgr, isRange255);
        var resultsCollection = session.Run(new List&lt;NamedOnnxValue&gt;
                {
                    NamedOnnxValue.CreateFromTensor&lt;float&gt;(inputName, tensor)
                });
        var topLabel = resultsCollection
            ?.FirstOrDefault(i =&gt; i.Name == "classLabel")
            ?.AsTensor&lt;string&gt;()
            ?.First();
        var labelScores = resultsCollection
            ?.FirstOrDefault(i =&gt; i.Name == "loss")
            ?.AsEnumerable&lt;NamedOnnxValue&gt;()
            ?.First()
            ?.AsDictionary&lt;string, float&gt;();
</span><strong class="bold"><span class="koboSpan" id="kobo.690.1">        return ClassifierOutput.Create(topLabel, labelScores, resizedImage);</span></strong><span class="koboSpan" id="kobo.691.1">
    }</span></pre></li> <li><span class="koboSpan" id="kobo.692.1">The last </span><a id="_idIndexMarker1347"/><span class="koboSpan" id="kobo.693.1">step is to finish the </span><strong class="source-inline"><span class="koboSpan" id="kobo.694.1">MLNetClassifier</span></strong><span class="koboSpan" id="kobo.695.1"> implementation by implementing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.696.1">ClassifierOutput</span></strong><span class="koboSpan" id="kobo.697.1"> class. </span><span class="koboSpan" id="kobo.697.2">Update your </span><strong class="source-inline"><span class="koboSpan" id="kobo.698.1">ClassifierOutput</span></strong><span class="koboSpan" id="kobo.699.1"> class by adding the </span><span class="No-Break"><span class="koboSpan" id="kobo.700.1">highlighted code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.701.1">
internal sealed class ClassifierOutput
{
</span><strong class="bold"><span class="koboSpan" id="kobo.702.1">    public string TopResultLabel { get; private set; }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.703.1">    public float TopResultScore { get; private set; }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.704.1">    public IDictionary&lt;string, float&gt; LabelScores { get; private set; }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.705.1">    public byte[] Image { get; private set; }</span></strong><span class="koboSpan" id="kobo.706.1">
    ClassifierOutput() { }
</span><strong class="bold"><span class="koboSpan" id="kobo.707.1">    public static ClassifierOutput Create(string topLabel, IDictionary&lt;string, float&gt; labelScores, byte[] image)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.708.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.709.1">        var topLabelValue = topLabel ?? </span><span class="koboSpan" id="kobo.709.2">throw new ArgumentException(nameof(topLabel));</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.710.1">        var labelScoresValue = labelScores ?? </span><span class="koboSpan" id="kobo.710.2">throw new ArgumentException(nameof(labelScores));</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.711.1">        return new ClassifierOutput</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.712.1">        {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.713.1">            TopResultLabel = topLabelValue,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.714.1">            TopResultScore = labelScoresValue.First(i =&gt; i.Key == topLabelValue).Value,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.715.1">            LabelScores = labelScoresValue,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.716.1">            Image = image,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.717.1">        };</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.718.1">    }</span></strong><span class="koboSpan" id="kobo.719.1">
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.720.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.721.1">ClassifierOutput</span></strong><span class="koboSpan" id="kobo.722.1"> class is used to encapsulate the four values that will be used in the UI and expose them as public properties. </span><span class="koboSpan" id="kobo.722.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.723.1">Create</span></strong><span class="koboSpan" id="kobo.724.1"> static method is used to create an</span><a id="_idIndexMarker1348"/><span class="koboSpan" id="kobo.725.1"> instance of the class. </span><span class="koboSpan" id="kobo.725.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">Create</span></strong><span class="koboSpan" id="kobo.727.1"> method validates the arguments provided and sets the public properties appropriately for use by </span><span class="No-Break"><span class="koboSpan" id="kobo.728.1">the UI.</span></span></p>
<p><span class="koboSpan" id="kobo.729.1">We have now written the code to recognize hot dogs in </span><span class="No-Break"><span class="koboSpan" id="kobo.730.1">an image.</span></span></p>
<p><span class="koboSpan" id="kobo.731.1">Now, we can build the user interface for the application and call </span><strong class="source-inline"><span class="koboSpan" id="kobo.732.1">MLNetClasssifier</span></strong><span class="koboSpan" id="kobo.733.1"> to classify </span><span class="No-Break"><span class="koboSpan" id="kobo.734.1">an image.</span></span></p>
<h3><span class="koboSpan" id="kobo.735.1">Requesting app permissions</span></h3>
<p><span class="koboSpan" id="kobo.736.1">Before we</span><a id="_idIndexMarker1349"/><span class="koboSpan" id="kobo.737.1"> dive right into building the rest of the app functionality, we need to address permissions. </span><span class="koboSpan" id="kobo.737.2">This app will have two buttons that the user will use, one to take a photo and another to select a photo from the device. </span><span class="koboSpan" id="kobo.737.3">This is similar to the functionality that we saw in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.738.1">Chapter 6</span></em></span><span class="koboSpan" id="kobo.739.1">, </span><em class="italic"><span class="koboSpan" id="kobo.740.1">Building a Photo Gallery App Using CollectionView and CarouselView</span></em><span class="koboSpan" id="kobo.741.1">, where we needed to request permission from the user before accessing the camera or device storage. </span><span class="koboSpan" id="kobo.741.2">However, we will implement the permissions differently than we did in that chapter. </span><span class="koboSpan" id="kobo.741.3">Since gaining access to the camera and accessing photos on the user’s device requires separate permissions, we will request them from each </span><span class="No-Break"><span class="koboSpan" id="kobo.742.1">button handler.</span></span></p>
<p><span class="koboSpan" id="kobo.743.1">Follow these steps to add a class to help us with the </span><span class="No-Break"><span class="koboSpan" id="kobo.744.1">permission checks:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.745.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.746.1">AppPermissions</span></strong><span class="koboSpan" id="kobo.747.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.748.1">the project.</span></span></li>
<li><span class="koboSpan" id="kobo.749.1">Modify the class definition to add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.750.1">partial</span></strong><span class="koboSpan" id="kobo.751.1"> modifier, and remove the </span><span class="No-Break"><span class="koboSpan" id="kobo.752.1">default constructor:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.753.1">
namespace HotdogOrNot;
internal partial class AppPermissions
{
}</span></pre></li> <li><span class="koboSpan" id="kobo.754.1">Add the following method to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.755.1">AppPermissions</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.756.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.757.1">
    public static async Task&lt;PermissionStatus&gt; CheckRequiredPermission&lt;TPermission&gt;() where TPermission : Permissions.BasePermission, new() =&gt; await Permissions.CheckStatusAsync&lt;TPermission&gt;();</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.758.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.759.1">CheckRequiredPermission</span></strong><span class="koboSpan" id="kobo.760.1"> method is used to ensure that our app has the</span><a id="_idIndexMarker1350"/><span class="koboSpan" id="kobo.761.1"> right permissions before we attempt any operations that might fail if we don’t. </span><span class="koboSpan" id="kobo.761.2">Its implementation is to call the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">CheckSyncStatus</span></strong><span class="koboSpan" id="kobo.763.1"> with the provided permission type in </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">TPermission</span></strong><span class="koboSpan" id="kobo.765.1">. </span><span class="koboSpan" id="kobo.765.2">It returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">PermissionStatus</span></strong><span class="koboSpan" id="kobo.767.1">, which is </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">enum</span></strong><span class="koboSpan" id="kobo.769.1">. </span><span class="koboSpan" id="kobo.769.2">We are mostly interested in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">Denied</span></strong><span class="koboSpan" id="kobo.771.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.772.1">Granted</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.773.1"> values.</span></span></p></li> <li><span class="koboSpan" id="kobo.774.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.775.1">CheckAndRequestRequiredPermission</span></strong><span class="koboSpan" id="kobo.776.1"> method to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">AppPermissions</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.778.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.779.1">
    public static async Task&lt;PermissionStatus&gt; CheckAndRequestRequiredPermission() &lt;TPermission&gt;() where TPermission : Permissions.BasePermission, new()
    {
        PermissionStatus status = await Permissions.CheckStatusAsync&lt; TPermission &gt;();
        if (status == PermissionStatus.Granted)
            return status;
        if (status == PermissionStatus.Denied &amp;&amp; DeviceInfo.Platform == DevicePlatform.iOS)
        {
            // Prompt the user to turn on in settings
            // On iOS once a permission has been denied it may not be requested again from the application
            await App.Current.MainPage.DisplayAlert("Required App Permissions", "Please enable all permissions in Settings for this App, it is useless without them.", "Ok");
        }
        if (Permissions.ShouldShowRationale&lt; TPermission &gt;())
        {
            // Prompt the user with additional information as to why the permission is needed
            await App.Current.MainPage.DisplayAlert("Required App Permissions", "This app uses photos, without these permissions it is useless.", "Ok");
        }
        status = await MainThread.InvokeOnMainThreadAsync(Permissions.RequestAsync&lt;TPermission&gt;);
        return status;
    }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.780.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.781.1">CheckAndRequestRequiredPermission</span></strong><span class="koboSpan" id="kobo.782.1"> method handles the intricacies of </span><a id="_idIndexMarker1351"/><span class="koboSpan" id="kobo.783.1">requesting access from the user. </span><span class="koboSpan" id="kobo.783.2">The first step is to simply check and see whether the permission has already been granted and, if it has, return the status. </span><span class="koboSpan" id="kobo.783.3">Next, if we are on iOS and the permission has been denied, it cannot be requested again, so you must instruct the user on how to grant permission to the app by using the settings panel. </span><span class="koboSpan" id="kobo.783.4">Android includes in the request behavior the ability to nag the user if they have denied access. </span><span class="koboSpan" id="kobo.783.5">This behavior is exposed through .NET MAUI with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.784.1">ShouldShowRationale</span></strong><span class="koboSpan" id="kobo.785.1"> method. </span><span class="koboSpan" id="kobo.785.2">It will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.786.1">false</span></strong><span class="koboSpan" id="kobo.787.1"> for any platform that does not support this behavior, and on Android, it will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.788.1">true</span></strong><span class="koboSpan" id="kobo.789.1"> the first time after the user denies access and </span><strong class="source-inline"><span class="koboSpan" id="kobo.790.1">false</span></strong><span class="koboSpan" id="kobo.791.1"> if the user denies it a </span><a id="_idIndexMarker1352"/><span class="koboSpan" id="kobo.792.1">second time. </span><span class="koboSpan" id="kobo.792.2">Finally, we request access to the permission from the user. </span><span class="koboSpan" id="kobo.792.3">Again, .NET MAUI hides all the platform implementation details from us, making checking and requesting access to certain resources </span><span class="No-Break"><span class="koboSpan" id="kobo.793.1">very straightforward.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.794.1">Look familiar?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.795.1">If the preceding code looks familiar, then you are right. </span><span class="koboSpan" id="kobo.795.2">It is based on the implementation that is described in the .NET MAUI documentation. </span><span class="koboSpan" id="kobo.795.3">You can find it </span><span class="No-Break"><span class="koboSpan" id="kobo.796.1">at </span></span><a href="https://learn.microsoft.com/en-us/dotnet/maui/platform-integration/appmodel/permissions"><span class="No-Break"><span class="koboSpan" id="kobo.797.1">https://learn.microsoft.com/en-us/dotnet/maui/platform-integration/appmodel/permissions</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.798.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.799.1">Now that we have the shared </span><strong class="source-inline"><span class="koboSpan" id="kobo.800.1">AppPermissions</span></strong><span class="koboSpan" id="kobo.801.1"> in place, we can start with</span><a id="_idTextAnchor965"/><span class="koboSpan" id="kobo.802.1"> the platform configuration. </span><span class="koboSpan" id="kobo.802.2">Before we can use the media picker, however, we need to do some configuration for each platform. </span><span class="koboSpan" id="kobo.802.3">We will start </span><span class="No-Break"><span class="koboSpan" id="kobo.803.1">with Android.</span></span></p>
<p><span class="koboSpan" id="kobo.804.1">In Android API version 33, three new permissions were added to enable read access to media files – </span><strong class="source-inline"><span class="koboSpan" id="kobo.805.1">ReadMediaImages</span></strong><span class="koboSpan" id="kobo.806.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.807.1">ReadMediaVideos</span></strong><span class="koboSpan" id="kobo.808.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.809.1">ReadMediaAudio</span></strong><span class="koboSpan" id="kobo.810.1">. </span><span class="koboSpan" id="kobo.810.2">Prior to API version 33, all that was required was the </span><strong class="source-inline"><span class="koboSpan" id="kobo.811.1">ReadExternalStorage</span></strong><span class="koboSpan" id="kobo.812.1"> permission. </span><span class="koboSpan" id="kobo.812.2">To access the camera, we will need both </span><strong class="source-inline"><span class="koboSpan" id="kobo.813.1">Camera</span></strong><span class="koboSpan" id="kobo.814.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.815.1">WriteExternalStorage</span></strong><span class="koboSpan" id="kobo.816.1"> permissions. </span><span class="koboSpan" id="kobo.816.2">To properly request the correct permission for the API version of the device, open </span><strong class="source-inline"><span class="koboSpan" id="kobo.817.1">MauiApplication.cs</span></strong><span class="koboSpan" id="kobo.818.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.819.1">Platform/Android</span></strong><span class="koboSpan" id="kobo.820.1"> folder and modify it to look like </span><span class="No-Break"><span class="koboSpan" id="kobo.821.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.822.1">
using Android.App;
using Android.Runtime;
</span><strong class="bold"><span class="koboSpan" id="kobo.823.1">// Needed for Picking photo/video</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.824.1">[assembly: UsesPermission(Android.Manifest.Permission.ReadExternalStorage, MaxSdkVersion = 32)]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.825.1">[assembly: UsesPermission(Android.Manifest.Permission.ReadMediaImages)]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.826.1">// Needed for Taking photo/video</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.827.1">[assembly: UsesPermission(Android.Manifest.Permission.Camera)]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.828.1">[assembly: UsesPermission(Android.Manifest.Permission.WriteExternalStorage)]</span></strong></pre> <p><span class="koboSpan" id="kobo.829.1">Finally, for </span><a id="_idIndexMarker1353"/><span class="koboSpan" id="kobo.830.1">Android, we need to declare usage of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.831.1">IMAGE_CAPTURE</span></strong><span class="koboSpan" id="kobo.832.1"> intent as follows in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.833.1">AndroidManifest.xml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.834.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.835.1">
  &lt;queries&gt;
    &lt;intent&gt;
      &lt;action android:name="android.media.action.IMAGE_CAPTURE" /&gt;
    &lt;/intent&gt;
  &lt;/queries&gt;</span></pre> <p><span class="koboSpan" id="kobo.836.1">For iOS and Mac Catalyst, the only thing we need to do is add the following four usage descriptions to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.837.1">info.plist</span></strong><span class="koboSpan" id="kobo.838.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.839.1">platform/ios</span></strong><span class="koboSpan" id="kobo.840.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.841.1">platform/maccatalyst</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.842.1"> folders:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.843.1">
&lt;key&gt;NSCameraUsageDescription&lt;/key&gt;
&lt;string&gt;This app needs access to the camera to take photos.&lt;/string&gt;
&lt;key&gt;NSPhotoLibraryUsageDescription&lt;/key&gt;
&lt;string&gt;This app needs access to photos.&lt;/string&gt;
&lt;key&gt;NSMicrophoneUsageDescription&lt;/key&gt;
&lt;string&gt;This app needs access to microphone.&lt;/string&gt;
&lt;key&gt;NSPhotoLibraryAddUsageDescription&lt;/key&gt;
&lt;string&gt;This app needs access to the photo gallery.&lt;/string&gt;</span></pre> <p><span class="koboSpan" id="kobo.844.1">For </span><a id="_idIndexMarker1354"/><span class="koboSpan" id="kobo.845.1">Windows, we need to add the following highlighted code to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.846.1">Capabilities</span></strong><span class="koboSpan" id="kobo.847.1"> section of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.848.1">package.appxmanifest</span></strong><span class="koboSpan" id="kobo.849.1"> file in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.850.1">platforms/windows</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.851.1"> folder:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.852.1">
&lt;Capabilities&gt;
  &lt;rescap:Capability Name="runFullTrust" /&gt;
  </span><strong class="bold"><span class="koboSpan" id="kobo.853.1">&lt;DeviceCapability Name="webcam"/&gt;</span></strong><span class="koboSpan" id="kobo.854.1">
&lt;/Capabilities&gt;</span></pre> <p><span class="koboSpan" id="kobo.855.1">Now that we have declared the permissions we need for each platform, we can implement the remaining functionality to take a photo or pick an </span><span class="No-Break"><span class="koboSpan" id="kobo.856.1">existing image.</span></span></p>
<h3><span class="koboSpan" id="kobo.857.1">Building the first view</span></h3>
<p><span class="koboSpan" id="kobo.858.1">The</span><a id="_idIndexMarker1355"/><span class="koboSpan" id="kobo.859.1"> first view in this app will be a simple view </span><a id="_idIndexMarker1356"/><span class="koboSpan" id="kobo.860.1">with two buttons. </span><span class="koboSpan" id="kobo.860.2">One button will be to start the camera so that users can take a photo of something to determine whether it is a hot dog. </span><span class="koboSpan" id="kobo.860.3">The other button will be to pick a photo from the photo library of the device. </span><span class="koboSpan" id="kobo.860.4">We will continue to use the MVVM pattern in this chapter, so we will split the view into two classes, </span><strong class="source-inline"><span class="koboSpan" id="kobo.861.1">MainView</span></strong><span class="koboSpan" id="kobo.862.1"> for the UI visible to the user and </span><strong class="source-inline"><span class="koboSpan" id="kobo.863.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.864.1"> for the </span><span class="No-Break"><span class="koboSpan" id="kobo.865.1">actual implementation.</span></span></p>
<h3><span class="koboSpan" id="kobo.866.1">Building the ViewModel class</span></h3>
<p><span class="koboSpan" id="kobo.867.1">We will </span><a id="_idIndexMarker1357"/><span class="koboSpan" id="kobo.868.1">start by creating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.869.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.870.1"> class, which will handle what will happen when a user taps one of the buttons. </span><span class="koboSpan" id="kobo.870.2">Let’s set this up by going through the </span><span class="No-Break"><span class="koboSpan" id="kobo.871.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.872.1">Create a new folder </span><span class="No-Break"><span class="koboSpan" id="kobo.873.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.874.1">ViewModels</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.875.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.876.1">Add a NuGet reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.877.1">CommunityToolkit.Mvvm</span></strong><span class="koboSpan" id="kobo.878.1">; we use </span><strong class="source-inline"><span class="koboSpan" id="kobo.879.1">CommunityToolkit.Mvvm</span></strong><span class="koboSpan" id="kobo.880.1"> to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.881.1">INotifyPropertyChanged</span></strong><span class="koboSpan" id="kobo.882.1"> interface and commands, as we did in </span><span class="No-Break"><span class="koboSpan" id="kobo.883.1">other chapters.</span></span></li>
<li><span class="koboSpan" id="kobo.884.1">Create </span><a id="_idIndexMarker1358"/><span class="koboSpan" id="kobo.885.1">a new partial class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.886.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.887.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.888.1">ViewModels</span></strong><span class="koboSpan" id="kobo.889.1"> folder, using </span><strong class="source-inline"><span class="koboSpan" id="kobo.890.1">ObservableObject</span></strong><span class="koboSpan" id="kobo.891.1"> from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.892.1">CommunityToolkit.Mvvm.ComponentModel</span></strong><span class="koboSpan" id="kobo.893.1"> namespace as a </span><span class="No-Break"><span class="koboSpan" id="kobo.894.1">base class.</span></span></li>
<li><span class="koboSpan" id="kobo.895.1">Create a private field of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.896.1">IClassifier</span></strong><span class="koboSpan" id="kobo.897.1"> type and call it </span><strong class="source-inline"><span class="koboSpan" id="kobo.898.1">classifier</span></strong><span class="koboSpan" id="kobo.899.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.900.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.901.1">
using CommunityToolkit.Mvvm.ComponentModel;
using HotdogOrNot.ImageClassifier;
namespace HotdogOrNot.ViewModels;
public partial class MainViewModel : ObservableObject
{
    </span><strong class="bold"><span class="koboSpan" id="kobo.902.1">private IClassifier classifier;</span></strong><span class="koboSpan" id="kobo.903.1">
    public MainViewModel()
    {
    }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.904.1">Initializing the ONNX model requires the use of asynchronous methods, so we need to handle them carefully, since we will be calling them from the constructor and the button handlers. </span><span class="koboSpan" id="kobo.904.2">The</span><a id="_idIndexMarker1359"/><span class="koboSpan" id="kobo.905.1"> following steps will create the </span><span class="No-Break"><span class="koboSpan" id="kobo.906.1">model initializer:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.907.1">Create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">InitTask</span></strong><span class="koboSpan" id="kobo.909.1"> property that is of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.910.1">Task</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.911.1"> type.</span></span></li>
<li><span class="koboSpan" id="kobo.912.1">Use a property initializer to set it to a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">Task</span></strong><span class="koboSpan" id="kobo.914.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.915.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.916.1">Task.Run</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.917.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.918.1">Initialize the model from the raw resources of the .NET MAUI app. </span><span class="koboSpan" id="kobo.918.2">The method should look like the </span><span class="No-Break"><span class="koboSpan" id="kobo.919.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.920.1">
    Task InitTask() =&gt; Task.Run(async () =&gt;
    {
        using var modelStream = await FileSystem.OpenAppPackageFileAsync("hotdog-or-not.onnx");
        using var modelMemoryStream = new MemoryStream();
        modelStream.CopyTo(modelMemoryStream);
        var model = modelMemoryStream.ToArray();
        _classifier = new MLNetClassifier(model);
    });</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.921.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.922.1">InitTask</span></strong><span class="koboSpan" id="kobo.923.1"> property holds a reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.924.1">Task</span></strong><span class="koboSpan" id="kobo.925.1"> that does </span><span class="No-Break"><span class="koboSpan" id="kobo.926.1">the following:</span></span></p><ul><li><span class="koboSpan" id="kobo.927.1">Loads the </span><strong class="source-inline"><span class="koboSpan" id="kobo.928.1">hotdog-or-not.onnx</span></strong><span class="koboSpan" id="kobo.929.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.930.1">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.931.1">Stream</span></strong></span></li><li><span class="koboSpan" id="kobo.932.1">Copies the bytes from the original stream to an array of bytes so that the original stream can be closed and any native resources, such as file handles, can </span><span class="No-Break"><span class="koboSpan" id="kobo.933.1">be released.</span></span></li><li><span class="koboSpan" id="kobo.934.1">Creates and returns a new instance of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.935.1">MLNetClassifier</span></strong><span class="koboSpan" id="kobo.936.1"> class using the </span><span class="No-Break"><span class="koboSpan" id="kobo.937.1">loaded model.</span></span></li></ul></li> <li><span class="koboSpan" id="kobo.938.1">To</span><a id="_idIndexMarker1360"/><span class="koboSpan" id="kobo.939.1"> ensure that </span><strong class="source-inline"><span class="koboSpan" id="kobo.940.1">InitTask</span></strong><span class="koboSpan" id="kobo.941.1"> will only run successfully once, add the following </span><span class="No-Break"><span class="koboSpan" id="kobo.942.1">highlighted code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.943.1">
public partial class MainViewModel : ObservableObject
{
    IClassifier _classifier;
</span><strong class="bold"><span class="koboSpan" id="kobo.944.1">    Task initTask;</span></strong><span class="koboSpan" id="kobo.945.1">
    public MainViewModel()
    {
</span><strong class="bold"><span class="koboSpan" id="kobo.946.1">        _ = InitAsync();</span></strong><span class="koboSpan" id="kobo.947.1">
    }
</span><strong class="bold"><span class="koboSpan" id="kobo.948.1">    public Task InitAsync()</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.949.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.950.1">        if (initTask == null || initTask.IsFaulted)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.951.1">            initTask = InitTask();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.952.1">        return initTask;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.953.1">    }</span></strong><span class="koboSpan" id="kobo.954.1">
  // Code omitted for brevity
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.955.1">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.956.1">InitAsync</span></strong><span class="koboSpan" id="kobo.957.1">, the initialization task is captured by a field only if the field is </span><strong class="source-inline"><span class="koboSpan" id="kobo.958.1">null</span></strong><span class="koboSpan" id="kobo.959.1"> or its value has faulted. </span><span class="koboSpan" id="kobo.959.2">This ensures that we only run the initialization successfully once. </span><span class="koboSpan" id="kobo.959.3">The value of the field is then returned to the caller, which, in this case, is the constructor. </span><span class="koboSpan" id="kobo.959.4">Unwinding this, the constructor calls </span><strong class="source-inline"><span class="koboSpan" id="kobo.960.1">InitAsync</span></strong><span class="koboSpan" id="kobo.961.1"> and throws away the return value. </span><strong class="source-inline"><span class="koboSpan" id="kobo.962.1">InitAsync</span></strong><span class="koboSpan" id="kobo.963.1">, meanwhile, captures the value returned by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.964.1">InitTask</span></strong><span class="koboSpan" id="kobo.965.1"> property, which is </span><strong class="source-inline"><span class="koboSpan" id="kobo.966.1">Task</span></strong><span class="koboSpan" id="kobo.967.1"> that has already been queued for execution. </span><span class="koboSpan" id="kobo.967.2">Since </span><strong class="source-inline"><span class="koboSpan" id="kobo.968.1">InitAsync</span></strong><span class="koboSpan" id="kobo.969.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.970.1">InitTask</span></strong><span class="koboSpan" id="kobo.971.1"> and their closure are all asynchronous, they complete sometime after the </span><span class="No-Break"><span class="koboSpan" id="kobo.972.1">constructor completes.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.973.1">Now that </span><a id="_idIndexMarker1361"/><span class="koboSpan" id="kobo.974.1">we have initialized the </span><strong class="source-inline"><span class="koboSpan" id="kobo.975.1">hotdog-or-not</span></strong><span class="koboSpan" id="kobo.976.1"> ONNX model, we can now implement the two buttons, one that takes a photo and another that allows the user to pick a photo from their device storage. </span><span class="koboSpan" id="kobo.976.2">Let’s start by implementing a couple of helper methods to use in both </span><span class="No-Break"><span class="koboSpan" id="kobo.977.1">use cases.</span></span></p>
<p><span class="koboSpan" id="kobo.978.1">The first helper method is used to convert </span><strong class="source-inline"><span class="koboSpan" id="kobo.979.1">FileResult</span></strong><span class="koboSpan" id="kobo.980.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.981.1">byte[]</span></strong><span class="koboSpan" id="kobo.982.1">. </span><span class="koboSpan" id="kobo.982.2">To implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.983.1">ConvertPhotoToBytes</span></strong><span class="koboSpan" id="kobo.984.1">, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.985.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.986.1">Open the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.987.1">MainViewModel.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.988.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.989.1">Add a new method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.990.1">ConvertPhotoToBytes</span></strong><span class="koboSpan" id="kobo.991.1">, which takes </span><strong class="source-inline"><span class="koboSpan" id="kobo.992.1">FileResult</span></strong><span class="koboSpan" id="kobo.993.1"> as a parameter and returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.994.1">byte []</span></strong><span class="koboSpan" id="kobo.995.1">. </span><span class="koboSpan" id="kobo.995.2">Since the method is </span><strong class="source-inline"><span class="koboSpan" id="kobo.996.1">async</span></strong><span class="koboSpan" id="kobo.997.1">, you’ll need to return </span><strong class="source-inline"><span class="koboSpan" id="kobo.998.1">Task</span></strong><span class="koboSpan" id="kobo.999.1"> and use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1000.1">async</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1001.1"> modifier.</span></span></li>
<li><span class="koboSpan" id="kobo.1002.1">In the method, check whether </span><strong class="source-inline"><span class="koboSpan" id="kobo.1003.1">FileResult</span></strong><span class="koboSpan" id="kobo.1004.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1005.1">null</span></strong><span class="koboSpan" id="kobo.1006.1"> and that it returns an </span><span class="No-Break"><span class="koboSpan" id="kobo.1007.1">empty array.</span></span></li>
<li><span class="koboSpan" id="kobo.1008.1">Next, open a stream from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1009.1">FileResult</span></strong><span class="koboSpan" id="kobo.1010.1"> using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1011.1">OpenStreamAsync</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1012.1"> method.</span></span></li>
<li><span class="koboSpan" id="kobo.1013.1">Create a new variable of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1014.1">MemoryStream</span></strong><span class="koboSpan" id="kobo.1015.1"> type and initialize it using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1016.1">default constructor.</span></span></li>
<li><span class="koboSpan" id="kobo.1017.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1018.1">Copy</span></strong><span class="koboSpan" id="kobo.1019.1"> method to copy </span><strong class="source-inline"><span class="koboSpan" id="kobo.1020.1">stream</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1021.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1022.1">MemoryStream</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1023.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1024.1">Finally, return </span><strong class="source-inline"><span class="koboSpan" id="kobo.1025.1">MemoryStream</span></strong><span class="koboSpan" id="kobo.1026.1"> as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1027.1">byte[]</span></strong><span class="koboSpan" id="kobo.1028.1">; your method should look like </span><span class="No-Break"><span class="koboSpan" id="kobo.1029.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1030.1">
    private async Task&lt;byte[]&gt; ConvertPhotoToBytes(FileResult photo)
    {
        if (photo == null) return Array.Empty&lt;byte&gt;();
        using var stream = await photo.OpenReadAsync();
        using MemoryStream memoryStream = new();
        stream.CopyTo(memoryStream);
        return memoryStream.ToArray();
    }</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1031.1">The other </span><a id="_idIndexMarker1362"/><span class="koboSpan" id="kobo.1032.1">helper method we will need is to use our classification model to get the results of a photo and return the results. </span><span class="koboSpan" id="kobo.1032.2">We will need a new type to return the results. </span><span class="koboSpan" id="kobo.1032.3">Follow these steps to implement the </span><span class="No-Break"><span class="koboSpan" id="kobo.1033.1">new class:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1034.1">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1035.1">Models</span></strong><span class="koboSpan" id="kobo.1036.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.1037.1">the project.</span></span></li>
<li><span class="koboSpan" id="kobo.1038.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1039.1">Models</span></strong><span class="koboSpan" id="kobo.1040.1"> folder, create a new class, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1041.1">Result</span></strong><span class="koboSpan" id="kobo.1042.1">, in a file </span><span class="No-Break"><span class="koboSpan" id="kobo.1043.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1044.1">Result.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1045.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1046.1">Add a public property, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1047.1">IsHotdog</span></strong><span class="koboSpan" id="kobo.1048.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1049.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1050.1">bool</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1051.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1052.1">Add a public property, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1053.1">Confidence</span></strong><span class="koboSpan" id="kobo.1054.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1055.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1056.1">float</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1057.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1058.1">Add a public property, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1059.1">PhotoBytes</span></strong><span class="koboSpan" id="kobo.1060.1">, as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1061.1">byte[]</span></strong><span class="koboSpan" id="kobo.1062.1">; the class should now look like </span><span class="No-Break"><span class="koboSpan" id="kobo.1063.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1064.1">
namespace HotdogOrNot.Models;
public class Result
{
    public bool IsHotdog { get; set; }
    public float Confidence { get; set; }
    public byte[] PhotoBytes { get; set; }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1065.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1066.1">IsHotdog</span></strong><span class="koboSpan" id="kobo.1067.1"> property is used to capture whether the label returned from the model is “hotdog.” </span><strong class="source-inline"><span class="koboSpan" id="kobo.1068.1">Confidence</span></strong><span class="koboSpan" id="kobo.1069.1"> is a score of how sure the model is that this is a hotdog or not. </span><span class="koboSpan" id="kobo.1069.2">Finally, since we transform the image prior to processing, we store the transformed image in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1070.1">PhotoBytes</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1071.1"> property.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.1072.1">Now, we </span><a id="_idIndexMarker1363"/><span class="koboSpan" id="kobo.1073.1">can implement the method that will run and process the classification result, by following </span><span class="No-Break"><span class="koboSpan" id="kobo.1074.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1075.1">Open the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1076.1">MainViewModel.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1077.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.1078.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1079.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.1080.1"> class, add a new field, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1081.1">isClassifying</span></strong><span class="koboSpan" id="kobo.1082.1">, with a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1083.1">bool</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1084.1"> type.</span></span></li>
<li><span class="koboSpan" id="kobo.1085.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1086.1">ObservableAttribute</span></strong><span class="koboSpan" id="kobo.1087.1"> attribute to the field; it should look like </span><span class="No-Break"><span class="koboSpan" id="kobo.1088.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1089.1">
    [ObservableProperty]
    private bool isClassifying;</span></pre></li> <li><span class="koboSpan" id="kobo.1090.1">Add a new method to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1091.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.1092.1"> class, named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1093.1">RunClassificationAsync</span></strong><span class="koboSpan" id="kobo.1094.1">. </span><span class="koboSpan" id="kobo.1094.2">The method will accept a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1095.1">byte[]</span></strong><span class="koboSpan" id="kobo.1096.1"> parameter and return </span><strong class="source-inline"><span class="koboSpan" id="kobo.1097.1">Result</span></strong><span class="koboSpan" id="kobo.1098.1">, wrapped in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1099.1">Task</span></strong><span class="koboSpan" id="kobo.1100.1">, since it </span><span class="No-Break"><span class="koboSpan" id="kobo.1101.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1102.1">async</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1103.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1104.1">
async Task&lt;Result&gt; RunClassificationAsync(byte[] imageToClassify)
    {
    }</span></pre></li> <li><span class="koboSpan" id="kobo.1105.1">In the method, the first thing we do is set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1106.1">IsClassifying</span></strong><span class="koboSpan" id="kobo.1107.1"> property to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1108.1">true</span></strong><span class="koboSpan" id="kobo.1109.1">; this will be used to disable the buttons later in </span><span class="No-Break"><span class="koboSpan" id="kobo.1110.1">the chapter.</span></span></li>
<li><span class="koboSpan" id="kobo.1111.1">Add a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1112.1">try..catch..finally</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1113.1"> statement.</span></span></li>
<li><span class="koboSpan" id="kobo.1114.1">Inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1115.1">try</span></strong><span class="koboSpan" id="kobo.1116.1"> statement, ensure the model is initialized by </span><span class="No-Break"><span class="koboSpan" id="kobo.1117.1">calling </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1118.1">InitAsync</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1119.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1120.1">Then, call </span><strong class="source-inline"><span class="koboSpan" id="kobo.1121.1">Classify</span></strong><span class="koboSpan" id="kobo.1122.1"> on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1123.1">classifier</span></strong><span class="koboSpan" id="kobo.1124.1"> field passing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1125.1">byte[]</span></strong><span class="koboSpan" id="kobo.1126.1">, representing the image as a parameter and storing </span><span class="No-Break"><span class="koboSpan" id="kobo.1127.1">the result.</span></span></li>
<li><span class="koboSpan" id="kobo.1128.1">The </span><a id="_idIndexMarker1364"/><span class="koboSpan" id="kobo.1129.1">last statement in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1130.1">try</span></strong><span class="koboSpan" id="kobo.1131.1"> statement block is to return a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1132.1">Result</span></strong><span class="koboSpan" id="kobo.1133.1">, setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.1134.1">IsHotdog</span></strong><span class="koboSpan" id="kobo.1135.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1136.1">true</span></strong><span class="koboSpan" id="kobo.1137.1"> only if the classification result’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1138.1">TopResultLabel</span></strong><span class="koboSpan" id="kobo.1139.1"> property is “hotdog,” </span><strong class="source-inline"><span class="koboSpan" id="kobo.1140.1">Confidence</span></strong><span class="koboSpan" id="kobo.1141.1"> is set to the classification result’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1142.1">TopResultScore</span></strong><span class="koboSpan" id="kobo.1143.1"> property, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1144.1">PhotoBytes</span></strong><span class="koboSpan" id="kobo.1145.1"> is set to the classification result’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1146.1">Image</span></strong><span class="koboSpan" id="kobo.1147.1"> property. </span><span class="koboSpan" id="kobo.1147.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1148.1">try</span></strong><span class="koboSpan" id="kobo.1149.1"> portion should look like </span><span class="No-Break"><span class="koboSpan" id="kobo.1150.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1151.1">
        try
        {
            await InitAsync().ConfigureAwait(false);
            var result = _classifier.Classify(imageToClassify);
            return new Result()
            {
                IsHotdog = result.TopResultLabel == "hotdog",
                Confidence = result.TopResultScore,
                PhotoBytes = result.Image
            };
        }
        catch</span></pre></li> <li><span class="koboSpan" id="kobo.1152.1">Now, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1153.1">catch</span></strong><span class="koboSpan" id="kobo.1154.1"> statement block, return a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1155.1">Result</span></strong><span class="koboSpan" id="kobo.1156.1">, setting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1157.1">IsHotdog</span></strong><span class="koboSpan" id="kobo.1158.1"> property to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1159.1">false</span></strong><span class="koboSpan" id="kobo.1160.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1161.1">Confidence</span></strong><span class="koboSpan" id="kobo.1162.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1163.1">0.0f</span></strong><span class="koboSpan" id="kobo.1164.1">, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1165.1">PhotoBytes</span></strong><span class="koboSpan" id="kobo.1166.1"> property to the bytes passed into the method. </span><span class="koboSpan" id="kobo.1166.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1167.1">catch</span></strong><span class="koboSpan" id="kobo.1168.1"> block should look like </span><span class="No-Break"><span class="koboSpan" id="kobo.1169.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1170.1">
        catch
        {
            return new Result
            {
                IsHotdog = false,
                Confidence = 0.0f,
                PhotoBytes = imageToClassify
            };
        }
        finally</span></pre></li> <li><span class="koboSpan" id="kobo.1171.1">Lastly, for</span><a id="_idIndexMarker1365"/><span class="koboSpan" id="kobo.1172.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1173.1">finally</span></strong><span class="koboSpan" id="kobo.1174.1"> block, we want to set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1175.1">IsClassiying</span></strong><span class="koboSpan" id="kobo.1176.1"> property back to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1177.1">false</span></strong><span class="koboSpan" id="kobo.1178.1">; however, we will need to do this on the main UI thread using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1179.1">MainThread.BeginInvokeOnMainThread</span></strong><span class="koboSpan" id="kobo.1180.1"> method from .NET MAUI, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1181.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1182.1">
        finally
        {
            MainThread.BeginInvokeOnMainThread(() =&gt; IsClassifying = false);
        }</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1183.1">Now that we have written the helper methods, we can create two methods, one to handle capturing an image from the camera and another to pick a photo from user storage. </span><span class="koboSpan" id="kobo.1183.2">We wi</span><a id="_idTextAnchor966"/><span class="koboSpan" id="kobo.1184.1">ll start with the camera </span><span class="No-Break"><span class="koboSpan" id="kobo.1185.1">capture method.</span></span></p>
<p><span class="koboSpan" id="kobo.1186.1">Let’s set this up by following </span><span class="No-Break"><span class="koboSpan" id="kobo.1187.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1188.1">Open the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1189.1">MainViewModel.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1190.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.1191.1">Create a public async void method </span><span class="No-Break"><span class="koboSpan" id="kobo.1192.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1193.1">TakePhoto</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1194.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1195.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1196.1">RelayCommand</span></strong><span class="koboSpan" id="kobo.1197.1"> attribute to make the </span><span class="No-Break"><span class="koboSpan" id="kobo.1198.1">method bindable.</span></span></li>
<li><span class="koboSpan" id="kobo.1199.1">Add an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1200.1">if</span></strong><span class="koboSpan" id="kobo.1201.1"> statement to check whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1202.1">MediaPicker.Default.IsCaptureSupported</span></strong><span class="koboSpan" id="kobo.1203.1"> parameter </span><span class="No-Break"><span class="koboSpan" id="kobo.1204.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1205.1">true</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1206.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1207.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1208.1">true</span></strong><span class="koboSpan" id="kobo.1209.1"> statement block of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1210.1">if</span></strong><span class="koboSpan" id="kobo.1211.1">, get the status of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1212.1">Camera</span></strong><span class="koboSpan" id="kobo.1213.1"> permission using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1214.1">CheckAndRequestPermission</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1215.1"> method.</span></span></li>
<li><span class="koboSpan" id="kobo.1216.1">If the status is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1217.1">Granted</span></strong><span class="koboSpan" id="kobo.1218.1">, then use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1219.1">CheckAndRequestMethod</span></strong><span class="koboSpan" id="kobo.1220.1"> again to check the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1221.1">WriteExternalStorage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1222.1"> permission.</span></span></li>
<li><span class="koboSpan" id="kobo.1223.1">If the status is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1224.1">Granted</span></strong><span class="koboSpan" id="kobo.1225.1">, use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1226.1">MediaPicker</span></strong><span class="koboSpan" id="kobo.1227.1"> to capture a photo using </span><span class="No-Break"><span class="koboSpan" id="kobo.1228.1">the </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1229.1">Capture</span></strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1230.1">PhotoAsync</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1231.1"> method.</span></span></li>
<li><span class="koboSpan" id="kobo.1232.1">Call a method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1233.1">ConvertPhotoToBytes</span></strong><span class="koboSpan" id="kobo.1234.1">, passing in the file returned </span><span class="No-Break"><span class="koboSpan" id="kobo.1235.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1236.1">MediaPicker</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1237.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1238.1">Pass the photo byt</span><a id="_idTextAnchor967"/><span class="koboSpan" id="kobo.1239.1">es to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1240.1">RunClassificationAsync</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1241.1"> method.</span></span></li>
<li><span class="koboSpan" id="kobo.1242.1">Finally, we</span><a id="_idIndexMarker1366"/><span class="koboSpan" id="kobo.1243.1"> will dynamically navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1244.1">Result</span></strong><span class="koboSpan" id="kobo.1245.1"> view, which we will create in the next section, passing the result from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1246.1">RunClassificationAsync</span></strong><span class="koboSpan" id="kobo.1247.1"> as a parameter. </span><span class="koboSpan" id="kobo.1247.2">We do this by using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1248.1">Shell.Current.GotoAsync</span></strong><span class="koboSpan" id="kobo.1249.1"> and ensuring that the app uses the main thread to do so, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1250.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1251.1">
    [RelayCommand()]
    public async void TakePhoto()
    {
        if (MediaPicker.Default.IsCaptureSupported)
        {
            var status = await AppPermissions.CheckAndRequestRequiredPermissionAsync&lt;Permissions.Camera&gt;();
            if (status == PermissionStatus.Granted) {
                status = await AppPermissions.CheckAndRequestRequiredPermissionAsync&lt;Permissions.StorageWrite&gt;();
            }
            if (status == PermissionStatus.Granted)
            {
                FileResult photo = await MediaPicker.Default.CapturePhotoAsync(new MediaPickerOptions() { Title = "Hotdog or Not?" </span><span class="koboSpan" id="kobo.1251.2">});
                var imageToClassify = await ConvertPhotoToBytes(photo);
                var result = await RunClassificationAsync(imageToClassify);
                await MainThread.InvokeOnMainThreadAsync(async () =&gt; await
                    Shell.Current.GoToAsync("Result", new Dictionary&lt;string, object&gt;() { { "result", result } })
                );
            }
        }
    }</span></pre></li> </ol>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1252.1">Shell.Current.GotoAsync</span></strong><span class="koboSpan" id="kobo.1253.1"> takes two parameters – the first is the route that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1254.1">Shell</span></strong><span class="koboSpan" id="kobo.1255.1"> is to </span><a id="_idIndexMarker1367"/><span class="koboSpan" id="kobo.1256.1">navigate to, and the second is a dictionary of key-value pairs to send to the destination view. </span><span class="koboSpan" id="kobo.1256.2">Later in this chapter, we will see how to configure a route to a view without using XAML and, when we create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1257.1">Result</span></strong><span class="koboSpan" id="kobo.1258.1"> view, how to access the parameters passed </span><span class="No-Break"><span class="koboSpan" id="kobo.1259.1">to it.</span></span></p>
<p><span class="koboSpan" id="kobo.1260.1">We will now create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1261.1">PickPhoto</span></strong><span class="koboSpan" id="kobo.1262.1"> method to allow a user to use an image from their device. </span><span class="koboSpan" id="kobo.1262.2">Use the following steps to create </span><span class="No-Break"><span class="koboSpan" id="kobo.1263.1">the method:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1264.1">Create a public async void method </span><span class="No-Break"><span class="koboSpan" id="kobo.1265.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1266.1">PickPhoto</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1267.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1268.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1269.1">RelayCommand</span></strong><span class="koboSpan" id="kobo.1270.1"> attribute to make the </span><span class="No-Break"><span class="koboSpan" id="kobo.1271.1">method bindable.</span></span></li>
<li><span class="koboSpan" id="kobo.1272.1">Grant the status of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1273.1">Photos</span></strong><span class="koboSpan" id="kobo.1274.1"> permission using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1275.1">CheckAndRequestPermission</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1276.1"> method.</span></span></li>
<li><span class="koboSpan" id="kobo.1277.1">If the status is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1278.1">Granted</span></strong><span class="koboSpan" id="kobo.1279.1">, use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1280.1">MediaPicker</span></strong><span class="koboSpan" id="kobo.1281.1"> to capture a photo using </span><span class="No-Break"><span class="koboSpan" id="kobo.1282.1">the </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1283.1">Pick</span></strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1284.1">PhotoAsync</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1285.1"> method.</span></span></li>
<li><span class="koboSpan" id="kobo.1286.1">Call a method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1287.1">ConvertPhotoToBytes</span></strong><span class="koboSpan" id="kobo.1288.1">, passing in the file returned </span><span class="No-Break"><span class="koboSpan" id="kobo.1289.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1290.1">MediaPicker</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1291.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1292.1">Pass the photo bytes to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1293.1">RunClassificationAsync</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1294.1"> method.</span></span></li>
<li><span class="koboSpan" id="kobo.1295.1">Finally, we will dynamically navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1296.1">Result</span></strong><span class="koboSpan" id="kobo.1297.1"> view, which we will create in the next section, passing the result from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1298.1">RunClassificationAsync</span></strong><span class="koboSpan" id="kobo.1299.1"> as a parameter. </span><span class="koboSpan" id="kobo.1299.2">We will do this by using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1300.1">Shell.Current.GotoAsync</span></strong><span class="koboSpan" id="kobo.1301.1"> and ensuring that the app uses the main thread to do so, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1302.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1303.1">
    [RelayCommand()]
    public async void PickPhoto()
    {
        var status = await AppPermissions.CheckAndRequestRequiredPermissionAsync&lt;Permissions.Photos&gt;();
        if (status == PermissionStatus.Granted)
        {
            FileResult photo = await MediaPicker.Default.PickPhotoAsync();
            var imageToClassify = await ConvertPhotoToBytes(photo);
            var result = await RunClassificationAsync(imageToClassify);
            await MainThread.InvokeOnMainThreadAsync(async () =&gt; await
                Shell.Current.GoToAsync("Result", new Dictionary&lt;string, object&gt;() { { "result", </span><a id="_idTextAnchor968"/><span class="koboSpan" id="kobo.1304.1">result } })
            );
        }
    }</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1305.1">When a </span><a id="_idIndexMarker1368"/><span class="koboSpan" id="kobo.1306.1">user clicks on a button, the classification could take a noticeable amount of time. </span><span class="koboSpan" id="kobo.1306.2">To prevent the user from clicking the button again because they think it’s not working, we will disable the buttons until the operation completes. </span><span class="koboSpan" id="kobo.1306.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1307.1">IsClassifying</span></strong><span class="koboSpan" id="kobo.1308.1"> property is already set; we just need to use that value to restrict </span><strong class="source-inline"><span class="koboSpan" id="kobo.1309.1">RelayCommands</span></strong><span class="koboSpan" id="kobo.1310.1">, by following </span><span class="No-Break"><span class="koboSpan" id="kobo.1311.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1312.1">Add a new method that returns a Boolean named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1313.1">CanExecuteClassification</span></strong><span class="koboSpan" id="kobo.1314.1">, and return the inverse of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1315.1">IsClassifying</span></strong><span class="koboSpan" id="kobo.1316.1"> property, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1317.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1318.1">
private bool CanExecuteClassification() =&gt; !IsClassifying;</span></pre></li> <li><span class="koboSpan" id="kobo.1319.1">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1320.1">RelayCommand</span></strong><span class="koboSpan" id="kobo.1321.1"> attribute for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1322.1">TakePhoto</span></strong><span class="koboSpan" id="kobo.1323.1"> method, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1324.1">highlighted here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1325.1">
[RelayCommand(</span><strong class="bold"><span class="koboSpan" id="kobo.1326.1">CanExecute = nameof(CanExecuteClassification)</span></strong><span class="koboSpan" id="kobo.1327.1">)]
public async void TakePhoto()</span></pre></li> <li><span class="koboSpan" id="kobo.1328.1">Update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1329.1">RelayCommand</span></strong><span class="koboSpan" id="kobo.1330.1"> attribute for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1331.1">PickPhoto</span></strong><span class="koboSpan" id="kobo.1332.1"> method, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1333.1">highlighted here:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1334.1">
[RelayCommand(</span><strong class="bold"><span class="koboSpan" id="kobo.1335.1">CanExecute = nameof(CanExecuteClassification)</span></strong><span class="koboSpan" id="kobo.1336.1">)]
public async void PickPhoto()</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1337.1">Now that ViewModel for the main</span><a id="_idIndexMarker1369"/><span class="koboSpan" id="kobo.1338.1"> page is complete, we can build View for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1339.1">main page.</span></span></p>
<h3><span class="koboSpan" id="kobo.1340.1">Building the view</span></h3>
<p><span class="koboSpan" id="kobo.1341.1">Now, once </span><a id="_idIndexMarker1370"/><span class="koboSpan" id="kobo.1342.1">we have created the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1343.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.1344.1"> class, it is time to </span><a id="_idIndexMarker1371"/><span class="koboSpan" id="kobo.1345.1">create the code for the </span><strong class="bold"><span class="koboSpan" id="kobo.1346.1">graphical user interface</span></strong><span class="koboSpan" id="kobo.1347.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1348.1">GUI</span></strong><span class="koboSpan" id="kobo.1349.1">). </span><span class="koboSpan" id="kobo.1349.2">Go through the following steps to create the GUI for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1350.1">MainView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1351.1"> view:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1352.1">Create a new folder </span><span class="No-Break"><span class="koboSpan" id="kobo.1353.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1354.1">Views</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1355.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1356.1">Add</span><a id="_idIndexMarker1372"/><span class="koboSpan" id="kobo.1357.1"> a new </span><strong class="bold"><span class="koboSpan" id="kobo.1358.1">.NET MAUI ContentPage (XAML)</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1359.1">called </span><a id="_idTextAnchor969"/></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1360.1">MainView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1361.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1362.1">Set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1363.1">Title</span></strong><span class="koboSpan" id="kobo.1364.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1365.1">ContentPage</span></strong><span class="koboSpan" id="kobo.1366.1"> as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1367.1">Hotdog or </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1368.1">Not hotdog</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1369.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1370.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1371.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.1372.1"> to the page, and set its </span><strong class="source-inline"><span class="koboSpan" id="kobo.1373.1">VerticalOptions</span></strong><span class="koboSpan" id="kobo.1374.1"> property to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1375.1">Center</span></strong><span class="koboSpan" id="kobo.1376.1"> and its </span><strong class="source-inline"><span class="koboSpan" id="kobo.1377.1">HorizontalOptions</span></strong><span class="koboSpan" id="kobo.1378.1"> property </span><span class="No-Break"><span class="koboSpan" id="kobo.1379.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1380.1">CenterAndExpand</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1381.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1382.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1383.1">Button</span></strong><span class="koboSpan" id="kobo.1384.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1385.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.1386.1">, with the text </span><strong class="source-inline"><span class="koboSpan" id="kobo.1387.1">Take Photo</span></strong><span class="koboSpan" id="kobo.1388.1">. </span><span class="koboSpan" id="kobo.1388.2">For the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1389.1">Command</span></strong><span class="koboSpan" id="kobo.1390.1"> property, add a binding to the</span><a id="_idTextAnchor970"/> <strong class="source-inline"><span class="koboSpan" id="kobo.1391.1">TakePhoto</span></strong><span class="koboSpan" id="kobo.1392.1"> property in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1393.1">MainViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1394.1"> class.</span></span></li>
<li><span class="koboSpan" id="kobo.1395.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1396.1">Button</span></strong><span class="koboSpan" id="kobo.1397.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1398.1">HorizontalStackLayout</span></strong><span class="koboSpan" id="kobo.1399.1">, with the text </span><strong class="source-inline"><span class="koboSpan" id="kobo.1400.1">Pick Photo</span></strong><span class="koboSpan" id="kobo.1401.1">. </span><span class="koboSpan" id="kobo.1401.2">For the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1402.1">Command</span></strong><span class="koboSpan" id="kobo.1403.1"> property, add a binding to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1404.1">PickPhoto</span></strong><span class="koboSpan" id="kobo.1405.1"> property in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1406.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.1407.1"> class, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1408.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1409.1">
&lt;ContentPage 
             
             
             x:Class="HotdogOrNot.Views.MainView"
             x:DataType="viewModels:MainViewModel"
             Title="Hotdog or Not hotdog"&gt;
    &lt;HorizontalStackLayout VerticalOptions="Center" HorizontalOptions="CenterAndExpand"&gt;
        &lt;Button Text="Take Photo" Command="{Binding TakePhotoCommand}" WidthRequest="150" HeightRequest="150" Margin="20" FontSize="Large"/&gt;
        &lt;Button Text="Pick Photo" Command="{Binding PickPhotoCommand}" WidthRequest="150" HeightRequest="150" Margin="20" FontSize="Large"/&gt;
    &lt;/HorizontalStackLayout&gt;
&lt;/ContentPage&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1410.1">In the </span><a id="_idIndexMarker1373"/><span class="koboSpan" id="kobo.1411.1">code-behind </span><strong class="source-inline"><span class="koboSpan" id="kobo.1412.1">MainView.xaml.cs</span></strong><span class="koboSpan" id="kobo.1413.1"> file, we will set the binding context of the view by following </span><span class="No-Break"><span class="koboSpan" id="kobo.1414.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1415.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1416.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.1417.1"> as a parameter of </span><span class="No-Break"><span class="koboSpan" id="kobo.1418.1">the constructor.</span></span></li>
<li><span class="koboSpan" id="kobo.1419.1">After the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1420.1">InitialComponent</span></strong><span class="koboSpan" id="kobo.1421.1"> method call, set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1422.1">BindingContext</span></strong><span class="koboSpan" id="kobo.1423.1"> property of the view to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1424.1">MainViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1425.1"> parameter.</span></span></li>
<li><span class="koboSpan" id="kobo.1426.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1427.1">SetBackButtonTitle</span></strong><span class="koboSpan" id="kobo.1428.1"> static method on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1429.1">NavigationPage</span></strong><span class="koboSpan" id="kobo.1430.1"> class so that an arrow to navigate back to this view will be shown in the navigation bar on the result view, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1431.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1432.1">
public MainView(Main</span><a id="_idTextAnchor971"/><span class="koboSpan" id="kobo.1433.1">ViewModel viewModel)
{
    InitializeComponent();
    BindingContext = viewModel; Navigati</span><a id="_idTextAnchor972"/><a id="_idTextAnchor973"/><span class="koboSpan" id="kobo.1434.1">onPage.SetBackButtonTitle(this, string.Empty);
}</span></pre></li> </ol>
<h3><span class="koboSpan" id="kobo.1435.1">Building the result view</span></h3>
<p><span class="koboSpan" id="kobo.1436.1">The</span><a id="_idIndexMarker1374"/><span class="koboSpan" id="kobo.1437.1"> last thing we need to do in this </span><a id="_idIndexMarker1375"/><span class="koboSpan" id="kobo.1438.1">project</span><a id="_idTextAnchor974"/><span class="koboSpan" id="kobo.1439.1"> is to create the result view. </span><span class="koboSpan" id="kobo.1439.2">This view will show the input</span><a id="_idTextAnchor975"/><span class="koboSpan" id="kobo.1440.1"> photo and the classification of a hot dog </span><span class="No-Break"><span class="koboSpan" id="kobo.1441.1">or not.</span></span></p>
<h4><span class="koboSpan" id="kobo.1442.1">Building the ResultViewModel class</span></h4>
<p><span class="koboSpan" id="kobo.1443.1">Before </span><a id="_idIndexMarker1376"/><span class="koboSpan" id="kobo.1444.1">we create the view, we will create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1445.1">ResultViewModel</span></strong><span class="koboSpan" id="kobo.1446.1"> class that will handle all the logic for the view, by following </span><span class="No-Break"><span class="koboSpan" id="kobo.1447.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1448.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1449.1">partial</span></strong><span class="koboSpan" id="kobo.1450.1"> class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1451.1">ResultViewModel</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1452.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1453.1">ViewModels</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1454.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1455.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1456.1">ObservableObject</span></strong><span class="koboSpan" id="kobo.1457.1"> as a base class to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1458.1">ResultViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1459.1"> class.</span></span></li>
<li><span class="koboSpan" id="kobo.1460.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1461.1">private</span></strong><span class="koboSpan" id="kobo.1462.1"> field of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1463.1">string</span></strong><span class="koboSpan" id="kobo.1464.1"> type, called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1465.1">title</span></strong><span class="koboSpan" id="kobo.1466.1">. </span><span class="koboSpan" id="kobo.1466.2">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1467.1">ObservableProperty</span></strong><span class="koboSpan" id="kobo.1468.1"> attribute to the field to make it a </span><span class="No-Break"><span class="koboSpan" id="kobo.1469.1">bindable property.</span></span></li>
<li><span class="koboSpan" id="kobo.1470.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1471.1">private</span></strong><span class="koboSpan" id="kobo.1472.1"> field of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1473.1">string</span></strong><span class="koboSpan" id="kobo.1474.1"> type, called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1475.1">description</span></strong><span class="koboSpan" id="kobo.1476.1">. </span><span class="koboSpan" id="kobo.1476.2">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1477.1">ObservableProperty</span></strong><span class="koboSpan" id="kobo.1478.1"> attribute to the field to make it a </span><span class="No-Break"><span class="koboSpan" id="kobo.1479.1">bindable property.</span></span></li>
<li><span class="koboSpan" id="kobo.1480.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1481.1">private</span></strong><span class="koboSpan" id="kobo.1482.1"> field of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1483.1">string</span></strong><span class="koboSpan" id="kobo.1484.1"> type, called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1485.1">Title</span></strong><span class="koboSpan" id="kobo.1486.1">. </span><span class="koboSpan" id="kobo.1486.2">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1487.1">ObservableProperty</span></strong><span class="koboSpan" id="kobo.1488.1"> attribute to the field to make it a bindable property, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1489.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1490.1">
using CommunityToolkit.Mvvm.ComponentModel;
using HotdogOrNot.Models;
namespace HotdogOrNot.ViewModels;
public partial class ResultViewModel : ObservableObject
{
    [ObservableProperty]
    private string title;
    [ObservableProperty]
    private string description;
     [ObservableProperty]
    byte[] photoBytes;
    public ResultViewModel()
    {
    }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1491.1">The next </span><a id="_idIndexMarker1377"/><span class="koboSpan" id="kobo.1492.1">thing we will do in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1493.1">ResultViewModel</span></strong><span class="koboSpan" id="kobo.1494.1"> is to create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1495.1">Initialize</span></strong><span class="koboSpan" id="kobo.1496.1"> method that will have the result as a parameter. </span><span class="koboSpan" id="kobo.1496.2">Let’s set this up by following </span><span class="No-Break"><span class="koboSpan" id="kobo.1497.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1498.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1499.1">private</span></strong><span class="koboSpan" id="kobo.1500.1"> method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1501.1">Initialize</span></strong><span class="koboSpan" id="kobo.1502.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1503.1">ResultViewModel</span></strong><span class="koboSpan" id="kobo.1504.1"> class that accepts a parameter of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1505.1">Result</span></strong><span class="koboSpan" id="kobo.1506.1"> type, named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1507.1">result</span></strong><span class="koboSpan" id="kobo.1508.1">, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1509.1">returns </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1510.1">void</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1511.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1512.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1513.1">Initialize</span></strong><span class="koboSpan" id="kobo.1514.1"> method, set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1515.1">PhotoBytes</span></strong><span class="koboSpan" id="kobo.1516.1"> property to the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1517.1">PhotoBytes</span></strong><span class="koboSpan" id="kobo.1518.1"> property of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1519.1">result</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1520.1"> parameter.</span></span></li>
<li><span class="koboSpan" id="kobo.1521.1">Add an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1522.1">if</span></strong><span class="koboSpan" id="kobo.1523.1"> statement that checks whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1524.1">IsHotDog</span></strong><span class="koboSpan" id="kobo.1525.1"> property of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1526.1">result</span></strong><span class="koboSpan" id="kobo.1527.1"> parameter is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1528.1">true</span></strong><span class="koboSpan" id="kobo.1529.1"> and whether </span><strong class="source-inline"><span class="koboSpan" id="kobo.1530.1">Confidence</span></strong><span class="koboSpan" id="kobo.1531.1"> is higher than </span><strong class="source-inline"><span class="koboSpan" id="kobo.1532.1">90%</span></strong><span class="koboSpan" id="kobo.1533.1">. </span><span class="koboSpan" id="kobo.1533.2">If this is the case, set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1534.1">Title</span></strong><span class="koboSpan" id="kobo.1535.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1536.1">"Hot dog"</span></strong><span class="koboSpan" id="kobo.1537.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1538.1">Description</span></strong><span class="koboSpan" id="kobo.1539.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1540.1">"This is for sure </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1541.1">a hotdog"</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1542.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1543.1">Add</span><a id="_idIndexMarker1378"/><span class="koboSpan" id="kobo.1544.1"> an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1545.1">else if</span></strong><span class="koboSpan" id="kobo.1546.1"> statement to check whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1547.1">IsHotdog</span></strong><span class="koboSpan" id="kobo.1548.1"> property of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1549.1">result</span></strong><span class="koboSpan" id="kobo.1550.1"> parameter is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1551.1">true</span></strong><span class="koboSpan" id="kobo.1552.1">. </span><span class="koboSpan" id="kobo.1552.2">If this is the case, set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1553.1">Title</span></strong><span class="koboSpan" id="kobo.1554.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1555.1">"Maybe"</span></strong><span class="koboSpan" id="kobo.1556.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1557.1">Description</span></strong><span class="koboSpan" id="kobo.1558.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1559.1">"This is maybe </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1560.1">a hotdog"</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1561.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1562.1">Add an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1563.1">else</span></strong><span class="koboSpan" id="kobo.1564.1"> statement that sets </span><strong class="source-inline"><span class="koboSpan" id="kobo.1565.1">Title</span></strong><span class="koboSpan" id="kobo.1566.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1567.1">"Not a hot dog"</span></strong><span class="koboSpan" id="kobo.1568.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1569.1">Description</span></strong><span class="koboSpan" id="kobo.1570.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1571.1">"This is </span><a id="_idTextAnchor976"/><span class="koboSpan" id="kobo.1572.1">not a hot dog"</span></strong><span class="koboSpan" id="kobo.1573.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1574.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1575.1">
public void Initialize(Result result)
{
    PhotoBytes = result.PhotoBytes;
    if (result.IsHotdog &amp;&amp; result.Confidence &gt; 0.9)
    {
        Title = "Hot dog";
        Description = "This is for sure a hot dog";
    }
    else if (result.IsHotdog)
    {
        Title = "Maybe";
        Description = "This is maybe a hot dog";
    }
    else
    {
        Title = "Not a hot dog";
        Description = "This is not a hot dog";
    }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1576.1">The</span><a id="_idIndexMarker1379"/><span class="koboSpan" id="kobo.1577.1"> final thing we need to do is call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1578.1">Initialize</span></strong><span class="koboSpan" id="kobo.1579.1"> method with the result. </span><span class="koboSpan" id="kobo.1579.2">If you recall from the previous section on building the main view, we navigated to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1580.1">Result</span></strong><span class="koboSpan" id="kobo.1581.1"> view and passed the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1582.1">Result</span></strong><span class="koboSpan" id="kobo.1583.1"> object as a parameter. </span><span class="koboSpan" id="kobo.1583.2">To access the parameter and call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1584.1">Initialize</span></strong><span class="koboSpan" id="kobo.1585.1"> method properly, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1586.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1587.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1588.1">IQueryAttributable</span></strong><span class="koboSpan" id="kobo.1589.1"> interface to the list of </span><span class="No-Break"><span class="koboSpan" id="kobo.1590.1">inherited interfaces:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1591.1">
public partial class ResultViewModel : ObservableObject</span><strong class="bold"><span class="koboSpan" id="kobo.1592.1">, IQueryAttributable</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1593.1">Add a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1594.1">void</span></strong><span class="koboSpan" id="kobo.1595.1"> method, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1596.1">ApplyQueryAttributes</span></strong><span class="koboSpan" id="kobo.1597.1">, that accepts a parameter named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1598.1">query</span></strong><span class="koboSpan" id="kobo.1599.1"> of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1600.1">IDictionary&lt;string, </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1601.1">object&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1602.1"> type:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1603.1">
public void ApplyQueryAttributes(IDictionary&lt;string, object&gt; query)
{
}</span></pre></li> <li><span class="koboSpan" id="kobo.1604.1">Now, in the method, call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1605.1">Initialize</span></strong><span class="koboSpan" id="kobo.1606.1"> method, passing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1607.1">“result”</span></strong><span class="koboSpan" id="kobo.1608.1"> object from the query dictionary and casting it to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1609.1">Result</span></strong><span class="koboSpan" id="kobo.1610.1"> type, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1611.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1612.1">
public void ApplyQueryAttributes(IDictionary&lt;string, object&gt; query)
{
    Initialize(query["result"] as Result);
}/</span></pre></li> </ol>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1613.1">ViewM</span><a id="_idTextAnchor977"/><a id="_idTextAnchor978"/><span class="koboSpan" id="kobo.1614.1">odel</span></strong><span class="koboSpan" id="kobo.1615.1"> is now </span><a id="_idIndexMarker1380"/><span class="koboSpan" id="kobo.1616.1">complete, and we are ready to </span><span class="No-Break"><span class="koboSpan" id="kobo.1617.1">create </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1618.1">View</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1619.1">.</span></span></p>
<h4><span class="koboSpan" id="kobo.1620.1">Building the view</span></h4>
<p><span class="koboSpan" id="kobo.1621.1">Because we </span><a id="_idIndexMarker1381"/><span class="koboSpan" id="kobo.1622.1">want to show the input photo in the result view, we need to convert it from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1623.1">byte[]</span></strong><span class="koboSpan" id="kobo.1624.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1625.1">Microsft.Maui.Controls.ImageSource</span></strong><span class="koboSpan" id="kobo.1626.1">. </span><span class="koboSpan" id="kobo.1626.2">We will do this in a value converter that we can use together with the binding</span><a id="_idIndexMarker1382"/><span class="koboSpan" id="kobo.1627.1"> in the </span><strong class="bold"><span class="koboSpan" id="kobo.1628.1">XAML</span></strong><span class="koboSpan" id="kobo.1629.1">, by following </span><span class="No-Break"><span class="koboSpan" id="kobo.1630.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1631.1">Create a new folder </span><span class="No-Break"><span class="koboSpan" id="kobo.1632.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1633.1">Converters</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1634.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1635.1">Create a new class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1636.1">BytesToImageConverter</span></strong><span class="koboSpan" id="kobo.1637.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1638.1">Converters</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1639.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.1640.1">Add and implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1641.1">IValueConverter</span></strong><span class="koboSpan" id="kobo.1642.1"> interface, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1643.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1644.1">
using</span><a id="_idTextAnchor979"/><span class="koboSpan" id="kobo.1645.1"> System.Globalization;
namespace HotdogOrNot.Converters;
public class BytesToImageConverter : IvalueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1646.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1647.1">Convert</span></strong><span class="koboSpan" id="kobo.1648.1"> method</span><a id="_idIndexMarker1383"/><span class="koboSpan" id="kobo.1649.1"> will be used when </span><strong class="source-inline"><span class="koboSpan" id="kobo.1650.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1651.1"> updates a view. </span><span class="koboSpan" id="kobo.1651.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1652.1">ConvertBack</span></strong><span class="koboSpan" id="kobo.1653.1"> method will be used in two-way bindings when </span><strong class="source-inline"><span class="koboSpan" id="kobo.1654.1">View</span></strong><span class="koboSpan" id="kobo.1655.1"> updates </span><strong class="source-inline"><span class="koboSpan" id="kobo.1656.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1657.1">. </span><span class="koboSpan" id="kobo.1657.2">In this case, we only need to write code for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1658.1">Convert</span></strong><span class="koboSpan" id="kobo.1659.1"> method, by following </span><span class="No-Break"><span class="koboSpan" id="kobo.1660.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1661.1">First, check whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1662.1">value</span></strong><span class="koboSpan" id="kobo.1663.1"> parameter is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1664.1">null</span></strong><span class="koboSpan" id="kobo.1665.1">. </span><span class="koboSpan" id="kobo.1665.2">If so, we should </span><span class="No-Break"><span class="koboSpan" id="kobo.1666.1">return </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1667.1">null</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1668.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1669.1">If the value is not </span><strong class="source-inline"><span class="koboSpan" id="kobo.1670.1">null</span></strong><span class="koboSpan" id="kobo.1671.1">, cast it </span><span class="No-Break"><span class="koboSpan" id="kobo.1672.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1673.1">byte[]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1674.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1675.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1676.1">MemoryStream</span></strong><span class="koboSpan" id="kobo.1677.1"> object from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1678.1">byte</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1679.1"> array.</span></span></li>
<li><span class="koboSpan" id="kobo.1680.1">Return the result of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1681.1">ImageSource.FromStream</span></strong><span class="koboSpan" id="kobo.1682.1"> method to which we w</span><a id="_idTextAnchor980"/><span class="koboSpan" id="kobo.1683.1">ill pass the stream, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1684.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1685.1">
public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
{
    if(value == null)
    {
        return null;
    }
    var bytes = (byte[])value;
    var stream = new MemoryStream(bytes);
    return ImageSource.FromStream(() =&gt; stream);
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1686.1">The view</span><a id="_idIndexMarker1384"/><span class="koboSpan" id="kobo.1687.1"> will contain the photo, which will take up two-thirds of the screen. </span><span class="koboSpan" id="kobo.1687.2">Under the photo, we will add a description of the result. </span><span class="koboSpan" id="kobo.1687.3">Let’s set this up by going through the </span><span class="No-Break"><span class="koboSpan" id="kobo.1688.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1689.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1690.1">Views</span></strong><span class="koboSpan" id="kobo.1691.1"> folder, create a new file using the .NET MAUI ContentPage (XAML) file template, and name </span><span class="No-Break"><span class="koboSpan" id="kobo.1692.1">it </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1693.1">ResultView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1694.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1695.1">Import the namespace for </span><span class="No-Break"><span class="koboSpan" id="kobo.1696.1">the converter.</span></span></li>
<li><span class="koboSpan" id="kobo.1697.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1698.1">BytesToImageConverter</span></strong><span class="koboSpan" id="kobo.1699.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1700.1">Resources</span></strong><span class="koboSpan" id="kobo.1701.1"> for the page and give it </span><strong class="source-inline"><span class="koboSpan" id="kobo.1702.1">“</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1703.1">ToImage”</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1704.1"> key.</span></span></li>
<li><span class="koboSpan" id="kobo.1705.1">Bind the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1706.1">Title</span></strong><span class="koboSpan" id="kobo.1707.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1708.1">ContentPage</span></strong><span class="koboSpan" id="kobo.1709.1"> as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1710.1">Title</span></strong><span class="koboSpan" id="kobo.1711.1"> property </span><span class="No-Break"><span class="koboSpan" id="kobo.1712.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1713.1">ViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1714.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1715.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1716.1">Grid</span></strong><span class="koboSpan" id="kobo.1717.1"> to the page with two rows. </span><span class="koboSpan" id="kobo.1717.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1718.1">Height</span></strong><span class="koboSpan" id="kobo.1719.1"> value for the first </span><strong class="source-inline"><span class="koboSpan" id="kobo.1720.1">RowDefinition</span></strong><span class="koboSpan" id="kobo.1721.1"> should be </span><strong class="source-inline"><span class="koboSpan" id="kobo.1722.1">2*</span></strong><span class="koboSpan" id="kobo.1723.1">. </span><span class="koboSpan" id="kobo.1723.2">The height of the second row should be </span><strong class="source-inline"><span class="koboSpan" id="kobo.1724.1">*</span></strong><span class="koboSpan" id="kobo.1725.1">. </span><span class="koboSpan" id="kobo.1725.2">These are relative values that mean that the first row will take up two-thirds of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1726.1">Grid</span></strong><span class="koboSpan" id="kobo.1727.1">, while the second row will take up one-third </span><span class="No-Break"><span class="koboSpan" id="kobo.1728.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1729.1">Grid</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1730.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1731.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1732.1">Image</span></strong><span class="koboSpan" id="kobo.1733.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1734.1">Grid</span></strong><span class="koboSpan" id="kobo.1735.1">, and bind the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1736.1">Source</span></strong><span class="koboSpan" id="kobo.1737.1"> property to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1738.1">PhotoBytes</span></strong><span class="koboSpan" id="kobo.1739.1"> property in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1740.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1741.1">. </span><span class="koboSpan" id="kobo.1741.2">Use the converter to convert the </span><a id="_idTextAnchor981"/><span class="koboSpan" id="kobo.1742.1">bytes to an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1743.1">ImageSource</span></strong><span class="koboSpan" id="kobo.1744.1"> object and set the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1745.1">Source</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1746.1"> property.</span></span></li>
<li><span class="koboSpan" id="kobo.1747.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1748.1">Label</span></strong><span class="koboSpan" id="kobo.1749.1">, and bind the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1750.1">Text</span></strong><span class="koboSpan" id="kobo.1751.1"> property to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1752.1">Description</span></strong><span class="koboSpan" id="kobo.1753.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1754.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1755.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1756.1">code block:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1757.1">
&lt;ContentPage     xmlns:converters="clr-
    namespace:HotdogOrNot.Converters"
    x:Cl</span><a id="_idTextAnchor982"/><span class="koboSpan" id="kobo.1758.1">ass="HotdogOrNot.Views.ResultView" Title="{Binding Title}"&gt;
  &lt;ContentPage.Resources&gt;
    &lt;converters:BytesToImageConverter x:Key="ToImage" /&gt;
  &lt;/ContentPage.Resources&gt;
  &lt;Grid&gt;
    &lt;Grid.RowDefinitions&gt;
      &lt;RowDefinition Height="2*" /&gt;
      &lt;RowDefinition Height="*" /&gt;
    &lt;/Grid.RowDefinitions&gt;
    &lt;Image Source="{Binding PhotoBytes, Converter=
{StaticResource ToImage}}" Aspect="AspectFill" /&gt;
    &lt;Label Grid.Row="1" HorizontalOptions="Center" FontAttributes="Bold" Margin="10" Text="{Binding Description}" /&gt;
  &lt;/Grid&gt;
&lt;/ContentPage&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1759.1">We also </span><a id="_idIndexMarker1385"/><span class="koboSpan" id="kobo.1760.1">need to set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1761.1">BindingContext</span></strong><span class="koboSpan" id="kobo.1762.1"> of the view. </span><span class="koboSpan" id="kobo.1762.2">We will do this in the same way as we did in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1763.1">MainView</span></strong><span class="koboSpan" id="kobo.1764.1"> – in the code-behind file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1765.1">ResultView.xaml.cs</span><a id="_idTextAnchor983"/></strong><span class="koboSpan" id="kobo.1766.1">), as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1767.1">code snippet:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1768.1">
public ResultView (ResultViewModel viewModel)
{
    InitializeComponent ();
    BindingContext = viewModel;
}</span></pre> <p><span class="koboSpan" id="kobo.1769.1">We</span><a id="_idTextAnchor984"/><a id="_idTextAnchor985"/><span class="koboSpan" id="kobo.1770.1"> are now ready to write the initialization code for </span><span class="No-Break"><span class="koboSpan" id="kobo.1771.1">the app.</span></span></p>
<h3><span class="koboSpan" id="kobo.1772.1">Initializing the app</span></h3>
<p><span class="koboSpan" id="kobo.1773.1">We </span><a id="_idIndexMarker1386"/><span class="koboSpan" id="kobo.1774.1">will set up </span><strong class="bold"><span class="koboSpan" id="kobo.1775.1">inversion of control</span></strong><span class="koboSpan" id="kobo.1776.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1777.1">IoC</span></strong><span class="koboSpan" id="kobo.1778.1">) and configure </span><a id="_idIndexMarker1387"/><span class="koboSpan" id="kobo.1779.1">the main page </span><span class="No-Break"><span class="koboSpan" id="kobo.1780.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1781.1">Shell</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1782.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1783.1">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.1784.1">App.xaml.cs</span></strong><span class="koboSpan" id="kobo.1785.1">, and set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1786.1">MainPage</span></strong><span class="koboSpan" id="kobo.1787.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1788.1">MainView</span></strong><span class="koboSpan" id="kobo.1789.1"> by following </span><span class="No-Break"><span class="koboSpan" id="kobo.1790.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1791.1">Delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1792.1">MainPage.xaml</span></strong><span class="koboSpan" id="kobo.1793.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1794.1">MainPage.xaml.cs</span></strong><span class="koboSpan" id="kobo.1795.1"> files from the root of the project, since we won’t be </span><span class="No-Break"><span class="koboSpan" id="kobo.1796.1">needing those.</span></span></li>
<li><span class="koboSpan" id="kobo.1797.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1798.1">AppShell.xaml</span></strong><span class="koboSpan" id="kobo.1799.1"> file in the root of the project, and modify it to look like the </span><span class="No-Break"><span class="koboSpan" id="kobo.1800.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1801.1">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;Shell
    x:Class="HotdogOrNot.AppShell"
    
    
    </span><strong class="bold"><span class="koboSpan" id="kobo.1802.1"/></strong><span class="koboSpan" id="kobo.1803.1">
    Shell.FlyoutBehavior="Disabled"&gt;
    </span><strong class="bold"><span class="koboSpan" id="kobo.1804.1">&lt;ShellContent</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1805.1">        Title="Home"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1806.1">        ContentTemplate="{DataTemplate views:MainView}"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1807.1">        Route="MainView" /&gt;</span></strong><span class="koboSpan" id="kobo.1808.1">
&lt;/Shell&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1809.1">Now, configure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1810.1">View</span></strong><span class="koboSpan" id="kobo.1811.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1812.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1813.1"> classes in the IoC container by following </span><span class="No-Break"><span class="koboSpan" id="kobo.1814.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1815.1">Open the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1816.1">MauiProgram.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1817.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.1818.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1819.1">CreateMauiApp</span></strong><span class="koboSpan" id="kobo.1820.1"> method before the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1821.1">return</span></strong><span class="koboSpan" id="kobo.1822.1"> statement, add the following highlighted lines </span><span class="No-Break"><span class="koboSpan" id="kobo.1823.1">of code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1824.1">
#if DEBUG
    builder.Logging.AddDebug();
#endif
</span><strong class="bold"><span class="koboSpan" id="kobo.1825.1">    builder.Services.AddTransient&lt;Views.MainView&gt;();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1826.1">    builder.Services.AddTransient&lt;Views.ResultView&gt;();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1827.1">builder.Services.AddTransient&lt;ViewModels.MainViewModel&gt;();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1828.1">        builder.Services.AddTransient&lt;ViewModels.ResultViewModel&gt;();</span></strong><span class="koboSpan" id="kobo.1829.1">
        return builder.Build();</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1830.1">The </span><a id="_idIndexMarker1388"/><span class="koboSpan" id="kobo.1831.1">very last thing we need to do is add the route to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1832.1">ResultView</span></strong><span class="koboSpan" id="kobo.1833.1"> to enable navigation from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1834.1">MainView</span></strong><span class="koboSpan" id="kobo.1835.1">. </span><span class="koboSpan" id="kobo.1835.2">We will do this by adding the following highlighted code to the constructor of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1836.1">AppShell</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1837.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1838.1">AppShell.xaml.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1839.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1840.1">
public AppShell()
{
</span><strong class="bold"><span class="koboSpan" id="kobo.1841.1">    Routing.RegisterRoute("Result", type</span><a id="_idTextAnchor986"/><span class="koboSpan" id="kobo.1842.1">of(HotdogOrNot.Views.ResultView));</span></strong><span class="koboSpan" id="kobo.1843.1">
    InitializeComponent();
}</span></pre> <p><span class="koboSpan" id="kobo.1844.1">Now, we are ready to run the app. </span><span class="koboSpan" id="kobo.1844.2">If we use the simulator/emulator, we can just drag and drop photos to it if we need photos to test with. </span><span class="koboSpan" id="kobo.1844.3">When the app has started, we can now pick a photo and run it against the model. </span><span class="koboSpan" id="kobo.1844.4">The following screenshot shows how the app will </span><a id="_idIndexMarker1389"/><span class="koboSpan" id="kobo.1845.1">look if we upload a photo of a </span><span class="No-Break"><span class="koboSpan" id="kobo.1846.1">hot dog:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer215">
<span class="koboSpan" id="kobo.1847.1"><img alt="Figure 12.13 – HotdogOrNot running in an Android emulator" src="image/B19214_12_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1848.1">Figure 12.13 – HotdogOrNot running in an Android emulator</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1849.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1850.1">The prediction result for Android may not be as accurate as the web portal at </span><a href="https://github.com/Azure-Samples/cognitive-services-android-customvision-sample/issues/12"><span class="koboSpan" id="kobo.1851.1">https://github.com/Azure-Samples/cognitive-services-android-customvision-sample/issues/12</span></a><span class="koboSpan" id="kobo.1852.1">. </span><span class="koboSpan" id="kobo.1852.2">If you desire better, more consistent results, you can use the </span><span class="No-Break"><span class="koboSpan" id="kobo.1853.1">REST APIs.</span></span></p>
<h1 id="_idParaDest-200"><a id="_idTextAnchor987"/><span class="koboSpan" id="kobo.1854.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1855.1">In this chapter, we built an app that can recognize whether a photo contains a hot dog or not. </span><span class="koboSpan" id="kobo.1855.2">We accomplished this by training a machine learning model for image classification, using Azure Cognitive Services and the Custom </span><span class="No-Break"><span class="koboSpan" id="kobo.1856.1">Vision service.</span></span></p>
<p><span class="koboSpan" id="kobo.1857.1">We exported models for ML.NET, and we learned how to use it in an MAUI app that targets iOS, Mac Catalyst, Windows, and Android. </span><span class="koboSpan" id="kobo.1857.2">In the app, a user can take a photo or pick one from their photo library. </span><span class="koboSpan" id="kobo.1857.3">This photo will be sent to the model to be classified, and we will get a result that tells us whether the photo is of a </span><span class="No-Break"><span class="koboSpan" id="kobo.1858.1">hot dog.</span></span></p>
<p><span class="koboSpan" id="kobo.1859.1">Now, we can continue to build other apps and use what we have learned in this chapter regarding machine learning, both on-device and in the cloud using Azure Cognitive Services. </span><span class="koboSpan" id="kobo.1859.2">Even if we are building other apps, the concept will be </span><span class="No-Break"><span class="koboSpan" id="kobo.1860.1">the same.</span></span></p>
<p><span class="koboSpan" id="kobo.1861.1">Now, we have completed all the chapters in this book. </span><span class="koboSpan" id="kobo.1861.2">We have learned </span><span class="No-Break"><span class="koboSpan" id="kobo.1862.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1863.1">What .NET MAUI is and how we can get started </span><span class="No-Break"><span class="koboSpan" id="kobo.1864.1">building apps</span></span></li>
<li><span class="koboSpan" id="kobo.1865.1">How to use the basic layouts and controls of .</span><span class="No-Break"><span class="koboSpan" id="kobo.1866.1">NET MAUI</span></span></li>
<li><span class="koboSpan" id="kobo.1867.1">How to work </span><span class="No-Break"><span class="koboSpan" id="kobo.1868.1">with navigation</span></span></li>
<li><span class="koboSpan" id="kobo.1869.1">How to make the user experience better </span><span class="No-Break"><span class="koboSpan" id="kobo.1870.1">with animations</span></span></li>
<li><span class="koboSpan" id="kobo.1871.1">How to use sensors such as the </span><strong class="bold"><span class="koboSpan" id="kobo.1872.1">Global Positioning System</span></strong><span class="koboSpan" id="kobo.1873.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1874.1">GPS</span></strong><span class="koboSpan" id="kobo.1875.1">) in </span><span class="No-Break"><span class="koboSpan" id="kobo.1876.1">the background</span></span></li>
<li><span class="koboSpan" id="kobo.1877.1">How to build apps for multiple </span><span class="No-Break"><span class="koboSpan" id="kobo.1878.1">form factors</span></span></li>
<li><span class="koboSpan" id="kobo.1879.1">How to build real-time apps powered </span><span class="No-Break"><span class="koboSpan" id="kobo.1880.1">by Azure</span></span></li>
<li><span class="koboSpan" id="kobo.1881.1">How to make apps smarter with </span><span class="No-Break"><span class="koboSpan" id="kobo.1882.1">machine learning</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1883.1">The next step is to start to build your own apps. </span><span class="koboSpan" id="kobo.1883.2">To stay up to date and learn more about .NET MAUI, our recommendation is to read the official Microsoft dev blogs and watch live streams on Twitch and YouTube videos from the .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.1884.1">MAUI team.</span></span></p>
<p><span class="koboSpan" id="kobo.1885.1">Thank you for reading </span><span class="No-Break"><span class="koboSpan" id="kobo.1886.1">the book!</span></span></p>
</div>
</body></html>