<html><head></head><body>
        

                            
                    <h1 class="header-title">Working with Azure Functions</h1>
                
            
            
                
<p>As we mentioned in <a href="049a0a4b-74b6-41a1-92db-87a4f8af9fd1.xhtml">Chapter 4</a>, <em>Deciding on the Best Cloud-Based Solution</em>, the serverless architecture is one of the newest ways to provide flexible software solutions. To do so, Microsoft Azure provides Azure Functions, an event-driven, serverless, and scalable technology that accelerates your project development. The main goal of this chapter is to inform you of Azure Functions and the best practices you can implement while using it.</p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Understanding the Azure Functions App</li>
<li>Programming Azure Functions using C#</li>
<li>Maintaining Azure Functions</li>
<li>Use case – implementing Azure Functions to send emails</li>
</ul>
<p>By the end of this chapter, you will understand how to use Azure Functions in C#.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Technical requirements</h1>
                
            
            
                
<p>This chapter requires that you have the following:</p>
<ul>
<li>Visual Studio 2017 or 2019 free Community Edition or better with all the database tools installed.</li>
<li>A free Azure account. The <em>Creating an Azure</em> account section of <a href="14b5c5da-4042-439e-9e5a-2e19ba4c4930.xhtml">Chapter 1</a>, <em>Understanding the Importance of Software Architecture</em>, explains how to create one.</li>
</ul>
<p>You can find the sample code for this chapter at <a href="https://github.com/PacktPublishing/Hands-On-Software-Architecture-with-CSharp-8/tree/master/ch08">https://github.com/PacktPublishing/Hands-On-Software-Architecture-with-CSharp-8/tree/master/ch08</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Understanding the Azure Functions App</h1>
                
            
            
                
<p>The Azure Functions App is an Azure PaaS where you can build pieces of code (functions) and connect them to your application and use triggers to start them. The concept is quite simple – you build a function in the language you prefer and decide on the trigger that will start it. You can write as many functions as you want in your system. There are cases where the system is written entirely with functions.</p>
<p>The steps for creating the necessary environment are as simple as the ones we need to follow in order to create the function itself. The following screenshot shows the parameters that you have to decide on when you create the environment. After you select Create a Resource in Azure and filter by Function App, you will see the following screen:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/10f24913-eea6-47e6-801c-18fcc84ee695.png" style="width:38.50em;height:39.25em;"/></p>
<p>There are a couple of key points that you should consider while creating the environment. The first one is the Hosting Plan, which is where you will run your functions. There are two options for the Hosting Plan: Consumption Plan and App Service Plan. Let's talk about these now.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Consumption Plan</h1>
                
            
            
                
<p>If you choose a Consumption Plan, your functions will only waste resources when they are executed. This means that you will only be charged while your functions are running. Scalability and memory resources will be automatically managed by Azure.</p>
<p>Something we need to take note of while writing functions in this plan is the <strong>timeout</strong>. By default, after 5 minutes, the function will time out. You can change the timeout value using the <kbd>functionTimeout</kbd> parameter. The maximum value is 10 minutes.</p>
<p>When you choose a Consumption Plan, the way that you will be charged will depend on what you're executing, their execution time, and their memory usage. More information on this can be found at <a href="https://azure.microsoft.com/en-us/pricing/details/functions/">https://azure.microsoft.com/en-us/pricing/details/functions/</a>.</p>
<p>Note that this can be a good option when you don't have App Services in your environment and you are running functions with low periodicity. On the other hand, if you need continuous processing, you may want to consider the App Service Plan.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">App Service Plan</h1>
                
            
            
                
<p>App Service Plan is one of the options you can choose when you want to create an Azure Functions App. The following is a list of reasons (suggested by Microsoft) why you should use the App Service Plan instead of the Consumption Plan to maintain your functions:</p>
<ul>
<li>You can use underutilized existing App Service instances.</li>
<li>Function apps run continuously or nearly continuously.</li>
<li>You need more CPU or memory options than what's provided with the Consumption Plan.</li>
<li>Your code needs to run longer than 10 minutes.</li>
<li>You require features such as VNET/VPN connectivity.</li>
<li>You want to run your function app on Linux or on a custom image.</li>
</ul>
<p>In the scenario of App Service Plan, the <kbd>functionTimeout</kbd> value varies according to the Azure Function Runtime version. However, the value is at least 30 minutes.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Programming Azure Functions using C#</h1>
                
            
            
                
<p>In this section, you will learn how to create Azure Functions. It is worth mentioning that there are several ways to create them using C#. The first one is by creating the functions and developing them in the Azure Portal itself. To do this, follow these steps:</p>
<ol>
<li>From the Home page, go to All resources, search for the <kbd>wwtravelclub</kbd> app, and click it. You will see the following screen:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="img/cc02e250-df6d-42f6-bc94-d4499a72b34e.png" style="width:54.83em;height:25.25em;"/></p>
<ol start="2">
<li>Clicking on the In-portal creation option. Here, you will be prompted to decide on the kind of trigger that you want to use to start the execution. The most used ones are <strong>HTTP Request</strong> and <strong>Timer Trigger</strong>, as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="img/6e568874-17e7-461a-a28a-62e874894f58.png" style="width:45.50em;height:16.50em;"/></p>
<p style="padding-left: 60px">When you decide on the trigger you want to use, you have to name it.</p>
<ol start="3">
<li>Depending on the trigger you decide on, you will have to install some extensions and set up other parameters. For instance, HTTP trigger requires that you set up an authorization level. Three options are available, that is, Function, Anonymous, and Admin, out of which we have selected the Function option as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="img/df03fc3b-2b75-470a-b324-b7f3fc449d46.png" style="width:16.67em;height:27.67em;"/></p>
<p>It is worth mentioning that this book doesn't cover all the options that are available when it comes to building functions. As a software architect, you should understand that Azure provides a good service for serverless architectures in terms of functions. This can be useful in several situations. This was discussed in more detail in <a href="049a0a4b-74b6-41a1-92db-87a4f8af9fd1.xhtml">Chapter 4</a>, <em>Deciding on the Best Cloud-Based Solution</em>.</p>
<ol start="5">
<li>The result of this is as follows. Notice that Azure provides an editor that allows us to run the code, check logs, and test the function that we've created. This is a good interface for testing and coding basic functions:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="img/d9e2bd25-f352-4a8c-84f9-17fb2e52eaf3.png"/></p>
<ol start="6">
<li>However, if you want to create more sophisticated functions, you may need a more sophisticated environment so that you can code and debug them more efficaciously. This is where the Visual Studio Azure Functions Project can help you.</li>
</ol>
<p>In Visual Studio, you are able to create a project dedicated to Azure Functions by going to the New Project | Cloud menu.</p>
<ol start="7">
<li>Once you've submitted your project, Visual Studio will ask you for the type of trigger you're using and for the Azure version that your function will run on:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="img/28194bbf-1190-4717-bef8-f46ee96451d8.png"/></p>
<p>At the time of writing, there are two versions of Azure Functions:</p>
<ul>
<li>In the first version, you can create functions that run on .NET Framework.</li>
<li>In the second version, you can create functions that run on .NET Core.</li>
</ul>
<p>As a software architect, you always have to keep code reusability in mind. In this case, you should pay attention to which version of Azure Functions Project you will decide to build your functions in.</p>
<p>By default, the code that's generated is similar to the code that's generated when you create Azure Functions in Azure Portal. The publish method follows the same steps as the publish procedure for web apps that we described in <a href="14b5c5da-4042-439e-9e5a-2e19ba4c4930.xhtml">Chapter 1</a>, <em>Understanding the Importance of Software Architecture</em>.</p>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Listing Azure Functions templates</h1>
                
            
            
                
<p>There are several templates in the Azure Portal that you can use to create Azure Functions. The number of templates that you can choose from is updated continuously. The following are just a few of them:</p>
<ul>
<li><strong>Blob Storage</strong>: You may want to process something for a file as soon as this file is uploaded to your blob storage. This can be a good use case for Azure functions.</li>
<li><strong>Cosmos DB</strong>: You may want to synchronize data that arrives in a Cosmos DB database with a processing method. Cosmos DB was discussed in detail in <a href="77cdecb5-cef4-4b02-80a1-052ad366b9f3.xhtml">Chapter 7</a>, <em>How to Choose Your Data Storage in the Cloud</em>.</li>
<li><strong>Event Grid</strong>: This is a good way to manage Azure events. Functions can be triggered so that they manage each event.</li>
<li><strong>Event Hubs</strong>: These can be used with Azure Functions to manage data that arrives for each connected device.</li>
<li><strong>HTTP</strong>: This trigger is really useful for building serverless APIs and web apps events.</li>
<li><strong>Microsoft Graph Events</strong>: The Graph API allows you to deliver functionality associated with Office 365. For example, using this trigger, you can connect a calendar event to a function.</li>
<li><strong>Queue storage</strong>: You can handle queue processing using a function as a service solution.</li>
<li><strong>Service Bus</strong>: This is another messaging service that can be a trigger for functions. Azure Service Bus will be covered in more detail in <a href="a2d50e08-6698-47f6-a9b5-188de08134c0.xhtml">Chapter 9</a>, <em>Design Patterns and .NET Core Implementation</em>.</li>
<li><strong>Timer</strong>: This is commonly used with functions and is where you specify Time Triggers so that you can continuously process data from your system.</li>
<li><strong>WebHooks</strong>: WebHooks is a technology that allows your application to avoid pooling data from an API. You can connect them to a function to learn how the event you've hooked is being processed.</li>
</ul>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Maintaining Azure Functions</h1>
                
            
            
                
<p>Once you've created and programmed your function, you need to monitor and maintain it. To do this, you can use a variety of tools – all of which you can find in Azure Portal. These tools will help you solve problems due to the amount of information you will be able to collect with them.</p>
<p>The first option when it comes to monitoring your function is using the Monitor menu inside of the Azure Functions interface in Azure Portal. There, you will be able to check all of your function executions, including successful results and failures:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/457f702c-541d-40fe-a83a-06726885644a.png"/></p>
<p>It will take about 5 minutes for any results to be available. The date shown in the grid is in UTC time.</p>
<p class="mce-root"/>
<p>The same interface allows you to connect to Application Insights. This will take you to a world of almost indefinite options that you can use to analyze your function data. Application Insights is one of the best <strong>Application Performance Management</strong> (<strong>APM</strong>) systems available nowadays:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/dda9710f-d76d-49dd-b6d7-505cefce5689.png"/></p>
<p>Beyond the query interface, you can also check all the performance issues of your function using the Insights interface in Azure Portal. There, you can analyze and filter all the requests that have been received by your solution and check their performance and dependencies. You can also trigger alerts when something abnormal happens to one of your endpoints:</p>
<p class="mce-root"/>
<p class="CDPAlignCenter CDPAlign"><img src="img/69145b32-05c8-4d37-8782-e2f68c52eebf.png"/></p>
<p>As a software architect, you will find a really good daily helper for your projects in this tool. It is worth mentioning that Application Insights works on several other Azure Services, such as web apps and virtual machines. This means you can monitor the health of your system and maintain it using the wonderful features provided by Azure.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Use case – implementing Azure Functions to send emails</h1>
                
            
            
                
<p>Here, we will use a subset of the Azure components we described previously. The use case from WWTravelClub proposes a worldwide implementation of the service, and there is a chance that this service will need different architecture designs to face all the performance key points that we described in <a href="14b5c5da-4042-439e-9e5a-2e19ba4c4930.xhtml">Chapter 1</a>, <em>Understanding the Importance of Software Architecture</em>.</p>
<p>If you go back to the user stories that were described in <a href="14b5c5da-4042-439e-9e5a-2e19ba4c4930.xhtml">Chapter 1</a>, <em>Understanding the Importance of Software Architecture</em>, you will find that many needs are related to communication. Because of this, it is really common to have some alerts be provided by emails in the solution. This chapter's use case will focus on how to send emails. The architecture will be totally serverless.</p>
<p>The following diagram shows the basic structure of the architecture. To give users a great experience, all the emails that are sent by the application will be queued asynchronously, thus avoiding high delays in the system's responses:</p>
<p class="CDPAlignCenter CDPAlign"><img src="img/3916fea9-5954-43af-926e-4156542b61ef.png"/></p>
<p>Note that there are no servers that manage Azure Functions for inserting and Azure Functions for getting messages from the Queue Storage. This is exactly what we call serverless. It is worth mentioning that this architecture is not restricted to only sending emails – it can also be used to process any HTTP POST request.</p>
<p>Now, we will learn how to set up security in the API so that only authorized applications can use the given solution.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">First Step – creating Azure Queue Storage</h1>
                
            
            
                
<p>It's quite simple to create storage in Azure Portal. Let's learn how:</p>
<ol>
<li>First, you will need to create a storage account and set up its name, security, and network, as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="img/44690125-2574-4cd9-a1c7-144b8c084895.png" style="width:63.67em;height:51.58em;"/></p>
<ol start="2">
<li>Once you have the storage account in place, you will be able to set up a queue. You just need to provide the queue's name:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="img/b50cc828-03a4-44db-ac6a-b810319c49ba.png" style="width:42.83em;height:25.67em;"/></p>
<ol start="3">
<li>The created queue will give you an overview of Azure Portal. There, you will find your queue's URL and use the Storage Explorer:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="img/e1cd3823-bfe2-47a8-a94b-d1198341894c.png"/></p>
<p>Note that you will also be able to connect to this storage using Microsoft Azure Storage Explorer (<a href="https://azure.microsoft.com/en-us/features/storage-explorer/">https://azure.microsoft.com/en-us/features/storage-explorer/</a>):
<p class="CDPAlignCenter CDPAlign"><img src="img/1c874dcd-a218-46ba-890b-82167a3f9552.png"/></p>
</p>
<ol start="4">
<li>Now, you can start your functional programming to inform the queue that an email is waiting to be sent. Here, we need to use an HTTP trigger. Note that the function is a static class that runs asynchronously. The following code is gathering the request data coming from the HTTP trigger and is inserting the data into a queue that will be treated later:</li>
</ol>
<pre style="padding-left: 60px">public static class SendEmail<br/>{<br/>    [FunctionName(nameof(SendEmail))]<br/>    public static async Task&lt;HttpResponseMessage&gt; RunAsync(<br/>    [HttpTrigger(AuthorizationLevel.Function, "post")]   <br/>    HttpRequestMessage req, ILogger log)<br/>    {<br/>        var requestData = await req.Content.ReadAsStringAsync();<br/>        var YOUR_CONNECTION_STRING = <br/>        "YOUR_AZURE_STORAGE_ACCOUNT_CONNECTION_STRING_HERE";<br/>        var storageAccount = <br/>        CloudStorageAccount.Parse(YOUR_CONNECTION_STRING);<br/>        var queueClient = storageAccount.CreateCloudQueueClient();<br/>        var messageQueue = queueClient.GetQueueReference("email");<br/>        var message = new CloudQueueMessage(requestData);<br/>        await messageQueue.AddMessageAsync(message);<br/>        log.LogInformation("HTTP trigger from SendEmail function <br/>        processed a request.");<br/>        return req.CreateResponse(HttpStatusCode.OK, new { success <br/>        = true }, JsonMediaTypeFormatter.DefaultMediaType);<br/>    }<br/>}</pre>
<ol start="5">
<li>You can use a tool such as Postman to test your function by running the Azure Functions Emulator:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="img/e39b6278-ff70-4d79-8675-95c855e8f3d8.png"/></p>
<ol start="6">
<li>The result will appear in Microsoft Azure Storage Explorer and Azure Portal. In Azure Portal, you can manage each message and dequeue each of them or even clear the queue storage:</li>
</ol>
<div><img src="img/404c9bbe-33ed-48aa-a26b-9e39cd8c13ff.png"/></div>
<ol start="7">
<li>After this, you can create a second function. This one will be triggered by data entering your queue. It is worth mentioning that, for Azure Functions v2, you will need to add the <kbd>Microsoft.Azure.WebJobs.Extensions.Storage</kbd> library as a NuGet reference:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="img/62b1db91-f9bd-476b-9703-a4dc9eca5b9f.png" style="width:28.25em;height:25.67em;"/></p>
<ol start="8">
<li>Once you've set the connection string inside <kbd>local.settings.json</kbd>, you will be able to run both functions and test them with Postman. The difference is that, with the second function running, if you set a breakpoint at the start of it, you will check whether the message has been sent:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="img/5b1b32ef-bf7e-4be0-bafd-aef379ccc879.png"/></p>
<ol start="9">
<li>From this point, the way to send emails will depend on the mail options you have. You may decide to use a proxy or may connect directly to your email server.</li>
</ol>
<p>There are several advantages to creating an email service this way:</p>
<ul>
<li>Once your service has been coded and tested, you can use it to send emails from any of your applications. This means that your code can always be reused.</li>
<li>Apps that use this service will not be stopped from sending emails due to the asynchronous advantages of posting in an HTTP service.</li>
<li>You don't need to pool the queue to check whether are data is ready for processing.</li>
</ul>
<p>Finally, the queue process runs concurrently, which delivers a better experience in most cases. It is possible to turn it off by setting some properties in <kbd>host.json</kbd>. All of the options for this can be found in the <em>Further reading</em> section, at the end of this chapter.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Summary</h1>
                
            
            
                
<p>In this chapter, we looked at some of the advantages of developing functionality with Serverless Azure Functions. You can use it as a guideline for checking the different types of triggers that are available in Azure Functions and for planning how to monitor them. We also saw how to program and maintain Azure functions. Finally, we looked at an example of an architecture where you connect multiple functions to avoid pooling data and to enable concurrent processing.</p>
<p>In the next chapter, we will analyze the concept of design patterns, learn why they are so useful, and learn about some of their common patterns.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Questions</h1>
                
            
            
                
<ol>
<li>What are Azure Functions?</li>
<li>What are the programming options for Azure Functions?</li>
<li>What are the plans that can be used with Azure Functions?</li>
<li>How can you deploy Azure Functions with Visual Studio?</li>
<li>What triggers can you use to develop Azure Functions?</li>
<li>What is the difference between Azure Functions v1 and v2?</li>
<li>How does Application Insights help us maintain and monitor Azure Functions?</li>
</ol>
<p class="mce-root"/>
<p class="mce-root"/>


            

            
        
    

        

                            
                    <h1 class="header-title">Further reading</h1>
                
            
            
                
<p>If you want to learn more when it comes to creating Azure Functions, check out the following links:</p>
<ul>
<li>Azure Functions scale and hosting: <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-scale">https://docs.microsoft.com/en-us/azure/azure-functions/functions-scale</a></li>
<li><em>Azure Functions - Essentials [Video]</em> by Praveen Kumar Sreeram: <a href="https://www.packtpub.com/virtualization-and-cloud/azure-functions-essentials-video">https://www.packtpub.com/virtualization-and-cloud/azure-functions-essentials-video</a></li>
<li>Introducing Azure Functions 2.0: <a href="https://azure.microsoft.com/en-us/blog/introducing-azure-functions-2-0/">https://azure.microsoft.com/en-us/blog/introducing-azure-functions-2-0/</a></li>
<li>An overview of Azure Event Grid: <a href="https://azure.microsoft.com/en-us/resources/videos/an-overview-of-azure-event-grid/">https://azure.microsoft.com/en-us/resources/videos/an-overview-of-azure-event-grid/</a></li>
<li>Timer trigger for Azure Functions: <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer">https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer</a></li>
<li>Application insights section from the book, <em>Azure for Architects</em> by Ritesh Modi: <a href="https://subscription.packtpub.com/book/virtualization_and_cloud/9781788397391/12/ch12lvl1sec95/application-insights">https://subscription.packtpub.com/book/virtualization_and_cloud/9781788397391/12/ch12lvl1sec95/application-insights</a></li>
<li>Monitoring Azure Functions using Application Insights section from the book, <em>Azure Serverless Computing Cookbook</em> by Praveen Kumar Sreeram: <a href="https://subscription.packtpub.com/book/virtualization_and_cloud/9781788390828/6/06lvl1sec34/monitoring-azure-functions-using-application-insights">https://subscription.packtpub.com/book/virtualization_and_cloud/9781788390828/6/06lvl1sec34/monitoring-azure-functions-using-application-insights</a></li>
<li>Get started with Azure Queue storage using .NET: <a href="https://docs.microsoft.com/en-us/azure/storage/queues/storage-dotnet-how-to-use-queues">https://docs.microsoft.com/en-us/azure/storage/queues/storage-dotnet-how-to-use-queues</a></li>
<li>Azure Functions triggers and bindings concepts: <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-triggers-bindings">https://docs.microsoft.com/en-us/azure/azure-functions/functions-triggers-bindings</a></li>
<li>Azure Queue storage bindings for Azure Functions: <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-queue">https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-queue</a></li>
</ul>


            

            
        
    </body></html>