<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;A Sample Application"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. A Sample Application</h1></div></div></div><p>Let's create a structure of our own in Microsoft Dynamics NAV. To do this, we must think of something that is not already available in the standard package but can be built on top of it.</p><p>For our example application, we will run a squash court. Running a squash court is simple to understand but something we cannot do without changing and expanding the product. In order to define our changes, we first need to make a fit-gap analysis.</p><p>After this chapter, you will have better understanding on how to reuse the framework of the Microsoft Dynamics NAV application. We will show how to reverse engineer the application and to study its functionality by going into the application code.</p><p>For this example, some new and changed objects are required. The <a class="link" href="apa.html" title="Appendix A. Installation Guide">Appendix</a>, <span class="emphasis"><em>Installation Guide</em></span>, describes where to find the objects and how to install and activate them.</p><p>In the first part, we will look at how to reverse engineer the standard application to look at and learn how it works and how to reuse the structures in our own solutions.</p><p>In the second part of the chapter, we will learn how to use the journals and entries in a custom application.</p><p>Lastly, we will look at how to integrate our solution with the standard application; in our case, sales invoicing.</p><div class="section" title="Fit-gap analysis"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec25"/>Fit-gap analysis</h1></div></div></div><p>When we <a class="indexterm" id="id157"/>do a fit-gap analysis, we <a class="indexterm" id="id158"/>look at the company's processes and define what we can and cannot do with the standard package. When a business process can be handled with the standard software we call this a <a class="indexterm" id="id159"/>
<span class="strong"><strong>Fit</strong></span>. When this cannot be done it's called a <a class="indexterm" id="id160"/>
<span class="strong"><strong>Gap</strong></span>. All gaps have to be either developed or we need to purchase an add-on.</p><p>However, even when something could be done with standard software features it does not necessarily mean that doing this is wise. The standard application should be used for what it is designed for. Using <a class="indexterm" id="id161"/>standard features for something else might work in the current version but if it changes in a new version it might no longer fit. For this reason it is better to design something new instead of wrongly using standard features.</p><div class="section" title="Designing a squash court application"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec35"/>Designing a squash court application</h2></div></div></div><p>The <a class="indexterm" id="id162"/>basic process of a squash court company is renting the courts to squash players; both members and non-members. There is a <a class="indexterm" id="id163"/>reservation and invoicing process handling different rates for members and non-members.</p><p>Although this could be implemented using items as squash courts and customers as players, this would be a typical example of using standard features wrongly. Instead of doing this, we will look at how items and customers are designed and use this to create a new squash court application.</p><p>Designing a specific application using standard NAV features is a matter of <a class="indexterm" id="id164"/>
<span class="strong"><strong>total cost of ownership</strong></span> (<span class="strong"><strong>TCO</strong></span>). If only one customer would use this solution, it would be better to use the standard application in a creative way. However, if we deploy the design from this chapter on a multi-tenant architecture and let thousands of companies run it, it would be economically possible to make the best application for the job. Keep this in mind each time you make a decision to design.</p></div><div class="section" title="Look, learn, and love"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec36"/>Look, learn, and love</h2></div></div></div><p>To determine the design for this application, we will first look at the parts of the standard application, which we can use to learn how they work. We will use this knowledge in our own design.</p><p>In Microsoft Dynamics NAV, customer and vendor master data are maintained using <a class="indexterm" id="id165"/>
<span class="strong"><strong>relationship management</strong></span> (<span class="strong"><strong>RM</strong></span>). For our solution, we will create a new master data for squash players being the business part of the application. This will also be integrated with RM.</p><p>To design the squash court, we will look at the design of items in the standard package. The squash court will be the product part of our application with a journal to create reservation entries, which we can invoice.</p><p>For this invoicing process, we will use and integrate with the sales part of Microsoft Dynamics NAV. </p><div class="section" title="Drawing the table and posting schema"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec01"/>Drawing the table and posting schema</h3></div></div></div><p>After <a class="indexterm" id="id166"/>we have decided on the design of our application, we <a class="indexterm" id="id167"/>can draw the tables and post the routines as we did in the previous chapter. This will clarify the design for others and guide us through the development process.</p><div class="mediaobject"><img alt="Drawing the table and posting schema" src="graphics/0365EN_02_01.jpg"/></div><p>In the preceding diagram, the objects in <a class="indexterm" id="id168"/>
<span class="strong"><strong>Relationship Management</strong></span> and <span class="strong"><strong>Sales</strong></span> are standard objects that we will possibly need to modify. The objects for the <span class="strong"><strong>Squash Application</strong></span>
<a class="indexterm" id="id169"/> are new objects but based on similar objects in the standard application.</p></div><div class="section" title="The project approach"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec02"/>The project approach</h3></div></div></div><p>In order to<a class="indexterm" id="id170"/> keep track of our project, we'll cut the changes into smaller tasks. The first task will be to do the changes in relationship management to be able to create a squash player from a contact. The second part is to create squash courts. The reservation and invoice processes are part three and four.</p></div><div class="section" title="Interfacing with the standard application"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec03"/>Interfacing with the standard application</h3></div></div></div><p>In our schema, we <a class="indexterm" id="id171"/>can see that we have two processes where we need to work on the standard Microsoft Dynamics NAV processes, which are <span class="strong"><strong>Relationship Management</strong></span> and <span class="strong"><strong>Sales</strong></span>.</p></div></div><div class="section" title="Design patterns"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec37"/>Design patterns</h2></div></div></div><p>To create <a class="indexterm" id="id172"/>the squash court application, we can use proven design patterns. This will limit the risk of our development's success and make it easy to communicate with others who are familiar with the patterns.</p><p>Examples of the patterns we will use are master data, number series, and journals.</p><p>Not everything that you need will be documented in patterns. Sometimes it is necessary to innovate. If you do this, it is important to still imagine your design as a pattern and document it for future use.</p></div></div></div>
<div class="section" title="Getting started"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec26"/>Getting started</h1></div></div></div><p>In the first part of the design process, we will look at how to reverse engineer the standard application in order to learn and reuse the knowledge in our own solution.</p><div class="section" title="Creating squash players"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec38"/>Creating squash players</h2></div></div></div><p>For the administration of our<a class="indexterm" id="id173"/> squash players, we use <a class="indexterm" id="id174"/>the data from the contact table. In the standard product, it is possible to create a customer or vendor with the contact data. We require the same functionality to create squash players so let's have a look at how this is done by Microsoft.</p><p>Open <span class="strong"><strong>Contact Card</strong></span> and try to find this function, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Creating squash players" src="graphics/0365EN_02_02.jpg"/></div><p>We want a function like this for our squash players. So let's get in and see what it does. For this, we need <a class="indexterm" id="id175"/>to design the page and look at the actions. The page number in this case is <span class="strong"><strong>5050</strong></span>, which we can find by clicking on <span class="strong"><strong>About this Page</strong></span> in the top-right corner of the page, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Creating squash players" src="graphics/0365EN_02_03.jpg"/></div><p>This option can <a class="indexterm" id="id176"/>be very useful to find information about the fields that are not on the page, the filters, or the source table.</p><div class="mediaobject"><img alt="Creating squash players" src="graphics/0365EN_02_04.jpg"/></div><p>To open the page, we <a class="indexterm" id="id177"/>need to open <span class="strong"><strong>Object Designer</strong></span> in <span class="strong"><strong>Development Environment</strong></span> (<span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>F12</em></span>), as shown in the following screenshot:</p><div class="mediaobject"><img alt="Creating squash players" src="graphics/0365EN_02_05.jpg"/></div><p>Here, we <a class="indexterm" id="id178"/>can find <span class="strong"><strong>5050 Contact Card</strong></span> in <span class="strong"><strong>Page</strong></span>:</p><div class="mediaobject"><img alt="Creating squash players" src="graphics/0365EN_02_06.jpg"/></div><p>We are looking for <span class="strong"><strong>Actions</strong></span> on this page. They are kind of difficult to find if you are unfamiliar with <span class="strong"><strong>Page Designer</strong></span>. To open <span class="strong"><strong>Actions</strong></span>, the cursor should be on the blank line below the last populated line. Then click on the right mouse button and <span class="strong"><strong>Actions</strong></span> or select <span class="strong"><strong>Actions</strong></span> from the <span class="strong"><strong>View</strong></span> drop-down menu.</p><div class="mediaobject"><img alt="Creating squash players" src="graphics/0365EN_02_07.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>Alternatively, you can also use the <span class="strong"><strong>Preview</strong></span> option from the <span class="strong"><strong>View</strong></span> drop-down menu to find the action.</p></div></div><p>Now, we<a class="indexterm" id="id179"/> are<a class="indexterm" id="id180"/> in the <span class="strong"><strong>Action Designer</strong></span> and we can search for the <span class="strong"><strong>Create as</strong></span> option. To see what it does, we need to go into the C/AL code by pressing <span class="emphasis"><em>F9</em></span> or by selecting <span class="strong"><strong>C/AL Code</strong></span> from the <span class="strong"><strong>View</strong></span> drop-down menu:</p><div class="mediaobject"><img alt="Creating squash players" src="graphics/0365EN_02_09.jpg"/></div><div class="section" title="CreateVendor versus CreateCustomer"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec04"/>CreateVendor versus CreateCustomer</h3></div></div></div><p>In Microsoft Dynamics NAV, there<a class="indexterm" id="id181"/> is a small difference between creating a customer and a vendor from a contact. When creating a customer, the system will ask us to select a customer template. The <span class="strong"><strong>Vendor</strong></span> option does not have that. To keep things simple, we will look at and learn from the <code class="literal">Vendor</code> function in this chapter.</p><p>The customer and vendor table are almost identical in structure and fields are numbered similarly in both tables. This is called transaction mirroring between sales and purchasing, which we will discuss further in <a class="link" href="ch06.html" title="Chapter 6. Trade">Chapter 6</a>, <span class="emphasis"><em>Trade</em></span>. We will mirror our new table in a similar way to the other Microsoft Dynamics NAV tables.</p><p>The C/AL code in <span class="strong"><strong>Action</strong></span> tells us that when clicking on the <span class="strong"><strong>Menu</strong></span> option, the function <code class="literal">CreateVendor</code> in the contact table is started. To copy this feature, we need to create a new function, <code class="literal">CreateSquashPlayer</code>. Let's keep that in mind while we dive further in this code.</p><div class="mediaobject"><img alt="CreateVendor versus CreateCustomer" src="graphics/0365EN_02_10.jpg"/></div><p>Open the contact table (5050) and search for the function <code class="literal">CreateVendor</code>. You can find functions in a table by going into the C/AL code (<span class="emphasis"><em>F9</em></span>) from anywhere in the table designer, and by using the <span class="strong"><strong>Find [Ctrl+F]</strong></span> function, as shown in the following screenshot:</p><div class="mediaobject"><img alt="CreateVendor versus CreateCustomer" src="graphics/0365EN_02_11.jpg"/></div></div><div class="section" title="Reverse engineering"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec05"/>Reverse engineering</h3></div></div></div><p>We need to <a class="indexterm" id="id182"/>reverse engineer this code in order to see what we <a class="indexterm" id="id183"/>need to create for our <code class="literal">CreateSquashPlayer</code> function. We will look at each part of the C/AL code in order to decide whether we need it or not.</p><div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_12.jpg"/></div><p>What does the following piece of code do?</p><div class="informalexample"><pre class="programlisting">TESTFIELD("Company No.");</pre></div><p>This tests the current record for a valid <code class="literal">Company No</code>. If this fails, we cannot continue and the end user gets a runtime error.</p><div class="informalexample"><pre class="programlisting">RMSetup.GET;
RMSetup.TESTFIELD("Bus. Rel. Code for Vendors");</pre></div><p>This reads the <code class="literal">Marketing Setup</code> table from the system and tests whether the <code class="literal">Bus. Rel. Code for Vendors</code> is valid. We need a new code for squash players here, which will be added as a new field to the setup table:</p><div class="informalexample"><pre class="programlisting">CLEAR(Vend);
Vend.SetInsertFromContact(TRUE);
Vend.INSERT(TRUE);
Vend.SetInsertFromContact(FALSE);</pre></div><p>Here, the <code class="literal">Vendor</code> table is cleared and a function is called within that table, then a new record is inserted in the database while activating the necessary business logic. Then the same function is called again with another parameter. Since the <code class="literal">Vendor</code> table is what we are copying, we will write down that we might need a similar function as <code class="literal">SetInsertFromContact</code>:</p><div class="informalexample"><pre class="programlisting">IF Type = Type::Company THEN
  ContComp := Rec 
ELSE
  ContComp.GET("Company No.");</pre></div><p>This code<a class="indexterm" id="id184"/> checks <a class="indexterm" id="id185"/>whether the current contact is a company. If so, it populates the <code class="literal">ContComp</code> variable with this record. If not, it populates <code class="literal">ContComp</code> with the company our current contact is related to:</p><div class="informalexample"><pre class="programlisting">ContBusRel."Contact No." := ContComp."No.";
ContBusRel."Business Relation Code" := RMSetup."Bus. Rel. Code for Vendors";
ContBusRel."Link to Table" := ContBusRel."Link to Table"::Vendor;
ContBusRel."No." := Vend."No.";
ContBusRel.INSERT(TRUE);</pre></div><p>The <code class="literal">ContBusRel</code> function<a class="indexterm" id="id186"/> refers to the table Contact Business Relation (5054) and is a linking table in the Microsoft Dynamics NAV data model. Technically, a contact can be connected to multiple customers and vendors although this does not make sense. This table is populated here. Let's write down that we need to look into this table and see if it needs changes:</p><div class="informalexample"><pre class="programlisting">UpdateCustVendBank.UpdateVendor(ContComp,ContBusRel);</pre></div><p>
<code class="literal">UpdateCustVendBank</code>
<a class="indexterm" id="id187"/> is an external codeunit that is used with the function <code class="literal">UpdateVendor</code>. We might need a copy of this function for our Squash players.</p><div class="informalexample"><pre class="programlisting">MESSAGE(Text009,Vend.TABLECAPTION,Vend."No.");</pre></div><p>The preceding code gives a message box for the end user that the record is created with the new number. Now, we have a number of things on our to-do list:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a master data table that looks like the <code class="literal">Vendor</code> table.</li><li class="listitem">We need to copy the <code class="literal">CreateVendor</code> function. </li><li class="listitem">Look at the <code class="literal">Contact Business Relation</code> table and the <code class="literal">CustVendBank-Update (5055)</code> codeunit.</li></ol></div><p>Let's look at the latter to learn something important before we start with the first:</p><div class="informalexample"><pre class="programlisting">UpdateVendor()
WITH Vend DO BEGIN
  GET(ContBusRel."No.");
  xRecRef.GETTABLE(Vend);
  NoSerie := "No. Series";
  PurchaserCode :=  Vend."Purchaser Code";
  TRANSFERFIELDS(Cont);
  "No." := ContBusRel."No.";
  "No. Series" := NoSerie;
  Vend."Purchaser Code" := PurchaserCode;
  MODIFY;
  RecRef.GETTABLE(Vend);
  ChangeLogMgt.LogModification(RecRef,xRecRef);
END;</pre></div><p>This code synchronizes<a class="indexterm" id="id188"/> the contact table with the vendor table. It <a class="indexterm" id="id189"/>does that by <a class="indexterm" id="id190"/>using the <code class="literal">TRANSFERFIELDS</code> function. This function transfers all fields with the same number from one table to another. This means that we cannot be creative with our field numbering. For example, in the contact table, the <span class="strong"><strong>Name</strong></span> field is number <span class="strong"><strong>2</strong></span>. If we were to use a different number for the <span class="strong"><strong>Name</strong></span> field, <code class="literal">TRANSFERFIELDS</code> would not copy the information.</p><p>Using this information, our table should look like this:</p><div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_13.jpg"/></div><p>Notice that we use field <span class="strong"><strong>19</strong></span> for our <span class="strong"><strong>Squash Player</strong></span> specific field. This is because field <span class="strong"><strong>19</strong></span> was used for <span class="strong"><strong>Budgeted Amount</strong></span> in the vendor table. We can therefore safely assume that Microsoft will not use field <span class="strong"><strong>19</strong></span> in the contact table in future.</p><p>An alternative approach for this if we wanted to be even safer is to add the fields that are specific to our solution as fields in our add-on number series. In our case, it would be 123.456.700.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>You can copy and paste fields from one table to another table. Note that table relations and C/AL code in the <code class="literal">OnValidate</code> and <code class="literal">OnLookup</code> trigger is copied as well. If the table we want to create is similar to an existing table, we could also use the <span class="strong"><strong>Save As</strong></span> option from the <span class="strong"><strong>File</strong></span> drop-down menu.</p></div></div><p>The next step is <a class="indexterm" id="id191"/>to add some business logic to the table. We want this table to use number series functionality just like the vendor table. This requires some standard steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First we create the setup table. A number series is defined in a setup table. As the <span class="strong"><strong>Squash Court</strong></span> module will be quite sophisticated, we'll create our own.<div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_14.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip06"/>Tip</h3><p>On MSDN, you can watch a video about the singleton pattern at <a class="ulink" href="http://msdn.microsoft.com/en-us/dynamics/nav/dn722393.aspx">http://msdn.microsoft.com/en-us/dynamics/nav/dn722393.aspx</a>.</p></div></div><p>A setup table always has a single <span class="strong"><strong>Primary Key</strong></span> field, as shown in the preceding screenshot, and the necessary setup fields. This table is designed to only have one single record.</p></li><li class="listitem">Then, we create a link to the number series. Our <span class="strong"><strong>Squash Player</strong></span> table is now required to have a link to the number series. We can copy this field from the vendor table and can make a table relation to the <span class="strong"><strong>No. Series</strong></span> table, as shown in the following screenshot:<div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_15.jpg"/></div></li><li class="listitem">Now, we add<a class="indexterm" id="id192"/> the C/AL business logic to our table, but <a class="indexterm" id="id193"/>first we need to define the variables that are required. These are our new <span class="strong"><strong>Squash Setup</strong></span> table and the <span class="strong"><strong>Number Series Management</strong></span> codeunits.<div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_16.jpg"/></div><p>We can define the variables in the specially created <span class="strong"><strong>C/AL Globals</strong></span> menu.</p><div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_17.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip07"/>Tip</h3><p>It is highly recommended to use the Microsoft naming standard, which allows you to copy and paste a lot of code and makes it easier for others to read your code.</p></div></div></li></ol></div><p>Number Series<a class="indexterm" id="id194"/> require three places of code. This code makes sure<a class="indexterm" id="id195"/> that the business logic of the Number Series functionality is always followed:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The following code goes into the <code class="literal">OnInsert</code> trigger. It populates the <code class="literal">No.</code> field with the next value of the Number Series:<div class="informalexample"><pre class="programlisting">OnInsert()
IF "No." = '' THEN BEGIN
  SquashSetup.GET;
  SquashSetup.TESTFIELD("Squash Player Nos.");
  NoSeriesMgt.InitSeries(SquashSetup."Squash Player Nos.",
    xRec."No. Series",0D,"No.","No. Series");
END;</pre></div></li><li class="listitem">The <code class="literal">OnValidate</code> trigger of the <code class="literal">No.</code> field tests when a user manually enters a value if that is allowed:<div class="informalexample"><pre class="programlisting">No. - OnValidate()
IF "No." &lt;&gt; xRec."No." THEN BEGIN
  SquashSetup.GET;
  NoSeriesMgt.TestManual(SquashSetup."Squash Player Nos.");
  "No. Series" := '';
END;</pre></div></li><li class="listitem">Lastly, we create a new <code class="literal">AssistEdit</code> function. This function is for readability and others reading your code afterwards. The code is used in the page or form and allows users to switch between linked number series:<div class="informalexample"><pre class="programlisting">AssistEdit() : Boolean
SquashSetup.GET;
SquashSetup.TESTFIELD("Squash Player Nos.");
IF NoSeriesMgt.SelectSeries(SquashSetup."Squash Player Nos.",
  xRec."No. Series","No. Series") 
THEN BEGIN
  NoSeriesMgt.SetSeries("No.");
  EXIT(TRUE);
END;</pre></div></li></ol></div><p>When the Number Series<a class="indexterm" id="id196"/> are in place, we can make the necessary <a class="indexterm" id="id197"/>change in the Contact Business Relation table.</p><p>In this table, we need to add the possibility to link squash players to contacts. This is done in the <span class="strong"><strong>Properties</strong></span> window of <span class="strong"><strong>Table Designer</strong></span> that can be accessed by pressing (<span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>F4</em></span>) or by using the <span class="strong"><strong>Properties</strong></span> option from the <span class="strong"><strong>View</strong></span> drop-down menu, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_18.jpg"/></div><p>First, we add the <span class="strong"><strong>Squash player</strong></span> option to the <span class="strong"><strong>Link to Table</strong></span> field, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_19.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip08"/>Tip</h3><p>Options are converted to SQL Integer data types. Make sure to add some blank options so when Microsoft releases other functionality we are not impacted. Changing the integer value of an existing option field requires a lot of work.</p></div></div><p>Then, we create a table relation with our new table, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_20.jpg"/></div><p>The next step is to <a class="indexterm" id="id198"/>expand<a class="indexterm" id="id199"/> the <span class="strong"><strong>CustVendBank-Update</strong></span> codeunit with a new <code class="literal">UpdateSquashPlayer</code> function. This is a copy of the <code class="literal">UpdateVendor</code> function that we discussed before. We can add functions in the <span class="strong"><strong>Globals</strong></span> menu.</p><p>There are two ways to copy a function. We can create a new function manually and copy the C/AL code and variables, or we can select a function from the list and use copy and paste and then rename the function.</p><div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_21.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip09"/>Tip</h3><p>When you add the <code class="literal">---</code> line to the function, others can see that it is not a Microsoft function. You can also include the project name like <code class="literal">---Squash</code>. This also makes the code easier to upgrade or to merge with other code.</p></div></div><p>This code also <a class="indexterm" id="id200"/>requires a new global variable, <code class="literal">SquashPlayer</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>UpdateSquashPlayer()</strong></span>
WITH SquashPlayer DO BEGIN
  GET(ContBusRel."No.");
  xRecRef.GETTABLE(SquashPlayer);
  NoSerie := "No. Series";
  TRANSFERFIELDS(Cont);
  "No." := ContBusRel."No.";
  "No. Series" := NoSerie;
  MODIFY;
  RecRef.GETTABLE(SquashPlayer);
  ChangeLogMgt.LogModification(RecRef,xRecRef);
END;</pre></div><p>The final piece of preparation work is to add the <span class="strong"><strong>Bus. Rel. Code for Squash Players</strong></span> field to the <span class="strong"><strong>Marketing Setup</strong></span> table, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_22.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>We use the same numbering in our fields as in our objects. This makes it easier in the future to see what belongs to what if more functionality is added.</p></div></div><p>With all this preparation work, we can now finally go ahead and make our function in the contact table (5050) that we can call from the user interface:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CreateSquashPlayer()</strong></span>
TESTFIELD(Type, Type::Person);

RMSetup.GET;
RMSetup.TESTFIELD("Bus. Rel. Code for Squash Pl.");

CLEAR(SquashPlayer);
SquashPlayer.INSERT(TRUE);

ContBusRel."Contact No." := Cont."No.";
ContBusRel."Business Relation Code" := 
  RMSetup."Bus. Rel. Code for Squash Pl.";
ContBusRel."Link to Table" := 
  ContBusRel."Link to Table"::"Squash Player";
ContBusRel."No." := SquashPlayer."No.";
ContBusRel.INSERT(TRUE);

UpdateCustVendBank.UpdateSquashPlayer(Cont,ContBusRel);

MESSAGE(Text009,SquashPlayer.TABLECAPTION,SquashPlayer."No.");</pre></div><p>Please note that we<a class="indexterm" id="id201"/> do not need the <code class="literal">SetInsertFromContact</code> function. This <a class="indexterm" id="id202"/>function enables users to create a new vendor first and create a contact using the vendor information. We do not want to support this method in our application.</p><p>Now, we can add the function to the page and test our functionality:</p><div class="mediaobject"><img alt="Reverse engineering" src="graphics/0365EN_02_23.jpg"/></div></div></div></div>
<div class="section" title="Designing a journal"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec27"/>Designing a journal</h1></div></div></div><p>Now, it is<a class="indexterm" id="id203"/> time to start on the product part of the squash application. In this part, we will no longer reverse engineer in detail. We will learn how<a class="indexterm" id="id204"/> to search in the standard functionality and reuse parts in our own software.</p><p>For this part, we will look at resources in Microsoft Dynamics NAV. Resources are similar to using as products as items but far less complex making it easier to look and learn.</p><div class="section" title="Squash court master data"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec39"/>Squash court master data</h2></div></div></div><p>Our <a class="indexterm" id="id205"/>company has 12 courts that we want to register in Microsoft Dynamics NAV. This master data is comparable to resources so we'll go ahead and copy this functionality. Resources are not attached to the contact table like the vendor/squash player tables. We need the number series again so we'll add a new number series to our Squash Setup table.</p><p>The <span class="strong"><strong>Squash Court</strong></span> table should look like this after creation:</p><div class="mediaobject"><img alt="Squash court master data" src="graphics/0365EN_02_24.jpg"/></div></div><div class="section" title="Chapter objects"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec40"/>Chapter objects</h2></div></div></div><p>With this <a class="indexterm" id="id206"/>chapter some objects are required. A description of how to import these objects can be found in the <a class="link" href="apa.html" title="Appendix A. Installation Guide">Appendix</a>, <span class="emphasis"><em>Installation Guide</em></span>.</p><div class="mediaobject"><img alt="Chapter objects" src="graphics/0365EN_02_25.jpg"/></div><p>After the import process is completed, make sure that your current database is the default database for the Role Tailored Client and run page 123456701, <span class="strong"><strong>Squash Setup</strong></span>.</p><div class="mediaobject"><img alt="Chapter objects" src="graphics/0365EN_02_26.jpg"/></div><p>From this page, <a class="indexterm" id="id207"/>select the action <span class="strong"><strong>Initialize Squash Application</strong></span>. This will execute the C/AL code in the <code class="literal">InitSquashApp</code> function of this page, which will prepare the demo data for us to play with. The objects are prepared and tested in a Microsoft Dynamics NAV 2013 R2 W1 database.</p></div><div class="section" title="Reservations"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec41"/>Reservations</h2></div></div></div><p>When running a <a class="indexterm" id="id208"/>squash court, we want to be able to keep track of reservations. Looking at standard Dynamics NAV functionality, it might be a good idea to create a squash player journal. The journal can create entries for reservations that can be invoiced.</p><p>A journal needs the object structure. The journal is prepared in the objects delivered with this chapter. Creating a new journal from scratch is a lot of work and can easily lead to making mistakes. It is easier and safer to copy an existing journal structure from the standard application that is similar to the journal we need for our design.</p><p>In our example, we have copied the Resource Journals:</p><div class="mediaobject"><img alt="Reservations" src="graphics/0365EN_02_27.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip11"/>Tip</h3><p>You can export these objects in text format and then rename and renumber the objects to be reused easily. The Squash Journal objects are renumbered and renamed from the Resource Journal.</p></div></div><p>As explained in <a class="link" href="ch01.html" title="Chapter 1. Introduction to Microsoft Dynamics NAV">Chapter 1</a>, <span class="emphasis"><em>Introduction to Microsoft Dynamics NAV</em></span>, all journals have the same structure. The<a class="indexterm" id="id209"/> template, batch, and register tables are almost always the same whereas the journal line and ledger entry table contain function-specific fields. Let's have a look at all of them one by one.</p><p>The <span class="strong"><strong>Journal Template</strong></span> has<a class="indexterm" id="id210"/> several fields, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Reservations" src="graphics/0365EN_02_28.jpg"/></div><p>Let's discuss these fields<a class="indexterm" id="id211"/> in more detail:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Name</strong></span>: This is the unique name. It is possible to define as many templates as required but usually one template per form ID and one for recurring will do. If you want journals with different source codes, you need to have more templates.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Description</strong></span>: A readable and understandable description for its purpose.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Test Report ID</strong></span>: All templates have a test report that allows the user to check for posting errors.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Form ID</strong></span>: For some journals, more UI objects are required. For example, the General Journals have a special form for bank and cash.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Posting Report ID</strong></span>: This report is printed when a user selects <span class="strong"><strong>Post</strong></span> and <span class="strong"><strong>Print</strong></span>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Force Posting Report</strong></span>: Use this option when a posting report is mandatory.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Source Code</strong></span>: Here you can enter a trail code for all the postings done via this journal.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Reason Code</strong></span>: This functionality is similar to <span class="strong"><strong>Source Code</strong></span>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Recurring</strong></span>: Whenever you post lines from a recurring journal, new lines are automatically created with a posting date defined in the recurring date formula.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>No. Series</strong></span>: When you use this feature the <span class="strong"><strong>Document No.</strong></span> in the journal line is automatically populated with a new number from this Number Series.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Posting No. Series</strong></span>: Use this feature for recurring journals.</li></ul></div><p>The <span class="strong"><strong>Journal Batch</strong></span> has various fields, as <a class="indexterm" id="id212"/>shown in the following screenshot:</p><div class="mediaobject"><img alt="Reservations" src="graphics/0365EN_02_29.jpg"/></div><p>Let's discuss these fields in more detail:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Journal Template Name</strong></span>: The name of the journal template this batch refers to</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Name</strong></span>: Each batch should have a unique code</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Description</strong></span>: A readable and explaining description for this batch</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Reason Code</strong></span>: When populated this <span class="strong"><strong>Reason Code</strong></span> will overrule <span class="strong"><strong>the Reason Code</strong></span> from the <span class="strong"><strong>Journal Template</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>No. Series</strong></span>: When populated this <span class="strong"><strong>No. Series</strong></span> will overrule the <span class="strong"><strong>No. Series</strong></span> from the <span class="strong"><strong>Journal Template</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Posting No. Series</strong></span>: When populated this <span class="strong"><strong>Posting No. Series</strong></span> will overrule the <span class="strong"><strong>Posting No. Series</strong></span> from the <span class="strong"><strong>Journal Template</strong></span></li></ul></div><p>The <span class="strong"><strong>Register</strong></span> table<a class="indexterm" id="id213"/> has various fields, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Reservations" src="graphics/0365EN_02_30.jpg"/></div><p>Terms <a class="indexterm" id="id214"/>from the <span class="strong"><strong>Journal Register</strong></span> tab that you need to know would be:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>No.</strong></span>: This field is automatically and incrementally populated for each transaction with this journal and there are no gaps between the numbers</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>From Entry No.</strong></span>: A reference to the first ledger entry created is with this transaction</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>To Entry No.</strong></span>: A reference to the last ledger entry is created with this transaction</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Creation Date</strong></span>: Always populated with the real date when the transaction was posted</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>User ID</strong></span>: The ID of the end user who has posted the transaction</li></ul></div></div><div class="section" title="The journal"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec42"/>The journal</h2></div></div></div><p>The journal line<a class="indexterm" id="id215"/> has a number of mandatory fields that are required for all journals and some fields that are required for their designed functionality.</p><p>In our case, the journal should create a reservation which then can be invoiced. This requires some information to be populated in the lines.</p><div class="section" title="Reservation"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec06"/>Reservation</h3></div></div></div><p>The reservation process<a class="indexterm" id="id216"/> is a logistical process that requires us to know the number of the squash court, the date, and the time of the reservation. We also need to know how long the players want to play. To check the reservation, it might also be useful to store the number of the squash player.</p></div><div class="section" title="Invoicing"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec07"/>Invoicing</h3></div></div></div><p>For the invoicing<a class="indexterm" id="id217"/> part, we need to know the price we need to invoice. It might also be useful to store the cost to see our profit. For the system to figure out the proper G/L Account for the turnover, we also need to define a General Product Posting Group. We will see more of how that works later in <a class="link" href="ch03.html" title="Chapter 3. Financial Management">Chapter 3</a>, <span class="emphasis"><em>Financial Management</em></span>.</p><div class="mediaobject"><img alt="Invoicing" src="graphics/0365EN_02_31.jpg"/></div><p>Let's discuss<a class="indexterm" id="id218"/> these fields in more detail:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Journal Template Name</strong></span>: This is a reference to the current <span class="strong"><strong>Journal Template</strong></span>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Line No.</strong></span>: Each journal has a virtually unlimited number of lines; this number is automatically incremented by 10000 allowing lines to be created in between.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Entry Type</strong></span>: This is the reservation or invoice.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Document No.</strong></span>: This number can be used to give to the squash player as a reservation number. When the <span class="strong"><strong>Entry Type</strong></span> is <span class="strong"><strong>Invoice</strong></span>, it is the invoice number.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Posting Date</strong></span>: This is usually the reservation date but when the <span class="strong"><strong>Entry Type</strong></span> is <span class="strong"><strong>Invoice</strong></span>, it might be the date of the invoice, which might differ from the posting date in the general ledger.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Squash Player No.</strong></span>: This is a reference to the squash player who has made the reservation.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Squash Court No.</strong></span>: This is a reference to the squash court.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Description</strong></span>: This<a class="indexterm" id="id219"/> is automatically updated with the number of the squash court, reservation date, and times, but can be changed by the user.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Reservation Date</strong></span>: This is the actual date of the reservation.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>From Time</strong></span>: This is the starting time of the reservation. We only allow whole and half hours.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>To Time</strong></span>: This is the ending time of the reservation. We only allow whole and half hours. This is automatically populated when people enter a quantity.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Quantity</strong></span>: This is the number of hours' playing time. We only allow units of 0.5 to be entered here. This is automatically calculated when the times are populated.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Unit Cost</strong></span>: This is the cost to run a squash court for one hour.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Total Cost</strong></span>: This is the cost for this reservation.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Unit Price</strong></span>: This is the invoice price for this reservation per hour. This depends on whether or not the squash player is a member or not.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Total Price</strong></span>: This is the total invoice price for this reservation.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Shortcut Dimension Code 1 &amp; 2</strong></span>: This is a reference to the dimensions used for this transaction.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Applies-to Entry No.</strong></span>: When a reservation is invoiced, this is the reference to the <span class="strong"><strong>Squash Entry No.</strong></span> of the reservation.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Source Code</strong></span>: This is inherited from the journal batch or template and used when posting the transaction.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Chargeable</strong></span>: When this option is used, there will not be an invoice for the reservation.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Journal Batch Name</strong></span>: This is a reference to the journal batch that is used for this transaction.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Reason Code</strong></span>: This is inherited from the journal batch or template and used when posting the transaction.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Recurring Method</strong></span>: When the journal is a recurring journal, you can use this field to determine if the <span class="strong"><strong>Amount</strong></span> field is blanked after posting the lines.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Recurring Frequency</strong></span>: This field determines the new posting date after the recurring lines are posted.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Gen. Bus. Posting Group</strong></span>: The combination of general business and product posting group determines the G/L Account for turnover when we invoice the reservation. The <span class="strong"><strong>Gen. Bus. Posting Group</strong></span> is inherited from the bill-to customer.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Gen. Prod. Posting Group</strong></span>: This will be inherited from the squash player.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>External Document No.</strong></span>: When a squash player wants us to note a reference number, we can store it here.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Posting No. Series</strong></span>: When <a class="indexterm" id="id220"/>the <span class="strong"><strong>Journal Template</strong></span> has a <span class="strong"><strong>Posting No. Series</strong></span>, it is populated here to be used when posting.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Bill-to Customer No.</strong></span>: This determines who is paying for the reservation. We will inherit this from the squash player.</li></ul></div><p>So now we have a place to enter reservations but we have something to do before we can start doing this. Some fields were determined to be inherited and calculated:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The time field needs calculation to avoid people entering wrong values</li><li class="listitem" style="list-style-type: disc">The <span class="strong"><strong>Unit Price</strong></span> should be calculated</li><li class="listitem" style="list-style-type: disc">The <span class="strong"><strong>Unit Cost</strong></span>, <span class="strong"><strong>Posting groups</strong></span>, and <span class="strong"><strong>Bill-to Customer No.</strong></span> need to be inherited</li><li class="listitem" style="list-style-type: disc">As the final cherry on top, we will look at implementing dimensions</li></ul></div></div></div><div class="section" title="Time calculation"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec43"/>Time calculation</h2></div></div></div><p>When it comes <a class="indexterm" id="id221"/>to the time, we want only to allow specific start and end times. Our squash court can be used in blocks of half an hour. The <span class="strong"><strong>Quantity</strong></span> field should be calculated based on the entered times and vice versa.</p><p>To have the <a class="indexterm" id="id222"/>most flexible solution possible, we will create a new table with allowed starting and ending times. This table will have two fields: <span class="strong"><strong>Reservation Time</strong></span> and <span class="strong"><strong>Duration</strong></span>.</p><p>The <span class="strong"><strong>Duration</strong></span> field will be a decimal field that we will promote to a <span class="strong"><strong>SumIndexField</strong></span>. This will enable us to use SIFT to calculate the quantity.</p><div class="mediaobject"><img alt="Time calculation" src="graphics/0365EN_02_32.jpg"/></div><p>When<a class="indexterm" id="id223"/> populated the table will look like this:</p><div class="mediaobject"><img alt="Time calculation" src="graphics/0365EN_02_33.jpg"/></div><p>The time fields in the squash journal table will now get a table relation with this table. This prevents<a class="indexterm" id="id224"/> a user entering values that are not in the table, thus entering only valid starting and ending times. This is all done without any C/AL code and is flexible when times change later.</p><div class="mediaobject"><img alt="Time calculation" src="graphics/0365EN_02_34.jpg"/></div><p>Now, we <a class="indexterm" id="id225"/>need some code that calculates the quantity based on the input:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>From Time - OnValidate()</strong></span>
CalcQty;

<span class="strong"><strong>To Time - OnValidate()</strong></span>
CalcQty;

<span class="strong"><strong>CalcQty()</strong></span>
IF ("From Time" &lt;&gt; 0T) AND ("To Time" &lt;&gt; 0T) THEN BEGIN
  IF "To Time" &lt;= "From Time" THEN
    FIELDERROR("To Time");
  ResTime.SETRANGE("Reservation Time", "From Time", 
    "To Time");
  ResTime.FIND('+');
  ResTime.NEXT(-1);
  ResTime.SETRANGE("Reservation Time", "From Time", 
    ResTime."Reservation Time");
  ResTime.CALCSUMS(Duration);
  VALIDATE(Quantity, ResTime.Duration);
END;</pre></div><p>When a <a class="indexterm" id="id226"/>user enters a value in the <span class="strong"><strong>From Time</strong></span> or <span class="strong"><strong>To Time</strong></span> fields, the <code class="literal">CalcQty</code> function is executed. This checks if both fields have a value and then checks whether <span class="strong"><strong>To Time</strong></span> is larger than <span class="strong"><strong>From Time</strong></span>.</p><p>Then we place a filter on the <span class="strong"><strong>Reservation Time</strong></span> table. Now, when a user makes a reservation from <code class="literal">8:00</code> to <code class="literal">9:00</code>, there are three records in the filter making the result of the <code class="literal">Calcsums</code> (total of all records) of duration <code class="literal">1,5</code>. Therefore, we find the previous reservation time and use that.</p><p>This example shows how easy it is to use the built-in Microsoft Dynamics NAV functionality such<a class="indexterm" id="id227"/> as table relations and <code class="literal">Calcsums</code> instead of complex time calculations, which we could have also used.</p></div><div class="section" title="Price calculation"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec44"/>Price calculation</h2></div></div></div><p>As<a class="indexterm" id="id228"/> discussed in <a class="link" href="ch01.html" title="Chapter 1. Introduction to Microsoft Dynamics NAV">Chapter 1</a>, <span class="emphasis"><em>Introduction to Microsoft Dynamics NAV</em></span>, there is a special technique to determine prices. Prices <a class="indexterm" id="id229"/>are stored in a table with all possible parameters as fields and by filtering down on these fields, the best price is determined. If required, extra logic is need to find the lowest (or highest) price, if more prices are found.</p><p>To look, learn, and love this part of the standard application, we have used table Sales Price (7002) and codeunit Sales Price Calc. Mgt. (7000), even though we only need a small part of this functionality. This mechanism of price calculation is used throughout the application and offers a normalized way of calculating sales prices. A similar construction is used for purchase prices with the table Purchase Price (7012) and codeunit Purch. Price Calc. Mgt. (7010).</p><div class="section" title="Squash prices"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec08"/>Squash prices</h3></div></div></div><p>In our case, we <a class="indexterm" id="id230"/>have already determined that we have a special rate for members, but let's say we have also a special rate for daytime and evening in winter and summer.</p><p>This could make our table look as follows:</p><div class="mediaobject"><img alt="Squash prices" src="graphics/0365EN_02_35.jpg"/></div><p>We can make special prices for members on dates for winter and summer and make a price valid only until a certain time. We can also make a special price for a court.</p><p>This table could be creatively expanded with all kinds of codes until we end up with table Sales Price (7002) in the standard product, which was the template for our example.</p></div><div class="section" title="Price Calc Mgt. codeunit"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec09"/>Price Calc Mgt. codeunit</h3></div></div></div><p>To <a class="indexterm" id="id231"/>calculate the price, we need a codeunit similar to the standard product. This codeunit is called with a squash journal line record and stores all valid prices in a buffer table and then finds the lowest price if there is any overlap:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>FindSquashPrice()</strong></span>
WITH FromSquashPrice DO BEGIN
  SETFILTER("Ending Date",'%1|&gt;=%2',0D,StartingDate);
  SETRANGE("Starting Date",0D,StartingDate);

  ToSquashPrice.RESET;
  ToSquashPrice.DELETEALL;

  SETRANGE(Member, IsMember);

  SETRANGE("Ending Time", 0T);
  SETRANGE("Squash Court No.", '');
  CopySquashPriceToSquashPrice(FromSquashPrice,ToSquashPrice);

  SETRANGE("Ending Time", 0T);
  SETRANGE("Squash Court No.", CourtNo);
  CopySquashPriceToSquashPrice(FromSquashPrice,ToSquashPrice);

  SETRANGE("Squash Court No.", '');
  IF StartingTime &lt;&gt; 0T THEN BEGIN
    SETFILTER("Ending Time",'%1|&gt;=%2',000001T,StartingTime);
    CopySquashPriceToSquashPrice(FromSquashPrice,
      ToSquashPrice);
  END;

  SETRANGE("Squash Court No.", CourtNo);
  IF StartingTime &lt;&gt; 0T THEN BEGIN
    SETFILTER("Ending Time",'%1|&gt;=%2',000001T,StartingTime);
    CopySquashPriceToSquashPrice(FromSquashPrice,
      ToSquashPrice);
  END;
END;</pre></div><p>If there is no price in the filter, it uses the unit price from the squash court, as shown here:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CalcBestUnitPrice()</strong></span>
WITH SquashPrice DO BEGIN
  FoundSquashPrice := FINDSET;
  IF FoundSquashPrice THEN BEGIN
    BestSquashPrice := SquashPrice;
    REPEAT
      IF SquashPrice."Unit Price" &lt; 
        BestSquashPrice."Unit Price" 
      THEN
        BestSquashPrice := SquashPrice;
    UNTIL NEXT = 0;
  END;
END;

// No price found in agreement
IF BestSquashPrice."Unit Price" = 0 THEN
  BestSquashPrice."Unit Price" := SquashCourt."Unit Price";

SquashPrice := BestSquashPrice;</pre></div></div><div class="section" title="Inherited data"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec10"/>Inherited data</h3></div></div></div><p>To use the <a class="indexterm" id="id232"/>journal for the product part of the application, we want to inherit some of the fields from the master data tables. In order to make that possible, we need to copy and paste these fields from other tables to our master data table and populate it.</p><p>In our example, we can copy and paste the fields from the Resource table (156). We also need to add code to the <code class="literal">OnValidate</code> triggers in the journal line table.</p><div class="mediaobject"><img alt="Inherited data" src="graphics/0365EN_02_36.jpg"/></div><p>The squash court table, for example, is expanded with the fields <span class="strong"><strong>Unit Code</strong></span>, <span class="strong"><strong>Unit Price</strong></span>, <span class="strong"><strong>Gen. Prod. Posting Group</strong></span>, and <span class="strong"><strong>VAT Prod. Posting Group</strong></span>, as shown in the preceding screenshot.</p><p>We can now<a class="indexterm" id="id233"/> add code to the <code class="literal">OnValidate</code> of the <code class="literal">Squash Court No.</code> field in the Journal Line table.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Squash Court No. - OnValidate()</strong></span>
IF SquashCourt.GET("Squash Court No.") THEN BEGIN
  Description := SquashCourt.Description;
  "Unit Cost" := SquashCourt."Unit Cost";
  "Gen. Prod. Posting Group" := SquashCourt."Gen. Prod. Posting Group";
  FindSquashPlayerPrice;
END;</pre></div><p>Please note that unit price is used in the Squash Price Calc. Mgt. codeunit that is executed from the <code class="literal">FindSquashPlayerPrice</code> function.</p></div></div><div class="section" title="Dimensions"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec45"/>Dimensions</h2></div></div></div><p>In Microsoft Dynamics NAV, dimensions <a class="indexterm" id="id234"/>are defined in master data and posted to the ledger entries to be used in analysis view <a class="indexterm" id="id235"/>entries. In <a class="link" href="ch03.html" title="Chapter 3. Financial Management">Chapter 3</a>, <span class="emphasis"><em>Financial Management</em></span>, we will discuss how to analyze the data generated by dimensions. In between that journey they move around a lot in different tables as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Table 348 | Dimension</strong></span>: This is where the main dimension codes are defined.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Table 349 | Dimension Value</strong></span>: This is where each dimension can have an unlimited number of values.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Table 350 | Dimension Combination</strong></span>: In this table, we can block certain combinations of dimension codes.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Table 351 | Dimension Value Combination</strong></span>: In this table, we can block certain combinations of dimension values. If this table is populated, the value <code class="literal">Limited</code> is populated in the dimension combination table for these dimensions.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Table 352 | Default Dimension</strong></span>: This table is populated for all master data that has dimensions defined.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Table 354 | Default Dimension Priority</strong></span>: When more than one master data record in one transaction have the same dimensions, it is possible here to set priorities.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Table 480 | Dimension Set Entry</strong></span>: This table contains a matrix of all used dimension combinations.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Codeunit 408 | Dimension Management</strong></span>: This codeunit is the single point in the application where all dimension movement is done.</li></ul></div><p>In our application, dimensions <a class="indexterm" id="id236"/>are moved from the squash player, squash court, and customer table via the squash journal line to the squash ledger entries. When we create an invoice, we move the dimensions from the ledger entries to the sales line table.</p><div class="section" title="Master data"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec11"/>Master data</h3></div></div></div><p>To <a class="indexterm" id="id237"/>connect dimensions to master data, we first need to allow this changing codeunit 408 dimension management.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>SetupObjectNoList()</strong></span>
TableIDArray[1] := DATABASE::"Salesperson/Purchaser";
TableIDArray[2] := DATABASE::"G/L Account";
TableIDArray[3] := DATABASE::Customer;
...
TableIDArray[22] := DATABASE::"Service Item Group";
TableIDArray[23] := DATABASE::"Service Item";

//* Squash Application
TableIDArray[49] := DATABASE::"Squash Player";
TableIDArray[50] := DATABASE::"Squash Court";
//* Squash Application

Object.SETRANGE(Type,Object.Type::Table);

FOR Index := 1 TO ARRAYLEN(TableIDArray) DO BEGIN
  ...</pre></div><p>The <code class="literal">TableIDArray</code> variable has a default number of 23 dimensions. This we have changed to <code class="literal">50</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip12"/>Tip</h3><p>By leaving gaps we allow Microsoft to add master data tables in future without us having to change our code.</p></div></div><p>Without this change, the system would return the following error message when we try to use dimensions:</p><div class="mediaobject"><img alt="Master data" src="graphics/0365EN_02_37.jpg"/></div><p>Next change is to add the <span class="strong"><strong>Global Dimension</strong></span> fields to the master data tables. They can be copied and pasted from other master data tables.</p><div class="mediaobject"><img alt="Master data" src="graphics/0365EN_02_38.jpg"/></div><p>When these <a class="indexterm" id="id238"/>fields are validated, the <code class="literal">ValidateShortcutDimCode</code> function is executed as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ValidateShortcutDimCode()</strong></span>
DimMgt.ValidateDimValueCode(FieldNumber,ShortcutDimCode);
DimMgt.SaveDefaultDim(DATABASE::"Squash Player","No.",
  FieldNumber,ShortcutDimCode);
MODIFY;</pre></div></div><div class="section" title="Journal"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec12"/>Journal</h3></div></div></div><p>When we use the<a class="indexterm" id="id239"/> master data records in the journal table, the dimensions are copied from the default dimension table to the dimension set entry table. This is done using the folowing piece of code that is called from <code class="literal">OnValidate</code> of each master data reference field:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CreateDim()</strong></span>
TableID[1] := Type1;
No[1] := No1;
TableID[2] := Type2;
No[2] := No2;
TableID[3] := Type3;
No[3] := No3;

"Shortcut Dimension 1 Code" := '';
"Shortcut Dimension 2 Code" := '';

"Dimension Set ID" :=
  DimMgt.GetDefaultDimID(TableID,No,"Source Code",
    "Shortcut Dimension 1 Code",
      "Shortcut Dimension 2 Code",0,0);</pre></div><p>To decide which dimensions to inherit, we should first analyze which master data is used in our Journal that is using default dimensions.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Squash Court No. - OnValidate()</strong></span>
CreateDim(
  DATABASE::"Squash Court","Squash Court No.",
  DATABASE::"Squash Player","Squash Player No.",
  DATABASE::Customer,"Bill-to Customer No.");</pre></div><p>In our <a class="indexterm" id="id240"/>case, <code class="literal">Table[1]</code> is <code class="literal">Squash Player</code>, <code class="literal">Table[2]</code> is <code class="literal">Squash Court</code>, and <code class="literal">Table[3]</code> is <code class="literal">Customer</code>. The dimension management codeunit makes sure everything is copied. We can use standard Microsoft Dynamics NAV functions.</p><div class="section" title="Posting"><div class="titlepage"><div><div><h4 class="title"><a id="ch02lvl4sec01"/>Posting</h4></div></div></div><p>When we <a class="indexterm" id="id241"/>post a journal using <code class="literal">Codeunit Squash Jnl.-Post Line (123456703)</code>, the dimensions are copied using the dimension set ID as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Code()</strong></span>

...
SquashLedgEntry."Dimension Set ID" := "Dimension Set ID";
...

SquashLedgEntry.INSERT;

NextEntryNo := NextEntryNo + 1;</pre></div><p>This field is also used from our combine invoicing report, which we will create later in this chapter in the <span class="strong"><strong>Invoicing</strong></span> section.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CreateLn()</strong></span>
...
SalesLn.INIT;

SalesLn."Dimension Set ID" := "Dimension Set ID";

SalesLn.INSERT(TRUE);</pre></div></div></div></div></div>
<div class="section" title="The posting process"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec28"/>The posting process</h1></div></div></div><p>Our<a class="indexterm" id="id242"/> journal is<a class="indexterm" id="id243"/> now ready to be posted. We've implemented all business logic, except the posting code.</p><div class="mediaobject"><img alt="The posting process" src="graphics/0365EN_02_39.jpg"/></div><p>The posting process of a journal in <a class="indexterm" id="id244"/>Microsoft Dynamics NAV has several codeunits for the structure:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Jnl.-Check Line</code>: This <a class="indexterm" id="id245"/>codeunit checks if the journal line is valid for posting.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Jnl.-Post Line</code>: This<a class="indexterm" id="id246"/> codeunit does the actual creation of the ledger entry and register tables and calls other <code class="literal">Jnl.-Post Line</code> codeunits if necessary to provide the transaction structure in <a class="link" href="ch01.html" title="Chapter 1. Introduction to Microsoft Dynamics NAV">Chapter 1</a>, <span class="emphasis"><em>Introduction to Microsoft Dynamics NAV</em></span>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Jnl.-Post Batch</code>: This<a class="indexterm" id="id247"/> codeunit loops though all journal lines in a journal batch and posts all the lines.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Jnl.-Post</code>: This is<a class="indexterm" id="id248"/> the codeunit that is called from the page. It calls the <code class="literal">Jnl.-Post Batch</code> codeunit and takes care of some user messaging.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Jnl.-Post+Print</code>: This <a class="indexterm" id="id249"/>is the codeunit that is called when you click on <span class="strong"><strong>Post + Print</strong></span>. It does the same as the <code class="literal">Jnl.-Post</code> codeunit but with the additional printing of a report defined in the journal template.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Jnl.-B.Post</code>: This <a class="indexterm" id="id250"/>posts all the journal lines that have no errors and marks the ones that have errors.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Jnl.-B.Post+Print</code>: This<a class="indexterm" id="id251"/> does the same as <code class="literal">Jnl.-B.Post</code> but with the additional printing of a report defined in the journal template.</li></ul></div><div class="section" title="Check line"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec46"/>Check line</h2></div></div></div><p>Let's have a look at the<a class="indexterm" id="id252"/> check line codeunit. When it comes to testing, Microsoft Dynamics NAV has a simple rule:</p><p>
<span class="emphasis"><em>Test near, Test far, Do it, Clean up</em></span>
</p><p>First, we need to test the field in the journal line table, then read external data tables to check if all is good, and then post the lines and delete the data from the journal table.</p><p>It does not make sense to read the G/L setup table from the database if the document no. in our own table is <a class="indexterm" id="id253"/>blank, or to start the posting process and error out because the posting date is outside of a valid range. This would cause a lot of unnecessary I/O from the database to the client.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>RunCheck()</strong></span>
WITH SquashJnlLine DO BEGIN
  IF EmptyLine THEN
    EXIT;

  TESTFIELD("Squash Player No.");
  TESTFIELD("Squash Court No.");
  TESTFIELD("Posting Date");
  TESTFIELD("Gen. Prod. Posting Group");
  TESTFIELD("From Time");
  TESTFIELD("To Time");
  TESTFIELD("Reservation Date");
  TESTFIELD("Bill-to Customer No.");

  IF "Entry Type" = "Entry Type"::Invoice THEN
    TESTFIELD("Applies-to Entry No.");

  IF "Applies-to Entry No." &lt;&gt; 0 THEN
    TESTFIELD("Entry Type", "Entry Type"::Invoice);
  IF "Posting Date" &lt;&gt; NORMALDATE("Posting Date") THEN
    FIELDERROR("Posting Date",Text000);

  IF (AllowPostingFrom = 0D) AND (AllowPostingTo = 0D) THEN 
    ...  
  END;

  ...

  IF NOT DimMgt.CheckDimIDComb("Dimension Set ID") THEN
    ...
  TableID[1] := DATABASE::"Squash Player";
  No[1] := "Squash Player No.";
  ...
  IF NOT DimMgt.CheckJnlLineDimValuePosting(JnlLineDim,
    TableID,No) 
  THEN
    IF "Line No." &lt;&gt; 0 THEN
      ..................</pre></div><p>In the preceding code, we can clearly see that fields in our table are checked first, and then the date <a class="indexterm" id="id254"/>validation, and lastly the dimension checking.</p></div><div class="section" title="Post line"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec47"/>Post line</h2></div></div></div><p>The actual <a class="indexterm" id="id255"/>posting code turns out to be quite simple. The values are checked and then a register is created or updated.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Code()</strong></span>
WITH SquashJnlLine DO BEGIN
  IF EmptyLine THEN
    EXIT;

  SquashJnlCheckLine.RunCheck(SquashJnlLine,TempJnlLineDim);

  IF NextEntryNo = 0 THEN BEGIN
    SquashLedgEntry.LOCKTABLE;
    IF SquashLedgEntry.FIND('+') THEN
      NextEntryNo := SquashLedgEntry."Entry No.";
    NextEntryNo := NextEntryNo + 1;
  END;

  IF SquashReg."No." = 0 THEN BEGIN
    SquashReg.LOCKTABLE;
    IF (NOT SquashReg.FIND('+') OR ... THEN BEGIN
      SquashReg.INIT;
      SquashReg."No." := SquashReg."No." + 1;
      ...
      SquashReg.INSERT;
    END;
  END;
  SquashReg."To Entry No." := NextEntryNo;
  SquashReg.MODIFY;

  SquashPlayer.GET("Squash Player No.");
  SquashPlayer.TESTFIELD(Blocked,FALSE);

  IF (GenPostingSetup."Gen. Bus. Posting Group" &lt;&gt; 
    "Gen. Bus. Posting Group") OR
    (GenPostingSetup."Gen. Prod. Posting Group" &lt;&gt; 
    "Gen. Prod. Posting Group")
  THEN
    GenPostingSetup.GET("Gen. Bus. Posting Group",
      "Gen. Prod. Posting Group");

  SquashLedgEntry.INIT;
  SquashLedgEntry."Entry Type" := "Entry Type";
  SquashLedgEntry."Document No." := "Document No.";
  ...
  SquashLedgEntry."No. Series" := "Posting No. Series";

  SquashLedgEntry.INSERT;</pre></div><p>All the fields <a class="indexterm" id="id256"/>are simply moved to the ledger entry table. This is what makes Microsoft Dynamics NAV simple and powerful.</p><p>Here, we can clearly see how easy it is to add a field to a posting process. Just add the fields to the journal line, the ledger entry, and add one line of code to the posting process.</p></div></div>
<div class="section" title="Invoicing"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec29"/>Invoicing</h1></div></div></div><p>The last<a class="indexterm" id="id257"/> issue on our to-do list <a class="indexterm" id="id258"/>is the invoicing process. For this, we use a part of the standard application.</p><p>As explained in <a class="link" href="ch01.html" title="Chapter 1. Introduction to Microsoft Dynamics NAV">Chapter 1</a>, <span class="emphasis"><em>Introduction to Microsoft Dynamics NAV</em></span>, invoicing is done using a document structure with a header and a line table. This has a posting routine that will start the journal transactions.</p><p>For our application, we need to create the invoice document and make sure that when posted, it updates our sub administration.</p><div class="section" title="Invoice document"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec48"/>Invoice document</h2></div></div></div><p>The sales<a class="indexterm" id="id259"/> invoice documents in Microsoft Dynamics NAV are stored in the Sales Header (36) and Sales Line (37) tables. We <a class="indexterm" id="id260"/>will create a report that will combine the outstanding reservation entries into invoices allowing the user to filter on a specific entry or any other field value in the squash ledger entry table.</p><p>Reports in Microsoft Dynamics NAV are not just for printing documents; we can also use its dataset capabilities to start batch jobs.</p><p>To enable this, our batch job needs to have a special property, <code class="literal">ProcessingOnly</code>, so let's start a blank report and do this.</p><div class="mediaobject"><img alt="Invoice document" src="graphics/0365EN_02_40.jpg"/></div><p>The report<a class="indexterm" id="id261"/> will browse through the squash<a class="indexterm" id="id262"/> ledger entries filtered on entry type<span class="strong"><strong> Reservation</strong></span> and open <span class="strong"><strong>Yes</strong></span>. The sorting is <span class="strong"><strong>Open</strong></span>, <span class="strong"><strong>Entry Type</strong></span>, <span class="strong"><strong>Bill-to Customer No.</strong></span>, and <span class="strong"><strong>Reservation Date</strong></span>. To use sorting, the fields must be defined together as a key in the table definition.</p><div class="mediaobject"><img alt="Invoice document" src="graphics/0365EN_02_41.jpg"/></div><p>As <span class="strong"><strong>Bill-to Customer No.</strong></span> is the first non-filtered value in the sorting, we can assume that if this value changes, we need a new sales header.</p><p>For every squash ledger entry, we will generate a sales line as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Squash Ledger Entry - OnAfterGetRecord()</strong></span>
IF "Bill-to Customer No." &lt;&gt; SalesHdr."Bill-to Customer No." 
THEN
  CreateSalesHdr;

CreateLn;</pre></div><div class="section" title="Sales header"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec13"/>Sales header</h3></div></div></div><p>The code to <a class="indexterm" id="id263"/>create a sales header is as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CreateSalesHdr()</strong></span>
CLEAR(SalesHdr);
SalesHdr.SetHideValidationDialog(TRUE);
SalesHdr."Document Type" := SalesHdr."Document Type"::Invoice;
SalesHdr."Document Date" := WORKDATE;
SalesHdr."Posting Date" := WORKDATE;
SalesHdr.VALIDATE("Sell-to Customer No.", 
  "Squash Ledger Entry"."Bill-to Customer No.");
SalesHdr.INSERT(TRUE);

NextLineNo := 10000;
CounterOK := CounterOK + 1;</pre></div><p>The <code class="literal">SetHideValidationDialog</code> function<a class="indexterm" id="id264"/> makes sure we don't get pop-up messages while validating values. This is a standard function in Microsoft Dynamics NAV, which is designed for this purpose.</p><p>The <code class="literal">TRUE</code> parameter to the <code class="literal">INSERT</code> statement makes sure that the Number Series are triggered.</p></div><div class="section" title="Sales line"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec14"/>Sales line</h3></div></div></div><p>To create a<a class="indexterm" id="id265"/> sales line, we need a minimum of the following code. Please note that we added the field <code class="literal">Applies-to Squash Entry No.</code> to the sales line table.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CreateLn()</strong></span>
WITH "Squash Ledger Entry" DO BEGIN
  GenPstSetup.GET("Gen. Bus. Posting Group", 
    "Gen. Prod. Posting Group");
  GenPstSetup.TESTFIELD("Sales Account");

  SalesLn.INIT;
  SalesLn."Document Type" := SalesHdr."Document Type";
  SalesLn."Document No." := SalesHdr."No.";
  SalesLn."Line No." := NextLineNo;
  SalesLn."Dimension Set ID" := "Dimension Set ID";
  
  SalesLn."System-Created Entry" := TRUE;

  SalesLn.Type := SalesLn.Type::"G/L Account";
  SalesLn.VALIDATE("No.", GenPstSetup."Sales Account");
  SalesLn.Description := Description;

  SalesLn.VALIDATE(Quantity, Quantity);
  SalesLn.VALIDATE("Unit Price", "Unit Price");
  SalesLn.VALIDATE("Unit Cost (LCY)", "Unit Cost");

  SalesLn."Applies-to Squash Entry No." := "Entry No.";
  SalesLn.INSERT(TRUE);

END;
NextLineNo := NextLineNo + 10000;</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>When you add fields to the sales and purchase document tables, make sure to also add these to the posted equivalents of these tables with the same number. This way you make sure that the information is copied to the historic data. This is done using the <code class="literal">TRANSFERFIELDS</code> command. We will discuss these tables in <a class="link" href="ch06.html" title="Chapter 6. Trade">Chapter 6</a>, <span class="emphasis"><em>Trade</em></span>.</p></div></div></div><div class="section" title="Dialog"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec15"/>Dialog</h3></div></div></div><p>If the<a class="indexterm" id="id266"/> combined invoicing takes some time, it might be good to show the user a process bar. For this, Microsoft Dynamics NAV has a standard structure.</p><p>The window shows the bill-to customer no. it is currently processing and a bar going from 1 percent to 100 percent. This is calculated by keeping a counter.</p><p>At the end of the process, we show a message telling the user how many invoices were created out of the number of squash ledger entries.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Squash Ledger Entry - OnPreDataItem()</strong></span>
CounterTotal := COUNT;
Window.OPEN(Text000);

<span class="strong"><strong>Squash Ledger Entry - OnAfterGetRecord()</strong></span>
Counter := Counter + 1;
Window.UPDATE(1,"Bill-to Customer No.");
Window.UPDATE(2,ROUND(Counter / CounterTotal * 10000,1));

...

<span class="strong"><strong>Squash Ledger Entry - OnPostDataItem()</strong></span>
Window.CLOSE;
MESSAGE(Text001,CounterOK,CounterTotal);</pre></div><p>To do this, we need<a class="indexterm" id="id267"/> some variables. The <span class="strong"><strong>Window</strong></span> variable is of type <span class="strong"><strong>Dialog</strong></span> whilst <span class="strong"><strong>Counter</strong></span>, <span class="strong"><strong>CounterTotal</strong></span>, and <span class="strong"><strong>CounterOK</strong></span> are integers, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Dialog" src="graphics/0365EN_02_42.jpg"/></div><p>The constant <span class="strong"><strong>Text000</strong></span> has the special values <span class="strong"><strong>#1##########</strong></span> and <span class="strong"><strong>@2@@@@@@@@@@@@@</strong></span>. The first allows us to show and update some text; the latter is used to create the process bar.</p><div class="mediaobject"><img alt="Dialog" src="graphics/0365EN_02_43.jpg"/></div><p>The result will look like what is shown in the following screenshot:</p><div class="mediaobject"><img alt="Dialog" src="graphics/0365EN_02_45.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>There is a best practice document about using progress bars in combination with the impact on performance at <a class="ulink" href="http://www.mibuso.com/howtoinfo.asp?FileID=17">http://www.mibuso.com/howtoinfo.asp?FileID=17</a>.</p></div></div></div></div><div class="section" title="Posting process"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec49"/>Posting process</h2></div></div></div><p>Now, our Sales Invoice<a class="indexterm" id="id268"/> is ready so we can start making the necessary <a class="indexterm" id="id269"/>changes to the posting process. Posting a sales document is done using a single posting codeunit and some helper objects.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Report 297</strong></span>: This report can be used to post more than one document at the same time with a filter.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Codeunit 80</strong></span>: This is the actual posting routine we are going to change.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Codeunit 81</strong></span>: This codeunit is called from the user interface and has a dialog if the user wants to ship, invoice, or both if the document is an order and a yes/no if the document is an invoice or credit memo.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Codeunit 82</strong></span>: When the user chooses post and print, this codeunit is executed, which does the same as <span class="strong"><strong>Codeunit 81</strong></span> plus printing a report.</li></ul></div><p>So we will make a change to <span class="strong"><strong>Codeunit 80</strong></span>. This codeunit has a specific structure that we need to understand before we go in and make the change.</p><div class="section" title="Analyze the object"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec16"/>Analyze the object</h3></div></div></div><p>The <a class="indexterm" id="id270"/>codeunit also has the <span class="emphasis"><em>Test Near</em></span>, <span class="emphasis"><em>Test Far</em></span>, <span class="emphasis"><em>Do it</em></span>, and <span class="emphasis"><em>Clean up</em></span> strategy so the first step is to make sure everything is in place before the actual posting starts. Let's have a look at how this codeunit is structured.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note03"/>Note</h3><p>The Sales-Post codeunit is too long to discuss in detail. We will focus on the most important parts and learning how to read this type of code routine.</p></div></div><p>This first part does the test near step and a part of the test far step. The <code class="literal">Ship</code>, <code class="literal">Invoice</code>, and <code class="literal">Receive</code> fields are set in codeunit 81 and 82 but checked and completed to make sure.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Code()</strong></span>
...
WITH SalesHeader DO BEGIN
  TESTFIELD("Document Type");
  TESTFIELD("Sell-to Customer No.");
  TESTFIELD("Bill-to Customer No.");
  TESTFIELD("Posting Date");
  TESTFIELD("Document Date");
  IF GenJnlCheckLine.DateNotAllowed("Posting Date") THEN
    FIELDERROR("Posting Date",Text045);
  CASE "Document Type" OF
    "Document Type"::Order:
      Receive := FALSE;
    "Document Type"::Invoice:
      BEGIN
        Ship := TRUE;
        Invoice := TRUE;
        Receive := FALSE;
      END;
    "Document Type"::"Return Order":
      Ship := FALSE;
    "Document Type"::"Credit Memo":
      BEGIN
        Ship := FALSE;
        Invoice := TRUE;
        Receive := TRUE;
      END;
  END;

  IF NOT (Ship OR Invoice OR Receive) THEN
    ERROR(...);

  WhseReference := "Posting from Whse. Ref.";
  "Posting from Whse. Ref." := 0;

  IF Invoice THEN
    CreatePrepaymentLines(...);
  CheckDim;</pre></div><p>The next step is <a class="indexterm" id="id271"/>moving the sales header information to the history tables for shipment, invoice, credit memo, or return receipt header. These sections are commented like this:</p><div class="informalexample"><pre class="programlisting">  // Insert invoice header or credit memo header
  IF Invoice THEN
    IF "Document Type" IN ["Document Type"::Order,
      "Document Type"::Invoice] 
    THEN BEGIN
      SalesInvHeader.INIT;
      SalesInvHeader.TRANSFERFIELDS(SalesHeader);</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>We will discuss the relation between a sales header and the sales shipment, sales invoice, sales credit memo, and return receipt in <a class="link" href="ch06.html" title="Chapter 6. Trade">Chapter 6</a>, <span class="emphasis"><em>Trade</em></span>.</p></div></div><p>When this is <a class="indexterm" id="id272"/>done, the sales lines are processed. They are also moved to the various posted line tables. This is all part of the <span class="emphasis"><em>Do it</em></span> section of the posting routine.</p><div class="informalexample"><pre class="programlisting">  // Lines
  InvPostingBuffer[1].DELETEALL;
  DropShipPostBuffer.DELETEALL;
  EverythingInvoiced := TRUE;

  SalesLine.RESET;
  SalesLine.SETRANGE("Document Type","Document Type");
  SalesLine.SETRANGE("Document No.","No.");
  LineCount := 0;
  RoundingLineInserted := FALSE;
  MergeSaleslines(...);</pre></div><p>If there is a drop shipment in a purchase order, this is handled here. We will discuss drop shipments in <a class="link" href="ch06.html" title="Chapter 6. Trade">Chapter 6</a>, <span class="emphasis"><em>Trade</em></span>.</p><div class="informalexample"><pre class="programlisting">  // Post drop shipment of purchase order
  PurchSetup.GET;
  IF DropShipPostBuffer.FIND('-') THEN
    REPEAT
      PurchOrderHeader.GET(
        PurchOrderHeader."Document Type"::Order,
        DropShipPostBuffer."Order No.");</pre></div><p>Then there is a section that creates the financial information in the general journal. We will go deeper into this section in <a class="link" href="ch03.html" title="Chapter 3. Financial Management">Chapter 3</a>, <span class="emphasis"><em>Financial Management</em></span>.</p><div class="informalexample"><pre class="programlisting">  IF Invoice THEN BEGIN
    // Post sales and VAT to G/L entries from posting buffer
    LineCount := 0;
    IF InvPostingBuffer[1].FIND('+') THEN
      REPEAT
        LineCount := LineCount + 1;
        Window.UPDATE(3,LineCount);

        GenJnlLine.INIT;
        GenJnlLine."Posting Date" := "Posting Date";
        GenJnlLine."Document Date" := "Document Date";</pre></div><p>Then the <span class="emphasis"><em>Clean up</em></span> section starts by calculating remaining quantities, VAT, and deleting the sales header and sales lines if possible.</p><div class="informalexample"><pre class="programlisting">IF ("Document Type" IN ["Document Type"::Order,
  "Document Type"::"Return Order"]) AND
   (NOT EverythingInvoiced)
THEN BEGIN
  MODIFY;
  // Insert T336 records
  InsertTrackingSpecification;

  IF SalesLine.FINDSET THEN
    REPEAT
      IF SalesLine.Quantity &lt;&gt; 0 THEN BEGIN
        IF Ship THEN BEGIN
          SalesLine."Quantity Shipped" :=
            SalesLine."Quantity Shipped" +
            SalesLine."Qty. to Ship";
          SalesLine."Qty. Shipped (Base)" :=
            SalesLine."Qty. Shipped (Base)" +
            SalesLine."Qty. to Ship (Base)";
        END;</pre></div><p>The <span class="emphasis"><em>Clean up</em></span> section<a class="indexterm" id="id273"/> ends by deleting the sales document and related information and clearing the variables used.</p><div class="informalexample"><pre class="programlisting">IF HASLINKS THEN DELETELINKS;
DELETE;
...

SalesLine.DELETEALL;
DeleteItemChargeAssgnt;
...

CLEAR(WhsePostRcpt);
CLEAR(WhsePostShpt);
...
CLEAR(WhseJnlPostLine);
CLEAR(InvtAdjmt);
Window.CLOSE;</pre></div></div><div class="section" title="Making the change"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec17"/>Making the change</h3></div></div></div><p>The change <a class="indexterm" id="id274"/>we are going to make is in the section where the lines are handled:</p><div class="informalexample"><pre class="programlisting">// Squash Journal Line
IF SalesLine."Applies-to Squash Entry No." &lt;&gt; 0 THEN
  PostSquashJnlLn;

IF (SalesLine.Type &gt;= SalesLine.Type::"G/L Account") AND 
  (SalesLine."Qty. to Invoice" &lt;&gt; 0) 
THEN BEGIN
  // Copy sales to buffer</pre></div><p>We will <a class="indexterm" id="id275"/>create a new function, <code class="literal">PostSquashJnlLn</code>. This way we minimize the impact on standard code and when we upgrade to a newer version, we can easily copy and paste our function and only need to change the calling place if required.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip14"/>Tip</h3><p>Always try to design for easy upgrading whenever possible. Remember that Microsoft might change this code in newer versions so the more flexible we are and the more we manage to minimize the impact on standard code, the better.</p></div></div><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>PostSquashJnlLn()</strong></span>
WITH SalesHeader DO BEGIN
  OldSquashLedEnt.GET(
    SalesLine."Applies-to Squash Entry No.");
  OldSquashLedEnt.TESTFIELD(Open);
  OldSquashLedEnt.TESTFIELD("Bill-to Customer No.", 
    "Bill-to Customer No.");

  SquashJnlLn.INIT;
  SquashJnlLn."Posting Date" := "Posting Date";
  SquashJnlLn."Reason Code" := "Reason Code";
  ...
  SquashJnlLn."Document No." := GenJnlLineDocNo;
  SquashJnlLn."External Document No." := GenJnlLineExtDocNo;
  SquashJnlLn.Quantity := -SalesLine."Qty. to Invoice";
  SquashJnlLn."Source Code" := SrcCode;
  SquashJnlLn."Dimension Set ID" := 
    SalesLine."Dimension Set ID";
  SquashJnlLn.Chargeable := TRUE;
  SquashJnlLn."Posting No. Series" := "Posting No. Series";
  SquashJnlPostLine.RunWithCheck(SquashJnlLn);
END;</pre></div><p>Our new function first gets the squash ledger entry it applies to and tests if it's still open and the bill-to customer no. has not changed. Then, we populate the squash journal line with the help of the sales line and the old squash ledger entry. Then dimensions are handled and the squash journal line is posted.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip15"/>Tip</h3><p>The journal lines are never actually inserted into the database. This is for performance and concurrency reasons. All journal transactions here are handled in the service tier cache. A journal is also never populated using <code class="literal">Validate</code>. This makes it very clear for you to see what happens.</p></div></div><p>Now when<a class="indexterm" id="id276"/> we post an invoice, we can see that the invoice entries are created:</p><div class="mediaobject"><img alt="Making the change" src="graphics/0365EN_02_46.jpg"/></div></div></div></div>
<div class="section" title="Navigate"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec30"/>Navigate</h1></div></div></div><p>We have <a class="indexterm" id="id277"/>now covered everything that is necessary for our <a class="indexterm" id="id278"/>squash court application to run but there is one special function of Microsoft Dynamics NAV that needs changing when we add new documents and ledger entries: the <code class="literal">Navigate</code> function.</p><p>The functionality was already discussed in <a class="link" href="ch01.html" title="Chapter 1. Introduction to Microsoft Dynamics NAV">Chapter 1</a>, <span class="emphasis"><em>Introduction to Microsoft Dynamics NAV</em></span>. The object is a single page (344) in the application that requires two changes.</p><div class="section" title="FindRecords"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec50"/>FindRecords</h2></div></div></div><p>The first<a class="indexterm" id="id279"/> function <a class="indexterm" id="id280"/>we change is <code class="literal">FindRecords</code>. This browses through the database finding all possible combinations of document no. and posting date.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>FindRecords()</strong></span>
...
// Squash Ledger Entries
IF SquashLedgEntry.READPERMISSION THEN BEGIN
  SquashLedgEntry.RESET;
  SquashLedgEntry.SETCURRENTKEY("Document No.",
    "Posting Date");
  SquashLedgEntry.SETFILTER("Document No.",DocNoFilter);
  SquashLedgEntry.SETFILTER("Posting Date",PostingDateFilter);
  InsertIntoDocEntry(
    DATABASE::"Squash Ledger Entry",0,
    SquashLedgEntry.TABLECAPTION,SquashLedgEntry.COUNT);
END;
// Squash Ledger Entries

DocExists := FINDFIRST;</pre></div><p>The function <a class="indexterm" id="id281"/>first checks if we have permission to read the squash ledger entry table. If our system administrator does not allow us to see this table, it should not show up.</p><p>The filtering is done on the document no. and posting date. When ready, the system inserts the number of found records in the result table.</p></div><div class="section" title="ShowRecords"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec51"/>ShowRecords</h2></div></div></div><p>The <a class="indexterm" id="id282"/>second function to change is<a class="indexterm" id="id283"/> <code class="literal">ShowRecords</code>. This makes sure we see the squash ledger entries when we click on the <span class="strong"><strong>Show</strong></span> action.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ShowRecords()</strong></span>
...
    DATABASE::"Warranty Ledger Entry":
      FORM.RUN(0,WarrantyLedgerEntry);
//* Squash Ledger Entries
    DATABASE::"Squash Ledger Entry":
      FORM.RUN(0,SquashLedgEntry);
   END;
END;</pre></div><div class="section" title="Testing"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec18"/>Testing</h3></div></div></div><p>Now when <a class="indexterm" id="id284"/>we navigate from an invoice we posted that was generated from our combine invoicing report, we get the following result:</p><div class="mediaobject"><img alt="Testing" src="graphics/0365EN_02_47.jpg"/></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec31"/>Summary</h1></div></div></div><p>In this chapter, we created our own vertical add-on application for Microsoft Dynamics NAV. We used similar data model and posting structures and reused parts of the standard application where appropriate but never wrongly used standard features.</p><p>We saw how to reverse engineer Microsoft Dynamics NAV code in order to find out what similar standard functionality to copy, paste, and change for our application.</p><p>We also found out how a journal and document posting code unit works and how to structure using <span class="emphasis"><em>Test near</em></span>, <span class="emphasis"><em>Test far</em></span>, <span class="emphasis"><em>Do it</em></span>, and <span class="emphasis"><em>Clean up</em></span>.</p><p>In the next chapter, we will explore the financial functionality of Microsoft Dynamics NAV and even make some changes to this part of the application.</p></div></body></html>