<html><head></head><body>
<div id="_idContainer115">
<h1 class="chapter-number" id="_idParaDest-110"><a id="_idTextAnchor513"/><span class="koboSpan" id="kobo.1.1">6</span></h1>
<h1 id="_idParaDest-111"><a id="_idTextAnchor514"/><span class="koboSpan" id="kobo.2.1">Building a Photo Gallery App Using CollectionView and CarouselView</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we will build an app that shows photos from the camera roll (photo gallery) of a user’s device. </span><span class="koboSpan" id="kobo.3.2">The user will also be able to select photos as favorites. </span><span class="koboSpan" id="kobo.3.3">We will then look at the different ways to display photos—in carousels and in multi-column grid control. </span><span class="koboSpan" id="kobo.3.4">By using the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.4.1">CarouselView</span></strong><span class="koboSpan" id="kobo.5.1"> control to display a group of images, the user can swipe through them to view each image. </span><span class="koboSpan" id="kobo.5.2">To display a large group of images, we will use the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.6.1">CollectionView</span></strong><span class="koboSpan" id="kobo.7.1"> control and vertical scrolling to allow the user to view all the images. </span><span class="koboSpan" id="kobo.7.2">By learning how to use these controls, we will be able to use them in a lot of other cases when we build </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">real-world apps.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">The following topics will be covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.11.1">Requesting permissions from the user to </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">access data</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">How to import photos from the iOS and Mac Catalyst </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">photo gallery</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">How to import photos from the Android </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">photo gallery</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">How to import photos from the Windows </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">photo gallery</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">How to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.20.1">CarouselView</span></strong><span class="koboSpan" id="kobo.21.1"> in .</span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">NET MAUI</span></span></li>
<li><span class="koboSpan" id="kobo.23.1">How to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.24.1">CollectionView</span></strong><span class="koboSpan" id="kobo.25.1"> in .</span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">NET MAUI</span></span></li>
</ul>
<h1 id="_idParaDest-112"><a id="_idTextAnchor515"/><span class="koboSpan" id="kobo.27.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.28.1">To be able to complete this project, you will need to have Visual Studio for Mac or Windows installed, as well as the necessary .NET MAUI workloads. </span><span class="koboSpan" id="kobo.28.2">See </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.29.1">Chapter 1</span></em></span><span class="koboSpan" id="kobo.30.1">,</span><em class="italic"><span class="koboSpan" id="kobo.31.1"> Introduction to .NET MAUI</span></em><span class="koboSpan" id="kobo.32.1">, for more details on how to set up </span><span class="No-Break"><span class="koboSpan" id="kobo.33.1">your environment.</span></span></p>
<p><span class="koboSpan" id="kobo.34.1">To build an iOS </span><a id="_idIndexMarker605"/><span class="koboSpan" id="kobo.35.1">app using Visual Studio for your PC, you have to have a </span><strong class="bold"><span class="koboSpan" id="kobo.36.1">Macintosh</span></strong><span class="koboSpan" id="kobo.37.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.38.1">Mac</span></strong><span class="koboSpan" id="kobo.39.1">) device connected. </span><span class="koboSpan" id="kobo.39.2">If you don’t have access to a Mac at all, you can just follow the Android and Windows part of </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">this project.</span></span></p>
<p><span class="koboSpan" id="kobo.41.1">You can find the full source for the code in this chapter </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">at </span></span><a href="https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition/"><span class="No-Break"><span class="koboSpan" id="kobo.43.1">https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.44.1">.</span></span><a id="_idTextAnchor516"/><a id="_idTextAnchor517"/></p>
<h1 id="_idParaDest-113"><a id="_idTextAnchor518"/><span class="koboSpan" id="kobo.45.1">Project overview</span></h1>
<p><span class="koboSpan" id="kobo.46.1">Almost all apps visualize collections of data, and in this chapter, we will focus on two of the .NET MAUI controls that can be used to display data collections—</span><strong class="source-inline"><span class="koboSpan" id="kobo.47.1">CollectionView</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.48.1">and </span><strong class="source-inline"><span class="koboSpan" id="kobo.49.1">CarouselView</span></strong><span class="koboSpan" id="kobo.50.1">. </span><span class="koboSpan" id="kobo.50.2">Our app will show the photos that users have on their devices; to do that, we need to create a photo importer for each platform—one for iOS</span><a id="_idTextAnchor519"/><span class="koboSpan" id="kobo.51.1"> and Mac Catalyst, one for Windows, and one </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">for Android.</span></span></p>
<p><span class="koboSpan" id="kobo.53.1">The build time for this project is about </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">60 minutes</span><a id="_idTextAnchor520"/><span class="koboSpan" id="kobo.55.1">.</span></span></p>
<h1 id="_idParaDest-114"><a id="_idTextAnchor521"/><span class="koboSpan" id="kobo.56.1">Building the photo gallery app</span></h1>
<p><span class="koboSpan" id="kobo.57.1">This project, like all the rest, is a </span><strong class="bold"><span class="koboSpan" id="kobo.58.1">File</span></strong><span class="koboSpan" id="kobo.59.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.60.1">New</span></strong><span class="koboSpan" id="kobo.61.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.62.1">Project...</span></strong><span class="koboSpan" id="kobo.63.1">-style project, which means that we will </span><a id="_idIndexMarker606"/><span class="koboSpan" id="kobo.64.1">not be importing any code at all. </span><span class="koboSpan" id="kobo.64.2">So, this first section is all about creating the project and setting up the basic </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">project structure</span><a id="_idTextAnchor522"/><a id="_idTextAnchor523"/><a id="_idTextAnchor524"/><span class="koboSpan" id="kobo.66.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.67.1">It’s time to start building the app using the following steps. </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">Let’s begin!</span></span></p>
<h2 id="_idParaDest-115"><span class="koboSpan" id="kobo.69.1">Creating the new projec</span><a id="_idTextAnchor525"/><span class="koboSpan" id="kobo.70.1">t</span></h2>
<p><span class="koboSpan" id="kobo.71.1">The first </span><a id="_idIndexMarker607"/><span class="koboSpan" id="kobo.72.1">step is to create a new .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">MAUI </span></span><span class="No-Break"><a id="_idIndexMarker608"/></span><span class="No-Break"><span class="koboSpan" id="kobo.74.1">project:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.75.1">Open Visual Studio 2022 and select </span><strong class="bold"><span class="koboSpan" id="kobo.76.1">Create a </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.77.1">new project</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer111">
<span class="koboSpan" id="kobo.79.1"><img alt="Figure 6.1 – Visual Studio 2﻿022" src="image/Figure_6.1_B19214.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.80.1">Figure 6.1 – Visual Studio 2</span><a id="_idTextAnchor526"/><span class="koboSpan" id="kobo.81.1">022</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.82.1">This </span><a id="_idIndexMarker609"/><span class="koboSpan" id="kobo.83.1">will open the </span><strong class="bold"><span class="koboSpan" id="kobo.84.1">Create a new </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.85.1">project</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.86.1"> wizard.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.87.1">In the search field, type in </span><strong class="source-inline"><span class="koboSpan" id="kobo.88.1">maui</span></strong><span class="koboSpan" id="kobo.89.1"> and select the </span><strong class="bold"><span class="koboSpan" id="kobo.90.1">.NET MAUI App</span></strong><span class="koboSpan" id="kobo.91.1"> item from </span><span class="No-Break"><span class="koboSpan" id="kobo.92.1">the list:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer112">
<span class="koboSpan" id="kobo.93.1"><img alt="Figure 6.2 – Create a new proje﻿ct" src="image/Figure_6.2_B19214.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.94.1">Figure 6.2 – Create a new proje</span><a id="_idTextAnchor527"/><span class="koboSpan" id="kobo.95.1">ct</span></p>
<ol>
<li value="3"><span class="No-Break"><span class="koboSpan" id="kobo.96.1">Click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.97.1">Next</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.99.1">Complete </span><a id="_idIndexMarker610"/><span class="koboSpan" id="kobo.100.1">the next step of the wizard by naming your project. </span><span class="koboSpan" id="kobo.100.2">We will be calling our application </span><strong class="source-inline"><span class="koboSpan" id="kobo.101.1">GalleryApp</span></strong><span class="koboSpan" id="kobo.102.1"> in this case. </span><span class="koboSpan" id="kobo.102.2">Move on to the next dialog box by clicking </span><strong class="bold"><span class="koboSpan" id="kobo.103.1">Next</span></strong><span class="koboSpan" id="kobo.104.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.105.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer113">
<span class="koboSpan" id="kobo.106.1"><img alt="Figure 6.3 – Configure your new proje﻿ct" src="image/Figure_6.3_B19214.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.107.1">Figure 6.3 – Configure your new proje</span><a id="_idTextAnchor528"/><span class="koboSpan" id="kobo.108.1">ct</span></p>
<ol>
<li value="5"><span class="No-Break"><span class="koboSpan" id="kobo.109.1">Click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.110.1">Next</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.112.1">The last </span><a id="_idIndexMarker611"/><span class="koboSpan" id="kobo.113.1">step will prompt you for </span><a id="_idIndexMarker612"/><span class="koboSpan" id="kobo.114.1">the version of .NET Core to support. </span><span class="koboSpan" id="kobo.114.2">At the time of writing, .NET 6 is available as </span><strong class="bold"><span class="koboSpan" id="kobo.115.1">Long-Term Support</span></strong><span class="koboSpan" id="kobo.116.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.117.1">LTS</span></strong><span class="koboSpan" id="kobo.118.1">), and .NET 7 is </span><a id="_idIndexMarker613"/><span class="koboSpan" id="kobo.119.1">available as </span><strong class="bold"><span class="koboSpan" id="kobo.120.1">Standard-Term Support</span></strong><span class="koboSpan" id="kobo.121.1">. </span><span class="koboSpan" id="kobo.121.2">For the purposes of this book, we will assume that you will be using .</span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">NET 7.</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer114">
<span class="koboSpan" id="kobo.123.1"><img alt="Figure 6.4 – Additional information" src="image/Figure_6.4_B19214.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.124.1">Figure 6.4 – Additional information</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.125.1">Finalize the setup by clicking </span><strong class="bold"><span class="koboSpan" id="kobo.126.1">Create</span></strong><span class="koboSpan" id="kobo.127.1"> and wait for Visual Studio to create </span><span class="No-Break"><span class="koboSpan" id="kobo.128.1">the project.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.129.1">Just like that, the app is created. </span><span class="koboSpan" id="kobo.129.2">Let’s start by getting some photos </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">to disp</span><a id="_idTextAnchor529"/><a id="_idTextAnchor530"/><a id="_idTextAnchor531"/><span class="koboSpan" id="kobo.131.1">lay.</span></span></p>
<h2 id="_idParaDest-116"><a id="_idTextAnchor532"/><span class="koboSpan" id="kobo.132.1">Importing photos</span></h2>
<p><span class="koboSpan" id="kobo.133.1">The importing of photos is something that is carried out for all the platforms, so we will create a photo </span><a id="_idIndexMarker614"/><span class="koboSpan" id="kobo.134.1">importer interface. </span><span class="koboSpan" id="kobo.134.2">The interface will have two </span><strong class="source-inline"><span class="koboSpan" id="kobo.135.1">Get</span></strong><span class="koboSpan" id="kobo.136.1"> methods—one that supports paging and one that gets photos with specified filenames. </span><span class="koboSpan" id="kobo.136.2">Both methods will also take a quality argument, but we will only use that argument in the iOS photo importer. </span><span class="koboSpan" id="kobo.136.3">The quality argument will be an </span><strong class="source-inline"><span class="koboSpan" id="kobo.137.1">enum</span></strong><span class="koboSpan" id="kobo.138.1"> type with two options—</span><strong class="source-inline"><span class="koboSpan" id="kobo.139.1">High</span></strong><span class="koboSpan" id="kobo.140.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">Low</span></strong><span class="koboSpan" id="kobo.142.1">. </span><span class="koboSpan" id="kobo.142.2">However, before we create the interface, we will create a model class that will represent an imported photo using the </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.144.1">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.145.1">Models</span></strong><span class="koboSpan" id="kobo.146.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.147.1">GalleryApp</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.148.1"> project.</span></span></li>
<li><span class="koboSpan" id="kobo.149.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.150.1">Photo</span></strong><span class="koboSpan" id="kobo.151.1"> in the recently </span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">created folder:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.153.1">
namespace GalleryApp.Models;
public class Photo
{
  public string Filename { get; set; }
  public byte[] Bytes { get; set; }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.154.1">Now that </span><a id="_idIndexMarker615"/><span class="koboSpan" id="kobo.155.1">we have created the model class, we can continue to create </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">the interface:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.157.1">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.158.1">Services</span></strong><span class="koboSpan" id="kobo.159.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.160.1">the project.</span></span></li>
<li><span class="koboSpan" id="kobo.161.1">Create a new interface named </span><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">IPhotoImporter</span></strong><span class="koboSpan" id="kobo.163.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.164.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.165.1"> folder:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.166.1">
namespace GalleryApp.Services;
using System.Collections.ObjectModel;
using GalleryApp.Models;
public interface IPhotoImporter
{
  Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(int start, int  count, 
Quality quality = Quality.Low);
  Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(List&lt;string&gt; filenames, 
Quality quality = Quality.Low);
}</span></pre></li> <li><span class="koboSpan" id="kobo.167.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">Services</span></strong><span class="koboSpan" id="kobo.169.1"> folder, add a new file and create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.170.1">enum</span></strong><span class="koboSpan" id="kobo.171.1"> type named </span><strong class="source-inline"><span class="koboSpan" id="kobo.172.1">Quality</span></strong><span class="koboSpan" id="kobo.173.1"> with two members—</span><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">Low</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.175.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">High</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.177.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.178.1">
namespace GalleryApp.Services;
public enum Quality
{
  Low,
  High
}</span></pre></li> <li><span class="koboSpan" id="kobo.179.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">Services</span></strong><span class="koboSpan" id="kobo.181.1"> folder, create </span><a id="_idIndexMarker616"/><span class="koboSpan" id="kobo.182.1">a new class </span><span class="No-Break"><span class="koboSpan" id="kobo.183.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.184.1">PhotoImporter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.185.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.186.1">
namespace GalleryApp.Services;
using GalleryApp.Models;
using System.Collections.ObjectModel;
internal partial class PhotoImporter : IPhotoImporter
{
  private partial Task&lt;string[]&gt; Import();
  public partial Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(int 
start, int count, Quality quality);
  public partial Task&lt;ObservableCollection&lt;Photo&gt;&gt; 
Get(List&lt;string&gt; filenames, Quality quality);
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.187.1">This class provides us with the base for the platform-specific implementations. </span><span class="koboSpan" id="kobo.187.2">By marking it </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">partial</span></strong><span class="koboSpan" id="kobo.189.1">, we are telling the compiler that there is more to this class in other files. </span><span class="koboSpan" id="kobo.189.2">We will be putting the implementation in the platform-specific </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">folders</span><a id="_idTextAnchor533"/><span class="koboSpan" id="kobo.191.1"> later.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.192.1">Now that </span><a id="_idIndexMarker617"/><span class="koboSpan" id="kobo.193.1">we have the interface, we can add </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">app permissions.</span></span></p>
<h3><span class="koboSpan" id="kobo.195.1">Requesting app permissions</span></h3>
<p><span class="koboSpan" id="kobo.196.1">If your app doesn’t require any of the device’s extra features, such as location, camera, or internet, then you will need to use permissions to request access to those resources. </span><span class="koboSpan" id="kobo.196.2">While each </span><a id="_idIndexMarker618"/><span class="koboSpan" id="kobo.197.1">platform implements permissions slightly differently, .NET MAUI maps the platform-specific permissions into a common set of permissions to make things simpler. </span><span class="koboSpan" id="kobo.197.2">The permission system in .NET MAUI is also extensible so that you can create your own permissions to best suit </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">your app.</span></span></p>
<p><span class="koboSpan" id="kobo.199.1">Let’s look at a specific example to see how requesting permissions works. </span><strong class="source-inline"><span class="koboSpan" id="kobo.200.1">GalleryApp</span></strong><span class="koboSpan" id="kobo.201.1"> displays images from a device’s photo library. </span><span class="koboSpan" id="kobo.201.2">In the case of iOS and Android, the app must declare and request access to the photo library before it can use it. </span><span class="koboSpan" id="kobo.201.3">While these permissions are configured and named differently, .NET MAUI defines a </span><strong class="source-inline"><span class="koboSpan" id="kobo.202.1">Photo</span></strong><span class="koboSpan" id="kobo.203.1"> permission that hides those </span><span class="No-Break"><span class="koboSpan" id="kobo.204.1">implementation details.</span></span></p>
<p><span class="koboSpan" id="kobo.205.1">Follow these steps to add a permission check </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">GalleryApp</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.208.1">:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.209.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">AppPermissions</span></strong><span class="koboSpan" id="kobo.211.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">GalleryApp</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.213.1"> project.</span></span></li>
<li><span class="koboSpan" id="kobo.214.1">Modify the class definition to add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">partial</span></strong><span class="koboSpan" id="kobo.216.1"> modifier, and remove the </span><span class="No-Break"><span class="koboSpan" id="kobo.217.1">default constructor:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.218.1">
namespace GalleryApp;
internal partial class AppPermissions
{
}</span></pre></li> <li><span class="koboSpan" id="kobo.219.1">Add the following class definition to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">AppPermissions</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.221.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.222.1">
internal partial class AppPermissions
{
</span><strong class="bold"><span class="koboSpan" id="kobo.223.1">  internal partial class AppPermission : Permissions.Photos</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.224.1">  {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.225.1">  }</span></strong><span class="koboSpan" id="kobo.226.1">
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.227.1">This creates a type named </span><strong class="source-inline"><span class="koboSpan" id="kobo.228.1">AppPermission</span></strong><span class="koboSpan" id="kobo.229.1"> that derives from the default .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">Photos</span></strong><span class="koboSpan" id="kobo.231.1"> permission class. </span><span class="koboSpan" id="kobo.231.2">It is also marked </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">partial</span></strong><span class="koboSpan" id="kobo.233.1"> to allow for platform-specific </span><a id="_idIndexMarker619"/><span class="koboSpan" id="kobo.234.1">implementation details to be added. </span><span class="koboSpan" id="kobo.234.2">Spoiler alert: we will need to have some </span><span class="No-Break"><span class="koboSpan" id="kobo.235.1">platform-specific permissions.</span></span></p></li> <li><span class="koboSpan" id="kobo.236.1">Add the following method to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.237.1">AppPermissions</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.238.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.239.1">
public static async Task&lt;PermissionStatus&gt; 
CheckRequiredPermission() =&gt; await Permissions.
</span><span class="koboSpan" id="kobo.239.2">CheckStatusAsync&lt;AppPermission&gt;();</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.240.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">CheckRequiredPermission</span></strong><span class="koboSpan" id="kobo.242.1"> method is used to ensure our app has the right permissions before we attempt any operations that might fail if we don’t. </span><span class="koboSpan" id="kobo.242.2">Its implementation is to call the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">CheckSyncStatus</span></strong><span class="koboSpan" id="kobo.244.1"> with our </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">AppPermission</span></strong><span class="koboSpan" id="kobo.246.1"> type. </span><span class="koboSpan" id="kobo.246.2">It returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">PermissionStatus</span></strong><span class="koboSpan" id="kobo.248.1">, which is an </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">enum</span></strong><span class="koboSpan" id="kobo.250.1"> type. </span><span class="koboSpan" id="kobo.250.2">We are mostly interested in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">Denied</span></strong><span class="koboSpan" id="kobo.252.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">Granted</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.254.1"> values.</span></span></p></li> <li><span class="koboSpan" id="kobo.255.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.256.1">CheckAndRequestRequiredPermission</span></strong><span class="koboSpan" id="kobo.257.1"> method to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.258.1">AppPermissions</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.259.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.260.1">
public static async Task&lt;PermissionStatus&gt; 
CheckAndRequestRequiredPermission()
{
  PermissionStatus status = await Permissions.
</span><span class="koboSpan" id="kobo.260.2">CheckStatusAsync&lt;AppPermission&gt;();
  if (status == PermissionStatus.Granted)
            return status;
  if (status == PermissionStatus.Denied &amp;&amp; DeviceInfo.Platform 
== DevicePlatform.iOS)
  {
    // Prompt the user to turn on in settings
    // On iOS once a permission has been denied it may not be 
requested again from the application
    await App.Current.MainPage.DisplayAlert("Required App 
Permissions", "Please enable all permissions in Settings for 
this App, it is useless without them.", "Ok");
  }
  if
  (Permissions.ShouldShowRationale&lt;AppPermission&gt;())
  {
    // Prompt the user with additional information as to why the 
permission is needed
    await App.Current.MainPage.DisplayAlert("Required App 
Permissions", "This is a Photo gallery app, without these 
permissions it is useless.", "Ok");
  }
  status = await MainThread.InvokeOnMainThreadAsync(Permissions.
</span><span class="koboSpan" id="kobo.260.3">RequestAsync&lt;AppPermission&gt;);
  return status;
  }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.261.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">CheckAndRequestRequiredPermission</span></strong><span class="koboSpan" id="kobo.263.1"> method handles the intricacies of requesting access from the user. </span><span class="koboSpan" id="kobo.263.2">The first step is to simply check whether the </span><a id="_idIndexMarker620"/><span class="koboSpan" id="kobo.264.1">permission has already been granted, and if it has, return the status. </span><span class="koboSpan" id="kobo.264.2">Next, if you are on iOS and the permission has been denied, it cannot be requested again, so you must instruct the user on how to grant permission to the app by using the settings panel. </span><span class="koboSpan" id="kobo.264.3">In the request behavior, Android includes the ability to nag the user if they have denied access. </span><span class="koboSpan" id="kobo.264.4">This behavior is exposed through .NET MAUI with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">ShouldShowRationale</span></strong><span class="koboSpan" id="kobo.266.1"> method. </span><span class="koboSpan" id="kobo.266.2">It will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">false</span></strong><span class="koboSpan" id="kobo.268.1"> for any platform that does not support this behavior; on Android, it will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">true</span></strong><span class="koboSpan" id="kobo.270.1"> the first time the user denies access and </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">false</span></strong><span class="koboSpan" id="kobo.272.1"> if the user denies it a second time. </span><span class="koboSpan" id="kobo.272.2">Finally, we request access for </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">AppPermission</span></strong><span class="koboSpan" id="kobo.274.1"> from the user. </span><span class="koboSpan" id="kobo.274.2">Again, .NET MAUI is hiding all the platform implementation details from us, making checking and requesting access to certain resources </span><span class="No-Break"><span class="koboSpan" id="kobo.275.1">very straightforward.</span></span></p></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.276.1">Look familiar?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.277.1">If the preceding code looks familiar, it might be. </span><span class="koboSpan" id="kobo.277.2">This is the same implementation that is described in the .NET MAUI documentation. </span><span class="koboSpan" id="kobo.277.3">You can find it </span><span class="No-Break"><span class="koboSpan" id="kobo.278.1">at </span></span><a href="https://learn.microsoft.com/en-us/dotnet/maui/platform-integration/appmodel/permissions"><span class="No-Break"><span class="koboSpan" id="kobo.279.1">https://learn.microsoft.com/en-us/dotnet/maui/platform-integration/appmodel/permissions</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.280.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.281.1">Now that we have the shared </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">AppPermissions</span></strong><span class="koboSpan" id="kobo.283.1"> in place, we can start with the </span><span class="No-Break"><span class="koboSpan" id="kobo.284.1">platform implementations.</span></span></p>
<h3><span class="koboSpan" id="kobo.285.1">Importing photos from the iOS photo gallery</span></h3>
<p><span class="koboSpan" id="kobo.286.1">First, we will write the iOS code. </span><span class="koboSpan" id="kobo.286.2">To access photos, we need permission from the user, and we need to explain why we are asking for permission. </span><span class="koboSpan" id="kobo.286.3">To do that, we add text that explains why </span><a id="_idIndexMarker621"/><span class="koboSpan" id="kobo.287.1">we need permission to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">info.plist</span></strong><span class="koboSpan" id="kobo.289.1"> file. </span><span class="koboSpan" id="kobo.289.2">This text will be displayed when we ask the users for permission. </span><span class="koboSpan" id="kobo.289.3">To open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">info.plist</span></strong><span class="koboSpan" id="kobo.291.1"> file, right-click on the file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.292.1">Platforms/iOS</span></strong><span class="koboSpan" id="kobo.293.1"> folder and click </span><strong class="bold"><span class="koboSpan" id="kobo.294.1">Open With…</span></strong><span class="koboSpan" id="kobo.295.1">, then select </span><strong class="bold"><span class="koboSpan" id="kobo.296.1">XML (Text) Editor</span></strong><span class="koboSpan" id="kobo.297.1">; this bypasses the default graphical </span><strong class="source-inline"><span class="koboSpan" id="kobo.298.1">Info.plist</span></strong><span class="koboSpan" id="kobo.299.1"> editor. </span><span class="koboSpan" id="kobo.299.2">Add the following text to the end of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">&lt;</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">dict&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.302.1"> element:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.303.1">
&lt;key&gt; NSPhotoLibraryUsageDescription &lt;/key&gt;
&lt;string&gt; We want to show your photos in this app &lt;/string&gt;</span></pre> <p><span class="koboSpan" id="kobo.304.1">The first thing we will do is implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.305.1">Import</span></strong><span class="koboSpan" id="kobo.306.1"> method that reads what photos can </span><span class="No-Break"><span class="koboSpan" id="kobo.307.1">be loaded:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.308.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">GalleryApp</span></strong><span class="koboSpan" id="kobo.310.1"> project in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">Platforms/iOS</span></strong><span class="koboSpan" id="kobo.312.1"> folder, create a new class </span><span class="No-Break"><span class="koboSpan" id="kobo.313.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">PhotoImporter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.315.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.316.1">Change the namespace declaration from </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">GalleryApp.Platforms.iOS</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.318.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.319.1">GalleryApp.Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.320.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.321.1">The partial class definitions must be in the same namespace, even though they are in </span><span class="No-Break"><span class="koboSpan" id="kobo.322.1">different folders.</span></span></li>
<li><span class="koboSpan" id="kobo.323.1">Add the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">partial</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.325.1"> modifier.</span></span></li>
<li><span class="koboSpan" id="kobo.326.1">Resolve all </span><span class="No-Break"><span class="koboSpan" id="kobo.327.1">the references.</span></span></li>
<li><span class="koboSpan" id="kobo.328.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.329.1">private</span></strong><span class="koboSpan" id="kobo.330.1"> field with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">PHAsset</span></strong><span class="koboSpan" id="kobo.332.1"> dictionary named </span><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">assets</span></strong><span class="koboSpan" id="kobo.334.1">. </span><span class="koboSpan" id="kobo.334.2">This will be used to store </span><span class="No-Break"><span class="koboSpan" id="kobo.335.1">photo information:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.336.1">
private Dictionary&lt;string,PHAsset&gt; assets;</span></pre></li> <li><span class="koboSpan" id="kobo.337.1">Create a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">private partial</span></strong><span class="koboSpan" id="kobo.339.1"> method </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">Import</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.343.1">
private partial async Task&lt;string[]&gt; Import()
{
}</span></pre></li> <li><span class="koboSpan" id="kobo.344.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">Import</span></strong><span class="koboSpan" id="kobo.346.1"> method, request authorization using </span><span class="No-Break"><span class="koboSpan" id="kobo.347.1">the </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">AppPermissions.Check</span></strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">AndRequestRequiredPermission</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.350.1"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.351.1">
var status = await AppPermissions.
</span><span class="koboSpan" id="kobo.351.2">CheckAndRequestRequiredPermission();</span></pre></li> <li><span class="koboSpan" id="kobo.352.1">If the </span><a id="_idIndexMarker622"/><span class="koboSpan" id="kobo.353.1">user has granted access, fetch all the image assets by </span><span class="No-Break"><span class="koboSpan" id="kobo.354.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">PHAsset.FetchAssets</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.356.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.357.1">
internal partial class PhotoImporter
{
  private Dictionary&lt;string,PHAsset&gt; assets;
  private partial async Task&lt;string[]&gt; Import()
  {
    var status = await AppPermissions.
</span><span class="koboSpan" id="kobo.357.2">CheckAndRequestRequiredPermission();
</span><strong class="bold"><span class="koboSpan" id="kobo.358.1">    if (status == PermissionStatus.Granted)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.359.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.360.1">      assets = PHAsset.FetchAssets(PHAssetMediaType.Image, null)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.361.1">      .Select(x =&gt; (PHAsset)x)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.362.1">      .ToDictionary(asset =&gt; asset.</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.363.1">ValueForKey((NSString)"filename").ToString(), asset =&gt; asset);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.364.1">    }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.365.1">    return assets?.Keys.ToList().ToArray();</span></strong><span class="koboSpan" id="kobo.366.1">
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.367.1">Now, we have fetched </span><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">PHAssets</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.369.1">for all the photos, but to show the photo, we need to get the actual photo. </span><span class="koboSpan" id="kobo.369.2">On iOS, to do that, we need to request the image for the asset. </span><span class="koboSpan" id="kobo.369.3">This is </span><a id="_idIndexMarker623"/><span class="koboSpan" id="kobo.370.1">something that is carried out asynchronously, so we will </span><span class="No-Break"><span class="koboSpan" id="kobo.371.1">use </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">ObservableCollection</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.374.1">
private void AddImage(ObservableCollection&lt;Photo&gt; photos, string path, 
PHAsset asset, Quality quality)
  {
    var options = new PHImageRequestOptions()
    {
      NetworkAccessAllowed = true,
      DeliveryMode = quality == Quality.Low ?
</span><span class="koboSpan" id="kobo.374.2">      PHImageRequestOptionsDeliveryMode.FastFormat :
      PHImageRequestOptionsDeliveryMode.HighQualityFormat
    };
        PHImageManager.DefaultManager.RequestImageForAsset(asset, 
PHImageManager.MaximumSize, PHImageContentMode.AspectFill, options, 
(image, info) =&gt;
    {
      using NSData imageData = image.AsPNG();
      var bytes = new byte[imageData.Length];
             System.Runtime.InteropServices.Marshal.Copy(imageData.
</span><span class="koboSpan" id="kobo.374.3">Bytes, bytes, 0, Convert.ToInt32(imageData.Length));
      photos.Add(new Photo()
      {
        Bytes = bytes,
        Filename = Path.GetFileName(path)
      });
    });
  }</span></pre> <p><span class="koboSpan" id="kobo.375.1">Now, we have </span><a id="_idIndexMarker624"/><span class="koboSpan" id="kobo.376.1">what we need to start implementing the two </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">Get</span></strong><span class="koboSpan" id="kobo.378.1"> methods from the interface. </span><span class="koboSpan" id="kobo.378.2">We will start with the partial </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(int start, int count, Quality quality = Quality.Low)</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.380.1">method, which will be used to get photos from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">CollectionView</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.382.1">view that loads </span><span class="No-Break"><span class="koboSpan" id="kobo.383.1">photos incrementally:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.384.1">
public partial async Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(int start, 
int count, Quality quality)
  {
    var photos = new ObservableCollection&lt;Photo&gt;();
    var status = await AppPermissions.
</span><span class="koboSpan" id="kobo.384.2">CheckAndRequestRequiredPermission();
    if (status == PermissionStatus.Granted)
    {
      var result = await Import();
      if (result.Length == 0)
      {
        return photos;
      }
      Index startIndex = start;
      Index endIndex = start + count;
      if (endIndex.Value &gt;= result.Length)
      {
        endIndex = result.Length;
      }
      if (startIndex.Value &gt; endIndex.Value)
      {
        return photos;
      }
      foreach (var path in result[startIndex..endIndex])
      {
        AddImage(photos, path, assets[path], quality);
      }
    }
    return photos;
  }</span></pre> <p><span class="koboSpan" id="kobo.385.1">The other </span><a id="_idIndexMarker625"/><span class="koboSpan" id="kobo.386.1">method from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">IPhotoImporter</span></strong><span class="koboSpan" id="kobo.388.1"> interface, </span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(List&lt;string&gt; filenames, Quality quality = Quality.Low)</span></strong><span class="koboSpan" id="kobo.390.1">, is very similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(int start, int count, Quality quality = Quality.Low)</span></strong><span class="koboSpan" id="kobo.392.1"> method. </span><span class="koboSpan" id="kobo.392.2">The only difference is that there is no code to handle indexes, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.393.1">foreach</span></strong><span class="koboSpan" id="kobo.394.1"> loop that loops through the result’s array contains an </span><strong class="source-inline"><span class="koboSpan" id="kobo.395.1">if</span></strong><span class="koboSpan" id="kobo.396.1"> statement that checks whether the filename is the same as the current </span><strong class="source-inline"><span class="koboSpan" id="kobo.397.1">PHAsset</span></strong><span class="koboSpan" id="kobo.398.1"> object, and if it is, it calls the </span><a id="_idTextAnchor534"/><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.399.1">AddImage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.400.1"> method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.401.1">
public partial async Task&lt;ObservableCollection&lt;Photo&gt;&gt; 
Get(List&lt;string&gt; filenames, Quality quality)
  {
    var photos = new ObservableCollection&lt;Photo&gt;();
    var result = await Import();
    if (result?.Length == 0)
    {
      return photos;
    }
    foreach (var path in result)
    {
      if (filenames.Contains(path))
      {
        AddImage(photos, path, assets[path], quality);
      }
    }
    return photos;
  }</span></pre> <p><span class="koboSpan" id="kobo.402.1">In the preceding code, we set </span><strong class="source-inline"><span class="koboSpan" id="kobo.403.1">NetworkAccessAllowed = true</span></strong><span class="koboSpan" id="kobo.404.1">. </span><span class="koboSpan" id="kobo.404.2">We do this to make it </span><a id="_idIndexMarker626"/><span class="koboSpan" id="kobo.405.1">possible to download ph</span><a id="_idTextAnchor535"/><span class="koboSpan" id="kobo.406.1">otos </span><span class="No-Break"><span class="koboSpan" id="kobo.407.1">from </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.408.1">iCloud</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.409.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.410.1">Now, one of the four photo importers of our project is complete. </span><span class="koboSpan" id="kobo.410.2">The Mac Catalyst importer will be the next one </span><span class="No-Break"><span class="koboSpan" id="kobo.411.1">we implement.</span></span></p>
<h3><span class="koboSpan" id="kobo.412.1">Importing photos from the Mac Catalyst photo gallery</span></h3>
<p><span class="koboSpan" id="kobo.413.1">The Mac Catalyst importer is exactly the same as what we just did for iOS. </span><span class="koboSpan" id="kobo.413.2">However, there isn’t </span><a id="_idIndexMarker627"/><span class="koboSpan" id="kobo.414.1">a convenient way to say, “</span><em class="italic"><span class="koboSpan" id="kobo.415.1">I need this class for just iOS and Mac Catalyst, and nothing else.</span></em><span class="koboSpan" id="kobo.416.1">” So we will take the path of least resistance and just copy the class into the Mac Catalyst </span><span class="No-Break"><span class="koboSpan" id="kobo.417.1">platform folder:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.418.1">Right-click the </span><strong class="source-inline"><span class="koboSpan" id="kobo.419.1">PhotoImporter.cs</span></strong><span class="koboSpan" id="kobo.420.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.421.1">Platforms/iOS</span></strong><span class="koboSpan" id="kobo.422.1"> folder in the project and </span><span class="No-Break"><span class="koboSpan" id="kobo.423.1">select </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.424.1">Copy</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.425.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.426.1">Right-click the </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">Platforms/MacCatalyst</span></strong><span class="koboSpan" id="kobo.428.1"> folder and </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">select </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.430.1">Paste</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.432.1">Right-click on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">Info.plist</span></strong><span class="koboSpan" id="kobo.434.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.435.1">Platforms/MacCatalyst</span></strong><span class="koboSpan" id="kobo.436.1"> folder and click </span><strong class="bold"><span class="koboSpan" id="kobo.437.1">Open With…</span></strong><span class="koboSpan" id="kobo.438.1">, then select </span><strong class="bold"><span class="koboSpan" id="kobo.439.1">XML (Text) Editor</span></strong><span class="koboSpan" id="kobo.440.1">, and add the following text to the end of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">&lt;</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">dict&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.443.1"> element:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.444.1">
&lt;key&gt; NSPhotoLibraryUsageDescription &lt;/key&gt;
&lt;string&gt; We want to show your photos in this app &lt;/string&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.445.1">That concludes the Mac Catalyst implementation of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">PhotoImporter</span></strong><span class="koboSpan" id="kobo.447.1"> class. </span><span class="koboSpan" id="kobo.447.2">Next, we will work on the</span><a id="_idTextAnchor536"/> <span class="No-Break"><span class="koboSpan" id="kobo.448.1">Android platform.</span></span></p>
<h3><span class="koboSpan" id="kobo.449.1">Importing photos from the Android photo gallery</span></h3>
<p><span class="koboSpan" id="kobo.450.1">Now that we have created an implementation for iOS, we will do the same for Android. </span><span class="koboSpan" id="kobo.450.2">Before we </span><a id="_idIndexMarker628"/><span class="koboSpan" id="kobo.451.1">jump right into the importer, we need to address the permissions </span><span class="No-Break"><span class="koboSpan" id="kobo.452.1">on Android.</span></span></p>
<p><span class="koboSpan" id="kobo.453.1">In Android API version 33, three new permissions were added to enable read access to media files: </span><strong class="source-inline"><span class="koboSpan" id="kobo.454.1">ReadMediaImages</span></strong><span class="koboSpan" id="kobo.455.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">ReadMediaVideos</span></strong><span class="koboSpan" id="kobo.457.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.458.1">ReadMediaAudio</span></strong><span class="koboSpan" id="kobo.459.1">. </span><span class="koboSpan" id="kobo.459.2">Prior to API version 33, all that was required was the </span><strong class="source-inline"><span class="koboSpan" id="kobo.460.1">ReadExternalStorage</span></strong><span class="koboSpan" id="kobo.461.1"> permission. </span><span class="koboSpan" id="kobo.461.2">To properly request the correct permission for the API version of the device, create a new file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.462.1">AppPermissions</span></strong><span class="koboSpan" id="kobo.463.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.464.1">Platform/Android</span></strong><span class="koboSpan" id="kobo.465.1"> folder and modify it to look like </span><span class="No-Break"><span class="koboSpan" id="kobo.466.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.467.1">
using Android.OS;
[assembly: Android.App.UsesPermission(Android.Manifest.Permission.
</span><span class="koboSpan" id="kobo.467.2">ReadMediaImages)]
[assembly: Android.App.UsesPermission(Android.Manifest.Permission.
</span><span class="koboSpan" id="kobo.467.3">ReadExternalStorage, MaxSdkVersion = 32)]
namespace GalleryApp;
internal partial class AppPermissions
{
  internal partial class AppPermission : Permissions.Photos
  {
    public override (string androidPermission, bool isRuntime)[] 
RequiredPermissions
    {
      get
      {
        List&lt;(string androidPermission, bool isRuntime)&gt; perms = new();
        if (Build.VERSION.SdkInt &gt;= BuildVersionCodes.Tiramisu)
                    perms.Add((global::Android.Manifest.Permission.
</span><span class="koboSpan" id="kobo.467.4">ReadMediaImages, true));
        else
                    perms.Add((global::Android.Manifest.Permission.
</span><span class="koboSpan" id="kobo.467.5">ReadExternalStorage, true));
        return perms.ToArray();
      }
    }
  }
}</span></pre> <p><span class="koboSpan" id="kobo.468.1">The first two </span><a id="_idIndexMarker629"/><span class="koboSpan" id="kobo.469.1">lines add the required permissions to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.470.1">AndroidManifet.xml</span></strong><span class="koboSpan" id="kobo.471.1"> file, similar to what we did manually with the iOS </span><strong class="source-inline"><span class="koboSpan" id="kobo.472.1">info.plist</span></strong><span class="koboSpan" id="kobo.473.1"> file. </span><span class="koboSpan" id="kobo.473.2">However, we only need </span><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">ReadMediaImages</span></strong><span class="koboSpan" id="kobo.475.1"> for API 33+ and </span><strong class="source-inline"><span class="koboSpan" id="kobo.476.1">ReadExternalStorage</span></strong><span class="koboSpan" id="kobo.477.1"> for API versions below 33, so we set </span><strong class="source-inline"><span class="koboSpan" id="kobo.478.1">MaxSdkVersion</span></strong><span class="koboSpan" id="kobo.479.1"> for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.480.1">ReadExternalStorage</span></strong><span class="koboSpan" id="kobo.481.1"> property. </span><span class="koboSpan" id="kobo.481.2">Then, we extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.482.1">AppPermission</span></strong><span class="koboSpan" id="kobo.483.1"> class with an implementation of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.484.1">RequirePermissions</span></strong><span class="koboSpan" id="kobo.485.1"> property. </span><span class="koboSpan" id="kobo.485.2">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">RequirePermissions</span></strong><span class="koboSpan" id="kobo.487.1">, we return an array containing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.488.1">ReadMediaImages</span></strong><span class="koboSpan" id="kobo.489.1"> permissions if the API version is 33 or higher, or the </span><strong class="source-inline"><span class="koboSpan" id="kobo.490.1">ReadExternalStorage</span></strong><span class="koboSpan" id="kobo.491.1"> permission if the API version is lower than 33. </span><span class="koboSpan" id="kobo.491.2">The Boolean value that is part of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">perms</span></strong><span class="koboSpan" id="kobo.493.1"> array indicates whether the permission requires requesting access at runtime from the user. </span><span class="koboSpan" id="kobo.493.2">Now, when the app launches, it will request access for the correct permission based on the API level of </span><span class="No-Break"><span class="koboSpan" id="kobo.494.1">the device.</span></span></p>
<p><span class="koboSpan" id="kobo.495.1">Now that we have the Android-specific permissions sorted, we can import images using the </span><span class="No-Break"><span class="koboSpan" id="kobo.496.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.497.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.498.1">PhotoImporter</span></strong><span class="koboSpan" id="kobo.499.1"> in the project in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">Platforms/Android</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.501.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.502.1">Change the namespace declaration from </span><strong class="source-inline"><span class="koboSpan" id="kobo.503.1">GalleryApp.Platforms.Android</span></strong><span class="koboSpan" id="kobo.504.1"> to </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.505.1">GalleryApp.Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.506.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.507.1">The partial class definitions must be in the same namespace, even though they are in </span><span class="No-Break"><span class="koboSpan" id="kobo.508.1">different folders.</span></span></li>
<li><span class="koboSpan" id="kobo.509.1">Add the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">partial</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.511.1"> modifier.</span></span></li>
<li><span class="koboSpan" id="kobo.512.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.513.1">using</span></strong><span class="koboSpan" id="kobo.514.1"> statement for </span><strong class="source-inline"><span class="koboSpan" id="kobo.515.1">GalleryApp.Models</span></strong><span class="koboSpan" id="kobo.516.1"> to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">Photo</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.518.1">class later.</span></span></li>
<li><span class="koboSpan" id="kobo.519.1">Like the iOS implementation, we will start by implementing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.520.1">Import</span></strong><span class="koboSpan" id="kobo.521.1"> method. </span><span class="koboSpan" id="kobo.521.2">Add a new method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.522.1">Import</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.523.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.524.1">
private partial async Task&lt;string[]&gt; Import()
{
  var paths = new List&lt;string&gt;();
  return paths.ToArray();
}</span></pre></li> <li><span class="koboSpan" id="kobo.525.1">Request </span><a id="_idIndexMarker630"/><span class="koboSpan" id="kobo.526.1">permissions from the user to get the photos (highlighted in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.527.1">code block):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.528.1">
private partial async Task&lt;string[]&gt; Import()
{
  var paths = new List&lt;string&gt;();
</span><strong class="bold"><span class="koboSpan" id="kobo.529.1">  var status = await AppPermissions.</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.530.1">CheckAndRequestRequiredPermission();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.531.1">  if (status == PermissionStatus.Granted)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.532.1">  {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.533.1">  }</span></strong><span class="koboSpan" id="kobo.534.1">
  return paths.ToArray();
}</span></pre></li> <li><span class="koboSpan" id="kobo.535.1">Now, use </span><strong class="source-inline"><span class="koboSpan" id="kobo.536.1">ContentResolver</span></strong><span class="koboSpan" id="kobo.537.1"> to query for the files and add them to </span><span class="No-Break"><span class="koboSpan" id="kobo.538.1">the result:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.539.1">
private partial async Task&lt;string[]&gt; Import()
{
  var paths = new List&lt;string&gt;();
  var status = await AppPermissions.
</span><span class="koboSpan" id="kobo.539.2">CheckAndRequestRequiredPermission();
  if (status == PermissionStatus.Granted)
  {
</span><strong class="bold"><span class="koboSpan" id="kobo.540.1">    var imageUri = MediaStore.Images.Media.ExternalContentUri;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.541.1">    var projection = new string[] { MediaStore.IMediaColumns.</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.542.1">Data };</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.543.1">    var orderBy = MediaStore.Images.IImageColumns.DateTaken;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.544.1">    var cursor = Platform.CurrentActivity.ContentResolver.</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.545.1">Query(imageUri, projection, null, null, orderBy);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.546.1">    while (cursor.MoveToNext())</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.547.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.548.1">      string path = cursor.GetString(cursor.</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.549.1">GetColumnIndex(MediaStore.IMediaColumns.Data));</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.550.1">      paths.Add(path);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.551.1">    }</span></strong><span class="koboSpan" id="kobo.552.1">
  }
  return paths.ToArray();
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.553.1">We will </span><a id="_idIndexMarker631"/><span class="koboSpan" id="kobo.554.1">then start editing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.555.1">Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(int start, int count, Quality quality = Quality.Low)</span></strong><span class="koboSpan" id="kobo.556.1"> method. </span><span class="koboSpan" id="kobo.556.2">If the import succeeds, we will continue to write the code that handles which photos should be imported in this loading of images. </span><span class="koboSpan" id="kobo.556.3">Conditions are specified with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.557.1">start</span></strong><span class="koboSpan" id="kobo.558.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.559.1">count</span></strong><span class="koboSpan" id="kobo.560.1"> parameters. </span><span class="koboSpan" id="kobo.560.2">Use the following </span><a id="_idIndexMarker632"/><span class="koboSpan" id="kobo.561.1">code listing to implement the first </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">Get</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.563.1"> method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.564.1">
public partial async Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(int start, 
int count, Quality quality)
{
  var photos = new ObservableCollection&lt;Photo&gt;();
  var result = await Import();
  if (result.Length == 0)
  {
    return photos;
  }
  Index startIndex = start;
  Index endIndex = start + count;
  if (endIndex.Value &gt;= result.Length)
  {
    endIndex = result.Length;
  }
  if (startIndex.Value &gt; endIndex.Value)
  {
    return photos;
  }
  foreach (var path in result[startIndex..endIndex])
  {
    photos.Add(new()
    {
      Bytes = File.ReadAllBytes(path),
      Filename = Path.GetFileName(path)
    });
  }
  return photos;
}</span></pre> <p><span class="koboSpan" id="kobo.565.1">Let’s review the preceding code. </span><span class="koboSpan" id="kobo.565.2">The first step is to call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.566.1">Import</span></strong><span class="koboSpan" id="kobo.567.1"> method and verify that there </span><a id="_idIndexMarker633"/><span class="koboSpan" id="kobo.568.1">are photos to import. </span><span class="koboSpan" id="kobo.568.2">If there are none, we simply return an empty list. </span><span class="koboSpan" id="kobo.568.3">If there are photos to import, then we need to know </span><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">startIndex</span></strong><span class="koboSpan" id="kobo.570.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.571.1">endIndex</span></strong><span class="koboSpan" id="kobo.572.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">photos</span></strong><span class="koboSpan" id="kobo.574.1"> array to import. </span><span class="koboSpan" id="kobo.574.2">The code defaults to </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">endIndex</span></strong><span class="koboSpan" id="kobo.576.1"> being </span><strong class="source-inline"><span class="koboSpan" id="kobo.577.1">startIndex</span></strong><span class="koboSpan" id="kobo.578.1"> plus the count of photos to import. </span><span class="koboSpan" id="kobo.578.2">If the count of photos to import is greater than the number of photos returned from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.579.1">Import</span></strong><span class="koboSpan" id="kobo.580.1"> method, then </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">endindex</span></strong><span class="koboSpan" id="kobo.582.1"> is adjusted to the length of the photos returned from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.583.1">Import</span></strong><span class="koboSpan" id="kobo.584.1"> method. </span><span class="koboSpan" id="kobo.584.2">If </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">startIndex</span></strong><span class="koboSpan" id="kobo.586.1"> is greater than </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">endIndex</span></strong><span class="koboSpan" id="kobo.588.1">, then we return the list of photos. </span><span class="koboSpan" id="kobo.588.2">Finally, we can read the images from </span><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">startIndex</span></strong><span class="koboSpan" id="kobo.590.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">endIndex</span></strong><span class="koboSpan" id="kobo.592.1"> from the array of photos and return the bytes from the file and just the name of the file for </span><span class="No-Break"><span class="koboSpan" id="kobo.593.1">each entry.</span></span></p>
<p><span class="koboSpan" id="kobo.594.1">Now, we will continue with the other </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">
(List&lt;string&gt; filenames, Quality quality = </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.597.1">Quality.Low)</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.598.1"> method.</span></span></p>
<p><span class="koboSpan" id="kobo.599.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">foreach</span></strong><span class="koboSpan" id="kobo.601.1"> loop to loop through all the photos and to check whether each photo is specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">filenames</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.603.1">parameter. </span><span class="koboSpan" id="kobo.603.2">If a photo is specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.604.1">filenames</span></strong><span class="koboSpan" id="kobo.605.1"> parameter, read the photo from the path, as in the first </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">Get</span></strong></span><span class="No-Break"><em class="italic"> </em></span><span class="No-Break"><span class="koboSpan" id="kobo.607.1">method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.608.1">
public partial async Task&lt;ObservableCollection&lt;Photo&gt;&gt; 
Get(List&lt;string&gt; filenames, Quality quality)
{
  var photos = new ObservableCollection&lt;Photo&gt;();
  var result = await Import();
  if (result.Length == 0)
  {
    return photos;
  }
  foreach (var path in result)
  {
    var filename = Path.GetFileName(path);
    if (!filenames.Contains(filename))
    {
      continue;
    }
    photos.Add(new Photo()
    {
      Bytes = File.ReadAllBytes(path),
      Filename = filename
    });
  }
  return photos;
}</span></pre> <p><span class="koboSpan" id="kobo.609.1">With the </span><a id="_idIndexMarker634"/><span class="koboSpan" id="kobo.610.1">Android importer finished, we can move to the final importer </span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">for Windows.</span></span></p>
<h3><span class="koboSpan" id="kobo.612.1">Importing photos from the Windows photo gallery</span></h3>
<p><span class="koboSpan" id="kobo.613.1">The final </span><a id="_idIndexMarker635"/><span class="koboSpan" id="kobo.614.1">importer that we need is for the Windows platform. </span><span class="koboSpan" id="kobo.614.2">The code will follow the same pattern as for the other platforms; however, for Windows, we will use the </span><strong class="bold"><span class="koboSpan" id="kobo.615.1">Windows Search</span></strong><span class="koboSpan" id="kobo.616.1"> service to get the list of photos. </span><span class="koboSpan" id="kobo.616.2">Let’s see how this platform is implemented by following </span><span class="No-Break"><span class="koboSpan" id="kobo.617.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.618.1">Import the </span><strong class="source-inline"><span class="koboSpan" id="kobo.619.1">tlbimp-Windows.Search.Interop</span></strong><span class="koboSpan" id="kobo.620.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">System.Data.OleDB</span></strong><span class="koboSpan" id="kobo.622.1"> NuGet packages. </span><span class="koboSpan" id="kobo.622.2">These are needed to search the filesystem </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">for images.</span></span></li>
<li><span class="koboSpan" id="kobo.624.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.625.1">GalleryApp</span></strong><span class="koboSpan" id="kobo.626.1"> project by double-clicking it in </span><strong class="bold"><span class="koboSpan" id="kobo.627.1">Solution Explorer</span></strong><span class="koboSpan" id="kobo.628.1">; edit the new imports to add </span><span class="No-Break"><span class="koboSpan" id="kobo.629.1">a condition:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.630.1">
&lt;PackageReference Include="System.Data.OleDb" Version="7.0.0" 
</span><strong class="bold"><span class="koboSpan" id="kobo.631.1">Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(Target</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.632.1">Framework)')) == 'windows'"</span></strong><span class="koboSpan" id="kobo.633.1"> /&gt;
&lt;PackageReference Include="tlbimp-Microsoft.Search.Interop" 
Version="1.0.0" </span><strong class="bold"><span class="koboSpan" id="kobo.634.1">Condition="$([MSBuild]::GetTargetPlatform</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.635.1">Identifier('$(TargetFramework)')) == 'windows'"</span></strong><span class="koboSpan" id="kobo.636.1"> /&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.637.1">We will use these two NuGet packages to search for image files on the local computer. </span><span class="koboSpan" id="kobo.637.2">But since we only need these assemblies on Windows, we limit </span><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">PackageReference</span></strong><span class="koboSpan" id="kobo.639.1"> so that it is only used when </span><strong class="source-inline"><span class="koboSpan" id="kobo.640.1">TargetPlatformIdentifier</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.641.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.642.1">'windows'</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.643.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.644.1">Create a new class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.645.1">PhotoImporter</span></strong><span class="koboSpan" id="kobo.646.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.647.1">Windows</span></strong><span class="koboSpan" id="kobo.648.1"> platform folder, and mark it </span><span class="No-Break"><span class="koboSpan" id="kobo.649.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">partial</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.651.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.652.1">Change the namespace declaration from </span><strong class="source-inline"><span class="koboSpan" id="kobo.653.1">GalleryApp.Platforms.Windows</span></strong><span class="koboSpan" id="kobo.654.1"> to </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.655.1">GalleryApp.Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.656.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.657.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.658.1">partial</span></strong><span class="koboSpan" id="kobo.659.1"> class definitions must be in the same namespace, even though they are in </span><span class="No-Break"><span class="koboSpan" id="kobo.660.1">different folders.</span></span></li>
<li><span class="koboSpan" id="kobo.661.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.662.1">using</span></strong><span class="koboSpan" id="kobo.663.1"> directives, so that we can use the classes in </span><span class="No-Break"><span class="koboSpan" id="kobo.664.1">those namespaces:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.665.1">
using GalleryApp.Models;
using Microsoft.Search.Interop;
using System.Data.OleDb;</span></pre></li> <li><span class="koboSpan" id="kobo.666.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">private</span></strong><span class="koboSpan" id="kobo.668.1"> field to hold the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.669.1">QueryHelper</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.670.1"> reference:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.671.1">
ISearchQueryHelper queryHelper;</span></pre></li> <li><span class="koboSpan" id="kobo.672.1">Like the </span><a id="_idIndexMarker636"/><span class="koboSpan" id="kobo.673.1">previous implementations, we will start by implementing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.674.1">Import</span></strong><span class="koboSpan" id="kobo.675.1"> method, so add a new method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.676.1">Import</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.677.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.678.1">
private partial async Task&lt;string[]&gt; Import()
{
  var paths = new List&lt;string&gt;();
  return paths.ToArray();
}</span></pre></li> <li><span class="koboSpan" id="kobo.679.1">Request permissions from the user to get the photos (highlighted in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.680.1">code block):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.681.1">
private partial async Task&lt;string[]&gt; Import()
{
  var paths = new List&lt;string&gt;();
</span><strong class="bold"><span class="koboSpan" id="kobo.682.1">  var status = await AppPermissions.</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.683.1">CheckAndRequestRequiredPermission();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.684.1">  if (status == PermissionStatus.Granted)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.685.1">  {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.686.1">  }</span></strong><span class="koboSpan" id="kobo.687.1">
  return paths.ToArray();
}</span></pre></li> <li><span class="koboSpan" id="kobo.688.1">Now, using </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">QueryHelper</span></strong><span class="koboSpan" id="kobo.690.1">, get all </span><a id="_idIndexMarker637"/><span class="koboSpan" id="kobo.691.1">the </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">image paths:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.693.1">
private partial async Task&lt;string[]&gt; Import()
{
  var paths = new List&lt;string&gt;();
  var status = await AppPermissions.
</span><span class="koboSpan" id="kobo.693.2">CheckAndRequestRequiredPermission();
  if (status == PermissionStatus.Granted)
  {
</span><strong class="bold"><span class="koboSpan" id="kobo.694.1">    string sqlQuery = queryHelper.GenerateSQLFromUserQuery(" ");</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.695.1">    using OleDbConnection conn = new(queryHelper.</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.696.1">ConnectionString);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.697.1">    conn.Open();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.698.1">    using OleDbCommand command = new(sqlQuery, conn);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.699.1">    using OleDbDataReader WDSResults = command.ExecuteReader();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.700.1">    while (WDSResults.Read())</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.701.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.702.1">      var itemUrl = WDSResults.GetString(0);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.703.1">      paths.Add(itemUrl);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.704.1">    }</span></strong><span class="koboSpan" id="kobo.705.1">
  }
  return paths.ToArray();
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.706.1">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.707.1">QueryHelper</span></strong><span class="koboSpan" id="kobo.708.1"> is used to create a SQL query, and we use </span><strong class="source-inline"><span class="koboSpan" id="kobo.709.1">OleDbConnection</span></strong><span class="koboSpan" id="kobo.710.1"> to query the search index for all the </span><span class="No-Break"><span class="koboSpan" id="kobo.711.1">matching files.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.712.1">We can </span><a id="_idIndexMarker638"/><span class="koboSpan" id="kobo.713.1">now start editing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.714.1">Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(int start, int count, Quality quality = Quality.Low)</span></strong><span class="koboSpan" id="kobo.715.1"> method. </span><span class="koboSpan" id="kobo.715.2">Add the following declaration to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.716.1">PhotoImporter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.717.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.718.1">
public partial async Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(int start, 
int count, Quality quality)
{
}</span></pre> <p><span class="koboSpan" id="kobo.719.1">Now, we will start the implementation of the method by setting up file patterns and the locations we </span><span class="No-Break"><span class="koboSpan" id="kobo.720.1">will search:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.721.1">
string[] patterns = { ".png", ".jpeg", ".jpg" };
string[] locations = {
Environment.GetFolderPath(Environment.SpecialFolder.MyPictures),
      Environment.GetFolderPath(Environment.SpecialFolder.
</span><span class="koboSpan" id="kobo.721.2">CommonPictures),
     Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.
</span><span class="koboSpan" id="kobo.721.3">UserProfile),"OneDrive","Camera Roll")
};</span></pre> <p><span class="koboSpan" id="kobo.722.1">These arrays </span><a id="_idIndexMarker639"/><span class="koboSpan" id="kobo.723.1">define the file extensions and folders that we will search for photos. </span><span class="koboSpan" id="kobo.723.2">We will then create </span><strong class="source-inline"><span class="koboSpan" id="kobo.724.1">QueryHelper</span></strong><span class="koboSpan" id="kobo.725.1"> from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">tlbimp-Windows.Search.Interop</span></strong><span class="koboSpan" id="kobo.727.1"> NuGet package and, using the arrays, configure the </span><span class="No-Break"><span class="koboSpan" id="kobo.728.1">query parameters:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.729.1">
queryHelper = new CSearchManager().GetCatalog("SystemIndex").
</span><span class="koboSpan" id="kobo.729.2">GetQueryHelper();
queryHelper.QueryMaxResults = start + count;
queryHelper.QuerySelectColumns = "System.ItemPathDisplay";
queryHelper.QueryWhereRestrictions = "AND (";
foreach (var pattern in patterns)
     queryHelper.QueryWhereRestrictions += " Contains(System.
</span><span class="koboSpan" id="kobo.729.3">FileExtension, '" + pattern + "') OR";
queryHelper.QueryWhereRestrictions = queryHelper.
</span><span class="koboSpan" id="kobo.729.4">QueryWhereRestrictions[..^2];
queryHelper.QueryWhereRestrictions += ")";
queryHelper.QueryWhereRestrictions += " AND (";
foreach (var location in locations)
     queryHelper.QueryWhereRestrictions += " scope='" + location + "' 
OR";
queryHelper.QueryWhereRestrictions = queryHelper.
</span><span class="koboSpan" id="kobo.729.5">QueryWhereRestrictions[..^2];
queryHelper.QueryWhereRestrictions += ")";
queryHelper.QuerySorting = "System.DateModified DESC";</span></pre> <p><strong class="source-inline"><span class="koboSpan" id="kobo.730.1">QueryMaxResults</span></strong><span class="koboSpan" id="kobo.731.1"> is set so that we only retrieve the results we are looking for. </span><span class="koboSpan" id="kobo.731.2">Then, we specify that the only data column to return is </span><strong class="source-inline"><span class="koboSpan" id="kobo.732.1">"System.ItemPathDisplay"</span></strong><span class="koboSpan" id="kobo.733.1">. </span><span class="koboSpan" id="kobo.733.2">Next, we set </span><strong class="source-inline"><span class="koboSpan" id="kobo.734.1">QueryWhereRestictions</span></strong><span class="koboSpan" id="kobo.735.1"> from our list of extensions. </span><span class="koboSpan" id="kobo.735.2">Note the use of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.736.1">range</span></strong><span class="koboSpan" id="kobo.737.1"> operator to remove the trailing </span><strong class="source-inline"><span class="koboSpan" id="kobo.738.1">"OR"</span></strong><span class="koboSpan" id="kobo.739.1"> in the query string. </span><span class="koboSpan" id="kobo.739.2">We use the same technique to add the locations to </span><strong class="source-inline"><span class="koboSpan" id="kobo.740.1">QueryWhereRestrictions</span></strong><span class="koboSpan" id="kobo.741.1">. </span><span class="koboSpan" id="kobo.741.2">Finally, we set the </span><span class="No-Break"><span class="koboSpan" id="kobo.742.1">sort order.</span></span></p>
<p><span class="koboSpan" id="kobo.743.1">The remainder </span><a id="_idIndexMarker640"/><span class="koboSpan" id="kobo.744.1">of the method is going to be very similar to those of the previous platforms. </span><span class="koboSpan" id="kobo.744.2">If the import succeeds, we will continue to handle what photos should be imported in this loading of images. </span><span class="koboSpan" id="kobo.744.3">Conditions are specified with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.745.1">start</span></strong><span class="koboSpan" id="kobo.746.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.747.1">count</span></strong><span class="koboSpan" id="kobo.748.1"> parameters. </span><span class="koboSpan" id="kobo.748.2">Use the following code listing to complete the implementation of the first </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">Get</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.750.1"> method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.751.1">
var photos = new ObservableCollection&lt;Photo&gt;();
var result = await Import();
if (result?.Length == 0)
{
  return photos;
}
Index startIndex = start;
Index endIndex = start + count;
if (endIndex.Value &gt;= result.Length)
{
  endIndex = result.Length;
}
if (startIndex.Value &gt; endIndex.Value)
{
  return photos;
}
foreach (var uri in result[startIndex..endIndex])
{
  var path = new System.Uri(uri).AbsolutePath;
  photos.Add(new()
  {
    Bytes = File.ReadAllBytes(path),
    Filename = Path.GetFileName(path)
  });
}
return photos;</span></pre> <p><span class="koboSpan" id="kobo.752.1">Let’s quickly </span><a id="_idIndexMarker641"/><span class="koboSpan" id="kobo.753.1">review the preceding code. </span><span class="koboSpan" id="kobo.753.2">The first step is to call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.754.1">Import</span></strong><span class="koboSpan" id="kobo.755.1"> method and verify that there are photos to import. </span><span class="koboSpan" id="kobo.755.2">If there are none, we simply return an empty list. </span><span class="koboSpan" id="kobo.755.3">If there are photos to import, then we need to know </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">startIndex</span></strong><span class="koboSpan" id="kobo.757.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">endIndex</span></strong><span class="koboSpan" id="kobo.759.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">photos</span></strong><span class="koboSpan" id="kobo.761.1"> array to import. </span><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">startIndex</span></strong><span class="koboSpan" id="kobo.763.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">endIndex</span></strong><span class="koboSpan" id="kobo.765.1"> are adjusted to make sure they are valid for the photos to import. </span><span class="koboSpan" id="kobo.765.2">Then, we can read the images from </span><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">startIndex</span></strong><span class="koboSpan" id="kobo.767.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">endIndex</span></strong><span class="koboSpan" id="kobo.769.1"> from the array of photos and return the bytes from the file and just the name of the file for </span><span class="No-Break"><span class="koboSpan" id="kobo.770.1">each entry.</span></span></p>
<p><span class="koboSpan" id="kobo.771.1">Now, we will continue with the other </span><strong class="source-inline"><span class="koboSpan" id="kobo.772.1">Task&lt;ObservableCollection&lt;Photo&gt;&gt; Get(List&lt;string&gt; filenames, Quality quality = Quality.Low)</span></strong><span class="koboSpan" id="kobo.773.1"> method. </span><span class="koboSpan" id="kobo.773.2">Add the following declaration to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.774.1">PhotoImporter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.775.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.776.1">
public partial async Task&lt;ObservableCollection&lt;Photo&gt;&gt; 
Get(List&lt;string&gt; filenames, Quality quality)
{
}</span></pre> <p><span class="koboSpan" id="kobo.777.1">Now, we will </span><a id="_idIndexMarker642"/><span class="koboSpan" id="kobo.778.1">start the implementation of the method by setting the </span><span class="No-Break"><span class="koboSpan" id="kobo.779.1">search parameters:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.780.1">
queryHelper = new CSearchManager().GetCatalog("SystemIndex").
</span><span class="koboSpan" id="kobo.780.2">GetQueryHelper();
queryHelper.QuerySelectColumns = "System.ItemPathDisplay";
queryHelper.QueryWhereRestrictions = "AND (";
foreach (var filename in filenames)
     queryHelper.QueryWhereRestrictions += " Contains(System.Filename, 
'" + filename + "') OR";
queryHelper.QueryWhereRestrictions = queryHelper.
</span><span class="koboSpan" id="kobo.780.3">QueryWhereRestrictions[..^2];
queryHelper.QueryWhereRestrictions += ")";</span></pre> <p><span class="koboSpan" id="kobo.781.1">For this method, we only need to add all the filenames to </span><strong class="source-inline"><span class="koboSpan" id="kobo.782.1">QueryWhereRestrictions</span></strong><span class="koboSpan" id="kobo.783.1">. </span><span class="koboSpan" id="kobo.783.2">Following that, call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.784.1">Import</span></strong><span class="koboSpan" id="kobo.785.1"> method, and if it returns results, then use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.786.1">foreach</span></strong><span class="koboSpan" id="kobo.787.1"> loop to loop through all the photos and to check whether each photo is specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.788.1">filenames</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.789.1">parameter. </span><span class="koboSpan" id="kobo.789.2">If a photo is specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.790.1">filenames</span></strong><span class="koboSpan" id="kobo.791.1"> parameter, read the photo from the path, as in the first </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.792.1">Get</span></strong></span><span class="No-Break"><em class="italic"> </em></span><span class="No-Break"><span class="koboSpan" id="kobo.793.1">method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.794.1">
var photos = new ObservableCollection&lt;Photo&gt;();
var result = await Import();
if (result?.Length == 0)
{
  return photos;
}
foreach (var uri in result)
{
  var path = new System.Uri(uri).AbsolutePath;
  var filename = Path.GetFileName(path);
  if (filenames.Contains(filename))
  {
    photos.Add(new()
    {
      Bytes = File.ReadAllBytes(path),
      Filename = filename
    });
  }
}
return photos;</span></pre> <p><span class="koboSpan" id="kobo.795.1">The photo </span><a id="_idIndexMarker643"/><span class="koboSpan" id="kobo.796.1">importers are now finished, and we are ready to write the rest of the app, which will mostly involve adding code that is shared between </span><span class="No-Break"><span class="koboSpan" id="kobo.797.1">the platforms.</span></span></p>
<h3><span class="koboSpan" id="kobo.798.1">Writing the app-initializing code</span></h3>
<p><span class="koboSpan" id="kobo.799.1">We have now written the code that we will use to get </span><a id="_idTextAnchor537"/><span class="koboSpan" id="kobo.800.1">data to the app. </span><span class="koboSpan" id="kobo.800.2">Let’s continue to build the app, starting </span><a id="_idIndexMarker644"/><span class="koboSpan" id="kobo.801.1">with init</span><a id="_idTextAnchor538"/><span class="koboSpan" id="kobo.802.1">ializing the core parts of </span><span class="No-Break"><span class="koboSpan" id="kobo.803.1">the app.</span></span></p>
<h3><span class="koboSpan" id="kobo.804.1">Wiring up dependency injection</span></h3>
<p><span class="koboSpan" id="kobo.805.1">By using dependency injection as a pattern, we can keep our code cleaner and more testable. </span><span class="koboSpan" id="kobo.805.2">This </span><a id="_idIndexMarker645"/><span class="koboSpan" id="kobo.806.1">app will use constructor injection, which means that all the dependencies that a class has must be passed through its constructor. </span><span class="koboSpan" id="kobo.806.2">The container then constructs objects for you, so you don’t have to </span><a id="_idIndexMarker646"/><span class="koboSpan" id="kobo.807.1">care too much about the dependency chain. </span><span class="koboSpan" id="kobo.807.2">Since .NET MAUI already includes a dependency injection framework, </span><strong class="bold"><span class="koboSpan" id="kobo.808.1">Microsoft.Extensions.DependencyInjection</span></strong><span class="koboSpan" id="kobo.809.1">, there is nothing extra </span><span class="No-Break"><span class="koboSpan" id="kobo.810.1">to install.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.811.1">Confused about dependency injection?</span></p>
<p class="callout"><span class="koboSpan" id="kobo.812.1">Check out the </span><em class="italic"><span class="koboSpan" id="kobo.813.1">Wiring up a dependency injection</span></em><span class="koboSpan" id="kobo.814.1"> section in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.815.1">Chapter 2</span></em></span><span class="koboSpan" id="kobo.816.1">, </span><em class="italic"><span class="koboSpan" id="kobo.817.1">Building Our Fir</span><a id="_idTextAnchor539"/><span class="koboSpan" id="kobo.818.1">st .NET MAUI App</span></em><span class="koboSpan" id="kobo.819.1">, for </span><a id="_idTextAnchor540"/><a id="_idTextAnchor541"/><span class="koboSpan" id="kobo.820.1">more details on </span><span class="No-Break"><span class="koboSpan" id="kobo.821.1">dependency injection.</span></span></p>
<p><span class="koboSpan" id="kobo.822.1">While it is recommended to use extension methods to group the types together, we have very few types in this app to register so we will use a different method in the </span><span class="No-Break"><span class="koboSpan" id="kobo.823.1">next section.</span></span></p>
<h4><span class="koboSpan" id="kobo.824.1">Registering PhotoImporter with dependency injection</span></h4>
<p><span class="koboSpan" id="kobo.825.1">Let’s add </span><a id="_idIndexMarker647"/><span class="koboSpan" id="kobo.826.1">the required code to </span><a id="_idIndexMarker648"/><span class="koboSpan" id="kobo.827.1">register the types we have created so far, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.828.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.829.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.830.1">GalleryApp</span></strong><span class="koboSpan" id="kobo.831.1"> project, </span><span class="No-Break"><span class="koboSpan" id="kobo.832.1">open </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.833.1">MauiProgram.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.834.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.835.1">Make the following changes to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.836.1">MauiProgram</span></strong><span class="koboSpan" id="kobo.837.1"> class (the changes </span><span class="No-Break"><span class="koboSpan" id="kobo.838.1">are highlighted):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.839.1">using GalleryApp.Services;</span></strong><span class="koboSpan" id="kobo.840.1">
using Microsoft.Extensions.Logging;
public static class MauiProgram
{
  public static MauiApp CreateMauiApp()
  {
    var builder = MauiApp.CreateBuilder();
    builder
      .UseMauiApp&lt;App&gt;()
      .ConfigureFonts(fonts =&gt;
      {
        fonts.AddFont("OpenSans-Regular.ttf", 
"OpenSansRegular");
        fonts.AddFont("OpenSans-Semibold.ttf", 
"OpenSansSemibold");
      });
#if DEBUG
    builder.Logging.AddDebug();
#endif
  </span><strong class="bold"><span class="koboSpan" id="kobo.841.1">builder.Services.AddSingleton&lt;IPhotoImporter&gt;(serviceProvider </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.842.1">=&gt; new PhotoImporter</span><a id="_idTextAnchor542"/><span class="koboSpan" id="kobo.843.1">());</span></strong><span class="koboSpan" id="kobo.844.1">
    return builder.Build();
  }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.845.1">The .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.846.1">MauiAppBuilder</span></strong><span class="koboSpan" id="kobo.847.1"> class exposes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.848.1">Services</span></strong><span class="koboSpan" id="kobo.849.1"> property, which is the dependency injection container. </span><span class="koboSpan" id="kobo.849.2">We simply need to add the types we want dependency injection to know about and the container will do the rest for us. </span><span class="koboSpan" id="kobo.849.3">Think of a builder </span><a id="_idIndexMarker649"/><span class="koboSpan" id="kobo.850.1">as something that collects a lot of information on what needs to be done, and then builds the object we need. </span><span class="koboSpan" id="kobo.850.2">It’s a </span><a id="_idIndexMarker650"/><span class="koboSpan" id="kobo.851.1">very useful pattern on its own, by </span><span class="No-Break"><span class="koboSpan" id="kobo.852.1">the way.</span></span></p>
<p><span class="koboSpan" id="kobo.853.1">We only use the builder for one thing at the moment. </span><span class="koboSpan" id="kobo.853.2">Later on, we will use it to register any class in the assembly that inherits from our abstract </span><strong class="source-inline"><span class="koboSpan" id="kobo.854.1">ViewModel</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.855.1">class and our views. </span><span class="koboSpan" id="kobo.855.2">The container is now prepared for us to ask for </span><span class="No-Break"><span class="koboSpan" id="kobo.856.1">these types.</span></span></p>
<h3><span class="koboSpan" id="kobo.857.1">Creating a shell</span></h3>
<p><span class="koboSpan" id="kobo.858.1">The main </span><a id="_idIndexMarker651"/><span class="koboSpan" id="kobo.859.1">navigation for this app will be tabs at the bottom of the screen. </span><span class="koboSpan" id="kobo.859.2">The app </span><a id="_idIndexMarker652"/><span class="koboSpan" id="kobo.860.1">will have a fly-out menu with two options—</span><strong class="bold"><span class="koboSpan" id="kobo.861.1">Home</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.862.1">and </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.863.1">Gallery</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.864.1">:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.865.1">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.866.1">Views</span></strong><span class="koboSpan" id="kobo.867.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.868.1">the project.</span></span></li>
<li><span class="koboSpan" id="kobo.869.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.870.1">Views</span></strong><span class="koboSpan" id="kobo.871.1"> folder, create two new files using the </span><strong class="bold"><span class="koboSpan" id="kobo.872.1">.NET MAUI ContentPage (XAML)</span></strong><span class="koboSpan" id="kobo.873.1"> template—one named </span><strong class="source-inline"><span class="koboSpan" id="kobo.874.1">MainView</span></strong><span class="koboSpan" id="kobo.875.1"> and one </span><span class="No-Break"><span class="koboSpan" id="kobo.876.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.877.1">GalleryView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.878.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.879.1">Delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.880.1">MainPage.Xaml</span></strong><span class="koboSpan" id="kobo.881.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.882.1">MainPage.Xaml.cs</span></strong><span class="koboSpan" id="kobo.883.1"> files from the root of the project since we won’t be </span><span class="No-Break"><span class="koboSpan" id="kobo.884.1">needing those.</span></span></li>
<li><span class="koboSpan" id="kobo.885.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.886.1">AppShell.xaml</span></strong><span class="koboSpan" id="kobo.887.1"> file in the root of </span><span class="No-Break"><span class="koboSpan" id="kobo.888.1">the project.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.889.1">Add both views to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.890.1">Shell</span></strong><span class="koboSpan" id="kobo.891.1"> object using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.892.1">ContentTemplate</span></strong><span class="koboSpan" id="kobo.893.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.894.1">ShellContent</span></strong><span class="koboSpan" id="kobo.895.1">. </span><span class="koboSpan" id="kobo.895.2">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.896.1">DataTemplate</span></strong><span class="koboSpan" id="kobo.897.1"> markup extension to load the view from the dependency </span><span class="No-Break"><span class="koboSpan" id="kobo.898.1">injection container:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.899.1">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;Shell
    x:Class="GalleryApp.AppShell"
      
     
    
    </span><strong class="bold"><span class="koboSpan" id="kobo.900.1"/></strong><span class="koboSpan" id="kobo.901.1">&gt;
    </span><strong class="bold"><span class="koboSpan" id="kobo.902.1">&lt;ShellContent Title="Home" ContentTemplate="{DataTemplate views:MainView}" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.903.1">    &lt;ShellContent Title="Gallery" ContentTemplate="{D</span><a id="_idTextAnchor543"/><span class="koboSpan" id="kobo.904.1">ataTemplate views:GalleryView}" /&gt;</span></strong><span class="koboSpan" id="kobo.905.1">
&lt;/Shell&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.906.1">Since the </span><a id="_idIndexMarker653"/><span class="koboSpan" id="kobo.907.1">views are loaded via </span><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">DataTemplates</span></strong><span class="koboSpan" id="kobo.909.1">, they must be </span><a id="_idIndexMarker654"/><span class="koboSpan" id="kobo.910.1">registered with dependency injection. </span><span class="koboSpan" id="kobo.910.2">Add the highlighted code to </span><strong class="source-inline"><span class="koboSpan" id="kobo.911.1">MauiProgram.cs</span></strong><span class="koboSpan" id="kobo.912.1">, after the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.913.1">IPhotoInmporter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.914.1"> line:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.915.1">
        builder.Services.
</span><span class="koboSpan" id="kobo.915.2">AddSingleton&lt;IPhotoImporter&gt;(serviceProvider =&gt; new 
PhotoImporter());
</span><strong class="bold"><span class="koboSpan" id="kobo.916.1">        builder.Services.AddTransient&lt;Views.MainView&gt;();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.917.1">        builder.Services.AddTransient&lt;Views.GalleryView&gt;();</span></strong><span class="koboSpan" id="kobo.918.1">
return builder.Build();</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.919.1">Now that we have created a shell, let’s conti</span><a id="_idTextAnchor544"/><span class="koboSpan" id="kobo.920.1">nue with some other b</span><a id="_idTextAnchor545"/><span class="koboSpan" id="kobo.921.1">ase code before we start to create </span><span class="No-Break"><span class="koboSpan" id="kobo.922.1">the views.</span></span></p>
<h3><span class="koboSpan" id="kobo.923.1">Creating a base view model</span></h3>
<p><span class="koboSpan" id="kobo.924.1">Before we create an actual view model, we will create an abstract base view model that all view </span><a id="_idIndexMarker655"/><span class="koboSpan" id="kobo.925.1">models can inherit from. </span><span class="koboSpan" id="kobo.925.2">The idea behind this base </span><a id="_idIndexMarker656"/><span class="koboSpan" id="kobo.926.1">view model is that we can write common code in it. </span><span class="koboSpan" id="kobo.926.2">In this case, we will implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.927.1">INotifyPropertyChanged</span></strong><span class="koboSpan" id="kobo.928.1"> interface by going through the </span><span class="No-Break"><span class="koboSpan" id="kobo.929.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.930.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.931.1">GalleryApp</span></strong><span class="koboSpan" id="kobo.932.1"> project, create a folder </span><span class="No-Break"><span class="koboSpan" id="kobo.933.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.934.1">ViewModels</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.935.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.936.1">Add a NuGet reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.937.1">CommunityToolkit.Mvvm</span></strong><span class="koboSpan" id="kobo.938.1">; we use </span><strong class="source-inline"><span class="koboSpan" id="kobo.939.1">CommunityToolkit.Mvvm</span></strong><span class="koboSpan" id="kobo.940.1"> for implementing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.941.1">INotifyPropertyChanged</span></strong><span class="koboSpan" id="kobo.942.1"> interface, as we have in </span><span class="No-Break"><span class="koboSpan" id="kobo.943.1">other chapters.</span></span></li>
<li><span class="koboSpan" id="kobo.944.1">Create a new abstract class </span><span class="No-Break"><span class="koboSpan" id="kobo.945.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.946.1">ViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.947.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.948.1">
namespace GalleryApp.ViewModels;
using CommunityToolkit.Mvvm.ComponentModel;
public abstract partial class ViewModel: ObservableObject
{
    [ObservableProperty]
    [NotifyPropertyChangedFor(nameof(IsNotBusy))]
    private bool isBusy;
    public bool IsNotBusy =&gt; !IsBusy;
    abstract protected internal Task Initialize();
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.949.1">In this app’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.950.1">ViewModel</span></strong><span class="koboSpan" id="kobo.951.1"> class, we have added an abstract method for </span><strong class="source-inline"><span class="koboSpan" id="kobo.952.1">Initialize</span></strong><span class="koboSpan" id="kobo.953.1">. </span><span class="koboSpan" id="kobo.953.2">Each </span><strong class="source-inline"><span class="koboSpan" id="kobo.954.1">ViewModel</span></strong><span class="koboSpan" id="kobo.955.1"> implementation will override this method and load the images asynchronously for display. </span><span class="koboSpan" id="kobo.955.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.956.1">IsBusy</span></strong><span class="koboSpan" id="kobo.957.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.958.1">NotIsBusy</span></strong><span class="koboSpan" id="kobo.959.1"> properties are used as flags to indicate when the data has </span><span class="No-Break"><span class="koboSpan" id="kobo.960.1">completed loading.</span></span></p>
<p><span class="koboSpan" id="kobo.961.1">Now, we have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.962.1">ViewModel</span></strong><span class="koboSpan" id="kobo.963.1"> base that we c</span><a id="_idTextAnchor546"/><span class="koboSpan" id="kobo.964.1">an use for all </span><strong class="source-inline"><span class="koboSpan" id="kobo.965.1">ViewModel</span></strong><span class="koboSpan" id="kobo.966.1"> insta</span><a id="_idTextAnchor547"/><a id="_idTextAnchor548"/><a id="_idTextAnchor549"/><span class="koboSpan" id="kobo.967.1">nces that we will create later in </span><span class="No-Break"><span class="koboSpan" id="kobo.968.1">this project.</span></span></p>
<h2 id="_idParaDest-117"><a id="_idTextAnchor550"/><span class="koboSpan" id="kobo.969.1">Creating the gallery view</span></h2>
<p><span class="koboSpan" id="kobo.970.1">Now, we will </span><a id="_idIndexMarker657"/><span class="koboSpan" id="kobo.971.1">start to build the views. </span><span class="koboSpan" id="kobo.971.2">We will start with the gallery view, which will show the photos as a grid. </span><span class="koboSpan" id="kobo.971.3">We will start with </span><strong class="source-inline"><span class="koboSpan" id="kobo.972.1">GalleryViewModel</span></strong><span class="koboSpan" id="kobo.973.1">, and then create </span><strong class="source-inline"><span class="koboSpan" id="kobo.974.1">GalleryView</span></strong><span class="koboSpan" id="kobo.975.1">. </span><span class="koboSpan" id="kobo.975.2">Creating the view model first allows Visual Studio to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.976.1">GalleryViewModel</span></strong><span class="koboSpan" id="kobo.977.1"> definition to check the syntax of the data bindings in the </span><span class="No-Break"><span class="koboSpan" id="kobo.978.1">XAML file.</span></span></p>
<h3><span class="koboSpan" id="kobo.979.1">Creating GalleryViewModel</span></h3>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.980.1">GalleryViewModel</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.981.1">is the class that will be responsible for fetching the data and handling </span><a id="_idIndexMarker658"/><span class="koboSpan" id="kobo.982.1">the view logic. </span><span class="koboSpan" id="kobo.982.2">Because photos will be added asynchronously to the photo collection, we don’t want to set </span><strong class="source-inline"><span class="koboSpan" id="kobo.983.1">IsBusy</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.984.1">to </span><strong class="source-inline"><span class="koboSpan" id="kobo.985.1">false</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.986.1">immediately after we call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.987.1">Get</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.988.1">method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.989.1">PhotoImporter</span></strong><span class="koboSpan" id="kobo.990.1">. </span><span class="koboSpan" id="kobo.990.2">We will instead wait 3 seconds first. </span><span class="koboSpan" id="kobo.990.3">However, we will also add an event listener to the collection so that we can listen for changes. </span><span class="koboSpan" id="kobo.990.4">If the collection changes and there are items in it, we will set </span><strong class="source-inline"><span class="koboSpan" id="kobo.991.1">IsBusy</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.992.1">to </span><strong class="source-inline"><span class="koboSpan" id="kobo.993.1">false</span></strong><span class="koboSpan" id="kobo.994.1">. </span><span class="koboSpan" id="kobo.994.2">Create a class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.995.1">GalleryViewModel</span></strong><span class="koboSpan" id="kobo.996.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.997.1">ViewModels</span></strong><span class="koboSpan" id="kobo.998.1"> folder and add the following code to </span><span class="No-Break"><span class="koboSpan" id="kobo.999.1">implement this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1000.1">
namespace GalleryApp.ViewModels;
using CommunityToolkit.Mvvm.ComponentModel;
using GalleryApp.Models;
using GalleryApp.Services;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
public partial class GalleryViewModel : ViewModel
{
    private readonly IPhotoImporter photoImporter;
    [ObservableProperty]
    public ObservableCollection&lt;Photo&gt; photos;
    public GalleryViewModel(IPhotoImporter photoImporter) : base()
    {
        this.photoImporter = photoImporter;
    }
    override protected internal async Task Initialize()
    {
        IsBusy = true;
        Photos = await photoImporter.Get(0, 20);
        Photos.CollectionChanged += Photos_CollectionChanged;
        await Task.Delay(3000);
        IsBusy = false;
    }
    private void Photos_CollectionChanged(object sender, System.
</span><span class="koboSpan" id="kobo.1000.2">Collections.Specialized.NotifyCollectionChangedEventArgs e)
    {
        if (e.NewItems != null &amp;&amp; e.NewItems.Count &gt; 0)
        {
            IsBusy = false;
            Photos.CollectionChanged -= Photos_CollectionChanged;
        }
    }
}</span></pre> <p><span class="koboSpan" id="kobo.1001.1">Finally, register </span><strong class="source-inline"><span class="koboSpan" id="kobo.1002.1">GalleryViewModel</span></strong><span class="koboSpan" id="kobo.1003.1"> with </span><a id="_idIndexMarker659"/><span class="koboSpan" id="kobo.1004.1">dependency injection </span><span class="No-Break"><span class="koboSpan" id="kobo.1005.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1006.1">MauiProgram</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1007.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1008.1">
        builder.Services.AddSingleton&lt;IphotoImporter&gt;(serviceProvider 
=&gt; new PhotoImporter());
        </span><strong class="bold"><span class="koboSpan" id="kobo.1009.1">builder.Services.AddTransient&lt;ViewModels.GalleryViewModel&gt;();</span></strong><span class="koboSpan" id="kobo.1010.1">
builder.Services.AddTransient&lt;Views.MainView&gt;();
builder.Services.AddTransient&lt;Views.GalleryView&gt;();
return builder.Build();</span></pre> <p><span class="koboSpan" id="kobo.1011.1">Now, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1012.1">GalleryViewModel</span></strong><span class="koboSpan" id="kobo.1013.1"> is ready, so we can start to </span><span class="No-Break"><span class="koboSpan" id="kobo.1014.1">create </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1015.1">GalleryView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1016.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.1017.1">Creating GalleryView</span></h3>
<p><span class="koboSpan" id="kobo.1018.1">First, we will </span><a id="_idIndexMarker660"/><span class="koboSpan" id="kobo.1019.1">create a converter that will convert </span><strong class="source-inline"><span class="koboSpan" id="kobo.1020.1">byte[]</span></strong><span class="koboSpan" id="kobo.1021.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1022.1">Microsft.Maui.Controls.ImageSource</span></strong><span class="koboSpan" id="kobo.1023.1">. </span><span class="koboSpan" id="kobo.1023.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1024.1">GalleryApp</span></strong><span class="koboSpan" id="kobo.1025.1"> project, create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1026.1">Converters</span></strong><span class="koboSpan" id="kobo.1027.1">, and inside the folder, create a new class </span><span class="No-Break"><span class="koboSpan" id="kobo.1028.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1029.1">BytesToImageConverter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1030.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1031.1">
namespace GalleryApp.Converters;
using System.Globalization;
internal class BytesToImageConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object 
parameter, CultureInfo culture)
    {
        if (value != null)
        {
            var bytes = (byte[])value;
            var stream = new MemoryStream(bytes);
            return ImageSource.FromStream(() =&gt; stream);
        }
        return null;
    }
    public object ConvertBack(object value, Type targetType, object 
parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}</span></pre> <p><span class="koboSpan" id="kobo.1032.1">To use </span><a id="_idIndexMarker661"/><span class="koboSpan" id="kobo.1033.1">the converter, we need to add it as a resource. </span><span class="koboSpan" id="kobo.1033.2">We will do this by adding it to </span><span class="No-Break"><span class="koboSpan" id="kobo.1034.1">a </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1035.1">Resource</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.1036.1">
Dictionary</span></strong><span class="koboSpan" id="kobo.1037.1"> object in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1038.1">Resources</span></strong><span class="koboSpan" id="kobo.1039.1"> property </span><span class="No-Break"><span class="koboSpan" id="kobo.1040.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1041.1">GalleryView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1042.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1043.1">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.1044.1">GalleryView.xaml</span></strong><span class="koboSpan" id="kobo.1045.1">, and add the following highlighted code to </span><span class="No-Break"><span class="koboSpan" id="kobo.1046.1">the view:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1047.1">
&lt;ContentPage  
              
</span><strong class="bold"><span class="koboSpan" id="kobo.1048.1">    </span></strong><span class="koboSpan" id="kobo.1049.1">
    x:Class="GalleryApp.Views.GalleryView"
    Title="GalleryView"&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.1050.1">    &lt;ContentPage.Resources&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1051.1">      &lt;ResourceDictionary&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1052.1">        &lt;converters:BytesToImageConverter x:Key="ToImage" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1053.1">      &lt;/ResourceDic</span><a id="_idTextAnchor551"/><span class="koboSpan" id="kobo.1054.1">tionary&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1055.1">    &lt;/ContentPage.Resources&gt;</span></strong><span class="koboSpan" id="kobo.1056.1">
&lt;/ContentPage&gt;</span></pre> <p><span class="koboSpan" id="kobo.1057.1">To be </span><a id="_idIndexMarker662"/><span class="koboSpan" id="kobo.1058.1">able to bind to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1059.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1060.1">, we will set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1061.1">BindingContext</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.1062.1">to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1063.1">GalleryViewModel</span></strong><span class="koboSpan" id="kobo.1064.1">. </span><span class="koboSpan" id="kobo.1064.2">Use the constructor dependency injection in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1065.1">GalleryView.xaml.cs</span></strong><span class="koboSpan" id="kobo.1066.1"> to create an instance </span><span class="No-Break"><span class="koboSpan" id="kobo.1067.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1068.1">GalleryViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1069.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1070.1">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.1071.1">GalleryView.xaml.cs</span></strong><span class="koboSpan" id="kobo.1072.1">, and add the following highlighted code to </span><span class="No-Break"><span class="koboSpan" id="kobo.1073.1">the class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1074.1">
public GalleryView(</span><strong class="bold"><span class="koboSpan" id="kobo.1075.1">GalleryViewModel viewModel</span></strong><span class="koboSpan" id="kobo.1076.1">)
{
    InitializeComponent();
    </span><strong class="bold"><span class="koboSpan" id="kobo.1077.1">BindingContext = viewModel;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1078.1">      MainThread.InvokeOnMainThreadAsync(viewModel.Initialize);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1079.1">}</span></strong></pre> <p><span class="koboSpan" id="kobo.1080.1">First, we modify the constructor so that dependency injection will provide an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1081.1">GalleryViewModel</span></strong><span class="koboSpan" id="kobo.1082.1">. </span><span class="koboSpan" id="kobo.1082.2">That instance is set as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1083.1">BindingContext</span></strong><span class="koboSpan" id="kobo.1084.1"> for the page. </span><span class="koboSpan" id="kobo.1084.2">This object will be used in the XAML bindings of the view. </span><span class="koboSpan" id="kobo.1084.3">Finally, we initialize the view </span><span class="No-Break"><span class="koboSpan" id="kobo.1085.1">model asynchronously.</span></span></p>
<p><span class="koboSpan" id="kobo.1086.1">What we </span><a id="_idIndexMarker663"/><span class="koboSpan" id="kobo.1087.1">will show in this view is a grid with three columns. </span><span class="koboSpan" id="kobo.1087.2">To build this with .NET MAUI, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1088.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1089.1"> control. </span><span class="koboSpan" id="kobo.1089.2">To specify the layout that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1090.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1091.1"> should have, add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1092.1">GridItemsLayout</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.1093.1">element to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1094.1">ItemsLayout</span></strong><span class="koboSpan" id="kobo.1095.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1096.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1097.1">. </span><span class="koboSpan" id="kobo.1097.2">Follow these steps to build </span><span class="No-Break"><span class="koboSpan" id="kobo.1098.1">this view:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1099.1">Navigate </span><span class="No-Break"><span class="koboSpan" id="kobo.1100.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1101.1">GalleryView.xaml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1102.1">.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1103.1">Import the namespaces for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1104.1">GalleryApp.ViewModels</span></strong><span class="koboSpan" id="kobo.1105.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1106.1">GalleryApp.Models</span></strong><span class="koboSpan" id="kobo.1107.1"> as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1108.1">viewModels</span></strong><span class="koboSpan" id="kobo.1109.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1110.1">models</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1111.1">, respectively:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1112.1">

</span><strong class="bold"><span class="koboSpan" id="kobo.1113.1"/></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1114.1"/></strong><span class="koboSpan" id="kobo.1115.1">
x:Class=" GalleryApp.Views.GalleryView"</span></pre></li> <li><span class="koboSpan" id="kobo.1116.1">On </span><strong class="source-inline"><span class="koboSpan" id="kobo.1117.1">ContentPage</span></strong><span class="koboSpan" id="kobo.1118.1">, set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1119.1">x:DataType</span></strong><span class="koboSpan" id="kobo.1120.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1121.1">viewModels:GalleryViewModel</span></strong><span class="koboSpan" id="kobo.1122.1">. </span><span class="koboSpan" id="kobo.1122.2">This makes the bindings compile, which will make our view faster </span><span class="No-Break"><span class="koboSpan" id="kobo.1123.1">to render:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1124.1">
&lt;CollectionView x:Name="Photos" ItemsSource="{Binding Photos}"&gt;
  &lt;CollectionView.ItemsLayout&gt;
    &lt;GridItemsLayout Orientation="Vertical" Span="3" 
HorizontalItemSpacing="0" /&gt;
  &lt;/CollectionView.ItemsLayout&gt;
  &lt;CollectionView.ItemTemplate&gt;
    &lt;DataTemplate x:DataType="models:Photo"&gt;
      &lt;Grid&gt;
        &lt;Image Aspect="AspectFill" Source="{Binding Bytes, 
Converter={StaticResource ToImage}}" HeightRequest="120" /&gt;
      &lt;/Grid&gt;
    &lt;/DataTempla</span><a id="_idTextAnchor552"/><span class="koboSpan" id="kobo.1125.1">te&gt;
  &lt;/CollectionView.ItemTemplate&gt;
&lt;/CollectionView&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1126.1">Now, we can see the photos in the view. </span><span class="koboSpan" id="kobo.1126.2">However, we will also need to create the content that </span><a id="_idIndexMarker664"/><span class="koboSpan" id="kobo.1127.1">will be shown when we don’t have any photos to show as they have not been loaded yet, or if there are no photos available. </span><span class="koboSpan" id="kobo.1127.2">Add the following highlighted code to create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1128.1">DataTemplate</span></strong><span class="koboSpan" id="kobo.1129.1"> object to show when </span><strong class="source-inline"><span class="koboSpan" id="kobo.1130.1">CollectionView</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.1131.1">doesn’t have </span><span class="No-Break"><span class="koboSpan" id="kobo.1132.1">any data:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1133.1">
&lt;CollectionView :Name="Photos" ItemsSource="{Binding Photos}" 
</span><strong class="bold"><span class="koboSpan" id="kobo.1134.1">EmptyView="{Binding}"</span></strong><span class="koboSpan" id="kobo.1135.1">&gt;
…
</span><strong class="bold"><span class="koboSpan" id="kobo.1136.1">  &lt;CollectionView.EmptyViewTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1137.1">    &lt;DataTemplate x:DataType="viewModels:GalleryViewModel"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1138.1">      &lt;Grid&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1139.1">        &lt;ActivityIndicator IsVisible="{Binding IsBusy}" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1140.1">        &lt;Label Text="No photos to import could be found" </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1141.1">IsVisible="{Binding IsNotBusy}" HorizontalOptions="Center" </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1142.1">VerticalOptions="Center" HorizontalTextAlignment="Center" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1143.1">      &lt;/Grid&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1144.1">    &lt;/DataTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1145.1">  &lt;/CollectionView.EmptyViewTemplate&gt;</span></strong><span class="koboSpan" id="kobo.1146.1">
&lt;/CollectionView&gt;</span></pre> <p><span class="koboSpan" id="kobo.1147.1">Now, we can run the app. </span><span class="koboSpan" id="kobo.1147.2">The next </span><a id="_idTextAnchor553"/><span class="koboSpan" id="kobo.1148.1">step is to lo</span><a id="_idTextAnchor554"/><span class="koboSpan" id="kobo.1149.1">ad more photos when a user reaches the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.1150.1">the view.</span></span></p>
<h3><span class="koboSpan" id="kobo.1151.1">Loading photos incrementally</span></h3>
<p><span class="koboSpan" id="kobo.1152.1">To load more than the first 20 items, we will load photos incrementally so that when users scroll </span><a id="_idIndexMarker665"/><span class="koboSpan" id="kobo.1153.1">to the end of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1154.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1155.1">, it will start to load more items. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1156.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1157.1"> has built-in support for loading data incrementally. </span><span class="koboSpan" id="kobo.1157.2">Because we get an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1158.1">ObservableCollection</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.1159.1">object back from the photo importer and data is added asynchronously to it, we need to create an event listener to handle when items are added to the photo importer so that we can add it to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1160.1">ObservableCollection</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.1161.1">instance that we bound to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1162.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1163.1">. </span><span class="koboSpan" id="kobo.1163.2">Create the event listener by navigating to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1164.1">GalleryViewModel.cs</span></strong><span class="koboSpan" id="kobo.1165.1"> and adding the following code at the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.1166.1">the class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1167.1">
private int itemsAdded;
private void Collection_CollectionChanged(object sender, System.
</span><span class="koboSpan" id="kobo.1167.2">Collections.Specialized.NotifyCollectionChangedEventArgs args)
  {
    foreach (Photo photo in args.NewItems)
    {
      itemsAdded++;
      Photos.Add(photo);
    }
    if (itemsAdded == 20)
    {
      var collection = (ObservableCollection&lt;Photo&gt;)sender;
      collection.CollectionChanged -= Collection_CollectionChanged;
    }
  }
  private int currentStartIndex = 0;
  [RelayCommand]
  public async Task LoadMore()
  {
    currentStartIndex += 20;
    itemsAdded = 0;
    var collection = await photoImporter.Get(currentStartIndex, 20);
    collection.CollectionChanged += Collection_CollectionChanged;
  }</span></pre> <p><span class="koboSpan" id="kobo.1168.1">The only </span><a id="_idIndexMarker666"/><span class="koboSpan" id="kobo.1169.1">thing we have left to do to get the incremental load to work is to bind </span><strong class="source-inline"><span class="koboSpan" id="kobo.1170.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1171.1"> to the code we created in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1172.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1173.1">. </span><span class="koboSpan" id="kobo.1173.2">The following code will trigger the loading of more photos when the user has just five </span><span class="No-Break"><span class="koboSpan" id="kobo.1174.1">items left:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1175.1">
&lt;CollectionView x:Name="Photos" EmptyView="{Binding}" 
ItemsSource="{Binding Photos}" </span><strong class="bold"><span class="koboSpan" id="kobo.1176.1">RemainingItemsThreshold="5" </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1177.1">RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}"</span></strong><span class="koboSpan" id="kobo.1178.1">&gt;</span></pre> <p><span class="koboSpan" id="kobo.1179.1">Now that we have a view that </span><a id="_idTextAnchor555"/><span class="koboSpan" id="kobo.1180.1">shows photos and loads them increment</span><a id="_idTextAnchor556"/><span class="koboSpan" id="kobo.1181.1">ally, we can make it possible to add photos </span><span class="No-Break"><span class="koboSpan" id="kobo.1182.1">as favorites.</span></span></p>
<h3><span class="koboSpan" id="kobo.1183.1">Saving favorites</span></h3>
<p><span class="koboSpan" id="kobo.1184.1">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.1185.1">GalleryView</span></strong><span class="koboSpan" id="kobo.1186.1">, we want </span><a id="_idIndexMarker667"/><span class="koboSpan" id="kobo.1187.1">to be able to select favorites that we can show in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1188.1">MainView</span></strong><span class="koboSpan" id="kobo.1189.1">. </span><span class="koboSpan" id="kobo.1189.2">To do that, we need to store the photos that we have selected so that it remembers our selection. </span><span class="koboSpan" id="kobo.1189.3">Create a new interface in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1190.1">GalleryApp</span></strong><span class="koboSpan" id="kobo.1191.1"> project named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1192.1">ILocalStorage</span></strong><span class="koboSpan" id="kobo.1193.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1194.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1195.1"> folder:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1196.1">
public interface ILocalStorage</span><a id="_idTextAnchor557"/><span class="koboSpan" id="kobo.1197.1">
{
  void  Store(string filename);
  List&lt;string&gt; Get();
}</span></pre> <p><span class="koboSpan" id="kobo.1198.1">The easiest </span><a id="_idIndexMarker668"/><span class="koboSpan" id="kobo.1199.1">way to store/persist data in .NET MAUI is to use the built-in property store. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1200.1">Preferences</span></strong><span class="koboSpan" id="kobo.1201.1"> is a static class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1202.1">Microsoft.Maui.Storage</span></strong><span class="koboSpan" id="kobo.1203.1"> namespace. </span><span class="koboSpan" id="kobo.1203.2">Follow these steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.1204.1">use it:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1205.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1206.1">MauiLocalStorage</span></strong><span class="koboSpan" id="kobo.1207.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1208.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1209.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.1210.1">Implement the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1211.1">ILocalStorage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1212.1"> interface:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1213.1">
namespace GalleryApp.Services;
using System.Text.Json;
public class MauiLocalStorage : ILocalStorage
{
  public const string FavoritePhotosKey = "FavoritePhotos";
  public List&lt;string&gt; Get()
  {
    if (Preferences.ContainsKey(FavoritePhotosKey))
    {
      var filenames = Preferences.Get(FavoritePhotosKey,string.Empty);
      return JsonSerializer.Deserialize&lt;List&lt;string&gt;&gt;(filenames);
    }
    return new List&lt;string&gt;();
  }
  public void Store(string filename)
  {
    var filenames = Get();
    filenames.Add(filename);
    var json = JsonSerializer.Serialize(filenames);
    Preferences.Set(FavoritePhotosKey, json);
  }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1214.1">To be able to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1215.1">ILocalStorage</span></strong><span class="koboSpan" id="kobo.1216.1"> with constructor injection, we need to register it with the </span><a id="_idIndexMarker669"/><span class="koboSpan" id="kobo.1217.1">container. </span><span class="koboSpan" id="kobo.1217.2">Navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1218.1">MauiProgram</span></strong><span class="koboSpan" id="kobo.1219.1"> class and add the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1220.1">highlighted code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1221.1">
builder.Services.AddSingleton&lt;IPhotoImporter&gt;(serviceProvider =&gt; new 
PhotoImporter());
</span><strong class="bold"><span class="koboSpan" id="kobo.1222.1">builder.Services.AddTransient&lt;ILocalStorage&gt;(ServiceProvider =&gt; new </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1223.1">MauiLocalStorage());</span><a id="_idTextAnchor558"/></strong><span class="koboSpan" id="kobo.1224.1">
builder.Services.AddTransient&lt;ViewModels.MainViewModel&gt;();</span></pre> <p><span class="koboSpan" id="kobo.1225.1">Now, we are ready to use the </span><span class="No-Break"><span class="koboSpan" id="kobo.1226.1">local storage.</span></span></p>
<p><span class="koboSpan" id="kobo.1227.1">Navigate to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1228.1">GalleryViewModel</span></strong><span class="koboSpan" id="kobo.1229.1"> class, add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1230.1">ILocalStorage</span></strong><em class="italic"> </em><span class="koboSpan" id="kobo.1231.1">interface to the constructor, and assign it to </span><span class="No-Break"><span class="koboSpan" id="kobo.1232.1">a field:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1233.1">
private readonly IPhotoImporter photoImporter;
</span><strong class="bold"><span class="koboSpan" id="kobo.1234.1">private readonly ILocalStorage localStorage;</span></strong><span class="koboSpan" id="kobo.1235.1">
public GalleryViewModel(IPhotoImporter photoImporter, </span><strong class="bold"><span class="koboSpan" id="kobo.1236.1">ILocalStorage </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1237.1">localStorage</span></strong><span class="koboSpan" id="kobo.1238.1">)
{
  this.photoImporter = photoImporter;
  </span><strong class="bold"><span class="koboSpan" id="kobo.1239.1">this.localStorage = localStorage;</span></strong><span class="koboSpan" id="kobo.1240.1">
}</span></pre> <p><span class="koboSpan" id="kobo.1241.1">The next step is to create a command that we can bind to from the view when we select photos. </span><span class="koboSpan" id="kobo.1241.2">The command will monitor which photos we have selected and notify other views that we </span><a id="_idIndexMarker670"/><span class="koboSpan" id="kobo.1242.1">have added favorite photos. </span><span class="koboSpan" id="kobo.1242.2">We will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1243.1">WeakReferenceManager</span></strong><span class="koboSpan" id="kobo.1244.1"> from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1245.1">CommunityToolkit</span></strong><span class="koboSpan" id="kobo.1246.1"> to send messages from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1247.1">GalleryViewModel</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1248.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1249.1">MainViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1250.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1251.1">Follow these steps to implement the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1252.1">GalleryViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1253.1"> side:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1254.1">Create a new class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1255.1">Services</span></strong><span class="koboSpan" id="kobo.1256.1"> folder </span><span class="No-Break"><span class="koboSpan" id="kobo.1257.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1258.1">Messages</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1259.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1260.1">
namespace GalleryApp.Services;
internal static class Messages
{
  public const string FavoritesAddedMessage = 
nameof(FavoritesAddedMessage);
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1261.1">This is used to define the message type we are sending </span><span class="No-Break"><span class="koboSpan" id="kobo.1262.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1263.1">MainViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1264.1">.</span></span></p></li> <li><span class="koboSpan" id="kobo.1265.1">Navigate </span><span class="No-Break"><span class="koboSpan" id="kobo.1266.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1267.1">GalleryViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1268.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1269.1">Create a new method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1270.1">AddFavorites</span></strong><span class="koboSpan" id="kobo.1271.1"> that is attributed to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1272.1">RelayCommand</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1273.1"> type.</span></span></li>
<li><span class="koboSpan" id="kobo.1274.1">Add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1275.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1276.1">
[RelayCommand]
public void AddFavorites(List&lt;Photo&gt; photos)
{
  foreach (var photo in photos)
  {
    localStorage.Store(photo.Filename);
  }
         WeakReferenceMessenger.Default.Send&lt;string&gt;(Messages.
</span><span class="koboSpan" id="kobo.1276.2">FavoritesAddedMessage);
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1277.1">Now, we are </span><a id="_idIndexMarker671"/><span class="koboSpan" id="kobo.1278.1">ready to start working with the view. </span><span class="koboSpan" id="kobo.1278.2">The first thing we will do is make it possible to select photos. </span><span class="koboSpan" id="kobo.1278.3">Navigate to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1279.1">GalleryView.xaml</span></strong><span class="koboSpan" id="kobo.1280.1"> and set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1281.1">SelectionMode</span></strong><span class="koboSpan" id="kobo.1282.1"> mode of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1283.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1284.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1285.1">Multiple</span></strong><span class="koboSpan" id="kobo.1286.1"> to make it possible to select </span><span class="No-Break"><span class="koboSpan" id="kobo.1287.1">multiple items:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1288.1">
&lt;CollectionView x:Name="Photos" 
EmptyView="{Binding}" ItemsSource="{Binding Photos}" 
</span><strong class="bold"><span class="koboSpan" id="kobo.1289.1">SelectionMode="Multiple"</span></strong><span class="koboSpan" id="kobo.1290.1"> RemainingItemsThreshold="5" 
RemainingItemsThresholdReachedCommand="{Binding LoadMore}"&gt;</span></pre> <p><span class="koboSpan" id="kobo.1291.1">When a user selects a photo, we want it to be clear which photos have been selected. </span><span class="koboSpan" id="kobo.1291.2">To achieve this, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1292.1">VisualStateManager</span></strong><span class="koboSpan" id="kobo.1293.1">. </span><span class="koboSpan" id="kobo.1293.2">We will do this by creating a style for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1294.1">Grid</span></strong><span class="koboSpan" id="kobo.1295.1"> and setting </span><strong class="source-inline"><span class="koboSpan" id="kobo.1296.1">Opacity</span></strong><span class="koboSpan" id="kobo.1297.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1298.1">0.5</span></strong><span class="koboSpan" id="kobo.1299.1">, as in the following code. </span><span class="koboSpan" id="kobo.1299.2">Add the code to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1300.1">Resources</span></strong><span class="koboSpan" id="kobo.1301.1"> of </span><span class="No-Break"><span class="koboSpan" id="kobo.1302.1">the page:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1303.1">
&lt;ContentPage.Resources&gt;
  &lt;ResourceDictionary&gt;
    &lt;converters:BytesToImageConverter x:Key="ToImage" /&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.1304.1">      &lt;Style TargetType="Grid"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1305.1">        &lt;Setter Property="VisualStateManager.VisualStateGroups"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1306.1">          &lt;VisualStateGroupList&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1307.1">            &lt;VisualStateGroup x:Name="CommonStates"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1308.1">              &lt;VisualState x:Name="Normal" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1309.1">                &lt;VisualState x:Name="Selected"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1310.1">                  &lt;VisualState.Setters&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1311.1">                    &lt;Setter Property="Opacity" Value="0.5" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1312.1">                &lt;/VisualState.Setters&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1313.1">              &lt;/VisualState&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1314.1">            &lt;/VisualStateGroup&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1315.1">          &lt;/VisualStateGroupList&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1316.1">        &lt;/Setter&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1317.1">      &lt;/Style&gt;</span></strong><span class="koboSpan" id="kobo.1318.1">
  &lt;/ResourceDictionary&gt;
&lt;/ContentPage.Resources&gt;</span></pre> <p><span class="koboSpan" id="kobo.1319.1">To save </span><a id="_idIndexMarker672"/><span class="koboSpan" id="kobo.1320.1">the selected photos, we will create a toolbar item that the user </span><span class="No-Break"><span class="koboSpan" id="kobo.1321.1">can tap:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1322.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1323.1">ToolbarItem</span></strong><span class="koboSpan" id="kobo.1324.1"> with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1325.1">Text</span></strong><span class="koboSpan" id="kobo.1326.1"> property set </span><span class="No-Break"><span class="koboSpan" id="kobo.1327.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1328.1">Select</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1329.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1330.1">Add an event handler </span><span class="No-Break"><span class="koboSpan" id="kobo.1331.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1332.1">SelectToolBarItem_Clicked</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1333.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1334.1">
&lt;ContentPage.ToolbarItems&gt;
    &lt;ToolbarItem Text="Select" Clicked="SelectToolBarItem_
Clicked" /&gt;
&lt;/ContentPage.ToolbarItems&gt;</span></pre></li> <li><span class="koboSpan" id="kobo.1335.1">Navigate to the code behind the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1336.1">GalleryView.xaml.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1337.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.1338.1">Add the following </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1339.1">using</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1340.1"> statements:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1341.1">
using GalleryApp.Models;
using GalleryApp.ViewModels;</span></pre></li> <li><span class="koboSpan" id="kobo.1342.1">Create an event handler </span><span class="No-Break"><span class="koboSpan" id="kobo.1343.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1344.1">SelectToolBarItem_Clicked</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1345.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1346.1">
private void SelectToolBarItem_Clicked(object sender, EventArgs e)
  {
    if (!Photos.SelectedItems.Any())
    {
      DisplayAlert("No photos", "No photos selected", "OK");
      return;
    }
    var viewModel = (GalleryViewModel)BindingContext;
         viewModel.AddFavoritesCommand.Execute(Photos.
</span><span class="koboSpan" id="kobo.1346.2">SelectedItems.Select(x =&gt;(Photo)x).ToList());
    DisplayAlert("Added", "Selected photos have been added to 
favorites", "OK");
  }</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1347.1">Now that </span><a id="_idIndexMarker673"/><span class="koboSpan" id="kobo.1348.1">we are d</span><a id="_idTextAnchor559"/><span class="koboSpan" id="kobo.1349.1">one with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1350.1">GalleryView</span></strong><span class="koboSpan" id="kobo.1351.1">, we will continue with the main view, which will </span><a id="_idTextAnchor560"/><span class="koboSpan" id="kobo.1352.1">show the latest photos and the favorite photos in </span><span class="No-Break"><span class="koboSpan" id="kobo.1353.1">two carousels.</span></span></p>
<h3><span class="koboSpan" id="kobo.1354.1">Creating the carousels for MainView</span></h3>
<p><span class="koboSpan" id="kobo.1355.1">The last </span><a id="_idIndexMarker674"/><span class="koboSpan" id="kobo.1356.1">view in this app is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1357.1">MainView</span></strong><span class="koboSpan" id="kobo.1358.1">, which is the view that is visible when users start the app. </span><span class="koboSpan" id="kobo.1358.2">This view will sho</span><a id="_idTextAnchor561"/><span class="koboSpan" id="kobo.1359.1">w two ca</span><a id="_idTextAnchor562"/><span class="koboSpan" id="kobo.1360.1">rousel views—one with recent photos and one with </span><span class="No-Break"><span class="koboSpan" id="kobo.1361.1">favorite photos.</span></span></p>
<h3><span class="koboSpan" id="kobo.1362.1">Creating the view model for MainView</span></h3>
<p><span class="koboSpan" id="kobo.1363.1">We will </span><a id="_idIndexMarker675"/><span class="koboSpan" id="kobo.1364.1">start by creating </span><strong class="source-inline"><span class="koboSpan" id="kobo.1365.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1366.1"> that we will use for the view. </span><span class="koboSpan" id="kobo.1366.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1367.1">ViewModel</span></strong><span class="koboSpan" id="kobo.1368.1"> folder, create a new class </span><span class="No-Break"><span class="koboSpan" id="kobo.1369.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1370.1">MainViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1371.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1372.1">
namespace GalleryApp.ViewModels;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Messaging;
using GalleryApp.Models;
using GalleryApp.Services;
using System.Collections.ObjectModel;
public partial class MainViewModel : ViewModel
{
  private readonly IPhotoImporter photoImporter;
  private readonly ILocalStorage localStorage;
  [ObservableProperty]
  private ObservableCollection&lt;Photo&gt; recent;
  [ObservableProperty]
  private ObservableCollection&lt;Photo&gt; favorites;
  public MainViewModel(IPhotoImporter photoImporter, ILocalStorage 
localStorage)
  {
    this.photoImporter = photoImporter;
    this.localStorage = localStorage;
  }
  override protected internal async Task Initialize()
  {
    var photos = await photoImporter.Get(0, 20, Quality.Low);
    Recent = photos;
    await LoadFavorites();
        WeakReferenceMessenger.Default.Register&lt;string&gt;(this, async 
(sender, message) =&gt; {
      if( message == Messages.FavoritesAddedMessage )
      {
        await MainThread.InvokeOnMainThreadAsync(LoadFavorites);
      }
    });
  }
  private async Task LoadFavorites()
  {
    var filenames = localStorage.Get();
    var favorites = await photoImporter.Get(filenames, Quality.Low);
    Favorites = favorites;
  }
}</span></pre> <p><span class="koboSpan" id="kobo.1373.1">In the preceding code, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1374.1">Initialize</span></strong><span class="koboSpan" id="kobo.1375.1"> method is used to register a callback </span><span class="No-Break"><span class="koboSpan" id="kobo.1376.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1377.1">Weak</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.1378.1">
ReferenceManager</span></strong><span class="koboSpan" id="kobo.1379.1">. </span><span class="koboSpan" id="kobo.1379.2">This callback invokes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1380.1">LoadFavorites</span></strong><span class="koboSpan" id="kobo.1381.1"> method if the message sent was </span><strong class="source-inline"><span class="koboSpan" id="kobo.1382.1">Message.FavoritesAddedMessage</span></strong><span class="koboSpan" id="kobo.1383.1">. </span><span class="koboSpan" id="kobo.1383.2">Recall </span><span class="No-Break"><span class="koboSpan" id="kobo.1384.1">that </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1385.1">Messages.Favorites</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.1386.1">
AddedMessage</span></strong><span class="koboSpan" id="kobo.1387.1"> is sent from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1388.1">GalleryViewModel</span></strong><span class="koboSpan" id="kobo.1389.1"> after selecting </span><span class="No-Break"><span class="koboSpan" id="kobo.1390.1">new photos.</span></span></p>
<p><span class="koboSpan" id="kobo.1391.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1392.1">LoadFavorites</span></strong><span class="koboSpan" id="kobo.1393.1"> method, the favorites are loaded from the storage provider instance in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1394.1">localStorage</span></strong><span class="koboSpan" id="kobo.1395.1">. </span><span class="koboSpan" id="kobo.1395.2">Then, the photos from the favorites are imported using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1396.1">photoImporter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1397.1"> instance.</span></span></p>
<p><span class="koboSpan" id="kobo.1398.1">We need </span><a id="_idIndexMarker676"/><span class="koboSpan" id="kobo.1399.1">to add the view model to dependency injection so that we can use it in the view. </span><span class="koboSpan" id="kobo.1399.2">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.1400.1">MauiProgram</span></strong><span class="koboSpan" id="kobo.1401.1"> and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1402.1">highlighted code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1403.1">
        builder.Services.AddTransient&lt;ILocalStorage&gt;(ServiceProvider 
=&gt; new MauiLocalStorage());
</span><strong class="bold"><span class="koboSpan" id="kobo.1404.1">        builder.Services.AddTransient&lt;ViewModels.MainViewModel&gt;();</span></strong><span class="koboSpan" id="kobo.1405.1">
        builder.Services.AddTransient&lt;ViewModels.GalleryVie</span><a id="_idTextAnchor563"/><span class="koboSpan" id="kobo.1406.1">wModel&gt;();</span></pre> <p><span class="koboSpan" id="kobo.1407.1">Now that we h</span><a id="_idTextAnchor564"/><span class="koboSpan" id="kobo.1408.1">ave created </span><strong class="source-inline"><span class="koboSpan" id="kobo.1409.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.1410.1">, we will continue with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1411.1">latest photos.</span></span></p>
<h3><span class="koboSpan" id="kobo.1412.1">Showing the latest photos</span></h3>
<p><span class="koboSpan" id="kobo.1413.1">We are </span><a id="_idIndexMarker677"/><span class="koboSpan" id="kobo.1414.1">now ready to set up the carousel views. </span><span class="koboSpan" id="kobo.1414.2">We have already created the view model, so we can use the view model to populate the view </span><span class="No-Break"><span class="koboSpan" id="kobo.1415.1">with content.</span></span></p>
<p><span class="koboSpan" id="kobo.1416.1">Let’s look at the steps to create </span><span class="No-Break"><span class="koboSpan" id="kobo.1417.1">the view:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1418.1">In the constructor of the code, behind the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1419.1">MainView.xaml.cs</span></strong><span class="koboSpan" id="kobo.1420.1"> file, set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1421.1">ViewModel</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1422.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1423.1">BindingContext</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1424.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1425.1">
public MainView(</span><strong class="bold"><span class="koboSpan" id="kobo.1426.1">MainViewModel viewModel</span></strong><span class="koboSpan" id="kobo.1427.1">)
{
  InitializeComponent();
  </span><strong class="bold"><span class="koboSpan" id="kobo.1428.1">BindingContext = viewModel;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1429.1">        MainThread.InvokeOnMainThreadAsync(viewModel.Initialize);</span></strong><span class="koboSpan" id="kobo.1430.1">
    }</span></pre></li> <li><span class="koboSpan" id="kobo.1431.1">Navigate </span><span class="No-Break"><span class="koboSpan" id="kobo.1432.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1433.1">MainView.xaml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1434.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1435.1">Add the </span><a id="_idIndexMarker678"/><span class="No-Break"><span class="koboSpan" id="kobo.1436.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1437.1">
&lt;ContentPage 
             
    
    
    
    x:Class="GalleryApp.Views.MainView"
    x:DataType="viewModels:MainViewModel"
    Title="My Photos"&gt;
  &lt;ContentPage.Resources&gt;
    &lt;ResourceDictionary&gt;
      &lt;converters:BytesToImageConverter x:Key="ToImage" /&gt;
    &lt;/ResourceDictionary&gt;
  &lt;/ContentPage.Resources&gt;
  &lt;Grid&gt;
    &lt;Grid.RowDefinitions&gt;
      &lt;RowDefinition Height="*" /&gt;
      &lt;RowDefinition Height="50" /&gt;
      &lt;RowDefinition Height="*" /&gt;
      &lt;RowDefinition Height="20" /&gt;
    &lt;/Grid.RowDefinitions&gt;
    &lt;CarouselView ItemsSource="{Binding Recent}" 
PeekAreaInsets="40,0,40,0" &gt;
      &lt;CarouselView.ItemsLayout&gt;
        &lt;LinearItemsLayout Orientation="Horizontal"  SnapPointsAlignment="Start" 
SnapPointsType="Mandatory" /&gt;
      &lt;/CarouselView.ItemsLayout&gt;
      &lt;CarouselView.ItemTemplate&gt;
        &lt;DataTemplate x:DataType="models:Photo"&gt;
          &lt;Image Source="{Binding Bytes, 
Converter={StaticResource ToImage}}" Aspect="AspectFill" /&gt;
        &lt;/DataTemplate&gt;
      &lt;/CarouselView.ItemTemplate&gt;
    &lt;/CarouselView&gt;
  &lt;/Grid&gt;
&lt;/ContentPage&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1438.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1439.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1440.1"> control is used to present data to the user in a scrollable layout, where the user can swipe to move through the collection of items. </span><span class="koboSpan" id="kobo.1440.2">It is very similar to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1441.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1442.1">; however, the uses of the two controls are different. </span><span class="koboSpan" id="kobo.1442.2">You would use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1443.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1444.1"> when you want to display a list of items with </span><a id="_idIndexMarker679"/><span class="koboSpan" id="kobo.1445.1">an indeterminate length, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1446.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1447.1"> is used to highlight items from a list of items with a limited length. </span><span class="koboSpan" id="kobo.1447.2">Since </span><strong class="source-inline"><span class="koboSpan" id="kobo.1448.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1449.1"> shares implementations with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1450.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1451.1"> control, it uses the familiar </span><strong class="source-inline"><span class="koboSpan" id="kobo.1452.1">ItemTemplate</span></strong><span class="koboSpan" id="kobo.1453.1"> property to customize how each item is displayed. </span><span class="koboSpan" id="kobo.1453.2">It adds an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1454.1">ItemsLayout</span></strong><span class="koboSpan" id="kobo.1455.1"> property to define how the collection of items is displayed. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1456.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1457.1"> can use either a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1458.1">Horizontal</span></strong><span class="koboSpan" id="kobo.1459.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1460.1">Vertical</span></strong><span class="koboSpan" id="kobo.1461.1"> layout direction, with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1462.1">Horizontal</span></strong><span class="koboSpan" id="kobo.1463.1"> being </span><span class="No-Break"><span class="koboSpan" id="kobo.1464.1">the default.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.1465.1">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.1466.1">MainView</span></strong><span class="koboSpan" id="kobo.1467.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1468.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1469.1"> is used to display the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1470.1">Recent</span></strong><span class="koboSpan" id="kobo.1471.1"> photos from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1472.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.1473.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1474.1">ItemsLayout</span></strong><span class="koboSpan" id="kobo.1475.1"> is customized to set the scrolling behavior so that items will snap into view using the start, or left edge of the image. </span><span class="koboSpan" id="kobo.1475.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1476.1">SnapPointType</span></strong><span class="koboSpan" id="kobo.1477.1"> property set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1478.1">Mandatory</span></strong><span class="koboSpan" id="kobo.1479.1"> makes sure that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1480.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1481.1"> snaps the image into place after scrolling, which would ensure a single image is always </span><span class="No-Break"><span class="koboSpan" id="kobo.1482.1">in view.</span></span></p><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.1483.1">ItemsTemplate</span></strong><span class="koboSpan" id="kobo.1484.1"> is used to display an image that is data-bound to each photo and displays the image from the bytes in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1485.1">Photo</span></strong><span class="koboSpan" id="kobo.1486.1"> model. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1487.1">BytesToImageConverter</span></strong><span class="koboSpan" id="kobo.1488.1"> converts the byte array from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1489.1">Photo</span></strong><span class="koboSpan" id="kobo.1490.1"> model into </span><strong class="source-inline"><span class="koboSpan" id="kobo.1491.1">ImageSource</span></strong><span class="koboSpan" id="kobo.1492.1"> that can be displayed by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1493.1">Image</span></strong><span class="koboSpan" id="kobo.1494.1"> control. </span><span class="koboSpan" id="kobo.1494.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1495.1">Image</span></strong><span class="koboSpan" id="kobo.1496.1"> control has the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1497.1">Aspect</span></strong><span class="koboSpan" id="kobo.1498.1"> property set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1499.1">AspectFill</span></strong><span class="koboSpan" id="kobo.1500.1">, allowing the image control to resize the image, maintaining the aspect ratio of the source image to fill the available </span><span class="No-Break"><span class="koboSpan" id="kobo.1501.1">visible space.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.1502.1">Now that we have sho</span><a id="_idTextAnchor565"/><span class="koboSpan" id="kobo.1503.1">wn the latest photos in a carousel, the next (</span><a id="_idTextAnchor566"/><span class="koboSpan" id="kobo.1504.1">and the last) step is to show the favorite photos in </span><span class="No-Break"><span class="koboSpan" id="kobo.1505.1">another carousel.</span></span></p>
<h3><span class="koboSpan" id="kobo.1506.1">Showing the favorite photos</span></h3>
<p><span class="koboSpan" id="kobo.1507.1">The last thing we will do in this app is add a carousel to show favorite photos. </span><span class="koboSpan" id="kobo.1507.2">Add the following </span><a id="_idIndexMarker680"/><span class="koboSpan" id="kobo.1508.1">highlighted code inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.1509.1">Grid</span></strong><span class="koboSpan" id="kobo.1510.1">, after the first </span><strong class="source-inline"><span class="koboSpan" id="kobo.1511.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1512.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1513.1">code snippet:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1514.1">
&lt;Grid&gt;
  &lt;!—Code omitted for brevity --&gt;
  &lt;CarouselView&gt;
    &lt;!—Code omitted for brevity --&gt;
  &lt;/CarouselView&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.1515.1">  &lt;Label Grid.Row="1" Margin="10" Text="Favorites" FontSize="Subtitle" </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1516.1">FontAttributes="Bold" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1517.1">  &lt;CarouselView Grid.Row="2" ItemsSource="{Binding Favorites}" </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1518.1">PeekAreaInsets="0,0,40,0" IndicatorView="Indicator"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1519.1">    &lt;CarouselView.ItemsLayout&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1520.1">      &lt;LinearItemsLayout Orientation="Horizontal" </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1521.1">SnapPointsAlignment="Start" SnapPointsType="MandatorySingle" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1522.1">    &lt;/CarouselView.ItemsLayout&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1523.1">    &lt;CarouselView.EmptyViewTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1524.1">      &lt;DataTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1525.1">        &lt;Label Text="No favorites selected" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1526.1">      &lt;/DataTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1527.1">    &lt;/CarouselView.EmptyViewTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1528.1">    &lt;CarouselView.ItemTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1529.1">      &lt;DataTemplate x:DataType="models:Photo"&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1530.1">        &lt;Border Grid.RowSpan="2" StrokeShape="RoundRectangle </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1531.1">15,15,15,15" Padding="0" Margin="0,0,0,0" BackgroundColor="#667788" &gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1532.1">          &lt;Image Source="{Binding Bytes, Converter={StaticResource </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1533.1">ToImage}}" Aspect="AspectFill" /&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1534.1">        &lt;/Border&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1535.1">      &lt;/DataTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1536.1">    &lt;/CarouselView.ItemTemplate&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1537.1">  &lt;/CarouselView&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1538.1">  &lt;IndicatorView Grid.Row="3" x:Name="Indicator" HorizontalOptions="Center" SelectedIndicatorColor="Red" IndicatorColor="LightGray" /&gt;</span></strong><span class="koboSpan" id="kobo.1539.1">
&lt;/Grid&gt;</span></pre> <p><span class="koboSpan" id="kobo.1540.1">For the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1541.1">Favorites</span></strong><span class="koboSpan" id="kobo.1542.1"> photos, again, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1543.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1544.1"> is used with a few changes from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1545.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1546.1"> displaying the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1547.1">Recent</span></strong><span class="koboSpan" id="kobo.1548.1"> photos. </span><span class="koboSpan" id="kobo.1548.2">The most visible change is that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1549.1">ItemsLayout</span></strong><span class="koboSpan" id="kobo.1550.1"> property is now using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1551.1">MandatorySingle</span></strong><span class="koboSpan" id="kobo.1552.1"> for the value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1553.1">SnapPointsType</span></strong><span class="koboSpan" id="kobo.1554.1">. </span><span class="koboSpan" id="kobo.1554.2">This forces a behavior that only allows the user to swipe one image at </span><a id="_idIndexMarker681"/><span class="koboSpan" id="kobo.1555.1">a time, snapping each image </span><span class="No-Break"><span class="koboSpan" id="kobo.1556.1">into view.</span></span></p>
<p><span class="koboSpan" id="kobo.1557.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1558.1">ItemTemplate</span></strong><span class="koboSpan" id="kobo.1559.1"> property has also been changed to add a rounded border around each image, with a </span><span class="No-Break"><span class="koboSpan" id="kobo.1560.1">background color.</span></span></p>
<p><span class="koboSpan" id="kobo.1561.1">New to this </span><strong class="source-inline"><span class="koboSpan" id="kobo.1562.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1563.1"> is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1564.1">EmptyViewTemplate</span></strong><span class="koboSpan" id="kobo.1565.1"> property. </span><span class="koboSpan" id="kobo.1565.2">This is used to display the text </span><strong class="source-inline"><span class="koboSpan" id="kobo.1566.1">"No favorites selected"</span></strong><span class="koboSpan" id="kobo.1567.1"> when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1568.1">Favorites</span></strong><span class="koboSpan" id="kobo.1569.1"> property </span><span class="No-Break"><span class="koboSpan" id="kobo.1570.1">is empty.</span></span></p>
<p><span class="koboSpan" id="kobo.1571.1">Finally, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1572.1">IndicatorView</span></strong><span class="koboSpan" id="kobo.1573.1"> was added to provide the user with a visual cue of how many items are in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1574.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1575.1"> and which item is currently displayed. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1576.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1577.1"> is connected to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1578.1">IndicatorView</span></strong><span class="koboSpan" id="kobo.1579.1"> by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1580.1">IndicatorView</span></strong><span class="koboSpan" id="kobo.1581.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1582.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1583.1">. </span><span class="koboSpan" id="kobo.1583.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1584.1">IndicatoryView</span></strong><span class="koboSpan" id="kobo.1585.1"> property is set to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1586.1">x:Name</span></strong><span class="koboSpan" id="kobo.1587.1"> property of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1588.1">IndicatorView</span></strong><span class="koboSpan" id="kobo.1589.1">. </span><span class="koboSpan" id="kobo.1589.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1590.1">IndicatorView</span></strong><span class="koboSpan" id="kobo.1591.1"> displays on the page as a series of horizontal light gray dots, with the dot representing the current image </span><span class="No-Break"><span class="koboSpan" id="kobo.1592.1">in red.</span></span></p>
<p><span class="koboSpan" id="kobo.1593.1">That is all—now, we </span><a id="_idIndexMarker682"/><span class="koboSpan" id="kobo.1594.1">can run the app and see both </span><a id="_idTextAnchor567"/><span class="koboSpan" id="kobo.1595.1">the most recent photos and the photos that have been marked </span><span class="No-Break"><span class="koboSpan" id="kobo.1596.1">as favorites.</span></span></p>
<h1 id="_idParaDest-118"><a id="_idTextAnchor568"/><span class="koboSpan" id="kobo.1597.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1598.1">In this chapter, we focused on photos. </span><span class="koboSpan" id="kobo.1598.2">We learned how to import photos from the platform-specific photo galleries and how we can display them as a grid using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1599.1">CollectionView</span></strong><span class="koboSpan" id="kobo.1600.1"> and in carousels using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1601.1">CarouselView</span></strong><span class="koboSpan" id="kobo.1602.1">. </span><span class="koboSpan" id="kobo.1602.2">This makes it possible for us to build other apps and provides multiple options for presenting data to users, as we can now pick the best method for </span><span class="No-Break"><span class="koboSpan" id="kobo.1603.1">the situation.</span></span></p>
<p><span class="koboSpan" id="kobo.1604.1">Additionally, we learned about permissions and how to check and request permission to use protected resources in </span><span class="No-Break"><span class="koboSpan" id="kobo.1605.1">our app.</span></span></p>
<p><span class="koboSpan" id="kobo.1606.1">If you are interested in extending the app even further, try creating a page to view the details of the photo, or to view the photo in full screen by tapping on </span><span class="No-Break"><span class="koboSpan" id="kobo.1607.1">the photo.</span></span></p>
<p><span class="koboSpan" id="kobo.1608.1">In the next chapter, we will build an app using location services and look at how to visualize location data on </span><span class="No-Break"><span class="koboSpan" id="kobo.1609.1">a map.</span></span></p>
</div>
</body></html>