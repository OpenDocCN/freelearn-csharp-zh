<html><head></head><body>
        

                            
                    <h1 class="header-title">Consuming Diagnostic Analyzers in .NET Projects</h1>
                
            
            
                
<p>In the previous chapter, we showed you how to write diagnostic analyzers to analyze and report issues about the .NET source code and contribute them to the .NET developer community. In this chapter, we will show you how to search, install, view, and configure the analyzers that have already been published by various analyzer authors on NuGet and the VS extension gallery. We will cover the following recipes:</p>
<ul>
<li>Searching and installing analyzers through the NuGet package manager</li>
<li>Searching and installing VSIX analyzers through the VS extension gallery</li>
<li>Viewing and configuring analyzers in the solution explorer in Visual Studio</li>
<li>Using the ruleset file and Rule Set editor to configure analyzers</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Introduction</h1>
                
            
            
                
<p>Diagnostic analyzers are extensions to the Roslyn C# compiler and Visual Studio IDE to analyze user code and report diagnostics. The user will see these diagnostics in the error list after building the project from Visual Studio and even when building the project on the command line. They will also see the diagnostics live while editing the source code in the Visual Studio IDE. Analyzers can report diagnostics to enforce specific code styles, improve code quality and maintenance, recommend design guidelines, or even report very domain-specific issues, which cannot be covered by the core compiler.</p>
<p>Analyzers can be installed in a .NET project either as a NuGet package or as a VSIX. To get a better understanding of these packaging schemes and learn about the differences in the analyzer experience when installed as a NuGet package versus a VSIX, it is recommended that you read the introduction part of the recipe <em>Publishing NuGet package and VSIX for an analyzer project</em> in <a href="9928750a-c427-42e6-b8a2-cf67eb5465af.xhtml">Chapter 1</a>, <em>Writing Diagnostic Analyzers</em>.</p>
<p>Analyzers are supported on various different flavors of .NET Standard, .NET Core, and .NET Framework projects, for example, class library, console app, and so on.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Searching and installing analyzers through the NuGet package manager</h1>
                
            
            
                
<p>In this recipe, we will show you how to search and install analyzer NuGet packages in the NuGet package manager in Visual Studio, and see the analyzer diagnostics from an installed NuGet package shown in project build and as live diagnostics during code editing in Visual Studio.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>You will need to have Visual Studio 2017 installed on your machine for this recipe. You can install a free community version of Visual Studio 2017 from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Create a C# class library project, say <kbd>ClassLibrary</kbd><em>,</em> in Visual Studio 2017.</li>
<li>In solution explorer, right-click on the solution or project node and execute the Manage NuGet Packages command:<br/></li>
</ol>
<div><img class="image-border" height="441" src="img/217b4155-cf3f-49c4-bd05-5ab20c6c8722.png" width="444"/></div>
<ol start="3">
<li>This brings up the NuGet Package Manager, which can be used to search and install NuGet packages to the solution or project:</li>
</ol>
<div><img class="image-border" height="388" src="img/f2f05852-6c78-4ebf-8e9b-351a05676076.png" width="671"/></div>
<ol start="4">
<li>In the search bar, type the following text to find NuGet packages tagged as analyzers : <kbd>Tags:"analyzers"</kbd>.</li>
</ol>
<p>Note that some of the well-known packages are tagged as <kbd>analyzer</kbd>, so you may also want to search for <kbd>Tags:"analyzer"</kbd><em><em>.</em></em></p>
<ol start="5">
<li>Check or uncheck the Include prerelease checkbox to the right of the search bar to search or hide the pre-release analyzer packages, respectively. The packages are listed based on the number of downloads, with the highest downloaded package at the top:</li>
</ol>
<div><img class="image-border" height="405" src="img/5b076f43-300d-4792-abbf-4a033cd15b6d.png" width="701"/></div>
<ol start="6">
<li>Select a package to install, say <kbd>System.Runtime.Analyzers</kbd>, and pick a specific version, say <em>1.1.0</em>, and click on Install:</li>
</ol>
<div><img class="image-border" height="358" src="img/1561fbb1-97cb-409f-9271-735374a8c9db.png" width="671"/></div>
<ol start="7">
<li>Click on the I Accept button on the License Acceptance dialog to install the NuGet package.</li>
</ol>
<p>Â </p>
<ol start="8">
<li>Verify the installed analyzer(s) that shows up under the Analyzers node in the solution explorer:</li>
</ol>
<div><img class="image-border" height="429" src="img/b6a0894b-b946-47de-ae30-77b47a3b48f4.png" width="415"/></div>
<ol start="9">
<li>Verify that the project file has a new <kbd>ItemGroup</kbd> with the following analyzer references from the installed analyzer package:</li>
</ol>
<pre style="padding-left: 90px">
<em>&lt;ItemGroup&gt;<br/> &lt;Analyzer Include="..\packages\System.Runtime.Analyzers.1.1.0\analyzers\dotnet\cs\System.Runtime.Analyzers.dll" /&gt;<br/> &lt;Analyzer Include="..\packages\System.Runtime.Analyzers.1.1.0\analyzers\dotnet\cs\System.Runtime.CSharp.Analyzers.dll" /&gt;<br/> &lt;/ItemGroup&gt;</em>
</pre>
<ol start="10">
<li>Add the following code to your C# project:</li>
</ol>
<pre style="padding-left: 90px">
namespace ClassLibrary<br/>{<br/>  public class MyAttribute : System.Attribute<br/>  {<br/>  }<br/>}
</pre>
<ol start="11">
<li>Verify the analyzer diagnostic from the installed analyzer that is shown in the error list:</li>
</ol>
<div><img class="image-border" height="449" src="img/4b52cd14-fc2c-4dfe-94a2-f8ce0879635f.png" width="983"/></div>
<ol start="12">
<li>Open Developer Command Prompt for VS 2017 and build the project to verify that the analyzer is executed on the command-line build and that the analyzer diagnostic is reported:</li>
</ol>
<p style="padding-left: 60px"><img class="image-border" height="330" src="img/f8691f86-51bf-4e92-8c5b-8b42c11bd6ed.png" width="800"/></p>
<ol start="13">
<li>Create a new C# project in VS 2017 and add the same code to it as step 10. Verify that no analyzer diagnostic shows up in the error list or command line, confirming that the analyzer package was only installed to the selected project in steps 1-6.</li>
</ol>
<p>Note that <strong>CA1018</strong> (<em>the custom attribute should have AttributeUsage defined</em>) has been moved to a separate analyzer assembly in future versions of the <kbd>FxCop/System.Runtime.Analyzers</kbd> package. It is recommended that you install the <kbd>Microsoft.CodeAnalysis.FxCopAnalyzers</kbd> NuGet package from ( <a href="https://www.nuget.org/packages/Microsoft.CodeAnalysis.FxCopAnalyzers">https://www.nuget.org/packages/Microsoft.CodeAnalysis.FxCopAnalyzers</a>)to get the latest group of Microsoft-recommended analyzers.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Searching and installing VSIX analyzers through the VS extension gallery</h1>
                
            
            
                
<p>In this recipe, we will show you how to search and install analyzer VSIX packages in the Visual Studio extension manager and see how the analyzer diagnostics from an installed VSIX light up as live diagnostics during code editing in Visual Studio.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>You will need to have Visual Studio 2017 installed on your machine to follow this recipe. You can install a free community version of Visual Studio 2017 from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Create a C# class library project, say <kbd>ClassLibrary</kbd>, in Visual Studio 2017.</li>
<li>From the top-level menu, navigate to Tools | Extensions and Updates.</li>
<li>Navigate to Online | Visual Studio Marketplace on the left tab of the dialog to view the available VSIXes in the Visual Studio extension gallery/marketplace:</li>
</ol>
<div><img class="image-border" height="475" src="img/9c9fa7c2-ed74-4a3a-8e00-4afb02a276e0.png" width="683"/></div>
<ol start="4">
<li>Search <kbd>analyzers</kbd> in the search textbox in the upper-right corner of the dialog and download an analyzer VSIX, say <kbd>Refactoring Essentials for Visual Studio</kbd>:</li>
</ol>
<div><img class="image-border" height="469" src="img/2d49b014-886b-48cd-9623-7e0d5b00ee64.png" width="677"/></div>
<ol start="5">
<li>Once the download completes, you will get a message at the bottom of the dialog saying that the install will be scheduled to execute once Visual Studio and related windows are closed:</li>
</ol>
<div><img class="image-border" height="479" src="img/cc5ab730-f2a4-4b29-8e48-e8c17f7ef6c8.png" width="692"/></div>
<ol start="6">
<li>Close the dialog and then close the Visual Studio instance to start the install.</li>
<li>In the VSIX Installer dialog, click on Modify to start installation:</li>
</ol>
<div><img class="image-border" height="263" src="img/c5cf1340-e55e-4be3-a47f-080a5f6a4276.png" width="348"/></div>
<ol start="8">
<li>The subsequent message prompts you to kill all the active Visual Studio and satellite processes. Save all your relevant work in all the open Visual Studio instances and click on End Task<strong>s</strong> to kill these processes and install the VSIX:</li>
</ol>
<div><img class="image-border" height="245" src="img/721c1b49-0632-4dc6-8500-e1771bfe4a5d.png" width="325"/></div>
<ol start="9">
<li>After installation, restart VS, click on Tools | Extensions And Updates, and verify that <kbd>Refactoring Essentials VSIX</kbd> is installed:</li>
</ol>
<div><img class="image-border" height="491" src="img/c54b8613-1557-4d94-9590-e72f8fac9394.png" width="705"/></div>
<ol start="10">
<li>Create a new C# project with the following source code and verify analyzer diagnostic <em>RECS0085</em> (<em>Redundant array creation expression</em>) in the error list:</li>
</ol>
<pre style="padding-left: 90px">
namespace ClassLibrary<br/>{<br/>  public class Class1<br/>  {<br/>    void Method()<br/>    {<br/>      int[] values = new int[] { 1, 2, 3 };<br/>    }<br/>  }<br/>}
</pre>
<div><img class="image-border" height="479" src="img/f14cc430-4446-464b-a30a-766503551251.png" width="698"/></div>
<ol start="11">
<li>Build the project from Visual Studio 2017 or the command line and confirm that no analyzer diagnostic shows up in the output window or the command line, respectively, confirming that the VSIX analyzer did not execute as a part of the build.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">Viewing and configuring analyzers in solution explorer in Visual Studio</h1>
                
            
            
                
<p>In this recipe, we will show you how to use the Solution explorer in Visual Studio 2017 to view the different analyzers installed in a project, view the implemented analyzer rules in these assemblies, as well as the rule properties (or the descriptor metadata), and configure the rule severity and persist the new severity settings.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>You will need to have created and opened a .NET project in Visual Studio 2017 with NuGet-based analyzers installed in the project. Refer to the first recipe in this chapter for installing analyzers in a .NET project.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Open a C# project, say <kbd>ClassLibrary</kbd>, with the analyzer NuGet package <kbd>System.Runtime.Analyzers.nupkg</kbd> pre-release version <em>1.2.0-beta2</em> installed in it.</li>
<li>In the solution explorer, expand References | Analyzers nodes to view the analyzer assemblies installed through the analyzer NuGet package(s). We should see two analyzer assemblies, <kbd>System.Runtime.Analyzers</kbd> and <kbd>System.Runtime.CSharp.Analyzers</kbd>:</li>
</ol>
<div><img class="image-border" height="353" src="img/edd824d1-77d3-450a-8784-362baa1cf26d.png" width="265"/></div>
<ol start="3">
<li>Expand the System.Runtime.Analyzers node to view all the <em>CAXXXX</em> rules implemented in the assembly and click on a specific rule, say CA1813: Avoid unsealed attributes<em>,</em> to view the rule properties, such as <em>ID, Message, Title, Description, Category, Effective severity</em>, Enabled by default, and so on, in the Properties Window:</li>
</ol>
<div><img class="image-border" height="554" src="img/33e32c43-e569-41eb-8c96-072f642a43f9.png" width="452"/></div>
<ol start="4">
<li>Note that the <em>CA1813</em> rule's Enabled by default is False, which means that the rule is turned off by default. We can confirm this by adding the following source code that violates this rule because we declared a public unsealed attribute, but <em>CA1813</em> is not reported for the violation:</li>
</ol>
<pre style="padding-left: 90px">
using System;<br/><br/>namespace ClassLibrary<br/>{<br/>  [AttributeUsage(AttributeTargets.All)]<br/>  public class MyAttribute: Attribute<br/>  {<br/>  }<br/>}
</pre>
<ol start="5">
<li>Right-click on the rule node, click on Set Rule Set Severity, and change the severity from Default to Warning:</li>
</ol>
<div><img class="image-border" height="382" src="img/ad315b35-5562-4c3e-aacc-451dee5c064d.png" width="498"/></div>
<ol start="6">
<li>Confirm that <em>CA1813</em> is now reported for the preceding code:</li>
</ol>
<div><img class="image-border" height="238" src="img/848047f4-f0aa-4ac2-9e3f-8a0b06c81b21.png" width="396"/></div>
<ol start="7">
<li>Save the current project and then close and re-open the solution.</li>
<li>Verify that the warning CA1813 still shows up for the preceding source code, confirming that the rule set severity change was persisted for the project.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>The analyzers node in solution explorer gives a visual representation of the analyzer items defined in the project file, which correspond to analyzer assemblies added manually to the project or added via analyzer NuGet package(s). The rules in the assembly come from each type in the assembly that implements the <kbd>DiagnosticAnalyzer</kbd> type and has a <kbd>DiagnosticAnalyzerAttribute</kbd> applied to it. The rule properties shown in the properties window come from instantiating the analyzer types and requesting them for it's <kbd>SupportedDiagnostics</kbd>.</p>
<p>Changing the rule severity in solution explorer and then persisting it for the project happens through an automatically generated ruleset file, which gets added to the project. Refer to the next recipe to get more details on ruleset-based analyzer configuration.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Using the ruleset file and Rule Set editor to configure analyzers</h1>
                
            
            
                
<p>In this recipe, we will show you how to use the <kbd>ruleset</kbd> file and the Rule Set editor in Visual Studio to configure the per-project severity of analyzer rules, and illustrate how the severity changes are reflected in the live diagnostics in Visual Studio, as well as command-line builds.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>You will need to have created and opened a .NET project in Visual Studio 2017 with NuGet-based analyzers installed in the project. Refer to the first recipe in this chapter for installing analyzers in a .NET project.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Open a C# project, say <kbd>ClassLibrary</kbd>, with the analyzer NuGet package <kbd>System.Runtime.Analyzers.nupkg</kbd> prerelease version <em>1.2.0-beta2</em> installed in it.</li>
<li>Add the following source code to the project and verify that no CA1813: Avoid unsealed attributes is fired:</li>
</ol>
<pre style="padding-left: 90px">
using System;<br/><br/>namespace ClassLibrary<br/>{<br/>  [AttributeUsage(AttributeTargets.All)]<br/>  public class MyAttribute: Attribute<br/>  {<br/>  }<br/>}
</pre>
<ol start="3">
<li>In the solution explorer, navigate to ClassLibary | References | Analyzers, right-click on the Analyzers node and execute the context menu command Open Active Rule Set:</li>
</ol>
<div><img class="image-border" height="177" src="img/4149663d-c886-41f9-b0bc-957a3df23969.png" width="549"/></div>
<ol start="4">
<li>In the Rule Set editor, search <em>CA1813</em> in the textbox in the top-right corner.</li>
<li>For the <em>CA1813,</em> search the result listed under System.Runtime.Analyzers, change the Action from None to Warning, and hit save:</li>
</ol>
<div><img class="image-border" height="277" src="img/d70d5cb8-7dd8-451a-a6c6-734c459f1210.png" width="800"/></div>
<ol start="6">
<li>We should now see a <em>CA1813</em> warning being reported on our attribute definition in the source code.</li>
<li>In the solution explorer, verify that the project now contains that a new <kbd>ClassLibrary.ruleset</kbd> item, and a new <kbd>CodeAnalysisRuleset</kbd> property was added to the project file:</li>
</ol>
<pre style="padding-left: 90px">
<em>&lt;CodeAnalysisRuleSet&gt;<strong>ClassLibrary.ruleset</strong>&lt;/CodeAnalysisRuleSet&gt;</em>
</pre>
<ol start="8">
<li>Open <kbd>ClassLibrary.ruleset</kbd> in a text editor outside of Visual Studio and verify that it has the following rule action specification for <em>CA1813</em>:</li>
</ol>
<pre style="padding-left: 90px">
<em> &lt;Rules AnalyzerId="System.Runtime.Analyzers" RuleNamespace="System.Runtime.Analyzers"&gt;</em><br/><em>   &lt;Rule Id="<strong>CA1813</strong>" Action="<strong>Warning</strong>" /&gt;</em><br/><em> &lt;/Rules&gt;</em>
</pre>
<ol start="9">
<li>Edit the ruleset file to change the <kbd>ruleset</kbd> Action for <em>CA1813</em> from Warning to Error and save the file.</li>
<li>Switch back to Visual Studio and confirm that the source code editor now shows a red squiggle and that the error list also reports an error for <em>CA1813</em>:</li>
</ol>
<div><img class="image-border" height="208" src="img/27524615-8925-4e81-aa64-adfb4512323b.png" width="403"/></div>
<ol start="11">
<li>Double-click on <em>ClassLibrary.ruleset</em> in the solution explorer to open it with the Rule Set editor and verify that the rule severity entry for <em>CA1813</em> is now showing as Error.</li>
<li>Build the project and verify that the error <em>CA1813</em> is reported, confirming that the <kbd>ruleset</kbd> setting is preserved for command-line builds as well.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>The <kbd>ruleset</kbd> file is essentially a grouping of a set of code-analysis rules that you can apply to a project to configure it's analysis. It is specified in an XML format and is based on an XML schema that ships with Visual Studio. It is also open sourced, and can be found at <a href="https://github.com/dotnet/roslyn/blob/version-2.0.0/src/Compilers/Core/Portable/RuleSet/RuleSetSchema.xsd">https://github.com/dotnet/roslyn/blob/version-2.0.0/src/Compilers/Core/Portable/RuleSet/RuleSetSchema.xsd</a>. A <kbd>ruleset</kbd> can be specified for a project using the <kbd>CodeAnalysisRuleset</kbd> property in the project file. Each Rules node contains a collection of rule specifications with a common analyzer ID and namespace. Each Rule specification has the rule ID and the effective Action or the severity. The rule Action can take one of the following five values: None (suppressed), Hidden (non-visible in the IDE, primarily a code fix trigger), Info (informational message), Warning, and <strong>Error</strong>. These rule actions get converted into compilation options for the compiler and override the default severity of the diagnostic ID.</p>
<p>The Rule Set editor is a powerful graphical user interface to search, filter, and bulk-edit rule configurations.</p>
<p>Refer to <a href="https://msdn.microsoft.com/en-us/library/dd264996.aspx">https://msdn.microsoft.com/en-us/library/dd264996.aspx</a> for a more detailed walk through, and for documentation for <kbd>ruleset</kbd> file schema and the Rule Set editor in Visual Studio.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>In Visual Studio 2017, built-in IDE analyzers for coding style rules can also be configured via the new <em>.editorconfig</em> format, which applies rule configurations at folder level. See the documentation at (<a href="https://docs.microsoft.com/en-us/visualstudio/ide/editorconfig-code-style-settings-reference">https://docs.microsoft.com/en-us/visualstudio/ide/editorconfig-code-style-settings-reference</a> ) for further details.</p>


            

            
        
    </body></html>