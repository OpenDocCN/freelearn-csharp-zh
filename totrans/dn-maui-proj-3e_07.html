<html><head></head><body>
<div id="_idContainer134">
<h1 class="chapter-number" id="_idParaDest-119"><a id="_idTextAnchor569"/><span class="koboSpan" id="kobo.1.1">7</span></h1>
<h1 id="_idParaDest-120"><a id="_idTextAnchor570"/><a id="_idTextAnchor571"/><a id="_idTextAnchor572"/><a id="_idTextAnchor573"/><span class="koboSpan" id="kobo.2.1">Building a Location Tracking App Using GPS and Maps</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, we will create a location tracking app that saves the location of the user and displays it as a heat map. </span><span class="koboSpan" id="kobo.3.2">We will learn how to run tasks in the background on iOS, macOS, and Android devices. </span><span class="koboSpan" id="kobo.3.3">We will extend the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.4.1">Map</span></strong><span class="koboSpan" id="kobo.5.1"> control to display the map with the saved locations directly in </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">the map.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">The following topics will be covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.9.1">Tracking the location of a user in the background on an iOS device and a </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">macOS device</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Tracking the location of a user in the background on an </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">Android device</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">How to show maps in a .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">MAUI app</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">How to extend the functionality of .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">MAUI maps</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.17.1">Let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">get started!</span></span></p>
<h1 id="_idParaDest-121"><a id="_idTextAnchor574"/><span class="koboSpan" id="kobo.19.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.20.1">To be able to complete this project, you’ll need to have Visual Studio for Mac or Windows installed, as well as the .NET MAUI components. </span><span class="koboSpan" id="kobo.20.2">See </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.21.1">Chapter 1</span></em></span><span class="koboSpan" id="kobo.22.1">, </span><em class="italic"><span class="koboSpan" id="kobo.23.1">Introduction to .NET MAUI</span></em><span class="koboSpan" id="kobo.24.1">, for more details on how to set up your environment. </span><span class="koboSpan" id="kobo.24.2">To build an iOS app using Visual Studio for Windows, you must have a Mac connected. </span><span class="koboSpan" id="kobo.24.3">If you don’t have access to a Mac at all, you can just complete the Android part of </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">this project.</span></span></p>
<p><span class="koboSpan" id="kobo.26.1">You can find the full source for the code in this chapter </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">at </span></span><a href="https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition"><span class="No-Break"><span class="koboSpan" id="kobo.28.1">https://github.com/PacktPublishing/MAUI-Projects-3rd-Edition</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.29.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.30.1">Important information for Windows users</span></p>
<p class="callout"><span class="koboSpan" id="kobo.31.1">At the time of writing, there was no </span><strong class="source-inline"><span class="koboSpan" id="kobo.32.1">Map</span></strong><span class="koboSpan" id="kobo.33.1"> control for the Windows platform in .NET MAUI. </span><span class="koboSpan" id="kobo.33.2">This is due to the lack of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.34.1">Map</span></strong><span class="koboSpan" id="kobo.35.1"> control in the underlying WinUI platform. </span><span class="koboSpan" id="kobo.35.2">For the latest information on </span><strong class="source-inline"><span class="koboSpan" id="kobo.36.1">Map</span></strong><span class="koboSpan" id="kobo.37.1"> support in Windows, visit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.38.1">Map</span></strong><span class="koboSpan" id="kobo.39.1"> documentation </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">at </span></span><a href="https://learn.microsoft.com/en-us/dotnet/maui/user-interface/controls/map"><span class="No-Break"><span class="koboSpan" id="kobo.41.1">https://learn.microsoft.com/en-us/dotnet/maui/user-interface/controls/map</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.42.1">.</span></span></p>
<h1 id="_idParaDest-122"><a id="_idTextAnchor575"/><a id="_idTextAnchor576"/><span class="koboSpan" id="kobo.43.1">Project overview</span></h1>
<p><span class="koboSpan" id="kobo.44.1">Many apps can be made richer by adding a map and location services. </span><span class="koboSpan" id="kobo.44.2">In this project, we will build a location tracking app that we will call </span><strong class="source-inline"><span class="koboSpan" id="kobo.45.1">MeTracker</span></strong><span class="koboSpan" id="kobo.46.1">. </span><span class="koboSpan" id="kobo.46.2">This app will track the position of the </span><a id="_idIndexMarker683"/><span class="koboSpan" id="kobo.47.1">user and save it to an SQLite database so that we can visualize the result in the form of a heat map. </span><span class="koboSpan" id="kobo.47.2">To build this app, we will learn how to set up processes in the background on iOS, macOS, and Android. </span><span class="koboSpan" id="kobo.47.3">Luckily for us, the iOS and macOS implementations are identical; however, the Android implementation is very different. </span><span class="koboSpan" id="kobo.47.4">For the map, we will use the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.48.1">Maps</span></strong><span class="koboSpan" id="kobo.49.1"> component and extend its functionality to build a </span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">heat map.</span></span></p>
<p><span class="koboSpan" id="kobo.51.1">Due to the lack of </span><strong class="source-inline"><span class="koboSpan" id="kobo.52.1">Map</span></strong><span class="koboSpan" id="kobo.53.1"> support on Windows, and just for some variety, this chapter will use Visual Studio for Mac screenshots and references. </span><span class="koboSpan" id="kobo.53.2">If you don’t have a Mac, don’t worry; you can still complete the project for Android on your Windows development machine. </span><span class="koboSpan" id="kobo.53.3">If you need help with the steps, look at some of the earlier chapters for </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">equivalent steps.</span></span><a id="_idTextAnchor577"/></p>
<p><span class="koboSpan" id="kobo.55.1">The estimated build time for this project is </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">180 minutes.</span></span><a id="_idTextAnchor578"/></p>
<h1 id="_idParaDest-123"><a id="_idTextAnchor579"/><span class="koboSpan" id="kobo.57.1">Building the MeTracker app</span></h1>
<p><span class="koboSpan" id="kobo.58.1">It’s time to </span><a id="_idIndexMarker684"/><span class="koboSpan" id="kobo.59.1">start building the app. </span><span class="koboSpan" id="kobo.59.2">Use the following steps to create a project from </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">a template:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.61.1">Open Visual Studio for Mac and </span><span class="No-Break"><span class="koboSpan" id="kobo.62.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.63.1">New</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer116">
<span class="koboSpan" id="kobo.65.1"><img alt="Figure 7.1 – Visual Studio for Mac start screen" src="image/B19214_07_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.66.1">Figure 7.1 – Visual Studio for Mac start screen</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.67.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.68.1">Choose a template for your new project</span></strong><span class="koboSpan" id="kobo.69.1"> dialog, use the </span><strong class="bold"><span class="koboSpan" id="kobo.70.1">.NET MAUI App</span></strong><span class="koboSpan" id="kobo.71.1"> template, which </span><a id="_idIndexMarker685"/><span class="koboSpan" id="kobo.72.1">is under </span><strong class="bold"><span class="koboSpan" id="kobo.73.1">Multiplatform</span></strong><span class="koboSpan" id="kobo.74.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.75.1">App</span></strong><span class="koboSpan" id="kobo.76.1">; then, </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.78.1">Continue</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.79.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer117">
<span class="koboSpan" id="kobo.80.1"><img alt="Figure 7.2 – New project﻿" src="image/B19214_07_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.81.1">Figure 7.2 – New project</span><a id="_idTextAnchor580"/></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.82.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.83.1">Configure your new .NET MAUI App</span></strong><span class="koboSpan" id="kobo.84.1"> dialog, ensure the </span><strong class="bold"><span class="koboSpan" id="kobo.85.1">.NET 7.0</span></strong><span class="koboSpan" id="kobo.86.1"> target </span><a id="_idIndexMarker686"/><span class="koboSpan" id="kobo.87.1">framework is selected, then </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.89.1">Continue</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer118">
<span class="koboSpan" id="kobo.91.1"><img alt="Figure 7.3 – Choosing a target framework" src="image/B19214_07_3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.92.1">Figure 7.3 – Choosing a target framework</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.93.1">In the </span><strong class="bold"><span class="koboSpan" id="kobo.94.1">Configure your new .NET MAUI App</span></strong><span class="koboSpan" id="kobo.95.1"> dialog, name the project </span><strong class="source-inline"><span class="koboSpan" id="kobo.96.1">MeTracker</span></strong><span class="koboSpan" id="kobo.97.1">, and then </span><a id="_idIndexMarker687"/><span class="No-Break"><span class="koboSpan" id="kobo.98.1">click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.99.1">Create</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer119">
<span class="koboSpan" id="kobo.101.1"><img alt="Figure 7.4 – Naming the new app﻿" src="image/B19214_07_4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.102.1">Figure 7.4 – Naming the new app</span><a id="_idTextAnchor581"/></p>
<p><span class="koboSpan" id="kobo.103.1">If you </span><a id="_idIndexMarker688"/><span class="koboSpan" id="kobo.104.1">run the app now, you should see something like </span><span class="No-Break"><span class="koboSpan" id="kobo.105.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer120">
<span class="koboSpan" id="kobo.106.1"><img alt="Figure 7.5 – MeTracker app on macOS" src="image/B19214_07_5.jpg"/></span>
</div>
</div>
<p class="IMG---Figure"><a id="_idTextAnchor582"/></p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.107.1">Figure 7.5 – MeTracker app on macOS</span></p>
<p><span class="koboSpan" id="kobo.108.1">Now that </span><a id="_idIndexMarker689"/><span class="koboSpan" id="kobo.109.1">we have created a project from a template, it’s time to </span><span class="No-Break"><span class="koboSpan" id="kobo.110.1">start coding!</span></span></p>
<h2 id="_idParaDest-124"><a id="_idTextAnchor583"/><span class="koboSpan" id="kobo.111.1">Creating a repository to save the locations of the users</span></h2>
<p><span class="koboSpan" id="kobo.112.1">The first </span><a id="_idIndexMarker690"/><span class="koboSpan" id="kobo.113.1">thing we will do is </span><a id="_idIndexMarker691"/><span class="koboSpan" id="kobo.114.1">create a repository that we can use to save the locations of </span><a id="_idTextAnchor584"/><span class="No-Break"><span class="koboSpan" id="kobo.115.1">the use</span><a id="_idTextAnchor585"/><span class="koboSpan" id="kobo.116.1">rs.</span></span></p>
<h3><span class="koboSpan" id="kobo.117.1">Creating a model for the location data</span></h3>
<p><span class="koboSpan" id="kobo.118.1">Before </span><a id="_idIndexMarker692"/><span class="koboSpan" id="kobo.119.1">we create a repository, we will create a model class that will represent a user location. </span><span class="koboSpan" id="kobo.119.2">Follow these steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">do so:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.121.1">Create a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">Models</span></strong><span class="koboSpan" id="kobo.123.1"> folder that we can use for all </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">our models.</span></span></li>
<li><span class="koboSpan" id="kobo.125.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.126.1">Location</span></strong><span class="koboSpan" id="kobo.127.1"> class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.128.1">Models</span></strong><span class="koboSpan" id="kobo.129.1"> folder and add properties for </span><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">Id</span></strong><span class="koboSpan" id="kobo.131.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.132.1">Latitude</span></strong><span class="koboSpan" id="kobo.133.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.134.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.135.1">Longitude</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.136.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.137.1">Create two </span><a id="_idIndexMarker693"/><span class="koboSpan" id="kobo.138.1">constructors – one that’s empty and one that takes </span><strong class="source-inline"><span class="koboSpan" id="kobo.139.1">latitude</span></strong><span class="koboSpan" id="kobo.140.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">longitude</span></strong><span class="koboSpan" id="kobo.142.1"> as arguments. </span><span class="koboSpan" id="kobo.142.2">Use the following code to </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">do so:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.144.1">
Using'System;
namespace MeTracker.Models;
public class Location
{
    public Location() {}
    public Location(double latitude, double longitude)
    {
        Latitude = latitude;
        Longitude = longitude;
    }
    public int Id { get; set; }
    public double Latitude { get; set; }
    public double Longitude { get; set</span><a id="_idTextAnchor586"/><a id="_idTextAnchor587"/><a id="_idTextAnchor588"/><span class="koboSpan" id="kobo.145.1">; }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.146.1">Now that we have created a model, we can start creating </span><span class="No-Break"><span class="koboSpan" id="kobo.147.1">a repository.</span></span></p>
<h3><span class="koboSpan" id="kobo.148.1">Creating a repository</span></h3>
<p><span class="koboSpan" id="kobo.149.1">First, we will </span><a id="_idIndexMarker694"/><span class="koboSpan" id="kobo.150.1">create an interface for the repository. </span><span class="koboSpan" id="kobo.150.2">Follow these steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.151.1">do so:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.152.1">Create a new folder </span><span class="No-Break"><span class="koboSpan" id="kobo.153.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.154.1">Repositories</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.156.1">In our new folder, create an interface </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.158.1">ILocationRepository</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.160.1">Write the following code in the new file that we created for </span><span class="No-Break"><span class="koboSpan" id="kobo.161.1">the interface:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.162.1">
using MeTracker.Models;
using System;
using System.Threading.Tasks;
namespace MeTracker.Repositories;
public interface ILocationRepository
{
    Task SaveAsync(Models.Location location);
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.163.1">Now that we </span><a id="_idIndexMarker695"/><span class="koboSpan" id="kobo.164.1">have an interface, we need to create an implementation of it. </span><span class="koboSpan" id="kobo.164.2">Follow these steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.165.1">do so:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.166.1">Create a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">LocationRepository</span></strong><span class="koboSpan" id="kobo.168.1"> class in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.169.1">Repositories</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.170.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.171.1">Implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.172.1">ILocationRepository</span></strong><span class="koboSpan" id="kobo.173.1"> interface and add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">async</span></strong><span class="koboSpan" id="kobo.175.1"> keyword to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">SaveAsync</span></strong><span class="koboSpan" id="kobo.177.1"> method using the </span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.179.1">
using System;
using System.Threading.Tasks;
using MeTracker.Models;
namespace MeTracker.Repositories;
public class LocationRepository : ILocationRepository
{
    public async Task SaveAsync(Models.Location location)
    {
</span><a id="_idTextAnchor589"/><span class="koboSpan" id="kobo.180.1">    }
}</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.181.1">A word on the Async suffix</span></p>
<p class="callout"><span class="koboSpan" id="kobo.182.1">You will see </span><a id="_idIndexMarker696"/><span class="koboSpan" id="kobo.183.1">in this and many other chapters in this book the use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.184.1">Async</span></strong><span class="koboSpan" id="kobo.185.1"> as a suffix on methods. </span><span class="koboSpan" id="kobo.185.2">Appending a suffix of </span><strong class="source-inline"><span class="koboSpan" id="kobo.186.1">Async</span></strong><span class="koboSpan" id="kobo.187.1"> to all asynchronous methods is a .NET convention. </span><span class="koboSpan" id="kobo.187.2">How do we know whether a method is asynchronous in an interface where you can’t see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">async</span></strong><span class="koboSpan" id="kobo.189.1"> keyword? </span><span class="koboSpan" id="kobo.189.2">It will most likely return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">Task</span></strong><span class="koboSpan" id="kobo.191.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.192.1">ValueTask</span></strong><span class="koboSpan" id="kobo.193.1"> object. </span><span class="koboSpan" id="kobo.193.2">There are some cases where an asynchronous method will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">void</span></strong><span class="koboSpan" id="kobo.195.1">; however, that is frowned upon, as Stephen Cleary explains in his article at </span><a href="https://msdn.microsoft.com/en-us/magazine/jj991977.aspx"><span class="koboSpan" id="kobo.196.1">https://msdn.microsoft.com/en-us/magazine/jj991977.aspx</span></a><span class="koboSpan" id="kobo.197.1">, so you won’t see it used in </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">this book.</span></span></p>
<p><span class="koboSpan" id="kobo.199.1">To store </span><a id="_idIndexMarker697"/><span class="koboSpan" id="kobo.200.1">the data, we will use an SQLite database and the </span><strong class="bold"><span class="koboSpan" id="kobo.201.1">object-relational mapper </span></strong><span class="koboSpan" id="kobo.202.1">(</span><strong class="bold"><span class="koboSpan" id="kobo.203.1">ORM</span></strong><span class="koboSpan" id="kobo.204.1">) known as SQLite-net so that we can write </span><a id="_idIndexMarker698"/><span class="koboSpan" id="kobo.205.1">code against a domain model instead of using SQL to perform operations against the database. </span><span class="koboSpan" id="kobo.205.2">This is an open source library that was created by Frank A. </span><span class="koboSpan" id="kobo.205.3">Krueger. </span><span class="koboSpan" id="kobo.205.4">Let’s set this up by going through the </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.207.1">Add a reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">sqli</span><a id="_idTextAnchor590"/><span class="koboSpan" id="kobo.209.1">te-net-pcl</span></strong><span class="koboSpan" id="kobo.210.1"> by right-clicking the </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">Dependencies</span></strong><span class="koboSpan" id="kobo.212.1"> node in </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.213.1">Solution Explorer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer121">
<span class="koboSpan" id="kobo.215.1"><img alt="Figure 7.6 – Adding the NuGet package" src="image/B19214_07_6.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.216.1">Figure 7.6 – Adding the NuGet package</span></p>
<ol>
<li class="upper-roman"><span class="koboSpan" id="kobo.217.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.218.1">Manage NuGet Packages…</span></strong><span class="koboSpan" id="kobo.219.1"> from the context menu to open the </span><strong class="bold"><span class="koboSpan" id="kobo.220.1">NuGet </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.221.1">Packages</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.222.1"> window.</span></span></li>
<li class="upper-roman"><span class="koboSpan" id="kobo.223.1">Check the </span><strong class="bold"><span class="koboSpan" id="kobo.224.1">Include prereleases</span></strong><span class="koboSpan" id="kobo.225.1"> checkbox and enter </span><strong class="source-inline"><span class="koboSpan" id="kobo.226.1">sqlite-net-pcl</span></strong><span class="koboSpan" id="kobo.227.1"> into the search box as </span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">shown next:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer122">
<span class="koboSpan" id="kobo.229.1"><img alt="Figure 7.7 – Adding the sqlite-net-pcl package" src="image/B19214_07_7.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.230.1">Figure 7.7 – Adding the sqlite-net-pcl package</span></p>
<ol>
<li class="upper-roman" value="3"><span class="koboSpan" id="kobo.231.1">Finally, check the </span><a id="_idIndexMarker699"/><span class="koboSpan" id="kobo.232.1">box next to </span><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">sqlite-net-pcl</span></strong><span class="koboSpan" id="kobo.234.1"> and click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.235.1">Add Package</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">.</span></span></li>
</ol>
<ol>
<li value="2"><span class="koboSpan" id="kobo.237.1">Go to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">Location</span></strong><span class="koboSpan" id="kobo.239.1"> model class and add </span><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">PrimaryKeyAttribute</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.241.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.242.1">Auto</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">
IncrementAttribute</span></strong><span class="koboSpan" id="kobo.244.1"> attributes to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">Id</span></strong><span class="koboSpan" id="kobo.246.1"> property. </span><span class="koboSpan" id="kobo.246.2">When we add these attributes, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">Id</span></strong><span class="koboSpan" id="kobo.248.1"> property will be a primary key in the database, and a value for it will be automatically created. </span><span class="koboSpan" id="kobo.248.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">Location</span></strong><span class="koboSpan" id="kobo.250.1"> class should now look like </span><span class="No-Break"><span class="koboSpan" id="kobo.251.1">the following:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.252.1">using SQLite;</span></strong><span class="koboSpan" id="kobo.253.1">
namespace MeTracker.Models;
public class Location
{
    public Location() { }
    public Location(double latitude, double longitude)
    {
        Latitude = latitude;
        Longitude = longitude;
    }
</span><strong class="bold"><span class="koboSpan" id="kobo.254.1">    [PrimaryKey]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.255.1">    [AutoIncrement]</span></strong><span class="koboSpan" id="kobo.256.1">
    public int Id { get; set; }
    public double Latitude { get; set; }
    public double Longitude { get; set; }
}</span></pre></li> <li><span class="koboSpan" id="kobo.257.1">Write the following code in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.258.1">LocationRepository</span></strong><span class="koboSpan" id="kobo.259.1"> class to create a connection </span><a id="_idIndexMarker700"/><span class="koboSpan" id="kobo.260.1">to the SQLite database. </span><span class="koboSpan" id="kobo.260.2">An </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">if</span></strong><span class="koboSpan" id="kobo.262.1"> statement is used to check whether we have already created a connection. </span><span class="koboSpan" id="kobo.262.2">If we have, we won’t create a new one; instead, we will use the connection that we’ve </span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">already created:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.264.1">
private SQLiteAsyncConnection connection;
private async Task CreateConnectionAsync()
{
    if (connection != null)
    {
        return;
    }
    var databasePath = Path.Combine(Environment.GetFolderPath (Environment.SpecialFolder .MyDocuments), "Locations.db");
    connection = new SQLiteAsyncConnection(databasePath);
    await connection.CreateTableAsync&lt;Location&gt;();
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.265.1">Now, it’s time to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.266.1">SaveAsync</span></strong><span class="koboSpan" id="kobo.267.1"> method, which will take a </span><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">location</span></strong><span class="koboSpan" id="kobo.269.1"> object as a parameter and store it in </span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">the database.</span></span></p>
<p><span class="koboSpan" id="kobo.271.1">We will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.272.1">CreateConnectionAsync</span></strong><span class="koboSpan" id="kobo.273.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.274.1">SaveAsync</span></strong><span class="koboSpan" id="kobo.275.1"> method to ensure that </span><a id="_idIndexMarker701"/><span class="koboSpan" id="kobo.276.1">a connection is created when we try to save data to the database. </span><span class="koboSpan" id="kobo.276.2">When we know that we have an active connection, we can just use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">InsertAsync</span></strong><span class="koboSpan" id="kobo.278.1"> method and pass the </span><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">location</span></strong><span class="koboSpan" id="kobo.280.1"> parameter of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">SaveAsync</span></strong><span class="koboSpan" id="kobo.282.1"> method as </span><span class="No-Break"><span class="koboSpan" id="kobo.283.1">a</span><a id="_idTextAnchor591"/><span class="koboSpan" id="kobo.284.1">n argument.</span></span></p>
<p><span class="koboSpan" id="kobo.285.1">Edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">SaveAsync</span></strong><span class="koboSpan" id="kobo.287.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">LocationRepository</span></strong><span class="koboSpan" id="kobo.289.1"> class so that it looks </span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.291.1">
public async Task SaveAsync(Models.Location location)
{
    await CreateConnectionAsync();
    await connection.InsertAsync(l</span><a id="_idTextAnchor592"/><a id="_idTextAnchor593"/><a id="_idTextAnchor594"/><span class="koboSpan" id="kobo.292.1">ocation);
}</span></pre> <p><span class="koboSpan" id="kobo.293.1">That wraps up the repository for now, so let’s move on to the location </span><span class="No-Break"><span class="koboSpan" id="kobo.294.1">tracking service.</span></span></p>
<h2 id="_idParaDest-125"><a id="_idTextAnchor595"/><span class="koboSpan" id="kobo.295.1">Creating a service for location tracking</span></h2>
<p><span class="koboSpan" id="kobo.296.1">To track a user’s location, we need to write code according to the platform. </span><span class="koboSpan" id="kobo.296.2">.NET MAUI has methods </span><a id="_idIndexMarker702"/><span class="koboSpan" id="kobo.297.1">for getting the location of a user, but it cannot be used in the background. </span><span class="koboSpan" id="kobo.297.2">To be able to use the code that we will </span><a id="_idIndexMarker703"/><span class="koboSpan" id="kobo.298.1">write for each platform, we need to create an interface. </span><span class="koboSpan" id="kobo.298.2">For the </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">ILocationRepository</span></strong><span class="koboSpan" id="kobo.300.1"> interface, there is just one implementation that will be used on both platforms (iOS and Android), whereas for the location tracking service, we will have one implementation for </span><span class="No-Break"><span class="koboSpan" id="kobo.301.1">each platform.</span></span></p>
<p><span class="koboSpan" id="kobo.302.1">Go through the following steps to create an </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">ILocationTrackingService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.304.1"> interface:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.305.1">Create a new folder </span><span class="No-Break"><span class="koboSpan" id="kobo.306.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.308.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.309.1">Create a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">ILocationTrackingService</span></strong><span class="koboSpan" id="kobo.311.1"> interface in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.313.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.314.1">In the interface, add a method called </span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">StartTracking</span></strong><span class="koboSpan" id="kobo.316.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.317.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.318.1">
public interface ILocationTrackingService
{
    void Start</span><a id="_idTextAnchor596"/><span class="koboSpan" id="kobo.319.1">Tracking();
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.320.1">To make sure we can run and test our app while we implement the location tracking service for each platform, we will use a partial class. </span><span class="koboSpan" id="kobo.320.2">The main part of the class will be in the shared </span><a id="_idIndexMarker704"/><span class="koboSpan" id="kobo.321.1">code section of the project and the platform-specific portions of the class will be in the platform-specific folders. </span><span class="koboSpan" id="kobo.321.2">We will </span><a id="_idIndexMarker705"/><span class="koboSpan" id="kobo.322.1">come back to each implementation later in </span><span class="No-Break"><span class="koboSpan" id="kobo.323.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.324.1">Create a class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">LocationTrackingService</span></strong><span class="koboSpan" id="kobo.326.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.327.1">Services</span></strong><span class="koboSpan" id="kobo.328.1"> folder, </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">as shown:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.330.1">
public partial class LocationTrackingService : ILocationTrackingService
{
    public void StartTracking()
    {
        StartTrackingInternal();
    }
    partial void StartTrack</span><a id="_idTextAnchor597"/><a id="_idTextAnchor598"/><span class="koboSpan" id="kobo.331.1">ingInternal();
}</span></pre> <p><span class="koboSpan" id="kobo.332.1">We are using an interface to abstract our implementation. </span><span class="koboSpan" id="kobo.332.2">We are also using a partial class to abstract each specific implementation, but providing a base implementation so that we don’t have to have an implementation for every platform immediately. </span><span class="koboSpan" id="kobo.332.3">However, the two methods (partial classes and base class inheritance) do not play together with the </span><span class="No-Break"><span class="koboSpan" id="kobo.333.1">same method.</span></span></p>
<p><span class="koboSpan" id="kobo.334.1">An implementation of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.335.1">StartTracking</span></strong><span class="koboSpan" id="kobo.336.1"> interface method requires the </span><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">public</span></strong><span class="koboSpan" id="kobo.338.1"> keyword, which would look </span><span class="No-Break"><span class="koboSpan" id="kobo.339.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.340.1">
public void StartTracking() {}</span></pre> <p><span class="koboSpan" id="kobo.341.1">Then, make it partial, </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">like so:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.343.1">
public partial void StartTracking() {}</span></pre> <p><span class="koboSpan" id="kobo.344.1">The compiler complains that there is no initial definition of the partial method – that is, one that has </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">no implementation.</span></span></p>
<p><span class="koboSpan" id="kobo.346.1">Remove the empty definition, </span><span class="No-Break"><span class="koboSpan" id="kobo.347.1">like so:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.348.1">
public partial void StartTracking();</span></pre> <p><span class="koboSpan" id="kobo.349.1">The compiler now complains because it has an accessibility </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">modifier, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">public</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.353.1">There is just </span><a id="_idIndexMarker706"/><span class="koboSpan" id="kobo.354.1">no making the compiler happy in this case. </span><span class="koboSpan" id="kobo.354.2">Therefore, to avoid these issues, we implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">StartTracking</span></strong><span class="koboSpan" id="kobo.356.1"> interface method by calling a </span><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">StartTrackingInternal</span></strong><span class="koboSpan" id="kobo.358.1"> partial method. </span><span class="koboSpan" id="kobo.358.2">We will </span><a id="_idIndexMarker707"/><span class="koboSpan" id="kobo.359.1">visit the implementation of </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">StartTrackingInternal</span></strong><span class="koboSpan" id="kobo.361.1"> for each platform later in this chapter; for now, the app should compile and run, even though we haven’t </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">implemented </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">StartTrackingInternal</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.365.1">Now that we have the interface and base implementation of the location tracking service, we can turn our attention to the app logic and </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">user interface.</span></span></p>
<h2 id="_idParaDest-126"><a id="_idTextAnchor599"/><span class="koboSpan" id="kobo.367.1">Setting up the app logic</span></h2>
<p><span class="koboSpan" id="kobo.368.1">Now that we have created the interfaces, we need to track the location of the user and save it locally </span><a id="_idIndexMarker708"/><span class="koboSpan" id="kobo.369.1">on the device. </span><span class="koboSpan" id="kobo.369.2">It’s time to write some code so that we can start tracking a user. </span><span class="koboSpan" id="kobo.369.3">We still don’t have any code that tracks the location of the user, but it</span><a id="_idTextAnchor600"/><span class="koboSpan" id="kobo.370.1"> will be easier to write this if we have already written the code that starts the</span><a id="_idTextAnchor601"/> <span class="No-Break"><span class="koboSpan" id="kobo.371.1">tracking process.</span></span></p>
<h3><span class="koboSpan" id="kobo.372.1">Creating a view with a map</span></h3>
<p><span class="koboSpan" id="kobo.373.1">To start with, we will </span><a id="_idIndexMarker709"/><span class="koboSpan" id="kobo.374.1">create a view with a simple map that is centered on the position of the user. </span><span class="koboSpan" id="kobo.374.2">Let’s set this up by going through the </span><span class="No-Break"><span class="koboSpan" id="kobo.375.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.376.1">Create a new folder </span><span class="No-Break"><span class="koboSpan" id="kobo.377.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">Views</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.380.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">Views</span></strong><span class="koboSpan" id="kobo.382.1"> folder, create a XAML-based </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">ContentPage</span></strong><span class="koboSpan" id="kobo.384.1"> template and n</span><a id="_idTextAnchor602"/><span class="koboSpan" id="kobo.385.1">ame </span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">it </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">MainView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.388.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer123">
<span class="koboSpan" id="kobo.389.1"><img alt="Figure 7.8 – Adding the .NET MAUI XAML Con﻿﻿tentPage component" src="image/B19214_07_8.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.390.1">Figure 7.8 – Adding the .NET MAUI XAML Con</span><a id="_idTextAnchor603"/><a id="_idTextAnchor604"/><span class="koboSpan" id="kobo.391.1">tentPage component</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.392.1">Add a </span><a id="_idIndexMarker710"/><span class="koboSpan" id="kobo.393.1">reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">Microsoft.Maui.Controls.Maps</span></strong><span class="koboSpan" id="kobo.395.1"> by right-clicking the </span><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">Dependencies</span></strong><span class="koboSpan" id="kobo.397.1"> node in </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.398.1">Solution Explorer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer124">
<span class="koboSpan" id="kobo.400.1"><img alt="Figure 7.9 – Adding the NuGet package" src="image/B19214_07_9.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.401.1">Figure 7.9 – Adding the NuGet package</span></p>
<ol>
<li class="upper-roman"><span class="koboSpan" id="kobo.402.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.403.1">Manage NuGet Packages…</span></strong><span class="koboSpan" id="kobo.404.1"> from </span><a id="_idIndexMarker711"/><span class="koboSpan" id="kobo.405.1">the context menu to open the </span><strong class="bold"><span class="koboSpan" id="kobo.406.1">NuGet package </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.407.1">manager</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.408.1"> window.</span></span></li>
<li class="upper-roman"><span class="koboSpan" id="kobo.409.1">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.410.1">Microsoft.Maui.Controls.Maps</span></strong><span class="koboSpan" id="kobo.411.1"> into the search box as </span><span class="No-Break"><span class="koboSpan" id="kobo.412.1">shown next:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer125">
<span class="koboSpan" id="kobo.413.1"><img alt="Figure 7.10 – Addin﻿g the .NET MAUI Maps package" src="image/B19214_07_10..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.414.1">Figure 7.10 – Adding the .NET MAUI Maps package</span></p>
<ol>
<li class="upper-roman" value="3"><span class="koboSpan" id="kobo.415.1">Finally, check the box next to </span><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">Microsoft.Maui.Controls.Maps</span></strong><span class="koboSpan" id="kobo.417.1"> and click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.418.1">Add Package</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.419.1">.</span></span></li>
</ol>
<ol>
<li value="4"><span class="koboSpan" id="kobo.420.1">Add the </span><a id="_idIndexMarker712"/><span class="koboSpan" id="kobo.421.1">Map initialization code by opening the </span><strong class="source-inline"><span class="koboSpan" id="kobo.422.1">MauiProgram.cs</span></strong><span class="koboSpan" id="kobo.423.1"> file and making the </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">highlighted change:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.425.1">
var builder = MauiApp.CreateBuilder();
builder
    .UseMauiApp&lt;App&gt;()
    .ConfigureFonts(fonts =&gt;
    {
        fonts.AddFont("OpenSans-Regular.ttf", "OpenSansRegular");
        fonts.AddFont("OpenSans-Semibold.ttf", "OpenSansSemibold");
    })
    </span><strong class="bold"><span class="koboSpan" id="kobo.426.1">.UseMauiMaps();</span></strong><span class="koboSpan" id="kobo.427.1">
    return builder.Build();</span></pre></li> <li><span class="koboSpan" id="kobo.428.1">Add the namespace for </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">Microsoft.Maui.Controls.Maps</span></strong><span class="koboSpan" id="kobo.430.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">MainView</span></strong><span class="koboSpan" id="kobo.432.1"> using the following </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">highlighted code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.434.1">
&lt;ContentPage 
             _idTextAnchor605"/&gt;<span class="koboSpan" id="kobo.435.1">om/winfx/2009/xaml"
    </span><strong class="bold"><span class="koboSpan" id="kobo.436.1">xmlns:</span><a id="_idTextAnchor606"/><span class="koboSpan" id="kobo.437.1">maps="clr-namespace:Microsoft.Maui.Controls.Maps;assembly=Microsoft.Maui.Controls.Maps"</span></strong><span class="koboSpan" id="kobo.438.1">
    x:Class="MeTracker.Views.MainView"
    Title="MainView"&gt;</span></span></pre><p class="list-inset"><span class="koboSpan" id="kobo.439.1">Now, we can </span><a id="_idIndexMarker713"/><span class="koboSpan" id="kobo.440.1">use the map in our view. </span><span class="koboSpan" id="kobo.440.2">Because we want </span><strong class="source-inline"><span class="koboSpan" id="kobo.441.1">Map</span></strong><span class="koboSpan" id="kobo.442.1"> to cover the whole page, we can add it to the root </span><span class="No-Break"><span class="koboSpan" id="kobo.443.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">ContentPage.</span></strong></span></p></li> <li><span class="koboSpan" id="kobo.445.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">Map</span></strong><span class="koboSpan" id="kobo.447.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">ContentPage</span></strong><span class="koboSpan" id="kobo.449.1"> with a name so that we can access it from the code-behind file. </span><span class="koboSpan" id="kobo.449.2">Name it </span><strong class="source-inline"><span class="koboSpan" id="kobo.450.1">Map</span></strong><span class="koboSpan" id="kobo.451.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.452.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.453.1">
&lt;ContentPage 
             
    
    x:Class="MeTracker.Views.MainView"
    Title="MainView"&gt;
    </span><strong class="bold"><span class="koboSpan" id="kobo.454.1">&lt;maps:Map x:Name="Map" /&gt;</span></strong><span class="koboSpan" id="kobo.455.1">
&lt;/ContentPage&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.456.1">Before we can start the app to see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.457.1">Map</span></strong><span class="koboSpan" id="kobo.458.1"> control for the first time, we need to set the shell to use our new </span><strong class="source-inline"><span class="koboSpan" id="kobo.459.1">MainView</span></strong><span class="koboSpan" id="kobo.460.1"> template instead of the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">MainPage</span></strong><span class="koboSpan" id="kobo.462.1"> template. </span><span class="koboSpan" id="kobo.462.2">But first, we will delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">MainPage.xaml</span></strong><span class="koboSpan" id="kobo.464.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.465.1">MainPage.xaml.cs</span></strong><span class="koboSpan" id="kobo.466.1"> files that we created when we started the project since we won’t be using </span><span class="No-Break"><span class="koboSpan" id="kobo.467.1">them here:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.468.1">Delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.469.1">MainPage.xaml</span></strong><span class="koboSpan" id="kobo.470.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.471.1">MainPage.xaml.cs</span></strong><span class="koboSpan" id="kobo.472.1"> files in the project since we will be setting our </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">MainView</span></strong><span class="koboSpan" id="kobo.474.1"> template as the first view that the </span><span class="No-Break"><span class="koboSpan" id="kobo.475.1">user sees.</span></span></li>
<li><span class="koboSpan" id="kobo.476.1">Edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">AppShell.xaml</span></strong><span class="koboSpan" id="kobo.478.1"> file, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">highlighted code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.480.1">
&lt;Shell
    x:Class="MeTracker.AppShell"
    
    
    
    </span><strong class="bold"><span class="koboSpan" id="kobo.481.1"/></strong><span class="koboSpan" id="kobo.482.1">
    Shell.FlyoutBehavior="Disabled"&gt;
    &lt;ShellContent
        Title="Home"
        ContentTemplate="{DataTemplate </span><strong class="bold"><span class="koboSpan" id="kobo.483.1">views:MainView</span></strong><span class="koboSpan" id="kobo.484.1">}"
        Route="</span><strong class="bold"><span class="koboSpan" id="kobo.485.1">MainView</span></strong><span class="koboSpan" id="kobo.486.1">" /&gt;
&lt;/Shell&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.487.1">Could we </span><a id="_idIndexMarker714"/><span class="koboSpan" id="kobo.488.1">have used the existing </span><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">MainPage</span></strong><span class="koboSpan" id="kobo.490.1"> template as it was? </span><span class="koboSpan" id="kobo.490.2">Sure – it really doesn’t make any difference to the compiler what the XAML file is named or where it is located, but for consistency and by MVVM convention in .NET MAUI, we put our </span><em class="italic"><span class="koboSpan" id="kobo.491.1">pages</span></em><span class="koboSpan" id="kobo.492.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.493.1">Views</span></strong><span class="koboSpan" id="kobo.494.1"> folder and suffix page names </span><span class="No-Break"><span class="koboSpan" id="kobo.495.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.496.1">Views</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.498.1">Choosing either Mac Catalyst or an iOS simulator and running the app will produce the result shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.499.1">Figure 7</span></em></span><em class="italic"><span class="koboSpan" id="kobo.500.1">.11</span></em><span class="koboSpan" id="kobo.501.1">. </span><span class="koboSpan" id="kobo.501.2">Android won’t work until we have completed the </span><span class="No-Break"><span class="koboSpan" id="kobo.502.1">next section:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer126">
<span class="koboSpan" id="kobo.503.1"><img alt="Figure 7.11 – Running the app after adding the Map control" src="image/B19214_07_11..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.504.1">Figure 7.11 – Running the app after adding the Map control</span></p>
<p><span class="koboSpan" id="kobo.505.1">Now that </span><a id="_idIndexMarker715"/><span class="koboSpan" id="kobo.506.1">we have a page with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.507.1">Map</span></strong><span class="koboSpan" id="kobo.508.1"> control on it, we will need to make sure we have permission from the user to use </span><span class="No-Break"><span class="koboSpan" id="kobo.509.1">location information.</span></span></p>
<h3><span class="koboSpan" id="kobo.510.1">Declaring platform-specific location permissions</span></h3>
<p><span class="koboSpan" id="kobo.511.1">To use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">Map</span></strong><span class="koboSpan" id="kobo.513.1"> control, we need to declare that we require permission to location information. </span><span class="koboSpan" id="kobo.513.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">Map</span></strong><span class="koboSpan" id="kobo.515.1"> control will make the runtime request if it is required. </span><span class="koboSpan" id="kobo.515.2">iOS/Mac Catalyst </span><a id="_idIndexMarker716"/><span class="koboSpan" id="kobo.516.1">and Android each have their own way of declaring the required permissions. </span><span class="koboSpan" id="kobo.516.2">We will start with iOS/Mac Catalyst, following which we will </span><span class="No-Break"><span class="koboSpan" id="kobo.517.1">do Android.</span></span></p>
<p><span class="koboSpan" id="kobo.518.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.519.1">info.plist</span></strong><span class="koboSpan" id="kobo.520.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">Platforms/iOS</span></strong><span class="koboSpan" id="kobo.522.1"> folder into </span><strong class="bold"><span class="koboSpan" id="kobo.523.1">Property List Editor</span></strong><span class="koboSpan" id="kobo.524.1"> by double-clicking on it. </span><span class="koboSpan" id="kobo.524.2">Add two new entries to the file, highlighted in the </span><span class="No-Break"><span class="koboSpan" id="kobo.525.1">next screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer127">
<span class="koboSpan" id="kobo.526.1"><img alt="Figure 7.12 – Editing info.plist for iOS" src="image/B19214_07_12..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.527.1">Figure 7.12 – Editing info.plist for iOS</span></p>
<p><span class="koboSpan" id="kobo.528.1">Make </span><a id="_idIndexMarker717"/><span class="koboSpan" id="kobo.529.1">the same changes in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.530.1">info.plist</span></strong><span class="koboSpan" id="kobo.531.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.532.1">Platforms/MacCatalyst</span></strong><span class="koboSpan" id="kobo.533.1"> folder, as </span><span class="No-Break"><span class="koboSpan" id="kobo.534.1">shown next:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer128">
<span class="koboSpan" id="kobo.535.1"><img alt="Figure 7.13 – Editing info.plist for Mac Catalyst" src="image/B19214_07_13..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.536.1">Figure 7.13 – Editing info.plist for Mac Catalyst</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.537.1">Windows users</span></p>
<p class="callout"><span class="koboSpan" id="kobo.538.1">To edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">info.plist</span></strong><span class="koboSpan" id="kobo.540.1"> files on Windows, you need to open the file in a text editor by right-clicking the file, selecting </span><strong class="bold"><span class="koboSpan" id="kobo.541.1">Open With…</span></strong><span class="koboSpan" id="kobo.542.1">, and then choosing </span><strong class="bold"><span class="koboSpan" id="kobo.543.1">XML Editor</span></strong><span class="koboSpan" id="kobo.544.1">. </span><span class="koboSpan" id="kobo.544.2">Then, add the entries highlighted in the next </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">code snippet.</span></span></p>
<p><span class="koboSpan" id="kobo.546.1">Editing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.547.1">info.plist</span></strong><span class="koboSpan" id="kobo.548.1"> file using the </span><strong class="bold"><span class="koboSpan" id="kobo.549.1">Property List Editor</span></strong><span class="koboSpan" id="kobo.550.1"> results in the changes </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">highlighted next:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.552.1">
    &lt;key&gt;XSAppIconAssets&lt;/key&gt;
    &lt;string&gt;Assets.xcassets/appicon.appiconset&lt;/string&gt;
    </span><strong class="bold"><span class="koboSpan" id="kobo.553.1">&lt;key&gt;NSLocationAlwaysAndWhenInUseUsageDescript</span><a id="_idTextAnchor607"/><span class="koboSpan" id="kobo.554.1">ion&lt;/key&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.555.1">    &lt;string&gt;Can we use your location at all tim</span><a id="_idTextAnchor608"/><span class="koboSpan" id="kobo.556.1">es?&lt;/string&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.557.1">    &lt;key&gt;NSLocationWhenInUseUsageDescript</span><a id="_idTextAnchor609"/><span class="koboSpan" id="kobo.558.1">ion&lt;/key&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.559.1">    &lt;string&gt;Can we use your location when your app is being used?&lt;/string&gt;</span></strong><span class="koboSpan" id="kobo.560.1">
&lt;/dict&gt;
&lt;/plist&gt;</span></pre> <p><span class="koboSpan" id="kobo.561.1">To track </span><a id="_idIndexMarker718"/><span class="koboSpan" id="kobo.562.1">the location of the user in the background with Android, we need to declare five permissions, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.563.1">following table:</span></span></p>
<table class="No-Table-Style" id="table001-1">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.564.1">ACCESS_COARSE_LOCATION</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.565.1">To get an approximate location for </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">the user</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.567.1">ACCESS_FINE_LOCATION</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.568.1">To get a precise location for </span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">the user</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.570.1">ACCESS_NETWORK_STATE</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.571.1">We need this because the location services in Android use information from a network to determine the location of </span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">the user</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.573.1">ACCESS_WIFI_STATE</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.574.1">We need this because the location services in Android use information from a Wi-Fi network to determine the location of </span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">the user</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.576.1">RECEIVE_BOOT_COMPLETED</span></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.577.1">So that the background job can start again after the device </span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">is rebooted</span></span></p>
</td>
</tr>
</tbody>
</table>
<p><span class="koboSpan" id="kobo.579.1">The following steps will declare the required permissions for </span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">our app:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.581.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.582.1">MainActivity.cs</span></strong><span class="koboSpan" id="kobo.583.1"> file in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">Platforms/Android</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.585.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.586.1">After the </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">using</span></strong><span class="koboSpan" id="kobo.588.1"> declarations’ block method, add the following </span><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">assembly</span></strong><span class="koboSpan" id="kobo.590.1"> attributes, </span><span class="No-Break"><span class="koboSpan" id="kobo.591.1">highlighted next:</span></span><pre class="source-code">
<a id="_idTextAnchor610"/><span class="koboSpan" id="kobo.592.1">using Android.App;
using Android.Runtime;
</span><strong class="bold"><a id="_idTextAnchor611"/><span class="koboSpan" id="kobo.593.1">[assembly: UsesPermission(Android.Manifest.Permission.AccessCoarseLocation)]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.594.1">[assembly: UsesPermission(Android.Manifest.Permission.AccessFineLocation)]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.595.1">[assembly: UsesPermission(Android.Manifest.Permission.AccessWifiState)]</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.596.1">[assembly: UsesPermission(Android.Manifest.Permission.ReceiveBootCompleted)]</span></strong><span class="koboSpan" id="kobo.597.1">
namespace MeTracker;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.598.1">Note that we don’t declare </span><strong class="source-inline"><span class="koboSpan" id="kobo.599.1">Android.Manifest.Permission.AccessNetworkState</span></strong><span class="koboSpan" id="kobo.600.1"> because it is part of the .NET </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">MAUI template.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.602.1">Now </span><a id="_idIndexMarker719"/><span class="koboSpan" id="kobo.603.1">that we have declared all the permissions that we require, we can enable the map services </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">on Android.</span></span></p>
<p><span class="koboSpan" id="kobo.605.1">Android requires an </span><strong class="bold"><span class="koboSpan" id="kobo.606.1">API key</span></strong><span class="koboSpan" id="kobo.607.1"> for </span><strong class="bold"><span class="koboSpan" id="kobo.608.1">Google Maps</span></strong><span class="koboSpan" id="kobo.609.1"> to work with maps. </span><span class="koboSpan" id="kobo.609.2">The Microsoft documentation regarding how to obtain an API key can be found at </span><a href="https://learn.microsoft.com/en-us/dotnet/maui/user-interface/controls/map?view=net-maui-7.0#get-a-google-maps-api-key"><span class="koboSpan" id="kobo.610.1">https://learn.microsoft.com/en-us/dotnet/maui/user-interface/controls/map?view=net-maui-7.0#get-a-google-maps-api-key</span></a><span class="koboSpan" id="kobo.611.1">. </span><span class="koboSpan" id="kobo.611.2">Follow those instructions to obtain your Google Maps key, then use your key in the following steps to configure the Google Maps API key in </span><span class="No-Break"><span class="koboSpan" id="kobo.612.1">the app:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.613.1">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.614.1">AndroidManifest.xml</span></strong><span class="koboSpan" id="kobo.615.1">, which is in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.616.1">Platforms/Android</span></strong><span class="koboSpan" id="kobo.617.1"> folder, by right-clicking on the file and selecting </span><strong class="bold"><span class="koboSpan" id="kobo.618.1">Open With…</span></strong><span class="koboSpan" id="kobo.619.1">, then selecting </span><strong class="bold"><span class="koboSpan" id="kobo.620.1">XML (</span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.621.1">Text) Editor</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.622.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.623.1">Insert a metadata element as a child of the application element, as shown in the following highlighted code, replacing </span><strong class="source-inline"><span class="koboSpan" id="kobo.624.1">"{YourKeyHere}"</span></strong><span class="koboSpan" id="kobo.625.1"> with the key you obtained </span><span class="No-Break"><span class="koboSpan" id="kobo.626.1">from Google:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.627.1">
&lt;application android:label="MeTracker.Android"&gt;
</span><strong class="bold"><span class="koboSpan" id="kobo.628.1">  &lt;meta-data android:name="com.google.android.geo.API_KEY" android:value="{YourKeyHere}" /&gt;</span></strong><span class="koboSpan" id="kobo.629.1">
&lt;/application&gt;</span><a id="_idTextAnchor612"/></pre></li> </ol>
<p><span class="koboSpan" id="kobo.630.1">Recent versions of Android and iOS have changed how permissions are handled. </span><span class="koboSpan" id="kobo.630.2">Certain permissions such as location are not granted without explicit approval from the user while the app is running. </span><span class="koboSpan" id="kobo.630.3">It is also possible that the user can deny permissions. </span><span class="koboSpan" id="kobo.630.4">Let’s look at how to handle runtime permission requests in the </span><span class="No-Break"><span class="koboSpan" id="kobo.631.1">next section.</span></span></p>
<h3><span class="koboSpan" id="kobo.632.1">Requesting location permission at runtime</span></h3>
<p><span class="koboSpan" id="kobo.633.1">Before we can use the location of the user, we need to request permissions from the user. </span><span class="koboSpan" id="kobo.633.2">.NET MAUI has cross-platform permission APIs, and we just need a tiny bit of code to make </span><a id="_idIndexMarker720"/><span class="koboSpan" id="kobo.634.1"> handling the request a little nicer. </span><span class="koboSpan" id="kobo.634.2">To implement the permission request handling, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.635.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.636.1">Create a new class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.637.1">AppPermissions</span></strong><span class="koboSpan" id="kobo.638.1"> in the root of </span><span class="No-Break"><span class="koboSpan" id="kobo.639.1">the project.</span></span></li>
<li><span class="koboSpan" id="kobo.640.1">Edit the new file to look like </span><span class="No-Break"><span class="koboSpan" id="kobo.641.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.642.1">
namespace MeTracker;
internal partial class AppPermissions
{
    internal partial class AppPermission : Permissions.LocationWhenInUse
    {
    }
    public static async Task&lt;PermissionStatus&gt; CheckRequiredPermissionAsync() =&gt; await Permissions.CheckStatusAsync&lt;AppPermission&gt;();
    public static async Task&lt;PermissionStatus&gt; CheckAndRequestRequiredPermissionAsync()
    {
        PermissionStatus status = await Permissions.CheckStatusAsync&lt;AppPermission&gt;();
        if (status == PermissionStatus.Granted)
            return status;
        if (status == PermissionStatus.Denied &amp;&amp; DeviceInfo.Platform == DevicePlatform.iOS)
        {
            // Prompt the user to turn on in settings
            // On iOS once a permission has been denied it may not be requested again from the application
            await App.Current.MainPage.DisplayAlert("Required App Permissions", "Please enable all permissions in Settings for this App, it is useless without them.", "Ok");
        }
        if (Permissions.ShouldShowRationale&lt;AppPermission&gt;())
        {
            // Prompt the user with additional information as to why the permission is needed
            await App.Current.MainPage.DisplayAlert("Required App Permissions", "This is a location based app, without these permissions it is useless.", "Ok");
        }
        status = await MainThread.InvokeOnMainThreadAsync(Permissions.RequestAsync&lt;AppPermission&gt;);
        return status;
    }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.643.1">This </span><a id="_idIndexMarker721"/><span class="koboSpan" id="kobo.644.1">creates a type named </span><strong class="source-inline"><span class="koboSpan" id="kobo.645.1">AppPermission</span></strong><span class="koboSpan" id="kobo.646.1"> that derives from the default .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.647.1">LocationWhenInUse</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.648.1">permission class.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.649.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">CheckRequiredPermission</span></strong><span class="koboSpan" id="kobo.651.1"> method is used to ensure our app has the right permissions before we attempt any operations that might fail if we don’t. </span><span class="koboSpan" id="kobo.651.2">Its implementation is to call the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.652.1">CheckSyncStatus</span></strong><span class="koboSpan" id="kobo.653.1"> method with our </span><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">AppPermission</span></strong><span class="koboSpan" id="kobo.655.1"> type. </span><span class="koboSpan" id="kobo.655.2">It returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.656.1">PermissionStatus</span></strong><span class="koboSpan" id="kobo.657.1"> type, which is an enum. </span><span class="koboSpan" id="kobo.657.2">We are mostly interested in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.658.1">Denied</span></strong><span class="koboSpan" id="kobo.659.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.660.1">Granted</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.661.1"> values.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.662.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.663.1">CheckAndRequestRequiredPermission</span></strong><span class="koboSpan" id="kobo.664.1"> method handles the intricacies of requesting access from the user. </span><span class="koboSpan" id="kobo.664.2">The first step is to simply check and see whether the permission has already been granted, and if it has, return the status. </span><span class="koboSpan" id="kobo.664.3">Next, if we are on iOS and the permission has been denied, it cannot be requested again, so you must instruct the user on how to grant permission to the app by using the settings panel. </span><span class="koboSpan" id="kobo.664.4">Android includes in the request behavior the ability to nag the user if they have denied access. </span><span class="koboSpan" id="kobo.664.5">This behavior is exposed through .NET MAUI with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.665.1">ShouldShowRationale</span></strong><span class="koboSpan" id="kobo.666.1"> method. </span><span class="koboSpan" id="kobo.666.2">It will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">false</span></strong><span class="koboSpan" id="kobo.668.1"> for any platform that does not support this behavior, and on Android, it will return </span><strong class="source-inline"><span class="koboSpan" id="kobo.669.1">true</span></strong><span class="koboSpan" id="kobo.670.1"> the first time the user denies access and </span><strong class="source-inline"><span class="koboSpan" id="kobo.671.1">false</span></strong><span class="koboSpan" id="kobo.672.1"> if the user denies it a second time. </span><span class="koboSpan" id="kobo.672.2">Finally, we request access to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.673.1">AppPermission</span></strong><span class="koboSpan" id="kobo.674.1"> type from the user. </span><span class="koboSpan" id="kobo.674.2">Again, .NET MAUI is hiding all the platform implementation details from us, making checking and requesting access to certain resources </span><span class="No-Break"><span class="koboSpan" id="kobo.675.1">very straightforward.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.676.1">Now that </span><a id="_idIndexMarker722"/><span class="koboSpan" id="kobo.677.1"> we have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.678.1">AppPermissions</span></strong><span class="koboSpan" id="kobo.679.1"> class in place, we can use it to request the current location of the user, and center that map on </span><span class="No-Break"><span class="koboSpan" id="kobo.680.1">that location.</span></span></p>
<h3><span class="koboSpan" id="kobo.681.1">Centering the map on the current user location</span></h3>
<p><span class="koboSpan" id="kobo.682.1">We will </span><a id="_idIndexMarker723"/><span class="koboSpan" id="kobo.683.1">center the map on the position of the user in the constructor of </span><strong class="source-inline"><span class="koboSpan" id="kobo.684.1">MainView.xaml.cs</span></strong><span class="koboSpan" id="kobo.685.1">. </span><span class="koboSpan" id="kobo.685.2">Because we want to fetch the user’s location asynchronously and this needs to be executed on the main thread, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.686.1">MainThread.BeginInvokeOnMainThread</span></strong><span class="koboSpan" id="kobo.687.1"> to run an anonymous method on the main thread. </span><span class="koboSpan" id="kobo.687.2">Once we have the location, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.688.1">MoveToRegion</span></strong><span class="koboSpan" id="kobo.689.1"> method of </span><strong class="source-inline"><span class="koboSpan" id="kobo.690.1">Map</span></strong><span class="koboSpan" id="kobo.691.1">. </span><span class="koboSpan" id="kobo.691.2">We can set this up by going through the </span><span class="No-Break"><span class="koboSpan" id="kobo.692.1">following steps:</span></span></p>
<ol>
<li><span class="No-Break"><span class="koboSpan" id="kobo.693.1">Open </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.694.1">MainView.xaml.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.695.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.696.1">Add the highlighted code shown in the following code snippet to the constructor of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.697.1">MainView.xaml.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.698.1"> class:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.699.1">
public MainView ()
{
    InitializeComponent();
    MainThread.BeginInvokeOnMainThread(async () =&gt;
    {
        var status = await AppPermissions.CheckAndRequestRequiredPermissionAsync();
        if (status == PermissionStatus.Granted)
        {
            var location = await Geolocation.GetLastKnownLocationAsync();
            if (location == null)
            {
                location = await Geolocation.GetLocationAsync();
            }
            Map.MoveToRegion(MapSpan.FromCenterAndRadius(
                location,
                Distance.FromKilometers(50)));
        }
    });
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.700.1">If you </span><a id="_idIndexMarker724"/><span class="koboSpan" id="kobo.701.1">run the application now, it should look something like </span><span class="No-Break"><span class="koboSpan" id="kobo.702.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer129">
<span class="koboSpan" id="kobo.703.1"><img alt="Figure 7.14 – Map centered on user location" src="image/B19214_07_14..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.704.1">Figure 7.14 – Map centered on user location</span></p>
<p><span class="koboSpan" id="kobo.705.1">Now that </span><a id="_idIndexMarker725"/><span class="koboSpan" id="kobo.706.1">we have the map displaying our current location, let’s start building the logic of the rest of the app, starting with our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.707.1">ViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.708.1"> class.</span></span></p>
<h3><span class="koboSpan" id="kobo.709.1">Creating a ViewModel class</span></h3>
<p><span class="koboSpan" id="kobo.710.1">Before we create an actual </span><strong class="source-inline"><span class="koboSpan" id="kobo.711.1">ViewModel</span></strong><span class="koboSpan" id="kobo.712.1"> class, we will create an abstract base view model that </span><a id="_idIndexMarker726"/><span class="koboSpan" id="kobo.713.1">all view models can inherit from. </span><span class="koboSpan" id="kobo.713.2">The idea behind this base view model is that we can write common code in it. </span><span class="koboSpan" id="kobo.713.3">In this case, we will implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.714.1">INotifyPropertyChanged</span></strong><span class="koboSpan" id="kobo.715.1"> interface by usi</span><a id="_idTextAnchor613"/><span class="koboSpan" id="kobo.716.1">ng the </span><strong class="source-inline"><span class="koboSpan" id="kobo.717.1">CommunityToolkit.Mvvm</span></strong><span class="koboSpan" id="kobo.718.1"> NuGet package. </span><span class="koboSpan" id="kobo.718.2">To add the package, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.719.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.720.1">Add a reference to </span><strong class="source-inline"><span class="koboSpan" id="kobo.721.1">CommunityToolkit.Mvvm</span></strong><span class="koboSpan" id="kobo.722.1"> by right-clicking the </span><strong class="source-inline"><span class="koboSpan" id="kobo.723.1">Dependencies</span></strong><span class="koboSpan" id="kobo.724.1"> node in </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.725.1">Solution Explorer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.726.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer130">
<span class="koboSpan" id="kobo.727.1"><img alt="Figure 7.15 – Adding the NuGet package" src="image/B19214_07_15..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.728.1">Figure 7.15 – Adding the NuGet package</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.729.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.730.1">Manage NuGet Packages…</span></strong><span class="koboSpan" id="kobo.731.1"> from </span><a id="_idIndexMarker727"/><span class="koboSpan" id="kobo.732.1">the context menu to open the </span><strong class="bold"><span class="koboSpan" id="kobo.733.1">NuGet package </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.734.1">manager</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.735.1"> window.</span></span></li>
<li><span class="koboSpan" id="kobo.736.1">Type </span><strong class="source-inline"><span class="koboSpan" id="kobo.737.1">CommunityToolkit.Mvvm</span></strong><span class="koboSpan" id="kobo.738.1"> into the search box, as </span><span class="No-Break"><span class="koboSpan" id="kobo.739.1">shown next:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer131">
<span class="koboSpan" id="kobo.740.1"><img alt="Figure 7.16 – Adding the CommunityToolkit.Mvvm package" src="image/B19214_07_16..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.741.1">Figure 7.16 – Adding the CommunityToolkit.Mvvm package</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.742.1">Finally, check the box next to </span><strong class="source-inline"><span class="koboSpan" id="kobo.743.1">CommunityToolkit.Mvvm</span></strong><span class="koboSpan" id="kobo.744.1"> and click </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.745.1">Add Package</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.746.1">.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.747.1">Now, we can </span><a id="_idIndexMarker728"/><span class="koboSpan" id="kobo.748.1">create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">ViewModel</span></strong><span class="koboSpan" id="kobo.750.1"> class by going through the </span><span class="No-Break"><span class="koboSpan" id="kobo.751.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.752.1">Create a folder called </span><strong class="source-inline"><span class="koboSpan" id="kobo.753.1">ViewModels</span></strong><span class="koboSpan" id="kobo.754.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.755.1">the project.</span></span></li>
<li><span class="koboSpan" id="kobo.756.1">Create a new class </span><span class="No-Break"><span class="koboSpan" id="kobo.757.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">ViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.759.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.760.1">Modify the template code to match </span><span class="No-Break"><span class="koboSpan" id="kobo.761.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.762.1">
using CommunityToolkit.Mvvm.ComponentModel;
namespace MeTracker.ViewModels;
public partial class ViewModel : ObservableObject
{
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.763.1">The next step </span><a id="_idIndexMarker729"/><span class="koboSpan" id="kobo.764.1">is to create the actual view model that will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.765.1">ViewModel</span></strong><span class="koboSpan" id="kobo.766.1"> as a base class. </span><span class="koboSpan" id="kobo.766.2">Let’s set this up by going through the </span><span class="No-Break"><span class="koboSpan" id="kobo.767.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.768.1">Create a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.769.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.770.1"> class in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.771.1">ViewModels</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.772.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.773.1">Make the </span><strong class="source-inline"><span class="koboSpan" id="kobo.774.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.775.1"> class </span><span class="No-Break"><span class="koboSpan" id="kobo.776.1">inherit </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.777.1">ViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.778.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.779.1">Add a read-only field of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.780.1">ILocationTrackingService</span></strong><span class="koboSpan" id="kobo.781.1"> type and name </span><span class="No-Break"><span class="koboSpan" id="kobo.782.1">it </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">locationTrackingService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.784.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.785.1">Add a read-only field of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.786.1">ILocationRepository</span></strong><span class="koboSpan" id="kobo.787.1"> type and name </span><span class="No-Break"><span class="koboSpan" id="kobo.788.1">it </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.789.1">locationRepository</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.790.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.791.1">Create a constructor with </span><strong class="source-inline"><span class="koboSpan" id="kobo.792.1">ILocationTrackingService</span></strong><span class="koboSpan" id="kobo.793.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.794.1">ILocationRepository</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.795.1">as parameters.</span></span></li>
<li><span class="koboSpan" id="kobo.796.1">Set the values of the fields that we created in </span><em class="italic"><span class="koboSpan" id="kobo.797.1">steps 3</span></em><span class="koboSpan" id="kobo.798.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.799.1">4</span></em><span class="koboSpan" id="kobo.800.1"> with the values from the parameters, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.801.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.802.1">
public class MainViewModel : View</span><a id="_idTextAnchor614"/><span class="koboSpan" id="kobo.803.1">Model
{
    private readonly ILocationRepository locationRepository;
    private readonly ILocationTrackingService locationTrackingService;
    public MainViewModel(ILocationTrackingService locationTrackingService,
        ILocationRepository locationRepository)
    {
        </span><strong class="bold"><span class="koboSpan" id="kobo.804.1">this.locationTrackingService = locationTrackingService;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.805.1">        this.locationRepository = locationRepository;</span></strong>
<a id="_idTextAnchor615"/><span class="koboSpan" id="kobo.806.1">    }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.807.1">To make the app start tracking the location of a user, we need to run the code that starts the tracking process on the main thread. </span><span class="koboSpan" id="kobo.807.2">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.808.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.809.1">In the constructor of the newly created </span><strong class="source-inline"><span class="koboSpan" id="kobo.810.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.811.1"> class, add an invocation to the main thread </span><span class="No-Break"><span class="koboSpan" id="kobo.812.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.813.1">MainThread.BeginInvokeOnMainThread</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.814.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.815.1">Call </span><strong class="source-inline"><span class="koboSpan" id="kobo.816.1">locationService.StartTracking</span></strong><span class="koboSpan" id="kobo.817.1"> in the action that we pass to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.818.1">BeginInvokeOnMainThread</span></strong><span class="koboSpan" id="kobo.819.1"> method. </span><span class="koboSpan" id="kobo.819.2">This is shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.820.1">highlighted code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.821.1">
public MainViewModel(ILocationTrackingService locationTrackingService, ILocationRepository locationRepository)
{
    this.locationTrackingService = locationTrackingService;
    this.locationRepository = locationRepository;
</span><strong class="bold"><span class="koboSpan" id="kobo.822.1">    MainThread.BeginInvokeOnMainThread(() =&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.823.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.824.1">        locationTrackingService.StartTracking();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.825.1">    });</span></strong><span class="koboSpan" id="kobo.826.1">
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.827.1">Finally, we need </span><a id="_idIndexMarker730"/><span class="koboSpan" id="kobo.828.1">to inject a </span><strong class="source-inline"><span class="koboSpan" id="kobo.829.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.830.1"> class into the constructor of </span><strong class="source-inline"><span class="koboSpan" id="kobo.831.1">MainView</span></strong><span class="koboSpan" id="kobo.832.1"> and assign the </span><strong class="source-inline"><span class="koboSpan" id="kobo.833.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.834.1"> instance to the binding context of the view. </span><span class="koboSpan" id="kobo.834.2">This will allow what data binding we’ve done to be processed, and the properties of </span><strong class="source-inline"><span class="koboSpan" id="kobo.835.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.836.1"> will be bound to the controls in the user interface. </span><span class="koboSpan" id="kobo.836.2">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.837.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.838.1">Go to the constructor of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.839.1">Views/MainView.xaml.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.840.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.841.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.842.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.843.1"> as a parameter of the constructor and call </span><span class="No-Break"><span class="koboSpan" id="kobo.844.1">it </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.845.1">viewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.846.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.847.1">Set </span><strong class="source-inline"><span class="koboSpan" id="kobo.848.1">BindingContext</span></strong><span class="koboSpan" id="kobo.849.1"> as the instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.850.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.851.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.852.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.853.1">
public MainView(</span><strong class="bold"><span class="koboSpan" id="kobo.854.1">MainViewModel viewModel</span></strong><span class="koboSpan" id="kobo.855.1">)
{
    InitializeCom</span><a id="_idTextAnchor616"/><span class="koboSpan" id="kobo.856.1">ponent();
    </span><strong class="bold"><span class="koboSpan" id="kobo.857.1">BindingContext = viewModel;</span></strong><span class="koboSpan" id="kobo.858.1">
    MainThread.BeginInvokeOnMainThread(async () =&gt;
    {
        var location = await Geolocation.GetLastKnownLocationAsync();
        if(location == null)
        {
            location = await Geolocation.GetLocationAsync();
        }
        Map.MoveToRegion(MapSpan.FromCenterAndRadius(
            location, Distance.FromKilometers(5)));
    });
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.859.1">In order </span><a id="_idIndexMarker731"/><span class="koboSpan" id="kobo.860.1">for .NET MAUI to locate the classes </span><a id="_idIndexMarker732"/><span class="koboSpan" id="kobo.861.1">we have implemented in this section so far, we need to add them to the </span><strong class="bold"><span class="koboSpan" id="kobo.862.1">dependency injection</span></strong><span class="koboSpan" id="kobo.863.1"> (</span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.864.1">DI</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.865.1">) container.</span></span></p>
<h3><span class="koboSpan" id="kobo.866.1">Adding classes to the DI container</span></h3>
<p><span class="koboSpan" id="kobo.867.1">Since we </span><a id="_idIndexMarker733"/><span class="koboSpan" id="kobo.868.1">have added a parameter to the constructor of the view, the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.869.1">View</span></strong><span class="koboSpan" id="kobo.870.1"> framework won’t be able to construct the view automatically. </span><span class="koboSpan" id="kobo.870.2">So, we need to add </span><strong class="source-inline"><span class="koboSpan" id="kobo.871.1">MainView</span></strong><span class="koboSpan" id="kobo.872.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.873.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.874.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.875.1">LocationTrackingService</span></strong><span class="koboSpan" id="kobo.876.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.877.1">LocationRepository</span></strong><span class="koboSpan" id="kobo.878.1"> instances to the DI container. </span><span class="koboSpan" id="kobo.878.2">To do that, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.879.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.880.1">Open the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.881.1">MauiProgram.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.882.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.883.1">Add the following highlighted lines to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.884.1">CreateMauiApp</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.885.1"> method:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.886.1">
public static MauiApp CreateMauiApp()
{
    var builder = MauiApp.CreateBuilder();
    builder
        .UseMauiApp&lt;App&gt;()
        .ConfigureFonts(fonts =&gt;
        {
            fonts.AddFont("OpenSans-Regular.ttf", "OpenSansRegular");
            fonts.AddFont("OpenSans-Semibold.ttf", "OpenSansSemibold");
        })
        .UseMauiMaps(); 
#if DEBUG
    builder.Logging.AddDebug();
#endif
</span><strong class="bold"><span class="koboSpan" id="kobo.887.1">        </span></strong><span class="koboSpan" id="kobo.888.1">    </span><strong class="bold"><span class="koboSpan" id="kobo.889.1">builder.Services.AddSingleton&lt;Services.ILocationTrackingService, Services.LocationTrackingService&gt;();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.890.1">        builder.Services.AddSingleton&lt;Repositories.ILocationRepository, Repositories.LocationRepository&gt;();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.891.1">        builder.Services.AddTransient(typeof(ViewModels.MainViewModel));</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.892.1">        builder.Services.AddTransient(typeof(Views.MainView));</span></strong><span class="koboSpan" id="kobo.893.1">
    return builder.Build();
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.894.1">Now, we will </span><a id="_idIndexMarker734"/><span class="koboSpan" id="kobo.895.1">be able to run the app again. </span><span class="koboSpan" id="kobo.895.2">We haven’t changed any of the interfaces, so it should look and behave the same as before. </span><span class="koboSpan" id="kobo.895.3">If it doesn’t, go back through the previous section carefully to make sure you have all the </span><span class="No-Break"><span class="koboSpan" id="kobo.896.1">code correct.</span></span></p>
<p><span class="koboSpan" id="kobo.897.1">Let’s add some code so that we can track the user’s location over time using background </span><span class="No-Break"><span class="koboSpan" id="kobo.898.1">locati</span><a id="_idTextAnchor617"/><a id="_idTextAnchor618"/><a id="_idTextAnchor619"/><a id="_idTextAnchor620"/><a id="_idTextAnchor621"/><a id="_idTextAnchor622"/><a id="_idTextAnchor623"/><a id="_idTextAnchor624"/><span class="koboSpan" id="kobo.899.1">on tracking.</span></span></p>
<h2 id="_idParaDest-127"><a id="_idTextAnchor625"/><span class="koboSpan" id="kobo.900.1">Background location tracking on iOS and Mac Catalyst</span></h2>
<p><span class="koboSpan" id="kobo.901.1">The </span><a id="_idIndexMarker735"/><span class="koboSpan" id="kobo.902.1">code for location tracking </span><a id="_idIndexMarker736"/><span class="koboSpan" id="kobo.903.1">is something that we need to write for each platform. </span><span class="koboSpan" id="kobo.903.2">For iOS and Mac Catalyst, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.904.1">CLLocationManager</span></strong><span class="koboSpan" id="kobo.905.1"> from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.906.1">CoreLocat</span><a id="_idTextAnchor626"/><a id="_idTextAnchor627"/><span class="koboSpan" id="kobo.907.1">ion</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.908.1"> namespace.</span></span></p>
<h3><span class="koboSpan" id="kobo.909.1">Enabling location updates in the background</span></h3>
<p><span class="koboSpan" id="kobo.910.1">When </span><a id="_idIndexMarker737"/><span class="koboSpan" id="kobo.911.1">we want to perform tasks in the background in an iOS or Mac Catalyst app, we need to declare what we want to do in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.912.1">info.plist</span></strong><span class="koboSpan" id="kobo.913.1"> file. </span><span class="koboSpan" id="kobo.913.2">The following steps show how we go </span><span class="No-Break"><span class="koboSpan" id="kobo.914.1">about this:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.915.1">Open </span><strong class="source-inline"><span class="koboSpan" id="kobo.916.1">info.plist</span></strong><span class="koboSpan" id="kobo.917.1">; you will need to do this for both </span><strong class="source-inline"><span class="koboSpan" id="kobo.918.1">Platforms/iOS/info.plist </span></strong><span class="No-Break"><span class="koboSpan" id="kobo.919.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.920.1">Platforms/MacCatalyst/info.plist</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.921.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.922.1">Add the following highlighted entry using the </span><strong class="bold"><span class="koboSpan" id="kobo.923.1">Property List Editor</span></strong><span class="koboSpan" id="kobo.924.1"> by selecting </span><strong class="bold"><span class="koboSpan" id="kobo.925.1">Required background modes</span></strong><span class="koboSpan" id="kobo.926.1"> from the dropdown and </span><strong class="bold"><span class="koboSpan" id="kobo.927.1">App registers for location updates</span></strong><span class="koboSpan" id="kobo.928.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.929.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer132">
<span class="koboSpan" id="kobo.930.1"><img alt="Figure 7.17 – Adding location updates" src="image/B19214_07_17..jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.931.1">Figure 7.17 – Adding location updates</span></p>
<p><span class="koboSpan" id="kobo.932.1">We can also enable background modes directly in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.933.1">info.plist</span></strong><span class="koboSpan" id="kobo.934.1"> file if we open it with an XML editor. </span><span class="koboSpan" id="kobo.934.2">In this case, we will add the </span><span class="No-Break"><span class="koboSpan" id="kobo.935.1">following XML:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.936.1">
&lt;key&gt;UIBackgroundModes&lt;/key&gt;
&lt;array&gt;
&lt;string&gt;location&lt;/st</span><a id="_idTextAnchor628"/><a id="_idTextAnchor629"/><a id="_idTextAnchor630"/><a id="_idTextAnchor631"/><span class="koboSpan" id="kobo.937.1">ring&gt;
&lt;/array&gt;</span></pre> <h3><span class="koboSpan" id="kobo.938.1">Subscribing to location updates</span></h3>
<p><span class="koboSpan" id="kobo.939.1">Now that we have prepared the </span><strong class="source-inline"><span class="koboSpan" id="kobo.940.1">info.plist</span></strong><span class="koboSpan" id="kobo.941.1"> file for location tracking, it is time to write </span><a id="_idIndexMarker738"/><span class="koboSpan" id="kobo.942.1">the actual code that will track the location of the user. </span><span class="koboSpan" id="kobo.942.2">If we don’t set </span><strong class="source-inline"><span class="koboSpan" id="kobo.943.1">CLLocationManager</span></strong><span class="koboSpan" id="kobo.944.1"> to not pause location updates, location updates can be paused automatically by iOS or Mac Catalyst when the location data is unlikely to change. </span><span class="koboSpan" id="kobo.944.2">In this app, we don’t want that to happen because we want to save the location multiple times so that we can establish whether a user visits a particular </span><span class="No-Break"><span class="koboSpan" id="kobo.945.1">location frequently.</span></span></p>
<p><span class="koboSpan" id="kobo.946.1">If you recall from earlier, we already defined the service as a partial class with a partial method; now, we will finish the service by implementing the platform-specific pieces of the service. </span><span class="koboSpan" id="kobo.946.2">Let’s set </span><span class="No-Break"><span class="koboSpan" id="kobo.947.1">this up:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.948.1">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.949.1">Services</span></strong><span class="koboSpan" id="kobo.950.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.951.1">Platforms/iOS</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.952.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.953.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.954.1">LocationTrackingService</span></strong><span class="koboSpan" id="kobo.955.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.956.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.957.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.958.1">Modify the class to match </span><span class="No-Break"><span class="koboSpan" id="kobo.959.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.960.1">
namespace MeTracker.Services;
public partial class LocationTrackingService : ILocationTr</span><a id="_idTextAnchor632"/><span class="koboSpan" id="kobo.961.1">ackingService
{
    partial void StartTrackingInternal()
    {
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.962.1">Add a private field </span><span class="No-Break"><span class="koboSpan" id="kobo.963.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.964.1">CLLocationManager</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.965.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.966.1">Create an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.967.1">CLLocationManager</span></strong><span class="koboSpan" id="kobo.968.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.969.1">StartTrackingInternal</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.970.1"> method.</span></span></li>
<li><span class="koboSpan" id="kobo.971.1">Set </span><strong class="source-inline"><span class="koboSpan" id="kobo.972.1">PausesLocationUpdatesAutomatically</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.973.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.974.1">false</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.975.1">.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.976.1">Before we can start tracking the location of the user, we need to set the accuracy of the data that we want to receive from </span><strong class="source-inline"><span class="koboSpan" id="kobo.977.1">CLLocationManager</span></strong><span class="koboSpan" id="kobo.978.1">. </span><span class="koboSpan" id="kobo.978.2">We will also add an event handler to handle </span><span class="No-Break"><span class="koboSpan" id="kobo.979.1">location updates.</span></span></p></li>
<li><span class="koboSpan" id="kobo.980.1">Set </span><strong class="source-inline"><span class="koboSpan" id="kobo.981.1">DesiredAccuracy</span></strong><span class="koboSpan" id="kobo.982.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.983.1">CLLocation.</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.984.1">Accuracy</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.985.1">BestForNavigation</span></strong><span class="koboSpan" id="kobo.986.1">. </span><span class="koboSpan" id="kobo.986.2">One of the constraints when running the app in the background is that </span><strong class="source-inline"><span class="koboSpan" id="kobo.987.1">DesiredAccuracy</span></strong><span class="koboSpan" id="kobo.988.1"> needs to be set to either </span><strong class="source-inline"><span class="koboSpan" id="kobo.989.1">Accuracy</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.990.1">Best</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.991.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.992.1">Accuracy</span></strong></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.993.1">BestForNavigation</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.994.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.995.1">Set </span><strong class="source-inline"><span class="koboSpan" id="kobo.996.1">AllowBackgroundLocationUpdates</span></strong><span class="koboSpan" id="kobo.997.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.998.1">true</span></strong><span class="koboSpan" id="kobo.999.1"> (as shown in the following code snippet) so that the location updates will continue, even when the app is running in </span><span class="No-Break"><span class="koboSpan" id="kobo.1000.1">the background.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1001.1">Your </span><a id="_idIndexMarker739"/><span class="koboSpan" id="kobo.1002.1">changes should</span><a id="_idTextAnchor633"/><span class="koboSpan" id="kobo.1003.1"> look </span><span class="No-Break"><span class="koboSpan" id="kobo.1004.1">like this:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1005.1">CLLocation l</span><a id="_idTextAnchor634"/><a id="_idTextAnchor635"/><span class="koboSpan" id="kobo.1006.1">ocationManager;</span></strong><span class="koboSpan" id="kobo.1007.1">
partial void StartTrac</span><a id="_idTextAnchor636"/><span class="koboSpan" id="kobo.1008.1">kingInternal()
{
</span><strong class="bold"><span class="koboSpan" id="kobo.1009.1">    locationManager = new CLLocationManager</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1010.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1011.1">        PausesLocationUpdatesAutomatically = false,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1012.1">        DesiredAccuracy = CLLocation.</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1013.1">Accuracy</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1014.1">BestForNavigation,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1015.1">        AllowsBackgroundLocationUpdates = true</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1016.1">    };</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1017.1">    // Add code here</span></strong><span class="koboSpan" id="kobo.1018.1">
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1019.1">The next step is to ask the user for permission to track their location. </span><span class="koboSpan" id="kobo.1019.2">We will request permission to track their location all the time, but the user has the option of only giving us permission to track their location when they are using the app. </span><span class="koboSpan" id="kobo.1019.3">Because the user also has the option of denying us permission to track their location, we need to check this before we start. </span><span class="koboSpan" id="kobo.1019.4">Let’s set </span><span class="No-Break"><span class="koboSpan" id="kobo.1020.1">this up:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1021.1">Add an event handler for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1022.1">LocationsUpdated</span></strong><span class="koboSpan" id="kobo.1023.1"> just after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1024.1">// Add code here</span></strong><span class="koboSpan" id="kobo.1025.1"> comment. </span><span class="koboSpan" id="kobo.1025.2">It should look like the code highlighted in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1026.1">fo</span><a id="_idTextAnchor637"/><span class="koboSpan" id="kobo.1027.1">llowing snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1028.1">
partial void StartTrackingInternal()
{
    locationManager = new CLLocationManager
    {
        PausesLocationUpdatesAutomatically = false,
        DesiredAccuracy = CLLocation.AccuracyBestForNavigation,
        AllowsBackgroundLocationUpdates = true
    };
    // Add code here
</span><strong class="bold"><span class="koboSpan" id="kobo.1029.1">    locationManager.LocationsUpdated +=</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1030.1">async (object sender, CLLocationsUpdatedEventArgs e) </span><a id="_idTextAnchor638"/><span class="koboSpan" id="kobo.1031.1">=&gt;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1032.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1033.1">        // Final block of code goes here</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1034.1">    };</span></strong><span class="koboSpan" id="kobo.1035.1">
};</span></pre></li> <li><span class="koboSpan" id="kobo.1036.1">After </span><a id="_idIndexMarker740"/><span class="koboSpan" id="kobo.1037.1">the event handler, call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1038.1">RequestAlwaysAuthorization</span></strong><span class="koboSpan" id="kobo.1039.1"> method of the instance that we recently created </span><span class="No-Break"><span class="koboSpan" id="kobo.1040.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1041.1">C</span><a id="_idTextAnchor639"/><span class="koboSpan" id="kobo.1042.1">LLocationManager</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1043.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1044.1">
partial void StartTrackingInternal()
{
    locationManager = new CLLocationManager
    {
        PausesLocationUpdatesAutomatically = false,
        DesiredAccuracy = CLLocation.AccurracyBestForNavigation,
        AllowsBackgroundLocationUpdates = true
    };
    // Add code here
    locationManager.LocationsUpdated +=
async (object sender, CLLocationsUpdatedEventArgs e) =&gt;
    {
        // Final block of code goes here
    };
</span><strong class="bold"><span class="koboSpan" id="kobo.1045.1">    locationManager.RequestAlwaysAuthorization();</span></strong><span class="koboSpan" id="kobo.1046.1">
};</span></pre></li> <li><span class="koboSpan" id="kobo.1047.1">Then, call </span><a id="_idIndexMarker741"/><span class="koboSpan" id="kobo.1048.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1049.1">StartUpdatingLocation</span></strong><span class="koboSpan" id="kobo.1050.1"> method </span><span class="No-Break"><span class="koboSpan" id="kobo.1051.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1052.1">locationManager</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1053.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1054.1">
partial void StartTrackingInternal()
{
    locationManager = new CLLocationManager
    {
        PausesLocationUpdatesAutomatically = false,
        DesiredAccuracy = CLLocation.AccurracyBestForNavigation,
        AllowsBackgroundLocationUpdates = true
    };
  </span><a id="_idTextAnchor640"/><span class="koboSpan" id="kobo.1055.1">  // Add code here
    locationManager.LocationsUpdated +=
async (object sender, CLLocationsUpdatedEventArgs e</span><a id="_idTextAnchor641"/><span class="koboSpan" id="kobo.1056.1">) =&gt;
    {
        // Final block of code</span><a id="_idTextAnchor642"/><span class="koboSpan" id="kobo.1057.1"> goes here
    };
    locationManager.RequestAlwaysAuthorization();
</span><strong class="bold"><span class="koboSpan" id="kobo.1058.1">    locationManager.StartUpdatingLocation();</span></strong><span class="koboSpan" id="kobo.1059.1">
};</span></pre></li> </ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.1060.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1061.1">The higher the accuracy is, the higher the battery consumption. </span><span class="koboSpan" id="kobo.1061.2">If we only want to track where the user has been and not how popular a place is, we could also set </span><strong class="source-inline"><span class="koboSpan" id="kobo.1062.1">AllowDeferredLocationUpdatesUntil</span></strong><span class="koboSpan" id="kobo.1063.1">. </span><span class="koboSpan" id="kobo.1063.2">This way, we can specify that the user has to move a specific distance before the location is updated. </span><span class="koboSpan" id="kobo.1063.3">We can also specify how often we want the location to be updated using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1064.1">timeout</span></strong><span class="koboSpan" id="kobo.1065.1"> argument. </span><span class="koboSpan" id="kobo.1065.2">The most power-efficient solution to track how long a user has been at a place is to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1066.1">StartMonitoringVisits</span></strong><span class="koboSpan" id="kobo.1067.1"> method </span><span class="No-Break"><span class="koboSpan" id="kobo.1068.1">of </span><a id="_idTextAnchor643"/></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1069.1">CLLocationManager</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1070.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1071.1">Now, it’s time </span><a id="_idIndexMarker742"/><span class="koboSpan" id="kobo.1072.1">to handle the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1073.1">LocationsUpdated</span></strong><span class="koboSpan" id="kobo.1074.1"> event. </span><span class="koboSpan" id="kobo.1074.2">Let’s go through the </span><span class="No-Break"><span class="koboSpan" id="kobo.1075.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1076.1">Add a private field called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1077.1">locationRepository</span></strong><span class="koboSpan" id="kobo.1078.1"> that is of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1079.1">ILocationRepository</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1080.1"> type.</span></span></li>
<li><span class="koboSpan" id="kobo.1081.1">Add a constructor that has </span><strong class="source-inline"><span class="koboSpan" id="kobo.1082.1">ILocationRepository</span></strong><span class="koboSpan" id="kobo.1083.1"> as a parameter. </span><span class="koboSpan" id="kobo.1083.2">Set the value of the parameter to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1084.1">locationRepository</span></strong><span class="koboSpan" id="kobo.1085.1"> field. </span><span class="koboSpan" id="kobo.1085.2">Your class should resemble the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1086.1">code snippet:</span></span><pre class="source-code">
<a id="_idTextAnchor644"/><span class="koboSpan" id="kobo.1087.1">using CoreLocation;
</span><strong class="bold"><span class="koboSpan" id="kobo.1088.1">using MeTracker.Repositories;</span></strong><span class="koboSpan" id="kobo.1089.1">
namespace MeTracker.Services;
public partial class LocationTrackingService : ILocationTrackingService
{
    CLLocationManag</span><a id="_idTextAnchor645"/><span class="koboSpan" id="kobo.1090.1">er locationManager;
</span><strong class="bold"><span class="koboSpan" id="kobo.1091.1">    ILocationRepository locationRepository;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1092.1">    public LocationTrackingService(ILocationRepository locationRepository)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1093.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1094.1">        this.locationRepository = locationRepository;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1095.1">    }</span></strong><span class="koboSpan" id="kobo.1096.1">
    partial void Star</span><a id="_idTextAnchor646"/><span class="koboSpan" id="kobo.1097.1">tTrackingInternal()
    {
    // Remainder of code </span><a id="_idTextAnchor647"/><span class="koboSpan" id="kobo.1098.1">omitted for brevity
    }</span></pre></li> <li><span class="koboSpan" id="kobo.1099.1">Read the latest location of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1100.1">Locations</span></strong><span class="koboSpan" id="kobo.1101.1"> property </span><span class="No-Break"><span class="koboSpan" id="kobo.1102.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1103.1">CLLocationsUpdatedEventArgs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1104.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1105.1">Create an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1106.1">MeTracker.Models.Location</span></strong><span class="koboSpan" id="kobo.1107.1"> and pass the latitude and longitude of the latest location </span><span class="No-Break"><span class="koboSpan" id="kobo.1108.1">to it.</span></span></li>
<li><span class="koboSpan" id="kobo.1109.1">Save </span><a id="_idIndexMarker743"/><span class="koboSpan" id="kobo.1110.1">the location using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1111.1">SaveAsync</span></strong><span class="koboSpan" id="kobo.1112.1"> method </span><span class="No-Break"><span class="koboSpan" id="kobo.1113.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1114.1">ILocationRepository</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1115.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1116.1">The code should be placed after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1117.1">// Final block of code goes here</span></strong><span class="koboSpan" id="kobo.1118.1"> comment. </span><span class="koboSpan" id="kobo.1118.2">It should look like the code shown in bold in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1119.1">following fragment:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1120.1">
locationManager.LocationsUpdated +=
async (object sender, CLLocationsUpdatedEventArgs e) =&gt;
{
    // Final blo</span><a id="_idTextAnchor648"/><span class="koboSpan" id="kobo.1121.1">ck of code goes here
    </span><strong class="bold"><span class="koboSpan" id="kobo.1122.1">var lastLocation = e.Locations.Last();</span></strong><span class="koboSpan" id="kobo.1123.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.1124.1">var newLocation = new Models.Location(lastLocation.Coordinate.Latitude, lastLocation.Coordinate.Longitude);</span></strong><span class="koboSpan" id="kobo.1125.1">
     </span><strong class="bold"><span class="koboSpan" id="kobo.1126.1">await locationRepository.SaveAsync(newLocation);</span></strong><span class="koboSpan" id="kobo.1127.1">
};</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1128.1">With that, we have completed the tracking part of the app for iOS. </span><span class="koboSpan" id="kobo.1128.2">The implementation is identical for Mac Catalyst; you can either repeat the steps in this section for Mac Catalyst (but create the file as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1129.1">Platforms/MacCatalyst/Services</span></strong><span class="koboSpan" id="kobo.1130.1"> instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1131.1">Platforms/iOS/S</span><a id="_idTextAnchor649"/><span class="koboSpan" id="kobo.1132.1">ervices</span></strong><span class="koboSpan" id="kobo.1133.1">) or copy the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1134.1">Platforms/iOS/Services/LocationTrackingService.cs</span></strong><span class="koboSpan" id="kobo.1135.1"> file to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1136.1">Platforms/MacCatalyst/Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1137.1"> folder.</span></span></p>
<p><span class="koboSpan" id="kobo.1138.1">No</span><a id="_idTextAnchor650"/><span class="koboSpan" id="kobo.1139.1">w, we will implement background tracking for Android, following which we will visualize the loc</span><a id="_idTextAnchor651"/><span class="koboSpan" id="kobo.1140.1">ation </span><span class="No-Break"><span class="koboSpan" id="kobo.1141.1">tracking data.</span></span></p>
<h2 id="_idParaDest-128"><a id="_idTextAnchor652"/><span class="koboSpan" id="kobo.1142.1">Background location tracking with Android</span></h2>
<p><span class="koboSpan" id="kobo.1143.1">The </span><a id="_idIndexMarker744"/><span class="koboSpan" id="kobo.1144.1">Android way to carry out background updates is very different from how we implemented it with iOS. </span><span class="koboSpan" id="kobo.1144.2">With Android, we need to create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1145.1">JobService</span></strong><span class="koboSpan" id="kobo.1146.1"> c</span><a id="_idTextAnchor653"/><a id="_idTextAnchor654"/><a id="_idTextAnchor655"/><a id="_idTextAnchor656"/><a id="_idTextAnchor657"/><span class="koboSpan" id="kobo.1147.1">lass and </span><span class="No-Break"><span class="koboSpan" id="kobo.1148.1">schedule it.</span></span></p>
<h3><span class="koboSpan" id="kobo.1149.1">Creating a background job</span></h3>
<p><span class="koboSpan" id="kobo.1150.1">To track the location of users in the background, we need to create a background job. </span><span class="koboSpan" id="kobo.1150.2">A background </span><a id="_idIndexMarker745"/><span class="koboSpan" id="kobo.1151.1">job is used by the OS to allow developers to execute code even when the app is not in the foreground or visible on the screen. </span><span class="koboSpan" id="kobo.1151.2">Follow these steps to create a background job to capture a </span><span class="No-Break"><span class="koboSpan" id="kobo.1152.1">user’s location:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1153.1">Create a new folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1154.1">Services</span></strong><span class="koboSpan" id="kobo.1155.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1156.1">Platforms/Android</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1157.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.1158.1">Create a new class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1159.1">LocationJobService</span></strong><span class="koboSpan" id="kobo.1160.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1161.1">Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1162.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.1163.1">Make the class inherit from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1164.1">Android.App.Job.JobServic</span><a id="_idTextAnchor658"/><span class="koboSpan" id="kobo.1165.1">e</span></strong><span class="koboSpan" id="kobo.1166.1"> as a </span><span class="No-Break"><span class="koboSpan" id="kobo.1167.1">base class.</span></span></li>
<li><span class="koboSpan" id="kobo.1168.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1169.1">using Android.App.Job</span></strong><span class="koboSpan" id="kobo.1170.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1171.1">using Android.App.Job</span></strong><span class="koboSpan" id="kobo.1172.1"> declarations to the top of </span><span class="No-Break"><span class="koboSpan" id="kobo.1173.1">the file.</span></span></li>
<li><span class="koboSpan" id="kobo.1174.1">Implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1175.1">OnStartJob</span></strong><span class="koboSpan" id="kobo.1176.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1177.1">OnStopJob</span></strong><span class="koboSpan" id="kobo.1178.1"> abstract methods, as shown in the f</span><a id="_idTextAnchor659"/><span class="koboSpan" id="kobo.1179.1">ollowing </span><span class="No-Break"><span class="koboSpan" id="kobo.1180.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1181.1">
using Android.App;
using Android.App.Job;
namespace MeTracker.Platforms.Android.Services;
internal class LocationJobService : JobService
{
    public override bool OnStartJob(JobParameters @params)
    {
        return true;
    }
    public override bool OnStopJob(JobParameters @params)
    {
        return true;
    }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1182.1">All the Android services in the app need to be added to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1183.1">AndroidManifest.xml</span></strong><span class="koboSpan" id="kobo.1184.1"> file. </span><span class="koboSpan" id="kobo.1184.2">We don't have to do this manually; instead, we can add an attribute to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1185.1">LocationJobService</span></strong><span class="koboSpan" id="kobo.1186.1"> class, which will then be generated in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1187.1">AndroidManifest.xml</span></strong><span class="koboSpan" id="kobo.1188.1"> file. </span><span class="koboSpan" id="kobo.1188.2">We will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1189.1">Name</span></strong><span class="koboSpan" id="kobo.1190.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1191.1">Permission</span></strong><span class="koboSpan" id="kobo.1192.1"> properties to set the required information, as shown in the f</span><a id="_idTextAnchor660"/><span class="koboSpan" id="kobo.1193.1">ollowing </span><span class="No-Break"><span class="koboSpan" id="kobo.1194.1">code snippet:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1195.1">[Service(Name = "MeTracker.Platforms.Android.Services.LocationJobService", Permission = "android.permission.BIND_JOB_SERVICE")]</span></strong><span class="koboSpan" id="kobo.1196.1">
internal class LocationJ</span><a id="_idTextAnchor661"/><a id="_idTextAnchor662"/><a id="_idTextAnchor663"/><span class="koboSpan" id="kobo.1197.1">obService : JobService</span></pre> <h3><span class="koboSpan" id="kobo.1198.1">Scheduling a background job</span></h3>
<p><span class="koboSpan" id="kobo.1199.1">When we have created a job, we need to schedule it. </span><span class="koboSpan" id="kobo.1199.2">We will do this from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1200.1">LocationTrackingService</span></strong><span class="koboSpan" id="kobo.1201.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1202.1">Platforms/Android</span></strong><span class="koboSpan" id="kobo.1203.1"> folder. </span><span class="koboSpan" id="kobo.1203.2">To configure the job, we will use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1204.1">JobInfo.Builder</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1205.1"> class.</span></span></p>
<p><span class="koboSpan" id="kobo.1206.1">We will </span><a id="_idIndexMarker746"/><span class="koboSpan" id="kobo.1207.1">use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1208.1">SetPersisted</span></strong><span class="koboSpan" id="kobo.1209.1"> method to ensure that the job starts again after a reboot. </span><span class="koboSpan" id="kobo.1209.2">This is why we added the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1210.1">RECEIVE_BOOT_COMPLETED</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1211.1">permission earlier.</span></span></p>
<p><span class="koboSpan" id="kobo.1212.1">To schedule a job, at least one constraint is needed. </span><span class="koboSpan" id="kobo.1212.2">In this case, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1213.1">SetOverrideDeadline</span></strong><span class="koboSpan" id="kobo.1214.1">. </span><span class="koboSpan" id="kobo.1214.2">This will specify that the job needs to run before the specified time (in milliseconds) </span><span class="No-Break"><span class="koboSpan" id="kobo.1215.1">has elapsed.</span></span></p>
<p><span class="koboSpan" id="kobo.1216.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1217.1">SetRequiresDeviceIdle</span></strong><span class="koboSpan" id="kobo.1218.1"> method can be used to make sure that a job only runs when the device is not being used by a user. </span><span class="koboSpan" id="kobo.1218.2">We could pass </span><strong class="source-inline"><span class="koboSpan" id="kobo.1219.1">true</span></strong><span class="koboSpan" id="kobo.1220.1"> to the method if we want to make sure that we don’t slow down the device when the user is </span><span class="No-Break"><span class="koboSpan" id="kobo.1221.1">using it.</span></span></p>
<p><span class="koboSpan" id="kobo.1222.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1223.1">SetRequiresBatteryNotLow</span></strong><span class="koboSpan" id="kobo.1224.1"> method can be used to specify that a job should not run when the battery level is low. </span><span class="koboSpan" id="kobo.1224.2">We recommend that this always be set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1225.1">true</span></strong><span class="koboSpan" id="kobo.1226.1"> if you don’t have a good reason to run the job when the battery is low. </span><span class="koboSpan" id="kobo.1226.2">This is because we don’t want our applications to drain the </span><span class="No-Break"><span class="koboSpan" id="kobo.1227.1">user’s battery.</span></span></p>
<p><span class="koboSpan" id="kobo.1228.1">So, let’s implement </span><strong class="source-inline"><span class="koboSpan" id="kobo.1229.1">LocationTrackingService</span></strong><span class="koboSpan" id="kobo.1230.1">. </span><span class="koboSpan" id="kobo.1230.2">Follow these steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.1231.1">do so:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1232.1">Create a new class named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1233.1">LocationTrackingService</span></strong><span class="koboSpan" id="kobo.1234.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1235.1">Platforms/Android/Services</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1236.1"> folder.</span></span></li>
<li><span class="koboSpan" id="kobo.1237.1">Modify the class to l</span><a id="_idTextAnchor664"/><span class="koboSpan" id="kobo.1238.1">ook like </span><span class="No-Break"><span class="koboSpan" id="kobo.1239.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1240.1">
namespace MeTracker.Services;
public partial class LocationTrackingService : ILocationTrackingService
{
    partial void </span><a id="_idTextAnchor665"/><span class="koboSpan" id="kobo.1241.1">StartTrackingInternal()
    {
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.1242.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1243.1">JobInfo.Builder</span></strong><span class="koboSpan" id="kobo.1244.1"> class based on an ID that we’ll specify (we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1245.1">1</span></strong><span class="koboSpan" id="kobo.1246.1"> here) and the component name (which we’ll create from the application context and the Java class) in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1247.1">StartTrackingInternal</span></strong><span class="koboSpan" id="kobo.1248.1"> method. </span><span class="koboSpan" id="kobo.1248.2">The component </span><a id="_idIndexMarker747"/><span class="koboSpan" id="kobo.1249.1">name is used to specify which code will run during </span><span class="No-Break"><span class="koboSpan" id="kobo.1250.1">the job.</span></span></li>
<li><span class="koboSpan" id="kobo.1251.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1252.1">SetOverrideDeadline</span></strong><span class="koboSpan" id="kobo.1253.1"> method and pass </span><strong class="source-inline"><span class="koboSpan" id="kobo.1254.1">1000</span></strong><span class="koboSpan" id="kobo.1255.1"> to it to make the job run before 1 second has elapsed from when the job </span><span class="No-Break"><span class="koboSpan" id="kobo.1256.1">was created.</span></span></li>
<li><span class="koboSpan" id="kobo.1257.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1258.1">SetPersisted</span></strong><span class="koboSpan" id="kobo.1259.1"> method and pass </span><strong class="source-inline"><span class="koboSpan" id="kobo.1260.1">true</span></strong><span class="koboSpan" id="kobo.1261.1"> to make the job persist even after the device </span><span class="No-Break"><span class="koboSpan" id="kobo.1262.1">is rebooted.</span></span></li>
<li><span class="koboSpan" id="kobo.1263.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1264.1">SetRequiresDeviceIdle</span></strong><span class="koboSpan" id="kobo.1265.1"> method and pass </span><strong class="source-inline"><span class="koboSpan" id="kobo.1266.1">false</span></strong><span class="koboSpan" id="kobo.1267.1"> so that the job will run even when a user is using </span><span class="No-Break"><span class="koboSpan" id="kobo.1268.1">the device.</span></span></li>
<li><span class="koboSpan" id="kobo.1269.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1270.1">SetRequiresBatteryLow</span></strong><span class="koboSpan" id="kobo.1271.1"> method and pass </span><strong class="source-inline"><span class="koboSpan" id="kobo.1272.1">true</span></strong><span class="koboSpan" id="kobo.1273.1"> to make sure that we don’t drain the user’s battery. </span><span class="koboSpan" id="kobo.1273.2">This method was added in Android API </span><span class="No-Break"><span class="koboSpan" id="kobo.1274.1">level 26.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1275.1">The code for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1276.1">LocationTrackingService</span></strong><span class="koboSpan" id="kobo.1277.1"> sh</span><a id="_idTextAnchor666"/><span class="koboSpan" id="kobo.1278.1">ould now look </span><span class="No-Break"><span class="koboSpan" id="kobo.1279.1">like this:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1280.1">using Android.App.Job;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1281.1">using Android.Content;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1282.1">using MeTracker.Platforms.Android.Services;</span></strong><span class="koboSpan" id="kobo.1283.1">
namespace MeTracker.Services;
public partial class LocationTrackingService : ILocationTrackingService
{
    partial void Start</span><a id="_idTextAnchor667"/><span class="koboSpan" id="kobo.1284.1">TrackingInternal()
    {
</span><strong class="bold"><span class="koboSpan" id="kobo.1285.1">        var javaClass = Java.Lang.Class.FromType(typeof(LocationJobService));</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1286.1">        var componentName = new ComponentName(global::Android.App.Application.Context, javaClass);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1287.1">        var jobBuilder = new JobInfo.Builder(1, componentName);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1288.1">        jobBuilder.SetOverrideDeadline(1000);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1289.1">        jobBuilder.SetPersisted(true);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1290.1">        jobBuilder.SetRequiresDeviceIdle(false);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1291.1">        jobBuilder.SetRequiresBatteryNotLow(true);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1292.1">        var jobInfo = jobBuilder.Build();</span></strong><span class="koboSpan" id="kobo.1293.1">
    }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1294.1">The last </span><a id="_idIndexMarker748"/><span class="koboSpan" id="kobo.1295.1">step in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1296.1">StartTrackingInternal</span></strong><span class="koboSpan" id="kobo.1297.1"> method is to schedule the job with the system using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1298.1">JobScheduler</span></strong><span class="koboSpan" id="kobo.1299.1">. </span><span class="koboSpan" id="kobo.1299.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1300.1">JobScheduler</span></strong><span class="koboSpan" id="kobo.1301.1"> service is an Android system service. </span><span class="koboSpan" id="kobo.1301.2">To get an instance of a system service, we will use the application context. </span><span class="koboSpan" id="kobo.1301.3">Follow these steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.1302.1">do so:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1303.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1304.1">GetSystemService</span></strong><span class="koboSpan" id="kobo.1305.1"> method on </span><strong class="source-inline"><span class="koboSpan" id="kobo.1306.1">Application.Context</span></strong><span class="koboSpan" id="kobo.1307.1"> to get the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1308.1">JobScheduler</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1309.1"> service.</span></span></li>
<li><span class="koboSpan" id="kobo.1310.1">Cast the result </span><span class="No-Break"><span class="koboSpan" id="kobo.1311.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1312.1">JobScheduler</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1313.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1314.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1315.1">Schedule</span></strong><span class="koboSpan" id="kobo.1316.1"> method on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1317.1">JobScheduler</span></strong><span class="koboSpan" id="kobo.1318.1"> class and pass the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1319.1">JobInfo</span></strong><span class="koboSpan" id="kobo.1320.1"> object to schedule the job, as shown in th</span><a id="_idTextAnchor668"/><span class="koboSpan" id="kobo.1321.1">e following </span><span class="No-Break"><span class="koboSpan" id="kobo.1322.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1323.1">
var jobScheduler = (JobScheduler)global::Android.App.Application.Context.GetSystemService(Context.JobSchedulerService);
jobScheduler.Schedule(jobInfo);</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1324.1">Now that </span><a id="_idIndexMarker749"/><span class="koboSpan" id="kobo.1325.1">the job is scheduled, we can start receiving location updates</span><a id="_idTextAnchor669"/><a id="_idTextAnchor670"/><span class="koboSpan" id="kobo.1326.1">; let’s work on </span><span class="No-Break"><span class="koboSpan" id="kobo.1327.1">that next.</span></span></p>
<h3><span class="koboSpan" id="kobo.1328.1">Subscribing to location updates</span></h3>
<p><span class="koboSpan" id="kobo.1329.1">Once we </span><a id="_idIndexMarker750"/><span class="koboSpan" id="kobo.1330.1">have scheduled the job, we can write the code to specify what the job should do – that is, track the location of a user. </span><span class="koboSpan" id="kobo.1330.2">To do this, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1331.1">LocationManager</span></strong><span class="koboSpan" id="kobo.1332.1">, which is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1333.1">SystemService</span></strong><span class="koboSpan" id="kobo.1334.1"> class. </span><span class="koboSpan" id="kobo.1334.2">With </span><strong class="source-inline"><span class="koboSpan" id="kobo.1335.1">LocationManager</span></strong><span class="koboSpan" id="kobo.1336.1">, we can either request a single location update or we can subscribe to location updates. </span><span class="koboSpan" id="kobo.1336.2">In this case, we want to subscribe to </span><span class="No-Break"><span class="koboSpan" id="kobo.1337.1">location updates.</span></span></p>
<p><span class="koboSpan" id="kobo.1338.1">We will start by creating an instance of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1339.1">ILocationRepository</span></strong><span class="koboSpan" id="kobo.1340.1"> interface. </span><span class="koboSpan" id="kobo.1340.2">We will use this to save the locations to the SQLite database. </span><span class="koboSpan" id="kobo.1340.3">Let’s set </span><span class="No-Break"><span class="koboSpan" id="kobo.1341.1">this up:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1342.1">Create a constructor </span><span class="No-Break"><span class="koboSpan" id="kobo.1343.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1344.1">LocationJobService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1345.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1346.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1347.1">private</span></strong><span class="koboSpan" id="kobo.1348.1"> read-only field for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1349.1">ILocationRepository</span></strong><span class="koboSpan" id="kobo.1350.1"> interface </span><span class="No-Break"><span class="koboSpan" id="kobo.1351.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1352.1">locationRepository</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1353.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1354.1">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1355.1">Services.GetService&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.1356.1"> in the constructor to create an instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1357.1">ILocationRepository</span></strong><span class="koboSpan" id="kobo.1358.1">, as shown in </span><a id="_idTextAnchor671"/><span class="koboSpan" id="kobo.1359.1">the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1360.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1361.1">
private ILocationRepo</span><a id="_idTextAnchor672"/><span class="koboSpan" id="kobo.1362.1">sitory locationRepository;
public</span><a id="_idTextAnchor673"/><span class="koboSpan" id="kobo.1363.1"> LocationJobService()
{
    locationReposito</span><a id="_idTextAnchor674"/><span class="koboSpan" id="kobo.1364.1">ry = MauiApplication.Current.Services.GetService&lt;ILocationRepository&gt;();
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1365.1">Before we subscribe to location updates, we will add a listener. </span><span class="koboSpan" id="kobo.1365.2">To do this, we will use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1366.1">Android.Locations.ILocationListener</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1367.1"> interface.</span></span></p>
<p><a id="_idTextAnchor675"/><span class="koboSpan" id="kobo.1368.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1369.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1370.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1371.1">Android.Locations.ILocationListener</span></strong><span class="koboSpan" id="kobo.1372.1"> interface </span><span class="No-Break"><span class="koboSpan" id="kobo.1373.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1374.1">LocationJobService</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1375.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1376.1">Add the following namespace declarations to the top of </span><span class="No-Break"><span class="koboSpan" id="kobo.1377.1">the file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1378.1">
using Android.Content;
using Android.Locations;
using Android.OS;
using Android.Runtime;
using MeTracker.Repositories;</span></pre></li> <li><span class="koboSpan" id="kobo.1379.1">Implement </span><a id="_idIndexMarker751"/><span class="koboSpan" id="kobo.1380.1">the interface and remove all instances of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1381.1">throw </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1382.1">new NotImplemented</span></strong></span><strong class="source-inline"><span class="koboSpan" id="kobo.1383.1">
Exception();</span></strong><span class="koboSpan" id="kobo.1384.1">. </span><span class="koboSpan" id="kobo.1384.2">This is added to the methods when you let Visual Studio generate an implementation of </span><span class="No-Break"><span class="koboSpan" id="kobo.1385.1">the interface.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1386.1">The method implementations should look like those in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1387.1">code snippet:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1388.1">
    public override bool OnStartJob(JobParameters @params)
    {
        return true;
    }
    public void OnLocationChanged(global::Android.Locations.Location location) { }
    public override bool OnStopJob(JobParameters @params) =&gt; true;
    public void OnStatusChanged(string provider, [GeneratedEnum] Availability status, Bundle extras) { }
    public void OnProviderDisabled(string provider) { }
    public void OliknProviderEnabled(string provider) { }</span></pre></li> <li><span class="koboSpan" id="kobo.1389.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1390.1">OnLocationChanged</span></strong><span class="koboSpan" id="kobo.1391.1"> method, map the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1392.1">Android.Locations.Location</span></strong><span class="koboSpan" id="kobo.1393.1"> object to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1394.1">Model.Location</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1395.1"> object.</span></span></li>
<li><span class="koboSpan" id="kobo.1396.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1397.1">SaveAsync</span></strong><span class="koboSpan" id="kobo.1398.1"> method on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1399.1">LocationRepository</span></strong><span class="koboSpan" id="kobo.1400.1"> class, as shown in the </span><a id="_idIndexMarker752"/><span class="koboSpan" id="kobo.1401.1">following </span><span class="No-Break"><span class="koboSpan" id="kobo.1402.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1403.1">
public void OnLocationChanged(Android.L</span><a id="_idTextAnchor676"/><span class="koboSpan" id="kobo.1404.1">ocations.Location location)
{
</span><strong class="source-inline"><span class="koboSpan" id="kobo.1405.1">var newLocation = new Models.Location(location.Latitude, location.Longitude);</span></strong>
<strong class="source-inline"><span class="koboSpan" id="kobo.1406.1">locationReposit</span><a id="_idTextAnchor677"/><span class="koboSpan" id="kobo.1407.1">ory.SaveAsync(newLocation);</span></strong><span class="koboSpan" id="kobo.1408.1">
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1409.1">Now that we have created a listener, we can subscribe to location updates. </span><span class="koboSpan" id="kobo.1409.2">Follow these steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.1410.1">do so:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1411.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1412.1">static</span></strong><span class="koboSpan" id="kobo.1413.1"> field of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1414.1">LocationManager</span></strong><span class="koboSpan" id="kobo.1415.1"> type named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1416.1">locationManager</span></strong><span class="koboSpan" id="kobo.1417.1">. </span><span class="koboSpan" id="kobo.1417.2">Make sure it has the same lifetime as </span><span class="No-Break"><span class="koboSpan" id="kobo.1418.1">the app.</span></span></li>
<li><span class="koboSpan" id="kobo.1419.1">It is possible in Android that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1420.1">JobService</span></strong><span class="koboSpan" id="kobo.1421.1"> will start before </span><strong class="source-inline"><span class="koboSpan" id="kobo.1422.1">MainView</span></strong><span class="koboSpan" id="kobo.1423.1"> is displayed and we request location permissions. </span><span class="koboSpan" id="kobo.1423.2">To prevent any errors due to missing permissions, we will check for </span><span class="No-Break"><span class="koboSpan" id="kobo.1424.1">them first:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1425.1">
public override bool OnStar</span><a id="_idTextAnchor678"/><span class="koboSpan" id="kobo.1426.1">tJob(JobParameters @params)
{
    PermissionStatus status = PermissionStatus.Unknown;
    Task.Run(async ()=&gt; status = await AppPermissions.CheckRequiredPermissionAsync()).Wait();
    if (status == PermissionStatus.Granted)
    {
    }
}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1427.1">We run </span><strong class="source-inline"><span class="koboSpan" id="kobo.1428.1">CheckRequiredPermissionsAsync</span></strong><span class="koboSpan" id="kobo.1429.1"> inside a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1430.1">Task.Run</span></strong><span class="koboSpan" id="kobo.1431.1"> instance because it’s an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1432.1">async</span></strong><span class="koboSpan" id="kobo.1433.1"> call, and we can’t add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1434.1">async</span></strong><span class="koboSpan" id="kobo.1435.1"> to the method because the return </span><a id="_idIndexMarker753"/><span class="koboSpan" id="kobo.1436.1">type is incompatible. </span><span class="koboSpan" id="kobo.1436.2">The call to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1437.1">Wait</span></strong><span class="koboSpan" id="kobo.1438.1"> turns the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1439.1">async</span></strong><span class="koboSpan" id="kobo.1440.1"> call into a synchronous one. </span><span class="koboSpan" id="kobo.1440.2">If the result is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1441.1">Granted</span></strong><span class="koboSpan" id="kobo.1442.1">, then we </span><span class="No-Break"><span class="koboSpan" id="kobo.1443.1">can continue.</span></span></p></li> <li><span class="koboSpan" id="kobo.1444.1">Go to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1445.1">StartJob</span></strong><span class="koboSpan" id="kobo.1446.1"> method in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1447.1">LocationJobService</span></strong><span class="koboSpan" id="kobo.1448.1">. </span><span class="koboSpan" id="kobo.1448.2">Get </span><strong class="source-inline"><span class="koboSpan" id="kobo.1449.1">LocationManager</span></strong><span class="koboSpan" id="kobo.1450.1"> by using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1451.1">GetSystemService</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1452.1">on </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1453.1">ApplicationContext</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1454.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1455.1">To subscribe for location updates, use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1456.1">RequestLocationUpdates</span></strong><span class="koboSpan" id="kobo.1457.1"> method, as shown </span><a id="_idTextAnchor679"/><span class="koboSpan" id="kobo.1458.1">in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1459.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1460.1">
public override bool OnSt</span><a id="_idTextAnchor680"/><span class="koboSpan" id="kobo.1461.1">artJob(JobParameters @params)
{
    PermissionStatus status = PermissionStatus.Unknown;
    Task.Run(async ()=&gt; status = await AppPermissions.CheckRequiredPermissionAsync()).Wait();
    if (status == PermissionStatus.Granted)
    {
        </span><strong class="bold"><span class="koboSpan" id="kobo.1462.1">locationManager = (LocationManager)ApplicationContext.GetSystemService  (Context.LocationService);</span></strong><span class="koboSpan" id="kobo.1463.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.1464.1">    locationManager.RequestLocationUpdates (LocationManager.GpsProvider, 1000L, 0.1f, this);</span></strong><span class="koboSpan" id="kobo.1465.1">
        return true;
    }
    return false;
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1466.1">The first argument that we pass to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1467.1">RequestLocationUpdates</span></strong><span class="koboSpan" id="kobo.1468.1"> method ensures that we get locations from the GPS. </span><span class="koboSpan" id="kobo.1468.2">The second ensures that at least </span><strong class="source-inline"><span class="koboSpan" id="kobo.1469.1">1000</span></strong><span class="koboSpan" id="kobo.1470.1"> milliseconds will elapse </span><a id="_idIndexMarker754"/><span class="koboSpan" id="kobo.1471.1">between location updates. </span><span class="koboSpan" id="kobo.1471.2">The third argument ensures that the user moves at least </span><strong class="source-inline"><span class="koboSpan" id="kobo.1472.1">0.1</span></strong><span class="koboSpan" id="kobo.1473.1"> meters to get a location update. </span><span class="koboSpan" id="kobo.1473.2">The last argument specifies which listener we should use. </span><span class="koboSpan" id="kobo.1473.3">Because the current class implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1474.1">Android.Locations.ILocationListener</span></strong><span class="koboSpan" id="kobo.1475.1"> interface, we will </span><span class="No-Break"><span class="koboSpan" id="kobo.1476.1">pass </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1477.1">this</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1478.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1479.1">Now that we have collected location data on from the user and stored it in our SQLite database, we can </span><a id="_idTextAnchor681"/><a id="_idTextAnchor682"/><span class="koboSpan" id="kobo.1480.1">now display that data on </span><span class="No-Break"><span class="koboSpan" id="kobo.1481.1">a map.</span></span></p>
<h2 id="_idParaDest-129"><a id="_idTextAnchor683"/><span class="koboSpan" id="kobo.1482.1">Creating a heat map</span></h2>
<p><span class="koboSpan" id="kobo.1483.1">To visualize the data that we have collected, we will create a heat map. </span><span class="koboSpan" id="kobo.1483.2">We will add lots of dots to </span><a id="_idIndexMarker755"/><span class="koboSpan" id="kobo.1484.1">the map and make them different colors, based on how much time a user spends in a particular place. </span><span class="koboSpan" id="kobo.1484.2">The most popular places will </span><a id="_idIndexMarker756"/><span class="koboSpan" id="kobo.1485.1">have a warm color, while the least popular places will have a </span><span class="No-Break"><span class="koboSpan" id="kobo.1486.1">cold color.</span></span></p>
<p><span class="koboSpan" id="kobo.1487.1">Before we add the dots to the map, we need to get a</span><a id="_idTextAnchor684"/><a id="_idTextAnchor685"/><a id="_idTextAnchor686"/><span class="koboSpan" id="kobo.1488.1">ll locations from </span><span class="No-Break"><span class="koboSpan" id="kobo.1489.1">the repository.</span></span></p>
<h3><span class="koboSpan" id="kobo.1490.1">Adding the GetAllAsync method to LocationRepository</span></h3>
<p><span class="koboSpan" id="kobo.1491.1">In order </span><a id="_idIndexMarker757"/><span class="koboSpan" id="kobo.1492.1">to visualize the data, we </span><a id="_idIndexMarker758"/><span class="koboSpan" id="kobo.1493.1">need to write some code </span><a id="_idIndexMarker759"/><span class="koboSpan" id="kobo.1494.1">so that location data can be read from the database. </span><span class="koboSpan" id="kobo.1494.2">Let’s set </span><span class="No-Break"><span class="koboSpan" id="kobo.1495.1">this up:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1496.1">Open the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1497.1">ILocationRepository.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1498.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.1499.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1500.1">GetAllAsync</span></strong><span class="koboSpan" id="kobo.1501.1"> method that returns a list of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1502.1">Location</span></strong><span class="koboSpan" id="kobo.1503.1"> objects, using the </span><span class="No-Break"><span class="koboSpan" id="kobo.1504.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1505.1">
Task&lt;List&lt;Models.Location&gt;&gt; GetAllAsync();</span></pre></li> <li><span class="koboSpan" id="kobo.1506.1">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1507.1">LocationRepository.cs</span></strong><span class="koboSpan" id="kobo.1508.1"> file, which </span><span class="No-Break"><span class="koboSpan" id="kobo.1509.1">implements </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1510.1">ILocationRepository</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1511.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1512.1">Implement the new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1513.1">GetAllAsync</span></strong><span class="koboSpan" id="kobo.1514.1"> method and return all the saved locations in the database, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1515.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1516.1">
public async Task&lt;List&lt;Location&gt;&gt; GetAllAsync()
{
    await CreateConnectionAsync();
    var locations = await connection.Table&lt;Location&gt; ().ToL</span><a id="_idTextAnchor687"/><a id="_idTextAnchor688"/><span class="koboSpan" id="kobo.1517.1">istAsync();
    return locations;
}</span></pre></li> </ol>
<h3><span class="koboSpan" id="kobo.1518.1">Preparing the data for visualization</span></h3>
<p><span class="koboSpan" id="kobo.1519.1">Before we </span><a id="_idIndexMarker760"/><span class="koboSpan" id="kobo.1520.1">can visualize the data on the map, we need </span><a id="_idIndexMarker761"/><span class="koboSpan" id="kobo.1521.1">to prepare the data. </span><span class="koboSpan" id="kobo.1521.2">The first thing we will do is create a new model that we can use for the prepared data. </span><span class="koboSpan" id="kobo.1521.3">Let’s set </span><span class="No-Break"><span class="koboSpan" id="kobo.1522.1">this up:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1523.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1524.1">Models</span></strong><span class="koboSpan" id="kobo.1525.1"> folder, create a new class </span><span class="No-Break"><span class="koboSpan" id="kobo.1526.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1527.1">Point</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1528.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1529.1">Add properties for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1530.1">Location</span></strong><span class="koboSpan" id="kobo.1531.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1532.1">Count</span></strong><span class="koboSpan" id="kobo.1533.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1534.1">Heat</span></strong><span class="koboSpan" id="kobo.1535.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1536.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1537.1">
namespace M</span><a id="_idTextAnchor689"/><span class="koboSpan" id="kobo.1538.1">eTracker.Models{
public class Point
{
    public Location Location { get; set; }
    public int Count { get; set; } = 1;
    public Color Heat { get; set; }
}
}</span></pre><p class="list-inset"><strong class="source-inline"><span class="koboSpan" id="kobo.1539.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.1540.1"> will store the locations that we will find later on. </span><span class="koboSpan" id="kobo.1540.2">Let’s add a property for </span><span class="No-Break"><span class="koboSpan" id="kobo.1541.1">storing points.</span></span></p></li> <li><span class="koboSpan" id="kobo.1542.1">Open the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1543.1">MainViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1544.1"> class.</span></span></li>
<li><span class="koboSpan" id="kobo.1545.1">Add a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1546.1">private</span></strong><span class="koboSpan" id="kobo.1547.1"> field called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1548.1">points</span></strong><span class="koboSpan" id="kobo.1549.1">, which is of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1550.1">List&lt;Point&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1551.1"> type.</span></span></li>
<li><span class="koboSpan" id="kobo.1552.1">Add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1553.1">ObservableProperty</span></strong><span class="koboSpan" id="kobo.1554.1"> attribute to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1555.1">points</span></strong><span class="koboSpan" id="kobo.1556.1"> field, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1557.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1558.1">
[ObservableProperty]
private List&lt;Models.Point&gt; points;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1559.1">Now that we have storage for our points, we must add some code so that we can add locations. </span><span class="koboSpan" id="kobo.1559.2">We will do this by implementing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1560.1">LoadDataAsync</span></strong><span class="koboSpan" id="kobo.1561.1"> method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1562.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.1563.1"> class and making sure that it is called on the main thread, right after location tracking </span><span class="No-Break"><span class="koboSpan" id="kobo.1564.1">has started.</span></span></p>
<p><span class="koboSpan" id="kobo.1565.1">The first thing </span><a id="_idIndexMarker762"/><span class="koboSpan" id="kobo.1566.1">we will do is group the saved locations so that all locations within 200 meters will be handled as one point. </span><span class="koboSpan" id="kobo.1566.2">We will track </span><a id="_idIndexMarker763"/><span class="koboSpan" id="kobo.1567.1">how many times we have logged a position within that point so that we can decide which color the point will be on the map. </span><span class="koboSpan" id="kobo.1567.2">Let’s set </span><span class="No-Break"><span class="koboSpan" id="kobo.1568.1">this up:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1569.1">Add an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1570.1">async</span></strong><span class="koboSpan" id="kobo.1571.1"> method called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1572.1">LoadDataAsync</span></strong><span class="koboSpan" id="kobo.1573.1">. </span><span class="koboSpan" id="kobo.1573.2">This returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1574.1">Task</span></strong><span class="koboSpan" id="kobo.1575.1"> object </span><span class="No-Break"><span class="koboSpan" id="kobo.1576.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1577.1">Main</span></strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1578.1">ViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1579.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1580.1">Call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1581.1">LoadDataAsync</span></strong><span class="koboSpan" id="kobo.1582.1"> method from the constructor after the call to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1583.1">StartTracking</span></strong><span class="koboSpan" id="kobo.1584.1"> method on </span><strong class="source-inline"><span class="koboSpan" id="kobo.1585.1">ILocationTrackingService</span></strong><span class="koboSpan" id="kobo.1586.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1587.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1588.1">
public MainViewModel(ILocationTrackingService locationTrackingService, ILocationRepository locationRepository)
{
    this.locationTrackingService = locationTrackingService;
    this.locationRepository = locationRepository;
    MainThread.BeginInvokeOnMainThread(</span><strong class="bold"><span class="koboSpan" id="kobo.1589.1">async</span></strong><span class="koboSpan" id="kobo.1590.1">() =&gt;
    {
        locationTrackingService.StartTracking();
        </span><strong class="bold"><span class="koboSpan" id="kobo.1591.1">await LoadDataAsync();</span></strong><span class="koboSpan" id="kobo.1592.1">
    });
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1593.1">The first step of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1594.1">LoadDataAsync</span></strong><span class="koboSpan" id="kobo.1595.1"> method is to read all tracked locations from the SQLite database. </span><span class="koboSpan" id="kobo.1595.2">When we have all the locations, we will loop through them and </span><span class="No-Break"><span class="koboSpan" id="kobo.1596.1">create points.</span></span></p>
<p><span class="koboSpan" id="kobo.1597.1">To calculate </span><a id="_idIndexMarker764"/><span class="koboSpan" id="kobo.1598.1">the distance between a location </span><a id="_idIndexMarker765"/><span class="koboSpan" id="kobo.1599.1">and a point, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1600.1">CalculateDistance</span></strong><span class="koboSpan" id="kobo.1601.1"> method, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1602.1">code snippet:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1603.1">
private async Task LoadDataAsync()
{
    var locations = await locationRepository.GetAll();
    var pointList = new List&lt;Models.Point&gt;();
    foreach (var location in locations)
    {
        //If no points exist, create a new one and continue to the next location in the list
        if (!pointList.Any())
        {
            pointList.Add(new Models.Point() { Location = location });
            continue;
        }
        var pointFound = false;
        //try to find a point for the current location
        foreach (var point in pointList)
        {
            var distance = Location.CalculateDistance(
                new Location(point.Location.Latitude, point.Location.Longitude),
                new Location(location.Latitude, location.Longitude),
                DistanceUnits.Kilometers);
            if (distance &lt; 0.2)
            {
                pointFound = true;
                point.Co</span><a id="_idTextAnchor690"/><span class="koboSpan" id="kobo.1604.1">u</span><a id="_idTextAnchor691"/><span class="koboSpan" id="kobo.1605.1">nt++;
                break;
            }
        }
        //if no point is found, add a new Point to the list of points
        if (!pointFound)
        {
            pointList.Add(new Models.Point() { Location = location });
        }
        // Next section of code goes here
    }
}</span></pre> <p><span class="koboSpan" id="kobo.1606.1">When we </span><a id="_idIndexMarker766"/><span class="koboSpan" id="kobo.1607.1">have a list of points, we can calculate </span><a id="_idIndexMarker767"/><span class="koboSpan" id="kobo.1608.1">the heat color for each point. </span><span class="koboSpan" id="kobo.1608.2">We are going to use the </span><strong class="bold"><span class="koboSpan" id="kobo.1609.1">hue</span></strong><span class="koboSpan" id="kobo.1610.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.1611.1">saturation</span></strong><span class="koboSpan" id="kobo.1612.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.1613.1">lightness</span></strong><span class="koboSpan" id="kobo.1614.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1615.1">HSL</span></strong><span class="koboSpan" id="kobo.1616.1">) representation of a color, as </span><span class="No-Break"><span class="koboSpan" id="kobo.1617.1">described here:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1618.1">Hue</span></strong><span class="koboSpan" id="kobo.1619.1">: Hue is a </span><a id="_idIndexMarker768"/><span class="koboSpan" id="kobo.1620.1">degree on the color wheel that goes from 0 to 360, with 0 being red and 240 being blue. </span><span class="koboSpan" id="kobo.1620.2">Because we want our most popular places to be red (hot) and our least popular places to be blue (cold), we will calculate a value between 0 and 240 for each point, based on how many times the user has been to that point. </span><span class="koboSpan" id="kobo.1620.3">This means that we will only use two-thirds of </span><span class="No-Break"><span class="koboSpan" id="kobo.1621.1">the scale.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1622.1">Saturation</span></strong><span class="koboSpan" id="kobo.1623.1">: Saturation </span><a id="_idIndexMarker769"/><span class="koboSpan" id="kobo.1624.1">is a percentage value: 0% is a shade of gray, while 100% is full color. </span><span class="koboSpan" id="kobo.1624.2">In our app, we will always use 100% (this will be represented as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1625.1">1</span></strong><span class="koboSpan" id="kobo.1626.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.1627.1">the code).</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1628.1">Lightness</span></strong><span class="koboSpan" id="kobo.1629.1">: Lightness is </span><a id="_idIndexMarker770"/><span class="koboSpan" id="kobo.1630.1">a percentage value of the amount of light: 0% is black and 100% is white. </span><span class="koboSpan" id="kobo.1630.2">We want it to be neutral, so we will use 50% (this will be represented as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1631.1">0.5</span></strong><span class="koboSpan" id="kobo.1632.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.1633.1">the code).</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1634.1">The first thing that we need to do is find out how many times the user has been to the most popular and least popular places. </span><span class="koboSpan" id="kobo.1634.2">Let’s take </span><span class="No-Break"><span class="koboSpan" id="kobo.1635.1">a look:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1636.1">First, check that the list of points is </span><span class="No-Break"><span class="koboSpan" id="kobo.1637.1">not empty.</span></span></li>
<li><span class="koboSpan" id="kobo.1638.1">Get the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1639.1">Min</span></strong><span class="koboSpan" id="kobo.1640.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1641.1">Max</span></strong><span class="koboSpan" id="kobo.1642.1"> values for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1643.1">Count</span></strong><span class="koboSpan" id="kobo.1644.1"> property in the list </span><span class="No-Break"><span class="koboSpan" id="kobo.1645.1">of points.</span></span></li>
<li><span class="koboSpan" id="kobo.1646.1">Calculate the difference between the minimum and the </span><span class="No-Break"><span class="koboSpan" id="kobo.1647.1">maximum values.</span></span></li>
<li><span class="koboSpan" id="kobo.1648.1">The code should be added after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1649.1">// Next section of code goes here</span></strong><span class="koboSpan" id="kobo.1650.1"> comment at the bottom of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1651.1">LoadDataAsync</span></strong><span class="koboSpan" id="kobo.1652.1"> method, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1653.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1654.1">
private async Task LoadDataAsync()
{
    // The rest of the method has been omitted for brevity
    // Next section of code goes here
</span><strong class="bold"><span class="koboSpan" id="kobo.1655.1">    </span><a id="_idTextAnchor692"/><span class="koboSpan" id="kobo.1656.1">if (pointList == null || !pointList.Any())</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1657.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1658.1">        return;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1659.1">    }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1660.1">    var pointMax = pointList.Select(x =&gt; x.Count).Max();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1661.1">    var pointMin = pointList.Select(x =&gt; x.Count).Min();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1662.1">    var diff = (float)(pointMax - pointMin);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1663.1">    // Last section of code goes here</span></strong><span class="koboSpan" id="kobo.1664.1">
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1665.1">Now, we can </span><a id="_idIndexMarker771"/><span class="koboSpan" id="kobo.1666.1">calculate the heat for each point, </span><span class="No-Break"><span class="koboSpan" id="kobo.1667.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1668.1">Loop through all </span><span class="No-Break"><span class="koboSpan" id="kobo.1669.1">the points.</span></span></li>
<li><span class="koboSpan" id="kobo.1670.1">The following </span><a id="_idIndexMarker772"/><span class="koboSpan" id="kobo.1671.1">code should be added after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1672.1">// Last section of code goes here</span></strong><span class="koboSpan" id="kobo.1673.1"> comment, at the bottom of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1674.1">LoadDataAsync()</span></strong><span class="koboSpan" id="kobo.1675.1"> method (this is highlighted in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1676.1">co</span><a id="_idTextAnchor693"/><span class="koboSpan" id="kobo.1677.1">de snippet):</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1678.1">
private async Task LoadDataAsync()
{
    // The rest of the method has been omitted for brevity
    // Next section of code goes here
    if (pointList == null || !pointList.Any())
    {
        return;
    }
    var pointMax = pointList.Select(x =&gt; x.Count).Max();
    var pointMin = pointList.Select(x =&gt; x.Count).Min();
    var diff = (float)(pointMax - pointMin);
    // Last section of code goes here
    </span><strong class="bold"><span class="koboSpan" id="kobo.1679.1">foreach (var point in pointList)</span></strong><span class="koboSpan" id="kobo.1680.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.1681.1">{</span></strong><span class="koboSpan" id="kobo.1682.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.1683.1">var heat = (2f / 3f) - ((float)point.Count / diff);</span></strong><span class="koboSpan" id="kobo.1684.1">
        </span><strong class="bold"><span class="koboSpan" id="kobo.1685.1">point.Heat = Color.FromHsla(heat, 1, 0.5);</span></strong><span class="koboSpan" id="kobo.1686.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.1687.1">}</span></strong><span class="koboSpan" id="kobo.1688.1">
    </span><strong class="bold"><span class="koboSpan" id="kobo.1689.1">Points = pointList;</span></strong><span class="koboSpan" id="kobo.1690.1">
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1691.1">That’s all </span><a id="_idIndexMarker773"/><span class="koboSpan" id="kobo.1692.1">we need to do to set up location tracking </span><a id="_idIndexMarker774"/><span class="koboSpan" id="kobo.1693.1">in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1694.1">MeTracker</span></strong><span class="koboSpan" id="kobo.1695.1"> project. </span><span class="koboSpan" id="kobo.1695.2">Now, let’s tur</span><a id="_idTextAnchor694"/><a id="_idTextAnchor695"/><a id="_idTextAnchor696"/><span class="koboSpan" id="kobo.1696.1">n our attention to visualizing the data </span><span class="No-Break"><span class="koboSpan" id="kobo.1697.1">we receive.</span></span></p>
<h3><span class="koboSpan" id="kobo.1698.1">Adding data visualizations</span></h3>
<p><span class="koboSpan" id="kobo.1699.1">In .NET MAUI, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1700.1">Map</span></strong><span class="koboSpan" id="kobo.1701.1"> control can render additional information over the map. </span><span class="koboSpan" id="kobo.1701.2">This includes pins and custom shapes, which are called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1702.1">MapElements</span></strong><span class="koboSpan" id="kobo.1703.1">. </span><span class="koboSpan" id="kobo.1703.2">We could simply add each </span><a id="_idIndexMarker775"/><span class="koboSpan" id="kobo.1704.1">location that is stored in the repository as a pin; however, to get the heat map, we want to add a colored dot to the map for each location, so we </span><a id="_idIndexMarker776"/><span class="koboSpan" id="kobo.1705.1">will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1706.1">MapElements</span></strong><span class="koboSpan" id="kobo.1707.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.1708.1">each location.</span></span></p>
<p><span class="koboSpan" id="kobo.1709.1">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1710.1">MapElements</span></strong><span class="koboSpan" id="kobo.1711.1"> property were </span><strong class="source-inline"><span class="koboSpan" id="kobo.1712.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1713.1"> , we could use a converter to map the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1714.1">MainViewModel</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1715.1">Points</span></strong><span class="koboSpan" id="kobo.1716.1"> property to the map’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1717.1">MapElements</span></strong><span class="koboSpan" id="kobo.1718.1"> property in a binding. </span><span class="koboSpan" id="kobo.1718.2">But </span><strong class="source-inline"><span class="koboSpan" id="kobo.1719.1">MapElements</span></strong><span class="koboSpan" id="kobo.1720.1"> is not a bindable property,  so it won’t be </span><span class="No-Break"><span class="koboSpan" id="kobo.1721.1">tha</span><a id="_idTextAnchor697"/><span class="koboSpan" id="kobo.1722.1">t easy.</span></span></p>
<p><span class="koboSpan" id="kobo.1723.1">Let’s start by creating a custom </span><span class="No-Break"><span class="koboSpan" id="kobo.1724.1">map control.</span></span></p>
<h2 id="_idParaDest-130"><a id="_idTextAnchor698"/><span class="koboSpan" id="kobo.1725.1">Creating a custom control for the map</span></h2>
<p><span class="koboSpan" id="kobo.1726.1">To show the heat map on our map, we will create a new control. </span><span class="koboSpan" id="kobo.1726.2">Since </span><strong class="source-inline"><span class="koboSpan" id="kobo.1727.1">Map</span></strong><span class="koboSpan" id="kobo.1728.1"> is a sealed class, we won’t </span><a id="_idIndexMarker777"/><span class="koboSpan" id="kobo.1729.1">be able to subclass it directly; instead, we will encapsulate the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1730.1">Map</span></strong><span class="koboSpan" id="kobo.1731.1"> control inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.1732.1">ContentView</span></strong><span class="koboSpan" id="kobo.1733.1"> with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1734.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1735.1"> to get access to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1736.1">Points</span></strong><span class="koboSpan" id="kobo.1737.1"> data </span><span class="No-Break"><span class="koboSpan" id="kobo.1738.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1739.1">ViewModel</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1740.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1741.1">Follow these </span><a id="_idIndexMarker778"/><span class="koboSpan" id="kobo.1742.1">steps to create the </span><span class="No-Break"><span class="koboSpan" id="kobo.1743.1">custom control:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1744.1">Create a new folder </span><span class="No-Break"><span class="koboSpan" id="kobo.1745.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1746.1">Controls</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1747.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1748.1">Create a new class </span><span class="No-Break"><span class="koboSpan" id="kobo.1749.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1750.1">CustomMap</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1751.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.1752.1">Add </span><strong class="source-inline"><span class="koboSpan" id="kobo.1753.1">ContentView</span></strong><span class="koboSpan" id="kobo.1754.1"> as a base class to the new class, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1755.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1756.1">
namespace MeTracker.Controls;
public class CustomM</span><a id="_idTextAnchor699"/><span class="koboSpan" id="kobo.1757.1">ap : ContentView
{
    public CustomMap()
    {
    }
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1758.1">Now, we need to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1759.1">Map</span></strong><span class="koboSpan" id="kobo.1760.1"> control to the custom control. </span><span class="koboSpan" id="kobo.1760.2">Follow these steps to add the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1761.1">Map</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1762.1"> control:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1763.1">Derive the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1764.1">CustomMap</span></strong><span class="koboSpan" id="kobo.1765.1"> control from the .NET MAUI </span><strong class="source-inline"><span class="koboSpan" id="kobo.1766.1">Map</span></strong><span class="koboSpan" id="kobo.1767.1"> control, as highlighted in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1768.1">code snippet:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1769.1">using Microsoft.Maui.Controls.Maps;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1770.1">using Microsoft.Maui.Maps;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1771.1">using Map = Microsoft.Maui.Controls.Maps.Map;</span></strong><span class="koboSpan" id="kobo.1772.1">
namespace MeTracker.Controls;
public class CustomMap : </span><strong class="bold"><span class="koboSpan" id="kobo.1773.1">Map</span></strong><span class="koboSpan" id="kobo.1774.1">
{
    public CustomMap()
    {
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.1775.1">Initialize the map in the constructor, as shown with the new </span><span class="No-Break"><span class="koboSpan" id="kobo.1776.1">changes highlighted:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1777.1">
public CustomMap()
{
    IsScrollEnabled = true;
    IsShowingUser = true;
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1778.1">If we want </span><a id="_idIndexMarker779"/><span class="koboSpan" id="kobo.1779.1">to have properties that we want to bind data to, we need to create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1780.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1781.1"> class. </span><span class="koboSpan" id="kobo.1781.2">This should be </span><a id="_idIndexMarker780"/><span class="koboSpan" id="kobo.1782.1">a public static field in the class. </span><span class="koboSpan" id="kobo.1782.2">We also need to create a regular property to hold the value. </span><span class="koboSpan" id="kobo.1782.3">The naming of the properties is really important. </span><span class="koboSpan" id="kobo.1782.4">The name of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1783.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1784.1"> needs to be </span><strong class="source-inline"><span class="koboSpan" id="kobo.1785.1">{NameOfTheProperty}Property</span></strong><span class="koboSpan" id="kobo.1786.1">; for example, the name of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1787.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1788.1"> that we will create in the following steps will be </span><strong class="source-inline"><span class="koboSpan" id="kobo.1789.1">PointsProperty</span></strong><span class="koboSpan" id="kobo.1790.1"> because the name of the property is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1791.1">Points</span></strong><span class="koboSpan" id="kobo.1792.1">. </span><span class="koboSpan" id="kobo.1792.2">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.1793.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1794.1"> is created using the static </span><strong class="source-inline"><span class="koboSpan" id="kobo.1795.1">Create</span></strong><span class="koboSpan" id="kobo.1796.1"> method on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1797.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1798.1"> class. </span><span class="koboSpan" id="kobo.1798.2">This requires at least four arguments, </span><span class="No-Break"><span class="koboSpan" id="kobo.1799.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1800.1">propertyName</span></strong><span class="koboSpan" id="kobo.1801.1">: This is the name of the property as </span><span class="No-Break"><span class="koboSpan" id="kobo.1802.1">a string.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1803.1">returnType</span></strong><span class="koboSpan" id="kobo.1804.1">: This is the type that will be returned from </span><span class="No-Break"><span class="koboSpan" id="kobo.1805.1">the property.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1806.1">declaringType</span></strong><span class="koboSpan" id="kobo.1807.1">: This is the type of the class that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1808.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1809.1"> is </span><span class="No-Break"><span class="koboSpan" id="kobo.1810.1">declared in.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1811.1">defaultValue</span></strong><span class="koboSpan" id="kobo.1812.1">: This is the default value that will be returned if no value is set. </span><span class="koboSpan" id="kobo.1812.2">This is an optional argument. </span><span class="koboSpan" id="kobo.1812.3">If it is not set, .NET MAUI will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1813.1">null</span></strong><span class="koboSpan" id="kobo.1814.1"> as a </span><span class="No-Break"><span class="koboSpan" id="kobo.1815.1">default value.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1816.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1817.1">set</span></strong><span class="koboSpan" id="kobo.1818.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1819.1">get</span></strong><span class="koboSpan" id="kobo.1820.1"> methods for the property will call methods in the base class to set or get values </span><span class="No-Break"><span class="koboSpan" id="kobo.1821.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1822.1">BindableProperty</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1823.1">:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1824.1">Create </span><strong class="source-inline"><span class="koboSpan" id="kobo.1825.1">BindableProperty</span></strong><span class="koboSpan" id="kobo.1826.1"> called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1827.1">PointsProperty</span></strong><span class="koboSpan" id="kobo.1828.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1829.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1830.1">
public static BindableProperty PointsProperty = BindableProperty.Create(nameof(Points), typeof(List&lt;Models.Point&gt;), typeof(CustomMap), new List&lt;Models.Point&gt;());</span></pre></li> <li><span class="koboSpan" id="kobo.1831.1">Create a </span><a id="_idIndexMarker781"/><span class="koboSpan" id="kobo.1832.1">property of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1833.1">List&lt;Models.Point&gt;</span></strong><span class="koboSpan" id="kobo.1834.1"> type called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1835.1">Points</span></strong><span class="koboSpan" id="kobo.1836.1">. </span><span class="koboSpan" id="kobo.1836.2">Remember to cast the result of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1837.1">GetValue</span></strong><span class="koboSpan" id="kobo.1838.1"> so that </span><a id="_idIndexMarker782"/><span class="koboSpan" id="kobo.1839.1">it’s the same type as the property. </span><span class="koboSpan" id="kobo.1839.2">We need to do this because </span><strong class="source-inline"><span class="koboSpan" id="kobo.1840.1">GetValue</span></strong><span class="koboSpan" id="kobo.1841.1"> will return the value as a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1842.1">type</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1843.1"> object:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1844.1">
public List&lt;Models.Point&gt; Points
{
get =&gt; GetValue(PointsProperty) as Li</span><a id="_idTextAnchor700"/><span class="koboSpan" id="kobo.1845.1">st&lt;Models.Point&gt;;
set =&gt; SetValue(PointsProperty, value);
}</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1846.1">In order to display </span><strong class="source-inline"><span class="koboSpan" id="kobo.1847.1">Points</span></strong><span class="koboSpan" id="kobo.1848.1">, we need to convert them to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1849.1">MapElements</span></strong><span class="koboSpan" id="kobo.1850.1">. </span><span class="koboSpan" id="kobo.1850.2">This is accomplished using a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1851.1">BindingProperty</span></strong><span class="koboSpan" id="kobo.1852.1"> event called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1853.1">PropertyChanged</span></strong><span class="koboSpan" id="kobo.1854.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1855.1">PropertyChanged</span></strong><span class="koboSpan" id="kobo.1856.1"> is fired every time </span><strong class="source-inline"><span class="koboSpan" id="kobo.1857.1">BindingProperty</span></strong><span class="koboSpan" id="kobo.1858.1"> changes. </span><span class="koboSpan" id="kobo.1858.2">To add the event and convert </span><strong class="source-inline"><span class="koboSpan" id="kobo.1859.1">Points</span></strong><span class="koboSpan" id="kobo.1860.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1861.1">MapElements</span></strong><span class="koboSpan" id="kobo.1862.1">, add the following highlighted code to </span><span class="No-Break"><span class="koboSpan" id="kobo.1863.1">the class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1864.1">
public readonly static BindableProperty PointsProperty = BindableProperty.Create(nameof(Points), typeof(List&lt;Models.Point&gt;), typeof(MapView), new List&lt;Models.Point&gt;(), </span><strong class="bold"><span class="koboSpan" id="kobo.1865.1">propertyChanged: OnPointsChanged</span></strong><span class="koboSpan" id="kobo.1866.1">);
</span><strong class="bold"><span class="koboSpan" id="kobo.1867.1">private static void OnPointsChanged(BindableObject bindable, object oldValue, object newValue)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1868.1">{</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1869.1">    var map = bindable as Map;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1870.1">    if (newValue == null) return;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1871.1">    if (map == null) return;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1872.1">    foreach (var point in newValue as List&lt;Models.Point&gt;)</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1873.1">    {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1874.1">        // Instantiate a Circle</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1875.1">        Circle circle = new()</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1876.1">        {</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1877.1">            Center = new Location(point.Location.Latitude, point.Location.Longitude),</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1878.1">            Radius = new Distance(200),</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1879.1">            StrokeColor = Color.FromArgb("#88FF0000"),</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1880.1">            StrokeWidth = 0,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1881.1">            FillColor = point.Heat</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1882.1">        };</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1883.1">        // Add the Circle to the map's MapElements collection</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1884.1">        map.MapElements.Add(circle);</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1885.1">    }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1886.1">}</span></strong><span class="koboSpan" id="kobo.1887.1">
public List&lt;Models.Point&gt; Points
{
    get =&gt; GetValue(PointsProperty) as List&lt;Models.Point&gt;;
    set =&gt; SetValue(PointsProperty, value);
}</span></pre> <p><span class="koboSpan" id="kobo.1888.1">Now that </span><a id="_idIndexMarker783"/><span class="koboSpan" id="kobo.1889.1">we’ve created a custom </span><a id="_idIndexMarker784"/><span class="koboSpan" id="kobo.1890.1">map control, we will use it to replace the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1891.1">Map</span></strong><span class="koboSpan" id="kobo.1892.1"> control in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1893.1">MainView</span></strong><span class="koboSpan" id="kobo.1894.1">. </span><span class="koboSpan" id="kobo.1894.2">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1895.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1896.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1897.1">MainView.xaml</span></strong><span class="koboSpan" id="kobo.1898.1"> file, declare the namespace for the </span><span class="No-Break"><span class="koboSpan" id="kobo.1899.1">custom control.</span></span></li>
<li><span class="koboSpan" id="kobo.1900.1">Replace the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1901.1">Map</span></strong><span class="koboSpan" id="kobo.1902.1"> control with the new control that we </span><span class="No-Break"><span class="koboSpan" id="kobo.1903.1">have created.</span></span></li>
<li><span class="koboSpan" id="kobo.1904.1">Add a binding to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1905.1">Points</span></strong><span class="koboSpan" id="kobo.1906.1"> property in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1907.1">MainViewModel</span></strong><span class="koboSpan" id="kobo.1908.1">, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1909.1">code snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1910.1">
&lt;ContentPage  

x:Class="MeTracker.Views.MainView"&gt;
&lt;map:Custo</span><a id="_idTextAnchor701"/><a id="_idTextAnchor702"/><a id="_idTextAnchor703"/><a id="_idTextAnchor704"/><span class="koboSpan" id="kobo.1911.1">mMap x:Name="Map" Points="{Binding Points}" /&gt;
&lt;/ContentPage&gt;</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1912.1">This concludes this section on how to extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1913.1">Maps</span></strong><span class="koboSpan" id="kobo.1914.1"> control. </span><span class="koboSpan" id="kobo.1914.2">The final</span><a id="_idTextAnchor705"/><span class="koboSpan" id="kobo.1915.1"> step for our app is to refresh the map when the </span><span class="No-Break"><span class="koboSpan" id="kobo.1916.1">app resumes.</span></span></p>
<h2 id="_idParaDest-131"><a id="_idTextAnchor706"/><span class="koboSpan" id="kobo.1917.1">Refreshing the map when the app resumes</span></h2>
<p><span class="koboSpan" id="kobo.1918.1">The last thing we will do is make sure that the map is up to date with the latest points when the </span><a id="_idIndexMarker785"/><span class="koboSpan" id="kobo.1919.1">app is resumed. </span><span class="koboSpan" id="kobo.1919.2">The easiest way to do this is to set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1920.1">MainPage</span></strong><span class="koboSpan" id="kobo.1921.1"> property in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1922.1">App.xaml.cs</span></strong><span class="koboSpan" id="kobo.1923.1"> file to a new instance of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1924.1">AppShell</span></strong><span class="koboSpan" id="kobo.1925.1">, in the same way as the constructor, as shown in the following </span><span class="No-Break"><span class="koboSpan" id="kobo.1926.1">code snippet:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1927.1">
protected override void OnResume()
{
    base.OnResume();
</span><strong class="bold"><span class="koboSpan" id="kobo.1928.1">    MainPage = new AppShell();</span></strong><span class="koboSpan" id="kobo.1929.1">
}</span></pre> <p><span class="koboSpan" id="kobo.1930.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1931.1">MeTracker</span></strong><span class="koboSpan" id="kobo.1932.1"> app is now complete – try it out. </span><span class="koboSpan" id="kobo.1932.2">A sample screenshot is shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1933.1">Figure 7</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1934.1">.18</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1935.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer133">
<span class="koboSpan" id="kobo.1936.1"><img alt="" role="presentation" src="image/B19214_07_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"> </p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1937.1">Figure 7.18 – MeTracker on iOS and Android</span></p>
<h1 id="_idParaDest-132"><a id="_idTextAnchor707"/><span class="koboSpan" id="kobo.1938.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1939.1">In this chapter, we built an app for iOS, Mac Catalyst, and Android that tracked the location of a user. </span><span class="koboSpan" id="kobo.1939.2">When we built the app, we learned how to use maps in .NET MAUI and how to use location tracking when it’s running in the background. </span><span class="koboSpan" id="kobo.1939.3">We also learned how to extend .NET MAUI with custom controls. </span><span class="koboSpan" id="kobo.1939.4">With this knowledge, we can create applications that perform other tasks in the background. </span><span class="koboSpan" id="kobo.1939.5">We also learned how to extend most controls in .</span><span class="No-Break"><span class="koboSpan" id="kobo.1940.1">NET MAUI.</span></span></p>
<p><span class="koboSpan" id="kobo.1941.1">Here are some ways you could extend this app </span><span class="No-Break"><span class="koboSpan" id="kobo.1942.1">even further:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1943.1">Right now, the app updates the map location when the app resumes. </span><span class="koboSpan" id="kobo.1943.2">How could you update the map when the </span><span class="No-Break"><span class="koboSpan" id="kobo.1944.1">location changes?</span></span></li>
<li><span class="koboSpan" id="kobo.1945.1">Add a view that lists all locations from the database. </span><span class="koboSpan" id="kobo.1945.2">Allow the user to remove a location from </span><span class="No-Break"><span class="koboSpan" id="kobo.1946.1">the list.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1947.1">The next project will be a weather app. </span><span class="koboSpan" id="kobo.1947.2">In the next chapter, we will use an existing weather service API to retrieve weather data and then display that data in </span><span class="No-Break"><span class="koboSpan" id="kobo.1948.1">the app.</span></span></p>
</div>
</body></html>