<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Networking and Multiplayer</h1></div></div></div><p>In previous chapters you learned how to use Unity's interface, manipulate objects, and add components and behaviors to them. You created gameplay using Playmaker actions and Unity scripting. We also looked at making custom actions from C# scripts. You made a fully playable air hockey game with an AI opponent using all these tools.</p><p>In this chapter, we are going to talk about networking. You will make a multiplayer mode for the game using <a id="id143" class="indexterm"/>
<strong>Photon Unity Networking</strong> (<strong>PUN</strong>), which is a helpful plugin that comes with Playmaker and lets you make multiplayer games almost effortlessly. We will also talk about the theory of networking in games and discuss Unity native networking as an alternative to Photon.</p><p>In this chapter, you will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Understanding networking and multiplayer</li><li class="listitem" style="list-style-type: disc">Setting up Photon Unity Networking</li><li class="listitem" style="list-style-type: disc">Making a multiplayer game</li></ul></div><div><div><div><div><h1 class="title"><a id="ch06lvl1sec30"/>Understanding networking and multiplayer</h1></div></div></div><p>Explaining things like TCP/IP and <a id="id144" class="indexterm"/>other low-level networking concepts<a id="id145" class="indexterm"/> is beyond the scope of this book, and we are going to try and keep everything as close to practical application as possible. On the other hand, it will be much easier for you to build multiplayer if you are familiar with at least some theory.</p><p>The first thing that you need to know is what servers and clients are. In simple terms, a server<a id="id146" class="indexterm"/> is a computer that responds to network requests from other computers, or more precisely, a system that responds to network requests from other systems, because you may have multiple servers and multiple clients on the same computer. This means that clients communicate with each other through a server. Typically, player systems are clients in multiplayer games, while servers are on computers that are accessed remotely. Sometimes, a player can <em>host</em> a game, in which case the player either acts as a server or simply tells the server to reserve its resources for the game.</p><p>You may have heard about network architectures before. In games, the most popular architectures are arguably client-server and peer-to-peer. The former means that all the clients subscribe to a single server. The server hosts most of the important information about the game and distributes it between the players. The latter is about peers (players) connecting to one another directly, so all the clients are connected to each other, and the network workload is distributed evenly.</p><p>The advantage of client-server<a id="id147" class="indexterm"/> is that it allows creating a more stable system that ensures that cheating is either impossible or very hard, as well as makes it easier for the developer to monitor everything and make changes to the game on the fly. This method, however, is generally expensive and relatively hard to implement yourself if you are just a solo developer who is learning to make his/her first multiplayer game.</p><p>Peer-to-peer<a id="id148" class="indexterm"/> does not require having a powerful server hosting multiple game sessions at the same time, allowing players to connect to each other, distributing the network workload between them. The drawback of peer-to-peer is that it tends to be less stable, and it is relatively hard to monitor. On top of that, you still need a server if you want to keep track of game sessions, perform matchmaking, and let your players play on the Internet instead of just a local network.</p><div><div><h3 class="title"><a id="tip23"/>Tip</h3><p>It is hard to connect to the Internet without having a server, because of something <a id="id149" class="indexterm"/>called <strong>Native Address Translation</strong> (<strong>NAT</strong>). Without getting into much detail, it should be noted that it is something that network routers do, and most of us have routers these days. A process commonly called <strong>NAT punchthrough</strong><a id="id150" class="indexterm"/> is used in order to connect one computer to another, and this process requires a server acting as a mediator for the first connection between two computers.</p></div></div><p>In Unity, it is relatively easy to set up a <strong>Local Area Network</strong> (<strong>LAN</strong>)<a id="id151" class="indexterm"/>, peer-to-peer<a id="id152" class="indexterm"/> connection, or client-server connection with one of the players hosting the game without using any external plugins. A LAN connection means that all the players are connected to the same local computer network. Unfortunately, whatever you do, you will need a server to make sure that players can always connect to each other over the Internet, which is what we want to do. Photon takes client-server and wraps it in an extremely easy to use interface that allows anyone to create multiplayer games without any prior experience. On top of that, it is very affordable for what it is.</p><p>Some of the Photon services allow players to host their own servers, but those take some time to set up. What we are going to use in this book is Photon Cloud. As the name implies, all the game sessions happen in the cloud, thus on remote Photon servers. All you need to do is synchronize your game's data through them and make sure that players can find each other. You do not need to set up a server, and you do not have to worry about the problems involved in making peer-to-peer multiplayer.</p><p>The way the synchronization works is that there is something called <strong>Network View</strong><a id="id153" class="indexterm"/> (<strong>Photon View</strong> in Photon), which is a component that makes one or more game object's properties synchronized over the network. When such a property changes in one client, it changes in all the clients, with the server keeping track of everything and sending commands to clients. For example, mallet's position can be such a property. This way, when player 1 moves their mallet, player 2 sees them move it and vice versa. The same goes for almost any other property.</p><div><div><h3 class="title"><a id="tip24"/>Tip</h3><p>As we will show in this chapter's example, synchronizing positions can be okay for player objects (such as mallets in air hockey or characters in first person shooters), but objects that have physical behaviors (such as the puck), can experience serious network delays on remote computers. There is currently no easy solution for this problem apart from using Unity native networking.</p></div></div><p>There are objects that <a id="id154" class="indexterm"/>can belong to the scene (like the walls and the background) and so are exactly the same and unchangeable throughout all clients, and then there are objects that belong to different clients, such as the mallets. Generally, you want to synchronize as little data over the network as possible in order to avoid high response times. Scene objects do not have to get synchronized since they do not change. Moreover, this way each player's mallet responds only to that player's input, which makes perfect sense gameplay-wise.</p><p>You are now ready to start setting up Photon. All this theory may sound complicated, but it really comes down to synchronizing variables over the network using a special Photon component called Photon View.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec31"/>Setting up Photon Unity Networking</h1></div></div></div><p>Photon Unity Networking<a id="id155" class="indexterm"/> is a free Unity plugin with an optional paid subscription that allows you to outsource most of the heavy lifting for building multiplayer games. The free version has full functionality but is limited by the number of players that can be online at the same time. This is not a problem, because all you need for <a id="id156" class="indexterm"/>testing is to be able to connect as many players as your game requires for being playable (so two for air hockey).</p><div><ol class="orderedlist arabic"><li class="listitem">First of all, we will need to set up PUN. In the main menu, navigate to <strong>PlayMaker</strong> | <strong>Addons</strong> | <strong>Photon Networking</strong> | <strong>Set up Photon Networking</strong>. This should open the <strong>Photon Setup Wizard</strong> window. Click on the orange <strong>Setup</strong> button.</li><li class="listitem">If this is the first time you are using Photon, you are going to need an account, so enter your e-mail in the appropriate field and click on the <strong>Send</strong> button.</li><li class="listitem">After that you can finish the registration process by clicking on the link that you will have received by e-mail. Sign in to your account on <a class="ulink" href="http://cloud.exitgames.com/">http://cloud.exitgames.com/</a>, click on the <strong>New App</strong> button on your account page, enter the game's name and description, and then click on <strong>Create</strong>. You should be <a id="id157" class="indexterm"/>redirected back to your account page. In the <strong>Details</strong> section, copy the code under <strong>AppID</strong> and go back to Unity.</li><li class="listitem">In the <strong>Photon Setup Wizard</strong>, click on the <strong>Setup</strong> button, paste your AppID into the <strong>Your AppId</strong> text field, and choose your region by pressing one of the <strong>Cloud Region</strong> buttons. Make sure you choose the region that is closer to you geographically as this will affect the connection speed of your game's multiplayer.</li><li class="listitem">Once you have pasted the AppID and chosen the region, click on the <strong>Save</strong> button below. A window should pop up saying that your settings have been saved. Click on <strong>OK</strong>. The following screenshot shows what the setup window is supposed to look like once you do:<div><img src="img/8108OT_06_01.jpg" alt="Setting up Photon Unity Networking"/></div></li><li class="listitem">Make sure that the green label saying <strong>Photon server is set up properly</strong> appears near the top of the window. Press the <strong>Main Menu</strong> button right below it. It should take you back to the first screen of <strong>Photon Setup Wizard</strong>.</li><li class="listitem">Make a copy of your main game scene and call it <code class="literal">Multiplayer</code>, load it by double-clicking it in the <strong>Project</strong> panel, and then go back to <strong>Photon Setup Wizard</strong> window and click on <strong>Add Photon System to the scene</strong>. The button should disappear, and you should see the second green label saying <strong>The scene is set up properly</strong>.</li><li class="listitem">At this point Photon <a id="id158" class="indexterm"/>Cloud is set up, and you can feel free to close the wizard window. Save the <strong>Multiplayer</strong> scene, making sure that the <strong>PlayMaker Photon Proxy</strong> game object was added to <strong>Hierarchy</strong>.</li></ol></div><p>You can modify the settings any time you want. You can also change your AppID if you choose to do so.</p><p>Now that we have added Photon to the project and made a scene dedicated to multiplayer, it is time to synchronize objects over the network and set up matchmaking.</p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec32"/>Making multiplayer</h1></div></div></div><p>There are a few game objects<a id="id159" class="indexterm"/> that have to be synchronized in our game, including the goals, the puck, and the mallets. We also need to make a few adjustments to the scene and set up matchmaking.</p><p>We are going to use the Photon Playmaker example as a template for our game, using the scenes from there and modifying them to suit our purposes. This is generally a good idea if you want to set up multiplayer quickly, because these examples feature numerous and complex FSMs that would take quite a lot of time to set up, while most of the things you will need have already been implemented.</p><p>You can download the demo scenes here: <a class="ulink" href="http://www.hutonggames.com/samples.php">http://www.hutonggames.com/samples.php</a>. Simply click on the link <strong>Download PlayMaker Photon Demo</strong> (requires Unity 3.5+ Playmaker 1.6.1+). Then you will need to find the downloaded <code class="literal">unitypackage</code> file on your computer and double-click on it. This will prompt the import window. Click on the <strong>Import</strong> button in the bottom-right corner of it.</p><div><div><h3 class="title"><a id="tip25"/>Tip</h3><p>The warning on the example download page advises against importing the example into existing projects. We can ignore this warning, because none of our files are named in the same way the ones in the example are. As a general rule, you should always make sure that this is the case before importing new packages into new empty projects. Otherwise you might find yourself losing important assets in your projects.</p></div></div><p>Save the <strong>Multiplayer</strong> scene, and let us add the demo scenes to our project. They should be under <code class="literal">Photon Unity Networking/PlayMaker/Demo/Separated Scenes Demo</code>. Open the <strong>demo_lobby</strong> scene by double-clicking on its file.</p><p>The first thing we need to do is add the new scenes to our project. Open <strong>Build Settings</strong> by pressing <em>Shift</em> + <em>command</em> + <em>B</em> (<em>Shift</em> + <em>Ctrl</em> + <em>B</em> in Windows), then click on the <strong>Add Current</strong> button shown in the following screenshot. This will add the currently open scene to the project. Do this for <strong>demo_lobby</strong> and <strong>demo_room</strong>. Then close <strong>Build Settings</strong>.</p><div><img src="img/8108OT_06_02.jpg" alt="Making multiplayer"/></div><p>These two scenes are<a id="id160" class="indexterm"/> going to be responsible for two states of the game: the matchmaking state where players can find and create servers and the match state where the game itself takes place. You can test how it works by opening two instances of your game at once: one in the Unity Editor, one in your web browser.</p><div><ol class="orderedlist arabic"><li class="listitem">To make a browser build, select <strong>File</strong> | <strong>Build &amp; Run</strong> from the main menu and save the build files wherever you want on your computer when the file browser appears. You might want to create a special <code class="literal">Build</code> folder to make sure that you can always find your build. This should automatically open the game in your browser.<div><div><h3 class="title"><a id="tip26"/>Tip</h3><p>Please note that your platform has to be set to Web Player as described in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with Unity and Playmaker">Chapter 1</a>, <em>Getting Started with Unity and Playmaker</em>. If it is not, open <strong>Build Settings</strong>, select <strong>Web Player</strong> from the list on the left, and click on the <strong>Switch Platform</strong> button. Then close the <strong>Build Settings</strong> window.</p></div></div></li><li class="listitem">Specify your nickname, and the name of the room next to <strong>CREATE ROOM</strong>, then click on <strong>GO</strong> on the right from the room name text field.</li><li class="listitem">A new scene should load, where you control a construction worker that can walk around on a plane.</li><li class="listitem">Keeping the game open in your web browser, go back to the Unity Editor; make sure that <strong>demo_scene</strong> is open and click on play.</li><li class="listitem">Click on the <strong>GO</strong> button next to <strong>EXISTING ROOMS</strong>. This will join a random exiting room. Since we only created one room, both of the game instances will now be connected to the same game session. This way you can test how networking works by looking at your scene from the points of view of two players.</li></ol></div><p>Now that you have <a id="id161" class="indexterm"/>seen how multiplayer works in the example project, it is time to modify its scenes to work with our game. We are going to keep the matchmaking intact (in fact, it can be kept this way for almost any multiplayer game). The only thing that needs changing is the maximum number of players that can join a single room. You may have noticed that the example project allows for 100 players. We need to change it to <code class="literal">2</code>.</p><div><ol class="orderedlist arabic"><li class="listitem">In the <strong>demo_lobby</strong> scene, select the <strong>Menu</strong> game object.</li><li class="listitem">Open the <strong>Create Room</strong> FSM from the second drop-down list from the left in the menu on top of the <strong>playMaker</strong> FSM view.<div><img src="img/8108OT_06_03.jpg" alt="Making multiplayer"/></div></li><li class="listitem">In the Photon Network<strong> Create Room</strong> action of the create room state, set the <strong>Max Number Of Players</strong> property to <code class="literal">2</code>. Now up to two players will be able to join one room.</li><li class="listitem">Save the scene.</li></ol></div><p>Now that the lobby is all set, it is time to<a id="id162" class="indexterm"/> set up the game itself to work via the network.</p><div><ol class="orderedlist arabic"><li class="listitem">Make a copy of the <strong>demo_room</strong> scene as backup to be able to go back to if something goes wrong. Open the original <strong>demo_room</strong> scene. You should have an unnamed game object with four children as well as <strong>Chat</strong>, <strong>Game</strong>, and the <strong>PlayMaker Photon Proxy</strong> game objects.</li><li class="listitem">You can delete everything except the <strong>Game</strong> game object. This is where most of the initial multiplayer logic (such as instantiating players) takes place.</li><li class="listitem">Save the scene and go back to the <strong>Multiplayer</strong> scene.</li><li class="listitem">Select all the objects in this scene's <strong>Hierarchy</strong> by either pressing <em>command</em> + <em>A</em> (<em>Ctrl</em> + <em>A</em> in Windows) or clicking on the first item in the list and then <em>Shift</em>-clicking on the last one.</li><li class="listitem">Copy the selected objects by pressing <em>command</em> + <em>C</em> (<em>Ctrl</em> + <em>C</em> in Windows), then open the <strong>demo_room</strong> scene again and press <em>command</em> + <em>V</em> (<em>Ctrl</em> + <em>V</em> in Windows) to paste them.</li><li class="listitem">Create empty prefabs called <code class="literal">Goal</code>, <code class="literal">Mallet</code>, and <code class="literal">Puck</code> under <strong>Prefabs</strong>/<strong>Resources</strong>. Create the folders if you don't have them yet.</li><li class="listitem">Drag the <strong>GoalLeft</strong> game object into the <code class="literal">Goal</code> prefab, <strong>MalletLeft</strong> game object into the <code class="literal">Mallet</code> prefab, and <strong>Puck</strong> game object into the <code class="literal">Puck</code> prefab.</li><li class="listitem">Delete the following objects from the scene: <strong>MalletLeft</strong>, <strong>MalletRight</strong>, and <strong>Puck</strong>. They are going to be instantiated from prefabs that you just created when players join the room.</li><li class="listitem">Make <strong>GoalLeft</strong> and <strong>GoalRight</strong> invisible by deactivating their <strong>Mesh Renderer</strong> components. These objects will be instantiated from prefabs as well, but not right away, so we need to keep them in the scene for their colliders to make sure that no mallets can get out of the table. You can also rename both of them <code class="literal">Blocker</code>, since they are needed to block the mallets.</li><li class="listitem">Select the <strong>Game</strong> game object and open its <strong>Game Manager</strong> FSM in the <strong>playMaker</strong> panel.</li><li class="listitem">In the <strong>Variables</strong> tab, make sure you have three <strong>GameObject</strong> variables: <strong>goalRef</strong>, <strong>player prefab</strong>, and <strong>puck prefab</strong>, as well as an <strong>Int</strong> variable <strong>player count</strong>. Drag the <code class="literal">Mallet</code> prefab into the <strong>GameObject</strong> slot of <strong>player prefab</strong> and the <code class="literal">Puck</code> into the the <strong>GameObject</strong> slot of <strong>puck prefab</strong>.</li><li class="listitem">In the <strong>Events</strong> tab, create a new event called <code class="literal">Two Players</code>.</li><li class="listitem">In the <strong>Photon Network Instantiate</strong> action of the <strong>instantiate player</strong> state, make sure that <strong>Rotation</strong> is set to (<code class="literal">0</code>, <code class="literal">0</code>, <code class="literal">0</code>).</li><li class="listitem">Add another <strong>Photon Network Instantiate</strong> action to the same state. Set its <strong>Game Object</strong> property to <strong>Goal</strong> by dragging the <code class="literal">Goal</code> prefab from the <strong>Project</strong> panel. Set the <strong>Position</strong> property to <code class="literal">(-7.98</code>, <code class="literal">2</code>, <code class="literal">0</code>) and the <strong>Rotation</strong> property to (<code class="literal">0</code>, <code class="literal">90</code>, <code class="literal">0</code>). Set <strong>Store Object</strong> to <strong>goalRef</strong>.</li><li class="listitem">Make a new state called <code class="literal">How many players?</code> and add <strong>Photon Network Get Room Properties</strong> and the <strong>Int Compare</strong> actions to it. Make sure the former is before the latter in the list. If an error saying that PlayMakerPhotonGameObjectProxy component is required appears, click on it, and the component in question will be added automatically.</li><li class="listitem">Set the <strong>Player Count</strong> property of the <strong>Photon Network Get Room Properties</strong> action to the <strong>player count</strong> variable.</li><li class="listitem">In the <strong>Int Compare</strong> action, set the <strong>Integer 1</strong> property to the <strong>player count</strong> variable and the <strong>Integer 2</strong> property to <code class="literal">2</code>. Set <strong>Equal</strong> to <strong>Two Players</strong>. Check the <strong>Every Frame</strong> box. If you see an error about an event, ignore it for now; it will be fixed later on.</li><li class="listitem">Make a new<a id="id163" class="indexterm"/> state called <code class="literal">Create Puck</code>.</li><li class="listitem">Add a <strong>FINISHED</strong> event to the <strong>instantiate player</strong> state. Drag a transition from it to <strong>How many players?</strong></li><li class="listitem">Add a <strong>Two Players</strong> event to <strong>How many players?</strong> and drag a transition from it to <strong>Create Puck</strong>.</li><li class="listitem">In the <strong>Create Puck</strong> state, add two actions: <strong>Photon Network Instantiate</strong> and <strong>Set Position</strong>. Make sure that <strong>Set Position</strong> is the last in the list. If an error saying that a PlayMakerPhotonGameObjectProxy component is required appears, click on it, and the component in question will be added automatically.</li><li class="listitem">Set the <strong>Game Object</strong> property of <strong>Photon Network Instantiate</strong> to the <code class="literal">Puck</code> prefab variable. Set <strong>Position</strong> to (<code class="literal">0</code>, <code class="literal">0.3</code>, <code class="literal">0</code>) and <strong>Rotation</strong> to (<code class="literal">0</code>, <code class="literal">0</code>, <code class="literal">0</code>).</li><li class="listitem">In the <strong>Set Position</strong> action, set <strong>Game Object</strong> to <strong>Specify Game Object</strong> and select the <strong>goalRef</strong> variable from the drop-down list. Make sure that <strong>Vector</strong> is <strong>None</strong>, <strong>X</strong> is <code class="literal">7.98</code>, and <strong>Y</strong> and <strong>Z</strong> are <strong>None</strong>.</li><li class="listitem">Save your scene.</li></ol></div><p>This state machine is responsible for spawning objects that should be unique to different players: players' mallets and goals are spawned as soon as the players connect to the room, while the puck is spawned once the second player connects to make sure that player 1 does not win while alone in the room.</p><p>Now we are going to set the individual parameters and synchronization of each of the prefabs we created, starting with <code class="literal">Goal</code>.</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">Goal</code> prefab in the <strong>Project</strong> panel and add three components to it using the <strong>Inspector</strong> panel: <strong>PlayMaker FSM</strong> (<strong>Script</strong>), <strong>Photon View</strong>, and <strong>Play Maker Photon Game Object Proxy</strong>. You can find these components by clicking on the <strong>Add Component</strong> button in <strong>Inspector</strong> and typing their names in the search field.</li><li class="listitem">Drag the <strong>Transform</strong> component of <code class="literal">Goal</code> prefab into the <strong>Photon View</strong> component's <strong>Observe</strong> property.</li><li class="listitem">Name the state machine <code class="literal">ColorSync</code> using the <strong>FSM</strong> tab of the <strong>playMaker</strong> panel.</li><li class="listitem">Rename the starting state to <code class="literal">is mine?</code> and add two events to it: <strong>YES</strong> and <strong>NO</strong>.</li><li class="listitem">Create two new states: <strong>Green</strong> and <strong>Red</strong>. Then make transitions from <strong>YES</strong> to <strong>Green</strong> and from <strong>NO</strong> to <strong>Red</strong>.</li><li class="listitem">In the <strong>is mine?</strong> state, add a <strong>Photon View Get Is Mine</strong> action. Set <strong>Is Mine Event</strong> to <strong>YES</strong> and <strong>Is Not Mine Event</strong> to <strong>NO</strong>.</li><li class="listitem">In the <strong>Green</strong> state, add a <strong>Set Material</strong> action. Set <strong>Material</strong> to the material you created for the green goal.</li><li class="listitem">Do the same for the <strong>Red</strong> state, but choose the red material instead.</li></ol></div><p>This state machine <a id="id164" class="indexterm"/>makes sure that goals change color in the beginning of the game. Verify that you still have the <strong>PlayMaker Photon Proxy</strong> game object in the scene. If you don't copy it from the <strong>Multiplayer</strong> scene. At this point you may want to build and launch two instances of the game to test that everything works well.</p><p>Now let us change the color of the mallets to match the goals' colors. We will also make sure that only the owner of the Mallet can move it.</p><div><ol class="orderedlist arabic"><li class="listitem">Find the <code class="literal">Fsm Photon player</code> prefab under <code class="literal">Photon Unity Networking/PlayMaker/Demo/Resources</code> in the <strong>Project</strong> panel and select it.</li><li class="listitem">Copy <strong>Play Maker Photon Game Object Proxy</strong> and the <strong>Photon View</strong> components over to the <code class="literal">Mallet</code> prefab by right-clicking the components' headers of <code class="literal">Fsm Photon player</code> and selecting <strong>Copy Component</strong> from the drop-down menu and then right-clicking one of the components' headers in the <code class="literal">Mallet</code> prefab and selecting <strong>Paste Component As New</strong> from the drop-down menu.</li><li class="listitem">Do the same for three of the <code class="literal">Fsm Photon player</code> prefab's <strong>Play Maker FSM</strong> components: the ones called <strong>GameObject naming</strong>, <strong>Position synch</strong>, and <strong>variable synch repository</strong>.</li><li class="listitem">Now the Mallet should have four FSMs. Rename the one called <strong>FSM</strong> to <code class="literal">Movement</code> to make sure we remember what it does.</li><li class="listitem">Drag the <strong>Play Maker FSM</strong> called <strong>variable synch repository</strong> into the <strong>Observe</strong> slot of <strong>Photon View</strong>. Set the <strong>Observe option</strong> property to <strong>Reliable Data Compressed</strong>.</li><li class="listitem">In the <strong>playMaker</strong> panel, open the <strong>Movement</strong> FSM and add a <code class="literal">Bool</code> variable to it called <strong>isMine</strong>.</li><li class="listitem">Set up the FSM as shown in the following screenshot, making sure that both the <strong>Move</strong> and <strong>Push Puck</strong> states stay unchanged. If you don't have the <strong>Push Puck</strong> state (you probably have it) confirm that the <strong>Move</strong> state has the <strong>Push Puck</strong> action attached to it. In order to set a state as a start state, right click on it and select <strong>Set as Start State</strong> from the contextual menu.</li><li class="listitem">Select the <a id="id165" class="indexterm"/><strong>Is mine?</strong> state and add the <strong>Photon View Get Is Mine</strong> action to it. Set its parameters as shown in the following screenshot, then add a transition from the <strong>Yes</strong> event to the <strong>Move</strong> state:<div><img src="img/8108OT_06_04.jpg" alt="Making multiplayer"/></div></li><li class="listitem">Switch to the <strong>GameObject naming</strong> FSM.</li><li class="listitem">In the <strong>add "me" to the gameObject name</strong> state, add a <strong>Set Material</strong> action and set its <strong>Material</strong> property to the green material you created for one of the mallets. Don't worry if it is no longer green, just make sure that each player's <strong>Goal</strong> material matches his/her <strong>Mallet</strong> material.</li><li class="listitem">In the <strong>add player to gameObject name</strong> state, add a <strong>SetMaterial</strong> action as well. This time set the <strong>Material</strong> property to the material that matches the red goal's material.</li><li class="listitem">Switch to the <strong>Position synch</strong> FSM, and select the <strong>Set player position with lerp</strong> state.</li><li class="listitem">In the <strong>Set Position</strong> action, set <strong>X</strong> to <strong>None</strong>, <strong>Y</strong> to <code class="literal">0.85</code>, and <strong>Z</strong> to <strong>None</strong>.</li></ol></div><p>Now the mallets should be good to go, their positions synched over the network and colors set on startup. Save your scene and confirm that mallets' positions are synced by building the game and launching two instances of it while connecting to the same match.</p><p>All that is left is to sync the <a id="id166" class="indexterm"/>Puck's position over the network.</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">Puck</code> prefab and add the <strong>Photon View</strong> and <strong>Play Maker Photon Game Object Proxy</strong> components to it.</li><li class="listitem">Copy the <strong>Position synch</strong> and <strong>variable synch repository</strong> FSMs to it from the <code class="literal">Fsm Photon player</code> prefab.</li><li class="listitem">Drag the <strong>variable synch repository</strong> component of <strong>Play Maker FSM</strong> into the <strong>Observe</strong> slot of <strong>Photon View</strong> and set its <strong>Observer</strong> option to <strong>Reliable Data Compressed</strong>.</li><li class="listitem">Switch to the <strong>Position synch</strong> FSM and select the <strong>Set player position with lerp</strong> state.</li><li class="listitem">In the <strong>Set Position</strong> action, set <strong>X</strong> to <strong>None</strong>, <strong>Y</strong> to <code class="literal">0.3</code>, and <strong>Z</strong> to <strong>None</strong>.</li><li class="listitem">Save your scene.</li></ol></div><p>The last thing that you need to do is make sure that one of the players leaves the room instead of just reloading the level once the puck hits a goal. To do that, select the <strong>GoalTriggerLeft</strong> game object and, in the <strong>LoadLevel</strong> state of its FSM, replace the <strong>Load Level</strong> action with <strong>Photon Network Leave Room</strong>. Do the same for <strong>GoalTriggerRight</strong>.</p><p>Now your multiplayer should be set up. Before testing everything, confirm that you have copied all of the files over from the <strong>Multiplayer</strong> scene correctly. Make sure that there is a game object called <strong>PlayMakerPhotonProxy</strong> in both <strong>demo_lobby</strong> and <strong>demo_room</strong> scenes. If it is missing in one of the scenes, add it by going to <strong>PlayMaker</strong> | <strong>Addons</strong> | <strong>Photon Networking</strong> | <strong>Components</strong> | <strong>Add Photon proxy to scene</strong> from the main menu, then save the scene.</p><p>You can test it by making a build and opening it in your browser while launching the game in the Editor. Make sure you always start from the <strong>demo_lobby</strong> scene, because otherwise the matchmaking will not work.</p><p>You will see that the mallets' and the puck's positions are synched over the network. That is, they move simultaneously in both Editor and web browser. You will also notice that the movement of the remote object is somewhat jerky and imprecise (especially the puck on the host's client). This is due to the inevitable network delay and physics data being calculated more often than Photon packages are being sent. At the moment the only real solution to this problem is switching to Unity native networking, which, however, requires that you have your own server if you want the game to work over the Internet.</p><p>The place where the objects' movement is smoothed out is the <strong>Position synch</strong> FSM of <code class="literal">Puck</code> and <code class="literal">Mallet</code> prefabs. If you look at the <strong>get player position</strong> and <strong>Set player position with lerp states</strong> of these state machines, you will see that, if the object was first created on the local machine, its position gets saved in a variable every frame and synched over the network. If the object does not belong to the player's client, the variable is read, and then the position of the local copy of the object is interpolated.</p><div><div><h3 class="title"><a id="tip27"/>Tip</h3><p>You could try changing the <strong>Amount</strong> property of the <strong>Vector3 Lerp 2</strong> action in the <strong>Set player position with lerp</strong> state. This variable determines the precision of the interpolation. If you want to know more about the way PUN works under the hood, make sure you consult its online documentation that explains every state machine in the demo scenes in great detail: <a class="ulink" href="https://hutonggames.fogbugz.com/default.asp?W927">https://hutonggames.fogbugz.com/default.asp?W927</a></p></div></div><p>As you can see, <a id="id167" class="indexterm"/>Photon networking is quite easy to set up, but is not a very good solution for games that require physics simulation. This is mostly due to cloud server limitations and limited integration with the Unity engine. Most simple games that don't rely on physics so heavily can benefit from Photon greatly. In other cases, Unity native networking should be used. More information about it can be found in the Network Reference Guide section of the Unity documentation: <a class="ulink" href="http://docs.unity3d.com/Documentation/Components/NetworkReferenceGuide.html">http://docs.unity3d.com/Documentation/Components/NetworkReferenceGuide.html</a></p><p>Playmaker is capable of working with native Unity networking as well. You can check the <strong>Network</strong> section of the <strong>Actions</strong> panel for the list of available Playmaker actions and compare them with the actions described in the reference material.</p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec33"/>Summary</h1></div></div></div><p>In this chapter, you learned the basics of networking in games, set up the Photon Unity Networking plugin to work with Playmaker, and added PUN multiplayer to your game. We also examined the advantages and disadvantages of Photon and showed that it may not be suitable for physics games such as air hockey, because of the network delay.</p><p>The next chapter will show how to put your game on the Web and add Kongregate API to save game scores in an online leaderboard.</p></div></body></html>