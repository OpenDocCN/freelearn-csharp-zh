<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Writing Secure Code and Debugging in Visual Studio</h1></div></div></div><p>In this chapter, we will have a look at some examples of being more efficient as a developer when it comes to debugging your code. We will also be looking at how to write secure code. Writing secure code can be a challenge, but consider the following: if part of your code security involves making sure that passwords are securely stored, why write that code over and over between projects? Write the code once and implement it in every new project you create. The concepts we will be looking at are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Encrypting and storing passwords correctly</li><li class="listitem" style="list-style-type: disc">Using <code class="literal">SecureString</code> in code</li><li class="listitem" style="list-style-type: disc">Securing sensitive parts of <code class="literal">App.config</code>/<code class="literal">web.config</code></li><li class="listitem" style="list-style-type: disc">Preventing SQL injection attacks</li><li class="listitem" style="list-style-type: disc">Using <strong>Diagnostic Tools</strong> and <strong>Historical Debugging</strong></li><li class="listitem" style="list-style-type: disc">Setting conditional breakpoints</li><li class="listitem" style="list-style-type: disc">Using <strong>PerfTips</strong> to identify bottlenecks in code</li></ul></div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec82"/>Introduction</h1></div></div></div><p>Something that many developers tend to miss is the need to write secure code. Development deadlines and other project-related pressures cause developers to put delivering code above doing it the right way. Many of you might not agree with me, but believe me when I say that I have heard the excuse of "We do not have budget for this" once too many times. This is usually when the development budget has been determined by other stakeholders and the developer not consulted.</p><p>Consider a situation where a consultant tells the developer that they have sold a system to a customer. That system now needs to be developed. Furthermore, the developer is told that they have <em>x</em> amount of hours to complete the development. A document outlining the requirements is given to the developer and the developer is given the go-ahead to begin, and to complete development in the required time.</p><p>This scenario is the reality many developers face. You might think that this scenario can't possibly exist, or perhaps you are reading this and relate to the scenario as being how the process currently works in your company. Whatever the case may be, this is something that happens today in software development.</p><p>So how do developers combat project suicide? (I call these projects this because projects approached like this rarely succeed.) Start by creating reusable code. Think of processes you repeat often enough to warrant writing a reusable DLL for. Did you know that you can create Visual Studio templates? If you have a standard project structure you use, create a template from it and re-use it for each new project, thereby speeding up delivery and cutting down on bugs.</p><p>A few considerations for project templates are database layers, security layers, common validation code (does this data table contain any data), common extension methods, and so on.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec83"/>Encrypting and storing passwords correctly</h1></div></div></div><p>One thing I have often seen is<a class="indexterm" id="id929"/> badly stored passwords. Just because the password is stored in a<a class="indexterm" id="id930"/> database on your server, does not make it secure. So what do badly stored passwords look like?</p><div><img alt="Encrypting and storing passwords correctly" src="img/B05391_12_01.jpg"/></div><p>Secure passwords stored badly are no longer secure. The passwords in the previous screenshot are the actual user passwords. Entering the first password, <code class="literal">^tj_Y4$g1!8LkD</code> at the login screen will give the user access to the system. Passwords should be stored securely in the database. In fact, you need to employ salted password hashing. You should be able to encrypt the user's password, but never decrypt it.</p><p>So how do you decrypt the password to match it to the password the user enters at the login screen? Well, you don't. You always hash the password the user enters at the login screen. If it matches the hash of their real password stored in the database, you give them access to the system.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec197"/>Getting ready</h2></div></div></div><p>The SQL tables in this recipe are for illustration only and are not written to by the code in the recipe. The database can be found in the <code class="literal">_database scripts</code> folder that accompanies the source <a class="indexterm" id="id931"/>code for this book.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec198"/>How to do it…</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Create a new class library by right-clicking on your solution, and selecting <strong>Add</strong> and then <strong>New Project</strong> from the context menu:<div><img alt="How to do it…" src="img/B05391_12_02.jpg"/></div></li><li class="listitem">From the<a class="indexterm" id="id932"/> <strong>Add New Project</strong> dialog screen, select <strong>Class Library</strong> from the installed templates and call your class <code class="literal">Chapter12</code>:<div><img alt="How to do it…" src="img/B05391_12_03.jpg"/></div></li><li class="listitem">Your new class library will be added to your solution with a default name of <code class="literal">Class1.cs</code>, which <a class="indexterm" id="id933"/>we renamed <code class="literal">Recipes.cs</code> in order to distinguish the<a class="indexterm" id="id934"/> code properly. You can, however, rename your class whatever you like if that makes more sense to you.</li><li class="listitem">To rename your class, simply click on the class name in the <strong>Solution Explorer</strong> and select <strong>Rename</strong> from the context menu:<div><img alt="How to do it…" src="img/B05391_12_04.jpg"/></div></li><li class="listitem">Visual Studio will <a class="indexterm" id="id935"/>ask you to confirm a rename of all references to the<a class="indexterm" id="id936"/> code element <strong>Class1</strong> in the project. Just click <strong>Yes</strong>:<div><img alt="How to do it…" src="img/B05391_12_49.jpg"/></div></li><li class="listitem">The following class is added to your <code class="literal">Chapter12</code> library project:<div><pre class="programlisting">namespace Chapter12
{
    public class Recipes
    {
        
    }
}</pre></div></li><li class="listitem">Add the following <code class="literal">using</code> statement to your class:<div><pre class="programlisting">using System.Security.Cryptography;</pre></div></li><li class="listitem">Next, you need to <a class="indexterm" id="id937"/>add two properties to the class. These properties will store the salt and the hash. Usually you will write these values to the database <a class="indexterm" id="id938"/>along with the username, but for the purposes of this recipe we will simply add them to the static properties. Also add two methods to the class called <code class="literal">RegisterUser()</code> and <code class="literal">ValidateLogin()</code>. Both methods take as parameters the <code class="literal">username</code> and <code class="literal">password</code> variables:<div><pre class="programlisting">public static class Recipes
{
    public static string saltValue { get; set; }
    public static string hashValue { get; set; }

    public static void RegisterUser(string password, string username)
    {
                    
    }

    public static void ValidateLogin(string password, string username)
    {                  

    }
}</pre></div></li><li class="listitem">Starting with the <code class="literal">RegisterUser()</code> method, here we do a number of things. To list the steps in the method:<div><ol class="orderedlist arabic"><li class="listitem">We generate a truly random, cryptographically strong salt value using <code class="literal">RNGCryptoServiceProvider</code></li><li class="listitem">Add the salt to the password and hash the salted password using <code class="literal">SHA256</code>.<div><div><h3 class="title"><a id="note44"/>Note</h3><p>It doesn't matter if you add the salt before or after the password. Just remember to be consistent each time you do it.</p></div></div></li><li class="listitem">Store the salt value and the hash value along with the username in the database.<div><div><h3 class="title"><a id="note45"/>Note</h3><p>In order to cut down on code, I have not actually added code to write the hash and salt values to the database. I simply added them to the properties created earlier. In a real-world situation, you would always write these to the database.</p></div></div><p>This is a very s<a class="indexterm" id="id939"/>ecure way to handle user passwords in your<a class="indexterm" id="id940"/> application:</p><div><pre class="programlisting">public static void RegisterUser(string password, string username)
{
    // Create a truly random salt using RNGCryptoServiceProvider.
    RNGCryptoServiceProvider csprng = new RNGCryptoServiceProvider();
    byte[] salt = new byte[32];
    csprng.GetBytes(salt);

    // Get the salt value
    saltValue = Convert.ToBase64String(salt);
    // Salt the password
    byte[] saltedPassword = Encoding.UTF8.GetBytes(saltValue + password);
            
    // Hash the salted password using SHA256
    SHA256Managed hashstring = new SHA256Managed();
    byte[] hash = hashstring.ComputeHash(saltedPassword);

    // Save both the salt and the hash in the user's database record.
    saltValue = Convert.ToBase64String(salt);
    hashValue = Convert.ToBase64String(hash);            
}</pre></div></li></ol></div></li><li class="listitem">The next method we need to create is the <code class="literal">ValidateLogin()</code> method. Here we take the username and validate that first. If the user entered the username incorrectly, do not tell them so. This would alert someone trying to compromise the system that they have the wrong username and that as soon as they get a wrong password notification, they know that the username is correct. The steps in this method are as follows:<div><ol class="orderedlist arabic"><li class="listitem">Get the salt and hash values for the entered username from the database.</li><li class="listitem">Salt the password the user entered at the login screen with the salt read from the database.</li><li class="listitem">Hash the salted password using the same hashing algorithm as when the user registered.</li><li class="listitem">Compare the <a class="indexterm" id="id941"/>hash value read from the database to the hash <a class="indexterm" id="id942"/>value generated in the method. If the two hashes match, then the password is correctly entered and the user validated.<p>Note that we never decrypt the password from the database. If you have code decrypting user passwords and matching that to the password entered, you need to reconsider and rewrite your password logic. A system should never be able to decrypt user passwords.</p><div><pre class="programlisting">public static void ValidateLogin(string password, string username)
{            
    // Read the user's salt value from the database
    string saltValueFromDB = saltValue;

    // Read the user's hash value from the database
    string hashValueFromDB = hashValue;
            
    byte[] saltedPassword = Encoding.UTF8.GetBytes(saltValueFromDB + password);

    // Hash the salted password using SHA256
    SHA256Managed hashstring = new SHA256Managed();
    byte[] hash = hashstring.ComputeHash(saltedPassword);

    string hashToCompare = Convert.ToBase64String(hash);

    if (hashValueFromDB.Equals(hashToCompare))
        Console.WriteLine("User Validated.");            
    else
        Console.WriteLine("Login credentials incorrect. User not validated.");            
}</pre></div></li></ol></div></li><li class="listitem">To test the code, add a reference to the <code class="literal">Chapter12</code> class in your <code class="literal">CodeSamples</code> project:<div><img alt="How to do it…" src="img/B05391_12_05.jpg"/></div></li><li class="listitem">Because we <a class="indexterm" id="id943"/>created a static class, you can add the new <code class="literal">using static</code> to your <code class="literal">Program.cs</code> file:<div><pre class="programlisting">using static Chapter12.Recipes;</pre></div></li><li class="listitem">Test the code by calling the <code class="literal">RegisterUser()</code> method and pass it the <code class="literal">username</code> and <code class="literal">password</code> variable. After that, call the <code class="literal">ValidateLogin()</code> method and see whether the <a class="indexterm" id="id944"/>password matches the hash. This would obviously not happen at the same time in a real production system:<div><pre class="programlisting">string username = "dirk.strauss";
string password = "^tj_Y4$g1!8LkD";
RegisterUser(password, username);

ValidateLogin(password, username);
Console.ReadLine();</pre></div></li><li class="listitem">When you debug the code, you <a class="indexterm" id="id945"/>will see the user has been validated:<div><img alt="How to do it…" src="img/B05391_12_06.jpg"/></div></li><li class="listitem">Lastly, modify the<a class="indexterm" id="id946"/> code slightly and set the <code class="literal">password</code> variable to something else. This will mimic a user entering an incorrect password:<div><pre class="programlisting">string username = "dirk.strauss";
string password = "^tj_Y4$g1!8LkD";
RegisterUser(password, username);

password = "WrongPassword";
ValidateLogin(password, username);
Console.ReadLine();</pre></div></li><li class="listitem">When you debug the application, you will see that the user is not validated:<div><img alt="How to do it…" src="img/B05391_12_07.jpg"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec199"/>How it works…</h2></div></div></div><p>Nowhere in the code did we decrypt the password. In fact, the password is never stored anywhere. We always worked <a class="indexterm" id="id947"/>with the hash of the password. Here are the important points to take away from this recipe:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Never use the<a class="indexterm" id="id948"/> <code class="literal">Random</code> class in C# to generate your salt. Always use the <code class="literal">RNGCryptoServiceProvider</code> class.</li><li class="listitem" style="list-style-type: disc">Never re-use the same salt in your code. So don't create a constant with your salt and use it to salt all the passwords in your system.</li><li class="listitem" style="list-style-type: disc">Never tell the user that the password is incorrect if the password didn't match. Also, never tell the user that they entered an incorrect username. This prevents someone trying to compromise the system from knowing that they got one of the two login credentials correct. If either the username or password has been entered incorrectly, rather notify the user that their login credentials are incorrect. This could mean that either the username or password (or both) have been entered incorrectly.</li><li class="listitem" style="list-style-type: disc">You can't get the passwords from the hash or salt stored in the database. Therefore, if the database was compromised, the password data stored within it would not be at risk. The encryption of the user's password is a one-way operation, meaning that it can never be decrypted. Also important to note is that even if the source code was compromised and stolen by someone with malicious intent, you would not be able to use the code to decipher the encrypted data in the database.</li><li class="listitem" style="list-style-type: disc">Combine the previous<a class="indexterm" id="id949"/> methods with a strong password policy (because even in 2016, there are still users that think using <code class="literal">'l3tm31n'</code> for a password is good enough), and you have a very good password encryption routine.</li></ul></div><p>When we look at the user<a class="indexterm" id="id950"/> access table, the correct way to store user credentials would look something like this:</p><div><img alt="How it works…" src="img/B05391_12_08.jpg"/></div><p>The salt and hash are stored alongside the username, and are secure because they can't be decrypted to expose the actual password.</p><div><div><h3 class="title"><a id="tip03"/>Tip</h3><p>If you sign up for a service on the Internet and they send you a confirmation either via email or text message and display your password in this message in plain text, then you should seriously consider closing your account. If a system can read your password and send it to you in plain text, then so can anybody else. Never use the same password for all your logins.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec84"/>Using SecureString in code</h1></div></div></div><p>Securing your application against malicious attacks is not an easy task. It is the constant struggle between writing secure <a class="indexterm" id="id951"/>code while minimizing bugs (which hackers usually exploit) and black hats writing more and more sophisticated methods to<a class="indexterm" id="id952"/> compromise systems and networks. I personally believe that higher learning institutions need to teach IT students two things:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to use and integrate with a popular ERP system</li><li class="listitem" style="list-style-type: disc">Proper software security principles</li></ul></div><p>In fact, I believe that secure programming 101 must not simply be a module or topic in a given IT course, but a whole course on its own. It needs to be handled with the seriousness and respect it deserves and needs to preferably be taught by someone that can actually hack a system or network.</p><p>White hats teaching students how to compromise systems, exploit vulnerable code, and infiltrate networks will make a big difference in changing the way future software developers approach programming. It comes down to developers knowing what not to do when programming defensively. It is quite possible that some of those students might go on to become black hats themselves, but they would have done that irrespective of whether they took a class on hacking secure programming or not.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec200"/>Getting ready</h2></div></div></div><p>The code might look <a class="indexterm" id="id953"/>a little funny in some places. This is because <code class="literal">SecureString</code> is using unmanaged memory to store the sensitive information. Rest<a class="indexterm" id="id954"/> assured that <code class="literal">SecureString</code> is well supported and used within the .NET Framework, as can be seen from the instantiation of the <code class="literal">SqlCredential</code> object used in creating connections to a database:</p><div><img alt="Getting ready" src="img/B05391_12_33.jpg"/></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec201"/>How to do it…</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start by adding a new Windows Forms project to your solution:<div><img alt="How to do it…" src="img/B05391_12_09.jpg"/></div></li><li class="listitem">Call the <a class="indexterm" id="id955"/>project <code class="literal">winformSecure</code> and click on the <strong>OK</strong><a class="indexterm" id="id956"/> button:<div><img alt="How to do it…" src="img/B05391_12_10.jpg"/></div></li><li class="listitem">In the <strong>Toolbox</strong>, search <a class="indexterm" id="id957"/>for the <strong>TextBox</strong> control <a class="indexterm" id="id958"/>and add it to your form:<div><img alt="How to do it…" src="img/B05391_12_50.jpg"/></div></li><li class="listitem">Lastly, add a <a class="indexterm" id="id959"/>button control to your form. You can<a class="indexterm" id="id960"/> resize this form however you like to look more like a login form:<div><img alt="How to do it…" src="img/B05391_12_11.jpg"/></div></li><li class="listitem">With the text box <a class="indexterm" id="id961"/>control selected on the Windows Forms, open up the <strong>Properties</strong> panel and click on the Events button (it looks like a<a class="indexterm" id="id962"/> lightning bolt). In the <strong>Key</strong> group, double-click on the <strong>KeyPress</strong> event to create the handler in the code behind:<div><img alt="How to do it…" src="img/B05391_12_12.jpg"/></div><p>The code that is <a class="indexterm" id="id963"/>created for you is the <strong>KeyPress</strong> event <a class="indexterm" id="id964"/>handler for the text box control. This will fire whenever a user presses a key on the keyboard:</p><div><pre class="programlisting">private void textBox1_KeyPress(object sender, KeyPressEventArgs e)
{
    
}</pre></div></li><li class="listitem">Back in the <strong>Properties</strong> panel, expand the <strong>Behavior</strong> group and change the value of <strong>UseSystemPasswordChar</strong> to <code class="literal">true</code>:<div><img alt="How to do it…" src="img/B05391_12_13.jpg"/></div></li><li class="listitem">In the code <a class="indexterm" id="id965"/>behind, add the following <code class="literal">using</code> statement:<div><pre class="programlisting">using System.Runtime.InteropServices;</pre></div></li><li class="listitem">Add the <code class="literal">SecureString</code> variable <a class="indexterm" id="id966"/>as a global variable to your Windows Forms:<div><pre class="programlisting">SecureString secure = new SecureString();</pre></div></li><li class="listitem">Then in the <code class="literal">KeyPress</code> event, append the <code class="literal">KeyChar</code> value to the <code class="literal">SecureString</code> variable every time the user presses a key. You might want to add code to ignore certain key presses, but this is beyond the scope of this recipe:<div><pre class="programlisting">private void textBox1_KeyPress(object sender, KeyPressEventArgs e)
{
    secure.AppendChar(e.KeyChar);
}</pre></div></li><li class="listitem">Then in the <a class="indexterm" id="id967"/><strong>Login</strong> button's event handler, add the following code to read the value from the <code class="literal">SecureString</code> object. Here we are <a class="indexterm" id="id968"/>working with unmanaged memory and unmanaged code:<div><pre class="programlisting">private void btnLogin_Click(object sender, EventArgs e)
{
    IntPtr unmanagedPtr = IntPtr.Zero;

    try
    {
        if (secure == null)
            throw new ArgumentNullException("Password not defined");
        unmanagedPtr = Marshal.SecureStringToGlobalAllocUnicode(secure);
        MessageBox.Show($"SecureString password to validate is {Marshal.PtrToStringUni(unmanagedPtr)}");
    }
    catch(Exception ex)
    {
        MessageBox.Show(ex.Message);
    }
    finally
    {
        Marshal.ZeroFreeGlobalAllocUnicode(unmanagedPtr);
        secure.Dispose();
    }
}</pre></div></li><li class="listitem">Run your Windows Forms application and type in a password:<div><img alt="How to do it…" src="img/B05391_12_31.jpg"/></div></li><li class="listitem">Then click on the <strong>Login</strong> button. You will then see the password you typed in displayed in the message box:<div><img alt="How to do it…" src="img/B05391_12_32.jpg"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec202"/>How it works…</h2></div></div></div><p>It has become almost a<a class="indexterm" id="id969"/> habit for many developers to use <code class="literal">System.String</code> to <a class="indexterm" id="id970"/>store sensitive information such as passwords. The problem with this approach is that <code class="literal">System.String</code> is immutable. This means that the object created in memory by <code class="literal">System.String</code> can't be changed. If you modify the variable, a new object is created in memory. You also cannot determine when the object created by <code class="literal">System.String</code> will be removed from memory during garbage collection. Conversely, by using the <code class="literal">SecureString</code> object, you will encrypt sensitive information and when that object is no longer needed, it is deleted from memory. <code class="literal">SecureString</code> encrypts and decrypts your sensitive data in unmanaged memory.</p><p>Now I need to be clear regarding one thing here. <code class="literal">SecureString</code> is by no means foolproof. If your system contains a virus with the sole purpose of compromising the <code class="literal">SecureString</code> operations, using it doesn't help much (be sure to use proper anti-virus software anyway). At some point during the code execution, the string representation of your password (or sensitive information) is visible. Secondly, if a hacker somehow found a way to inspect your heap or log your key strokes, the password might be visible. The use of <code class="literal">SecureString</code>, however makes this window of opportunity for a hacker much smaller. The window of opportunity reduces because there are less attack vectors (points of entry for a hacker), thereby reducing your attack surface (sum of all points of attack by a hacker).</p><p>The bottom<a class="indexterm" id="id971"/> line is this: <code class="literal">SecureString</code> is there for a reason. As a software developer concerned about security, you <a class="indexterm" id="id972"/>should be using <code class="literal">SecureString</code>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec85"/>Securing sensitive parts of App.config/web.config</h1></div></div></div><p>As a developer, you<a class="indexterm" id="id973"/> will undoubtedly work with sensitive information such as passwords. How you handle this information during development is very important. In the past, I have received copies of a client's live database to use for testing. This does pose a very real security risk for your client.</p><p>Often, we keep settings in a <code class="literal">web.config</code> file (when working with web applications). For this example, though, I will be demonstrating a console application that uses an <code class="literal">App.config</code> file. The same logic can be applied to a <code class="literal">web.config</code> file too.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec203"/>Getting ready</h2></div></div></div><p>Creating a console application is the quickest way to demonstrate this recipe. If, however, you want to follow along using a web application (and securing a <code class="literal">web.config</code> file), you can do so.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec204"/>How to do it…</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">In the console application, locate the <code class="literal">App.config</code> file. This is the file that contains the sensitive data:<div><img alt="How to do it…" src="img/B05391_12_17.jpg"/></div></li><li class="listitem">If you open the <code class="literal">App.config</code> file, you will see that within the <code class="literal">appSettings</code> tag there is a key added called <code class="literal">Secret</code>. This information should probably not be in the <code class="literal">App.config</code> to start off with. The problem here is that it might be checked into your<a class="indexterm" id="id974"/> source control. Imagine that on GitHub?<div><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;configuration&gt;
    &lt;startup&gt; 
        &lt;supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.6.1"/&gt;
    &lt;/startup&gt;
    &lt;appSettings&gt;
      &lt;add key="name" value="Dirk"/&gt;
      &lt;add key="lastname" value="Strauss"/&gt; 
      &lt;add key="Secret" value="letMeIn"/&gt;
    &lt;/appSettings&gt;
&lt;/configuration&gt;</pre></div></li><li class="listitem">To overcome this vulnerability, we need to move the sensitive data out of the <code class="literal">App.config</code> file into another file. To do this, we specify a path to a file that will contain the sensitive data we want to remove from the <code class="literal">App.config</code> file:<div><pre class="programlisting">&lt;appSettings file="C:\temp\secret\secret.config"&gt;</pre></div><div><div><h3 class="title"><a id="note46"/>Note</h3><p>You might be wondering, why not simply just encrypt the information? Well, that is a given really. The reason this value is in plain text is just to demonstrate a concept here. You would probably encrypt this value anyway in a real-world situation. You would not, however, want this sensitive information sitting on a server in a code repository somewhere, even if it is encrypted. Be safe, move it out of your solution.</p></div></div></li><li class="listitem">When you have <a class="indexterm" id="id975"/>added the path to the secure file, remove the key containing the sensitive information:<div><img alt="How to do it…" src="img/B05391_12_18.jpg"/></div></li><li class="listitem">Navigate to the path you specified in the <code class="literal">App.config</code> file property. Create your <code class="literal">secret.config</code> file and open it up for editing:<div><img alt="How to do it…" src="img/B05391_12_19.jpg"/></div></li><li class="listitem">Inside this file, repeat the <code class="literal">appSettings</code> section and add the <code class="literal">Secret</code> key to it. What happens<a class="indexterm" id="id976"/> now is that when your console application runs, it reads the <code class="literal">appSettings</code> section in your solution and finds the reference to the secret file. It then looks for the secret file and merges it with the <code class="literal">App.config</code> in your solution:<div><img alt="How to do it…" src="img/B05391_12_20.jpg"/></div></li><li class="listitem">To see that this<a class="indexterm" id="id977"/> merge works, add a reference to your console application:<div><img alt="How to do it…" src="img/B05391_12_14.jpg"/></div></li><li class="listitem">Search for <a class="indexterm" id="id978"/>and add <code class="literal">System.Configuration</code> to your references:<div><img alt="How to do it…" src="img/B05391_12_15.jpg"/></div></li><li class="listitem">When you have<a class="indexterm" id="id979"/> added the reference, your solution references should look something like this:<div><img alt="How to do it…" src="img/B05391_12_16.jpg"/></div></li><li class="listitem">To the top of your <code class="literal">Program.cs</code> file, add the following <code class="literal">using</code> statement:<div><pre class="programlisting">using System.Configuration;</pre></div></li><li class="listitem">Add the following<a class="indexterm" id="id980"/> code to read the <code class="literal">Secret</code> key setting from your <code class="literal">App.config</code> file. Only this time, it will read the merged file, which is made up of your <code class="literal">App.config</code> and your <code class="literal">secret.config</code> file:<div><pre class="programlisting">string sSecret = ConfigurationManager.AppSettings["Secret"];
Console.WriteLine(sSecret);
Console.ReadLine();</pre></div></li><li class="listitem">Run your console application<a class="indexterm" id="id981"/> and you will see that the sensitive data has been read from the <code class="literal">secret.config</code> file, which was merged with the <code class="literal">App.config</code> file at runtime:<div><img alt="How to do it…" src="img/B05391_12_21.jpg"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec205"/>How it works…</h2></div></div></div><p>Something I need to point out here is that this technique will also work for <code class="literal">web.config</code> files. If you need to remove sensitive information from your configuration file, move it to another file so that it doesn't get included in your source control check-in or deployment.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec86"/>Preventing SQL injection attacks</h1></div></div></div><p>SQL injection attacks<a class="indexterm" id="id982"/> are a very real problem. There are too many applications that still make themselves vulnerable to this kind of attack. If you develop a web application or website, you should be vigilant of bad database operations. Vulnerable in-line SQL exposes the database to a SQL injection attack. A SQL injection attack is where an attacker modifies SQL statements via a web form input box to produce a different result than originally intended. This is usually attempted on a form where the web application is supposed to access the database to authenticate the user login. By not sanitizing the user input, you are exposing your data to exploits such as this.</p><p>The accepted solution to mitigate SQL injection attacks is to create a parametrized stored procedure and call that from your code.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec206"/>Getting ready</h2></div></div></div><p>You need to create the <code class="literal">CookbookDB</code> database in your SQL Server before continuing this recipe. You will find<a class="indexterm" id="id983"/> the script in the <code class="literal">_database scripts</code> folder in the accompanying source code.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec207"/>How to do it…</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">For this recipe, I am using SQL Server 2012. The concept is the same if you are using an older version of SQL Server. After you have created the <code class="literal">CookbookDB</code> database, you will see that there is a table called <code class="literal">UserDisplayData</code> under the <code class="literal">Tables</code> folder:<div><img alt="How to do it…" src="img/B05391_12_22.jpg"/></div></li><li class="listitem">The <code class="literal">UserDisplayData</code> table is simply used to illustrate the concept of querying using a parameterized stored procedure. It would not have any real benefit in a production database, because it only returns a screen name:<div><img alt="How to do it…" src="img/B05391_12_29.jpg"/></div></li><li class="listitem">We need to<a class="indexterm" id="id984"/> create a stored procedure to select data from this table for a specific ID (user ID). Click on the <code class="literal">Programmability</code> node to expand it:<div><img alt="How to do it…" src="img/B05391_12_23.jpg"/></div></li><li class="listitem">Next, right-click <a class="indexterm" id="id985"/>on the <code class="literal">Stored Procedures</code> node and select <strong>New Stored Procedure…</strong> from the context menu:<div><img alt="How to do it…" src="img/B05391_12_24.jpg"/></div></li><li class="listitem">SQL Server will create the following stored procedure template for you. This template consists<a class="indexterm" id="id986"/> of a section where you can comment on the particular stored procedure, as well as a section to add parameters you might need, and obviously a section that you need to add the actual SQL statement to:<div><pre class="programlisting">SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:          &lt;Author,,Name&gt;
-- Create date:      &lt;Create Date,,&gt;
-- Description:      &lt;Description,,&gt;
-- =============================================
CREATE PROCEDURE &lt;Procedure_Name, sysname, ProcedureName&gt; 
    -- Add the parameters for the stored procedure here
    &lt;@Param1, sysname, @p1&gt; &lt;Datatype_For_Param1, , int&gt; = &lt;Default_Value_For_Param1, , 0&gt;, 
    &lt;@Param2, sysname, @p2&gt; &lt;Datatype_For_Param2, , int&gt; = &lt;Default_Value_For_Param2, , 0&gt;
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON;

    -- Insert statements for procedure here
    SELECT &lt;@Param1, sysname, @p1&gt;, &lt;@Param2, sysname, @p2&gt;
END
GO</pre></div></li><li class="listitem">Give the stored <a class="indexterm" id="id987"/>procedure a suitable name that will describe the action or intent of the stored procedure:<div><pre class="programlisting">CREATE PROCEDURE cb_ReadCurrentUserDisplayData</pre></div><div><div><h3 class="title"><a id="note47"/>Note</h3><p>There are many people that do prefix their stored procedures, and I'm one of those. I like to keep my stored procedures grouped. I therefore name my stored procedures in the format <em>[prefix]_[tablename_or_module]_[stored_procedure_action]</em>. Having said that, I generally avoid using <code class="literal">sp_</code> as a prefix to my stored procedures. There are a lot of opinions on the Internet as to why this is a bad idea. It is generally believed that using <code class="literal">sp_</code> as a stored procedure prefix impacts on performance because it is used as the stored procedure prefix in the master database.</p><p>For the purposes of this recipe, I have just kept to a simple name for the stored procedure.</p></div></div></li><li class="listitem">Define a parameter for this stored procedure. By doing this, you are telling the database that when this stored procedure is called, it will pass through a value of type integer that is stored in a parameter caller <code class="literal">@userID</code>:<div><pre class="programlisting">@userID INT</pre></div></li><li class="listitem">You now define the SQL statement to be used by this stored procedure. We are just going to do a straightforward <code class="literal">SELECT</code> statement:<div><pre class="programlisting">SELECT
   Firstname, Lastname, Displayname
FROM
   dbo.UserDisplayData
WHERE
   ID = @userID</pre></div><div><div><h3 class="title"><a id="note48"/>Note</h3><p>You will notice that my <code class="literal">SELECT</code> statement contains the specific column names instead of a <code class="literal">SELECT * FROM</code>. Doing a <code class="literal">SELECT *</code> is considered bad practice. You would usually not want to return all the column values from a table. If you want all the column values, then it is better to explicitly list the columns by name instead of just getting all.</p><p>Using <code class="literal">SELECT *</code> returns unnecessary columns and increases the overhead on the server. This does make a difference in the bigger scheme of things, especially when the database starts getting a lot of traffic.</p><p>The thought of having to type out the column names for a large table is definitely not something I would look forward to. You can however use the following tricks to make it easy for you to add the column names to your SQL <code class="literal">SELECT</code> statement. You can right-click on the database table and select <strong>Script Table As</strong> to create one of several SQL statements. Secondly, you can expand the <code class="literal">Table</code> node and expand the table you wish to write the statement for. You will then see a node called <code class="literal">Columns</code>. Drag the <code class="literal">Columns</code> node<a class="indexterm" id="id988"/> onto the query editor. That will insert all the column names into the query editor for you.</p></div></div></li><li class="listitem">When you have completed adding the code to your stored procedure, it will look like this:<div><img alt="How to do it…" src="img/B05391_12_25.jpg"/></div></li><li class="listitem">To create the stored procedure, you need to click on the <strong>Execute</strong> button. Be certain that you have the correct database selected when clicking on the <strong>Execute</strong> button:<div><img alt="How to do it…" src="img/B05391_12_26.jpg"/></div></li><li class="listitem">The stored <a class="indexterm" id="id989"/>procedure will then be created under the <code class="literal">Stored Procedures</code> node in SQL Server:<div><img alt="How to do it…" src="img/B05391_12_27.jpg"/></div></li><li class="listitem">We have now got to halfway through this task. It is time to construct the code that we will use in our application to query the database. We will be adding this code directly<a class="indexterm" id="id990"/> to the <code class="literal">Program.cs</code> file of your console application. While this code isn't considered best practice (hardcoding the server credentials), it serves merely to illustrate the concept of calling a parameterized stored procedure from C#.</li><li class="listitem">To start, add the following <code class="literal">using</code> statement to the top of your console application:<div><pre class="programlisting">using System.Data.SqlClient;</pre></div></li><li class="listitem">We then add the variables to contain the credentials we need to log on to the server:<div><pre class="programlisting">int intUserID = 1;
int cmdTimeout = 15;
string server = "DIRK";
string db = "CookbookDB";
string uid = "dirk";
string password = "uR^GP2ABG19@!R";</pre></div></li><li class="listitem">We now use <code class="literal">SecureString</code> to store the password and add it to a <code class="literal">SqlCredential</code> object:<div><pre class="programlisting">SecureString secpw = new SecureString();
if (password.Length &gt; 0)
{
    foreach (var c in password.ToCharArray()) secpw.AppendChar(c);
}
secpw.MakeReadOnly();
          
string dbConn = $"Data Source={server};Initial Catalog={db};";
6SqlCredential cred = new SqlCredential(uid, secpw);</pre></div><div><div><h3 class="title"><a id="note49"/>Note</h3><p>For more on <code class="literal">SecureString</code>, see the <em>Using SecureString in code</em> recipe of this chapter.</p></div></div></li><li class="listitem">We now<a class="indexterm" id="id991"/> create a <code class="literal">SqlConnection</code> object inside a <code class="literal">using</code> statement. This ensures that the SQL connection is closed when the <code class="literal">using</code> statement moves out of scope:<div><pre class="programlisting">using (SqlConnection conn = new SqlConnection(dbConn, cred))
{                
    try
    {

    }
    catch (Exception ex)
    {
        Console.WriteLine(ex.Message);
    }
}
Console.ReadLine();</pre></div></li><li class="listitem">Inside the <code class="literal">try</code>, add the following code to open the connection string and create a <code class="literal">SqlCommand</code> object that takes the open connection and name of the stored procedure as parameters. You can use the shortcut method of creating the actual SQL parameter to pass to the stored procedure:<div><pre class="programlisting">cmd.Parameters.Add("userID", SqlDbType.Int).Value = intUserID;</pre></div><p>Because I'm just passing a parameter of type integer to the stored procedure, I'm not defining a length for this parameter:</p><div><img alt="How to do it…" src="img/B05391_12_30.jpg"/></div><p>If, however, you ever need to define a parameter of type <code class="literal">VarChar(MAX)</code>, you <a class="indexterm" id="id992"/>would need to define the size of the parameter type by adding <code class="literal">-1</code>. Let's say, for example you need to store a student's essay in the database, the code would then look as follows for the <code class="literal">VarChar(MAX)</code>:</p><div><pre class="programlisting">cmd.Parameters.Add("essay", SqlDbType.VarChar, -1).Value = essayValue;</pre></div></li><li class="listitem">After we have added our parameter with its value to the <code class="literal">SqlCommand</code> object, we specify a timeout value, execute the <code class="literal">SqlDataReader</code>, and load it into a <code class="literal">DataTable</code>. The value is then output to the console application:<div><pre class="programlisting">conn.Open();
SqlCommand cmd = new SqlCommand("cb_ReadCurrentUserDisplayData", conn);
cmd.CommandType = CommandType.StoredProcedure;
cmd.Parameters.Add("userID", SqlDbType.Int).Value = intUserID;
cmd.CommandTimeout = cmdTimeout;
var returnData = cmd.ExecuteReader();
var dtData = new DataTable();
dtData.Load(returnData);

if (dtData.Rows.Count != 0)
     Console.WriteLine(dtData.Rows[0]["Displayname"]);</pre></div></li><li class="listitem">After you have added all the code to your console application, the correct completed code will look as follows:<div><pre class="programlisting">int intUserID = 1;
int cmdTimeout = 15;
string server = "DIRK";
string db = "CookbookDB";
string uid = "dirk";
string password = "uR^GP2ABG19@!R";
SecureString secpw = new SecureString();
if (password.Length &gt; 0)
{
    foreach (var c in password.ToCharArray()) secpw.AppendChar(c);
}
secpw.MakeReadOnly();
            
string dbConn = $"Data Source={server};Initial Catalog={db};";

SqlCredential cred = new SqlCredential(uid, secpw);
using (SqlConnection conn = new SqlConnection(dbConn, cred))
{                
    try
    {
        conn.Open();
        SqlCommand cmd = new SqlCommand("cb_ReadCurrentUserDisplayData", conn);
        cmd.CommandType = CommandType.StoredProcedure;
        cmd.Parameters.Add("userID", SqlDbType.Int).Value = intUserID;
        cmd.CommandTimeout = cmdTimeout;
        var returnData = cmd.ExecuteReader();
        var dtData = new DataTable();
        dtData.Load(returnData);
        if (dtData.Rows.Count != 0)
        Console.WriteLine(dtData.Rows[0]["Displayname"]);

    }
    catch (Exception ex)
    {
        Console.WriteLine(ex.Message);
    }
}
Console.ReadLine();</pre></div></li><li class="listitem">Run your<a class="indexterm" id="id993"/> console application and you will see the display name output to the screen:<div><img alt="How to do it…" src="img/B05391_12_28.jpg"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec208"/>How it works…</h2></div></div></div><p>By creating a parameterized SQL query, the compiler correctly substitutes the arguments before running the <a class="indexterm" id="id994"/>SQL statement against the database. It will prevent malicious data changing your SQL statement in order to exact a malicious result. This is because the <code class="literal">SqlCommand</code> object does not directly insert the parameter values into the statement.</p><p>To sum it all up, using parameterized stored procedures means no more Little Bobby Tables.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec87"/>Using Diagnostic Tools and Historical Debugging</h1></div></div></div><p>The trusty old bug has<a class="indexterm" id="id995"/> been the bane of software developers and engineers for more than 140 years. Yes, you read that right. It was in fact Thomas Edison that coined the term "bug" in the late 1870s. It appeared in many of his notebook entries where he <a class="indexterm" id="id996"/>describes for example that the incandescent lightbulb still had many "bugs left."</p><p>His efforts to debug his inventions are quite legendary. Consider the true grit and determination it took for a man already in his mid-sixties to work 112-hour working weeks. He and his seven-person team (it is a common misconception that there were only six because the seventh member didn't appear in the group photograph) became known as the insomnia squad during a 5-week stint that resulted in very little sleep.</p><p>These days, thanks to<a class="indexterm" id="id997"/> advances in technology, software developers have a vast array of debugging tools (inside and outside of Visual Studio) at their disposal. So does debugging really matter? Of course it does. It is part of what we as software developers do. If we don't debug, well, here are some examples:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In 2004, the <strong>Electronic Data Systems</strong> (<strong>EDS</strong>) Child Support System in the UK overpaid almost <a class="indexterm" id="id998"/>2 million people, underpaying almost a million and resulted in billions of dollars in uncollected child support payments. The incompatibility between EDS and another system it relied on resulted in taxpayers losing money and negatively affecting the lives of so many single parents.</li><li class="listitem" style="list-style-type: disc">The initial release of Apple Maps in 2012. Enough said. While bemusing for many, I still find myself using Google Maps for turn-by-turn directions when in an unfamiliar city or area.</li><li class="listitem" style="list-style-type: disc">The Therac-25 radiation therapy machine used electrons to target tumors in patients. Unfortunately, a race condition in the software caused the machine to deliver lethal overdoses of radiation in several patients.</li></ul></div><p>Examples <a class="indexterm" id="id999"/>of software bugs affecting the lives of millions of people can be found all over the Internet. We're not simply talking about the run-of-the-mill bugs either. Sometimes we're faced with seemingly insurmountable issues. It is the comfort of knowing how to use some of the tools available that makes the difference between a stable application and one that is totally unusable.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec209"/>Getting ready</h2></div></div></div><p>As of writing this, IntelliTrace is only available in Visual Studio 2015 Enterprise. IntelliTrace is, however, not a new feature in Visual Studio. It has evolved over time, since Visual Studio 2010, into what we have available today.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec210"/>How to do it…</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">First off, go to <strong>Tools</strong> | <strong>Options</strong>:<div><img alt="How to do it…" src="img/B05391_12_34.jpg"/></div></li><li class="listitem">Expand the<a class="indexterm" id="id1000"/> <strong>IntelliTrace</strong> node and click on <strong>General</strong>. Ensure that <a class="indexterm" id="id1001"/><strong>Enable IntalliTrace</strong> is checked. Also, make sure that the <strong>IntelliTrace events and call information</strong> option is selected. Click on <strong>OK</strong>:<div><img alt="How to do it…" src="img/B05391_12_35.jpg"/></div></li><li class="listitem">In the <code class="literal">Recipes.cs</code> file, you might need to add the following <code class="literal">using</code> statements:<div><pre class="programlisting">using System.Diagnostics;
using System.Reflection;
using System.IO;</pre></div></li><li class="listitem">Add a method <a class="indexterm" id="id1002"/>called <code class="literal">ErrorInception()</code> to the <code class="literal">Recipes</code> class. Also, add<a class="indexterm" id="id1003"/> the code to read the base path and assume that there is a folder called <code class="literal">log</code>. Do not create this folder on your hard drive. We want an exception to be thrown. Lastly, add another method called <code class="literal">LogException()</code> that does nothing:<div><pre class="programlisting">public static void ErrorInception()
{
    string basepath = Path.GetDirectoryName (Assembly.GetEntryAssembly().Location);
    var full = Path.Combine(basepath, "log");
}

private static void LogException(string message)
{

}</pre></div></li><li class="listitem">Add the following code to your <code class="literal">ErrorInception()</code> method after the full path has been determined. Here we are trying to open the log file. This is where the exception will occur:<div><pre class="programlisting">try
{
    for (int i = 0; i &lt;= 3; i++)
    {
        // do work
        File.Open($"{full}\\log.txt", FileMode.Append);
    }
}
catch (Exception ex)
{
    StackTrace st = new StackTrace();
    StackFrame sf = st.GetFrame(0);
    MethodBase currentMethodName = sf.GetMethod();
    ex.Data.Add("Date", DateTime.Now);
    LogException(ex.Message);
}</pre></div></li><li class="listitem">When you have<a class="indexterm" id="id1004"/> added all your code, your code should look like<a class="indexterm" id="id1005"/> this:<div><pre class="programlisting">public static void ErrorInception()
{
    string basepath = Path.GetDirectoryName(Assembly.GetEntryAssembly().Location);
    var full = Path.Combine(basepath, "log");

    try
    {
        for (int i = 0; i &lt;= 3; i++)
        {
            // do work
            File.Open($"{full}\\log.txt", FileMode.Append);
        }
    }
    catch (Exception ex)
    {
        StackTrace st = new StackTrace();
        StackFrame sf = st.GetFrame(0);
        MethodBase currentMethodName = sf.GetMethod();
        ex.Data.Add("Date", DateTime.Now);
        LogException(ex.Message);
    }
}

private static void LogException(string message)
{

}</pre></div></li><li class="listitem">In the <code class="literal">Program.cs</code> file, call the <code class="literal">ErrorInception()</code> method. Right after that, do a <code class="literal">Console.ReadLine()</code> so that our console application will pause there. Do not add any breakpoints anywhere to your code:<div><pre class="programlisting">ErrorInception();
Console.ReadLine();</pre></div></li><li class="listitem">Start debugging your application. The exception is thrown and the application <a class="indexterm" id="id1006"/>continues running, a condition often experienced with much more complex applications. At this point, you would expect a log file to be appended with the fictitious data of the app, but nothing happened. It is at this <a class="indexterm" id="id1007"/>point that you stop your application and start adding breakpoints all over your code in a hit and miss-type exercise. I say hit and miss because you probably will not know exactly where the error is. This is especially true if your code file contains a few thousand lines of code.<p>Well now, with IntelliTrace and Historical Debugging, you just need to click on the <strong>Break All</strong> button:</p><div><img alt="How to do it…" src="img/B05391_12_41.jpg"/></div></li><li class="listitem">Your application is now essentially paused. If you don't see the <strong>Diagnostic Tools</strong> window, go to <strong>Debug</strong> and click on <strong>Show Diagnostic Tools</strong> (or <em>Ctrl</em> + <em>Alt</em> + <em>F2</em>):<div><img alt="How to do it…" src="img/B05391_12_40.jpg"/></div></li><li class="listitem">Visual Studio <a class="indexterm" id="id1008"/>now displays the <strong>Diagnostic Tools</strong> window. Immediately <a class="indexterm" id="id1009"/>you can see that there is a problem indicated by the red diamond icon on the <strong>Events</strong> section. In the <strong>Events</strong> tab at the bottom, you can click on the exception:<div><img alt="How to do it…" src="img/B05391_12_42.jpg"/></div></li><li class="listitem">Doing this <a class="indexterm" id="id1010"/>expands the exception details, where you can see that the<a class="indexterm" id="id1011"/> log file was not found. Visual Studio, however, goes one step further with Historical Debugging:<div><img alt="How to do it…" src="img/B05391_12_43.jpg"/></div></li><li class="listitem">You will see <a class="indexterm" id="id1012"/>a link at the bottom of the exception details that says <strong>Activate Historical Debugging</strong>. Click on this link. This allows you to see the actual line of code that caused this exception in the code editor. It also allows you to view the history of the application's state in the <strong>Locals</strong> window, call stack, and other windows. You now can see the specific line of<a class="indexterm" id="id1013"/> code that caused the exception in your code editor. In the <strong>Locals</strong> window, you can also see what the path was that the application used to look for the log file. This kind of debugging experience is immensely powerful and allows developers to go straight to the source of the error. This leads to increased productivity and better code:<div><img alt="How to do it…" src="img/B05391_12_44.jpg"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec211"/>How it works…</h2></div></div></div><p>So what is the<a class="indexterm" id="id1014"/> takeaway here? If you only remember one thing, remember this. Once the users of your system lose faith in the abilities and potential of that system due<a class="indexterm" id="id1015"/> to bugs, that confidence is almost impossible to regain. Even if you resurrect your system from the ashes, after it was laid low by bugs and other issues, to produce a flawless product, your users will not be easily swayed. This is because in their mind, the system is buggy.</p><p>I once had to take over a system partially developed by a senior developer who was leaving the company. She had an excellent specification and a well presented prototype shown to the customer. The only problem was that she left the company shortly after the system's phase one was implemented. When the bugs came popping up, the client naturally asked for her assistance.</p><p>Telling the client that the developer (who has been solely responsible for building a relationship with the client) has left the company did not bode well to instil a sense of confidence. Having a single developer involved was the first mistake of this particular project anyway.</p><p>Secondly, phase<a class="indexterm" id="id1016"/> two was about to be developed by yours truly, who was also the only developer assigned to this client. This had to be done while building on top of the buggy phase one. So I was fixing bugs while developing new features for the system. Luckily<a class="indexterm" id="id1017"/> this time round, I had a fantastic project manager called Rory Shelton as my wingman. Together we were dumped in the deep end and Rory did a fantastic job managing the client's expectations while being totally transparent with the client regarding the challenges we were facing.</p><p>The users were unfortunately already disillusioned with the provided system and didn't trust the software. This trust was never fully regained. If we had IntelliTrace and Historical Debugging back in 2007, I definitely would have been able to track down the issues in a code base that was unfamiliar to me.</p><p>Always debug your software. When you find no more bugs, debug it again. Then give the system to my mom (love you mom). You as the developer of that system know which buttons to click and what data to enter, and in which order things need to happen. My mom doesn't and I can assure you that a user unfamiliar with a system can break it quicker than you can brew a fresh cup of coffee.</p><p>Visual Studio provides developers with a very powerful and feature rich set of debugging tools. Use them.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec88"/>Setting conditional breakpoints</h1></div></div></div><p>Conditional breakpoints are <a class="indexterm" id="id1018"/>another hidden gem when it comes to debugging. These allow you to specify one or several conditions. When one of these conditions<a class="indexterm" id="id1019"/> are met, the code will stop at the breakpoint. Using conditional breakpoints is really easy.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec212"/>Getting ready</h2></div></div></div><p>There is nothing you specifically need to prepare to use this recipe.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec213"/>How to do it…</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Add the following code to your <code class="literal">Program.cs</code> file. We are simply creating a list of integers and looping through that list:<div><pre class="programlisting">List&lt;int&gt; myList = new List&lt;int&gt;() { 1, 4, 6, 9, 11 };
foreach(int num in myList)
{
    Console.WriteLine(num);
}
Console.ReadLine();</pre></div></li><li class="listitem">Next, place a<a class="indexterm" id="id1020"/> breakpoint on the <code class="literal">Console.WriteLine(num)</code> line of code inside the loop:<div><img alt="How to do it…" src="img/B05391_12_45.jpg"/></div></li><li class="listitem">Right-click on the breakpoint and select <strong>Conditions…</strong> from the context menu:<div><img alt="How to do it…" src="img/B05391_12_46.jpg"/></div></li><li class="listitem">You will now see that Visual Studio opens a <strong>Breakpoint Settings</strong> window. Here we specify that the breakpoint needs to be hit only when the value of <code class="literal">num</code> is <code class="literal">9</code>. You can add several conditions and specify different conditions. The condition logic is really flexible:<div><img alt="How to do it…" src="img/B05391_12_47.jpg"/></div></li><li class="listitem">Debug your<a class="indexterm" id="id1021"/> console application. You will see that when the breakpoint is hit, the value of <code class="literal">num</code> is <code class="literal">9</code>:<div><img alt="How to do it…" src="img/B05391_12_48.jpg"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec214"/>How it works…</h2></div></div></div><p>The condition is<a class="indexterm" id="id1022"/> evaluated on every loop. When the condition is true, the breakpoint will be hit. In the example illustrated in this recipe, the true benefit of a conditional breakpoint is somewhat lost because it is a very small list. Consider this though. You are binding a data grid. Items on the grid are given specific icons based on the status of the item. Your grid contains hundreds of items, because this is a hierarchical grid. You identify the primary ID of the item which is bound to the grid. This primary ID is then passed to other code logic to determine the status, which determines the icon displayed.</p><p>To debug and press the <em>F10</em> key through hundreds of loops is not productive in any event. With conditional breakpoints, you can specify a value for the primary ID, and only break when the loop hits that value. You can then go straight to the item that is being displayed incorrectly.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec89"/>Using PerfTips to identify bottlenecks in code</h1></div></div></div><p>PerfTips are definitely<a class="indexterm" id="id1023"/> one of my favorite features of Visual<a class="indexterm" id="id1024"/> Studio 2015. Explaining what they do doesn't do them justice. You have to see them in action.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec215"/>Getting ready</h2></div></div></div><p>Do not confuse PerfTips with CodeLens. PerfTips is a separate option from CodeLens in Visual Studio.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec216"/>How to do it…</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">PerfTips are enabled by default. But just in case you are not seeing any PerfTips, go to <strong>Tools</strong> | <strong>Options</strong>, and expand the <strong>Debugging</strong> node. Under <strong>General</strong>, to the bottom of the settings page, you will see an option called <strong>Show elapsed time PerfTip while debugging</strong>. Ensure that this option is checked:<div><img alt="How to do it…" src="img/B05391_12_36.jpg"/></div></li><li class="listitem">We will <a class="indexterm" id="id1025"/>create a few simple methods that<a class="indexterm" id="id1026"/> mimic long-running tasks. To do this, we will just sleep the thread for a couple of seconds. In the <code class="literal">Recipes.cs</code> file, add the following code:<div><pre class="programlisting">public static void RunFastTask()
{
    RunLongerTask();
}

private static void RunLongerTask()
{
    Thread.Sleep(3000);
    BottleNeck();
}

private static void BottleNeck()
{
    Thread.Sleep(8000);
}</pre></div></li><li class="listitem">In your console application, call the static method <code class="literal">RunFastTask()</code> and place a breakpoint on this line of code:<div><pre class="programlisting">RunFastTask();
Thread.Sleep(1000);</pre></div></li><li class="listitem">Start<a class="indexterm" id="id1027"/> debugging your console application. Your breakpoint will stop on the <code class="literal">RunFastTask()</code> method. Hit <em>F10</em> to step over this method:<div><img alt="How to do it…" src="img/B05391_12_37.jpg"/></div></li><li class="listitem">You will notice that 11 seconds later, the next line will be highlighted and the PerfTip will be <a class="indexterm" id="id1028"/>displayed. The PerfTip displays the time it took for the previous line of code to execute. So the debugger that now sits on the <code class="literal">Thread.Sleep</code>, shows that the <code class="literal">RunFastTask()</code> method took 11 seconds to complete. The task is clearly not very fast:<div><img alt="How to do it…" src="img/B05391_12_38.jpg"/></div></li><li class="listitem">Stepping in to the <code class="literal">RunFastTask()</code> method, you can place further breakpoints and step over them one by one to find the method that is causing the longest delay. As you can see, PerfTips allow developers to quickly and easily identify bottlenecks in code:<div><img alt="How to do it…" src="img/B05391_12_39.jpg"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec217"/>How it works…</h2></div></div></div><p>There are many tools<a class="indexterm" id="id1029"/> on the market that do this and much <a class="indexterm" id="id1030"/>more, allowing developers to view all sorts of code metrics. PerfTips, however, allow you to see issues on the fly while you are stepping through your code as per your normal debugging tasks. It is, in my opinion, an indispensable debugging tool.</p></div></div></body></html>