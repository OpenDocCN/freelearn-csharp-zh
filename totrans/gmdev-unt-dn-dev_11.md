# *第8章*：Unity中的可脚本化渲染管线

在[*第7章*](B17146_07_Final_ASB_ePub.xhtml#_idTextAnchor121)“理解Unity中计算机图形学的数学”，我们学习了在计算机图形学中使用的数学知识。这些知识是通用的计算机图形学知识，所有3D软件和游戏引擎都使用这些数学概念。对于游戏引擎来说，渲染是其最重要的功能之一。在本章中，我们将具体探讨Unity提供的渲染功能。

本章将探讨以下关键主题：

+   可脚本化渲染管线的介绍

+   与Unity的通用渲染管线一起工作

+   通用渲染管线着色器和材质

+   提高通用渲染管线的性能

到本章结束时，你将了解**可脚本化渲染管线**是什么，以及如何在你的项目中启用基于可脚本化渲染管线的**通用渲染管线**和**高清晰度渲染管线**。你还将知道如何使用**通用渲染管线资产**来配置你的渲染管线，以及如何使用**体积框架**将后处理效果应用到你的游戏中。你还将了解如何创建可以在通用渲染管线中使用的自定义着色器和材质，如何使用Unity的**帧调试器**工具查看渲染过程的信息，以及如何使用**SRP批处理器**减少你项目中的绘制调用次数。

听起来很令人兴奋！现在，让我们开始吧！

# 可脚本化渲染管线的介绍

自2004年首次发布以来，Unity游戏引擎已发展成为世界上使用最广泛的实时内容创作平台。大量游戏都是使用Unity游戏引擎开发的。同时，Unity正在迅速应用于传统产业的 内容设计和生产过程，包括VR、AR和MR模拟应用、建筑设计展示、汽车设计和制造，甚至电影和电视动画制作。基于计算机图形学的实时渲染技术的发展是Unity引擎快速增长和广泛应用的重要原因。

在Unity 2018版本之前，开发者只能使用Unity提供的**内置渲染管线**。由于Unity引擎本身是一个封闭源代码引擎，Unity中的内置渲染管线对开发者来说就像一个黑盒，开发者无法了解Unity引擎内部渲染的具体逻辑实现。此外，使用Unity内置渲染管线开发的游戏将在不同平台上使用相同的渲染逻辑。对于开发者来说，为不同平台定制渲染管线非常困难。

随着可脚本渲染管线的发布，开发者可以直接在GitHub上查看其代码，并使用C#代码控制渲染过程，为他们的游戏或应用程序定制独特的渲染管线。

注意

你可以在GitHub上找到可脚本渲染管线的代码：[https://github.com/Unity-Technologies/Graphics](https://github.com/Unity-Technologies/Graphics)。

可脚本渲染管线是Unity为开发者提供的一个工具箱，通过它开发者可以在Unity中自由实现特定的渲染功能。为了方便开发者，基于可脚本渲染管线提供了两个预构建的渲染管线，即通用渲染管线和高清渲染管线。

通过使用基于可脚本渲染管线的预构建渲染管线，我们可以直接修改渲染管线中的特定功能，而无需从头开始实现一个新的管线，同时获得优秀的渲染效果和持续更新。因此，当使用Unity开发游戏时，有三个现成的渲染管线可供选择：

+   传统的内置渲染管线

+   通用渲染管线

+   高清渲染管线

当然，你也可以选择基于可脚本渲染管线开发自己的渲染管线。

以下是一些使用通用渲染管线或高清渲染管线在GitHub上制作的开源项目，你可以下载并使用。

## Fontainebleau 示例

第一个项目是使用高清渲染管线制作的**Fontainebleau 示例**项目：

![图 8.1 – Fontainebleau 示例

](img/Figure_8.01_B17146.jpg)

图 8.1 – Fontainebleau 示例

如图 8.1 所示，这个项目允许你以第一人称模式在森林中行走。你可以在这里找到项目：[https://github.com/Unity-Technologies/FontainebleauDemo](https://github.com/Unity-Technologies/FontainebleauDemo)。

## Spaceship 示例

我要介绍的第二个项目是**Spaceship 示例**项目。这是一个可玩的高质量AAA第一人称模式演示，如图 8.2 所示：

![图 8.2 – Spaceship 示例

](img/Figure_8.02_B17146.jpg)

图 8.2 – Spaceship 示例

在这个开源项目中，你可以看到如何实现GPU加速的粒子效果，例如逼真的火焰、烟雾和电火花视觉效果。你可以在这里找到项目：[https://github.com/Unity-Technologies/SpaceshipDemo](https://github.com/Unity-Technologies/SpaceshipDemo)。

## BoatAttack 示例

如果你选择将通用渲染管线作为你游戏的渲染管线，那么这个开源项目值得一看：

![图 8.3 – BoatAttack 示例

](img/Figure_8.03_B17146.jpg)

图 8.3 – BoatAttack 示例

如*图8.3*所示，这是一款使用通用渲染管线制作的赛船游戏。您可以在以下链接找到该项目：[https://github.com/Unity-Technologies/BoatAttack](https://github.com/Unity-Technologies/BoatAttack)。

除了GitHub上的开源项目外，Unity还为开发者提供了Unity的**资产商店**上的免费资源，供开发者学习和使用。

这里有一些样本。

## 异教徒：数字人

我首先想分享的是资产商店上的**异教徒：数字人**项目：

![图8.4 – 资产商店中的异教徒：数字人

](img/Figure_8.04_B17146.jpg)

图8.4 – 异教徒：资产商店中的数字人

如*图8.4*所示，这是一个免费项目，展示了如何制作具有真实皮肤、眼睛、眉毛等的数字人。您可以在以下链接找到该项目：[https://assetstore.unity.com/packages/essentials/tutorial-projects/the-heretic-digital-human-168620](https://assetstore.unity.com/packages/essentials/tutorial-projects/the-heretic-digital-human-168620)。

## 异教徒：VFX角色

第二个项目也来自资产商店上的**异教徒**，并且可以免费下载：

![图8.5 – 异教徒：VFX角色

](img/Figure_8.05_B17146.jpg)

图8.5 – 异教徒：VFX角色

如*图8.5*所示，该项目展示了如何在Unity中使用高清渲染管线创建基于VFX的角色。您可以在以下链接找到该项目：[https://assetstore.unity.com/packages/essentials/tutorial-projects/the-heretic-vfx-character-168622](https://assetstore.unity.com/packages/essentials/tutorial-projects/the-heretic-vfx-character-168622)。

好吧，在介绍了许多基于Scriptable Render Pipeline的开源免费项目之后，您现在对这种渲染管线更感兴趣了吗？如果是这样，那么我们将简要介绍基于Scriptable Render Pipeline的两个预构建渲染管线，即通用渲染管线和高清渲染管线。

## 通用渲染管线

通用渲染管线是Unity中基于Scriptable Render Pipeline的预构建渲染管线。正如其名称所暗示的，这个渲染管线可以在Unity支持的所有平台上使用。不同的管线不能混合，所以一旦您选择使用通用渲染管线，内置渲染管线和高清渲染管线将不会启用。

Unity默认使用传统的内置渲染管线，但您可以在项目中以不同的方式启用通用渲染管线。

如果您想开发一个新项目，那么您可以使用**Unity Hub**提供的**3D示例场景（URP）**项目模板来创建一个新的通用渲染管线项目：

![图8.6 – 3D示例场景（URP）项目模板

](img/Figure_8.06_B17146.jpg)

图8.6 – 3D示例场景（URP）项目模板

如*图8.6*所示，**3D示例场景（URP）**项目模板配置了项目设置以在项目中使用通用渲染管线：

![图8.7 – 新的URP项目

![图片](img/Figure_8.07_B17146.jpg)

图8.7 – 新的URP项目

在新项目创建完成后，您可以看到使用通用渲染管线渲染的示例场景，如图8.7所示。

然而，如果您想将现有项目从内置渲染管线切换到通用渲染管线，使用通用渲染管线重新创建一个新项目并不适合您的项目。在这种情况下，选择使用Unity的包管理器安装通用渲染管线是一个更合适的选择：

![图8.8 – 打开包管理器窗口

![图片](img/Figure_8.08_B17146.jpg)

图8.8 – 打开包管理器窗口

可以通过在Unity编辑器的工具栏中点击**窗口** | **包管理器**来打开包管理器窗口，如图中所示：

![图8.9 – 包管理器

![图片](img/Figure_8.09_B17146.jpg)

图8.9 – 包管理器

如*图8.9*所示，您可以在包列表中找到**通用RP**包并将其安装到您的项目中。

在本节中，我们简要介绍了通用渲染管线及其在项目中的安装方法。更详细的介绍将在*使用Unity的通用渲染管线*部分进行。接下来，让我们继续简要探索高清渲染管线及其在项目中的安装方法。

## 高清渲染管线

高清渲染管线是基于Unity中的可脚本渲染管线构建的另一个预构建渲染管线。与通用渲染管线不同，它不支持Unity支持的所有平台，仅支持高端平台。以下表格显示了高清渲染管线支持的平台：

![图8.10](img/Figure_8.10_B17146.jpg)

图8.10 – 高清渲染管线支持的平台

如前表所示，高清渲染管线目前主要用于如游戏机或桌面电脑等平台。如果您正在开发面向移动设备的项目，那么高清渲染管线不是一个合适的选择。

由于我们希望涵盖尽可能多的使用场景，本章将主要关注通用渲染管线的使用——因此对高清渲染管线的简要介绍。然而，如果您想尝试它或确实需要使用高清渲染管线，安装过程与之前描述的安装通用渲染管线非常相似。

首先，如果您正在启动一个新项目，您可以使用Unity Hub提供的**3D示例场景（HDRP）**项目模板来创建一个新的高清渲染管线项目。

如 *图 8.11* 所示，**3D 示例场景 (HDRP**) 项目模板配置了项目设置以在项目中使用高清渲染管道：

![图 8.11 – 3D 示例场景 (HDRP) 模板

![图片](img/Figure_8.11_B17146.jpg)

图 8.11 – 3D 示例场景 (HDRP) 模板

在等待新项目创建完成后，你可以查看使用高清渲染管道渲染的示例场景，如图 *图 8.12* 所示：

![图 8.12 – 新的 HDRP 项目

![图片](img/Figure_8.12_B17146.jpg)

图 8.12 – 新的 HDRP 项目

当然，你还可以从 Unity 的包管理器中安装 **高清渲染管道** 包：

![图 8.13 – 通过包管理器安装高清渲染管道

![图片](img/Figure_8.13_B17146.jpg)

图 8.13 – 通过包管理器安装高清渲染管道

如 *图 8.13* 所示，你可以在包列表中找到 **高清渲染管道** 包并将其安装到你的项目中。

在本节中，我们简要介绍了高清渲染管道以及如何在你的项目中安装它。

通过阅读本节，*脚本渲染管道简介*，你现在应该已经了解了脚本渲染管道是什么以及如何在你的项目中安装基于脚本渲染管道的通用渲染管道和高清渲染管道。接下来，我们将详细讨论如何在你的项目中正确使用通用渲染管道。

让我们开始吧！

# 使用 Unity 的通用渲染管道

通用渲染管道被 Unity 开发者广泛使用。它不仅用于开发 PC 或游戏机游戏；你还可以用它来开发移动游戏。

我们可以通过 Unity Hub 项目模板创建一个新的通用渲染管道项目。通过项目模板，Unity 将自动为我们设置所有渲染管道资源。该项目还包含一个示例场景，如图 *图 8.14* 所示。你可以在该场景中找到一个摄像机、一个方向光、一个聚光灯、一个后处理体积、反射探针和一些模型：

![图 8.14 – 通用渲染管道的示例场景

![图片](img/Figure_8.14_B17146.jpg)

图 8.14 – 通用渲染管道的示例场景

首先，这个示例场景是一个很好的起点。我们将用它来解释如何使用通用渲染管道。

## 探索示例场景

让我们先探索这个示例场景。如图 *图 8.14* 所示，这个场景并不复杂，但它包含了通用渲染管道的大部分功能。我们将分别介绍场景中的这些组件。

### 主摄像机

让我们从场景中的主摄像机开始。我们可以在 **层次结构** 窗口中选择 **Main Camera** 以打开其 **检查器** 窗口，如图下所示：

![图 8.15 – 主摄像机对象

![图片](img/Figure_8.15_B17146.jpg)

图 8.15 – 主摄像机对象

**Main Camera**对象上附加了一个**Camera**组件，它提供了与相机对象相关的所有功能。你可以设置背景、剔除遮罩、抗锯齿设置、相机的透视设置等。

你还需要注意的一个组件是**通用附加相机数据**组件，你可以在图8.15的底部找到它。如果你使用的是通用渲染管线，Unity不允许你从相机中移除它，因为这个组件用于内部存储数据。

### 方向光

在这个示例项目中只有一个方向光，用于模拟阳光。你可以通过修改场景中光对象上附加的**Light**组件的设置来修改光的颜色、强度和阴影效果。你还可以修改光对象的**Transform**组件的旋转属性来调整方向光的指向，如图8.16所示。

![图8.16 – 方向光对象

](img/Figure_8.16_B17146.jpg)

图8.16 – 方向光对象

在这个示例中，这个光的强度值为**2**，并且使用了柔和的阴影。

### 聚光灯

Unity中有四种类型的灯光，分别是**方向光**、**点光**、**聚光灯**和**区域光**。在这个示例场景中，除了用于模拟阳光的方向光外，还有一个聚光灯用于模拟聚光灯：

![图8.17 – 聚光灯对象

](img/Figure_8.17_B17146.jpg)

图8.17 – 聚光灯对象

如前图所示，Unity中聚光灯对象的效果类似于现实世界中的聚光灯。聚光灯的设置与Unity中方向光的设置类似：

![图8.18 – 聚光灯设置

](img/Figure_8.18_B17146.jpg)

图8.18 – 聚光灯设置

你仍然可以通过修改**Spot Light**对象上附加的**Light**组件的设置来修改聚光灯的颜色、强度和阴影效果，并且你也可以修改这个聚光灯的范围和内/外聚光角度，如图8.18所示。

### 后处理体积

现在，让我们来看看示例场景中的后处理体积对象。在游戏开发中，后处理是一种常用于向渲染图像添加各种效果的技巧，常见的效果如色调映射、景深、光晕、抗锯齿和运动模糊：

![图8.19 – 后处理体积

](img/Figure_8.19_B17146.jpg)

图8.19 – 后处理体积

通用渲染管道提供了**体积**组件和**体积配置文件**对象来管理应用于渲染图像的不同后期处理效果，如图*图8.19*所示。使用**体积**组件的一个优点是组件和特定设置可以解耦。**体积**组件上的所有设置都来自相关的**体积配置文件**对象。我们将在稍后详细讨论**体积配置文件**对象。

在这个示例场景中，应用了**色调映射**、**光晕**和**晕影**效果。如果你对未经后期处理的原始渲染图像感兴趣，让我们看看当我们禁用这个后期处理体积时会发生什么：

![图8.20 – 原始图像（顶部）与后期处理图像（底部）

](img/Figure_8.20_B17146.jpg)

图8.20 – 原始图像（顶部）与后期处理图像（底部）

*图8.20*显示了示例场景的原始图像和后期处理图像的比较。

### 反射探头

**反射探头**可以通过对其周围场景进行采样，为场景中相关的模型提供高效的反射信息，从而使场景中模型的表面具有逼真的反射效果：

![图8.21 – 场景中的反射探头

](img/Figure_8.21_B17146.jpg)

图8.21 – 场景中的反射探头

在这个示例场景中，我们可以看到有三个反射探头作为名为**Reflection Probes**的GameObject的子对象，如图所示。

如果我们选择这些反射探头中的一个，那么相应的反射探头将在场景视图中显示，并显示反射信息，如图*图8.22*所示：

![图8.22 – 查看场景中的反射信息

](img/Figure_8.22_B17146.jpg)

图8.22 – 查看场景中的反射信息

由于不同位置的反射探头会获得不同的反射信息，为了正确使用反射信息，它们需要放置在适当的位置。虽然“适当的位置”的定义因场景而异，但一个一般的指导原则是，你应该将反射探头放置在场景中任何将被显著反射的大物体附近。例如，将反射探头放置在场景中墙壁中心和角落的周围。当然，这并不意味着可以忽略场景中的所有小物体。例如，与墙壁相比，场景中的篝火可能是一个小物体，但反射篝火的光线对于创建场景的真实渲染同样重要。

## 通用渲染管道资产

由于这个新的示例项目是使用通用渲染管道模板创建的，Unity 已经自动为我们设置好了一切，以便使通用渲染管道正常工作。然而，如果你的项目正在使用内置渲染管道进行开发，并且你想切换到使用通用渲染管道，或者如果你的项目已经使用通用渲染管道开发，但你想使用另一个渲染管道，那么了解如何在 Unity 中设置它是非常必要的。

注意

在本章中，我们正在使用通用渲染管道中的 **前向渲染路径**。所谓的 **渲染路径** 指的是与光照和着色相关的一系列操作。Unity 的内置渲染管道提供了不同的渲染路径，例如前向渲染路径和 **延迟渲染路径**。从通用渲染管道的 12.0.0 版本开始，开发者也可以在管道中使用延迟渲染路径，但这超出了本章的范围。如果你对这个主题感兴趣，你可以在 [https://docs.unity3d.com/Packages/com.unity.render-pipelines.universal@12.0/manual/rendering/deferred-rendering-path.html](mailto:https://docs.unity3d.com/Packages/com.unity.render-pipelines.universal@12.0/manual/rendering/deferred-rendering-path.html) 和 [https://docs.unity3d.com/Packages/com.unity.render-pipelines.universal@12.0/manual/urp-universal-renderer.html#rendering-path-comparison](mailto:https://docs.unity3d.com/Packages/com.unity.render-pipelines.universal@12.0/manual/urp-universal-renderer.html#rendering-path-comparison) 找到更多信息。

我们将引导你完成以下步骤，学习如何在 Unity 中为你的项目设置渲染管道：

1.  让我们从 **项目设置** 窗口开始。你可以在 Unity 编辑器的工具栏中通过 **编辑** | **项目设置** 打开这个窗口。

1.  接下来，点击左侧分类列表中的 **图形** 项以打开 **图形** 设置面板，如图 8.23 所示：

![图 8.23 – 图形设置

![图片](img/Figure_8.23_B17146.jpg)

图 8.23 – 图形设置

让我们详细看看 **可脚本渲染管道设置** 属性：

+   **图形** 设置的 **可脚本渲染管道设置** 属性与一个名为 **UniversalRP-HighQuality** 的 **通用渲染管道资产** 类型的对象相关联，该对象在项目使用模板创建时自动创建。

+   如果 **图形** 设置的 **可脚本渲染管道设置** 属性设置为无，那么 Unity 将使用默认的内置渲染管道。

1.  你可以在项目的 **Assets** > **Settings** 文件夹中找到这个 **通用渲染管道资产** 对象：

![图 8.24 – 通用渲染管道资产对象

![图片](img/Figure_8.24_B17146.jpg)

图 8.24 – 通用渲染管道资产对象

1.  然后，选择**UniversalRP-HighQuality**对象以打开**检查器**窗口，这样我们就可以检查该**通用渲染管线资产**对象的详细信息。如图*图 8.25*所示，一个**通用渲染管线资产**对象为当前的通用渲染管线提供各种设置，例如渲染功能和渲染质量：

![图 8.25 – 该通用渲染管线资产对象的检查器窗口

](img/Figure_8.25_B17146.jpg)

图 8.25 – 该通用渲染管线资产对象的检查器窗口

+   接下来，让我们逐一查看这些设置。我们可以在**通用**部分配置渲染管线的通用设置，如图*图 8.26*所示。例如，如果启用了**深度纹理**选项，你可以在着色器代码中访问渲染管线生成的深度图：

![图 8.26 – 通用设置

](img/Figure_8.26_B17146.jpg)

图 8.26 – 通用设置

注意

在游戏开发中，**深度纹理**用于表示从摄像机视角看 3D 空间中对象的深度信息。

+   我们还可以控制全局渲染质量：

![图 8.27 – 质量设置

](img/Figure_8.27_B17146.jpg)

图 8.27 – 质量设置

在*图 8.27*中，我们启用了全局**HDR**选项，全局**抗锯齿**设置为**2x**。我们还可以通过调整**渲染缩放**滑块来修改渲染分辨率。

+   作为实时渲染的一个重要因素，通用渲染管线的灯光也可以在**灯光**部分进行配置，如图*图 8.28*所示：

![图 8.28 – 灯光设置

](img/Figure_8.28_B17146.jpg)

图 8.28 – 灯光设置

设置面板中的主光源是游戏场景中最亮的方向性光源。你可以决定是否启用它以及是否允许它投射阴影。

+   在*图 8.29*中，你可以在**灯光**设置下找到**阴影**设置。你可以在此处修改参数以调整 Unity 中的阴影外观：

![图 8.29 – 阴影设置

](img/Figure_8.29_B17146.jpg)

图 8.29 – 阴影设置

+   最后，让我们探索**高级**设置：

![图 8.30 – 高级设置

](img/Figure_8.30_B17146.jpg)

图 8.30 – 高级设置

这里，我们可以检查**SRP 批处理器**选项以启用 SRP 批处理器功能，从而提高通用渲染管线的性能，我们将在*提高通用渲染管线性能*部分详细解释。我们还可以修改**调试**日志输出的级别，如图*图 8.30*所示。

注意

如果你的项目中没有通用渲染管线资产，你可以在 Unity 编辑器的工具栏中点击**资产** > **创建** > **渲染** > **通用渲染管线** > **管线资产**来创建一个新的：

在本节中，我们介绍了Unity中的通用渲染管线资产以及如何通过更改**图形**设置的**脚本渲染管线设置**属性在不同的渲染管线之间切换。接下来，我们将探讨通用渲染管线中的另一个重要资产，即体积配置文件。

## 体积框架和后处理

**体积**框架由脚本渲染管线为游戏开发者提供。通过使用此框架，开发者可以将组件与其特定设置解耦。基于脚本渲染管线的渲染管线，如通用渲染管线和高清渲染管线，使用此框架。

正如我们之前提到的，通用渲染管线使用**体积**组件和**体积配置文件**对象来管理应用于渲染图像的不同后处理效果。以下步骤演示了如何启用体积框架并应用一些后处理效果到示例项目中：

1.  首先，我们需要在场景中的GameObject上添加一个**体积**组件来启用体积框架，如图所示：

![Figure 8.31 – Adding a Volume component](Figure 8.31 – 添加体积组件)

![img/Figure_8.31_B17146.jpg](img/Figure_8.31_B17146.jpg)

图8.31 – 添加体积组件

1.  在*图8.31*中，该**体积**组件的**配置文件**属性为**0**，因此我们可以通过点击其下方的**新建**按钮创建一个新的**体积配置文件**，或者分配一个现有的**体积配置文件**给它。在这里，我们将创建一个新的**体积配置文件**：

![Figure 8.32 – Creating a new Volume Profile file](Figure 8.32 – 创建新的体积配置文件)

![img/Figure_8.32_B17146.jpg](img/Figure_8.32_B17146.jpg)

图8.32 – 创建新的体积配置文件

1.  点击**添加覆盖**按钮打开**体积覆盖**面板，然后点击**后处理**项打开**后处理**覆盖列表：

![Figure 8.33 – Add Override](Figure 8.33 – 添加覆盖)

![img/Figure_8.33_B17146.jpg](img/Figure_8.33_B17146.jpg)

图8.33 – 添加覆盖

1.  在*图8.34*中，您可以在**后处理**覆盖列表中看到许多后处理效果。您可以选择要应用于渲染图像的效果，例如**辉光**：

![Figure 8.34 – Post-processing effects](Figure 8.34 – 后处理效果)

![img/Figure_8.34_B17146.jpg](img/Figure_8.34_B17146.jpg)

图8.34 – 后处理效果

1.  最后，让我们修改**辉光**效果配置；检查**阈值**和**强度**选项，并将它们的值分别设置为**0.9**和**4**，如图所示：

![Figure 8.35 – Setting up the Bloom effect](Figure 8.35 – 设置辉光效果)

![img/Figure_8.35_B17146.jpg](img/Figure_8.35_B17146.jpg)

图8.35 – 设置辉光效果

完成前面的步骤后，切换到游戏视图。应用**辉光**效果后，我们可以在*图8.36*中看到游戏场景：

![Figure 8.36 – The applied Bloom effect image (top) versus the original image (bottom)](Figure 8.36 – 应用辉光效果后的图像（顶部）与原始图像（底部）对比)

![img/Figure_8.36_B17146.jpg](img/Figure_8.36_B17146.jpg)

图8.36 – 应用辉光效果后的图像（顶部）与原始图像（底部）对比

在本节中，我们首先通过探索模板中包含的示例场景来学习通用渲染管道的功能。然后，我们介绍了如何在不同的渲染管道和通用渲染管道资产之间切换。最后，我们演示了如何使用体积框架在通用渲染管道中实现后处理。我们旅程的下一站是探索对Unity中的渲染至关重要的着色器和材质。

# 通用渲染管道着色器和材质

**着色器**和**材质**对于在Unity中渲染模型至关重要。着色器用于提供算法来计算每个像素的颜色。材质为与其关联的着色器提供各种参数，以确定如何渲染模型，例如提供纹理作为着色器的输入并定义着色器如何采样纹理：

![图8.37 – 材质和着色器

](img/Figure_8.37_B17146.jpg)

图8.37 – 材质和着色器

如果我们在场景中选择一个模型，例如安全帽模型，材质设置将在**检查器**窗口中显示，如图*图8.37*所示。

## 常用着色器

每种材质都可以与指定的着色器相关联，并且该着色器所需的参数将在**检查器**窗口中显示。在使用通用渲染管道时，常用的着色器是**通用渲染管道/Lit**，并且这个安全帽模型也是使用这个着色器渲染的。通过调整各种参数，**通用渲染管道/Lit**着色器可以用于渲染不同的材质表面，如金属、玻璃和木材。

注意

命名为**Lit**的着色器意味着这个着色器将执行光照计算。命名为**Unlit**的着色器表示该着色器在计算像素颜色时不会考虑光照因素。

我们可以通过选择不同的着色器通过**着色器**下拉窗口来更改材质相关的着色器，如图*图8.38*所示：

![图8.38 – 着色器

](img/Figure_8.38_B17146.jpg)

图8.38 – 着色器

一旦我们确定了与材质关联的着色器，我们就可以通过这个材质提供各种特定着色器的参数：

![图8.39 – 着色器的参数

](img/Figure_8.39_B17146.jpg)

图8.39 – 着色器的参数

在*图8.39*中，开发者可以在**表面输入**部分为**通用渲染管道/Lit**着色器指定各种贴图。与这些贴图参数相关的纹理用于为着色器提供不同的信息。以下将详细解释：

+   **基础贴图**用于向着色器提供表面的基础颜色。

+   **金属贴图**用于向着色器提供金属工作流程信息，以确定表面“金属”程度。

+   **法线贴图**用于向模型表面添加原始模型上不存在的更多细节。

+   **遮挡贴图**用于向着色器提供信息，以模拟环境光照产生的阴影。

不同着色器所需的参数可能不同，由于着色器算法的不同，最终的渲染结果也有所不同：

另一方面，Unity还为开发者提供了一个功能，可以自动将现有材质升级到通用渲染管线材质。您可以在Unity编辑器工具栏中通过点击**编辑** > **渲染管线** > **通用渲染管线** > **将项目材质升级到通用RP材质**来找到它，如前图所示。

](img/Figure_8.43_B17146.jpg)

图 8.40 – 无光照着色器

因此，当将正在使用内置渲染管线开发的项目更改为使用通用渲染管线时，开发者经常会遇到一个称为“材质错误”的问题：

![图 8.41 – 安全帽模型

![图 8.41 – 安全帽模型

图 8.41 – 安全帽模型

使用此材料渲染的安全帽模型将只显示基本颜色，并且将不再受任何光照的影响。您可以在前面的屏幕截图中看到安全帽模型与周围模型之间的差异。

## ![图 8.40 – 无光照着色器

正如我们在本章开头提到的，如果您选择使用通用渲染管线，内置渲染管线将不再可用。这不仅包括内置渲染管线本身，还包括与内置渲染管线一起使用的着色器。

![图 8.40 – 无光照着色器

![图 8.42 – 内置标准着色器不能在通用渲染管线中使用

例如，如果我们将与此材质关联的着色器更改为**通用渲染管线/无光照**，那么在**表面输入**部分中只剩下**基础贴图**以提供表面的基础颜色：

图 8.42 – 内置标准着色器不能在通用渲染管线中使用

![图 8.42 – 无光照着色器

因此，如果您的项目正在使用内置渲染管线进行开发，但需要切换到使用通用渲染管线，那么为了确保通用渲染管线可以正确工作，您需要将现有的材质升级到通用渲染管线材质。

您可以手动修改与现有材质关联的着色器，例如将内置的**标准**着色器替换为**通用渲染管线/Lit**着色器：

![图 8.43 – 升级项目材质

例如，我们可以将渲染安全帽模型所使用的着色器从**通用渲染管线/无光照**更改为内置的**标准**着色器。然后，您可以看到安全帽模型显示为粉红色，这意味着材质中存在错误，如前图所示。

图 8.43 – 升级项目材质

升级项目材质到通用渲染管线材质

![图 8.44 – 材质升级器

](img/Figure_8.44_B17146.jpg)

图8.44 – 材质升级器

然后，将弹出**材质升级器**窗口。如图8.44所示，更改是不可逆的，因此如果你想要将项目中所有的材质升级到通用渲染管线材质，并且已经备份了项目，请点击**继续**按钮。

注意

这个**材质升级器**工具只能将内置着色器升级到通用渲染管线着色器，但不能升级开发者创建的自定义着色器。因此，自定义着色器仍然需要手动修改。

## 创建着色器和着色器图

有时，你可能想要创建一个新的着色器来实现一些可以与通用渲染管线一起使用的自定义功能。有两种方法可以实现这一点——你可以创建一个新的着色器文件或着色器图文件。

### 创建新的着色器文件

首先，即使我们的项目使用通用渲染管线，我们仍然可以使用传统的办法，在Unity内置的渲染管线中使用着色器模板来创建自定义着色器文件。如图8.45所示，我们可以点击**资产** > **创建** > **着色器**来创建一个新的着色器：

![图8.45 – 创建着色器文件

](img/Figure_8.45_B17146.jpg)

图8.45 – 创建着色器文件

列出了一些内置的着色器模板，例如`CustomShader`：

![图8.46 – 自定义着色器

](img/Figure_8.46_B17146.jpg)

图8.46 – 自定义着色器

然后，在我们的项目中创建了一个着色器文件，如图中所示。你可以通过双击它来在你的IDE中打开着色器源文件，然后你可以使用Unity的**ShaderLab语言**来编写着色器代码，该代码定义了Unity如何计算每个像素的渲染颜色。

注意

在Unity的ShaderLab语言中如何编写着色器超出了本章的范围，但如果你感兴趣，可以在[https://docs.unity.cn/Packages/com.unity.render-pipelines.universal@7.7/manual/writing-custom-shaders-urp.html](mailto:https://docs.unity.cn/Packages/com.unity.render-pipelines.universal@7.7/manual/writing-custom-shaders-urp.html)找到更多信息。

除了创建着色器文件，我们还可以创建一个新的自定义着色器图文件来渲染场景中的这些模型。让我们继续。

### 创建新的着色器图文件

与创建着色器文件的传统方法相比，创建一个新的**着色器图**文件更容易。着色器图功能首次在Unity 2018中引入。在开发着色器图文件时，你不需要编写着色器代码，而是直接使用可视化节点进行开发。

我们仍然可以创建一个新的无光照着色器，但这次，我们将使用着色器图而不是着色器文件，如下面的步骤所示：

1.  如图8.47所示，点击`CustomShaderGraph`：

![图8.47 – 创建新的着色器图文件

](img/Figure_8.47_B17146.jpg)

图8.47 – 创建新的着色器图文件

1.  创建了一个新的着色器图文件，其扩展名为`.shadergraph`，如图所示：

![图 8.48 – Shader 图文件

](img/Figure_8.48_B17146.jpg)

图 8.48 – Shader 图文件

1.  双击此文件，这次 Shader 图文件将不会在 IDE 中打开，而是在 Unity 编辑器中直接显示一个视觉节点编辑器，如图 *图 8.49* 所示：

![图 8.49 – Shader 图编辑器

](img/Figure_8.49_B17146.jpg)

图 8.49 – Shader 图编辑器

这个视觉节点编辑器有很多内容需要理解，所以让我们更详细地了解一下：

+   在 Unity 中，一个着色器通常由两部分组成，即**顶点**程序和**片段**程序。

+   **顶点**程序通常用于将模型的顶点在屏幕空间中的 3D 坐标转换为 2D 坐标。我们在上一章中已经介绍了坐标系的知识。在这个例子中，顶点程序中有三个节点，即**位置**、**法线**和**切线**。

+   或者，**片段**程序确定像素的颜色，在这个例子中，**片段**程序只有一个节点，名为**基础颜色**。

+   您还可以在右下角的**主预览**窗口中预览此着色器的结果，如图 *图 8.49* 所示。我们刚刚创建的着色器将用蓝色渲染像素。

现在我们已经创建了一个新的 Shader 图文件，并在 Shader 图编辑器中打开它，这允许我们编辑、添加和删除节点，接下来我们将看看如何在 Shader 图文件中编辑一个节点。让我们开始吧！

### 在 Shader 图中编辑节点的属性

我们可以在 Shader 图文件中编辑现有节点的属性。如我们之前提到的，有一个名为**基础颜色**的节点，所以让我们按照以下方式编辑此节点：

![图 8.50 – 编辑基础颜色节点

](img/Figure_8.50_B17146.jpg)

图 8.50 – 编辑基础颜色节点

1.  在 Shader 图编辑器中，选择**片段**部分中的**基础颜色**节点。

1.  点击此节点的颜色输入以打开颜色选择器窗口。

1.  在颜色选择器窗口中选择您想要使用的颜色 – 在这种情况下，我们为**基础颜色**节点选择了黄色。**主预览**窗口显示了着色器正在发生的情况，如图 *图 8.50* 所示。

如您所见，修改现有节点非常简单；除了修改节点外，我们还可以创建一个新的节点，为着色器提供更多数据。让我们继续。

### 在 Shader 图中添加新节点

开发着色器通常涉及采样纹理并返回一个颜色值供着色器使用。让我们执行以下步骤，向我们的示例着色器添加一个新节点，以添加采样纹理的能力：

1.  在 Shader 图编辑器中右键单击，并从弹出菜单中选择**创建节点**：

![图 8.51 – 创建节点

](img/Figure_8.51_B17146.jpg)

图 8.51 – 创建节点

1.  在**创建节点**窗口的右上角搜索栏中输入`texture`，然后在结果列表中选择**采样纹理 2D**项：

![图8.52 – 选择Sample Texture 2D节点

](img/Figure_8.52_B17146.jpg)

图8.52 – 选择Sample Texture 2D节点

1.  如*图8.53*所示，创建了一个新的**Sample Texture 2D**节点。点击此节点的**Texture**插槽以提供纹理资产：

![图8.53 – 点击节点的Texture插槽

](img/Figure_8.53_B17146.jpg)

图8.53 – 点击节点的Texture插槽

1.  从弹出的**选择纹理**窗口中选择一个纹理：

![图8.54 – 选择纹理

](img/Figure_8.54_B17146.jpg)

图8.54 – 选择纹理

1.  然后，如*图8.55*所示，**Sample Texture 2D**节点从其**Texture**输入采样纹理并获取纹理的颜色：

![图8.55 – 从纹理资产加载数据

](img/Figure_8.55_B17146.jpg)

图8.55 – 从纹理资产加载数据

现在，我们在Shader Graph文件中添加了一个新的节点，但从纹理采样得到的颜色仍然存储在**Sample Texture 2D**节点中。接下来，我们需要将其与**Fragment**部分的**Base Color**节点连接起来，以便着色器可以使用从该纹理获取的颜色渲染像素。

### 在Shader Graph中连接两个节点

我们可以通过在Shader Graph文件中连接两个节点，将数据（如颜色）从一个节点传递到另一个节点，因此让我们按照以下步骤将**Sample Texture 2D**节点与**Base Color**节点连接起来：

1.  如*图8.56*所示，点击**RGBA(4)**输出的旁边的单选按钮：

![图8.56 – 点击单选按钮

](img/Figure_8.56_B17146.jpg)

图8.56 – 点击单选按钮

1.  之后，将出现一条可以自由拖动的线：

![图8.57 – 出现一条线

](img/Figure_8.57_B17146.jpg)

图8.57 – 出现一条线

1.  将此线拖动到**Base Color**节点的颜色输入。如*图8.58*所示，我们连接了这两个节点，**主预览**窗口显示着色器已使用从纹理获取的颜色渲染了像素：

![图8.58 – 连接两个节点

](img/Figure_8.58_B17146.jpg)

图8.58 – 连接两个节点

现在您应该知道如何创建Shader Graph文件以及如何修改、添加和连接其中的节点。作为开发者，在使用Shader Graph时，我们不需要编写着色器代码，Unity将根据Shader Graph文件的内容自动生成着色器代码。

在本节中，我们介绍了与通用渲染管道着色器和材质相关的知识，然后演示了如何将内置材质升级为通用渲染管道材质，最后探讨了如何创建一个可以在通用渲染管道中使用的自定义着色器。接下来，我们将继续讨论如何查找性能问题并提高通用渲染管道的性能。

# 提高通用渲染管道的性能

渲染是游戏引擎的主要功能之一。因此，了解如何有效地使用Unity的渲染管线非常重要。在本节中，我们将讨论的主题是性能。

## 帧调试器

首先，我们应该学习如何使用工具来查看和定位由Unity中的渲染引起的性能瓶颈。

Unity编辑器中的**帧调试器**工具是我们推荐的工具，它允许我们轻松查看Unity中渲染一帧的整个过程。

让我们按照以下步骤来了解Unity的渲染管线是如何渲染您游戏的一帧的：

1.  通过点击**播放**按钮在编辑器中启动游戏：

![Figure 8.59 – 在编辑器中播放游戏

![img/Figure_8.59_B17146.jpg]

图8.59 – 在编辑器中播放游戏

1.  在Unity编辑器的工具栏中点击**窗口** > **分析** > **帧调试器**以打开**帧调试器**窗口，如图*图8.60*所示：

![Figure 8.60 – 打开帧调试器

![img/Figure_8.60_B17146.jpg]

图8.60 – 打开帧调试器

1.  在**帧调试器**窗口中，点击**启用**按钮来捕捉您游戏当前帧的快照，如图*图8.61*所示：![Figure 8.61 – 帧调试器

    ![img/Figure_8.61_B17146.jpg]

图8.61 – 帧调试器

1.  在*图8.62*中，我们可以看到有**109**个绘制调用，这些调用调用图形API，如**OpenGL**、**Direct3D**和**Vulkan**来绘制对象。我们还可以选择一个特定的绘制调用来查看其详细信息：

![Figure 8.62 – 查看绘制调用信息

![img/Figure_8.62_B17146.jpg]

图8.62 – 查看绘制调用信息

通过帧调试器工具，我们可以理解整个渲染过程并查看特定绘制调用的信息，这为我们提供了确定如何提高渲染性能的见解。例如，在*图8.62*中，我们可以看到使用了**33**个绘制调用来渲染不透明对象。因此，减少这里的绘制调用数量是我们应该做的事情。接下来，我们将介绍如何使用SRP Batcher来实现这一点。

## SRP Batcher

**SRP Batcher**是Scriptable Render Pipeline提供的一项功能，因此每个基于Scriptable Render Pipeline的渲染管线都可以使用此功能来减少绘制调用次数并提高渲染性能。

为了确保SRP Batcher可以在您的项目中正确工作，您需要确保两件事。第一是启用通用渲染管线的**SRP Batcher**功能，第二是确保您项目中的着色器与SRP Batcher兼容。

首先，让我们确保渲染管线中启用了SRP Batcher。正如我们在*《通用渲染管线资产》子节*中提到的，我们可以通过检查我们项目使用的通用渲染管线资产文件的**高级**设置中的**SRP Batcher**选项来启用它，如图*图8.63*所示：

![图8.63 – 启用SRP Batcher

![图片](img/Figure_8.63_B17146.jpg)

图8.63 – 启用SRP Batcher

接下来，让我们检查我们用于渲染这些不透明对象的着色器是否与SRP Batcher兼容：

![图8.64 – 着色器的SRP Batcher兼容性状态

![图片](img/Figure_8.64_B17146.jpg)

图8.64 – 着色器的SRP Batcher兼容性状态

我们可以在**检查器**窗口中找到着色器的SRP Batcher兼容性状态，如图中所示。在这里，使用的是**通用渲染管线/Lit**着色器，它与SRP Batcher兼容。

现在，让我们运行游戏并再次检查帧调试器：

![图8.65 – 绘制调用次数减少

![图片](img/Figure_8.65_B17146.jpg)

图8.65 – 绘制调用次数减少

正如你在*图8.65*中可以看到的，总的绘制调用次数已经从**109**减少到**91**，用于渲染不透明对象的绘制调用次数已经从**33**减少到**20**，并且每个绘制调用都被标记为**SRP Batch**。

在本节中，我们首先介绍了如何使用Unity的帧调试器工具来查看整个渲染过程和特定绘制调用的信息。然后，我们还探讨了如何通过使用SRP Batcher来减少绘制调用次数并提高渲染性能。

# 摘要

本章介绍了Unity中可以选择的三个现成的渲染管线，即传统的内置渲染管线和基于可脚本渲染管线（Scriptable Render Pipeline）的两个预制渲染管线——通用渲染管线和高清渲染管线。同时，我们还介绍了一些使用这些渲染管线的开源项目，供你学习和使用。

然后，我们讨论了如何在Unity中使用通用渲染管线，首先通过探索一个示例场景，然后解释了如何使用通用渲染管线资产来配置你的渲染管线以及如何使用体积框架来对你的游戏应用后处理效果。

我们还介绍了着色器和材质的概念，演示了如何将内置材质升级为通用渲染管线材质，并探讨了如何创建一个可以在通用渲染管线中使用的自定义着色器。

最后，我们探讨了如何使用Unity的帧调试器工具来查看渲染过程的信息以及如何使用SRP Batcher来减少绘制调用次数。

通过阅读本章，你现在应该已经理解了如何在Unity中正确地使用通用渲染管线。在下一章中，我们将介绍如何在Unity中使用**面向数据的技术堆栈**（**DOTS**）。
