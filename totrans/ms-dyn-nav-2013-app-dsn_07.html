<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Storage and Logistics"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Storage and Logistics</h1></div></div></div><p>In the previous chapters, we looked at how companies work with ERP in production and trade businesses. All these companies work together to bring finished products to the stores where end consumers can buy them.</p><p>During this process, the products move around between the companies. This is done using different kinds of transportation, such as trucks, ships, trains, and airplanes. It may also be necessary to store the products in a warehouse until they are sold or moved to the shops.</p><p>More and more companies make a decision to outsource logistics rather than having their own transportation. When this is the case, logistics can be a separate part of the supply chain. This chapter discusses the process and the effects on the ERP system.</p><p>One of the specific aspects of logistics companies is that the products they handle are not their property. Although they are a part of the total cost of the consumer product, they don't care about the detailed value of their inventory. Logistics companies sell warehouse handling, storage, and transportation as services.</p><p>Microsoft Dynamics NAV does not have built-in functionality to handle this so, in this chapter, we will discuss how to design an application to do this.</p><p>There are several add-on solutions for this business and in a real-world situation those add-ons should be evaluated as potential solutions. In this chapter, we will discuss how to design and create a basic framework for such an add-on application that can be easily extended without adding too much complexity.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note45"/>Note</h3><p>The objects provided with this chapter should never be implemented at a real-customer scenario. They are for the purpose of this chapter's examples only.</p></div></div><p>After reading this chapter, you will have a better understanding of how to design a solid add-on solution and how to integrate it into the standard Microsoft Dynamics NAV product.</p><div class="section" title="How to read this chapter"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec51"/>How to read this chapter</h1></div></div></div><p>In this chapter, we will demonstrate how an add-on for Microsoft Dynamics NAV should be designed. In this example, we create a solution for a Storage &amp; Logistics company. This is chosen because the functionality is similar to the existing functionality in Microsoft Dynamics NAV (warehousing) and is a good example of building on top of standard application features.</p><p>We will start by analyzing the business process and then discuss the reasons why we won't use standard application features and explain the modules our new application will have.</p><p>The next step is to go deeper into these modules and define the design patterns for each of them. We will then walk through the application like we did in the previous chapters and reverse engineer it to explain how all the pieces were designed.</p><p>To do this, we need to download and install the application. As we progress in the chapter, we will discuss most of the objects that can be opened and analyzed in the Microsoft Dynamics NAV development environment.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip37"/>Tip</h3><p>Open the objects as we move along in the chapter to learn more. The objects are rich in functionality, which cannot all be discussed in detail in this book.</p></div></div><div class="section" title="Chapter objects"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec137"/>Chapter objects</h2></div></div></div><p>With this chapter, some objects and <span class="strong"><strong>Dynamic-link library</strong></span> (<span class="strong"><strong>DLL</strong></span>) files<a class="indexterm" id="id936"/> are required. The <a class="link" href="apa.html" title="Appendix A. Installation Guide">Appendix</a>, <span class="emphasis"><em>Installation Guide</em></span>, describes how to import and activate them.</p><p>After the import process is complete, make sure that your current database is the default database for the Role Tailored Client and run <span class="strong"><strong>Page 123456701</strong></span>, <span class="strong"><strong>Storage &amp; Logistics Setup</strong></span> from the <span class="strong"><strong>Object Designer</strong></span> in the <span class="strong"><strong>Classic Client</strong></span>.</p><p>From this page, select the <span class="strong"><strong>Initialize Storage &amp; Logistics</strong></span> option, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Chapter objects" src="graphics/0365EN_07_01.jpg"/></div></div><div class="section" title="The process"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec138"/>The process</h2></div></div></div><p>To design <a class="indexterm" id="id937"/>a solid solution for a specific market, we first need to analyze the business processes and see where the fits and gaps are with the standard product.</p><p>The companies that will be using this solution are logistics providers. These companies do not buy and sell products but sell logistics services such as transportation and storage.</p><p>There can be various moments in the supply chain where these companies are required. Products are often manufactured in companies all over the world and shipped to consumers elsewhere. Products can cover great distances, as shown in the following diagram:</p><div class="mediaobject"><img alt="The process" src="graphics/0365EN_07_02.jpg"/></div></div><div class="section" title="Using standard features"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec139"/>Using standard features</h2></div></div></div><p>Microsoft Dynamics NAV, like<a class="indexterm" id="id938"/> many ERP systems, is designed for people to handle their own products and supports the process of costing as we have seen in the previous chapters. For logistics service providers, this inventory control and valuation functionality is not necessary since the products are not their property. This means that they would want to use the warehouse functionality without the item ledger entries, which is very difficult in Microsoft Dynamics NAV.</p><p>Logistics service providers also offer transportation solutions. They will pick up the products and deliver them to the customer. The process includes combining different stops in routes resulting in a more cost-efficient way of transportation. This functionality is not available in Microsoft Dynamics NAV.</p></div><div class="section" title="Defining the modules"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec140"/>Defining the modules</h2></div></div></div><p>In this chapter, we will <a class="indexterm" id="id939"/>design three new modules on top of <a class="indexterm" id="id940"/>Microsoft Dynamics NAV that integrate with each other and could still be used separately. These modules also integrate with the standard application through <a class="indexterm" id="id941"/>
<span class="strong"><strong>Sales &amp; Purchase Documents</strong></span>.</p><div class="mediaobject"><img alt="Defining the modules" src="graphics/0365EN_07_03.jpg"/></div><div class="section" title="Storage"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec151"/>Storage</h3></div></div></div><p>The first part of the <a class="indexterm" id="id942"/>application is the <a class="indexterm" id="id943"/>storage module. This allows us to receive and ship products and move them internally in the warehouse. The design of this module is very similar to the warehouse documents in the standard application that we discussed in <a class="link" href="ch06.html" title="Chapter 6. Trade">Chapter 6</a>, <span class="emphasis"><em>Trade</em></span>.</p></div><div class="section" title="Logistics"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec152"/>Logistics</h3></div></div></div><p>The<a class="indexterm" id="id944"/> logistics module<a class="indexterm" id="id945"/> supports the planning of routes, delivering the products to the consumers. This is integrated into the storage module but can also be used from sales shipment documents in the standard application.</p><p>For the design of this module, we have looked at the production orders in Microsoft Dynamics NAV that we discussed in <a class="link" href="ch05.html" title="Chapter 5. Production">Chapter 5</a>, <span class="emphasis"><em>Production</em></span>. The routes and shipments have a <span class="strong"><strong>Status</strong></span> field that indicates the progress, similar to a production order.</p></div><div class="section" title="Invoicing"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec153"/>Invoicing</h3></div></div></div><p>The <a class="indexterm" id="id946"/>storage and transportation services are then invoiced to the customer periodically or when the products leave the warehouse.</p><p>For this, we <a class="indexterm" id="id947"/>will use the standard Microsoft Dynamics NAV invoicing solutions but we will add a new <span class="strong"><strong>Income &amp; Expenses</strong></span> module<a class="indexterm" id="id948"/> in between the logistical solution and the invoicing functionality.</p><p>We have looked at the design of Job Ledger Entries and how they are invoiced. This will be discussed in the next chapter.</p></div></div></div></div>
<div class="section" title="The storage application"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec52"/>The storage application</h1></div></div></div><p>In a <a class="indexterm" id="id949"/>storage warehouse, products come and go all the time. A big difference between a storage company and a production plant is that the storage company does not care about what exact products they have; they care about the amount of space they require for storage. The business is selling storage handling, storage space, and transportation.</p><p>For our application, we'll assume that our warehouse has a receipt and a shipping region, an in-between staging region and a bulk storage region. If we simplify the warehouse, it might look like the following floor plan:</p><div class="mediaobject"><img alt="The storage application" src="graphics/0365EN_07_04.jpg"/></div><p>Let's look at the various sections in detail:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Receipt</strong></span>: When <a class="indexterm" id="id950"/>products come in, they are first unloaded from the truck onto a receipt region. This is often located close to the <a class="indexterm" id="id951"/>unloading dock, so the truck can quickly move on to its next stop after the products are unloaded and the loading documents are checked. From the receiving location, the products should be stored away as quickly as possible since another truck might come and we need the space. The products can now go to either the staging region or the bulk region.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Staging</strong></span>: The <a class="indexterm" id="id952"/>staging region<a class="indexterm" id="id953"/> is an in-between region where products can be stored but will leave the warehouse quickly when it is too busy to properly store in the bulk area and we need the space in the receipt region.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Shipment</strong></span>: When <a class="indexterm" id="id954"/>products leave the<a class="indexterm" id="id955"/> warehouse, they will first be moved to the shipment region. This allows us to quickly load the trucks when they arrive and easily compare the loading documents with the real products.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Bulk</strong></span>: When <a class="indexterm" id="id956"/>we expect products to be in the<a class="indexterm" id="id957"/> warehouse for a longer period, they will be stored in the bulk area where we can define shelves. A shelf can have a capacity for one or more products depending on the setup in the system.</li></ul></div><div class="section" title="Documents"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec141"/>Documents</h2></div></div></div><p>The first step<a class="indexterm" id="id958"/> is to have a registration of what will be coming to our warehouse by creating the receipt documents. In the old days, we would often receive this information by phone or fax, but today most companies use interfaces, such as EDI and web portals for this. This keeps us from making mistakes when typing the information in the system and allows us to automatically populate the receipt document.</p><p>The receipt documents will be combined into put-away documents that register the transfer from one region to the other. The software will also suggest a shelf to store the products.</p><p>When the products leave the warehouse, our customers will also register a shipment document. On their call, we will start the order picking process and combine the shipments. The pick documents will tell us on which shelf the products are stored.</p><p>Incidentally, it may also be necessary to move the products in the warehouse. This will be registered in internal movement documents.</p><p>The storage documents are connected to the logistics document structure, which we will see later in this chapter, while discussing logistics.</p></div><div class="section" title="Look, learn, and love"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec142"/>Look, learn, and love</h2></div></div></div><p>In <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <span class="emphasis"><em>A Sample Application</em></span>, we learned how to use a journal and entry design patterns to register usage. In this chapter, we will continue with this and add some document design pattern structures.</p><p>To design our application, we will look at how existing pieces of Microsoft Dynamics NAV are designed and reuse them.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip38"/>Tip</h3><p>On <a class="ulink" href="https://community.dynamics.com/nav/w/designpatterns/default.aspx">https://community.dynamics.com/nav/w/designpatterns/default.aspx</a>, you'll find dozens of design patterns for Microsoft Dynamics NAV including many used in this chapter.</p></div></div><div class="section" title="Journal"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl4sec23"/>Journal</h3></div></div></div><p>The core of our <a class="indexterm" id="id959"/>application is the <a class="indexterm" id="id960"/>
<span class="strong"><strong>Storage Journal</strong></span>, which is<a class="indexterm" id="id961"/> created from the same template as the <a class="indexterm" id="id962"/>
<span class="strong"><strong>Squash Journal</strong></span> earlier. The difference is that people in a warehouse use documents rather than journals.</p></div><div class="section" title="Documents"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl4sec24"/>Documents</h3></div></div></div><p>We will support the five<a class="indexterm" id="id963"/> types of documents<a class="indexterm" id="id964"/> we discussed earlier, namely, Receipt, Shipment, Put-away, Pick, and Movement. The documents can be created manually by end users or created automatically. We will also provide an interface structure to allow customers to register receipts and shipments.</p><p>As all the documents have the same structure and mostly the same fields, they are in the same table to share business logic.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip39"/>Tip</h3><p>Sharing the same table for multiple document types allows easier sharing of business logic across the application.</p></div></div><p>This is also done in the standard Microsoft Dynamics NAV application for sales and purchase documents as we discussed in <a class="link" href="ch06.html" title="Chapter 6. Trade">Chapter 6</a>, <span class="emphasis"><em>Trade</em></span>.</p></div><div class="section" title="Master data"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl4sec25"/>Master data</h3></div></div></div><p>To define<a class="indexterm" id="id965"/> what we are storing in the warehouse, we will use a new table called <a class="indexterm" id="id966"/>
<span class="strong"><strong>Product</strong></span>, which is similar to the Item table in the standard system. By creating a new table, we will improve upgradability of our solution, which will help us be more in control of our own application or in other words, less likely to be impacted by the changes Microsoft implements in the standard product.</p></div></div><div class="section" title="Drawing the design pattern"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec143"/>Drawing the design pattern</h2></div></div></div><p>If we<a class="indexterm" id="id967"/> combine this information into a table and transaction structure, it would look like the following diagram:</p><div class="mediaobject"><img alt="Drawing the design pattern" src="graphics/0365EN_07_05.jpg"/></div><p>The actual<a class="indexterm" id="id968"/> inventory is kept in <a class="indexterm" id="id969"/>
<span class="strong"><strong>Storage Entries</strong></span>. By filtering on a warehouse code, region code, or shelf number, the inventory can be calculated.</p><div class="section" title="Sharing tables"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec155"/>Sharing tables</h3></div></div></div><p>The <span class="strong"><strong>Storage &amp; Logistics</strong></span> add-on application <a class="indexterm" id="id970"/>also has some shared tables. It does not make sense to have a product or warehouse table for each part of the add-on. We choose to also share the setup and the cue tables for the Role Center definition. The Storage &amp; Logistics application has four Role Centers.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip40"/>Tip</h3><p>By sharing the cue table, it is much easier to place the same cues on different Role Centers. If we were to create one table for each Role Center, we would need to copy and paste the cue definition to the table for each change request.</p></div></div></div></div><div class="section" title="Getting started"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec144"/>Getting started</h2></div></div></div><p>In our scenario, we'll ship and receive products for a company called CRONUS International Ltd. for whom we do shipping. We have warehouses in Austria, Belgium, Czech Republic, Denmark, Germany, Great Britain, Iceland, Netherlands, Norway, Sweden, Slovenia, Slovakia, and the USA.</p><p>Each warehouse has the same basic layout as explained earlier in this chapter. From the warehouse, we plan routes to transport the products to the consumer. After initializing<a class="indexterm" id="id971"/> the application <a class="indexterm" id="id972"/>and restarting the application, the <span class="strong"><strong>Role Center</strong></span> should look like this:</p><div class="mediaobject"><img alt="Getting started" src="graphics/0365EN_07_06.jpg"/></div><p>Let's look at the various sections in detail:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Activities</strong></span>: This window shows the workflow for the warehouse floor</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>My Products</strong></span>: This contains all customer products we have on inventory</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>My Regions</strong></span>: This allows us to see what inventory is where in our warehouses</li></ul></div></div><div class="section" title="Opening balance"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec145"/>Opening balance</h2></div></div></div><p>The opening balance<a class="indexterm" id="id973"/> was created using the Storage Journal. By using the journal to create opening entries, we are sure that business rules are followed.</p><p>In our design, we have decided that end users are not allowed to directly register inventory on the bulk location. We start by receiving it, and then we create a put-away document to move it to the bulk location. We'll see how this is done later in this chapter when we discuss<a class="indexterm" id="id974"/> the storage documents.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note46"/>Note</h3><p>Have a look on the <span class="strong"><strong>Storage &amp; Logistics Setup (123456701)</strong></span> page to see how this was done in the <code class="literal">CreateOpeningBalance()</code> function.</p></div></div></div><div class="section" title="Products"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec146"/>Products</h2></div></div></div><p>Products <a class="indexterm" id="id975"/>are references to the items of our customers that we <a class="indexterm" id="id976"/>keep in inventory. They contain a <span class="strong"><strong>Bill-to Customer No.</strong></span> and a <span class="strong"><strong>Customer Item No</strong></span>. This allows us, for example, to keep the item with number <span class="strong"><strong>70000</strong></span> for two different customers.</p><p>We can also see and set up <span class="strong"><strong>Storage Prices</strong></span> for this product, which we will later use for the invoicing.</p><div class="mediaobject"><img alt="Products" src="graphics/0365EN_07_07.jpg"/></div><div class="section" title="Warehouse"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec156"/>Warehouse</h3></div></div></div><p>A warehouse<a class="indexterm" id="id977"/> is a physical building with an address. To move products from one warehouse to another warehouse, we would need to ship them, create a route, and then physically receive them in the other building.</p><div class="mediaobject"><img alt="Warehouse" src="graphics/0365EN_07_08.jpg"/></div></div><div class="section" title="Regions"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec157"/>Regions</h3></div></div></div><p>A region<a class="indexterm" id="id978"/> is a part of the warehouse that is used for a specific storage activity. In our example, we have a receipt, staging, bulk, and shipment region. To move products from one region to another, we should create a put-away, movement, or pick document.</p><div class="mediaobject"><img alt="Regions" src="graphics/0365EN_07_09.jpg"/></div></div><div class="section" title="Shelves"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec158"/>Shelves</h3></div></div></div><p>A shelf is <a class="indexterm" id="id979"/>a specific part of a region. The specific code of a shelf often indicates its position in the warehouse. For example, our warehouses have two rows, A and B, with 18 lines and 8 levels where each shelf can contain one pallet.</p></div></div><div class="section" title="Registration worksheet"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec147"/>Registration worksheet</h2></div></div></div><p>The <a class="indexterm" id="id980"/>warehouse process starts with receiving products. To save time when the products arrive on the dock, we ask our customers to register their products in advance. This is done in the storage registration worksheet.</p><p>In our application, we have simulated an interface with our customer CRONUS International Ltd. We can start the interface from the Role Center directly.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We start the <span class="strong"><strong>CRONUS Storage Import Receipt</strong></span> report from the <span class="strong"><strong>Role Center</strong></span>, as shown in the following screenshot:<div class="mediaobject"><img alt="Registration worksheet" src="graphics/0365EN_07_10.jpg"/></div></li><li class="listitem">The system pops up and asks for a <span class="strong"><strong>Storage Registration Code</strong></span>.</li><li class="listitem"> We will choose <span class="strong"><strong>CRONUS</strong></span> from the list and start the import process.</li><li class="listitem">After this, we open <span class="strong"><strong>Registration Worksheets</strong></span>.<div class="mediaobject"><img alt="Registration worksheet" src="graphics/0365EN_07_11.jpg"/></div></li><li class="listitem">When <a class="indexterm" id="id981"/>we now open the registration worksheet, we see what CRONUS will send us today. This allows us to prepare our business, maybe move around some products, and schedule resources.<div class="mediaobject"><img alt="Registration worksheet" src="graphics/0365EN_07_12.jpg"/></div></li><li class="listitem">We can now register this worksheet, which will create the receipt documents for us.</li></ol></div></div><div class="section" title="Storage documents"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec148"/>Storage documents</h2></div></div></div><p>We use<a class="indexterm" id="id982"/> documents to determine which product goes where. Creating <a class="indexterm" id="id983"/>those documents in the system manually requires a large amount of work, so in our application, this is done automatically.</p><div class="section" title="Receipt"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec159"/>Receipt</h3></div></div></div><p>By <a class="indexterm" id="id984"/>default, all products that are received <a class="indexterm" id="id985"/>are stored in the <span class="strong"><strong>RECEIPT</strong></span> region. This region does not have shelves. If required, we can change the region code.</p><p>After we register the receipt document, we have inventory on the <span class="strong"><strong>RECEIPT</strong></span> location:</p><div class="mediaobject"><img alt="Receipt" src="graphics/0365EN_07_13.jpg"/></div><p>Since this<a class="indexterm" id="id986"/> is a relatively small region, we<a class="indexterm" id="id987"/> need to move the products to the bulk location as quickly as possible. This is done using a put-away document.</p></div><div class="section" title="Put-away"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec160"/>Put-away</h3></div></div></div><p>A <a class="indexterm" id="id988"/>put-away document<a class="indexterm" id="id989"/> is used to move products from the receipt region into the bulk region. The storage entries tell us what is in the receipt region, so we copy that information into a new put-away document. These documents can be created manually, and based on the warehouse information on the document, we can pull the data into the document.</p><p>Another requirement is to have an automated process that creates put-away documents based on the entire content of the receipt region.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To provide for this functionality, we have created the <span class="strong"><strong>Receipts to Put-Away (123456715)</strong></span> report. This processing-only report reads the storage entries for the receipt region, and creates the put-away documents based on certain predefined rules.<div class="mediaobject"><img alt="Put-away" src="graphics/0365EN_07_14.jpg"/></div></li><li class="listitem">The report filters down the storage entries-based regions of type <span class="strong"><strong>Receipt</strong></span> and with inventory.<div class="mediaobject"><img alt="Put-away" src="graphics/0365EN_07_15.jpg"/></div></li><li class="listitem">It creates a <a class="indexterm" id="id990"/>put-away document <a class="indexterm" id="id991"/>for each warehouse suggesting the first put-away region in the warehouse. For each <code class="literal">StorageEntry</code>, the <code class="literal">CreateLine</code> function is started. Let's have a look at the C/AL code for this:<div class="informalexample"><pre class="programlisting">CreateLineCreateLine()

FindOrCreateStorageHdr;
Region2.SETRANGE("Warehouse Code");
Region2.SETRANGE("Put-Away", TRUE);
Region2.FINDFIRST;

WITH StorageEntry DO BEGIN
  NextLineNo := NextLineNo + 10000;
  StorageLn."Document Type" := StorageHdr."Document Type";
  StorageLn."Document No." := StorageHdr."No.";
  StorageLn."Line No." := NextLineNo;
  StorageLn."No." := "Product No.";
  StorageLn."Warehouse Code" := "Warehouse Code";
  StorageLn."Region Code" := Region2.Code;</pre></div></li><li class="listitem">The first step is to check whether it's necessary to create a new storage document. We create a new document for each <code class="literal">Warehouse</code> and <code class="literal">StorageDate</code>.</li><li class="listitem">Then, the system filters on the region table to find a put-away region. For each <code class="literal">StorageEntry</code>, a <code class="literal">StorageLine</code> is created.</li><li class="listitem">After running the report, our put-away document looks like this:<div class="mediaobject"><img alt="Put-away" src="graphics/0365EN_07_16.jpg"/></div></li><li class="listitem">The suggested <span class="strong"><strong>Region Code</strong></span> is <span class="strong"><strong>BULK</strong></span> and the <span class="strong"><strong>Apply-to Region Code</strong></span> is <span class="strong"><strong>RECEIPT</strong></span>.</li><li class="listitem">If we <a class="indexterm" id="id992"/>now try to<a class="indexterm" id="id993"/> register this document, we will receive an error since we did not enter any <code class="literal">Shelves</code> because this is mandatory on this region.<div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note47"/>Note</h3><p>This check is done in the codeunit Storage Jnl.-Check Line. By moving these checks into this codeunit, we make sure these rules are mandatory in each posting.</p></div></div></li><li class="listitem">Since we rely on the system to keep track of our inventory, we can also have it suggest available shelves for us. This is also done using batch report <span class="strong"><strong>123456716 Generate Put-Away Shelves</strong></span>. Let's design the report and look at the C/AL code in <code class="literal">StorageLineDataItem</code>:<div class="informalexample"><pre class="programlisting">Storage Line - OnAfterGetRecord()

Counter := Counter + 1;
Window.UPDATE(1,"Document No.");
Window.UPDATE(2,ROUND(Counter / CounterTotal * 10000,1));

Shelf.SETRANGE("Warehouse Code", "Storage Line"."Warehouse Code");
Shelf.SETRANGE("Region Code", "Region Code");
Shelf.SETRANGE(Inventory, 0);
Shelf.SETRANGE("Blocked by Storage", FALSE);
Shelf.FINDFIRST;

"Shelf No." := Shelf."No.";
MODIFY;</pre></div></li><li class="listitem">For each <code class="literal">StorageLine</code> in the put-away document, it finds another shelf by filtering on availability <a class="indexterm" id="id994"/>based on <code class="literal">Inventory</code> and <code class="literal">BlockedByStorage</code>.</li><li class="listitem">The <code class="literal">BlockedByStorage</code> field is a flow field that returns true if the shelf is used on a warehouse document preventing two forklift trucks from stopping at the same shelf.</li><li class="listitem">When this <a class="indexterm" id="id995"/>report is executed, we can register this put-away document and we can see the <span class="strong"><strong>Storage Entries</strong></span> that are generated from the <span class="strong"><strong>Product Card</strong></span> using the <span class="strong"><strong>Ledger Entries</strong></span> action:<div class="mediaobject"><img alt="Put-away" src="graphics/0365EN_07_17.jpg"/></div></li></ol></div><p>Here, we can see that the put-away document has applied its entries to the receipt entries. Since we moved everything, the original entry is closed and the remaining quantity is set to zero.</p><p>This functionality is similar to what we created in <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <span class="emphasis"><em>A Sample Application</em></span>, when applying an invoice entry to a reservation.</p></div><div class="section" title="Shipment"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec161"/>Shipment</h3></div></div></div><p>After a while <a class="indexterm" id="id996"/>when the products <a class="indexterm" id="id997"/>are in inventory, the customer may send a request to ship them. The shipping documents are sent using the same interface as the receipt documents.</p><div class="mediaobject"><img alt="Shipment" src="graphics/0365EN_07_18.jpg"/><div class="caption"><p>CRONUS Storage Import Shipment option</p></div></div><p>Running the <span class="strong"><strong>CRONUS Storage Import Shipment</strong></span> report will create the <span class="strong"><strong>Storage Registration Worksheet</strong></span>, which <a class="indexterm" id="id998"/>we can <a class="indexterm" id="id999"/>check and register to a shipment document, the same way as the receipt documents earlier.</p><p>The system creates a shipment document for each <span class="strong"><strong>Ship-to Address</strong></span>.</p><div class="mediaobject"><img alt="Shipment" src="graphics/0365EN_07_19.jpg"/></div><p>We now have to start the process of moving the products from the storage region to the shipment region.</p></div><div class="section" title="Picks"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec162"/>Picks</h3></div></div></div><p>The products<a class="indexterm" id="id1000"/> that will be shipped <a class="indexterm" id="id1001"/>need to be picked from the bulk or staging region using a pick document. As with the put-away functionality, our application design provides an automated process that supports this process.</p><p>To create the document, we use batch <span class="strong"><strong>Report 123456717 Shipments to Pick</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Picks" src="graphics/0365EN_07_20.jpg"/></div><p>This report can <a class="indexterm" id="id1002"/>combine shipments into one or more pick documents:</p><div class="informalexample"><pre class="programlisting">Storage Line - OnAfterGetRecord()

Counter := Counter + 1;
Window.UPDATE(1,"Document No.");
Window.UPDATE(2,ROUND(Counter / CounterTotal * 10000,1));

Product.GET("No.");
Product.SETRANGE("Warehouse Filter Code", "Warehouse Code");
Product.CALCFIELDS(Inventory);
IF Quantity &gt; Product.Inventory THEN
  ERROR(Text001, Quantity, Product.Inventory, "No.");

QtyToPick := Quantity;

StorageEntry.SETCURRENTKEY("Product No.");
StorageEntry.SETRANGE("Warehouse Code", "Storage Header"."Warehouse Code");
StorageEntry.SETRANGE("Product No.", "No.");
StorageEntry.SETRANGE(Open, TRUE);
IF StorageEntry.FINDSET(TRUE) THEN REPEAT
  StorageEntry.CALCFIELDS("Blocked by Storage");
  IF NOT StorageEntry."Blocked by Storage" THEN BEGIN
    IF QtyToPick &gt;= StorageEntry.Quantity THEN
      QtyToPick := QtyToPick - StorageEntry.Quantity
    ELSE BEGIN
      StorageEntry.Quantity := QtyToPick;
      QtyToPick := 0;
    END;
    CreateLine(StorageEntry);
  END;
UNTIL (StorageEntry.NEXT = 0) OR (QtyToPick = 0);

IF QtyToPick &gt; 0 THEN
  ERROR(Text002, "No.");</pre></div><p>First, the system<a class="indexterm" id="id1003"/> checks whether the products are <a class="indexterm" id="id1004"/>in inventory in this warehouse. If they are here, it starts browsing through the storage entries to look for available shelves. Here, we also use the <span class="strong"><strong>Blocked by Storage flow</strong></span> field to avoid two employees fighting over the same product.</p><p>One of the functional requirements in our application is to avoid having half a shipment to be picked and block the <span class="strong"><strong>SHIPMENT</strong></span> region being incomplete. If there are not enough inventories available for the pick, the system will display an error.</p><p>After the pick is created, we update the <span class="strong"><strong>Pick Status on the Shipment</strong></span> field. In the following screenshot, we can see that there are three <span class="strong"><strong>Pick Lines</strong></span> attached to this shipment:</p><div class="mediaobject"><img alt="Picks" src="graphics/0365EN_07_21.jpg"/></div><p>When we click on <span class="strong"><strong>3</strong></span>, the system opens the lines. Double-clicking on the lines will open the pick document.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip41"/>Tip</h3><p>To influence the double-click event, assign the <span class="strong"><strong>RETURN</strong></span> shortcut to one of the actions on a page.</p></div></div><p>After registration of the pick document, the status of the shipment moves to <span class="strong"><strong>Completely Picked</strong></span>. We can see that the <span class="strong"><strong>Pick Lines</strong></span> are registered:</p><div class="mediaobject"><img alt="Picks" src="graphics/0365EN_07_22.jpg"/></div><p>The last step <a class="indexterm" id="id1005"/>before the shipment can be <a class="indexterm" id="id1006"/>registered is updating the storage lines with the <span class="strong"><strong>Apply-to Storage Entry No.</strong></span> from the pick document. For this step, we have designed a dedicated report <span class="strong"><strong>Update Storage Shipment (123456718)</strong></span> that can be started from the <span class="strong"><strong>Storage Shipment Document</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Picks" src="graphics/0365EN_07_23.jpg"/></div><p>After this, the shipment can be registered. The products have now left our warehouse and are on the road to the customer.</p></div></div></div>
<div class="section" title="The logistics application"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec53"/>The logistics application</h1></div></div></div><p>Similar to <a class="indexterm" id="id1007"/>production orders in the standard application, the processes in our logistics application are status-driven rather than transaction-driven. This is why this part of the application does not have a journal with entries. The tables can have archived copies but they are not part of a normal registering or posting<a class="indexterm" id="id1008"/> routine.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note48"/>Note</h3><p>For the examples in this part of the chapter, we should change the default <span class="strong"><strong>Role Center to Logistics Role Center (123456700)</strong></span> in the <span class="strong"><strong>Profile table (2000000072)</strong></span>.</p></div></div><div class="section" title="Drawing the design patterns"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec149"/>Drawing the design patterns</h2></div></div></div><p>If we look<a class="indexterm" id="id1009"/> at the structure of the logistics application, we can see that the typical posting transactions are missing. The application uses a status-driven workflow based on events that are defined in the triggers of the tables.</p><div class="mediaobject"><img alt="Drawing the design patterns" src="graphics/0365EN_07_24.jpg"/></div><p>The logistics shipment and shipment details have a lot of similarity with the shipments from the warehouse. We have chosen to move them into new tables for the following reasons:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Security</strong></span>: In Microsoft dynamics NAV, the table level is most important for security. If we share this table, it would be impossible to set up users to have access to logistics and not to the warehouse or vice versa.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Locking</strong></span>: If two <a class="indexterm" id="id1010"/>departments use the same table for different purposes, they will most likely have a different locking mechanism. For example, in logistics, shipments are bound to the route object. The warehouse shipments are bound to other shipment documents. Filtering the same table in main processes in different ways will significantly increase the probability of blocks and deadlocks.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Table size</strong></span>: The storage documents are registered shortly after they are created. Most documents are deleted and moved to registered tables on the same day that they are created. Logistics shipments have a longer life cycle. It takes longer to take the products from our warehouse to the customer and during this process, many<a class="indexterm" id="id1011"/> things can go wrong because of outside events. The transport tables may be periodically cleaned up like manufacturing or jobs in the standard Microsoft Dynamics NAV product.</li></ul></div></div><div class="section" title="Getting started"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec150"/>Getting started</h2></div></div></div><p>To start the<a class="indexterm" id="id1012"/> logistics process, we can create some shipments manually but the application also provides an interface to the sales shipments and warehouse shipments.</p><p>Let's start the <span class="strong"><strong>Combine Shipments (Sales)</strong></span> option from <span class="strong"><strong>Activities</strong></span> on the <span class="strong"><strong>Logistics Role Center</strong></span> to generate some data to work with.</p></div><div class="section" title="Shipments"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec151"/>Shipments</h2></div></div></div><p>Logistics shipments<a class="indexterm" id="id1013"/> are products moving from one physical address to another physical address.</p><p>In our example, the shipments are created from our warehouse to the customer but a shipment can also be from another address to a customer. Tracking the status of a shipment is very important for the planners. A shipment starts with the <span class="strong"><strong>Ready to Ship</strong></span> status as soon as all mandatory fields are checked.</p><p>When the shipments are combined into routes, the shipment moves to shipping and the status is changed to <span class="strong"><strong>Shipping</strong></span>. During this stage, the products are picked up from the warehouse. When this happens, the <span class="strong"><strong>Pickup Date Time</strong></span> is populated. This is done from the route.</p><p>After delivery, the <span class="strong"><strong>Delivery Date Time</strong></span> is populated and the status is set to <span class="strong"><strong>Shipped</strong></span>.</p><div class="mediaobject"><img alt="Shipments" src="graphics/0365EN_07_25.jpg"/></div><p>The planners can follow the shipments from their Role Centers in a workflow.</p></div><div class="section" title="Routes"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec152"/>Routes</h2></div></div></div><p>Shipments<a class="indexterm" id="id1014"/> are combined into a route. For the planners to make a product planning, it is very important that the shipment details are correct. The length, width, height, and weight of the products determine whether they can fit in a truck, ship, airplane, or train.</p><p>Our example add-on system has a report to combine shipments into a route. The shipments in a route will be combined into stops if they have the same address information.</p><div class="section" title="Combining shipments"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec163"/>Combining shipments</h3></div></div></div><p>Combined shipping<a class="indexterm" id="id1015"/> is done in the <span class="strong"><strong>Shipment To Route &amp; Warehouse (123456701)</strong></span> report. The shipments are grouped per warehouse. For each warehouse, a new route is created.</p><p>For each shipment, the system creates a route stop. The stops have different types, Pickup, Delivery, Pickup Group, and Delivery Group. Each shipment then gets a Pickup and Delivery stop:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Shipment - OnAfterGetRecord()</strong></span>

IF Route.Description &lt;&gt; Warehouse.Name THEN BEGIN
  Route."No." := '';
  Route.Description := Warehouse.Name;
  Route."Shipment Date" := WORKDATE;
  Route.Status := Route.Status::Planned;
  
  Route."Bill-to Customer No." := "Bill-to Customer No.";
  Route."Bill-to Name" := "Bill-to Name";

  Route.INSERT(TRUE);
  i := 0;
END;

i := i + 10000;

RouteStop."Route No." := Route."No.";
RouteStop."Line No." := i;
RouteStop.Type := RouteStop.Type::Pickup;
RouteStop.VALIDATE("Shipment No.", "No.");
RouteStop.INSERT;

i := i + 10000;

RouteStop."Route No." := Route."No.";
RouteStop."Line No." := i;
RouteStop.Type := RouteStop.Type::Delivery;
RouteStop.VALIDATE("Shipment No.", "No.");
RouteStop.INSERT;</pre></div><p>After the routes are<a class="indexterm" id="id1016"/> created and the shipments are assigned to a stop, a grouping and optimizing algorithm is started. This is codeunit <code class="literal">Route Optimizer (123456700)</code>.</p></div><div class="section" title="Route optimizer"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec164"/>Route optimizer</h3></div></div></div><p>The algorithm<a class="indexterm" id="id1017"/> in our example is designed to find the optimal route to deliver the products to the addresses by calculating the distance of each address from the warehouse. The route starts from the address that is closest to our warehouse and ends at the address that is the farthest away.</p><p>This is just an example of a simple algorithm. Each company will have its own algorithm that needs to be implemented:</p><div class="informalexample"><pre class="programlisting">RouteStopPickup.SETRANGE("Route No.", Route."No.");
RouteStopPickup.SETRANGE(Type, RouteStopPickup.Type::Pickup);
RouteStopPickup.FINDFIRST;

RouteStopDelivery.SETRANGE("Route No.", Route."No.");
RouteStopDelivery.SETRANGE(Type, RouteStopDelivery.Type::Delivery);
RouteStopDelivery.FINDSET;
REPEAT
  Window.UPDATE(2, RouteStopDelivery."Shipment No.");

  IF NOT Optimizer.GET(RouteStopDelivery.Name) THEN BEGIN
    CLEAR(BingMapMgt);
    BingMapMgt.CalculateRoute('', RouteStopPickup.Latitude, RouteStopPickup.Longitude,'', RouteStopDelivery.Latitude,
      RouteStopDelivery.Longitude, Optimizer."Distance (Distance)",Optimizer."Activity Time", Optimize::Distance);

    Optimizer.Name := RouteStopDelivery.Name;
    Optimizer.Latitude := RouteStopDelivery.Latitude;
    Optimizer.Longitude := RouteStopDelivery.Longitude;
    Optimizer.INSERT;
  END;
  
UNTIL RouteStopDelivery.NEXT = 0;</pre></div><p>The calculation of the distance is done by calling a web service from Bing Maps. This is explained in <a class="link" href="ch09.html" title="Chapter 9. Interfacing">Chapter 9</a>, <span class="emphasis"><em>Interfacing</em></span>.</p><p>Each distance is stored as a record into the <span class="strong"><strong>Optimizer</strong></span> table, which is a helper table. This table is a temporary variable in this codeunit.</p><p>Temporary tables<a class="indexterm" id="id1018"/> have multiple benefits that make them interesting to use. As they are not stored in the database, they have much better performance compared to real tables. This also has a benefit for concurrency since there can be no locking.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip42"/>Tip</h3><p>Temporary tables are free to use. They are not checked in the license file when used. To create and modify the definition, a valid license is still required. The video at <a class="ulink" href="https://www.youtube.com/watch?v=QHn5oEOJv0Q">https://www.youtube.com/watch?v=QHn5oEOJv0Q</a> shows how to use temporary datasets.</p></div></div><p>After generating the distances, all Pickup shipments are combined into one stop by assigning them all to the same <code class="literal">Sequence No.</code> value:</p><div class="informalexample"><pre class="programlisting">RouteStopGroup.INIT;
RouteStopGroup."Route No." := Route."No.";
RouteStopGroup."Line No." := 10;
RouteStopGroup.Type := RouteStopGroup.Type::"Pickup Group";
RouteStopGroup."Sequence No." := 10;
RouteStopGroup.Name := RouteStopPickup.Name;
RouteStopGroup.INSERT;

RouteStopPickup.MODIFYALL("Sequence No.", 10);</pre></div><p>By sorting the distance helper table on distance, we can easily assign the correct <code class="literal">Sequence No.</code> to the delivery stops. For each <code class="literal">Sequence No.</code> value, we will also generate a group record in the stop table:</p><div class="informalexample"><pre class="programlisting">Optimizer.SETCURRENTKEY("Distance (Distance)");
Optimizer.ASCENDING(FALSE);
Optimizer.FIND('-');
REPEAT
  RouteStopGroup.INIT;
  RouteStopGroup."Route No." := Route."No.";
  RouteStopGroup."Line No." := Sequence;
  RouteStopGroup.Type := 
    RouteStopGroup.Type::"Delivery Group";
  RouteStopGroup."Sequence No." := Sequence;
  RouteStopGroup.Name := Optimizer.Name;
  RouteStopGroup.INSERT;

  RouteStopDelivery.SETRANGE(Name, Optimizer.Name);
  RouteStopDelivery.MODIFYALL("Sequence No.", Sequence);
  
  Sequence := Sequence + 10;
  IF (xLongitude &lt;&gt; Optimizer.Longitude) OR 
    (xLatitude &lt;&gt; Optimizer.Latitude) 
  THEN BEGIN
    IF xLongitude + xLatitude &lt;&gt; 0 THEN BEGIN
      CLEAR(BingMapMgt);
      BingMapMgt.CalculateRoute('', xLatitude, xLongitude,'', 
        Optimizer.Latitude, Optimizer.Longitude, 
        RouteStopGroup.Distance, RouteStopGroup.Time, 
        Optimize::Distance);
      RouteStopGroup.MODIFY;
    END;
    xLongitude := Optimizer.Longitude;
    xLatitude := Optimizer.Latitude;
  END;
UNTIL Optimizer.NEXT = 0;</pre></div><p>After optimizing the route, it should<a class="indexterm" id="id1019"/> look something like what is shown in the following screenshot. We pick up two shipments at the warehouse and drive them to two addresses in the country.</p><div class="mediaobject"><img alt="Route optimizer" src="graphics/0365EN_07_26.jpg"/></div></div></div><div class="section" title="Route follow up"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec153"/>Route follow up</h2></div></div></div><p>During the route, the<a class="indexterm" id="id1020"/> planner needs to follow up with the driver. This will result in the status update of the shipment.</p><p>In our solution, the planner should populate the <span class="strong"><strong>Date Time Completed</strong></span> field. This field is automatically updated<a class="indexterm" id="id1021"/> in the shipment using a flow field.</p></div><div class="section" title="Incidents"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec154"/>Incidents</h2></div></div></div><p>A special status for a shipment is an incident. If, for any reason, we cannot deliver the shipment, it should be taken back to the warehouse and shipped again. Based on the reason of the incident, we might need to invoice extra services.</p><p>The incident<a class="indexterm" id="id1022"/> can be on a stop group or on an individual shipment and can have status <span class="strong"><strong>Undeliverable</strong></span>, <span class="strong"><strong>Closed</strong></span>, or <span class="strong"><strong>Other</strong></span>. The planner can add extra comments.</p><div class="mediaobject"><img alt="Incidents" src="graphics/0365EN_07_27.jpg"/></div><p>The other shipments that do not have incidents get the new status, while the incidents move to another place on the Role Center.</p><div class="mediaobject"><img alt="Incidents" src="graphics/0365EN_07_28.jpg"/></div><div class="section" title="Follow up"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec165"/>Follow up</h3></div></div></div><p>The<a class="indexterm" id="id1023"/> incidents can be followed up by the planner via the Role Center. Incidents that have not been handled, keep the status open until someone decides what to do with it.</p><div class="mediaobject"><img alt="Follow up" src="graphics/0365EN_07_29.jpg"/></div></div></div></div>
<div class="section" title="The invoicing application"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec54"/>The invoicing application</h1></div></div></div><p>In <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <span class="emphasis"><em>A Sample Application</em></span>, we introduced invoicing for an add-on solution. For the<a class="indexterm" id="id1024"/> solution in this chapter, we'll take this one step further.</p><p>Our company is invoicing different logistics services, such as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Handling costs for storage receipt and shipments</li><li class="listitem" style="list-style-type: disc">Storage costs for the period we keep the inventory</li><li class="listitem" style="list-style-type: disc">Costs for transporting the products to the end consumer</li></ul></div><p>All these costs need to be combined in one invoice. Some customers may require monthly invoicing or some weekly and for incidental customers, we invoice directly. This requires a special module to handle the invoicing.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note49"/>Note</h3><p>For the examples in this part of the chapter, the <span class="strong"><strong>Default Role Center</strong></span> in the <span class="strong"><strong>Profile table (2000000072)</strong></span> should be changed to <span class="strong"><strong>Income &amp; Expenses Role Center (123456761)</strong></span>.</p></div></div><p>Let's have a look at the <a class="indexterm" id="id1025"/>process to see where the invoicing is required:</p><div class="mediaobject"><img alt="The invoicing application" src="graphics/0365EN_07_30.jpg"/></div><div class="section" title="Income and expense"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec155"/>Income and expense</h2></div></div></div><p>Everything that we want to invoice at one time to a customer, we store in a new table that we will call Income &amp; Expense. This is a container where they will be kept until the periodical invoicing is done for this customer.</p><p>The <a class="indexterm" id="id1026"/>Income &amp; Expense records<a class="indexterm" id="id1027"/> can be created manually by end users or automatically by the system. Let's have a look at them:</p><div class="mediaobject"><img alt="Income and expense" src="graphics/0365EN_07_31.jpg"/></div><p>To<a class="indexterm" id="id1028"/> create a new<a class="indexterm" id="id1029"/> Income &amp; Expense record, we need to fill in the following <a class="indexterm" id="id1030"/>fields:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Income &amp; Expense Code</strong></span>: This is a reference to the group of Income &amp; Expense.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Type</strong></span>: This can be either Income or Expense. The former will be used on sales invoices and the latter is reserved for future use on purchase invoices if we decide to hire other companies to handle our logistics.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Description</strong></span>: This is the description that will be printed on the sales invoice.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Quantity</strong></span>: This is the number of services that we have done. For example, the number of storage days or number of kilometers or miles in a route.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Unit Cost/Total Cost</strong></span>: This can be used to calculate the profit of a service.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Unit Price/Total Price</strong></span>: This is the price the customer will see on the sales invoice.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Unit of Measure Code</strong></span>: This is a reference to the calculation method such as <code class="literal">BOX</code>, <code class="literal">KM</code>, <code class="literal">MILES</code>, or <code class="literal">DAY</code>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Applies-to Document Subtype</strong></span>: This<a class="indexterm" id="id1031"/> is a reference to Storage Header, Registered Storage Header, Logistics Shipment, or Logistics Route. If necessary, this can be expanded to accommodate other add-ons.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Applies-to Document (Line) No.</strong></span>: This is a reference to the Storage and Logistics documents that this Income &amp; Expense record belongs to.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Applies-to Entry No.</strong></span>: This is a reference to the Storage Invoice Entry.</li></ul></div></div><div class="section" title="Invoicing"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec156"/>Invoicing</h2></div></div></div><p>After the Income &amp; Expenses <a class="indexterm" id="id1032"/>are created, we can start the <a class="indexterm" id="id1033"/>invoicing process. To support this, some minor changes are done in the invoicing part of Microsoft Dynamics NAV and as an example, we choose a slightly different approach compared to <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <span class="emphasis"><em>A Sample Application</em></span>.</p><div class="section" title="Sales Line"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec166"/>Sales Line</h3></div></div></div><p>The <a class="indexterm" id="id1034"/>
<span class="strong"><strong>Sales Line</strong></span> table (37) has gotten some minor modifications. We have added an extra type for <span class="strong"><strong>Income</strong></span> and implemented a table relation for the <span class="strong"><strong>No.</strong></span> field:</p><div class="mediaobject"><img alt="Sales Line" src="graphics/0365EN_07_32.jpg"/></div><p>This enables us to also create new entries on a sales invoice without having to create an Income &amp; Expense first.</p><p>The Sales Line also has a reference to the <span class="strong"><strong>Income &amp; Expense Entry No.</strong></span> and the <span class="strong"><strong>Apply-to</strong></span> fields. This<a class="indexterm" id="id1035"/> enables us to create the <span class="strong"><strong>Income &amp; Expense Journal Lines</strong></span> in the <span class="strong"><strong>Sales Post Code Unit</strong></span>.</p></div><div class="section" title="Codeunit Sales-Post (80)"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec167"/>Codeunit Sales-Post (80)</h3></div></div></div><p>The<a class="indexterm" id="id1036"/> sales post code unit has only one change to populate the Income &amp; Expense Journal:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>OnRun()</strong></span>

        ...
        SalesLine.Type::Income:          //* Chapter 7
          PostIncome;

<span class="strong"><strong>PostIncome()</strong></span>

IF SalesLine."Qty. to Invoice" = 0 THEN 
  EXIT;

WITH IncExpJnlLn DO BEGIN
  INIT;
  "Posting Date" := "Posting Date";
  ...
  "Source Code" := SrcCode;
  "Posting No. Series" := "Posting No. Series";
  "Dimension Set ID" := SalesLine."Dimension Set ID";
  IncExpJnlPostLine.RunWithCheck(IncExpJnlLn);
END;</pre></div><p>This is done in the same way as the Resource Journal, however, we moved the code that creates the journal line to a function, and this improves readability and upgradability of our code.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip43"/>Tip</h3><p>As the Sales Line has all the <span class="strong"><strong>Posting Group</strong></span> and <span class="strong"><strong>Amount</strong></span> fields populated, the General Ledger Entries, VAT Entries, and Customer Ledger Entries are automatically generated by the standard application. </p></div></div></div></div><div class="section" title="Pricing methodology"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec157"/>Pricing methodology</h2></div></div></div><p>Our <a class="indexterm" id="id1037"/>add-on solution has three levels of automatic <a class="indexterm" id="id1038"/>price calculation that are more or less identical. We can calculate prices for storage documents, logistics shipments, and routes.</p><p>Let's look at the storage prices as an example of how this is done.</p><div class="section" title="Storage prices"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec168"/>Storage prices</h3></div></div></div><p>In the<a class="indexterm" id="id1039"/> <span class="strong"><strong>Storage Price</strong></span> table, we can register prices for different storage activities.</p><div class="mediaobject"><img alt="Storage prices" src="graphics/0365EN_07_33.jpg"/></div><p>When the price is calculated, the system will filter down in this table to find the price that matches best. For example, if a product has a price for receipt without a warehouse code, this price is used in all warehouses, but if one warehouse code is populated, this warehouse has a special price.</p><p>Prices can be differentiated to receipt, shipment, pick, put-away, movement, and storage. The first options are used on the storage documents, the latter when calculating storage cost.</p><p>The <span class="strong"><strong>Income &amp; Expense Code</strong></span> determines which type of Income &amp; Expense will be created for this combination. A storage document can have more than one Income &amp; Expense, for example, a normal receipt line and a customs surplus.</p></div><div class="section" title="Calculation"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec169"/>Calculation</h3></div></div></div><p>The<a class="indexterm" id="id1040"/> Income &amp; Expenses are created using a Price Calc. Mgt. Codeunit, which we are familiar with from <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <span class="emphasis"><em>A Sample Application</em></span>, only this time we will not update the Unit Price but create the Income &amp; Expenses.</p><p>The calculation for storage is done in codeunit 123456710:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>FindStorageLinePrice</strong></span>

WITH StorageLine DO BEGIN
  Product.GET("No.");
  StorageLinePriceExists(StorageHeader, StorageLine);
  CreateIncExp(StorageHeader,StorageLine,TempStoragePrice);

END;</pre></div><p>The <code class="literal">FindStorageLinePrice</code> function<a class="indexterm" id="id1041"/> will call the standard <a class="indexterm" id="id1042"/>
<code class="literal">StorageLinePriceExists</code> function <a class="indexterm" id="id1043"/>to find the storage prices that match the criteria. For all the storage prices in the filter, it calls the <a class="indexterm" id="id1044"/>
<code class="literal">CreateIncExp</code> function:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CreateIncExp()</strong></span>

IncExp.SETRANGE("Applies-to Document Type", IncExp."Applies-to Document Type"::"Storage Header");
IncExp.SETRANGE("Applies-to Document No.", StorageHeader."No.");
IncExp.SETRANGE("Applies-to Document Line No.", StorageLine."Line No.");
IncExp.DELETEALL;

WITH StoragePrice DO BEGIN
  FoundStoragePrice := FINDSET;
  IF FoundStoragePrice THEN BEGIN
    REPEAT
      IncExpCode.GET(StoragePrice."Income &amp; Expense Code");
      IncExp.INIT;
      IncExp."Entry No." := 0;           //* For Autoincrement
      IncExp.Type := IncExpCode.Type;
      IncExp."Income &amp; Expense Code" := 
        "Income &amp; Expense Code";
      IncExp.Description := Description;
      IncExp.Quantity := StorageLine.Quantity;
      IncExp."Unit Cost" := IncExpCode."Unit Cost";
      IncExp."Total Cost" := IncExp.Quantity * 
        IncExp."Unit Cost";
      IncExp."Unit Price" := StoragePrice."Unit Price";
      IncExp."Total Price" := IncExp.Quantity * 
        IncExp."Unit Price";
      IncExp."Applies-to Document Type" := 
        IncExp."Applies-to Document Type"::"Storage Header";
      IncExp."Applies-to Document No." := StorageHeader."No.";
      IncExp."Applies-to Document Line No." := 
        StorageLine."Line No.";
      IncExp."Bill-to Customer No." := 
        StorageHeader."Bill-to Customer No.";
      IncExp."Gen. Prod. Posting Group" := 
        IncExpCode."Gen. Prod. Posting Group";
      IncExp."VAT Prod. Posting Group" := 
        IncExpCode."VAT Prod. Posting Group";
      IncExp.INSERT;
    UNTIL NEXT = 0;
  END;
END;</pre></div><p>Each price will<a class="indexterm" id="id1045"/> create a separate Income &amp; Expense record.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip44"/>Tip</h3><p>The Income &amp; Expense table is set to <span class="strong"><strong>Auto Increment</strong></span>. This means that SQL Server will generate the entry number for us. This enables multiple users to generate entries in this table at the same time without blocking each other.</p></div></div></div><div class="section" title="Result"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec170"/>Result</h3></div></div></div><p>When <a class="indexterm" id="id1046"/>new documents are generated by the system or end users, the prices are automatically calculated. The user can see the total cost and price on the <span class="strong"><strong>Fact Box</strong></span> and change, remove, or add records if necessary, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Result" src="graphics/0365EN_07_34.jpg"/></div></div></div><div class="section" title="Periodic invoicing"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec158"/>Periodic invoicing</h2></div></div></div><p>One of <a class="indexterm" id="id1047"/>the services we are providing is storage. This<a class="indexterm" id="id1048"/> means that sometimes products can be in our warehouse for several days or even weeks or months. Our customers will be invoiced for the time they use our warehouse space.</p><p>Each time we receive a product in our warehouse or move a product to another region or shelf, a storage entry is created to keep track. For invoicing, we also create a Storage Invoice Entry. This is mainly because the inventory handling and invoicing are done on different moments by different persons. The products can be shipped to the customer when we start the invoicing process.</p><p>The<a class="indexterm" id="id1049"/> Storage Invoice Entry is created with a <span class="strong"><strong>From Storage Date</strong></span> that is inherited from the Storage Date of the Storage Entry. The <a class="indexterm" id="id1050"/>Storage Invoice Entry also has a <span class="strong"><strong>To Storage Date</strong></span> that maintains blank until the product leaves the warehouse or moves to another location that might have another price. The Income &amp; Expense Code determines which price will be invoiced and is determined when posting a <span class="strong"><strong>Storage Document</strong></span>.</p><p>The batch report <span class="strong"><strong>Storage Invoicing (123456703)</strong></span> is used for the creation of the Income &amp; Expenses. Let's have a look at how this is done.</p><div class="mediaobject"><img alt="Periodic invoicing" src="graphics/0365EN_07_35.jpg"/></div><p>The report only has one Storage Invoice Entry <code class="literal">DataItem</code>, which is filtered on <span class="strong"><strong>Open=Yes</strong></span>.</p><p>In the report, all the Storage Invoice Entries are moved to a buffer table first and handled later. There are two important reasons for implementing a solution like this:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Changing Record Set</strong></span>: This report filters on Storage Invoice Entries, which are open for invoicing. When the Storage Invoice Entry is completely invoiced, we want to change this value. This means that the record set we use is changing during the process. This is something the SQL Server backend cannot handle and this will result in very poor performance. By first moving all records to a buffer table, the filtering will be done on a virtual table that is maintained on the Service Tier rather than SQL Server.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Locking</strong></span>: If we <a class="indexterm" id="id1051"/>were to filter on open entries and modify our dataset, it would result in locking more records than necessary. Filtering on a non-clustered index will result in SQL Server moving to Range Locks rather than Row Locks. By <a class="indexterm" id="id1052"/>reading the actual Storage Invoice Entry one by one using the clustered index, we will make sure that SQL Server only locks the records we use for this process, allowing other users to keep creating new records at the end of this table.</li></ul></div><div class="section" title="Processing the buffer"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec171"/>Processing the buffer</h3></div></div></div><p>When <a class="indexterm" id="id1053"/>processing the buffer, we first check whether this entry has been invoiced before. If this is the case, we start invoicing from the previous date, if not; we use the From Storage Date.</p><p>Then, we check whether the products have already left the warehouse or have been moved. If this is the case, we can close this entry by invoicing until this date; otherwise, we will invoice until the Workdate.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip45"/>Tip</h3><p>Users can change the systems Workdate and influence the systems behavior this way and invoice until another date.</p></div></div><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ProcessBuffer()</strong></span>

StorageInvEntry.LOCKTABLE;

WITH TempStorageInvEntry DO
  IF FIND('-') THEN REPEAT
    StorageInvEntry.GET("Entry No.");
    
    IF "Last Invoice Date" &lt;&gt; 0D THEN
      FromDate := "Last Invoice Date"
    ELSE
      FromDate := "From Storage Date";

    IF "To Storage Date" &lt;&gt; 0D THEN
      StorageInvEntry."Last Invoice Date" := "To Storage Date"
    ELSE
      StorageInvEntry."Last Invoice Date" := WORKDATE;

    Date.SETRANGE("Period Type", Date."Period Type"::Datum);
    Date.SETRANGE("Period No.", 1, 5);
    Date.SETRANGE("Period Start", FromDate, 
      StorageInvEntry."Last Invoice Date");
    IncExp."Entry No." := 0;
    IncExp."Income &amp; Expense Code" := "Income &amp; Expense Code";
    IncExp.Type := IncExp.Type::Income;
    IncExp.Description := STRSUBSTNO(Text000, FromDate, 
      StorageInvEntry."Last Invoice Date");
    IncExp.Quantity := Date.COUNT;
    IncExp."Unit Cost" := "Unit Cost";
    IncExp."Total Cost" := IncExp.Quantity * "Total Cost";
    IncExp."Unit Price" := "Unit Price";
    IncExp."Total Price" := IncExp.Quantity * "Unit Price";
    IncExp."Global Dimension 1 Code" := 
      "Global Dimension 1 Code";
    IncExp."Global Dimension 2 Code" := 
      "Global Dimension 2 Code";
    IncExp."Bill-to Customer No." := "Bill-to Customer No.";
    IncExpCode.GET(IncExp."Income &amp; Expense Code");
    IncExp."Gen. Prod. Posting Group" := 
      IncExpCode."Gen. Prod. Posting Group";
    IncExp."VAT Prod. Posting Group" := 
      IncExpCode."VAT Prod. Posting Group";
    IncExp."Unit of Measure Code" := 
       IncExpCode."Unit of Measure Code";
    IncExp."Applies-to Entry No." := "Entry No.";
    IncExp.INSERT;
    
    StorageInvEntry.Open := "To Storage Date" &lt;&gt; 0D;
    StorageInvEntry.MODIFY;
  UNTIL NEXT = 0;</pre></div><p>The next step in our code is to calculate the number of workdays between the two dates. This will prevent <a class="indexterm" id="id1054"/>our customer from paying for storage on Saturday and Sunday. We do this by using the virtual date table. This table contains all dates, weeks, months, quarters and years between January 1 0000 and December 31 9999 and can be very useful in date calculations.</p><p>With this result, we can now create the Income &amp; Expense records that will be invoiced later. If the <span class="strong"><strong>To Storage Date</strong></span> is populated, we close the Storage Invoice Entry.</p></div></div><div class="section" title="Combined invoicing"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec159"/>Combined invoicing</h2></div></div></div><p>The <a class="indexterm" id="id1055"/>data model we use allows us to combine invoicing<a class="indexterm" id="id1056"/> on all the services we provide for our customers. We can create one invoice that contains handling, storage, and transportation costs for our customers.</p><p>This is done by batch report 123456704 Combine Storage &amp; Logistics, which works exactly the same as the report in <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <span class="emphasis"><em>A Sample Application</em></span>.</p></div></div>
<div class="section" title="Add-on flexibility"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec55"/>Add-on flexibility</h1></div></div></div><p>The add-on <a class="indexterm" id="id1057"/>we have created in this chapter is definitely not ready to be used by a real company but it demonstrates how to create a flexible solution that can be easily expanded by others.</p><p>Most modern logistic service providers offer other services to customers, such as value-added logistics, item tracking, and third- and fourth-party logistics.</p><div class="section" title="Value-added logistics"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec160"/>Value-added logistics</h2></div></div></div><p>When a<a class="indexterm" id="id1058"/> company offers value-added logistics services, they not only keep products on inventory but they also offer services around this, such as display packaging.</p><p>This can be best compared with manufacturing in Microsoft Dynamics NAV. A list of items called a bill of materials is combined into a new product. This new product is then shipped to the customer.</p><p>When the displays are no longer necessary, for example, when a marketing campaign is finished, the displays need to be picked up from the customer and disassembled into the original products.</p><div class="mediaobject"><img alt="Value-added logistics" src="graphics/0365EN_07_36.jpg"/></div><p>In our solution, this <a class="indexterm" id="id1059"/>could be implemented by creating a VAL region where the products are moved to.</p></div><div class="section" title="Item tracking"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec161"/>Item tracking</h2></div></div></div><p>Our <a class="indexterm" id="id1060"/>customers also want to know the whereabouts of their products, which warehouse they are in, and which product was shipped to which customer. This is especially important in the food and medicine industry to be able to call back a lot, if something is wrong.</p><p>To implement this in our solution, it requires some changes. First, we need to implement a Tracking Code in the Storage Entries, and secondly, we need to implement some kind of Tracking Entries when we ship a product outside our warehouse since our logistics solution currently does not have any entries, only status fields.</p><div class="mediaobject"><img alt="Item tracking" src="graphics/0365EN_07_37.jpg"/></div></div><div class="section" title="Third- and fourth-party logistics"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec162"/>Third- and fourth-party logistics</h2></div></div></div><p>In our example <a class="indexterm" id="id1061"/>database, we plan shipments on routes and drive <a class="indexterm" id="id1062"/>them to the end customer with our own trucks. This is called second-party logistics. First-party logistics would be if we were to handle our own products with our own trucks.</p><p>The following figure shows the increasing complexity of logistics if it gets outsourced and combined:</p><div class="mediaobject"><img alt="Third- and fourth-party logistics" src="graphics/0365EN_07_38.jpg"/></div><p>If we provide <a class="indexterm" id="id1063"/>third-party logistics, we would use other companies to offer parts of the services to our customers. We will then tell them which part of the service to handle and report back to us when it is finished. The third party involved does not know the details of the complete transaction.</p><p>If we offer <a class="indexterm" id="id1064"/>fourth-party logistics, we would outsource a complete warehouse or route to another company. We would only tell them which product should be moved where and they would handle it, without us knowing the details.</p><p>Very often, third- and fourth-party logistics are mixed but they are usually handled by interfaces between different companies.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec56"/>Summary</h1></div></div></div><p>In this chapter, we looked at the Microsoft Dynamics NAV product from a completely different viewpoint compared to the previous chapters.</p><p>The goal was not to design a rock-solid storage and logistics add-on solution for Microsoft Dynamics NAV as this would require much more than one chapter. The information in this chapter is intended to demonstrate how to integrate new functionality on top of Microsoft Dynamics NAV. We analyzed business processes and designed new data and transaction models to handle them in the product and implemented this.</p><p>For our solution, we designed two new document structures and two new journals and entry structures. We stayed close to the standard methodology of Microsoft Dynamics NAV by creating a framework that can easily be expanded. We also spend some time looking at how to prevent unnecessary locking in the database and how to avoid changing a filtered dataset.</p><p>Finally, we looked at some examples of how our add-on solution can be enhanced to better suit other demands in the market.</p><p>This chapter does not end here. The C/AL objects provided with this chapter can be studied in order to understand even better how the pieces are put together.</p><p>In the next chapter, we will design an application inside Microsoft Dynamics NAV. We will look at how it can be used for a consultancy company using the Jobs module and extending this with new functionality to meet specific requirements.</p></div></body></html>