<html><head></head><body>
<div id="_idContainer160">
<h1 class="chapter-number" id="_idParaDest-260"><a id="_idTextAnchor259"/><span class="koboSpan" id="kobo.1.1">12</span></h1>
<h1 id="_idParaDest-261"><a id="_idTextAnchor260"/><span class="koboSpan" id="kobo.2.1">Code Analysis in Visual Studio</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Thus far, we’ve covered how to refactor our code in a safe, effective, reliable, and </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">productive manner.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In this chapter, we’ll determine areas of code that might need refactoring using code metrics and code analysis tools. </span><span class="koboSpan" id="kobo.5.2">Along the way, we’ll cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.7.1">Calculating code metrics in </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">Visual Studio</span></span></li>
<li><span class="koboSpan" id="kobo.9.1">Performing code analysis in </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">Visual Studio</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Exploring advanced code </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">analysis tools</span></span></li>
</ul>
<h1 id="_idParaDest-262"><a id="_idTextAnchor261"/><span class="koboSpan" id="kobo.13.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.14.1">The starting code for this chapter is available from GitHub at </span><a href="https://github.com/PacktPublishing/Refactoring-with-CSharp"><span class="koboSpan" id="kobo.15.1">https://github.com/PacktPublishing/Refactoring-with-CSharp</span></a><span class="koboSpan" id="kobo.16.1"> in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.17.1">Chapter12/Ch12BeginningCode</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.18.1"> folder.</span></span></p>
<h1 id="_idParaDest-263"><a id="_idTextAnchor262"/><span class="koboSpan" id="kobo.19.1">Calculating code metrics in Visual Studio</span></h1>
<p><span class="koboSpan" id="kobo.20.1">Every codebase I’ve ever </span><a id="_idIndexMarker715"/><span class="koboSpan" id="kobo.21.1">worked with has had a few maintainability hot spots. </span><span class="koboSpan" id="kobo.21.2">These are areas that are frequently changed, have a higher degree of complexity than </span><a id="_idIndexMarker716"/><span class="koboSpan" id="kobo.22.1">other areas of code, and represent serious quality risks to the </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">software project.</span></span></p>
<p><span class="koboSpan" id="kobo.24.1">These areas are usually some of the most critical to refactor and they tend to be easily discoverable using </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.25.1">code metrics</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.27.1">Code metrics calculate a handful of useful statistics about every file, class, method, and property in your C# code. </span><span class="koboSpan" id="kobo.27.2">This lets you spot hot spots in your code that have significantly higher complexity or lower maintainability. </span><span class="koboSpan" id="kobo.27.3">Code metrics can even help you find classes that are too large and likely violate the Single Responsibility Principle (SRP) as we discussed in </span><a href="B21324_08.xhtml#_idTextAnchor173"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.28.1">Chapter 8</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.29.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.30.1">To calculate code metrics, open your solution in Visual Studio and then click the </span><strong class="bold"><span class="koboSpan" id="kobo.31.1">Analyze</span></strong><span class="koboSpan" id="kobo.32.1"> menu, followed by </span><strong class="bold"><span class="koboSpan" id="kobo.33.1">Calculate Code Metrics</span></strong><span class="koboSpan" id="kobo.34.1">, and then </span><strong class="bold"><span class="koboSpan" id="kobo.35.1">For Solution</span></strong><span class="koboSpan" id="kobo.36.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.37.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.38.1">.1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer143">
<span class="koboSpan" id="kobo.40.1"><img alt="Figure 12.1 – Calculating code metrics" src="image/B21324_12_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.41.1">Figure 12.1 – Calculating code metrics</span></p>
<p><span class="koboSpan" id="kobo.42.1">This will open the </span><strong class="bold"><span class="koboSpan" id="kobo.43.1">Code Metrics Results</span></strong><span class="koboSpan" id="kobo.44.1"> pane, as </span><a id="_idIndexMarker717"/><span class="koboSpan" id="kobo.45.1">shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.46.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.47.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">:</span></span></p>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer144">
<span class="koboSpan" id="kobo.49.1"><img alt="Figure 12.2 – Code Metrics Results" src="image/B21324_12_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.50.1">Figure 12.2 – Code Metrics Results</span></p>
<p><span class="koboSpan" id="kobo.51.1">This pane displays a</span><a id="_idIndexMarker718"/><span class="koboSpan" id="kobo.52.1"> hierarchical view of your solution, along with the following </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">six metrics:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.54.1">Lines of Source Code</span></strong><span class="koboSpan" id="kobo.55.1">: The number of lines of code for the class </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">or method.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.57.1">Lines of Executable Code</span></strong><span class="koboSpan" id="kobo.58.1">: The lines of source code that ignore blank lines </span><span class="No-Break"><span class="koboSpan" id="kobo.59.1">and comments.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.60.1">Cyclomatic Complexity</span></strong><span class="koboSpan" id="kobo.61.1">: A metric that specifies the unique number of paths that exist through your code. </span><span class="koboSpan" id="kobo.61.2">Each </span><strong class="source-inline"><span class="koboSpan" id="kobo.62.1">if</span></strong><span class="koboSpan" id="kobo.63.1"> statement, loop, switch case, and similar type of branching instruction increases this </span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">by 1.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.65.1">Maintainability Index</span></strong><span class="koboSpan" id="kobo.66.1">: A calculated </span><a id="_idIndexMarker719"/><span class="koboSpan" id="kobo.67.1">value based on cyclomatic complexity, lines of code, and the number </span><a id="_idIndexMarker720"/><span class="koboSpan" id="kobo.68.1">of operations performed in a method. </span><span class="koboSpan" id="kobo.68.2">This value ranges from 0 to 100, indicating how maintainable your code is. </span><span class="koboSpan" id="kobo.68.3">Values from 0 to 9 are bad, 10 to 20 are warning areas, and 21 and above are areas </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">to watch.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.70.1">Depth of Inheritance</span></strong><span class="koboSpan" id="kobo.71.1">: The number of classes this class inherits from before it reaches </span><strong class="source-inline"><span class="koboSpan" id="kobo.72.1">System.Object</span></strong><span class="koboSpan" id="kobo.73.1">, which all classes ultimately </span><span class="No-Break"><span class="koboSpan" id="kobo.74.1">inherit from.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.75.1">Class Coupling</span></strong><span class="koboSpan" id="kobo.76.1">: The number of other classes your code </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">depends on.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.78.1">Each of these metrics is useful individually, but together, they tell a </span><span class="No-Break"><span class="koboSpan" id="kobo.79.1">broader picture.</span></span></p>
<p><span class="koboSpan" id="kobo.80.1">The maintainability index gives you a quick metric for an area of code. </span><span class="koboSpan" id="kobo.80.2">Unlike other columns, which sum up values for all code in a class, namespace, or project, the maintainability index acts as an average, which can help you quickly drill into </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">problem areas.</span></span></p>
<p><span class="koboSpan" id="kobo.82.1">Cyclomatic complexity can identify areas that are hard to test or hard to understand since it identifies the number of distinct paths through a method. </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.83.1">Figure 12</span></em></span><em class="italic"><span class="koboSpan" id="kobo.84.1">.3 </span></em><span class="koboSpan" id="kobo.85.1">illustrates a cyclomatic complexity of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.86.1">CalculatePrice</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.87.1"> method:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer145">
<span class="koboSpan" id="kobo.88.1"><img alt="Figure 12.3 – Calculating cyclomatic complexity" src="image/B21324_12_3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.89.1">Figure 12.3 – Calculating cyclomatic complexity</span></p>
<p><span class="koboSpan" id="kobo.90.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.91.1">CalculatePrice</span></strong><span class="koboSpan" id="kobo.92.1"> method has a cyclomatic complexity of 4. </span><span class="koboSpan" id="kobo.92.2">All methods start with a cyclomatic complexity of 1, representing a single path through the method. </span><span class="koboSpan" id="kobo.92.3">Each branching statement, such as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">if</span></strong><span class="koboSpan" id="kobo.94.1"> statements here, increments the cyclomatic complexity by 1, resulting in a total </span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">of 4.</span></span></p>
<p><span class="koboSpan" id="kobo.96.1">I find cyclomatic complexity to be generally useful and try to keep this as low as possible. </span><span class="koboSpan" id="kobo.96.2">Keep in mind that cyclomatic complexity is biased against methods that use </span><strong class="source-inline"><span class="koboSpan" id="kobo.97.1">switch</span></strong><span class="koboSpan" id="kobo.98.1"> statements since </span><a id="_idIndexMarker721"/><span class="koboSpan" id="kobo.99.1">each </span><strong class="source-inline"><span class="koboSpan" id="kobo.100.1">case</span></strong><span class="koboSpan" id="kobo.101.1"> statement adds to the complexity. </span><span class="koboSpan" id="kobo.101.2">Simple </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">switch</span></strong><span class="koboSpan" id="kobo.103.1"> statements with</span><a id="_idIndexMarker722"/><span class="koboSpan" id="kobo.104.1"> only a line or two of code are generally not hard to maintain, so treat cyclomatic complexity as only one indicator of code quality. </span><span class="koboSpan" id="kobo.104.2">Microsoft recommends a maximum cyclomatic complexity of 10 for each method, but in my experience, I tend to be happiest with a cyclomatic complexity of 7 </span><span class="No-Break"><span class="koboSpan" id="kobo.105.1">or less.</span></span></p>
<p><span class="koboSpan" id="kobo.106.1">Depth of inheritance and class coupling can help you identify places where you may be over-using inheritance or have too high of coupling to other classes, as we covered in </span><a href="B21324_08.xhtml#_idTextAnchor173"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.107.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.108.1">. </span><span class="koboSpan" id="kobo.108.2">Microsoft encourages a maximum depth of inheritance of 6 and a maximum class coupling </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">of 9.</span></span></p>
<p><span class="koboSpan" id="kobo.110.1">The lines of code metrics are quite useful. </span><span class="koboSpan" id="kobo.110.2">I find that having many lines of code in a class is frequently one of the greatest signs that a class violates the SRP and needs to be refactored. </span><span class="koboSpan" id="kobo.110.3">Similarly, if a method is too large, it’s usually hard to understand, maintain, </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">and test.</span></span></p>
<p><span class="koboSpan" id="kobo.112.1">I try to keep classes under 200 lines of code and methods to 20 lines or less. </span><span class="koboSpan" id="kobo.112.2">In both cases, I look for things I can pull out of the method or class and am hesitant to expand an already large class or method with new logic unless I can pull logic out of the </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">code first.</span></span></p>
<p><span class="koboSpan" id="kobo.114.1">Keep in mind that these are general guidelines I’ve found generally effective. </span><span class="koboSpan" id="kobo.114.2">These are not concrete rules that you</span><a id="_idIndexMarker723"/><span class="koboSpan" id="kobo.115.1"> must </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">always follow.</span></span></p>
<p><span class="koboSpan" id="kobo.117.1">I encourage you to spend</span><a id="_idIndexMarker724"/><span class="koboSpan" id="kobo.118.1"> some time looking over code metrics for the sample code for this chapter or some code you maintain. </span><span class="koboSpan" id="kobo.118.2">In the case of the code for this chapter, I’m most concerned about the </span><span class="No-Break"><span class="koboSpan" id="kobo.119.1">following methods:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.120.1">BaggageCalculator.CalculatePrice</span></strong><span class="koboSpan" id="kobo.121.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">Flight.Baggage</span></strong><span class="koboSpan" id="kobo.123.1"> namespace has a maintainability index of 58, cyclomatic complexity of 4, and 26 lines of </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">source code</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">FlightScheduler.Search</span></strong><span class="koboSpan" id="kobo.126.1">, which takes in a </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">FlightSearch</span></strong><span class="koboSpan" id="kobo.128.1"> object in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.129.1">Flight.Scheduling</span></strong><span class="koboSpan" id="kobo.130.1"> namespace, has a maintainability index of 48, a cyclomatic complexity of 9, a class coupling of 11, and 37 lines of </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">source code</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.132.1">Both methods are flagged by the metrics because they have several </span><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">if</span></strong><span class="koboSpan" id="kobo.134.1"> statements that they need to run. </span><span class="koboSpan" id="kobo.134.2">Neither method is very complex, but at the same time, if either needs to grow significantly more, I’d like to see refactorings like the ones we applied in </span><a href="B21324_05.xhtml#_idTextAnchor101"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.135.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.136.1"> to move complexity out of these methods and into </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">other objects.</span></span></p>
<p><span class="koboSpan" id="kobo.138.1">Now that we’ve covered code metrics, let’s see how code analysis can give us another way of looking at </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">our code.</span></span></p>
<h1 id="_idParaDest-264"><a id="_idTextAnchor263"/><span class="koboSpan" id="kobo.140.1">Performing code analysis in Visual Studio</span></h1>
<p><span class="koboSpan" id="kobo.141.1">Microsoft knows that as</span><a id="_idIndexMarker725"/><span class="koboSpan" id="kobo.142.1"> C# and .NET changes, it can</span><a id="_idIndexMarker726"/><span class="koboSpan" id="kobo.143.1"> be very difficult to keep up with evolving standards in a broad and </span><span class="No-Break"><span class="koboSpan" id="kobo.144.1">changing language.</span></span></p>
<p><span class="koboSpan" id="kobo.145.1">To address this, Microsoft gave us tools beyond code metrics in the form of analyzers that inspect our C# code for issues. </span><span class="koboSpan" id="kobo.145.2">These analyzers look at our code and flag potential issues and optimizations. </span><span class="koboSpan" id="kobo.145.3">This</span><a id="_idIndexMarker727"/><span class="koboSpan" id="kobo.146.1"> helps ensure our code complies with </span><a id="_idIndexMarker728"/><span class="koboSpan" id="kobo.147.1">standards and is secure, reliable, </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">and maintainable.</span></span></p>
<h2 id="_idParaDest-265"><a id="_idTextAnchor264"/><span class="koboSpan" id="kobo.149.1">Analyzing your solution using the default ruleset</span></h2>
<p><span class="koboSpan" id="kobo.150.1">To see an analyzer in</span><a id="_idIndexMarker729"/><span class="koboSpan" id="kobo.151.1"> action, build this chapter’s solution in Visual Studio and notice the three warnings that appear in the </span><strong class="bold"><span class="koboSpan" id="kobo.152.1">Output</span></strong><span class="koboSpan" id="kobo.153.1"> pane, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.154.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.155.1">.4</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer146">
<span class="koboSpan" id="kobo.157.1"><img alt="Figure 12.4 – An overview of the build results showing warnings" src="image/B21324_12_4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.158.1">Figure 12.4 – An overview of the build results showing warnings</span></p>
<p><span class="koboSpan" id="kobo.159.1">These three lines represent separate compiler warnings for the CS8618 code analysis rule, which we’ll look </span><span class="No-Break"><span class="koboSpan" id="kobo.160.1">at shortly.</span></span></p>
<p><span class="koboSpan" id="kobo.161.1">Before we do that, click on the </span><strong class="bold"><span class="koboSpan" id="kobo.162.1">View</span></strong><span class="koboSpan" id="kobo.163.1"> menu and then select </span><strong class="bold"><span class="koboSpan" id="kobo.164.1">Error List</span></strong><span class="koboSpan" id="kobo.165.1">. </span><span class="koboSpan" id="kobo.165.2">You should see the same warnings formatted in an easier-to-read manner, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.166.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.167.1">.5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer147">
<span class="koboSpan" id="kobo.169.1"><img alt="Figure 12.5 – An overview of the compiler warnings in Error List" src="image/B21324_12_5.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.170.1">Figure 12.5 – An overview of the compiler warnings in Error List</span></p>
<p><span class="koboSpan" id="kobo.171.1">If these warnings don’t show up, make sure the </span><strong class="bold"><span class="koboSpan" id="kobo.172.1">Errors</span></strong><span class="koboSpan" id="kobo.173.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.174.1">Warnings</span></strong><span class="koboSpan" id="kobo.175.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.176.1">Messages</span></strong><span class="koboSpan" id="kobo.177.1"> buttons are checked, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.178.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.179.1">.5</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.180.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.181.1">Since these warnings are all associated with </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">Airport.cs</span></strong><span class="koboSpan" id="kobo.183.1">, let’s review </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">its code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.185.1">
public class Airport {
</span><strong class="bold"><span class="koboSpan" id="kobo.186.1">  public string Country { get; set; }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.187.1">  public string Code { get; set; }</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.188.1">  public string Name { get; set; }</span></strong><span class="koboSpan" id="kobo.189.1">
  // Non-relevant code omitted...
</span><span class="koboSpan" id="kobo.189.2">}</span></pre>
<p><span class="koboSpan" id="kobo.190.1">When looking at this</span><a id="_idIndexMarker730"/><span class="koboSpan" id="kobo.191.1"> code in Visual Studio, you’ll see a “green squiggly” underneath each of these three properties. </span><span class="koboSpan" id="kobo.191.2">As shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.192.1">Figure 12</span></em></span><em class="italic"><span class="koboSpan" id="kobo.193.1">.6</span></em><span class="koboSpan" id="kobo.194.1">, hovering the mouse cursor over any of these “squigglies” shows details about the warning </span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">or suggestion:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer148">
<span class="koboSpan" id="kobo.196.1"><img alt="Figure 12.6 – The CS8618 compiler warning associated with the Name property" src="image/B21324_12_6.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.197.1">Figure 12.6 – The CS8618 compiler warning associated with the Name property</span></p>
<p><span class="koboSpan" id="kobo.198.1">In this case, the warning tells us that these three properties are non-nullable, meaning that they are declared as </span><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">string</span></strong><span class="koboSpan" id="kobo.200.1"> instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">string?</span></strong><span class="koboSpan" id="kobo.202.1">, as we discussed in </span><a href="B21324_10.xhtml#_idTextAnchor209"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.203.1">Chapter 10</span></em></span></a><span class="koboSpan" id="kobo.204.1"> when discussing </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">nullability analysis.</span></span></p>
<p><span class="koboSpan" id="kobo.206.1">Since the default value for any </span><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">string</span></strong><span class="koboSpan" id="kobo.208.1"> property in .NET is null and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.209.1">Airport</span></strong><span class="koboSpan" id="kobo.210.1"> class doesn’t have any logic to initialize these three properties, the compiler warning is telling us that when </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">Airport</span></strong><span class="koboSpan" id="kobo.212.1"> instances are created, they’ll have null values in properties we told it couldn’t </span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">be null!</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.214.1">Nullability analysis in .NET</span></p>
<p class="callout"><span class="koboSpan" id="kobo.215.1">Remember that although strings are</span><a id="_idIndexMarker731"/><span class="koboSpan" id="kobo.216.1"> reference types and can be null, nullability analysis in C# indicates if a property is expected to have a null value at any point in</span><a id="_idIndexMarker732"/><span class="koboSpan" id="kobo.217.1"> time. </span><span class="koboSpan" id="kobo.217.2">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.218.1">string</span></strong><span class="koboSpan" id="kobo.219.1"> type indicator means that we never expect these properties to have a null value. </span><span class="koboSpan" id="kobo.219.2">On the other hand, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">string?</span></strong><span class="koboSpan" id="kobo.221.1"> type indicator would indicate that we might expect null values. </span><span class="koboSpan" id="kobo.221.2">See </span><a href="B21324_10.xhtml#_idTextAnchor209"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.222.1">Chapter 10</span></em></span></a><span class="koboSpan" id="kobo.223.1"> for more information on nullability analysis </span><span class="No-Break"><span class="koboSpan" id="kobo.224.1">in C#.</span></span></p>
<p><span class="koboSpan" id="kobo.225.1">There are a few ways to address this </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">compiler warning:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.227.1">Default these properties to an </span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">empty string</span></span></li>
<li><span class="koboSpan" id="kobo.229.1">Change these properties to </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">string?</span></strong><span class="koboSpan" id="kobo.231.1"> instead </span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">string</span></strong></span></li>
<li><span class="koboSpan" id="kobo.234.1">Add a constructor</span><a id="_idIndexMarker733"/><span class="koboSpan" id="kobo.235.1"> that sets these properties to </span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">non-null values</span></span></li>
<li><span class="koboSpan" id="kobo.237.1">Mark these properties as </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">required</span></strong><span class="koboSpan" id="kobo.239.1"> so that they must be set </span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">on creation</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.241.1">As shown here, the </span><a id="_idIndexMarker734"/><span class="koboSpan" id="kobo.242.1">simplest fix is to mark</span><a id="_idIndexMarker735"/><span class="koboSpan" id="kobo.243.1"> these properties </span><span class="No-Break"><span class="koboSpan" id="kobo.244.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">required</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.246.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.247.1">
public class Airport {
  public </span><strong class="bold"><span class="koboSpan" id="kobo.248.1">required</span></strong><span class="koboSpan" id="kobo.249.1"> string Country { get; set; }
  public </span><strong class="bold"><span class="koboSpan" id="kobo.250.1">required</span></strong><span class="koboSpan" id="kobo.251.1"> string Code { get; set; }
  public </span><strong class="bold"><span class="koboSpan" id="kobo.252.1">required</span></strong><span class="koboSpan" id="kobo.253.1"> string Name { get; set; }
  // Non-relevant code omitted...
</span><span class="koboSpan" id="kobo.253.2">}</span></pre>
<p><span class="koboSpan" id="kobo.254.1">This resolves the three code analysis warnings, leaving two less severe suggestions for us to investigate, both dealing with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">Equals</span></strong><span class="koboSpan" id="kobo.256.1"> method </span><span class="No-Break"><span class="koboSpan" id="kobo.257.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.258.1">Airport</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.260.1">
public override bool Equals(object? </span><span class="koboSpan" id="kobo.260.2">obj) {
  Airport? </span><span class="koboSpan" id="kobo.260.3">otherAirport = obj as Airport;
  if (otherAirport == null)
    return false;
  string otherName = otherAirport.Name;
  string otherCountry = otherAirport.Country;
  string otherCode = otherAirport.Code;
  return Country == otherCountry &amp;&amp;
          Code == otherCode;
}</span></pre>
<p><span class="koboSpan" id="kobo.261.1">The first warning is IDE0019, which</span><a id="_idIndexMarker736"/><span class="koboSpan" id="kobo.262.1"> suggests using pattern matching when declaring </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">otherAirport</span></strong><span class="koboSpan" id="kobo.264.1">. </span><span class="koboSpan" id="kobo.264.2">Thankfully, this analyzer provides a </span><strong class="bold"><span class="koboSpan" id="kobo.265.1">Quick Action</span></strong><span class="koboSpan" id="kobo.266.1"> to </span><a id="_idIndexMarker737"/><span class="koboSpan" id="kobo.267.1">resolve the suggestion. </span><span class="koboSpan" id="kobo.267.2">Hovering over the three</span><a id="_idIndexMarker738"/><span class="koboSpan" id="kobo.268.1"> dots underneath the </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">Airport?</span></strong><span class="koboSpan" id="kobo.270.1"> type reveals the </span><strong class="bold"><span class="koboSpan" id="kobo.271.1">Use pattern matching</span></strong> <strong class="bold"><span class="koboSpan" id="kobo.272.1">Quick Action</span></strong><span class="koboSpan" id="kobo.273.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.274.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.275.1">.7</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.276.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer149">
<span class="koboSpan" id="kobo.277.1"><img alt="Figure 12.7 – Applying the Use pattern matching refactoring" src="image/B21324_12_7.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.278.1">Figure 12.7 – Applying the Use pattern matching refactoring</span></p>
<p><span class="koboSpan" id="kobo.279.1">Applying this refactoring resolves the suggestion and makes our code </span><span class="No-Break"><span class="koboSpan" id="kobo.280.1">more concise:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.281.1">
if (</span><strong class="bold"><span class="koboSpan" id="kobo.282.1">obj is not Airport otherAirport</span></strong><span class="koboSpan" id="kobo.283.1">)
      return false;</span></pre>
<p><span class="koboSpan" id="kobo.284.1">The last remaining warning is </span><em class="italic"><span class="koboSpan" id="kobo.285.1">IDE0059: Unnecessary assignment of a value to ‘otherName’</span></em><span class="koboSpan" id="kobo.286.1">. </span><span class="koboSpan" id="kobo.286.2">This highlights that we’ve declared a variable and assigned a value to that variable but never used the variable after that point, as shown here </span><span class="No-Break"><span class="koboSpan" id="kobo.287.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">otherName</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.289.1">:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.290.1">string otherName = otherAirport.Name;</span></strong><span class="koboSpan" id="kobo.291.1">
string otherCountry = otherAirport.Country;
string otherCode = otherAirport.Code;
return Country == otherCountry &amp;&amp;
        Code == otherCode;</span></pre>
<p><span class="koboSpan" id="kobo.292.1">Looking at this code, it’s a toss-up as to whether </span><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">otherName</span></strong><span class="koboSpan" id="kobo.294.1"> should be included in the equality check or if the variable is simply not needed. </span><span class="koboSpan" id="kobo.294.2">In this case, you might ask a business stakeholder if an airport could ever have multiple names but be the same airport. </span><span class="koboSpan" id="kobo.294.3">If you get a “yes,” then</span><a id="_idIndexMarker739"/><span class="koboSpan" id="kobo.295.1"> the fix would be to remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">otherName</span></strong><span class="koboSpan" id="kobo.297.1"> variable, while a “no” would indicate</span><a id="_idIndexMarker740"/><span class="koboSpan" id="kobo.298.1"> that a </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">Name</span></strong><span class="koboSpan" id="kobo.300.1"> check should be added to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">return</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.302.1"> statement.</span></span></p>
<p><span class="koboSpan" id="kobo.303.1">The correct fix for code issues</span><a id="_idIndexMarker741"/><span class="koboSpan" id="kobo.304.1"> is not always obvious without gathering more information about the business domain </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">you’re modeling.</span></span></p>
<h2 id="_idParaDest-266"><a id="_idTextAnchor265"/><span class="koboSpan" id="kobo.306.1">Configuring code analysis rulesets</span></h2>
<p><span class="koboSpan" id="kobo.307.1">There are a large and</span><a id="_idIndexMarker742"/><span class="koboSpan" id="kobo.308.1"> growing number of analyzers in .NET and not every analyzer shares the same levels of importance. </span><span class="koboSpan" id="kobo.308.2">Because of this, Microsoft provides different sets of analyzers so that you can start with a small subset of the most useful ones and gradually expand into additional sets of analyzers as your </span><span class="No-Break"><span class="koboSpan" id="kobo.309.1">maturity grows.</span></span></p>
<p><span class="koboSpan" id="kobo.310.1">Let’s look at our code analysis settings for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">Chapter12</span></strong><span class="koboSpan" id="kobo.312.1"> project by right-clicking on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">Chapter12</span></strong><span class="koboSpan" id="kobo.314.1"> project in </span><strong class="bold"><span class="koboSpan" id="kobo.315.1">Solution Explorer</span></strong><span class="koboSpan" id="kobo.316.1"> and then </span><span class="No-Break"><span class="koboSpan" id="kobo.317.1">selecting </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.318.1">Properties</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.320.1">This will open the properties view of the project. </span><span class="koboSpan" id="kobo.320.2">This view lists all configurable properties associated with the project and can be scrolled through from top to bottom or navigated using the navigation pane on the </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">left-hand side.</span></span></p>
<p><span class="koboSpan" id="kobo.322.1">Click on </span><strong class="bold"><span class="koboSpan" id="kobo.323.1">Code Analysis</span></strong><span class="koboSpan" id="kobo.324.1"> in the navigation pane; you should see the project’s code analysis settings, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.325.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.326.1">.8</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.327.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer150">
<span class="koboSpan" id="kobo.328.1"><img alt="Figure 12.8 – Code Analysis settings for the project" src="image/B21324_12_8.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.329.1">Figure 12.8 – Code Analysis settings for the project</span></p>
<p><span class="koboSpan" id="kobo.330.1">As you can see from the </span><strong class="bold"><span class="koboSpan" id="kobo.331.1">Run on build</span></strong><span class="koboSpan" id="kobo.332.1"> setting, the compiler will analyze code every time the project </span><span class="No-Break"><span class="koboSpan" id="kobo.333.1">is built.</span></span></p>
<p><span class="koboSpan" id="kobo.334.1">The exact set of analyzers used is </span><a id="_idIndexMarker743"/><span class="koboSpan" id="kobo.335.1">controlled by the </span><strong class="bold"><span class="koboSpan" id="kobo.336.1">Analysis level</span></strong><span class="koboSpan" id="kobo.337.1"> setting, which defaults to </span><strong class="bold"><span class="koboSpan" id="kobo.338.1">Latest</span></strong><span class="koboSpan" id="kobo.339.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">new projects.</span></span></p>
<p><span class="koboSpan" id="kobo.341.1">There is a wide variety of analysis rulesets supported by Visual Studio, but let’s focus on the four rulesets that start with “Latest” as these are the most recent rulesets available, and the patterns in these rules will help you understand the other rules options. </span><span class="koboSpan" id="kobo.341.2">These options are </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">as follows:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.343.1">Latest</span></strong><span class="koboSpan" id="kobo.344.1">: The default set of rules. </span><span class="koboSpan" id="kobo.344.2">This is a set of rules that is intended to be broadly applicable to any type </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">of project.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.346.1">Latest Minimum</span></strong><span class="koboSpan" id="kobo.347.1">: Everything in </span><strong class="bold"><span class="koboSpan" id="kobo.348.1">Latest</span></strong><span class="koboSpan" id="kobo.349.1"> plus additional rules. </span><span class="koboSpan" id="kobo.349.2">This represents the minimum set of rules that Microsoft recommends using in </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">a project.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.351.1">Latest Recommended</span></strong><span class="koboSpan" id="kobo.352.1">: Everything in </span><strong class="bold"><span class="koboSpan" id="kobo.353.1">Latest Minimum</span></strong><span class="koboSpan" id="kobo.354.1"> plus some additional rules. </span><span class="koboSpan" id="kobo.354.2">This contains a robust set of rules designed to help you maintain a business application that can run in any locale securely </span><span class="No-Break"><span class="koboSpan" id="kobo.355.1">and reliably.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.356.1">Latest All</span></strong><span class="koboSpan" id="kobo.357.1">: All available rules are enabled. </span><span class="koboSpan" id="kobo.357.2">Not every rule may be relevant for the application you’re trying to build, but it maximizes your chances of building a robust and </span><span class="No-Break"><span class="koboSpan" id="kobo.358.1">reliable application.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.359.1">Let’s see what happens when</span><a id="_idIndexMarker744"/><span class="koboSpan" id="kobo.360.1"> we change our project from </span><strong class="bold"><span class="koboSpan" id="kobo.361.1">Latest</span></strong><span class="koboSpan" id="kobo.362.1"> to </span><strong class="bold"><span class="koboSpan" id="kobo.363.1">Latest Recommended</span></strong><span class="koboSpan" id="kobo.364.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">then build.</span></span></p>
<h2 id="_idParaDest-267"><a id="_idTextAnchor266"/><span class="koboSpan" id="kobo.366.1">Responding to code analysis rules</span></h2>
<p><span class="koboSpan" id="kobo.367.1">After changing the</span><a id="_idIndexMarker745"/><span class="koboSpan" id="kobo.368.1"> project to use the </span><strong class="bold"><span class="koboSpan" id="kobo.369.1">Latest Recommended</span></strong><span class="koboSpan" id="kobo.370.1"> ruleset, three new warnings will appear, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.371.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.372.1">.9:</span></em></span></p>
<div>
<div class="IMG---Figure" id="_idContainer151">
<span class="koboSpan" id="kobo.373.1"><img alt="Figure 12.9 – New compiler warnings after moving to a stricter ruleset" src="image/B21324_12_9.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.374.1">Figure 12.9 – New compiler warnings after moving to a stricter ruleset</span></p>
<p><span class="koboSpan" id="kobo.375.1">Let’s start with the first warning. </span><span class="koboSpan" id="kobo.375.2">This corresponds to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">Flight</span></strong><span class="koboSpan" id="kobo.377.1"> class, which is currently defined in only a few lines </span><span class="No-Break"><span class="koboSpan" id="kobo.378.1">of code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.379.1">
public class Flight {
  public string BuildMessage(string id, string status) {
    return $"Flight {id} is {status}";
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.380.1">The CA1822 warning tells us </span><em class="italic"><span class="koboSpan" id="kobo.381.1">Member ‘BuildMessage’ does not access instance data and can be marked </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.382.1">as static</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.383.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.384.1">This analyzer is suggesting we make the </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">BuildMessage</span></strong><span class="koboSpan" id="kobo.386.1"> method </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">static</span></strong><span class="koboSpan" id="kobo.388.1"> because it doesn’t deal with any specific information from the overall </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">Flight</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.390.1"> class.</span></span></p>
<p><span class="koboSpan" id="kobo.391.1">In this case, making the method </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">static</span></strong><span class="koboSpan" id="kobo.393.1"> could make it easier to test and allow the compiler to make a few performance optimizations </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">as well.</span></span></p>
<p><span class="koboSpan" id="kobo.395.1">We could resolve this warning by performing the </span><em class="italic"><span class="koboSpan" id="kobo.396.1">Make method static</span></em><span class="koboSpan" id="kobo.397.1"> refactoring we covered in </span><a href="B21324_04.xhtml#_idTextAnchor072"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.398.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.399.1">, but instead, let’s explore suppressing </span><span class="No-Break"><span class="koboSpan" id="kobo.400.1">specific warnings.</span></span></p>
<p><span class="koboSpan" id="kobo.401.1">In this case, let’s say that we intend </span><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">BuildMessage</span></strong><span class="koboSpan" id="kobo.403.1"> to deal with instance-specific properties at some point in the future, but haven’t gotten there yet. </span><span class="koboSpan" id="kobo.403.2">Because of this, we want the warning to go away without making the </span><span class="No-Break"><span class="koboSpan" id="kobo.404.1">method static.</span></span></p>
<p><span class="koboSpan" id="kobo.405.1">Use the </span><strong class="bold"><span class="koboSpan" id="kobo.406.1">Quick Action</span></strong><span class="koboSpan" id="kobo.407.1"> menu on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">BuildMessage</span></strong><span class="koboSpan" id="kobo.409.1"> method and then select the </span><strong class="bold"><span class="koboSpan" id="kobo.410.1">Suppress or configure issues</span></strong><span class="koboSpan" id="kobo.411.1"> submenu. </span><span class="koboSpan" id="kobo.411.2">From there, choose </span><strong class="bold"><span class="koboSpan" id="kobo.412.1">Suppress CA1822</span></strong><span class="koboSpan" id="kobo.413.1">. </span><span class="koboSpan" id="kobo.413.2">This will reveal three</span><a id="_idIndexMarker746"/><span class="koboSpan" id="kobo.414.1"> different options for suppressing the issue, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.415.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.416.1">.10</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.417.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer152">
<span class="koboSpan" id="kobo.418.1"><img alt="Figure 12.10 – Options for suppressing the code analysis warnings" src="image/B21324_12_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.419.1">Figure 12.10 – Options for suppressing the code analysis warnings</span></p>
<p><span class="koboSpan" id="kobo.420.1">These options are </span><span class="No-Break"><span class="koboSpan" id="kobo.421.1">as follows:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.422.1">in Source</span></strong><span class="koboSpan" id="kobo.423.1">: This adds several </span><strong class="source-inline"><span class="koboSpan" id="kobo.424.1">#pragma</span></strong><span class="koboSpan" id="kobo.425.1"> statements above and below your code to disable the code analysis </span><span class="No-Break"><span class="koboSpan" id="kobo.426.1">warning temporarily</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.427.1">in Suppression File</span></strong><span class="koboSpan" id="kobo.428.1">: This creates a separate file with code telling code analysis not to care about this specific issue for this </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">specific method</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.430.1">in Source (attribute)</span></strong><span class="koboSpan" id="kobo.431.1">: This adds </span><strong class="source-inline"><span class="koboSpan" id="kobo.432.1">SuppressMessageAttribute</span></strong><span class="koboSpan" id="kobo.433.1"> above the method, suppressing the code </span><span class="No-Break"><span class="koboSpan" id="kobo.434.1">analysis issue</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.435.1">All three of these approaches will suppress the issue, but all do so in different styles. </span><span class="koboSpan" id="kobo.435.2">I generally prefer to avoid preprocessor directives such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">#pragma</span></strong><span class="koboSpan" id="kobo.437.1"> to have cleaner and more maintainable code. </span><span class="koboSpan" id="kobo.437.2">This leaves the suppression file and </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">attribute approaches.</span></span></p>
<p><span class="koboSpan" id="kobo.439.1">The advantage of a suppression file is that code analysis suppressions do not clutter your source code and instead live in a separate file. </span><span class="koboSpan" id="kobo.439.2">However, that’s also their disadvantage. </span><span class="koboSpan" id="kobo.439.3">By hiding away suppressions in another file, you reduce the odds of resolving them in the future since they’re “out of sight, out </span><span class="No-Break"><span class="koboSpan" id="kobo.440.1">of mind.”</span></span></p>
<p><span class="koboSpan" id="kobo.441.1">Using the </span><strong class="bold"><span class="koboSpan" id="kobo.442.1">in Source (attribute)</span></strong><span class="koboSpan" id="kobo.443.1"> approach and then adding a </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">using</span></strong><span class="koboSpan" id="kobo.445.1"> statement for </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">System.Diagnostic.CodeAnalysis</span></strong><span class="koboSpan" id="kobo.447.1"> results </span><a id="_idIndexMarker747"/><span class="koboSpan" id="kobo.448.1">in the </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">following file:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.450.1">using System.Diagnostics.CodeAnalysis;</span></strong><span class="koboSpan" id="kobo.451.1">
namespace Packt.CloudySkiesAir.Chapter12.Flight;
public class Flight {
</span><strong class="bold"><span class="koboSpan" id="kobo.452.1">  [SuppressMessage("Performance",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.453.1">    "CA1822:Mark members as static",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.454.1">    Justification = "Intend to work with instance data in future        release")]</span></strong><span class="koboSpan" id="kobo.455.1">
  public string BuildMessage(string id, string status) {
    return $"Flight {id} is {status}";
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.456.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.457.1">SuppressMessage</span></strong><span class="koboSpan" id="kobo.458.1"> attribute above the method marks the category of the code analysis issue as “Performance.” </span><span class="koboSpan" id="kobo.458.2">Next, it names the individual analysis rule being suppressed before providing </span><span class="No-Break"><span class="koboSpan" id="kobo.459.1">a justification.</span></span></p>
<p><span class="koboSpan" id="kobo.460.1">This justification is a string explaining to your coworkers (and future you) why you believe the code analysis rule should not be addressed at this time and should be excluded from the list of code </span><span class="No-Break"><span class="koboSpan" id="kobo.461.1">analysis results.</span></span></p>
<p><span class="koboSpan" id="kobo.462.1">I will never suppress a code analysis warning without providing a valid justification for the suppression. </span><span class="koboSpan" id="kobo.462.2">If a rule was important enough for someone to provide an analyzer for, it should either be resolved or I should have a valid justification for why I am choosing to ignore it. </span><span class="koboSpan" id="kobo.462.3">In case you were wondering, “I don’t feel like addressing it” is not a </span><span class="No-Break"><span class="koboSpan" id="kobo.463.1">valid justification.</span></span></p>
<p><span class="koboSpan" id="kobo.464.1">With the first warning out of the way, let’s look at the other two warnings together as </span><span class="No-Break"><span class="koboSpan" id="kobo.465.1">they’re related.</span></span></p>
<p><span class="koboSpan" id="kobo.466.1">The first warning is CA1305, which is associated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.467.1">DateHelpers</span></strong><span class="koboSpan" id="kobo.468.1"> class, as </span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.470.1">
public static class DateHelpers {
  public static string Format(this DateTime time) {
    return </span><strong class="bold"><span class="koboSpan" id="kobo.471.1">time.ToString("ddd MMM dd HH:mm tt")</span></strong><span class="koboSpan" id="kobo.472.1">;
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.473.1">This warning states that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">ToString</span></strong><span class="koboSpan" id="kobo.475.1"> call might result in a different result, depending on the user’s locale and</span><a id="_idIndexMarker748"/><span class="koboSpan" id="kobo.476.1"> language settings. </span><span class="koboSpan" id="kobo.476.2">My settings, as someone speaking English in the United States, may be different than someone running the same code with French as their </span><span class="No-Break"><span class="koboSpan" id="kobo.477.1">primary locale.</span></span></p>
<p><span class="koboSpan" id="kobo.478.1">The next warning is on </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">BuildFlightIdentifier</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.480.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">CharterFlightInfo</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.482.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.483.1">
public class CharterFlightInfo : FlightInfoBase {
  public List&lt;ICargoItem&gt; Cargo { get; } = new();
  public override string BuildFlightIdentifier() {
    StringBuilder sb = new(base.BuildFlightIdentifier());
    if (Cargo.Count != 0) {
      sb.Append(" carrying ");
      foreach (var cargo in Cargo) {
</span><strong class="bold"><span class="koboSpan" id="kobo.484.1">        sb.Append($"{cargo}, ");</span></strong><span class="koboSpan" id="kobo.485.1">
      }
    }
    return sb.ToString();
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.486.1">This warning is complaining about a similar localization issue stating that the behavior of </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">StringBuilder.Append</span></strong><span class="koboSpan" id="kobo.488.1"> could differ based on the </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">user’s locale.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.490.1">Recommended rules versus minimum and default rules</span></p>
<p class="callout"><span class="koboSpan" id="kobo.491.1">These formatting rules are examples of rules that are not relevant to all projects. </span><span class="koboSpan" id="kobo.491.2">These rules are not enabled in the default or minimum rulesets for a reason: not all applications you create will need to behave consistently, regardless of where they’re running. </span><span class="koboSpan" id="kobo.491.3">If you’re building a</span><a id="_idIndexMarker749"/><span class="koboSpan" id="kobo.492.1"> hobby application or an application that runs only on a single server or in your office, this rule probably isn’t important for you. </span><span class="koboSpan" id="kobo.492.2">However, if you’re building something that is distributed throughout the globe to customers of all cultures, this is going to be a rule you </span><span class="No-Break"><span class="koboSpan" id="kobo.493.1">care about.</span></span></p>
<p><span class="koboSpan" id="kobo.494.1">The fix for these two </span><a id="_idIndexMarker750"/><span class="koboSpan" id="kobo.495.1">warnings is to provide an explicit culture that you want to be used when formatting strings. </span><span class="koboSpan" id="kobo.495.2">This changes our append code to the </span><span class="No-Break"><span class="koboSpan" id="kobo.496.1">following line:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.497.1">
sb.Append(</span><strong class="bold"><span class="koboSpan" id="kobo.498.1">CultureInfo.InvariantCulture,</span></strong><span class="koboSpan" id="kobo.499.1"> $"{cargo}, ");</span></pre>
<p><span class="koboSpan" id="kobo.500.1">Our date formatting code changes in a </span><span class="No-Break"><span class="koboSpan" id="kobo.501.1">similar manner:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.502.1">CultureInfo culture = CultureInfo.InvariantCulture;</span></strong><span class="koboSpan" id="kobo.503.1">
return time.ToString("ddd MMM dd HH:mm tt", </span><strong class="bold"><span class="koboSpan" id="kobo.504.1">culture</span></strong><span class="koboSpan" id="kobo.505.1">);</span></pre>
<p><span class="koboSpan" id="kobo.506.1">With these changes made, we are now free of code analysis warnings. </span><span class="koboSpan" id="kobo.506.2">Let’s finish this section by looking at a way of making sure we stay free </span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">of warnings.</span></span></p>
<h2 id="_idParaDest-268"><a id="_idTextAnchor267"/><span class="koboSpan" id="kobo.508.1">Treating warnings as errors</span></h2>
<p><span class="koboSpan" id="kobo.509.1">I’ve met many developers who treat</span><a id="_idIndexMarker751"/><span class="koboSpan" id="kobo.510.1"> warnings like they treat speed limits while driving: they ignore them and cruise by at </span><span class="No-Break"><span class="koboSpan" id="kobo.511.1">unsafe speeds.</span></span></p>
<p><span class="koboSpan" id="kobo.512.1">There are a few ways of making sure developers ensure their code is free of warnings. </span><span class="koboSpan" id="kobo.512.2">Perhaps the easiest way of doing so is to tell the C# compiler to treat any warning as if it were a </span><span class="No-Break"><span class="koboSpan" id="kobo.513.1">compiler error.</span></span></p>
<p><span class="koboSpan" id="kobo.514.1">You can have the C# compiler treat all warnings as errors by right-clicking on the project and then selecting </span><strong class="bold"><span class="koboSpan" id="kobo.515.1">Properties</span></strong><span class="koboSpan" id="kobo.516.1">, as we did before. </span><span class="koboSpan" id="kobo.516.2">From there, expand </span><strong class="bold"><span class="koboSpan" id="kobo.517.1">Build</span></strong><span class="koboSpan" id="kobo.518.1"> in the navigation pane and then click </span><strong class="bold"><span class="koboSpan" id="kobo.519.1">Errors and warnings</span></strong><span class="koboSpan" id="kobo.520.1">. </span><span class="koboSpan" id="kobo.520.2">Once you do so, you should see something like </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.521.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.522.1">.11</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer153">
<span class="koboSpan" id="kobo.524.1"><img alt="Figure 12.11 – Configuring errors and warnings for a project" src="image/B21324_12_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.525.1">Figure 12.11 – Configuring errors and warnings for a project</span></p>
<p><span class="koboSpan" id="kobo.526.1">You can check </span><strong class="bold"><span class="koboSpan" id="kobo.527.1">Treat warnings as errors</span></strong><span class="koboSpan" id="kobo.528.1"> to have all warnings result </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">in errors.</span></span></p>
<p><span class="koboSpan" id="kobo.530.1">Since developers pay attention to things that stop their code from running at all, causing any warning to stop them from </span><a id="_idIndexMarker752"/><span class="koboSpan" id="kobo.531.1">building their code will certainly get their attention! </span><span class="koboSpan" id="kobo.531.2">Be careful when using this as they may not be very happy about the severity of </span><span class="No-Break"><span class="koboSpan" id="kobo.532.1">the interruption.</span></span></p>
<p><span class="koboSpan" id="kobo.533.1">A less extreme option is to configure the </span><strong class="bold"><span class="koboSpan" id="kobo.534.1">Treat specific warnings as errors</span></strong><span class="koboSpan" id="kobo.535.1"> setting and include the identifiers of specific warnings you believe should always </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">be addressed.</span></span></p>
<p><span class="koboSpan" id="kobo.537.1">For example, if we wanted to force developers to respond to suggestions of making methods </span><strong class="source-inline"><span class="koboSpan" id="kobo.538.1">static</span></strong><span class="koboSpan" id="kobo.539.1"> (CA1822), you could set the </span><strong class="bold"><span class="koboSpan" id="kobo.540.1">Suppress specific warnings</span></strong><span class="koboSpan" id="kobo.541.1"> value to </span><strong class="source-inline"><span class="koboSpan" id="kobo.542.1">$(WarningsAsErrors);NU1605;CA1822</span></strong><span class="koboSpan" id="kobo.543.1">; by doing so, any place where the warning occurred and was not suppressed would result in a </span><span class="No-Break"><span class="koboSpan" id="kobo.544.1">compiler error.</span></span></p>
<p><span class="koboSpan" id="kobo.545.1">Now that we’ve covered the code analysis features of Visual Studio, let’s take a look at a pair of additional options in the form of third-party tools that work well with </span><span class="No-Break"><span class="koboSpan" id="kobo.546.1">C# code.</span></span></p>
<h1 id="_idParaDest-269"><a id="_idTextAnchor268"/><span class="koboSpan" id="kobo.547.1">Exploring advanced code analysis tools</span></h1>
<p><span class="koboSpan" id="kobo.548.1">The built-in code analysis</span><a id="_idIndexMarker753"/><span class="koboSpan" id="kobo.549.1"> and code metrics tools are very good for engineers wanting to pinpoint bad code and ensure code follows best practices for .NET projects, but they lack some </span><span class="No-Break"><span class="koboSpan" id="kobo.550.1">enterprise-level features.</span></span></p>
<p><span class="koboSpan" id="kobo.551.1">In this section, we’ll look at two different commercial analysis tools that I’ve found to provide</span><a id="_idIndexMarker754"/><span class="koboSpan" id="kobo.552.1"> additional</span><a id="_idIndexMarker755"/><span class="koboSpan" id="kobo.553.1"> value for .NET projects: </span><strong class="bold"><span class="koboSpan" id="kobo.554.1">SonarCloud</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.555.1">and </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.556.1">NDepend</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.557.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.558.1">I won’t be covering how to set up these tools as both tools have comprehensive documentation that I’ve</span><a id="_idIndexMarker756"/><span class="koboSpan" id="kobo.559.1"> provided links to in the </span><em class="italic"><span class="koboSpan" id="kobo.560.1">Further reading</span></em><span class="koboSpan" id="kobo.561.1"> section at the end of this chapter. </span><span class="koboSpan" id="kobo.561.2">Instead, we’ll focus on the types of insights that dedicated code analysis tools can give you beyond what’s available in </span><span class="No-Break"><span class="koboSpan" id="kobo.562.1">Visual Studio.</span></span></p>
<h2 id="_idParaDest-270"><a id="_idTextAnchor269"/><span class="koboSpan" id="kobo.563.1">Tracking code metrics with SonarCloud and SonarQube</span></h2>
<p><span class="koboSpan" id="kobo.564.1">SonarCloud and SonarQube are a pair of commercial code analysis tools offered by SonarSource. </span><span class="koboSpan" id="kobo.564.2">Both products</span><a id="_idIndexMarker757"/><span class="koboSpan" id="kobo.565.1"> look at Git repositories containing code in a variety of popular programming languages and generate a series </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">of recommendations.</span></span></p>
<p><span class="koboSpan" id="kobo.567.1">The primary difference</span><a id="_idIndexMarker758"/><span class="koboSpan" id="kobo.568.1"> between SonarCloud and SonarQube is that </span><a id="_idIndexMarker759"/><span class="koboSpan" id="kobo.569.1">SonarCloud is hosted on and analyzed by servers maintained by SonarSource while SonarQube is software you can install on </span><span class="No-Break"><span class="koboSpan" id="kobo.570.1">your servers.</span></span></p>
<p><span class="koboSpan" id="kobo.571.1">Both pieces of software can analyze code in Git repositories and provide heat maps of problem areas in your code in the areas of reliability, maintainability, security, and code duplication. </span><span class="koboSpan" id="kobo.571.2">These views give you a simple graphical representation of your code that helps easily flag problem areas, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.572.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.573.1">.12</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.574.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer154">
<span class="koboSpan" id="kobo.575.1"><img alt="Figure 12.12 – SonarCloud analysis highlighting technical debt areas" src="image/B21324_12_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.576.1">Figure 12.12 – SonarCloud analysis highlighting technical debt areas</span></p>
<p><span class="koboSpan" id="kobo.577.1">These tools have built-in analyzers</span><a id="_idIndexMarker760"/><span class="koboSpan" id="kobo.578.1"> that analyze</span><a id="_idIndexMarker761"/><span class="koboSpan" id="kobo.579.1"> your code and flag reliability, security, and performance issues </span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">for remediation.</span></span></p>
<p><span class="koboSpan" id="kobo.581.1">Once an issue has been flagged, you can </span><a id="_idIndexMarker762"/><span class="koboSpan" id="kobo.582.1">use the web user interface shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.583.1">Figure 12</span></em></span><em class="italic"><span class="koboSpan" id="kobo.584.1">.13</span></em><span class="koboSpan" id="kobo.585.1"> to assign it to a team member, add comments to it, or mark it as resolved </span><span class="No-Break"><span class="koboSpan" id="kobo.586.1">or ignored:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer155">
<span class="koboSpan" id="kobo.587.1"><img alt="Figure 12.13 – Code analysis recommendations per line of code" src="image/B21324_12_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.588.1">Figure 12.13 – Code analysis recommendations per line of code</span></p>
<p><span class="koboSpan" id="kobo.589.1">For me, SonarCloud and</span><a id="_idIndexMarker763"/><span class="koboSpan" id="kobo.590.1"> SonarQube have a few major </span><span class="No-Break"><span class="koboSpan" id="kobo.591.1">selling points:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.592.1">They help expose technical </span><a id="_idIndexMarker764"/><span class="koboSpan" id="kobo.593.1">debt to non-developers in a very user-friendly way. </span><span class="koboSpan" id="kobo.593.2">An engineering manager or chief technology officer can look at the project in their web browser and get an understanding of the weak areas without ever having to install Visual Studio. </span><span class="koboSpan" id="kobo.593.3">This helps make technical </span><span class="No-Break"><span class="koboSpan" id="kobo.594.1">debt transparent.</span></span></li>
<li><span class="koboSpan" id="kobo.595.1">Items flagged by SonarCloud and SonarQube tend to be worth investigating, perhaps even more so than items flagged by Visual Studio </span><span class="No-Break"><span class="koboSpan" id="kobo.596.1">code analyzers.</span></span></li>
<li><span class="koboSpan" id="kobo.597.1">You tend to get a good result with these tools out of the box without needing additional configuration, though the configuration is available for customization should you wish to </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">do so.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.599.1">SonarCloud and Sonar</span><a id="_idIndexMarker765"/><span class="koboSpan" id="kobo.600.1">Qube are commercial products that are priced based on the lines of code in your projects. </span><span class="koboSpan" id="kobo.600.2">SonarCloud is also freely available for any public </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">GitHub repository.</span></span></p>
<p><span class="koboSpan" id="kobo.602.1">Since the code in this book is public on GitHub, you can see its code analysis results at </span><a href="https://sonarcloud.io/summary/overall?id=IntegerMan_Refactoring-with-CSharp"><span class="koboSpan" id="kobo.603.1">https://sonarcloud.io/summary/overall?id=IntegerMan_Refactoring-with-CSharp</span></a><span class="koboSpan" id="kobo.604.1">. </span><span class="koboSpan" id="kobo.604.2">I’d also strongly recommend that you create an account and have SonarCloud analyze some open-source code you’ve written </span><a id="_idIndexMarker766"/><span class="koboSpan" id="kobo.605.1">or are familiar with, just to walk through the setup and analysis process </span><a id="_idIndexMarker767"/><span class="koboSpan" id="kobo.606.1">and see the recommendations it </span><span class="No-Break"><span class="koboSpan" id="kobo.607.1">gives you.</span></span></p>
<p><span class="koboSpan" id="kobo.608.1">While SonarCloud and SonarQube are not .NET-specific tools, I do find they work well with .NET projects, which is why they’re highlighted in </span><span class="No-Break"><span class="koboSpan" id="kobo.609.1">this book.</span></span></p>
<p><span class="koboSpan" id="kobo.610.1">Next, let’s look at a tool </span><a id="_idIndexMarker768"/><span class="koboSpan" id="kobo.611.1">explicitly built for .NET and C# projects in </span><span class="No-Break"><span class="koboSpan" id="kobo.612.1">particular: NDepend.</span></span></p>
<h2 id="_idParaDest-271"><a id="_idTextAnchor270"/><span class="koboSpan" id="kobo.613.1">In-depth .NET analysis with NDepend</span></h2>
<p><span class="koboSpan" id="kobo.614.1">NDepend is a power tool </span><a id="_idIndexMarker769"/><span class="koboSpan" id="kobo.615.1">designed to help architects and software engineers get the most out of their </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">C# projects.</span></span></p>
<p><span class="koboSpan" id="kobo.617.1">NDepend can operate as a Visual Studio</span><a id="_idIndexMarker770"/><span class="koboSpan" id="kobo.618.1"> extension such as GitHub Copilot Chat, as a standalone application, or as a build agent integrated into an Azure DevOps </span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">build pipeline.</span></span></p>
<p><span class="koboSpan" id="kobo.620.1">When NDepend runs its analysis, it produces an HTML report (pictured in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.621.1">Figure 12</span></em></span><em class="italic"><span class="koboSpan" id="kobo.622.1">.14</span></em><span class="koboSpan" id="kobo.623.1">) and populates a dashboard view with the same information in </span><span class="No-Break"><span class="koboSpan" id="kobo.624.1">Visual Studio:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer156">
<span class="koboSpan" id="kobo.625.1"><img alt="Figure 12.14 – NDepend report showing code analysis results" src="image/B21324_12_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.626.1">Figure 12.14 – NDepend report showing code analysis results</span></p>
<p><span class="koboSpan" id="kobo.627.1">This report highlights</span><a id="_idIndexMarker771"/><span class="koboSpan" id="kobo.628.1"> the number of code analysis rules violated by the project, the</span><a id="_idIndexMarker772"/><span class="koboSpan" id="kobo.629.1"> current unit test code coverage percentages, and how metrics have changed </span><span class="No-Break"><span class="koboSpan" id="kobo.630.1">over time.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.631.1">Try it out</span></p>
<p class="callout"><span class="koboSpan" id="kobo.632.1">You can view a sample NDepend report for this chapter in the </span><a href="http://Chapter12/Ch12FinalCode/NDependOut/NDependReport.html"><span class="koboSpan" id="kobo.633.1">Chapter12/Ch12FinalCode/NDependOut/NDependReport.html</span></a><span class="koboSpan" id="kobo.634.1"> file in this book’s </span><span class="No-Break"><span class="koboSpan" id="kobo.635.1">GitHub repository.</span></span></p>
<p><span class="koboSpan" id="kobo.636.1">If you and your engineering team are trying to answer questions such as “Are we getting better or worse?”, “What are our major problems?”, or “What areas need to be fixed the most?”, NDepend will help you </span><span class="No-Break"><span class="koboSpan" id="kobo.637.1">with that.</span></span></p>
<p><span class="koboSpan" id="kobo.638.1">Like SonarCloud, NDepend operates on a series of analyzers called “rules.” </span><span class="koboSpan" id="kobo.638.2">These rules are written using LINQ against a model representing your source code. </span><span class="koboSpan" id="kobo.638.3">The default rules ship with their source code included and can be customized to your team’s needs. </span><span class="koboSpan" id="kobo.638.4">You can also write your own rules – much as we’ll write our own Roslyn Analyzers in the next </span><span class="No-Break"><span class="koboSpan" id="kobo.639.1">two chapters.</span></span></p>
<p><span class="koboSpan" id="kobo.640.1">These rules also allow you to compare how your code has changed since it was last baselined and estimate the</span><a id="_idIndexMarker773"/><span class="koboSpan" id="kobo.641.1"> amount of time it will take to resolve the technical debt </span><span class="No-Break"><span class="koboSpan" id="kobo.642.1">they represent.</span></span></p>
<p><span class="koboSpan" id="kobo.643.1">NDepend’s strengths go</span><a id="_idIndexMarker774"/><span class="koboSpan" id="kobo.644.1"> past its primary report, rules list, and list of rules violations. </span><span class="koboSpan" id="kobo.644.2">The real strength of NDepend is in its </span><span class="No-Break"><span class="koboSpan" id="kobo.645.1">data visualizations.</span></span></p>
<p><span class="koboSpan" id="kobo.646.1">The dependency matrix is what NDepend was originally known for and allows you to see a two-dimensional matrix of different namespaces and types, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.647.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.648.1">.15</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.649.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer157">
<span class="koboSpan" id="kobo.650.1"><img alt="Figure 12.15 – The NDepend dependency matrix" src="image/B21324_12_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.651.1">Figure 12.15 – The NDepend dependency matrix</span></p>
<p><span class="koboSpan" id="kobo.652.1">This matrix helps you detect namespaces or types that are dependent on each other. </span><span class="koboSpan" id="kobo.652.2">When different types or namespaces are mutually dependent on each other, this typically represents incorrectly segmented software architecture, and NDepend makes this highly visible when violations </span><span class="No-Break"><span class="koboSpan" id="kobo.653.1">are present.</span></span></p>
<p><span class="koboSpan" id="kobo.654.1">NDepend’s visualizations don’t stop there, however. </span><span class="koboSpan" id="kobo.654.2">My favorite visualization built into NDepend is its heat view, which allows you</span><a id="_idIndexMarker775"/><span class="koboSpan" id="kobo.655.1"> to view types or methods inside your project in a hierarchical tree with</span><a id="_idIndexMarker776"/><span class="koboSpan" id="kobo.656.1"> different rectangles representing different types </span><span class="No-Break"><span class="koboSpan" id="kobo.657.1">or methods.</span></span></p>
<p><span class="koboSpan" id="kobo.658.1">This view is similar to a tree map in data visualization tools, but each rectangle is colorized and sized based on various metrics calculated by NDepend. </span><span class="koboSpan" id="kobo.658.2">These metrics go well beyond the metrics Visual Studio calculates on its own and include things such as the lines of code, cyclomatic complexity, percentage of unit test coverage, or even the amount of comments in </span><span class="No-Break"><span class="koboSpan" id="kobo.659.1">the file.</span></span></p>
<p><span class="koboSpan" id="kobo.660.1">This heat map, pictured in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.661.1">Figure 12</span></em></span><em class="italic"><span class="koboSpan" id="kobo.662.1">.16</span></em><span class="koboSpan" id="kobo.663.1">, is the most intuitive way I’ve found of helping me zero in on potentially problematic code – and communicate problem areas visually to </span><span class="No-Break"><span class="koboSpan" id="kobo.664.1">key stakeholders:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer158">
<span class="koboSpan" id="kobo.665.1"><img alt="Figure 12.16 – An NDepend heat map showing lines of code and cyclomatic complexity" src="image/B21324_12_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.666.1">Figure 12.16 – An NDepend heat map showing lines of code and cyclomatic complexity</span></p>
<p><span class="koboSpan" id="kobo.667.1">NDepend also offers a dependency graph view. </span><span class="koboSpan" id="kobo.667.2">This graph allows you to see how assemblies, namespaces, types, methods, properties, events, and even fields interact with each other richly </span><a id="_idIndexMarker777"/><span class="koboSpan" id="kobo.668.1">and interactively, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.669.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.670.1">.17</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.671.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer159">
<span class="koboSpan" id="kobo.672.1"><img alt="Figure 12.17 – Namespace and type interactions within the Chapter12 project" src="image/B21324_12_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.673.1">Figure 12.17 – Namespace and type interactions within the Chapter12 project</span></p>
<p><span class="koboSpan" id="kobo.674.1">This allows you to visualize</span><a id="_idIndexMarker778"/><span class="koboSpan" id="kobo.675.1"> your software architecture and communicate that architecture to others on your team. </span><span class="koboSpan" id="kobo.675.2">This is particularly handy when onboarding </span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">new developers.</span></span></p>
<p><span class="koboSpan" id="kobo.677.1">The graph view also allows you to spot problem areas such as types that depend on too many other types, different namespaces dependent on each other, and classes that likely violate </span><span class="No-Break"><span class="koboSpan" id="kobo.678.1">the SRP.</span></span></p>
<p><span class="koboSpan" id="kobo.679.1">In my experience, NDepend takes some additional time to configure and investigate, but it represents a very effective way of visualizing, communicating, and navigating problem areas in </span><span class="No-Break"><span class="koboSpan" id="kobo.680.1">your code.</span></span></p>
<p><span class="koboSpan" id="kobo.681.1">Let’s finish this chapter by exploring code analysis at our </span><span class="No-Break"><span class="koboSpan" id="kobo.682.1">fictional organization.</span></span></p>
<h1 id="_idParaDest-272"><a id="_idTextAnchor271"/><span class="koboSpan" id="kobo.683.1">Case study – Cloudy Skies Airline</span></h1>
<p><span class="koboSpan" id="kobo.684.1">Cloudy Skies Airlines knew they</span><a id="_idIndexMarker779"/><span class="koboSpan" id="kobo.685.1"> had a lot of technical debt and code issues, but they weren’t sure which areas they should prioritize. </span><span class="koboSpan" id="kobo.685.2">Each engineer had different opinions on what was most important. </span><span class="koboSpan" id="kobo.685.3">As you would expect, these opinions were usually influenced by what each engineer had worked on </span><span class="No-Break"><span class="koboSpan" id="kobo.686.1">most recently.</span></span></p>
<p><span class="koboSpan" id="kobo.687.1">To resolve this issue, engineering leadership turned to the data. </span><span class="koboSpan" id="kobo.687.2">They started analyzing the available code metrics in Visual Studio and cataloging where most code analysis warnings seemed to </span><span class="No-Break"><span class="koboSpan" id="kobo.688.1">be located.</span></span></p>
<p><span class="koboSpan" id="kobo.689.1">Engineering management then compared the problem areas with the areas that had changed within the past 3 months and the areas the organization expects will need to change to support the team’s upcoming initiatives. </span><span class="koboSpan" id="kobo.689.2">This approach helped engineering management prioritize technical debt resolution in strategic areas that supported </span><span class="No-Break"><span class="koboSpan" id="kobo.690.1">business objectives.</span></span></p>
<p><span class="koboSpan" id="kobo.691.1">To help resolve the backlog </span><a id="_idIndexMarker780"/><span class="koboSpan" id="kobo.692.1">of warnings, developers were given a new mandate: each commit you make should not increase the number of active code analysis warnings. </span><span class="koboSpan" id="kobo.692.2">Decreasing the warning count or having it stay the same is fine, but increasing it will not be acceptable in </span><span class="No-Break"><span class="koboSpan" id="kobo.693.1">code review.</span></span></p>
<p><span class="koboSpan" id="kobo.694.1">This policy built additional awareness of code analysis warnings and the warnings were gradually reduced over time. </span><span class="koboSpan" id="kobo.694.2">Once the team got acclimated to paying attention to warnings, they moved to a larger code analysis ruleset. </span><span class="koboSpan" id="kobo.694.3">This caused a new series of warnings to come in, but those warnings helped identify potential or actual problems, as well as optimizations for </span><span class="No-Break"><span class="koboSpan" id="kobo.695.1">the application.</span></span></p>
<p><span class="koboSpan" id="kobo.696.1">To help provide insight into the health of its code, the organization is currently evaluating SonarCloud and NDepend to provide the team with a quality dashboard that will help them focus on key areas and ensure quality remains high </span><span class="No-Break"><span class="koboSpan" id="kobo.697.1">going forward.</span></span></p>
<h1 id="_idParaDest-273"><a id="_idTextAnchor272"/><span class="koboSpan" id="kobo.698.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.699.1">In this chapter, we saw how code metrics and code analysis tools can help you spot problem areas in your code, follow best practices, and prioritize areas of technical debt. </span><span class="koboSpan" id="kobo.699.2">This will help you understand the issues you and your team struggle with. </span><span class="koboSpan" id="kobo.699.3">Once you know the areas you struggle with, you can focus on remediating them going forward. </span><span class="koboSpan" id="kobo.699.4">This also helps you prioritize areas of technical debt and communicate those areas </span><span class="No-Break"><span class="koboSpan" id="kobo.700.1">to others.</span></span></p>
<p><span class="koboSpan" id="kobo.701.1">These built-in analyzers are incredibly handy and it turns out you can build some on your own. </span><span class="koboSpan" id="kobo.701.2">Over the next two chapters, we’ll do just that as we build our own code analyzer that can detect and automatically </span><span class="No-Break"><span class="koboSpan" id="kobo.702.1">fix issues.</span></span></p>
<h1 id="_idParaDest-274"><a id="_idTextAnchor273"/><span class="koboSpan" id="kobo.703.1">Questions</span></h1>
<p><span class="koboSpan" id="kobo.704.1">Answer the following questions to test your knowledge of </span><span class="No-Break"><span class="koboSpan" id="kobo.705.1">this chapter:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.706.1">What are the areas you consider to be most problematic about </span><span class="No-Break"><span class="koboSpan" id="kobo.707.1">your code?</span></span></li>
<li><span class="koboSpan" id="kobo.708.1">What do the code metrics say about these </span><span class="No-Break"><span class="koboSpan" id="kobo.709.1">problem areas?</span></span></li>
<li><span class="koboSpan" id="kobo.710.1">What is cyclomatic complexity and how is </span><span class="No-Break"><span class="koboSpan" id="kobo.711.1">it calculated?</span></span></li>
<li><span class="koboSpan" id="kobo.712.1">What are the things you should consider when picking a code </span><span class="No-Break"><span class="koboSpan" id="kobo.713.1">analysis ruleset?</span></span></li>
</ol>
<h1 id="_idParaDest-275"><a id="_idTextAnchor274"/><span class="koboSpan" id="kobo.714.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.715.1">You can find more information about code analysis at </span><span class="No-Break"><span class="koboSpan" id="kobo.716.1">these URLs:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.717.1">Code Metrics </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.718.1">Values</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.719.1">: </span></span><a href="https://learn.microsoft.com/en-us/visualstudio/code-quality/code-metrics-values"><span class="No-Break"><span class="koboSpan" id="kobo.720.1">https://learn.microsoft.com/en-us/visualstudio/code-quality/code-metrics-values</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.721.1">Overview of .NET source code </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.722.1">analysis</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.723.1">: </span></span><a href="https://learn.microsoft.com/en-us/dotnet/fundamentals/code-analysis/overview"><span class="No-Break"><span class="koboSpan" id="kobo.724.1">https://learn.microsoft.com/en-us/dotnet/fundamentals/code-analysis/overview</span></span></a></li>
<li><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.725.1">SonarCloud</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.726.1">: </span></span><a href="https://www.sonarsource.com/products/sonarcloud/"><span class="No-Break"><span class="koboSpan" id="kobo.727.1">https://www.sonarsource.com/products/sonarcloud/</span></span></a></li>
<li><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.728.1">NDepend</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.729.1">: </span></span><a href="https://www.ndepend.com/"><span class="No-Break"><span class="koboSpan" id="kobo.730.1">https://www.ndepend.com/</span></span></a></li>
</ul>
</div>
</body></html>