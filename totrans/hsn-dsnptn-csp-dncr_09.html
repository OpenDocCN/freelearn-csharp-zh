<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Implementing Design Patterns for Web Applications - Part 2</h1>
                </header>
            
            <article>
                
<p class="mce-root">In the previous chapter, we extended our FlixOne inventory management console application to a web application while illustrating different patterns. We also covered <strong>User Interface</strong><span> (</span><strong>UI</strong><span>)</span> architectural patterns such as <strong>Model-View-Controller</strong> (<strong>MVC</strong>), <strong>Model View Presenter</strong> (<strong>MVP</strong>), and others. The previous chapter aimed to discuss patterns such as MVC. We now need to extend our existing application to incorporate more patterns.</p>
<p class="mce-root">In this chapter, we will continue with our existing FlixOne web application and extend the application by working on code to see the implementation of authentication and authorization. In addition to this, we will discuss <strong>Test-Driven Development</strong> (<strong>TDD</strong>).</p>
<p class="mce-root">In this chapter, we will cover the following topics:</p>
<ul>
<li>Authentication and authorization</li>
<li>Creating a .NET Core web test project</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>This chapter contains various code examples to explain the concepts. The code is kept simple and is just for demonstration purposes. Most of the examples involve a .NET Core console application that is written in C#.</p>
<p>To run and execute the code, Visual Studio 2019 is a prerequisite (you can also use Visual Studio 2017 to run the application).</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing Visual Studio</h1>
                </header>
            
            <article>
                
<p>To run these code examples, you need to install Visual Studio (the preferred <strong>Integrated Development Environment </strong>(<strong>IDE</strong>)). To do so, follow these instructions:</p>
<ol>
<li>Download Visual Studio from the following download link, which contains installation instructions:<span> </span><a href="https://docs.microsoft.com/en-us/visualstudio/install/install-visual-studio">https://docs.microsoft.com/en-us/visualstudio/install/install-visual-studio</a>.</li>
<li>Follow the installation instructions you find there. Multiple versions are available for Visual Studio installation. Here, we are using Visual Studio for Windows.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up .NET Core</h1>
                </header>
            
            <article>
                
<p class="mce-root">If you do not have .NET Core installed, you need to follow these instructions:</p>
<ol>
<li class="mce-root">Download .NET Core for Windows using<span> </span><a href="https://www.microsoft.com/net/download/windows">https://www.microsoft.com/net/download/windows</a>.<a href="https://www.microsoft.com/net/download/windows"/></li>
<li>For multiple versions and a related library, visit <a href="https://dotnet.microsoft.com/download/dotnet-core/2.2">https://dotnet.microsoft.com/download/dotnet-core/2.2</a>.<a href="https://dotnet.microsoft.com/download/dotnet-core/2.2"/></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing SQL Server</h1>
                </header>
            
            <article>
                
<p class="mce-root">If you do not have SQL Server installed, you need to follow these instructions:</p>
<ol>
<li>Download SQL Server from the following link: <a href="https://www.microsoft.com/en-in/download/details.aspx?id=1695">https://www.microsoft.com/en-in/download/details.aspx?id=1695</a>.</li>
<li>You can find installation instructions here: <a href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017">https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017</a>.</li>
</ol>
<div class="mce-root packt_infobox">For troubleshooting and for more information, refer to the following link: <a href="https://www.blackbaud.com/files/support/infinityinstaller/content/installermaster/tkinstallsqlserver2008r2.htm">https://www.blackbaud.com/files/support/infinityinstaller/content/installermaster/tkinstallsqlserver2008r2.htm</a>.<br/>
<br/>
<span>The complete source code is available from the following link: </span><a href="https://github.com/PacktPublishing/Hands-On-Design-Patterns-with-C-and-.NET-Core/tree/master/Chapter7">https://github.com/PacktPublishing/Hands-On-Design-Patterns-with-C-and-.NET-Core/tree/master/Chapter7</a>.<a href="https://github.com/PacktPublishing/Hands-On-Design-Patterns-with-C-and-.NET-Core/tree/master/Chapter6"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Extending the .NET Core web application</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will continue with our FlixOne inventory application. Throughout this chapter, we will discuss web application patterns and extend the web application that we developed in the previous chapter.</p>
<div class="packt_infobox">This chapter continues with the web application developed in the previous chapter. If you skipped the previous chapter, please revisit it to Synchronization with the current chapter.</div>
<p>In this section, we will go through the process of requirement gathering, and then discuss the various challenges with our web application that we developed before now.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Project kickoff</h1>
                </header>
            
            <article>
                
<p class="mce-root">In <a href="8e089021-1efb-4b88-8bf2-e26f69f883b9.xhtml">Chapter 6</a>, <em>Implementing Design Patterns for Web Applications â€“ Part 1</em>, we extended our FlixOne inventory console application and developed a web application. We extended the application after considering the following points:</p>
<ul>
<li>Our business needs a rich UI.</li>
<li>New opportunities demand a responsive web application.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Requirements</h1>
                </header>
            
            <article>
                
<p class="mce-root">After several meetings and discussions with the management, <strong>Business Analysts</strong> (<strong>BAs</strong>), and presales folks, management decided to work on the following high-level requirements: <strong>business requirements</strong> and <strong>technical requirements</strong>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Business requirements</h1>
                </header>
            
            <article>
                
<p>The business team eventually came up with the following business requirements:</p>
<ul>
<li><strong>Product categorization</strong>: There are several products, but if a user wants to search for a specific product, they can do so by filtering all products by their categories. For example, products such as mangoes, bananas, and more should come under a category called <kbd>Fruits</kbd>.</li>
<li><strong>Product addition</strong>: There should be an interface that provides us with a feature to add new products. This feature should only be available to users who have the <kbd>Add Products</kbd> privilege.</li>
</ul>
<ul>
<li><strong>Product updation</strong>: There should be a new interface where product updates should be possible.</li>
<li><strong>Product deletion</strong>: There is a requirement for administrators to delete products.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>The actual requirements for meeting the business needs are now ready for development. After several discussions with business folks, we concluded that the following are the requirements:</p>
<ul>
<li><strong>You should have a landing or home page</strong>:
<ul>
<li>Should be a dashboard that contains various widgets</li>
<li>Should show an at-a-glance picture of the store</li>
</ul>
</li>
<li><strong>You should have a product page</strong>:
<ul>
<li>Should have the capability to add, update, and delete products</li>
<li>Should have the capability to add, update, and delete product categories</li>
</ul>
</li>
</ul>
<div class="packt_infobox">The FlixOne Inventory Management web application is an imaginary product. We are creating this application to discuss the various design patterns required/used in web projects.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Challenges</h1>
                </header>
            
            <article>
                
<p class="mce-root">Although we have extended our existing console application to a new web application, it has various challenges for both developers and businesses. In this section, we will discuss these challenges, and then we will find out the solution to overcome these challenges.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Challenges for developers</h1>
                </header>
            
            <article>
                
<p>The following are the challenges that arose due to a big change in the application. These were also a result of major extensions to upgrading a console application to a web application:</p>
<ul>
<li><strong>No support for TDD</strong>: Currently, there is no test project incorporated in the solution. Consequently, developers can't follow the TDD approach, which could lead to more bugs in the application.</li>
</ul>
<ul>
<li><strong>Security</strong>: In the current application, there is no mechanism to restrict or permit the user from providing access to a particular screen or module of the application. There is also nothing related to authentication and authorization.</li>
<li><strong>UI and User Experience (UX)</strong>: Our app is promoted from a console-based application, so the UI is not very rich.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Challenges for businesses</h1>
                </header>
            
            <article>
                
<p>It takes time to achieve the final output, which delays the product, resulting in a loss for the business. <span>The following challenges occur as we adapt a new technology stack, and there are plenty of changes in the code:</span></p>
<ul>
<li><strong>Loss of clients</strong>: Here, we are still in the stage of development but the demand for our business is very high; however, the development team is taking longer than expected to deliver the product.</li>
<li><strong>It takes more time to roll out the production updates</strong>: Development efforts are time-consuming at the moment, which delays the subsequent activities <span>and</span> leads to a delay in production.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Finding a solution to the problems/challenges</h1>
                </header>
            
            <article>
                
<p>After several meetings and brainstorming sessions, the development team came to the conclusion that we have to stabilize our web-based solution. To overcome these challenges and provide the solution, the tech team and the business team got together to identify the various solutions and points.</p>
<p>The following points <span>are</span> supported by the solution:</p>
<ul>
<li>Implementing authentication and authorization</li>
<li>Following TDD</li>
<li>Redesigning the UI to meet the UX</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Authentication and authorization</h1>
                </header>
            
            <article>
                
<p class="mce-root">In the previous chapter<span>â€”</span>where we started upgrading our console application to a web application<span>â€”</span>we added <strong>Create, Read, Update, and Delete </strong>(<strong>CRUD</strong>) operations, which are available publicly to any user who is able to perform them. There is nothing coded to restrict a particular user from performing these operations. The risk with this is that users who are not supposed to perform these operations can easily do so. The consequences of this are as follows:</p>
<ul>
<li>Unattended access</li>
<li>An open door for hackers/attackers</li>
<li>Data leakage issues</li>
</ul>
<p>Now, if we are keen to safeguard our application and restrict the operations to permitted users <span>only,</span> then we have to implement a design that only allows these users to perform operations. There may be scenarios in which we could allow open access for a few operations. In our case, most operations are only for restricted access. In simple terms, we can try something that tells our application that the incoming user is the one who belongs to our application and can perform the specified task.</p>
<div class="packt_tip"><strong>Authentication</strong> is simply a process in which a system verifies or identifies the incoming requests through credentials (generally a user ID and password). If the system finds that the provided credentials are wrong, then it notifies the user (generally via a message on the GUI screen) and terminates the authorization process.<br/>
<strong>Authorization</strong> always comes after authentication. This is a process that allows the authenticated user who raised the request to access resources or data after verifying that they have access to the specific resources or data.</div>
<p>In the previous paragraph, we have discussed some mechanisms that stop unattended access to our application's operations. Let's refer to the following diagram and discuss what it shows:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/00ea38bd-deaf-44bf-ae88-d05a91e2597e.png" style=""/></div>
<p>The preceding diagram depicts a scenario in which the system does not allow unattended access. This is simply defined as follows: an incoming request is received and the internal system (an authentication mechanism) checks whether a request is authenticated or not. If a request is authenticated, then a user is allowed to perform the operations for which they are authorized. This is not only the single check, but for a typical system, authorization comes in place after authentication. We will discuss this in the upcoming sections.</p>
<p>To understand this in a better way, let's write a simple login application. Let's follow the steps given here:</p>
<ol>
<li>Open <span class="packt_screen">Visual Studio 2018<span>.</span></span></li>
<li>Open <span class="packt_screen">File</span> | <span class="packt_screen">New</span> | <span class="packt_screen">New project.</span></li>
<li>From the <span class="packt_screen">Project</span> window, give a name to your project.</li>
</ol>
<ol start="4">
<li>Select <span class="packt_screen">ASP.NET Core 2.2</span> for the Web Application (<span class="packt_screen">Model-View-Controller</span>) template:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/e1b73f2c-6bb3-472c-83fa-148167c195de.png"/></div>
<ol start="5">
<li>You can choose various authentications that are available as part of the selected template.</li>
<li>By default, the template provides an option named <span class="packt_screen">No Authentication</span>, as shown here:<span class="packt_screen"><br/></span></li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/56f9fe22-d905-4a1c-aaa3-9967f6e3011f.png"/></div>
<ol start="7">
<li>Press <em>F5</em> and run the application. From here, you will see the default home page:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/36015566-2dc3-4f85-a9a6-5479287ae8ef.png"/></div>
<p>You will now notice that you can navigate every page without any restrictions. This is obvious and makes sense as these pages are available as open access. The <span class="packt_screen">Home</span> and <span class="packt_screen">Privacy</span> pages are open access and do not require any authentication, meaning that anyone can access/view these pages. On the other hand, we may have a few pages that are meant for unattended access, such as the <span class="packt_screen">User Profile</span>, and <span class="packt_screen">Admin</span> pages.</p>
<div class="packt_tip">Refer to the GitHub repository for the chapter at <a href="https://github.com/PacktPublishing/Hands-On-Design-Patterns-with-C-and-.NET-Core/tree/master/Chapter6">https://github.com/PacktPublishing/Hands-On-Design-Patterns-with-C-and-.NET-Core/tree/master/Chapter6</a>, and go through the entire application that we have built using ASP.NET Core MVC.</div>
<p class="mce-root">To continue with our <span class="packt_screen">SimpleLogin</span> application, let's add a screen that is meant for restricted access: the <span class="packt_screen">Products</span> screen. In this chapter, we are not going to discuss how to add a new controller or views to an existing project. If you want to know how we can add these to our project, revisit <a href="8e089021-1efb-4b88-8bf2-e26f69f883b9.xhtml">Chapter 6</a>, <em>Implementing Design Patterns for Web Applications â€“ Part 1</em>.</p>
<p>We have added new functionality to our project to showcase products with CRUD operations. Now, hit <em>F5</em> and check the output:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/e1323798-b41f-4647-91e2-9b02aee64b03.png"/></div>
<p>You will get the output that is shown in the previous screenshot. You might notice that we <span>now</span><span> </span><span>have a new menu named </span><span class="packt_screen">Products</span><span>.</span></p>
<p>Let's navigate through the new menu options. Click on the <span class="packt_screen">Products </span><span>menu</span><span>:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/e4d9a790-7ca3-413c-953e-c7ffd7085696.png"/></div>
<p>The previous <span>screenshot</span> shows our <span class="packt_screen">Product</span> page. This page is available to all and anyone can view it without any restrictions. You might have a look and observe that this page has the feature to <span class="packt_screen">Create New</span> products, and to <span class="packt_screen">Edit</span> and <span class="packt_screen">Delete</span> existing products. Now, imagine a scenario where one unknown user came and deleted a specific product that is very important and attracts a high sales volume. You can imagine the scenario and how much this hampers a business. There might even be a chance that customers are lost.</p>
<p>In our scenario, we can protect our <span class="packt_screen">Product</span> page in two ways:</p>
<ul>
<li><strong>Prior Authenticate</strong>: On this page, the link to <span class="packt_screen">Products</span> is not available for everyone; it is only available for authenticated requests/users.</li>
<li><strong>Post Authenticate</strong>: On this page, the link to <span class="packt_screen">Products</span> is available for everyone. However, once someone requests to access the page, the system performs an authentication check.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Authentication in action</h1>
                </header>
            
            <article>
                
<p>In this section, we will see how to implement authentication and make our web pages restricted for unauthenticated requests.</p>
<p>To achieve authentication, we should adopt some sort of mechanism that provides us with a way to authenticate a user. In general cases, if a user is logged in, that means they are already authenticated.</p>
<p>In our web application, we will also follow the same approach and make sure that the user is logged in before accessing the restricted pages, views, and operations:</p>
<pre>public class User<br/>{<br/>    public Guid Id { get; set; }<br/>    public string UserName { get; set; }<br/>    public string EmailId { get; set; }<br/>    public string FirstName { get; set; }<br/>    public string LastName { get; set; }<br/>    public byte[] PasswordHash { get; set; }<br/>    public byte[] PasswordSalt { get; set; }<br/>    public string SecretKey { get; set; }<br/>    public string Mobile { get; set; }<br/>    public string EmailToken { get; set; }<br/>    public DateTime EmailTokenDateTime { get; set; }<br/>    public string OTP { get; set; }<br/>    public DateTime OtpDateTime { get; set; }<br/>    public bool IsMobileVerified { get; set; }<br/>    public bool IsEmailVerified { get; set; }<br/>    public bool IsActive { get; set; }<br/>    public string Image { get; set; }<br/>}</pre>
<p>The previous class is a typical <kbd>User</kbd> model/entity that represents our database <span><kbd>User</kbd> </span><span>table</span><span>. This table will persist all the information regarding</span> <kbd>User</kbd>. Here is what every field looks like:</p>
<ul>
<li><kbd>Id</kbd> is a <strong><span class="ILfuVd"><span class="e24Kjd">Globally Unique Identifier</span></span></strong> (<strong>GUID</strong>) and primary key in the table.</li>
<li><kbd>UserName</kbd> is typically used during login and other related operations. It is a programmatically generated field.</li>
<li><kbd>FirstName</kbd> and <kbd>LastName</kbd> combine the full name of the user.</li>
<li><kbd>Emailid</kbd> is the valid email ID of the user. It should be a valid email because we will validate this after/during the registration process.</li>
<li><kbd>PasswordHash</kbd> and <kbd>PasswordSalt</kbd> are the byte arrays that are based on a <strong>Hash-Based Message Authentication Code, Secure Hash Algorithm</strong> (<strong>HMAC</strong><strong>SHA</strong>) 512. A value for <kbd>PasswordHash</kbd> attribute is 64 bytes and <kbd>PasswordSalt</kbd> is 128 bytes.</li>
<li><kbd>SecretKey</kbd> is a Base64-encoded string.</li>
<li><kbd>Mobilie</kbd> is a valid mobile number that depends on the validity check by the system.</li>
<li><kbd>EmailToken</kbd> and <kbd>OTP</kbd> are the <strong>One-Time Passwords</strong> (<strong>OTPs</strong>) that are randomly generated to validate <kbd>emailId</kbd> and <kbd>Mobile number</kbd>.</li>
<li><kbd>EmailTokenDateTime</kbd> and <kbd>OtpDateTime</kbd> are the properties of the <kbd>datetime</kbd> data type; they represent the date and time in which <kbd>EmailToken</kbd> and <kbd>OTP</kbd> are issued for the user.</li>
<li><kbd>IsMobileVerified</kbd> and <kbd>IsEmailverified</kbd> are Boolean values (<kbd>true</kbd>/<kbd>false</kbd>) that tell the system whether the mobile number and/or email ID are verified or not.</li>
<li><kbd>IsActive</kbd> is a Boolean value (<kbd>true</kbd>/<kbd>false</kbd>) that tells the system whether a <kbd>User</kbd> model is active or not.</li>
<li><kbd>Image</kbd> is a Base64-encoded string of an image. It represents the profile picture of a user.</li>
</ul>
<p>We need to add our new class/entity to our <kbd>Context</kbd> class. Let's add <span><span>what we can see</span></span> in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/e66ab985-bf29-4c24-a451-510908e88c54.png" style=""/></div>
<p>By adding the previous line in our <kbd>Context</kbd> class, we can access our <kbd>User</kbd> table directly using <strong>E<span>ntity</span> <span>F</span><span>ramework</span></strong> (<strong>EF</strong>) functionality:</p>
<pre>public class LoginViewModel<br/>{<br/>    [Required]<br/>    public string Username { get; set; }<br/>    [Required]<br/>    [DataType(DataType.Password)]<br/>    public string Password { get; set; }<br/>    [Display(Name = "Remember Me")]<br/>    public bool RememberMe { get; set; }<br/>    public string ReturnUrl { get; set; }<br/>}</pre>
<p><kbd>LoginViewModel</kbd> is used to authenticate the user. The values of this <kbd>viewmodel</kbd> come from the <span class="packt_screen">Login</span> page (we will discuss and create this page in the upcoming section). It contains the following:</p>
<ul>
<li><kbd>UserName</kbd>: This is a unique name that is used to identify the user. This is a human-readable value that can be easily identified. It is not like the GUID value.</li>
<li><kbd>Password</kbd>: This is a secret and sensitive value for any user.</li>
<li><kbd>RememberMe</kbd>: This tells us whether the user wants to allow the current system to persist cookies which store values in cookies at the client browser.</li>
</ul>
<p>To perform the CRUD operations, let's add the following code to the <span class="packt_screen"><kbd>UserManager</kbd></span> class:</p>
<pre>public class UserManager : IUserManager<br/>{<br/>    private readonly InventoryContext _context;<br/><br/>    public UserManager(InventoryContext context) =&gt; _context = context;<br/><br/>    public bool Add(User user, string userPassword)<br/>    {<br/>        var newUser = CreateUser(user, userPassword);<br/>        _context.Users.Add(newUser);<br/>        return _context.SaveChanges() &gt; 0;<br/>    }<br/><br/>    public bool Login(LoginViewModel authRequest) =&gt; FindBy(authRequest) != null;<br/><br/>    public User GetBy(string userId) =&gt; _context.Users.Find(userId);</pre>
<p>The following is the code snippet from the rest of the methods of the <kbd>UserManager</kbd> class:</p>
<pre>   public User FindBy(LoginViewModel authRequest)<br/>    {<br/>        var user = Get(authRequest.Username).FirstOrDefault();<br/>        if (user == null) throw new ArgumentException("You are not registered with us.");<br/>        if (VerifyPasswordHash(authRequest.Password, user.PasswordHash, user.PasswordSalt)) return user;<br/>        throw new ArgumentException("Incorrect username or password.");<br/>    }<br/>    public IEnumerable&lt;User&gt; Get(string searchTerm, bool isActive = true)<br/>    {<br/>        return _context.Users.Where(x =&gt;<br/>            x.UserName == searchTerm.ToLower() || x.Mobile == searchTerm ||<br/>            x.EmailId == searchTerm.ToLower() &amp;&amp; x.IsActive == isActive);<br/>    }<br/>    <br/>    ...<br/>}</pre>
<p>The preceding code is the <kbd>UserManager</kbd> class, which gives us the <span>ability</span> to interact with our <kbd>User</kbd> table using EF:</p>
<p>The following code shows the View of the <span class="packt_screen">Login</span> screen:</p>
<pre>&lt;form asp-action="Login" asp-route-returnurl="@Model.ReturnUrl"&gt;<br/>    &lt;div asp-validation-summary="ModelOnly" class="text-danger"&gt;&lt;/div&gt;<br/><br/>    &lt;div class="form-group"&gt;<br/>        &lt;label asp-for="Username" class="control-label"&gt;&lt;/label&gt;<br/>        &lt;input asp-for="Username" class="form-control" /&gt;<br/>        &lt;span asp-validation-for="Username" class="text-danger"&gt;&lt;/span&gt;<br/>    &lt;/div&gt;<br/><br/>    &lt;div class="form-group"&gt;<br/>        &lt;label asp-for="Password" class="control-label"&gt;&lt;/label&gt;<br/>        &lt;input asp-for="Password" class="form-control"/&gt;<br/>        &lt;span asp-validation-for="Password" class="text-danger"&gt;&lt;/span&gt;<br/>    &lt;/div&gt;<br/><br/>    &lt;div class="form-group"&gt;<br/>        &lt;label asp-for="RememberMe" &gt;&lt;/label&gt;<br/>        &lt;input asp-for="RememberMe" /&gt;<br/>        &lt;span asp-validation-for="RememberMe"&gt;&lt;/span&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="form-group"&gt;<br/>        &lt;input type="submit" value="Login" class="btn btn-primary" /&gt;<br/>    &lt;/div&gt;<br/>&lt;/form&gt;</pre>
<p>The previous code snippet is from our <kbd>Login.cshtml</kbd> page/view. This page provides a form to enter the <kbd>Login</kbd> details. These details come to our <kbd>Account</kbd> controller and are then validated to authenticate the user:</p>
<p>The following is the <kbd>Login</kbd> action method:</p>
<pre>[HttpGet]<br/>public IActionResult Login(string returnUrl = "")<br/>{<br/>    var model = new LoginViewModel { ReturnUrl = returnUrl };<br/>    return View(model);<br/>}</pre>
<p>The preceding code snippet is a <kbd>Get /Account/Login</kbd> request that displays the empty login page, which is shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/49b3bb00-4948-47d3-a661-8124331d513d.png" style=""/></div>
<p>The previous screenshot appears as soon as the user clicks on the <span class="packt_screen">Login</span> menu option. This is a simple form used to enter the <span class="packt_screen">Login</span> details.</p>
<p>The following code shows the <kbd>Login</kbd> action method that handles the <kbd>Login</kbd> functionality of the application:</p>
<pre>[HttpPost]<br/>public IActionResult Login(LoginViewModel model)<br/>{<br/>    if (ModelState.IsValid)<br/>    {<br/>        var result = _authManager.Login(model);<br/><br/>        if (result)<br/>        {<br/>           return !string.IsNullOrEmpty(model.ReturnUrl) &amp;&amp; Url.IsLocalUrl(model.ReturnUrl)<br/>                ? (IActionResult)Redirect(model.ReturnUrl)<br/>                : RedirectToAction("Index", "Home");<br/>        }<br/>    }<br/>    ModelState.AddModelError("", "Invalid login attempt");<br/>    return View(model);<br/>}</pre>
<p class="mce-root"/>
<p>The preceding code snippet is a <kbd>Post /Account/Login</kbd> request from a login page that posts the entire <kbd>LoginViewModel</kbd> class:</p>
<p>The following is the screenshot of our Login view:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/f6723286-de50-440c-8d2b-5a2dafc67aa9.png" style=""/></div>
<p>In the previous screenshot, we are trying to log in using our default user credentials (<span class="packt_screen">Username</span>: <kbd>aroraG</kbd> and <span class="packt_screen">Password</span>: <kbd>test123</kbd>). The information related to this login is being persisted in cookies, but only if the <span class="packt_screen">Remember Me</span> checkbox is checked by the user. The system remembers the logged-in session on the current computer until the user hits the <span class="packt_screen">Logout</span> button.</p>
<p>As soon as the user hits the <span class="packt_screen">Login</span> button, the system authenticates their login details and redirects them to the home page, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/dd11bc73-c8d1-4c6b-b7bc-7e33fd058cd7.png" style=""/></div>
<p>You might observe text in the menu, such as <kbd>Welcome Gaurav</kbd>. This welcome text is not coming automatically, but we did instruct our system to show this text by adding a few lines of code, as shown in the following code:</p>
<pre>&lt;li class="nav-item"&gt;<br/>    @{<br/>        if (AuthManager.IsAuthenticated)<br/>        {<br/>            &lt;a class="nav-link text-dark" asp-area="" asp-controller="Account" asp-action="Logout"&gt;&lt;strong&gt;Welcome @AuthManager.Name&lt;/strong&gt;, Logout&lt;/a&gt;<br/><br/>        }<br/>        else<br/>        {<br/>            &lt;a class="nav-link text-dark" asp-area="" asp-controller="Account" asp-action="Login"&gt;Login&lt;/a&gt;<br/>        }<br/>    }<br/>&lt;/li&gt;</pre>
<p>The previous code snippet is taken from the <kbd>_Layout.cshtml</kbd> view/page. In the previous code snippet, we are checking whether <kbd>IsAuthenticated</kbd> returns true. If so, then the welcome message is displayed. This welcome message comes along with the <span class="packt_screen">Logout</span> option, but it displays the <kbd>Login</kbd> menu when <kbd>IsAuthenticated</kbd> returns the <kbd>false</kbd> value:</p>
<pre>public bool IsAuthenticated<br/>{<br/>    get { return User.Identities.Any(u =&gt; u.IsAuthenticated); }<br/>}</pre>
<p><kbd>IsAuthenticated</kbd> is a <kbd>ReadOnly</kbd> property of the <kbd>AuthManager</kbd> class that checked whether the request is authenticated or not. Before we move ahead, let's revisit our <kbd>Login</kbd> method:</p>
<pre>public IActionResult Login(LoginViewModel model)<br/>{<br/>    if (ModelState.IsValid)<br/>    {<br/>        var result = _authManager.Login(model);<br/><br/>        if (result)<br/>        {<br/>           return !string.IsNullOrEmpty(model.ReturnUrl) &amp;&amp; Url.IsLocalUrl(model.ReturnUrl)<br/>                ? (IActionResult)Redirect(model.ReturnUrl)<br/>                : RedirectToAction("Index", "Home");<br/>        }<br/>    }<br/>    ModelState.AddModelError("", "Invalid login attempt");<br/>    return View(model);<br/>}</pre>
<p>The previous <kbd>Login</kbd> method simply validates the user. Take a look at this statement<span>â€”</span><kbd>var result = _authManager.Login(model);</kbd>. This calls a <kbd>Login</kbd> method from <kbd>AuthManager</kbd>:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/dde59675-3690-45ac-8590-ca3a459137f8.png" style=""/></div>
<p>If the <kbd>Login</kbd> method returns <kbd>true</kbd>, then it redirects the current <span class="packt_screen">Login</span> page to the <span class="packt_screen">Home</span> page. Otherwise, it remains on the same <span class="packt_screen">Login</span> page by complaining about an <span class="packt_screen">Invalid login attempt</span>. The following is the code of the <kbd>Login</kbd> method:</p>
<pre>public bool Login(LoginViewModel model)<br/>{<br/>    var user = _userManager.FindBy(model);<br/>    if (user == null) return false;<br/>    SignInCookie(model, user);<br/>    return true;<br/>}</pre>
<p>The <kbd>Login</kbd> method is a typical method of the <kbd>AuthManager</kbd> class, which calls the <kbd>FindBy(model)</kbd> method of <kbd>UserManager</kbd> and checks whether it exists or not. If it exists, then it further calls the <kbd>SignInCookie(model,user)</kbd> method of the <kbd>AuthManager</kbd> class, otherwise, it simply returns as <kbd>false</kbd>, meaning that the <span class="packt_screen">Login</span> is unsuccessful:</p>
<pre>private void SignInCookie(LoginViewModel model, User user)<br/>{<br/>    var claims = new List&lt;Claim&gt;<br/>    {<br/>        new Claim(ClaimTypes.Name, user.FirstName),<br/>        new Claim(ClaimTypes.Email, user.EmailId),<br/>        new Claim(ClaimTypes.NameIdentifier, user.Id.ToString())<br/>    };<br/><br/>    var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);<br/>    var principal = new ClaimsPrincipal(identity);<br/>    var props = new AuthenticationProperties { IsPersistent = model.RememberMe };<br/>    _httpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal, props).Wait();<br/>}</pre>
<p>The following code snippet makes sure that if the user is authenticated, then their details should be persisted in <span class="packt_screen"><kbd>HttpContext</kbd></span> so that the system can authenticate each and every incoming request from users. You might observe the <kbd>_httpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal, props).Wait();</kbd> <span>statement </span>that actually signed in and enabled the cookie authentication:</p>
<pre>//Cookie authentication<br/>services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme).AddCookie();<br/>//For claims<br/>services.AddSingleton&lt;IHttpContextAccessor, HttpContextAccessor&gt;();<br/>services.AddTransient&lt;IAuthManager, AuthManager&gt;();</pre>
<p>The previous statements help us to enable cookie authentication and claims for incoming requests for our application. Finally, the <kbd>app.UseAuthentication();</kbd> <span>statement </span><span>adds the authentication mechanism ability into our application. These statements should be added to the</span> <kbd>Startup.cs</kbd> <span>class.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Why does it make a difference?</h1>
                </header>
            
            <article>
                
<p>We have added plenty of code into our web application, but does this really help us to restrict our pages/views from unattended requests? The <strong>Products</strong> page/view is still open; therefore, I can perform any available actions from the <span class="packt_screen">Products</span> page/view:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/503ea6e8-df37-4c0b-b2bd-d0ae1a348a07.png" style=""/></div>
<p>As a user, I can see the <span class="packt_screen">Products</span> option whether I am logged in or not:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/5e25140c-009d-4976-8bee-da343dc28458.png" style=""/></div>
<p>The previous screenshot shows the same <span class="packt_screen">Products</span> menu option after login as before login.</p>
<p>We can restrict the access of the <span class="packt_screen">Products</span> page like this:</p>
<pre>&lt;li class="nav-item"&gt;<br/>    @{<br/>        if (AuthManager.IsAuthenticated)<br/>        {<br/>            &lt;a class="nav-link text-dark" asp-area="" asp-controller="Product" asp-action="Index"&gt;Products&lt;/a&gt;<br/>        }<br/>    }<br/>&lt;/li&gt;</pre>
<p>The following is the home screen of the application:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/bf5954af-e1af-4505-958e-413ae4cfd1bd.png" style=""/></div>
<p>The previous code helps systems to only display the <span class="packt_screen">Products</span> menu option once the user is logged in/authenticated. The <span class="packt_screen">Products</span> menu options will not get displayed on the screen. Like this, we can restrict the unattended access. However, this approach has its own cons. The biggest one is that if someone knows the URL of the <span class="packt_screen">Products</span> page<span>â€”</span>which will lead you to <kbd>/Product/Index</kbd><span>â€”</span>then they can perform restricted operations. These operations are restricted as they are <span>not </span><span>meant to be used by a user who is not logged in.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Authorization in action</h1>
                </header>
            
            <article>
                
<p>In the previous section, we discussed how to avoid unattended access to a particular or restricted screen/page. We have seen that <span class="packt_screen">Login</span> actually authenticates the user and allows them to make a request to the system. On the other hand, authentication does not mean that if a user is authenticated, then they are authorized to access a particular section, page, or screen.</p>
<p>The following depicts <span>a typical</span> authorization and authentication process:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/8ce628c8-963b-4240-a461-128fba886d7e.png" style=""/></div>
<p>In this process, the first request/user gets authenticated (typically, it is a login form), then a request is authorized to perform a particular/requested operation(s). There may be many scenarios where a request is authenticated but not authorized to access a specific resource or perform a specific operation.</p>
<p>In our application (created in the previous section), we have a <kbd>Products</kbd> page with CRUD operations. The <kbd>Products</kbd> page is not a public page, which means that this page is not available for all; it is available with restricted access.</p>
<p>We come back to the following main problem that we left within the previous section: "What if a user is authenticated but they are not authorized to access a particular page/resource? It does not matter whether we hide the page from the unauthorized user because they can easily access or view it by entering its URL<span>.</span><em>"</em> To overcome this challenge/issue, we can implement the following steps:</p>
<ol>
<li>Check the authorization on each access of the restricted resource, which means that whenever a user tries to access the resource (by entering a direct URL in the browser), the system checks for authorization, so that incoming requests to access the resource can be authorized. If the incoming request of the user is not authorized, then they would not be able to perform the specified operation.</li>
<li>Checking authorization on each operation of the restricted resource means that if the user is authenticated, they would be able to access the restricted page/view, but the operations of this page/view can only be accessible if the user is authorized.</li>
</ol>
<div class="packt_tip">The <kbd>Microsoft.AspNetCore.Authorization</kbd> namespace provides built-in functions to authorize specific resources.</div>
<p>To restrict access and avoid unattended access to a particular resource, we can use the <kbd>Authorize</kbd> attribute:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/4d449cc2-19f6-4522-8811-b1b9a59ef4af.png" style=""/></div>
<p>The previous screenshot shows that we are putting the <kbd>Authorize</kbd> attribute into our <kbd>ProductController</kbd>. Now, hit <em>F5</em> and run the application.</p>
<div class="packt_tip">If the user is not logged in to the system, they would not able to see the <span class="packt_screen">Product</span> page as we have already added the condition. If the user is validated, then display <span class="packt_screen">Products</span> in the menu bar.</div>
<p>Do not log in to the system and enter the product URL, <kbd>http://localhost:56229/Product</kbd>, directly to your browser. This will redirect the user to the <span class="packt_screen">Login</span> screen. Please see the following <span>screenshot</span> and check the URL; you might notice that the URL contains a <span class="packt_screen">ReturnUrl</span> part that will instruct the system on where to be redirected upon a successful login attempt.</p>
<p><span>See the following screenshot; note that the URL contains the </span><span class="packt_screen">ReturnUrl</span><span> part. The system redirects the application to this URL once the user is logged in:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/c7be2aef-4be7-4eb3-acbc-ff8900abfcf1.png" style=""/></div>
<p><span>The following screenshot shows <span class="packt_screen">Product Listing</span>:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/ecde544b-f171-4a84-ab26-ccb3fda4cb3b.png" style=""/></div>
<p>Our <span class="packt_screen">Product Listing</span> screen provides operations such as <span class="packt_screen">Create New</span>, <span class="packt_screen">Edit</span>, <span class="packt_screen">Delete</span>, and <span class="packt_screen">Details</span>. The current application allows the user to perform these operations. Therefore, does it make sense that any visiting and authenticated user can create, update, and delete a product? If we allow this for every user, the consequences can be as follows:</p>
<ul>
<li><span>We can have many products that have been already added to the system.</span></li>
<li><span>Unavoidable removal/deletion of products.</span></li>
<li><span>Unavoidable updating of products.</span></li>
</ul>
<p>Can we have something such as user types that differentiate all users of the <kbd>Admin</kbd> type from normal users, allowing only users with admin rights<span>â€”not the normal usersâ€”to</span> perform these operations? A better idea is to add roles for users; therefore, we would need to make a user of a specific type.</p>
<p>Let's add a new entity into our project and name it <kbd>Role</kbd>:</p>
<pre>public class Role<br/>{<br/>    public Guid Id { get; set; }<br/>    public string Name { get; set; }<br/>    public string ShortName { get; set; }<br/>}</pre>
<p>The previous code snippet that defines the <kbd>Role</kbd> class for a user has properties, as explained in the following list:</p>
<ul>
<li><kbd>Id</kbd>: This uses <kbd>GUID</kbd> as a primary key.</li>
<li><kbd>Name</kbd>: A <kbd>Role</kbd> name of a <kbd>string</kbd> type.</li>
<li><kbd>ShortName</kbd>: A short or abbreviated name of the role that is of a <kbd>string</kbd> type.</li>
</ul>
<p>We need to add our new class/entity to our <kbd>Context</kbd> class. Let's add this as follows:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/41ec1447-9387-4dad-900d-b7264329c630.png" style=""/></div>
<p>The previous code provides the ability to work various DB operations using EF:</p>
<pre>public IEnumerable&lt;Role&gt; GetRoles() =&gt; _context.Roles.ToList();<br/><br/>public IEnumerable&lt;Role&gt; GetRolesBy(string userId) =&gt; _context.Roles.Where(x =&gt; x.UserId.ToString().Equals(userId));<br/><br/>public string RoleNamesBy(string userId)<br/>{<br/>    var listofRoleNames = GetRolesBy(userId).Select(x=&gt;x.ShortName).ToList();<br/>    return string.Join(",", listofRoleNames);<br/>}</pre>
<p>The three methods of the <kbd>UserManager</kbd> class that appeared in the previous code snippet provide us with the <span>ability</span> to get <kbd>Roles</kbd> from the database:</p>
<pre>private void SignInCookie(LoginViewModel model, User user)<br/>{<br/>    var claims = new List&lt;Claim&gt;<br/>    {<br/>        new Claim(ClaimTypes.Name, user.FirstName),<br/>        new Claim(ClaimTypes.Email, user.EmailId),<br/>        new Claim(ClaimTypes.NameIdentifier, user.Id.ToString())<br/>    };<br/><br/>    if (user.Roles != null)<br/>    {<br/>        string[] roles = user.Roles.Split(",");<br/><br/>        claims.AddRange(roles.Select(role =&gt; new Claim(ClaimTypes.Role, role)));<br/>    }<br/><br/>    var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);<br/><br/>    var principal = new ClaimsPrincipal(identity);<br/>    var props = new AuthenticationProperties { IsPersistent = model.RememberMe };<br/>    _httpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal, props).Wait();<br/>}</pre>
<p>We have added <kbd>Roles</kbd> to our <kbd>Claims</kbd> by modifying the <kbd>SigningCookie</kbd> method of the <kbd>AuthManager</kbd> class:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/b2f40509-4128-4d60-864b-84b5bc9fc064.png" style=""/></div>
<p>The previous screenshot shows that a user named <kbd>Gaurav</kbd> has two roles: <kbd>Admin</kbd> and <kbd>Manager</kbd>:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/7dff3042-7c28-4700-a762-c9d3dbab96ac.png" style=""/></div>
<p>We restrict <kbd>ProductController</kbd> for the user(s) with the <kbd>Admin</kbd> and <kbd>Manager</kbd> <span>roles </span>only. Now, try to log in with user <kbd>aroraG</kbd> and you will see <kbd>Product Listing</kbd>, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/f3bb9f93-2966-43f8-a046-9632d5670f63.png" style=""/></div>
<p>Now, let's try to log in with a second user, <kbd>aroraG1</kbd>, which has the role of <kbd>Editor</kbd>. This will throw an <kbd>AccessDenied</kbd> error. For this, see the follo<span>w</span>ing screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/edba9b44-843e-42d3-8a6b-ea4845d3e9e3.png"/></div>
<p>In this way, we can safeguard our restricted resources. There are a lot of ways to achieve this. .NET Core MVC provides built-in functionality to achieve this, and you can also do so in a customizable way. If you do not want to use these available built-in features, you can easily draft your own functionality of required features by adding to the existing code. If you want to do this, you need to start from scratch. Furthermore, if something is available, then there is no sense in creating something similar again. If you do not find the functionality for available components, then you should customize the existing functionality/features rather than writing the entire code from scratch.</p>
<div class="packt_tip"><strong>A developer should implement an authentication mechanism that can't be tampered with. </strong>In this section, we have discussed a lot to do with authentication and authorization, as well as writing code and creating our web application. In regard to authentication, we should use a good mechanism for the authentication so that no one can tamper with or bypass it. There are two more designs you can start with:<br/>
<ul>
<li>Authentication filters</li>
<li>Authenticating individual requests/endpoints</li>
</ul>
</div>
<p>After the implementation of the previous steps, every request that comes via any mode should be authenticated and authorized before the system responds to the user or the client that made the call. This process mainly includes the following:</p>
<ul>
<li><strong>Confidentiality</strong>: The secured system makes sure that any sensitive data is not exposed to unauthenticated and unauthorized access requests.</li>
<li><strong>Availability</strong>: The security measures in the system make sure that the system is available for users who are genuine, as confirmed through the system's authentication and authorization mechanism.</li>
<li><strong>Integrity</strong>: In a secured system, data tampering is not possible, so the data is secure.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a web test project</h1>
                </header>
            
            <article>
                
<p class="mce-root">Unit testing is the one that checks code health. This means that if the code is buggy (unhealthy), that would be the basis of many unknown and unwanted issues in the application. To overcome this approach, we could follow the TDD approach.</p>
<div class="packt_infobox">You can practice TDD with Katas. You can refer to <a href="https://www.codeproject.com/Articles/886492/Learning-Test-Driven-Development-with-TDD-Katas">https://www.codeproject.com/Articles/886492/Learning-Test-Driven-Development-with-TDD-Katas</a> to find out more about TDD katas. If you want to practice this approach, use this repository: <a href="https://github.com/garora/TDD-Katas">https://github.com/garora/TDD-Katas</a>.<a href="https://github.com/garora/TDD-Katas"/></div>
<p>We have already discussed a lot about TDD in previous chapters, so we are not going to discuss this in detail here. Instead, let's create a test project as follows:</p>
<ol>
<li>Open our web application.</li>
<li>From <span class="packt_screen">Solution Explorer</span> in <span class="packt_screen">Visual Studio</span>, right-click on <span class="packt_screen">Solution</span> and click on <span class="packt_screen">Add</span> | <span class="packt_screen">New Project...</span>, as shown in the following screenshot:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/7fce068c-4813-4bfd-b558-c91398c93cfb.png" style=""/></div>
<ol start="3">
<li>From the <span class="packt_screen">Add New Project</span> template, select <span class="packt_screen">.NET Core and xUnit Test Project (.NET Core)</span> and provide a meaningful name:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/68d046c1-29af-4cb9-a4c1-c6a62a091e86.png" style=""/></div>
<p style="padding-left: 60px">You will get a default unit <kbd>test</kbd> class with an empty test code, as shown in the following code snippet:</p>
<pre style="padding-left: 60px">namespace Product_Test<br/>{<br/>    public class UnitTest1<br/>    {<br/>        [Fact]<br/>        public void Test1()<br/>        {<br/>        }<br/>    }<br/>}</pre>
<p style="padding-left: 60px">You can change the name of this class or discard this class if you want to write your own <kbd>test</kbd> class:</p>
<pre style="padding-left: 60px">public class ProductData<br/>{<br/>    public IEnumerable&lt;ProductViewModel&gt; GetProducts()<br/>    {<br/>        var productVm = new List&lt;ProductViewModel&gt;<br/>        {<br/>            new ProductViewModel<br/>            {<br/>                CategoryId = Guid.NewGuid(),<br/>                CategoryDescription = "Category Description",<br/>                CategoryName = "Category Name",<br/>                ProductDescription = "Product Description",<br/>                ProductId = Guid.NewGuid(),<br/>                ProductImage = "Image full path",<br/>                ProductName = "Product Name",<br/>                ProductPrice = 112M<br/>            },<br/>           ... <br/>        };<br/><br/>        return productVm;<br/>    }</pre>
<ol start="4">
<li>The previous code is from our newly added <kbd>ProductDate</kbd><span> class. P</span><span>lease add this to a new folder called <kbd>Fake</kbd>. This class just creates dummy data so that we can test our web application for the product:</span></li>
</ol>
<pre style="padding-left: 60px">public class ProductTests<br/>{<br/>    [Fact]<br/>    public void Get_Returns_ActionResults()<br/>    {<br/>        // Arrange<br/>        var mockRepo = new Mock&lt;IProductRepository&gt;();<br/>        mockRepo.Setup(repo =&gt; repo.GetAll()).Returns(new ProductData().GetProductList());<br/>        var controller = new ProductController(mockRepo.Object);<br/><br/>        // Act<br/>        var result = controller.GetList();<br/><br/>        // Assert<br/>        var viewResult = Assert.IsType&lt;OkObjectResult&gt;(result);<br/>        var model = Assert.IsAssignableFrom&lt;IEnumerable&lt;ProductViewModel&gt;&gt;(viewResult.Value);<br/>        Assert.NotNull(model);<br/>        Assert.Equal(2, model.Count());<br/>    }<br/>}</pre>
<ol start="5">
<li>Add a new file called <kbd>ProductTests</kbd> in the <kbd>Services</kbd> folder. Please note that we are using <kbd>Stubs</kbd> and <kbd>Mocks</kbd> in this code.</li>
</ol>
<p style="padding-left: 60px">Our previous code will complain about the error using red squiggly lines, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/de3be8e2-682c-40e9-a3ac-2c5f2bc64507.png"/></div>
<ol start="6">
<li>The previous code has errors as we did not add certain packages that were required for us to perform tests. To overcome these errors, we should install <kbd>moq</kbd> support to our <kbd>test</kbd> project. Pass the following command in your <span class="packt_screen">Package Manager Console</span>:</li>
</ol>
<pre style="padding-left: 60px">i<strong>nstall-package moq</strong> </pre>
<ol start="7">
<li>The preceding <span>command </span>will install the <kbd>moq</kbd> framework in the test project. Please note that while firing the preceding command, you should select the test project that we have created:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/0f6d860c-70f3-447d-b6a2-e3bdd6e3ec46.png"/></div>
<p style="padding-left: 60px">Once <kbd>moq</kbd> is installed, you can go ahead and start testing.</p>
<div class="packt_tip">Important points to note while you're working with the <kbd>xUnit</kbd> test projects are as follows:<br/>
<ul>
<li><strong>Fact</strong> is an attribute and is used for a normal test method that is without parameters.</li>
<li><strong>Theory</strong> is an attribute and is used for a parameterized test method.</li>
</ul>
</div>
<ol start="8">
<li>All set. Now, click on <span class="packt_screen">Test explorer</span> and run your tests:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/f0688d2c-d36b-46e4-9c3f-a397ad044b51.png" style=""/></div>
<p>Finally, our tests have passed! This means that our controller methods are good, and we do not have any issues or bugs in our code that can break the functionality of the application/system.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>The main goal of this chapter was to make it possible for our web application to safeguard against unattended requests. This chapter covered a step-by-step creation of a web application using Visual Studio and discussed authentication and authorization. We also discussed TDD and created a new xUnit web test project where we used <kbd>Stubs</kbd> and <kbd>Mocks</kbd>.</p>
<p>In the next chapter, we will discuss the best practices and patterns while using concurrent programming in .NET Core.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Questions</h1>
                </header>
            
            <article>
                
<p class="mce-root"><span>The following questions will allow you to consolidate the information contained in this chapter:</span></p>
<ol>
<li>What are authentication and authorization?</li>
<li>Is it safe to use authentication at the first level of request and then allow incoming requests for restricted areas?</li>
<li>How can you prove that authorization always comes after authentication?</li>
<li>What is TDD and why do developers care about it?</li>
<li>Define TDD katas. How do they help us to improve our TDD approach?</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Further reading</h1>
                </header>
            
            <article>
                
<p>Congratulations, you've completed this chapter! To learn more about the topics covered in this chapter, refer to the following books:</p>
<ul>
<li><em>Building RESTful Web services with .NET Core</em>, by <em>Gaurav Aroraa, Tadit Dash</em>, published by <em>Packt Publishing</em>: <a href="https://www.packtpub.com/application-development/building-restful-web-services-net-core">https://www.packtpub.com/application-development/building-restful-web-services-net-core</a><a href="https://www.packtpub.com/application-development/building-restful-web-services-net-core"/></li>
<li><em>C# and .NET Core Test Driven Development</em>, by <em>Ayobami Adewole</em>, published by <em>Packt Publishing</em>: <a href="https://www.packtpub.com/in/application-development/c-and-net-core-test-driven-development">https://www.packtpub.com/in/application-development/c-and-net-core-test-driven-development</a><a href="https://www.packtpub.com/in/application-development/c-and-net-core-test-driven-development"/></li>
</ul>


            </article>

            
        </section>
    </body></html>