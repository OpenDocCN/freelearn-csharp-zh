<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;Improving Games with Extra Features and Optimization"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Improving Games with Extra Features and Optimization</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Pausing the game</li><li class="listitem" style="list-style-type: disc">Implementing slow motion</li><li class="listitem" style="list-style-type: disc">Preventing your game from running on unknown servers</li><li class="listitem" style="list-style-type: disc">State-driven behavior Do-It-Yourself states</li><li class="listitem" style="list-style-type: disc">State-driven behavior using the State Design pattern</li><li class="listitem" style="list-style-type: disc">Reducing the number of objects by destroying objects at a death time</li><li class="listitem" style="list-style-type: disc">Reducing the number of enabled objects by disabling objects whenever possible</li><li class="listitem" style="list-style-type: disc">Reducing the number of active objects by making objects inactive whenever possible</li><li class="listitem" style="list-style-type: disc">Improving efficiency with delegates and events and avoiding SendMessage!</li><li class="listitem" style="list-style-type: disc">Executing methods regularly but independent of frame rate with coroutines</li><li class="listitem" style="list-style-type: disc">Spreading long computations over several frames with coroutines</li><li class="listitem" style="list-style-type: disc">Evaluating performance by measuring max and min frame rates (FPS)</li><li class="listitem" style="list-style-type: disc">Identifying performance bottlenecks with the Unity performance Profiler</li><li class="listitem" style="list-style-type: disc">Identifying performance bottlenecks with Do-It-Yourself performance profiling</li><li class="listitem" style="list-style-type: disc">Cache GameObject and component references to avoid expensive lookups</li><li class="listitem" style="list-style-type: disc">Improving performance with LOD groups</li><li class="listitem" style="list-style-type: disc">Improving performance through reduced draw calls by designing for draw call batching</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec107"/>Introduction</h1></div></div></div><p>The first three recipes in this chapter provide some ideas for adding some extra features to your game (pausing, slow motion, and securing online games). The next two recipes then present ways to manage complexity in your games through managing states and their transitions.</p><p>The rest of the recipes in this chapter provide examples of how to investigate and improve the efficiency and performance of your game. Each of these optimization recipes begins by stating an optimization principle that it embodies.</p><div class="section" title="The big picture"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec332"/>The big picture</h2></div></div></div><p>Before getting on with<a class="indexterm" id="id1163"/> the recipes, let's step back and think about the different parts of Unity games and how their construction and runtime behavior can impact on game performance.</p><p>Games are made up of several different kinds of components:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Audio assets</li><li class="listitem" style="list-style-type: disc">2D and 3D graphical assets</li><li class="listitem" style="list-style-type: disc">Text and other file assets</li><li class="listitem" style="list-style-type: disc">Scripts</li></ul></div><p>When a game is running, there are many competing processing requirements for your CPU and GPU, including:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Audio processing</li><li class="listitem" style="list-style-type: disc">Script processing</li><li class="listitem" style="list-style-type: disc">2D physics processing</li><li class="listitem" style="list-style-type: disc">3D physics processing</li><li class="listitem" style="list-style-type: disc">Graphical rendering</li><li class="listitem" style="list-style-type: disc">GPU processing</li></ul></div><p>One way to reduce the complexity of graphical computations and to improve frame rates is to use simpler models whenever possible—this is the reduction of the <span class="strong"><strong>Level Of Detail</strong></span> (<span class="strong"><strong>LOD</strong></span>). The general strategy is to identify situations where a simpler model will not degrade the user's experience. Typically, situations include where a model is only taking up a small part of the screen (so less detail in the model will not change what the user sees), when objects are moving very fast across the screen (so the user is unlikely to have time to notice less detail), or where we are sure the users' visual focus is elsewhere (for example, in a car racing game, the user is not looking at the quality of the trees but on the road ahead). We provide a LOD recipe, <span class="emphasis"><em>Improving performance with LOD groups</em></span>, in this chapter.</p><p>Unity's draw call batching may actually be <span class="emphasis"><em>more efficient</em></span> than you or your team's 3D modelers are at reducing the triangle/vertex geometry. So, it may be that by manually simplifying a 3D model, you have removed Unity's opportunity to apply its highly effective vertex reduction algorithms; then, the geometric complexity may be larger for a small model than for a larger model, and so a smaller model may lead to a lower game performance! One<a class="indexterm" id="id1164"/> recipe presents advice collected from several sources and the location of tools to assist in different strategies to try to reduce draw calls and improve graphical performance.</p><p>We will present several recipes allowing you to analyze actual processing times and frame rates, so that you can collect data to confirm whether your design decisions are having the desired efficiency improvements.</p><div class="blockquote"><table border="0" cellpadding="0" cellspacing="0" class="blockquote" summary="Block quote" width="100%"><tr><td valign="top"> </td><td valign="top"><p><span class="emphasis"><em>"You have a limited CPU budget and you have to live with it"</em></span></p></td><td valign="top"> </td></tr><tr><td valign="top"> </td><td align="right" colspan="2" style="text-align: center" valign="top">--<span class="attribution"><span class="emphasis"><em>Joachim Ante, Unite-07</em></span></span></td></tr></table></div><p>At the end of the day, the best <span class="emphasis"><em>balance</em></span> of heuristic strategies for your particular game project can only be discovered by an investment of time and hard work, and some form of profiling investigation. Certain strategies (such as caching to reduce component reflection lookups) should perhaps be standard practice in all projects, while other strategies may require <span class="emphasis"><em>tweaking</em></span> for each unique game and level, to find which approaches work effectively to improve efficiency, frame rates, and, most importantly, the user experience when playing the game.</p><div class="blockquote"><blockquote class="blockquote"><p><span class="emphasis"><em>"Premature Optimization is the root of all evil"</em></span></p><p><span class="emphasis"><em>Donald Knuth, "Structured Programming With Go To Statements". Computing Surveys, Vol 6, No 4, December 1974</em></span></p></blockquote></div><p>Perhaps, the core strategy to take away from this chapter is that there are many parts of a game that are candidates for possible optimization, and you should drive the actual optimizations you finally implement for a particular game based on the evidence you gain by profiling its performance.</p></div></div></div>
<div class="section" title="Pausing the game"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec108"/>Pausing the game</h1></div></div></div><p>As compelling as<a class="indexterm" id="id1165"/> your next game will be, you should always let players pause it for a short break. In this recipe, we will implement a simple and effective pause screen including controls for changing the display's quality settings.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec333"/>Getting ready</h2></div></div></div><p>For this recipe, we have prepared a package named <code class="literal">BallGame</code> containing a playable scene. The package is in the <code class="literal">1362_11_01</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec334"/>How to do it...</h2></div></div></div><p>To pause<a class="indexterm" id="id1166"/> your game upon pressing the <span class="emphasis"><em>Esc</em></span> key, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Import the <code class="literal">BallGame</code> package into your project and, from the <span class="strong"><strong>Project</strong></span> view, open the level named <code class="literal">BallGame_01</code>.</li><li class="listitem">In the <span class="strong"><strong>Inspector</strong></span>, create a new tag <span class="strong"><strong>Ball</strong></span>, apply this tag to prefab <code class="literal">ball</code> in <code class="literal">Prefabs</code> folder, and save the scene.</li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, use the <span class="strong"><strong>Create</strong></span> drop-down menu to add a <span class="strong"><strong>Panel</strong></span> to the UI (<span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Panel</strong></span>). Note that it will automatically add it to the current <span class="strong"><strong>Canvas</strong></span> in the scene. Rename the panel <code class="literal">QualityPanel</code>.</li><li class="listitem">Now use the <span class="strong"><strong>Create</strong></span> drop-down menu to add a <span class="strong"><strong>Slider</strong></span> to the UI (<span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Slider</strong></span>). Rename it <code class="literal">QualitySlider</code>.</li><li class="listitem">Finally, use the <span class="strong"><strong>Create</strong></span> drop-down menu to add a <span class="strong"><strong>Text</strong></span> to the UI (<span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Text</strong></span>). Rename it <code class="literal">QualityLabel</code>. Also, from the <span class="strong"><strong>Inspector</strong></span> view, <span class="strong"><strong>Rect Transform</strong></span>, change its <span class="strong"><strong>Pos Y</strong></span> to <span class="strong"><strong>-25</strong></span>.</li><li class="listitem">Add the following C# script <span class="strong"><strong>PauseGame</strong></span> to <span class="strong"><strong>First Person Controller</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using UnityEngine.UI;
using System.Collections;

public class PauseGame : MonoBehaviour {
  public GameObject qPanel;
  public GameObject qSlider;
  public GameObject qLabel;
  public bool expensiveQualitySettings = true;
  private bool isPaused = false;

  void Start () {
    Cursor.visible = isPaused;
    Slider slider = qSlider.GetComponent&lt;Slider&gt; ();
    slider.maxValue = QualitySettings.names.Length;
    slider.value = QualitySettings.GetQualityLevel ();
    qPanel.SetActive(false);
  }

  void Update () {
    if (Input.GetKeyDown(KeyCode.Escape)) {
      isPaused = !isPaused;
      SetPause ();
    }
  }

  private void SetPause(){
    float timeScale = !isPaused ? 1f : 0f;
    Time.timeScale = timeScale;
    Cursor.visible = isPaused;
    GetComponent&lt;MouseLook&gt; ().enabled = !isPaused;
    qPanel.SetActive (isPaused);
  }

  public void SetQuality(float qs){
    int qsi = Mathf.RoundToInt (qs);
    QualitySettings.SetQualityLevel (qsi);
    Text label = qLabel.GetComponent&lt;Text&gt; ();
    label.text = QualitySettings.names [qsi];
  }
}</pre></div></li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, select the <span class="strong"><strong>First Person Controller</strong></span>. Then, from the <span class="strong"><strong>Inspector</strong></span>, access the <span class="strong"><strong>Pause Game</strong></span> component and populate the <span class="strong"><strong>QPanel</strong></span>, <span class="strong"><strong>QSlider</strong></span>, and<a class="indexterm" id="id1167"/> <span class="strong"><strong>QLabel</strong></span> fields with the game objects <span class="strong"><strong>QualityPanel</strong></span>, <span class="strong"><strong>QualitySlider</strong></span>, and <span class="strong"><strong>QualityLabel</strong></span> respectively, as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_01.jpg"/></div></li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, select <span class="strong"><strong>QualitySlider</strong></span>. Then, from the <span class="strong"><strong>Inspector</strong></span> view, <span class="strong"><strong>Slider</strong></span> component, find the list named <span class="strong"><strong>On Value Changed (Single)</strong></span>, and click on the <span class="strong"><strong>+</strong></span> sign to add a command.</li><li class="listitem">Drag the <span class="strong"><strong>First Person Controller</strong></span> from the <span class="strong"><strong>Hierarchy</strong></span> view into the game object field of the<a class="indexterm" id="id1168"/> new command. Then, use the function selector to find the <span class="strong"><strong>SetQuality </strong></span>function under <span class="strong"><strong>Dynamic float</strong></span> (<span class="strong"><strong>No Function</strong></span> | <span class="strong"><strong>PauseGame</strong></span> | <span class="strong"><strong>Dynamic float</strong></span> | <span class="strong"><strong>SetQuality</strong></span>), as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_02.jpg"/></div></li><li class="listitem">When you play the scene, you should be able to pause/resume the game by pressing the <span class="emphasis"><em>Esc</em></span> key, also activating a slider that controls the game's quality settings.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_03.jpg"/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec335"/>How it works...</h2></div></div></div><p>Pausing the game is actually an easy, straightforward task in Unity: all we need to do is set the game's <span class="strong"><strong>Time Scale</strong></span> to <code class="literal">0</code> (and set it back to <code class="literal">1</code> to resume). In our code, we have included such a <a class="indexterm" id="id1169"/>command within the <code class="literal">SetPause()</code> function, which is called whenever the player presses the <span class="emphasis"><em>Esc</em></span> key, also toggling the <code class="literal">isPaused</code> variable. To make things more functional, we have included a <span class="strong"><strong>GUI panel</strong></span> featuring a <span class="emphasis"><em>QualitySettings</em></span> slider that is activated whenever the game is paused.</p><div class="mediaobject"><img alt="How it works..." src="graphics/1362OT_11_04.jpg"/></div><p>Regarding the behavior for the QualitySettings slider and text, their parameters are adjusted at the start based on the game's variety of quality settings, their names, and its current state. Then, changes in the slider's value redefine the quality settings, also updating the label text accordingly.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec336"/>There's more...</h2></div></div></div><p>You can always<a class="indexterm" id="id1170"/> add more functionality to the <span class="emphasis"><em>pause</em></span> screen by displaying sound volume controls, save/load buttons, and so on.</p><div class="section" title="Learning more about QualitySettings"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec87"/>Learning more about QualitySettings</h3></div></div></div><p>Our code for changing quality settings is a slight modification of the example given by Unity's documentation. If <a class="indexterm" id="id1171"/>you want to learn more about the subject, check out <a class="ulink" href="http://docs.unity3d.com/ScriptReference/QualitySettings.html">http://docs.unity3d.com/ScriptReference/QualitySettings.html</a>.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec337"/>See also</h2></div></div></div><p>Refer to the <span class="emphasis"><em>Implementing slow motion</em></span> recipe<a class="indexterm" id="id1172"/> in this chapter for more information.</p></div></div>
<div class="section" title="Implementing slow motion"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec109"/>Implementing slow motion</h1></div></div></div><p>Since Remedy Entertainment's <span class="emphasis"><em>Max Payne</em></span>, slow motion, or bullet time, became a popular feature in games. For example, Criterion's <span class="emphasis"><em>Burnout</em></span> series has successfully explored the slow motion effect in the <a class="indexterm" id="id1173"/>racing genre. In this recipe, we will implement a slow motion effect triggered by the pressing of the mouse's right button.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec338"/>Getting ready</h2></div></div></div><p>For this recipe, we will use the same package as the previous recipe, <code class="literal">BallGame</code> in the <code class="literal">1362_11_02</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec339"/>How to do it...</h2></div></div></div><p>To implement slow motion, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Import the <code class="literal">BallGame</code> package into your project and, from the <span class="strong"><strong>Project</strong></span> view, open the level named <code class="literal">BallGame_01</code>.</li><li class="listitem">In the <span class="strong"><strong>Inspector</strong></span>, create a new tag <span class="strong"><strong>Ball</strong></span>, apply this tag to prefab <code class="literal">ball</code> in the <code class="literal">Prefabs</code> folder, and save the scene.</li><li class="listitem">Add the<a class="indexterm" id="id1174"/> following C# script <span class="strong"><strong>BulletTime</strong></span> to <span class="strong"><strong>First Person Controller</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using UnityEngine.UI;
using System.Collections;

public class BulletTime : MonoBehaviour
{
    public float sloSpeed = 0.1f;
    public float totalTime = 10f;
    public float recoveryRate = 0.5f;
    public Slider EnergyBar;
    private float elapsed = 0f;
    private bool isSlow = false;

    void Update ()
    {

        if (Input.GetButtonDown ("Fire2") &amp;&amp; elapsed &lt; totalTime)
            SetSpeed (sloSpeed);

        if (Input.GetButtonUp ("Fire2"))
            SetSpeed (1f);

        if (isSlow) {
            elapsed += Time.deltaTime / sloSpeed;
            if (elapsed &gt;= totalTime) {
                SetSpeed (1f);
            }

        } else {
            elapsed -= Time.deltaTime * recoveryRate;
            elapsed = Mathf.Clamp (elapsed, 0, totalTime);
        }
        float remainingTime = (totalTime - elapsed) / totalTime;
        EnergyBar.value = remainingTime;
    }

    private void SetSpeed (float speed)
    {
        Time.timeScale = speed;
        Time.fixedDeltaTime = 0.02f * speed;
        isSlow = !(speed &gt;= 1.0f);
    }
}</pre></div></li><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, use the <span class="strong"><strong>Create</strong></span> drop-down menu to add a <span class="strong"><strong>Slider</strong></span> to the UI (<span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Slider</strong></span>). Please note that it will be created as a child of the preexisting <span class="strong"><strong>Canvas</strong></span> object. Rename it <code class="literal">EnergySlider</code>.</li><li class="listitem">Select <span class="strong"><strong>EnergySlider</strong></span> and, from the <span class="strong"><strong>Inspector</strong></span> view, <span class="strong"><strong>Rect Transform</strong></span> component, set its<a class="indexterm" id="id1175"/> position as follows: <span class="strong"><strong>Left: 0</strong></span>; <span class="strong"><strong>Pos Y: 0</strong></span>; <span class="strong"><strong>Pos Z: 0</strong></span>; <span class="strong"><strong>Right: 0</strong></span>; <span class="strong"><strong>Height: 50</strong></span>. Then, expand the <span class="strong"><strong>Anchors</strong></span> settings and change it to: <span class="strong"><strong>Min X: 0</strong></span>; <span class="strong"><strong>Y: 1</strong></span>; <span class="strong"><strong>Max X: 0.5</strong></span>; <span class="strong"><strong>Y: 1</strong></span>; <span class="strong"><strong>Pivot X: 0</strong></span>; <span class="strong"><strong>Y: 1</strong></span>, as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_05.jpg"/></div></li><li class="listitem">Also select the <span class="strong"><strong>Handle Slide Area</strong></span> child and disable it from the <span class="strong"><strong>Inspector</strong></span> view, as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_06.jpg"/></div></li><li class="listitem">Finally, select the <span class="strong"><strong>First Person Controller</strong></span> from the <span class="strong"><strong>Hierarchy</strong></span> view, find the <span class="strong"><strong>Bullet Time</strong></span> component, and drag the <span class="strong"><strong>EnergySlider</strong></span> from the <span class="strong"><strong>Hierarchy</strong></span> view into its <span class="strong"><strong>Energy Bar</strong></span> slot, as shown in the next screenshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_07.jpg"/></div></li><li class="listitem">Play your game. You should be able to activate slow motion by holding down the right mouse button (or whatever alternative you have set for <span class="strong"><strong>Input</strong></span> axis <span class="strong"><strong>Fire2</strong></span>). The slider will act as a progress bar that slowly shrinks, indicating the<a class="indexterm" id="id1176"/> remaining <span class="emphasis"><em>bullet time</em></span> you have.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec340"/>How it works...</h2></div></div></div><p>Basically, all we need to do to have the slow motion effect is decrease the <code class="literal">Time.timeScale</code> variable. In our script, we do that by using the <code class="literal">sloSpeed</code> variable. Please note that we also need to adjust the <code class="literal">Time.fixedDeltaTime</code> variable, updating the physics simulation of our game.</p><p>In order to make the experience more challenging, we have also implemented a sort of <span class="emphasis"><em>energy bar</em></span> to indicate how much bullet time the player has left (the initial value is given, in seconds, by the <code class="literal">totalTime</code> variable). Whenever the player is not using bullet time, he has his quota filled according to the <code class="literal">recoveryRate</code> variable.</p><p>Regarding the <span class="emphasis"><em>GUI slider</em></span>, we have used the <span class="strong"><strong>Rect Transform</strong></span> settings to place it on the top-left corner and set its dimensions to half of the screen's width and 50 pixels tall. Also, we have hidden the <span class="emphasis"><em>handle slide area</em></span> to make it more similar to a traditional energy bar. Finally, instead of allowing direct interaction from the player with the slider, we have used the <code class="literal">BulletTime</code> script to change the slider's value.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec341"/>There's more...</h2></div></div></div><p>Some suggestions for <a class="indexterm" id="id1177"/>you to improve your slow motion effect even further are as follows.</p><div class="section" title="Customizing the slider"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec88"/>Customizing the slider</h3></div></div></div><p>Don't forget that<a class="indexterm" id="id1178"/> you can personalize the slider's appearance by creating your own sprites, or even by changing the slider's <span class="emphasis"><em>fill</em></span> color based on the slider's value. Try adding the following lines of code to the end of the <code class="literal">Update</code> function:</p><div class="informalexample"><pre class="programlisting">GameObject fill = GameObject.Find("Fill").gameObject;
Color sliderColor = Color.Lerp(Color.red, Color.green, remainingTime);
fill.GetComponent&lt;Image&gt; ().color = sliderColor;</pre></div></div><div class="section" title="Adding Motion Blur"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec89"/>Adding Motion Blur</h3></div></div></div><p>
<span class="strong"><strong>Motion Blur</strong></span> is an image effect frequently identified with slow motion. Once attached to the camera, it could be enabled or <a class="indexterm" id="id1179"/>disabled<a class="indexterm" id="id1180"/> depending on the <code class="literal">speed</code> float value. For more information on the Motion Blur<a class="indexterm" id="id1181"/> image effect, refer to <a class="ulink" href="http://docs.unity3d.com/Manual/script-MotionBlur.html">http://docs.unity3d.com/Manual/script-MotionBlur.html</a>.</p></div><div class="section" title="Creating sonic ambience"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec90"/>Creating sonic ambience</h3></div></div></div><p>
<span class="emphasis"><em>Max Payne</em></span> famously <a class="indexterm" id="id1182"/>used a strong, heavy heartbeat sound as sonic ambience. You could also try lowering the sound effects volume to convey the character focus when in slow motion. Plus, using audio filters on the camera could be an interesting option.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec342"/>See also</h2></div></div></div><p>Refer to the recipe <span class="emphasis"><em>Pausing the game</em></span> in this chapter for more information.</p></div></div>
<div class="section" title="Preventing your game from running on unknown servers"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec110"/>Preventing your game from running on unknown servers</h1></div></div></div><p>After all the hard <a class="indexterm" id="id1183"/>work you've had to go through to complete your web game project, it wouldn't be fair if it ended up generating traffic and income on someone else's website. In this recipe, we will create a script that prevents the main game menu from showing up unless it's hosted by an authorized server.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec343"/>Getting ready</h2></div></div></div><p>To test this recipe, you will need access to a webspace provider where you can host the game.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec344"/>How to do it...</h2></div></div></div><p>To prevent your web <a class="indexterm" id="id1184"/>game from being pirated, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">From the <span class="strong"><strong>Hierarchy</strong></span> view, use the <span class="strong"><strong>Create</strong></span> drop-down menu to create a <span class="strong"><strong>UI Text</strong></span> GameObject (<span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>UI</strong></span> | <span class="strong"><strong>Text</strong></span>). Name it <code class="literal">Text – warning</code>. Then, from the <span class="strong"><strong>Text</strong></span> component in the <span class="strong"><strong>Inspector</strong></span>, change its <span class="strong"><strong>text</strong></span> field to <code class="literal">Getting Info. Please wait</code>.</li><li class="listitem">Add the following C# script to the <code class="literal">Text – warning</code> game object:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
using UnityEngine.UI;

public class BlockAccess : MonoBehaviour {
  public bool checkDomain = true;
  public bool fullURL = true;
  public string[] domainList;
  public string warning;


  private void Start(){
    Text scoreText = GetComponent&lt;Text&gt;();
    bool illegalCopy = true;

    if (Application.isEditor)
      illegalCopy = false;

    if (Application.isWebPlayer &amp;&amp; checkDomain){
      for (int i = 0; i &lt; domainList.Length; i++){
        if (Application.absoluteURL == domainList[i]){
          illegalCopy = false;
        }else if (Application.absoluteURL.Contains(domainList[i]) &amp;&amp; !fullURL){
          illegalCopy = false;
        }
      }
    }

    if (illegalCopy)
      scoreText.text = warning;
    else
      Application.LoadLevel(Application.loadedLevel + 1);
  }
}</pre></div></li><li class="listitem">From the <span class="strong"><strong>Inspector</strong></span> view, leave the options <span class="strong"><strong>Check Domain</strong></span> and <span class="strong"><strong>Full URL</strong></span> checked, and increase <span class="strong"><strong>Size</strong></span> of <span class="strong"><strong>Domain List</strong></span> to <code class="literal">1</code> and fill out <span class="strong"><strong>Element 0</strong></span> with the complete <a class="indexterm" id="id1185"/>URL for your game. Type in the sentence <code class="literal">This is not a valid copy of the game</code> in the <span class="strong"><strong>Message</strong></span> field, as shown in the following screenshot. You might have to change the paragraph's <span class="strong"><strong>Horizontal Overflow</strong></span> to <span class="strong"><strong>Overflow</strong></span>.<div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note56"/>Note</h3><p>Note: Remember to include the Unity 3D file name and extension in the URL, and not the HTML where it is embedded.</p></div></div><div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_08.jpg"/></div></li><li class="listitem">Save your scene as <code class="literal">menu</code>.</li><li class="listitem">Create a new scene and change its <span class="strong"><strong>Main Camera</strong></span> background color to black. Save this scene as <code class="literal">nextLevel</code>.</li><li class="listitem">Let's build the game. Go to the <span class="strong"><strong>File | Build Settings…</strong></span> menu and include the scenes <span class="strong"><strong>menu</strong></span> and <span class="strong"><strong>nextLevel</strong></span>, in that order, in the build list (<span class="strong"><strong>Scenes</strong></span> in <span class="strong"><strong>Build</strong></span>). Also, select <span class="strong"><strong>Web Player</strong></span> as your platform and click on <span class="strong"><strong>Build</strong></span>.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec345"/>How it works...</h2></div></div></div><p>As soon as the scene starts, the script compares the actual URL of the <code class="literal">.unity3d</code> file to the ones listed in the <code class="literal">Block Access</code> component. If they don't match, the next level in the build is not loaded and a message appears on the screen. If they do match, the line of code <code class="literal">Application.LoadLevel(Application.loadedLevel + 1)</code> will load the next scene from the<a class="indexterm" id="id1186"/> build list.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec346"/>There's more...</h2></div></div></div><p>Here is some information on how to fine tune and customize this recipe.</p><div class="section" title="Improving security by using full URLs in your domain list"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec91"/>Improving security by using full URLs in your domain list</h3></div></div></div><p>Your game will be<a class="indexterm" id="id1187"/> more secure if you fill out the domain list with complete URLs (such as <a class="ulink" href="http://www.myDomain.com/unitygame/game.unity3d">http://www.myDomain.com/unitygame/game.unity3d</a>). In fact, it's recommended that you leave the <span class="strong"><strong>Full URL</strong></span> option selected so that your game won't be stolen and published under a URL such as <code class="literal">www.stolenGames.com/yourgame.html?www.myDomain.com</code>.</p></div><div class="section" title="Allowing redistribution with more domains"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec92"/>Allowing redistribution with more domains</h3></div></div></div><p>If you want <a class="indexterm" id="id1188"/>your game to run from several different domains, increase <span class="strong"><strong>Size</strong></span> and fill out more URLs. Also, you can leave your game completely free of protection by leaving the <span class="strong"><strong>Check Domain</strong></span> option unchecked.</p></div></div></div>
<div class="section" title="State-driven behavior Do-It-Yourself states"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec111"/>State-driven behavior Do-It-Yourself states</h1></div></div></div><p>Games as a whole, and individual objects or characters, can often be thought of (or modeled as) passing through different <span class="emphasis"><em>states</em></span> or <span class="emphasis"><em>modes</em></span>. Modeling states and changes of state (due to <span class="emphasis"><em>events</em></span> or game conditions) is a very common way to manage the complexity of games and game components. In this recipe, we create a simple three-state game (game playing/game <a class="indexterm" id="id1189"/>won/game lost) using a single <code class="literal">GameManager</code> class.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec347"/>How to do it...</h2></div></div></div><p>To use states to manage object behavior, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create two UI buttons at the top middle of the screen. Name one <span class="strong"><strong>Button-win</strong></span> and edit its text to read <span class="strong"><strong>Win Game</strong></span>. Name the second <span class="strong"><strong>Button-lose</strong></span> and edit its text to read <span class="strong"><strong>Lose Game</strong></span>.</li><li class="listitem">Create a UI text object at the top left of the screen. Name this <span class="strong"><strong>Text-state-messages</strong></span>, and set its <span class="strong"><strong>Rect Transform</strong></span> height property to <span class="strong"><strong>300</strong></span> and its <span class="strong"><strong>Text (Script) Paragraph Vertical Overflow</strong></span> property to <span class="strong"><strong>Overflow</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_38.jpg"/></div></li><li class="listitem">Add the<a class="indexterm" id="id1190"/> following C# script class <code class="literal">GameManager</code> to <span class="strong"><strong>Main Camera</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
using System;
using UnityEngine.UI;

public class GameManager : MonoBehaviour {
  public Text textStateMessages;
  public Button buttonWinGame;
  public Button buttonLoseGame;

  private enum GameStateType {
    Other,
    GamePlaying,
    GameWon,
    GameLost,
  }

  private GameStateType currentState = GameStateType.Other;
  private float timeGamePlayingStarted;
  private float timeToPressAButton = 5;

  void Start () {
    NewGameState( GameStateType.GamePlaying );
  }

  private void NewGameState(GameStateType newState) {
    // (1) state EXIT actions
    OnMyStateExit(currentState);

    // (2) change current state
    currentState = newState;

    // (3) state ENTER actions
    OnMyStateEnter(currentState);

    PostMessageDivider();
  }

  public void PostMessageDivider(){
    string newLine = "\n";
    string divider = "--------------------------------";
    textStateMessages.text += newLine + divider;
  }

  public void PostMessage(string message){
    string newLine = "\n";
    string timeTo2DecimalPlaces = String.Format("{0:0.00}", Time.time);
    textStateMessages.text += newLine + timeTo2DecimalPlaces + " :: " + message;
  }

  public void BUTTON_CLICK_ACTION_WIN_GAME(){
    string message = "Win Game BUTTON clicked";
    PostMessage(message);
    NewGameState( GameStateType.GameWon );
  }

  public void BUTTON_CLICK_ACTION_LOSE_GAME(){
    string message = "Lose Game BUTTON clicked";
    PostMessage(message);
    NewGameState( GameStateType.GameLost );
  }

  private void DestroyButtons(){
    Destroy (buttonWinGame.gameObject);
    Destroy (buttonLoseGame.gameObject);
  }

  //--------- OnMyStateEnter[ S ] - state specific actions
  private void OnMyStateEnter(GameStateType state){
    string enterMessage = "ENTER state: " + state.ToString();
    PostMessage(enterMessage);

    switch (state){
    case GameStateType.GamePlaying:
      OnMyStateEnterGamePlaying();
      break;
    case GameStateType.GameWon:
      // do nothing
      break;
    case GameStateType.GameLost:
      // do nothing
      break;
    }
  }

  private void OnMyStateEnterGamePlaying(){
    // record time we enter state
    timeGamePlayingStarted = Time.time;
  }

  //--------- OnMyStateExit[ S ] - state specific actions
  private void OnMyStateExit(GameStateType state){
    string exitMessage = "EXIT state: " + state.ToString();
    PostMessage(exitMessage);

    switch (state){
    case GameStateType.GamePlaying:
      OnMyStateExitGamePlaying();
      break;
    case GameStateType.GameWon:
      // do nothing
      break;
    case GameStateType.GameLost:
      // do nothing
      break;
    case GameStateType.Other:
      // cope with game starting in state 'Other'
      // do nothing
      break;
    }
  }

  private void OnMyStateExitGamePlaying(){
// if leaving gamePlaying state then destroy the 2 buttons
    DestroyButtons();
  }

  //--------- Update[ S ] - state specific actions
  void Update () {
    switch (currentState){
    case GameStateType.GamePlaying:
      UpdateStateGamePlaying();
      break;
    case GameStateType.GameWon:
      // do nothing
      break;
    case GameStateType.GameLost:
      // do nothing
      break;
    }
  }

  private void UpdateStateGamePlaying(){
    float timeSinceGamePlayingStarted = Time.time - timeGamePlayingStarted;
    if(timeSinceGamePlayingStarted &gt; timeToPressAButton){
      string message = "User waited too long - automatically going to Game LOST state";
      PostMessage(message);
      NewGameState(GameStateType.GameLost);
    }
  }
}</pre></div></li><li class="listitem">In the <span class="strong"><strong>Hierarchy</strong></span>, select the <span class="strong"><strong>Button-win</strong></span> button, and for its <span class="strong"><strong>Button (Script)</strong></span> component, add <a class="indexterm" id="id1191"/>an <code class="literal">OnClick</code> action to call the <code class="literal">BUTTON_CLICK_ACTION_WIN_GAME()</code> method from the <span class="strong"><strong>GameManager</strong></span> component in the <span class="strong"><strong>Main Camera</strong></span> GameObject.</li><li class="listitem">In the <span class="strong"><strong>Hierarchy</strong></span>, select the <span class="strong"><strong>Button-lose</strong></span> button, and for its <span class="strong"><strong>Button (Script)</strong></span> component, add an <code class="literal">OnClick</code> action to call the <code class="literal">BUTTON_CLICK_ACTION_LOSE_GAME() </code>method from the <span class="strong"><strong>GameManager</strong></span> component in the <span class="strong"><strong>Main Camera</strong></span> GameObject.</li><li class="listitem">In the <span class="strong"><strong>Hierarchy</strong></span>, select the <span class="strong"><strong>Main Camera</strong></span> GameObject. Next, drag into the <span class="strong"><strong>Inspector</strong></span> to ensure that all three <span class="strong"><strong>GameManager (Script)</strong></span> public variables, <span class="strong"><strong>Text State Messages</strong></span>, <span class="strong"><strong>Button Win Game</strong></span>, and<span class="strong"><strong> Button Lose Game</strong></span>, have the corresponding Canvas GameObjects dragged into them (the two buttons and the UI text GameObject).</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec348"/>How it works...</h2></div></div></div><p>As can be seen in the following state chart figure, this recipe models a simple game, which starts in the <span class="strong"><strong>GAME PLAYING</strong></span> state; then, depending on the button clicked by the user, the game moves either into the <span class="strong"><strong>GAME WON</strong></span> state or the <span class="strong"><strong>GAME LOST</strong></span> state. Also, if the user waits too long to click on a button, the game moves into the <span class="strong"><strong>GAME LOST</strong></span> state.</p><p>The possible states<a class="indexterm" id="id1192"/> of the system are defined using the enumerated type <code class="literal">GameStateType</code>, and the current state of the system at any point in time is stored in the <code class="literal">currentState</code> variable.</p><div class="mediaobject"><img alt="How it works..." src="graphics/1362OT_11_39.jpg"/></div><p>A fourth state is defined (<code class="literal">Other</code>) to allow us to explicitly set the desired <code class="literal">GamePlaying</code> state in our <code class="literal">Start()</code> method. When we wish the game state to be changed, we call the <code class="literal">NewGameState(…)</code>method, passing the new state the game is to change into. The <code class="literal">NewGameState(…)</code>method first calls the <code class="literal">OnMyStateExit(…)</code>method with the current state, since there may be actions to be performed when a particular state is exited; for example, when the <code class="literal">GamePlaying</code> state is exited, it destroys the two buttons. Next, the <code class="literal">NewGameState(…)</code>method sets the <code class="literal">currentState</code> variable to be assigned the new state. Next, the <code class="literal">OnMyStateEnter(…)</code> method is called, since there may be actions to be performed immediately when a new state is entered. Finally, a message divider is posted to the UI Text box, with a call to the <code class="literal">PostMessageDivider()</code>method.</p><p>When the <code class="literal">GameManager</code> object receives messages (for example, every frame for <code class="literal">Update()</code>), its behavior must be appropriate for the current state. So, we see in this method a <code class="literal">Switch</code> statement, which calls state-specific methods. For example, if the current state is <code class="literal">GamePlaying</code>, then when an <code class="literal">Update() </code>message is received, the <code class="literal">UpdateStateGamePlaying()</code>method will be called.</p><p>The <code class="literal">BUTTON_CLICK_ACTION_WIN_GAME()</code> and <code class="literal">BUTTON_CLICK_ACTION_LOSE_GAME()</code> methods are executed if their corresponding buttons have been clicked. They move the game into the corresponding <span class="strong"><strong>WIN</strong></span> or <span class="strong"><strong>LOSE</strong></span> state.</p><p>Logic has been written in the <code class="literal">UpdateStateGamePlaying() m</code>ethod, so once the <code class="literal">GameManager</code> has been in the <code class="literal">GamePlaying</code> state for more than a certain time (defined in variable <code class="literal">timeToPressAButton</code>), the game will automatically change into the <code class="literal">GameLost</code> state.</p><p>So, for each state, we may need to write methods for state exit, state entry, and update events, and also a main method for each event with a <code class="literal">Switch</code> statement to determine which state method should be called (or not). As can be imagined, the size of our methods and the <a class="indexterm" id="id1193"/>number of methods in our <code class="literal">GameManager</code> class will grow significantly as more states and a more complex game logic are needed for non-trivial games. The next recipe takes a more sophisticated approach to state-driven games, where each state has its own class.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec349"/>See also</h2></div></div></div><p>Refer to the next recipe in this chapter for more information on how to manage the complexity of states with class inheritance and the State Design Pattern.</p></div></div>
<div class="section" title="State-driven behavior using the State Design pattern"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec112"/>State-driven behavior using the State Design pattern</h1></div></div></div><p>The previous <a class="indexterm" id="id1194"/>pattern illustrated not only the usefulness of modeling game states, but also how a game manager class can grow in size and become unmanageable. To manage the complexity of many states and complex behaviors of states, the State pattern has been proposed in the <a class="indexterm" id="id1195"/>software development community. Design patterns are general purpose software component architectures that have been tried and tested and found to be good solutions to commonly occurring software system features. The key features of the State pattern are that each state is modeled by its own class and that all states inherit (are subclassed) from a single parent state class. The states need to know about each other in order to tell the game manager to change the current state. This is a small price to pay for the division of the complexity of the overall game behaviors into separate state classes.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note57"/>Note</h3><p>NOTE: Many thanks to the contribution from Bryan Griffiths which has helped improve this recipe.</p></div></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec350"/>Getting ready</h2></div></div></div><p>This recipe builds upon the previous recipe. So, make a copy of that project, open it, and then follow the steps for this recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec351"/>How to do it...</h2></div></div></div><p>To manage<a class="indexterm" id="id1196"/> an object's behavior using the state pattern architecture, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Replace<a class="indexterm" id="id1197"/> the contents of C# script class <code class="literal">GameManager</code> with the following:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
using UnityEngine.UI;

public class GameManager : MonoBehaviour {
  public Text textGameStateName;
  public Button buttonWinGame;
  public Button buttonLoseGame;

  public StateGamePlaying stateGamePlaying{get; set;}
  public StateGameWon stateGameWon{get; set;}
  public StateGameLost stateGameLost{get; set;}

  private GameState currentState;

  private void Awake () {
    stateGamePlaying = new StateGamePlaying(this);
    stateGameWon = new StateGameWon(this);
    stateGameLost = new StateGameLost(this);
  }

  private void Start () {
    NewGameState( stateGamePlaying );
  }

  private void Update () {
    if (currentState != null)
      currentState.StateUpdate();
  }

  public void NewGameState(GameState newState)
  {
    if( null != currentState)
      currentState.OnMyStateExit();

    currentState = newState;
    currentState.OnMyStateEntered();
  }

  public void DisplayStateEnteredMessage(string stateEnteredMessage){
    textGameStateName.text = stateEnteredMessage;
  }

  public void BUTTON_CLICK_ACTION_WIN_GAME(){
    if( null != currentState){
currentState.OnButtonClick(GameState.ButtonType.ButtonWinGame);
      DestroyButtons();
    }
  }

  public void BUTTON_CLICK_ACTION_LOSE_GAME(){
    if( null != currentState){
currentState.OnButtonClick(GameState.ButtonType.ButtonLoseGame);
      DestroyButtons();
    }
  }

  private void DestroyButtons(){
    Destroy (buttonWinGame.gameObject);
    Destroy (buttonLoseGame.gameObject);
  }
}</pre></div></li><li class="listitem">Create a <a class="indexterm" id="id1198"/>new C# script<a class="indexterm" id="id1199"/> class called <code class="literal">GameState</code>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public abstract class GameState {
  public enum ButtonType {
    ButtonWinGame,
    ButtonLoseGame
  }

  protected GameManager gameManager;
  public GameState(GameManager manager) {
    gameManager = manager;
  }

  public abstract void OnMyStateEntered();
  public abstract void OnMyStateExit();
  public abstract void StateUpdate();
  public abstract void OnButtonClick(ButtonType button);
}</pre></div></li><li class="listitem">Create a<a class="indexterm" id="id1200"/> new C# script<a class="indexterm" id="id1201"/> class called <code class="literal">StateGamePlaying</code>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class StateGamePlaying : GameState {
  public StateGamePlaying(GameManager manager):base(manager){}

  public override void OnMyStateEntered(){
    string stateEnteredMessage = "ENTER state: StateGamePlaying";
    gameManager.DisplayStateEnteredMessage(stateEnteredMessage);
    Debug.Log(stateEnteredMessage);
  }
  public override void OnMyStateExit(){}
  public override void StateUpdate() {}


  public override void OnButtonClick(ButtonType button){
    if( ButtonType.ButtonWinGame == button )
      gameManager.NewGameState(gameManager.stateGameWon);

    if( ButtonType.ButtonLoseGame == button )
      gameManager.NewGameState(gameManager.stateGameLost);
  }
}</pre></div></li><li class="listitem">Create a new C# script class called <code class="literal">StateGameWon</code>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class StateGameWon : GameState {
  public StateGameWon(GameManager manager):base(manager){}

  public override void OnMyStateEntered(){
    string stateEnteredMessage = "ENTER state: StateGameWon";
gameManager.DisplayStateEnteredMessage(stateEnteredMessage);
    Debug.Log(stateEnteredMessage);
  }
  public override void OnMyStateExit(){}
  public override void StateUpdate() {}
  public override void OnButtonClick(ButtonType button){}
}</pre></div></li><li class="listitem">Create a<a class="indexterm" id="id1202"/> new C# script class called <code class="literal">StateGameLost</code>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class StateGameLost : GameState {
  public StateGameLost(GameManager manager):base(manager){}

  public override void OnMyStateEntered(){
    string stateEnteredMessage = "ENTER state: StateGameLost";
gameManager.DisplayStateEnteredMessage(stateEnteredMessage);
    Debug.Log(stateEnteredMessage);
  }
  public override void OnMyStateExit(){}
  public override void StateUpdate() {}
  public override void OnButtonClick(ButtonType button){}
}</pre></div></li><li class="listitem">In the <span class="strong"><strong>Hierarchy</strong></span>, select the <span class="strong"><strong>Button-win</strong></span> button, and for its <span class="strong"><strong>Button (Script)</strong></span> component, add an <code class="literal">OnClick</code> action to call the <code class="literal">BUTTON_CLICK_ACTION_WIN_GAME()</code> method from the <span class="strong"><strong>GameManager</strong></span> component in the <span class="strong"><strong>Main Camera</strong></span> GameObject.</li><li class="listitem">In the <span class="strong"><strong>Hierarchy</strong></span>, select the <span class="strong"><strong>Button-lose</strong></span> button, and for its <span class="strong"><strong>Button (Script)</strong></span> component, add <a class="indexterm" id="id1203"/>an <code class="literal">OnClick</code> action to call the <code class="literal">BUTTON_CLICK_ACTION_LOSE_GAME()</code> method from the <span class="strong"><strong>GameManager</strong></span> component in the <span class="strong"><strong>Main Camera</strong></span> GameObject.</li><li class="listitem">In the <span class="strong"><strong>Hierarchy</strong></span>, select the <span class="strong"><strong>Main Camera</strong></span> GameObject. Next, drag into the <span class="strong"><strong>Inspector</strong></span> to ensure that all three <span class="strong"><strong>GameManager (Script)</strong></span> public variables, <span class="strong"><strong>Text State Messages</strong></span>, <span class="strong"><strong>Button Win Game</strong></span>, and<span class="strong"><strong> Button Lose Game</strong></span>, have the corresponding Canvas GameObjects dragged into them (the two buttons and the UI text GameObject).</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec352"/>How it works...</h2></div></div></div><p>The scene is very straightforward for this recipe. There is the single <span class="strong"><strong>Main Camera</strong></span> GameObject that has the <code class="literal">GameManager</code> script object component attached to it.</p><p>A C# scripted class is defined for each state that the game needs to manage—for this example, the three states <code class="literal">StateGamePlaying</code>, <code class="literal">StateGameWon</code>, and <code class="literal">StateGameLost</code>. Each of these state classes is a subclass of <code class="literal">GameState</code>. <code class="literal">GameState</code> defines properties and methods that all subclass<a class="indexterm" id="id1204"/> states will possess:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">An enumerated type <code class="literal">ButtonType</code>, which defines the two possible button clicks that the game might generate: <code class="literal">ButtonWinGame</code> and <code class="literal">ButtonLoseGame</code>.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">gameManager</code> variable: so that each state object has a link to the game manager.</li><li class="listitem" style="list-style-type: disc">The constructor<a class="indexterm" id="id1205"/> method that accepts a reference to the <code class="literal">GameManager</code>: that automatically makes the <code class="literal">gameManager</code> variable refer to the passed in <code class="literal">GameManager</code> object.</li><li class="listitem" style="list-style-type: disc">The four abstract methods <code class="literal">OnMyStateEntered()</code>, <code class="literal">OnMyStateExit()</code>,<code class="literal"> OnButtonClick(…)</code>, and <code class="literal">StateUpdate()</code>. Note that abstract methods must have their own implementation for each subclass.</li></ul></div><p>When the <code class="literal">GameManager</code> class' <code class="literal">Awake()</code> method is executed, three state objects are created, one for each of the playing/win/lose classes. These state objects are stored in their corresponding variables: <code class="literal">stateGamePlaying</code>, <code class="literal">stateGameWon</code>, and <code class="literal">stateGameLost</code>.</p><p>The <code class="literal">GameManager</code> class has a variable called <code class="literal">currentState</code>, which is a reference to the current state object at any time while the game runs (initially, it will be <code class="literal">null</code>). Since it is of the <code class="literal">GameState</code> class (the parent of all state classes), it can refer to any of the different state objects.</p><p>After <code class="literal">Awake()</code>, <code class="literal">GameManager</code> will receive a <code class="literal">Start()</code> message. This method initializes the <code class="literal">currentState</code> to be the <code class="literal">stateGamePlaying</code> object.</p><p>For each frame, the <code class="literal">GameManager</code> will receive <code class="literal">Update()</code>messages. Upon receiving these messages, <code class="literal">GameManager</code> sends a <code class="literal">StateUpdate()</code>messages to the <code class="literal">currentState</code> object. So, for each frame, the object for the current state of the game will execute those methods. For example, when the <code class="literal">currentState</code> is set to game playing, for each frame, the <code class="literal">gamePlayingObject</code> will calls its (in this case, empty) <code class="literal">StateUpdate()</code> method.</p><p>The <code class="literal">StateGamePlaying</code> class implements statements in its <code class="literal">OnButtonClick()</code> method so that when the user clicks on a button, the <code class="literal">gamePlayingObject</code> will call the <code class="literal">GameManager</code> instance's <code class="literal">NewState()</code> method, passing it the object corresponding to the new state. So, if the user clicks on <span class="strong"><strong>Button-win</strong></span>, the <code class="literal">NewState()</code> method is passed to <code class="literal">gameManager.stateGameWon</code>.</p></div></div>
<div class="section" title="Reducing the number of objects by destroying objects at death a time"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec113"/>Reducing the number of objects by destroying objects at death a time</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 1</strong></span>: Minimize the number of active and enabled objects in a scene.</p><p>One way to reduce<a class="indexterm" id="id1206"/> the number of active objects is to destroy objects when they are no longer needed. As soon as an object is no longer needed, we should destroy it; this saves both memory and processing resources since Unity no longer needs to send the object such messages as <code class="literal">Update()</code> and <code class="literal">FixedUpdate()</code>, or consider object collisions or physics and so on.</p><p>However, there may be times when we wish not to destroy an object immediately, but at some known point in the future. Examples might include after a sound has finished playing (see that recipe <span class="emphasis"><em>Waiting for audio to finish before auto-destructing object</em></span> in <a class="link" href="ch09.html" title="Chapter 9. Playing and Manipulating Sounds">Chapter 9</a>, <span class="emphasis"><em>Playing and Manipulating Sounds</em></span>), the player only has a certain time to collect a bonus object before it disappears, or perhaps an object displaying a message to the player should disappear after a certain time.</p><p>This recipe demonstrates how objects can be told to <span class="emphasis"><em>start dying</em></span>, and then to automatically destroy them after a given delay has passed.</p><div class="mediaobject"><img alt="Reducing the number of objects by destroying objects at death a time" src="graphics/1362OT_11_14.jpg"/></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec353"/>How to do it...</h2></div></div></div><p>To destroy<a class="indexterm" id="id1207"/> objects after a specified time, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new 2D project.</li><li class="listitem">Create a UI <span class="strong"><strong>Button</strong></span> named <span class="strong"><strong>Click Me</strong></span>, and make it stretch to fill the entire window.</li><li class="listitem">In the <span class="strong"><strong>Inspector</strong></span>, set the Button's <span class="strong"><strong>Text child</strong></span> to have left-aligned and large text.</li><li class="listitem">Add the following script class <code class="literal">DeathTimeExample.cs</code> to <span class="strong"><strong>Button Click Me</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
using UnityEngine.UI;

public class DeathTimeExample : MonoBehaviour {
  public void BUTTON_ACTION_StartDying() {
    deathTime = Time.time + deathDelay;
  }

  public float deathDelay = 4f;
  private float deathTime = -1;

  public Text buttonText;

  void Update(){
    if(deathTime &gt; 0){
      UpdateTimeDisplay();
      CheckDeath();
    }
  }

  private void UpdateTimeDisplay(){
    float timeLeft = deathTime - Time.time;
    string timeMessage = "time left: " + timeLeft;
    buttonText.text = timeMessage;
  }

  private void CheckDeath(){
    if(Time.time &gt; deathTime) Destroy( gameObject );
  }
}</pre></div></li><li class="listitem">Drag the <span class="strong"><strong>Text</strong></span> child of <span class="strong"><strong>Button Click Me</strong></span> into the script's public variable <span class="strong"><strong>Button Text</strong></span>, so<a class="indexterm" id="id1208"/> this script is able to change the button text to show the countdown.</li><li class="listitem">With <span class="strong"><strong>Button Click Me</strong></span> selected in the <span class="strong"><strong>Hierarchy</strong></span>, add a new <span class="strong"><strong>On Click()</strong></span> event for this <a class="indexterm" id="id1209"/>button, dragging the button itself as the target GameObject and selecting public function <code class="literal">BUTTON_ACTION_StartDying(),</code>as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_15.jpg"/></div></li><li class="listitem">Now, run the scene; once the button is clicked, the button's text should show the countdown. Once the countdown gets to zero, <span class="strong"><strong>Button Click Me</strong></span> will be destroyed (including all its children, in this case, just the GameObject <span class="strong"><strong>Text</strong></span>).</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec354"/>How it works...</h2></div></div></div><p>The float variable <code class="literal">deathDelay</code> stores the number of seconds the object waits before destroying itself once the decision has been made for the object to start dying. The float variable <code class="literal">deathTime</code> either has a value of <code class="literal">-1</code> (no death time yet set) or it is a non-negative value, which is the time we wish the object to destroy itself.</p><p>When the button is<a class="indexterm" id="id1210"/> clicked, the <code class="literal">BUTTON_ACTION_StartDying()</code> method is called. This method sets this <code class="literal">deathTime</code> variable to the current time plus whatever value is set in <code class="literal">deathDelay</code>. This new value for <code class="literal">deathTime</code> will be a positive number, meaning the <code class="literal">IF</code>-statement in the <code class="literal">Update()</code> method will fire from this point onward.</p><p>Every frame method <code class="literal">Update()</code> checks if <code class="literal">deathTime</code> is greater than zero (that is, a death time has been set), and, if so, it then calls, the <code class="literal">UpdateTimeDisplay()</code> and <code class="literal">CheckDeath()</code> methods.</p><p>The <code class="literal">UpdateTimeDisplay()</code> methods<a class="indexterm" id="id1211"/> creates a string message stating how many seconds are left and updates the <span class="strong"><strong>Button Text</strong></span> to show this message.</p><p>The <code class="literal">CheckDeath()</code> method tests <a class="indexterm" id="id1212"/>whether the current time has passed the <code class="literal">deathTime</code>. If the death time has passed, then the parent <code class="literal">gameObject</code> is immediately destroyed.</p><p>When you run the scene, you'll see the <span class="strong"><strong>Button</strong></span> removed from the <span class="strong"><strong>Hierarchy</strong></span> once its death time has been reached.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec355"/>See also</h2></div></div></div><p>Refer to the following recipes in this chapter for more information:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Reducing the number of enabled objects by disabling objects whenever possible</li><li class="listitem" style="list-style-type: disc">Reducing the number of active objects by making objects inactive whenever possible</li></ul></div></div></div>
<div class="section" title="Reducing the number of enabled objects by disabling objects whenever possible"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec114"/>Reducing the number of enabled objects by disabling objects whenever possible</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 1</strong></span>: Minimize the number of active and enabled objects in a scene.</p><p>Sometimes, we <a class="indexterm" id="id1213"/>may not want to completely remove an object, but we can identify times when a scripted component of an object can be safely disabled. If a <code class="literal">MonoBehaviour</code> script is disabled, then Unity no longer needs to send the object messages, such as <code class="literal">Update()</code>and <code class="literal">FixedUpdate()</code>, for each frame.</p><p>For example, if a <span class="strong"><strong>Non-Player Character</strong></span> (<span class="strong"><strong>NPC</strong></span>) should only demonstrate some behavior when the player <a class="indexterm" id="id1214"/>can see that character, then we only need to be executing the behavior logic when the NPC is visible—the rest of the time, we can safely disable the scripted component.</p><p>Unity provides the very useful events <code class="literal">OnBecameInvisible()</code> and <code class="literal">OnBecameVisible()</code>, which inform an object when it moves out of and into the visible area for one or more cameras in the scene.</p><p>This recipe illustrates the following rule of thumb: if an object has no reason to be doing actions when it cannot be seen, then we should disable that object while it cannot be seen.</p><div class="mediaobject"><img alt="Reducing the number of enabled objects by disabling objects whenever possible" src="graphics/1362OT_11_16.jpg"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec356"/>Getting ready</h2></div></div></div><p>For this recipe, we have prepared a package named <code class="literal">unity4_assets_handyman_goodDirt</code> containing the <code class="literal">3rdPersonController</code> handyman and Terrain material <code class="literal">goodDirt</code>. The package is in the <code class="literal">1362_11_07</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec357"/>How to do it...</h2></div></div></div><p>To disable objects to reduce<a class="indexterm" id="id1215"/> computer processing workload requirements, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new Unity project, importing the provided Unity package <code class="literal">unity4_assets_handyman_goodDirt</code>.</li><li class="listitem">Create a new <span class="strong"><strong>Terrain </strong></span>(size <span class="strong"><strong>20 x 20</strong></span>, located at <span class="strong"><strong>-10, 0, -10</strong></span>) and texture-paint it with <span class="strong"><strong>GoodDirt</strong></span> (which you'll find in the <span class="strong"><strong>Standard Assets</strong></span> folder from your import of the <span class="strong"><strong>Terrain Assets</strong></span> package).</li><li class="listitem">Add a <span class="strong"><strong>3rdPersonController</strong></span> at (<span class="strong"><strong>0, 1, 0</strong></span>).</li><li class="listitem">Create a new <span class="strong"><strong>Cube</strong></span> just in front of your <span class="strong"><strong>3rdPersonController</strong></span> (so it is visible in the <span class="strong"><strong>Game</strong></span> panel when you start running the game).</li><li class="listitem">Add the following C# script class <code class="literal">DisableWhenNotVisible</code> to your <span class="strong"><strong>Cube</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class DisableWhenNotVisible : MonoBehaviour {
  private GameObject player;

  void Start(){
    player = GameObject.FindGameObjectWithTag("Player");
  }

  void OnBecameVisible() {
    enabled = true;
    print ("cube became visible again");
  }

  void OnBecameInvisible() {
    enabled = false;
    print ("cube became invisible");
  }

  void Update(){
    //do something, so we know when this script is NOT doing something!
    float d = Vector3.Distance( transform.position, player.transform.position);
    print(Time.time + ": distance from player to cube = " + d);
  }
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec358"/>How it works...</h2></div></div></div><p>When visible, the scripted <code class="literal">DisableWhenNotVisible</code> component of <span class="strong"><strong>Cube</strong></span> recalculates and displays the distance from itself to the <span class="strong"><strong>3rdPersonController</strong></span> object's transform, via the variable <code class="literal">player</code> in the <code class="literal">Update()</code> method for each frame. However, when this object receives the message <code class="literal">OnBecameInvisible()</code>, the object sets its <code class="literal">enabled</code> property to <code class="literal">false</code>. This results in Unity no longer sending <code class="literal">Update()</code>messages to the <code class="literal">GameObject</code>, so the distance calculation in <code class="literal">Update()</code> is no longer performed; thus, reducing the game's processing workload. Upon receiving the message <code class="literal">OnBecameVisible()</code>, the <code class="literal">enabled</code> property is set back<a class="indexterm" id="id1216"/> to <code class="literal">true</code>, and the object will then receive <code class="literal">Update()</code> messages for each frame. Note that you can see the scripted component become disabled by seeing the blue <span class="emphasis"><em>tick</em></span> in its <span class="strong"><strong>Inspector</strong></span> checkbox disappear if you have the <span class="strong"><strong>Cube</strong></span> selected in the <span class="strong"><strong>Hierarchy</strong></span> when running the game.</p><div class="mediaobject"><img alt="How it works..." src="graphics/1362OT_11_17.jpg"/></div><p>The preceding screenshot shows our <span class="strong"><strong>Console</strong></span> text output, logging how the user must have turned away from the cube at 6.9 seconds after starting the game (and so the cube was no longer visible); then, at 9.4 seconds, the user turned so that they could see the cube again, causing it to be re-enabled.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec359"/>There's more...</h2></div></div></div><p>Some details you don't want to miss:</p><div class="section" title="Note – viewable in Scene panel still counts as visible!"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec93"/>Note – viewable in Scene panel still counts as visible!</h3></div></div></div><p>Note that even if the <span class="strong"><strong>Game</strong></span> panel is not showing (rendering) an object, if the object is visible in a <span class="strong"><strong>Scene</strong></span> panel, then it will still be considered visible. Therefore, it is recommended that <a class="indexterm" id="id1217"/>you hide/close the <span class="strong"><strong>Scene</strong></span> panel when testing this recipe, otherwise it may be that the object does only becomes non-visible when the game stops running.</p></div><div class="section" title="Another common case – only enable after OnTrigger()"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec94"/>Another common case – only enable after OnTrigger()</h3></div></div></div><p>Another common <a class="indexterm" id="id1218"/>situation is that we only want a scripted component to be active if the player's character is nearby (within some minimum distance). In these situations, a sphere collider (with <span class="strong"><strong>Is Trigger</strong></span> checked) can be set up on the object to be disabled/enabled (continuing our example, this would be on our <span class="strong"><strong>Cube</strong></span>), and the scripted component can be enabled only when the player's character enters that sphere. This can be implemented by replacing the <code class="literal">OnBecameInvisible()</code> and  <code class="literal">OnBecameVisible()</code> methods with the <code class="literal">OnTriggerEnter()</code> and <code class="literal">OnTriggerExit()</code> methods as follows:</p><div class="informalexample"><pre class="programlisting">void OnTriggerEnter(Collider hitObjectCollider) {
  if (hitObjectCollider.CompareTag("Player")){
    print ("cube close to Player again");
    enabled = true;
  }
}

void OnTriggerExit(Collider hitObjectCollider) {
  if (hitObjectCollider.CompareTag("Player")){
    print ("cube away from Player");
    enabled = false;
  }
}</pre></div><p>The following screenshot illustrates a large sphere collider having been created around the cube, with its <span class="strong"><strong>Trigger</strong></span> enabled:</p><div class="mediaobject"><img alt="Another common case – only enable after OnTrigger()" src="graphics/1362OT_11_18.jpg"/></div><p>Many computer games (such as <span class="emphasis"><em>Half Life</em></span>) use environmental design such as corridors to optimize memory usage by loading and unloading different parts of the environment. For example, when<a class="indexterm" id="id1219"/> a player hits a corridor trigger, environment objects load and unload. See the following for more information about such techniques:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://gamearchitect.net/Articles/StreamingBestiary.html">http://gamearchitect.net/Articles/StreamingBestiary.html</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://cie.acm.org/articles/level-design-optimization-guidelines-for-game-artists-using-the-epic-games/">http://cie.acm.org/articles/level-design-optimization-guidelines-for-game-artists-using-the-epic-games/</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://gamedev.stackexchange.com/questions/33016/how-does-3d-games-work-so-fluent-provided-that-each-meshs-size-is-so-big">http://gamedev.stackexchange.com/questions/33016/how-does-3d-games-work-so-fluent-provided-that-each-meshs-size-is-so-big</a></li></ul></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec360"/>See also</h2></div></div></div><p>Refer to the following recipes in this chapter for more information:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Reducing the number of objects by destroying objects at a death time</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Reducing the number of active objects by making objects inactive whenever possible</em></span></li></ul></div></div></div>
<div class="section" title="Reducing the number of active objects by making objects inactive whenever possible"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec115"/>Reducing the number of active objects by making objects inactive whenever possible</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 1</strong></span>: Minimize the number of active and enabled objects in a scene.</p><p>Sometimes, we<a class="indexterm" id="id1220"/> may not want to completely remove an object, but it is possible to go one step further than disabling a scripted component by making the parent <code class="literal">GameObject</code> that contains the scripted component <code class="literal">inactive</code>. This is just like deselecting the checkbox next to the <code class="literal">GameObject</code> in the <span class="strong"><strong>Inspector</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img alt="Reducing the number of active objects by making objects inactive whenever possible" src="graphics/1362OT_11_19.jpg"/></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec361"/>How to do it...</h2></div></div></div><p>To reduce computer processing <span class="emphasis"><em>workload</em></span> requirements by making an object inactive when it becomes invisible, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy the previous recipe.</li><li class="listitem">Remove the scripted component <code class="literal">DisableWhenNotVisible</code> from your <span class="strong"><strong>Cube</strong></span>, and instead, add the following C# script class <code class="literal">InactiveWhenNotVisible</code> to <span class="strong"><strong>Cube</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
using UnityEngine.UI;

public class InactiveWhenNotVisible : MonoBehaviour {
  // button action
  public void BUTTON_ACTION_MakeActive(){
    gameObject.SetActive(true);
    makeActiveAgainButton.SetActive(false);
  }

  public GameObject makeActiveAgainButton;

  private GameObject player;

  void Start(){
    player = GameObject.FindGameObjectWithTag("Player");
  }

  void OnBecameInvisible() {
    makeActiveAgainButton.SetActive(true);
    print ("cube became invisible");
    gameObject.SetActive(false);
  }

  void Update(){
    float d = Vector3.Distance( transform.position, player.transform.position);
    print(Time.time + ": distance from player to cube = " + d);
  }
}</pre></div></li><li class="listitem">Create a new <span class="strong"><strong>Button</strong></span>, containing the text <code class="literal">Make Cube Active Again</code>, and position the button so that it is at the top of the <span class="strong"><strong>Game</strong></span> panel and stretches the entire width<a class="indexterm" id="id1221"/> of the <span class="strong"><strong>Game</strong></span> panel, as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_20.jpg"/></div></li><li class="listitem">With the <span class="strong"><strong>Button</strong></span> selected in the <span class="strong"><strong>Hierarchy</strong></span>, add a new <span class="strong"><strong>On Click()</strong></span> event for this button, dragging the <span class="strong"><strong>Cube</strong></span> as the target GameObject and selecting public function <code class="literal">BUTTON_ACTION_makeCubeActiveAgain()</code>.</li><li class="listitem">Uncheck the active checkbox next to the <span class="strong"><strong>Button</strong></span> name in the <span class="strong"><strong>Inspector</strong></span> (in other words, manually deactivate this <span class="strong"><strong>Button</strong></span> so that we don't see the <span class="strong"><strong>Button</strong></span> when the scene first runs).</li><li class="listitem">Select the <span class="strong"><strong>Cube</strong></span> in the <span class="strong"><strong>Inspector</strong></span> and drag the <span class="strong"><strong>Button</strong></span> into the <code class="literal">MakeActiveAgainButton</code> variable slot of its script class <code class="literal">InactiveWhenNotVisible</code> component, as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_21.jpg"/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec362"/>How it works...</h2></div></div></div><p>Initially, the <span class="strong"><strong>Cube</strong></span> is visible and the <span class="strong"><strong>Button</strong></span> is inactive (so not visible to the user). When the <span class="strong"><strong>Cube</strong></span> receives an <code class="literal">OnBecameInvisible</code> event message, its <code class="literal">OnBecameInvisible()</code> method will execute. This method performs two actions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">It first <a class="indexterm" id="id1222"/>enables (and therefore makes visible) the <code class="literal">Button</code>.</li><li class="listitem" style="list-style-type: disc">It then makes inactive the script's parent <code class="literal">gameObject</code> (that is, the <code class="literal">Cube</code> GameObject).</li></ul></div><p>When the <span class="strong"><strong>Button</strong></span> is clicked, it makes the <span class="strong"><strong>Cube</strong></span> object active again and makes the <span class="strong"><strong>Button</strong></span> inactive again. So, at any one time, only one of the <span class="strong"><strong>Cube</strong></span> and <span class="strong"><strong>Button</strong></span> objects are active, and each makes itself inactive when the other is active.</p><p>Note that an inactive <code class="literal">GameObject</code> does not receive <span class="emphasis"><em>any</em></span> messages, so it will not receive the <code class="literal">OnBecameVisible()</code> message, and this may not be appropriate for every object that is out of sight of the camera. However, when deactivating objects is appropriate, a larger performance saving is made compared to simply disabling a single scripted <code class="literal">Monobehaviour</code> component of a <code class="literal">GameObject</code>.</p><p>The only way to reactivate an inactive object is for another object to set the <code class="literal">GameObject</code> component's active property back to <code class="literal">true</code>. In this recipe, it is the <code class="literal">Button</code> GameObject, which, when clicked, runs the <code class="literal">BUTTON_ACTION_makeCubeActiveAgain()</code> method, which allows our game to make the <span class="strong"><strong>Cube</strong></span> active again.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec363"/>See also</h2></div></div></div><p>Refer to the following<a class="indexterm" id="id1223"/> recipes in this chapter for more information:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Reducing the number of objects by destroying objects at a death time</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Reducing the number of enabled objects by disabling objects whenever possible</em></span></li></ul></div></div></div>
<div class="section" title="Improving efficiency with delegates and events and avoiding SendMessage!"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec116"/>Improving efficiency with delegates and events and avoiding SendMessage!</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 2</strong></span>: Minimize actions requiring Unity to perform "reflection" over objects and searching of all current scene objects.</p><p>When events <a class="indexterm" id="id1224"/>can be based on visibility, distance, or <a class="indexterm" id="id1225"/>collisions, we can use such events as <code class="literal">OnTriggerExit</code> and <code class="literal">OnBecomeInvisible</code>, as described in some of the previous recipes. When events can be based on time periods, we can use coroutines, as described in other recipes in this chapter. However, some events are unique to each game situation, and C# offers several methods of broadcasting user-defined event messages to scripted objects. One approach is the <code class="literal">SendMessage(…)</code> method, which, when sent to a GameObject, will check every <code class="literal">Monobehaviour</code> scripted component and execute the named method if its parameters match. However, this involves an<a class="indexterm" id="id1226"/> inefficient technique known as <span class="strong"><strong>reflection</strong></span>. C# offers another event message approach known<a class="indexterm" id="id1227"/> as <span class="strong"><strong>delegates and events</strong></span>, which we describe and implement in this recipe. Delegates and events work in a similar way to <code class="literal">SendMessage(…)</code>, but are much more efficient since Unity maintains a defined list of which objects are <span class="emphasis"><em>listening</em></span> to the broadcast events. <code class="literal">SendMessage(…)</code> should be avoided if performance is important, since it means that Unity has to analyze each scripted object (<span class="emphasis"><em>reflect over</em></span> the object) to see whether there is a public method corresponding to the message that has been sent; this is much slower than using delegates and events.</p><p>Delegates and events implement<a class="indexterm" id="id1228"/> the <span class="strong"><strong>publish-subscribe design pattern</strong></span> (<span class="strong"><strong>pubsub</strong></span>). This is also known as the <a class="indexterm" id="id1229"/><span class="strong"><strong>observer</strong></span> design pattern. Objects can subscribe one of their methods to receive a particular type of event message from a particular publisher. In this recipe, we'll have a manager class that will publish new events when UI buttons are clicked. We'll create some UI objects, some of which <span class="strong"><strong>subscribe</strong></span> to the color change events, so that each time a color change event is published, subscribed UI objects receive the event message and change their color accordingly. C# publisher objects don't have to worry about how many objects subscribe to them at any point in time (it could be none or 1,000!); this is known as <span class="strong"><strong>loose coupling</strong></span>, since it allows different code components to be written (and maintained) independently and is a desirable feature of object-oriented code.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec364"/>How to do it...</h2></div></div></div><p>To implement<a class="indexterm" id="id1230"/> delegates and events, follow<a class="indexterm" id="id1231"/> these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new 2D project.</li><li class="listitem">Add the following C# script class <span class="strong"><strong>ColorManager</strong></span> to the <span class="strong"><strong>Main Camera</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class ColorManager : MonoBehaviour {
  public void BUTTON_ACTION_make_green(){
    PublishColorEvent(Color.green);
  }

  public void BUTTON_ACTION_make_blue(){
    PublishColorEvent(Color.blue);
  }

  public void BUTTON_ACTION_make_red(){
    PublishColorEvent(Color.red);
  }

  public delegate void ColorChangeHandler(Color newColor);
  public static event ColorChangeHandler onChangeColor;

  private void PublishColorEvent(Color newColor){
    // if there is at least one listener to this delegate
    if(onChangeColor != null){
      // broadcast change color event
      onChangeColor(newColor);
    }
  }
}</pre></div></li><li class="listitem">Create two UI <span class="strong"><strong>Image</strong></span> objects and two UI <span class="strong"><strong>Text</strong></span> objects. Position one <span class="strong"><strong>Image</strong></span> and <span class="strong"><strong>Text</strong></span> object to the lower left of the screen and position the other to the lower right of the screen. Make the text on the lower left read <span class="strong"><strong>Not listening</strong></span>, and make the text on the right of the screen read <span class="strong"><strong>I am listening</strong></span>. For good measure, add a <span class="strong"><strong>Slider</strong></span> UI object in the top right of the screen.</li><li class="listitem">Create three UI buttons in the top left of the screen, named <span class="strong"><strong>Button-GREEN</strong></span>, <span class="strong"><strong>Button-BLUE</strong></span>, and<a class="indexterm" id="id1232"/> <span class="strong"><strong>Button-RED</strong></span>, with corresponding text reading <code class="literal">make things &lt;color=green&gt;GREEN&lt;/color&gt;</code>, <code class="literal">make things &lt;color=blue&gt;BLUE&lt;/color&gt;</code>, and <code class="literal">make things &lt;color=red&gt;RED&lt;/color&gt;</code>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_22.jpg"/></div></li><li class="listitem">Attach<a class="indexterm" id="id1233"/> the following C# script class <code class="literal">ColorChangeListenerImage</code> to both the lower-right <span class="strong"><strong>Image</strong></span> and also the <span class="strong"><strong>Slider</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
using UnityEngine.UI;

public class ColorChangeListenerImage : MonoBehaviour {
  void OnEnable() {
    ColorManager.onChangeColor += ChangeColorEvent;
  }

  private void OnDisable(){
    ColorManager.onChangeColor -= ChangeColorEvent;
  }

  void ChangeColorEvent(Color newColor){
    GetComponent&lt;Image&gt;().color = newColor;
  }
}</pre></div></li><li class="listitem">Attach the following C# script class <code class="literal">ColorChangeListenerText</code> to the <span class="strong"><strong>I am listening Text</strong></span> UI object:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
using UnityEngine.UI;

public class ColorChangeListenerText : MonoBehaviour {
  void OnEnable() {
    ColorManager.onChangeColor += ChangeColorEvent;
  }

  private void OnDisable(){
    ColorManager.onChangeColor -= ChangeColorEvent;
  }

  void ChangeColorEvent(Color newColor){
    GetComponent&lt;Text&gt;().color = newColor;
  }
}</pre></div></li><li class="listitem">With button-<span class="strong"><strong>GREEN</strong></span> selected in the <span class="strong"><strong>Hierarchy</strong></span>, add a new <span class="strong"><strong>On Click()</strong></span> event for this button, dragging the <span class="strong"><strong>Main Camera</strong></span> as the target GameObject and selecting public<a class="indexterm" id="id1234"/> function <code class="literal">BUTTON_ACTION_make_green()</code>. Do the same for the <span class="strong"><strong>BLUE</strong></span> and <span class="strong"><strong>RED</strong></span> buttons with functions <code class="literal">BUTTON_ACTION_make_blue()</code> and <code class="literal">BUTTON_ACTION_make_red()</code> respectively.</li><li class="listitem">Run the game. When you click a change color button, the three UI objects on the right of the screen show all changes to the corresponding color, while the two UI objects at the bottom left of the screen remain in the default <span class="strong"><strong>White</strong></span> color.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec365"/>How it works...</h2></div></div></div><p>First, let's consider what we want to happen—we want the right-hand <span class="strong"><strong>Image</strong></span>, <span class="strong"><strong>Slider</strong></span>, and <span class="strong"><strong>Text</strong></span> objects to change their color when they receive an event message <code class="literal">OnChangeColor()</code> with a new color argument.</p><p>This is achieved<a class="indexterm" id="id1235"/> by each object having an instance of the appropriate <code class="literal">ColorChangeListener</code> class that subscribes their <code class="literal">OnChangeColor()</code> method to listen for color change events published from the <code class="literal">ColorManager</code> class. Since both the <span class="strong"><strong>Image</strong></span> and <span class="strong"><strong>Slider</strong></span> objects have an image component whose color will change, they have scripted components of our C# class <code class="literal">ColorChangeListenerImage</code>, while the <span class="strong"><strong>Text</strong></span> object needs a different class since it is the color of the text component whose color is to be changed (so we add an instance of C# scripted component <code class="literal">ColorChangeListenerText</code> to the <span class="strong"><strong>Text</strong></span> UI object). So, as we can see, different objects may respond to receiving the same event messages in ways appropriate to each different object.</p><p>Since our scripted objects may be disabled and enabled at different times, each time a scripted <code class="literal">ColorChangeListener</code> object is enabled (such as when its GameObject parent is instantiated), its <code class="literal">OnChangeColor()</code> method is added (<code class="literal">+=</code>) to the list of those subscribed to listen for color change events, likewise each time <code class="literal">ColorChangeListenerImage/Text</code> objects are disabled, those methods are removed (<code class="literal">-=</code>) from the list of event subscribers.</p><p>When a <code class="literal">ColorChangeListenerImage/Text</code> object receives a color change message, its subscribed <code class="literal">OnChangeColor()</code> method is executed and the color of the appropriate component is changed to the received <code class="literal">Color</code> value (<code class="literal">green</code>/<code class="literal">red</code>/<code class="literal">blue</code>).</p><p>The <code class="literal">ColorManager</code><a class="indexterm" id="id1236"/> class has a public class (static) variable <code class="literal">changeColorEvent</code>, which defines an <span class="emphasis"><em>event</em></span> to which Unity maintains a dynamic list of all the subscribed object methods. It is to this event that <code class="literal">ColorChangeListenerImage/Text</code> objects register or deregister their methods.</p><p>The <code class="literal">ColorManager</code> class displays three buttons to the user to change all listening objects to a specific color: green, red, and blue. When a button is clicked, the <code class="literal">changeColorEvent</code> is told to publish a new event, passing a<a class="indexterm" id="id1237"/> corresponding <code class="literal">Color</code> argument to all subscribed object methods.</p><p>The <code class="literal">ColorManager</code> class declares a <span class="emphasis"><em>Delegate</em></span> named <code class="literal">ColorChangeHandler</code>. Delegates define the return type (in this case, <code class="literal">void</code>) and argument <span class="emphasis"><em>signature</em></span> of methods that can be delegated (subscribed) to an event. In this case, methods must have the argument signature of a single parameter of type <code class="literal">Color</code>. Our <code class="literal">OnChangeColor()</code> method in classes <code class="literal">ColorChangeListenerImage/Text</code> match this argument signature and so are permitted to subscribe to the <code class="literal">changeColorEvent</code> in the <code class="literal">ColorManager</code> class.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note58"/>Note</h3><p>Note: An easy to<a class="indexterm" id="id1238"/> understand video about Unity delegates and events can be found at <a class="ulink" href="http://www.youtube.com/watch?v=N2zdwKIsXJs">http://www.youtube.com/watch?v=N2zdwKIsXJs</a>.</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec366"/>See also</h2></div></div></div><p>Refer to the <span class="emphasis"><em>Cache GameObject and component references to avoid expensive lookups</em></span> recipe in this chapter for more information.</p></div></div>
<div class="section" title="Executing methods regularly but independent of frame rate with coroutines"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec117"/>Executing methods regularly but independent of frame rate with coroutines</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 3</strong></span>: Call methods as few times as possible.</p><p>While it is very simple to put logic into <code class="literal">Update()</code> and have it regularly executed for each frame, we can improve game performance by executing logic as rarely as possible. So, if we can get away with only checking for a situation every 5 seconds, then great performance savings can be made to move that logic out of <code class="literal">Update()</code>.</p><p>A <span class="strong"><strong>coroutine</strong></span> is a function that <a class="indexterm" id="id1239"/>can suspend its execution until a <code class="literal">yield</code> action has completed. One kind of yield action simply waits for a given number of seconds. In this recipe, we use coroutines and yield to show how a method can be only executed every 5 seconds; this could be useful for NPCs to decide whether they should randomly <span class="emphasis"><em>wake up</em></span> or perhaps choose a new location to start moving toward.</p><div class="mediaobject"><img alt="Executing methods regularly but independent of frame rate with coroutines" src="graphics/1362OT_11_23.jpg"/></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec367"/>How to do it...</h2></div></div></div><p>To implement <a class="indexterm" id="id1240"/>methods at regular intervals independent of the frame rate, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following C# script class <code class="literal">TimedMethod</code> to the <span class="strong"><strong>Main Camera</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class TimedMethod : MonoBehaviour {
  private void Start() {
    StartCoroutine(Tick());
  }

  private IEnumerator Tick() {
    float delaySeconds = 5.0F;
    while (true) {
      print("tick " + Time.time);
      yield return new WaitForSeconds(delaySeconds);
    }
  }
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec368"/>How it works...</h2></div></div></div><p>When the <code class="literal">Start()</code> message is received, the <code class="literal">Tick()</code> method is started as a coroutine. The <code class="literal">Tick()</code> method sets the delay between executions (variable <code class="literal">delaySeconds</code>) to 5 seconds. An infinite loop is then started, where the method does its actions (in this case, just printing out the time); finally, a <code class="literal">yield</code> instruction is executed, which causes the method to suspend execution for the given delay of 5 seconds. After the yield instruction has completed, the<a class="indexterm" id="id1241"/> loop will continue executing once again and so on. What is important to understand when working with coroutines is that the method will <span class="emphasis"><em>resume executing</em></span> from the same state it yielded.</p><p>You may have noticed that <span class="emphasis"><em>there are no</em></span> <code class="literal">Update()</code> <span class="emphasis"><em>or</em></span> <code class="literal">FixedUpdate()</code> <span class="emphasis"><em>methods at all</em></span>. So, although our game has logic being regularly executed, in this example, there is no logic that has to be executed every frame—fantastic!</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec369"/>There's more...</h2></div></div></div><p>Some details you don't want to miss:</p><div class="section" title="Have different actions happening at different intervals"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec95"/>Have different actions happening at different intervals</h3></div></div></div><p>Coroutines can be used to have different kinds of logic being executed at different regular intervals. So, logic that needs frame-by-frame execution goes into <code class="literal">Update()</code>, and logic that works fine once <a class="indexterm" id="id1242"/>or twice a second might go into a coroutine with a 0.5-second delay; logic that can get away with less occasional updating can go into another coroutine with a 2- or 5-second delay, and so on. Effective and noticeable performance improvements can be found by carefully analyzing (and testing) different game logic to identify the <span class="emphasis"><em>least frequent execution</em></span> that is still acceptable.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec370"/>See also</h2></div></div></div><p>Refer to the next recipe for more information.</p></div></div>
<div class="section" title="Spreading long computations over several frames with coroutines"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec118"/>Spreading long computations over several frames with coroutines</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 3</strong></span>: Call methods as few times as possible.</p><p>Coroutines allow <a class="indexterm" id="id1243"/>us to write asynchronous code—we can ask a method to go off and calculate something, but the rest of the game can keep on running without having to wait for that calculation to end. Or, we can call a coroutine method for each frame from <code class="literal">Update()</code> and organize the method to complete part of a complex calculation each time it is called.</p><p>Note that<a class="indexterm" id="id1244"/> coroutines are not <span class="emphasis"><em>threads</em></span>, but they are very handy in that each can progress each frame further. It also allows us to write code that does not have to wait for certain methods to complete before another can begin.</p><p>When games start requiring complex computations, such as for artificial intelligence reasoning, it may not be possible to maintain acceptable game performance when trying to complete all calculations in a single frame—this is where coroutines can be an excellent solution.</p><p>This recipe illustrates how a complex calculation can be structured into several pieces, each to be completed one frame at a time.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note59"/>Note</h3><p>Note: An excellent<a class="indexterm" id="id1245"/> description of coroutines (and other Unity topics) can be found on Ray Pendergraph's wikidot website <a class="ulink" href="http://raypendergraph.wikidot.com/unity-developer-s-notes#toc6">http://raypendergraph.wikidot.com/unity-developer-s-notes#toc6</a>.</p></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec371"/>How to do it...</h2></div></div></div><p>To spread computations over several frames, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following script class <code class="literal">SegmentedCalculation</code> to the <span class="strong"><strong>Main Camera</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class SegmentedCalculation : MonoBehaviour {
  private const int ARRAY_SIZE = 50;
  private const int SEGMENT_SIZE = 10;
  private int[] randomNumbers;

  private void Awake(){
    randomNumbers = new int[ARRAY_SIZE];
    for(int i=0; i&lt;ARRAY_SIZE; i++){
      randomNumbers[i] = Random.Range(0, 1000);
    }

    StartCoroutine( FindMinMax() );
  }

  private IEnumerator FindMinMax() {
    int min = int.MaxValue;
    int max = int.MinValue

    for(int i=0; i&lt;ARRAY_SIZE; i++){
      if(i % SEGMENT_SIZE == 0){
        print("frame: " + Time.frameCount + ", i:" + i + ", min:" + min + ", max:" + max);

        // suspend for 1 frame since we've completed another segment
        yield return null;
      }

      if(randomNumbers[i] &gt; max){
        max = randomNumbers[i];
      } else if(randomNumbers[i] &lt; min){
        min = randomNumbers[i];
      }
    }

    // disable this scripted component
    print("** completed - disabling scripted component");
    enabled = false;
  }
}</pre></div></li><li class="listitem">Run the <a class="indexterm" id="id1246"/>game, and<a class="indexterm" id="id1247"/> you'll see how the search for highest and lowest values in the array progresses in steps, avoiding undesirable delays between each new frame.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_24.jpg"/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec372"/>How it works...</h2></div></div></div><p>The <code class="literal">randomNumbers</code> array of random integers is created in <code class="literal">Awake()</code>. Then, the <code class="literal">FindMinMax()</code> method is<a class="indexterm" id="id1248"/> started as a coroutine. The size of the array is defined by constant <code class="literal">ARRAY_SIZE</code>, and the number of elements to process each frame by <code class="literal">SEGMENT_SIZE</code>.</p><p>The <code class="literal">FindMinMax()</code> method sets initial values for <span class="emphasis"><em>min</em></span> and <span class="emphasis"><em>max</em></span> and begins to loop through the array. If the current index is divisible by the <code class="literal">SEGMENT_SIZE</code> (remainder 0), then we make<a class="indexterm" id="id1249"/> the method display the current frame number and variable values and suspend execution for one frame with a <code class="literal">yield null</code> statement. For every loop, the value for the current array index is compared with <code class="literal">min</code> and <code class="literal">max</code>, and those values are updated if a new minimum or maximum has been found. When the loop is completed, the scripted component disables itself.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec373"/>There's more...</h2></div></div></div><p>Some details you don't want to miss:</p><div class="section" title="Retrieving the complete Unity log text files from your system"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec96"/>Retrieving the complete Unity log text files from your system</h3></div></div></div><p>As well as<a class="indexterm" id="id1250"/> seeing log texts in the <span class="strong"><strong>Console</strong></span> panel, you can also access the Unity editor log text file as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Mac:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">~/Library/Logs/Unity/Editor.log</code></li><li class="listitem" style="list-style-type: disc">And access through the standard Console app</li></ul></div></li><li class="listitem" style="list-style-type: disc">Windows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">C:\Users\username\AppData\Local\Unity\Editor\Editor.log</code></li></ul></div></li><li class="listitem" style="list-style-type: disc">Mobile devices (see the Unity documentation for accessing device log data)<div class="mediaobject"><img alt="Retrieving the complete Unity log text files from your system" src="graphics/1362OT_11_25.jpg"/></div></li></ul></div><p>For more<a class="indexterm" id="id1251"/> information about Unity logs files, see<a class="indexterm" id="id1252"/> the online manual at <a class="ulink" href="http://docs.unity3d.com/Manual/LogFiles.html">http://docs.unity3d.com/Manual/LogFiles.html</a>.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec374"/>See also</h2></div></div></div><p>Refer to the <span class="emphasis"><em>Executing methods regularly but independent of frame rate with coroutines</em></span> recipe in this chapter for more information.</p></div></div>
<div class="section" title="Evaluating performance by measuring max and min frame rates (FPS)"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec119"/>Evaluating performance by measuring max and min frame rates (FPS)</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 4</strong></span>: Use performance data to drive design and coding decisions.</p><p>A useful raw <a class="indexterm" id="id1253"/>measurement of game performance is the<a class="indexterm" id="id1254"/> maximum and minimum frame rate for a section of a game. In this recipe, we make use of a Creative Commons <span class="strong"><strong>Frames Per Second</strong></span> (<span class="strong"><strong>FPS</strong></span>) calculation<a class="indexterm" id="id1255"/> script to record the maximum and minimum frame rates for a game performing mathematics calculations for each frame.</p><div class="mediaobject"><img alt="Evaluating performance by measuring max and min frame rates (FPS)" src="graphics/1362OT_11_26.jpg"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec375"/>Getting ready</h2></div></div></div><p>For this recipe, we have provided C# script <code class="literal">FPSCounter.cs</code> in the <code class="literal">1362_11_12</code> folder. This file is the one we have modified to include the maximum and minimum values based on the<a class="indexterm" id="id1256"/> <span class="strong"><strong>Do-It-Yourself</strong></span> (<span class="strong"><strong>DIY</strong></span>) frame rate calculation script from Annop "Nargus" Prapasapong, kindly<a class="indexterm" id="id1257"/> published under Creative Commons on the Unify wiki at <a class="ulink" href="http://wiki.unity3d.com/index.php?title=FramesPerSecond">http://wiki.unity3d.com/index.php?title=FramesPerSecond</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec376"/>How to do it...</h2></div></div></div><p>To calculate and record the maximum and minimum FPS, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Start a<a class="indexterm" id="id1258"/> new project, and import the <code class="literal">FPSCounter.cs</code> script.</li><li class="listitem">Add the <code class="literal">FPSCounter </code>script class to the <span class="strong"><strong>Main Camera</strong></span>.</li><li class="listitem">Add the following C# script class <code class="literal">SomeCalculations</code> to the <span class="strong"><strong>Main Camera</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class SomeCalculations : MonoBehaviour {
  public int outerLoopIterations = 20;
  public int innerLoopMaxIterations = 100;

  void Update(){
    for(int i = 0; i &lt; outerLoopIterations; i++){
      int innerLoopIterations = Random.Range(2,innerLoopMaxIterations);
      for(int j = 0; j &lt; innerLoopIterations; j++){
        float n = Random.Range(-1000f, 1000f);
      }
    }
  }
}</pre></div></li><li class="listitem">Run the game for 20 to 30 seconds. On the screen, you should see the current average and the maximum and minimum frame rates displayed.</li><li class="listitem">Stop the game running. You should now see in the <span class="strong"><strong>Console</strong></span> a summary message <a class="indexterm" id="id1259"/>stating the max and min frames per second, as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_27.jpg"/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec377"/>How it works...</h2></div></div></div><p>The <code class="literal">SomeCalculations</code> script ensures that we make Unity do something for each frame, in that it performs lots of calculations when the <code class="literal">Update()</code> method is called for each frame. There is an outer loop (loop counter <code class="literal">i</code>) of public variable <code class="literal">outerLoopIterations</code> iterations (which we set to <code class="literal">20</code>), and an inner loop (loop counter <code class="literal">j</code>), which is a random number of iterations between 2, and the value of public variable <code class="literal">innerLoopMaxIterations</code> (which we set to <code class="literal">100</code>).</p><p>The work for the <a class="indexterm" id="id1260"/>calculations of average <span class="strong"><strong>Frames Per Second</strong></span> (<span class="strong"><strong>FPS</strong></span>) is performed by the <code class="literal">FPSCounter </code>script, which runs coroutine method <code class="literal">FPS()</code> at the chosen frequency (which we can change in the <span class="strong"><strong>Inspector</strong></span>). Each time the <code class="literal">FPS()</code>method <a class="indexterm" id="id1261"/>executes, it recalculates the average frames per second, updates the max and minimum values if appropriate, and, if the <span class="strong"><strong>Display While Running</strong></span> checkbox was ticked, then a <span class="strong"><strong>GUIText</strong></span> object on screen is updated with a message of the average, max, and min FPS.</p><p>Finally, the <code class="literal">OnApplicationQuit()</code> method in script class <code class="literal">FPSCounter</code> is executed when the game is terminated and prints to the console the summary max/min FPS message.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec378"/>There's more...</h2></div></div></div><p>Some details you don't want to miss:</p><div class="section" title="Turn off runtime display to reduce FPS processing"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec97"/>Turn off runtime display to reduce FPS processing</h3></div></div></div><p>We have<a class="indexterm" id="id1262"/> added an option so that you can turn off the runtime display, which will reduce the processing required for the FPS calculations. You just have to un-check the <span class="strong"><strong>Display While Running</strong></span> checkbox in the <span class="strong"><strong>Inspector</strong></span>.</p><div class="mediaobject"><img alt="Turn off runtime display to reduce FPS processing" src="graphics/1362OT_11_28.jpg"/></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec379"/>See also</h2></div></div></div><p>Refer to the following recipes in this chapter for more information:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Identifying performance bottlenecks with the Unity performance Profiler</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Identifying performance bottlenecks with Do-It-Yourself. performance profiling</em></span></li></ul></div></div></div>
<div class="section" title="Identifying performance bottlenecks with the Unity performance Profiler"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec120"/>Identifying performance bottlenecks with the Unity performance Profiler</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 4</strong></span>: Use performance data to drive design and coding decisions.</p><p>As well as following<a class="indexterm" id="id1263"/> general asset and code design principals, which we know ought to lead to improved performance, we should be aware that each game is different and that, in reality, the only way to know which design decisions affect performance the most is to collect and analyze runtime performance<a class="indexterm" id="id1264"/> data. While a raw <span class="strong"><strong>Frames Per Second</strong></span> (<span class="strong"><strong>FPS</strong></span>) measurement is useful, to choose between different decisions having detailed information about the processing requirements for rendering and code execution for each frame is invaluable.</p><p>The Unity 5 <span class="strong"><strong>Profiler</strong></span> offers a detailed breakdown of code and rendering processing requirements, as well as processing required by GPU, audio, and both 2D and 3D physics. Perhaps the most useful, it allows programmers to explicitly record data for named code segments. We will name our profile <code class="literal">MATT_SomeCalculations</code> and record and examine frame-by-frame processing requirements for our calculations.</p><div class="mediaobject"><img alt="Identifying performance bottlenecks with the Unity performance Profiler" src="graphics/1362OT_11_29.jpg"/></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec380"/>How to do it...</h2></div></div></div><p>To record processing requirements<a class="indexterm" id="id1265"/> using the Unity <span class="strong"><strong>Profiler</strong></span>, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Start a new 2D project.</li><li class="listitem">Open the <span class="strong"><strong>Profiler</strong></span> window from the <span class="strong"><strong>Window</strong></span> menu and ensure that the <span class="strong"><strong>Record</strong></span> option is selected, and that the <span class="strong"><strong>Scripts</strong></span> performance data is being collected, as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_30.jpg"/></div></li><li class="listitem">Add the following C# script class <code class="literal">ProfileCalculations</code> to the <span class="strong"><strong>Main Camera</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class ProfileCalculations : MonoBehaviour {
  public int outerLoopIterations = 20;
  public int innerLoopMaxIterations = 100;

  void Update(){
    Profiler.BeginSample("MATT_calculations");

    for(int i = 0; i &lt; outerLoopIterations; i++){
      int innerLoopIterations = Random.Range(2,innerLoopMaxIterations);
      for(int j = 0; j &lt; innerLoopIterations; j++){
        float n = Random.Range(-1000f, 1000f);
      }
    }

    Profiler.EndSample();
  }
}</pre></div></li><li class="listitem">Run the game for 20 to 30 seconds.</li><li class="listitem">Stop the game running. You should now see in the <span class="strong"><strong>Profiler</strong></span> panel details of the breakdown <a class="indexterm" id="id1266"/>of processing required for the selected frame—each of the jagged lines in the top<a class="indexterm" id="id1267"/> right of the <span class="strong"><strong>Profiler</strong></span> panel represents the collected data for a frame.</li><li class="listitem">View data for different frames by dragging the white line to a different horizontal position—the current frame and the total number of frames are shown at the top right in the form <span class="strong"><strong>Frame: frame / totalFrames</strong></span>.</li><li class="listitem">Since we have named a code profile sample, prefixed with <span class="strong"><strong>MATT</strong></span>, we can limit the display of data to only samples containing that word. In the search text box (next to the little magnifying glass,) type <code class="literal">MATT</code>, and you should now see just a single<a class="indexterm" id="id1268"/> row of profile data for our sample <span class="strong"><strong>MATT_calculations</strong></span>. We can see that for frame 83, our code took up 1.2 percent of the processing for that frame.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_31.jpg"/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec381"/>How it works...</h2></div></div></div><p>The <code class="literal">ProfileCalculations</code> script ensures that we make Unity do something for each frame; it does lots of calculations with an inner and outer loop, just like in the previous FPS recipe.</p><p>The two important statements are those that mark the beginning and ending of a named code sample to be recorded and presented in the <span class="strong"><strong>Profiler</strong></span>. The <code class="literal">Profiler.BeginSample("MATT_calculations")</code> statement starts our named profile and it is ended with the<a class="indexterm" id="id1269"/> <code class="literal">EndSample()</code> statement.</p><p>Using an eye-catching prefix allows us to easily isolate our named code profile for analysis, using the search text box in the <span class="strong"><strong>Profiler</strong></span> panel.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec382"/>See also</h2></div></div></div><p>Refer to the following recipes in this chapter for more information:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Evaluating performance by measuring max and min frame rates (FPS)</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Identifying performance bottlenecks with Do-It-Yourself performance profiling</em></span></li></ul></div></div></div>
<div class="section" title="Identifying performance &quot;bottlenecks&quot; with Do-It-Yourself performance profiling"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec121"/>Identifying performance "bottlenecks" with Do-It-Yourself performance profiling</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 4</strong></span>: Use <a class="indexterm" id="id1270"/>performance data to drive design and coding decisions.</p><p>The Unity 5 performance <a class="indexterm" id="id1271"/>profiler is great, but there may be times where we wish to have completed control over the code we are running and how it displays or logs data. In this recipe, we explore how to use a freely available script for DIY performance profiling. While it's not quite as fancy as the graphical and detailed profiling of the performance profiler from Unity, it still provides low-level data about the time required for each frame by named parts of scripts, which is sufficient for making code design decisions to improve game performance.</p><div class="mediaobject"><img alt="Identifying performance &quot;bottlenecks&quot; with Do-It-Yourself performance profiling" src="graphics/1362OT_11_32.jpg"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec383"/>Getting ready</h2></div></div></div><p>For this recipe, we have provided C# script <code class="literal">Profile.cs</code> in the <code class="literal">1362_11_14</code> folder. This is the DIY profiling script from Michael Garforth, kindly published under <span class="emphasis"><em>Creative Commons</em></span> on the Unify <a class="indexterm" id="id1272"/>Wiki at <a class="ulink" href="http://wiki.unity3d.com/index.php/Profiler">http://wiki.unity3d.com/index.php/Profiler</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec384"/>How to do it...</h2></div></div></div><p>To record processing requirements using Do-It-Yourself code profiling, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Start a new project, and import the <code class="literal">Profile.cs</code> script.</li><li class="listitem">Add the following C# script class <code class="literal">DIYProfiling</code> to the <span class="strong"><strong>Main Camera</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class DIYProfiling : MonoBehaviour {
  public int outerLoopIterations = 20;
  public int innerLoopMaxIterations = 100;

  void Update(){
    string profileName = "MATT_calculations";
    Profile.StartProfile(profileName);

    for (int i = 0; i &lt; outerLoopIterations; i++){
      int innerLoopIterations = Random.Range(2,innerLoopMaxIterations);
      for (int j = 0; j &lt; innerLoopIterations; j++){
        float n = Random.Range(-1000f, 1000f);
      }
    }

    Profile.EndProfile(profileName);
  }


  private void OnApplicationQuit() {
    Profile.PrintResults();
  }
}</pre></div></li><li class="listitem">Run the game for a few seconds.</li><li class="listitem">Stop the game running. You should now see in the <span class="strong"><strong>Console</strong></span> a summary message stating<a class="indexterm" id="id1273"/> total processing time for our named Profile, average time, and number of iterations, and also the total time for which the game was run.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec385"/>How it works...</h2></div></div></div><p>As you can see, the script is almost identical to that used with the Unity profiling in the previous recipe. Rather than calling the Unity <span class="strong"><strong>Profiler</strong></span>, we call static (class) methods of Michael Garforth's <code class="literal">Profile</code> class.</p><p>We call <code class="literal">Profile</code> class<a class="indexterm" id="id1274"/> methods <code class="literal">StartProfile(…)</code> and <code class="literal">EndProfile(…)</code> with the string name for what is to be analyzed (in this example, <code class="literal">MATT_calculations</code>).</p><p>Finally, the <code class="literal">OnApplicationQuit()</code>method is executed when the game is terminated, calling the <code class="literal">PrintResuls()</code> method of the <code class="literal">Profile</code> class, which prints to the console the summary performance information.</p><p>The <code class="literal">Profile</code> class records how many times, and how long between Start and End, each named profile is called, outputting summary information about these executions when <code class="literal">PrintResuls()</code> is called.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec386"/>See also</h2></div></div></div><p>Refer to the following recipes<a class="indexterm" id="id1275"/> in this chapter<a class="indexterm" id="id1276"/> for more information:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Evaluating performance by measuring max and min frame rates (FPS)</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Identifying performance bottlenecks with the Unity performance Profiler</em></span></li></ul></div></div></div>
<div class="section" title="Cache GameObject and component references to avoid expensive lookups"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec122"/>Cache GameObject and component references to avoid expensive lookups</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 2</strong></span>: Minimize actions requiring Unity to perform "reflection" over objects and searching of all current scene objects.</p><p>Reflection is <a class="indexterm" id="id1277"/>when, at run time, Unity has to analyze objects to see whether they contain a method corresponding to a "message" that the object has received - an example would be <code class="literal">SendMessage()</code>. An example of making Unity perform a search over all active objects in a scene would be the simple and useful, but slow, <code class="literal">FindObjectsByTag()</code>. Another action that slows Unity down is each time we make it look up an object's component using <code class="literal">GetComponent()</code>.</p><div class="mediaobject"><img alt="Cache GameObject and component references to avoid expensive lookups" src="graphics/1362OT_11_33.jpg"/></div><p>In the olden days for many components, Unity offered <span class="emphasis"><em>quick component property getters</em></span> such as <code class="literal">.audio</code> to reference the <code class="literal">AudioSource</code> component of a script's parent <span class="strong"><strong>GameObject</strong></span>, <code class="literal">rigidbody</code> to<a class="indexterm" id="id1278"/> reference the <span class="strong"><strong>RigidBody</strong></span> component, and so on. However, this wasn't a consistent rule, and in other cases, you had to use <code class="literal">GetComponent()</code>. With Unity 5, all these <span class="emphasis"><em>quick component property getters</em></span> have been removed (with the exception of <code class="literal">.transform</code>, which is automatically cached, so has no performance cost to use). To help game developers update their scripts to work with Unity 5, they introduced <span class="emphasis"><em>Automatic Script Updating</em></span>, whereby (after a suitable warning to have backed up files before going ahead!) Unity will go through scripts replacing <span class="emphasis"><em>quick component property getters</em></span> code with the standardized <code class="literal">GetComponent&lt;ComponentTyle&gt;()</code> code pattern, such as <a class="indexterm" id="id1279"/>
<code class="literal">GetComponent&lt;Rigidbody&gt;()</code> and <code class="literal">GetComponent&lt;AudioSource&gt;()</code>. However, while script updating makes things consistent, and also makes explicit all these <code class="literal">GetComponent()</code> reflection statements, each <code class="literal">GetComponent()</code> execution eats up valuable processing resources.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note60"/>Note</h3><p>You can read more about Unity's reasons for this (and the alternative <span class="emphasis"><em>Extension Methods</em></span> approach they rejected; a shame—I think we'll see them appear in a later version of Unity since it's an elegant way to solve this coding situation) in this June 2014 blog post and manual page at:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://blogs.unity3d.com/2014/06/23/unity5-api-changes-automatic-script-updating/">http://blogs.unity3d.com/2014/06/23/unity5-api-changes-automatic-script-updating/</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://unity3d.com/learn/tutorials/modules/intermediate/scripting/extension-methods">http://unity3d.com/learn/tutorials/modules/intermediate/scripting/extension-methods</a></li></ul></div></div></div><p>In this recipe, we'll incrementally refactor a method, making it more efficient at each step by removing reflection and component lookup actions. The method we'll improve is to find half the distance from the <span class="strong"><strong>GameObject</strong></span> in the scene tagged <code class="literal">Player</code> (a <span class="strong"><strong>3rd Person Controller</strong></span>) and 1,000 other <span class="strong"><strong>GameObjects</strong></span> in the scene tagged <code class="literal">Respawn</code>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec387"/>Getting ready</h2></div></div></div><p>For this recipe, we have prepared a package named <code class="literal">unity4_assets_handyman_goodDirt</code> containing the 3rdPersonController handyman and Terrain material <code class="literal">goodDirt</code>. The package is in the folder <code class="literal">1362_11_15</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec388"/>How to do it...</h2></div></div></div><p>To improve code performance by caching component lookups, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new<a class="indexterm" id="id1280"/> 3D project, importing the provided Unity package <code class="literal">unity4_assets_handyman_goodDirt</code>.</li><li class="listitem">Create a new <span class="strong"><strong>Terrain </strong></span>(size <span class="strong"><strong>200 x 200</strong></span>, located at <span class="strong"><strong>-100, 0, -100</strong></span>) and texture-paint it with <span class="strong"><strong>GoodDirt</strong></span>.</li><li class="listitem">Add a <span class="strong"><strong>3rdPersonController</strong></span> at the center of the terrain (that is, <span class="strong"><strong>0, 1, 0</strong></span>). Note that this will already be tagged <span class="strong"><strong>Player</strong></span>.</li><li class="listitem">Create a new <span class="strong"><strong>Sphere</strong></span> and give it the tag <span class="strong"><strong>Respawn</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>Project</strong></span> panel, create a new empty prefab named <span class="strong"><strong>prefab_sphere</strong></span> and drag the <span class="strong"><strong>Sphere</strong></span> from the <span class="strong"><strong>Hierarchy</strong></span> panel into your prefab in the <span class="strong"><strong>Project</strong></span> panel.</li><li class="listitem">Now, delete the <span class="strong"><strong>Sphere</strong></span> from the <span class="strong"><strong>Hierarchy</strong></span> panel (since all its properties have been copied into our prefab).</li><li class="listitem">Add the following C# script class <code class="literal">SphereBuilder</code> to the <span class="strong"><strong>Main Camera</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class SphereBuilder : MonoBehaviour
{
  public const int NUM_SPHERES = 1000;
  public GameObject spherePrefab;

  void Awake(){
    List&lt;Vector3&gt; randomPositions = BuildVector3Collection(NUM_SPHERES);
    for(int i=0; i &lt; NUM_SPHERES; i++){
      Vector3 pos = randomPositions[i];
      Instantiate(spherePrefab, pos, Quaternion.identity);
    }
  }

  public List&lt;Vector3&gt; BuildVector3Collection(int numPositions){
    List&lt;Vector3&gt; positionArrayList = new List&lt;Vector3&gt;();
    for(int i=0; i &lt; numPositions; i++) {
      float x = Random.Range(-100, 100);
      float y = Random.Range(1, 100);
      float z = Random.Range(-100, 100);
      Vector3 pos = new Vector3(x,y,z);
      positionArrayList.Add (pos);
    }

    return positionArrayList;
  }
}</pre></div></li><li class="listitem">With the <span class="strong"><strong>Main Camera</strong></span> selected in the <span class="strong"><strong>Hierarchy</strong></span>, drag <span class="strong"><strong>prefab_sphere</strong></span> from the Project panel in <span class="strong"><strong>Inspector</strong></span> public variable <code class="literal">Sphere Prefab</code>, for script component <code class="literal">SphereBuilder,</code> as shown in the following screenshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_34.jpg"/></div></li><li class="listitem">Add the<a class="indexterm" id="id1281"/> following C# script class <code class="literal">SimpleMath</code> to the <span class="strong"><strong>Main Camera</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;

public class SimpleMath : MonoBehaviour {
  public float Halve(float n){
    return n / 2;
  }
}</pre></div></li></ol></div><div class="section" title="Method 1 – AverageDistance calculation"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec98"/>Method 1 – AverageDistance calculation</h3></div></div></div><p>Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following<a class="indexterm" id="id1282"/> C# script class <code class="literal">AverageDistance</code> to the <span class="strong"><strong>Main Camera</strong></span>:<div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
using System;

public class AverageDistance : MonoBehaviour
{
  void Update(){
    // method1 - basic
    Profiler.BeginSample("TESTING_method1");
    GameObject[] sphereArray = GameObject.FindGameObjectsWithTag("Respawn");
    for (int i=0; i &lt; SphereBuilder.NUM_SPHERES; i++){
      HalfDistanceBasic(sphereArray[i].transform);
    }
    Profiler.EndSample();
  }

  // basic
  private void HalfDistanceBasic(Transform sphereGOTransform){
    Transform playerTransform = GameObject.FindGameObjectWithTag("Player").transform;
    Vector3 pos1 = playerTransform.position;
    Vector3 pos2 = sphereGOTransform.position;

    float distance = Vector3.Distance(pos1, pos2);

    SimpleMath mathObject = GetComponent&lt;SimpleMath&gt;();
    float halfDistance = mathObject.Halve(distance);
  }
}</pre></div></li><li class="listitem">Open the <span class="strong"><strong>Profiler</strong></span> panel and ensure that <span class="strong"><strong>record</strong></span> is selected and and that the script processing load is being recorded.</li><li class="listitem">Run the game for 10 to 20 seconds.</li><li class="listitem">In the <span class="strong"><strong>Profiler</strong></span><a class="indexterm" id="id1283"/> panel, restrict the listed results to only samples starting with <code class="literal">TEST</code>. For whichever frame you select, you should see the percentage CPU load and milliseconds required for <span class="strong"><strong>TESTING_method1</strong></span>.</li></ol></div></div><div class="section" title="Method 2 – Cache array of Respawn object transforms"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec99"/>Method 2 – Cache array of Respawn object transforms</h3></div></div></div><p>Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><code class="literal">FindGameObjectWithTag()</code> is slow, so let's fix that for the search for objects tagged <a class="indexterm" id="id1284"/><code class="literal">Respawn</code>. First, in C# script class <code class="literal">AverageDistance</code>, add a private <code class="literal">Transform</code> array variable named <code class="literal">sphereTransformArrayCache</code>:<div class="informalexample"><pre class="programlisting">private Transform[] sphereTransformArrayCache;</pre></div></li><li class="listitem">Now, add the <code class="literal">Start()</code> method, the statement that stores in this array references to the <span class="strong"><strong>Transform</strong></span> component of all our <code class="literal">Respawn</code> tagged objects:<div class="informalexample"><pre class="programlisting">private void Start(){
  GameObject[] sphereGOArray = GameObject.FindGameObjectsWithTag("Respawn");
  sphereTransformArrayCache = new Transform[SphereBuilder.NUM_SPHERES];
  for (int i=0; i &lt; SphereBuilder.NUM_SPHERES; i++){
    sphereTransformArrayCache[i] = sphereGOArray[i].transform;
  }
}</pre></div></li><li class="listitem">Now, in the <code class="literal">Update()</code>method, start a new <span class="strong"><strong>Profiler</strong></span> sample named <span class="strong"><strong>TESTING_method2</strong></span>, which<a class="indexterm" id="id1285"/> uses our cached array of games objects tagged with <code class="literal">Respawn</code>:<div class="informalexample"><pre class="programlisting">// method2 - use cached sphere ('Respawn' array)
Profiler.BeginSample("TESTING_method2");
for (int i=0; i &lt; SphereBuilder.NUM_SPHERES; i++){
  HalfDistanceBasic(sphereTransformArrayCache[i]);
}
Profiler.EndSample();</pre></div></li><li class="listitem">Once again, run the game for 10 to 20 seconds and set the <span class="strong"><strong>Profiler</strong></span> panel to restrict the listed results to only samples starting with <code class="literal">TEST</code>. For whichever frame you select, you should see the percentage CPU load and milliseconds required for <span class="strong"><strong>TESTING_method1</strong></span> and <span class="strong"><strong>TESTING_method2</strong></span>.</li></ol></div></div><div class="section" title="Method 3 – Cache reference to Player transform"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec100"/>Method 3 – Cache reference to Player transform</h3></div></div></div><p>That should run faster. But wait! Let's improve things some more. Let's make use of a cached reference to <span class="strong"><strong>Cube-Player</strong></span> component's transform, avoiding the slow object-tag reflection lookup<a class="indexterm" id="id1286"/> altogether. Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, add a new private variable and a statement in the <code class="literal">Start()</code>method to assign the <code class="literal">Player</code> object's transform in this variable <code class="literal">playerTransformCache</code>:<div class="informalexample"><pre class="programlisting">private Transform playerTransformCache;
private Transform[] sphereTransformArrayCache;

private void Start(){
  GameObject[] sphereGOArray = GameObject.FindGameObjectsWithTag("Respawn");
  sphereTransformArrayCache = new Transform[SphereBuilder.NUM_SPHERES];
  for (int i=0; i &lt; SphereBuilder.NUM_SPHERES; i++){
    sphereTransformArrayCache[i] = sphereGOArray[i].transform;
  }

  playerTransformCache = GameObject.FindGameObjectWithTag("Player").transform;
}</pre></div></li><li class="listitem">Now, in <code class="literal">Update()</code>, add the following code to start a new <span class="strong"><strong>Profiler</strong></span> sample named <span class="strong"><strong>TESTING_method3</strong></span>:<div class="informalexample"><pre class="programlisting">// method3 - use cached playerTransform
Profiler.BeginSample("TESTING_method3");
for (int i=0; i &lt; SphereBuilder.NUM_SPHERES; i++){
HalfDistanceCachePlayerTransform(sphereTransformArrayCache[i]);
}
Profiler.EndSample();</pre></div></li><li class="listitem">Finally, we need to write a new method that calculates the half distance making use<a class="indexterm" id="id1287"/> of the cached player transform variable we have set up. So, add this new method, <code class="literal">HalfDistanceCachePlayerTransform( sphereTransformArrayCache[i] )</code>:<div class="informalexample"><pre class="programlisting">// playerTransform cached
private void HalfDistanceCachePlayerTransform(Transform sphereGOTransform){
  Vector3 pos1 = playerTransformCache.position;
  Vector3 pos2 = sphereGOTransform.position;
  float distance = Vector3.Distance(pos1, pos2);
  SimpleMath mathObject = GetComponent&lt;SimpleMath&gt;();
  float halfDistance = mathObject.Halve(distance);
}</pre></div></li></ol></div></div><div class="section" title="Method 4 – Cache Player's Vector3 position"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec101"/>Method 4 – Cache Player's Vector3 position</h3></div></div></div><p>Let's improve things some more. If, for our particular game, we can make the assumption that the player character<a class="indexterm" id="id1288"/> does not move, we have an opportunity to cache the player's <span class="strong"><strong>position</strong></span> once, rather than retrieving it for each frame.</p><p>Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">At the moment, to find <code class="literal">pos1</code>, we are making Unity find the position <code class="literal">Vector3</code> value inside <code class="literal">playerTransform</code> <span class="emphasis"><em>every time the</em></span> <code class="literal">Update()</code> <span class="emphasis"><em>method is called.</em></span> Let's cache this <code class="literal">Vector3</code> position with a variable and statement in <code class="literal">Start()</code>, as follows:<div class="informalexample"><pre class="programlisting">private Vector3 pos1Cache;

private void Start(){
...
pos1Cache = playerTransformCache.position;
}</pre></div></li><li class="listitem">Now, write a new half-distance method that makes use of this cached position:<div class="informalexample"><pre class="programlisting">// player position cached
private void HalfDistanceCachePlayer1Position(Transform sphereGOTransform){
  Vector3 pos1 = pos1Cache;
  Vector3 pos2 = sphereGOTransform.position;
  float distance = Vector3.Distance(pos1, pos2);
  SimpleMath mathObject = GetComponent&lt;SimpleMath&gt;();
  float halfDistance = mathObject.Halve(distance);
}</pre></div></li><li class="listitem">Now, in<a class="indexterm" id="id1289"/> the <code class="literal">Update()</code> method, add the following code so that we create a new sample for our method 4, and call our new half-distance method:<div class="informalexample"><pre class="programlisting">// method4 - use cached playerTransform.position
Profiler.BeginSample("TESTING_method4");
for (int i=0; i &lt; SphereBuilder.NUM_SPHERES; i++){
  HalfDistanceCachePlayer1Position(sphereTransformArrayCache[i]);
}
Profiler.EndSample();</pre></div></li></ol></div></div><div class="section" title="Method 5 – Cache reference to SimpleMath component"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec102"/>Method 5 – Cache reference to SimpleMath component</h3></div></div></div><p>That should improve things again. But we can still improve things—you'll notice in our latest half-distance<a class="indexterm" id="id1290"/> method that we have an explicit <code class="literal">GetComponent()</code> call to get a reference to our <code class="literal">mathObject</code>; this will be executed <span class="emphasis"><em>every time the method is called.</em></span> Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's cache this scripted component reference as well to save a <code class="literal">GetComponent()</code> reflection for each iteration. We'll declare a variable <code class="literal">mathObjectCache</code>, and in <code class="literal">Awake()</code>, we will set it to refer to our <code class="literal">SimpleMath</code> scripted component:<div class="informalexample"><pre class="programlisting">private SimpleMath mathObjectCache;

private void Awake(){
  mathObjectCache = GetComponent&lt;SimpleMath&gt;();
}</pre></div></li><li class="listitem">Let's write a new half-distance method that uses this cached reference to the math component <code class="literal">HalfDistanceCacheMathComponent(i)</code>:<div class="informalexample"><pre class="programlisting">// math Component cache
private void HalfDistanceCacheMathComponent(Transform sphereGOTransform){
  Vector3 pos1 = pos1Cache;
  Vector3 pos2 = sphereGOTransform.position;
  float distance = Vector3.Distance(pos1, pos2);
  SimpleMath mathObject = mathObjectCache;
  float halfDistance = mathObject.Halve(distance);
}</pre></div></li><li class="listitem">Now, in the <a class="indexterm" id="id1291"/><code class="literal">Update()</code> method, add the following code so that we create a new sample for our <span class="emphasis"><em>method5</em></span> and call our new half-distance method:<div class="informalexample"><pre class="programlisting">// method5 - use cached math component
Profiler.BeginSample("TESTING_method5");
for (int i=0; i &lt; SphereBuilder.NUM_SPHERES; i++){
  HalfDistanceCacheMathComponent(sphereTransformArrayCache[i]);
}
Profiler.EndSample();</pre></div></li></ol></div></div><div class="section" title="Method 6 – Cache array of sphere Vector3 positions"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec103"/>Method 6 – Cache array of sphere Vector3 positions</h3></div></div></div><p>We've improved things <a class="indexterm" id="id1292"/>quite a bit, but there is still a glaring opportunity to use caching to improve our code (if we can assume that the spheres do not move, which seems reasonable in this example). At present, for every frame and every sphere in our half-distance calculation method, we are asking Unity to retrieve the value of the <code class="literal">Vector3</code> position property in the transform of the current sphere (this is our variable <code class="literal">pos2</code>), and this position is used to calculate the distance of the current sphere from <code class="literal">Player</code>. Let's create an array of all those <code class="literal">Vector3</code> positions so that we can pass the current one to our half-distance calculation method and save the work of retrieving it so many times.</p><p>Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, add a new private variable and a statement inside our existing loop in the <code class="literal">Start()</code> method to assign each sphere's <code class="literal">Vector3</code> transform position in the array <code class="literal">spherePositionArrayCache</code>:<div class="informalexample"><pre class="programlisting">private Vector3[] spherePositionArrayCache = new Vector3[SphereBuilder.NUM_SPHERES];

private void Start(){
  GameObject[] sphereGOArray = GameObject.FindGameObjectsWithTag("Respawn");
  sphereTransformArrayCache = new Transform[SphereBuilder.NUM_SPHERES];
  for (int i=0; i &lt; SphereBuilder.NUM_SPHERES; i++){
    sphereTransformArrayCache[i] = sphereGOArray[i].transform;
    spherePositionArrayCache[i] = sphereGOArray[i].transform.position;
  }

  playerTransformCache = GameObject.FindGameObjectWithTag("Player").transform;
  pos1Cache = playerTransformCache.position;
}</pre></div></li><li class="listitem">Let's write a<a class="indexterm" id="id1293"/> new half-distance method that uses this array of cached positions:<div class="informalexample"><pre class="programlisting">// sphere position cache
private void HalfDistanceCacheSpherePositions(Transform sphereGOTransform, Vector3 pos2){
  Vector3 pos1 = pos1Cache;
  float distance = Vector3.Distance(pos1, pos2);
  SimpleMath mathObject = mathObjectCache;
  float halfDistance = mathObject.Halve(distance);
}</pre></div></li><li class="listitem">Now, in the <code class="literal">Update()</code>method, add the following code so that we create a new sample for our <span class="emphasis"><em>method6</em></span> and call our new half-distance method:<div class="informalexample"><pre class="programlisting">// method6 - use cached array of sphere positions
Profiler.BeginSample("TESTING_method6");
for (int i=0; i &lt; SphereBuilder.NUM_SPHERES; i++){
HalfDistanceCacheSpherePositions(sphereTransformArrayCache[i], spherePositionArrayCache[i]);
}
Profiler.EndSample();</pre></div></li><li class="listitem">Open the <span class="strong"><strong>Profiler</strong></span> panel and ensure that <span class="strong"><strong>record</strong></span> is selected and script processing load is being recorded.</li><li class="listitem">Run the game for 10 to 20 seconds.</li><li class="listitem">In the <span class="strong"><strong>Profiler</strong></span> panel, restrict the listed results to only samples starting with <code class="literal">TEST</code>. For whichever frame you select, you should see the percentage CPU load and milliseconds required for each method (lower is better for both these values!). For almost every frame, you should see how/if each method refined by caching has reduced the CPU load.<div class="mediaobject"><img alt="Method 6 – Cache array of sphere Vector3 positions" src="graphics/1362OT_11_35.jpg"/></div></li></ol></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec389"/>How it works...</h2></div></div></div><p>This recipe illustrates how we try to cache references once, before any iteration, for variables whose value will not change, such as references to <code class="literal">GameObjects</code> and their components, and, in this example, the <code class="literal">Transform</code> components and <code class="literal">Vector3</code> positions of objects tagged <code class="literal">Player</code> and <code class="literal">Respawn</code>. Of course, as with everything, there is a "cost" associated with<a class="indexterm" id="id1294"/> caching, and that cost is the memory requirements to store all those references. This is known as the <a class="indexterm" id="id1295"/><span class="strong"><strong>Space-Time Tradeoff</strong></span>. You can learn more about this classic computer science<a class="indexterm" id="id1296"/> speed versus memory tradeoff at <a class="ulink" href="https://en.wikipedia.org/wiki/Space%E2%80%93time_tradeoff">https://en.wikipedia.org/wiki/Space%E2%80%93time_tradeoff</a>.</p><p>In methods that need to be performed many times, this removing of implicit and explicit component and object lookups may offer a measurable performance improvement.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note61"/>Note</h3><p>Note: Two good places to learn more about Unity performance optimization techniques are from the <span class="emphasis"><em>Performance Optimization</em></span> web page in the Unity script reference and from Unity's Jonas Echterhoff and Kim Steen Riber Unite2012 presentation <span class="emphasis"><em>Performance Optimization Tips and Tricks for Unity</em></span>. Many recipes in this chapter had their origins from suggestions in the following sources:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://docs.unity3d.com/410/Documentation/ScriptReference/index.Performance_Optimization.html">http://docs.unity3d.com/410/Documentation/ScriptReference/index.Performance_Optimization.html</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://unity3d.com/unite/archive/2012">http://unity3d.com/unite/archive/2012</a></li></ul></div></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec390"/>See also</h2></div></div></div><p>Refer to the following recipes in this chapter for more information:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Improving efficiency with delegates and events and avoiding SendMessage!</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Identifying performance bottlenecks with the Unity performance Profiler</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Identifying performance bottlenecks with Do-It-Yourself performance profiling</em></span></li></ul></div></div></div>
<div class="section" title="Improving performance with LOD groups"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec123"/>Improving performance with LOD groups</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 5</strong></span>: Minimize the number of draw calls.</p><p>Detailed geometry and high-resolution texture maps can be a double-edged sword: they can deliver a better visual experience, but they can impact negatively on the game's performance. <span class="strong"><strong>LOD groups</strong></span> address<a class="indexterm" id="id1297"/> this issue by replacing high-quality objects by simplified versions whenever that object takes up a smaller portion of the screen than necessary for a high-quality version to make a significant difference.</p><p>In this recipe, we will use a <span class="strong"><strong>LOD group</strong></span> to create a game object featuring two different levels of detail: a high-quality version for whenever the object takes up more than 50 percent of the screen and a low-quality version for the times it takes up less than that amount. We would like to thank Carl Callewaert, from Unity, for his demonstration of the LOD Group functionality, which has informed this recipe in many ways.</p><div class="mediaobject"><img alt="Improving performance with LOD groups" src="graphics/1362OT_11_09.jpg"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec391"/>Getting ready</h2></div></div></div><p>For this recipe, we have prepared two prefabs for the high- and low-quality versions of the game object. They share the same dimensions and transform settings (position, rotation, and scale), so that they can replace each other seamlessly. Both prefabs are contained within the package named <code class="literal">LODGroup</code>, available in the <code class="literal">1362_11_16</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec392"/>How to do it...</h2></div></div></div><p>To create a LOD group, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Import the <span class="strong"><strong>LODGroup</strong></span> package into your project.</li><li class="listitem">From the <span class="strong"><strong>Project</strong></span> view, inside the <span class="strong"><strong>LOD</strong></span> folder, drag the <span class="strong"><strong>batt-high</strong></span> prefab into the <span class="strong"><strong>Hierarchy</strong></span> view. Then, do the same for the <span class="strong"><strong>batt-low </strong></span>prefab. Make sure that they are placed at the same <span class="strong"><strong>Position</strong></span> (<span class="strong"><strong>X</strong></span>: <span class="strong"><strong>0</strong></span>; <span class="strong"><strong>Y</strong></span>: <span class="strong"><strong>0</strong></span>; <span class="strong"><strong>Z</strong></span>: <span class="strong"><strong>0</strong></span>).</li><li class="listitem">From the <span class="strong"><strong>Create</strong></span> drop-down menu in the <span class="strong"><strong>Hierarchy</strong></span> view, create a new empty game<a class="indexterm" id="id1298"/> object (<span class="strong"><strong>Create</strong></span> | <span class="strong"><strong>Create Empty</strong></span>). Rename it <code class="literal">battLOD</code>.</li><li class="listitem">Add the <span class="strong"><strong>LODGroup</strong></span> component to <span class="strong"><strong>battLOD</strong></span> (menu <span class="strong"><strong>Component</strong></span> | <span class="strong"><strong>Rendering</strong></span> | <span class="strong"><strong>LODGroup</strong></span>).</li><li class="listitem">Select the <span class="strong"><strong>battLOD</strong></span> object, and, from the <span class="strong"><strong>Inspector</strong></span> view, <span class="strong"><strong>LODGroup</strong></span> component, right-click on <span class="strong"><strong>LOD 2</strong></span> and delete it (since we'll have only two different LODs: <span class="strong"><strong>LOD 0</strong></span> and <span class="strong"><strong>LOD 1</strong></span>), as shown in the following screnshot:<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_10.jpg"/></div></li><li class="listitem">Select the <span class="strong"><strong>LOD 0</strong></span> area, click on the <span class="strong"><strong>Add</strong></span> button, and select the <span class="strong"><strong>batt-high</strong></span> game object from the list. A message about reparenting objects will appear. Select <span class="strong"><strong>Yes, Reparent</strong></span>.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_11.jpg"/></div></li><li class="listitem">Select<a class="indexterm" id="id1299"/> the <span class="strong"><strong>LOD 1</strong></span> section, click on <span class="strong"><strong>Add</strong></span>, and select the <span class="strong"><strong>batt-low</strong></span> object. Again, chose <span class="strong"><strong>Yes, Reparent</strong></span> when prompted.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_12.jpg"/></div></li><li class="listitem">Drag the limits of the LOD renderers to set them as: <span class="strong"><strong>LOD 0: 100%</strong></span>, <span class="strong"><strong>LOD 1</strong></span>: <span class="strong"><strong>50%</strong></span>, <span class="strong"><strong>Culled: 1%.</strong></span> That will make Unity render <span class="strong"><strong>bat-high </strong></span>whenever it occupies 51 percent to 100 percent of the screen space, <span class="strong"><strong>batt-low</strong></span> when 2 percent to 50 percent, and will not render anything if 1 percent or less.<div class="mediaobject"><img alt="How to do it..." src="graphics/1362OT_11_13.jpg"/></div></li><li class="listitem">Move the scene's camera toward the <span class="strong"><strong>battLOD</strong></span> object and back. You will notice how <a class="indexterm" id="id1300"/>Unity swaps between the high- and low-definition LOD renderer as it occupies more or less than 50 percent of the screen's space.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec393"/>How it works...</h2></div></div></div><p>Once we have populated the LOD renderers with the appropriate models, the <span class="strong"><strong>LODGroup</strong></span> component will select and display the right renderer based on how much of the screen's percentage the object takes up, or even display nothing at all.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec394"/>There's more...</h2></div></div></div><p>Some details you don't want to miss:</p><div class="section" title="Adding more LOD renderers"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec104"/>Adding more LOD renderers</h3></div></div></div><p>You can add more<a class="indexterm" id="id1301"/> LOD renderers by right-clicking on an existing LOD renderer and selecting <span class="strong"><strong>Insert Before</strong></span> from the context menu.</p></div><div class="section" title="Fading LOD transitions"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec105"/>Fading LOD transitions</h3></div></div></div><p>In case you <a class="indexterm" id="id1302"/>want to minimize the <span class="emphasis"><em>popping</em></span> that occurs when renderers are swapped, you can try changing the parameter <span class="strong"><strong>Fade Mode</strong></span> from <span class="strong"><strong>None</strong></span> to <span class="strong"><strong>Percentage</strong></span> or <span class="strong"><strong>Crossfade</strong></span>.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec395"/>See also</h2></div></div></div><p>Refer to the next recipe in this chapter for more information</p></div></div>
<div class="section" title="Improving performance through reduced draw calls by designing for draw call batching"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec124"/>Improving performance through reduced draw calls by designing for draw call batching</h1></div></div></div><p>
<span class="strong"><strong>Optimization principal 5</strong></span>: Minimize the number of draw calls.</p><p>One way to minimize draw calls is by prioritizing design decisions to qualify objects for Unity's <span class="emphasis"><em>Static</em></span> and <span class="emphasis"><em>Dynamic draw call batching</em></span>.</p><p>The more CPU-efficient batching method is Unity's<a class="indexterm" id="id1303"/> <span class="strong"><strong>static batching</strong></span>. It allows reduction of draw calls for any sized geometry. If that is not possible, then the next best thing is <a class="indexterm" id="id1304"/><span class="strong"><strong>dynamic batching</strong></span>, which again allows Unity to process together several moving objects in a single draw call.</p><p>Note that there is a cost—batching uses memory, and static batching uses more memory than dynamic memory. So, you can improve performance with batching, but you'll be increasing the scene's memory "footprint." As always, use memory and performance profiling to evaluate which use of techniques is best for your game and its intended deployment device.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec396"/>How to do it...</h2></div></div></div><p>In this section, we will learn how to make possible <span class="strong"><strong>static batching</strong></span> and <span class="strong"><strong>dynamic batching</strong></span>.</p><div class="section" title="Static batching"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec106"/>Static batching</h3></div></div></div><p>To make possible <a class="indexterm" id="id1305"/>Unity <span class="strong"><strong>static batching</strong></span>, you need to do the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Ensure that models share the same material.</li><li class="listitem">Mark models as <span class="strong"><strong>Static</strong></span>, as shown in the following screenshot:<div class="mediaobject"><img alt="Static batching" src="graphics/1362OT_11_37.jpg"/></div></li></ol></div><p>Objects that can be safely marked as <span class="strong"><strong>Static</strong></span> include environment objects that won't move or be scaled.</p><p>Many techniques can be used to ensure models share the same material including:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Avoid using textures by directly painting vertices of the model (useful links for this are provided in the <span class="emphasis"><em>There's more…</em></span> section)</li><li class="listitem" style="list-style-type: disc">Increasing the number of objects textured with exactly the same texture</li><li class="listitem" style="list-style-type: disc">Artificially enabling objects to share the same texture by combining multiple textures into a single one (texture atlassing)</li><li class="listitem" style="list-style-type: disc">Maximizing script use of <code class="literal">Renderer.sharedMaterial</code> rather than <code class="literal">Renderer.material</code> (since use of <code class="literal">Render.material</code> involves making a copy of the material and, therefore, disqualifies that GameObejct for batching)</li></ul></div><p>In fact, both static and dynamic<a class="indexterm" id="id1306"/> batching only work with objects that use the same material, so all methods above apply equally for making dynamic batching possible as well.</p></div><div class="section" title="Dynamic batching"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec107"/>Dynamic batching</h3></div></div></div><p>To make possible <a class="indexterm" id="id1307"/>Unity <span class="strong"><strong>dynamic batching</strong></span>, you need to do the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Ensure that models share the same material.</li><li class="listitem">Keep the number of <span class="strong"><strong>vertex attributes</strong></span> below 900 for each mesh.</li><li class="listitem">Have the group of objects to quality for dynamic batching to use the same transform scale (although non-uniform scaled models can still be batched).</li><li class="listitem">If possible, have dynamic lightmapped objects point to the same lightmap location to facilitate dynamic batching.</li><li class="listitem">Avoid the use of multi-pass shaders and real-time shadows if possible, since both of these prevent dynamic batching.</li></ol></div><p>To calculate the number of<a class="indexterm" id="id1308"/> <span class="strong"><strong>vertex attributes</strong></span>, you need to multiply the number of vertices by the number of attributes<a class="indexterm" id="id1309"/> used by the <span class="strong"><strong>Shader</strong></span>. For example, for a <span class="strong"><strong>Shader</strong></span> using three attributes (vertex position, normal, and UV), it would mean that a model must have less than 300 vertices to keep the total number of attributes below 900 to qualify for dynamic batching.</p></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec397"/>There's more...</h2></div></div></div><p>Some details you don't want to miss:</p><div class="section" title="Reduce the need for textures by vertex painting"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec108"/>Reduce the need for textures by vertex painting</h3></div></div></div><p>For more information <a class="indexterm" id="id1310"/>about this topic, see the<a class="indexterm" id="id1311"/> following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Blender:<p>
<a class="ulink" href="http://wiki.blender.org/index.php/Doc:2.6/Manual/Materials/Special_Effects/Vertex_Paint">http://wiki.blender.org/index.php/Doc:2.6/Manual/Materials/Special_Effects/Vertex_Paint</a>
</p></li><li class="listitem" style="list-style-type: disc">3D Studio<a class="indexterm" id="id1312"/> Max:<p>
<a class="ulink" href="http://3dmax-tutorials.com/Vertex_Paint_Modifier.html">http://3dmax-tutorials.com/Vertex_Paint_Modifier.html</a>
</p></li><li class="listitem" style="list-style-type: disc">Maya: free Vertex Chameleon plugin<p>
<a class="ulink" href="http://renderheads.com/portfolio/VertexChameleon/">http://renderheads.com/portfolio/VertexChameleon/</a>
</p></li></ul></div></div><div class="section" title="Information sources about reducing textures and materials"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec109"/>Information sources about reducing textures and materials</h3></div></div></div><p>For more information about this topic, see the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Unity manual <a class="indexterm" id="id1313"/>page for Draw Call Batching:<p>
<a class="ulink" href="http://docs.unity3d.com/Manual/DrawCallBatching.html">http://docs.unity3d.com/Manual/DrawCallBatching.html</a>
</p></li><li class="listitem" style="list-style-type: disc">Paladin <a class="indexterm" id="id1314"/>Studios:<p>
<a class="ulink" href="http://www.paladinstudios.com/2012/07/30/4-ways-to-increase-performance-of-your-unity-game/">http://www.paladinstudios.com/2012/07/30/4-ways-to-increase-performance-of-your-unity-game/</a>
</p></li><li class="listitem" style="list-style-type: disc">Nvidia white paper on texture atlassing to increase draw call batching opportunities:<p>
<a class="ulink" href="http://http.download.nvidia.com/developer/NVTextureSuite/Atlas_Tools/Texture_Atlas_Whitepaper.pdf">http://http.download.nvidia.com/developer/NVTextureSuite/Atlas_Tools/Texture_Atlas_Whitepaper.pdf</a>
</p></li><li class="listitem" style="list-style-type: disc">Nvidia free texture tools<a class="indexterm" id="id1315"/> and Photoshop plug-in:<p>
<a class="ulink" href="http://www.nvidia.com/object/texture_atlas_tools.html">http://www.nvidia.com/object/texture_atlas_tools.html</a>
</p></li></ul></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec398"/>See also</h2></div></div></div><p>Refer to the <span class="emphasis"><em>Improving performance with LOD groups</em></span> recipe in this chapter for more information</p></div></div>
<div class="section" title="Conclusion"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec125"/>Conclusion</h1></div></div></div><p>In this chapter, we have introduced some extra features and a range of approaches to improve game performance and collect performance data for analysis.</p><p>The first three recipes in this chapter provide some ideas for adding some extra features to your game (pausing, slow motion, and securing online games). The rest of the recipes in this chapter provide examples of how to investigate and improve the efficiency and performance of your game.</p><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec399"/>There's more...</h2></div></div></div><p>Just as there are many components in a game, there are many parts of a game where processing <span class="emphasis"><em>bottlenecks</em></span> may be found and need to be addressed to improve overall game performance. Some additional suggestions and further reference sources are now provided to provide a launching pad for your further exploration of the issues of optimization and performance, since such topics could take up a whole book rather than just one chapter.</p><div class="section" title="Game audio optimization"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec110"/>Game audio optimization</h3></div></div></div><p>Mobile devices have considerably less memory and processing resources than consoles, desktops, or even laptops, and often raise the biggest challenges when it comes to game audio. For example, the iPhone can only decompress one audio clip at a time, so a game may suffer processing spikes (that is, slow down game frame rate) due to audio decompression issues.</p><p>Paladin Studios<a class="indexterm" id="id1316"/> recommend the following audio file compression strategies for mobile games:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Short Clips</strong></span>: Native (no compression)</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Longer clips</strong></span> (or ones that loop): Compressed in memory</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Music</strong></span>: Stream from disc</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Files which consistently cause CPU spikes</strong></span>: Decompress on load</li></ul></div><p>For more information about this topic, see the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Unity manual audio:<p>
<a class="ulink" href="http://docs.unity3d.com/Manual/AudioFiles.html">http://docs.unity3d.com/Manual/AudioFiles.html</a>
</p></li><li class="listitem" style="list-style-type: disc">Paladin Studios:<p>
<a class="ulink" href="http://www.paladinstudios.com/2012/07/30/4-ways-to-increase-performance-of-your-unity-game/">http://www.paladinstudios.com/2012/07/30/4-ways-to-increase-performance-of-your-unity-game/</a>
</p></li><li class="listitem" style="list-style-type: disc">Apple developers audio page:<p>
<a class="ulink" href="https://developer.apple.com/library/ios/documentation/AudioVideo/Conceptual/MultimediaPG/UsingAudio/UsingAudio.html">https://developer.apple.com/library/ios/documentation/AudioVideo/Conceptual/MultimediaPG/UsingAudio/UsingAudio.html</a>
</p></li></ul></div></div><div class="section" title="Physics engine optimization"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec111"/>Physics engine optimization</h3></div></div></div><p>For some strategies relating<a class="indexterm" id="id1317"/> to physics, you might consider to improve performance the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If possible, use<a class="indexterm" id="id1318"/> <span class="strong"><strong>geometric primitive colliders</strong></span> (2D box/2D circle/3D box/3D sphere/3D cylinder):<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You can have multiple primitive colliders</li></ul></div></li><li class="listitem" style="list-style-type: disc">You can also have primitive colliders on child objects:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">As long as you have a rigid body on the root object in the object hierarchy</li></ul></div></li><li class="listitem" style="list-style-type: disc">Avoid <span class="strong"><strong>2D polygon </strong></span>and <span class="strong"><strong>3D mesh</strong></span> colliders:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">These are much more processor intensive</li></ul></div></li><li class="listitem" style="list-style-type: disc">Try increasing<a class="indexterm" id="id1319"/> the delay between each <code class="literal">FixedUpdate()</code> method call to reduce physics:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Although not to the point where user experience or game behavior is below acceptable quality!</li></ul></div></li><li class="listitem" style="list-style-type: disc">Wherever possible, start off rigid bodies in sleep mode (so that they don't require physics processing until woken up by code or a collision). See the following Unity script reference pages for making objects go to sleep and wake up:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://docs.unity3d.com/ScriptReference/Rigidbody.Sleep.html">http://docs.unity3d.com/ScriptReference/Rigidbody.Sleep.html</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://docs.unity3d.com/ScriptReference/Rigidbody.WakeUp.html">http://docs.unity3d.com/ScriptReference/Rigidbody.WakeUp.html</a></li></ul></div><div class="mediaobject"><img alt="Physics engine optimization" src="graphics/1362OT_11_36.jpg"/></div></li></ul></div></div><div class="section" title="More tips for improving script efficiency"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec112"/>More tips for improving script efficiency</h3></div></div></div><p>Some code strategies <a class="indexterm" id="id1320"/>you might consider to improve performance include the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Use <span class="strong"><strong>Structs</strong></span> rather than <span class="strong"><strong>Classes</strong></span> to improve speed up processing.</li><li class="listitem" style="list-style-type: disc">Wherever possible, use simple arrays of primitive types rather than <span class="strong"><strong>ArrayLists</strong></span>, <span class="strong"><strong>Dictionaries,</strong></span> or more complex collection classes. A good article about choosing the most appropriate collection in Unity can be found at <a class="ulink" href="http://wiki.unity3d.com/index.php/Choosing_the_right_collection_type">http://wiki.unity3d.com/index.php/Choosing_the_right_collection_type</a>.</li><li class="listitem" style="list-style-type: disc">Raycasting is slow, so avoid performing it every frame, for example, use coroutines to only raycast every 3rd or 10th frame.</li><li class="listitem" style="list-style-type: disc">Finding objects is slow, so avoid finding objects in <code class="literal">Update()</code> or inner loops, and you <a class="indexterm" id="id1321"/>can have objects set up a <code class="literal">public static</code> variable to allow quick instance retrieval, rather than using a <code class="literal">Find(…)</code> method. Or you could use the Singleton design pattern.</li><li class="listitem" style="list-style-type: disc">Avoid using <code class="literal">OnGUI()</code>, since it is called every frame just like <code class="literal">Update()</code>; this is much easier to avoid now with the new Unity 5 UI system.</li></ul></div></div><div class="section" title="Sources of more wisdom about optimization"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec113"/>Sources of more wisdom about optimization</h3></div></div></div><p>Here are several other sources that you might want to explore to learn more about game optimization topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Unity<a class="indexterm" id="id1322"/> general mobile optimization page:<p>
<a class="ulink" href="http://docs.unity3d.com/Manual/MobileOptimisation.html">http://docs.unity3d.com/Manual/MobileOptimisation.html</a>
</p></li><li class="listitem" style="list-style-type: disc">X-team Unity best practices:<p>
<a class="ulink" href="http://x-team.com/2014/03/unity-3d-optimisation-and-best-practices-part-1/">http://x-team.com/2014/03/unity-3d-optimisation-and-best-practices-part-1/</a>
</p></li><li class="listitem" style="list-style-type: disc">Code Project:<p>
<a class="ulink" href="http://www.codeproject.com/Articles/804021/Unity-and-Csharp-Performance-Optimisation-tips">http://www.codeproject.com/Articles/804021/Unity-and-Csharp-Performance-Optimisation-tips</a>
</p></li><li class="listitem" style="list-style-type: disc">General graphics optimization:<p>
<a class="ulink" href="http://docs.unity3d.com/Manual/OptimizingGraphicsPerformance.html">http://docs.unity3d.com/Manual/OptimizingGraphicsPerformance.html</a>
</p></li><li class="listitem" style="list-style-type: disc">Learn more about mobile physics at Unity's iPhone optimization physics page:<p>
<a class="ulink" href="http://docs.unity3d.com/Manual/iphone-Optimizing-Physics.html">http://docs.unity3d.com/Manual/iphone-Optimizing-Physics.html</a>
</p></li></ul></div></div><div class="section" title="Published articles that discuss premature optimization"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec114"/>Published articles that discuss premature optimization</h3></div></div></div><p>Here are<a class="indexterm" id="id1323"/> several articles discussing Donald Knuth's famous quotation about premature optimization being "evil":</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Joe Duffy's blog:<p>
<a class="ulink" href="http://joeduffyblog.com/2010/09/06/the-premature-optimization-is-evil-myth/">http://joeduffyblog.com/2010/09/06/the-premature-optimization-is-evil-myth/</a>
</p></li><li class="listitem" style="list-style-type: disc">"When is optimization premature?" Stack Overflow:<p>
<a class="ulink" href="http://stackoverflow.com/questions/385506/when-is-optimisation-premature">http://stackoverflow.com/questions/385506/when-is-optimisation-premature</a>
</p></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>The Fallacy of Premature Optimization</em></span>, Randall Hyde (published by ACM), source: Ubiquity <a class="indexterm" id="id1324"/>Volume 10, Issue 3, 2009:<p>
<a class="ulink" href="http://ubiquity.acm.org/article.cfm?id=1513451">http://ubiquity.acm.org/article.cfm?id=1513451</a>
</p></li></ul></div></div><div class="section" title="Sources of more about Game Managers and the State Pattern"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl3sec115"/>Sources of more about Game Managers and the State Pattern</h3></div></div></div><p>Learn more<a class="indexterm" id="id1325"/> about implementing the State Pattern and Game Managers in <a class="indexterm" id="id1326"/>Unity from the following sites:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://rusticode.com/2013/12/11/creating-game-manager-using-state-machine-and-singleton-pattern-in-unity3d/">http://rusticode.com/2013/12/11/creating-game-manager-using-state-machine-and-singleton-pattern-in-unity3d/</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://github.com/thefuntastic/Unity3d-Finite-State-Machine">https://github.com/thefuntastic/Unity3d-Finite-State-Machine</a></li></ul></div></div></div></div></body></html>