<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Relationship Management</h1></div></div></div><p>Relationship management software is typically a result of what ERP applications have achieved.</p><p>In earlier days, everyone had a rolodex on their desk with phone numbers and addresses and salespeople would always know by heart who was a good customer and which customers were always late paying or had bad margins.</p><p>The introduction of RM software completely changed that, allowing us to maintain all companies' contacts in a single place and analyze sales data very easily.</p><p>Relationship management has been part of Microsoft Dynamics since Version 2.0 and was dramatically changed and improved in Version 3.0. The current Microsoft Dynamics NAV RM software is mostly the same as in that version, except for the Microsoft Outlook integration that keeps changing in every version.</p><p>In this chapter, we will deep dive into this module, which is very complete. After reading this chapter, you will have a good understanding of the concepts and how to maintain master data and analyze transaction data.</p><p>We will also perform some application changes in the relationship management part.</p><div><div><div><div><h1 class="title"><a id="ch04lvl1sec36"/>How companies work</h1></div></div></div><p>In traditional accounting<a class="indexterm" id="id426"/> software, we differentiate customers and vendors as business relations for invoices, but companies have many more relations we would like to register in our system.</p><p>Also, a company or person can have multiple relations with our company. The best example is my relationship with Microsoft. As everyone, I use the software so I am a customer, both in my business and personal life. On the other hand, Microsoft hires me to teach workshops and do presentations, which makes me a vendor. As an MVP, I have a totally different relationship with them. They give me an award and invite me to special events and allow me to access the company store. They also ask for my advice in future versions, so to them, I am their consultant.</p><p>So one person or company can have different roles in RM. Microsoft Dynamics NAV is able to handle all that while maintaining a single point of data entry and maintenance.</p><p>Unlike financial applications, RM is much more flexible. The functionality and rules of financial applications are <a class="indexterm" id="id427"/>defined by government regulations and are mandatory for companies to comply with. Companies are not forced to use RM but once implemented, everyone understands the benefits and never want to do without it.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec69"/>Contacts</h2></div></div></div><p>The starting point of the<a class="indexterm" id="id428"/> RM <a class="indexterm" id="id429"/>application is the <strong>Contact</strong> table. This is where we store the address, phone numbers, e-mail addresses, and so on of everyone we know.</p><p>When we open the <strong>Contact list</strong>, we see that companies and persons are grouped for an easy overview.</p><div><img alt="Contacts" src="img/0365EN_04_01.jpg"/><div><p>The cut-off text is not important for reference in this screenshot</p></div></div><p>As we learned in the previous chapters, a page in Microsoft Dynamics NAV is based on a single table, so that must mean that companies and persons are stored in the same table.</p><p>When we open the contact card, we can clearly see that this is the case. The <strong>Type</strong> field indicates whether the contact is a business or a person and whether the person belongs to a company. The <strong>Company No.</strong> field refers to a contact with type<strong> Company</strong>. This is a one-to-many relationship meaning that if a physical person has a relationship with more than one company, he or she needs to be maintained for each company with a relation.</p><p>The following screenshot is from the contact card in Microsoft Dynamics NAV:</p><div><img alt="Contacts" src="img/0365EN_04_02.jpg"/></div><p>Let's step through the tabs <a class="indexterm" id="id430"/>and look at some important fields:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>No.</strong>: This is a unique key value determined by a Number Series. Companies and persons have the same numbering.</li><li class="listitem" style="list-style-type: disc"><strong>Type</strong>: This indicates whether this contact is a person or a company.</li><li class="listitem" style="list-style-type: disc"><strong>Company Name</strong>: When the contact is a person and connected to a company, it is automatically populated with that company's name.</li><li class="listitem" style="list-style-type: disc"><strong>Name</strong>: This is the name of the contact. If the contact is a person, we can click on the <strong>AssistEdit</strong> button next to the name to open the name details. The name is automatically broken down in to first, middle, and last name depending on the number of words we enter. However, if our contact has a more complex name like "Walter van den Broek", which is typical for Dutch people, the system is unable to break it down.<div><img alt="Contacts" src="img/0365EN_04_03.jpg"/></div></li><li class="listitem" style="list-style-type: disc"><strong>Address</strong>: Enter the <a class="indexterm" id="id431"/>street where the contact lives or has an office.<div><div><h3 class="title"><a id="tip23"/>Tip</h3><p>It is always best practice to enter the postal address here since this will be used on all documents. For a visiting address, use the <strong>Alternative Address</strong> feature.</p></div></div></li><li class="listitem" style="list-style-type: disc"><strong>Post Code &amp; City</strong>: These fields are connected via the <strong>Post Code</strong> table and one can populate the other if that table is maintained, which is an optional feature.<div><div><h3 class="title"><a id="note09"/>Note</h3><p>Most companies maintain the <strong>Post Code</strong> table for their country and manually enter the post codes for foreign countries. Most countries offer a post code/city list for sale or as a web service, which will speed up data entry and keep people from entering the wrong master data.</p></div></div></li><li class="listitem" style="list-style-type: disc"><strong>Search Name</strong>: This is automatically populated with the <strong>Name</strong> field and lets you search for contacts faster, as you can enter this field instead of the <strong>No.</strong> field when referencing to a contact.</li><li class="listitem" style="list-style-type: disc"><strong>(Mobile) Phone, Fax</strong>, and <strong>Telex No.</strong>: This is a reference to the phone and fax numbers of this company. The (mobile) phone field also allows you to start an interaction with this contact.</li><li class="listitem" style="list-style-type: disc"><strong>Sales Person</strong>: This is <a class="indexterm" id="id432"/>the main salesperson for this contact. If this contact is promoted to a customer, the salespersons' name will be printed on the order form and invoices.</li><li class="listitem" style="list-style-type: disc"><strong>Salutation Code</strong>: This special field refers to how this contact should be addressed. The salutation code table allows you to build phrases such as "Dear Mrs. Brown". We'll see more about salutation codes in segments.</li><li class="listitem" style="list-style-type: disc"><strong>E-Mail</strong>: This field contains the e-mail address of the contact. By pressing the <strong>E-Mail</strong> button [<img alt="Contacts" src="img/0365EN_04_04.jpg"/>], we can send an e-mail directly.
</li><li class="listitem" style="list-style-type: disc"><strong>Homepage</strong>: Here is where the URL of the contacts website goes. We can access the website by clicking on the <strong>URL</strong> button [<img alt="Contacts" src="img/0365EN_04_05.jpg"/>].
</li><li class="listitem" style="list-style-type: disc"><strong>Correspondence Type</strong>: This field is used when we create a Microsoft Word document in an interaction. It indicates whether we send a hardcopy, e-mail, or fax.</li><li class="listitem" style="list-style-type: disc"><strong>Currency Code &amp; VAT Registration No.</strong>: When this contact is promoted to a customer or vendor, the currency code and VAT registration no. are inherited from here.</li><li class="listitem" style="list-style-type: disc"><strong>Territory Code</strong>: This field can be used in segments to filter on geographic regions.</li></ul></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec26"/>Salutation codes</h3></div></div></div><p>When we perform mail merge, we <a class="indexterm" id="id433"/>want the letters to start nicely with "Dear Harry" or dear "Mrs. Brown". This can<a class="indexterm" id="id434"/> be done using salutation codes.</p><p>We can create as many codes as we like but a contact can only use one. This is the list in the CRONUS demo database.</p><div><img alt="Salutation codes" src="img/0365EN_04_06.jpg"/></div><p>There is one salutation<a class="indexterm" id="id435"/> code for <a class="indexterm" id="id436"/>companies but most are for persons. When we look at the formulas for <strong>Female Married</strong> or <strong>Unmarried</strong>, we see this screen:</p><div><img alt="Salutation codes" src="img/0365EN_04_07.jpg"/></div><p>We can enter a<a class="indexterm" id="id437"/> formal and informal code. The salutation can have up to<a class="indexterm" id="id438"/> five variables pointing to <strong>Job Title</strong>, <strong>First Name</strong>, <strong>Middle Name</strong>, <strong>Surname</strong>, <strong>Initials</strong>, and <strong>Company Name</strong>.</p><p>When we look at the result for Karen Friske, it will be "Dear Ms. Karen Friske" or "Hi Karen".</p><p>At the end of this chapter, we will look at how to create extra salutation types.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec27"/>Alternative addresses</h3></div></div></div><p>Like we said earlier in this <a class="indexterm" id="id439"/>chapter, it is best practice to use the address fields in the contact table for the postal address since this will be printed on all documents.</p><p>In the <strong>Contact Alt. Address Card</strong> table, we can add as many other addresses to a contact as we want.</p><div><img alt="Alternative addresses" src="img/0365EN_04_08.jpg"/></div><div><div><h3 class="title"><a id="tip24"/>Tip</h3><p>Although the codes are not related to anything, it is best practice to have a rule here. Always use the same code for home or office addresses. We can later use this when printing labels or segments.</p></div></div><p>An alternative <a class="indexterm" id="id440"/>address can also have a valid to and valid end date to control which alternative address is currently active.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec28"/>Relationships with customer and vendor</h3></div></div></div><p>In <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <em>A Sample Application</em>, you saw<a class="indexterm" id="id441"/> that the contact table is the umbrella data of the customer, vendor, and bank account master data tables.</p><p>Each contact of the type <strong>Company</strong> can be promoted as one of these tables. The benefit is that all address information fields have a single place of maintenance and are inherited. It also allows us to analyze sales data into relationship management as we will see later in this chapter when discussing segments.</p><p>When we create master data, a different Number Series is used. At the end of this chapter, we will look at how to change that in the code.</p><p>A contact of <strong>Type: Person</strong> cannot be created as the <strong>Customer</strong>, <strong>Vendor</strong>, or <strong>Bank Account</strong>.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec29"/>Duplicates</h3></div></div></div><p>When entering new contacts, the <a class="indexterm" id="id442"/>system can search for duplicate contacts. In the Duplicate Search String Setup table, we can enable the filtering on eight fields: <strong>Name</strong>, <strong>Name2</strong>, <strong>Address</strong>, <strong>Address2</strong>, <strong>Post Code</strong>, <strong>City</strong>, <strong>Phone No.</strong>, and <strong>VAT Registration No</strong>.</p><p>For each field, we can set up which part should be used when searching for a duplicate. We can use the option <strong>First</strong> and <strong>Last</strong> and a length, which is useful for the <strong>Name</strong>, <strong>Address</strong>, and <strong>City</strong> fields. Using <strong>First</strong> with the full length of the field will search for an exact match, which is useful for <strong>Post Code</strong>, <strong>Phone No.</strong>, and <strong>VAT Registration No</strong>.</p><p>In the <strong>Marketing Setup</strong> table, we can specify the percentage of matching criteria that should result in a warning, as shown in the following screenshot:</p><div><img alt="Duplicates" src="img/0365EN_04_09.jpg"/></div><p>For each contact, the system will save these values in <code class="literal">Cont. Duplicate Search String table (5086)</code>.</p><p>When we enter a new contact, the <a class="indexterm" id="id443"/>system will also generate the same strings and compare these to the ones in the database. When there is a match, the system will show a warning with the duplicate contacts.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec70"/>Profiles</h2></div></div></div><p>The contact table has<a class="indexterm" id="id444"/> a very limited number of fields and does not allow much creativity for us to <a class="indexterm" id="id445"/>add flexible information. This is where profiles are used.</p><p>Profiles allow the users to create an unlimited number of extra information sources that can be manually or automatically populated.</p><p>Let's have a look at an example profile:</p><div><img alt="Profiles" src="img/0365EN_04_11.jpg"/></div><p>This profile is for contacts of type <strong>Company</strong>. It has <strong>Question</strong> and <strong>Answer</strong> lines. A question can have one or multiple answers and we can define as many questions and answers as we want. The last column shows how many contacts have this profile answer.</p><p>A profile is used from the <strong>Contact Card</strong>.</p><div><img alt="Profiles" src="img/0365EN_04_12.jpg"/></div><p>When we click on this, a<a class="indexterm" id="id446"/> new page opens where we can select the required profile and <a class="indexterm" id="id447"/>answer the questions.</p><div><img alt="Profiles" src="img/0365EN_04_13.jpg"/></div><p>The answers are displayed in the <strong>Lines</strong> subpage of the <strong>Contact Card</strong> window.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec30"/>Automatic profiles</h3></div></div></div><p>Profiles can also be <a class="indexterm" id="id448"/>automatically<a class="indexterm" id="id449"/> answered based on formulas. This is done using the <strong>Auto Contact Classification</strong> option and setting up the <strong>Question Details</strong>.</p><div><img alt="Automatic profiles" src="img/0365EN_04_14.jpg"/></div><p>The <strong>Profile Question Details</strong> are fixed and hardcoded. They depend on the relationship between a contact and a customer or vendor as discussed earlier in this chapter.</p><div><img alt="Automatic profiles" src="img/0365EN_04_15.jpg"/></div><p>We will not <a class="indexterm" id="id450"/>describe all the possibilities as this is very well covered in the <a class="indexterm" id="id451"/>online help.</p><p>When the questions are set up, the answers should have a <strong>From Value</strong> and <strong>To Value</strong> to allow the system to pick the right one.</p><p>To generate the answers, a batch job is used called <strong>Update Contact Classification</strong> where we can filter on a profile.</p><div><img alt="Automatic profiles" src="img/0365EN_04_16.jpg"/></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec71"/>Interactions</h2></div></div></div><p>We have all kinds of <a class="indexterm" id="id452"/>interaction<a class="indexterm" id="id453"/> moments with our contacts. Whether they are phone calls, mailings, or sending an invoice, we can register them in Microsoft Dynamics NAV.</p><p>As with profiles, there are interactions that are generated automatically and manually. Manual interactions are created using a wizard.</p><p>All interactions relate to an <strong>Interaction Template Code</strong>. The system allows an unlimited amount of code we can define ourselves. The interaction code will also determine how the rest of wizard will behave.</p><div><img alt="Interactions" src="img/0365EN_04_17.jpg"/></div><p>Interactions can be <a class="indexterm" id="id454"/>
<strong>Inbound</strong> or <strong>Outbound</strong> and initiated by us or them. These are<a class="indexterm" id="id455"/> informative fields.</p><p>The <strong>Wizard Action</strong> field determines whether the wizard will generate a mail merge document, allow us to attach a previously created document, or do nothing. Mail merge allows us to create a Word document with all fields from the contact table.</p><p>Let's create an interaction and look at how that is done. To create an interaction, we choose <strong>Create Interaction</strong> on the contact card or list and click on the <strong>Create Interaction</strong> button from the <strong>Process Actions</strong>. This will open the following wizard:</p><div><img alt="Interactions" src="img/0365EN_04_18.jpg"/></div><p>The first page asks us what type of interaction we would like to start. Let's make a memo:</p><div><img alt="Interactions" src="img/0365EN_04_19.jpg"/></div><p>This is the next step<a class="indexterm" id="id456"/> as our interaction code defines that we will generate a mail<a class="indexterm" id="id457"/> merge:</p><div><img alt="Interactions" src="img/0365EN_04_20.jpg"/></div><p>We can now create the memo in Microsoft Word with all necessary fields already filled in.</p><div><img alt="Interactions" src="img/0365EN_04_21.jpg"/></div><p>After closing<a class="indexterm" id="id458"/> Microsoft Word, we move on to the next step and when we <a class="indexterm" id="id459"/>populate all fields, we can finish the wizard. This will save the interaction in the database and print the memo since we choose <strong>Hard Copy</strong> as <strong>Correspondence Type</strong>.</p><div><div><h3 class="title"><a id="note10"/>Note</h3><p>It is also possible to postpone interactions and restart them later.</p></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec31"/>Automatic interactions</h3></div></div></div><p>Some interactions <a class="indexterm" id="id460"/>can also be <a class="indexterm" id="id461"/>automatically generated, for example, each time we print an invoice or shipment.</p><p>Which interaction code is used for each transaction is defined in the <strong>Interaction Template Setup</strong>. For every print, we want an interaction log entry to be generated and we need to set up a code.</p><div><img alt="Automatic interactions" src="img/0365EN_04_22.jpg"/></div><div><div><h3 class="title"><a id="tip25"/>Tip</h3><p>Be careful when printing a lot of documents, as the interaction log entry table can be locked for a longer period forcing other users in the database to wait until the process is completed. To avoid this, enable <a class="indexterm" id="id462"/>auto-increment on this table as described in this blog at <a class="ulink" href="http://markbrummel.wordpress.com/2014/05/25/tip-14-autoincrement-interaction-log-entries/">http://markbrummel.wordpress.com/2014/05/25/tip-14-autoincrement-interaction-log-entries/</a>.</p></div></div><p>Other <a class="indexterm" id="id463"/>automatically created interaction log entries are created by <a class="indexterm" id="id464"/>segments, which we will look at later in the chapter.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec32"/>Finished interactions</h3></div></div></div><p>When completed, the<a class="indexterm" id="id465"/> interactions are <a class="indexterm" id="id466"/>connected to a contact and can be used for analysis purposes. It is also possible to start a To-do from an interaction. We'll look at that in the next paragraph.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec72"/>To-do's</h2></div></div></div><p>The To-do's<a class="indexterm" id="id467"/> are the lowest level of<a class="indexterm" id="id468"/> activities in the relationship management model. They are best compared to Masks or Meetings in Microsoft Outlook.</p><p>To-do's can be created directly in the system or from another event. We can create a To-do from the interaction we just created. Let's do this.</p><div><img alt="To-do's" src="img/0365EN_04_23.jpg"/><div><p>The reference here is the tab, Create To-do, and hence the cut-off text at the side is fine</p></div></div><p>When we click on <strong>Create To-do</strong> form the <strong>Interaction Log Entries</strong>, the system shows us a wizard that will guide us through the process, just like the <strong>Interaction</strong> wizard.</p><div><img alt="To-do's" src="img/0365EN_04_24.jpg"/></div><p>There are <a class="indexterm" id="id469"/>three types <a class="indexterm" id="id470"/>of To-do's, <strong>Standard</strong> (blank), <strong>Meeting</strong>, and <strong>Phone Call</strong>. The steps in the wizard depend on the type we select. Let's select a <strong>Meeting</strong>.</p><p>The next step asks the attendees for the meeting and allows a template for the invitation, which then again will create an Interaction Log Entry.</p><div><img alt="To-do's" src="img/0365EN_04_25.jpg"/></div><div><div><h3 class="title"><a id="note11"/>Note</h3><p>To perform this step, the To-do organizer should have a valid e-mail address. This can be set up in the sales persons.</p></div></div><p>The next <a class="indexterm" id="id471"/>step only asks<a class="indexterm" id="id472"/> for a location so we will click on <strong>Finish</strong>.</p><p>When we now open the To-do's from the <strong>Sales &amp; Marketing Department</strong>, we can open the <strong>Sales Person</strong> per day matrix, which shows us the meeting we just created.</p><div><img alt="To-do's" src="img/0365EN_04_26.jpg"/><div><p>The cut-off text is not a part of the referenced section in the screenshot</p></div></div><p>We'll see more of <a class="indexterm" id="id473"/>To-do's when we <a class="indexterm" id="id474"/>discuss <strong>Opportunities</strong> and <strong>Outlook Integration</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec73"/>Opportunities</h2></div></div></div><p>When we discussed profiles, we could already see that relationship management is tightly integrated with the ERP part of the application. This is also the case for opportunities.</p><p>Opportunities<a class="indexterm" id="id475"/> allow us to <a class="indexterm" id="id476"/>manage all the quote requests we get from our prospects, creating a workflow that will guide us to a deal that is won or lost. This then allows us to analyze the win and lose deals and change our business based on this information.</p><p>We can analyze the sales pipeline and make a proper judgement of our future order position allowing us to schedule capacity in time.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec33"/>Workflow</h3></div></div></div><p>Each opportunity we <a class="indexterm" id="id477"/>create will follow a sales cycle in the system. This will guide us step by step though the process.</p><p>Let's have a look at the sales cycles in the CRONUS database.</p><p>There are four sales cycles defined. The most important field is the <strong>Probability Calculation</strong> formula. This will determine how the system calculates the current value of all opportunities with this code. We can see the <strong>Calculated Current Value</strong> by opening the <strong>Statistics</strong> window of a sales cycle, as shown in the following screenshot:</p><div><img alt="Workflow" src="img/0365EN_04_27.jpg"/></div><p>There are four options to <a class="indexterm" id="id478"/>choose from: <code class="literal">Multiply</code>, <code class="literal">Add</code>, <code class="literal">Chances of Success %</code>, and <code class="literal">Completed %</code>. The function <code class="literal">UpdateEstimates</code> in the <code class="literal">Opportunity Entry (5093)</code> table calculates this:</p><div><pre class="programlisting">
<strong>UpdateEstimates()</strong>
IF SalesCycleStage.GET("Sales Cycle Code","Sales Cycle Stage") 
THEN BEGIN
  SalesCycle.GET("Sales Cycle Code");
  CASE SalesCycle."Probability Calculation" OF
    SalesCycle."Probability Calculation"::Multiply:
      BEGIN
        "Probability %" := "Chances of Success %" * 
                      SalesCycleStage."Completed %" / 100;
      END;
    SalesCycle."Probability Calculation"::Add:
      BEGIN
        "Probability %" := ("Chances of Success %" + 
                      SalesCycleStage."Completed %") / 2;
      END;
    SalesCycle."Probability Calculation"::"Chances of Success %":
      BEGIN
        "Probability %" := "Chances of Success %";
      END;
    SalesCycle."Probability Calculation"::"Completed %":
      BEGIN
        "Probability %" := SalesCycleStage."Completed %";
      END;
  END;
  "Completed %" := SalesCycleStage."Completed %";
  "Calcd. Current Value (LCY)" := "Estimated Value (LCY)" * 
                           "Probability %" / 100;
END;</pre></div><p>The <code class="literal">Probability Calculation</code> first calculates a <code class="literal">Probability % </code>field, which will then lead to the <a class="indexterm" id="id479"/>required <code class="literal">Calculated Current Value</code>.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec34"/>Sales stages</h3></div></div></div><p>Each sales cycle has different stages that will<a class="indexterm" id="id480"/> guide us through the <a class="indexterm" id="id481"/>sales process.</p><div><img alt="Sales stages" src="img/0365EN_04_28.jpg"/></div><p>The current sales stage of an opportunity defines the <code class="literal">Completed %</code> field. We can decide with <strong>Allow Skip</strong>  option whether a sales stage is mandatory. The quote required will force us to assign a sales quote to this opportunity as we will see later when we create an opportunity.</p><div><div><div><div><h4 class="title"><a id="ch04lvl4sec02"/>Activity codes</h4></div></div></div><p>Each sales stage has an <a class="indexterm" id="id482"/>activity code. This will define which To-do's are created to support us in the sales process.</p><div><img alt="Activity codes" src="img/0365EN_04_29.jpg"/></div><p>This is a very powerful<a class="indexterm" id="id483"/> tool, enabling sales people to create a workflow for each sales process.</p><p>Let's create an opportunity and see what happens in the system.</p></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec35"/>Creating an opportunity</h3></div></div></div><p>An opportunity starts by<a class="indexterm" id="id484"/> selecting an existing contact or creating a new one. From the <strong>Contact Card</strong>, we can navigate to <strong>Related Information</strong> | <strong>Contact</strong> | <strong>Opportunities</strong> | <strong>List</strong>.</p><p>This leads us to a filtered lists of opportunities linked to this contact.</p><div><ol class="orderedlist arabic"><li class="listitem">Here we can select <strong>Create Opportunity</strong>.<div><img alt="Creating an opportunity" src="img/0365EN_04_30.jpg"/></div></li><li class="listitem">This opens the wizard that will guide us though the process. In the first window, we enter the description <code class="literal">Sell Chairs</code> and click on <strong>Next</strong> to take us to the second step.<div><img alt="Creating an opportunity" src="img/0365EN_04_31.jpg"/></div></li><li class="listitem">In this step, we<a class="indexterm" id="id485"/> choose <strong>Sales Cycle</strong> code <strong>FIRSTSMALL</strong> and select <strong>Finish</strong>.</li><li class="listitem">Selecting <strong>Next</strong> will allow us to enter additional information, such as assigning a sales campaign, and activating the first stage. We will skip that now and discuss campaigns later in this chapter.<p>When we now open the created opportunity, the information should look like the following screenshot. There are no activity lines as we have not yet activated the first stage.</p><div><img alt="Creating an opportunity" src="img/0365EN_04_32.jpg"/><div><p>The cut-off text is not a part of the reference in this screenshot</p></div></div></li><li class="listitem">Let's activate the<a class="indexterm" id="id486"/> first stage and see what happens. We do that by navigating to <strong>Actions</strong> | <strong>Functions</strong> | <strong>Update</strong>. We enter a wizard where we select <strong>First</strong>.<div><img alt="Creating an opportunity" src="img/0365EN_04_33.jpg"/></div></li><li class="listitem">We'll click on <strong>Next</strong> twice and enter step three of the wizard.</li><li class="listitem">In this step, we should enter the estimated sales value and <strong>chance of success (%)</strong> of getting this deal. This is important to calculate the <strong>calculated estimated value</strong> we discussed earlier.<div><img alt="Creating an opportunity" src="img/0365EN_04_34.jpg"/></div></li><li class="listitem">When we click on <a class="indexterm" id="id487"/><strong>Finish</strong>, we come back to the <strong>Opportunity</strong> page and see that the current value is <strong>260,00</strong>.<div><img alt="Creating an opportunity" src="img/0365EN_04_35.jpg"/><div><p>The cut-off text is not a part of the reference in this screenshot</p></div></div><p>Since the probability calculation of this sales cycle is <strong>Add</strong>, the formula is:</p><div><pre class="programlisting">"Probability %" := ("Chances of Success %" +  
  SalesCycleStage."Completed %") / 2;

"Calcd. Current Value (LCY)" := "Estimated Value (LCY)" * 
  "Probability %" / 100;</pre></div><p>This will lead to <code class="literal">(50 + 2) / 2 = 26 and 1000 * 26 / 100 = 260</code>.</p></li><li class="listitem">Now we <a class="indexterm" id="id488"/>navigate to <strong>Related Information</strong> | <strong>Opportunity</strong> | <strong>To-Dos</strong> and see that the system has created two To-do's for us that we have to complete.<div><img alt="Creating an opportunity" src="img/0365EN_04_36.jpg"/><div><p>The cut-off text is not a part of the reference in this screenshot</p></div></div></li><li class="listitem">This will help us remember our daily tasks and allow management to see nothing is forgotten. The next stages in this sales cycle are <strong>Qualification</strong> and <strong>Presentation</strong>.<div><img alt="Creating an opportunity" src="img/0365EN_04_37.jpg"/></div></li><li class="listitem">We can enter these stages by entering the wizard again and selecting <strong>Next</strong>.<div><img alt="Creating an opportunity" src="img/0365EN_04_38.jpg"/></div></li><li class="listitem">After <a class="indexterm" id="id489"/>selecting the <strong>Next</strong> button twice, we hit step three. Since one of our To-do's was verifying the quality of the opportunity, we can now say for example that the chance of success is 80 percent.<div><img alt="Creating an opportunity" src="img/0365EN_04_39.jpg"/></div></li><li class="listitem">We'll select the <strong>Cancel existing open to-dos</strong> Checkbox to make sure our workflow is updated. You will see that the <strong>Calculated Current Value</strong> has increased to <strong>425,00</strong>:<div><img alt="Creating an opportunity" src="img/0365EN_04_40.jpg"/></div></li><li class="listitem">When we <a class="indexterm" id="id490"/>enter the next stage, we will get the following error message telling us that assigning a quote is mandatory to enter the next step:<div><img alt="Creating an opportunity" src="img/0365EN_04_41.jpg"/></div></li></ol></div><div><div><div><div><h4 class="title"><a id="ch04lvl4sec03"/>Sales quote</h4></div></div></div><p>To assign a sales quote to an opportunity, we <a class="indexterm" id="id491"/>navigate to <strong>Actions</strong> | <strong>Functions</strong> | <strong>Assign Sales Quote</strong> from the <strong>Opportunity Card</strong>. This will<a class="indexterm" id="id492"/> open a new sales quote with all fields populated from the opportunity.</p><div><img alt="Sales quote" src="img/0365EN_04_42.jpg"/></div><div><div><h3 class="title"><a id="note12"/>Note</h3><p>To assign a quote to a contact without a <strong>Sell-to Customer No.</strong>, we need to use the <strong>Sell-to Customer Template Code</strong>. This can be used when the <strong>Show more fields</strong> option is activated on the <strong>General</strong> fast tab.</p></div></div><p>We will select<a class="indexterm" id="id493"/> two furniture items and populate the <a class="indexterm" id="id494"/>
<strong>Quantity</strong> and <strong>Line Discount %</strong> fields.</p><p>When we now update the opportunity, we can use the quote amount of 796,80 which will lead to a <strong>Calculated Current Value</strong> of 478,08 in step three and 557,76 in step four.</p><div><div><h3 class="title"><a id="note13"/>Note</h3><p>To update the opportunity to step 4, the sales person should have a valid e-mail address, which can be set up in the sales persons.</p></div></div></div><div><div><div><div><h4 class="title"><a id="ch04lvl4sec04"/>Closing the deal</h4></div></div></div><p>Step five is the final step <a class="indexterm" id="id495"/>in the sales cycle stages we used in our example. Now we need to tell the system whether the deal is won or lost. To do this, we navigate to <strong>Actions</strong> | <strong>Functions</strong> | <strong>Close</strong> from the <strong>Opportunity Card</strong>. We will select <strong>Won</strong> and click on <strong>Next</strong>.</p><div><img alt="Closing the deal" src="img/0365EN_04_43.jpg"/></div><p>After selecting a valid reason <a class="indexterm" id="id496"/>and the sales amount, we can close the deal.</p><div><img alt="Closing the deal" src="img/0365EN_04_44.jpg"/></div><p>The system now creates a customer for this contact and updates the quote with this number. We need to promote<a class="indexterm" id="id497"/> the quote to an order manually.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec74"/>Creating segments</h2></div></div></div><p>Segments allow us<a class="indexterm" id="id498"/> to slice and<a class="indexterm" id="id499"/> dice the data in our system to create a filtered list of contacts. This information can then be used to create an interaction such as a mailing or start a sales campaign.</p><p>Since Microsoft Dynamics NAV relationship management is integrated with the ERP system, we can filter on both RM and ERP data.</p><p>Let's create a new segment and look at the possibilities:</p><div><img alt="Creating segments" src="img/0365EN_04_45.jpg"/></div><p>The segment has a <strong>No.</strong> and <strong>Description field</strong>. The no. can be defined using the Number Series.</p><p>On the <strong>Interaction</strong> tab, we select <strong>Interaction Template Code</strong>. We will select an interaction that generates a Word document so we can use the mail merge capabilities of segments.</p><p>The <strong>Unit Cost (LCY)</strong> is important to determine the total cost of this segment especially when we use it with campaigns, as we will see later in the chapter.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec36"/>Adding contacts</h3></div></div></div><p>With our segment<a class="indexterm" id="id500"/> defined, we can now start filtering the system for contact information by navigating to <strong>Actions</strong> | <strong>Functions</strong> | <strong>Contacts</strong> | <strong>Add Contacts</strong>.</p><div><img alt="Adding contacts" src="img/0365EN_04_46.jpg"/></div><p>This opens a selection window, allowing us to filter on different parts of the application:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Options</strong>: This is further divided into four categories:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Allow Existing Contacts</strong>: If you run multiple selections and check this option, the system will create new segment lines each time a contact is within the selection.</li><li class="listitem" style="list-style-type: disc"><strong>Expand Companies</strong>: When you select this option, the system will add the persons related to the companies in the selection.</li><li class="listitem" style="list-style-type: disc"><strong>Allow Related Companies</strong>: When <strong>Expand Companies</strong> is selected, this option will delete the company record if a company has one or more persons in the filter.</li><li class="listitem" style="list-style-type: disc"><strong>Ignore Exclusion</strong>: A contact can be ignored on segments. Checking this flag will ignore this field.</li></ul></div></li><li class="listitem" style="list-style-type: disc"><strong>Contact</strong>: Here we<a class="indexterm" id="id501"/> can filter directly on all fields in the contact table. For example, all contacts in the country NL.</li><li class="listitem" style="list-style-type: disc"><strong>Profile</strong>: This allows us to filter on any profile answer. When we use automatic profile answers, we can for example filter on customers with a specific turnover or profit value.</li><li class="listitem" style="list-style-type: disc"><strong>Mailing Group</strong>: We can save any segment to a mailing group allowing easy reuse of previously generated filters.</li><li class="listitem" style="list-style-type: disc"><strong>Interaction Log Entry</strong>: We can filter on contacts who have had specific interaction codes. For example, everyone who had a sales invoice in the last year.</li><li class="listitem" style="list-style-type: disc"><strong>Job Responsibility</strong>: If we want to send out a mail to all managers, we select the matching job responsibility code.</li><li class="listitem" style="list-style-type: disc"><strong>Industry Group</strong>: This allows us to filter out companies in specific industries.</li><li class="listitem" style="list-style-type: disc"><strong>Business Relation</strong>: This is by default used to integrate with customers, vendors, and bank accounts but can also be expanded with extra information.</li><li class="listitem" style="list-style-type: disc"><strong>Value Entry</strong>: This is probably the most powerful filter where we can filter on specific item numbers and posting dates from the related contact.</li></ul></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec37"/>Refine/reduce contacts</h3></div></div></div><p>After adding all contacts<a class="indexterm" id="id502"/> from The Netherlands, we might want to refine or <a class="indexterm" id="id503"/>reduce this, which can be done with the same filtering as adding contacts. Refining will check whether the contacts in the segments match the specific filter criteria and reducing will remove all contacts in the segment that match the criteria.</p><p>We will reduce the segment with City Waalwijk.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec38"/>Segment criteria</h3></div></div></div><p>We can now ask the <a class="indexterm" id="id504"/>system what criteria we used by navigating to <strong>Related Information</strong> | <strong>Segments</strong> | <strong>Criteria</strong>.</p><div><img alt="Segment criteria" src="img/0365EN_04_47.jpg"/></div><p>This allows us to<a class="indexterm" id="id505"/> see what we did, but also to undo the last actions or save the criteria.</p><div><img alt="Segment criteria" src="img/0365EN_04_48.jpg"/></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec39"/>Mailing groups</h3></div></div></div><p>Another option to reuse a <a class="indexterm" id="id506"/>segment is to apply a mailing group to all<a class="indexterm" id="id507"/> contacts in a segment. To start this, we click on <a class="indexterm" id="id508"/>
<strong>Apply Mailing Group</strong> in the <strong>ACTIONS</strong> tab from the <strong>Segment Card</strong>.</p><div><img alt="Mailing groups" src="img/0365EN_04_49.jpg"/></div><p>This will create a record in the Contact Mailing Group table for each contact in the segment.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec40"/>Log segment</h3></div></div></div><p>When the segment is finished, it<a class="indexterm" id="id509"/> should be logged. Logging the segment will start the mail merge process in our segment and create the.</p><div><img alt="Log segment" src="img/0365EN_04_50.jpg"/></div><div><div><h3 class="title"><a id="note14"/>Note</h3><p>Using this option will also print the letters in this example. For an exercise it might be useful to enable a PDF printer or turn of your printer and remove the print job.</p></div></div><p>If required, the system can directly <a class="indexterm" id="id510"/>generate a follow up segment if we wanted to use this segment with a campaign.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec75"/>Campaigns</h2></div></div></div><p>Most big companies with <a class="indexterm" id="id511"/>marketing departments have sales campaigns to improve their sales. These <a class="indexterm" id="id512"/>are typically periods where some items are more interesting for customers to buy.</p><p>With the campaigns in Microsoft Dynamics NAV, we can manage the sales prices and see the results of a specific campaign both from a cost and profit viewpoint.</p><p>Let's open a campaign and see what information it contains:</p><div><img alt="Campaigns" src="img/0365EN_04_51.jpg"/></div><p>Each campaign has a unique <strong>No.</strong> field that can be created using Number Series and <strong>Description</strong>. The <strong>No.</strong> field should be carefully chosen since it will be used throughout the application where this campaign is used.</p><p>The <strong>Status Code</strong> options can be custom defined but do not impact business logic. The <strong>Starting Date</strong> and <strong>Ending Date</strong> fields are important for the pricing information. The special price and discounts will only be valid within these periods.</p><p>Via the <strong>Invoicing</strong> tab, we can see that campaigns are integrated with dimensions. This gives us the powerful option to define a dimension code for each campaign and create an analysis view to analyze the results in the financial part of Microsoft Dynamics NAV, like we discussed in the <a class="indexterm" id="id513"/>previous chapter.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec41"/>Pricing</h3></div></div></div><p>Microsoft Dynamics NAV<a class="indexterm" id="id514"/> allows special item pricing for campaigns. If a sales order is generated from a campaign, the system will use the special price automatically.</p><p>By navigating to <strong>Related Information</strong> | <strong>Campaign</strong> | <strong>Sales Prices</strong>, we can enter the pricing information for this campaign.</p><div><img alt="Pricing" src="img/0365EN_04_52.jpg"/></div><p>This price table is filtered exactly the same way as discussed in our example application in <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <em>A Sample Application</em>.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec42"/>Segments</h3></div></div></div><p>To select customers or<a class="indexterm" id="id515"/> prospects for a campaign, we need to create one or more segments. These segments should be connected to the campaign using the <strong>Campaign No.</strong> field. Everyone related to these segments will get the specific prices and discounts.</p><p>The segments are also used to create the interaction log entries and To-do's for this campaign. We need to make our target group aware that this campaign exists by sending them a letter, fax, e-mail, or even a phone call.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec43"/>Activate</h3></div></div></div><p>By activating<a class="indexterm" id="id516"/> the campaign, the system will add all contacts to the campaign group and create interaction log entries.</p><p>The interaction log entries will be used to calculate the cost of a campaign. Each interaction has a specific cost and all costs add up to the total amount on the campaign.</p><p>When an opportunity comes in, we can point this to a specific campaign. The value of this opportunity is also used in estimating the success of the campaign.</p><p>The campaign is also copied into the sales documents using the dimensions attached to the campaign. This allows us to further analyze the results.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec76"/>Outlook integration</h2></div></div></div><p>Salespeople are often on the<a class="indexterm" id="id517"/> road without <a class="indexterm" id="id518"/>online access to the ERP system, and Microsoft Dynamics NAV does not have an offline mode. To solve this problem, Microsoft Dynamics NAV is integrated with Microsoft Outlook. This allows salespeople to view contacts and tasks offline and replicate with the back office system when possible.</p><p>If salespeople use a Windows Mobile phone with Microsoft Outlook, they can even have all their Microsoft Dynamics NAV information on their device.</p><p>Using user-defined views will also enable us to synchronize other Microsoft Dynamics NAV data to Microsoft Outlook, for example, the customer table with the current value of the <strong>Balance</strong> field or the item table with the current inventory.</p><p>We will discuss the possibilities of interfacing with Microsoft Outlook in <a class="link" href="ch09.html" title="Chapter 9. Interfacing">Chapter 9</a>, <em>Interfacing</em>.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec44"/>E-mail logging</h3></div></div></div><p>Microsoft Dynamics <a class="indexterm" id="id519"/>NAV also has a capability to read exchange shared folders such as <code class="literal">info@ mailboxes</code>. For each e-mail, the system can generate Interaction Log Entries and To-do's.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec77"/>The setup</h2></div></div></div><p>Before implementing <a class="indexterm" id="id520"/>relationship management, we should properly set up the options. This can be done in the <strong>Marketing Setup</strong>.</p><div><img alt="The setup" src="img/0365EN_04_53.jpg"/></div><p>Let's take a look at all the fields:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Attachment Storage Type</strong>: The<a class="indexterm" id="id521"/> attachments in the interaction log entries can either be stored in the database (embedded) or on the filesystem (disk file). It is highly recommended to store them on the filesystem.</li><li class="listitem" style="list-style-type: disc"><strong>Attachment Storage Location</strong>: If we chose <a class="indexterm" id="id522"/>to store the attachments on file system, this is where we specify the path.</li><li class="listitem" style="list-style-type: disc"><strong>Index Mode</strong>: When using a <a class="indexterm" id="id523"/>contact search, this should be set to <strong>Auto</strong>. It might have a small drawback on performance and cause the database to become bigger.</li><li class="listitem" style="list-style-type: disc"><strong>Inheritance</strong>: When <a class="indexterm" id="id524"/>entering a person's profile, it can inherit the salesperson code, territory code, country/region code, language code, address details, and communication details from the company it belongs to.</li><li class="listitem" style="list-style-type: disc"><strong>Defaults</strong>: A new contact <a class="indexterm" id="id525"/>can get a default salesperson code, territory code, country/region code, language code, or correspondence type. There is a different default salutation code for companies and persons.</li><li class="listitem" style="list-style-type: disc"><strong>Default Sales Cycle Code</strong>: Every new <a class="indexterm" id="id526"/>opportunity will automatically get this code.</li><li class="listitem" style="list-style-type: disc"><strong>Mergefield Language ID</strong><a class="indexterm" id="id527"/>: This defines if the Word merge fields are in the local language or in English.</li><li class="listitem" style="list-style-type: disc"><strong>Synchronization</strong>: Here, we <a class="indexterm" id="id528"/>enter the default business relation code for customers, vendors, and bank accounts.</li><li class="listitem" style="list-style-type: disc"><strong>Maintain Dupl. Search strings</strong>: Check this <a class="indexterm" id="id529"/>field if duplicate contact functions are used.</li><li class="listitem" style="list-style-type: disc"><strong>Autosearch for Duplicates</strong>: Use this option<a class="indexterm" id="id530"/> if the system should automatically search when entering new contacts.</li><li class="listitem" style="list-style-type: disc"><strong>Search Hit %</strong>: This determines<a class="indexterm" id="id531"/> the percentage of matching lines from the duplicate search string setup should have to qualify as a duplicate contact.</li></ul></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec37"/>Customizing relationship management</h1></div></div></div><p>RM is a complete <a class="indexterm" id="id532"/>module that is not often highly customized or verticalized. However, we will describe some possible changes and how to integrate an add-on, in our case the squash application with relationship management.</p><p>All examples in this chapter are part of the objects downloaded for <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <em>A Sample Application</em>.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec78"/>Salutation formula types</h2></div></div></div><p>By default, the system<a class="indexterm" id="id533"/> has two<a class="indexterm" id="id534"/> salutation formula types, formal and informal, allowing us to print Dear Mrs. Brown, or Dear Angela, but what if we want to print Attn. Mrs. Brown?</p><p>For this, we need to first add an option to the <strong>Salutation Type</strong> field in the <strong>Salutation Formula</strong> table.</p><div><img alt="Salutation formula types" src="img/0365EN_04_54.jpg"/></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec45"/>Support the formula</h3></div></div></div><p>Next, we want to use the<a class="indexterm" id="id535"/> formula when printing a Contact Cover Sheet. This uses the <strong>Format Address</strong> functionality from codeunit 365.</p><p>This codeunit is the single point in Dynamics NAV where all the address formatting is done.</p><p>The formatting of contact persons is done in the <code class="literal">ContactAddrAlt </code>function. We should make the following change:</p><div><pre class="programlisting">
<strong>ContactAddrAlt()</strong>
...
  ContIdenticalAddress:
    WITH ContAltAddr DO BEGIN
      GET(Cont."Company No.",CompanyAltAddressCode);
      FormatAddr(
        AddrArray,"Company Name","Company Name 2",
        Cont.Name,Address,"Address 2",
        City,"Post Code",County,"Country/Region Code");
    END;
  (Cont.Type=Cont.Type::Person) AND
  (Cont."Company No." &lt;&gt; ''):
    WITH Cont DO
      FormatAddr(
//        AddrArray,ContCompany.Name,ContCompany."Name 2",
//        Name,Address,"Address 2",
        AddrArray,ContCompany.Name,ContCompany."Name 2",
        GetSalutation(5, Cont."Language Code"),Address,
        "Address 2",City,"Post Code",County,
        "Country/Region Code") </pre></div><div><div><h3 class="title"><a id="tip26"/>Tip</h3><p>Always comment <a class="indexterm" id="id536"/>out the original line of code before you make a change. This will enable you to always go back to standard code and help when upgrading this solution to a newer version.</p><p>Most NAV partners and developers have their own way of documenting and commenting. The example in here is the minimum comment requirement. We will discuss versioning objects in <a class="link" href="ch10.html" title="Chapter 10. Application Design">Chapter 10</a>, <em>Application Design</em>.</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec46"/>The GetSalutation function</h3></div></div></div><p>In our modification, we <a class="indexterm" id="id537"/>use the <code class="literal">GetSalutation</code> function<a class="indexterm" id="id538"/> in <code class="literal">Contact table (5050)</code> instead of the <strong>Name</strong> field. Let's have a look at that function and analyze what it does:</p><div><pre class="programlisting">
<strong>GetSalutation()</strong>
IF NOT SalutationFormula.GET("Salutation Code",LanguageCode,
  SalutationType) 
THEN
  ERROR(Text021,LanguageCode,"No.");

SalutationFormula.TESTFIELD(Salutation);

CASE SalutationFormula."Name 1" OF
  SalutationFormula."Name 1"::"Job Title":
    NamePart[1] := "Job Title";
  SalutationFormula."Name 1"::"First Name":
    NamePart[1] := "First Name";
  SalutationFormula."Name 1"::"Middle Name":
    NamePart[1] := "Middle Name";
  SalutationFormula."Name 1"::Surname:
    NamePart[1] := Surname;
  SalutationFormula."Name 1"::Initials:
    NamePart[1] := Initials;
  SalutationFormula."Name 1"::"Company Name":
    NamePart[1] := "Company Name";
END;

CASE SalutationFormula."Name 2" OF
  ...
END;
...
FOR i := 1 TO 5 DO
  IF NamePart[i] = '' THEN BEGIN
    SubStr := '%' + FORMAT(i) + ' ';
    IF STRPOS(SalutationFormula.Salutation,SubStr) &gt; 0 THEN
      SalutationFormula.Salutation :=
        DELSTR(SalutationFormula.Salutation,STRPOS(SalutationFormula.Salutation,SubStr),3);
  END;

EXIT(STRSUBSTNO(SalutationFormula.Salutation,NamePart[1],
  NamePart[2],NamePart[3],NamePart[4],NamePart[5]))</pre></div><p>The function<a class="indexterm" id="id539"/>
<a class="indexterm" id="id540"/> uses two parameters: <code class="literal">SalutationType</code> and <code class="literal">LanguageCode</code>. With these values and the salutation code of the contact, it checks whether there is a valid formula. Since we only added a new option, the code still works because at database level, the <strong>Option</strong> field is translated to an <strong>Integer</strong>.</p><div><div><h3 class="title"><a id="note15"/>Note</h3><p>For documentation purposes, we could also implement the new option value in this function. The downside of this would be that we do a modification that is not technically necessary but needs to be maintained and upgraded.</p></div></div><p>Depending on the order of the formula, the necessary name fields are combined and used as the return value of the function.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec47"/>Setup the salutation formula</h3></div></div></div><p>If we want to use our new <a class="indexterm" id="id541"/>salutation formula, we need to<a class="indexterm" id="id542"/> set it up first. We will do this for F-MAR to test it with CT100191 Megan Sherman from American Wood Exports.</p><div><img alt="Setup the salutation formula" src="img/0365EN_04_55.jpg"/></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec48"/>Test the solution</h3></div></div></div><p>After adding the new formula, we print a<a class="indexterm" id="id543"/> cover sheet from the contact card using the <strong>Contact Cover Sheet</strong> option from the <strong>Report</strong> actions. The result will look like this:</p><div><img alt="Test the solution" src="img/0365EN_04_56.jpg"/></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec79"/>Customer and vendor numbering</h2></div></div></div><p>Another common requirement from end users is to maintain the same number when creating a <a class="indexterm" id="id544"/>customer or<a class="indexterm" id="id545"/> vendor from a contact.</p><p>This can be done by adding one line of code to the <code class="literal">CreateCustomer</code> function in the contact table:</p><div><pre class="programlisting">
<strong>CreateCustomer()</strong>
...

CLEAR(Cust);
Cust.SetInsertFromContact(TRUE);
//* Maintain Contact No. &gt;&gt;&gt;
Cust."No." := "No.";
//* Maintain Contact No. &lt;&lt;&lt;
Cust.INSERT(TRUE);
Cust.SetInsertFromContact(FALSE);</pre></div><p>This works because by populating the <code class="literal">No.</code> field, the Number Series functionality in the <code class="literal">OnInsert</code> trigger does not start:</p><div><pre class="programlisting">
<strong>OnInsert()</strong>
IF "No." = '' THEN BEGIN
  SalesSetup.GET;
  SalesSetup.TESTFIELD("Customer Nos.");
  NoSeriesMgt.InitSeries(SalesSetup."Customer Nos.",
    xRec."No. Series",0D,"No.","No. Series");
END;
...</pre></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec49"/>Disabling the direct creation of customers and vendors</h3></div></div></div><p>When using this option, it should be <a class="indexterm" id="id546"/>disabled to directly create a customer or vendor. This<a class="indexterm" id="id547"/> can be done easily by removing the <code class="literal">No. Series</code> from the <strong>Sales &amp; Receivables Setup</strong> and <strong>Purchases &amp; Payables Setup</strong>. This results in a runtime error message when creating the customer or vendor.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec80"/>Sharing contact information across companies</h2></div></div></div><p>When more companies have their <a class="indexterm" id="id548"/>administration <a class="indexterm" id="id549"/>in Microsoft Dynamics NAV, they most often have the same owner or group of owners that want their contact data to span across their companies.</p><p>This can be achieved by sharing some tables across all companies and changing some business logic.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec50"/>Share tables</h3></div></div></div><p>By default, Microsoft <a class="indexterm" id="id550"/>Dynamics NAV will create a separate instance of each table for each company. This can be changed with the <code class="literal">DataPerCompany</code> property in the table designer.</p><div><img alt="Share tables" src="img/0365EN_04_57.jpg"/></div><p>The following lists should be shared across the database since they contain the main contact information and the link to the customer and vendor data:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">5050 - Contact</li><li class="listitem" style="list-style-type: disc">5051 - Contact Alt. Address</li><li class="listitem" style="list-style-type: disc">5052 - Contact Alt. Addr. Date Range</li><li class="listitem" style="list-style-type: disc">5053 - Business Relation</li><li class="listitem" style="list-style-type: disc">5054 - Contact Business Relation</li></ul></div><p>This will allow us to reuse contact data in all companies. Other tables are optional to share but might be useful.</p><p>By sharing the <a class="indexterm" id="id551"/>
<strong>Contact Profile Answer</strong> table, other companies can see how a customer is doing within the group.</p><p>The segment tables could be shared in order to slice and dice information across the company. This also requires the criteria tables to be shared.</p><div><div><h3 class="title"><a id="tip27"/>Tip</h3><p>When you share the profile or segment tables, the reports that calculate them should be started for each company individually in the database.</p></div></div><p>Campaigns and<a class="indexterm" id="id552"/> opportunities should not be shared since that interfaces with the ERP system. Never share financial tables such as the value entry or document tables.</p><p>Interaction log entries could be shared but we should realize that most table relations to sales and purchase documents will not work when we are in the wrong company.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec51"/>Business relation</h3></div></div></div><p>When sharing the contacts across<a class="indexterm" id="id553"/> the companies, we are interested to see in which company contacts are customer and vendor. We also want to maintain those tables when the contact information changes.</p><p>This means that besides sharing the Contact Business Relation table, we should also add a field indicating the company and add this field to the primary key.</p><div><img alt="Business relation" src="img/0365EN_04_58.jpg"/></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec52"/>C/AL code modifications</h3></div></div></div><p>To make this customization work, we need the <a class="indexterm" id="id554"/>C/AL code to understand what we want to do. It needs to understand that we added the company. Let's go through all the functions we need to change to make this work.</p><p>The functions that create the customer and vendor records we saw in <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <em>A Sample Application</em>, should also be checked, for example, the function <code class="literal">CreateCustomer</code> in the contact table.</p><div><pre class="programlisting">
<strong>CreateCustomer()</strong>
...

ContBusRel.RESET;
ContBusRel.SETRANGE("Contact No.","No.");
ContBusRel.SETRANGE("Link to Table",ContBusRel."Link to Table"::Customer);
//* Company Sharing &gt;&gt;&gt;
ContBusRel.SETRANGE(Company, COMPANYNAME);
//* Company Sharing &lt;&lt;&lt;
IF ContBusRel.FIND('-') THEN
  ERROR(
    Text019,

...</pre></div><p>And a little bit <a class="indexterm" id="id555"/>further up in the C/AL code:</p><div><pre class="programlisting">ContBusRel."Contact No." := ContComp."No.";
ContBusRel."Business Relation Code" := RMSetup."Bus. Rel. Code for Customers";
ContBusRel."Link to Table" := ContBusRel."Link to Table"::Customer;
//* Company Sharing &gt;&gt;&gt;
<strong>ContBusRel.Company := COMPANYNAME;</strong>
//* Company Sharing &lt;&lt;&lt;
ContBusRel."No." := Cust."No.";
ContBusRel.INSERT(TRUE); </pre></div><p>We should also check the code that maintains data integrity, which is the <code class="literal">CustVendBank-Update Codeunit (5055)</code> that we discussed in <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <em>A Sample Application</em>:</p><div><pre class="programlisting">
<strong>UpdateCustomer()</strong>
WITH Cust DO BEGIN
//* Company Sharing &gt;&gt;&gt;
<strong>  CHANGECOMPANY(COMPANYNAME);</strong>
//* Company Sharing &lt;&lt;&lt;
  GET(ContBusRel."No.");
  ...
END; </pre></div><p>Here, we use the <code class="literal">CHANGECOMPANY</code> C/AL command to change the company for a specific instance of a variable.</p><div><div><h3 class="title"><a id="note16"/>Note</h3><p>There are more functions impacted such as the <code class="literal">UpdateQuotes</code> function in the contact table. Analyze your database before implementing this feature.</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec53"/>Number Series</h3></div></div></div><p>The last change we should do for a properly working system is create a new instance of the <a class="indexterm" id="id556"/>Number Series functionality.</p><p>This can be achieved relatively easily since the Number Series are an isolated set of objects.</p><p>In the object designer, we should filter on this set of objects and export them to a <code class="literal">.txt</code> file.</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Table (308): No. Series</li><li class="listitem" style="list-style-type: disc">Table (309): No. Series Line</li><li class="listitem" style="list-style-type: disc">Table (310): No. Series Relationship</li><li class="listitem" style="list-style-type: disc">Report (21): No. Series</li><li class="listitem" style="list-style-type: disc">Report (22): No. Series Check</li><li class="listitem" style="list-style-type: disc">Codeunit (396): NoSeriesManagement</li><li class="listitem" style="list-style-type: disc">Page (456): No. Series</li><li class="listitem" style="list-style-type: disc">Page (457): No. Series Lines</li><li class="listitem" style="list-style-type: disc">Page (458): No. Series Relationships</li></ul></div><p>In this file, we can renumber them and rename them so we get something like this:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Table (123456721): No. Series (Shared)</li><li class="listitem" style="list-style-type: disc">Table (123456722): No. Series Line (Shared)</li><li class="listitem" style="list-style-type: disc">Table (123456723): No. Series Rel. (Shared)</li><li class="listitem" style="list-style-type: disc">Report (123456721): No. Series (Shared)</li><li class="listitem" style="list-style-type: disc">Report (123456722): No. Series Check (Shared)</li><li class="listitem" style="list-style-type: disc">Codeunit (123456721): NoSeriesManagement (Shared)</li><li class="listitem" style="list-style-type: disc">Page (123456721): No. Series (Shared)</li><li class="listitem" style="list-style-type: disc">Page (123456722): No. Series Lines (Shared)</li><li class="listitem" style="list-style-type: disc">Page (123456723): No. Series Rel. (Shared)</li></ul></div><p>Where, the tables should be <code class="literal">DataPerCompany</code> No.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec54"/>Final steps</h3></div></div></div><p>When we have shared <a class="indexterm" id="id557"/>Number Series functionality, we can implement this in the existing objects.</p><div><ol class="orderedlist arabic"><li class="listitem">The <strong>Contact Nos.</strong> field in the marketing setup table should change the table relation to the Shared No. Series table as well as the <strong>No. Series</strong> field in the contact table.</li><li class="listitem">The <code class="literal">NoSeriesMgt</code> variable in the contact table should move from <code class="literal">NoSeriesManagement</code> to <code class="literal">SharedNoSeriesMgt</code>.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec55"/>Alternative approaches</h3></div></div></div><p>Sharing the contact<a class="indexterm" id="id558"/> information across companies is a change that has been implemented by many companies and can be considered safe. Other tables in Microsoft Dynamics NAV are more difficult to share because of financial or operational information.</p><p>A typical example in the standard application is <code class="literal">Item table (27)</code>. This contains a field <code class="literal">Cost is Adjusted (29)</code>, which is used when running cost adjustment. If this table will be shared across all companies, it would create a major issue with running this function. We will discuss cost adjustment in <a class="link" href="ch05.html" title="Chapter 5. Production">Chapter 5</a>, <em>Production</em>.</p><p>For this issue, there are two commonly implemented solutions:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Shared Master Items</strong>: We can <a class="indexterm" id="id559"/>create a new table called master item. This table is shared across all companies and contains the information we share like descriptions and pricing. When the data in this table is changed, it should enable a mechanism comparable to the <code class="literal">CustVendBank-Update Codeunit (5055)</code>, which updates the items in the other companies using the <code class="literal">CHANGECOMPANY</code> C/AL function.</li><li class="listitem" style="list-style-type: disc"><strong>External Synchronization</strong>: We could <a class="indexterm" id="id560"/>implement something that will export the changes done in one company into an XML file. An Application Server can run in the background and read this xml file and implement these changes to other companies in the database or even other databases.</li></ul></div><p>The first solution with master items looks a lot like the way contacts work in the standard application and is a perfect example of look, learn, and love using proven data structures in customized solutions.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec81"/>Adding contacts to segments</h2></div></div></div><p>The last change<a class="indexterm" id="id561"/> we are implementing in<a class="indexterm" id="id562"/> relationship management is adding a table to the <strong>Add Contacts</strong> functionality in segments.</p><p>We have seen that it is already complete but a vertical solution might want to integrate its ledger entry tables here.</p><p>For this example, we will make it possible to filter in the squash ledger entries from the example application in <a class="link" href="ch02.html" title="Chapter 2. A Sample Application">Chapter 2</a>, <em>A Sample Application</em>.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec56"/>Expanding report</h3></div></div></div><p>The first step is to add the<a class="indexterm" id="id563"/> squash ledger entries as <code class="literal">DataItem</code> to the Add Contacts report (5198). We will copy the functionality from the Value Entries as this is comparable functionality.</p><div><div><h3 class="title"><a id="tip28"/>Tip</h3><p>Always find comparable standard application functionality to learn from. Never just copy and paste this but learn how it's done and apply your own knowledge.</p></div></div><div><img alt="Expanding report" src="img/0365EN_04_59.jpg"/></div><p>We cannot copy and paste the table relation from the other contact business relation <code class="literal">DataItem</code> since squash players are contact persons, not companies. Our table relation should be <code class="literal">Contact No.=FIELD(No.)</code>.</p><p>The code in our Contact Business Relation table tells us that we need two new variables or the type Boolean, <code class="literal">SquashFilters</code> and <code class="literal">SkipSquashLedgerEntry</code>:</p><div><pre class="programlisting">
<strong>ContactBusinessRelation2 - OnPreDataItem()</strong>
IF ContactOK AND ((GETFILTERS&lt;&gt;'') OR SquashFilters) THEN
  ContactOK := FALSE
ELSE
  CurrReport.BREAK;

<strong>ContactBusinessRelation2 - OnAfterGetRecord()</strong>
SkipSquashLedgerEntry := FALSE;
IF NOT SquashFilters THEN BEGIN
  ContactOK := TRUE;
  SkipSquashLedgerEntry := TRUE;
  CurrReport.BREAK;
END;</pre></div><p>The <code class="literal">SquashFilters</code> is determined in the <code class="literal">OnPreReport</code> trigger:</p><div><pre class="programlisting">
<strong>Report - OnPreReport()</strong>
ItemFilters := "Value Entry".HASFILTER;

//* Squash &gt;&gt;&gt;
SquashFilters := "Squash Ledger Entry".HASFILTER;
//* Squash &lt;&lt;&lt;
...</pre></div><p>The code in the<a class="indexterm" id="id564"/> Squash Ledger Entry <code class="literal">DataItem</code> should look like this:</p><div><pre class="programlisting">
<strong>Squash Ledger Entry - OnPreDataItem()</strong>
IF SkipSquashLedgerEntry THEN
  CurrReport.BREAK;

CASE ContactBusinessRelation2."Link to Table" OF
  ContactBusinessRelation2."Link to Table"::"Squash Player": 
  BEGIN
    SETRANGE("Squash Player No.",
      ContactBusinessRelation2."No.");
  END;
  ELSE
    CurrReport.BREAK;
END;
<strong>Squash Ledger Entry - OnAfterGetRecord()</strong>
ContactOK := TRUE;

IF ContactOK THEN
  CurrReport.BREAK;</pre></div><p>Make sure we filter on our instance of Contact Business Relation and that we filter on our link to the squash player table.</p><p>The <code class="literal">ContactOK</code> indicates<a class="indexterm" id="id565"/> that all contact persons connected to this squash ledger entry will be inserted.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec57"/>Implementing criteria filters</h3></div></div></div><p>To support the criteria filter <a class="indexterm" id="id566"/>functionality, we need to make two changes, one to the <strong>Add Contacts</strong> report and the other to the <code class="literal">SegCriteriaManagement</code> codeunit.</p><p>In the <strong>Add Contacts</strong> report, we add this C/AL code to the <code class="literal">OnPreReport</code> trigger. This will make a call to the <code class="literal">SegCriteriaManagement Codeunit (5062)</code>:</p><div><pre class="programlisting">
<strong>OnPreReport()</strong>
...
SegCriteriaManagement.InsertCriteriaFilter(
  "Segment Header".GETFILTER("No."),DATABASE::"Value Entry",
  "Value Entry".GETFILTERS,"Value Entry".GETVIEW(FALSE));
//* Squash &gt;&gt;&gt;
SegCriteriaManagement.InsertCriteriaFilter(
  "Segment Header".GETFILTER("No."),
    DATABASE::"Squash Ledger Entry",
    "Squash Ledger Entry".GETFILTERS,
    "Squash Ledger Entry".GETVIEW(FALSE));
//* Squash &lt;&lt;&lt;</pre></div><p>In the <code class="literal">SegCriteriaManagement</code> codeunit, we add this code to the <code class="literal">SegCriteriaFilter</code> function, which will require a new local variable for <code class="literal">Squash Ledger Entry</code>:</p><div><pre class="programlisting">
<strong>SegCriteriaFilter()</strong>
...

CASE TableNo OF
   ...
//* Squash Ledger Entry &gt;&gt;&gt;
  DATABASE::"Squash Ledger Entry":
    BEGIN
      SquashLedgEntry.SETVIEW(View);
      EXIT(SquashLedgEntry.GETFILTERS);
    END;
//* Squash Ledger Entry &lt;&lt;&lt;
END;</pre></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec58"/>Test solution</h3></div></div></div><p>Now, we can test the <a class="indexterm" id="id567"/>solution by trying to add all squash player of type <strong>Member</strong> to a <strong>Segment</strong>:</p><div><img alt="Test solution" src="img/0365EN_04_60.jpg"/></div><p>The result is a segment with the required squash players.</p><div><img alt="Test solution" src="img/0365EN_04_61.jpg"/></div><div><div><h3 class="title"><a id="note17"/>Note</h3><p>This change also needs to be implemented to the reduce/refine functionality, which works similar to the add contacts report.</p></div></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec38"/>Summary</h1></div></div></div><p>In this chapter, we took a deep dive into the Microsoft Dynamics NAV relationship management functionality. We learned how it is integrated with the ERP part of the system. Relationship management can be very useful to analyze sales data. With profiles, we can filter on turnover and profit figures and use them in segments.</p><p>Interaction Log Entries allow us to keep track of all the contact moments with the people we do business with. Outlook integration can be used for salespeople to work remotely and synchronize with the system.</p><p>Campaigns and opportunities help us to keep track of the quote process and make our sales working more efficient.</p><p>Lastly, we looked at some common requirements to change the relationship management system to meet our company's specific requirements.</p><p>In the next chapters, we will look at the ERP part of Microsoft Dynamics NAV starting with the process in <a class="link" href="ch05.html" title="Chapter 5. Production">Chapter 5</a>, <em>Production</em>, and <a class="link" href="ch06.html" title="Chapter 6. Trade">Chapter 6</a>, <em>Trade</em>.</p></div></body></html>