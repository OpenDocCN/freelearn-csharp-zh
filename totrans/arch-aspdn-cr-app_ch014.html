<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="packt" name="generator"/>
<title>13 Understanding the Operation Result Design Pattern</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<link href="../styles/stylesheet2.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body>
<section class="level1 pkt" data-number="14" id="understanding-the-operation-result-design-pattern">
<h1 data-number="14"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">13 Understanding the Operation Result Design Pattern</span></h1>
<section class="level2" data-number="14.1" id="before-you-begin-join-our-book-community-on-discord-12">
<h2 data-number="14.1"><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Before you begin: Join our book community on Discord</span></h2>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">Give your feedback straight to the author himself and chat to other early readers on our Discord server (find the "architecting-aspnet-core-apps-3e" channel under EARLY ACCESS SUBSCRIPTION).</span></p>
<p><a href="https://packt.link/EarlyAccess"><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">https://packt.link/EarlyAccess</span></a></p>
<p><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Qr code Description automatically generated" src="../media/file71.png" style="width:10em"/></span></p>
<p><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">This chapter explores the </span><strong><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">Operation Result</span></strong><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml"> pattern, starting simple and progressing to more complex cases. </span><span class="koboSpan" id="kobo.8.2" xmlns="http://www.w3.org/1999/xhtml">An operation result aims to communicate the success or failure of an operation to its caller. </span><span class="koboSpan" id="kobo.8.3" xmlns="http://www.w3.org/1999/xhtml">It also allows that operation to return both a value and one or more messages to the caller.Imagine any system where you want to display user-friendly error messages, achieve some small speed gain, or even handle failure easily and explicitly. </span><span class="koboSpan" id="kobo.8.4" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">Operation Result</span></strong><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml"> design pattern can help you achieve these goals. </span><span class="koboSpan" id="kobo.10.2" xmlns="http://www.w3.org/1999/xhtml">One way to use it is to handle the result of a remote operation, such as after querying a remote web service.This pattern builds upon foundational object-oriented programming concepts. </span><span class="koboSpan" id="kobo.10.3" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we iterate and design different possibilities incrementally. </span><span class="koboSpan" id="kobo.10.4" xmlns="http://www.w3.org/1999/xhtml">Of course, you should always base your final design on your needs, so learning multiple options will help you make the right choices.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml">The Operation Result pattern is also known as the </span><strong><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">Result Object Pattern</span></strong><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.13.2" xmlns="http://www.w3.org/1999/xhtml">I prefer Operation Result because the name specifies that it represents the result of an operation, while the Result Object has a broader meaning. </span><span class="koboSpan" id="kobo.13.3" xmlns="http://www.w3.org/1999/xhtml">Nonetheless, both are basically the same.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we cover the following topics:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">The Operation Result design pattern basics</span></li>
<li><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml">The Operation Result design pattern returning a value</span></li>
<li><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">The Operation Result design pattern returning error messages</span></li>
<li><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">The Operation Result design pattern returning messages with severity levels</span></li>
<li><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml">Using sub-classes and static factory methods for better isolation of successes and failures</span></li>
</ul>
</section>
<section class="level2" data-number="14.2" id="the-operation-result-pattern">
<h2 data-number="14.2"><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">The Operation Result pattern</span></h2>
<p><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">The Operation Result design pattern can be very simple to more complex. </span><span class="koboSpan" id="kobo.21.2" xmlns="http://www.w3.org/1999/xhtml">In this section, we explore multiple ways to use this pattern. </span><span class="koboSpan" id="kobo.21.3" xmlns="http://www.w3.org/1999/xhtml">We start with its simplest form and build on that until we can return messages and values and add severity levels as the result of an operation.</span></p>
<section class="level3" data-number="14.2.1" id="goal-13">
<h3 data-number="14.2.1"><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">Goal</span></h3>
<p><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">The role of the </span><strong><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">Operation Result</span></strong><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml"> pattern is to give an operation (a method) the possibility to return a complex result (an object), which allows the consumer to:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">[Mandatory] Access the success indicator of the operation (that is, whether the operation succeeded or not).</span></li>
<li><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml">[Optional] Access the operation result if there is one (the method's return value).</span></li>
<li><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">[Optional] Access the cause of the failure if the operation was unsuccessful (error messages).</span></li>
<li><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml">[Optional] Access other information that documents the operation’s result. </span><span class="koboSpan" id="kobo.29.2" xmlns="http://www.w3.org/1999/xhtml">This could be as simple as a list of messages or as complex as multiple properties.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml">This can go even further, such as returning the severity of a failure or adding any other relevant information for the specific use case. </span><span class="koboSpan" id="kobo.30.2" xmlns="http://www.w3.org/1999/xhtml">The success indicator could be binary (</span><code><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml">true</span></code><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">false</span></code><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">), or there could be more than two states, such as success, partial success, and failure.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">Always focus on your needs first, then use your imagination and knowledge to find the best solution. </span><span class="koboSpan" id="kobo.35.2" xmlns="http://www.w3.org/1999/xhtml">Software engineering is not only about applying techniques that others tell you to. </span><span class="koboSpan" id="kobo.35.3" xmlns="http://www.w3.org/1999/xhtml">It’s an art! </span><span class="koboSpan" id="kobo.35.4" xmlns="http://www.w3.org/1999/xhtml">The difference is that you are crafting software instead of painting or woodworking. </span><span class="koboSpan" id="kobo.35.5" xmlns="http://www.w3.org/1999/xhtml">And that most people won’t see any of that art (code) or get it even if they do.</span></p>
</blockquote>
</section>
<section class="level3" data-number="14.2.2" id="design-13">
<h3 data-number="14.2.2"><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">Design</span></h3>
<p><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">It is easy to rely on throwing exceptions when an operation fails. </span><span class="koboSpan" id="kobo.37.2" xmlns="http://www.w3.org/1999/xhtml">However, the Operation Result pattern is an alternative way of communicating success or failure between components when you don’t want to use exceptions. </span><span class="koboSpan" id="kobo.37.3" xmlns="http://www.w3.org/1999/xhtml">One such reason could be that the messages are not errors or that treating an erroneous result is part of the main flow, not part of a side </span><code><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">catch</span></code><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml"> flow.A method must return an object containing one or more elements presented in the </span><em><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">Goal</span></em><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml"> section to be used effectively. </span><span class="koboSpan" id="kobo.41.2" xmlns="http://www.w3.org/1999/xhtml">As a rule of thumb, a method returning an operation result should not throw exceptions. </span><span class="koboSpan" id="kobo.41.3" xmlns="http://www.w3.org/1999/xhtml">This way, consumers don’t have to handle anything other than the operation result itself.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml">You can throw exceptions for special cases, but at this point, it is a judgment call based on clear specifications or facing a real problem. </span><span class="koboSpan" id="kobo.42.2" xmlns="http://www.w3.org/1999/xhtml">For example, a critical event that happens, like the disk is full, would be a valid use case for an exception because it has nothing to do with the main flow, and the code must alert the rest of the program about the system failure.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml">Instead of walking you through all of the possible UML diagrams, let’s jump into the code and explore multiple smaller examples after taking a look at the basic sequence diagram that describes the simplest form of this pattern, applicable to all examples:</span></p>
<figure>
<span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 13.1: Sequence diagram of the Operation Result design pattern" src="../media/file72.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">Figure 13.1: Sequence diagram of the Operation Result design pattern</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml">The preceding diagram shows that an operation returns a result (an object), and then the caller handles that result. </span><span class="koboSpan" id="kobo.46.2" xmlns="http://www.w3.org/1999/xhtml">The following examples cover what we can include in that result object.</span></p>
</section>
<section class="level3" data-number="14.2.3" id="project-implementing-different-operation-result-patterns">
<h3 data-number="14.2.3"><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml">Project – Implementing different Operation Result patterns</span></h3>
<p><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml">In this project, a consumer (REST API) routes the HTTP requests to the correct handler. </span><span class="koboSpan" id="kobo.48.2" xmlns="http://www.w3.org/1999/xhtml">We are visiting each of those handlers one by one to create an incremental learning flow from simple to more complex operation results. </span><span class="koboSpan" id="kobo.48.3" xmlns="http://www.w3.org/1999/xhtml">This project shows you many ways to implement the Operation Result pattern to help you understand it, make it your own, and implement it as required in your projects.Let’s start with the REST API.</span></p>
<section class="level4" data-number="14.2.3.1" id="the-consumer">
<h4 data-number="14.2.3.1"><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">The consumer</span></h4>
<p><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">The consumer of all examples is the </span><code><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml"> file. </span><span class="koboSpan" id="kobo.52.2" xmlns="http://www.w3.org/1999/xhtml">The following code from </span><code><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml"> routes the HTTP requests toward a handler:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet("/simplest-form", ...);
app.MapGet("/single-error", ...);
app.MapGet("/single-error-with-value", ...);
app.MapGet("/multiple-errors-with-value", ...);
app.MapGet("/multiple-errors-with-value-and-severity", ...);
app.MapGet("/static-factory-methods", ...);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml">Next, we cover each use case one by one.</span></p>
</section>
<section class="level4" data-number="14.2.3.2" id="the-simplest-form-of-the-operation-result-pattern">
<h4 data-number="14.2.3.2"><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml">The simplest form of the Operation Result pattern</span></h4>
<p><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">The following diagram represents the simplest form of the Operation Result pattern:</span></p>
<figure>
<span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 13.2: Class diagram of the Operation Result design pattern" src="../media/file73.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml">Figure 13.2: Class diagram of the Operation Result design pattern</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml">We can translate that class diagram into the following blocks of code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/simplest-form",
    (OperationResult.SimplestForm.Executor executor) =&gt;
    {
        var result = executor.Operation();
        if (result.Succeeded)
        {
            // Handle the success
            return "Operation succeeded";
        }
        else
        {
            // Handle the failure
            return "Operation failed";
        }
    }
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code handles the </span><code><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">/simplest-form</span></code><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml"> HTTP requests. </span><span class="koboSpan" id="kobo.65.2" xmlns="http://www.w3.org/1999/xhtml">The highlighted code consumes the following operation:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml">namespace OperationResult.SimplestForm;
public class Executor
{
    public OperationResult Operation()
    {
        // Randomize the success indicator
        // This should be real logic
        var randomNumber = Random.Shared.Next(100);
        var success = randomNumber % 2 == 0;
        // Return the operation result
        return new OperationResult(success);
    }
}
public record class OperationResult(bool Succeeded);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml">Executor</span></code><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml"> class contains the operation to execute represented by the </span><code><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml">Operation</span></code><span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.71.2" xmlns="http://www.w3.org/1999/xhtml">That method returns an instance of the </span><code><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.73.2" xmlns="http://www.w3.org/1999/xhtml">The implementation is based on a random number. </span><span class="koboSpan" id="kobo.73.3" xmlns="http://www.w3.org/1999/xhtml">Sometimes it succeeds, and sometimes it fails. </span><span class="koboSpan" id="kobo.73.4" xmlns="http://www.w3.org/1999/xhtml">You would usually code real application logic in that method instead. </span><span class="koboSpan" id="kobo.73.5" xmlns="http://www.w3.org/1999/xhtml">Moreover, in an actual application, the method should have a proper name representing the operation, like </span><code><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">PayRegistrationFees</span></code><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">CreateConcert</span></code><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml">.The </span><code><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml"> record class represents the result of the operation. </span><span class="koboSpan" id="kobo.79.2" xmlns="http://www.w3.org/1999/xhtml">In this case, a simple read-only Boolean value is stored in the </span><code><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">Succeeded</span></code><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml"> property.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml">I chose a record class because there is no reason for the result to change. </span><span class="koboSpan" id="kobo.82.2" xmlns="http://www.w3.org/1999/xhtml">To know more about record classes, have a look at </span><em><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">Appendix A</span></em><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml">In this form, the difference between the </span><code><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml">Operation</span></code><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml"> method returning a </span><code><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml">bool</span></code><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml"> and an instance of </span><code><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml"> is small, but it exists nonetheless. </span><span class="koboSpan" id="kobo.91.2" xmlns="http://www.w3.org/1999/xhtml">By returning an </span><code><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml"> object, you can extend the return value over time, adding properties and methods to it, which you cannot do with a </span><code><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml">bool</span></code><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml"> without updating all consumers.Next, we add an error message to the result.</span></p>
</section>
<section class="level4" data-number="14.2.3.3" id="a-single-error-message">
<h4 data-number="14.2.3.3"><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml">A single error message</span></h4>
<p><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml">Now that we know whether the operation succeeded or not, we want to know what went wrong. </span><span class="koboSpan" id="kobo.97.2" xmlns="http://www.w3.org/1999/xhtml">To do that, we add an </span><code><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">ErrorMessage</span></code><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml"> property to the </span><code><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml"> record class.With that in place, we no longer need to set whether the operation succeeded or not; we can compute that using the </span><code><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml">ErrorMessage</span></code><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml"> property instead. </span><span class="koboSpan" id="kobo.103.2" xmlns="http://www.w3.org/1999/xhtml">The logic behind this improvement goes as follows:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">When there is no error message, the operation succeeded.</span></li>
<li><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml">When there is an error message, the operation failed.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml"> record class implementing this logic looks like the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml">namespace OperationResult.SingleError
public record class OperationResult
{
    public bool Succeeded =&gt; string.IsNullOrWhiteSpace(ErrorMessage);
    public string? </span><span class="koboSpan" id="kobo.109.2" xmlns="http://www.w3.org/1999/xhtml">ErrorMessage { get; init; }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we have the following:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml">Succeeded</span></code><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml"> property checks for an error message.</span></li>
<li><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml">ErrorMessage</span></code><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml"> property contains an error message settable when instantiating the object.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml">The executor of that operation looks similar but uses the new constructor, setting an error message instead of directly setting the success indicator:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml">namespace OperationResult.SingleError
public class Executor
{
    public OperationResult Operation()
    {
        // Randomize the success indicator
        // This should be real logic
        var randomNumber = Random.Shared.Next(100);
        var success = randomNumber % 2 == 0;
        // Return the operation result
        return success
            ? </span><span class="koboSpan" id="kobo.118.2" xmlns="http://www.w3.org/1999/xhtml">new()
            : new() { ErrorMessage = $"Something went wrong with the number '{randomNumber}'." </span><span class="koboSpan" id="kobo.118.3" xmlns="http://www.w3.org/1999/xhtml">};
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml">The consuming code does the same as in the previous sample but writes the error message in the response output instead of a generic failure string:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/single-error",
    (OperationResult.SingleError.Executor executor) =&gt;
    {
        var result = executor.Operation();
        if (result.Succeeded)
        {
            // Handle the success
            return "Operation succeeded";
        }
        else
        {
            // Handle the failure
            return result.ErrorMessage;
        }
    }
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml">When looking at this example, we can begin to comprehend the Operation Result pattern’s usefulness. </span><span class="koboSpan" id="kobo.121.2" xmlns="http://www.w3.org/1999/xhtml">It furthers us from the simple success indicator that looked like an overcomplicated Boolean.Next, we add the possibility of setting a value when the operation succeeds.</span></p>
</section>
<section class="level4" data-number="14.2.3.4" id="adding-a-return-value">
<h4 data-number="14.2.3.4"><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml">Adding a return value</span></h4>
<p><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have a reason for failure, we may want the operation to return a value. </span><span class="koboSpan" id="kobo.123.2" xmlns="http://www.w3.org/1999/xhtml">To achieve this, let’s build over the previous example and add a </span><code><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml"> property to the </span><code><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml">namespace OperationResult.SingleErrorWithValue;
public record class OperationResult
{
    public bool Succeeded =&gt; string.IsNullOrWhiteSpace(ErrorMessage);
    public string? </span><span class="koboSpan" id="kobo.128.2" xmlns="http://www.w3.org/1999/xhtml">ErrorMessage { get; init; }
    public int? </span><span class="koboSpan" id="kobo.128.3" xmlns="http://www.w3.org/1999/xhtml">Value { get; init; }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml">By adding a second </span><code><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml">init</span></code><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">-only property, we can set the </span><code><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml"> property when the operation succeeds and fails.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml">In a real-world scenario, that </span><code><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml"> property could be </span><code><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml">null</span></code><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml"> in the case of an error, hence the nullable </span><code><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml">int</span></code><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml"> property.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml">The operation is also very similar, but we are setting the </span><code><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml"> property as well as using the object initializer in both cases (highlighted lines):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml">namespace OperationResult.SingleErrorWithValue;
public class Executor
{
    public OperationResult Operation()
    {
        // Randomize the success indicator
        // This should be real logic
        var randomNumber = Random.Shared.Next(100);
        var success = randomNumber % 2 == 0;
        // Return the operation result
        return success
            ? </span><span class="koboSpan" id="kobo.144.2" xmlns="http://www.w3.org/1999/xhtml">new() { Value = randomNumber }
            : new()
            {
                ErrorMessage = $"Something went wrong with the number '{randomNumber}'.",
                Value = randomNumber,
            };
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml">With that in place, the consumer can use the </span><code><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml"> property. </span><span class="koboSpan" id="kobo.147.2" xmlns="http://www.w3.org/1999/xhtml">In our case, the program displays it when the operation succeeds:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/single-error-with-value",
    (OperationResult.SingleErrorWithValue.Executor executor) =&gt;
    {
        var result = executor.Operation();
        if (result.Succeeded)
        {
            // Handle the success
            return $"Operation succeeded with a value of '{result.Value}'.";
        }
        else
        {
            // Handle the failure
            return result.ErrorMessage;
        }
    }
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code displays the </span><code><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml">ErrorMessage</span></code><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml"> property when the operation fails or uses the </span><code><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml"> property when it succeeds. </span><span class="koboSpan" id="kobo.153.2" xmlns="http://www.w3.org/1999/xhtml">With this, the power of the Operation Result pattern continues to emerge.But we are not done yet, so let’s jump into the next evolution.</span></p>
</section>
<section class="level4" data-number="14.2.3.5" id="multiple-error-messages">
<h4 data-number="14.2.3.5"><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml">Multiple error messages</span></h4>
<p><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml">Now we are at the point where we can transfer a </span><code><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml"> and an </span><code><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">ErrorMessage</span></code><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml"> to the operation consumers; what about transferring multiple errors, such as validation errors? </span><span class="koboSpan" id="kobo.159.2" xmlns="http://www.w3.org/1999/xhtml">To achieve this, we can convert our </span><code><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml">ErrorMessage</span></code><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml"> property from a </span><code><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">string</span></code><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml"> to an </span><code><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml">IEnumerable&lt;string&gt;</span></code><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml"> or another type of collection that fits your needs better. </span><span class="koboSpan" id="kobo.165.2" xmlns="http://www.w3.org/1999/xhtml">Here I chose the </span><code><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml">IReadOnlyCollection&lt;string&gt;</span></code><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml"> interface and the </span><code><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml">ImmutableList&lt;string&gt;</span></code><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml"> class so we know that external actors can’t mutate the results:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml">namespace OperationResult.MultipleErrorsWithValue;
public record class OperationResult
{
    public OperationResult()
    {
        Errors = ImmutableList&lt;string&gt;.Empty;
    }
    public OperationResult(params string[] errors)
    {
        Errors = errors.ToImmutableList();
    }
    public bool Succeeded =&gt; !HasErrors();
    public int? </span><span class="koboSpan" id="kobo.170.2" xmlns="http://www.w3.org/1999/xhtml">Value { get; init; }
    public IReadOnlyCollection&lt;string&gt; Errors { get; init; }
    public bool HasErrors()
    {
        return Errors?.Count &gt; 0;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml">Let’s look at the new pieces in the preceding code before continuing:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml">The errors are now stored in </span><code><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml">ImmutableList&lt;string&gt;</span></code><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml"> object and returned as an </span><code><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">IReadOnlyCollection&lt;string&gt;</span></code><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">Succeeded</span></code><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml"> property accounts for a collection instead of a single message and follows the same logic.</span></li>
<li><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml">HasErrors</span></code><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml"> method improves readability.</span></li>
<li><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml">The default constructor represents the successful state.</span></li>
<li><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">The constructor that takes error messages as parameters represents a failed state and populates the </span><code><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml">Errors</span></code><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml"> property.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml">Now that the operation result is updated, the operation itself can stay the same. </span><span class="koboSpan" id="kobo.187.2" xmlns="http://www.w3.org/1999/xhtml">The consumer stays almost the same as well (see the highlight in the code below), but we need to tell ASP.NET how to serialize the result:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/multiple-errors-with-value",
    object (OperationResult.MultipleErrorsWithValue.Executor executor)
    =&gt; {
        var result = executor.Operation();
        if (result.Succeeded)
        {
            // Handle the success
            return $"Operation succeeded with a value of '{result.Value}'.";
        }
        else
        {
            // Handle the failure
            return result.Errors;
        }
    }
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml">We must specify the method returns an object (the highlighted code) so ASP.NET understands that the return value of our delegate can be anything. </span><span class="koboSpan" id="kobo.189.2" xmlns="http://www.w3.org/1999/xhtml">Without this, the return type could not be inferred, and the code would not compile. </span><span class="koboSpan" id="kobo.189.3" xmlns="http://www.w3.org/1999/xhtml">That makes sense since the function is returning a </span><code><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml">string</span></code><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml"> in one path and an </span><code><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml">IReadOnlyCollection&lt;string&gt;</span></code><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml"> in another.During the executing, ASP.NET serializes the </span><code><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml">IReadOnlyCollection&lt;string&gt; Errors</span></code><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml"> property to JSON before outputting it to the client to help visualize the collection.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml">Returning a </span><code><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml">plain/text</span></code><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml"> string when the operation succeeds and an </span><code><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml">application/json</span></code><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml"> array when it fails is not a good practice. </span><span class="koboSpan" id="kobo.200.2" xmlns="http://www.w3.org/1999/xhtml">I suggest avoiding this in real applications. </span><span class="koboSpan" id="kobo.200.3" xmlns="http://www.w3.org/1999/xhtml">Either return JSON or plain text. </span><span class="koboSpan" id="kobo.200.4" xmlns="http://www.w3.org/1999/xhtml">Do not mix content types in a single endpoint unless necessary per specifications. </span><span class="koboSpan" id="kobo.200.5" xmlns="http://www.w3.org/1999/xhtml">Mixing content types only creates avoidable complexity and confusion. </span><span class="koboSpan" id="kobo.200.6" xmlns="http://www.w3.org/1999/xhtml">Moreover, it is way easier for the consumers of the API to always expect the same content type.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml">When designing system contracts, consistency and uniformity are usually better than incoherency, ambiguity, and variance.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml">Our Operation Result pattern implementation is getting better and better but still lacks a few features. </span><span class="koboSpan" id="kobo.202.2" xmlns="http://www.w3.org/1999/xhtml">One of those features is the possibility to propagate messages that are not errors, such as information messages and warnings, which we implement next.</span></p>
</section>
<section class="level4" data-number="14.2.3.6" id="adding-message-severity">
<h4 data-number="14.2.3.6"><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml">Adding message severity</span></h4>
<p><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">Now that our operation result structure is materializing, let’s update our last iteration to support message severity.First, we need a severity indicator. </span><span class="koboSpan" id="kobo.204.2" xmlns="http://www.w3.org/1999/xhtml">An </span><code><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml">enum</span></code><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml"> is a good candidate for this kind of work, but it could also be something else. </span><span class="koboSpan" id="kobo.206.2" xmlns="http://www.w3.org/1999/xhtml">In our case, we leverage an </span><code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml">enum</span></code><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml"> that we name </span><code><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml">OperationResultSeverity</span></code><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml">.Then we need a message class to encapsulate both the message and the severity level; let’s name that class </span><code><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">OperationResultMessage</span></code><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.212.2" xmlns="http://www.w3.org/1999/xhtml">The new code looks like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml">namespace OperationResult.WithSeverity;
public record class OperationResultMessage
{
    public OperationResultMessage(string message, OperationResultSeverity severity)
    {
        Message = message ?? </span><span class="koboSpan" id="kobo.213.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(message));
        Severity = severity;
    }
    public string Message { get; }
    public OperationResultSeverity Severity { get; }
}
public enum OperationResultSeverity
{
    Information = 0,
    Warning = 1,
    Error = 2
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml">As you can see, we have a simple data structure to replace our </span><code><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml">string</span></code><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml"> messages.To ensure the enum gets serialized as string and make the output easier to read and consume, we must register the following converter:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services
    .Configure&lt;JsonOptions&gt;(o
        =&gt; o.SerializerOptions.Converters.Add(
            new JsonStringEnumConverter()))
;</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml">Then we need to update the </span><code><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml"> class to use that new </span><code><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml">OperationResultMessage</span></code><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml"> class instead. </span><span class="koboSpan" id="kobo.222.2" xmlns="http://www.w3.org/1999/xhtml">We then need to ensure that the operation result indicates a success only when there is no </span><code><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml">OperationResultSeverity.Error</span></code><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">, allowing it to transmit the </span><code><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml">OperationResultSeverity.Information</span></code><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml">OperationResultSeverity.Warnings</span></code><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml"> messages:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml">namespace OperationResult.WithSeverity;
public record class OperationResult
{
    public OperationResult()
    {
        Messages = ImmutableList&lt;OperationResultMessage&gt;.Empty;
    }
    public OperationResult(params OperationResultMessage[] messages)
    {
        Messages = messages.ToImmutableList();
    }
    public bool Succeeded =&gt; !HasErrors();
    public int? </span><span class="koboSpan" id="kobo.229.2" xmlns="http://www.w3.org/1999/xhtml">Value { get; init; }
    public ImmutableList&lt;OperationResultMessage&gt; Messages { get; init; }
    public bool HasErrors()
    {
        return FindErrors().Any();
    }
    private IEnumerable&lt;OperationResultMessage&gt; FindErrors()
        =&gt; Messages.Where(x =&gt; x.Severity == OperationResultSeverity.Error);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml">The highlighted lines represent the updated logic that sets the success state of the operation. </span><span class="koboSpan" id="kobo.230.2" xmlns="http://www.w3.org/1999/xhtml">The operation is successful only when no error exists in the </span><code><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">Messages</span></code><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml"> list. </span><span class="koboSpan" id="kobo.232.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml">FindErrors</span></code><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml"> method returns messages with an </span><code><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml">Error</span></code><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml"> severity, while the </span><code><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml">HasErrors</span></code><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml"> method bases its decision on that method’s output.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml">HasErrors</span></code><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml"> method logic can be anything. </span><span class="koboSpan" id="kobo.241.2" xmlns="http://www.w3.org/1999/xhtml">In this case, this works.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml">With that in place, the </span><code><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml">Executor</span></code><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml"> class is also revamped. </span><span class="koboSpan" id="kobo.244.2" xmlns="http://www.w3.org/1999/xhtml">Let’s have a look at those changes:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml">namespace OperationResult.WithSeverity;
public class Executor
{
    public OperationResult Operation()
    {
        // Randomize the success indicator
        // This should be real logic
        var randomNumber = Random.Shared.Next(100);
        var success = randomNumber % 2 == 0;
        // Some information message
        var information = new OperationResultMessage(
            "This should be very informative!",
            OperationResultSeverity.Information
        );
        // Return the operation result
        if (success)
        {
            var warning = new OperationResultMessage(
                "Something went wrong, but we will try again later automatically until it works!",
                OperationResultSeverity.Warning
            );
            return new OperationResult(information, warning) { Value = randomNumber };
        }
        else
        {
            var error = new OperationResultMessage(
                $"Something went wrong with the number '{randomNumber}'.",
                OperationResultSeverity.Error
            );
            return new OperationResult(information, error) { Value = randomNumber };
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we removed the tertiary operator. </span><span class="koboSpan" id="kobo.246.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml">Operation</span></code><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml"> method also uses all severity levels.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml">You should always aim to write code that is easy to read. </span><span class="koboSpan" id="kobo.249.2" xmlns="http://www.w3.org/1999/xhtml">It is OK to use language features, but nesting statements over statements on a single line has limits and can quickly become a mess.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">In that last code block, both successes and failures return two messages:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml">When the operation succeeds, the method returns an information and a warning message.</span></li>
<li><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">When the operation fails, the method returns an information and an error message.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml">From the consumer standpoint, we have a placeholder if-else block and return the operation result directly. </span><span class="koboSpan" id="kobo.253.2" xmlns="http://www.w3.org/1999/xhtml">Of course, we could handle this differently in a real application that needs to know about those messages, but in this case, all we want to see are those results, so this does it:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">app.MapGet("/multiple-errors-with-value-and-severity", (OperationResult.WithSeverity.Executor executor) =&gt;
{
    var result = executor.Operation();
    if (result.Succeeded)
    {
        // Handle the success
    }
    else
    {
        // Handle the failure
    }
    return result;
});</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">As you can see, it is still as easy to use, but now with more flexibility added to it. </span><span class="koboSpan" id="kobo.255.2" xmlns="http://www.w3.org/1999/xhtml">We can do something with the different types of messages, such as displaying them to the user, retrying the operation, and more.For now, when running the application and calling this endpoint, successful calls return a JSON string that looks like the following:</span></p>
<div class="C0-SHConPACKT">
<pre><code><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml">{
    "succeeded": true,
    "value": 56,
    "messages": [
        {
            "message": "This should be very informative!",
            "severity": "Information"
        },
        {
            "message": "Something went wrong, but we will try again later automatically until it works!",
            "severity": "Warning"
        }
    ]
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml">Failures return a JSON string that looks like this:</span></p>
<div class="C0-SHConPACKT">
<pre><code><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml">{
    "succeeded": false,
    "value": 19,
    "messages": [
        {
            "message": "This should be very informative!",
            "severity": "Information"
        },
        {
            "message": "Something went wrong with the number '19'.",
            "severity": "Error"
        }
    ]
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">Another idea to improve this design would be adding a </span><code><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">Status</span></code><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml"> property that returns a complex success result based on each message’s severity level. </span><span class="koboSpan" id="kobo.261.2" xmlns="http://www.w3.org/1999/xhtml">To do that, we could create another </span><code><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">enum</span></code><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml">:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">public enum OperationStatus { Success, Failure, PartialSuccess }</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml">Then we could access that value through a new property named </span><code><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml">Status</span></code><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml">, on the </span><code><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.269.2" xmlns="http://www.w3.org/1999/xhtml">With this, a consumer could handle partial success without digging into the messages. </span><span class="koboSpan" id="kobo.269.3" xmlns="http://www.w3.org/1999/xhtml">I will leave you to play with this one on your own; for example, the </span><code><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml">Status</span></code><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml"> property could replace the </span><code><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml">Succeeded</span></code><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml"> property, or the </span><code><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml">Succeeded</span></code><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml"> property could leverage the </span><code><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml">Status</span></code><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml"> property similarly to what we did with the errors. </span><span class="koboSpan" id="kobo.277.2" xmlns="http://www.w3.org/1999/xhtml">The most important part is to define what would be a success, a partial success, and a failure. </span><span class="koboSpan" id="kobo.277.3" xmlns="http://www.w3.org/1999/xhtml">Think of a database transaction, for example; one failure could lead to the rollback of the transaction, while in another case, one failure could be acceptable.Now that we’ve expanded our simple example into this, what happens if we want the </span><code><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml"> to be optional? </span><span class="koboSpan" id="kobo.279.2" xmlns="http://www.w3.org/1999/xhtml">To do that, we could create multiple operation result classes holding more or less information (properties); let’s try that next.</span></p>
</section>
<section class="level4" data-number="14.2.3.7" id="sub-classes-and-factories">
<h4 data-number="14.2.3.7"><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml">Sub-classes and factories</span></h4>
<p><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml">In this iteration, we keep all the properties but instantiate the </span><code><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml"> objects using static factories. </span><span class="koboSpan" id="kobo.283.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, we hide certain properties in the sub-classes, so each result type only contains the data it needs. </span><span class="koboSpan" id="kobo.283.3" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml"> class itself only exposes the </span><code><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">Succeeded</span></code><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml"> property in this scenario.A </span><strong><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">static factory method</span></strong><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml"> is nothing more than a static method that creates objects. </span><span class="koboSpan" id="kobo.289.2" xmlns="http://www.w3.org/1999/xhtml">It is handy and easy to use but less flexible.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml">I cannot stress this enough: be careful when designing something </span><code><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml">static</span></code><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml">, or it could haunt you later; </span><code><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml">static</span></code><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml"> members are not extensible and can make their consumers harder to test.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">OperationResultMessage</span></code><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml"> class and the </span><code><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml">OperationResultSeverity</span></code> <code><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml">enum</span></code><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml"> remain unchanged. </span><span class="koboSpan" id="kobo.300.2" xmlns="http://www.w3.org/1999/xhtml">In the following code block, we do not consider the severity when computing the operation’s success or failure state. </span><span class="koboSpan" id="kobo.300.3" xmlns="http://www.w3.org/1999/xhtml">Instead, we create an abstract </span><code><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml"> class with two sub-classes:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml">SuccessfulOperationResult</span></code><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml"> class represents successful operations.</span></li>
<li><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml">FailedOperationResult</span></code><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml"> class represents failed operations.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml">Then the next step is to force the use of the specifically designed classes by creating two static factory methods:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">The static </span><code><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml">Success</span></code><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml"> method returns a </span><code><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml">SuccessfulOperationResult</span></code><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml"> object.</span></li>
<li><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml">The static </span><code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml">Failure</span></code><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml"> returns a </span><code><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml">FailedOperationResult</span></code><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml"> object.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml">This technique moves the responsibility of deciding whether the operation is a success from the </span><code><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml"> class to the </span><code><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml">Operation</span></code><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml"> method that explicitly creates the expected result.The following code block shows the new </span><code><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml"> implementation (the static factories are highlighted):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml">namespace OperationResult.StaticFactoryMethod;
public abstract record class OperationResult
{
    private OperationResult() { }
    public abstract bool Succeeded { get; }
    public static OperationResult Success(int? </span><span class="koboSpan" id="kobo.327.2" xmlns="http://www.w3.org/1999/xhtml">value = null)
    {
        return new SuccessfulOperationResult { Value = value };
    }
    public static OperationResult Failure(params OperationResultMessage[] errors)
    {
        return new FailedOperationResult(errors);
    }
    private record class SuccessfulOperationResult : OperationResult
    {
        public override bool Succeeded { get; } = true;
        public virtual int? </span><span class="koboSpan" id="kobo.327.3" xmlns="http://www.w3.org/1999/xhtml">Value { get; init; }
    }
    private record class FailedOperationResult : OperationResult
    {
        public FailedOperationResult(params OperationResultMessage[] errors)
        {
            Messages = errors.ToImmutableList();
        }
        public override bool Succeeded { get; } = false;
        public ImmutableList&lt;OperationResultMessage&gt; Messages { get; }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml">After analyzing the code, there are a few closely related particularities:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml"> class has a private constructor.</span></li>
<li><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml">Both the </span><code><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml">SuccessfulOperationResult</span></code><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml">FailedOperationResult</span></code><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml"> classes are nested inside the </span><code><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml"> class, inherit from it, and are </span><code><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml">private</span></code><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml">Nested classes are the only way to inherit from the </span><code><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml"> class because, like other members of the class, nested classes have access to their private members, including the constructor. </span><span class="koboSpan" id="kobo.343.2" xmlns="http://www.w3.org/1999/xhtml">Otherwise, it is impossible to inherit from </span><code><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.345.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, as private classes, they can only be accessed internally from the </span><code><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml"> class for the same reason and become inaccessible from the outside.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">Since the beginning of the book, I have repeated </span><strong><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml">flexibility</span></strong><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml"> many times; but you don’t always want flexibility. </span><span class="koboSpan" id="kobo.350.2" xmlns="http://www.w3.org/1999/xhtml">Even if most of the book is about improving flexibility, sometimes you want control over what you expose and what you allow consumers to do, whether to protect internal mechanisms (encapsulation) or for maintainability reasons.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml">For example, allowing consumers to change the internal state of an object can lead to unexpected behaviors. </span><span class="koboSpan" id="kobo.351.2" xmlns="http://www.w3.org/1999/xhtml">Another example would be when managing a library; the larger the public API, the more chances of introducing a breaking change. </span><span class="koboSpan" id="kobo.351.3" xmlns="http://www.w3.org/1999/xhtml">Nonetheless, over-hiding elements can be a detrimental experience for the consumers; if you need something somewhere, the chances are that someone else will too (eventually).</span></p>
</blockquote>
<blockquote>
<p><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">In this case, we could have used a protected constructor instead or implemented a fancier way of instancing success and failure instances. </span><span class="koboSpan" id="kobo.352.2" xmlns="http://www.w3.org/1999/xhtml">Nonetheless, I decided to use this opportunity to show you how to lock a class in place without the sealed modifier, making extending by inheritance from the outside impossible. </span><span class="koboSpan" id="kobo.352.3" xmlns="http://www.w3.org/1999/xhtml">We could have built mechanisms in our classes to allow controlled extensibility (like the Template Method pattern), but for this one, let’s keep it locked in tight!</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">From here, the only missing pieces are the operation itself and the consumer of the operation. </span><span class="koboSpan" id="kobo.353.2" xmlns="http://www.w3.org/1999/xhtml">Let’s look at the operation first:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml">namespace OperationResult.StaticFactoryMethod;
public class Executor
{
    public OperationResult Operation()
    {
        // Randomize the success indicator
        // This should be real logic
        var randomNumber = Random.Shared.Next(100);
        var success = randomNumber % 2 == 0;
        // Return the operation result
        if (success)
        {
            return OperationResult.Success(randomNumber);
        }
        else
        {
            var error = new OperationResultMessage(
                $"Something went wrong with the number '{randomNumber}'.",
                OperationResultSeverity.Error
            );
            return OperationResult.Failure(error);
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml">The two highlighted lines in the preceding code block show the elegance of this new improvement. </span><span class="koboSpan" id="kobo.355.2" xmlns="http://www.w3.org/1999/xhtml">I find this code very easy to read, which was the objective. </span><span class="koboSpan" id="kobo.355.3" xmlns="http://www.w3.org/1999/xhtml">We now have two methods that clearly define our intentions when using them: </span><code><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml">Success</span></code><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml">Failure</span></code><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml">.The consumer uses the same code that we saw before in other examples, so I’ll omit it here. </span><span class="koboSpan" id="kobo.359.2" xmlns="http://www.w3.org/1999/xhtml">However, the output is different for a successful or a failed operation. </span><span class="koboSpan" id="kobo.359.3" xmlns="http://www.w3.org/1999/xhtml">Here is a successful output:</span></p>
<div class="C0-SHConPACKT">
<pre><code><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml">{
    "succeeded": true,
    "value": 80
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml">Here is a failed output:</span></p>
<div class="C0-SHConPACKT">
<pre><code><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml">{
    "succeeded": false,
    "messages": [
        {
            "message": "Something went wrong with the number '37'.",
            "severity": "Error"
        }
    ]
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml">As the two preceding JSON outputs show, each object's properties are different. </span><span class="koboSpan" id="kobo.363.2" xmlns="http://www.w3.org/1999/xhtml">The only shared property of the two is the </span><code><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml">Succeeded</span></code><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml"> property. </span><span class="koboSpan" id="kobo.365.2" xmlns="http://www.w3.org/1999/xhtml">Beware that this type of class hierarchy is harder to consume directly since the interface (the </span><code><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml"> class) has a minimal API surface, which is good in theory, and each sub-class adds different properties, which are hidden from the consumers. </span><span class="koboSpan" id="kobo.367.2" xmlns="http://www.w3.org/1999/xhtml">For example, it would be hard to use the </span><code><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml"> property of a successful operation directly in the endpoint handler code. </span><span class="koboSpan" id="kobo.369.2" xmlns="http://www.w3.org/1999/xhtml">Therefore, when hiding properties, as we did here, ensure those additional properties are optional. </span><span class="koboSpan" id="kobo.369.3" xmlns="http://www.w3.org/1999/xhtml">For example, we can use this technique when sending the result to another system over HTTP (like this project does) or publish the operation result as an event (see </span><em><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 19</span></em><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml">Introduction to Microservices Architecture</span></em><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml">, where we introduce event-driven architecture). </span><span class="koboSpan" id="kobo.373.2" xmlns="http://www.w3.org/1999/xhtml">Nevertheless, learning to manipulate classes using polymorphism will be helpful the day you need it.Next, let’s peek at some advantages and disadvantages of the Operation Result pattern.</span></p>
</section>
</section>
<section class="level3" data-number="14.2.4" id="advantages-and-disadvantages">
<h3 data-number="14.2.4"><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml">Advantages and disadvantages</span></h3>
<p><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">Here are a few advantages and disadvantages of the Operation Result design pattern.</span></p>
<section class="level4" data-number="14.2.4.1" id="advantages">
<h4 data-number="14.2.4.1"><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">Advantages</span></h4>
<p><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml">It is more explicit than throwing an </span><code><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml">Exception</span></code><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml"> since the operation result type is specified explicitly as the method’s return type. </span><span class="koboSpan" id="kobo.379.2" xmlns="http://www.w3.org/1999/xhtml">That makes it more evident than knowing what type of exceptions the operation and its dependencies can throw.Another advantage is the execution speed; returning an object is faster than throwing an exception. </span><span class="koboSpan" id="kobo.379.3" xmlns="http://www.w3.org/1999/xhtml">Not that much faster, but faster nonetheless.Using operation results is more flexible than exceptions and gives us design flexibility; for example, we can manage different message types like warnings and information.</span></p>
</section>
<section class="level4" data-number="14.2.4.2" id="disadvantages">
<h4 data-number="14.2.4.2"><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml">Disadvantages</span></h4>
<p><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">Using operation results is more complex than throwing exceptions because we must </span><em><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml">manually propagate it up the call stack</span></em><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml"> (i.e., the result object is returned by the callee and handled by the caller). </span><span class="koboSpan" id="kobo.383.2" xmlns="http://www.w3.org/1999/xhtml">This is especially true if the operation result must go up multiple levels, suggesting this pattern may not be the most suitable.It is easy to expose members not used by all scenarios, creating a bigger API surface than needed, where some parts are used only in some cases. </span><span class="koboSpan" id="kobo.383.3" xmlns="http://www.w3.org/1999/xhtml">But, between this and spending countless hours designing the perfect system, sometimes exposing an </span><code><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml">int? </span><span class="koboSpan" id="kobo.384.2" xmlns="http://www.w3.org/1999/xhtml">Value { get; }</span></code><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml"> property is the best option. </span><span class="koboSpan" id="kobo.385.2" xmlns="http://www.w3.org/1999/xhtml">Nonetheless, always try to reduce that surface to a minimum and use your imagination and design skills to overcome those challenges!</span></p>
</section>
</section>
</section>
<section class="level2" data-number="14.3" id="summary-12">
<h2 data-number="14.3"><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we visited multiple forms of the Operation Result pattern, from an augmented Boolean to a complex data structure containing messages, values, and success indicators. </span><span class="koboSpan" id="kobo.387.2" xmlns="http://www.w3.org/1999/xhtml">We also explored static factories and private constructors to control external access. </span><span class="koboSpan" id="kobo.387.3" xmlns="http://www.w3.org/1999/xhtml">Furthermore, after all that exploration, let’s conclude that there are almost endless possibilities around the Operation Result pattern. </span><span class="koboSpan" id="kobo.387.4" xmlns="http://www.w3.org/1999/xhtml">Each specific use case should dictate how to make it happen. </span><span class="koboSpan" id="kobo.387.5" xmlns="http://www.w3.org/1999/xhtml">From here, I am confident you have enough information about the pattern to explore the many possibilities yourself, and I highly encourage you to.The Operation Result pattern is perfect for crafting strongly typed return values that self-manage multiple states (error and success) or support complex states (like partial success). </span><span class="koboSpan" id="kobo.387.6" xmlns="http://www.w3.org/1999/xhtml">It is also ideal for transporting messages that are not necessarily errors, like information messages. </span><span class="koboSpan" id="kobo.387.7" xmlns="http://www.w3.org/1999/xhtml">Even in its simplest form, we can leverage the Operation Result pattern as a base for extensibility since we can add members to the result class over time, which would be impossible for a primitive type (or any type we don’t control).</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml">HttpResponseMessage</span></code><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml"> class returned by the methods of the </span><code><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml">HttpClient</span></code><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml"> class is an excellent example of a concrete implementation of the Operation Result pattern. </span><span class="koboSpan" id="kobo.392.2" xmlns="http://www.w3.org/1999/xhtml">It contains a single message exposed through the </span><code><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml">ReasonPhrase</span></code><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml"> property. </span><span class="koboSpan" id="kobo.394.2" xmlns="http://www.w3.org/1999/xhtml">It exposes a complex success state through the </span><code><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">StatusCode</span></code><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml"> property and a simple success indicator through its </span><code><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml">IsSuccessStatusCode</span></code><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml"> property. </span><span class="koboSpan" id="kobo.398.2" xmlns="http://www.w3.org/1999/xhtml">It also contains more information about the request and response through other properties.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml">At this point, we would usually explore how the </span><strong><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml">Operation Result</span></strong><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml"> pattern can help us follow the SOLID principles. </span><span class="koboSpan" id="kobo.401.2" xmlns="http://www.w3.org/1999/xhtml">However, it depends too much on the implementation, so here are a few key points instead:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml">OperationResult</span></code><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml"> class encapsulates the result, extracting that responsibility from the other system’s components (SRP).</span></li>
<li><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml">We violated the ISP with the </span><code><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml">Value</span></code><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml"> property in multiple examples. </span><span class="koboSpan" id="kobo.407.2" xmlns="http://www.w3.org/1999/xhtml">This infringement has a minor impact that we fixed as an example of overcoming this challenge.</span></li>
<li><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">We could compare an operation result to a DTO but returned by an operation (method) instead of a REST API endpoint. </span><span class="koboSpan" id="kobo.408.2" xmlns="http://www.w3.org/1999/xhtml">From there, we could add an abstraction or stick with returning a concrete class, but sometimes using concrete types makes the system easier to understand and maintain. </span><span class="koboSpan" id="kobo.408.3" xmlns="http://www.w3.org/1999/xhtml">Depending on the implementation, this may break different principles.</span></li>
</ul>
<blockquote>
<p><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml">When the advantages surpass the minor impacts of those kinds of violations, it is acceptable to let them slide. </span><span class="koboSpan" id="kobo.409.2" xmlns="http://www.w3.org/1999/xhtml">Principles are ideals and are not applicable in every scenario—principles are not laws.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml">Most design decisions are trade-offs between two imperfect solutions, so you must choose which downsides you prefer to live with to gain the upsides.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml">This chapter concludes </span><em><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml">Section 3:</span></em> <em><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml">Components Patterns</span></em><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml"> and leads to </span><em><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml">Section 4: Application Patterns</span></em><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml">, where we explore higher-level design patterns.</span></p>
</section>
<section class="level2" data-number="14.4" id="questions-12">
<h2 data-number="14.4"><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml">Questions</span></h2>
<p><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">Let’s take a look at a few practice questions:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">Is returning an operation result when doing an asynchronous call, such as an HTTP request, a good idea?</span></li>
<li><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml">What is the name of the pattern that we implemented using static methods?</span></li>
<li><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml">Is it faster to return an operation result than throw an exception?</span></li>
<li><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">In what scenario might the Operation Result pattern come in handy?</span></li>
</ol>
</section>
<section class="level2" data-number="14.5" id="further-reading-10">
<h2 data-number="14.5"><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml">Further reading</span></h2>
<p><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml">Here are some links to build on what we learned in this chapter:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml">An article on my blog about exceptions (title: </span><em><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml">A beginner guide to exceptions</span></em><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml"> | </span><em><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml">The basics</span></em><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml">): </span><a href="https://adpg.link/PpEm"><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/PpEm</span></a></li>
<li><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">An article on my blog about Operation Result (title</span><em><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml">: Operation result</span></em><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml"> | </span><em><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml">Design Pattern</span></em><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml">): </span><a href="https://adpg.link/4o2q"><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/4o2q</span></a></li>
</ul>
</section>
<section class="level2" data-number="14.6" id="answers-9">
<h2 data-number="14.6"><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml">Answers</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml">Yes, asynchronous operations like HTTP are great candidates for the Operation Result pattern. </span><span class="koboSpan" id="kobo.438.2" xmlns="http://www.w3.org/1999/xhtml">For example, in the BCL, the </span><code><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml">HttpResponseMessage</span></code><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml"> instance returned by the </span><code><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml">Send</span></code><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml"> method of the </span><code><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml">HttpClient</span></code><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml"> class is an operation result.</span></li>
<li><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">We implemented two </span><strong><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml">static factory methods</span></strong><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml">.</span></li>
<li><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml">Yes, returning an object is marginally faster than throwing an exception.</span></li>
<li><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">The Operation Result pattern comes in handy when we want to return the state of the operation along with its return value as part of the main consumption flow. </span><span class="koboSpan" id="kobo.449.2" xmlns="http://www.w3.org/1999/xhtml">It is very suitable to return multiple properties describing the result of the process and is extensible.</span></li>
</ol>
</section>
</section>
</body>
</html>
