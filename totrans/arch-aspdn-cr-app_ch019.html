<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="packt" name="generator"/>
<title>18 Request-EndPoint-Response (REPR) and Minimal APIs</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<link href="../styles/stylesheet2.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body>
<section class="level1 pkt" data-number="19" id="request-endpoint-response-repr-and-minimal-apis">
<h1 data-number="19"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">18 Request-EndPoint-Response (REPR) and Minimal APIs</span></h1>
<section class="level2" data-number="19.1" id="before-you-begin-join-our-book-community-on-discord-17">
<h2 data-number="19.1"><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Before you begin: Join our book community on Discord</span></h2>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">Give your feedback straight to the author himself and chat to other early readers on our Discord server (find the "architecting-aspnet-core-apps-3e" channel under EARLY ACCESS SUBSCRIPTION).</span></p>
<p><a href="https://packt.link/EarlyAccess"><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">https://packt.link/EarlyAccess</span></a></p>
<p><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Qr code Description automatically generated" src="../media/file120.png" style="width:10em"/></span></p>
<p><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">This chapter introduces the </span><strong><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">Request-EndPoint-Response (REPR)</span></strong><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml"> pattern, which builds on top of Vertical Slice Architecture and CQS. </span><span class="koboSpan" id="kobo.8.2" xmlns="http://www.w3.org/1999/xhtml">We continue to simplify our codebase to make it even more readable, maintainable, and less abstract, yet still testable.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">We pronounce REPR like “reaper”, which sounds way better than “rer” or “reper”. </span><span class="koboSpan" id="kobo.9.2" xmlns="http://www.w3.org/1999/xhtml">I must credit Steve "ardalis" Smith for this outstanding pattern name. </span><span class="koboSpan" id="kobo.9.3" xmlns="http://www.w3.org/1999/xhtml">I left a link to his article in the </span><em><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml">Further reading</span></em><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml"> section.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">We leveraged this pattern already, possibly without you knowing about its name. </span><span class="koboSpan" id="kobo.12.2" xmlns="http://www.w3.org/1999/xhtml">Now it is time to formally introduce it, then assemble a technology stack to make it scalable for a real-world application.We build that solution, then improve it during the chapter to make it better by exploring manual techniques, existing tools, and open-source libraries. </span><span class="koboSpan" id="kobo.12.3" xmlns="http://www.w3.org/1999/xhtml">The result is not perfect, but we are not done improving this new e-commerce-inspired solution.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">The key to this approach is learning to think about architecture and improve your design skills, so you have the tools to overcome the unique challenges the real world will throw at you!</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we cover the following topics:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">Request-EndPoint-Response (REPR) pattern</span></li>
<li><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml">Project – REPR—A slice of the real-world</span></li>
</ul>
<p><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">Let's explore the pattern before jumping into a more hands-on example.</span></p>
</section>
<section class="level2" data-number="19.2" id="request-endpoint-response-repr-pattern">
<h2 data-number="19.2"><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">Request-EndPoint-Response (REPR) pattern</span></h2>
<p><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml">The Request-EndPoint-Response (REPR) pattern offers a simple approach similar to what we explored in Vertical Slice Architecture which deviates from the traditional Model-View-Controller (MVC) pattern. </span><span class="koboSpan" id="kobo.19.2" xmlns="http://www.w3.org/1999/xhtml">As we explored in the MVC Chapter, REST APIs don't have views, so we have to distort the concept to make it work. </span><span class="koboSpan" id="kobo.19.3" xmlns="http://www.w3.org/1999/xhtml">REPR is more appropriate than MVC for building REST APIs in the context of HTTP since each URL is a way to describe how to reach an endpoint (execute an operation), not a controller.</span></p>
<section class="level3" data-number="19.2.1" id="goal-17">
<h3 data-number="19.2.1"><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">Goal</span></h3>
<p><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">REPR aims to align our REST APIs to HTTP and treat the inherent request-response concept being the web as a first-class citizen in our application design.On top of this, the REPR pattern using Minimal APIs is well-aligned with Vertical Slice Architecture and facilitates building feature-oriented software instead of layer-heavy applications.</span></p>
</section>
<section class="level3" data-number="19.2.2" id="design-17">
<h3 data-number="19.2.2"><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">Design</span></h3>
<p><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">REPR has three components:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">A request that contains the required information for the endpoint to do its work and plays the role of an input DTO.</span></li>
<li><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">An endpoint handler containing the business logic to execute, which is the central piece of this pattern.</span></li>
<li><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">A response that the endpoint returns to the client and plays the role of an output DTO.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml">You can treat each request as a </span><em><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">Query</span></em><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml"> or a </span><em><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></em><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml"> as we explore in the CQS and Vertical Slice Architecture chapters.Here's a diagram that represents this concept:</span></p>
<figure>
<span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 18.1: a diagram representing the logical flow and the REPR pattern." src="../media/file121.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">Figure 18.1: a diagram representing the logical flow and the REPR pattern.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">The preceding diagram should sound familiar since it resembles what we explored in the Vertical Slice Architecture. </span><span class="koboSpan" id="kobo.34.2" xmlns="http://www.w3.org/1999/xhtml">However, instead of Request-Handler-Result, we use Request-Endpoint-Response (a.k.a. </span><span class="koboSpan" id="kobo.34.3" xmlns="http://www.w3.org/1999/xhtml">REPR).Bottom line, a request can be a Query or a Command, then it hits the endpoint that executes the logic and finally returns a response.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">The server returns an HTTP response even when the response’s body is empty.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">Let’s explore an example using Minimal API.</span></p>
</section>
<section class="level3" data-number="19.2.3" id="project-simpleendpoint">
<h3 data-number="19.2.3"><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">Project – SimpleEndpoint</span></h3>
<p><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">The SimpleEndpoint project showcases a few simple features and patterns to organize our REPR features without dependencies on external libraries.</span></p>
<section class="level4" data-number="19.2.3.1" id="feature-shuffletext">
<h4 data-number="19.2.3.1"><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml">Feature: ShuffleText</span></h4>
<p><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">The first feature gets a string as input, shuffles its content, and returns it:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml">namespace SimpleEndpoint;
public class ShuffleText
{
    public record class Request(string Text);
    public record class Response(string Text);
    public class Endpoint
    {
        public Response Handle(Request request)
        {
            var chars = request.Text.ToArray();
            Random.Shared.Shuffle(chars);
            return new Response(new string(chars));
        }
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code leverages the </span><code><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml">Random</span></code><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml"> API and shuffles the </span><code><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">request.Text</span></code><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml"> property then returns the results wrapped in a </span><code><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml">Response</span></code><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml"> object.Before executing our feature, we must create a minimal API map and register our handler with the container. </span><span class="koboSpan" id="kobo.48.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the Program.cs class that achieves this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">using SimpleEndpoint;
var builder = WebApplication.CreateBuilder(args);
builder.Services.AddSingleton&lt;ShuffleText.Endpoint&gt;();
var app = builder.Build();
app.MapGet(
    "/shuffle-text/{text}",
    ([AsParameters] ShuffleText.Request query, ShuffleText.Endpoint endpoint)
        =&gt; endpoint.Handle(query)
);
app.Run();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code registers the </span><code><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml">ShuffleText.Endpoint</span></code><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml"> as a singleton so we can inject it in the delegate. </span><span class="koboSpan" id="kobo.52.2" xmlns="http://www.w3.org/1999/xhtml">The delegate leverages the </span><code><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml">[AsParameters]</span></code><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml"> attribute to bind the route parameter to the </span><code><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml">ShuffleText.Request</span></code><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml"> property. </span><span class="koboSpan" id="kobo.56.2" xmlns="http://www.w3.org/1999/xhtml">Finally, the logic is straightforward; the endpoint delegate sends the request to the injected endpoint handler and returns the result, which ASP.NET Core serializes to JSON.When we send the following HTTP request:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml">GET https://localhost:7289/shuffle-text/I%20love%20ASP.NET%20Core</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">We receive some gibberish results similar to the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml">{
  "text": "eo .e vNrCAT PSElIo"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml">This pattern is close to the simplest we can get out of the box. </span><span class="koboSpan" id="kobo.60.2" xmlns="http://www.w3.org/1999/xhtml">Next, we encapsulate the endpoint itself.</span></p>
</section>
<section class="level4" data-number="19.2.3.2" id="feature-randomnumber">
<h4 data-number="19.2.3.2"><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml">Feature: RandomNumber</span></h4>
<p><span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml">This feature generates a number of random numbers between a minimum and a maximum.The first pattern divided the code between the </span><code><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml"> file and the feature itself. </span><span class="koboSpan" id="kobo.64.2" xmlns="http://www.w3.org/1999/xhtml">In this pattern, we encapsulate the endpoint delegate into the feature (same file in this case):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml">namespace SimpleEndpoint;
public class RandomNumber
{
    public record class Request(int Amount, int Min, int Max);
    public record class Response(IEnumerable&lt;int&gt; Numbers);
    public class Handler
    {
        public Response Handle(Request request)
        {
            var result = new int[request.Amount];
            for (var i = 0; i &lt; request.Amount; i++)
            {
                result[i] = Random.Shared.Next(request.Min, request.Max);
            }
            return new Response(result);
        }
    }
    public static Response Endpoint([AsParameters] Request query, Handler handler)
        =&gt; handler.Handle(query);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code is very similar to the first feature. </span><span class="koboSpan" id="kobo.66.2" xmlns="http://www.w3.org/1999/xhtml">However, the delegate we named </span><code><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">Endpoint</span></code><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml"> is now part of the feature class (highlighted code). </span><span class="koboSpan" id="kobo.68.2" xmlns="http://www.w3.org/1999/xhtml">The class that contains the logic is now called </span><code><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml"> instead of </span><code><span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml">Endpoint</span></code><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.72.2" xmlns="http://www.w3.org/1999/xhtml">This change makes the full feature live closer together.Nonetheless, we still need to register the dependency with the container and map the endpoint to our delegate like this in the </span><code><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml"> file:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.AddSingleton&lt;RandomNumber.Handler&gt;();
// ...
</span><span class="koboSpan" id="kobo.75.2" xmlns="http://www.w3.org/1999/xhtml">app.MapGet(
    "/random-number/{Amount}/{Min}/{Max}", 
    RandomNumber.Endpoint
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code is routing the request to the </span><code><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml">RandomNumber.Endpoint</span></code><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml"> method.When we send the following HTTP request:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml">https://localhost:7289/random-number/5/0/100</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">We receive a result similar to the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml">{
  "numbers": [
    60,
    27,
    78,
    63,
    87
  ]
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml">We moved more of our feature’s code together; however, our code is still divided into two files. </span><span class="koboSpan" id="kobo.82.2" xmlns="http://www.w3.org/1999/xhtml">Let’s explore a way to fix this next.</span></p>
</section>
<section class="level4" data-number="19.2.3.3" id="feature-uppercase">
<h4 data-number="19.2.3.3"><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">Feature: UpperCase</span></h4>
<p><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml">This feature transforms the input text to uppercase and returns the result.Our objective is to centralize as much of the code as possible in the </span><code><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml">UpperCase</span></code><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml"> feature class so we control it from a single place. </span><span class="koboSpan" id="kobo.86.2" xmlns="http://www.w3.org/1999/xhtml">To achieve this, we create the following extension methods (highlighted):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml">namespace SimpleEndpoint;
public static class UpperCase
{
    public record class Request(string Text);
    public record class Response(string Text);
    public class Handler
    {
        public Response Handle(Request request)
        {
            return new Response(request.Text.ToUpper());
        }
    }
    public static IServiceCollection AddUpperCase(this IServiceCollection services)
    {
        return services.AddSingleton&lt;Handler&gt;();
    }
    public static IEndpointRouteBuilder MapUpperCase(this IEndpointRouteBuilder endpoints)
    {
        endpoints.MapGet(
            "/upper-case/{Text}",
            ([AsParameters] Request query, Handler handler)
                =&gt; handler.Handle(query)
        );
        return endpoints;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml">In the preceding code, we changed the following:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml">UpperCase</span></code><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml"> class is static to allow us to create extension methods. </span><span class="koboSpan" id="kobo.91.2" xmlns="http://www.w3.org/1999/xhtml">Turning the </span><code><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml">UpperCase</span></code><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml"> class into a static class does not hinder our maintainability because we use it as an organizer and do not instantiate it.</span></li>
<li><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml">We added the </span><code><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml">AddUpperCase</span></code><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml"> method that registers the dependencies with the container.</span></li>
<li><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml">We added the </span><code><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">MapUpperCase</span></code><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml"> method that creates the endpoint itself.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml">In the Program.cs file, we can now register our feature like this:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.AddUpperCase();
// ...
</span><span class="koboSpan" id="kobo.101.2" xmlns="http://www.w3.org/1999/xhtml">app.MapUpperCase();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code calls our extension methods, which move all the related code into the </span><code><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml">UpperCase</span></code><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml"> class but its connection with ASP.NET Core.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml">I find this approach elegant and very clean for a no-dependency project. </span><span class="koboSpan" id="kobo.105.2" xmlns="http://www.w3.org/1999/xhtml">Of course, we could design this in a million different ways, use an existing library to help us, scan the assembly and auto-register our features, and more.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml">You can use this pattern to build a real-world application. </span><span class="koboSpan" id="kobo.106.2" xmlns="http://www.w3.org/1999/xhtml">I’d suggest creating an </span><code><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml">AddFeatures</span></code><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml"> and a </span><code><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml">MapFeatures</span></code><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml"> extension method that register all the features instead of cluttering the </span><code><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml"> file, but besides a few final organization touch, this is a robust enough pattern. </span><span class="koboSpan" id="kobo.112.2" xmlns="http://www.w3.org/1999/xhtml">We explore more of this in the next project.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml">When we send the following HTTP request:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml">GET https://localhost:7289/upper-case/I%20love%20ASP.NET%20Core</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml">We receive the following response:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml">{
  "text": "I LOVE ASP.NET CORE"
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml">Now that we explored REPR and how to encapsulate our REPR features in several ways, we are almost ready to explore a larger project.</span></p>
</section>
</section>
<section class="level3" data-number="19.2.4" id="conclusion-27">
<h3 data-number="19.2.4"><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml">Conclusion</span></h3>
<p><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml">Creating a feature-based design using Minimal APIs, the REPR pattern, and no external dependencies is possible and simple. </span><span class="koboSpan" id="kobo.119.2" xmlns="http://www.w3.org/1999/xhtml">We organized our project in different ways. </span><span class="koboSpan" id="kobo.119.3" xmlns="http://www.w3.org/1999/xhtml">Each feature comprises a request, a response, and a handler attached to an endpoint.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">We can combine the handler and the endpoint to make it a three-component pattern. </span><span class="koboSpan" id="kobo.120.2" xmlns="http://www.w3.org/1999/xhtml">What I like about having a distinct handler is that we can reuse the handler in a non-HTTP context; say, we could create a CLI tool in front of the application and reuse the same logic. </span><span class="koboSpan" id="kobo.120.3" xmlns="http://www.w3.org/1999/xhtml">It all depends on what we are building.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml">Let’s see how the REPR pattern can help us follow the </span><strong><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml">SOLID</span></strong><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml"> principles:</span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">S</span></strong><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml">: Each piece has a single responsibility, and all pieces are centralized under a feature for ease of navigation, making this pattern a perfect SRP ally.</span></li>
<li><strong><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">O</span></strong><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml">: Using an approach similar to what we did with the </span><code><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml">UpperCase</span></code><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml"> feature, we can change the feature’s behavior without affecting the rest of the codebase.</span></li>
<li><strong><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml">L</span></strong><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">: N/A</span></li>
<li><strong><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml">I</span></strong><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml">: The REPR pattern divides a feature into three smaller interfaces: the request, the endpoint, and the response.</span></li>
<li><strong><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml">D</span></strong><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml">: N/A</span></li>
</ul>
<p><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml">Now that we familiarized ourselves with the REPR pattern, it is time to explore a larger project, including exception handling and grey-box testing.</span></p>
</section>
</section>
<section class="level2" data-number="19.3" id="project-repra-slice-of-the-real-world">
<h2 data-number="19.3"><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml">Project – REPR—A slice of the real-world</span></h2>
<p><strong><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></strong><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml">: this project slightly differs from the previous ones about products and stocks. </span><span class="koboSpan" id="kobo.139.2" xmlns="http://www.w3.org/1999/xhtml">We remove the inventory from the product, add a unit price, and create a barebone shopping basket as a foundation for an e-commerce application. </span><span class="koboSpan" id="kobo.139.3" xmlns="http://www.w3.org/1999/xhtml">The inventory management became so complex that we had to extract and handle it separately (not included here).By using the REPR pattern, Minimal APIs, and what we learned with Vertical Slice Architecture, we analyzed that the application contains two major areas:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml">A product catalog</span></li>
<li><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml">A shopping cart</span></li>
</ul>
<p><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml">For this first iteration, we kept the management of the products away from the application, supporting only the following features:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml">Listing all products</span></li>
<li><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml">Fetching the details of a product</span></li>
</ul>
<p><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml">As for the shopping cart, we kept it to a minimum. </span><span class="koboSpan" id="kobo.145.2" xmlns="http://www.w3.org/1999/xhtml">The basket only persists the </span><code><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">Id</span></code><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml"> of the products in the cart and its quantity. </span><span class="koboSpan" id="kobo.147.2" xmlns="http://www.w3.org/1999/xhtml">The basket does not support any more advanced use cases. </span><span class="koboSpan" id="kobo.147.3" xmlns="http://www.w3.org/1999/xhtml">Here are the operations it supports:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">Add an item to the cart</span></li>
<li><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml">Fetch the items that are in the cart</span></li>
<li><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml">Remove an item from the cart</span></li>
<li><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml">Update the quantity of an item in the cart</span></li>
</ul>
<p><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml">For now, the shopping cart is not aware of the product catalog.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml">We improve the application in </span><em><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 19</span></em><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml">Introduction to Microservices Architecture</span></em><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><em><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 20</span></em><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml">Modular Monolith</span></em><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">Let’s assemble the stack we’ll build upon next.</span></p>
<section class="level3" data-number="19.3.1" id="assembling-our-stack">
<h3 data-number="19.3.1"><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml">Assembling our stack</span></h3>
<p><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml">I want to keep the project as barebone as possible, using Minimal APIs, yet, we don’t have to struggle with manually implementing every single concern ourselves. </span><span class="koboSpan" id="kobo.164.2" xmlns="http://www.w3.org/1999/xhtml">Here are the tools we will use to build this project:</span></p>
<ul>
<li><em><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml">ASP.NET Core Minimal API</span></em><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml"> as our backbone.</span></li>
<li><em><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidation</span></em><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml"> as our validation framework.</span></li>
<li><em><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidation.AspNetCore.Http</span></em><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml"> connects FluentValidation into Minimal API.</span></li>
<li><em><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml">Mapperly</span></em><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml"> is our mapping framework.</span></li>
<li><em><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper</span></em><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml"> helps us handle exceptions globally, shifting our pattern to error management.</span></li>
<li><em><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">EF Core</span></em><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml"> (InMemory) as our ORM.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml">From a terminal window, we can use the CLI to install the packages:</span></p>
<div class="C0-ConsolePACKT">
<pre><code><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">dotnet add package FluentValidation.AspNetCore
dotnet add package ForEvolve.ExceptionMapper
dotnet add package ForEvolve.FluentValidation.AspNetCore.Http
dotnet add package Microsoft.EntityFrameworkCore.InMemory
dotnet add package Riok.Mapperly</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml">We know most of those pieces and will dig deeper into the new ones in time. </span><span class="koboSpan" id="kobo.179.2" xmlns="http://www.w3.org/1999/xhtml">Meanwhile, let’s explore the structure of the project.</span></p>
</section>
<section class="level3" data-number="19.3.2" id="dissecting-the-code-structure">
<h3 data-number="19.3.2"><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">Dissecting the code structure</span></h3>
<p><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml">The directory structure is very similar to what we explored in Vertical Slice Architecture. </span><span class="koboSpan" id="kobo.181.2" xmlns="http://www.w3.org/1999/xhtml">The root of the project contains the </span><code><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml"> file and a </span><code><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">Features</span></code><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml"> directory that holds the features or slices. </span><span class="koboSpan" id="kobo.185.2" xmlns="http://www.w3.org/1999/xhtml">The following diagram represents the features:</span></p>
<figure>
<span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 18.2: The project's directory structure that represents the features' hierarchical relationships." src="../media/file122.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml">Figure 18.2: The project's directory structure that represents the features' hierarchical relationships.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml">The features inside each area share a cohesive bond and some pieces of code (coupling), while the two areas are entirely disconnected (loosely coupled).The </span><code><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml"> file is very light and only bootstraps the application:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml">using Web.Features;
var builder = WebApplication.CreateBuilder(args);
builder.AddFeatures();
var app = builder.Build();
app.MapFeatures();
await app.SeedFeaturesAsync();
app.Run();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml">The highlighted lines are extension methods defined in the </span><code><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml">Features</span></code><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml"> class (located under the </span><code><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml">Features</span></code><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml"> folder), which cascades the responsibility of registering the dependencies with the container, mapping the endpoints, and seeding the database to each area. </span><span class="koboSpan" id="kobo.196.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the skeleton of the class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml">using FluentValidation;
using FluentValidation.AspNetCore;
using System.Reflection;
namespace Web.Features;
public static class Features
{
    public static IServiceCollection AddFeatures(
        this WebApplicationBuilder builder){}
    public static IEndpointRouteBuilder MapFeatures(
        this IEndpointRouteBuilder endpoints){}
    public static async Task SeedFeaturesAsync(
        this WebApplication app){}
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml">Let’s now explore the </span><code><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml">AddFeatures</span></code><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml"> method:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml">public static IServiceCollection AddFeatures(this WebApplicationBuilder builder)
{
    // Register fluent validation
    builder.AddFluentValidationEndpointFilter();
    return builder.Services
        .AddFluentValidationAutoValidation()
        .AddValidatorsFromAssembly(Assembly.GetExecutingAssembly())
        // Add features
        .AddProductsFeature()
        .AddBasketsFeature()
    ;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml">AddFeatures</span></code><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml"> method registers FluentValidation and the Minimal API filters to validate our endpoints (the highlighted line). </span><span class="koboSpan" id="kobo.204.2" xmlns="http://www.w3.org/1999/xhtml">Each slice defines its own configuration methods, like the </span><code><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml">AddProductsFeature</span></code><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml">AddBasketsFeature</span></code><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml"> methods. </span><span class="koboSpan" id="kobo.208.2" xmlns="http://www.w3.org/1999/xhtml">We will come back to those. </span><span class="koboSpan" id="kobo.208.3" xmlns="http://www.w3.org/1999/xhtml">Meanwhile, let’s explore the </span><code><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml">MapFeatures</span></code><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml"> method:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">public static IEndpointRouteBuilder MapFeatures(this IEndpointRouteBuilder endpoints)
{
    var group = endpoints
        .MapGroup("/")
        .AddFluentValidationFilter();
    ;
    group
        .MapProductsFeature()
        .MapBasketsFeature()
    ;
    return endpoints;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml">MapFeatures</span></code><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml"> method creates a root route group, adds the </span><em><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidation</span></em><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml"> filter to it so the validation applies to all endpoints in this group, then it calls the </span><code><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml">MapProductsFeature</span></code><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml">MapBasketsFeature</span></code><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml"> methods that map their features into the group. </span><span class="koboSpan" id="kobo.220.2" xmlns="http://www.w3.org/1999/xhtml">Finally, the </span><code><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml">SeedFeaturesAsync</span></code><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml"> method seeds the database using the feature extension methods:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml">public static async Task SeedFeaturesAsync(this WebApplication app)
{
    using var scope = app.Services.CreateScope();
    await scope.SeedProductsAsync();
    await scope.SeedBasketAsync();
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">With those building blocks in place, the program starts, adds features, and registers endpoints. </span><span class="koboSpan" id="kobo.224.2" xmlns="http://www.w3.org/1999/xhtml">Afterward, each category of features—products and baskets—cascades the calls, letting each feature registers its pieces. </span><span class="koboSpan" id="kobo.224.3" xmlns="http://www.w3.org/1999/xhtml">Next are a few diagrams representing the call hierarchy from the </span><code><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml"> file. </span><span class="koboSpan" id="kobo.226.2" xmlns="http://www.w3.org/1999/xhtml">Let’s start with the </span><code><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml">AddFeatures</span></code><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml"> method:</span></p>
<figure>
<span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 18.3: the call hierarchy of the AddFeatures method." src="../media/file123.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml">Figure 18.3: the call hierarchy of the AddFeatures method.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">The preceding diagram showcases the division of responsibilities where each piece aggregates its sub-parts or registers its dependencies.A similar flow happens from the </span><code><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml">MapFeatures</span></code><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml"> method:</span></p>
<figure>
<span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 18.4: the call hierarchy of the MapFeatures method." src="../media/file124.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml">Figure 18.4: the call hierarchy of the MapFeatures method.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml">Finally, the </span><code><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml">SeedFeaturesAsync</span></code><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml"> method utilizes a similar approach to seed the in-memory database:</span></p>
<figure>
<span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 18.5: the call hierarchy of the SeedFeaturesAsync method." src="../media/file125.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml">Figure 18.5: the call hierarchy of the SeedFeaturesAsync method.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml">These diagrams showcase the entry point (</span><code><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml">) sending a request to each feature so that every piece handles itself.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml">In a real project using an actual database, you do not want to seed the database this way. </span><span class="koboSpan" id="kobo.244.2" xmlns="http://www.w3.org/1999/xhtml">In this case, it works because each time we start the project, the database is empty because it only lives for the time the program runs—it lives in memory. </span><span class="koboSpan" id="kobo.244.3" xmlns="http://www.w3.org/1999/xhtml">There are numerous strategies to seed your data sources in real life, from executing a SQL script to deploying a Docker container that runs only once.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml">Now that we explored the high-level view of the program, it is time to dig into a feature and explore how it works.</span></p>
</section>
<section class="level3" data-number="19.3.3" id="exploring-the-shopping-basket">
<h3 data-number="19.3.3"><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml">Exploring the shopping basket</span></h3>
<p><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml">This section explores the </span><code><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml">AddItem</span></code><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">FetchItems</span></code><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml"> features of the shopping basket slice. </span><span class="koboSpan" id="kobo.251.2" xmlns="http://www.w3.org/1999/xhtml">The slice is completely decoupled from the </span><code><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">Products</span></code><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml"> slice, and does not know the products themselves. </span><span class="koboSpan" id="kobo.253.2" xmlns="http://www.w3.org/1999/xhtml">All it knows is how to accumulate product identifiers and quantities and associate those with a customer. </span><span class="koboSpan" id="kobo.253.3" xmlns="http://www.w3.org/1999/xhtml">We address this problem later.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">There are no customer features and no authentication to keep the project simple.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">The code of the </span><code><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml">Features/Baskets/Baskets.cs</span></code><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml"> file powers the shopping basket features. </span><span class="koboSpan" id="kobo.257.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the skeleton:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml">using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Diagnostics;
namespace Web.Features;
public static partial class Baskets
{
    // Baskets.cs
    public record class BasketItem(int CustomerId, int ProductId, int Quantity);
    public class BasketContext : DbContext {}
    public static IServiceCollection AddBasketsFeature(this IServiceCollection services) {}
    public static IEndpointRouteBuilder MapBasketsFeature(this IEndpointRouteBuilder endpoints) {}
    public static Task SeedBasketsAsync(this IServiceScope scope) {}
    // Baskets.AddItem.cs
    public partial class AddItem {}
    public static IServiceCollection AddAddItem(this IServiceCollection services) {}
    public static IEndpointRouteBuilder MapAddItem(this IEndpointRouteBuilder endpoints) {}
    // Baskets.FetchItems.cs
    public partial class FetchItems {}
    public static IServiceCollection AddFetchItems(this IServiceCollection services) {}
    public static IEndpointRouteBuilder MapFetchItems(this IEndpointRouteBuilder endpoints) {}
    // Baskets.RemoveItem.cs
    public partial class RemoveItem {}
    public static IServiceCollection AddRemoveItem(this IServiceCollection services) {}
    public static IEndpointRouteBuilder MapRemoveItem(this IEndpointRouteBuilder endpoints) {}
    // Baskets.UpdateQuantity.cs
    public partial class UpdateQuantity {}
    public static IServiceCollection AddUpdateQuantity(this IServiceCollection services) {}
    public static IEndpointRouteBuilder MapUpdateQuantity(this IEndpointRouteBuilder endpoints) {}
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">The highlighted code of the preceding block contains the </span><code><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">BasketItem</span></code><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml"> data model and the </span><code><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">BasketContext</span></code><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml"> EF Core </span><code><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml">, which all basket features share. </span><span class="koboSpan" id="kobo.265.2" xmlns="http://www.w3.org/1999/xhtml">It also includes the three methods that register and make the features work (</span><code><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml">AddBasketsFeature</span></code><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml">MapBasketsFeature</span></code><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml">SeedBasketsAsync</span></code><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.271.2" xmlns="http://www.w3.org/1999/xhtml">The other methods and classes are divided into several files. </span><span class="koboSpan" id="kobo.271.3" xmlns="http://www.w3.org/1999/xhtml">We explore a few of them in the chapter.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml">We used the </span><code><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml">partial</span></code><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml"> modifier to split the nested classes into multiple files. </span><span class="koboSpan" id="kobo.274.2" xmlns="http://www.w3.org/1999/xhtml">We made the class </span><code><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml">static</span></code><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml"> to create extension methods in it.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml">BasketItem</span></code><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml"> class allows us to persist a simple shopping cart to the database:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml">public record class BasketItem(
    int CustomerId, 
    int ProductId, 
    int Quantity
);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">BasketContext</span></code><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml"> class configures the primary key of the </span><code><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">BasketItem</span></code><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml"> class and exposes the </span><code><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">Items</span></code><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml"> property (highlighted):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">public class BasketContext : DbContext
{
    public BasketContext(DbContextOptions&lt;BasketContext&gt; options)
        : base(options) { }
    public DbSet&lt;BasketItem&gt; Items =&gt; Set&lt;BasketItem&gt;();
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        modelBuilder
            .Entity&lt;BasketItem&gt;()
            .HasKey(x =&gt; new { x.CustomerId, x.ProductId })
        ;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml">AddBasketsFeature</span></code><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml"> method registers each feature and the </span><code><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml">BasketContext</span></code><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml"> with the IoC container:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml">public static IServiceCollection AddBasketsFeature(this IServiceCollection services)
{
    return services
        .AddAddItem()
        .AddFetchItems()
        .AddRemoveItem()
        .AddUpdateQuantity()
        .AddDbContext&lt;BasketContext&gt;(options =&gt; options
            .UseInMemoryDatabase("BasketContextMemoryDB")
            .ConfigureWarnings(builder =&gt; builder.Ignore(InMemoryEventId.TransactionIgnoredWarning))
        )
    ;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">Besides the </span><code><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">AddDbContext</span></code><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml"> method, the </span><code><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml">AddBasketsFeature</span></code><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml"> delegates the registration of dependencies to each feature. </span><span class="koboSpan" id="kobo.299.2" xmlns="http://www.w3.org/1999/xhtml">We explore the highlighted ones shortly. </span><span class="koboSpan" id="kobo.299.3" xmlns="http://www.w3.org/1999/xhtml">The EF Core code registers the in-memory provider that serves the </span><code><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml">BasketContext</span></code><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">.Next, the </span><code><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml">MapBasketsFeature</span></code><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml"> method maps the endpoints:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml">public static IEndpointRouteBuilder MapBasketsFeature(this IEndpointRouteBuilder endpoints)
{
    var group = endpoints
        .MapGroup(nameof(Baskets).ToLower())
        .WithTags(nameof(Baskets))
    ;
    group
        .MapFetchItems()
        .MapAddItem()
        .MapUpdateQuantity()
        .MapRemoveItem()
    ;
    return endpoints;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code creates a group, naming it </span><code><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">baskets</span></code><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml">, making its endpoints accessible using the </span><code><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml">/baskets</span></code><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml"> URL prefix. </span><span class="koboSpan" id="kobo.309.2" xmlns="http://www.w3.org/1999/xhtml">We also tag the group “Baskets” to leverage an OpenAPI generator in the future. </span><span class="koboSpan" id="kobo.309.3" xmlns="http://www.w3.org/1999/xhtml">Then the method uses a similar pattern to the </span><code><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">AddBasketsFeature</span></code><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml"> method and delegates the endpoint mapping to the features.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml">Have you noticed that the method returns the </span><code><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml">endpoints</span></code><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml"> object directly? </span><span class="koboSpan" id="kobo.314.2" xmlns="http://www.w3.org/1999/xhtml">This allows us to chain the feature mapping. </span><span class="koboSpan" id="kobo.314.3" xmlns="http://www.w3.org/1999/xhtml">In another scenario, we could return the </span><code><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml">group</span></code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml"> object (</span><code><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml">RouteGroupBuilder</span></code><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml"> instance) to let the caller further configure the group. </span><span class="koboSpan" id="kobo.318.2" xmlns="http://www.w3.org/1999/xhtml">What we build is always about the needs and objectives.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml">Finally, the </span><code><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml">SeedBasketsAsync</span></code><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml"> method does nothing; we do not create any shopping cart when starting the program, unlike the </span><code><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml">Products</span></code><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml"> slice:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml">public static Task SeedBasketsAsync(this IServiceScope scope)
{
    return Task.CompletedTask;
}</span></code></pre>
</div>
<blockquote>
<p><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml">We could have omitted the preceding method. </span><span class="koboSpan" id="kobo.325.2" xmlns="http://www.w3.org/1999/xhtml">I left it so we follow a linear pattern between the features. </span><span class="koboSpan" id="kobo.325.3" xmlns="http://www.w3.org/1999/xhtml">Such a linear pattern makes it easier to understand and learn. </span><span class="koboSpan" id="kobo.325.4" xmlns="http://www.w3.org/1999/xhtml">It also allows identifying the recurring pieces we could work on to automate the registration process.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have covered the shared pieces, let’s add data to our shopping basket.</span></p>
<section class="level4" data-number="19.3.3.1" id="additem-feature">
<h4 data-number="19.3.3.1"><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml">AddItem feature</span></h4>
<p><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml">The role of the </span><code><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml">AddItem</span></code><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml"> feature is to create a </span><code><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml">BasketItem</span></code><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml"> object and persist it in the database. </span><span class="koboSpan" id="kobo.332.2" xmlns="http://www.w3.org/1999/xhtml">To achieve this, we leverage the REPR pattern. </span><span class="koboSpan" id="kobo.332.3" xmlns="http://www.w3.org/1999/xhtml">Inspired by the preceding few chapters, we name the request </span><code><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml"> (CQS pattern), add a mapper object using Mapperly, and leverage FluentValidation to ensure the request is valid. </span><span class="koboSpan" id="kobo.334.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the skeleton of the </span><code><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml">AddItem</span></code><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml">using FluentValidation;
using Microsoft.EntityFrameworkCore;
using Riok.Mapperly.Abstractions;
namespace Web.Features;
public partial class Baskets
{
    public partial class AddItem
    {
        public record class Command(
            int CustomerId,
            int ProductId,
            int Quantity
        );
        public record class Response(
            int ProductId,
            int Quantity
        );
        [Mapper]
        public partial class Mapper {}
        public class Validator : AbstractValidator&lt;Command&gt; {}
        public class Handler {}
    }
    public static IServiceCollection AddAddItem(this IServiceCollection services) {}
    public static IEndpointRouteBuilder MapAddItem(this IEndpointRouteBuilder endpoints) {}
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code contains all the necessary pieces of the feature:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml">The request (the </span><code><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml"> class).</span></li>
<li><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml">The response (the </span><code><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml">Response</span></code><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml"> class).</span></li>
<li><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">The endpoint (the </span><code><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml">MapAddItem</span></code><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml"> method pointing the requests to the </span><code><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml"> class).</span></li>
<li><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">A mapper object that has Mapperly generate the mapping code for us.</span></li>
<li><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml">A validator class that ensures the input we receive is valid.</span></li>
<li><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">AddAddItem</span></code><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml"> method registers its services with the IoC container.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start with the </span><code><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml">AddAddItem</span></code><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml"> method that registers the feature’s services:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml">public static IServiceCollection AddAddItem(this IServiceCollection services)
{
    return services
        .AddScoped&lt;AddItem.Handler&gt;()
        .AddSingleton&lt;AddItem.Mapper&gt;()
    ;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml">Then the </span><code><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml">MapAddItem</span></code><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml"> method routes the appropriate POST requests with a valid </span><code><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml"> object in its body to the </span><code><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml">public static IEndpointRouteBuilder MapAddItem(
    this IEndpointRouteBuilder endpoints)
{
    endpoints.MapPost(
        "/",
        async (AddItem.Command command, AddItem.Handler handler, CancellationToken cancellationToken) =&gt;
        {
            var result = await handler.HandleAsync(
                command, 
                cancellationToken
            );
            return TypedResults.Created(
                $"/products/{result.ProductId}", 
                result
            );
        }
    );
    return endpoints;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml"> instance is a copy of the </span><code><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml">BasketItem</span></code><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml"> class, while the response only returns the </span><code><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml">ProductId</span></code><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml">Quantity</span></code><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml"> properties. </span><span class="koboSpan" id="kobo.375.2" xmlns="http://www.w3.org/1999/xhtml">The highlighted lines represent the endpoint handing off the </span><code><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml"> object to the use case </span><code><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml"> class.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml">We could write the </span><code><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml"> code in the delegate, which would make unit testing the delegate very hard.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml"> class is the glue of the feature:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml">public class Handler
{
    private readonly BasketContext _db;
    private readonly Mapper _mapper;
    public Handler(BasketContext db, Mapper mapper)
    {
        _db = db ?? </span><span class="koboSpan" id="kobo.386.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(db));
        _mapper = mapper ?? </span><span class="koboSpan" id="kobo.386.3" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(mapper));
    }
    public async Task&lt;Response&gt; HandleAsync(Command command, CancellationToken cancellationToken)
    {
        var itemExists = await _db.Items.AnyAsync(
            x =&gt; x.CustomerId == command.CustomerId &amp;&amp; x.ProductId == command.ProductId,
            cancellationToken: cancellationToken
        );
        if (itemExists)
        {
            throw new DuplicateBasketItemException(command.ProductId);
        }
        var item = _mapper.Map(command);
        _db.Add(item);
        await _db.SaveChangesAsync(cancellationToken);
        var result = _mapper.Map(item);
        return result;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code contains the business logic of the feature by ensuring the item is not already in the basket. </span><span class="koboSpan" id="kobo.387.2" xmlns="http://www.w3.org/1999/xhtml">If it is, it throws a </span><code><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml">DuplicateBasketItemException</span></code><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.389.2" xmlns="http://www.w3.org/1999/xhtml">Otherwise, it saves the item to the database. </span><span class="koboSpan" id="kobo.389.3" xmlns="http://www.w3.org/1999/xhtml">It then returns a </span><code><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml">Response</span></code><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml"> object.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml">Each customer (</span><code><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml">CustomerId</span></code><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml">) can have each product (</span><code><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">ProductId</span></code><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml">) once in its cart (composite primary key), which is why we test for this condition.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml">The handler leveraged the </span><code><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml">Mapper</span></code><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml">[Mapper]
public partial class Mapper
{
    public partial BasketItem Map(Command item);
    public partial Response Map(BasketItem item);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml">Implicitly, the </span><code><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml">Command</span></code><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml"> object was validated using the following </span><code><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml">Validator</span></code><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml">public class Validator : AbstractValidator&lt;Command&gt;
{
    public Validator()
    {
        RuleFor(x =&gt; x.CustomerId).GreaterThan(0);
        RuleFor(x =&gt; x.ProductId).GreaterThan(0);
        RuleFor(x =&gt; x.Quantity).GreaterThan(0);
    }
}</span></code></pre>
</div>
<blockquote>
<p><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml">As a reminder, in the </span><code><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">Features.cs</span></code><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml"> file, we called the </span><code><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml">AddFluentValidationFilter</span></code><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml"> method on the root route group, letting the </span><code><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidationEndpointFilter</span></code><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml"> class validate the inputs for us using the </span><code><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml">Validator</span></code><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml"> class.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml">With this in place, we can send the following HTTP request:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml">POST https://localhost:7252/baskets
Content-Type: application/json
{
    "customerId": 1, 
    "productId": 3, 
    "quantity": 10
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">The endpoint responds with the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">{
  "productId": 3,
  "quantity": 10
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml">And has the following HTTP header:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml">Location: /products/3</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">To recap, here’s what happens:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml">ASP.NET Core routes the request to the delegate we registered in the </span><code><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml">MapAddItem</span></code><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml"> method.</span></li>
<li><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml">The validation middle runs an </span><code><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml">AddItem.Validator</span></code><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml"> object against the </span><code><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml">AddItem.Command</span></code><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml"> sent to the endpoint. </span><span class="koboSpan" id="kobo.430.2" xmlns="http://www.w3.org/1999/xhtml">The request is valid.</span></li>
<li><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml">HandleAsync</span></code><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml"> method of the </span><code><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml">AddItem.Handler</span></code><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml"> class is executed.</span></li>
<li><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml">Assuming the item is not already in the customer’s basket, it is added to the database.</span></li>
<li><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml">HandleAsync</span></code><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml"> method returns a </span><code><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml">Response</span></code><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml"> object to the delegate.</span></li>
<li><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml">The delegate returns a </span><code><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml">201 Create</span></code><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml"> status code with the </span><code><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">Location</span></code><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml"> header set to the URL of the product that got added.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml">As the preceding list depicts, the process is quite simple; a request gets in, the business logic is executed (endpoint), then a response goes out: REPR.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml">There are a few more pieces, but they save us the trouble of object mapping and validation. </span><span class="koboSpan" id="kobo.448.2" xmlns="http://www.w3.org/1999/xhtml">Those pieces are optional; you can conceive your own stack with more or less pieces in it.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">On top of the feature code, we also have a few tests to assess that the business logic remains correct over time. </span><span class="koboSpan" id="kobo.449.2" xmlns="http://www.w3.org/1999/xhtml">We cover those under the </span><em><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml">Grey-box testing</span></em><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml"> section. </span><span class="koboSpan" id="kobo.451.2" xmlns="http://www.w3.org/1999/xhtml">Meanwhile, let’s look at the </span><code><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml">FetchItems</span></code><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml"> feature.</span></p>
</section>
<section class="level4" data-number="19.3.3.2" id="fetchitems-feature">
<h4 data-number="19.3.3.2"><span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml">FetchItems feature</span></h4>
<p><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml">Now that we know the pattern, this feature should be faster to cover. </span><span class="koboSpan" id="kobo.455.2" xmlns="http://www.w3.org/1999/xhtml">It allows a client to retrieve the shopping basket of the specified customer using the following request:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml">public record class Query(int CustomerId);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml">The client expects a collection of items in the response:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml">public record class Response(IEnumerable&lt;Item&gt; Items) : IEnumerable&lt;Item&gt;
{
    public IEnumerator&lt;Item&gt; GetEnumerator()
        =&gt; Items.GetEnumerator();
    IEnumerator IEnumerable.GetEnumerator()
        =&gt; ((IEnumerable)Items).GetEnumerator();
}
public record class Item(int ProductId, int Quantity);</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml">Since the client knows about the customer, it does not need the endpoint to return the </span><code><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml">CustomerId</span></code><span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml"> property, which is why the </span><code><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">Item</span></code><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml"> class only has two of the </span><code><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml">BasketItem</span></code><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml"> properties.Here are the </span><code><span class="koboSpan" id="kobo.466.1" xmlns="http://www.w3.org/1999/xhtml">Mapper</span></code><span class="koboSpan" id="kobo.467.1" xmlns="http://www.w3.org/1999/xhtml"> and the </span><code><span class="koboSpan" id="kobo.468.1" xmlns="http://www.w3.org/1999/xhtml">Validator</span></code><span class="koboSpan" id="kobo.469.1" xmlns="http://www.w3.org/1999/xhtml"> classes, which should be self-explanatory at this point:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.470.1" xmlns="http://www.w3.org/1999/xhtml">[Mapper]
public partial class Mapper
{
    public partial Response Map(IQueryable&lt;BasketItem&gt; items);
}
public class Validator : AbstractValidator&lt;Query&gt;
{
    public Validator()
    {
        RuleFor(x =&gt; x.CustomerId).GreaterThan(0);
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.471.1" xmlns="http://www.w3.org/1999/xhtml">Then, a last piece of plumbing is the </span><code><span class="koboSpan" id="kobo.472.1" xmlns="http://www.w3.org/1999/xhtml">AddFetchItems</span></code><span class="koboSpan" id="kobo.473.1" xmlns="http://www.w3.org/1999/xhtml"> method which registers the feature’s services with the containers:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.474.1" xmlns="http://www.w3.org/1999/xhtml">public static IServiceCollection AddFetchItems(this IServiceCollection services)
{
    return services
        .AddScoped&lt;FetchItems.Handler&gt;()
        .AddSingleton&lt;FetchItems.Mapper&gt;()
    ;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.475.1" xmlns="http://www.w3.org/1999/xhtml">Now to the endpoint itself, forwarding the </span><code><span class="koboSpan" id="kobo.476.1" xmlns="http://www.w3.org/1999/xhtml">FetchItems.Query</span></code><span class="koboSpan" id="kobo.477.1" xmlns="http://www.w3.org/1999/xhtml"> object to a </span><code><span class="koboSpan" id="kobo.478.1" xmlns="http://www.w3.org/1999/xhtml">FetchItems.Handler</span></code><span class="koboSpan" id="kobo.479.1" xmlns="http://www.w3.org/1999/xhtml"> instance:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.480.1" xmlns="http://www.w3.org/1999/xhtml">public static IEndpointRouteBuilder MapFetchItems(this IEndpointRouteBuilder endpoints)
{
    endpoints.MapGet(
        "/{CustomerId}",
        ([AsParameters] FetchItems.Query query, FetchItems.Handler handler, CancellationToken cancellationToken)
            =&gt; handler.HandleAsync(query, cancellationToken)
    );
    return endpoints;
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.481.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code is simpler than the </span><code><span class="koboSpan" id="kobo.482.1" xmlns="http://www.w3.org/1999/xhtml">AddItem</span></code><span class="koboSpan" id="kobo.483.1" xmlns="http://www.w3.org/1999/xhtml"> feature because it serializes the handler’s response directly as a 200 OK status code without transforming it.Finally, the </span><code><span class="koboSpan" id="kobo.484.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.485.1" xmlns="http://www.w3.org/1999/xhtml"> class itself:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.486.1" xmlns="http://www.w3.org/1999/xhtml">public class Handler
{
    private readonly BasketContext _db;
    private readonly Mapper _mapper;
    public Handler(BasketContext db, Mapper mapper)
    {
        _db = db ?? </span><span class="koboSpan" id="kobo.486.2" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(db));
        _mapper = mapper ?? </span><span class="koboSpan" id="kobo.486.3" xmlns="http://www.w3.org/1999/xhtml">throw new ArgumentNullException(nameof(mapper));
    }
    public async Task&lt;Response&gt; HandleAsync(Query query, CancellationToken cancellationToken)
    {
        var items = _db.Items.Where(x =&gt; x.CustomerId == query.CustomerId);
        await items.LoadAsync(cancellationToken);
        var result = _mapper.Map(items);
        return result;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.487.1" xmlns="http://www.w3.org/1999/xhtml">The preceding code loads all the items associated with the specified customer from the database and returns them. </span><span class="koboSpan" id="kobo.487.2" xmlns="http://www.w3.org/1999/xhtml">If there are no items, the client receives an empty array.That’s it; we can now send the following HTTP request and hit the endpoint:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.488.1" xmlns="http://www.w3.org/1999/xhtml">GET https://localhost:7252/baskets/1</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.489.1" xmlns="http://www.w3.org/1999/xhtml">Assuming we added an item to the basket, we should receive a response similar to the following:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.490.1" xmlns="http://www.w3.org/1999/xhtml">[
  {
    "productId": 3,
    "quantity": 10
  }
]</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.491.1" xmlns="http://www.w3.org/1999/xhtml">We now have a working shopping basket!</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.492.1" xmlns="http://www.w3.org/1999/xhtml">You can explore the other features in the codebase available on GitHub (</span><a href="https://adpg.link/ikAn"><span class="koboSpan" id="kobo.493.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/ikAn</span></a><span class="koboSpan" id="kobo.494.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.494.2" xmlns="http://www.w3.org/1999/xhtml">All features have tests and are functional.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.495.1" xmlns="http://www.w3.org/1999/xhtml">Next, we look at exception handling.</span></p>
</section>
</section>
<section class="level3" data-number="19.3.4" id="managing-exception-handling">
<h3 data-number="19.3.4"><span class="koboSpan" id="kobo.496.1" xmlns="http://www.w3.org/1999/xhtml">Managing exception handling</span></h3>
<p><span class="koboSpan" id="kobo.497.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.498.1" xmlns="http://www.w3.org/1999/xhtml">AddItem</span></code><span class="koboSpan" id="kobo.499.1" xmlns="http://www.w3.org/1999/xhtml"> feature throws a </span><code><span class="koboSpan" id="kobo.500.1" xmlns="http://www.w3.org/1999/xhtml">DuplicateBasketItemException</span></code><span class="koboSpan" id="kobo.501.1" xmlns="http://www.w3.org/1999/xhtml"> when the product is already in the basket. </span><span class="koboSpan" id="kobo.501.2" xmlns="http://www.w3.org/1999/xhtml">However, when that happens, the server returns an error that resembles the following (partial output):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.502.1" xmlns="http://www.w3.org/1999/xhtml">Web.Features.DuplicateBasketItemException: The product '3' is already in your shopping cart.
   </span><span class="koboSpan" id="kobo.502.2" xmlns="http://www.w3.org/1999/xhtml">at Web.Features.Baskets.AddItem.Handler.HandleAsync(Command command, CancellationToken cancellationToken) in C18\REPR\Web\Features\Baskets\Baskets.AddItem.cs:line 57
   at Web.Features.Baskets.&lt;&gt;c.&lt;&lt;MapAddItem&gt;b__2_0&gt;d.MoveNext() in C18\REPR\Web\Features\Baskets\Baskets.AddItem.cs:line 82
--- End of stack trace from previous location ---</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.503.1" xmlns="http://www.w3.org/1999/xhtml">That error is ugly and impractical for a client calling the API. </span><span class="koboSpan" id="kobo.503.2" xmlns="http://www.w3.org/1999/xhtml">To circumvent this, we can add a try-catch somewhere and treat each exception individually, or we can use a middleware to catch the exceptions and normalize their output.Managing exceptions one by one is tedious and error-prone. </span><span class="koboSpan" id="kobo.503.3" xmlns="http://www.w3.org/1999/xhtml">On the other hand, centralizing exception management and treating them as a cross-cutting concern transforms the tedious mechanism into a new tool to leverage. </span><span class="koboSpan" id="kobo.503.4" xmlns="http://www.w3.org/1999/xhtml">Moreover, it ensures that the API always returns the errors in the same format with no additional effort.Let’s program a basic middleware.</span></p>
<section class="level4" data-number="19.3.4.1" id="creating-an-exception-handler-middleware">
<h4 data-number="19.3.4.1"><span class="koboSpan" id="kobo.504.1" xmlns="http://www.w3.org/1999/xhtml">Creating an exception handler middleware</span></h4>
<p><span class="koboSpan" id="kobo.505.1" xmlns="http://www.w3.org/1999/xhtml">A middleware in ASP.NET Core is executed as part of the pipeline and can run before and after the execution of an endpoint.When an exception occurs, the request is re-executed in a parallel pipeline, allowing different middleware to manage the error flow.To create a middleware, we must implement an </span><code><span class="koboSpan" id="kobo.506.1" xmlns="http://www.w3.org/1999/xhtml">InvokeAsync</span></code><span class="koboSpan" id="kobo.507.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.507.2" xmlns="http://www.w3.org/1999/xhtml">The easiest way to do this is by implementing the </span><code><span class="koboSpan" id="kobo.508.1" xmlns="http://www.w3.org/1999/xhtml">IMiddleware</span></code><span class="koboSpan" id="kobo.509.1" xmlns="http://www.w3.org/1999/xhtml"> interface. </span><span class="koboSpan" id="kobo.509.2" xmlns="http://www.w3.org/1999/xhtml">You can add middleware types to the default or exception-handling alternate pipelines.The following code represents a basic exception-handling middleware:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.510.1" xmlns="http://www.w3.org/1999/xhtml">using Microsoft.AspNetCore.Diagnostics;
namespace Web;
public class MyExceptionMiddleware : IMiddleware
{
    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        var exceptionHandlerPathFeature = context.Features
            .Get&lt;IExceptionHandlerFeature&gt;() ?? </span><span class="koboSpan" id="kobo.510.2" xmlns="http://www.w3.org/1999/xhtml">throw new NotSupportedException();
        var exception = exceptionHandlerPathFeature.Error;
        await context.Response.WriteAsJsonAsync(new
        {
            Error = exception.Message
        });
        await next(context);
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.511.1" xmlns="http://www.w3.org/1999/xhtml">The middleware fetches the </span><code><span class="koboSpan" id="kobo.512.1" xmlns="http://www.w3.org/1999/xhtml">IExceptionHandlerFeature</span></code><span class="koboSpan" id="kobo.513.1" xmlns="http://www.w3.org/1999/xhtml"> to access the error and outputs an object containing the error message (ASP.NET Core manages this feature). </span><span class="koboSpan" id="kobo.513.2" xmlns="http://www.w3.org/1999/xhtml">If the feature is unavailable, the middleware throws a </span><code><span class="koboSpan" id="kobo.514.1" xmlns="http://www.w3.org/1999/xhtml">NotSupportedException</span></code><span class="koboSpan" id="kobo.515.1" xmlns="http://www.w3.org/1999/xhtml">, which rethrows the original exception.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.516.1" xmlns="http://www.w3.org/1999/xhtml">Any type of exception a middleware of the alternate pipeline throws will rethrow the original exception.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.517.1" xmlns="http://www.w3.org/1999/xhtml">If any, the highlighted code executes the next middleware in the pipeline. </span><span class="koboSpan" id="kobo.517.2" xmlns="http://www.w3.org/1999/xhtml">These pipelines are like a chain of responsibilities but with a different objective.To register the middleware, we must first add it to the container:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.518.1" xmlns="http://www.w3.org/1999/xhtml">builder.Services.AddSingleton&lt;MyExceptionMiddleware&gt;();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.519.1" xmlns="http://www.w3.org/1999/xhtml">Then, we must register it as part of the exception-handling alternate pipeline:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.520.1" xmlns="http://www.w3.org/1999/xhtml">app.UseExceptionHandler(errorApp =&gt;
{
    errorApp.UseMiddleware&lt;MyExceptionMiddleware&gt;();
});</span></code></pre>
</div>
<blockquote>
<p><span class="koboSpan" id="kobo.521.1" xmlns="http://www.w3.org/1999/xhtml">We could also register more middleware or create them inline, like this:</span></p>
</blockquote>
<pre><code><span class="koboSpan" id="kobo.522.1" xmlns="http://www.w3.org/1999/xhtml">app.UseExceptionHandler(errorApp =&gt;
{
    errorApp.Use(async (context, next) =&gt;
    {
        var exceptionHandlerPathFeature = context.Features
            .Get&lt;IExceptionHandlerFeature&gt;() ?? </span><span class="koboSpan" id="kobo.522.2" xmlns="http://www.w3.org/1999/xhtml">throw new NotSupportedException();
        var logger = context.RequestServices
            .GetRequiredService&lt;ILoggerFactory&gt;()
            .CreateLogger("ExceptionHandler");
        var exception = exceptionHandlerPathFeature.Error;
        logger.LogWarning(
            "An exception occurred: {message}",
            exception.Message
        );
        await next(context);
    });
    errorApp.UseMiddleware&lt;MyExceptionMiddleware&gt;();
});</span></code></pre>
<blockquote>
<p><span class="koboSpan" id="kobo.523.1" xmlns="http://www.w3.org/1999/xhtml">The possibilities are vast.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.524.1" xmlns="http://www.w3.org/1999/xhtml">Now, if we try to add a duplicated item to the basket, we get a </span><em><span class="koboSpan" id="kobo.525.1" xmlns="http://www.w3.org/1999/xhtml">500 Internal Server Error</span></em><span class="koboSpan" id="kobo.526.1" xmlns="http://www.w3.org/1999/xhtml"> with the following body:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.527.1" xmlns="http://www.w3.org/1999/xhtml">{
  "error": "The product \u00273\u0027 is already in your shopping cart."
</span><span class="koboSpan" id="kobo.527.2" xmlns="http://www.w3.org/1999/xhtml">}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.528.1" xmlns="http://www.w3.org/1999/xhtml">This response is more elegant than before and easier to handle for the clients. </span><span class="koboSpan" id="kobo.528.2" xmlns="http://www.w3.org/1999/xhtml">We could also alter the status code in the middleware. </span><span class="koboSpan" id="kobo.528.3" xmlns="http://www.w3.org/1999/xhtml">However, customizing this middleware would take many pages, so we leverage an existing library instead.</span></p>
</section>
<section class="level4" data-number="19.3.4.2" id="exception-handling-using-exceptionmapper">
<h4 data-number="19.3.4.2"><span class="koboSpan" id="kobo.529.1" xmlns="http://www.w3.org/1999/xhtml">Exception handling using ExceptionMapper</span></h4>
<p><span class="koboSpan" id="kobo.530.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.531.1" xmlns="http://www.w3.org/1999/xhtml">ForEvolve.ExceptionMapper</span></code><span class="koboSpan" id="kobo.532.1" xmlns="http://www.w3.org/1999/xhtml"> package is an ASP.NET Core middleware that allows us to map exceptions to different status codes. </span><span class="koboSpan" id="kobo.532.2" xmlns="http://www.w3.org/1999/xhtml">Out-of-the-box, it offers many exception types to get started, handles them, and allows easy mapping between a custom exception and a status code. </span><span class="koboSpan" id="kobo.532.3" xmlns="http://www.w3.org/1999/xhtml">By default, the library serializes the exceptions to a </span><code><span class="koboSpan" id="kobo.533.1" xmlns="http://www.w3.org/1999/xhtml">ProblemDetails</span></code><span class="koboSpan" id="kobo.534.1" xmlns="http://www.w3.org/1999/xhtml"> object (based on RFC 7807) by leveraging as many ASP.NET Core components as possible, so we can customize parts of the library by customizing ASP.NET Core.To get started, in the </span><code><span class="koboSpan" id="kobo.535.1" xmlns="http://www.w3.org/1999/xhtml">Program.cs</span></code><span class="koboSpan" id="kobo.536.1" xmlns="http://www.w3.org/1999/xhtml"> file, we must add the following lines:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.537.1" xmlns="http://www.w3.org/1999/xhtml">// Add the dependencies to the container
builder.AddExceptionMapper();
// Register the middleware
app.UseExceptionMapper();</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.538.1" xmlns="http://www.w3.org/1999/xhtml">Now, if we try to add a duplicated product to the basket, we receive a response with a </span><em><span class="koboSpan" id="kobo.539.1" xmlns="http://www.w3.org/1999/xhtml">409 Conflict</span></em><span class="koboSpan" id="kobo.540.1" xmlns="http://www.w3.org/1999/xhtml"> status code with the following body:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.541.1" xmlns="http://www.w3.org/1999/xhtml">{
  "type": "https://tools.ietf.org/html/rfc9110#section-15.5.10",
  "title": "The product \u00273\u0027 is already in your shopping cart.",
  "status": 409,
  "traceId": "00-74bdbaa08064fd97ba1de31802ec6f8f-31ffd9ea8215b706-00",
  "debug": {
    "type": {
      "name": "DuplicateBasketItemException",
      "fullName": "Web.Features.DuplicateBasketItemException"
    },
    "stackTrace": "..."
  </span><span class="koboSpan" id="kobo.541.2" xmlns="http://www.w3.org/1999/xhtml">}
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.542.1" xmlns="http://www.w3.org/1999/xhtml">This output is starting to look like something!</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.543.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.544.1" xmlns="http://www.w3.org/1999/xhtml">debug</span></code><span class="koboSpan" id="kobo.545.1" xmlns="http://www.w3.org/1999/xhtml"> object (highlighted) only appears in development or as an opt-in option.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.546.1" xmlns="http://www.w3.org/1999/xhtml">How can the middleware know it’s a 409 Conflict and not a 500 Internal Server Error? </span><span class="koboSpan" id="kobo.546.2" xmlns="http://www.w3.org/1999/xhtml">Simple! </span><span class="koboSpan" id="kobo.546.3" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.547.1" xmlns="http://www.w3.org/1999/xhtml">DuplicateBasketItemException</span></code><span class="koboSpan" id="kobo.548.1" xmlns="http://www.w3.org/1999/xhtml"> inherits from the </span><code><span class="koboSpan" id="kobo.549.1" xmlns="http://www.w3.org/1999/xhtml">ConflictException</span></code><span class="koboSpan" id="kobo.550.1" xmlns="http://www.w3.org/1999/xhtml"> that comes from the </span><code><span class="koboSpan" id="kobo.551.1" xmlns="http://www.w3.org/1999/xhtml">ForEvolve.ExceptionMapper</span></code><span class="koboSpan" id="kobo.552.1" xmlns="http://www.w3.org/1999/xhtml"> namespace (highlighted):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.553.1" xmlns="http://www.w3.org/1999/xhtml">using ForEvolve.ExceptionMapper;
namespace Web.Features;
public class DuplicateBasketItemException : ConflictException
{
    public DuplicateBasketItemException(int productId)
        : base($"The product '{productId}' is already in your shopping cart.")
    {
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.554.1" xmlns="http://www.w3.org/1999/xhtml">With this setup, we can leverage exceptions to return errors with different status codes.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.555.1" xmlns="http://www.w3.org/1999/xhtml">I have used this methodology for many years, and it simplifies the program structure and developers' lives. </span><span class="koboSpan" id="kobo.555.2" xmlns="http://www.w3.org/1999/xhtml">The idea is to harness the power and simplicity of exceptions.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.556.1" xmlns="http://www.w3.org/1999/xhtml">For example, we may want to map EF Core errors, </span><code><span class="koboSpan" id="kobo.557.1" xmlns="http://www.w3.org/1999/xhtml">DbUpdateException</span></code><span class="koboSpan" id="kobo.558.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.559.1" xmlns="http://www.w3.org/1999/xhtml">DbUpdateConcurrencyException</span></code><span class="koboSpan" id="kobo.560.1" xmlns="http://www.w3.org/1999/xhtml">, to a </span><em><span class="koboSpan" id="kobo.561.1" xmlns="http://www.w3.org/1999/xhtml">409 Conflict</span></em><span class="koboSpan" id="kobo.562.1" xmlns="http://www.w3.org/1999/xhtml"> as well, so in case we forget to catch a database error, the middleware will do it for us. </span><span class="koboSpan" id="kobo.562.2" xmlns="http://www.w3.org/1999/xhtml">To achieve this, we can customize the middleware this way:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.563.1" xmlns="http://www.w3.org/1999/xhtml">builder.AddExceptionMapper(builder =&gt;
{
    builder
        .Map&lt;DbUpdateException&gt;()
        .ToStatusCode(StatusCodes.Status409Conflict)
    ;
    builder
        .Map&lt;DbUpdateConcurrencyException&gt;()
        .ToStatusCode(StatusCodes.Status409Conflict)
    ;
});</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.564.1" xmlns="http://www.w3.org/1999/xhtml">With that in place, if a client hits an unhandled EF Core exception, the server will respond with something like the following (I omitted the stack trace for brevity reasons):</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.565.1" xmlns="http://www.w3.org/1999/xhtml">{
  "type": "https://tools.ietf.org/html/rfc9110#section-15.5.10",
  "title": "Exception of type \u0027Microsoft.EntityFrameworkCore.DbUpdateException\u0027 was thrown.",
  "status": 409,
  "traceId": "00-74bdbaa08064fd97ba1de31802ec6f8f-a5ac17f17da8d2db-00",
  "debug": {
    "type": {
      "name": "DbUpdateException",
      "fullName": "Microsoft.EntityFrameworkCore.DbUpdateException"
    },
    "stackTrace": "..."
  </span><span class="koboSpan" id="kobo.565.2" xmlns="http://www.w3.org/1999/xhtml">},
  "entries": []
}</span></code></pre>
</div>
<blockquote>
<p><span class="koboSpan" id="kobo.566.1" xmlns="http://www.w3.org/1999/xhtml">In an actual project, for security reasons, I recommend customizing the error handling further to hide the fact that we are using EF Core. </span><span class="koboSpan" id="kobo.566.2" xmlns="http://www.w3.org/1999/xhtml">We must give as little information as possible about our systems to malicious actors to keep them as secure and safe as possible. </span><span class="koboSpan" id="kobo.566.3" xmlns="http://www.w3.org/1999/xhtml">We won’t cover creating custom exception handlers here because it is out of the scope of the chapter.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.567.1" xmlns="http://www.w3.org/1999/xhtml">As we can see, it is easy to register custom exceptions and associate them with a status code. </span><span class="koboSpan" id="kobo.567.2" xmlns="http://www.w3.org/1999/xhtml">We can do this with any custom exception or inherit from an existing one to make it work with customization.As of version 3.0.29, </span><em><span class="koboSpan" id="kobo.568.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper</span></em><span class="koboSpan" id="kobo.569.1" xmlns="http://www.w3.org/1999/xhtml"> offers the following custom exception associations:</span></p>
<table>
<tbody>
<tr class="odd">
<td><span class="koboSpan" id="kobo.570.1" xmlns="http://www.w3.org/1999/xhtml">Exception Type</span></td>
<td><span class="koboSpan" id="kobo.571.1" xmlns="http://www.w3.org/1999/xhtml">Status Code</span></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.572.1" xmlns="http://www.w3.org/1999/xhtml">BadRequestException</span></code></td>
<td><code><span class="koboSpan" id="kobo.573.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status400BadRequest</span></code></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.574.1" xmlns="http://www.w3.org/1999/xhtml">ConflictException</span></code></td>
<td><code><span class="koboSpan" id="kobo.575.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status409Conflict</span></code></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.576.1" xmlns="http://www.w3.org/1999/xhtml">ForbiddenException</span></code></td>
<td><code><span class="koboSpan" id="kobo.577.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status403Forbidden</span></code></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.578.1" xmlns="http://www.w3.org/1999/xhtml">GoneException</span></code></td>
<td><code><span class="koboSpan" id="kobo.579.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status410Gone</span></code></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.580.1" xmlns="http://www.w3.org/1999/xhtml">NotFoundException</span></code></td>
<td><code><span class="koboSpan" id="kobo.581.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status404NotFound</span></code></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.582.1" xmlns="http://www.w3.org/1999/xhtml">ResourceNotFoundException</span></code></td>
<td><code><span class="koboSpan" id="kobo.583.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status404NotFound</span></code></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.584.1" xmlns="http://www.w3.org/1999/xhtml">UnauthorizedException</span></code></td>
<td><code><span class="koboSpan" id="kobo.585.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status401Unauthorized</span></code></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.586.1" xmlns="http://www.w3.org/1999/xhtml">GatewayTimeoutException</span></code></td>
<td><code><span class="koboSpan" id="kobo.587.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status504GatewayTimeout</span></code></td>
</tr>
<tr class="even">
<td><code><span class="koboSpan" id="kobo.588.1" xmlns="http://www.w3.org/1999/xhtml">InternalServerErrorException</span></code></td>
<td><code><span class="koboSpan" id="kobo.589.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status500InternalServerError</span></code></td>
</tr>
<tr class="odd">
<td><code><span class="koboSpan" id="kobo.590.1" xmlns="http://www.w3.org/1999/xhtml">ServiceUnavailableException</span></code></td>
<td><code><span class="koboSpan" id="kobo.591.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status503ServiceUnavailable</span></code></td>
</tr>
</tbody>
</table><span class="koboSpan" id="kobo.592.1" xmlns="http://www.w3.org/1999/xhtml">
Table 18.1: ExceptionMapper custom exception associations.
</span><p><span class="koboSpan" id="kobo.593.1" xmlns="http://www.w3.org/1999/xhtml">You can inherit from those standard exceptions, and the middleware will associate them with the correct status code as we did with the </span><code><span class="koboSpan" id="kobo.594.1" xmlns="http://www.w3.org/1999/xhtml">DuplicateBasketItemException</span></code><span class="koboSpan" id="kobo.595.1" xmlns="http://www.w3.org/1999/xhtml"> class.</span><em><span class="koboSpan" id="kobo.596.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper</span></em><span class="koboSpan" id="kobo.597.1" xmlns="http://www.w3.org/1999/xhtml"> also maps the following .NET exceptions automatically:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.598.1" xmlns="http://www.w3.org/1999/xhtml">BadHttpRequestException</span></code><span class="koboSpan" id="kobo.599.1" xmlns="http://www.w3.org/1999/xhtml"> to </span><code><span class="koboSpan" id="kobo.600.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status400BadRequest</span></code></li>
<li><code><span class="koboSpan" id="kobo.601.1" xmlns="http://www.w3.org/1999/xhtml">NotImplementedException</span></code><span class="koboSpan" id="kobo.602.1" xmlns="http://www.w3.org/1999/xhtml"> to </span><code><span class="koboSpan" id="kobo.603.1" xmlns="http://www.w3.org/1999/xhtml">StatusCodes.Status501NotImplemented</span></code></li>
</ul>
<p><span class="koboSpan" id="kobo.604.1" xmlns="http://www.w3.org/1999/xhtml">In the project, there are three custom exceptions that you can find on GitHub:</span></p>
<ul>
<li><code><span class="koboSpan" id="kobo.605.1" xmlns="http://www.w3.org/1999/xhtml">BasketItemNotFoundException</span></code><span class="koboSpan" id="kobo.606.1" xmlns="http://www.w3.org/1999/xhtml"> that inherits from </span><code><span class="koboSpan" id="kobo.607.1" xmlns="http://www.w3.org/1999/xhtml">NotFoundException</span></code></li>
<li><code><span class="koboSpan" id="kobo.608.1" xmlns="http://www.w3.org/1999/xhtml">DuplicateBasketItemException</span></code><span class="koboSpan" id="kobo.609.1" xmlns="http://www.w3.org/1999/xhtml"> that inherits from </span><code><span class="koboSpan" id="kobo.610.1" xmlns="http://www.w3.org/1999/xhtml">ConflictException</span></code></li>
<li><code><span class="koboSpan" id="kobo.611.1" xmlns="http://www.w3.org/1999/xhtml">ProductNotFoundException</span></code><span class="koboSpan" id="kobo.612.1" xmlns="http://www.w3.org/1999/xhtml"> that inherits from </span><code><span class="koboSpan" id="kobo.613.1" xmlns="http://www.w3.org/1999/xhtml">NotFoundException</span></code></li>
</ul>
<p><span class="koboSpan" id="kobo.614.1" xmlns="http://www.w3.org/1999/xhtml">Next, we explore this way of thinking about error propagation a little more.</span></p>
</section>
<section class="level4" data-number="19.3.4.3" id="leveraging-exceptions-to-propagate-errors">
<h4 data-number="19.3.4.3"><span class="koboSpan" id="kobo.615.1" xmlns="http://www.w3.org/1999/xhtml">Leveraging exceptions to propagate errors</span></h4>
<p><span class="koboSpan" id="kobo.616.1" xmlns="http://www.w3.org/1999/xhtml">With the middleware of </span><em><span class="koboSpan" id="kobo.617.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper</span></em><span class="koboSpan" id="kobo.618.1" xmlns="http://www.w3.org/1999/xhtml"> in place, we can treat exceptions as a simple tool to propagate errors to the clients. </span><span class="koboSpan" id="kobo.618.2" xmlns="http://www.w3.org/1999/xhtml">We can throw an existing exception, like a </span><code><span class="koboSpan" id="kobo.619.1" xmlns="http://www.w3.org/1999/xhtml">NotFoundException</span></code><span class="koboSpan" id="kobo.620.1" xmlns="http://www.w3.org/1999/xhtml">, or create a custom reusable one with a more precise preconfigured error message.When we want the server to return a specific error, all we must do is:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.621.1" xmlns="http://www.w3.org/1999/xhtml">Create a new exception type.</span></li>
<li><span class="koboSpan" id="kobo.622.1" xmlns="http://www.w3.org/1999/xhtml">Inherit from an existing type from </span><em><span class="koboSpan" id="kobo.623.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper</span></em><span class="koboSpan" id="kobo.624.1" xmlns="http://www.w3.org/1999/xhtml"> or register our custom exception with the middleware.</span></li>
<li><span class="koboSpan" id="kobo.625.1" xmlns="http://www.w3.org/1999/xhtml">Throw our custom exception anywhere in the REPR flow.</span></li>
<li><span class="koboSpan" id="kobo.626.1" xmlns="http://www.w3.org/1999/xhtml">Let the middleware do its job.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.627.1" xmlns="http://www.w3.org/1999/xhtml">Here’s a simplified representation of this flow, using the </span><code><span class="koboSpan" id="kobo.628.1" xmlns="http://www.w3.org/1999/xhtml">AddItem</span></code><span class="koboSpan" id="kobo.629.1" xmlns="http://www.w3.org/1999/xhtml"> endpoint as an example:</span></p>
<figure>
<span class="koboSpan" id="kobo.630.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 18.6: a simplified view of an exception flow using ExceptionMapper." src="../media/file126.png"/></span><figcaption aria-hidden="true"><span class="koboSpan" id="kobo.631.1" xmlns="http://www.w3.org/1999/xhtml">Figure 18.6: a simplified view of an exception flow using ExceptionMapper.</span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.632.1" xmlns="http://www.w3.org/1999/xhtml">With this in place, we have a simple way to return errors to the clients from anywhere in the REPR flow. </span><span class="koboSpan" id="kobo.632.2" xmlns="http://www.w3.org/1999/xhtml">Moreover, our errors are consistently formatted the same way.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.633.1" xmlns="http://www.w3.org/1999/xhtml">The exception handling pattern and the </span><em><span class="koboSpan" id="kobo.634.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper</span></em><span class="koboSpan" id="kobo.635.1" xmlns="http://www.w3.org/1999/xhtml"> library also work with MVC and allow customizing the error formatting process.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.636.1" xmlns="http://www.w3.org/1999/xhtml">Next, let’s explore a few test cases.</span></p>
</section>
</section>
<section class="level3" data-number="19.3.5" id="grey-box-testing-1">
<h3 data-number="19.3.5"><span class="koboSpan" id="kobo.637.1" xmlns="http://www.w3.org/1999/xhtml">Grey-box testing</span></h3>
<p><span class="koboSpan" id="kobo.638.1" xmlns="http://www.w3.org/1999/xhtml">Using Vertical Slice Architecture or REPR makes writing grey-box tests very convenient. </span><span class="koboSpan" id="kobo.638.2" xmlns="http://www.w3.org/1999/xhtml">The test project mainly comprises integration tests that use the grey-box philosophy. </span><span class="koboSpan" id="kobo.638.3" xmlns="http://www.w3.org/1999/xhtml">Since we know the application under test's inner workings, we can manipulate the data from the EF Core </span><code><span class="koboSpan" id="kobo.639.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.640.1" xmlns="http://www.w3.org/1999/xhtml"> objects, which allows us to write almost end-to-end tests very quickly. </span><span class="koboSpan" id="kobo.640.2" xmlns="http://www.w3.org/1999/xhtml">The confidence level we get from those tests is very high because they test the whole stack, including HTTP, not just some scattered pieces, leading to a very high level of code coverage per test case. </span><span class="koboSpan" id="kobo.640.3" xmlns="http://www.w3.org/1999/xhtml">Of course, integration tests are slower, yet not that slow. </span><span class="koboSpan" id="kobo.640.4" xmlns="http://www.w3.org/1999/xhtml">It is up to you to create the right balance of unit and integration tests. </span><span class="koboSpan" id="kobo.640.5" xmlns="http://www.w3.org/1999/xhtml">In this case, I focused on grey-box integration testing, which led to 13 tests covering 97.2% of the lines and 63.1% of the branches. </span><span class="koboSpan" id="kobo.640.6" xmlns="http://www.w3.org/1999/xhtml">The guard clauses represent most of the branches that we do not test. </span><span class="koboSpan" id="kobo.640.7" xmlns="http://www.w3.org/1999/xhtml">We could write a few unit tests to boost the numbers if we’d like.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.641.1" xmlns="http://www.w3.org/1999/xhtml">We explored white-, grey- and black-box testing in </span><em><span class="koboSpan" id="kobo.642.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 2</span></em><span class="koboSpan" id="kobo.643.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.644.1" xmlns="http://www.w3.org/1999/xhtml">Automated Testing</span></em><span class="koboSpan" id="kobo.645.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.646.1" xmlns="http://www.w3.org/1999/xhtml">Let’s start by exploring the AddItem tests.</span></p>
<section class="level4" data-number="19.3.5.1" id="additemtest">
<h4 data-number="19.3.5.1"><span class="koboSpan" id="kobo.647.1" xmlns="http://www.w3.org/1999/xhtml">AddItemTest</span></h4>
<p><span class="koboSpan" id="kobo.648.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.649.1" xmlns="http://www.w3.org/1999/xhtml">AddItem</span></code><span class="koboSpan" id="kobo.650.1" xmlns="http://www.w3.org/1999/xhtml"> feature is the first use case we explored. </span><span class="koboSpan" id="kobo.650.2" xmlns="http://www.w3.org/1999/xhtml">We need three tests to cover all scenarios but the </span><code><span class="koboSpan" id="kobo.651.1" xmlns="http://www.w3.org/1999/xhtml">Handler</span></code><span class="koboSpan" id="kobo.652.1" xmlns="http://www.w3.org/1999/xhtml"> class guard clauses.</span></p>
<section class="level5" data-number="19.3.5.1.1" id="first-test-method">
<h5 data-number="19.3.5.1.1"><span class="koboSpan" id="kobo.653.1" xmlns="http://www.w3.org/1999/xhtml">First test method</span></h5>
<p><span class="koboSpan" id="kobo.654.1" xmlns="http://www.w3.org/1999/xhtml">The following grey-box integration test ensures an HTTP POST request adds the item to the database:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.655.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public async Task Should_add_the_new_item_to_the_basket()
{
    // Arrange
    await using var application = new C18WebApplication();
    var client = application.CreateClient();
    // Act
    var response = await client.PostAsJsonAsync(
        "/baskets",
        new AddItem.Command(4, 1, 22)
    );
    // Assert the response
    Assert.NotNull(response);
    Assert.True(response.IsSuccessStatusCode);
    var result = await response.Content
        .ReadFromJsonAsync&lt;AddItem.Response&gt;();
    Assert.NotNull(result);
    Assert.Equal(1, result.ProductId);
    Assert.Equal(22, result.Quantity);
    // Assert the database state
    using var seedScope = application.Services.CreateScope();
    var db = seedScope.ServiceProvider
        .GetRequiredService&lt;BasketContext&gt;();
    var dbItem = db.Items.FirstOrDefault(x =&gt; x.CustomerId == 4 &amp;&amp; x.ProductId == 1);
    Assert.NotNull(dbItem);
    Assert.Equal(22, dbItem.Quantity);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.656.1" xmlns="http://www.w3.org/1999/xhtml">The </span><em><span class="koboSpan" id="kobo.657.1" xmlns="http://www.w3.org/1999/xhtml">Arrange</span></em><span class="koboSpan" id="kobo.658.1" xmlns="http://www.w3.org/1999/xhtml"> block of the preceding test case creates a test application and an </span><code><span class="koboSpan" id="kobo.659.1" xmlns="http://www.w3.org/1999/xhtml">HttpClient</span></code><span class="koboSpan" id="kobo.660.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.660.2" xmlns="http://www.w3.org/1999/xhtml">It then sends an </span><code><span class="koboSpan" id="kobo.661.1" xmlns="http://www.w3.org/1999/xhtml">AddItem.Command</span></code><span class="koboSpan" id="kobo.662.1" xmlns="http://www.w3.org/1999/xhtml"> to the endpoint in its </span><em><span class="koboSpan" id="kobo.663.1" xmlns="http://www.w3.org/1999/xhtml">Act</span></em><span class="koboSpan" id="kobo.664.1" xmlns="http://www.w3.org/1999/xhtml"> block.Afterward, it splits the </span><em><span class="koboSpan" id="kobo.665.1" xmlns="http://www.w3.org/1999/xhtml">Assert</span></em><span class="koboSpan" id="kobo.666.1" xmlns="http://www.w3.org/1999/xhtml"> block in two: the HTTP response and the database itself. </span><span class="koboSpan" id="kobo.666.2" xmlns="http://www.w3.org/1999/xhtml">The first part ensures that the endpoint returns the expected data. </span><span class="koboSpan" id="kobo.666.3" xmlns="http://www.w3.org/1999/xhtml">The second part ensures that the database is in the correct state.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.667.1" xmlns="http://www.w3.org/1999/xhtml">It is a good habit to ensure the database is in the correct state, especially with EF Core or most Unit of Work implementations, because one could add an item and forget to save the changes leading to an incorrect database state. </span><span class="koboSpan" id="kobo.667.2" xmlns="http://www.w3.org/1999/xhtml">Yet, the data returned by the endpoint would have been correct.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.668.1" xmlns="http://www.w3.org/1999/xhtml">We could test more or less elements here. </span><span class="koboSpan" id="kobo.668.2" xmlns="http://www.w3.org/1999/xhtml">We could refactor the </span><em><span class="koboSpan" id="kobo.669.1" xmlns="http://www.w3.org/1999/xhtml">Assert</span></em><span class="koboSpan" id="kobo.670.1" xmlns="http://www.w3.org/1999/xhtml"> block so it becomes more elegant. </span><span class="koboSpan" id="kobo.670.2" xmlns="http://www.w3.org/1999/xhtml">We can and should continuously improve all types of code, including tests. </span><span class="koboSpan" id="kobo.670.3" xmlns="http://www.w3.org/1999/xhtml">However, in this case, I wanted to keep as much of the logic in the test method to make it easier to understand.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.671.1" xmlns="http://www.w3.org/1999/xhtml">It is also a good practice to keep test methods as independent as possible. </span><span class="koboSpan" id="kobo.671.2" xmlns="http://www.w3.org/1999/xhtml">This does not mean that improving readability and encapsulating code into helper classes or methods is wrong; on the contrary.</span></p>
</blockquote>
<p><span class="koboSpan" id="kobo.672.1" xmlns="http://www.w3.org/1999/xhtml">The only opaque piece of the test method is the </span><code><span class="koboSpan" id="kobo.673.1" xmlns="http://www.w3.org/1999/xhtml">C18WebApplication</span></code><span class="koboSpan" id="kobo.674.1" xmlns="http://www.w3.org/1999/xhtml"> class, which inherits from the </span><code><span class="koboSpan" id="kobo.675.1" xmlns="http://www.w3.org/1999/xhtml">WebApplicationFactory&lt;Program&gt;</span></code><span class="koboSpan" id="kobo.676.1" xmlns="http://www.w3.org/1999/xhtml"> class and implements a few helper methods to simplify the configuration of the test application. </span><span class="koboSpan" id="kobo.676.2" xmlns="http://www.w3.org/1999/xhtml">You can treat it as an instance of the </span><code><span class="koboSpan" id="kobo.677.1" xmlns="http://www.w3.org/1999/xhtml">WebApplicationFactory&lt;Program&gt;</span></code><span class="koboSpan" id="kobo.678.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.678.2" xmlns="http://www.w3.org/1999/xhtml">Feel free to browse the code on GitHub and explore its inner workings.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.679.1" xmlns="http://www.w3.org/1999/xhtml">Creating an </span><code><span class="koboSpan" id="kobo.680.1" xmlns="http://www.w3.org/1999/xhtml">Application</span></code><span class="koboSpan" id="kobo.681.1" xmlns="http://www.w3.org/1999/xhtml"> class is a good reusability pattern. </span><span class="koboSpan" id="kobo.681.2" xmlns="http://www.w3.org/1999/xhtml">However, creating an application per test method is not the most performant because you are booting the entire program for every test.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.682.1" xmlns="http://www.w3.org/1999/xhtml">You can use test fixtures to reuse and share an instance of the program between multiple tests. </span><span class="koboSpan" id="kobo.682.2" xmlns="http://www.w3.org/1999/xhtml">However, remember that the application's state and potentially the database are also shared between tests.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.683.1" xmlns="http://www.w3.org/1999/xhtml">To the second test, next.</span></p>
</section>
<section class="level5" data-number="19.3.5.1.2" id="second-test-method">
<h5 data-number="19.3.5.1.2"><span class="koboSpan" id="kobo.684.1" xmlns="http://www.w3.org/1999/xhtml">Second test method</span></h5>
<p><span class="koboSpan" id="kobo.685.1" xmlns="http://www.w3.org/1999/xhtml">This test ensures that the </span><code><span class="koboSpan" id="kobo.686.1" xmlns="http://www.w3.org/1999/xhtml">Location</span></code><span class="koboSpan" id="kobo.687.1" xmlns="http://www.w3.org/1999/xhtml"> header contains a valid URL. </span><span class="koboSpan" id="kobo.687.2" xmlns="http://www.w3.org/1999/xhtml">This test is important since the </span><code><span class="koboSpan" id="kobo.688.1" xmlns="http://www.w3.org/1999/xhtml">Baskets</span></code><span class="koboSpan" id="kobo.689.1" xmlns="http://www.w3.org/1999/xhtml"> and the </span><code><span class="koboSpan" id="kobo.690.1" xmlns="http://www.w3.org/1999/xhtml">Products</span></code><span class="koboSpan" id="kobo.691.1" xmlns="http://www.w3.org/1999/xhtml"> features are loosely coupled and can change independently. </span><span class="koboSpan" id="kobo.691.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.692.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public async Task Should_return_a_valid_product_url()
{
    // Arrange
    await using var application = new C18WebApplication();
    await application.SeedAsync&lt;Products.ProductContext&gt;(async db =&gt;
    {
        db.Products.RemoveRange(db.Products);
        db.Products.Add(new("A test product", 15.22m, 1));
        await db.SaveChangesAsync();
    });
    var client = application.CreateClient();
    // Act
    var response = await client.PostAsJsonAsync(
        "/baskets",
        new AddItem.Command(4, 1, 22)
    );
    // Assert
    Assert.NotNull(response);
    Assert.Equal(HttpStatusCode.Created, response.StatusCode);
    Assert.NotNull(response.Headers.Location);
    var productResponse = await client
        .GetAsync(response.Headers.Location);
    Assert.NotNull(productResponse);
    Assert.True(productResponse.IsSuccessStatusCode);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.693.1" xmlns="http://www.w3.org/1999/xhtml">The preceding test method is similar to the first one. </span><span class="koboSpan" id="kobo.693.2" xmlns="http://www.w3.org/1999/xhtml">The </span><em><span class="koboSpan" id="kobo.694.1" xmlns="http://www.w3.org/1999/xhtml">Arrange</span></em><span class="koboSpan" id="kobo.695.1" xmlns="http://www.w3.org/1999/xhtml"> block creates an application, seeds the database, and creates an </span><code><span class="koboSpan" id="kobo.696.1" xmlns="http://www.w3.org/1999/xhtml">HttpClient</span></code><span class="koboSpan" id="kobo.697.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.697.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.698.1" xmlns="http://www.w3.org/1999/xhtml">SeedAsync</span></code><span class="koboSpan" id="kobo.699.1" xmlns="http://www.w3.org/1999/xhtml"> method is one of the helper methods of the </span><code><span class="koboSpan" id="kobo.700.1" xmlns="http://www.w3.org/1999/xhtml">C18WebApplication</span></code><span class="koboSpan" id="kobo.701.1" xmlns="http://www.w3.org/1999/xhtml"> class.The </span><em><span class="koboSpan" id="kobo.702.1" xmlns="http://www.w3.org/1999/xhtml">Act</span></em><span class="koboSpan" id="kobo.703.1" xmlns="http://www.w3.org/1999/xhtml"> block sends a request to create a basket item.The </span><em><span class="koboSpan" id="kobo.704.1" xmlns="http://www.w3.org/1999/xhtml">Assert</span></em><span class="koboSpan" id="kobo.705.1" xmlns="http://www.w3.org/1999/xhtml"> block is divided in two. </span><span class="koboSpan" id="kobo.705.2" xmlns="http://www.w3.org/1999/xhtml">The first ensures that the HTTP response contains a </span><code><span class="koboSpan" id="kobo.706.1" xmlns="http://www.w3.org/1999/xhtml">Location</span></code><span class="koboSpan" id="kobo.707.1" xmlns="http://www.w3.org/1999/xhtml"> header and that the status code is 201. </span><span class="koboSpan" id="kobo.707.2" xmlns="http://www.w3.org/1999/xhtml">The second part (highlighted) takes the </span><code><span class="koboSpan" id="kobo.708.1" xmlns="http://www.w3.org/1999/xhtml">Location</span></code><span class="koboSpan" id="kobo.709.1" xmlns="http://www.w3.org/1999/xhtml"> header and sends an HTTP request to validate the URL’s validity. </span><span class="koboSpan" id="kobo.709.2" xmlns="http://www.w3.org/1999/xhtml">This test ensures that if we change the URL of the </span><code><span class="koboSpan" id="kobo.710.1" xmlns="http://www.w3.org/1999/xhtml">Products.FetchOne</span></code><span class="koboSpan" id="kobo.711.1" xmlns="http://www.w3.org/1999/xhtml"> endpoint, say we prefer </span><code><span class="koboSpan" id="kobo.712.1" xmlns="http://www.w3.org/1999/xhtml">/catalog</span></code><span class="koboSpan" id="kobo.713.1" xmlns="http://www.w3.org/1999/xhtml"> over </span><code><span class="koboSpan" id="kobo.714.1" xmlns="http://www.w3.org/1999/xhtml">/products</span></code><span class="koboSpan" id="kobo.715.1" xmlns="http://www.w3.org/1999/xhtml">, this test will alert us.We explore the third test case next.</span></p>
</section>
<section class="level5" data-number="19.3.5.1.3" id="third-test-method">
<h5 data-number="19.3.5.1.3"><span class="koboSpan" id="kobo.716.1" xmlns="http://www.w3.org/1999/xhtml">Third test method</span></h5>
<p><span class="koboSpan" id="kobo.717.1" xmlns="http://www.w3.org/1999/xhtml">The last test method ensures that the endpoint responds with a 409 Conflict status when a consumer tries to add an existing item:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.718.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public async Task Should_return_a_ProblemDetails_with_a_Conflict_status_code()
{
    // Arrange
    await using var application = new C18WebApplication();
    await application.SeedAsync&lt;BasketContext&gt;(async db =&gt;
    {
        db.Items.RemoveRange(db.Items);
        db.Items.Add(new(
            CustomerId: 1,
            ProductId: 1,
            Quantity: 10
        ));
        await db.SaveChangesAsync();
    });
    var client = application.CreateClient();
    // Act
    var response = await client.PostAsJsonAsync(
        "/baskets",
        new AddItem.Command(
            CustomerId: 1,
            ProductId: 1,
            Quantity: 20
        )
    );
    // Assert the response
    Assert.NotNull(response);
    Assert.False(response.IsSuccessStatusCode);
    Assert.Equal(HttpStatusCode.Conflict, response.StatusCode);
    var problem = await response.Content
        .ReadFromJsonAsync&lt;ProblemDetails&gt;();
    Assert.NotNull(problem);
    Assert.Equal("The product \u00271\u0027 is already in your shopping cart.", problem.Title);
    // Assert the database state
    using var seedScope = application.Services.CreateScope();
    var db = seedScope.ServiceProvider
        .GetRequiredService&lt;BasketContext&gt;();
    var dbItem = db.Items.FirstOrDefault(x =&gt; x.CustomerId == 1 &amp;&amp; x.ProductId == 1);
    Assert.NotNull(dbItem);
    Assert.Equal(10, dbItem.Quantity);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.719.1" xmlns="http://www.w3.org/1999/xhtml">The preceding test method is very similar to the other two.The </span><em><span class="koboSpan" id="kobo.720.1" xmlns="http://www.w3.org/1999/xhtml">Arrange</span></em><span class="koboSpan" id="kobo.721.1" xmlns="http://www.w3.org/1999/xhtml"> block creates a test application, seeds the database, and creates an </span><code><span class="koboSpan" id="kobo.722.1" xmlns="http://www.w3.org/1999/xhtml">HttpClient</span></code><span class="koboSpan" id="kobo.723.1" xmlns="http://www.w3.org/1999/xhtml">.The </span><em><span class="koboSpan" id="kobo.724.1" xmlns="http://www.w3.org/1999/xhtml">Act</span></em><span class="koboSpan" id="kobo.725.1" xmlns="http://www.w3.org/1999/xhtml"> block sends a request using the only item in the database, which we expect to result in a conflict.The first part of the </span><em><span class="koboSpan" id="kobo.726.1" xmlns="http://www.w3.org/1999/xhtml">Assert</span></em><span class="koboSpan" id="kobo.727.1" xmlns="http://www.w3.org/1999/xhtml"> block ensures that the endpoint returns the expected </span><code><span class="koboSpan" id="kobo.728.1" xmlns="http://www.w3.org/1999/xhtml">ProblemDetails</span></code><span class="koboSpan" id="kobo.729.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.729.2" xmlns="http://www.w3.org/1999/xhtml">The second part validates that the endpoint has not changed the quantity in the database.With those three tests, we are covering the relevant code of the </span><code><span class="koboSpan" id="kobo.730.1" xmlns="http://www.w3.org/1999/xhtml">AddItem</span></code><span class="koboSpan" id="kobo.731.1" xmlns="http://www.w3.org/1999/xhtml"> feature.The other test cases are similar, sending HTTP requests and validating the database content. </span><span class="koboSpan" id="kobo.731.2" xmlns="http://www.w3.org/1999/xhtml">Each feature has between one and three tests. </span><span class="koboSpan" id="kobo.731.3" xmlns="http://www.w3.org/1999/xhtml">We explore a test related to the </span><code><span class="koboSpan" id="kobo.732.1" xmlns="http://www.w3.org/1999/xhtml">UpdateQuantity</span></code><span class="koboSpan" id="kobo.733.1" xmlns="http://www.w3.org/1999/xhtml"> feature next.</span></p>
</section>
</section>
<section class="level4" data-number="19.3.5.2" id="updatequantitytest">
<h4 data-number="19.3.5.2"><span class="koboSpan" id="kobo.734.1" xmlns="http://www.w3.org/1999/xhtml">UpdateQuantityTest</span></h4>
<p><span class="koboSpan" id="kobo.735.1" xmlns="http://www.w3.org/1999/xhtml">We did not cover the </span><code><span class="koboSpan" id="kobo.736.1" xmlns="http://www.w3.org/1999/xhtml">UpdateQuantity</span></code><span class="koboSpan" id="kobo.737.1" xmlns="http://www.w3.org/1999/xhtml"> feature, but one of its branches is that if the current quantity and the new quantities are the same, the endpoint will not update the data. </span><span class="koboSpan" id="kobo.737.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the snippet:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.738.1" xmlns="http://www.w3.org/1999/xhtml">if (item.Quantity != command.Quantity)
{
    _db.Items.Update(itemToUpdate);
    await _db.SaveChangesAsync(cancellationToken);
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.739.1" xmlns="http://www.w3.org/1999/xhtml">To test this use case, we subscribe to the </span><code><span class="koboSpan" id="kobo.740.1" xmlns="http://www.w3.org/1999/xhtml">SavedChanges</span></code><span class="koboSpan" id="kobo.741.1" xmlns="http://www.w3.org/1999/xhtml"> event on the EF Core </span><code><span class="koboSpan" id="kobo.742.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.743.1" xmlns="http://www.w3.org/1999/xhtml">, then ensure the code never calls it. </span><span class="koboSpan" id="kobo.743.2" xmlns="http://www.w3.org/1999/xhtml">This uses no mocks or stubs and tests the real code.This test stands out of the lot, so I considered it worth exploring before moving on. </span><span class="koboSpan" id="kobo.743.3" xmlns="http://www.w3.org/1999/xhtml">Here’s the code:</span></p>
<div class="C0-CodePACKT">
<pre><code><span class="koboSpan" id="kobo.744.1" xmlns="http://www.w3.org/1999/xhtml">[Fact]
public async Task Should_not_touch_the_database_when_the_quantity_is_the_same()
{
    // Arrange
    await using var application = new C18WebApplication();
    await application.SeedAsync&lt;BasketContext&gt;(async db =&gt;
    {
        db.Items.RemoveRange(db.Items.ToArray());
        db.Items.Add(new BasketItem(2, 1, 5));
        await db.SaveChangesAsync();
    });
    using var seedScope = application.Services.CreateScope();
    var db = seedScope.ServiceProvider
        .GetRequiredService&lt;BasketContext&gt;();
    var mapper = seedScope.ServiceProvider
        .GetRequiredService&lt;UpdateQuantity.Mapper&gt;();
    db.SavedChanges += Db_SavedChanges;
    var saved = false;
    var sut = new UpdateQuantity.Handler(db, mapper);
    // Act
    var response = await sut.HandleAsync(
        new UpdateQuantity.Command(2, 1, 5),
        CancellationToken.None
    );
    // Assert
    Assert.NotNull(response);
    Assert.False(saved);
    void Db_SavedChanges(object? </span><span class="koboSpan" id="kobo.744.2" xmlns="http://www.w3.org/1999/xhtml">sender, SavedChangesEventArgs e)
    {
        saved = true;
    }
}</span></code></pre>
</div>
<p><span class="koboSpan" id="kobo.745.1" xmlns="http://www.w3.org/1999/xhtml">The preceding test method should sound very familiar by now. </span><span class="koboSpan" id="kobo.745.2" xmlns="http://www.w3.org/1999/xhtml">However, we use a different pattern here.In the </span><em><span class="koboSpan" id="kobo.746.1" xmlns="http://www.w3.org/1999/xhtml">Arrange</span></em><span class="koboSpan" id="kobo.747.1" xmlns="http://www.w3.org/1999/xhtml"> block, we create a test application and seed the database, but we do not create an </span><code><span class="koboSpan" id="kobo.748.1" xmlns="http://www.w3.org/1999/xhtml">HttpClient</span></code><span class="koboSpan" id="kobo.749.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.749.2" xmlns="http://www.w3.org/1999/xhtml">We use the </span><code><span class="koboSpan" id="kobo.750.1" xmlns="http://www.w3.org/1999/xhtml">ServiceProvider</span></code><span class="koboSpan" id="kobo.751.1" xmlns="http://www.w3.org/1999/xhtml"> to create the dependencies instead. </span><span class="koboSpan" id="kobo.751.2" xmlns="http://www.w3.org/1999/xhtml">Then manually instantiate the </span><code><span class="koboSpan" id="kobo.752.1" xmlns="http://www.w3.org/1999/xhtml">UpdateQuantity.Handler</span></code><span class="koboSpan" id="kobo.753.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.753.2" xmlns="http://www.w3.org/1999/xhtml">This allows us to customize the </span><code><span class="koboSpan" id="kobo.754.1" xmlns="http://www.w3.org/1999/xhtml">BasketContext</span></code><span class="koboSpan" id="kobo.755.1" xmlns="http://www.w3.org/1999/xhtml"> instance to assess whether the endpoint called its </span><code><span class="koboSpan" id="kobo.756.1" xmlns="http://www.w3.org/1999/xhtml">SaveChange</span></code><span class="koboSpan" id="kobo.757.1" xmlns="http://www.w3.org/1999/xhtml"> method (highlighted code).The </span><em><span class="koboSpan" id="kobo.758.1" xmlns="http://www.w3.org/1999/xhtml">Act</span></em><span class="koboSpan" id="kobo.759.1" xmlns="http://www.w3.org/1999/xhtml"> block invokes the </span><code><span class="koboSpan" id="kobo.760.1" xmlns="http://www.w3.org/1999/xhtml">HandleAsync</span></code><span class="koboSpan" id="kobo.761.1" xmlns="http://www.w3.org/1999/xhtml"> method directly with a command that should not trigger the update because the item has the same quantity as the one we seeded. </span><span class="koboSpan" id="kobo.761.2" xmlns="http://www.w3.org/1999/xhtml">Unlike the other tests, we are not sending an HTTP request.The </span><em><span class="koboSpan" id="kobo.762.1" xmlns="http://www.w3.org/1999/xhtml">Assert</span></em><span class="koboSpan" id="kobo.763.1" xmlns="http://www.w3.org/1999/xhtml"> block is simpler than the other tests we explored because we test the method, not the HTTP response or the database. </span><span class="koboSpan" id="kobo.763.2" xmlns="http://www.w3.org/1999/xhtml">In this case, we only care whether the </span><code><span class="koboSpan" id="kobo.764.1" xmlns="http://www.w3.org/1999/xhtml">saved</span></code><span class="koboSpan" id="kobo.765.1" xmlns="http://www.w3.org/1999/xhtml"> variable is </span><code><span class="koboSpan" id="kobo.766.1" xmlns="http://www.w3.org/1999/xhtml">true</span></code><span class="koboSpan" id="kobo.767.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.768.1" xmlns="http://www.w3.org/1999/xhtml">false</span></code><span class="koboSpan" id="kobo.769.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.770.1" xmlns="http://www.w3.org/1999/xhtml">This test is much faster than the other because no HTTP is involved. </span><span class="koboSpan" id="kobo.770.2" xmlns="http://www.w3.org/1999/xhtml">When calling the </span><code><span class="koboSpan" id="kobo.771.1" xmlns="http://www.w3.org/1999/xhtml">CreateClient</span></code><span class="koboSpan" id="kobo.772.1" xmlns="http://www.w3.org/1999/xhtml"> method of a </span><code><span class="koboSpan" id="kobo.773.1" xmlns="http://www.w3.org/1999/xhtml">WebApplicationFactory&lt;T&gt;</span></code><span class="koboSpan" id="kobo.774.1" xmlns="http://www.w3.org/1999/xhtml"> object (the </span><code><span class="koboSpan" id="kobo.775.1" xmlns="http://www.w3.org/1999/xhtml">C18WebApplication</span></code><span class="koboSpan" id="kobo.776.1" xmlns="http://www.w3.org/1999/xhtml"> class in this case), it starts the webserver and then creates the </span><code><span class="koboSpan" id="kobo.777.1" xmlns="http://www.w3.org/1999/xhtml">HttpClient</span></code><span class="koboSpan" id="kobo.778.1" xmlns="http://www.w3.org/1999/xhtml">, which has a significant performance overhead.</span></p>
<blockquote>
<p><span class="koboSpan" id="kobo.779.1" xmlns="http://www.w3.org/1999/xhtml">Remember this tip when you have to optimize your test suites.</span></p>
</blockquote>
</blockquote>
<p><span class="koboSpan" id="kobo.780.1" xmlns="http://www.w3.org/1999/xhtml">And we are done; the test knows whether or not the </span><code><span class="koboSpan" id="kobo.781.1" xmlns="http://www.w3.org/1999/xhtml">DbContext</span></code><span class="koboSpan" id="kobo.782.1" xmlns="http://www.w3.org/1999/xhtml">’s </span><code><span class="koboSpan" id="kobo.783.1" xmlns="http://www.w3.org/1999/xhtml">SavedChanges</span></code><span class="koboSpan" id="kobo.784.1" xmlns="http://www.w3.org/1999/xhtml"> method was called. </span><span class="koboSpan" id="kobo.784.2" xmlns="http://www.w3.org/1999/xhtml">Let’s summarize what we learned before moving to the next chapter.</span></p>
</section>
</section>
</section>
<section class="level2" data-number="19.4" id="summary-17">
<h2 data-number="19.4"><span class="koboSpan" id="kobo.785.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.786.1" xmlns="http://www.w3.org/1999/xhtml">We delved into the Request-EndPoint-Response (REPR) design pattern and learned that REPR follows the most foundational pattern of the web. </span><span class="koboSpan" id="kobo.786.2" xmlns="http://www.w3.org/1999/xhtml">The client sends a request to an endpoint, which processes it and returns a response. </span><span class="koboSpan" id="kobo.786.3" xmlns="http://www.w3.org/1999/xhtml">The pattern focuses on designing the backend code around the endpoint, making it faster to develop, easier to find your way around the project, and more focused on features than MVC and layers.We also took a CQS approach around the requests, making them queries or commands, depicting all that can happen in a program: read or write states.We explored ways to organize the code around such a pattern, from implementing trivial to more complex features. </span><span class="koboSpan" id="kobo.786.4" xmlns="http://www.w3.org/1999/xhtml">We built a technology stack to create an e-commerce web application that leverages the REPR pattern and a feature-oriented design. </span><span class="koboSpan" id="kobo.786.5" xmlns="http://www.w3.org/1999/xhtml">We learned how to leverage middleware to handle exceptions globally and how the </span><em><span class="koboSpan" id="kobo.787.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper</span></em><span class="koboSpan" id="kobo.788.1" xmlns="http://www.w3.org/1999/xhtml"> library provides us with this capability. </span><span class="koboSpan" id="kobo.788.2" xmlns="http://www.w3.org/1999/xhtml">We also used grey-box testing to cover almost all of the project's logic with just a few tests.Next, we explore microservices architecture.</span></p>
</section>
<section class="level2" data-number="19.5" id="questions-17">
<h2 data-number="19.5"><span class="koboSpan" id="kobo.789.1" xmlns="http://www.w3.org/1999/xhtml">Questions</span></h2>
<p><span class="koboSpan" id="kobo.790.1" xmlns="http://www.w3.org/1999/xhtml">Let’s take a look at a few practice questions:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.791.1" xmlns="http://www.w3.org/1999/xhtml">Must we use the </span><em><span class="koboSpan" id="kobo.792.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidation</span></em><span class="koboSpan" id="kobo.793.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><em><span class="koboSpan" id="kobo.794.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper</span></em><span class="koboSpan" id="kobo.795.1" xmlns="http://www.w3.org/1999/xhtml"> libraries when implementing the REPR pattern?</span></li>
<li><span class="koboSpan" id="kobo.796.1" xmlns="http://www.w3.org/1999/xhtml">What are the three components of the REPR pattern?</span></li>
<li><span class="koboSpan" id="kobo.797.1" xmlns="http://www.w3.org/1999/xhtml">Does the REPR pattern dictate that we use nested classes?</span></li>
<li><span class="koboSpan" id="kobo.798.1" xmlns="http://www.w3.org/1999/xhtml">Why are grey-box integration tests provide much confidence?</span></li>
<li><span class="koboSpan" id="kobo.799.1" xmlns="http://www.w3.org/1999/xhtml">Name an advantage of handling exceptions using middleware.</span></li>
</ol>
</section>
<section class="level2" data-number="19.6" id="further-reading-15">
<h2 data-number="19.6"><span class="koboSpan" id="kobo.800.1" xmlns="http://www.w3.org/1999/xhtml">Further reading</span></h2>
<p><span class="koboSpan" id="kobo.801.1" xmlns="http://www.w3.org/1999/xhtml">Here are a few links to build upon what we learned in the chapter:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.802.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidation: </span><a href="https://adpg.link/xXgp"><span class="koboSpan" id="kobo.803.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/xXgp</span></a></li>
<li><span class="koboSpan" id="kobo.804.1" xmlns="http://www.w3.org/1999/xhtml">FluentValidation.AspNetCore.Http: </span><a href="https://adpg.link/qsao"><span class="koboSpan" id="kobo.805.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/qsao</span></a></li>
<li><span class="koboSpan" id="kobo.806.1" xmlns="http://www.w3.org/1999/xhtml">ExceptionMapper: </span><a href="https://adpg.link/ESDb"><span class="koboSpan" id="kobo.807.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/ESDb</span></a></li>
<li><span class="koboSpan" id="kobo.808.1" xmlns="http://www.w3.org/1999/xhtml">Mapperly: </span><a href="https://adpg.link/Dwcj"><span class="koboSpan" id="kobo.809.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/Dwcj</span></a></li>
<li><span class="koboSpan" id="kobo.810.1" xmlns="http://www.w3.org/1999/xhtml">MVC Controllers are Dinosaurs - Embrace API Endpoints: </span><a href="https://adpg.link/NGjm"><span class="koboSpan" id="kobo.811.1" xmlns="http://www.w3.org/1999/xhtml">https://adpg.link/NGjm</span></a></li>
</ul>
</section>
<section class="level2" data-number="19.7" id="answers-14">
<h2 data-number="19.7"><span class="koboSpan" id="kobo.812.1" xmlns="http://www.w3.org/1999/xhtml">Answers</span></h2>
<ol>
<li><span class="koboSpan" id="kobo.813.1" xmlns="http://www.w3.org/1999/xhtml">No. </span><span class="koboSpan" id="kobo.813.2" xmlns="http://www.w3.org/1999/xhtml">REPR does not dictate how to implement it. </span><span class="koboSpan" id="kobo.813.3" xmlns="http://www.w3.org/1999/xhtml">You can create your own stack or go barebone ASP.NET Core minimal API and implement everything by hand in the project.</span></li>
<li><span class="koboSpan" id="kobo.814.1" xmlns="http://www.w3.org/1999/xhtml">REPR consists of a request, an endpoint, and a response.</span></li>
<li><span class="koboSpan" id="kobo.815.1" xmlns="http://www.w3.org/1999/xhtml">No. </span><span class="koboSpan" id="kobo.815.2" xmlns="http://www.w3.org/1999/xhtml">REPR does not prescribe any implementation details.</span></li>
<li><span class="koboSpan" id="kobo.816.1" xmlns="http://www.w3.org/1999/xhtml">Grey-box integration tests provide much confidence in their outcome because they test the feature almost end-to-end, ensuring all the pieces are there, from the services in the IoC container to the database.</span></li>
<li><span class="koboSpan" id="kobo.817.1" xmlns="http://www.w3.org/1999/xhtml">Handling exceptions using middleware allows for centralizing the management of exceptions, encapsulating that responsibility in a single place. </span><span class="koboSpan" id="kobo.817.2" xmlns="http://www.w3.org/1999/xhtml">It also provides for uniformizing the output, sending the clients a response in the same format for all errors. </span><span class="koboSpan" id="kobo.817.3" xmlns="http://www.w3.org/1999/xhtml">It removes the burden of handling each exception individually, eliminating </span><code><span class="koboSpan" id="kobo.818.1" xmlns="http://www.w3.org/1999/xhtml">try</span></code><span class="koboSpan" id="kobo.819.1" xmlns="http://www.w3.org/1999/xhtml">-</span><code><span class="koboSpan" id="kobo.820.1" xmlns="http://www.w3.org/1999/xhtml">catch</span></code><span class="koboSpan" id="kobo.821.1" xmlns="http://www.w3.org/1999/xhtml"> boilerplate code.</span></li>
</ol>
</section>
</section>
</body>
</html>
