<html><head></head><body>
        

                            
                    <h1 class="header-title">Improving Code Maintenance of C# Code Base</h1>
                
            
            
                
<p>In this chapter, we will cover the following recipes:</p>
<ul>
<li>Configuring C# code style rules built into Visual Studio 2017</li>
<li>Using the <kbd>.editorconfig</kbd> file for the configuration of code style rules</li>
<li>Using the public API analyzer for API surface maintenance</li>
<li>Using third-party StyleCop analyzers for code style rules</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Introduction</h1>
                
            
            
                
<p>In the current era of open source projects with numerous diverse contributors from different organizations and different parts of the world, one of the primary requirements of maintaining any repo is enforcing code style guidelines across the code base. Historically, this has been done through exhaustive documentation and code reviews to catch any violations of these coding guidelines. However, this approach has its flaws and requires a lot of man hours on maintaining the documentation and performing exhaustive code reviews.</p>
<p>With the automated code style and naming rules that are built into Visual Studio 2017, users can customize and configure the enforcement levels for individual rules and prompt visual indicators for violations, such as suggestions or squiggles in the editor and diagnostics in the error list, with appropriate severity (error/warning/informational message). Additionally, the rules come with a code fix that can automatically fix one or more instances of the violations across the document, project, or solution. With the new EditorConfig support in Visual Studio 2017, these rule configurations can be enforced and customized at each folder level via an <kbd>.editorconfig</kbd> file. Additionally, the <kbd>.editorconfig</kbd> files can be checked into the repo alongside the sources so that the rules are enforced for every user that contributes to the repo.</p>
<p>EditorConfig (<a href="http://editorconfig.org/">http://editorconfig.org/</a>) is an open source file format that helps developers configure and enforce formatting and code style conventions to achieve consistent, more readable codebases. EditorConfig files are easily checked into source control and are applied at repository and project levels. EditorConfig conventions override their equivalents in your personal settings, such that the conventions of the codebase take precedence over the individual developer.</p>
<p>In this chapter, we will introduce you to these code style rules, show you how to configure them in the Visual Studio 2017 IDE, and save these settings into an EditorConfig file. Additionally, we will introduce you to a very popular third-party Roslyn analyzer, the PublicAPI analyzer, that allows tracking the public API surface of .NET assemblies through additional non-source text files checked into the repo, and provides diagnostics and code fixes when there is a breaking API change or a new addition to the public API that is not documented in the public API files. We will also walk you through configuring StyleCop analyzers for a .NET project, a popular third-party code style analyzer, and an alternative to the built-in Visual Studio code style rules for enforcing code style.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Configuring C# code style rules built into Visual Studio 2017</h1>
                
            
            
                
<p>In this section, we will walk you through the important categories of code style rules built into Visual Studio 2017, and also show you how to configure them in Visual Studio.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>You will need to have Visual Studio 2017 installed on your machine to execute the recipes in this chapter. You can install a free community version of Visual Studio 2017 from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Start Visual Studio, navigate to File | New | Project..., create a new C# class library project, and replace the code in <kbd>Class1.cs</kbd> with code from the code sample at <kbd>ClassLibrary/Class1.cs</kbd>.</li>
<li>Click on Tools | Options to bring up the tools options dialog and navigate to the C# code style options (Text Editor | C# | Code Style | General):</li>
</ol>
<div><img class="image-border" height="442" src="img/b102d1de-6050-423d-b786-8ebc55eef267.png" width="685"/></div>
<ol start="3">
<li>Change the Severity of 'this.' preferences to Suggestion, predefined type preferences to Warning, and 'var' preferences to Error. Change the Preference of 'var' preferences from Prefer explicit type to Prefer 'var':</li>
</ol>
<div><img class="image-border" height="256" src="img/f2a6f176-6866-4490-bb87-50b245e1f7d7.png" width="629"/></div>
<ol start="4">
<li>Change the Severity of Code block preferences to Warning and change the Preference For methods to Prefer expression body:</li>
</ol>
<div><img class="image-border" height="165" src="img/8abec331-d7e1-4301-bf53-90099ccd3425.png" width="585"/></div>
<ol start="5">
<li>Ensure that all the remaining code style rules (Expression preferences, Variable preferences and 'null' checking) have the severity Suggestion.</li>
<li>Verify the following code style diagnostics in the error list:</li>
</ol>
<div><img class="image-border" height="314" src="img/cac29f6b-689b-4c7b-a00b-6c56c36f69e4.png" width="828"/></div>
<ol start="7">
<li>Double-click on the first IDE0007 error and verify that a light bulb is offered for a code fix to use 'var' instead of explicit type. Verify that hitting the <em>Enter</em> key fixes the code and the diagnostic is removed from the error list. Repeat the exercise for the remaining IDE0007 diagnostics:</li>
</ol>
<div><img class="image-border" height="203" src="img/9e0cd8f4-28af-4b99-9305-1193c44b409d.png" width="548"/></div>
<ol start="8">
<li>Now, double-click on the first IDE0012 warning and verify that a light bulb is offered to Simplify name 'System.Int32'. This time, click on the Fix all occurrences in Document hyperlink and verify a preview changes dialog comes up that fixes all instances of <em>IDE0012</em> in the document with a single batch fix:</li>
</ol>
<div><img class="image-border" height="339" src="img/ab570d39-fbd0-4da5-955b-477bf176a71e.png" width="410"/></div>
<ol start="9">
<li>Apply code fixes for each of the remaining diagnostics in the error list and verify that the code is now completely clean:</li>
</ol>
<pre style="padding-left: 90px">
using System;<br/><br/>class Class1<br/>{<br/>  // Field and Property - prefer predefined type<br/>  private int field1;<br/>  private int Property1 =&gt; int.MaxValue;<br/><br/>  private void Method_DoNotPreferThis()<br/>  {<br/>    Console.WriteLine(field1);<br/>    Console.WriteLine(Property1);<br/>    Method_PreferExpressionBody();<br/>  }<br/><br/>  private int Method_PreferVar()<br/>  {<br/>    var i = 0;<br/>    var c = new Class1();<br/>    var c2 = Method_PreferExpressionBody();<br/>    return i;<br/>  }<br/><br/>  private void Method_PreferBraces(bool flag)<br/>  {<br/>    if (flag)<br/>    {<br/>      Console.WriteLine(flag);<br/>    }<br/>  }<br/><br/>  private Class1 Method_PreferExpressionBody() =&gt; Method_PreferPatternMatching(null);<br/><br/>  private Class1 Method_PreferPatternMatching(object o)<br/>  {<br/>    if (o is Class1 c)<br/>    {<br/>      return c;<br/>    }<br/><br/>    return new Class1();<br/>  }<br/><br/>  private int Method_PreferInlineVariableDeclaration(string s)<br/>  {<br/>    if (int.TryParse(s, out var i))<br/>    {<br/>      return i;<br/>    }<br/><br/>    return -1;<br/>  }<br/><br/>  private void Method_NullCheckingPreferences(object o)<br/>  {<br/>    var str = o?.ToString();<br/>    var o3 = o ?? new object();<br/>  }<br/>}
</pre>
<ol start="10">
<li>Add the following new method to <kbd>Class1</kbd> and verify that IDE0007 (use 'var' instead of explicit type) is raised for the code style violation in the newly added code:</li>
</ol>
<pre style="padding-left: 60px">
private void Method_New_ViolateVarPreference()<br/>{<br/>  Class1 c = new Class1();<br/>}
</pre>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>Code style rules are built into Visual Studio 2017 and are classified into the following broad categories:</p>
<ul>
<li>'this.' preferences</li>
<li>predefined type preferences</li>
<li>'var' preferences</li>
<li>Code block preferences</li>
<li>Expression preferences</li>
<li>Variable preferences</li>
<li>'null' checking</li>
</ul>
<p>Each category has a set of one or more rules, each with two fields:</p>
<ul>
<li>Preference: A string identifying the preference for the rule. Normally, it has two possible values, one indicating that the rule should be preferred, and the other indicating the rule should not be preferred. For example, for a 'this.' preference rule, the possible values are:
<ul>
<li>Do not prefer 'this.': This enforces that code with the <kbd>'this.'</kbd> prefix to member accesses is flagged.</li>
<li>Prefer 'this.': This ensures that code without 'this.' prefix to member accesses is flagged.</li>
</ul>
</li>
<li>Severity: An enum identifying the severity of the rule. It has the following possible values and visual effects:
<ul>
<li>Error: Violations of the rule produce error diagnostics in the error list and red squiggles in the code editor.</li>
<li>Warning: Violations of the rule produce warning diagnostics in the error list and green squiggles in the code editor.</li>
<li>Suggestion: Violations of the rule produce informational message diagnostics in the error list and gray dots under the first couple of characters of violating syntax in the code editor.</li>
<li>None: Rule is not enforced in the editor and there are no diagnostics in the error list or visual indicators in the editor.</li>
</ul>
</li>
</ul>
<p>Users can configure the preference and severity of each rule as per their requirements using the Tools | Options dialog. Closing and re-opening the source documents causes the configuration changes to take effect and the violations are reported in the error list and visual indicators (squiggles/dots) appear in the code editor. Each rule comes with a code fix and FixAll support to fix one or more instances of the violation across the document, project, or solution.</p>
<p>Diagnostics reported for the built-in code style rules are only produced during live code editing in Visual Studio 2017 -they do not break the build and are not produced during the command-line builds. This behavior may or may not change in future versions of Visual Studio.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There is more...</h1>
                
            
            
                
<p>Code style rule preferences are saved with user profile settings and persisted across Visual Studio sessions on the machine for the same Visual Studio install. This means that any project opened in Visual Studio will have the same code style enforcement. However, the same sources opened on a different Visual Studio installation or a different machine with a different user profile will not have the same code style enforcement. To enable same code style enforcement for a repo across all users, users need to persist the code style settings into an <kbd>.editorconfig</kbd> file and check it into the repo along with the sources. Refer to, <em>Using .editorconfig file for per-folder configuration for code style rules</em>, recipe in this chapter for further details.</p>
<p>Consider exploring the Naming rules in the Tools | Options... dialog under Text Editor | C# | Code Style | Naming. These rules allow users to enforce guidelines on how each different symbol kind should be named. For example, interface names should start with capital letter "I", type name should be Pascal cased, and so on.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Using the .editorconfig file for configuration of code style rules</h1>
                
            
            
                
<p>In this section, we will show you how to configure the code style rules built into Visual Studio 2017 using the EditorConfig file, and how to override these settings at different folder levels. These EditorConfig files can be checked into the repo along with source files and this ensures the code style settings are persisted and enforced for all repo contributors.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>You will need to have Visual Studio 2017 installed on your machine to execute the recipes in this chapter. You can install a free community version of Visual Studio 2017 from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15</a>.</p>
<p>Install the <kbd>EditorConfig Language Service</kbd> VSIX from the Visual Studio extension gallery at <a href="http://vsixgallery.com/extension/1209461d-57f8-46a4-814a-dbe5fecef941/">http://vsixgallery.com/extension/1209461d-57f8-46a4-814a-dbe5fecef941/</a> to get intellisense and autocompletion for <kbd>.editorconfig</kbd> files in Visual Studio.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Start Visual Studio, click on File | New | Project..., create a new C# class library project, and replace the code in <kbd>Class1.cs</kbd> with code from the code sample at <kbd>ClassLibrary/Class1.cs</kbd>.</li>
<li>Add a new text file named <kbd>.editorconfig</kbd> to the project with the following contents:</li>
</ol>
<pre style="padding-left: 90px">
# top-most EditorConfig file<br/>root = true<br/><br/># rules for all .cs files.<br/>[*.cs]<br/><br/># 'this.' preferences<br/>dotnet_style_qualification_for_field = false:suggestion<br/>dotnet_style_qualification_for_property = false:suggestion<br/>dotnet_style_qualification_for_method = false:suggestion<br/>dotnet_style_qualification_for_event = false:suggestion<br/><br/># predefined type preferences<br/>dotnet_style_predefined_type_for_locals_parameters_members = true:warning<br/>dotnet_style_predefined_type_for_member_access = true:warning<br/><br/># 'var' preferences<br/>csharp_style_var_for_built_in_types = true:error<br/>csharp_style_var_when_type_is_apparent = true:error<br/>csharp_style_var_elsewhere = true:error<br/><br/># code block preferences<br/>csharp_new_line_before_open_brace = all<br/>csharp_style_expression_bodied_methods = true:warning<br/>csharp_style_expression_bodied_constructors = false:warning<br/>csharp_style_expression_bodied_operators = false:warning<br/>csharp_style_expression_bodied_properties = true:warning<br/>csharp_style_expression_bodied_indexers = true:warning<br/>csharp_style_expression_bodied_accessors = true:warning<br/><br/># expression preferences<br/>dotnet_style_object_initializer = true:suggestion<br/>dotnet_style_collection_initializer = true:suggestion<br/>csharp_style_pattern_matching_over_is_with_cast_check = true:suggestion<br/>csharp_style_pattern_matching_over_as_with_null_check = true:suggestion<br/>dotnet_style_explicit_tuple_names = true:suggestion<br/><br/># variable preferences<br/>csharp_style_inlined_variable_declaration = true:suggestion<br/><br/># 'null' checking<br/>csharp_style_throw_expression = true:suggestion<br/>csharp_style_conditional_delegate_call = true:suggestion<br/>dotnet_style_coalesce_expression = true:suggestion<br/>dotnet_style_null_propagation = true:suggestion
</pre>
<ol start="3">
<li>Verify the following code style diagnostics in the error list:</li>
</ol>
<div><img class="image-border" height="309" src="img/d3b69fa0-88c8-42ed-a5fd-ba1ab89b5cb1.png" width="828"/></div>
<ol start="4">
<li>Double-click on the first IDE0007 error and verify that a light bulb is offered for a code fix to use 'var' instead of explicit type. Verify that hitting the <em>Enter</em> key fixes the code and the diagnostic is removed from the error list. Repeat the exercise for the remaining IDE0007 diagnostics.</li>
<li>Then, double-click on the first IDE0012 warning and verify that a light bulb is offered to Simplify name 'System.Int32'. This time, click on the Fix all occurrences in <strong>Document</strong> hyperlink and verify that a preview changes dialog comes up, which fixes all instances of IDE0012 in the document with a single batch fix.</li>
<li>Apply code fixes for each of the remaining diagnostics in the error list and verify the code is now completely clean:</li>
</ol>
<pre style="padding-left: 90px">
using System;<br/><br/>class Class1<br/>{<br/> // Field and Property - prefer predefined type<br/> private int field1;<br/> private int Property1 =&gt; int.MaxValue;<br/><br/> private void Method_DoNotPreferThis()<br/> {<br/>  Console.WriteLine(field1);<br/>  Console.WriteLine(Property1);<br/>  Method_PreferExpressionBody();<br/> }<br/><br/> private int Method_PreferVar()<br/> {<br/>  var i = 0;<br/>  var c = new Class1();<br/>  var c2 = Method_PreferExpressionBody();<br/>  return i;<br/> }<br/><br/> private void Method_PreferBraces(bool flag)<br/> {<br/>  if (flag)<br/>  {<br/>   Console.WriteLine(flag);<br/>  }<br/> }<br/><br/> private Class1 Method_PreferExpressionBody() =&gt; Method_PreferPatternMatching(null);<br/><br/> private Class1 Method_PreferPatternMatching(object o)<br/> {<br/>  if (o is Class1 c)<br/>  {<br/>   return c;<br/>  }<br/><br/>  return new Class1();<br/> }<br/><br/> private int Method_PreferInlineVariableDeclaration(string s)<br/> {<br/>  if (int.TryParse(s, out var i))<br/>  {<br/>   return i;<br/>  }<br/><br/>  return -1;<br/> }<br/><br/> private void Method_NullCheckingPreferences(object o)<br/> {<br/>  var str = o?.ToString();<br/>  var o3 = o ?? new object();<br/> }<br/>}
</pre>
<ol start="7">
<li>Add a new folder, say <kbd>NewFolder</kbd>, to the root of the project and add a new class, say <kbd>Class2.cs</kbd>, to the folder with the following method and verify IDE0007 (use 'var' instead of explicit type) is raised for the code style violation in the newly added code.</li>
</ol>
<pre style="padding-left: 90px">
private void Method_New_ViolateVarPreference()<br/>{<br/> Class1 c = new Class1();<br/>}
</pre>
<ol start="8">
<li>Add a new text file named <kbd>.editorconfig</kbd> to <kbd>NewFolder</kbd> with the following contents:</li>
</ol>
<pre style="padding-left: 90px">
# rules for all .cs files in this folder.<br/>[*.cs]<br/><br/># override 'var' preferences<br/>csharp_style_var_for_built_in_types = false:error<br/>csharp_style_var_when_type_is_apparent = false:error<br/>csharp_style_var_elsewhere = false:error
</pre>
<ol start="9">
<li>Close and reopen <kbd>Class2.cs</kbd> and verify the IDE0007 is no longer reported.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>Refer to the <em>How it works...,</em> section in the recipe, <em>Configuring C# code style rules built into Visual Studio 2017,</em> in this chapter to understand the different built-in code style rules in Visual Studio 2017, the Preference and Severity settings associated with these rules and how they map to the editor config entries. For example, consider the following entry:</p>
<pre>
dotnet_style_qualification_for_field = false:suggestion
</pre>
<p><kbd>dotnet_style_qualification_for_field</kbd> is the rule name, with the preference <kbd>false</kbd> and severity <kbd>suggestion</kbd>. These rules and their settings are enforced at each folder level, with the EditorConfig file at any folder level overriding the settings from the EditorConfig files in the ancestor directories, until the root file path is reached or an EditorConfig file with <kbd>root=true</kbd> is found. We recommend you refer to the following articles to get a detailed understanding of EditorConfig and related support in Visual Studio 2017:</p>
<ul>
<li>Editorconfig file format: <a href="http://editorconfig.org/">http://EditorConfig.org/</a></li>
<li>Editorconfig support for .NET code style in VS2017: <a href="https://blogs.msdn.microsoft.com/dotnet/2016/12/15/code-style-configuration-in-the-vs2017-rc-update/">https://blogs.msdn.microsoft.com/dotnet/2016/12/15/code-style-configuration-in-the-vs2017-rc-update/</a></li>
<li>Editorconfig reference for .NET code style in VS2017: <a href="https://docs.microsoft.com/en-us/visualstudio/ide/editorconfig-code-style-settings-reference">https://docs.microsoft.com/en-us/visualstudio/ide/EditorConfig-code-style-settings-reference</a></li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Using the public API analyzer for API surface maintenance</h1>
                
            
            
                
<p>The <kbd>DeclarePublicAPIAnalyzer</kbd> analyzer is a popular third-party analyzer developed at the (<a href="https://github.com/dotnet/roslyn-analyzers">https://github.com/dotnet/roslyn-analyzers</a>) repo and published as a NuGet package at <a href="https://www.nuget.org/packages/Roslyn.Diagnostics.Analyzers/">https://www.nuget.org/packages/Roslyn.Diagnostics.Analyzers</a>. This analyzer helps track the public surface area of a project with additional readable and reviewable text files that live along with the project sources and provide API documentation as a source. For example, consider the following source file with public and non-public symbols:</p>
<pre>
public class Class1<br/>{<br/>  public int Field1;<br/><br/>  public object Property1 =&gt; null;<br/><br/>  public void Method1() { }<br/><br/>  public void Method1(int x) { }<br/><br/>  private void Method2() { }<br/>}
</pre>
<p>The additional API surface text file for this type will look as follows:</p>
<pre>
Class1<br/>Class1.Class1() -&gt; void<br/>Class1.Field1 -&gt; int<br/>Class1.Method1() -&gt; void<br/>Class1.Method1(int x) -&gt; void<br/>Class1.Property1.get -&gt; object
</pre>
<p>There is an entry for every public symbol: type <em>Class1</em>, its constructor and it's members <em>Field1, Method1</em> overloads, and the <em>Property1</em> getter. Entries contain the entire symbol signature, including the return type and parameters.</p>
<p>With this NuGet package, users can track the shipped and unshipped public API surface at any point of time, get live and build breaking diagnostics when the public API surface is changed, and apply code fixes to update these additional files to match the local API changes. This enables richer and more focused API reviews when the actual code changes are large and spread across the code base, but the API changes can be reviewed by just looking at core signature changes in a single file.</p>
<div><strong>DeclarePublicAPIAnalyzer</strong> was written primarily for tracking the public API surface of the Roslyn source base at <a href="https://github.com/dotnet/roslyn">https://github.com/dotnet/roslyn</a> and is still very popular among all Roslyn contributors. The analyzer was eventually converted into a general-purpose open source analyzer that can be installed for any .NET project from <a href="http://NuGet.org">NuGet.org</a>.</div>
<p>In this section, we will show you how to install and configure the public API analyzer for a C# project, walk you through the additional text files tracking the public API surface, show you the diagnostics reported from this analyzer with API changes, and finally show you how to apply code fixes to fix one or multiple instances of these diagnostics to update the API surface text files.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>You will need to have Visual Studio 2017 installed on your machine to execute the recipes in this chapter. You can install a free community version of Visual Studio 2017 from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Start Visual Studio, click on File | New | Project..., create a new C# class library project, and replace the code in <kbd>Class1.cs</kbd> with code from the code sample at <kbd>ClassLibrary/Class1.cs</kbd> (also mentioned in the <em>Introduction</em> section of this recipe).</li>
<li>Install the <kbd>Roslyn.Diagnostics.Analyzers</kbd> NuGet package Version <em>1.2.0-beta2</em>. For guidance on how to search for and install the analyzer NuGet package in a project, refer to the recipe <em>Searching and installing analyzers through the NuGet package manager,</em> in <a href="8e0229af-657f-4306-96b5-40511d1fe7b2.xhtml">Chapter 2</a>, <em>Consuming Diagnostic Analyzers in .NET Projects</em>.</li>
</ol>
<p> </p>
<ol start="3">
<li>Escalate the severity of <em>RS0016</em> and <em>RS0017</em> from Warning to Error. For guidance on analyzer severity configuration, refer to the recipe, <em>Viewing and configuring analyzers in solution explorer in Visual Studio</em> in <a href="8e0229af-657f-4306-96b5-40511d1fe7b2.xhtml">Chapter 2</a>, <em>Consuming Diagnostic Analyzers in .NET Projects.</em></li>
<li>Add two new text files named <kbd>PublicAPI.Shipped.txt</kbd> and <kbd>PublicAPI.Unshipped.txt</kbd> to the project.</li>
<li>Select both text files in the solution explorer, change their build action from Content to AdditionalFiles using the Properties window, and save the project:</li>
</ol>
<div><img class="image-border" height="469" src="img/fa5b4e08-f2ed-4279-9d0b-d125fdd2209f.png" width="267"/></div>
<ol start="6">
<li>Verify squiggles in the editor and six <em>RS0016</em> errors (the '<em>x</em>' is not part of the declared API) in the error list, one for each public symbol:</li>
</ol>
<div><img class="image-border" height="410" src="img/997e7f84-5a52-4a60-89cf-7ae5c942be8e.png" width="761"/></div>
<ol start="7">
<li>Move the caret to the field symbol <kbd>Field1</kbd> and hit <em>Ctrl</em> + dot(.) to get the code fix to automatically fix the diagnostic and add the symbol to the unshipped public API text file:</li>
</ol>
<div><img class="image-border" height="167" src="img/9e203eb7-23f2-467a-bbd2-e3ba6549d37f.png" width="559"/></div>
<ol start="8">
<li>Apply the code fix by hitting the <em>Enter</em> key and verify the entry <kbd>Class1.Field1 -&gt; int</kbd> is added to <kbd>PublicAPI.Unshipped.txt</kbd> and the diagnostic and squiggle for <kbd>Field1</kbd> no longer exist.</li>
</ol>
<p> </p>
<ol start="9">
<li>Move the caret to the type declaration for <em>Class1</em> and again hit <em>Ctrl</em> + dot to get the code fix, but this time apply a FixAll code fix to batch fix all RS0016 instances in the entire document and add all public symbols to the unshipped public API text file. For guidance on applying FixAll code fixes, refer to the recipe, <em>Applying batch code fixes (FixAll) across different scopes: document, project and solution</em>, in <a href="b14c99a8-f390-4888-a441-54ebfb46d0c7.xhtml">Chapter 3</a>, <em>Writing IDE Code Fixes, Refactorings and Intellisense Completion Providers.</em></li>
<li>Cut the entire contents of <kbd>PublicAPI.Unshipped.txt</kbd> and paste it into <kbd>PublicAPI.Shipped.txt</kbd>.</li>
<li>In <kbd>Class1.cs</kbd>, attempt to introduce a breaking API change by renaming the shipped public symbol <kbd>Field1</kbd> to <kbd>Field2</kbd><em>.</em></li>
<li>Verify <em>RS0016</em> is immediately reported for <kbd>Field2</kbd> and a code fix is offered to add a public API entry for <kbd>Field2</kbd><em>.</em> Apply the code fix to add <kbd>Field2</kbd> to the public API surface and fix the diagnostic.</li>
<li>Build the project and verify that the project fails to build with the following <em>RS0017</em> diagnostic in the output window for the breaking change: <kbd>ClassLibraryPublicAPI.Shipped.txt(3,1,3,21): error RS0017: Symbol 'Class1.Field1 -&gt; int' is part of the declared API, but is either not public or could not be found</kbd>.</li>
<li>Undo the changes in steps 11 and 12.</li>
<li>Change <kbd>Method2</kbd> to be a public method, verify <em>RS0016</em> is reported for it, and use the code fix to add it's API entry to <kbd>PublicAPI.Unshipped.txt</kbd>.</li>
<li>Now, rename the <kbd>unshipped</kbd> public symbol from <kbd>c</kbd> to <kbd>Method3</kbd><em>.</em> Verify that <em>RS0016</em> is reported for <kbd>Method3</kbd> and the code fix replaces the public API entry for <em>Method2</em> with the entry for <kbd>Method3</kbd>:</li>
</ol>
<div><img class="image-border" height="144" src="img/629732ef-e6d7-46d1-a818-2416d0aee6f7.png" width="603"/></div>
<ol start="17">
<li>Apply the code fix and verify that the build succeeds and there are no diagnostics in the error list.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p><kbd>DeclarePublicAPIAnalyzer</kbd> is an additional file analyzer that works by comparing the public symbols declared in the compilation against the public API entries in the shipped and unshipped API surface text files. It uses a unique string representation for each symbol, based on its fully qualified name and signature as it's public API entry. It reports diagnostics for any missing or extra public API entries. You can find the implementation of this analyzer at <a href="https://github.com/dotnet/roslyn-analyzers/blob/master/src/Roslyn.Diagnostics.Analyzers/Core/DeclarePublicAPIAnalyzer.cs">https://github.com/dotnet/roslyn-analyzers/blob/master/src/Roslyn.Diagnostics.Analyzers/Core/DeclarePublicAPIAnalyzer.cs</a>, and its corresponding code fix provided at <a href="https://github.com/dotnet/roslyn-analyzers/blob/master/src/Roslyn.Diagnostics.Analyzers/Core/DeclarePublicAPIFix.cs">https://github.com/dotnet/roslyn-analyzers/blob/master/src/Roslyn.Diagnostics.Analyzers/Core/DeclarePublicAPIFix.cs</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>You can read more about how to write and consume additional file analyzers, such as the DeclarePublicAPIAnalyzer, at <a href="https://github.com/dotnet/roslyn/blob/master/docs/analyzers/Using%20Additional%20Files.md">https://github.com/dotnet/roslyn/blob/master/docs/analyzers/Using%20Additional%20Files.md</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Using third-party StyleCop analyzers for code style rules</h1>
                
            
            
                
<p>In this section, we will introduce you to a popular third-party analyzer package for code style rules for C# projects, StyleCop analyzers. We will walk through how to install the StyleCop analyzers NuGet package, give example violations for each of the StyleCop rule categories, and show you how to configure and tune individual StyleCop rules.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>You will need to have Visual Studio 2017 installed on your machine to execute the recipes in this chapter. You can install a free community version of Visual Studio 2017 from <a href="https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15">https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&amp;rel=15</a>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<ol>
<li>Start Visual Studio, navigate to File | New | Project..., create a new C# class library project, and replace the code in <kbd>Class1.cs</kbd> with code from the code sample at <kbd>ClassLibrary/Class1.cs</kbd>.</li>
<li>Install the <kbd>StyleCop.Analyzers</kbd> NuGet package (as of this writing, the latest prerelease version is <em>1.1.0-beta001</em>). For guidance on how to search for and install analyzer NuGet package in a project, refer to the recipe, <em>Searching and installing analyzers through the NuGet package manager</em> in <a href="8e0229af-657f-4306-96b5-40511d1fe7b2.xhtml">Chapter 2</a>, <em>Consuming Diagnostic Analyzers in .NET Projects</em>.</li>
<li>Verify the following StyleCop diagnostics show up in the error list:</li>
</ol>
<div><img class="image-border" height="283" src="img/9230d185-ddbd-49aa-8c5a-0408dd39dc67.png" width="927"/></div>
<ol start="4">
<li>Build the project from the command-line or top-level Build menu in Visual Studio and verify these diagnostics are also reported from the build.</li>
</ol>
<p> </p>
<ol start="5">
<li>Double-click on the warning <em>SA1025</em> <em>Code must not contain multiple whitespace characters in a row,</em> verify that the lightbulb is offered in the editor to fix the spacing violation, and applying the code fix by hitting the <em>Enter</em> key fixes it:</li>
</ol>
<div><img class="image-border" height="210" src="img/8e7acd55-b902-4313-9df6-97438d3adb08.png" width="550"/></div>
<ol start="6">
<li>Then, double-click on the warning SA1200 Using directive must appear within a namespace declaration and verify it is reported on the using statement <kbd>using System;</kbd> due to it being outside the namespace <kbd>Namespace</kbd>.</li>
<li>Add a new file to the project named <kbd>stylecop.json</kbd>.</li>
<li>Select <kbd>stylecop.json</kbd> in the solution explorer, change its build action from Content to AdditionalFiles using the Properties window, and save the project:</li>
</ol>
<div><img class="image-border" height="511" src="img/fd18c60e-a282-4d68-b637-3e3d859ef4da.png" width="293"/></div>
<ol start="9">
<li>Add the following text to <kbd>stylecop.json</kbd> and verify that <em>SA1200</em> is no longer reported:</li>
</ol>
<pre style="padding-left: 90px">
{<br/>  "settings": {<br/>    "orderingRules": {<br/>      "usingDirectivesPlacement": "<strong>outsideNamespace</strong>"<br/>    }<br/>  }<br/>}
</pre>
<ol start="10">
<li>Move <kbd>using System;</kbd> inside the namespace <kbd>Namespace</kbd> and verify <em>SA1200</em> <em>(</em>using directive must appear outside a namespace declaration) is now reported for the using statement being inside the namespace.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>The StypeCop analyzers contain the following categories of style rules:</p>
<ul>
<li><strong>Spacing rules (SA1000-)</strong> (<a href="https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/SpacingRules.md">https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/SpacingRules.md</a>): Rules that enforce spacing requirements around keywords and symbols in the code</li>
<li><strong>Readability rules (SA1100-)</strong> (<a href="https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/ReadabilityRules.md">https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/ReadabilityRules.md</a>): Rules that ensure that the code is well-formatted and readable</li>
<li><strong>Ordering rules (SA1200-)</strong> (<a href="https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/OrderingRules.md">https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/OrderingRules.md</a>): Rules that enforce a standard ordering scheme for code contents</li>
<li><strong>Naming rules (SA1300-)</strong> (<a href="https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/NamingRules.md">https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/NamingRules.md</a>): Rules that enforce naming requirements for members, types, and variables</li>
<li><strong>Maintainability rules (SA1400-)</strong> (<a href="https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/MaintainabilityRules.md">https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/MaintainabilityRules.md</a>): Rules that improve code maintainability</li>
<li><strong>Layout rules (SA1500-)</strong> (<a href="https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/LayoutRules.md">https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/LayoutRules.md</a>): Rules that enforce code layout and line spacing</li>
<li><strong>Documentation rules (SA1600-)</strong> (<a href="https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/DocumentationRules.md">https://github.com/DotNetAnalyzers/StyleCopAnalyzers/blob/master/documentation/DocumentationRules.md</a>): Rules that verify the content and formatting of code documentation</li>
</ul>
<p>The code example that we provided had the following StyleCop diagnostics by category:</p>
<ul>
<li><strong>Spacing</strong>:
<ul>
<li>SA1025 (Code must not contain multiple whitespace characters in a row)</li>
</ul>
</li>
<li><strong>Readability</strong>:
<ul>
<li>SA1101 (Prefix local calls with this)</li>
</ul>
</li>
<li><strong>Ordering</strong>:
<ul>
<li>SA1200 (Using directive must appear within a namespace declaration)</li>
</ul>
</li>
<li><strong>Naming</strong>:
<ul>
<li>SA1300 (Element "method" must begin with an uppercase letter)</li>
<li>SA1303 (Const field names must begin with uppercase letter)</li>
</ul>
</li>
<li><strong>Maintainability</strong>:
<ul>
<li>SA1401 (Field must be private)</li>
<li>SA1402 (File may only contain a single type)</li>
</ul>
</li>
<li><strong>Layout</strong>:
<ul>
<li>SA1502 (Element must not be on a single line)</li>
<li>SA1503 (Braces must not be omitted)</li>
<li>SA1505 (An opening brace must not be followed by a blank line)</li>
</ul>
</li>
<li><strong>Documentation</strong>:
<ul>
<li>SA1600 (Elements must be documented)</li>
<li>SA1633 (The file header is missing or not located at the top of the file)</li>
</ul>
</li>
</ul>
<p>The StyleCop analyzers package also comes with code fixes for certain rules to fix the violations.</p>
<p>The StyleCop analyzers can be installed either as a NuGet package (<a href="http://www.nuget.org/packages/StyleCop.Analyzers/">http://www.nuget.org/packages/StyleCop.Analyzers/</a>) for specific C# projects/solutions or as a VSIX Extension enabled for all C# projects. The NuGet package enables the build-time StyleCop diagnostics and hence is the recommended way of installing the analyzers.</p>
<p>The code style is generally considered to be a very subjective matter, and hence it is very important that individual rules can be selectively enabled, suppressed, or configured by the end user.</p>
<ul>
<li>StyleCop rules can be enabled or suppressed using the code analysis ruleset files (see the recipe, <em>Using ruleset file and ruleset editor to configure analyzers,</em> in <a href="8e0229af-657f-4306-96b5-40511d1fe7b2.xhtml">Chapter 2</a>, <em>Consuming Diagnostic Analyzers in .NET Projects</em> for reference).</li>
<li>Stylecop rules can be configured and tuned using a <kbd>stylecop.json</kbd> file added to the project as an additional non-source file. For example, consider the ordering rule <em>SA1200</em> (using directive must appear within a namespace declaration) at (<a href="http://www.nuget.org/packages/StyleCop.Analyzers/">http://www.nuget.org/packages/StyleCop.Analyzers/</a>). By default, this rule reports violations if using directives are placed at the top of the file <em>outside</em> a namespace declaration. However, this rule can be configured to be its semantic opposite and require using directives to be outside a namespace declaration and report violations if they are <em>inside</em>, using the following <kbd>stylecop.json</kbd>:</li>
</ul>
<pre style="padding-left: 90px">
{<br/>  "settings": {<br/>    "orderingRules": {<br/>      "usingDirectivesPlacement": "<strong>outsideNamespace</strong>"<br/>    }<br/>  }<br/>}
</pre>
<p>The StyleCop analyzers repo has thorough documentation for each category of rules, as well as individual style rules. You can find the documentation at <a href="https://github.com/DotNetAnalyzers/StyleCopAnalyzers/tree/master/documentation">https://github.com/DotNetAnalyzers/StyleCopAnalyzers/tree/master/documentation</a>.</p>


            

            
        
    </body></html>