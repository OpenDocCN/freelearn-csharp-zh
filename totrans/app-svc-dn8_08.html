<html><head></head><body>
  <div><h1 class="chapterNumber">8</h1>
    <h1 class="chapterTitle" id="_idParaDest-300">Building and Securing Web Services Using Minimal APIs</h1>
    <p class="normal">This chapter is about building and securing web services using ASP.NET Core Minimal APIs. This includes implementing techniques to protect a web service from attacks as well as authentication and authorization.</p>
    <p class="normal">This chapter will cover the following topics:</p>
    <ul>
      <li class="bulletList">Building web services using ASP.NET Core Minimal APIs</li>
      <li class="bulletList">Relaxing the same origin security policy using CORS</li>
      <li class="bulletList">Preventing denial of service attacks using rate limiting</li>
      <li class="bulletList">Improving startup time and resources using native AOT</li>
      <li class="bulletList">Understanding identity services</li>
    </ul>
    <h1 class="heading-1" id="_idParaDest-301">Building web services using ASP.NET Core Minimal APIs</h1>
    <p class="normal">In older versions of <a id="_idIndexMarker718"/>ASP.NET Core, you would build a web service using controllers with an action method for each endpoint, a bit like<a id="_idIndexMarker719"/> building a website with <a id="_idIndexMarker720"/>ASP.NET Core MVC using controllers and models but without the views. Since .NET 6, you have another, often better, choice: <strong class="keyWord">ASP.NET Core</strong> <strong class="keyWord">Minimal APIs</strong>.</p>
    <h2 class="heading-2" id="_idParaDest-302">Benefits of Minimal API-based web services</h2>
    <p class="normal">In earlier versions of ASP.NET Core, implementing even a simple web service required a lot of boilerplate code compared to<a id="_idIndexMarker721"/> alternative web development platforms. For example, a minimal <code class="inlineCode">Hello World</code> web service implementation that<a id="_idIndexMarker722"/> has a single endpoint that returns plain text could be<a id="_idIndexMarker723"/> implemented using <strong class="keyWord">Express.js</strong> in just nine lines of code, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">const express = require('express')
const app = express()
const port = 3000
app.get('/', (req, res) =&gt; {
  res.send('Hello World!')
})
app.listen(port, () =&gt; {
  console.log(`Example app listening on port ${port}`)
})
</code></pre>
    <p class="normal">With ASP.NET Core 5 or earlier, that would require more than fifty lines of code!</p>
    <p class="normal">The equivalent using ASP.NET Core 6 or later using ASP.NET Core Minimal APIs is now only five lines of code and six lines of configuration, as shown in the following two code blocks:</p>
    <pre class="programlisting code"><code class="hljs-code">int port = 3000;
var app = WebApplication.Create();
app.MapGet("/", () =&gt; "Hello World!");
Console.WriteLine($"Example app listening on port {port}");
await app.RunAsync($"https://localhost:{port}/");
</code></pre>
    <p class="normal">The platform is specified in the project file, and the implicit <code class="inlineCode">using</code> statements SDK feature does some heavy lifting. It is enabled by default, as shown highlighted in the following markup:</p>
    <pre class="programlisting code"><code class="hljs-code">&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;
  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
<strong class="hljs-slc">    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;</strong>
  &lt;/PropertyGroup&gt;
&lt;/Project&gt;
</code></pre>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Another benefit of minimal APIs is that they do not use dynamically generated code, unlike controller-based Web APIs. This allows them to use native AOT to produce smaller, faster services that are better for implementing and hosting microservices in containers. We will cover native AOT with minimal APIs later in this chapter. Whenever possible, implement your web services <a id="_idIndexMarker724"/>using minimal APIs instead of <a id="_idIndexMarker725"/>controllers.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-303">Understanding Minimal API route mappings</h2>
    <p class="normal">The <code class="inlineCode">WebApplication</code> instance has <a id="_idIndexMarker726"/>methods that you can call to map a route to a <a id="_idIndexMarker727"/>lambda expression or statement:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">MapGet</code>: Map a route to a <code class="inlineCode">GET</code> request to retrieve an entity.</li>
      <li class="bulletList"><code class="inlineCode">MapPost</code>: Map a route to a <code class="inlineCode">POST</code> request to insert an entity.</li>
      <li class="bulletList"><code class="inlineCode">MapPut</code>: Map a route to a <code class="inlineCode">PUT</code> request to update an entity.</li>
      <li class="bulletList"><code class="inlineCode">MapPatch</code>: Map a route to a <code class="inlineCode">PATCH</code> request to update an entity.</li>
      <li class="bulletList"><code class="inlineCode">MapDelete</code>: Map a route to a <code class="inlineCode">DELETE</code> request to delete an entity.</li>
      <li class="bulletList"><code class="inlineCode">MapMethods</code>: Map a route to any other HTTP method or methods, for example, <code class="inlineCode">CONNECT</code> or <code class="inlineCode">HEAD</code>.</li>
    </ul>
    <p class="normal">For example, you might want to map an HTTP <code class="inlineCode">GET</code> request for the relative path <code class="inlineCode">api/customers</code> to a delegate defined by a lambda expression or a function that returns a JSON document containing a list of customers, and equivalent mappings to insert and delete, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">app.MapGet("api/customers", GetCustomers);
app.MapPost("api/customers", InsertCustomer);
app.MapDelete("api/customers/{id}", DeleteCustomer);
</code></pre>
    <p class="normal">You might want to map an HTTP <code class="inlineCode">CONNECT</code> request for the relative path <code class="inlineCode">api/customers</code> to a lambda statement block, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">app.MapMethods("api/customers", new[] { "CONNECT" }, () =&gt;
  { 
    // Do something.
  });
</code></pre>
    <p class="normal">If you have multiple endpoints that share a common relative path, then you can define a <strong class="keyWord">route group</strong>. The <code class="inlineCode">MapGroup</code> method<a id="_idIndexMarker728"/> was <a id="_idIndexMarker729"/>introduced in .NET 7:</p>
    <pre class="programlisting code"><code class="hljs-code">RouteGroupBuilder group = app.MapGroup("api/customers")
group.MapGet("/", GetCustomers)
  .MapGet("/{id}", GetCustomerById)
  .MapPost("/", InsertCustomer)
  .MapDelete("/{id}", DeleteCustomer);
</code></pre>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You<a id="_idIndexMarker730"/> can learn more about mapping routes at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/route-handlers">https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/route-handlers</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-304">Understanding parameter mapping</h2>
    <p class="normal">The delegate can have parameters defined that can be set automatically. Although most mappings can be configured without<a id="_idIndexMarker731"/> explicitly being specified, you can optionally use <a id="_idIndexMarker732"/>attributes to define where ASP.NET Core Minimal APIs should set the parameter values from:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">[FromServices]</code>: The parameter will be set from the registered dependency services.</li>
      <li class="bulletList"><code class="inlineCode">[FromRoute]</code>: The parameter will be set from a matching named route segment.</li>
      <li class="bulletList"><code class="inlineCode">[FromQuery]</code>: The parameter will be set from a matching named query string parameter.</li>
      <li class="bulletList"><code class="inlineCode">[FromBody]</code>: The parameter will be set from the body of the HTTP request.</li>
    </ul>
    <p class="normal">For example, to update an entity in a database, you would need a database context to be retrieved from the registered dependency services, an identifier passed as a query string or route segment, and the new entity in the body of the request, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">app.MapPut("api/customers/{id}", async (
  [FromServices] NorthwindContext db,
  [FromRoute] string id, // or [FromQuery] string id,
  [FromBody] Customer customer) =&gt;
{
  Customer? existingCustomer = await db.Customers.FindAsync(id);
  ...
});
</code></pre>
    <h2 class="heading-2" id="_idParaDest-305">Understanding return values</h2>
    <p class="normal">A minimal<a id="_idIndexMarker733"/> API service can return <a id="_idIndexMarker734"/>data in some common formats, as shown in <em class="italic">Table 8.1</em>:</p>
    <table class="table-container" id="table001-6">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Type</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Lambda</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">Plain text</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">() =&gt; "Hello World!"</code></p>
            <p class="normal"><code class="inlineCode">() =&gt; Results.Text("Hello World!")</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">JSON document</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">() =&gt; new { FirstName = "Bob", LastName = "Jones" }</code></p>
            <p class="normal"><code class="inlineCode">() =&gt; Results.Json(new { FirstName = "Bob", LastName = "Jones" })</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">IResult</code> with status codes</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">() =&gt; Results.Ok(new { FirstName = "Bob", LastName = "Jones" })</code></p>
            <p class="normal"><code class="inlineCode">() =&gt; Results.NoContent()</code></p>
            <p class="normal"><code class="inlineCode">() =&gt; Results.Redirect("new/path")</code></p>
            <p class="normal"><code class="inlineCode">() =&gt; Results.NotFound()</code></p>
            <p class="normal"><code class="inlineCode">() =&gt; Results.BadRequest()</code></p>
            <p class="normal"><code class="inlineCode">() =&gt; Results.Problem()</code></p>
            <p class="normal"><code class="inlineCode">() =&gt; Results.StatusCode(405)</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal">File</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">() =&gt; Results.File("/path/filename.ext")</code></p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 8.1: Examples of minimal API return values</p>
    <h2 class="heading-2" id="_idParaDest-306">Documenting a Minimal APIs service</h2>
    <p class="normal">You can call <a id="_idIndexMarker735"/>additional methods as many times as you need to specify what<a id="_idIndexMarker736"/> return types and status codes can be expected from an endpoint, for example:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">Produces&lt;T&gt;(StatusCodes.Status200OK)</code>: When successful, this route returns a response containing a type <code class="inlineCode">T</code> and status code <code class="inlineCode">200</code>.</li>
      <li class="bulletList"><code class="inlineCode">Produces(StatusCodes.Status404NotFound)</code>: When no match for the route is found, this<a id="_idIndexMarker737"/> route returns an empty response and status code 404.</li>
    </ul>
    <h2 class="heading-2" id="_idParaDest-307">Setting up an ASP.NET Core Web API project</h2>
    <p class="normal">First, we will create a simple ASP.NET Core Web API project that we will later protect using various techniques like<a id="_idIndexMarker738"/> rate limiting, CORS, and authentication and authorization.</p>
    <p class="normal">The API for this web service is defined as shown in <em class="italic">Table 8.2</em>:</p>
    <table class="table-container" id="table002-6">
      <tbody>
        <tr>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Method</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Path</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Request body</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Response body</strong></p>
          </td>
          <td class="table-cell">
            <p class="normal"><strong class="keyWord">Success code</strong></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">GET</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">/</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">None</p>
          </td>
          <td class="table-cell">
            <p class="normal">Hello World!</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">200</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">GET</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">/api/products</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">None</p>
          </td>
          <td class="table-cell">
            <p class="normal">Array of in-stock <code class="inlineCode">Product</code> objects</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">200</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">GET</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">/api/products/outofstock</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">None</p>
          </td>
          <td class="table-cell">
            <p class="normal">Array of out-of-stock <code class="inlineCode">Product</code> objects</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">200</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">GET</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">/api/products/discontinued</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">None</p>
          </td>
          <td class="table-cell">
            <p class="normal">Array of discontinued <code class="inlineCode">Product</code> objects</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">200</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">GET</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">/api/products/{id}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">None</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Product</code> object</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">200</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">GET</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">/api/products/{name}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">None</p>
          </td>
          <td class="table-cell">
            <p class="normal">Array of <code class="inlineCode">Product</code> objects that contain the name</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">200</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">POST</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">/api/products</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Product</code> object (no <code class="inlineCode">Id</code> value)</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Product</code> object</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">201</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">PUT</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">/api/products/{id}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">Product</code> object</p>
          </td>
          <td class="table-cell">
            <p class="normal">None</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">204</code></p>
          </td>
        </tr>
        <tr>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">DELETE</code></p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">/api/products/{id}</code></p>
          </td>
          <td class="table-cell">
            <p class="normal">None</p>
          </td>
          <td class="table-cell">
            <p class="normal">None</p>
          </td>
          <td class="table-cell">
            <p class="normal"><code class="inlineCode">204</code></p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="packt_figref">Table 8.2: API methods implemented by the example project</p>
    <p class="normal">Let’s go:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your<a id="_idIndexMarker739"/> preferred code editor to create a new solution named <code class="inlineCode">Chapter08</code>.</li>
      <li class="numberedList">Add a Web API project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">ASP.NET Core Web API</strong> / <code class="inlineCode">webapi</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter08</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.WebApi.Service</code></li>
          <li class="bulletList"><strong class="screenText">Authentication type</strong>: <strong class="screenText">None</strong>.</li>
          <li class="bulletList"><strong class="screenText">Configure for HTTPS</strong>: Selected.</li>
          <li class="bulletList"><strong class="screenText">Enable Docker</strong>: Cleared.</li>
          <li class="bulletList"><strong class="screenText">Enable OpenAPI support</strong>: Selected.</li>
          <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared.</li>
          <li class="bulletList"><strong class="screenText">Use controllers</strong>: Cleared.</li>
        </ul>
      
    <div><p class="normal">To create a Web API project using minimal APIs with <code class="inlineCode">dotnet new</code> for pre-.NET 8 SDKs, you must use either the <code class="inlineCode">-minimal</code> switch or the <code class="inlineCode">--use-minimal-apis</code> switch. For .NET 8 SDKs, minimal APIs are the default and to use controllers, you must specify the <code class="inlineCode">--use-controllers</code> or <code class="inlineCode">-controllers</code> switch.</p>
    </div>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> If you are using JetBrains Rider, its user interface might not yet have an option to create a web API project using minimal APIs. I recommend creating the project using <code class="inlineCode">dotnet new</code> and then adding the project to your solution.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">Add a project<a id="_idIndexMarker740"/> reference to the Northwind database context project for SQL Server that you created in <em class="chapterRef">Chapter 3</em>, <em class="italic">Building Entity Models for SQL Server Using EF Core</em>, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\..\Chapter03\Northwind.Common.DataContext
.SqlServer\Northwind.Common.DataContext.SqlServer.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      
    <div><p class="normal">The path cannot have a line break. If you did not complete the task of creating the class libraries in <em class="chapterRef">Chapter 3</em>, then download the solution projects from the GitHub repository.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">In the project file, change <code class="inlineCode">invariantGlobalization</code> to <code class="inlineCode">false</code>, and treat warnings as errors, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;
  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;InvariantGlobalization&gt;<strong class="hljs-literal-slc">false</strong>&lt;/InvariantGlobalization&gt;
<strong class="hljs-slc">    &lt;TreatWarningsAsErrors&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/TreatWarningsAsErrors&gt;</strong>
  &lt;/PropertyGroup&gt;
</code></pre>
      
    <div><p class="normal">Explicitly setting invariant globalization to <code class="inlineCode">true</code> is new in the ASP.NET Core Web API project template with .NET 8. It is designed to make a web service non-culture-specific so it can be deployed anywhere in the world and have the same behavior. By setting this property to <code class="inlineCode">false</code>, the web service will default to the culture of the current computer it is hosted on. You can read more about invariant globalization mode at the following link: <a href="https://github.com/dotnet/runtime/blob/main/docs/design/features/globalization-invariant-mode.md">https://github.com/dotnet/runtime/blob/main/docs/design/features/globalization-invariant-mode.md</a></p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">At the command <a id="_idIndexMarker741"/>prompt or terminal, build the <code class="inlineCode">Northwind.WebApi.Service</code> project to make sure the entity model class library projects outside the current solution are properly compiled, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet build
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Properties</code> folder, in <code class="inlineCode">launchSettings.json</code>, modify the <code class="inlineCode">applicationUrl</code> of the profile named <code class="inlineCode">https</code> to use port <code class="inlineCode">5081</code>, as shown highlighted in the following configuration:
        <pre class="programlisting code"><code class="hljs-code">"profiles": {
  ...
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"https"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">{</strong>
    "commandName": "Project",
    "dotnetRunMessages": true,
    "launchBrowser": true,
    "launchUrl": "swagger",
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"applicationUrl"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"https://localhost:5081"</strong><strong class="hljs-punctuation-slc">,</strong>
    "environmentVariables": {
      "ASPNETCORE_ENVIRONMENT": "Development"
    }
</code></pre>
      
    <div><p class="normal">Visual Studio 2022 will read this settings file and automatically run a web browser if <code class="inlineCode">launchBrowser</code> is <code class="inlineCode">true</code>, and then navigate to the <code class="inlineCode">applicationUrl</code> and <code class="inlineCode">launchUrl</code>. Visual Studio Code and <code class="inlineCode">dotnet run</code> will not, so you will need to run a web browser and navigate manually to <a href="https://localhost:5081/swagger">https://localhost:5081/swagger</a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">In <code class="inlineCode">Program.cs</code>, delete the statements about the weather service and replace them with statements to import the namespace to add the <code class="inlineCode">NorthwindContext</code> to <a id="_idIndexMarker742"/>configured services, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> Northwind.EntityModels; </strong><strong class="hljs-comment-slc">// To use the AddNorthwindContext method.</strong>
var builder = WebApplication.CreateBuilder(args);
// Add services to the container.
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();
<strong class="hljs-slc">builder.Services.AddNorthwindContext();</strong>
var app = builder.Build();
// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
  app.UseSwagger();
  app.UseSwaggerUI();
}
app.UseHttpsRedirection();
</code></pre>
      </li>
      <li class="numberedList">Add a new class file named <code class="inlineCode">WebApplication.Extensions.cs</code>.
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Instead of cluttering your <code class="inlineCode">Program.cs</code> file with hundreds of lines of code, define extension methods for the common types that are configured in minimal APIs, like <code class="inlineCode">WebApplication</code> and <code class="inlineCode">IServiceCollection</code>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">In <code class="inlineCode">WebApplication.Extensions.cs</code>, import namespaces for controlling HTTP results, binding <a id="_idIndexMarker743"/>a parameter to a dependency service, and working with <code class="inlineCode">Northwind</code> entity models, and then define an extension method for the <code class="inlineCode">WebApplication</code> class to configure responses to all the HTTP <code class="inlineCode">GET</code> requests documented in our API table, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.AspNetCore.Http.HttpResults; // To use Results.
using Microsoft.AspNetCore.Mvc; // To use [FromServices] and so on.
using Northwind.EntityModels; // To use NorthwindContext, Product.
namespace Packt.Extensions;
public static class WebApplicationExtensions
{
  public static WebApplication MapGets(this WebApplication app,
    int pageSize = 10)
  {
    app.MapGet("/", () =&gt; "Hello World!")
      .ExcludeFromDescription();
    app.MapGet("api/products", (
      [FromServices] NorthwindContext db,
      [FromQuery] int? page) =&gt;
      db.Products
        .Where(p =&gt; p.UnitsInStock &gt; 0 &amp;&amp; !p.Discontinued)
        .OrderBy(product =&gt; product.ProductId)
        .Skip(((page ?? 1) - 1) * pageSize)
        .Take(pageSize)
      )
      .WithName("GetProducts")
      .WithOpenApi(operation =&gt;
      {
        operation.Description =
          "Get products with UnitsInStock &gt; 0 and Discontinued = false.";
        operation.Summary = "Get in-stock products that are not discontinued.";
        return operation;
      })
      .Produces&lt;Product[]&gt;(StatusCodes.Status200OK);
    app.MapGet("api/products/outofstock", 
      ([FromServices] NorthwindContext db) =&gt; db.Products
        .Where(p =&gt; p.UnitsInStock == 0 &amp;&amp; !p.Discontinued)
      )
      .WithName("GetProductsOutOfStock")
      .WithOpenApi()
      .Produces&lt;Product[]&gt;(StatusCodes.Status200OK);
    app.MapGet("api/products/discontinued", 
      ([FromServices] NorthwindContext db) =&gt;
        db.Products.Where(product =&gt; product.Discontinued)
      )
      .WithName("GetProductsDiscontinued")
      .WithOpenApi()
      .Produces&lt;Product[]&gt;(StatusCodes.Status200OK);
    app.MapGet("api/products/{id:int}",
      async Task&lt;Results&lt;Ok&lt;Product&gt;, NotFound&gt;&gt; (
      [FromServices] NorthwindContext db,
      [FromRoute] int id) =&gt;
        await db.Products.FindAsync(id) is Product product ?
          TypedResults.Ok(product) : TypedResults.NotFound())
      .WithName("GetProductById")
      .WithOpenApi()
      .Produces&lt;Product&gt;(StatusCodes.Status200OK)
      .Produces(StatusCodes.Status404NotFound);
    app.MapGet("api/products/{name}", (
      [FromServices] NorthwindContext db,
      [FromRoute] string name) =&gt;
        db.Products.Where(p =&gt; p.ProductName.Contains(name)))
      .WithName("GetProductsByName")
      .WithOpenApi()
      .Produces&lt;Product[]&gt;(StatusCodes.Status200OK);
    return app;
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">WebApplication.Extensions.cs</code>, define an extension method for the <code class="inlineCode">WebApplication</code> class to <a id="_idIndexMarker744"/>configure a response to the HTTP <code class="inlineCode">POST</code> request documented in the API table, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public static WebApplication MapPosts(this WebApplication app)
{
  app.MapPost("api/products", async ([FromBody] Product product, 
    [FromServices] NorthwindContext db) =&gt;
  {
    db.Products.Add(product);
    await db.SaveChangesAsync();
    return Results.Created($"api/products/{product.ProductId}", product);
  }).WithOpenApi()
    .Produces&lt;Product&gt;(StatusCodes.Status201Created);
  return app;
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">WebApplication.Extensions.cs</code>, define an extension method for the <code class="inlineCode">WebApplication</code> class to configure a response to the HTTP <code class="inlineCode">PUT</code> request documented in the<a id="_idIndexMarker745"/> API table, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public static WebApplication MapPuts(this WebApplication app)
{
  app.MapPut("api/products/{id:int}", async (
    [FromRoute] int id, 
    [FromBody] Product product, 
    [FromServices] NorthwindContext db) =&gt;
  {
    Product? foundProduct = await db.Products.FindAsync(id);
    if (foundProduct is null) return Results.NotFound();
    foundProduct.ProductName = product.ProductName;
    foundProduct.CategoryId = product.CategoryId;
    foundProduct.SupplierId = product.SupplierId;
    foundProduct.QuantityPerUnit = product.QuantityPerUnit;
    foundProduct.UnitsInStock = product.UnitsInStock;
    foundProduct.UnitsOnOrder = product.UnitsOnOrder;
    foundProduct.ReorderLevel = product.ReorderLevel;
    foundProduct.UnitPrice = product.UnitPrice;
    foundProduct.Discontinued = product.Discontinued;
    await db.SaveChangesAsync();
    return Results.NoContent();
  }).WithOpenApi()
    .Produces(StatusCodes.Status404NotFound)
    .Produces(StatusCodes.Status204NoContent);
  return app;
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">WebApplication.Extensions.cs</code>, define an extension method for the <code class="inlineCode">WebApplication</code> class to configure a response to the HTTP <code class="inlineCode">DELETE</code> request documented in the<a id="_idIndexMarker746"/> API table, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public static WebApplication MapDeletes(this WebApplication app)
{
  app.MapDelete("api/products/{id:int}", async (
    [FromRoute] int id, 
    [FromServices] NorthwindContext db) =&gt;
  {
    if (await db.Products.FindAsync(id) is Product product)
    {
      db.Products.Remove(product);
      await db.SaveChangesAsync();
      return Results.NoContent();
    }
    return Results.NotFound();
  }).WithOpenApi()
    .Produces(StatusCodes.Status404NotFound)
    .Produces(StatusCodes.Status204NoContent);
  return app;
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, import the namespace to use the extension methods you just defined, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Packt.Extensions; // To use MapGets and so on.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, before the call to <code class="inlineCode">app.Run()</code>, call your custom extension methods to map <code class="inlineCode">GET</code>, <code class="inlineCode">POST</code>, <code class="inlineCode">PUT</code>, and <code class="inlineCode">DELETE</code> requests, noting that you can override the default page size of 10 entities when requesting all products, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.MapGets() // Default pageSize: 10.
  .MapPosts()
  .MapPuts()
  .MapDeletes();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, make sure the last statement in the file runs the web app, as shown in the following code:
        <pre class="programlisting gen"><code class="hljs">app.Run();
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-308">Testing web services using Swagger</h2>
    <p class="normal">Now we can start the web<a id="_idIndexMarker747"/> service, see its documentation using <a id="_idIndexMarker748"/>Swagger, and perform basic manual testing:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">If your database server is not running (for example, because you are hosting it in Docker, a virtual machine, or in the cloud), then make sure to start it.</li>
      <li class="numberedList">Start the web service project using the <code class="inlineCode">https</code> profile:<ul>
          <li class="bulletList">If you are using Visual Studio 2022, then select the <strong class="screenText">https</strong> profile in the drop-down list and then navigate to <strong class="screenText">Debug</strong> | <strong class="screenText">Start Without Debugging</strong> or press <em class="keystroke">Ctrl</em> + <em class="keystroke">F5</em>. A web browser should navigate to the Swagger documentation web page automatically.</li>
          <li class="bulletList">If you are using Visual Studio Code, then enter the command <code class="inlineCode">dotnet run --launch-profile https</code>, manually start a web browser, and navigate to the Swagger documentation web page: <a href="https://localhost:5081/swagger">https://localhost:5081/swagger</a>.</li>
        </ul>
      
    <div><p class="normal">On Windows, if prompted to do so, you will have to set Windows Defender Firewall to allow access to your local web service.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="3">In the console or<a id="_idIndexMarker749"/> terminal, note the information about your web service, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:5081
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\apps-services-net8\Chapter08\Northwind.WebApi.Service
</code></pre>
      </li>
      <li class="numberedList">In your web browser, note <a id="_idIndexMarker750"/>the Swagger documentation, as shown in <em class="italic">Figure 8.1</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_08_01.png"/></figure>
    <p class="packt_figref">Figure 8.1: Swagger documentation for the Northwind Web API service</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Click <strong class="screenText">GET /api/products</strong> to <a id="_idIndexMarker751"/>expand that section.</li>
      <li class="numberedList">Click the <strong class="screenText">Try it out</strong> button, note the optional query string parameter named <strong class="screenText">page</strong>, and then click the <strong class="screenText">Execute</strong> button.</li>
      <li class="numberedList">Note the response<a id="_idIndexMarker752"/> includes the first ten products that are in stock and not discontinued: <code class="inlineCode">1</code>, <code class="inlineCode">2</code>, <code class="inlineCode">3</code>, <code class="inlineCode">4</code>, <code class="inlineCode">6</code>, <code class="inlineCode">7</code>, <code class="inlineCode">8</code>, <code class="inlineCode">10</code>, <code class="inlineCode">11</code>, and <code class="inlineCode">12</code>.</li>
      <li class="numberedList">For the <strong class="screenText">page</strong> parameter, enter <code class="inlineCode">3</code>, and then click the <strong class="screenText">Execute</strong> button.</li>
      <li class="numberedList">Note the response includes<a id="_idIndexMarker753"/> the third page of ten products that are in stock and are not discontinued: <code class="inlineCode">25</code>, <code class="inlineCode">26</code>, <code class="inlineCode">27</code>, <code class="inlineCode">30</code>, <code class="inlineCode">32</code>, <code class="inlineCode">33</code>, <code class="inlineCode">34</code>, <code class="inlineCode">35</code>, <code class="inlineCode">36</code>, and <code class="inlineCode">37</code>.</li>
      <li class="numberedList">Click <strong class="screenText">GET /api/products</strong> to collapse that section.</li>
      <li class="numberedList">Try executing the <strong class="screenText">GET /api/products/outofstock</strong> path and note it returns one product, <strong class="screenText">31 Gorgonzola Telino</strong>, which has zero units in stock and is not discontinued.</li>
      <li class="numberedList">Try executing the <strong class="screenText">GET /api/products/discontinued</strong> path and note it returns eight products, <code class="inlineCode">5</code>, <code class="inlineCode">9</code>, <code class="inlineCode">17</code>, <code class="inlineCode">24</code>, <code class="inlineCode">28</code>, <code class="inlineCode">29</code>, <code class="inlineCode">42</code>, and <code class="inlineCode">53</code>, which all have their <code class="inlineCode">Discontinued</code> properties set to <code class="inlineCode">true</code>.</li>
      <li class="numberedList">Click <strong class="screenText">GET /api/products/{id}</strong> to expand that section.</li>
      <li class="numberedList">Click <strong class="screenText">Try it out</strong>, enter the required <strong class="screenText">id</strong> parameter as <code class="inlineCode">77</code>, click <strong class="screenText">Execute</strong>, and note the response<a id="_idIndexMarker754"/> contains the product named <strong class="screenText">Original Frankfurter grüne Soße</strong>, as shown in the following JSON document:
        <pre class="programlisting code"><code class="hljs-code">{
  "productId": 77,
  "productName": "Original Frankfurter grüne Soße",
  "supplierId": 12,
  "categoryId": 2,
  "quantityPerUnit": "12 boxes",
  "unitPrice": 13,
  "unitsInStock": 32,
  "unitsOnOrder": 0,
  "reorderLevel": 15,
  "discontinued": false,
  "category": null,
  "supplier": null,
  "orderDetails": []
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">GET /api/products/{id}</strong> to collapse that section.</li>
      <li class="numberedList">Click <strong class="screenText">GET /api/products/{name}</strong> to expand that section.</li>
      <li class="numberedList">Click <strong class="screenText">Try it out</strong>, enter the required <strong class="screenText">name</strong> parameter as <code class="inlineCode">man</code>, click <strong class="screenText">Execute</strong>, and note the response contains the products named <strong class="screenText">Queso Manchego La Pastora</strong> and <strong class="screenText">Manjimup Dried Apples</strong>.</li>
      <li class="numberedList">Leave the web service running.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-309">Testing web services with code editor tools</h2>
    <p class="normal">Using the Swagger user interface to test web services can quickly get clumsy. A better tool is either the Visual <a id="_idIndexMarker755"/>Studio Code extension named <strong class="keyWord">REST Client</strong> or the <strong class="screenText">Endpoints Explorer</strong> and <code class="inlineCode">.http</code> file support available <a id="_idIndexMarker756"/>with Visual Studio 2022 version 17.6 or later. </p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn about Visual Studio 2022 and its HTTP editor at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/test/http-files">https://learn.microsoft.com/en-us/aspnet/core/test/http-files</a>.</p>
    </div>
    <p class="normal">JetBrains Rider has a similar tool window named <strong class="screenText">Endpoints</strong>.</p>
    <div><p class="normal">If you are using JetBrains Rider, you can read about its tools for HTTP files at the following link: <a href="https://www.jetbrains.com/help/rider/Http_client_in__product__code_editor.html">https://www.jetbrains.com/help/rider/Http_client_in__product__code_editor.html</a>. It is slightly different from the other two code editors. In particular, how Rider handles setting variables is more awkward, as shown at the following link: <a href="https://www.jetbrains.com/help/rider/Exploring_HTTP_Syntax.html#example-working-with-environment-files">https://www.jetbrains.com/help/rider/Exploring_HTTP_Syntax.html#example-working-with-environment-files</a>. You might prefer to use Visual Studio Code with the REST Client extension for this section.</p>
    </div>
    <p class="normal">Let’s see how these help us test a web service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Make sure you have the web service testing tools installed:<ul>
          <li class="bulletList">If you are using Visual Studio 2022, then make sure you have version 17.6 or later (released in May 2023).</li>
          <li class="bulletList">If you are using Visual Studio Code, then make sure you have installed the REST Client extension by Huachao Mao (<code class="inlineCode">humao.rest-client</code>).</li>
          <li class="bulletList">If you are using Visual Studio 2022, navigate to <strong class="screenText">View</strong> | <strong class="screenText">Other Windows</strong> | <strong class="screenText">Endpoints Explorer</strong>, and note the current project is scanned for potential Web API endpoints, as shown in <em class="italic">Figure 8.2</em>.</li>
        </ul>
      </li>
      <li class="numberedList">In your preferred code editor, start the <code class="inlineCode">Northwind.WebApi.Service</code> project using the <code class="inlineCode">https</code> profile (if it is not already running) and leave it running.</li>
      <li class="numberedList">In the <code class="inlineCode">apps-services-net8</code> folder, if it does not already exist, create an <code class="inlineCode">HttpRequests</code> folder.</li>
      <li class="numberedList">In the <code class="inlineCode">HttpRequests</code> folder, create a file named <code class="inlineCode">webapi-get-products.http</code> and modify its contents to declare a variable to hold the base address of the Web API service products endpoint and a request to get the first page of ten products, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">### Configure a variable for the web service base address.
@base_address = https://localhost:5081/api/products/
### Get first page of 10 products that are in stock and not discontinued.
GET {{base_address}} 
</code></pre>
      
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: REST Client<a id="_idIndexMarker757"/> does not require <code class="inlineCode">GET</code> at the beginning of a request because it will assume <code class="inlineCode">GET</code> as the default. But at the time of writing, Visual Studio’s HTTP editor requires <code class="inlineCode">GET</code> to be explicitly specified. For now, I recommend that you specify the HTTP method for all tools, and I will do so for all <code class="inlineCode">.http</code> files for my books.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Click <strong class="screenText">Send Request</strong>, and note <a id="_idIndexMarker758"/>the response is the same as what was returned by Swagger, a JSON document response containing the first ten products that are in stock and not discontinued, as shown in Visual Studio 2022 in <em class="italic">Figure 8.2</em> and Visual Studio Code in <em class="italic">Figure 8.3</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_08_02.png"/></figure>
    <p class="packt_figref">Figure 8.2: Visual Studio 2022 getting products from the web API service</p>
    <figure class="mediaobject"><img alt="" src="img/B19587_08_03.png"/></figure>
    <p class="packt_figref">Figure 8.3: Visual Studio Code REST Client getting products from the web API service</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="6">In <code class="inlineCode">webapi-get-products.http</code>, add <a id="_idIndexMarker759"/>more requests separated by <code class="inlineCode">###</code>, as shown in the<a id="_idIndexMarker760"/> following file:
        <pre class="programlisting code"><code class="hljs-code">### Get third page of 10 products that are in stock and not discontinued
GET {{base_address}}?page=3
### Get products that are out-of-stock but not discontinued
GET {{base_address}}outofstock
### Get products that are discontinued
GET {{base_address}}discontinued
### Get product 77
GET {{base_address}}77
### Get products that contain "man"
GET {{base_address}}man
</code></pre>
      
    <div><p class="normal">You can execute an HTTP request in Visual Studio 2022 by clicking the green triangle “play” button, by right-clicking and selecting <strong class="screenText">Send Request</strong>, or by pressing <em class="keystroke">Ctrl</em> + <em class="keystroke">Alt</em> + <em class="keystroke">S</em>. In Visual Studio Code, click <strong class="screenText">Send Request</strong> above each query, or navigate to <strong class="screenText">View</strong> | <strong class="screenText">Command Palette</strong> and select <strong class="screenText">Rest Client: Send Request</strong>, or use its keyboard shortcut (<em class="keystroke">Ctrl</em> + <em class="keystroke">Alt</em> + <em class="keystroke">R</em> on Windows).</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">In the <code class="inlineCode">HttpRequests</code> folder, create a file named <code class="inlineCode">webapi-insert-product.http</code> and modify<a id="_idIndexMarker761"/> its contents to contain a <strong class="keyWord">POST </strong>request to insert a new product, as shown<a id="_idIndexMarker762"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code">POST https://localhost:5081/api/products/
Content-Type: application/json
{
  "productName": "Harry's Hamburgers",
  "supplierId": 7,
  "categoryId": 6,
  "quantityPerUnit": "6 per box",
  "unitPrice": 24.99,
  "unitsInStock": 0,
  "unitsOnOrder": 20,
  "reorderLevel": 10,
  "discontinued": false
}
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Send Request</strong>, and note the response indicates that the new product was added successfully because the status code is <code class="inlineCode">201</code>, and its location includes its product ID, as shown in <em class="italic">Figure 8.4</em>:
    <figure class="mediaobject"><img alt="" src="img/B19587_08_04.png"/></figure>
    <p class="packt_figref">Figure 8.4: REST Client inserting a new product by calling the web API service</p>
    <div><p class="normal">Originally, there were 77<a id="_idIndexMarker763"/> products in the Northwind database. The next product ID would be 78. The actual product ID assigned automatically will depend on whether you have previously added any other products, so your assigned number might be higher.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">In the <code class="inlineCode">HttpRequests</code> folder, create <a id="_idIndexMarker764"/>a file named <code class="inlineCode">webapi-update-product.http</code> and modify its contents to contain a <code class="inlineCode">PUT</code> request to update the product with ID <code class="inlineCode">78</code> (or whatever number was assigned to your <code class="inlineCode">Harry's Hamburgers</code>) with a different quantity per unit, unit price, and units in stock, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">PUT https://localhost:5081/api/products/78
Content-Type: application/json
{
  "productName": "Harry's Hamburgers",
  "supplierId": 7,
  "categoryId": 6,
  "quantityPerUnit": "12 per box",
  "unitPrice": 44.99,
  "unitsInStock": 50,
  "unitsOnOrder": 20,
  "reorderLevel": 10,
  "discontinued": false
}
</code></pre>
      </li>
      <li class="numberedList">Send the request and note you should get a 204 status code in the response, meaning a successful update.</li>
      <li class="numberedList">Confirm the product was updated by executing a <code class="inlineCode">GET</code> request for the product ID.</li>
      <li class="numberedList">In the <code class="inlineCode">HttpRequests</code> folder, create a file named <code class="inlineCode">webapi-delete-product.http</code> and modify its contents to contain a <code class="inlineCode">DELETE</code> request for the new product, as<a id="_idIndexMarker765"/> shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">DELETE https://localhost:5081/api/products/78
</code></pre>
      </li>
      <li class="numberedList">Note the successful <a id="_idIndexMarker766"/>response, as shown in <em class="italic">Figure 8.5</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_08_05.png"/></figure>
    <p class="packt_figref">Figure 8.5: Deleting a product using the Web API service</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="14">Send the request again and note the response contains a 404 status code because the product has now been deleted.</li>
      <li class="numberedList">Shut down the web server.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-310">Excluding paths from OpenAPI documentation</h2>
    <p class="normal">Sometimes you want to have a path that works but is not shown in the Swagger documentation. Let’s see how to<a id="_idIndexMarker767"/> remove the service base address that returns a plain text <code class="inlineCode">Hello World!</code> response from the Swagger documentation web page:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In <code class="inlineCode">WebApplication.Extensions.cs</code>, for the root path that returns <code class="inlineCode">Hello World</code>, exclude it from the OpenAPI documentation, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.MapGet("/", () =&gt; "Hello World!")
<strong class="hljs-slc">  .ExcludeFromDescription();</strong>
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Service</code> project using the <code class="inlineCode">https</code> profile without debugging and note the path is now not documented.</li>
    </ol>
    <p class="normal">We have a working web service implemented using ASP.NET Core Minimal APIs. Now let’s attack it! (So that we can learn how to prevent those attacks.)</p>
    <h2 class="heading-2" id="_idParaDest-311">Visual Studio 2022 scaffolding for Minimal APIs</h2>
    <p class="normal">It is important to learn how to implement a<a id="_idIndexMarker768"/> service using minimal APIs from scratch so that you properly understand it. But once you know how to do it manually, the process can be automated and the boilerplate code can be written for you, especially if you are building a web API that wraps an EF Core entity model.</p>
    <p class="normal">For example, Visual Studio <a id="_idIndexMarker769"/>2022 has a project item template named <strong class="screenText">API with read/write endpoints, using Entity Framework</strong> that allows you to select:</p>
    <ul>
      <li class="bulletList">An entity model class like <code class="inlineCode">Customer</code>.</li>
      <li class="bulletList">An endpoints class that will contain all the mapping methods.</li>
      <li class="bulletList">A <code class="inlineCode">DbContext</code>-derived class like <code class="inlineCode">NorthwindContext</code>.</li>
      <li class="bulletList">A database provider like SQLite or SQL Server.</li>
    </ul>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn more about this project item template at the following link: <a href="https://devblogs.microsoft.com/visualstudio/web-api-development-in-visual-studio-2022/#scaffolding-in-visual-studio/">https://devblogs.microsoft.com/visualstudio/web-api-development-in-visual-studio-2022/#scaffolding-in-visual-studio/</a>.</p>
    </div>
    <h1 class="heading-1" id="_idParaDest-312">Relaxing the same origin security policy using CORS</h1>
    <p class="normal">Modern web browsers support multiple tabs so users can visit multiple websites at the same time efficiently. If code <a id="_idIndexMarker770"/>executing in one tab could access resources in another tab, then that could be a vector of attack.</p>
    <p class="normal">All web browsers implement a <a id="_idIndexMarker771"/>security feature called the <strong class="keyWord">same origin policy</strong>. This means that only requests that come from the same origin are allowed. For example, if a block of JavaScript is served from the <a id="_idIndexMarker772"/>same origin that hosts a web service or served an <code class="inlineCode">&lt;iframe&gt;</code>, then that JavaScript can call the service and access the data in the <code class="inlineCode">&lt;iframe&gt;</code>. If a request is made from a different origin, then the request fails. But what counts as the “same origin?”</p>
    <p class="normal">An origin is defined by:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Scheme</strong> aka protocol, for example, <code class="inlineCode">http</code> or <code class="inlineCode">https</code>.</li>
      <li class="bulletList"><strong class="keyWord">Port</strong>, for example, <code class="inlineCode">801</code> or <code class="inlineCode">5081</code>. The default port for <code class="inlineCode">http</code> is <code class="inlineCode">80</code> and for <code class="inlineCode">https</code> is <code class="inlineCode">443</code>.</li>
      <li class="bulletList"><strong class="keyWord">Host/domain/subdomain</strong>, for example, <code class="inlineCode">www.example.com</code>, <code class="inlineCode">www.example.net</code>, <code class="inlineCode">example.com</code>.</li>
    </ul>
    <p class="normal">If the origin is <code class="inlineCode">https://www.example.com/about-us/</code>, then the following are <em class="italic">not</em> the same origin:</p>
    <ul>
      <li class="bulletList">Different scheme: <code class="inlineCode">http://www.example.com/about-us/</code></li>
      <li class="bulletList">Different host/domain: <code class="inlineCode">https://www.example.co.uk/about-us/</code></li>
      <li class="bulletList">Different subdomain: <code class="inlineCode">https://careers.example.com/about-us/</code></li>
      <li class="bulletList">Different port: <code class="inlineCode">https://www.example.com:444/about-us/</code></li>
    </ul>
    <p class="normal">It is the web browser that sets the <code class="inlineCode">Origin</code> header automatically when making a request. This cannot be overridden. </p>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> The same origin policy does <em class="italic">not</em> apply to any requests that come from a non-web browser because, in those cases, the programmer could change the <code class="inlineCode">Origin</code> header anyway. If you create a console app or even an ASP.NET Core project that uses .NET classes like <code class="inlineCode">HttpClient</code> to make a request, the same origin policy does not apply unless you explicitly set the <code class="inlineCode">Origin</code> header.</p>
    </div>
    <p class="normal">Let’s see some <a id="_idIndexMarker773"/>examples of calling the web <a id="_idIndexMarker774"/>service from a<a id="_idIndexMarker775"/> web page with a different origin and from a .NET app.</p>
    <h2 class="heading-2" id="_idParaDest-313">Configuring HTTP logging for the web service</h2>
    <p class="normal">First, let’s enable HTTP logging for the web<a id="_idIndexMarker776"/> service and configure it to show the<a id="_idIndexMarker777"/> origin of <a id="_idIndexMarker778"/>requests:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.Service</code> project, add a new class file named <code class="inlineCode">IServiceCollection.Extensions.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">IServiceCollection.Extensions.cs</code>, import the namespace for controlling which HTTP fields are logged, and then define an extension method for the <code class="inlineCode">IServiceCollection</code> interface to add HTTP logging, including the <code class="inlineCode">Origin</code> header and all fields including the response body, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.AspNetCore.HttpLogging; // To use HttpLoggingFields.
namespace Packt.Extensions;
public static class IServiceCollectionExtensions
{
  public static IServiceCollection AddCustomHttpLogging(
    this IServiceCollection services)
  {
    services.AddHttpLogging(options =&gt;
    {
      // Add the Origin header so it will not be redacted.
      options.RequestHeaders.Add("Origin");
      // By default, the response body is not included.
      options.LoggingFields = HttpLoggingFields.All;
    });
    return services;
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, before the call to <code class="inlineCode">builder.Build()</code>, add a statement to add custom HTTP logging, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddCustomHttpLogging();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after the call to <code class="inlineCode">UseHttpsRedirection()</code>, add a statement to use HTTP logging, as<a id="_idIndexMarker779"/> shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.UseHttpLogging();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">appsettings.Development.json</code>, add <a id="_idIndexMarker780"/>an entry to set the level for HTTP logging to <code class="inlineCode">Information</code>, as shown highlighted in<a id="_idIndexMarker781"/> the following configuration:
        <pre class="programlisting code"><code class="hljs-code">{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"<strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-comment-slc">// To enable logging HTTP requests, this must be</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-comment-slc">// set to Information (3) or higher.</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-attr-slc">"Microsoft.AspNetCore.HttpLogging"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"Information"</strong>
    }
  }
}
</code></pre>
      </li>
    </ol>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: The JSON specification does not allow comments but the JSON with Comments format does. You can use JavaScript-style comments using <code class="inlineCode">//</code> or <code class="inlineCode">/* */</code>. You can read more at the following link: <a href="https://code.visualstudio.com/docs/languages/json#_json-with-comments">https://code.visualstudio.com/docs/languages/json#_json-with-comments</a>. If you are using a fussy code editor, just delete the comment I added above.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-314">Creating a web page JavaScript client</h2>
    <p class="normal">Next, let’s create a web <a id="_idIndexMarker782"/>page client that will attempt to use JavaScript on a different port to call the web service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to <a id="_idIndexMarker783"/>add a new project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">ASP.NET Core Web App (Model-View-Controller) </strong>/ <code class="inlineCode">mvc</code></li>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter08</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.WebApi.Client.Mvc</code></li>
          <li class="bulletList">Other Visual Studio 2022 options:<ul>
              <li class="bulletList"><strong class="screenText">Authentication Type</strong>: <strong class="screenText">None</strong>.</li>
              <li class="bulletList"><strong class="screenText">Configure for HTTPS</strong>: Selected.</li>
              <li class="bulletList"><strong class="screenText">Enable Docker</strong>: Cleared.</li>
              <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared.</li>
              <li class="bulletList">In Visual Studio 2022, configure the startup project to be the current selection.</li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project, in the <code class="inlineCode">Properties</code> folder, in <code class="inlineCode">launchSettings.json</code>, change the <code class="inlineCode">applicationUrl</code> for the <code class="inlineCode">https</code> profile to use port <code class="inlineCode">5082</code>, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">"applicationUrl": "https://localhost:5082",
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project file, treat warnings as errors.</li>
      <li class="numberedList">In the <code class="inlineCode">Views/Home</code> folder, in <code class="inlineCode">Index.cshtml</code>, replace the existing markup with the markup below, which has a link to a route that has not been defined yet to define a text box and button, and a JavaScript block that makes a call to the web service to get products that contain a partial name, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">@{
  ViewData["Title"] = "Products using JavaScript";
}
&lt;div class="text-center"&gt;
  &lt;h1 class="display-4"&gt;@ViewData["Title"]&lt;/h1&gt;
  &lt;div&gt;
      Go to &lt;a href="/home/products"&gt;Products using .NET&lt;/a&gt;
  &lt;/div&gt;
  &lt;div&gt;
    &lt;input id="productName" placeholder="Enter part of a product name" /&gt;
    &lt;input id="getProductsButton" type="button" value="Get Products" /&gt;
  &lt;/div&gt;
  &lt;div&gt;
    &lt;table id="productsTable" class="table"&gt;
        &lt;thead&gt;
            &lt;tr&gt;
                &lt;th scope="col"&gt;Product Name&lt;/th&gt;
            &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody id="tableBody"&gt;
        &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;
  &lt;script&gt;
    var baseaddress = "https://localhost:5081/";
    function xhr_load() {
        console.log(this.responseText);
        var products = JSON.parse(this.responseText);
        var out = "";
        var i;
        for (i = 0; i &lt; products.length; i++) {
            out += '&lt;tr&gt;&lt;td&gt;&lt;a href="' + baseaddress + 'api/products/' + 
                products[i].productId + '"&gt;' +
                products[i].productName + '&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;';
        }
        document.getElementById("tableBody").innerHTML = out;
    }
    function getProductsButton_click() {
        xhr.open("GET", baseaddress + "api/products/" + 
          document.getElementById("productName").value);
        xhr.send();
    }
    document.getElementById("getProductsButton")
      .addEventListener("click", getProductsButton_click);
    var xhr = new XMLHttpRequest();
    xhr.addEventListener("load", xhr_load);
  &lt;/script&gt;
&lt;/div&gt;
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Service</code> project using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project using the <code class="inlineCode">https</code> profile without debugging.
    <div><p class="normal">If you are using Visual Studio Code, then the web browser will not start automatically. Start <a id="_idIndexMarker784"/>Chrome, and then navigate to <a href="https://localhost:5082">https://localhost:5082</a>.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="7">In Chrome, show <strong class="screenText">Developer Tools</strong> and <strong class="screenText">Console</strong>.</li>
      <li class="numberedList">In the <strong class="screenText">Products using JavaScript</strong> web page, in the text box, enter <code class="inlineCode">man</code>, click the <strong class="screenText">Get Products</strong> button, and note the<a id="_idIndexMarker785"/> error, as shown in the following output and in <em class="italic">Figure 8.6</em>:
        <pre class="programlisting con"><code class="hljs-con">Access to XMLHttpRequest at 'https://localhost:5081/api/products/man' from origin 'https://localhost:5082' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
GET https://localhost:5081/api/products/man net::ERR_FAILED 200
</code></pre>
      </li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_08_06.png"/></figure>
    <p class="packt_figref">Figure 8.6: CORS error in the Chrome Developer Tools console</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">At the command prompt or terminal for the <code class="inlineCode">Northwind.WebApi.Service</code> project, note the HTTP log<a id="_idIndexMarker786"/> for the request and that the <code class="inlineCode">Host</code> is on a different port number to the <code class="inlineCode">Origin</code> so they are not the same origin, as<a id="_idIndexMarker787"/> shown highlighted in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[1]
      Request:
      Protocol: HTTP/2
      Method: GET
      Scheme: https
      PathBase:
      Path: /api/products/man
      Accept: */*
<strong class="hljs-con-slc">      Host: localhost:5081</strong>
      User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36
      Accept-Encoding: gzip, deflate, br
      Accept-Language: en-US,en;q=0.9,sv;q=0.8
<strong class="hljs-con-slc">      Origin: https://localhost:5082</strong>
      Referer: [Redacted]
      sec-ch-ua: [Redacted]
      sec-ch-ua-mobile: [Redacted]
      sec-ch-ua-platform: [Redacted]
      sec-fetch-site: [Redacted]
      sec-fetch-mode: [Redacted]
      sec-fetch-dest: [Redacted]
</code></pre>
      </li>
      <li class="numberedList">Also note the output shows that the web service did execute the database query and return the products in a JSON document response to the browser, as shown in <a id="_idIndexMarker788"/>the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[2]
      Response:
      StatusCode: 200
      Content-Type: application/json; charset=utf-8
info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[4]
      ResponseBody: [{"productId":12,"productName":
      "Queso Manchego La Pastora","supplierId":5,"categoryId":4,
      "quantityPerUnit":"10 - 500 g pkgs.","unitPrice":38.0000,
      "unitsInStock":86,"unitsOnOrder":0,"reorderLevel":0,
      "discontinued":false,"category":null,"supplier":null,
      "orderDetails":[]},
      {"productId":51,"productName":"Manjimup Dried Apples",
      "supplierId":24,"categoryId":7,
      "quantityPerUnit":"50 - 300 g pkgs.","unitPrice":53.0000,
      "unitsInStock":20,"unitsOnOrder":0,"reorderLevel":10,
      "discontinued":false,"category":null,"supplier":null,
      "orderDetails":[]}]
</code></pre>
      
    <div><p class="normal">Although the browser<a id="_idIndexMarker789"/> receives a response containing the data requested, it is the browser that enforces the same origin policy by refusing to reveal the HTTP response to the JavaScript. The web service is not “secured” by CORS.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="11">Close the browser(s) and shut down the web servers.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-315">Creating a .NET client</h2>
    <p class="normal">Next, let’s create a .NET client<a id="_idIndexMarker790"/> to the web service to see that the same origin policy does not apply to non-web<a id="_idIndexMarker791"/> browsers:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project, add a reference to the entity models project so that we can use the <code class="inlineCode">Product</code> class, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\..\Chapter03\Northwind.Common.EntityModels .SqlServer\Northwind.Common.EntityModels.SqlServer.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project at the command prompt or terminal by entering the following command: <code class="inlineCode">dotnet build</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project, in <code class="inlineCode">Program.cs</code>, import the namespace for working with HTTP headers, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using System.Net.Http.Headers; // To use MediaTypeWithQualityHeaderValue.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, before the call to <code class="inlineCode">builder.Build()</code>, add statements to configure an HTTP client factory to call the web service, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddHttpClient(name: "Northwind.WebApi.Service",
  configureClient: options =&gt;
  {
    options.BaseAddress = new("https://localhost:5081/");
    options.DefaultRequestHeaders.Accept.Add(
      new MediaTypeWithQualityHeaderValue(
        "application/json", 1.0));
  });
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Controllers</code> folder, in <code class="inlineCode">HomeController.cs</code>, import the namespace for the entity models, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels; // To use Product.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">HomeController.cs</code>, add statements to store the registered HTTP client factory in a private <code class="inlineCode">readonly</code> field, as <a id="_idIndexMarker792"/>shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">private readonly ILogger&lt;HomeController&gt; _logger;
<strong class="hljs-keyword-slc">private</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">readonly</strong><strong class="hljs-slc"> IHttpClientFactory _httpClientFactory;</strong>
public HomeController(ILogger&lt;HomeController&gt; logger,
  <strong class="hljs-params-slc">IHttpClientFactory httpClientFactory</strong>)
{
  _logger = logger;
<strong class="hljs-slc">  _httpClientFactory = httpClientFactory;</strong>
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">HomeController.cs</code>, add an asynchronous action method named <code class="inlineCode">Products</code> that will use the HTTP factory to request products whose name contains a value entered as <a id="_idIndexMarker793"/>an optional <code class="inlineCode">name</code> parameter in a custom MVC route, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">[Route("home/products/{name?}")]
public async Task&lt;IActionResult&gt; Products(string? name)
{
  HttpClient client = _httpClientFactory.CreateClient(
    name: "Northwind.WebApi.Service");
  HttpRequestMessage request = new(
    method: HttpMethod.Get, requestUri: $"api/products/{name}");
  HttpResponseMessage response = await client.SendAsync(request);
  IEnumerable&lt;Product&gt;? model = await response.Content
    .ReadFromJsonAsync&lt;IEnumerable&lt;Product&gt;&gt;();
  ViewData["baseaddress"] = client.BaseAddress;
  return View(model);
}
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Views/Home</code> folder, add a new file named <code class="inlineCode">Products.cshtml</code>. (The Visual Studio 2022 project item template is named <strong class="screenText">Razor View - Empty</strong>. The JetBrains Rider project item template is named <strong class="screenText">Razor MVC View</strong>.)</li>
      <li class="numberedList">In <code class="inlineCode">Products.cshtml</code>, modify its contents to output a table of products that match part of a <a id="_idIndexMarker794"/>product name entered in a text box, as shown in the<a id="_idIndexMarker795"/> following markup:
        <pre class="programlisting code"><code class="hljs-code">@using Northwind.EntityModels
@model IEnumerable&lt;Product&gt;?
@{
  ViewData["Title"] = "Products using .NET";
}
&lt;div class="text-center"&gt;
  &lt;h1 class="display-4"&gt;@ViewData["Title"]&lt;/h1&gt;
  &lt;div&gt;
    Go to &lt;a href="/"&gt;Products using JavaScript&lt;/a&gt;
  &lt;/div&gt;
  &lt;form action="/home/products"&gt;
    &lt;input name="name" placeholder="Enter part of a product name" /&gt;
    &lt;input type="submit" value="Get Products" /&gt;
  &lt;/form&gt;
  &lt;div&gt;
    &lt;table class="table"&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;th scope="col"&gt;Product Name&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody&gt;
        @if (Model is not null)
        {
          @foreach (Product p in Model)
          {
            &lt;tr&gt;&lt;td&gt;&lt;a href="@(ViewData["baseaddress"])api/products/
@p.ProductId"&gt;@p.ProductName&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;
          }
        }
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Service</code> project using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">On the home page, click the link to go to <strong class="screenText">Products using .NET</strong>, and note the first ten in-stock, not discontinued products are shown in the table, from <strong class="screenText">Chai</strong> to <strong class="screenText">Queso Manchego La Pastora</strong>.</li>
      <li class="numberedList">In the text box, enter <code class="inlineCode">man</code>, click <strong class="screenText">Get Products</strong>, and <a id="_idIndexMarker796"/>note that two products are shown in the <a id="_idIndexMarker797"/>table, as shown in <em class="italic">Figure 8.7</em>:
    <figure class="mediaobject"><img alt="" src="img/B19587_08_07.png"/></figure>
    <p class="packt_figref">Figure 8.7: Getting two products from a web service using .NET</p>
    <div><p class="normal">It is the .NET HTTP client that is calling the web service, so the same origin policy does not apply. If you were to check the logs at the command line or terminal as you did before, you would see the ports are different, but it does not matter.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="14">Click one of the product names to make a direct request to the web service for an individual product and note the response, as shown in the following document:
        <pre class="programlisting con"><code class="hljs-con">{"productId":12,"productName":"Queso Manchego La Pastora",
"supplierId":5,"categoryId":4,
"quantityPerUnit":"10 - 500 g pkgs.","unitPrice":38.0000,
"unitsInStock":86,"unitsOnOrder":0,"reorderLevel":0,
"discontinued":false,"category":null,"supplier":null,"orderDetails":[]}
</code></pre>
      </li>
      <li class="numberedList">Close the browser and shut down the web servers.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-316">Understanding CORS</h2>
    <p class="normal"><strong class="keyWord">Cross-Origin Resource Sharing</strong> (<strong class="keyWord">CORS</strong>) is an HTTP-header-based feature that asks the browser to disable its same-origin security policy in specific scenarios. The HTTP headers indicate which origins should be allowed in<a id="_idIndexMarker798"/> addition to the same origin.</p>
    <p class="normal">Let’s enable CORS in the web service so that it can send extra headers to indicate to the browser that it is allowed to access resources from a different origin:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.Service</code> project, in <code class="inlineCode">WebApplication.Extensions.cs</code>, add an extension method to add CORS support to the web service, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public static IServiceCollection AddCustomCors(
  this IServiceCollection services)
{
  services.AddCors(options =&gt;
  {
    options.AddPolicy(name: "Northwind.Mvc.Policy",
      policy =&gt;
      {
        policy.WithOrigins("https://localhost:5082");
      });
  });
  return services;
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after creating the <code class="inlineCode">builder</code>, call the custom extension method to add CORS support, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddCustomCors();
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after the call to <code class="inlineCode">UseHttpLogging</code>, and before mapping the <code class="inlineCode">GET</code> requests, add a statement to use the CORS policy, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.UseCors(policyName: "Northwind.Mvc.Policy");
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Service</code> project using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Show <strong class="screenText">Developer Tools</strong> and the <strong class="screenText">Console</strong>.</li>
      <li class="numberedList">On the home page, in the text box, enter <code class="inlineCode">man</code>, click <strong class="screenText">Get Products</strong>, and note that the console shows the JSON document returned from the web service, and the table is<a id="_idIndexMarker799"/> filled with the two products, as shown in <em class="italic">Figure 8.8</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_08_08.png"/></figure>
    <p class="packt_figref">Figure 8.8: A successful cross-origin request to the web service using JavaScript</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="8">Close the browser and shut down the web servers.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-317">Enabling CORS for specific endpoints</h2>
    <p class="normal">In the previous example, we<a id="_idIndexMarker800"/> enabled the same CORS policy for the whole web service. You might need finer control at the endpoint level:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.Service</code> project, in <code class="inlineCode">Program.cs</code>, change the call to <code class="inlineCode">UseCors</code> to not specify the policy name, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-comment-slc">// </strong>app.UseCors(policyName: "Northwind.Mvc.Policy");
<strong class="hljs-comment-slc">// Without a named policy the middleware is added but not active.</strong>
<strong class="hljs-slc">app.UseCors();</strong>
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">WebApplication.Extensions.cs</code>, at the end of the call to <code class="inlineCode">MapGet</code> that gets products that contain part of a product name, add a call to <code class="inlineCode">RequiresCors</code>, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.MapGet("api/products/{name}", (
  [FromServices] NorthwindContext db,
  [FromRoute] string name) =&gt;
    db.Products.Where(p =&gt; p.ProductName.Contains(name)))
  .WithName("GetProductsByName")
  .WithOpenApi()
  .Produces&lt;Product[]&gt;(StatusCodes.Status200OK)
<strong class="hljs-slc">  .RequireCors(policyName: </strong><strong class="hljs-string-slc">"Northwind.Mvc.Policy"</strong><strong class="hljs-slc">);</strong>
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Service</code> project using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Client.Mvc</code> project using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Show <strong class="screenText">Developer Tools</strong> and <strong class="screenText">Console</strong>.</li>
      <li class="numberedList">On the home page, in the text box, enter <code class="inlineCode">cha</code>, click <strong class="screenText">Get Products</strong>, and note that the console shows the JSON document returned from the web service and the table is filled with three products.</li>
      <li class="numberedList">Close the browser and shut down the web servers.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-318">Understanding other CORS policy options</h2>
    <p class="normal">You can control the:</p>
    <ul>
      <li class="bulletList">Allowed origins, for<a id="_idIndexMarker801"/> example, <code class="inlineCode">https://*.example.com/</code>.</li>
      <li class="bulletList">Allowed HTTP methods, for example, <code class="inlineCode">GET</code>, <code class="inlineCode">POST</code>, <code class="inlineCode">DELETE</code>, and so on.</li>
      <li class="bulletList">Allowed HTTP request headers, for example, <code class="inlineCode">Content-Type</code>, <code class="inlineCode">Content-Language</code>, <code class="inlineCode">x-custom-header</code>, and so<a id="_idIndexMarker802"/> on.</li>
      <li class="bulletList">Exposed HTTP response headers, meaning which headers to include unredacted in a response (because, by default, response headers are redacted), for example, <code class="inlineCode">x-custom-header</code>.</li>
    </ul>
    <div><p class="normal">You can learn more about options for CORS policies at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/security/cors#cors-policy-options">https://learn.microsoft.com/en-us/aspnet/core/security/cors#cors-policy-options</a></p>
    </div>
    <p class="normal">Now that you know that CORS does not secure a web service, let’s look at a useful technique that can prevent a common form of attack.</p>
    <h1 class="heading-1" id="_idParaDest-319">Preventing denial of service attacks using rate limiting</h1>
    <p class="normal">A <strong class="keyWord">denial of service </strong>(<strong class="keyWord">DoS</strong>) attack is a malicious attempt to disrupt a web service by overwhelming it with requests. If the <a id="_idIndexMarker803"/>requests all came from <a id="_idIndexMarker804"/>the same place, for example, the same IP address, then it would be relatively easy to cut them off as soon as the attack is detected. But these attacks are often implemented as <strong class="keyWord">distributed DoS</strong> (<strong class="keyWord">DDoS</strong>) attacks from <a id="_idIndexMarker805"/>many locations so you cannot separate attackers from genuine clients.</p>
    <p class="normal">A different approach is to apply rate limiting to everyone but let through more requests for genuine identified clients.</p>
    <p class="normal">Genuine clients should only make the minimum requests they need. How many is reasonable will depend on your service. One way to prevent DDoS attacks would be to limit how many requests are allowed from any client per minute. </p>
    <p class="normal">This technique is not just useful to prevent attacks. Even genuine clients might accidentally make too many requests, or for a commercial web service, you might want to charge different amounts for different rates, like when controlling a subscription. Commercial web services<a id="_idIndexMarker806"/> from Twitter/X to Reddit now charge a <em class="italic">lot</em> of money for access to their web APIs.</p>
    <p class="normal">When a client makes<a id="_idIndexMarker807"/> requests over a set rate limit, the client should receive either <code class="inlineCode">429 Too Many Requests</code> or <code class="inlineCode">503 Service Unavailable</code> HTTP responses.</p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: If you need to build a massively scalable web service and protect its APIs, you should use a cloud service like Azure API Management instead of trying to implement your own rate limiting. You can learn more about this at the following link: <a href="https://learn.microsoft.com/en-us/azure/api-management/">https://learn.microsoft.com/en-us/azure/api-management/</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-320">Rate limiting using the AspNetCoreRateLimit package</h2>
    <p class="normal"><code class="inlineCode">AspNetCoreRateLimit</code>, a third-party package<a id="_idIndexMarker808"/> that targets .NET 6 or later, provides flexible rate-limiting middleware based on the IP address or client ID:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.Service</code> project, add a reference to the <code class="inlineCode">AspNetCoreRateLimit</code> package, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;PackageReference Include="AspNetCoreRateLimit" Version="5.0.0" /&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.WebApi.Service</code> project to restore packages.</li>
      <li class="numberedList">In <code class="inlineCode">appsettings.Development.json</code>, add configuration for default rate limit options and client-specific policies, as shown highlighted in the following configuration:
        <pre class="programlisting code"><code class="hljs-code">{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.AspNetCore.HttpLogging": "Information"
    }
  }<strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"ClientRateLimiting"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">{</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"EnableEndpointRateLimiting"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">false</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"StackBlockedRequests"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">false</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"ClientIdHeader"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"X-Client-Id"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"HttpStatusCode"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-number-slc">429</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"EndpointWhitelist"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">[</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"get:/api/license"</strong><strong class="hljs-punctuation-slc">,</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"*:/api/status"</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">],</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"ClientWhitelist"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">[</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"dev-id-1"</strong><strong class="hljs-punctuation-slc">,</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"dev-id-2"</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">],</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"GeneralRules"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">[</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-punctuation-slc">{</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-attr-slc">"Endpoint"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"*"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-attr-slc">"Period"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"10s"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-attr-slc">"Limit"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-number-slc">2</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-punctuation-slc">},</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-punctuation-slc">{</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-attr-slc">"Endpoint"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"*"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-attr-slc">"Period"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"12h"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-attr-slc">"Limit"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-number-slc">100</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-punctuation-slc">}</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-punctuation-slc">]</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-punctuation-slc">},</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"ClientRateLimitPolicies"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">{</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"ClientRules"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">[</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-punctuation-slc">{</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-attr-slc">"ClientId"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"console-client-abc123"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-attr-slc">"Rules"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">[</strong>
<strong class="hljs-slc">          </strong><strong class="hljs-punctuation-slc">{</strong>
<strong class="hljs-slc">            </strong><strong class="hljs-attr-slc">"Endpoint"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"*"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">            </strong><strong class="hljs-attr-slc">"</strong><strong class="hljs-attr-slc">Period"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"10s"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">            </strong><strong class="hljs-attr-slc">"Limit"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-number-slc">5</strong>
<strong class="hljs-slc">          </strong><strong class="hljs-punctuation-slc">},</strong>
<strong class="hljs-slc">          </strong><strong class="hljs-punctuation-slc">{</strong>
<strong class="hljs-slc">            </strong><strong class="hljs-attr-slc">"Endpoint"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"*"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">            </strong><strong class="hljs-attr-slc">"Period"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"12h"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">            </strong><strong class="hljs-attr-slc">"Limit"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-number-slc">250</strong>
<strong class="hljs-slc">          </strong><strong class="hljs-punctuation-slc">}</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-punctuation-slc">]</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-punctuation-slc">}</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-punctuation-slc">]</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-punctuation-slc">}</strong>
}
</code></pre>
      
    <p class="normal">Note:</p>
    <ul>
      <li class="bulletList"><code class="inlineCode">EnableEndpointRateLimiting</code> is <code class="inlineCode">false</code>, meaning all endpoints will share the same rules.</li>
      <li class="bulletList">If a client needs to identify itself, it can set a header named <code class="inlineCode">X-Client-Id</code> to a unique <code class="inlineCode">string</code> value.</li>
      <li class="bulletList">If a rate limit is reached for a client, the service will start returning <code class="inlineCode">429</code> status code responses to that client.</li>
      <li class="bulletList">Two endpoints will be excluded from the global rate limits because they are on the endpoint whitelist. One endpoint is for getting a license, and the other endpoint is for checking the status of the service. We will not actually implement these features and you would want to<a id="_idIndexMarker809"/> apply different rate limits to these endpoints; otherwise, someone could call them to bring down your server instead.</li>
      <li class="bulletList">Two client IDs, named <code class="inlineCode">dev-id-1</code> and <code class="inlineCode">dev-id-2</code>, will be excluded from the rate limits because they are on the client whitelist. These could be special client accounts for internal developers that are not shared outside the organization.</li>
      <li class="bulletList">Two general (default) rules are configured: the first sets a rate limit of 2 requests every 10 seconds, and the second sets a rate limit of 100 requests every 12 hours.</li>
      <li class="bulletList">Two client-specific rules are configured that are looser than the default rules: for the client ID named <code class="inlineCode">console-client-abc123</code>, it is allowed to make up to 5 requests every 10 seconds, and up to 250 requests every 12 hours.</li>
    </ul></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="4">In <code class="inlineCode">IServiceCollection.Extensions.cs</code>, import the namespace for working with rate-limiting options, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using AspNetCoreRateLimit; // To use ClientRateLimitOptions and so on.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">IServiceCollection.Extensions.cs</code>, define an extension method to load rate-limiting configuration from app settings and set rate-limiting options, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public static IServiceCollection AddCustomRateLimiting(
  this IServiceCollection services, ConfigurationManager configuration)
{
  // Add services to store rate limit counters and rules in memory.
  services.AddMemoryCache();
  services.AddInMemoryRateLimiting();
  // Load default rate limit options from appsettings.json.
  services.Configure&lt;ClientRateLimitOptions&gt;(
    configuration.GetSection("ClientRateLimiting"));
  // Load client-specific policies from appsettings.json.
  services.Configure&lt;ClientRateLimitPolicies&gt;(
    configuration.GetSection("ClientRateLimitPolicies"));
  // Register the configuration.
  services.AddSingleton
    &lt;IRateLimitConfiguration, RateLimitConfiguration&gt;();
  return services;
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after creating the <code class="inlineCode">builder</code>, add statements to load rate-limiting configuration <a id="_idIndexMarker810"/>from app settings and set rate-limiting options, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">builder.Services.AddCustomRateLimiting(builder.Configuration);
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">IServiceCollection.Extensions.cs</code>, in the call to configure HTTP logging, add a statement to allow two rate-limiting headers to not be redacted, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">services.AddHttpLogging(options =&gt;
{
  // Add the Origin header so it will not be redacted.
  options.RequestHeaders.Add("Origin");
<strong class="hljs-slc">  </strong><strong class="hljs-comment-slc">// Add the rate limiting headers so they will not be redacted.</strong>
<strong class="hljs-slc">  options.RequestHeaders.Add(</strong><strong class="hljs-string-slc">"X-Client-Id"</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">  options.ResponseHeaders.Add(</strong><strong class="hljs-string-slc">"Retry-After"</strong><strong class="hljs-slc">);</strong>
  // By default, the response body is not included.
  options.LoggingFields = HttpLoggingFields.All;
});
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">WebApplication.Extensions.cs</code>, import the namespace for working with rate-limiting policy stores, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using AspNetCoreRateLimit; // To use IClientPolicyStore and so on.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">WebApplication.Extensions.cs</code>, add statements to define an extension method to seed the client <a id="_idIndexMarker811"/>policy store, which just means loading the policies from the configuration, and then use client rate limits, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public static async Task UseCustomClientRateLimiting(this WebApplication app)
{
  using (IServiceScope scope = app.Services.CreateScope())
  {
    IClientPolicyStore clientPolicyStore = scope.ServiceProvider
      .GetRequiredService&lt;IClientPolicyStore&gt;();
    await clientPolicyStore.SeedAsync();
  }
  app.UseClientRateLimiting();
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after calling <code class="inlineCode">UseHttpLogging</code>, add a call to use client rate limiting, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">await app.UseCustomClientRateLimiting();
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-321">Creating a rate-limited console client</h2>
    <p class="normal">Now we can create a<a id="_idIndexMarker812"/> console app that will be a client to the web service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Use your preferred code editor to add a new console app to the <code class="inlineCode">Chapter08</code> solution named <code class="inlineCode">Northwind.WebApi.Client.Console</code>.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Client.Console</code> project, treat warnings as errors, globally and statically import the <code class="inlineCode">System.Console</code> class, and add a reference to the entity models project, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;ItemGroup&gt;
  &lt;ProjectReference Include="..\..\Chapter03\Northwind.Common.EntityModels
.SqlServer\Northwind.Common.EntityModels.SqlServer.csproj" /&gt;
&lt;/ItemGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.WebApi.Client.Console</code> project at the command prompt or terminal to compile the referenced project and copy its assembly to the appropriate <code class="inlineCode">bin</code> folder.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Client.Console</code> project, add a new class file named <code class="inlineCode">Program.Helpers.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">Program.Helpers.cs</code>, add statements to define a method for the <code class="inlineCode">partial Program</code> class to write <a id="_idIndexMarker813"/>some text in a foreground color, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">partial class Program
{
  private static void WriteInColor(string text, ConsoleColor foregroundColor)
  {
    ConsoleColor previousColor = ForegroundColor;
    ForegroundColor = foregroundColor;
    Write(text);
    ForegroundColor = previousColor;
  }
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, delete the existing statements. Add statements to prompt the user for a client name to identify it, and then create an HTTP client to make a request to get the first page of products from the web service once per second until the user presses <em class="keystroke">Ctrl</em> + <em class="keystroke">C</em> to stop the console app, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Northwind.EntityModels; // To use Product.
using System.Net.Http.Json; // To use ReadFromJsonAsync&lt;T&gt; method.
Write("Enter a client name or press Enter: ");
string? clientName = ReadLine();
if (string.IsNullOrEmpty(clientName))
{
  clientName = $"console-client-{Guid.NewGuid()}";
}
WriteLine($"X-Client-Id will be: {clientName}");
HttpClient client = new();
client.BaseAddress = new("https://localhost:5081");
client.DefaultRequestHeaders.Accept.Add(new("application/json"));
// Specify the rate limiting client id for this console app.
client.DefaultRequestHeaders.Add("X-Client-Id", clientName);
while (true)
{
  WriteInColor(string.Format("{0:hh:mm:ss}: ", 
    DateTime.UtcNow), ConsoleColor.DarkGreen);
  int waitFor = 1; // Second.
  try
  {
    HttpResponseMessage response = await client.GetAsync("api/products");
    if (response.IsSuccessStatusCode)
    {
      Product[]? products = 
        await response.Content.ReadFromJsonAsync&lt;Product[]&gt;();
      if (products != null)
      {
        foreach (Product product in products)
        {
          Write(product.ProductName);
          Write(", ");
        }
        WriteLine();
      }
    }
    else
    {
      WriteInColor(string.Format("{0}: {1}", (int)response.StatusCode,
        await response.Content.ReadAsStringAsync()),
        ConsoleColor.DarkRed);
      WriteLine();
    }
  }
  catch (Exception ex)
  {
    WriteLine(ex.Message);
  }
  await Task.Delay(TimeSpan.FromSeconds(waitFor));
}
</code></pre>
      </li>
      <li class="numberedList">If your database server is not running (for example, because you are hosting it in Docker, a virtual machine, or in the cloud), then make sure to start it.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Service</code> project using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Client.Console</code> project without debugging.</li>
      <li class="numberedList">In the console<a id="_idIndexMarker814"/> app, press <em class="keystroke">Enter</em> to generate a GUID-based client ID.</li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Client.Console</code> project using the <code class="inlineCode">https</code> profile without debugging again so we have two clients.</li>
      <li class="numberedList">In the console app, press <em class="keystroke">Enter</em> to generate a GUID-based client ID.</li>
      <li class="numberedList">Note that each client can make two requests before it starts to receive <code class="inlineCode">429</code> status codes, as shown in the following output and in <em class="italic">Figure 8.9</em>:
        <pre class="programlisting con"><code class="hljs-con">Enter a client name or press Enter:
X-Client-Id will be: console-client-d54c61ba-66bb-4e39-9c1a-7af6e2bf647e
07:32:18: Chai, Chang, Aniseed Syrup, Chef Anton's Cajun Seasoning, Grandma's Boysenberry Spread, Uncle Bob's Organic Dried Pears, Northwoods Cranberry Sauce, Ikura, Queso Cabrales, Queso Manchego La Pastora,
07:32:20: Chai, Chang, Aniseed Syrup, Chef Anton's Cajun Seasoning, Grandma's Boysenberry Spread, Uncle Bob's Organic Dried Pears, Northwoods Cranberry Sauce, Ikura, Queso Cabrales, Queso Manchego La Pastora,
07:32:21: 429: API calls quota exceeded! maximum admitted 2 per 10s.
07:32:22: 429: API calls quota exceeded! maximum admitted 2 per 10s.
07:32:23: 429: API calls quota exceeded! maximum admitted 2 per 10s.
07:32:24: 429: API calls quota exceeded! maximum admitted 2 per 10s.
07:32:25: 429: API calls quota exceeded! maximum admitted 2 per 10s.
07:32:26: 429: API calls quota exceeded! maximum admitted 2 per 10s.
07:32:27: 429: API calls quota exceeded! maximum admitted 2 per 10s.
07:32:28: Chai, Chang, Aniseed Syrup, Chef Anton's Cajun Seasoning, Grandma's Boysenberry Spread, Uncle Bob's Organic Dried Pears, Northwoods Cranberry Sauce, Ikura, Queso Cabrales, Queso Manchego La Pastora,
07:32:29: Chai, Chang, Aniseed Syrup, Chef Anton's Cajun Seasoning, Grandma's Boysenberry Spread, Uncle Bob's Organic Dried Pears, Northwoods Cranberry Sauce, Ikura, Queso Cabrales, Queso Manchego La Pastora,
07:32:30: 429: API calls quota exceeded! maximum admitted 2 per 10s.
07:32:31: 429: API calls quota exceeded! maximum admitted 2 per 10s.
07:32:32: 429: API calls quota exceeded! maximum admitted 2 per 10s.
</code></pre>
      </li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_08_09.png"/></figure>
    <p class="packt_figref">Figure 8.9: A console app exceeding its web service rate limit</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="14">Stop the two console apps. Leave the web service running.</li>
      <li class="numberedList">In the command line for the web service, note the HTTP logs that show each request from<a id="_idIndexMarker815"/> the console client with its client ID sent as a header named <code class="inlineCode">X-Client-Id</code>, the request being blocked because that client has exceeded its quota, and a response that contains a header named <code class="inlineCode">Retry-After</code> containing the number of seconds the client should wait before retrying, as shown highlighted in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[1]
      Request:
      Protocol: HTTP/1.1
      Method: GET
      Scheme: https
      PathBase:
      Path: /api/products
      Accept: application/json
      Host: localhost:5081
<strong class="hljs-con-slc">      X-Client-Id: console-client-d54c61ba-66bb-4e39-9c1a-7af6e2bf647e</strong>
info: AspNetCoreRateLimit.ClientRateLimitMiddleware[0]
<strong class="hljs-con-slc">      Request get:/api/products from ClientId console-client-d54c61ba-66bb-4e39-9c1a-7af6e2bf647e has been blocked, quota 2/10s exceeded by 3. Blocked by rule *, TraceIdentifier 0HMIKGNJQEK5P:0000000E. MonitorMode: False</strong>
info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[2]
      Response:
      StatusCode: 429
      Content-Type: text/plain
      <strong class="hljs-con-slc">Retry-After: 6</strong>
info: Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware[4]
      ResponseBody: API calls quota exceeded! maximum admitted 2 per 10s.
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Client.Console</code> project, in <code class="inlineCode">Program.cs</code>, before writing the error message to the console in dark red, add statements to read the <code class="inlineCode">Retry-After</code> header to get the number of seconds to wait for, as shown highlighted<a id="_idIndexMarker816"/> in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc"> retryAfter = response.Headers</strong>
<strong class="hljs-slc">  .GetValues(</strong><strong class="hljs-string-slc">"Retry-After"</strong><strong class="hljs-slc">).ToArray()[</strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">];</strong>
<strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (</strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc">.TryParse(retryAfter, </strong><strong class="hljs-keyword-slc">out</strong><strong class="hljs-slc"> waitFor))</strong>
<strong class="hljs-slc">{</strong>
<strong class="hljs-slc">  retryAfter = </strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc">.Format(</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-string-slc">"I will retry after {0} seconds."</strong><strong class="hljs-slc">, waitFor);</strong>
<strong class="hljs-slc">}</strong>
WriteInColor(string.Format("{0}: {1} {2}", (int)response.StatusCode,
  await response.Content.ReadAsStringAsync(), retryAfter),
  ConsoleColor.DarkRed);
</code></pre>
      
    <div><p class="normal">Note the <code class="inlineCode">waitFor</code> variable is set from the <code class="inlineCode">Retry-After</code> header value. This is later used to pause the console app using an asynchronous delay, as shown in the following code:</p>
      <p class="normal"><code class="inlineCode">await Task.Delay(TimeSpan.FromSeconds(waitFor));</code></p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="17">Start the <code class="inlineCode">Northwind.WebApi.Client.Console</code> project without debugging.</li>
      <li class="numberedList">In the console app, press <em class="keystroke">Enter</em> to generate a GUID-based client ID.</li>
      <li class="numberedList">Note the console app will now sensibly wait for the suggested number of seconds before making its next call to the service, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Enter a client name:
X-Client-Id will be: console-client-add7613f-51a9-4c4a-8ec7-0244203d2e19
07:45:01: Chai, Chang, Aniseed Syrup, Chef Anton's Cajun Seasoning, Grandma's Boysenberry Spread, Uncle Bob's Organic Dried Pears, Northwoods Cranberry Sauce, Ikura, Queso Cabrales, Queso Manchego La Pastora,
07:45:02: Chai, Chang, Aniseed Syrup, Chef Anton's Cajun Seasoning, Grandma's Boysenberry Spread, Uncle Bob's Organic Dried Pears, Northwoods Cranberry Sauce, Ikura, Queso Cabrales, Queso Manchego La Pastora,
07:45:03: 429: API calls quota exceeded! maximum admitted 2 per 10s. I will retry after 8 seconds.
07:45:11: Chai, Chang, Aniseed Syrup, Chef Anton's Cajun Seasoning, Grandma's Boysenberry Spread, Uncle Bob's Organic Dried Pears, Northwoods Cranberry Sauce, Ikura, Queso Cabrales, Queso Manchego La Pastora,
07:45:12: Chai, Chang, Aniseed Syrup, Chef Anton's Cajun Seasoning, Grandma's Boysenberry Spread, Uncle Bob's Organic Dried Pears, Northwoods Cranberry Sauce, Ikura, Queso Cabrales, Queso Manchego La Pastora,
07:45:13: 429: API calls quota exceeded! maximum admitted 2 per 10s. I will retry after 8 seconds.
</code></pre>
      </li>
      <li class="numberedList">Stop and restart the <code class="inlineCode">Northwind.WebApi.Client.Console</code> project without debugging.</li>
      <li class="numberedList">In the console app, enter the name <code class="inlineCode">dev-id-1</code>, and note that the rate limit does not apply to this console app client. This could be a special account for internal developers.</li>
      <li class="numberedList">Stop and restart <a id="_idIndexMarker817"/>the <code class="inlineCode">Northwind.WebApi.Client.Console</code> project without debugging.</li>
      <li class="numberedList">In the console app, enter the name <code class="inlineCode">console-client-abc123</code>, and note that the rate limit is different for this console app client ID, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">info: AspNetCoreRateLimit.ClientRateLimitMiddleware[0]
      Request get:/api/products from ClientId console-client-abc123 has been blocked, quota 5/10s exceeded by 1. Blocked by rule *, TraceIdentifier 0HMIKGS1TPSHJ:00000006. MonitorMode: False
</code></pre>
      </li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-322">Rate limiting using ASP.NET Core middleware</h2>
    <p class="normal">ASP.NET Core 7 introduced its own basic<a id="_idIndexMarker818"/> rate-limiting middleware, initially distributed as a separate NuGet package but now included with <a id="_idIndexMarker819"/>ASP.NET Core. It has a dependency on another Microsoft package, <code class="inlineCode">System.Threading.RateLimiting</code>. It is not as feature-rich as the third-party package and we will not cover it in this book, although I have written an online-only section at the following link:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/ch08-rate-limiting.md">https://github.com/markjprice/apps-services-net8/blob/main/docs/ch08-rate-limiting.md</a></p>
    <div><p class="normal">You can learn about the ASP.NET Core rate limiter at the following link: <a href="https://learn.microsoft.com/en-us/aspnet/core/performance/rate-limit">https://learn.microsoft.com/en-us/aspnet/core/performance/rate-limit</a>.</p>
    </div>
    <p class="normal">Protecting your web services from attacks is important. What about improving the performance of your web service? Is there anything we can do about that? </p>
    <h1 class="heading-1" id="_idParaDest-323">Improving startup time and resources using native AOT</h1>
    <p class="normal">Native AOT produces apps and <a id="_idIndexMarker820"/>services that are:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Self-contained</strong>, meaning they can <a id="_idIndexMarker821"/>run on systems that do not have the .NET runtime installed.</li>
      <li class="bulletList"><strong class="keyWord">Ahead-of-time (AOT) compiled to native code</strong>, meaning a faster startup time and a potentially smaller <a id="_idIndexMarker822"/>memory footprint. This can have a positive impact when you have lots of instances (for example, when deploying massively scalable microservices) that are frequently stopped and restarted.</li>
    </ul>
    <p class="normal">Native AOT compiles <strong class="keyWord">intermediate code</strong> (<strong class="keyWord">IL</strong>) to native code at the time of publishing, rather than at runtime <a id="_idIndexMarker823"/>using the <strong class="keyWord">Just-In-Time</strong> (<strong class="keyWord">JIT</strong>) compiler. But native AOT apps and services must target <a id="_idIndexMarker824"/>a specific runtime environment like Windows x64 or Linux ARM.</p>
    <p class="normal">Since native AOT happens at publish time, while debugging and working live on a project in your code editor, it uses the runtime JIT compiler, not native AOT, even if you have AOT enabled in the project! But <a id="_idIndexMarker825"/>some features that are incompatible with native AOT will be disabled or throw exceptions, and a source analyzer is enabled to show warnings about potential code incompatibilities.</p>
    <h2 class="heading-2" id="_idParaDest-324">Limitations of native AOT</h2>
    <p class="normal">Native AOT has limitations, some <a id="_idIndexMarker826"/>of which are shown in the following list:</p>
    <ul>
      <li class="bulletList">No dynamic loading of assemblies.</li>
      <li class="bulletList">No runtime code generation, for example, using <code class="inlineCode">System.Reflection.Emit</code>.</li>
      <li class="bulletList">It requires trimming, which has its own limitations.</li>
      <li class="bulletList">The assembly must be self-contained, so they must embed any libraries they call, which increases their size.</li>
    </ul>
    <p class="normal">Although your own apps and services might not use the features listed above, major parts of .NET itself do. For example, ASP.NET Core MVC (including Web API services that use controllers) and EF Core do runtime code generation to implement their functionality.</p>
    <p class="normal">The .NET teams are hard at work making as much of .NET compatible with native AOT as possible, as soon as possible. But .NET 8 only includes basic support for ASP.NET Core if you use minimal APIs, and no support for EF Core.</p>
    <p class="normal">My guess is that .NET 9 will include support for ASP.NET Core MVC and some parts of EF Core, but it could take until .NET 10 before we can all confidently use most of .NET and know we can build our apps and services with native AOT to gain the benefits.</p>
    <p class="normal">The native AOT publishing process includes code analyzers to warn you if you use any features that are not supported, but not all packages have been annotated to work well with this yet.</p>
    <p class="normal">The most common annotation used to indicate that a type or member does not support AOT is the <code class="inlineCode">[RequiresDynamicCode]</code> attribute.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn more about AOT warnings at the following link: <a href="https://learn.microsoft.com/en-us/dotnet/core/deploying/native-aot/fixing-warnings">https://learn.microsoft.com/en-us/dotnet/core/deploying/native-aot/fixing-warnings</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-325">Reflection and native AOT</h2>
    <p class="normal">Reflection is frequently used <a id="_idIndexMarker827"/>for runtime inspection of type metadata, dynamic invocation of members, and code generation.</p>
    <p class="normal">Native AOT does allow some reflection features, but the trimming performed during the native AOT compilation process cannot statically determine when a type has members that might be only accessed via reflection. These members would be removed by AOT, which would then cause a runtime exception. </p>
    <div><p class="normal"><strong class="keyWord">Good Practice</strong>: Developers must annotate their types with <code class="inlineCode">[DynamicallyAccessedMembers]</code> to indicate a member that is only dynamically accessed via reflection and should therefore be left untrimmed.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-326">Native AOT for ASP.NET Core</h2>
    <p class="normal">.NET 7 only supported native AOT <a id="_idIndexMarker828"/>with console apps and class libraries on Windows or Linux. It did not support macOS or ASP.NET Core. .NET 8 is the first version to support<a id="_idIndexMarker829"/> macOS and parts of ASP.NET Core.</p>
    <p class="normal">The following ASP.NET Core features are fully supported: <code class="inlineCode">gRPC</code>, <code class="inlineCode">CORS</code>, <code class="inlineCode">HealthChecks</code>, <code class="inlineCode">HttpLogging</code>, <code class="inlineCode">Localization</code>, <code class="inlineCode">OutputCaching</code>, <code class="inlineCode">RateLimiting</code>, <code class="inlineCode">RequestDecompression</code>, <code class="inlineCode">ResponseCaching</code>, <code class="inlineCode">ResponseCompression</code>, <code class="inlineCode">Rewrite</code>, <code class="inlineCode">StaticFiles</code>, and <code class="inlineCode">WebSockets</code>.</p>
    <p class="normal">The following ASP.NET Core features are partially supported: minimal APIs.</p>
    <p class="normal">The following ASP.NET Core features are not supported (yet): MVC, Blazor Server, SignalR, Authentication (except JWT), Session, and SPA.</p>
    <p class="normal">As you have previously seen, you implement an ASP.NET Core Minimal APIs web service by mapping an HTTP request to a lambda expression, for example, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">    app.MapGet("/", () =&gt; "Hello World!");
</code></pre>
    <p class="normal">At runtime, ASP.NET Core uses the <code class="inlineCode">RequestDelegateFactory</code> (<strong class="keyWord">RDF</strong>) class to convert your <code class="inlineCode">MapX</code> calls into <code class="inlineCode">RequestDelegate</code> instances. But this is dynamic code so is not compatible with native AOT.</p>
    <p class="normal">In ASP.NET Core 8, when native AOT is enabled, the runtime use of RDF is replaced with a source generator<a id="_idIndexMarker830"/> named <strong class="keyWord">Request Delegate Generator </strong>(<strong class="keyWord">RDG</strong>) that performs similar work but at compile<a id="_idIndexMarker831"/> time. This makes sure the code generated is statically analyzable by the native AOT publish <a id="_idIndexMarker832"/>process.</p>
    <div><p class="normal"><strong class="keyWord">More Information</strong>: You can learn how to create your own source generator at the following link: <a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/ch01-dynamic-code.md#creating-source-generators">https://github.com/markjprice/apps-services-net8/blob/main/docs/ch01-dynamic-code.md#creating-source-generators</a>.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-327">Requirements for native AOT</h2>
    <p class="normal">There are additional requirements<a id="_idIndexMarker833"/> for different operating systems:</p>
    <ul>
      <li class="bulletList">On Windows, you must install the Visual Studio 2022 <strong class="screenText">Desktop development with C++</strong> workload with all default components.</li>
      <li class="bulletList">On Linux, you must install the compiler toolchain and developer packages for libraries that the .NET runtime depends on. For example, for Ubuntu 18.04 or later: <code class="inlineCode">sudo apt-get install clang zlib1g-dev</code>.</li>
    </ul>
    <div><p class="normal"><strong class="keyWord">Warning!</strong> Cross-platform native AOT publishing is not supported. This means that you must run the publish on the operating system that you will deploy to. For example, you cannot publish a native AOT project on Linux to later run on Windows.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-328">Enabling native AOT for a project</h2>
    <p class="normal">To enable native AOT<a id="_idIndexMarker834"/> publishing in a project, add the <code class="inlineCode">&lt;PublishAot&gt;</code> element to the project file, as shown highlighted in the following markup:</p>
    <pre class="programlisting code"><code class="hljs-code">  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
<strong class="hljs-slc">    &lt;PublishAot&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/PublishAot&gt;</strong>
</code></pre>
    <h2 class="heading-2" id="_idParaDest-329">Enabling JSON serialization with native AOT</h2>
    <p class="normal">JSON serialization with native AOT requires<a id="_idIndexMarker835"/> the use of the <code class="inlineCode">System.Text.Json</code> source generator. All model types passed as parameters or return values must be registered <a id="_idIndexMarker836"/>with a <code class="inlineCode">JsonSerializerContext</code>, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">[JsonSerializable(typeof(Product)] // A single Product.
[JsonSerializable(typeof(Product[]))] // An array of Products.
public partial class MyJsonSerializerContext : JsonSerializerContext { }
</code></pre>
    <p class="normal">Your custom JSON serializer context must be added to the service dependencies, as shown in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">builder.Services.ConfigureHttpJsonOptions(options =&gt;
{
  options.SerializerOptions.AddContext&lt;MyJsonSerializerContext&gt;();
});
</code></pre>
    <h2 class="heading-2" id="_idParaDest-330">Building a native AOT project</h2>
    <p class="normal">Now let’s see a practical example<a id="_idIndexMarker837"/> using the new project template:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the solution named <code class="inlineCode">Chapter08</code>, add a native AOT-compatible web service project, as defined in the following list:<ul>
          <li class="bulletList">Project template: <strong class="screenText">ASP.NET Core Web API (native AOT)</strong> / <code class="inlineCode">webapiaot</code>
        <div><p class="normal">This is a new project template introduced with .NET 8. It is different from the <strong class="screenText">Web API</strong> / <code class="inlineCode">webapi</code> project template. It does not have an option to use controllers since native AOT support is currently minimal APIs-only. It also does not have an option for HTTPS because HTTPS is often handled by a reverse-proxy in cloud-native deployments. In JetBrains Rider, select <strong class="screenText">ASP.NET Core Web Application</strong> and then select the <strong class="screenText">Type</strong> of <strong class="screenText">Web API (native AOT)</strong>.</p>
        </div></li>
        </ul>
        <ul>
          <li class="bulletList">Solution file and folder: <code class="inlineCode">Chapter08</code></li>
          <li class="bulletList">Project file and folder: <code class="inlineCode">Northwind.MinimalAot.Service</code></li>
          <li class="bulletList"><strong class="screenText">Enable Docker</strong>: Cleared.</li>
          <li class="bulletList"><strong class="screenText">Do not use top-level statements</strong>: Cleared.</li>
          <li class="bulletList">In the <code class="inlineCode">Properties</code> folder, in <code class="inlineCode">launchSettings.json</code>, note only <code class="inlineCode">http</code> is configured; delete the <code class="inlineCode">launchUrl</code> and modify the port to use <code class="inlineCode">5083</code>, as shown highlighted in the following configuration:
            <pre class="programlisting code"><code class="hljs-code">{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "",
      "applicationUrl": "http://localhost:<strong class="hljs-string-slc">5083</strong>",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
</code></pre>
          </li>
        </ul>
      </li>
      <li class="numberedList">In the project file, change invariant globalization to <code class="inlineCode">false</code>, treat warnings as errors, note that native AOT publishing is enabled, and add a package reference for SQL <a id="_idIndexMarker838"/>Server for ADO.NET, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;Project Sdk="Microsoft.NET.Sdk.Web"&gt;
  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
    &lt;Nullable&gt;enable&lt;/Nullable&gt;
    &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
    &lt;InvariantGlobalization&gt;<strong class="hljs-literal-slc">false</strong>&lt;/InvariantGlobalization&gt;
<strong class="hljs-slc">    &lt;TreatWarningsAsErrors&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/TreatWarningsAsErrors&gt;</strong>
<strong class="hljs-slc">    &lt;PublishAot&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/PublishAot&gt;</strong>
  &lt;/PropertyGroup&gt;
<strong class="hljs-slc">  &lt;ItemGroup&gt;</strong>
<strong class="hljs-slc">    &lt;PackageReference Include=</strong><strong class="hljs-string-slc">"Microsoft.Data.SqlClient"</strong><strong class="hljs-slc"> Version=</strong><strong class="hljs-string-slc">"5.1.2"</strong><strong class="hljs-slc"> /&gt;</strong>
<strong class="hljs-slc">  &lt;/ItemGroup&gt;</strong>
&lt;/Project&gt;
</code></pre>
      </li>
      <li class="numberedList">Add a new class file named <code class="inlineCode">Product.cs</code>, and modify its contents to define a class to represent just the three columns we want from each row in the <code class="inlineCode">Products</code> table, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">namespace Northwind.Models;
public class Product
{
  public int ProductId { get; set; }
  public string? ProductName { get; set; }
  public decimal? UnitPrice { get; set; }
}
</code></pre>
      </li>
      <li class="numberedList">Add a new class file named <code class="inlineCode">NorthwindJsonSerializerContext.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">NorthwindJsonSerializerContext.cs</code>, define a class that enables a <code class="inlineCode">Product</code> and a list <a id="_idIndexMarker839"/>of <code class="inlineCode">Product</code> objects to be serialized as JSON, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using System.Text.Json.Serialization; // To use JsonSerializerContext.
using Northwind.Models; // To use Product.
namespace Northwind.Serialization;
[JsonSerializable(typeof(Product))]
[JsonSerializable(typeof(List&lt;Product&gt;))]
internal partial class NorthwindJsonSerializerContext
  : JsonSerializerContext { }
</code></pre>
      </li>
      <li class="numberedList">Delete the <code class="inlineCode">Northwind.MinimalAot.Service.http</code> file.</li>
      <li class="numberedList">Add a new class file named <code class="inlineCode">WebApplication.Extensions.cs</code>.</li>
      <li class="numberedList">In <code class="inlineCode">WebApplication.Extensions.cs</code>, define an extension method for the <code class="inlineCode">WebApplication</code> class that maps some HTTP <code class="inlineCode">GET</code> requests to return a plain text response, and a list of either all products or products with a minimum price from the Northwind database using ADO.NET, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using Microsoft.Data.SqlClient; // To use SqlConnection and so on.
using Northwind.Models; // To use Product.
using System.Data; // To use CommandType.
namespace Packt.Extensions;
public static class WebApplicationExtensions
{
  public static WebApplication MapGets(this WebApplication app)
  {
    // app.MapGet(pattern, handler);
    app.MapGet("/", () =&gt; "Hello from a native AOT minimal API web service.");
    app.MapGet("/products", GetProducts);
    app.MapGet("/products/{minimumUnitPrice:decimal?}", GetProducts);
    return app;
  }
  private static List&lt;Product&gt; GetProducts(decimal? minimumUnitPrice = null)
  {
    SqlConnectionStringBuilder builder = new();
    builder.InitialCatalog = "Northwind";
    builder.MultipleActiveResultSets = true;
    builder.Encrypt = true;
    builder.TrustServerCertificate = true;
    builder.ConnectTimeout = 10; // Default is 30 seconds.
    builder.DataSource = "."; // Local SQL Server
    builder.IntegratedSecurity = true;
    /*
    // To use SQL Server Authentication:
    builder.UserID = Environment.GetEnvironmentVariable("MY_SQL_USR");
    builder.Password = Environment.GetEnvironmentVariable("MY_SQL_PWD");
    builder.PersistSecurityInfo = false;
    */
    SqlConnection connection = new(builder.ConnectionString);
    connection.Open();
    SqlCommand cmd = connection.CreateCommand();
    cmd.CommandType = CommandType.Text;
    cmd.CommandText =
      "SELECT ProductId, ProductName, UnitPrice FROM Products";
    if (minimumUnitPrice.HasValue)
    {
      cmd.CommandText += " WHERE UnitPrice &gt;= @minimumUnitPrice";
      cmd.Parameters.AddWithValue("minimumUnitPrice", minimumUnitPrice);
    }
    SqlDataReader r = cmd.ExecuteReader();
    List&lt;Product&gt; products = new();
    while (r.Read())
    {
      Product p = new()
      {
        ProductId = r.GetInt32("ProductId"),
        ProductName = r.GetString("ProductName"),
        UnitPrice = r.GetDecimal("UnitPrice")
      };
      products.Add(p);
    }
    r.Close();
    return products;
  }
}
</code></pre>
      
    <div><p class="normal">With native AOT, we cannot use EF Core, so we are using the lower-level ADO.NET SqlClient API. This is faster and more efficient anyway. In the future, perhaps with .NET 9 or .NET 10, we will be able to use our EF Core model for Northwind instead.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="9">In <code class="inlineCode">Program.cs</code>, note the call to the <code class="inlineCode">CreateSlimBuilder</code> method, which ensures that only the essential features of ASP.NET Core are enabled by default, so it minimizes<a id="_idIndexMarker840"/> the deployed web service size, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">var builder = WebApplication.CreateSlimBuilder(args);
</code></pre>
      
    <div><p class="normal">The <code class="inlineCode">CreateSlimBuilder</code> method does not include support for HTTPS or HTTP/3, although you can add those back in yourself if you need them. It does support JSON file configuration for <code class="inlineCode">appsettings.json</code> and logging.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">In <code class="inlineCode">Program.cs</code>, after the call to <code class="inlineCode">builder.Build()</code>, delete the statements that generated some sample todos and map some endpoints, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">var sampleTodos = new Todo[]
{
  new(1, "Walk the dog"),
  new(2, "Do the dishes", DateOnly.FromDateTime(DateTime.Now)),
  new(3, "Do the laundry", DateOnly.FromDateTime(DateTime.Now.AddDays(1))),
  new(4, "Clean the bathroom"),
  new(5, "Clean the car", DateOnly.FromDateTime(DateTime.Now.AddDays(2)))
};
var todosApi = app.MapGroup("/todos");
todosApi.MapGet("/", () =&gt; sampleTodos);
todosApi.MapGet("/{id}", (int id) =&gt;
    sampleTodos.FirstOrDefault(a =&gt; a.Id == id) is { } todo
        ? Results.Ok(todo)
        : Results.NotFound());
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, at the bottom of the file, delete the statements that define the <code class="inlineCode">Todo</code> record and <code class="inlineCode">AppJsonSerializerContext</code> class, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">public record Todo(int Id, string? Title, DateOnly? DueBy = null, bool IsComplete = false);
[JsonSerializable(typeof(Todo[]))]
internal partial class AppJsonSerializerContext : JsonSerializerContext
{
}
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, delete the namespace imports, import the namespaces for our JSON serializer context and extension methods, modify the statement that inserts the JSON serialization context to use the Northwind one, and then before running<a id="_idIndexMarker841"/> the web <code class="inlineCode">app</code>, call the <code class="inlineCode">MapGets</code> method, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> Northwind.Serialization;</strong>
<strong class="hljs-keyword-slc">using</strong><strong class="hljs-slc"> Packt.Extensions; </strong><strong class="hljs-comment-slc">// To use MapGets().</strong>
var builder = WebApplication.CreateSlimBuilder(args);
builder.Services.ConfigureHttpJsonOptions(options =&gt;
{
  options.SerializerOptions.TypeInfoResolverChain
    .Insert(0, <strong class="hljs-slc">NorthwindJsonSerializerContext</strong>.Default);
});
var app = builder.Build();
<strong class="hljs-slc">app.MapGets();</strong>
app.Run();
</code></pre>
      </li>
      <li class="numberedList">If your database server is not running (for example, because you are hosting it in Docker, a virtual machine, or in the cloud), then make sure to start it.</li>
      <li class="numberedList">Start the web service project using the <code class="inlineCode">http</code> profile:<ul>
          <li class="bulletList">If you are using Visual Studio 2022, then select the <strong class="screenText">http</strong> profile in the drop-down list and then navigate to <strong class="screenText">Debug</strong> | <strong class="screenText">Start Without Debugging</strong> or press <em class="keystroke">Ctrl</em> + <em class="keystroke">F5</em>.</li>
          <li class="bulletList">If you are using Visual Studio Code, then enter the command <code class="inlineCode">dotnet run --launch-profile http</code>, manually start a web browser, and navigate to the web service: <code class="inlineCode">https://localhost:5083/</code>.</li>
        </ul>
      </li>
      <li class="numberedList">In the web browser, note<a id="_idIndexMarker842"/> the plain text response: <code class="inlineCode">Hello from a native AOT minimal API web service.</code></li>
      <li class="numberedList">In the address bar, append <code class="inlineCode">/products</code>, and note the array of products in the response, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">[{"productId":1,"productName":"Chai","unitPrice":18.0000},
 {"productId":2,"productName":"Chang","unitPrice":19.0000},
 {"productId":3,"productName":"Aniseed Syrup","unitPrice":10.0000},
 {"productId":4,"productName":"Chef Anton's Cajun Seasoning",
  "unitPrice":22.0000},
 {"productId":5,"productName":"Chef Anton's Gumbo Mix",
  "unitPrice":21.3500},
 {"productId":6,"productName":"Grandma's Boysenberry Spread",
  "unitPrice":25.0000},
 {"productId":7,"productName":"Uncle Bob's Organic Dried Pears",
  "unitPrice":30.0000},
 {"productId":8,"productName":"Northwoods Cranberry Sauce",
  "unitPrice":40.0000},
 {"productId":9,"productName":"Mishi Kobe Niku","unitPrice":97.0000},
 {"productId":10,"productName":"Ikura","unitPrice":31.0000},
 {"productId":11,"productName":"Queso Cabrales","unitPrice":21.0000},
 {"productId":12,"productName":"Queso Manchego La Pastora",
  "unitPrice":38.0000},
</code></pre>
      </li>
      <li class="numberedList">In the address bar, append <code class="inlineCode">/products/100</code>, and note the array of two products in the response, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">[{"productId":29,"productName":"Thüringer Rostbratwurst","unitPrice":123.7900},{"productId":38,"productName":"Côte de Blaye","unitPrice":263.5000}]
</code></pre>
      </li>
      <li class="numberedList">Close the browser and shut down the web server.</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-331">Publishing a native AOT project</h2>
    <p class="normal">A service that functions correctly during development when the service is untrimmed and JIT-compiled could still fail once you publish it using native AOT. You should therefore perform a<a id="_idIndexMarker843"/> publish before assuming your project will work.</p>
    <p class="normal">If your project does not produce any AOT warnings at publish time, you can then be confident that your service will work after publishing for AOT.</p>
    <p class="normal">Let’s review the source-generated code and publish our web service:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.MinimalAot.Service</code> project file, add an element to emit compiler-generated files, as shown highlighted in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;PropertyGroup&gt;
  &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
  ...
<strong class="hljs-slc">  &lt;EmitCompilerGeneratedFiles&gt;</strong><strong class="hljs-literal-slc">true</strong><strong class="hljs-slc">&lt;/EmitCompilerGeneratedFiles&gt;</strong>
&lt;/PropertyGroup&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.MinimalAot.Service</code> project.</li>
      <li class="numberedList">If you are using Visual Studio 2022, toggle <strong class="screenText">Show All Files</strong> in <strong class="screenText">Solution Explorer</strong>.</li>
      <li class="numberedList">Expand the <code class="inlineCode">obj\Debug\net8.0\generated</code> folder, and note the folders and files that have been created by the source generators for AOT and JSON serialization, and note that you will be opening some of these files in the next few steps, as shown in <em class="italic">Figure 8.10</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_08_10.png"/></figure>
    <p class="packt_figref">Figure 8.10: Folders and files created by source generators in an AOT web service project</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="5">Open the <code class="inlineCode">GeneratedRouteBuilderExtensions.g.cs</code> file, and note it contains code to define the mapped routes for the minimal API web service.</li>
      <li class="numberedList">Open the <code class="inlineCode">NorthwindJsonSerializerContext.Decimal.g.cs</code> file, and note it contains code to serialize a <code class="inlineCode">decimal</code> value passed as the minimum unit price parameter to one of the routes.</li>
      <li class="numberedList">Open the <code class="inlineCode">NorthwindJsonSerializerContext.ListProduct.g.cs</code> file, and note it contains<a id="_idIndexMarker844"/> code to serialize a list of <code class="inlineCode">Product</code> objects returned as a response for two of the routes.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.MinimalAot.Service</code> folder, at the command prompt or terminal, publish the web service using native AOT, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet publish
</code></pre>
      </li>
      <li class="numberedList">Note the message about generating native code and trim warnings for packages like <code class="inlineCode">Microsoft.Data.SqlClient</code>, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">Generating native code
C:\Users\markj\.nuget\packages\microsoft.data.sqlclient\5.1.1\runtimes\win\lib\net6.0\Microsoft.Data.SqlClient.dll : warning IL2104: Assembly 'Microsoft.Data.SqlClient' produced trim warnings. For more information see https://aka.ms/dotnet-illink/libraries [C:\apps-services-net8\Chapter08\Northwind.MinimalAot.Service\Northwind.MinimalAot.Service.csproj]
/_/src/libraries/System.Data.Common/src/System/Data/DataTable.cs(6704): Trim analysis warning IL2026: System.Data.DataTable.System.Xml.Serialization.IXmlSerializable.ReadXml(XmlReader): Using member 'System.Data.DataTable.ReadXmlSerializableInternal(XmlReader)' which has 'RequiresUnreferencedCodeAttribute' can break functionality when trimming application code. DataTable.ReadXml uses XmlSerialization underneath which is not trimming safe. Members from serialized types may be trimmed if not referenced directly. [C:\apps-services-net8\Chapter08\Northwind.MinimalAot.Service\Northwind.MinimalAot.Service.csproj]
</code></pre>
      
    <div><p class="normal">We did not use the <code class="inlineCode">DataTable.ReadXml</code> method, which is calling a potentially trimmed member, so we can ignore the preceding warning.</p>
    </div></li>
    </ol>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="10">Start <strong class="screenText">File Explorer</strong> and open the <code class="inlineCode">bin\Release\net8.0\win-x64\publish</code> folder and note the EXE file is about 30 MB. This and the <code class="inlineCode">Microsoft.Data.SqlClient.SNI.dll</code> file are the only files that need to be deployed onto another <a id="_idIndexMarker845"/>Windows computer for the web service to work. The <code class="inlineCode">appsettings.json</code> files are only needed to override configuration if needed. The PDB file is only needed if debugging.</li>
      <li class="numberedList">Run the <code class="inlineCode">Northwind.MinimalAot.Service.exe</code>, and note the web service starts up very fast and it will use port <code class="inlineCode">5000</code> by default, as shown in <em class="italic">Figure 8.11</em>:</li>
    </ol>
    <figure class="mediaobject"><img alt="" src="img/B19587_08_11.png"/></figure>
    <figure class="mediaobject">Figure 8.11: File Explorer showing published executable and running the AOT web service</figure>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="12">Start a web browser, navigate <a id="_idIndexMarker846"/>to <code class="inlineCode">http://localhost:5000/</code>, and note the web service works correctly by returning the plain text response.</li>
      <li class="numberedList">Navigate to <code class="inlineCode">http://localhost:5000/products/100</code>, and note the web service responds with the two products that have a minimum unit price of 100.</li>
      <li class="numberedList">Close the web browser and shut down the web service.</li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Service</code> project file, at the command prompt or terminal, publish the web service, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet publish
</code></pre>
      </li>
      <li class="numberedList">Start <strong class="screenText">File Explorer</strong>, open the <code class="inlineCode">bin\Release\net8.0\win-x64\publish</code> folder, and note the <code class="inlineCode">Northwind.WebApi.Service.exe</code> file is less than 154 KB. That is because it is framework-dependent, meaning it needs .NET installed on the computer to work. Also, there are many files that must be deployed along with the EXE file that add up to about 14 MB.</li>
      <li class="numberedList">Run the <code class="inlineCode">Northwind.MinimalAot.Service.exe</code> and note the web service starts up slower than the AOT version and it will use port <code class="inlineCode">5000</code> by default.</li>
      <li class="numberedList">Start a web browser, navigate to <code class="inlineCode">http://localhost:5000/</code>, and note the web service works correctly by returning the plain text response.</li>
      <li class="numberedList">Navigate to <code class="inlineCode">http://localhost:5000/products/100</code>, and note the web service responds with the two products that have a minimum unit price of 100 but the response is slower than the AOT version.</li>
      <li class="numberedList">Close the web browser and shut down the web service.</li>
    </ol>
    <p class="normal">Many .NET developers have<a id="_idIndexMarker847"/> been waiting for AOT compilation for a long time. Microsoft is finally delivering on the promise, and it will expand to cover more project types over the next few major versions, so it’s a technology to keep an eye on.</p>
    <h1 class="heading-1" id="_idParaDest-332">Understanding identity services</h1>
    <p class="normal">Identity services are used to authenticate and authorize users. It is important for these services to implement open standards so that you can integrate disparate systems. Common standards include <strong class="keyWord">OpenID Connect</strong> and <strong class="keyWord">OAuth 2.0</strong>.</p>
    <p class="normal">Microsoft has no plans to officially<a id="_idIndexMarker848"/> support third-party authentication servers <a id="_idIndexMarker849"/>like <strong class="keyWord">IdentityServer4</strong> because “creating and sustaining an authentication server is a full-time endeavor, and Microsoft already has a team and a product in that area, Azure Active Directory, which allows 500,000 objects for free.”</p>
    <h2 class="heading-2" id="_idParaDest-333">JWT bearer authorization</h2>
    <p class="normal"><strong class="keyWord">JSON Web Token</strong> (<strong class="keyWord">JWT</strong>) is<a id="_idIndexMarker850"/> a standard that<a id="_idIndexMarker851"/> defines a compact and secure method to transmit information as a JSON object. The JSON object is digitally <a id="_idIndexMarker852"/>signed so it can be trusted. The most common scenario for using JWT is authorization.</p>
    <p class="normal">A user logs in to a trusted party using credentials like a username and password or biometric scan or two-factor authentication, and the trusted party issues a JWT. This is then sent with every request to the secure web service.</p>
    <p class="normal">In their compact form, JWTs consist of three parts separated by dots. These parts are the <em class="italic">header</em>, <em class="italic">payload</em>, and <em class="italic">signature</em>, as shown in the following format: <code class="inlineCode">aaa.bbb.ccc</code>. The header and payload are Base64 <a id="_idIndexMarker853"/>encoded.</p>
    <h2 class="heading-2" id="_idParaDest-334">Authenticating service clients using JWT bearer authentication</h2>
    <p class="normal">During local development, the <code class="inlineCode">dotnet user-jwts</code> command-line tool is used to create and manage local JWTs. The values are<a id="_idIndexMarker854"/> stored in a JSON file in the local machine’s user profile folder.</p>
    <p class="normal">Let’s secure the web service using JWT bearer authentication and test it with a local token:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">In the <code class="inlineCode">Northwind.WebApi.Service</code> project, add a reference to the package for JWT bearer authentication, as shown in the following markup:
        <pre class="programlisting code"><code class="hljs-code">&lt;PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer"
                  Version="8.0.0" /&gt;
</code></pre>
      </li>
      <li class="numberedList">Build the <code class="inlineCode">Northwind.WebApi.Service</code> project to restore packages.</li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after creating the <code class="inlineCode">builder</code>, add statements to add authorization and authentication using JWT, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">var builder = WebApplication.CreateBuilder(args);
<strong class="hljs-slc">builder.Services.AddAuthorization();</strong>
<strong class="hljs-slc">builder.Services.AddAuthentication(defaultScheme: </strong><strong class="hljs-string-slc">"Bearer"</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">  .AddJwtBearer();</strong>
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">Program.cs</code>, after building the app, add a statement to use authorization, as shown highlighted in the following code:
        <pre class="programlisting code"><code class="hljs-code">var app = builder.Build();
<strong class="hljs-slc">app.UseAuthorization();</strong>
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">WebApplication.Extensions.cs</code>, import the namespace for security claims, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">using System.Security.Claims; // To use ClaimsPrincipal.
</code></pre>
      </li>
      <li class="numberedList">In <code class="inlineCode">WebApplication.Extensions.cs</code>, after mapping an HTTP <code class="inlineCode">GET</code> request for the root path to return a plain text <code class="inlineCode">Hello World </code>response, add a statement to map an HTTP <code class="inlineCode">GET</code> request <a id="_idIndexMarker855"/>for the secret path to return the authenticated user’s name if they are authorized, as shown in the following code:
        <pre class="programlisting code"><code class="hljs-code">app.MapGet("/", () =&gt; "Hello World!")
  .ExcludeFromDescription();
<strong class="hljs-slc">app.MapGet(</strong><strong class="hljs-string-slc">"/secret"</strong><strong class="hljs-slc">, (ClaimsPrincipal user) =&gt; </strong>
<strong class="hljs-slc">  </strong><strong class="hljs-built_in-slc">string</strong><strong class="hljs-slc">.Format(</strong><strong class="hljs-string-slc">"Welcome, {0}. The secret ingredient is love."</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">    user.Identity?.Name ?? </strong><strong class="hljs-string-slc">"secure user"</strong><strong class="hljs-slc">))</strong>
<strong class="hljs-slc">  .RequireAuthorization();</strong>
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Service</code> project folder, at the command prompt or terminal, create a local JWT, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet user-jwts create
</code></pre>
      </li>
      <li class="numberedList">Note the automatically assigned <code class="inlineCode">ID</code>, <code class="inlineCode">Name</code>, and <code class="inlineCode">Token</code>, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">New JWT saved with ID 'd7e22000'.
Name: markjprice
Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6Im1hcmtqcHJpY2UiLCJzdWIiOiJtYXJran...lci1qd3RzIn0.pGEbYKRjU98dEjxLSx7GAEm41LXMS0J80iIjuZbqrj4
</code></pre>
      </li>
      <li class="numberedList">At the command prompt or terminal, print all the information for the ID that was assigned, as shown in the following command:
        <pre class="programlisting con"><code class="hljs-con">dotnet user-jwts print d7e22000 --show-all
</code></pre>
      </li>
      <li class="numberedList">Note the scheme is <code class="inlineCode">Bearer</code> so the token must be sent with every request, the audience(s) lists the authorized client domains and port numbers, the token expires after three months, the JSON objects represent the header and payload, and finally, there’s the compact token with its Base64-encoded three parts separated by <a id="_idIndexMarker856"/>dots, as shown in the following partial output:
        <pre class="programlisting con"><code class="hljs-con">Found JWT with ID 'd7e22000'.
ID: d7e22000
Name: markjprice
Scheme: Bearer
Audience(s): http://localhost:30225, https://localhost:44344, http://localhost:5080, https://localhost:5081
Not Before: 2023-09-26T10:58:18.0000000+00:00
Expires On: 2023-12-26T10:58:18.0000000+00:00
Issued On: 2023-09-26T10:58:19.0000000+00:00
Scopes: none
Roles: [none]
Custom Claims: [none]
Token Header: {"alg":"HS256","typ":"JWT"}
Token Payload: {"unique_name":"markjprice","sub":"markjprice","jti":"d7e22000","aud":["http://localhost:30225","https://localhost:44344","http://localhost:5080","https://localhost:5081"],"nbf":1664189898,"exp":1672052298,"iat":1664189899,"iss":"dotnet-user-jwts"}
Compact Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6Im1hcmtqcHJpY2UiLCJzdWIiOiJtYXJranByaWNl...uZXQtdXNlci1qd3RzIn0.pGEbYKRjU98dEjxLSx7GAEm41LXMS0J80iIjuZbqrj4
</code></pre>
      </li>
      <li class="numberedList">In the <code class="inlineCode">Northwind.WebApi.Service</code> project, in <code class="inlineCode">appsettings.Development.json</code>, note the new section named <code class="inlineCode">Authentication</code>, as shown highlighted in the following configuration:
        <pre class="programlisting code"><code class="hljs-code">{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.AspNetCore.HttpLogging": "Information"
    }
  },
<strong class="hljs-slc">  </strong><strong class="hljs-attr-slc">"Authentication"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">{</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-attr-slc">"Schemes"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">{</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-attr-slc">"Bearer"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">{</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-attr-slc">"ValidAudiences"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-punctuation-slc">[</strong>
<strong class="hljs-slc">          </strong><strong class="hljs-string-slc">"http://localhost:30225"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">          </strong><strong class="hljs-string-slc">"https://localhost:44344"</strong><strong class="hljs-punctuation-slc">,</strong>
<strong class="hljs-slc">          </strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">http://localhost:5080"</strong>
<strong class="hljs-slc">          </strong><strong class="hljs-string-slc">"https://localhost:5081"</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-punctuation-slc">],</strong>
<strong class="hljs-slc">        </strong><strong class="hljs-attr-slc">"ValidIssuer"</strong><strong class="hljs-punctuation-slc">:</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"dotnet-user-jwts"</strong>
<strong class="hljs-slc">      </strong><strong class="hljs-punctuation-slc">}</strong>
<strong class="hljs-slc">    </strong><strong class="hljs-punctuation-slc">}</strong>
<strong class="hljs-slc">  </strong><strong class="hljs-punctuation-slc">}</strong>
}
</code></pre>
      </li>
      <li class="numberedList">Start the <code class="inlineCode">Northwind.WebApi.Service</code> project using the <code class="inlineCode">https</code> profile without debugging.</li>
      <li class="numberedList">In the browser, change the relative path to <code class="inlineCode">/secret</code> and note the response is rejected with<a id="_idIndexMarker857"/> a 401 status code.</li>
      <li class="numberedList">Start Visual Studio Code and open the <code class="inlineCode">HttpRequests</code> folder.</li>
      <li class="numberedList">In the <code class="inlineCode">HttpRequests</code> folder, create a file named <code class="inlineCode">webapi-secure-request.http</code> and modify its contents to contain a request to get the secret ingredient, as shown in the following code (but use your <code class="inlineCode">Bearer</code> token, of course):
        <pre class="programlisting code"><code class="hljs-code">### Get the secret ingredient.
GET https://localhost:5081/secret/
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6Im1hcmtqcHJpY2UiLCJzdWIiOiJtYXJranByaWNl...uZXQtdXNlci1qd3RzIn0.pGEbYKRjU98dEjxLSx7GAEm41LXMS0J80iIjuZbqrj4
</code></pre>
      </li>
      <li class="numberedList">Click <strong class="screenText">Send Request</strong>, and note the response, as shown in the following output:
        <pre class="programlisting con"><code class="hljs-con">Welcome, secure user. The secret ingredient is love.
</code></pre>
      </li>
      <li class="numberedList">Close the browser and shut down the web service.</li>
    </ol>
    <h1 class="heading-1" id="_idParaDest-335">Practicing and exploring</h1>
    <p class="normal">Test your knowledge and understanding by answering some questions, getting some hands-on practice, and exploring this chapter’s topics with deeper research.</p>
    <h2 class="heading-2" id="_idParaDest-336">Exercise 8.1 – Test your knowledge</h2>
    <p class="normal">Answer the following questions:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">List six method names that can be specified in an HTTP request.</li>
      <li class="numberedList">List six status codes and their descriptions that can be returned in an HTTP response.</li>
      <li class="numberedList">How is the ASP.NET Core Minimal APIs service technology different from the ASP.NET Core Web APIs service technology?</li>
      <li class="numberedList">With the ASP.NET Core Minimal APIs service technology, how do you map an HTTP <code class="inlineCode">PUT</code> request to <code class="inlineCode">api/customers</code> to a lambda statement block?</li>
      <li class="numberedList">With the ASP.NET Core Minimal APIs service technology, how do you map a method or lambda parameter to a value in a route, query string, or the body of the request?</li>
      <li class="numberedList">Does enabling CORS increase security for a web service?</li>
      <li class="numberedList">You have added statements to <code class="inlineCode">Program.cs</code> to enable HTTP logging but HTTP requests and responses are not being logged. What is the most likely reason and how can you fix it?</li>
      <li class="numberedList">How do you limit the rate of requests for a specific client using the <code class="inlineCode">AspNetCoreRateLimit</code> package?</li>
      <li class="numberedList">How do you limit the rate of requests for a specific endpoint using the <code class="inlineCode">Microsoft.AspNetCore.RateLimiting</code> package?</li>
      <li class="numberedList">What does JWT mean?</li>
    </ol>
    <h2 class="heading-2" id="_idParaDest-337">Exercise 8.2 – Review Microsoft HTTP API design policy</h2>
    <p class="normal">Microsoft has internal HTTP/REST API design guidelines. Microsoft teams reference this document when designing their HTTP APIs. They are a great starting point for your own standards for HTTP APIs. You can review them at the following link:</p>
    <p class="normal"><a href="https://github.com/microsoft/api-guidelines">https://github.com/microsoft/api-guidelines</a></p>
    <p class="normal">The guidelines have a section specific to CORS and you can review them at the following link:</p>
    <p class="normal"><a href="https://github.com/microsoft/api-guidelines/blob/vNext/Guidelines.md#8-cors">https://github.com/microsoft/api-guidelines/blob/vNext/Guidelines.md#8-cors</a></p>
    <h2 class="heading-2" id="_idParaDest-338">Exercise 8.3 – Explore topics</h2>
    <p class="normal">Use the links on the following page to learn more details about the topics covered in this chapter:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-8---building-and-securing-web-services-using-minimal-apis">https://github.com/markjprice/apps-services-net8/blob/main/docs/book-links.md#chapter-8---building-and-securing-web-services-using-minimal-apis</a></p>
    <h2 class="heading-2" id="_idParaDest-339">Exercise 8.4 – Exposing data via the web using OData services</h2>
    <p class="normal">Learn how to quickly implement a Web API service that can wrap an EF Core entity model using OData in this online-only chapter:</p>
    <p class="normal"><a href="https://github.com/markjprice/apps-services-net8/blob/main/docs/ch08-odata.md">https://github.com/markjprice/apps-services-net8/blob/main/docs/ch08-odata.md</a></p>
    <h2 class="heading-2" id="_idParaDest-340">Exercise 8.5 – Auth0 project templates</h2>
    <p class="normal">If you need to implement Auth0 for authentication and authorization, then you can use project templates to scaffold your code. An article describing these project templates and how to use them is found at the following link:</p>
    <p class="normal"><a href="https://auth0.com/blog/introducing-auth0-templates-for-dotnet/">https://auth0.com/blog/introducing-auth0-templates-for-dotnet/</a></p>
    <h1 class="heading-1" id="_idParaDest-341">Summary</h1>
    <p class="normal">In this chapter, you learned how to: </p>
    <ul>
      <li class="bulletList">Build a web service that implements the REST architectural style using minimal APIs.</li>
      <li class="bulletList">Relax the same-origin security policy for specified domains and ports using CORS.</li>
      <li class="bulletList">Implement two different rate-limiting packages to prevent denial of service attacks.</li>
      <li class="bulletList">Secure services using JWT bearer authorization.</li>
    </ul>
    <p class="normal">In the next chapter, you will learn how to build reliable and scalable services by adding features like caching, queues, and automatic handling of transient faults using libraries like Polly.</p>
  </div>
</body></html>