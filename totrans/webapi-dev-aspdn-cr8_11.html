<html><head></head><body>
<div id="_idContainer088">
<h1 class="chapter-number" id="_idParaDest-229"><a id="_idTextAnchor438"/><span class="koboSpan" id="kobo.1.1">11</span></h1>
<h1 id="_idParaDest-230"><a id="_idTextAnchor439"/><span class="koboSpan" id="kobo.2.1">Getting Started with gRPC</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Besides RESTful APIs, there are other types of APIs. </span><span class="koboSpan" id="kobo.3.2">One of them is the </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">remote procedure call</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.6.1">RPC</span></strong><span class="koboSpan" id="kobo.7.1">)-based API, which we introduced in </span><a href="B18971_01.xhtml#_idTextAnchor012"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.8.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.9.1">. </span><span class="koboSpan" id="kobo.9.2">gRPC is a high-performance RPC framework developed by Google. </span><span class="koboSpan" id="kobo.9.3">Now, it is an open-source project under the </span><strong class="bold"><span class="koboSpan" id="kobo.10.1">Cloud Native Computing Foundation</span></strong><span class="koboSpan" id="kobo.11.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.12.1">CNCF</span></strong><span class="koboSpan" id="kobo.13.1">), and it is becoming more and </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">more popular.</span></span></p>
<p><span class="koboSpan" id="kobo.15.1">ASP.NET Core provides a set of gRPC tools to help us build gRPC services. </span><span class="koboSpan" id="kobo.15.2">In this chapter, we will introduce the fundamentals of gRPC and </span><strong class="bold"><span class="koboSpan" id="kobo.16.1">Protocol Buffers</span></strong><span class="koboSpan" id="kobo.17.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.18.1">Protobuf</span></strong><span class="koboSpan" id="kobo.19.1">) messages. </span><span class="koboSpan" id="kobo.19.2">First, we will learn how to define protobuf messages and gRPC services. </span><span class="koboSpan" id="kobo.19.3">Then, we will learn how to implement gRPC services in ASP.NET Core, empowering us to communicate seamlessly between different applications. </span><span class="koboSpan" id="kobo.19.4">We will be covering the following topics in </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.21.1">Recap </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">of gRPC</span></span></li>
<li><span class="koboSpan" id="kobo.23.1">Setting up a </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">gRPC project</span></span></li>
<li><span class="koboSpan" id="kobo.25.1">Defining gRPC services </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">and messages</span></span></li>
<li><span class="koboSpan" id="kobo.27.1">Implementing gRPC services </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">and clients</span></span></li>
<li><span class="koboSpan" id="kobo.29.1">Consuming gRPC services in ASP.NET </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">Core applications</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.31.1">By the end of this chapter, you should be able to understand the fundamentals of protobuf and gRPC and know how to build gRPC services in </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">ASP.NET Core.</span></span></p>
<h1 id="_idParaDest-231"><a id="_idTextAnchor440"/><span class="koboSpan" id="kobo.33.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.34.1">The code examples in this chapter can be found at </span><a href="https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8/tree/main/samples/chapter11"><span class="koboSpan" id="kobo.35.1">https://github.com/PacktPublishing/Web-API-Development-with-ASP.NET-Core-8/tree/main/samples/chapter11</span></a><span class="koboSpan" id="kobo.36.1">. </span><span class="koboSpan" id="kobo.36.2">You can use VS 2022 or VS Code to open </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">the solutions.</span></span></p>
<h1 id="_idParaDest-232"><a id="_idTextAnchor441"/><span class="koboSpan" id="kobo.38.1">Recap of gRPC</span></h1>
<p><span class="koboSpan" id="kobo.39.1">If you have read </span><a href="B18971_01.xhtml#_idTextAnchor012"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.40.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.41.1">, you should be familiar with the concept of RPC – it is a protocol that allows a program to call a procedure on a remote machine. </span><span class="koboSpan" id="kobo.41.2">Unlike RESTful APIs, which center around resources, RPC-based APIs focus on actions. </span><span class="koboSpan" id="kobo.41.3">So, RPC methods support various types of actions besides </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">CRUD operations.</span></span></p>
<p><span class="koboSpan" id="kobo.43.1">gRPC is </span><a id="_idIndexMarker1086"/><span class="koboSpan" id="kobo.44.1">one of the most popular RPC frameworks. </span><span class="koboSpan" id="kobo.44.2">It provides many benefits over traditional RPC frameworks. </span><span class="koboSpan" id="kobo.44.3">As we mentioned in </span><a href="B18971_01.xhtml#_idTextAnchor012"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.45.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.46.1">, gRPC is based on HTTP/2, which is more efficient than HTTP/1.1. </span><span class="koboSpan" id="kobo.46.2">gRPC uses protobuf as the default data serialization format, which is a binary format that is more compact and efficient than JSON. </span><span class="koboSpan" id="kobo.46.3">The tooling support for gRPC is also very good. </span><span class="koboSpan" id="kobo.46.4">It follows the contract-first approach, which means we can create language-neutral service definitions and generate code for different languages. </span><span class="koboSpan" id="kobo.46.5">It also supports streaming, which is a very useful feature for </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">real-time communication.</span></span></p>
<p><span class="koboSpan" id="kobo.48.1">With the increasing popularity of microservices, gRPC is becoming more and more popular. </span><span class="koboSpan" id="kobo.48.2">While gRPC offers some advantages over RESTful APIs, it is not considered a complete replacement. </span><span class="koboSpan" id="kobo.48.3">gRPC is an excellent choice for high-performance, low-latency communication between microservices, but RESTful APIs are more suitable for web-based applications and scenarios where simplicity, flexibility, and wide adoption are more critical. </span><span class="koboSpan" id="kobo.48.4">It’s important to choose the right protocol based on the requirements of your specific use case. </span><span class="koboSpan" id="kobo.48.5">In the next section, we will learn how to set up a gRPC project in </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">ASP.NET Core.</span></span><a id="_idTextAnchor442"/></p>
<h1 id="_idParaDest-233"><a id="_idTextAnchor443"/><span class="koboSpan" id="kobo.50.1">Setting up a gRPC project</span></h1>
<p><span class="koboSpan" id="kobo.51.1">In this section, we</span><a id="_idIndexMarker1087"/><span class="koboSpan" id="kobo.52.1"> will build a gRPC project using the dotnet CLI. </span><span class="koboSpan" id="kobo.52.2">We will also create a client project to consume the gRPC service. </span><span class="koboSpan" id="kobo.52.3">We will be using the same project throughout </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">this chapter</span><a id="_idTextAnchor444"/><span class="koboSpan" id="kobo.54.1">.</span></span></p>
<h2 id="_idParaDest-234"><a id="_idTextAnchor445"/><span class="koboSpan" id="kobo.55.1">Creating a new gRPC project</span></h2>
<p><span class="koboSpan" id="kobo.56.1">To create a </span><a id="_idIndexMarker1088"/><span class="koboSpan" id="kobo.57.1">new gRPC project, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">dotnet new</span></strong><span class="koboSpan" id="kobo.59.1"> command. </span><span class="koboSpan" id="kobo.59.2">The dotnet CLI provides a template for gRPC projects, which includes a basic gRPC service. </span><span class="koboSpan" id="kobo.59.3">We can use the following command to create a new </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">gRPC project:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.61.1">
dotnet new grpc -o GrpcDemo</span></pre> <p><span class="koboSpan" id="kobo.62.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.63.1">-o</span></strong><span class="koboSpan" id="kobo.64.1"> option specifies the output directory. </span><span class="koboSpan" id="kobo.64.2">After running the command, we will see that a project named </span><strong class="source-inline"><span class="koboSpan" id="kobo.65.1">GrpcDemo</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.66.1">is created.</span></span></p>
<p><span class="koboSpan" id="kobo.67.1">If you</span><a id="_idIndexMarker1089"/><span class="koboSpan" id="kobo.68.1"> prefer to use VS 2022, you can also create a new gRPC project in VS 2022 using the built-in gRPC template. </span><span class="koboSpan" id="kobo.68.2">You can select the </span><strong class="bold"><span class="koboSpan" id="kobo.69.1">ASP.NET Core gRPC Service</span></strong><span class="koboSpan" id="kobo.70.1"> template when creating a new project, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.71.1">Figure 11</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.72.1">.1</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer085">
<span class="koboSpan" id="kobo.74.1"><img alt="Figure 11.1 – Creating a new gRPC project in VS 2022" src="image/B18971_11_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.75.1">Figure 11.1 – Creating a new gRPC project in VS 2022</span></p>
<p><span class="koboSpan" id="kobo.76.1">After creating the project, you can use VS Code or VS 2022 to open the project. </span><span class="koboSpan" id="kobo.76.2">Next, we’ll explore the </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">project structur</span><a id="_idTextAnchor446"/><span class="koboSpan" id="kobo.78.1">e.</span></span></p>
<h2 id="_idParaDest-235"><a id="_idTextAnchor447"/><span class="koboSpan" id="kobo.79.1">Understanding the gRPC project structure</span></h2>
<p><span class="koboSpan" id="kobo.80.1">The </span><a id="_idIndexMarker1090"/><span class="koboSpan" id="kobo.81.1">project structure of a gRPC project has some differences from a RESTful API project. </span><span class="koboSpan" id="kobo.81.2">There is no </span><strong class="source-inline"><span class="koboSpan" id="kobo.82.1">Controllers</span></strong><span class="koboSpan" id="kobo.83.1"> folder in the gRPC project. </span><span class="koboSpan" id="kobo.83.2">Instead, there is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.84.1">Protos</span></strong><span class="koboSpan" id="kobo.85.1"> folder, which contains the proto files. </span><span class="koboSpan" id="kobo.85.2">You can find a </span><strong class="source-inline"><span class="koboSpan" id="kobo.86.1">greet.proto</span></strong><span class="koboSpan" id="kobo.87.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.88.1">Protos</span></strong><span class="koboSpan" id="kobo.89.1"> folder, </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.91.1">
syntax = "proto3";option csharp_namespace = "GrpcDemo";
package greet;
// The greeting service definition.
</span><span class="koboSpan" id="kobo.91.2">service Greeter {
  // Sends a greeting
  rpc SayHello (HelloRequest) returns (HelloReply);
}
// The request message containing the user's name.
</span><span class="koboSpan" id="kobo.91.3">message HelloRequest {
  string name = 1;
}
// The response message containing the greetings.
</span><span class="koboSpan" id="kobo.91.4">message HelloReply {
  string message = 1;
}</span></pre>
<p><span class="koboSpan" id="kobo.92.1">gRPC </span><a id="_idIndexMarker1091"/><span class="koboSpan" id="kobo.93.1">uses protobuf as the </span><a id="_idIndexMarker1092"/><span class="koboSpan" id="kobo.94.1">default data serialization format. </span><span class="koboSpan" id="kobo.94.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">greet.proto</span></strong><span class="koboSpan" id="kobo.96.1"> file is the proto file that defines the gRPC service and messages. </span><span class="koboSpan" id="kobo.96.2">If you are familiar with RESTful APIs, you can think of this file as the Swagger file (OpenAPI specification). </span><span class="koboSpan" id="kobo.96.3">It is the contract of the gRPC service. </span><span class="koboSpan" id="kobo.96.4">In the preceding proto file, we define a service named </span><strong class="source-inline"><span class="koboSpan" id="kobo.97.1">Greeter</span></strong><span class="koboSpan" id="kobo.98.1"> with a method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.99.1">SayHello()</span></strong><span class="koboSpan" id="kobo.100.1">. </span><span class="koboSpan" id="kobo.100.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.101.1">SayHello()</span></strong><span class="koboSpan" id="kobo.102.1"> method takes a </span><strong class="source-inline"><span class="koboSpan" id="kobo.103.1">HelloRequest</span></strong><span class="koboSpan" id="kobo.104.1"> message as input and returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.105.1">HelloReply</span></strong><span class="koboSpan" id="kobo.106.1"> message as output. </span><span class="koboSpan" id="kobo.106.2">Both </span><strong class="source-inline"><span class="koboSpan" id="kobo.107.1">HelloRequest</span></strong><span class="koboSpan" id="kobo.108.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.109.1">HelloReply</span></strong><span class="koboSpan" id="kobo.110.1"> messages have string properties named </span><strong class="source-inline"><span class="koboSpan" id="kobo.111.1">name</span></strong><span class="koboSpan" id="kobo.112.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.113.1">message</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">, respectively.</span></span></p>
<p><span class="koboSpan" id="kobo.115.1">In a proto file, you can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">//</span></strong><span class="koboSpan" id="kobo.117.1"> to add comments. </span><span class="koboSpan" id="kobo.117.2">To add multi-line comments, you can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.118.1">/* ... </span><span class="koboSpan" id="kobo.118.2">*/</span></strong><span class="koboSpan" id="kobo.119.1">.</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.120.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.121.1">VS Code does not provide syntax highlighting for proto files by default. </span><span class="koboSpan" id="kobo.121.2">You can install some extensions, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">vscode-proto3</span></strong><span class="koboSpan" id="kobo.123.1">, to enable </span><span class="No-Break"><span class="koboSpan" id="kobo.124.1">syntax highlighting.</span></span></p>
<p><span class="koboSpan" id="kobo.125.1">Let’s check</span><a id="_idIndexMarker1093"/><span class="koboSpan" id="kobo.126.1"> the project file. </span><span class="koboSpan" id="kobo.126.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.127.1">GrpcDemo.csproj</span></strong><span class="koboSpan" id="kobo.128.1"> file; we will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">following content:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.130.1">
&lt;ItemGroup&gt;  &lt;Protobuf Include="Protos\greet.proto" GrpcServices="Server" /&gt;
&lt;/ItemGroup&gt;
&lt;ItemGroup&gt;
  &lt;PackageReference Include="Grpc.AspNetCore" Version="2.51.0" /&gt;
  &lt;PackageReference Include="Google.Protobuf" Version="3.22.0-rc2" /&gt;
&lt;/ItemGroup&gt;</span></pre>
<p><span class="koboSpan" id="kobo.131.1">You will see that it includes two </span><span class="No-Break"><span class="koboSpan" id="kobo.132.1">package references:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">Grpc.AspNetCore</span></strong><span class="koboSpan" id="kobo.134.1">: This package provides the gRPC server library for ASP.NET Core. </span><span class="koboSpan" id="kobo.134.2">It also references the </span><strong class="source-inline"><span class="koboSpan" id="kobo.135.1">Grpc.Tools</span></strong><span class="koboSpan" id="kobo.136.1"> package, which provides the </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">code-generation tooling.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">Google.Protobuf</span></strong><span class="koboSpan" id="kobo.139.1">: This package provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.140.1">Protobuf</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.141.1">runtime library.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.142.1">There is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">Protobuf</span></strong><span class="koboSpan" id="kobo.144.1"> item group that includes the proto file. </span><span class="koboSpan" id="kobo.144.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.145.1">GrpcServices</span></strong><span class="koboSpan" id="kobo.146.1"> attribute specifies the type of code generated by the proto file. </span><span class="koboSpan" id="kobo.146.2">It can be set to the </span><span class="No-Break"><span class="koboSpan" id="kobo.147.1">following values:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.148.1">None</span></strong><span class="koboSpan" id="kobo.149.1">: No code </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">is generated</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.151.1">Client</span></strong><span class="koboSpan" id="kobo.152.1">: This option only generates </span><span class="No-Break"><span class="koboSpan" id="kobo.153.1">client-side code</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.154.1">Server</span></strong><span class="koboSpan" id="kobo.155.1">: This option only generates </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">server-side code</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">Both</span></strong><span class="koboSpan" id="kobo.158.1">: This option generates both client-side code and server-side code. </span><span class="koboSpan" id="kobo.158.2">It is the </span><span class="No-Break"><span class="koboSpan" id="kobo.159.1">default value</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.160.1">In the </span><a id="_idIndexMarker1094"/><span class="koboSpan" id="kobo.161.1">template project, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">GrpcServices</span></strong><span class="koboSpan" id="kobo.163.1"> attribute is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.164.1">Server</span></strong><span class="koboSpan" id="kobo.165.1">, which means only server-side code </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">is generated.</span></span></p>
<p><span class="koboSpan" id="kobo.167.1">If you have multiple proto files, you can add multiple </span><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">Protobuf</span></strong><span class="koboSpan" id="kobo.169.1"> items to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.170.1">ItemGroup</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.171.1"> element.</span></span></p>
<p><span class="koboSpan" id="kobo.172.1">Next, let’s check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.173.1">Services</span></strong><span class="koboSpan" id="kobo.174.1"> folder. </span><span class="koboSpan" id="kobo.174.2">You can find the </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">GreeterService.cs</span></strong><span class="koboSpan" id="kobo.176.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">Services</span></strong><span class="koboSpan" id="kobo.178.1"> folder, which contains the implementation of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">Greeter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.180.1"> service:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.181.1">
public class GreeterService(ILogger&lt;GreeterService&gt; logger) : Greeter.GreeterBase{
    public override Task&lt;HelloReply&gt; SayHello(HelloRequest request, ServerCallContext context)
    {
        return Task.FromResult(new HelloReply
        {
            Message = "Hello " + request.Name
        });
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.182.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.183.1">GreeterService</span></strong><span class="koboSpan" id="kobo.184.1"> class inherits from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.185.1">GreeterBase</span></strong><span class="koboSpan" id="kobo.186.1"> class, which is generated by the proto file. </span><span class="koboSpan" id="kobo.186.2">It has a </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">SayHello()</span></strong><span class="koboSpan" id="kobo.188.1"> method, which takes a </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">HelloRequest</span></strong><span class="koboSpan" id="kobo.190.1"> object as input and returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">HelloReply</span></strong><span class="koboSpan" id="kobo.192.1"> object as output. </span><span class="koboSpan" id="kobo.192.2">The implementation of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">SayHello()</span></strong><span class="koboSpan" id="kobo.194.1"> method is very simple – it matches the definition of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">SayHello()</span></strong><span class="koboSpan" id="kobo.196.1"> method in the </span><span class="No-Break"><span class="koboSpan" id="kobo.197.1">proto file.</span></span></p>
<p><span class="koboSpan" id="kobo.198.1">If you move your mouse over the </span><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">HelloRequest</span></strong><span class="koboSpan" id="kobo.200.1"> class in VS Code, you will see a pop-up message, which shows that the namespace of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">HelloRequest</span></strong><span class="koboSpan" id="kobo.202.1"> class is </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">GrpcDemo.HelloRequest</span></strong><span class="koboSpan" id="kobo.204.1">, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.205.1">Figure 11</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.206.1">.2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer086">
<span class="koboSpan" id="kobo.208.1"><img alt="Figure 11.2 – The namespace of the HelloRequest class" src="image/B18971_11_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.209.1">Figure 11.2 – The namespace of the HelloRequest class</span></p>
<p><span class="koboSpan" id="kobo.210.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">HelloReply</span></strong><span class="koboSpan" id="kobo.212.1"> class is </span><a id="_idIndexMarker1095"/><span class="koboSpan" id="kobo.213.1">also similar. </span><span class="koboSpan" id="kobo.213.2">However, you won’t be able to find the </span><strong class="source-inline"><span class="koboSpan" id="kobo.214.1">HelloRequest</span></strong><span class="koboSpan" id="kobo.215.1"> class and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">HelloReply</span></strong><span class="koboSpan" id="kobo.217.1"> class in the project. </span><span class="koboSpan" id="kobo.217.2">Where are these </span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">classes defined?</span></span></p>
<p><span class="koboSpan" id="kobo.219.1">You can press </span><em class="italic"><span class="koboSpan" id="kobo.220.1">F12</span></em><span class="koboSpan" id="kobo.221.1"> to go to the definition of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.222.1">HelloRequest</span></strong><span class="koboSpan" id="kobo.223.1"> class in VS Code. </span><span class="koboSpan" id="kobo.223.2">You will be navigated to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.224.1">Greet.cs</span></strong><span class="koboSpan" id="kobo.225.1"> file, which is located in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.226.1">obj\Debug\net8.0\Protos</span></strong><span class="koboSpan" id="kobo.227.1"> folder. </span><span class="koboSpan" id="kobo.227.2">This file is generated by the proto file and contains the definition of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.228.1">HelloRequest</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.229.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.230.1">
  #region Messages  /// &lt;summary&gt;
  /// The request message containing the user's name.
</span><span class="koboSpan" id="kobo.230.2">  /// &lt;/summary&gt;
  public sealed partial class HelloRequest : pb::IMessage&lt;HelloRequest&gt;
  {
    private static readonly pb::MessageParser&lt;HelloRequest&gt; _parser = new pb::MessageParser&lt;HelloRequest&gt;(() =&gt; new HelloRequest());
    // Omitted for brevity
    public HelloRequest() {
      OnConstruction();
    }
    // Omitted for brevity
    /// &lt;summary&gt;Field number for the "name" field.&lt;/summary&gt;
    public const int NameFieldNumber = 1;
    private string name_ = "";
    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]
    [global::System.CodeDom.Compiler.GeneratedCode("protoc", null)]
    public string Name {
      get { return name_; }
      set {
        name_ = pb::ProtoPreconditions.CheckNotNull(value, "value");
      }
    }
    // Omitted for brevity
  }</span></pre>
<p><span class="koboSpan" id="kobo.231.1">In the definition </span><a id="_idIndexMarker1096"/><span class="koboSpan" id="kobo.232.1">of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">HelloRequest</span></strong><span class="koboSpan" id="kobo.234.1"> class, you can see that it implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.235.1">IMessage&lt;HelloRequest&gt;</span></strong><span class="koboSpan" id="kobo.236.1"> interface, which is defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.237.1">Google.Protobuf</span></strong><span class="koboSpan" id="kobo.238.1"> package. </span><span class="koboSpan" id="kobo.238.2">All protobuf messages must implement this base interface. </span><span class="koboSpan" id="kobo.238.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.239.1">HelloRequest</span></strong><span class="koboSpan" id="kobo.240.1"> class also has a </span><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">Name</span></strong><span class="koboSpan" id="kobo.242.1"> property, which is defined in the proto file. </span><span class="koboSpan" id="kobo.242.2">You can find a </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">DebuggerNonUserCodeAttribute</span></strong><span class="koboSpan" id="kobo.244.1"> attribute on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">Name</span></strong><span class="koboSpan" id="kobo.246.1"> property. </span><span class="koboSpan" id="kobo.246.2">This attribute means that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">Name</span></strong><span class="koboSpan" id="kobo.248.1"> member is not part of the user code for an application. </span><span class="koboSpan" id="kobo.248.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">Name</span></strong><span class="koboSpan" id="kobo.250.1"> property also has a </span><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">GeneratedCode</span></strong><span class="koboSpan" id="kobo.252.1"> attribute, which means this member is generated by the tooling. </span><span class="koboSpan" id="kobo.252.2">Specifically, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">Name</span></strong><span class="koboSpan" id="kobo.254.1"> property is generated by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">protoc</span></strong><span class="koboSpan" id="kobo.256.1"> tool, which is the protobuf compiler. </span><span class="koboSpan" id="kobo.256.2">Users should not modify </span><span class="No-Break"><span class="koboSpan" id="kobo.257.1">this member.</span></span></p>
<p><span class="koboSpan" id="kobo.258.1">You can also </span><a id="_idIndexMarker1097"/><span class="koboSpan" id="kobo.259.1">find the definition of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">HelloReply</span></strong><span class="koboSpan" id="kobo.261.1"> class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">Greet.cs</span></strong><span class="koboSpan" id="kobo.263.1"> file. </span><span class="koboSpan" id="kobo.263.2">Next to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">Greet.cs</span></strong><span class="koboSpan" id="kobo.265.1"> file, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.266.1">Protos</span></strong><span class="koboSpan" id="kobo.267.1"> folder, you can find a </span><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">GreetGrpc.cs</span></strong><span class="koboSpan" id="kobo.269.1"> file, which defines the </span><strong class="source-inline"><span class="koboSpan" id="kobo.270.1">GreeterBase</span></strong><span class="koboSpan" id="kobo.271.1"> abstract class as the base class of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.272.1">GreeterService</span></strong><span class="koboSpan" id="kobo.273.1"> class. </span><span class="koboSpan" id="kobo.273.2">Similarly, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.274.1">GreeterBase</span></strong><span class="koboSpan" id="kobo.275.1"> class is also generated by the gRPC tooling. </span><span class="koboSpan" id="kobo.275.2">It contains the definition of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.276.1">SayHello()</span></strong><span class="koboSpan" id="kobo.277.1"> method, </span><span class="No-Break"><span class="koboSpan" id="kobo.278.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.279.1">
/// &lt;summary&gt;Base class for server-side implementations of Greeter&lt;/summary&gt;[grpc::BindServiceMethod(typeof(Greeter), "BindService")]
public abstract partial class GreeterBase
{
  /// &lt;summary&gt;
  /// Sends a greeting
  /// &lt;/summary&gt;
  /// &lt;param name="request"&gt;The request received from the client.&lt;/param&gt;
  /// &lt;param name="context"&gt;The context of the server-side call handler being invoked.&lt;/param&gt;
  /// &lt;returns&gt;The response to send back to the client (wrapped by a task).&lt;/returns&gt;
  [global::System.CodeDom.Compiler.GeneratedCode("grpc_csharp_plugin", null)]
  public virtual global::System.Threading.Tasks.Task&lt;global::GrpcDemo.HelloReply&gt; SayHello(global::GrpcDemo.HelloRequest request, grpc::ServerCallContext context)
  {
    throw new grpc::RpcException(new grpc::Status(grpc::StatusCode.Unimplemented, ""));
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.280.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.281.1">GreeterBase</span></strong><span class="koboSpan" id="kobo.282.1"> class </span><a id="_idIndexMarker1098"/><span class="koboSpan" id="kobo.283.1">is marked with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">BindServiceMethod</span></strong><span class="koboSpan" id="kobo.285.1"> attribute, which means this method is the implementation of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">SayHello()</span></strong><span class="koboSpan" id="kobo.287.1"> method defined in the proto file. </span><span class="koboSpan" id="kobo.287.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">SayHello()</span></strong><span class="koboSpan" id="kobo.289.1"> method has an attribute called </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">GeneratedCode</span></strong><span class="koboSpan" id="kobo.291.1"> that indicates that this class is generated by the gRPC C# plugin. </span><span class="koboSpan" id="kobo.291.2">Inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.292.1">SayHello()</span></strong><span class="koboSpan" id="kobo.293.1"> method, you can see that it throws an exception by default. </span><span class="koboSpan" id="kobo.293.2">Because this method is </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">virtual</span></strong><span class="koboSpan" id="kobo.295.1">, we need to override this method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">GreeterService</span></strong><span class="koboSpan" id="kobo.297.1"> class to provide the </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">actual implementation.</span></span></p>
<p><span class="koboSpan" id="kobo.299.1">Next, let’s check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">Program.cs</span></strong><span class="koboSpan" id="kobo.301.1"> file. </span><span class="koboSpan" id="kobo.301.2">You will find the following code in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">Program.cs</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.303.1"> file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.304.1">
var builder = WebApplication.CreateBuilder(args);// Add services to the container.
</span><span class="koboSpan" id="kobo.304.2">builder.Services.AddGrpc();
var app = builder.Build();
// Configure the HTTP request pipeline.
</span><span class="koboSpan" id="kobo.304.3">app.MapGrpcService&lt;GreeterService&gt;();</span></pre>
<p><span class="koboSpan" id="kobo.305.1">In the preceding code block, we can see that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.306.1">AddGrpc()</span></strong><span class="koboSpan" id="kobo.307.1"> method is called to add gRPC services to the service container. </span><span class="koboSpan" id="kobo.307.2">Then, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">MapGrpcService&lt;GreeterService&gt;()</span></strong><span class="koboSpan" id="kobo.309.1"> method to map the </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">GreeterService</span></strong><span class="koboSpan" id="kobo.311.1"> class to the gRPC service, which is similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">MapControllers</span></strong><span class="koboSpan" id="kobo.313.1"> method in the RESTful </span><span class="No-Break"><span class="koboSpan" id="kobo.314.1">API project.</span></span></p>
<p><span class="koboSpan" id="kobo.315.1">There is another line of code in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.316.1">Program.cs</span></strong><span class="koboSpan" id="kobo.317.1"> file that uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">MapGet()</span></strong><span class="koboSpan" id="kobo.319.1"> method to show a message if users access the root path of the application from a </span><span class="No-Break"><span class="koboSpan" id="kobo.320.1">web browser:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.321.1">
app.MapGet("/", () =&gt; "Communication with gRPC endpoints must be made through a gRPC client. </span><span class="koboSpan" id="kobo.321.2">To learn how to create a client, visit: https://go.microsoft.com/fwlink/?linkid=2086909");</span></pre> <p><span class="koboSpan" id="kobo.322.1">This is because gRPC services cannot be accessed by a web browser. </span><span class="koboSpan" id="kobo.322.2">So, we need to show a message to notify users that they need to use a gRPC client to access the </span><span class="No-Break"><span class="koboSpan" id="kobo.323.1">gRPC service.</span></span></p>
<p><span class="koboSpan" id="kobo.324.1">Let’s update </span><a id="_idIndexMarker1099"/><span class="koboSpan" id="kobo.325.1">the proto file and see what happens. </span><span class="koboSpan" id="kobo.325.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.326.1">greet.proto</span></strong><span class="koboSpan" id="kobo.327.1"> file and update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">HelloRequest</span></strong><span class="koboSpan" id="kobo.329.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.330.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.331.1">
message HelloRequest {  string name = 1;
  string address = 2;
}</span></pre>
<p><span class="koboSpan" id="kobo.332.1">Save the file and go back to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">GreeterService</span></strong><span class="koboSpan" id="kobo.334.1"> class. </span><span class="koboSpan" id="kobo.334.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.335.1">SayHello()</span></strong><span class="koboSpan" id="kobo.336.1"> method, you can try to access the </span><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">Address</span></strong><span class="koboSpan" id="kobo.338.1"> property of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">HelloRequest</span></strong><span class="koboSpan" id="kobo.340.1"> object. </span><span class="koboSpan" id="kobo.340.2">You will find that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">Address</span></strong><span class="koboSpan" id="kobo.342.1"> property is not available. </span><span class="koboSpan" id="kobo.342.2">This is because the generated code is not updated. </span><span class="koboSpan" id="kobo.342.3">We need to regenerate the code by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.343.1">dotnet build</span></strong><span class="koboSpan" id="kobo.344.1"> command. </span><span class="koboSpan" id="kobo.344.2">Alternatively, you can delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">obj</span></strong><span class="koboSpan" id="kobo.346.1"> folder and the code will be </span><span class="No-Break"><span class="koboSpan" id="kobo.347.1">regenerated automatically.</span></span></p>
<p><span class="koboSpan" id="kobo.348.1">You may find that it is not convenient to store the generated code in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.349.1">obj</span></strong><span class="koboSpan" id="kobo.350.1"> folder. </span><span class="koboSpan" id="kobo.350.2">We can change the output directory of the generated code by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">OutputDir</span></strong><span class="koboSpan" id="kobo.352.1"> attribute in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">Protobuf</span></strong><span class="koboSpan" id="kobo.354.1"> item in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">.csproj</span></strong><span class="koboSpan" id="kobo.356.1"> file. </span><span class="koboSpan" id="kobo.356.2">For example, you can change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">Protobuf</span></strong><span class="koboSpan" id="kobo.358.1"> item </span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.360.1">
&lt;ItemGroup&gt;  &lt;Protobuf Include="Protos\greet.proto" GrpcServices="Server" OutputDir="Generated" /&gt;
&lt;/ItemGroup&gt;</span></pre>
<p><span class="koboSpan" id="kobo.361.1">Now, the generated code will be stored in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">Generated\Protos</span></strong><span class="koboSpan" id="kobo.363.1"> folder. </span><span class="koboSpan" id="kobo.363.2">A proto file can generate multiple files for server-side code. </span><span class="koboSpan" id="kobo.363.3">For example, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">greet.proto</span></strong><span class="koboSpan" id="kobo.365.1"> file will generate the </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">following files:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.367.1">greet.cs</span></strong><span class="koboSpan" id="kobo.368.1">: This file contains the definition of the messages and the methods to serialize and deserialize </span><span class="No-Break"><span class="koboSpan" id="kobo.369.1">the messages</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">greetGrpc.cs</span></strong><span class="koboSpan" id="kobo.371.1">: This file contains the definition of the base class of the service and the methods to bind the service to </span><span class="No-Break"><span class="koboSpan" id="kobo.372.1">the server</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.373.1">Now that we</span><a id="_idIndexMarker1100"/><span class="koboSpan" id="kobo.374.1"> understand the structure of the gRPC project, let’s learn the concepts behind protobuf  </span><span class="No-Break"><span class="koboSpan" id="kobo.375.1">messages.</span></span></p>
<h1 id="_idParaDest-236"><a id="_idTextAnchor448"/><span class="koboSpan" id="kobo.376.1">Creating protobuf messages</span></h1>
<p><span class="koboSpan" id="kobo.377.1">In this </span><a id="_idIndexMarker1101"/><span class="koboSpan" id="kobo.378.1">section, we will learn how to create protobuf messages. </span><span class="koboSpan" id="kobo.378.2">We will introduce the concepts of protobuf messages and how to define them in a </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">proto file.</span></span></p>
<p><span class="koboSpan" id="kobo.380.1">gRPC is a contract-first framework, meaning that the gRPC service and messages must be defined in a proto file. </span><span class="koboSpan" id="kobo.380.2">When we talk about messages, we are talking about the data that is sent between the client and the server. </span><span class="koboSpan" id="kobo.380.3">While gRPC messages may be similar to the data model in RESTful APIs, they are not the same. </span><span class="koboSpan" id="kobo.380.4">RESTful APIs are centered around resources, and the data model is usually a resource model that can be mapped to one or multiple database tables. </span><span class="koboSpan" id="kobo.380.5">In contrast, gRPC is action-based, and the message can be any other type of data model or other message sent between the client and the server. </span><span class="koboSpan" id="kobo.380.6">Therefore, gRPC messages may not be exactly mapped to a resource model in </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">RESTful APIs.</span></span></p>
<p><span class="koboSpan" id="kobo.382.1">For example, when creating an invoice through a RESTful API using JSON as the data format, we need to send an HTTP POST request with a JSON body to the server. </span><span class="koboSpan" id="kobo.382.2">The JSON body will be deserialized into a .NET object, which serves as the data model for the invoice. </span><span class="koboSpan" id="kobo.382.3">To retrieve an invoice, we need to send an HTTP GET request to the server and the server. </span><span class="koboSpan" id="kobo.382.4">The server will serialize the data model into a JSON string and send it back to the client. </span><span class="koboSpan" id="kobo.382.5">We may also have other actions, such as updating an invoice, deleting an invoice, and so on. </span><span class="koboSpan" id="kobo.382.6">All these actions are mapped to </span><span class="No-Break"><span class="koboSpan" id="kobo.383.1">HTTP methods.</span></span></p>
<p><span class="koboSpan" id="kobo.384.1">To implement the same functionality using gRPC, we need to define a gRPC service with several methods: </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">CreateInvoice()</span></strong><span class="koboSpan" id="kobo.386.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">GetInvoice()</span></strong><span class="koboSpan" id="kobo.388.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">UpdateInvoice()</span></strong><span class="koboSpan" id="kobo.390.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">DeleteInvoice()</span></strong><span class="koboSpan" id="kobo.392.1">, and others. </span><span class="koboSpan" id="kobo.392.2">For each of these methods, we must also define the corresponding request and response messages. </span><span class="koboSpan" id="kobo.392.3">For example, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.393.1">CreateInvoice()</span></strong><span class="koboSpan" id="kobo.394.1"> method requires a </span><strong class="source-inline"><span class="koboSpan" id="kobo.395.1">CreateInvoiceRequest</span></strong><span class="koboSpan" id="kobo.396.1"> message containing the properties of the invoice, as well as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.397.1">CreateInvoiceResponse</span></strong><span class="koboSpan" id="kobo.398.1"> message containing the ID of the created invoice. </span><span class="koboSpan" id="kobo.398.2">It is important to note that the request and response messages are distinct from the data model of the invoice, which is used to represent the invoice entity in the system. </span><span class="koboSpan" id="kobo.398.3">The request and response messages are used to send data between the client and </span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">the server.</span></span></p>
<p><span class="koboSpan" id="kobo.400.1">Note that </span><a id="_idIndexMarker1102"/><span class="koboSpan" id="kobo.401.1">gRPC and protobuf are not the same thing. </span><span class="koboSpan" id="kobo.401.2">protobuf is a language-neutral, platform-neutral data serialization format. </span><span class="koboSpan" id="kobo.401.3">gRPC is a framework that uses protobuf as the default data serialization format. </span><span class="koboSpan" id="kobo.401.4">Sometimes, these two terms are used interchangeably, but we should know the difference </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">between them.</span></span></p>
<p><span class="koboSpan" id="kobo.403.1">Think about the invoice example we mentioned previously. </span><span class="koboSpan" id="kobo.403.2">An invoice has several properties, such as the invoice number, the invoice date, the customer’s name, the total amount, and so on. </span><span class="koboSpan" id="kobo.403.3">A customer has a name and an address. </span><span class="koboSpan" id="kobo.403.4">An address has some properties, such as street, city, state, and </span><span class="No-Break"><span class="koboSpan" id="kobo.404.1">so on.</span></span></p>
<p><span class="koboSpan" id="kobo.405.1">Next, we’ll define the first message that is used to create an address for the invoice service. </span><span class="koboSpan" id="kobo.405.2">The source code for this section can be found in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">chapter11/GrpcDemo-v2</span></strong><span class="koboSpan" id="kobo.407.1"> folder. </span><span class="koboSpan" id="kobo.407.2">We will start with a simple message and then introduce more concepts regarding protobuf messages, including field numbers, field types, and how to use other .NET types in protobuf messages. </span><span class="koboSpan" id="kobo.407.3">We will also learn how to implement list and dictionary types using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">repeated</span></strong><span class="koboSpan" id="kobo.409.1"> an</span><a id="_idTextAnchor449"/><span class="koboSpan" id="kobo.410.1">d </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">map</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.412.1"> keywords.</span></span></p>
<h2 id="_idParaDest-237"><a id="_idTextAnchor450"/><span class="koboSpan" id="kobo.413.1">Defining a protobuf message</span></h2>
<p><span class="koboSpan" id="kobo.414.1">Create a </span><a id="_idIndexMarker1103"/><span class="koboSpan" id="kobo.415.1">new </span><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">invoice.proto</span></strong><span class="koboSpan" id="kobo.417.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">Protos</span></strong><span class="koboSpan" id="kobo.419.1"> folder. </span><span class="koboSpan" id="kobo.419.2">VS Code provides a proto file template when you create a new file, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.420.1">Figure 11</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.421.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.422.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer087">
<span class="koboSpan" id="kobo.423.1"><img alt="Figure 11.3 – The proto file template in VS Code" src="image/B18971_11_3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.424.1">Figure 11.3 – The proto file template in VS Code</span></p>
<p><span class="koboSpan" id="kobo.425.1">The proto file</span><a id="_idIndexMarker1104"/><span class="koboSpan" id="kobo.426.1"> template creates a proto file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">Protos.proto</span></strong><span class="koboSpan" id="kobo.428.1">. </span><span class="koboSpan" id="kobo.428.2">Rename it </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">invoice.proto</span></strong><span class="koboSpan" id="kobo.430.1">. </span><span class="koboSpan" id="kobo.430.2">The content of the proto file is </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.432.1">
syntax = "proto3";option csharp_namespace = "MyApp.Namespace";</span></pre>
<p><span class="koboSpan" id="kobo.433.1">A proto file is a text file with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">.proto</span></strong><span class="koboSpan" id="kobo.435.1"> extension. </span><span class="koboSpan" id="kobo.435.2">The first line of the proto file specifies the syntax version of the proto file. </span><span class="koboSpan" id="kobo.435.3">At the time of writing, the latest version of the proto file is version 3, which was released in 2016. </span><span class="koboSpan" id="kobo.435.4">You can find more information about the proto file syntax </span><span class="No-Break"><span class="koboSpan" id="kobo.436.1">at </span></span><a href="https://protobuf.dev/programming-guides/proto3/"><span class="No-Break"><span class="koboSpan" id="kobo.437.1">https://protobuf.dev/programming-guides/proto3/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.438.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.439.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.440.1">option csharp_namespace</span></strong><span class="koboSpan" id="kobo.441.1"> line specifies the namespace of the generated code in C#. </span><span class="koboSpan" id="kobo.441.2">You can change the namespace according to your needs. </span><span class="koboSpan" id="kobo.441.3">This option is used to avoid naming conflicts between different proto files. </span><span class="koboSpan" id="kobo.441.4">Note that even though a proto file is language-neutral, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">option csharp_namespace</span></strong><span class="koboSpan" id="kobo.443.1"> attribute is only used by the C# code generator. </span><span class="koboSpan" id="kobo.443.2">In this sample project, we can change the namespace to </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">GrpcDemo</span></strong><span class="koboSpan" id="kobo.445.1"> to match the namespace of the </span><span class="No-Break"><span class="koboSpan" id="kobo.446.1">existing code.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.447.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.448.1">Protobuf supports a </span><strong class="source-inline"><span class="koboSpan" id="kobo.449.1">package</span></strong><span class="koboSpan" id="kobo.450.1"> keyword to avoid naming conflicts, depending on the language. </span><span class="koboSpan" id="kobo.450.2">For example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.451.1">package com.company</span></strong><span class="koboSpan" id="kobo.452.1"> is equivalent to </span><strong class="source-inline"><span class="koboSpan" id="kobo.453.1">option csharp_namespace = "Com.Company"</span></strong><span class="koboSpan" id="kobo.454.1"> in C# (the name will be converted into PascalCase), and </span><strong class="source-inline"><span class="koboSpan" id="kobo.455.1">package com.company</span></strong><span class="koboSpan" id="kobo.456.1"> is equivalent to </span><strong class="source-inline"><span class="koboSpan" id="kobo.457.1">option java_package = "com.company"</span></strong><span class="koboSpan" id="kobo.458.1"> in Java. </span><span class="koboSpan" id="kobo.458.2">However, </span><strong class="source-inline"><span class="koboSpan" id="kobo.459.1">package com.company</span></strong><span class="koboSpan" id="kobo.460.1"> will be ignored in Python since Python modules are organized by </span><span class="No-Break"><span class="koboSpan" id="kobo.461.1">filesystem directories.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.462.1">Since we are using C#, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">option csharp_namespace</span></strong><span class="koboSpan" id="kobo.464.1"> attribute, which can override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.465.1">package</span></strong><span class="koboSpan" id="kobo.466.1"> keyword for C# applications. </span><span class="koboSpan" id="kobo.466.2">If you share the proto file with other applications that use other languages, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.467.1">package</span></strong><span class="koboSpan" id="kobo.468.1"> keyword or the language-specific option to avoid </span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">naming conflicts.</span></span></p>
<p><span class="koboSpan" id="kobo.470.1">Once the proto file has</span><a id="_idIndexMarker1105"/><span class="koboSpan" id="kobo.471.1"> been created, we need to add it to the project file. </span><span class="koboSpan" id="kobo.471.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.472.1">GrpcDemo.csproj</span></strong><span class="koboSpan" id="kobo.473.1"> file and add the following code to an </span><strong class="source-inline"><span class="koboSpan" id="kobo.474.1">&lt;</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">ItemGroup&gt;</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.476.1"> element:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.477.1">
&lt;Protobuf Include="Protos\invoice.proto" GrpcServices="Server"  OutputDir="Generated"/&gt;</span></pre> <p><span class="koboSpan" id="kobo.478.1">Now, the gRPC tooling will generate the code for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">invoice.proto</span></strong><span class="koboSpan" id="kobo.480.1"> file when we build </span><span class="No-Break"><span class="koboSpan" id="kobo.481.1">the project.</span></span></p>
<p><span class="koboSpan" id="kobo.482.1">gRPC proto3 uses similar concepts as .NET classes to define messages. </span><span class="koboSpan" id="kobo.482.2">However, there are some differences. </span><span class="koboSpan" id="kobo.482.3">For example, proto3 does not support </span><strong class="source-inline"><span class="koboSpan" id="kobo.483.1">GUID</span></strong><span class="koboSpan" id="kobo.484.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">decimal</span></strong><span class="koboSpan" id="kobo.486.1"> types. </span><span class="koboSpan" id="kobo.486.2">Let’s start with a simple message. </span><span class="koboSpan" id="kobo.486.3">We can define an </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">Address</span></strong><span class="koboSpan" id="kobo.488.1"> message </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.490.1">
message CreateAddressRequest {  string street = 1;
  string city = 2;
  string state = 3;
  string zip_code = 4;
  string country = 5;
}</span></pre>
<p><span class="koboSpan" id="kobo.491.1">As we can see, it is similar to a .NET class. </span><span class="koboSpan" id="kobo.491.2">We use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.492.1">message</span></strong><span class="koboSpan" id="kobo.493.1"> keyword to define a gRPC message. </span><span class="koboSpan" id="kobo.493.2">In the message body, we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.494.1">string</span></strong><span class="koboSpan" id="kobo.495.1"> to declare a string field. </span><span class="koboSpan" id="kobo.495.2">However, there are some</span><a id="_idIndexMarker1106"/><span class="koboSpan" id="kobo.496.1"> questions to </span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">answer here:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.498.1">Why do we assign a number to each property? </span><span class="koboSpan" id="kobo.498.2">Is it the </span><span class="No-Break"><span class="koboSpan" id="kobo.499.1">default value?</span></span></li>
<li><span class="koboSpan" id="kobo.500.1">Why does the number start with 1? </span><span class="koboSpan" id="kobo.500.2">Can we </span><span class="No-Break"><span class="koboSpan" id="kobo.501.1">use 0?</span></span></li>
<li><span class="koboSpan" id="kobo.502.1">Should we use these numbers in a </span><span class="No-Break"><span class="koboSpan" id="kobo.503.1">specific order?</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.504.1">Let’s answer these questions b</span><a id="_idTextAnchor451"/><span class="koboSpan" id="kobo.505.1">efore we </span><span class="No-Break"><span class="koboSpan" id="kobo.506.1">move on.</span></span></p>
<h2 id="_idParaDest-238"><a id="_idTextAnchor452"/><span class="koboSpan" id="kobo.507.1">Understanding field numbers</span></h2>
<p><span class="koboSpan" id="kobo.508.1">The</span><a id="_idIndexMarker1107"/><span class="koboSpan" id="kobo.509.1"> numbers following the field names are called </span><em class="italic"><span class="koboSpan" id="kobo.510.1">field numbers</span></em><span class="koboSpan" id="kobo.511.1">. </span><span class="koboSpan" id="kobo.511.2">Field numbers play an important role in the proto file. </span><span class="koboSpan" id="kobo.511.3">These field numbers are used to identify the fields in the message. </span><span class="koboSpan" id="kobo.511.4">What is the benefit of using field numbers instead of field names? </span><span class="koboSpan" id="kobo.511.5">Let’s look at an example of an </span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">XML document:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.513.1">
&lt;address&gt;  &lt;street&gt;1 Fake Street&lt;/street&gt;
  &lt;city&gt;Wellington&lt;/city&gt;
  &lt;state&gt;Wellington&lt;/state&gt;
  &lt;zip_code&gt;6011&lt;/zip_code&gt;
  &lt;country&gt;New Zealand&lt;/country&gt;
&lt;/address&gt;</span></pre>
<p><span class="koboSpan" id="kobo.514.1">In the preceding XML document, each field is wrapped in a tag. </span><span class="koboSpan" id="kobo.514.2">We have to open and close the tags to wrap the values of the fields. </span><span class="koboSpan" id="kobo.514.3">The XML syntax wastes a lot of space when transferring data. </span><span class="koboSpan" id="kobo.514.4">Consider the following example of a </span><span class="No-Break"><span class="koboSpan" id="kobo.515.1">JSON document:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.516.1">
{  "street": "1 Fake Street",
  "city": "Wellington",
  "state": "Wellington",
  "zip_code": "6011",
  "country": "New Zealand"
}</span></pre>
<p><span class="koboSpan" id="kobo.517.1">In the</span><a id="_idIndexMarker1108"/><span class="koboSpan" id="kobo.518.1"> preceding JSON document, we just use each field name once. </span><span class="koboSpan" id="kobo.518.2">Normally, JSON format is more compact than XML format. </span><span class="koboSpan" id="kobo.518.3">What if we get rid of the field names? </span><span class="koboSpan" id="kobo.518.4">That is why we use field numbers in the proto file. </span><span class="koboSpan" id="kobo.518.5">By using field numbers instead of field names when encoding the message, we can make the gRPC message more compact. </span><span class="koboSpan" id="kobo.518.6">This is because numbers are shorter than field names. </span><span class="koboSpan" id="kobo.518.7">Additionally, protobuf uses a binary format, which is more compact than plain text formats such as JSON and XML. </span><span class="koboSpan" id="kobo.518.8">This further helps reduce the size of </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">the message.</span></span></p>
<p><span class="koboSpan" id="kobo.520.1">There are a few things to note about field numbers according to the </span><span class="No-Break"><span class="koboSpan" id="kobo.521.1">protobuf documentation:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.522.1">The range of field numbers is from </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">1</span></strong><span class="koboSpan" id="kobo.524.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">536,870,911</span></strong><span class="koboSpan" id="kobo.526.1">. </span><span class="koboSpan" id="kobo.526.2">So we cannot use </span><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">0</span></strong><span class="koboSpan" id="kobo.528.1"> as a </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">field number.</span></span></li>
<li><span class="koboSpan" id="kobo.530.1">The field numbers must be unique within </span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">a message.</span></span></li>
<li><span class="koboSpan" id="kobo.532.1">Field numbers </span><strong class="source-inline"><span class="koboSpan" id="kobo.533.1">19000</span></strong><span class="koboSpan" id="kobo.534.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">19999</span></strong><span class="koboSpan" id="kobo.536.1"> are reserved for protobuf, so you cannot </span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">use them.</span></span></li>
<li><span class="koboSpan" id="kobo.538.1">Technically, the order of the field numbers does not matter. </span><span class="koboSpan" id="kobo.538.2">It is recommended to use the ascending order of the field numbers. </span><span class="koboSpan" id="kobo.538.3">Smaller field numbers use fewer bytes to encode. </span><span class="koboSpan" id="kobo.538.4">For example, a field number between </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">1</span></strong><span class="koboSpan" id="kobo.540.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">15</span></strong><span class="koboSpan" id="kobo.542.1"> uses only one byte to encode, but numbers from </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">16</span></strong><span class="koboSpan" id="kobo.544.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.545.1">2047</span></strong><span class="koboSpan" id="kobo.546.1"> use </span><span class="No-Break"><span class="koboSpan" id="kobo.547.1">two bytes.</span></span></li>
<li><span class="koboSpan" id="kobo.548.1">Once a field number is assigned to a field, it cannot be changed if the proto file is used in production. </span><span class="koboSpan" id="kobo.548.2">Changing a field number will break the backward compatibility of the </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">proto file.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.550.1">With that, we have learned what field numbers are and why we use them. </span><span class="koboSpan" id="kobo.550.2">Next, let’s unde</span><a id="_idTextAnchor453"/><span class="koboSpan" id="kobo.551.1">rstand </span><span class="No-Break"><span class="koboSpan" id="kobo.552.1">field types.</span></span></p>
<h2 id="_idParaDest-239"><a id="_idTextAnchor454"/><span class="koboSpan" id="kobo.553.1">Understanding the field types</span></h2>
<p><span class="koboSpan" id="kobo.554.1">Similar to .NET classes, a gRPC </span><a id="_idIndexMarker1109"/><span class="koboSpan" id="kobo.555.1">message can have different types of fields. </span><span class="koboSpan" id="kobo.555.2">protobuf provides a set of native types, which are called </span><strong class="bold"><span class="koboSpan" id="kobo.556.1">scalar value types</span></strong><span class="koboSpan" id="kobo.557.1">. </span><span class="koboSpan" id="kobo.557.2">These </span><a id="_idIndexMarker1110"/><span class="koboSpan" id="kobo.558.1">scalar value types have representations in most programming</span><a id="_idIndexMarker1111"/><span class="koboSpan" id="kobo.559.1"> languages. </span><span class="koboSpan" id="kobo.559.2">The following table lists the mapping between protobuf scalar value types and .</span><span class="No-Break"><span class="koboSpan" id="kobo.560.1">NET types:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-8">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<thead>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.561.1">Protobuf Type</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold"><span class="koboSpan" id="kobo.562.1">.</span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.563.1">NET Type</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.564.1">Notes</span></strong></span></p>
</td>
</tr>
</thead>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">double</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.566.1">double</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.567.1">±5.0 × 10</span><span class="superscript"><span class="koboSpan" id="kobo.568.1">−324</span></span><span class="koboSpan" id="kobo.569.1"> to ±1.7 × </span><span class="No-Break"><span class="koboSpan" id="kobo.570.1">10</span></span><span class="No-Break"><span class="superscript"><span class="koboSpan" id="kobo.571.1">308</span></span></span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">float</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">float</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.575.1">±1.5 x 10</span><span class="superscript"><span class="koboSpan" id="kobo.576.1">−45</span></span><span class="koboSpan" id="kobo.577.1"> to ±3.4 </span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">x 10</span></span><span class="No-Break"><span class="superscript"><span class="koboSpan" id="kobo.579.1">38</span></span></span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">int32</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.582.1">int</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.583.1">The length is variable. </span><span class="koboSpan" id="kobo.583.2">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">sint32</span></strong><span class="koboSpan" id="kobo.585.1"> if the field has </span><span class="No-Break"><span class="koboSpan" id="kobo.586.1">negative numbers.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">int64</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.588.1">long</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.589.1">The length is variable. </span><span class="koboSpan" id="kobo.589.2">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.590.1">sint64</span></strong><span class="koboSpan" id="kobo.591.1"> if the field has </span><span class="No-Break"><span class="koboSpan" id="kobo.592.1">negative numbers.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.593.1">uint32</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">uint</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.595.1">The length is variable. </span><span class="koboSpan" id="kobo.595.2">Unsigned integer. </span><span class="koboSpan" id="kobo.595.3">0 </span><span class="No-Break"><span class="koboSpan" id="kobo.596.1">to</span></span><span class="No-Break"> </span><span class="No-Break"><span class="koboSpan" id="kobo.597.1">(2</span></span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">32</span></span><span class="No-Break"><span class="koboSpan" id="kobo.599.1">-1).</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">uint64</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.601.1">ulong</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.602.1">The length is variable. </span><span class="koboSpan" id="kobo.602.2">Unsigned integer. </span><span class="koboSpan" id="kobo.602.3">0 </span><span class="No-Break"><span class="koboSpan" id="kobo.603.1">to (2</span></span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">64</span></span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">-1).</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">sint32</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.607.1">int</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.608.1">The length is variable. </span><span class="koboSpan" id="kobo.608.2">Signed integer. </span><span class="koboSpan" id="kobo.608.3">-231 </span><span class="No-Break"><span class="koboSpan" id="kobo.609.1">to (2</span></span><span class="No-Break"><span class="koboSpan" id="kobo.610.1">31</span></span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">-1).</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.612.1">sint64</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.613.1">long</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.614.1">The length is variable. </span><span class="koboSpan" id="kobo.614.2">Signed integer. </span><span class="koboSpan" id="kobo.614.3">-263 </span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">to (2</span></span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">63</span></span><span class="No-Break"><span class="koboSpan" id="kobo.617.1">-1).</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.618.1">fixed32</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.619.1">uint</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.620.1">The length is always 4 bytes. </span><span class="koboSpan" id="kobo.620.2">This type is more efficient than </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">uint32</span></strong><span class="koboSpan" id="kobo.622.1"> for serializing or deserializing values that are greater </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">than 2</span></span><span class="No-Break"><span class="superscript"><span class="koboSpan" id="kobo.624.1">28</span></span></span><span class="No-Break"><span class="koboSpan" id="kobo.625.1">.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.626.1">fixed64</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.627.1">ulong</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.628.1">The length is always 8 bytes. </span><span class="koboSpan" id="kobo.628.2">This type is more efficient than </span><strong class="source-inline"><span class="koboSpan" id="kobo.629.1">uint64</span></strong><span class="koboSpan" id="kobo.630.1"> for serializing or deserializing values that are greater </span><span class="No-Break"><span class="koboSpan" id="kobo.631.1">than 2</span></span><span class="No-Break"><span class="superscript"><span class="koboSpan" id="kobo.632.1">56</span></span></span><span class="No-Break"><span class="koboSpan" id="kobo.633.1">.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.634.1">sfixed32</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.635.1">int</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.636.1">The length is always </span><span class="No-Break"><span class="koboSpan" id="kobo.637.1">4 bytes.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.638.1">sfixed64</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.639.1">long</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.640.1">The length is always </span><span class="No-Break"><span class="koboSpan" id="kobo.641.1">8 bytes.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.642.1">bool</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.643.1">bool</span></strong></span></p>
</td>
<td class="No-Table-Style"/>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.644.1">string</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.645.1">string</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.646.1">A </span><strong class="source-inline"><span class="koboSpan" id="kobo.647.1">string</span></strong><span class="koboSpan" id="kobo.648.1"> field must be encoded in UTF-8 or 7-bit ASCII. </span><span class="koboSpan" id="kobo.648.2">The maximum length of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.649.1">string</span></strong><span class="koboSpan" id="kobo.650.1"> field </span><span class="No-Break"><span class="koboSpan" id="kobo.651.1">is 2</span></span><span class="No-Break"><span class="superscript"><span class="koboSpan" id="kobo.652.1">32</span></span></span><span class="No-Break"><span class="koboSpan" id="kobo.653.1">.</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">bytes</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.655.1">ByteString</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.656.1">This type is defined in protobuf runtime. </span><span class="koboSpan" id="kobo.656.2">It can be mapped to and from C#’s </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.657.1">byte[]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.658.1"> type.</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.659.1">Table 11.1 – Protobuf scalar value types and .NET types</span></p>
<p><span class="koboSpan" id="kobo.660.1">Let’s create a new </span><a id="_idIndexMarker1112"/><span class="koboSpan" id="kobo.661.1">message </span><a id="_idIndexMarker1113"/><span class="koboSpan" id="kobo.662.1">named </span><strong class="source-inline"><span class="koboSpan" id="kobo.663.1">CreateContactRequest</span></strong><span class="koboSpan" id="kobo.664.1"> and add some fields </span><span class="No-Break"><span class="koboSpan" id="kobo.665.1">to it:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.666.1">
message CreateContactRequest {  string first_name = 1;
  string last_name = 2;
  string email = 3;
  string phone = 4;
  int32 year_of_birth = 5;
  bool is_active = 6;
}</span></pre>
<p><span class="koboSpan" id="kobo.667.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.668.1">CreateContactRequest</span></strong><span class="koboSpan" id="kobo.669.1"> message requires the </span><strong class="source-inline"><span class="koboSpan" id="kobo.670.1">first_name</span></strong><span class="koboSpan" id="kobo.671.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">last_name</span></strong><span class="koboSpan" id="kobo.673.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.674.1">email</span></strong><span class="koboSpan" id="kobo.675.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.676.1">phone</span></strong><span class="koboSpan" id="kobo.677.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.678.1">year_of_birth</span></strong><span class="koboSpan" id="kobo.679.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.680.1">is_active</span></strong><span class="koboSpan" id="kobo.681.1"> fields. </span><span class="koboSpan" id="kobo.681.2">The types for these fields are </span><strong class="source-inline"><span class="koboSpan" id="kobo.682.1">string</span></strong><span class="koboSpan" id="kobo.683.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.684.1">int32</span></strong><span class="koboSpan" id="kobo.685.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.686.1">bool</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.687.1">, respectively.</span></span></p>
<p><span class="koboSpan" id="kobo.688.1">Next, we</span><a id="_idIndexMarker1114"/><span class="koboSpan" id="kobo.689.1"> can run </span><strong class="source-inline"><span class="koboSpan" id="kobo.690.1">dotnet build</span></strong><span class="koboSpan" id="kobo.691.1"> to generate the code. </span><span class="koboSpan" id="kobo.691.2">Alternatively, you can delete the existing files in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.692.1">Generated</span></strong><span class="koboSpan" id="kobo.693.1"> folder and gRPC tooling will regenerate the code automatically based on the </span><span class="No-Break"><span class="koboSpan" id="kobo.694.1">proto files.</span></span></p>
<p><span class="koboSpan" id="kobo.695.1">The generated code files contain some complicated code. </span><span class="koboSpan" id="kobo.695.2">However, we can find the definition of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.696.1">CreateContactRequest</span></strong><span class="koboSpan" id="kobo.697.1"> class, which is </span><span class="No-Break"><span class="koboSpan" id="kobo.698.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.699.1">
public sealed partial class CreateContactRequest : pb::IMessage&lt;CreateContactRequest&gt;{
    private string firstName_ = "";
    public string FirstName {
      get { return firstName_; }
      set {
        firstName_ = pb::ProtoPreconditions.CheckNotNull(value, "value");
      }
    }
    private string lastName_ = "";
    public string LastName {
      get { return lastName_; }
      set {
        lastName_ = pb::ProtoPreconditions.CheckNotNull(value, "value");
      }
    }
    private string email_ = "";
    public string Email {
      get { return email_; }
      set {
        email_ = pb::ProtoPreconditions.CheckNotNull(value, "value");
      }
    }
    private string phone_ = "";
    public string Phone {
      get { return phone_; }
      set {
        phone_ = pb::ProtoPreconditions.CheckNotNull(value, "value");
      }
    }
    private int yearOfBirth_;
    public int YearOfBirth {
      get { return yearOfBirth_; }
      set {
        yearOfBirth_ = value;
      }
    }
    private bool isActive_;
    public bool IsActive {
      get { return isActive_; }
      set {
        isActive_ = value;
      }
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.700.1">In the preceding </span><a id="_idIndexMarker1115"/><span class="koboSpan" id="kobo.701.1">code block, some code has been omitted for brevity. </span><span class="koboSpan" id="kobo.701.2">You can see that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.702.1">CreateContactRequest</span></strong><span class="koboSpan" id="kobo.703.1"> message has been converted into a .NET class, which includes the properties for </span><span class="No-Break"><span class="koboSpan" id="kobo.704.1">each field.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.705.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.706.1">Protobuf has a style guide for naming fields and methods. </span><span class="koboSpan" id="kobo.706.2">The general rules are </span><span class="No-Break"><span class="koboSpan" id="kobo.707.1">as follows:</span></span></p>
<ul>
<li class="callout"><span class="koboSpan" id="kobo.708.1">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.709.1">lower_snake_case</span></strong><span class="koboSpan" id="kobo.710.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.711.1">field names</span></span></li>
<li class="callout"><span class="koboSpan" id="kobo.712.1">Use </span><strong class="source-inline"><span class="koboSpan" id="kobo.713.1">PascalCase</span></strong><span class="koboSpan" id="kobo.714.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.715.1">method names</span></span></li>
<li class="callout"><span class="koboSpan" id="kobo.716.1">File names should be </span><span class="No-Break"><span class="koboSpan" id="kobo.717.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">lower_snake_case</span></strong></span></li>
<li class="callout"><span class="koboSpan" id="kobo.719.1">Using double quotes for string literals is preferred over </span><span class="No-Break"><span class="koboSpan" id="kobo.720.1">single quotes</span></span></li>
<li class="callout"><span class="koboSpan" id="kobo.721.1">The indentation should be two spaces </span><span class="No-Break"><span class="koboSpan" id="kobo.722.1">in length</span></span></li>
</ul>
<p class="callout"><span class="koboSpan" id="kobo.723.1">You can find more information </span><span class="No-Break"><span class="koboSpan" id="kobo.724.1">at </span></span><a href="https://protobuf.dev/programming-guides/style/"><span class="No-Break"><span class="koboSpan" id="kobo.725.1">https://protobuf.dev/programming-guides/style/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.726.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.727.1">With that, we’ve </span><a id="_idIndexMarker1116"/><span class="koboSpan" id="kobo.728.1">learned how to use protobuf scalar value types. </span><span class="koboSpan" id="kobo.728.2">Now, let’s consider </span><span class="No-Break"><span class="koboSpan" id="kobo.729.1">other types</span><a id="_idTextAnchor455"/><span class="koboSpan" id="kobo.730.1">.</span></span></p>
<h2 id="_idParaDest-240"><a id="_idTextAnchor456"/><span class="koboSpan" id="kobo.731.1">Other .NET types</span></h2>
<p><span class="koboSpan" id="kobo.732.1">The protobuf </span><a id="_idIndexMarker1117"/><span class="koboSpan" id="kobo.733.1">scalar data types do not support all the .NET types, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.734.1">Guid</span></strong><span class="koboSpan" id="kobo.735.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.736.1">DateTime</span></strong><span class="koboSpan" id="kobo.737.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.738.1">decimal</span></strong><span class="koboSpan" id="kobo.739.1">, and others. </span><span class="koboSpan" id="kobo.739.2">There are some workarounds for</span><a id="_idIndexMarker1118"/><span class="koboSpan" id="kobo.740.1"> these types. </span><span class="koboSpan" id="kobo.740.2">In this section, we will learn how to use these types in protobuf. </span><span class="koboSpan" id="kobo.740.3">We will also explore some other types, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.741.1">enum</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.742.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.743.1">repeat</span><a id="_idTextAnchor457"/><span class="koboSpan" id="kobo.744.1">ed</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.745.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.746.1">GUID values</span></h3>
<p><span class="koboSpan" id="kobo.747.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.748.1">GUID</span></strong><span class="koboSpan" id="kobo.749.1"> type (on other platforms, it may have another name, </span><strong class="source-inline"><span class="koboSpan" id="kobo.750.1">UUID</span></strong><span class="koboSpan" id="kobo.751.1">) is a 128-bit structure</span><a id="_idIndexMarker1119"/><span class="koboSpan" id="kobo.752.1"> that is used to identify objects. </span><span class="koboSpan" id="kobo.752.2">It is a very common type in .NET applications. </span><span class="koboSpan" id="kobo.752.3">Normally, a </span><strong class="source-inline"><span class="koboSpan" id="kobo.753.1">GUID</span></strong><span class="koboSpan" id="kobo.754.1"> value can be represented as a string that contains 32 hexadecimal digits. </span><span class="koboSpan" id="kobo.754.2">For example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.755.1">31F6E4E7-7C48-4F91-8D33-7A74F6729C8B</span></strong><span class="koboSpan" id="kobo.756.1"> is a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.757.1">GUID</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.758.1"> value.</span></span></p>
<p><span class="koboSpan" id="kobo.759.1">However, protobuf does not support the </span><strong class="source-inline"><span class="koboSpan" id="kobo.760.1">GUID</span></strong><span class="koboSpan" id="kobo.761.1"> type. </span><span class="koboSpan" id="kobo.761.2">The best way to represent a </span><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">GUID</span></strong><span class="koboSpan" id="kobo.763.1"> value in protobuf is to use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">string</span></strong><span class="koboSpan" id="kobo.765.1"> field. </span><span class="koboSpan" id="kobo.765.2">In the .NET code, we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">Guid.Parse()</span></strong><span class="koboSpan" id="kobo.767.1"> to convert a string into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">GUID</span></strong><span class="koboSpan" id="kobo.769.1"> value and use </span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">Guid.ToString()</span></strong><span class="koboSpan" id="kobo.771.1"> to convert a </span><strong class="source-inline"><span class="koboSpan" id="kobo.772.1">GUID</span></strong><span class="koboSpan" id="kobo.773.1"> value into </span><span class="No-Break"><span class="koboSpan" id="kobo.774.1">a str</span><a id="_idTextAnchor458"/><span class="koboSpan" id="kobo.775.1">ing.</span></span></p>
<h3><span class="koboSpan" id="kobo.776.1">DateTime values</span></h3>
<p><span class="koboSpan" id="kobo.777.1">.NET has</span><a id="_idIndexMarker1120"/><span class="koboSpan" id="kobo.778.1"> several types to represent a date and time value, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.779.1">DateTime</span></strong><span class="koboSpan" id="kobo.780.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.781.1">DateTimeOffset</span></strong><span class="koboSpan" id="kobo.782.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.783.1">TimeSpan</span></strong><span class="koboSpan" id="kobo.784.1">. </span><span class="koboSpan" id="kobo.784.2">Although protobuf does not support these types directly, it provides several extensions to </span><span class="No-Break"><span class="koboSpan" id="kobo.785.1">support them.</span></span></p>
<p><span class="koboSpan" id="kobo.786.1">To use these extension types, we need to import the </span><strong class="source-inline"><span class="koboSpan" id="kobo.787.1">google/protobuf/xxx.proto</span></strong><span class="koboSpan" id="kobo.788.1"> file into the proto file. </span><span class="koboSpan" id="kobo.788.2">For example, here is a message that contains a timestamp and </span><span class="No-Break"><span class="koboSpan" id="kobo.789.1">a duration:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.790.1">
syntax = "proto3";import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";
message UpdateInvoiceDueDateRequest {
  string invoice_id = 1;
  google.protobuf.Timestamp due_date = 2;
  google.protobuf.Duration grace_period = 3;
}</span></pre>
<p><span class="koboSpan" id="kobo.791.1">Check the generated code for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.792.1">UpdateInvoiceDueDateRequest</span></strong><span class="koboSpan" id="kobo.793.1"> message in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.794.1">Generated</span></strong><span class="koboSpan" id="kobo.795.1"> folder. </span><span class="koboSpan" id="kobo.795.2">You will find that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.796.1">due_date</span></strong><span class="koboSpan" id="kobo.797.1"> field is converted into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.798.1">Timestamp</span></strong><span class="koboSpan" id="kobo.799.1"> type, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.800.1">grace_period</span></strong><span class="koboSpan" id="kobo.801.1"> field is converted into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.802.1">Duration</span></strong><span class="koboSpan" id="kobo.803.1"> type, </span><span class="No-Break"><span class="koboSpan" id="kobo.804.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.805.1">
public const int DueDateFieldNumber = 2;private global::Google.Protobuf.WellKnownTypes.Timestamp dueDate_;
public global::Google.Protobuf.WellKnownTypes.Timestamp DueDate {
  get { return dueDate_; }
  set {
    dueDate_ = value;
  }
}
public const int GracePeriodFieldNumber = 3;
private global::Google.Protobuf.WellKnownTypes.Duration gracePeriod_;
public global::Google.Protobuf.WellKnownTypes.Duration GracePeriod {
  get { return gracePeriod_; }
  set {
    gracePeriod_ = value;
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.806.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.807.1">Timestamp</span></strong><span class="koboSpan" id="kobo.808.1"> type and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.809.1">Duration</span></strong><span class="koboSpan" id="kobo.810.1"> type are not native .NET types. </span><span class="koboSpan" id="kobo.810.2">They are defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.811.1">Google.Protobuf.WellKnownTypes</span></strong><span class="koboSpan" id="kobo.812.1"> namespace, which includes some </span><a id="_idIndexMarker1121"/><span class="koboSpan" id="kobo.813.1">well-known types that are not supported by protobuf. </span><span class="koboSpan" id="kobo.813.2">The source code for these types can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.814.1">at </span></span><a href="https://github.com/protocolbuffers/protobuf/tree/main/csharp/src/Google.Protobuf/WellKnownTypes"><span class="No-Break"><span class="koboSpan" id="kobo.815.1">https://github.com/protocolbuffers/protobuf/tree/main/csharp/src/Google.Protobuf/WellKnownTypes</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.816.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.817.1">Because these types are not native .NET types, we need to convert them into native .NET types when using them. </span><span class="koboSpan" id="kobo.817.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.818.1">Google.Protobuf.WellKnownTypes</span></strong><span class="koboSpan" id="kobo.819.1"> namespace provides some methods to do the conversion. </span><span class="koboSpan" id="kobo.819.2">Here is an example of converting .NET types into </span><span class="No-Break"><span class="koboSpan" id="kobo.820.1">protobuf types:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.821.1">
var updateInvoiceDueDateRequest = new UpdateInvoiceDueDateRequest{
    InvoiceId = Guid.Parse("3193C36C-2AAB-49A7-A0B1-6BDB3B69DEA1"),
    DueDate = Timestamp.FromDateTime(DateTime.UtcNow.AddDays(30)),
    GracePeriod = Duration.FromTimeSpan(TimeSpan.FromDays(10))
};</span></pre>
<p><span class="koboSpan" id="kobo.822.1">We</span><a id="_idIndexMarker1122"/><span class="koboSpan" id="kobo.823.1"> can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.824.1">Timestamp</span></strong><span class="koboSpan" id="kobo.825.1"> class to convert </span><strong class="source-inline"><span class="koboSpan" id="kobo.826.1">DateTime</span></strong><span class="koboSpan" id="kobo.827.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.828.1">DateTimeOffset</span></strong><span class="koboSpan" id="kobo.829.1"> values into </span><strong class="source-inline"><span class="koboSpan" id="kobo.830.1">Timestamp</span></strong><span class="koboSpan" id="kobo.831.1"> values. </span><span class="koboSpan" id="kobo.831.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.832.1">Timestamp.FromDateTime()</span></strong><span class="koboSpan" id="kobo.833.1"> method is used to convert a </span><strong class="source-inline"><span class="koboSpan" id="kobo.834.1">DateTime</span></strong><span class="koboSpan" id="kobo.835.1"> value, while the </span><strong class="source-inline"><span class="koboSpan" id="kobo.836.1">Timestamp.FromDateTimeOffset()</span></strong><span class="koboSpan" id="kobo.837.1"> method is used to convert a </span><strong class="source-inline"><span class="koboSpan" id="kobo.838.1">DateTimeOffset</span></strong><span class="koboSpan" id="kobo.839.1"> value. </span><span class="koboSpan" id="kobo.839.2">We can also use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.840.1">Duration.FromTimeSpan()</span></strong><span class="koboSpan" id="kobo.841.1"> method to convert a </span><strong class="source-inline"><span class="koboSpan" id="kobo.842.1">TimeSpan</span></strong><span class="koboSpan" id="kobo.843.1"> value into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.844.1">Duration</span></strong><span class="koboSpan" id="kobo.845.1"> value. </span><span class="koboSpan" id="kobo.845.2">Note that if you use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.846.1">DateTimeOffset</span></strong><span class="koboSpan" id="kobo.847.1"> type in your application, the offset of </span><strong class="source-inline"><span class="koboSpan" id="kobo.848.1">DateTimeOffset</span></strong><span class="koboSpan" id="kobo.849.1"> values is always 0, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.850.1">DateTime.Kind</span></strong><span class="koboSpan" id="kobo.851.1"> property is always set </span><span class="No-Break"><span class="koboSpan" id="kobo.852.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.853.1">DateTimeKind.Utc</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.854.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.855.1">Similarly, we can convert protobuf types into .</span><span class="No-Break"><span class="koboSpan" id="kobo.856.1">NET types:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.857.1">
var dueDate = updateInvoiceDueDateRequest.DueDate.ToDateTime();var gracePeriod = updateInvoiceDueDateRequest.GracePeriod.ToTimeSpan();</span></pre>
<p><span class="koboSpan" id="kobo.858.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.859.1">Timestamp</span></strong><span class="koboSpan" id="kobo.860.1"> class provides several methods for converting its values into other types. </span><span class="koboSpan" id="kobo.860.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.861.1">ToDateTime()</span></strong><span class="koboSpan" id="kobo.862.1"> method can be used to convert a </span><strong class="source-inline"><span class="koboSpan" id="kobo.863.1">Timestamp</span></strong><span class="koboSpan" id="kobo.864.1"> value into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.865.1">DateTime</span></strong><span class="koboSpan" id="kobo.866.1"> value, while the </span><strong class="source-inline"><span class="koboSpan" id="kobo.867.1">ToTimeSpan()</span></strong><span class="koboSpan" id="kobo.868.1"> method can be used to convert a </span><strong class="source-inline"><span class="koboSpan" id="kobo.869.1">Duration</span></strong><span class="koboSpan" id="kobo.870.1"> value into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.871.1">TimeSpan</span></strong><span class="koboSpan" id="kobo.872.1"> value. </span><span class="koboSpan" id="kobo.872.2">Additionally, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.873.1">ToDateTimeOffset()</span></strong><span class="koboSpan" id="kobo.874.1"> method can be used to convert a </span><strong class="source-inline"><span class="koboSpan" id="kobo.875.1">Timestamp</span></strong><span class="koboSpan" id="kobo.876.1"> value into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.877.1">DateTimeOffset</span></strong><span class="koboSpan" id="kobo.878.1"> value. </span><span class="koboSpan" id="kobo.878.2">Depending on your requirements, you can select the appropriate method for </span><span class="No-Break"><span class="koboSpan" id="kobo.879.1">your</span><a id="_idTextAnchor459"/><span class="koboSpan" id="kobo.880.1"> needs.</span></span></p>
<h3><span class="koboSpan" id="kobo.881.1">Decimal values</span></h3>
<p><span class="koboSpan" id="kobo.882.1">At the time </span><a id="_idIndexMarker1123"/><span class="koboSpan" id="kobo.883.1">of writing, protobuf does not support the </span><strong class="source-inline"><span class="koboSpan" id="kobo.884.1">decimal</span></strong><span class="koboSpan" id="kobo.885.1"> type directly. </span><span class="koboSpan" id="kobo.885.2">There are some discussions about adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.886.1">decimal</span></strong><span class="koboSpan" id="kobo.887.1"> type to protobuf, but it hasn’t been implemented yet. </span><span class="koboSpan" id="kobo.887.2">As a workaround, Microsoft Docs provides a </span><strong class="source-inline"><span class="koboSpan" id="kobo.888.1">DecimalValue</span></strong><span class="koboSpan" id="kobo.889.1"> type, which can be used to represent a </span><strong class="source-inline"><span class="koboSpan" id="kobo.890.1">decimal</span></strong><span class="koboSpan" id="kobo.891.1"> value in protobuf. </span><span class="koboSpan" id="kobo.891.2">The following code, which has been copied from Microsoft Docs, shows how </span><a id="_idIndexMarker1124"/><span class="koboSpan" id="kobo.892.1">to define a </span><strong class="source-inline"><span class="koboSpan" id="kobo.893.1">decimal</span></strong><span class="koboSpan" id="kobo.894.1"> value </span><span class="No-Break"><span class="koboSpan" id="kobo.895.1">in protobuf:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.896.1">
// Example: 12345.6789 -&gt; { units = 12345, nanos = 678900000 }message DecimalValue {
    // Whole units part of the amount
    int64 units = 1;
    // Nano units of the amount (10^-9)
    // Must be same sign as units
    sfixed32 nanos = 2;
}</span></pre>
<p><span class="koboSpan" id="kobo.897.1">We will not delve into the details of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.898.1">DecimalValue</span></strong><span class="koboSpan" id="kobo.899.1"> type in this book. </span><span class="koboSpan" id="kobo.899.2">You can find more information </span><span class="No-Break"><span class="koboSpan" id="kobo.900.1">at </span></span><a href="https://learn.microsoft.com/en-us/dotnet/architecture/grpc-for-wcf-developers/protobuf-data-types#decimals"><span class="No-Break"><span class="koboSpan" id="kobo.901.1">https://learn.microsoft.com/en-us/dotnet/architecture/grpc-for-wcf-developers/protobuf-data-types#</span><span id="_idTextAnchor460"/><span class="koboSpan" id="kobo.902.1">decimals</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.903.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.904.1">Enum values</span></h3>
<p><span class="koboSpan" id="kobo.905.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.906.1">enum</span></strong><span class="koboSpan" id="kobo.907.1"> type is</span><a id="_idIndexMarker1125"/><span class="koboSpan" id="kobo.908.1"> very common in .NET applications. </span><span class="koboSpan" id="kobo.908.2">protobuf supports the </span><strong class="source-inline"><span class="koboSpan" id="kobo.909.1">enum</span></strong><span class="koboSpan" id="kobo.910.1"> type. </span><span class="koboSpan" id="kobo.910.2">Here’s an example of </span><span class="No-Break"><span class="koboSpan" id="kobo.911.1">its usage:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.912.1">
enum InvoiceStatus {  INVOICE_STATUS_UNKNOWN = 0;
  INVOICE_STATUS_DRAFT = 1;
  INVOICE_STATUS_AWAIT_PAYMENT = 2;
  INVOICE_STATUS_PAID = 3;
  INVOICE_STATUS_OVERDUE = 4;
  INVOICE_STATUS_CANCELLED = 5;
}</span></pre>
<p><span class="koboSpan" id="kobo.913.1">The preceding enum definition is similar to the enum definition in C#, but we need to define </span><a id="_idIndexMarker1126"/><span class="koboSpan" id="kobo.914.1">it in the proto file. </span><span class="koboSpan" id="kobo.914.2">In the preceding code, we define an </span><strong class="source-inline"><span class="koboSpan" id="kobo.915.1">InvoiceStatus</span></strong><span class="koboSpan" id="kobo.916.1"> enum type with six values. </span><span class="koboSpan" id="kobo.916.2">Note that every enum type must contain a </span><strong class="source-inline"><span class="koboSpan" id="kobo.917.1">0</span></strong><span class="koboSpan" id="kobo.918.1"> value, which is the default value and must be placed at the first position. </span><span class="koboSpan" id="kobo.918.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.919.1">InvoiceStatus</span></strong><span class="koboSpan" id="kobo.920.1"> enum type is converted into a .NET enum type, </span><span class="No-Break"><span class="koboSpan" id="kobo.921.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.922.1">
public enum InvoiceStatus {  [pbr::OriginalName("INVOICE_STATUS_UNKNOWN")] Unknown = 0,
  [pbr::OriginalName("INVOICE_STATUS_DRAFT")] Draft = 1,
  [pbr::OriginalName("INVOICESTATUS_AWAIT_PAYMENT")] AwaitPayment = 2,
  [pbr::OriginalName("INVOICE_STATUS_PAID")] Paid = 3,
  [pbr::OriginalName("INVOICE_STATUS_OVERDUE")] Overdue = 4,
}</span></pre>
<p><span class="koboSpan" id="kobo.923.1">As you can see, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.924.1">INVOICE_STATUS</span></strong><span class="koboSpan" id="kobo.925.1"> prefix in the original names is removed because the prefix is the same as the enum name. </span><span class="koboSpan" id="kobo.925.2">In the .NET code, the enum names are converted </span><span class="No-Break"><span class="koboSpan" id="kobo.926.1">into PascalCase.</span></span></p>
<p><span class="koboSpan" id="kobo.927.1">Besides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.928.1">enum</span></strong><span class="koboSpan" id="kobo.929.1"> type, .NET also has a common type named </span><strong class="source-inline"><span class="koboSpan" id="kobo.930.1">nullable</span></strong><span class="koboSpan" id="kobo.931.1">. </span><span class="koboSpan" id="kobo.931.2">We’ll check out nullable types in the </span><span class="No-Break"><span class="koboSpan" id="kobo.932.1">ne</span><a id="_idTextAnchor461"/><span class="koboSpan" id="kobo.933.1">xt section.</span></span></p>
<h3><span class="koboSpan" id="kobo.934.1">Nullable values</span></h3>
<p><span class="koboSpan" id="kobo.935.1">Protobuf scalar </span><a id="_idIndexMarker1127"/><span class="koboSpan" id="kobo.936.1">value types, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.937.1">int32</span></strong><span class="koboSpan" id="kobo.938.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.939.1">sint32</span></strong><span class="koboSpan" id="kobo.940.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.941.1">fixed32</span></strong><span class="koboSpan" id="kobo.942.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.943.1">bool</span></strong><span class="koboSpan" id="kobo.944.1">, cannot be </span><strong class="source-inline"><span class="koboSpan" id="kobo.945.1">null</span></strong><span class="koboSpan" id="kobo.946.1">. </span><span class="koboSpan" id="kobo.946.2">But in .NET, nullable value types are very common. </span><span class="koboSpan" id="kobo.946.3">For example, we can use </span><strong class="source-inline"><span class="koboSpan" id="kobo.947.1">int?</span></strong><span class="koboSpan" id="kobo.948.1"> to declare an integer value that can be </span><strong class="source-inline"><span class="koboSpan" id="kobo.949.1">null</span></strong><span class="koboSpan" id="kobo.950.1">. </span><span class="koboSpan" id="kobo.950.2">To support nullable value types, protobuf provides some wrapper types, which are defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.951.1">google/protobuf/wrappers.proto</span></strong><span class="koboSpan" id="kobo.952.1"> file, to support nullable types. </span><span class="koboSpan" id="kobo.952.2">We can import this file into the proto file and use the wrapper types. </span><span class="koboSpan" id="kobo.952.3">For example, we can define a message </span><span class="No-Break"><span class="koboSpan" id="kobo.953.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.954.1">
syntax = "proto3";import "google/protobuf/wrappers.proto";
message AddInvoiceItemRequest {
  string name = 1;
  string description = 2;
  google.protobuf.DoubleValue unit_price = 3;
  google.protobuf.Int32Value quantity = 4;
  google.protobuf.BoolValue is_taxable = 5;
}</span></pre>
<p><span class="koboSpan" id="kobo.955.1">In the </span><a id="_idIndexMarker1128"/><span class="koboSpan" id="kobo.956.1">preceding code, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.957.1">google.protobuf.DoubleValue</span></strong><span class="koboSpan" id="kobo.958.1"> type is used to represent a nullable </span><strong class="source-inline"><span class="koboSpan" id="kobo.959.1">double</span></strong><span class="koboSpan" id="kobo.960.1"> value, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.961.1">google.protobuf.Int32Value</span></strong><span class="koboSpan" id="kobo.962.1"> type is used to represent a nullable </span><strong class="source-inline"><span class="koboSpan" id="kobo.963.1">int32</span></strong><span class="koboSpan" id="kobo.964.1"> value, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.965.1">google.protobuf.BoolValue</span></strong><span class="koboSpan" id="kobo.966.1"> type is used to define a nullable </span><strong class="source-inline"><span class="koboSpan" id="kobo.967.1">bool</span></strong><span class="koboSpan" id="kobo.968.1"> value. </span><span class="koboSpan" id="kobo.968.2">The generated code for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.969.1">AddInvoiceItemRequest</span></strong><span class="koboSpan" id="kobo.970.1"> message is </span><span class="No-Break"><span class="koboSpan" id="kobo.971.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.972.1">
private double? </span><span class="koboSpan" id="kobo.972.2">unitPrice_;public double? </span><span class="koboSpan" id="kobo.972.3">UnitPrice {
  get { return unitPrice_; }
  set {
    unitPrice_ = value;
  }
}
private int? </span><span class="koboSpan" id="kobo.972.4">quantity_;
public int? </span><span class="koboSpan" id="kobo.972.5">Quantity {
  get { return quantity_; }
  set {
    quantity_ = value;
  }
}
private bool? </span><span class="koboSpan" id="kobo.972.6">isTaxable_;
public bool? </span><span class="koboSpan" id="kobo.972.7">IsTaxable {
  get { return isTaxable_; }
  set {
    isTaxable_ = value;
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.973.1">As you </span><a id="_idIndexMarker1129"/><span class="koboSpan" id="kobo.974.1">can see, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.975.1">unitPrice</span></strong><span class="koboSpan" id="kobo.976.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.977.1">quantity</span></strong><span class="koboSpan" id="kobo.978.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.979.1">IsTaxable</span></strong><span class="koboSpan" id="kobo.980.1"> fields are converted into nullable types </span><span class="No-Break"><span class="koboSpan" id="kobo.981.1">in .NET.</span></span></p>
<p><span class="koboSpan" id="kobo.982.1">Most of .NET nullable types are supported by protobuf. </span><span class="koboSpan" id="kobo.982.2">Besides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.983.1">google.protobuf.DoubleValue</span></strong><span class="koboSpan" id="kobo.984.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.985.1">google.protobuf.Int32Value</span></strong><span class="koboSpan" id="kobo.986.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.987.1">google.protobuf.BoolValue</span></strong><span class="koboSpan" id="kobo.988.1"> types, protobuf also provides the following </span><span class="No-Break"><span class="koboSpan" id="kobo.989.1">wrapper types:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.990.1">google.protobuf.FloatValue</span></strong><span class="koboSpan" id="kobo.991.1">: This type is used to represent a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.992.1">float</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.993.1">? </span><span class="koboSpan" id="kobo.993.2">value.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.994.1">google.protobuf.Int64Value</span></strong><span class="koboSpan" id="kobo.995.1">: This type is used to represent a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.996.1">long</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.997.1">? </span><span class="koboSpan" id="kobo.997.2">value.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.998.1">google.protobuf.UInt32Value</span></strong><span class="koboSpan" id="kobo.999.1">: This type is used to represent a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1000.1">uint</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1001.1">? </span><span class="koboSpan" id="kobo.1001.2">value.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1002.1">google.protobuf.UInt64Value</span></strong><span class="koboSpan" id="kobo.1003.1">: This type is used to represent a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1004.1">ulong</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1005.1">? </span><span class="koboSpan" id="kobo.1005.2">value.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1006.1">google.protobuf.StringValue</span></strong><span class="koboSpan" id="kobo.1007.1">: This type is used to represent a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1008.1">string</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1009.1"> value.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1010.1">google.protobuf.BytesValue</span></strong><span class="koboSpan" id="kobo.1011.1">: This type is used to represent a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1012.1">ByteString</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1013.1"> value.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1014.1">There are</span><a id="_idIndexMarker1130"/><span class="koboSpan" id="kobo.1015.1"> two special types in the preceding list: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1016.1">google.protobuf.StringValue</span></strong><span class="koboSpan" id="kobo.1017.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1018.1">google.protobuf.BytesValue</span></strong><span class="koboSpan" id="kobo.1019.1">. </span><span class="koboSpan" id="kobo.1019.2">The corresponding .NET types are </span><strong class="source-inline"><span class="koboSpan" id="kobo.1020.1">string</span></strong><span class="koboSpan" id="kobo.1021.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1022.1">ByteString</span></strong><span class="koboSpan" id="kobo.1023.1">. </span><span class="koboSpan" id="kobo.1023.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1024.1">ByteString</span></strong><span class="koboSpan" id="kobo.1025.1"> type is a class that represents an immutable array of bytes, which is defined in the protobuf runtime. </span><span class="koboSpan" id="kobo.1025.2">The default value of these two types </span><span class="No-Break"><span class="koboSpan" id="kobo.1026.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1027.1">null</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1028.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1029.1">So, if </span><strong class="source-inline"><span class="koboSpan" id="kobo.1030.1">google.protobuf.StringValue</span></strong><span class="koboSpan" id="kobo.1031.1"> is mapped to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1032.1">string</span></strong><span class="koboSpan" id="kobo.1033.1"> in .NET, what is the difference between </span><strong class="source-inline"><span class="koboSpan" id="kobo.1034.1">google.protobuf.StringValue</span></strong><span class="koboSpan" id="kobo.1035.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1036.1">string</span></strong><span class="koboSpan" id="kobo.1037.1"> in protobuf? </span><span class="koboSpan" id="kobo.1037.2">The difference is the default value. </span><span class="koboSpan" id="kobo.1037.3">We’ll look at the default values of these types in th</span><a id="_idTextAnchor462"/><span class="koboSpan" id="kobo.1038.1">e </span><span class="No-Break"><span class="koboSpan" id="kobo.1039.1">next section.</span></span></p>
<h3><span class="koboSpan" id="kobo.1040.1">Default values</span></h3>
<p><span class="koboSpan" id="kobo.1041.1">The following table lists </span><a id="_idIndexMarker1131"/><span class="koboSpan" id="kobo.1042.1">the default values of the scalar </span><span class="No-Break"><span class="koboSpan" id="kobo.1043.1">value types:</span></span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table002-7">
<colgroup>
<col/>
<col/>
</colgroup>
<thead>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1044.1">Protobuf Type</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1045.1">Default Value</span></strong></span></p>
</td>
</tr>
</thead>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1046.1">string</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1047.1">An </span><span class="No-Break"><span class="koboSpan" id="kobo.1048.1">empty string</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1049.1">bytes</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1050.1">An empty </span><span class="No-Break"><span class="koboSpan" id="kobo.1051.1">byte array</span></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1052.1">bool</span></strong></span></p>
</td>
<td class="No-Table-Style">
<p><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1053.1">false</span></strong></span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><span class="No-Break"><span class="koboSpan" id="kobo.1054.1">Numeric types</span></span></p>
</td>
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1055.1">0</span></strong></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1056.1">enums</span></strong> </p>
</td>
<td class="No-Table-Style">
<p><span class="koboSpan" id="kobo.1057.1">The first </span><span class="No-Break"><span class="koboSpan" id="kobo.1058.1">enum value</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1059.1">Table 11.2 – Default values of protobuf scalar value types</span></p>
<p><span class="koboSpan" id="kobo.1060.1">If you use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1061.1">string</span></strong><span class="koboSpan" id="kobo.1062.1"> as the type of a field, the default value will be an empty string. </span><span class="koboSpan" id="kobo.1062.2">However, the default value of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1063.1">google.protobuf.StringValue</span></strong><span class="koboSpan" id="kobo.1064.1"> field is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1065.1">null</span></strong><span class="koboSpan" id="kobo.1066.1">. </span><span class="koboSpan" id="kobo.1066.2">Similarly, the default value of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1067.1">bytes</span></strong><span class="koboSpan" id="kobo.1068.1"> field is an empty byte array, while the default value of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1069.1">google.protobuf.BytesValue</span></strong><span class="koboSpan" id="kobo.1070.1"> field is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1071.1">null</span></strong><span class="koboSpan" id="kobo.1072.1">. </span><span class="koboSpan" id="kobo.1072.2">All other wrapper types also have a default value </span><span class="No-Break"><span class="koboSpan" id="kobo.1073.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1074.1">null</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1075.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1076.1">All </span><a id="_idIndexMarker1132"/><span class="koboSpan" id="kobo.1077.1">numeric types, including </span><strong class="source-inline"><span class="koboSpan" id="kobo.1078.1">int32</span></strong><span class="koboSpan" id="kobo.1079.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1080.1">double</span></strong><span class="koboSpan" id="kobo.1081.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1082.1">float</span></strong><span class="koboSpan" id="kobo.1083.1">, have a default value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1084.1">0</span></strong><span class="koboSpan" id="kobo.1085.1">. </span><span class="koboSpan" id="kobo.1085.2">This applies to all numerical data types. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1086.1">Enum</span></strong><span class="koboSpan" id="kobo.1087.1"> types in protobuf have a default value of the first value in the enum type, which must be 0. </span><span class="koboSpan" id="kobo.1087.2">For instance, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1088.1">InvoiceStatus</span></strong><span class="koboSpan" id="kobo.1089.1"> enum type has a default value of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1090.1">INVOICE_STATUS_UNKNOWN</span></strong><span class="koboSpan" id="kobo.1091.1">, which </span><span class="No-Break"><span class="koboSpan" id="kobo.1092.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1093.1">0</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1094.1">.</span></span><a id="_idTextAnchor463"/></p>
<h3><span class="koboSpan" id="kobo.1095.1">Repeated fields</span></h3>
<p><span class="koboSpan" id="kobo.1096.1">Similar </span><a id="_idIndexMarker1133"/><span class="koboSpan" id="kobo.1097.1">to .NET collections, protobuf supports repeated fields. </span><span class="koboSpan" id="kobo.1097.2">A repeated field can contain zero or more items. </span><span class="koboSpan" id="kobo.1097.3">The following code shows how to define a </span><span class="No-Break"><span class="koboSpan" id="kobo.1098.1">repeated field:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1099.1">
message UpdateBatchInvoicesStatusRequest {  repeated string invoice_ids = 1;
  InvoiceStatus status = 2;
}</span></pre>
<p><span class="koboSpan" id="kobo.1100.1">In the preceding code, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1101.1">repeated</span></strong><span class="koboSpan" id="kobo.1102.1"> keyword to define a repeated field. </span><span class="koboSpan" id="kobo.1102.2">The generated code for the repeated </span><strong class="source-inline"><span class="koboSpan" id="kobo.1103.1">invoice_ids</span></strong><span class="koboSpan" id="kobo.1104.1"> field in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1105.1">UpdateInvoicesStatusRequest</span></strong><span class="koboSpan" id="kobo.1106.1"> message is </span><span class="No-Break"><span class="koboSpan" id="kobo.1107.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1108.1">
private readonly pbc::RepeatedField&lt;string&gt; invoiceIds_ = new pbc::RepeatedField&lt;string&gt;();public pbc::RepeatedField&lt;string&gt; InvoiceIds {
  get { return invoiceIds_; }
}</span></pre>
<p><span class="koboSpan" id="kobo.1109.1">From the generated code, we can see that the repeated </span><strong class="source-inline"><span class="koboSpan" id="kobo.1110.1">string</span></strong><span class="koboSpan" id="kobo.1111.1"> field is converted into a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1112.1">RepeatedField&lt;string&gt;</span></strong><span class="koboSpan" id="kobo.1113.1"> type. </span><span class="koboSpan" id="kobo.1113.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1114.1">RepeatedField&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.1115.1"> type is defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1116.1">Google.Protobuf.Collections</span></strong><span class="koboSpan" id="kobo.1117.1"> namespace, and it implements the .NET collection interfaces, </span><span class="No-Break"><span class="koboSpan" id="kobo.1118.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1119.1">
public sealed class RepeatedField&lt;T&gt; : IList&lt;T&gt;, ICollection&lt;T&gt;, IEnumerable&lt;T&gt;, IEnumerable, IList, ICollection, IDeepCloneable&lt;RepeatedField&lt;T&gt;&gt;, IEquatable&lt;RepeatedField&lt;T&gt;&gt;, IReadOnlyList&lt;T&gt;, IReadOnlyCollection&lt;T&gt;{
  // Omitted for brevity
}</span></pre>
<p><span class="koboSpan" id="kobo.1120.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1121.1">RepeatedField&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.1122.1"> type can be used as a normal .NET collection type, and any LINQ methods can be applied to it. </span><span class="koboSpan" id="kobo.1122.2">This makes it a powerful and versatile tool for </span><span class="No-Break"><span class="koboSpan" id="kobo.1123.1">data manipulation.</span></span></p>
<p><span class="koboSpan" id="kobo.1124.1">You will </span><a id="_idIndexMarker1134"/><span class="koboSpan" id="kobo.1125.1">also find that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1126.1">InvoiceIds</span></strong><span class="koboSpan" id="kobo.1127.1"> field is a read-only property. </span><span class="koboSpan" id="kobo.1127.2">To add one or multiple items to the collection, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1128.1">Add()</span></strong><span class="koboSpan" id="kobo.1129.1"> method can be used. </span><span class="koboSpan" id="kobo.1129.2">Here’s </span><span class="No-Break"><span class="koboSpan" id="kobo.1130.1">an example:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1131.1">
var updateInvoicesStatusRequest = new UpdateBatchInvoicesStatusRequest();// Add one item
updateInvoicesStatusRequest.InvoiceIds.Add("3193C36C-2AAB-49A7-A0B1-6BDB3B69DEA1");
// Add multiple items
updateInvoicesStatusRequest.InvoiceIds.Add(new[]
            { "99143291-2523-4EE8-8A4D-27B09334C980", "BB4E6CFE-6AAE-4948-941A-26D1FBF59E8A" });</span></pre>
<p><span class="koboSpan" id="kobo.1132.1">The default value of a repeated field is an </span><span class="No-Break"><span class="koboSpan" id="kobo.1133.1">empty collectio</span><a id="_idTextAnchor464"/><span class="koboSpan" id="kobo.1134.1">n.</span></span></p>
<h3><span class="koboSpan" id="kobo.1135.1">Map fields</span></h3>
<p><span class="koboSpan" id="kobo.1136.1">Protobuf</span><a id="_idIndexMarker1135"/><span class="koboSpan" id="kobo.1137.1"> supports map fields, which are collections of key-value pairs similar to a .NET dictionary. </span><span class="koboSpan" id="kobo.1137.2">The following code provides an example of how to define a </span><span class="No-Break"><span class="koboSpan" id="kobo.1138.1">map field:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1139.1">
message UpdateInvoicesStatusRequest {  map&lt;string, InvoiceStatus&gt; invoice_status_map = 1;
}</span></pre>
<p><span class="koboSpan" id="kobo.1140.1">The</span><a id="_idIndexMarker1136"/><span class="koboSpan" id="kobo.1141.1"> generated code for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1142.1">invoice_status_map</span></strong><span class="koboSpan" id="kobo.1143.1"> field is </span><span class="No-Break"><span class="koboSpan" id="kobo.1144.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1145.1">
private readonly pbc::MapField&lt;string, global::GrpcDemo.InvoiceStatus&gt; invoiceStatusMap_ = newpbc::MapField&lt;string, global::GrpcDemo.InvoiceStatus&gt;();public pbc::MapField&lt;string, global::GrpcDemo.InvoiceStatus&gt; InvoiceStatusMap {
  get { return invoiceStatusMap_; }
}</span></pre>
<p><span class="koboSpan" id="kobo.1146.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1147.1">MapField&lt;Tkey, TValue&gt;</span></strong><span class="koboSpan" id="kobo.1148.1"> type is defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1149.1">Google.Protobuf.Collections</span></strong><span class="koboSpan" id="kobo.1150.1"> namespace and it implements the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1151.1">IDictionary&lt;TKey, TValue&gt;</span></strong><span class="koboSpan" id="kobo.1152.1"> interface, </span><span class="No-Break"><span class="koboSpan" id="kobo.1153.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1154.1">
public sealed class MapField&lt;TKey, TValue&gt; : IDeepCloneable&lt;MapField&lt;TKey, TValue&gt;&gt;, IDictionary&lt;TKey, TValue&gt;, ICollection&lt;KeyValuePair&lt;TKey, TValue&gt;&gt;, IEnumerable&lt;KeyValuePair&lt;TKey, TValue&gt;&gt;, IEnumerable, IEquatable&lt;MapField&lt;TKey, TValue&gt;&gt;, IDictionary, ICollection, IReadOnlyDictionary&lt;TKey, TValue&gt;, IReadOnlyCollection&lt;KeyValuePair&lt;TKey, TValue&gt;&gt;{
  // Omitted for brevity
}</span></pre>
<p><span class="koboSpan" id="kobo.1155.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1156.1">MapField&lt;TKey, TValue&gt;</span></strong><span class="koboSpan" id="kobo.1157.1"> type can be used as a normal .NET dictionary type. </span><span class="koboSpan" id="kobo.1157.2">This type provides the same functionality as a standard dictionary, allowing for the storage and retrieval of </span><span class="No-Break"><span class="koboSpan" id="kobo.1158.1">key-value pairs.</span></span></p>
<p><span class="koboSpan" id="kobo.1159.1">Similar to the repeated field, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1160.1">InvoiceStatusMap</span></strong><span class="koboSpan" id="kobo.1161.1"> field is also a read-only property. </span><span class="koboSpan" id="kobo.1161.2">We can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1162.1">Add()</span></strong><span class="koboSpan" id="kobo.1163.1"> method to add one key-value pair or multiple key-value pairs to the collection, </span><span class="No-Break"><span class="koboSpan" id="kobo.1164.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1165.1">
var updateInvoicesStatusRequest = new UpdateInvoicesStatusRequest();// Add one key-value pair
updateInvoicesStatusRequest.InvoiceStatusMap.Add("3193C36C-2AAB-49A7-A0B1-6BDB3B69DEA1", InvoiceStatus.AwaitPayment);
// Add multiple key-value pairs
updateInvoicesStatusRequest.InvoiceStatusMap.Add(new Dictionary&lt;string, InvoiceStatus&gt;
{
    { "99143291-2523-4EE8-8A4D-27B09334C980", InvoiceStatus.Paid },
    { "BB4E6CFE-6AAE-4948-941A-26D1FBF59E8A", InvoiceStatus.Overdue }
});</span></pre>
<p><span class="koboSpan" id="kobo.1166.1">Note that map</span><a id="_idIndexMarker1137"/><span class="koboSpan" id="kobo.1167.1"> fields cannot be repeated. </span><span class="koboSpan" id="kobo.1167.2">Also, the key of a map field must be a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1168.1">string</span></strong><span class="koboSpan" id="kobo.1169.1"> or integer type. </span><span class="koboSpan" id="kobo.1169.2">You cannot use an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1170.1">enum</span></strong><span class="koboSpan" id="kobo.1171.1"> type as the key of a map field. </span><span class="koboSpan" id="kobo.1171.2">The value of a map field can be any type, including a message type. </span><span class="koboSpan" id="kobo.1171.3">But the value type cannot be another </span><span class="No-Break"><span class="koboSpan" id="kobo.1172.1">map field.</span></span></p>
<p><span class="koboSpan" id="kobo.1173.1">We have now acquired a comprehensive understanding of protobuf messages, including field numbers, field types, default values, repeated fields, and map fields. </span><span class="koboSpan" id="kobo.1173.2">For further information on protobuf messages, please refer </span><span class="No-Break"><span class="koboSpan" id="kobo.1174.1">to </span></span><a href="https://protobuf.dev/programming-guides/proto3/"><span class="No-Break"><span class="koboSpan" id="kobo.1175.1">https://protobuf.dev/programming-guides/proto3/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1176.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1177.1">Next, we’ll examine the various protobuf services. </span><span class="koboSpan" id="kobo.1177.2">We will explore the various types of RPC methods and how to create a gRPC client for the service. </span><span class="koboSpan" id="kobo.1177.3">By doing so, we will gain a better understanding of how these services function and how to use </span><span class="No-Break"><span class="koboSpan" id="kobo.1178.1">them effecti</span><a id="_idTextAnchor465"/><span class="koboSpan" id="kobo.1179.1">vely.</span></span></p>
<h1 id="_idParaDest-241"><a id="_idTextAnchor466"/><span class="koboSpan" id="kobo.1180.1">Creating a protobuf service</span></h1>
<p><span class="koboSpan" id="kobo.1181.1">Now that we have</span><a id="_idIndexMarker1138"/><span class="koboSpan" id="kobo.1182.1"> understood the definition of a protobuf message, we can move on to defining protobuf services. </span><span class="koboSpan" id="kobo.1182.2">These services are comprised of RPC methods, each of which has a request and response message. </span><span class="koboSpan" id="kobo.1182.3">To facilitate the implementation of these services, gRPC tooling will generate the necessary C# code, which can then be used as the base class for </span><span class="No-Break"><span class="koboSpan" id="kobo.1183.1">the service.</span></span></p>
<p><span class="koboSpan" id="kobo.1184.1">gRPC supports four types of </span><span class="No-Break"><span class="koboSpan" id="kobo.1185.1">RPC methods:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1186.1">Unary RPC</span></strong><span class="koboSpan" id="kobo.1187.1">: The client sends a </span><a id="_idIndexMarker1139"/><span class="koboSpan" id="kobo.1188.1">single request message to the server and receives a single response message in return. </span><span class="koboSpan" id="kobo.1188.2">This type of method is suitable for applications that need single </span><span class="No-Break"><span class="koboSpan" id="kobo.1189.1">request-response exchanges.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1190.1">Server streaming RPC</span></strong><span class="koboSpan" id="kobo.1191.1">: The </span><a id="_idIndexMarker1140"/><span class="koboSpan" id="kobo.1192.1">client sends a single request message to the server and the server then responds with a stream of response messages. </span><span class="koboSpan" id="kobo.1192.2">This type of method allows for continuous data exchange between the client </span><span class="No-Break"><span class="koboSpan" id="kobo.1193.1">and server.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1194.1">Client streaming RPC</span></strong><span class="koboSpan" id="kobo.1195.1">: The</span><a id="_idIndexMarker1141"/><span class="koboSpan" id="kobo.1196.1"> client sends a stream request message to the server and the server then responds with a response message. </span><span class="koboSpan" id="kobo.1196.2">Similar to server streaming RPC, this type of method also allows for a continuous data exchange but the data change is initiated by </span><span class="No-Break"><span class="koboSpan" id="kobo.1197.1">the client.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1198.1">Bidirectional streaming RPC</span></strong><span class="koboSpan" id="kobo.1199.1">: The </span><a id="_idIndexMarker1142"/><span class="koboSpan" id="kobo.1200.1">client initiates the process by sending a stream request message, to which the server responds with a stream response message. </span><span class="koboSpan" id="kobo.1200.2">This type of method enables communication between the client and the server to be conducted in </span><span class="No-Break"><span class="koboSpan" id="kobo.1201.1">both directions.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1202.1">Let’s check out these RPC methods one by one. </span><span class="koboSpan" id="kobo.1202.2">The source code for this section can be found in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1203.1">chapter11/GrpcDemo-</span><a id="_idTextAnchor467"/><span class="koboSpan" id="kobo.1204.1">v3</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1205.1"> folder.</span></span></p>
<h2 id="_idParaDest-242"><a id="_idTextAnchor468"/><span class="koboSpan" id="kobo.1206.1">Defining a unary service</span></h2>
<p><span class="koboSpan" id="kobo.1207.1">A </span><a id="_idIndexMarker1143"/><span class="koboSpan" id="kobo.1208.1">unary service is </span><a id="_idIndexMarker1144"/><span class="koboSpan" id="kobo.1209.1">the simplest type of RPC method. </span><span class="koboSpan" id="kobo.1209.2">The following code shows a </span><span class="No-Break"><span class="koboSpan" id="kobo.1210.1">unary service:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1211.1">
message CreateContactRequest {  string first_name = 1;
  string last_name = 2;
  string email = 3;
  string phone = 4;
  int32 year_of_birth = 5;
  bool is_active = 6;
}
message CreateContactResponse {
  string contact_id = 1;
}
service ContactService {
  rpc CreateContact(CreateContactRequest) returns (CreateContactResponse);
}</span></pre>
<p><span class="koboSpan" id="kobo.1212.1">In the </span><a id="_idIndexMarker1145"/><span class="koboSpan" id="kobo.1213.1">preceding code, we define a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1214.1">CreateContactRequest</span></strong><span class="koboSpan" id="kobo.1215.1"> message and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1216.1">CreateContactResponse</span></strong><span class="koboSpan" id="kobo.1217.1"> message, and then we define a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1218.1">ContactService</span></strong><span class="koboSpan" id="kobo.1219.1"> service, which contains a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1220.1">CreateContact()</span></strong><span class="koboSpan" id="kobo.1221.1"> RPC method. </span><span class="koboSpan" id="kobo.1221.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1222.1">CreateContact</span></strong><span class="koboSpan" id="kobo.1223.1"> RPC method requires a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1224.1">CreateContactRequest</span></strong><span class="koboSpan" id="kobo.1225.1"> request message and a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1226.1">CreateContactResponse</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1227.1">response message.</span></span></p>
<p><span class="koboSpan" id="kobo.1228.1">The generated </span><a id="_idIndexMarker1146"/><span class="koboSpan" id="kobo.1229.1">code for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1230.1">CreateContact()</span></strong><span class="koboSpan" id="kobo.1231.1"> RPC method is </span><span class="No-Break"><span class="koboSpan" id="kobo.1232.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1233.1">
public abstract partial class ContactServiceBase{
  public virtual global::System.Threading.Tasks.Task&lt;global::GrpcDemo.CreateContactResponse&gt; CreateContact(global::GrpcDemo.CreateContactRequest request, grpc::ServerCallContext context)
  {
    throw new grpc::RpcException(new grpc::Status(grpc::StatusCode.Unimplemented, ""));
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.1234.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1235.1">ContactServiceBase</span></strong><span class="koboSpan" id="kobo.1236.1"> class is a base class for the service implementation. </span><span class="koboSpan" id="kobo.1236.2">It contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1237.1">CreateContact()</span></strong><span class="koboSpan" id="kobo.1238.1"> method, which is a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1239.1">virtual</span></strong><span class="koboSpan" id="kobo.1240.1"> method. </span><span class="koboSpan" id="kobo.1240.2">By default, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1241.1">CreateContact()</span></strong><span class="koboSpan" id="kobo.1242.1"> method throws an exception because the method is not implemented. </span><span class="koboSpan" id="kobo.1242.2">We need to override this method in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1243.1">service implementation.</span></span></p>
<p><span class="koboSpan" id="kobo.1244.1">Next, create</span><a id="_idIndexMarker1147"/><span class="koboSpan" id="kobo.1245.1"> a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1246.1">ContactService.cs</span></strong><span class="koboSpan" id="kobo.1247.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1248.1">Service</span></strong><span class="koboSpan" id="kobo.1249.1"> folder. </span><span class="koboSpan" id="kobo.1249.2">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1250.1">ContactService.cs</span></strong><span class="koboSpan" id="kobo.1251.1"> file, we need to implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1252.1">ContactService</span></strong><span class="koboSpan" id="kobo.1253.1"> class, which is </span><a id="_idIndexMarker1148"/><span class="koboSpan" id="kobo.1254.1">derived from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1255.1">ContactServiceBase</span></strong><span class="koboSpan" id="kobo.1256.1"> class. </span><span class="koboSpan" id="kobo.1256.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1257.1">ContactService</span></strong><span class="koboSpan" id="kobo.1258.1"> class is </span><span class="No-Break"><span class="koboSpan" id="kobo.1259.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1260.1">
public class ContactService(ILogger&lt;ContactService&gt; logger) : Contact.ContactBase{
    public override Task&lt;CreateContactResponse&gt; CreateContact(CreateContactRequest request, ServerCallContext context)
    {
        // TODO: Save contact to database
        return Task.FromResult(new CreateContactResponse
        {
            ContactId = Guid.NewGuid().ToString()
        });
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.1261.1">In the </span><a id="_idIndexMarker1149"/><span class="koboSpan" id="kobo.1262.1">preceding code, we override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1263.1">CreateContact()</span></strong><span class="koboSpan" id="kobo.1264.1"> method and implement the method. </span><span class="koboSpan" id="kobo.1264.2">This </span><strong class="source-inline"><span class="koboSpan" id="kobo.1265.1">CreateContact()</span></strong><span class="koboSpan" id="kobo.1266.1"> method allows us to execute some logic we need, such as saving the contact to the database. </span><span class="koboSpan" id="kobo.1266.2">For simplicity, we just return a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1267.1">CreateContactResponse</span></strong><span class="koboSpan" id="kobo.1268.1"> object with a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.1269.1">ContactId</span></strong><span class="koboSpan" id="kobo.1270.1"> value. </span><span class="koboSpan" id="kobo.1270.2">In reality, we may have </span><span class="No-Break"><span class="koboSpan" id="kobo.1271.1">additional logic.</span></span></p>
<p><span class="koboSpan" id="kobo.1272.1">Next, we need to register the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1273.1">ContactService</span></strong><span class="koboSpan" id="kobo.1274.1"> class in the DI container. </span><span class="koboSpan" id="kobo.1274.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1275.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1276.1"> file and add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1277.1">ConfigureServices()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1278.1"> method:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1279.1">
app.MapGrpcService&lt;ContactService&gt;();</span></pre> <p><span class="koboSpan" id="kobo.1280.1">Our new </span><a id="_idIndexMarker1150"/><span class="koboSpan" id="kobo.1281.1">unary service simplifies the process of handling HTTP requests, eliminating the need to write any code or manage different HTTP methods. </span><span class="koboSpan" id="kobo.1281.2">All RPC calls are handled by the gRPC framework, allowing for a </span><span class="No-Break"><span class="koboSpan" id="kobo.1282.1">streamlined process.</span></span></p>
<p><span class="koboSpan" id="kobo.1283.1">To call a gRPC service, a gRPC client must be created as current browsers do not support this protocol. </span><span class="koboSpan" id="kobo.1283.2">Alternatively, tools such as Postman can be used to access the service. </span><span class="koboSpan" id="kobo.1283.3">In the following section, we will demonstrate how to create a console application to</span><a id="_idTextAnchor469"/><span class="koboSpan" id="kobo.1284.1"> call </span><span class="No-Break"><span class="koboSpan" id="kobo.1285.1">the service.</span></span></p>
<h2 id="_idParaDest-243"><a id="_idTextAnchor470"/><span class="koboSpan" id="kobo.1286.1">Creating a gRPC client</span></h2>
<p><span class="koboSpan" id="kobo.1287.1">A gRPC can </span><a id="_idIndexMarker1151"/><span class="koboSpan" id="kobo.1288.1">be a console application, a web application, or any other type of application, such as a WPF application. </span><span class="koboSpan" id="kobo.1288.2">In this section, we will create a console application as the gRPC client for the unary service we created in the previous section. </span><span class="koboSpan" id="kobo.1288.3">You can use similar code in other types of applications. </span><span class="koboSpan" id="kobo.1288.4">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1289.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1290.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1291.1">dotnet new</span></strong><span class="koboSpan" id="kobo.1292.1"> command to create a new </span><span class="No-Break"><span class="koboSpan" id="kobo.1293.1">console project:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1294.1">dotnet new console -o GrpcDemo.Client</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1295.1">Now, we have two projects. </span><span class="koboSpan" id="kobo.1295.2">If you have not created a solution file, you can create it by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.1296.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1297.1">dotnet new sln -n GrpcDemo</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1298.1">Then, add the two projects to </span><span class="No-Break"><span class="koboSpan" id="kobo.1299.1">the solution:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1300.1">dotnet sln GrpcDemo.sln add GrpcDemo/GrpcDemo.csproj</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1301.1">dotnet sln GrpcDemo.sln add GrpcDemo.Client/GrpcDemo.Client.csproj</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1302.1">Next, navigate</span><a id="_idIndexMarker1152"/><span class="koboSpan" id="kobo.1303.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1304.1">GrpcDemo.Client</span></strong><span class="koboSpan" id="kobo.1305.1"> folder and add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1306.1">Grpc.Net.Client</span></strong><span class="koboSpan" id="kobo.1307.1"> package to </span><span class="No-Break"><span class="koboSpan" id="kobo.1308.1">the project:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1309.1">cd GrpcDemo.Client</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1310.1">dotnet add GrpcDemo.Client.csproj package Grpc.Net.Client</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1311.1">To use the gRPC tooling to generate the client code, we also need to add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1312.1">following packages:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1313.1">dotnet add GrpcDemo.Client.csproj package Google.Protobuf</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1314.1">dotnet add GrpcDemo.Client.csproj package Grpc.Tools</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1315.1">Please change the project name and path in the preceding commands if you use a different project name </span><span class="No-Break"><span class="koboSpan" id="kobo.1316.1">or path.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.1317.1">The updated </span><strong class="source-inline"><span class="koboSpan" id="kobo.1318.1">GrpcDemo.Client.csproj</span></strong><span class="koboSpan" id="kobo.1319.1"> file contains the </span><span class="No-Break"><span class="koboSpan" id="kobo.1320.1">following code:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1321.1">&lt;ItemGroup&gt;  &lt;PackageReference Include="Grpc.Net.Client" Version="2.55.0" /&gt;  &lt;PackageReference Include="Google.Protobuf" Version="3.22.0-rc2" /&gt;  &lt;PackageReference Include="Grpc.Tools" Version="2.56.0"&gt;    &lt;IncludeAssets&gt;runtime; build; native; contentfiles; analyzers; buildtransitive&lt;/IncludeAssets&gt;    &lt;PrivateAssets&gt;all&lt;/PrivateAssets&gt;  &lt;/PackageReference&gt;&lt;/ItemGroup&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1322.1">As mentioned in the </span><em class="italic"><span class="koboSpan" id="kobo.1323.1">Understanding the gRPC project structure</span></em><span class="koboSpan" id="kobo.1324.1"> section, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1325.1">Grpc.Tools</span></strong><span class="koboSpan" id="kobo.1326.1"> package contains code-generation tooling for gRPC. </span><span class="koboSpan" id="kobo.1326.2">It is a development-time dependency, which means that it is not required at runtime. </span><span class="koboSpan" id="kobo.1326.3">So, we need to add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1327.1">&lt;PrivateAssets&gt;all&lt;/PrivateAssets&gt;</span></strong><span class="koboSpan" id="kobo.1328.1"> element to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1329.1">Grpc.Tools</span></strong><span class="koboSpan" id="kobo.1330.1"> package to ensure that the package is not included in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1331.1">published application.</span></span></p></li> <li><span class="koboSpan" id="kobo.1332.1">Next, copy </span><a id="_idIndexMarker1153"/><span class="koboSpan" id="kobo.1333.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1334.1">Protos</span></strong><span class="koboSpan" id="kobo.1335.1"> folder from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1336.1">GrpcDemo</span></strong><span class="koboSpan" id="kobo.1337.1"> project to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1338.1">GrpcDemo.Client</span></strong><span class="koboSpan" id="kobo.1339.1"> project. </span><span class="koboSpan" id="kobo.1339.2">Then, add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1340.1">GrpcDemo.Client.csproj</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1341.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1342.1">
&lt;ItemGroup&gt;  &lt;Protobuf Include="Protos\greet.proto" GrpcServices="Client" OutputDir="Generated"/&gt;  &lt;Protobuf Include="Protos\invoice.proto" GrpcServices="Client"  OutputDir="Generated"/&gt;  &lt;Protobuf Include="Protos\demo.proto" GrpcServices="Client"  OutputDir="Generated"/&gt;&lt;/ItemGroup&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1343.1">Similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1344.1">GrpcDemo</span></strong><span class="koboSpan" id="kobo.1345.1"> project, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1346.1">Protobuf</span></strong><span class="koboSpan" id="kobo.1347.1"> element to specify the proto files and the output directory. </span><span class="koboSpan" id="kobo.1347.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1348.1">GrpcServices</span></strong><span class="koboSpan" id="kobo.1349.1"> attribute is used to specify the type of the generated code. </span><span class="koboSpan" id="kobo.1349.2">In this case, we use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1350.1">Client</span></strong><span class="koboSpan" id="kobo.1351.1"> because we are creating a </span><span class="No-Break"><span class="koboSpan" id="kobo.1352.1">gRPC client.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.1353.1">When you make changes to the proto files in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1354.1">GrpcDemo</span></strong><span class="koboSpan" id="kobo.1355.1"> project, do not forget to copy the changes to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1356.1">GrpcDemo.Client</span></strong><span class="koboSpan" id="kobo.1357.1"> project to ensure that the client code is up </span><span class="No-Break"><span class="koboSpan" id="kobo.1358.1">to date.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.1359.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1360.1">Generated/Protos</span></strong><span class="koboSpan" id="kobo.1361.1"> folder, you will find the generated code for each proto file. </span><span class="koboSpan" id="kobo.1361.2">For</span><a id="_idIndexMarker1154"/><span class="koboSpan" id="kobo.1362.1"> example, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1363.1">invoice.proto</span></strong><span class="koboSpan" id="kobo.1364.1"> file will generate the </span><span class="No-Break"><span class="koboSpan" id="kobo.1365.1">following files:</span></span></p><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.1366.1">Invoice.cs</span></strong><span class="koboSpan" id="kobo.1367.1">: This file contains the definition of the messages in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1368.1">invoice.proto</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1369.1"> file</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1370.1">InvoiceGrpc.cs</span></strong><span class="koboSpan" id="kobo.1371.1">: This file contains the gRPC client code for the services in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1372.1">invoice.proto</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1373.1"> file</span></span></li></ul></li> <li><span class="koboSpan" id="kobo.1374.1">Next, let’s create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1375.1">InvoiceClient.cs</span></strong><span class="koboSpan" id="kobo.1376.1"> file in the project root folder and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1377.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1378.1">
using Grpc.Net.Client;namespace GrpcDemo.Client;internal class InvoiceClient{    public async Task CreateContactAsync()    {        using var channel = GrpcChannel.ForAddress("http://localhost:5269");        var client = new Contact.ContactClient(channel);        var reply = await client.CreateContactAsync(new CreateContactRequest()        {            Email = "john.doe@abc.com",            FirstName = "John",            LastName = "Doe",            IsActive = true,            Phone = "1234567890",            YearOfBirth = 1980        });        Console.WriteLine("Created Contact: " + reply.ContactId);        Console.ReadKey();    }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1379.1">In the preceding code, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1380.1">GrpcChannel.ForAddress()</span></strong><span class="koboSpan" id="kobo.1381.1"> method to create a gRPC channel, which accepts the address of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1382.1">gRPC server.</span></span></p></li> <li><span class="koboSpan" id="kobo.1383.1">To get the</span><a id="_idIndexMarker1155"/><span class="koboSpan" id="kobo.1384.1"> address of the gRPC server, you can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1385.1">dotnet run</span></strong><span class="koboSpan" id="kobo.1386.1"> command in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1387.1">GrpcDemo</span></strong><span class="koboSpan" id="kobo.1388.1"> project to start the gRPC server. </span><span class="koboSpan" id="kobo.1388.2">The following output shows the address of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1389.1">gRPC server:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1390.1">
info: Microsoft.Hosting.Lifetime[14]      Now listening on: http://localhost:5269info: Microsoft.Hosting.Lifetime[0]      Application started. </span><span class="koboSpan" id="kobo.1390.2">Press Ctrl+C to shut down.info: Microsoft.Hosting.Lifetime[0]      Hosting environment: Development</span></pre></li> <li><span class="koboSpan" id="kobo.1391.1">Alternatively, you can check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1392.1">applicationUrl</span></strong><span class="koboSpan" id="kobo.1393.1"> property in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1394.1">Properties/launchSettings.json</span></strong><span class="koboSpan" id="kobo.1395.1"> file. </span><span class="koboSpan" id="kobo.1395.2">The following code shows the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1396.1">applicationUrl</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1397.1"> property:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1398.1">
{  "$schema": "http://json.schemastore.org/launchsettings.json",  "profiles": {    "http": {      ...      "applicationUrl": "http://localhost:5269",      ...    },    "https": {      ...      "applicationUrl": "https://localhost:7179;http://localhost:5269",      ...    }  }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1399.1">A gRPC </span><a id="_idIndexMarker1156"/><span class="koboSpan" id="kobo.1400.1">channel is used to establish a connection to the gRPC server on the specified address and port. </span><span class="koboSpan" id="kobo.1400.2">Once we have the gRPC channel, we can create an instance of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1401.1">ContactClient</span></strong><span class="koboSpan" id="kobo.1402.1"> class, which is generated from the proto file. </span><span class="koboSpan" id="kobo.1402.2">Then, we call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1403.1">CreateContactAsync()</span></strong><span class="koboSpan" id="kobo.1404.1"> method to create a contact. </span><span class="koboSpan" id="kobo.1404.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1405.1">CreateContactAsync()</span></strong><span class="koboSpan" id="kobo.1406.1"> method accepts a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1407.1">CreateContactRequest</span></strong><span class="koboSpan" id="kobo.1408.1"> object as the parameter. </span><span class="koboSpan" id="kobo.1408.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1409.1">CreateContactAsync()</span></strong><span class="koboSpan" id="kobo.1410.1"> method returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1411.1">CreateContactResponse</span></strong><span class="koboSpan" id="kobo.1412.1"> object, which contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1413.1">ContactId</span></strong><span class="koboSpan" id="kobo.1414.1"> value. </span><span class="koboSpan" id="kobo.1414.2">At the end of the method, we print the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1415.1">ContactId</span></strong><span class="koboSpan" id="kobo.1416.1"> value to </span><span class="No-Break"><span class="koboSpan" id="kobo.1417.1">the console.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.1418.1">This method is straightforward. </span><span class="koboSpan" id="kobo.1418.2">There are a few things </span><span class="No-Break"><span class="koboSpan" id="kobo.1419.1">to note:</span></span></p><ul><li><span class="koboSpan" id="kobo.1420.1">Creating a gRPC channel is an expensive operation. </span><span class="koboSpan" id="kobo.1420.2">So, it is recommended to reuse the gRPC channel. </span><span class="koboSpan" id="kobo.1420.3">However, a gRPC client is a lightweight object, so there is no need to </span><span class="No-Break"><span class="koboSpan" id="kobo.1421.1">reuse it.</span></span></li><li><span class="koboSpan" id="kobo.1422.1">You can create multiple gRPC clients from one gRPC channel, and you can safely use multiple gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.1423.1">clients concurrently.</span></span></li></ul></li> <li><span class="koboSpan" id="kobo.1424.1">To secure the</span><a id="_idIndexMarker1157"/><span class="koboSpan" id="kobo.1425.1"> gRPC channel using TLS, you need to run the gRPC service with HTTPS. </span><span class="koboSpan" id="kobo.1425.2">For example, you can use the following command to run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1426.1">gRPC service:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1427.1">dotnet run --urls=https://localhost:7179</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1428.1">Then, you can use the HTTPS address to create the </span><span class="No-Break"><span class="koboSpan" id="kobo.1429.1">gRPC channel:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1430.1">using var channel = GrpcChannel.ForAddress("https://localhost:7179");</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1431.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1432.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1433.1"> file, call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1434.1">CreateContactAsync()</span></strong><span class="koboSpan" id="kobo.1435.1"> method, </span><span class="No-Break"><span class="koboSpan" id="kobo.1436.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1437.1">
var contactClient = new InvoiceClient();await contactClient.CreateContactAsync();</span></pre></li> <li><span class="koboSpan" id="kobo.1438.1">Run the gRPC server and the gRPC client in different terminals. </span><span class="koboSpan" id="kobo.1438.2">By doing this, you will be able to see the following output in the gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.1439.1">client terminal:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1440.1">Created Contact: 3193c36c-2aab-49a7-a0b1-6bdb3b69dea1</span></strong></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1441.1">This is a simple example of a gRPC client in a console application. </span><span class="koboSpan" id="kobo.1441.2">In the next section, we will create a server streaming service and the c</span><a id="_idTextAnchor471"/><span class="koboSpan" id="kobo.1442.1">orresponding </span><span class="No-Break"><span class="koboSpan" id="kobo.1443.1">gRPC client.</span></span></p>
<h2 id="_idParaDest-244"><a id="_idTextAnchor472"/><span class="koboSpan" id="kobo.1444.1">Defining a server streaming service</span></h2>
<p><span class="koboSpan" id="kobo.1445.1">Similar to a </span><a id="_idIndexMarker1158"/><span class="koboSpan" id="kobo.1446.1">unary service, a server</span><a id="_idIndexMarker1159"/><span class="koboSpan" id="kobo.1447.1"> streaming service has a request message and a response message. </span><span class="koboSpan" id="kobo.1447.2">The difference is that the response message is a stream message. </span><span class="koboSpan" id="kobo.1447.3">Once the server starts to send the stream response message, the client cannot send any more messages to the server, unless the server finishes sending the stream response message or the client cancels the RPC call by </span><span class="No-Break"><span class="koboSpan" id="kobo.1448.1">raising </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1449.1">ServerCallContext.CancellationToken</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1450.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1451.1">The server streaming service is useful when we need to send a stream of data to the client. </span><span class="koboSpan" id="kobo.1451.2">In this case, the server can send multiple messages to the client over a single RPC call. </span><span class="koboSpan" id="kobo.1451.3">Here are some </span><a id="_idIndexMarker1160"/><span class="koboSpan" id="kobo.1452.1">scenarios where a server streaming service </span><span class="No-Break"><span class="koboSpan" id="kobo.1453.1">is useful:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1454.1">Events streaming</span></strong><span class="koboSpan" id="kobo.1455.1">: When the server needs to send a stream of event messages to the client so that the client can process the </span><span class="No-Break"><span class="koboSpan" id="kobo.1456.1">event messages.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1457.1">Real-time data feeds</span></strong><span class="koboSpan" id="kobo.1458.1">: When the server has a continuous stream of data to send to the client, such as stock prices, weather data, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1459.1">so on.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1460.1">File streaming</span></strong><span class="koboSpan" id="kobo.1461.1">: When the server needs to send a large file to the client, the server can split the file into small chunks and send them one by one as a stream response message. </span><span class="koboSpan" id="kobo.1461.2">This can reduce the memory usage on the server and the client because the server and the client do not need to load the entire file </span><span class="No-Break"><span class="koboSpan" id="kobo.1462.1">into memory.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1463.1">The following code shows a server streaming service with the required </span><span class="No-Break"><span class="koboSpan" id="kobo.1464.1">message types:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1465.1">
message GetRandomNumbersRequest {  int32 min = 1;
  int32 max = 2;
  int32 count = 3;
}
message GetRandomNumbersResponse {
  int32 number = 1;
}
service RandomNumbers {
  rpc GetRandomNumbers(GetRandomNumbersRequest) returns (stream GetRandomNumbersResponse);
}</span></pre>
<p><span class="koboSpan" id="kobo.1466.1">In the preceding proto file, we define two messages named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1467.1">GetRandomNumbersRequest</span></strong><span class="koboSpan" id="kobo.1468.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1469.1">GetRandomNumbersResponse</span></strong><span class="koboSpan" id="kobo.1470.1">. </span><span class="koboSpan" id="kobo.1470.2">Then, we define a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1471.1">RandomNumbers</span></strong><span class="koboSpan" id="kobo.1472.1"> service, which contains a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1473.1">GetRandomNumbers()</span></strong><span class="koboSpan" id="kobo.1474.1"> RPC method. </span><span class="koboSpan" id="kobo.1474.2">Note that the response message of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1475.1">GetRandomNumbers</span></strong><span class="koboSpan" id="kobo.1476.1"> RPC method is annotated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1477.1">stream</span></strong><span class="koboSpan" id="kobo.1478.1"> keyword. </span><span class="koboSpan" id="kobo.1478.2">This means that the response message is a </span><span class="No-Break"><span class="koboSpan" id="kobo.1479.1">stream message.</span></span></p>
<p><span class="koboSpan" id="kobo.1480.1">The generated </span><a id="_idIndexMarker1161"/><span class="koboSpan" id="kobo.1481.1">code for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1482.1">GetRandomNumbers()</span></strong><span class="koboSpan" id="kobo.1483.1"> RPC method is </span><span class="No-Break"><span class="koboSpan" id="kobo.1484.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1485.1">
[grpc::BindServiceMethod(typeof(RandomNumbers), "BindService")]public abstract partial class RandomNumbersBase
{
  [global::System.CodeDom.Compiler.GeneratedCode("grpc_csharp_plugin", null)]
  public virtual global::System.Threading.Tasks.Task GetRandomNumbers(global::GrpcDemo.GetRandomNumbersRequest request, grpc::IServerStreamWriter&lt;global::GrpcDemo.GetRandomNumbersResponse&gt; responseStream, grpc::ServerCallContext context)
  {
    throw new grpc::RpcException(new grpc::Status(grpc::StatusCode.Unimplemented, ""));
  }
}</span></pre>
<p><span class="koboSpan" id="kobo.1486.1">In the generated code, we can see that the type of the response message is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1487.1">IServerStreamWriter&lt;GetRandomNumbersResponse&gt;</span></strong><span class="koboSpan" id="kobo.1488.1">. </span><span class="koboSpan" id="kobo.1488.2">Let’s add a simple implementation for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1489.1">RandomNumbers</span></strong><span class="koboSpan" id="kobo.1490.1"> service. </span><span class="koboSpan" id="kobo.1490.2">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1491.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1492.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1493.1">RandomNumbersService.cs</span></strong><span class="koboSpan" id="kobo.1494.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1495.1">Service</span></strong><span class="koboSpan" id="kobo.1496.1"> folder and add the </span><a id="_idIndexMarker1162"/><span class="No-Break"><span class="koboSpan" id="kobo.1497.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1498.1">
public class RandomNumbersService(ILogger&lt;RandomNumbersService&gt; logger) : RandomNumbers.RandomNumbersBase{    public override async Task GetRandomNumbers(GetRandomNumbersRequest request,        IServerStreamWriter&lt;GetRandomNumbersResponse&gt; responseStream, ServerCallContext context)    {        var random = new Random();        for (var i = 0; i &lt; request.Count; i++)        {            await responseStream.WriteAsync(new GetRandomNumbersResponse            {                Number = random.Next(request.Min, request.Max)            });            await Task.Delay(1000);        }    }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1499.1">In the implementation of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1500.1">GetRandomNumbers()</span></strong><span class="koboSpan" id="kobo.1501.1"> method, we use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1502.1">for</span></strong><span class="koboSpan" id="kobo.1503.1"> loop to generate random numbers and send them to the client every second. </span><span class="koboSpan" id="kobo.1503.2">Note that we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1504.1">responseStream.WriteAsync()</span></strong><span class="koboSpan" id="kobo.1505.1"> method to send the stream response message to the client. </span><span class="koboSpan" id="kobo.1505.2">The message finishes sending when the </span><span class="No-Break"><span class="koboSpan" id="kobo.1506.1">loop ends.</span></span></p></li> <li><span class="koboSpan" id="kobo.1507.1">If we need a </span><a id="_idIndexMarker1163"/><span class="koboSpan" id="kobo.1508.1">continuous stream response message, we can check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1509.1">ServerCallContext.CancellationToken</span></strong><span class="koboSpan" id="kobo.1510.1"> property of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1511.1">context</span></strong><span class="koboSpan" id="kobo.1512.1"> parameter. </span><span class="koboSpan" id="kobo.1512.2">If the client cancels the RPC call, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1513.1">ServerCallContext.CancellationToken</span></strong><span class="koboSpan" id="kobo.1514.1"> property will be raised. </span><span class="koboSpan" id="kobo.1514.2">The following code shows how to check the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1515.1">ServerCallContext.CancellationToken</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1516.1"> property:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1517.1">
public override async Task GetRandomNumbers(GetRandomNumbersRequest request,    IServerStreamWriter&lt;GetRandomNumbersResponse&gt; responseStream, ServerCallContext context){    var random = new Random();    while (!context.CancellationToken.IsCancellationRequested)    {        await responseStream.WriteAsync(new GetRandomNumbersResponse        {            Number = random.Next(request.Min, request.Max)        });        await Task.Delay(1000, context.CancellationToken);    }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1518.1">In the preceding code, we use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1519.1">while</span></strong><span class="koboSpan" id="kobo.1520.1"> loop to check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1521.1">ServerCallContext.CancellationToken</span></strong><span class="koboSpan" id="kobo.1522.1"> property. </span><span class="koboSpan" id="kobo.1522.2">If the client cancels the RPC call, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1523.1">ServerCallContext.CancellationToken</span></strong><span class="koboSpan" id="kobo.1524.1"> property will be raised, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1525.1">while</span></strong><span class="koboSpan" id="kobo.1526.1"> loop will end. </span><span class="koboSpan" id="kobo.1526.2">If there are any other asynchronous operations in the method, we can pass the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1527.1">ServerCallContext.CancellationToken</span></strong><span class="koboSpan" id="kobo.1528.1"> property to the asynchronous operations. </span><span class="koboSpan" id="kobo.1528.2">This can ensure that the asynchronous operations will be canceled when the client cancels the </span><span class="No-Break"><span class="koboSpan" id="kobo.1529.1">RPC call.</span></span></p></li> <li><span class="koboSpan" id="kobo.1530.1">Next, we</span><a id="_idIndexMarker1164"/><span class="koboSpan" id="kobo.1531.1"> will register the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1532.1">RandomNumbersService</span></strong><span class="koboSpan" id="kobo.1533.1"> class in the DI  container. </span><span class="koboSpan" id="kobo.1533.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1534.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1535.1"> file and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1536.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1537.1">
app.MapGrpcService&lt;RandomNumbersService&gt;();</span></pre></li> <li><span class="koboSpan" id="kobo.1538.1">Next, we will create a gRPC client to call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1539.1">GetRandomNumbers()</span></strong><span class="koboSpan" id="kobo.1540.1"> RPC method. </span><span class="koboSpan" id="kobo.1540.2">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1541.1">RandomNumbersClient.cs</span></strong><span class="koboSpan" id="kobo.1542.1"> file in the project root folder and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1543.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1544.1">
internal class ServerStreamingClient{    public async Task GetRandomNumbers()    {        using var channel = GrpcChannel.ForAddress("https://localhost:7179");        var client = new RandomNumbers.RandomNumbersClient(channel);        var reply = client.GetRandomNumbers(new GetRandomNumbersRequest()        {            Count = 100,            Max = 100,            Min = 1        });        await foreach (var number in reply.ResponseStream.ReadAllAsync())        {            Console.WriteLine(number.Number);        }        Console.ReadKey();    }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1545.1">The code</span><a id="_idIndexMarker1165"/><span class="koboSpan" id="kobo.1546.1"> to create the client is similar to that of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1547.1">InvoiceClient</span></strong><span class="koboSpan" id="kobo.1548.1">, which we introduced in the </span><em class="italic"><span class="koboSpan" id="kobo.1549.1">Creating a gRPC client</span></em><span class="koboSpan" id="kobo.1550.1"> section. </span><span class="koboSpan" id="kobo.1550.2">The only difference is in the response message, which is handled using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1551.1">await foreach</span></strong><span class="koboSpan" id="kobo.1552.1"> statement. </span><span class="koboSpan" id="kobo.1552.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1553.1">ReadAllAsync()</span></strong><span class="koboSpan" id="kobo.1554.1"> method returns an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1555.1">IAsyncEnumerable&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.1556.1"> object, which can be iterated over using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1557.1">await </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1558.1">foreach</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1559.1"> statement.</span></span></p></li> <li><span class="koboSpan" id="kobo.1560.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1561.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1562.1"> file of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1563.1">GrpcDemo.Client</span></strong><span class="koboSpan" id="kobo.1564.1"> project, call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1565.1">GetRandomNumbers()</span></strong><span class="koboSpan" id="kobo.1566.1"> method, </span><span class="No-Break"><span class="koboSpan" id="kobo.1567.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1568.1">
var serverStreamingClient = new ServerStreamingClient();await serverStreamingClient.GetRandomNumbers();</span></pre></li> <li><span class="koboSpan" id="kobo.1569.1">Run the gRPC server and the gRPC client in different terminals. </span><span class="koboSpan" id="kobo.1569.2">You will see that the output contains a series of </span><span class="No-Break"><span class="koboSpan" id="kobo.1570.1">random numbers.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.1571.1">This is an example of a server streaming service and the corresponding gRPC client. </span><span class="koboSpan" id="kobo.1571.2">In the next section, we will create a client streaming service a</span><a id="_idTextAnchor473"/><span class="koboSpan" id="kobo.1572.1">nd the corresponding </span><span class="No-Break"><span class="koboSpan" id="kobo.1573.1">gRPC client.</span></span></p>
<h2 id="_idParaDest-245"><a id="_idTextAnchor474"/><span class="koboSpan" id="kobo.1574.1">Defining a client streaming service</span></h2>
<p><span class="koboSpan" id="kobo.1575.1">A</span><a id="_idIndexMarker1166"/><span class="koboSpan" id="kobo.1576.1"> client streaming service allows the</span><a id="_idIndexMarker1167"/><span class="koboSpan" id="kobo.1577.1"> client to send a stream of messages to the server over a single request. </span><span class="koboSpan" id="kobo.1577.2">The server then sends a single response message to the client when it finishes processing the stream request messages. </span><span class="koboSpan" id="kobo.1577.3">Once the server sends the response message, the client streaming call </span><span class="No-Break"><span class="koboSpan" id="kobo.1578.1">is complete.</span></span></p>
<p><span class="koboSpan" id="kobo.1579.1">Here are some scenarios where a</span><a id="_idIndexMarker1168"/><span class="koboSpan" id="kobo.1580.1"> client streaming service </span><span class="No-Break"><span class="koboSpan" id="kobo.1581.1">is useful:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1582.1">File uploading</span></strong><span class="koboSpan" id="kobo.1583.1">: When the client uploads a large file to the server, the client can split the file into small chunks and send them one by one as a stream request message, which can be more efficient than sending the entire file in a </span><span class="No-Break"><span class="koboSpan" id="kobo.1584.1">single request.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1585.1">Real-time data capture</span></strong><span class="koboSpan" id="kobo.1586.1">: When the client needs to send a stream of data to the server, such as sensor data, user interactions, or any continuous stream of data, the server can process the data and respond to the batch </span><span class="No-Break"><span class="koboSpan" id="kobo.1587.1">of data.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1588.1">Data aggregation</span></strong><span class="koboSpan" id="kobo.1589.1">: When the client needs to send a batch of data to the server for aggregation </span><span class="No-Break"><span class="koboSpan" id="kobo.1590.1">or analysis.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1591.1">To define a client streaming service, we need to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1592.1">stream</span></strong><span class="koboSpan" id="kobo.1593.1"> keyword to annotate the request message. </span><span class="koboSpan" id="kobo.1593.2">The following code shows a client streaming service with the required </span><span class="No-Break"><span class="koboSpan" id="kobo.1594.1">message types:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1595.1">
message SendRandomNumbersRequest {  int32 number = 1;
}
message SendRandomNumbersResponse {
  int32 count = 1;
  int32 sum = 2;
}
service RandomNumbers {
  rpc SendRandomNumbers(stream SendRandomNumbersRequest) returns (SendRandomNumbersResponse);
}</span></pre>
<p><span class="koboSpan" id="kobo.1596.1">The</span><a id="_idIndexMarker1169"/><span class="koboSpan" id="kobo.1597.1"> preceding </span><strong class="source-inline"><span class="koboSpan" id="kobo.1598.1">.proto</span></strong><span class="koboSpan" id="kobo.1599.1"> file defines two messages: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1600.1">SendRandomNumbersRequest</span></strong><span class="koboSpan" id="kobo.1601.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1602.1">SendRandomNumbersResponse</span></strong><span class="koboSpan" id="kobo.1603.1">. </span><span class="koboSpan" id="kobo.1603.2">The client sends a stream message containing a series of numbers to the server. </span><span class="koboSpan" id="kobo.1603.3">The server then processes the stream message and calculates the sum of the numbers. </span><span class="koboSpan" id="kobo.1603.4">Finally, the server sends a response message to the client, which contains the count of the numbers and the sum of the numbers. </span><span class="koboSpan" id="kobo.1603.5">It is important to note that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1604.1">SendRandomNumbers()</span></strong><span class="koboSpan" id="kobo.1605.1"> RPC method is annotated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1606.1">stream</span></strong><span class="koboSpan" id="kobo.1607.1"> keyword, indicating that the request message is a </span><span class="No-Break"><span class="koboSpan" id="kobo.1608.1">stream message.</span></span></p>
<p><span class="koboSpan" id="kobo.1609.1">Similar to the server streaming service, we can implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1610.1">SendRandomNumbers()</span></strong><span class="koboSpan" id="kobo.1611.1"> method, </span><span class="No-Break"><span class="koboSpan" id="kobo.1612.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1613.1">
public override async Task&lt;SendRandomNumbersResponse&gt; SendRandomNumbers(IAsyncStreamReader&lt;SendRandomNumbersRequest&gt; requestStream, ServerCallContext context){
    var count = 0;
    var sum = 0;
    await foreach (var request in requestStream.ReadAllAsync())
    {
        _logger.LogInformation($"Received: {request.Number}");
        count++;
        sum += request.Number;
    }
    return new SendRandomNumbersResponse
    {
        Count = count,
        Sum = sum
    };
}</span></pre>
<p><span class="koboSpan" id="kobo.1614.1">We utilize the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1615.1">IAsyncStreamReader&lt;T&gt;.ReadAllAsync()</span></strong><span class="koboSpan" id="kobo.1616.1"> method in the preceding code to read all the stream request messages from the client. </span><span class="koboSpan" id="kobo.1616.2">Subsequently, we use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1617.1">await foreach</span></strong><span class="koboSpan" id="kobo.1618.1"> to iterate over the stream request messages. </span><span class="koboSpan" id="kobo.1618.2">Lastly, we compute the count and sum of the numbers and return a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1619.1">SendRandomNumbersResponse</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1620.1"> object.</span></span></p>
<p><span class="koboSpan" id="kobo.1621.1">To </span><a id="_idIndexMarker1170"/><span class="koboSpan" id="kobo.1622.1">consume the client streaming service, we will copy the proto files from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1623.1">GrpcDemo</span></strong><span class="koboSpan" id="kobo.1624.1"> project to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1625.1">GrpcDemo.Client</span></strong><span class="koboSpan" id="kobo.1626.1"> project. </span><span class="koboSpan" id="kobo.1626.2">Then, we will create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1627.1">ClientStreamingClient</span></strong><span class="koboSpan" id="kobo.1628.1"> class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1629.1">GrpcDemo.Client</span></strong><span class="koboSpan" id="kobo.1630.1"> project and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1631.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1632.1">
internal class ClientStreamingClient{
    public async Task SendRandomNumbers()
    {
        using var channel = GrpcChannel.ForAddress("https://localhost:7179");
        var client = new RandomNumbers.RandomNumbersClient(channel);
        // Create a streaming request
        using var clientStreamingCall = client.SendRandomNumbers();
        var random = new Random();
        for (var i = 0; i &lt; 20; i++)
        {
            await clientStreamingCall.RequestStream.WriteAsync(new SendRandomNumbersRequest
            {
                Number = random.Next(1, 100)
            });
            await Task.Delay(1000);
        }
        await clientStreamingCall.RequestStream.CompleteAsync();
        // Get the response
        var response = await clientStreamingCall;
        Console.WriteLine($"Count: {response.Count}, Sum: {response.Sum}");
        Console.ReadKey();
    }
}</span></pre>
<p><span class="koboSpan" id="kobo.1633.1">In </span><a id="_idIndexMarker1171"/><span class="koboSpan" id="kobo.1634.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1635.1">SendRandomNumbers()</span></strong><span class="koboSpan" id="kobo.1636.1"> method, we create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1637.1">AsyncClientStreamingCall</span></strong><span class="koboSpan" id="kobo.1638.1"> object by calling the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1639.1">SendRandomNumbers()</span></strong><span class="koboSpan" id="kobo.1640.1"> method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1641.1">RandomNumbersClient</span></strong><span class="koboSpan" id="kobo.1642.1"> class. </span><span class="koboSpan" id="kobo.1642.2">Note that the client streaming call starts when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1643.1">SendRandomNumbers()</span></strong><span class="koboSpan" id="kobo.1644.1"> method is called, but the client does not send any messages until the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1645.1">RequestStream.CompleteAsync()</span></strong><span class="koboSpan" id="kobo.1646.1"> method is called. </span><span class="koboSpan" id="kobo.1646.2">In a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1647.1">for</span></strong><span class="koboSpan" id="kobo.1648.1"> loop, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1649.1">RequestStream.WriteAsync()</span></strong><span class="koboSpan" id="kobo.1650.1"> method to send the stream request message to the server. </span><span class="koboSpan" id="kobo.1650.2">At the end of the method, we call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1651.1">RequestStream.CompleteAsync()</span></strong><span class="koboSpan" id="kobo.1652.1"> method to indicate that the stream request message is complete. </span><span class="koboSpan" id="kobo.1652.2">The stream request message contains 20 numbers, which are </span><span class="No-Break"><span class="koboSpan" id="kobo.1653.1">generated randomly.</span></span></p>
<p><span class="koboSpan" id="kobo.1654.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1655.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1656.1"> file of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1657.1">GrpcDemo.Client</span></strong><span class="koboSpan" id="kobo.1658.1"> project, we then call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1659.1">SendRandomNumbers()</span></strong><span class="koboSpan" id="kobo.1660.1"> method, </span><span class="No-Break"><span class="koboSpan" id="kobo.1661.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1662.1">
var clientStreamingClient = new ClientStreamingClient();await clientStreamingClient.SendRandomNumbers();</span></pre>
<p><span class="koboSpan" id="kobo.1663.1">Run the </span><a id="_idIndexMarker1172"/><span class="koboSpan" id="kobo.1664.1">gRPC server and the gRPC client in different terminals. </span><span class="koboSpan" id="kobo.1664.2">After around 20 seconds, you will see the following output in the gRPC client terminal (the sum may </span><span class="No-Break"><span class="koboSpan" id="kobo.1665.1">be different):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1666.1">
Count: 20, Sum: 1000</span></pre> <p><span class="koboSpan" id="kobo.1667.1">With that, we’ve learned how to create a client streaming service and the corresponding gRPC client. </span><span class="koboSpan" id="kobo.1667.2">In the next section, we will create a bidirectional streaming se</span><a id="_idTextAnchor475"/><span class="koboSpan" id="kobo.1668.1">rvice and the corresponding </span><span class="No-Break"><span class="koboSpan" id="kobo.1669.1">gRPC client.</span></span></p>
<h2 id="_idParaDest-246"><a id="_idTextAnchor476"/><span class="koboSpan" id="kobo.1670.1">Defining a bidirectional streaming service</span></h2>
<p><span class="koboSpan" id="kobo.1671.1">A</span><a id="_idIndexMarker1173"/><span class="koboSpan" id="kobo.1672.1"> bidirectional streaming </span><a id="_idIndexMarker1174"/><span class="koboSpan" id="kobo.1673.1">service allows the client and the server to send a stream of messages to each other over a single request concurrently. </span><span class="koboSpan" id="kobo.1673.2">Once the connection has been established, the client and the server can send messages to each other at any time in any order because the two streams are independent. </span><span class="koboSpan" id="kobo.1673.3">For example, the server can respond to each message from the client, or the server can send a response message after receiving a series of messages from </span><span class="No-Break"><span class="koboSpan" id="kobo.1674.1">the client.</span></span></p>
<p><span class="koboSpan" id="kobo.1675.1">Here are some scenarios </span><a id="_idIndexMarker1175"/><span class="koboSpan" id="kobo.1676.1">where a bidirectional streaming service </span><span class="No-Break"><span class="koboSpan" id="kobo.1677.1">is useful:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1678.1">Chat applications</span></strong><span class="koboSpan" id="kobo.1679.1">: When the client and the server need to send instant messages to </span><span class="No-Break"><span class="koboSpan" id="kobo.1680.1">each other</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1681.1">Real-time data dashboard</span></strong><span class="koboSpan" id="kobo.1682.1">: When the client continuously sends data to the server and the server builds a real-time dashboard to display </span><span class="No-Break"><span class="koboSpan" id="kobo.1683.1">the data</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1684.1">Multiplayer games</span></strong><span class="koboSpan" id="kobo.1685.1">: When the players need to interact with each other in real-time and the server needs to synchronize the game state between </span><span class="No-Break"><span class="koboSpan" id="kobo.1686.1">the players</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1687.1">Let’s define </span><a id="_idIndexMarker1176"/><span class="koboSpan" id="kobo.1688.1">a bidirectional streaming service. </span><span class="koboSpan" id="kobo.1688.2">In this example, the client sends some sentences to the server and the server responds to each sentence with the uppercase version </span><a id="_idIndexMarker1177"/><span class="koboSpan" id="kobo.1689.1">of the sentence. </span><span class="koboSpan" id="kobo.1689.2">The following code shows the required </span><span class="No-Break"><span class="koboSpan" id="kobo.1690.1">message types:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1691.1">
message ChatMessage {  string sender = 1;
  string message = 1;
}
service Chat {
  rpc SendMessage(stream ChatMessage) returns (stream ChatMessage);
}</span></pre>
<p><span class="koboSpan" id="kobo.1692.1">In the preceding proto file, we have defined a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1693.1">ChatMessage</span></strong><span class="koboSpan" id="kobo.1694.1"> message containing two fields: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1695.1">sender</span></strong><span class="koboSpan" id="kobo.1696.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1697.1">message</span></strong><span class="koboSpan" id="kobo.1698.1">. </span><span class="koboSpan" id="kobo.1698.2">Additionally, we have defined a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1699.1">Chat</span></strong><span class="koboSpan" id="kobo.1700.1"> service with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1701.1">SendMessage</span></strong><span class="koboSpan" id="kobo.1702.1"> RPC method. </span><span class="koboSpan" id="kobo.1702.2">It is important to note that both the request and response of this method are annotated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1703.1">stream</span></strong><span class="koboSpan" id="kobo.1704.1"> keyword, indicating that they are both </span><span class="No-Break"><span class="koboSpan" id="kobo.1705.1">stream messages.</span></span></p>
<p><span class="koboSpan" id="kobo.1706.1">Now, we can implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1707.1">SendMessage()</span></strong><span class="koboSpan" id="kobo.1708.1"> method. </span><span class="koboSpan" id="kobo.1708.2">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1709.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1710.1">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1711.1">ChatService.cs</span></strong><span class="koboSpan" id="kobo.1712.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1713.1">Service</span></strong><span class="koboSpan" id="kobo.1714.1"> folder and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1715.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1716.1">
public class ChatService(ILogger&lt;ChatService&gt; logger) : Chat.ChatBase{    public override async Task SendMessage(IAsyncStreamReader&lt;ChatMessage&gt; requestStream, IServerStreamWriter&lt;ChatMessage&gt; responseStream, ServerCallContext context)    {        await foreach (var request in requestStream.ReadAllAsync())        {            logger.LogInformation($"Received: {request.Message}");            await responseStream.WriteAsync(new ChatMessage            {                Message = $"You said: {request.Message.ToUpper()}"            });        }    }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1717.1">Here, we</span><a id="_idIndexMarker1178"/><span class="koboSpan" id="kobo.1718.1"> utilize the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1719.1">await foreach</span></strong><span class="koboSpan" id="kobo.1720.1"> method to iterate over the stream request messages. </span><span class="koboSpan" id="kobo.1720.2">For each request message, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1721.1">WriteAsync()</span></strong><span class="koboSpan" id="kobo.1722.1"> method to send a response message back to the client. </span><span class="koboSpan" id="kobo.1722.2">This response message contains the uppercase version of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1723.1">request message.</span></span></p></li> <li><span class="koboSpan" id="kobo.1724.1">Next, register the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1725.1">ChatService</span></strong><span class="koboSpan" id="kobo.1726.1"> class in the dependency injection container. </span><span class="koboSpan" id="kobo.1726.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1727.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1728.1"> file and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1729.1">following code:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1730.1">app.MapGrpcService&lt;ChatService&gt;();</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1731.1">Copy the proto files from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1732.1">GrpcDemo</span></strong><span class="koboSpan" id="kobo.1733.1"> project to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1734.1">GrpcDemo.Client</span></strong><span class="koboSpan" id="kobo.1735.1"> project. </span><span class="koboSpan" id="kobo.1735.2">Then, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1736.1">BidirectionalStreamingClient</span></strong><span class="koboSpan" id="kobo.1737.1"> class in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1738.1">GrpcDemo.Client</span></strong><span class="koboSpan" id="kobo.1739.1"> project and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1740.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1741.1">
internal class BidirectionalStreamingClient{    public async Task SendMessage()    {        using var channel = GrpcChannel.ForAddress("https://localhost:7179");        var client = new Chat.ChatClient(channel);        // Create a streaming request        using var streamingCall = client.SendMessage();        Console.WriteLine("Starting a background task to receive messages...");        var responseReaderTask = Task.Run(async () =&gt;        {            await foreach (var response in streamingCall.ResponseStream.ReadAllAsync())            {                Console.WriteLine(response.Message);            }        });        Console.WriteLine("Starting to send messages...");        Console.WriteLine("Input your message then press enter to send it.");        while (true)        {            var message = Console.ReadLine();            if (string.IsNullOrWhiteSpace(message))            {                break;            }            await streamingCall.RequestStream.WriteAsync(new ChatMessage            {                Message = message            });        }        Console.WriteLine("Disconnecting...");        await streamingCall.RequestStream.CompleteAsync();        await responseReaderTask;    }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1742.1">Because we</span><a id="_idIndexMarker1179"/><span class="koboSpan" id="kobo.1743.1"> use a console application to call the bidirectional streaming service, we need to use a background task to read the stream response messages. </span><span class="koboSpan" id="kobo.1743.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1744.1">ReadAllAsync()</span></strong><span class="koboSpan" id="kobo.1745.1"> method returns an </span><strong class="source-inline"><span class="koboSpan" id="kobo.1746.1">IAsyncEnumerable&lt;T&gt;</span></strong><span class="koboSpan" id="kobo.1747.1"> object, which can be iterated over using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1748.1">await foreach</span></strong><span class="koboSpan" id="kobo.1749.1"> statement. </span><span class="koboSpan" id="kobo.1749.2">In the background task, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1750.1">await foreach</span></strong><span class="koboSpan" id="kobo.1751.1"> statement to iterate over the stream response messages and print them to </span><span class="No-Break"><span class="koboSpan" id="kobo.1752.1">the console.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.1753.1">Additionally, we use a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1754.1">while</span></strong><span class="koboSpan" id="kobo.1755.1"> loop to read the input from the console and send the stream request messages to the server in the main thread. </span><span class="koboSpan" id="kobo.1755.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1756.1">while</span></strong><span class="koboSpan" id="kobo.1757.1"> loop ends when the user enters an empty string. </span><span class="koboSpan" id="kobo.1757.2">At the end of the method, we call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1758.1">RequestStream.CompleteAsync()</span></strong><span class="koboSpan" id="kobo.1759.1"> method to indicate that the stream request message is complete so that the server can finish processing the stream request </span><span class="No-Break"><span class="koboSpan" id="kobo.1760.1">messages gracefully.</span></span></p></li> <li><span class="koboSpan" id="kobo.1761.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1762.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1763.1"> file of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1764.1">GrpcDemo.Client</span></strong><span class="koboSpan" id="kobo.1765.1"> project, call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1766.1">SendMessage()</span></strong><span class="koboSpan" id="kobo.1767.1"> method, </span><span class="No-Break"><span class="koboSpan" id="kobo.1768.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1769.1">
var bidirectionalStreamingClient = new BidirectionalStreamingClient();await bidirectionalStreamingClient.SendMessage();</span></pre></li> <li><span class="koboSpan" id="kobo.1770.1">Run the </span><a id="_idIndexMarker1180"/><span class="koboSpan" id="kobo.1771.1">gRPC server and the gRPC client in different terminals. </span><span class="koboSpan" id="kobo.1771.2">You will see the following output in the gRPC </span><span class="No-Break"><span class="koboSpan" id="kobo.1772.1">client terminal:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1773.1">
Hello, World!Starting background task to receive messages...Starting to send messages...Input your message then press enter to send it.How are you?You said: HOW ARE YOU?What is ASP.NET Core?You said: WHAT IS ASP.NET CORE?Disconnecting...</span></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1774.1">This example is a simple demonstration of a bidirectional streaming service and the corresponding gRPC client. </span><span class="koboSpan" id="kobo.1774.2">The bidirectional streaming service allows the client and the server to send a stream of messages to each other at any time in any order. </span><span class="koboSpan" id="kobo.1774.3">In the preceding example, the service responds to each message from the client. </span><span class="koboSpan" id="kobo.1774.4">However, using similar code, we can implement more complex logic per </span><span class="No-Break"><span class="koboSpan" id="kobo.1775.1">the requirements.</span></span></p>
<p><span class="koboSpan" id="kobo.1776.1">We have now explored four types of gRPC services: unary, server streaming, client streaming, and bidirectional streaming. </span><span class="koboSpan" id="kobo.1776.2">We have also learned how to create a gRPC client to call each of these gRPC services. </span><span class="koboSpan" id="kobo.1776.3">In the next section, we will learn how to</span><a id="_idTextAnchor477"/><span class="koboSpan" id="kobo.1777.1"> use gRPC services in ASP.NET </span><span class="No-Break"><span class="koboSpan" id="kobo.1778.1">Core applications.</span></span></p>
<h1 id="_idParaDest-247"><a id="_idTextAnchor478"/><span class="koboSpan" id="kobo.1779.1">Consuming gRPC services in ASP.NET Core applications</span></h1>
<p><span class="koboSpan" id="kobo.1780.1">In the </span><a id="_idIndexMarker1181"/><span class="koboSpan" id="kobo.1781.1">previous section, we learned how to create console applications to consume gRPC services. </span><span class="koboSpan" id="kobo.1781.2">In this section, we</span><a id="_idIndexMarker1182"/><span class="koboSpan" id="kobo.1782.1"> will integrate gRPC services into ASP.NET Core applications. </span><span class="koboSpan" id="kobo.1782.2">We will reuse the gRPC services we created in the previous section, and we will create a new ASP.NET Core application to consume the </span><span class="No-Break"><span class="koboSpan" id="kobo.1783.1">gRPC services.</span></span></p>
<p><span class="koboSpan" id="kobo.1784.1">To get started with the steps outlined in this section, begin with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1785.1">GrpcDemo-v3</span></strong><span class="koboSpan" id="kobo.1786.1"> folder of the source code. </span><span class="koboSpan" id="kobo.1786.2">The complete code for this section can be found in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1787.1">GrpcDemo-v4</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1788.1"> folder.</span></span></p>
<p><span class="koboSpan" id="kobo.1789.1">In the console applications, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1790.1">GrpcChannel</span></strong><span class="koboSpan" id="kobo.1791.1"> class to create a gRPC channel, after which we used the gRPC channel to create a gRPC client, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1792.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1793.1">
using var channel = GrpcChannel.ForAddress("https://localhost:7179");var client = new Contact.ContactClient(channel);</span></pre>
<p><span class="koboSpan" id="kobo.1794.1">In ASP.NET Core applications, a better way to create a gRPC client is to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1795.1">IHttpClientFactory</span></strong><span class="koboSpan" id="kobo.1796.1"> interface with dependency injection. </span><span class="koboSpan" id="kobo.1796.2">Let’s see how to use the DI container to create a </span><span class="No-Break"><span class="koboSpan" id="kobo.1797.1">gRPC client:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1798.1">First, we must create a new ASP.NET Core application. </span><span class="koboSpan" id="kobo.1798.2">In this ASP.NET Core application, we will create a REST API to consume the gRPC services we created in the previous section. </span><span class="koboSpan" id="kobo.1798.3">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1799.1">dotnet new</span></strong><span class="koboSpan" id="kobo.1800.1"> command to create a new ASP.NET </span><span class="No-Break"><span class="koboSpan" id="kobo.1801.1">Core application:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1802.1">dotnet new webapi -o GrpcDemo.Api -controllers</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1803.1">Then, add this project to </span><span class="No-Break"><span class="koboSpan" id="kobo.1804.1">the solution:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1805.1">dotnet sln GrpcDemo.sln add GrpcDemo.Api/GrpcDemo.Api.csproj</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1806.1">Next, add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1807.1">Grpc.Net.ClientFactory</span></strong><span class="koboSpan" id="kobo.1808.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1809.1">Grpc.Tools</span></strong><span class="koboSpan" id="kobo.1810.1"> packages to </span><span class="No-Break"><span class="koboSpan" id="kobo.1811.1">the </span></span><span class="No-Break"><a id="_idIndexMarker1183"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1812.1">project:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1813.1">cd GrpcDemo.Api</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1814.1">dotnet add GrpcDemo.Api.csproj package Grpc.Net.ClientFactory</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1815.1">dotnet add GrpcDemo.Api.csproj package Grpc.Tools</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1816.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1817.1">Grpc.Net.ClientFactory</span></strong><span class="koboSpan" id="kobo.1818.1"> package allows developers to create a gRPC client using a dependency injection container, eliminating the need for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1819.1">new</span></strong><span class="koboSpan" id="kobo.1820.1"> keyword. </span><span class="koboSpan" id="kobo.1820.2">Additionally, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1821.1">Grpc.Tools</span></strong><span class="koboSpan" id="kobo.1822.1"> package can be used to generate gRPC client code from </span><span class="No-Break"><span class="koboSpan" id="kobo.1823.1">proto files.</span></span></p></li> <li><span class="koboSpan" id="kobo.1824.1">Then, copy </span><a id="_idIndexMarker1184"/><span class="koboSpan" id="kobo.1825.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1826.1">Protos</span></strong><span class="koboSpan" id="kobo.1827.1"> folder from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1828.1">GrpcDemo</span></strong><span class="koboSpan" id="kobo.1829.1"> project to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1830.1">GrpcDemo.Api</span></strong><span class="koboSpan" id="kobo.1831.1"> project. </span><span class="koboSpan" id="kobo.1831.2">Next, add the following code to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1832.1">GrpcDemo.Api.csproj</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1833.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1834.1">
&lt;ItemGroup&gt;  &lt;Protobuf Include="Protos\greet.proto" GrpcServices="Client" OutputDir="Generated"/&gt;  &lt;Protobuf Include="Protos\invoice.proto" GrpcServices="Client"  OutputDir="Generated"/&gt;  &lt;Protobuf Include="Protos\demo.proto" GrpcServices="Client"  OutputDir="Generated"/&gt;&lt;/ItemGroup&gt;</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1835.1">Similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1836.1">GrpcDemo.Client</span></strong><span class="koboSpan" id="kobo.1837.1"> project, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1838.1">GrpcServices="Client"</span></strong><span class="koboSpan" id="kobo.1839.1"> attribute to specify the type of the generated code. </span><span class="koboSpan" id="kobo.1839.2">In this case, we use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1840.1">Client</span></strong><span class="koboSpan" id="kobo.1841.1"> because we will create a gRPC client to consume the gRPC services in the ASP.NET </span><span class="No-Break"><span class="koboSpan" id="kobo.1842.1">Core application.</span></span></p></li> <li><span class="koboSpan" id="kobo.1843.1">Next, we</span><a id="_idIndexMarker1185"/><span class="koboSpan" id="kobo.1844.1"> can register the gRPC client in the DI container. </span><span class="koboSpan" id="kobo.1844.2">Open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1845.1">Program.cs</span></strong><span class="koboSpan" id="kobo.1846.1"> file and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1847.1">following code:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1848.1">builder.Services.AddGrpcClient&lt;Contact.ContactClient&gt;(x =&gt; x.Address = new Uri("https://localhost:7179"));</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1849.1">Note that the address of the gRPC server is hardcoded in the preceding code for simplicity. </span><span class="koboSpan" id="kobo.1849.2">In a real-world application, we should use a configuration file to store the address of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1850.1">gRPC server.</span></span></p></li> <li><span class="koboSpan" id="kobo.1851.1">Next, we</span><a id="_idIndexMarker1186"/><span class="koboSpan" id="kobo.1852.1"> must create a controller to consume the gRPC services. </span><span class="koboSpan" id="kobo.1852.2">Create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1853.1">ContactController.cs</span></strong><span class="koboSpan" id="kobo.1854.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1855.1">Controllers</span></strong><span class="koboSpan" id="kobo.1856.1"> folder and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1857.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1858.1">
[ApiController][Route("[controller]")]public class ContactController(Contact.ContactClient client, ILogger&lt;ContactController&gt; logger) : ControllerBase{    [HttpPost]    public async Task&lt;IActionResult&gt; CreateContact(CreateContactRequest request)    {        var reply = await _client.CreateContactAsync(request);        return Ok(reply);    }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1859.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1860.1">ContactController</span></strong><span class="koboSpan" id="kobo.1861.1"> class, we use dependency injection to inject the gRPC client, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1862.1">ContactClient</span></strong><span class="koboSpan" id="kobo.1863.1">, which is generated from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1864.1">demo.proto</span></strong><span class="koboSpan" id="kobo.1865.1"> file. </span><span class="koboSpan" id="kobo.1865.2">Then, we create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1866.1">CreateContact</span></strong><span class="koboSpan" id="kobo.1867.1"> action method to call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1868.1">CreateContactAsync()</span></strong><span class="koboSpan" id="kobo.1869.1"> method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1870.1">ContactClient</span></strong><span class="koboSpan" id="kobo.1871.1"> class. </span><span class="koboSpan" id="kobo.1871.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1872.1">CreateContactAsync()</span></strong><span class="koboSpan" id="kobo.1873.1"> method accepts a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1874.1">CreateContactRequest</span></strong><span class="koboSpan" id="kobo.1875.1"> object as the parameter, which is also generated from the proto file. </span><span class="koboSpan" id="kobo.1875.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1876.1">CreateContactAsync()</span></strong><span class="koboSpan" id="kobo.1877.1"> method returns a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1878.1">CreateContactResponse</span></strong><span class="koboSpan" id="kobo.1879.1"> object, which contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1880.1">ContactId</span></strong><span class="koboSpan" id="kobo.1881.1"> value. </span><span class="koboSpan" id="kobo.1881.2">At the end of the method, we return the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1882.1">ContactId</span></strong><span class="koboSpan" id="kobo.1883.1"> value to </span><span class="No-Break"><span class="koboSpan" id="kobo.1884.1">the client.</span></span></p></li> <li><span class="koboSpan" id="kobo.1885.1">Run the</span><a id="_idIndexMarker1187"/><span class="koboSpan" id="kobo.1886.1"> gRPC </span><a id="_idIndexMarker1188"/><span class="koboSpan" id="kobo.1887.1">server and the ASP.NET Core application in different terminals. </span><span class="koboSpan" id="kobo.1887.2">Note that the gRPC server address must match the address specified in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1888.1">AddGrpcClient()</span></strong><span class="koboSpan" id="kobo.1889.1"> method. </span><span class="koboSpan" id="kobo.1889.2">Then, you can navigate to the Swagger UI page, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1890.1">http://localhost:5284/swagger/index.html</span></strong><span class="koboSpan" id="kobo.1891.1">, to test the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1892.1">CreateContact()</span></strong><span class="koboSpan" id="kobo.1893.1"> action method. </span><span class="koboSpan" id="kobo.1893.2">For example, you can use the following JSON object as the </span><span class="No-Break"><span class="koboSpan" id="kobo.1894.1">request body:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1895.1">
{  "firstName": "John",  "lastName": "Doe",  "email": "john.doe@example.com",  "phone": "1234567890",  "yearOfBirth": 1980,  "isActive": true}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1896.1">You will see the following response (the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1897.1">contactId</span></strong><span class="koboSpan" id="kobo.1898.1"> value may </span><span class="No-Break"><span class="koboSpan" id="kobo.1899.1">be different):</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1900.1">{</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1901.1">  "contactId": "8fb43c22-143f-4131-a5f5-c3700b4f3a08"</span></strong><strong class="bold"><span class="koboSpan" id="kobo.1902.1">}</span></strong></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1903.1">This simple </span><a id="_idIndexMarker1189"/><span class="koboSpan" id="kobo.1904.1">example shows how to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1905.1">AddGrpcClient()</span></strong><span class="koboSpan" id="kobo.1906.1"> method to register a gRPC client in the DI  container in ASP.NET Core applications, and how to use the gRPC client to consume</span><a id="_idIndexMarker1190"/><span class="koboSpan" id="kobo.1907.1"> a unary gRPC service. </span><span class="koboSpan" id="kobo.1907.2">For other types </span><a id="_idTextAnchor479"/><span class="koboSpan" id="kobo.1908.1">of gRPC services, you need to update the </span><span class="No-Break"><span class="koboSpan" id="kobo.1909.1">code accordingly.</span></span></p>
<h1 id="_idParaDest-248"><a id="_idTextAnchor480"/><span class="koboSpan" id="kobo.1910.1">Updating proto files</span></h1>
<p><span class="koboSpan" id="kobo.1911.1">gRPC is a </span><a id="_idIndexMarker1191"/><span class="koboSpan" id="kobo.1912.1">contract-first RPC framework. </span><span class="koboSpan" id="kobo.1912.2">This means that the server and the client communicate with each other using a contract, which is defined in a proto file. </span><span class="koboSpan" id="kobo.1912.3">Inevitably, the contract will change over time. </span><span class="koboSpan" id="kobo.1912.4">In this section, we will learn how to update the contract and how to handle the changes in the server and </span><span class="No-Break"><span class="koboSpan" id="kobo.1913.1">the client.</span></span></p>
<p><span class="koboSpan" id="kobo.1914.1">Once a proto file is used in production, we need to consider backward compatibility when we update the proto file. </span><span class="koboSpan" id="kobo.1914.2">This is because the existing clients may use the old version of the proto file, which may not be compatible with the new version of the proto file. </span><span class="koboSpan" id="kobo.1914.3">If the new version of the contract is not backward compatible, the existing clients </span><span class="No-Break"><span class="koboSpan" id="kobo.1915.1">will break.</span></span></p>
<p><span class="koboSpan" id="kobo.1916.1">The following changes are </span><span class="No-Break"><span class="koboSpan" id="kobo.1917.1">backward compatible:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1918.1">Adding new fields to a request message</span></strong><span class="koboSpan" id="kobo.1919.1">: If the client does not send the new fields, the server can use the default values of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1920.1">new fields.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1921.1">Adding new fields to a response message</span></strong><span class="koboSpan" id="kobo.1922.1">: If the response message contains the new fields but the client does not recognize the new fields, the client will discard the new fields in proto 3. </span><span class="koboSpan" id="kobo.1922.2">In the future version of proto, known as 3.5, this behavior will be changed to preserve the new fields as </span><span class="No-Break"><span class="koboSpan" id="kobo.1923.1">unknown fields.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1924.1">Adding a new RPC method to a service</span></strong><span class="koboSpan" id="kobo.1925.1">: The client that uses old versions of the proto file will not be able to call the new RPC method. </span><span class="koboSpan" id="kobo.1925.2">However, the old RPC methods will </span><span class="No-Break"><span class="koboSpan" id="kobo.1926.1">still work.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1927.1">Adding a new service to a proto file</span></strong><span class="koboSpan" id="kobo.1928.1">: Similar to adding a new RPC method, the new service will not be available to the old clients, but the old services will </span><span class="No-Break"><span class="koboSpan" id="kobo.1929.1">still work.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1930.1">The following</span><a id="_idIndexMarker1192"/><span class="koboSpan" id="kobo.1931.1"> changes may cause breaking changes, which require the clients to be </span><span class="No-Break"><span class="koboSpan" id="kobo.1932.1">updated accordingly:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1933.1">Removing a field from </span><span class="No-Break"><span class="koboSpan" id="kobo.1934.1">a message</span></span></li>
<li><span class="koboSpan" id="kobo.1935.1">Renaming a field in </span><span class="No-Break"><span class="koboSpan" id="kobo.1936.1">a message</span></span></li>
<li><span class="koboSpan" id="kobo.1937.1">Removing or renaming </span><span class="No-Break"><span class="koboSpan" id="kobo.1938.1">a message</span></span></li>
<li><span class="koboSpan" id="kobo.1939.1">Changing a data type of </span><span class="No-Break"><span class="koboSpan" id="kobo.1940.1">a field</span></span></li>
<li><span class="koboSpan" id="kobo.1941.1">Changing a </span><span class="No-Break"><span class="koboSpan" id="kobo.1942.1">field number</span></span></li>
<li><span class="koboSpan" id="kobo.1943.1">Removing or renaming </span><span class="No-Break"><span class="koboSpan" id="kobo.1944.1">a service</span></span></li>
<li><span class="koboSpan" id="kobo.1945.1">Removing or renaming an RPC method from </span><span class="No-Break"><span class="koboSpan" id="kobo.1946.1">a service</span></span></li>
<li><span class="koboSpan" id="kobo.1947.1">Renaming </span><span class="No-Break"><span class="koboSpan" id="kobo.1948.1">a package</span></span></li>
<li><span class="koboSpan" id="kobo.1949.1">Changing the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1950.1">csharp_namespace</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1951.1"> option</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1952.1">Protobuf uses field numbers to serialize and deserialize messages. </span><span class="koboSpan" id="kobo.1952.2">If we rename a field in a message without changing the field number and the data type, the message can still be serialized and deserialized correctly, but the field name in the .NET code will be different from the field name in the proto file. </span><span class="koboSpan" id="kobo.1952.3">This can be confusing for developers. </span><span class="koboSpan" id="kobo.1952.4">So, the client code needs to be updated to use the new </span><span class="No-Break"><span class="koboSpan" id="kobo.1953.1">field name.</span></span></p>
<p><span class="koboSpan" id="kobo.1954.1">Removing a field from a message is a breaking change as the field number cannot be reused. </span><span class="koboSpan" id="kobo.1954.2">For example, if we remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1955.1">year_of_birth</span></strong><span class="koboSpan" id="kobo.1956.1"> field from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1957.1">CreateContactRequest</span></strong><span class="koboSpan" id="kobo.1958.1"> message defined in the </span><em class="italic"><span class="koboSpan" id="kobo.1959.1">Understanding the field types</span></em><span class="koboSpan" id="kobo.1960.1"> section for the gRPC server, the server will deserialize field number 5 as an unknown field. </span><span class="koboSpan" id="kobo.1960.2">This could lead to errors in serialization/de-serialization if a developer later decides to add a new field with field number 5 as a different data type while existing clients still send field number 5 as an </span><span class="No-Break"><span class="koboSpan" id="kobo.1961.1">integer value.</span></span></p>
<p><span class="koboSpan" id="kobo.1962.1">To safely remove a field, we must ensure that the removed field number is not being used in the future. </span><span class="koboSpan" id="kobo.1962.2">To avoid any potential conflicts, we can reserve the removed field number by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1963.1">reserved</span></strong><span class="koboSpan" id="kobo.1964.1"> keyword. </span><span class="koboSpan" id="kobo.1964.2">For example, if we delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1965.1">year_of_birth</span></strong><span class="koboSpan" id="kobo.1966.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1967.1">is_active</span></strong><span class="koboSpan" id="kobo.1968.1"> fields from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1969.1">CreateContactRequest</span></strong><span class="koboSpan" id="kobo.1970.1"> message, we can reserve the field numbers, </span><span class="No-Break"><span class="koboSpan" id="kobo.1971.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1972.1">
message CreateContactRequest {  reserved 5, 6;
  reserved "year_of_birth", "is_active";
  string first_name = 1;
  string last_name = 2;
  string email = 3;
  string phone = 4;
}</span></pre>
<p><span class="koboSpan" id="kobo.1973.1">In the preceding code, we use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1974.1">reserved</span></strong><span class="koboSpan" id="kobo.1975.1"> keyword to reserve field numbers 5 and 6, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1976.1">year_of_birth</span></strong><span class="koboSpan" id="kobo.1977.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1978.1">is_active</span></strong><span class="koboSpan" id="kobo.1979.1"> field names. </span><span class="koboSpan" id="kobo.1979.2">The reserved field numbers and field names cannot be reused in the proto file. </span><span class="koboSpan" id="kobo.1979.3">If we try to use a reserved field number or field name, the gRPC tooling will report </span><span class="No-Break"><span class="koboSpan" id="kobo.1980.1">an error.</span></span></p>
<p><span class="koboSpan" id="kobo.1981.1">Note that the</span><a id="_idIndexMarker1193"/><span class="koboSpan" id="kobo.1982.1"> reserved field names should be listed, as well as the reserved field numbers. </span><span class="koboSpan" id="kobo.1982.2">This ensures that the JSON and text formats are backward compatible. </span><span class="koboSpan" id="kobo.1982.3">When the field names are reserved, they cannot be </span><a id="_idTextAnchor481"/><span class="koboSpan" id="kobo.1983.1">placed in the same </span><strong class="source-inline"><span class="koboSpan" id="kobo.1984.1">reserved</span></strong><span class="koboSpan" id="kobo.1985.1"> statement with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1986.1">field numbers.</span></span></p>
<h1 id="_idParaDest-249"><a id="_idTextAnchor482"/><span class="koboSpan" id="kobo.1987.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.1988.1">In this chapter, we explored the fundamentals of gRPC services and clients. </span><span class="koboSpan" id="kobo.1988.2">We discussed the field types that are used in protobuf, including the scalar types and some other types such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1989.1">DateTime</span></strong><span class="koboSpan" id="kobo.1990.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1991.1">enum</span></strong><span class="koboSpan" id="kobo.1992.1">, repeated fields, and map fields. </span><span class="koboSpan" id="kobo.1992.2">Then, we learned about four types of gRPC services: unary, server streaming, client streaming, and bidirectional streaming. </span><span class="koboSpan" id="kobo.1992.3">We explored how to implement each type of gRPC service and how to create a gRPC client to consume the gRPC service. </span><span class="koboSpan" id="kobo.1992.4">Additionally, we demonstrated how to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1993.1">AddGrpcClient()</span></strong><span class="koboSpan" id="kobo.1994.1"> method to register a gRPC client in the DI  container of an ASP.NET Core application and how to use the gRPC client to consume a unary gRPC service. </span><span class="koboSpan" id="kobo.1994.2">Finally, we discussed how to update the proto files and how to handle the changes in the server and </span><span class="No-Break"><span class="koboSpan" id="kobo.1995.1">the client.</span></span></p>
<p><span class="koboSpan" id="kobo.1996.1">To simplify the code samples, we did not use any database access code in the gRPC services. </span><span class="koboSpan" id="kobo.1996.2">In a real-world application, we may need to interact with a database or other external services in the gRPC services. </span><span class="koboSpan" id="kobo.1996.3">You can follow the same approach as you do in REST </span><span class="No-Break"><span class="koboSpan" id="kobo.1997.1">API services.</span></span></p>
<p><span class="koboSpan" id="kobo.1998.1">gRPC is suitable for building high-performance service-to-service communication. </span><span class="koboSpan" id="kobo.1998.2">Due to this book’s content limitations, we only covered the basics of gRPC. </span><span class="koboSpan" id="kobo.1998.3">We did not cover advanced topics such as authentication, error handling, performance tuning, and others. </span><span class="koboSpan" id="kobo.1998.4">However, this chapter should be enough to get you started </span><span class="No-Break"><span class="koboSpan" id="kobo.1999.1">with gRPC.</span></span></p>
<p><span class="koboSpan" id="kobo.2000.1">In the next chapter, we will explore GraphQL, an alternative approach to web APIs. </span><span class="koboSpan" id="kobo.2000.2">GraphQL provides clients with the ability to request only the data they need, making it easier to modify APIs over time and enabling the use of powerful </span><span class="No-Break"><span class="koboSpan" id="kobo.2001.1">developer tools.</span></span></p>
<h2 id="_idParaDest-250"><a id="_idTextAnchor483"/><span class="koboSpan" id="kobo.2002.1">Further reading</span></h2>
<p><span class="koboSpan" id="kobo.2003.1">To learn more about gRPC on .NET Core, please refer to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2004.1">following resources:</span></span></p>
<ul>
<li><a href="https://protobuf.dev/"><span class="No-Break"><span class="koboSpan" id="kobo.2005.1">https://protobuf.dev/</span></span></a></li>
<li><a href="https://grpc.io/docs/languages/csharp/"><span class="No-Break"><span class="koboSpan" id="kobo.2006.1">https://grpc.io/docs/languages/csharp/</span></span></a></li>
<li><a href="https://learn.microsoft.com/en-us/aspnet/core/grpc/"><span class="No-Break"><span class="koboSpan" id="kobo.2007.1">https://learn.microsoft.com/en-us/aspnet/core/grpc/</span></span></a></li>
</ul>
</div>
</body></html>