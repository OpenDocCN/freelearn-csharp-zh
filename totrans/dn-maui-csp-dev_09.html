<html><head></head><body>
		<div><h1 id="_idParaDest-153" class="chapter-number"><a id="_idTextAnchor160"/>9</h1>
			<h1 id="_idParaDest-154"><a id="_idTextAnchor161"/>Unit Testing</h1>
			<p>Until now, we’ve been focusing on creating the app, but there is danger in going too far without introducing unit testing. In this chapter, we will focus on writing comprehensive and meaningful unit tests using best practices.</p>
			<p class="callout-heading">Test-driven development (TDD)</p>
			<p class="callout">Some developers believe that unit tests should come <em class="italic">before</em> the code (TDD), but that is beyond the scope of this book.</p>
			<p>Unit testing is <a id="_idIndexMarker357"/>crucial to creating robust applications and knowing that your app works before you ship it. It is also a critical aspect of debugging, telling you right away if something you just changed or added broke some aspect of your app.</p>
			<p>To facilitate unit tests, you’ll want to use dependency injection so that you can mock up time-consuming services, such as APIs, databases, and so on. We’ll spend time with mocks, injected into our test classes, to ensure that we are processing data as intended.</p>
			<p>The specific topics in this chapter are as follows:</p>
			<ul>
				<li>Why create unit tests?</li>
				<li>Getting started creating unit tests</li>
				<li>Mocks</li>
				<li>Dependency injection</li>
				<li>NSubstitute</li>
			</ul>
			<h1 id="_idParaDest-155"><a id="_idTextAnchor162"/>Technical requirements</h1>
			<p>To follow along with this chapter, you will need Visual Studio. You will also install two NuGet packages, as shown in the chapter itself. If you are going to enter the code as you go, you’ll want to start with the source from the previous chapter: <a href="https://github.com/PacktPublishing/.NET-MAUI-for-C-Sharp-Developers/tree/persistence">https://github.com/PacktPublishing/.NET-MAUI-for-C-Sharp-Developers/tree/persistence</a>.</p>
			<p>The source code for this chapter can be found here:<a id="_idTextAnchor163"/> <a href="https://github.com/PacktPublishing/.NET-MAUI-for-C-Sharp-Developers/tree/UnitTests">https://github.com/PacktPublishing/.NET-MAUI-for-C-Sharp-Developers/tree/UnitTests</a>.</p>
			<h1 id="_idParaDest-156"><a id="_idTextAnchor164"/>Why create unit tests?</h1>
			<p>There<a id="_idIndexMarker358"/> are many types of tests you will want to run on a production app. These include unit tests (testing one small part of an app – typically, a method), integration tests (how well the parts of the program run together), UI tests (making sure that interacting with the UI acts as expected), and end-to-end tests (making sure the entire program works as expected).</p>
			<p><strong class="bold">Unit tests</strong> are a<a id="_idIndexMarker359"/> critical part of this process and are created for every method and every unit of logic. In fact, multiple tests are typically created for each unit, so that you can test the happy path, the sad path, and corner conditions.</p>
			<p>The <strong class="bold">happy path</strong> is <a id="_idIndexMarker360"/>when the data is as expected. The <strong class="bold">sad path</strong> is when<a id="_idIndexMarker361"/> the data is predictably wrong (for example, the user does not enter a required field).</p>
			<p><code>123</code> as the username).</p>
			<p>A key benefit of unit tests is that they make your code less <em class="italic">brittle</em>. Without unit tests, it is easy to get into a situation where a change over here breaks code over there, and you don’t know about the breakage until either you run the entire program or, worse, your customer finds it.</p>
			<p>Key to all of this is that research has shown that it is easier and less expensive to fix a bug found during a unit test than it is to find bugs found later. For example, in the 1990s, Capers Jones analyzed data about bugs from more than 400 software projects and found that the cost of fixing a bug increased by a factor of 6 to 7 for every phase of development.</p>
			<p>Furthermore, unit tests act as excellent documentation for your app, describing precisely what you expect to happen under a wide variety of situations. Unlike comments, which rust – that is, become out of sync with the code – unit tests can never depart from the code because they will break when your code changes in ways that make the expected outcome change.</p>
			<h2 id="_idParaDest-157"><a id="_idTextAnchor165"/>Vote early and vote often</h2>
			<p>It is important<a id="_idIndexMarker364"/> to run all of your unit tests after every change you make to the code. You want to catch inadvertent and unwanted side effects as quickly as possible. However, for this to work, your unit tests must be <em class="italic">fast</em>. A suite of unit tests that take an appreciable amount of time to run will be used less often. The longer they take to run, the less frequently the programmer will run them.</p>
			<p>Good unit tests are not only fast but also <em class="italic">isolated</em> from one another. That means that one unit test does not depend on the outcome or state of another – it should not matter what order they are run in.</p>
			<p>You want to be able to look at the outcome of unit tests and immediately identify what went wrong so that you can fix it quickly. To accomplish this, your unit tests should do the following:</p>
			<ul>
				<li>Test exactly one thing at a time</li>
				<li>Be well named</li>
			</ul>
			<p>If you test more than one thing in a unit test and that test fails, you won’t know which of the things was the culprit. Well-named unit tests make it clear at a glance what they are testing and thus what went wrong.</p>
			<p>This is an example of a bad unit test name: <code>DoesGetBuddiesWork</code>.</p>
			<p>This is a good unit test name: <code>GettingBuddiesListDoesNotThrowAnException</code>.</p>
			<p>If the test fails, a glance at the name of the <em class="italic">good unit test name</em> tells you exactly what went wrong.</p>
			<p class="callout-heading">Unit test names</p>
			<p class="callout">Some programmers use very rigid naming schemes for unit tests. For example, some will create the name by the name of the method followed by the condition followed by the expected outcome. So, you might have a name like this: <code>GetBuddiesList_WhenEmpty_ShouldNotThrowAnException</code>.</p>
			<p class="callout">These can be useful, as glancing at the name of the test gives you a lot of information.</p>
			<p>Remember, as the <a id="_idIndexMarker365"/>program grows, so too will your set of unit tests. When you have hundreds (or even thousands), you’ll want to be able to zip through your tests so quickly that you don’t mind running them after each meaningful change, and when one or more fail, you want to know what was tested without having to open up the test and look.</p>
			<h1 id="_idParaDest-158"><a id="_idTextAnchor166"/>Creating unit tests</h1>
			<p>To get <a id="_idIndexMarker366"/>started, right-click on the solution and choose <strong class="bold">Add New Project</strong>. In the dialog box, use the dropdown to pick <strong class="bold">UnitTest</strong>. There are a number of unit test frameworks. The two most popular are the older <strong class="bold">NUnit</strong> and the newer <strong class="bold">xUnit</strong>. We’ll choose <strong class="bold">xUnit Test Project</strong>, as shown in <em class="italic">Figure 9</em><em class="italic">.1</em>:</p>
			<p class="IMG---Figure"> </p>
			<div><div><img src="img/Figure_9.1_B19723.jpg" alt="Figure 9.1 – Selecting the unit test type&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.1 – Selecting the unit test type</p>
			<ol>
				<li>Click <code>.Tests</code>, as shown in the following figure:</li>
			</ol>
			<div><div><img src="img/Figure_9.2_B19723.jpg" alt="Figure 9.2 – Naming the test project&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.2 – Naming the test project</p>
			<ol>
				<li value="2">Click <strong class="bold">Next</strong> and select the .NET platform (this book will use .NET 7).</li>
			</ol>
			<p>Visual Studio will create<a id="_idIndexMarker368"/> your project as well as the first unit test class and method. Since this is generic, delete that class and create one called <code>PreferencesTests</code>.</p>
			<h2 id="_idParaDest-159"><a id="_idTextAnchor167"/>Setting the project reference</h2>
			<p>Before doing <a id="_idIndexMarker369"/>anything else, we need to make <code>ForgetMeNotDemo.Tests</code> aware of the <code>ForgetMeNotDemo</code> project. To do so, right-click on the test project and select <strong class="bold">Add</strong> | <strong class="bold">ProjectReference</strong>, and check the box next to <strong class="bold">ForgetMeNotDemo</strong>, as shown in <em class="italic">Figure 9</em><em class="italic">.3</em>:</p>
			<div><div><img src="img/Figure_9.3_B19723.jpg" alt="Figure 9.3 – Referencing ForgetMeNotDemo from the unit test project&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.3 – Referencing ForgetMeNotDemo from the unit test project</p>
			<p>With all that set up, we are ready to write our first unit test, designed only to ensure that the <a id="_idIndexMarker370"/>testing structure is in place and working.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">This will not build. Please refer to the <em class="italic">Tweaking the project file</em> section that appears later in the chapter.</p>
			<h2 id="_idParaDest-160"><a id="_idTextAnchor168"/>Creating the first unit test</h2>
			<p>To make<a id="_idIndexMarker371"/> sure all is right with the world, open <code>UnitTest1</code> and add a test method that must pass:</p>
			<pre class="source-code">
namespace ForgetMeNotDemo.Tests
{
  public class UnitTest1
  {
    [Fact]
    public void MustBeTrue()
    {
      Assert.True(true);
    }
  }
}</pre>
			<p>xUnit tests come in two flavors:</p>
			<ul>
				<li><strong class="bold">Facts</strong>: These are <a id="_idIndexMarker372"/>invariants – they always take the same data and should always pass</li>
				<li><strong class="bold">Theories</strong>: These <a id="_idIndexMarker373"/>are a suite of tests that execute the same code but are given different input arguments</li>
			</ul>
			<p>Let’s explore<a id="_idIndexMarker374"/> the theories. The first test we created, <code>MustBeTrue</code>, simply asserts that the value true is <code>true</code>. This makes a good first test, as it will test that your unit testing is set up correctly.</p>
			<p>To run this test, click on the <strong class="bold">Test</strong> | <strong class="bold">Run All Tests</strong> menu item – but be warned, <em class="italic">it </em><em class="italic">won’t work!</em></p>
			<p>In order to make this work, there is a bit of tweaking we have to do to the project file.</p>
			<h2 id="_idParaDest-161"><a id="_idTextAnchor169"/>Tweaking the project file</h2>
			<p>The problem<a id="_idIndexMarker375"/> is that your .NET MAUI <code>.csproj</code> project file lists the following <code>TargetFrameworks</code>:</p>
			<pre class="console">
&lt;TargetFrameworks&gt;net7.0-android;net7.0-ios;net7.0-
  maccatalyst&lt;/TargetFrameworks&gt;</pre>
			<p>However, the unit test project file looks like this:</p>
			<pre class="console">
&lt;TargetFramework&gt;7.0&lt;/TargetFramework&gt;</pre>
			<p>To fix this discrepancy, exit Visual Studio and open your .NET MAUI project <code>.csproj</code> file using your favorite text editor (not Word or other programs that add special characters – I like to use Visual Studio Code, but whatever floats your boat). Modify <code>&lt;TargetFramework&gt;</code> to include .<code>net7.0</code>:</p>
			<pre class="console">
&lt;TargetFrameworks&gt;net7.0;net7.0-android;net7.0-ios;net7.0-
  maccatalyst&lt;/TargetFrameworks&gt;</pre>
			<p>You’re halfway there. The next issue is that we need to output the test as a DLL, but the output for the project is an EXE. The best way to fix this is to add a condition – only do the output as an EXE when the target framework is not 7.0:</p>
			<pre class="console">
&lt;OutputType Condition="'$(TargetFramework)' !=
  'net7.0'"&gt;Exe&lt;/OutputType&gt;</pre>
			<p>Reopen Visual Studio and open the solution. Your test should work now.</p>
			<h2 id="_idParaDest-162"><a id="_idTextAnchor170"/>Running the test</h2>
			<p>First, rename <code>UnitTest1</code> to <code>PreferencesTests</code>. Next, go to the menu and select <strong class="bold">Test</strong> | <strong class="bold">Test Explorer</strong>. This will open (surprise!) <strong class="bold">Test Explorer</strong>. Click the green <em class="italic">Play</em> button, as<a id="_idIndexMarker376"/> shown in <em class="italic">Figure 9</em><em class="italic">.4</em>:</p>
			<div><div><img src="img/Figure_9.4_B19723.jpg" alt="Figure 9.4 – The Play button&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.4 – The Play button</p>
			<p>Your project will build and Test Explorer will run your test, showing you results as shown in <em class="italic">Figure 9</em><em class="italic">.5</em>:</p>
			<div><div><img src="img/Figure_9.5_B19723.jpg" alt="Figure 9.5 – Test results&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.5 – Test results</p>
			<p>Reading down from the top, it shows that <code>ForgetMeNotDemo.Tests</code> has one test, and the green check indicates that all the tests in <code>ForgetMeNotDemo.Tests</code> have passed.</p>
			<p>Inside <code>ForgetMeNotDemo.Tests</code> will be a list of all the test classes – in this case, just the one, <code>PreferencesTests</code>, and this too shows that there is one test and that it passed.</p>
			<p>Finally, inside <code>PreferencesTests</code> will be a list of each individual test, and again, the green check indicates the test passed.</p>
			<p>Congratulations, you’ve created your first test, run it, and seen it pass!</p>
			<p>Now, let’s settle down to writing some tests for <code>ForgetMeNotDemo</code>.</p>
			<h1 id="_idParaDest-163"><a id="_idTextAnchor171"/>ForgetMeNotDemo unit tests</h1>
			<p>To get started, we <a id="_idIndexMarker377"/>examine one ViewModel at a time, paying attention to the methods. We do this because what we want to test is the business logic, and if you’ve done it right, most of your business logic will be in a <code>ViewModel</code> class.</p>
			<p>For example, turning our attention to <code>PreferencesViewModel</code>, we see the <code>Init()</code> method. The job of <code>Init</code> is to populate the <code>PreferenceList</code> collection. For now, we’ll ignore how it does this and just write a test to ensure that it does.</p>
			<h2 id="_idParaDest-164"><a id="_idTextAnchor172"/>Implementing the triple-A pattern</h2>
			<p>Before we <a id="_idIndexMarker378"/>start, create an interface for <code>PreferenceService</code>, as described earlier in the book (open <code>PreferenceService</code>, right-click on the class name, and choose <strong class="bold">Extract Interface</strong>).</p>
			<p>A classic design pattern for unit tests<a id="_idIndexMarker379"/> is the <strong class="bold">Arrange, Act, Assert</strong> (<strong class="bold">AAA</strong>) pattern. That is, you set up your test (Arrange), then you call a method or two (Act), and then check to make sure you have the expected results (Assert). Let’s see this in action (note, this test has two flaws that will be discussed):</p>
			<pre class="source-code">
  [Fact]
  public async void AfterCallingInitPreferencesIsNotEmpty()
  {
    // Arrange
    IPreferenceService service = new PreferenceService();
    preferencesViewModel = new PreferencesViewModel();
    // Act
    await preferencesViewModel.Init();
    // Assert
    Assert.NotEmpty(preferencesViewModel.PreferenceList);
  }</pre>
			<p>Here, we set up <code>IPreferenceService</code>, which we’ll need to create <code>PreferencesViewModel</code>, and then we create an instance of that <code>ViewModel</code>.</p>
			<p>With that in place, we can call the <code>Init()</code> method.</p>
			<p>Now, we<a id="_idIndexMarker380"/> will test the results using Assert. Assert has many methods that you can use to test the success of your test. These include, but are not limited to, the following:</p>
			<ul>
				<li><code>Assert.True</code></li>
				<li><code>Assert.False</code></li>
				<li><code>Assert.Equal&lt;T&gt;(T expected, </code><code>T actual)</code></li>
				<li><code>Assert.InRange&lt;T&gt;(T actual, T low, </code><code>T high)</code></li>
				<li><code>Assert.Null</code></li>
				<li><code>Assert.NotNull</code></li>
				<li><code>Assert.IsType&lt;T&gt;(object obj)</code></li>
				<li><code>Assert.Empty(IenumerableCollection)</code></li>
				<li><code>Assert.Contains&lt;T&gt;(T expected, </code><code>Ienumerable&lt;t&gt; collection)</code></li>
			</ul>
			<p>There are many more too. The definitive list can be found at the <code>xUnit</code> repository: <a href="https://github.com/xunit/assert.xunit/blob/main/Assert.cs">https://github.com/xunit/assert.xunit/blob/main/Assert.cs</a>. The various Asserts are arranged as classes, each of which has a variety of <code>Assert</code> methods. A partial list is shown in <em class="italic">Figure 9</em><em class="italic">.6</em>:</p>
			<div><div><img src="img/Figure_9.6_B19723.jpg" alt="Figure 9.6 – A partial list of Assert classes&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.6 – A partial list of Assert classes</p>
			<p>In our <a id="_idIndexMarker381"/>case, we are asserting that, after running <code>Init</code>, <code>PreferenceList</code> is not empty. Open <strong class="bold">Test Explorer</strong> and click on the <strong class="bold">Run All Tests In View</strong> button, as shown here:</p>
			<div><div><img src="img/Figure_9.7_B19723.jpg" alt="Figure 9.7 – Run All Tests In View button&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.7 – Run All Tests In View button</p>
			<p>The tests run, and Test Explorer gives us the results, as shown in the following figure:</p>
			<div><div><img src="img/Figure_9.8_B19723.jpg" alt="Figure 9.8 – Test Explorer results&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.8 – Test Explorer results</p>
			<p>Let us see<a id="_idIndexMarker382"/> what each numbered option in the figure means:</p>
			<p>[1] The number of tests</p>
			<p>[2] The number of tests that passed</p>
			<p>[3] The number of tests that failed</p>
			<p>[4] A summary and statement on how long the test took</p>
			<p>[5] Each passed test in the context of where the text is located. A green check means that it passed, and a red x indicates that it failed. Notice that the time for each test is listed. Also note that the tests took at most 6 milliseconds, but the entire test suite took 408 ms. The difference is the overhead of beginning the test procedure. This will soon be swamped by the time for all the tests.</p>
			<h2 id="_idParaDest-165"><a id="_idTextAnchor173"/>What’s wrong with this test?</h2>
			<p>I mentioned <a id="_idIndexMarker383"/>previously that this test has two significant flaws. The first is that the call to <code>Init</code> may not populate <code>PreferenceList</code> because the service may return zero records. We’ll need to adjust for that by asserting instead that <code>PreferenceList</code> is not null.</p>
			<p>The second, more important, problem is that the test depends on running <code>PreferenceService</code>. If we examine the code for <code>PreferenceService</code>, we see that the call to <code>GetPreferences</code> has a significant problem:</p>
			<pre class="source-code">
public async Task&lt;List&lt;Preference&gt;&gt; GetPreferences()
{
  return await GetPreferencesMock();
}</pre>
			<p>Right <a id="_idIndexMarker384"/>now, while developing the app, we are calling to <code>GetPreferencesMock</code>, which is just a method in <code>PreferenceService</code>. But that is not how we’ll finish the app. In <a href="B19723_11.xhtml#_idTextAnchor216"><em class="italic">Chapter 11</em></a>, we’ll convert this to make an API call. API calls can take an unpredictably long time, and potentially, can grind our test to a halt.</p>
			<p>To solve this, we need a mock <code>PreferenceService</code> that both returns quickly and returns a predictable collection (or an empty collection if we want to test that eventuality).</p>
			<h1 id="_idParaDest-166"><a id="_idTextAnchor174"/>Mocks</h1>
			<p>Often, when testing, you <a id="_idIndexMarker385"/>need to interact with a method that takes an indeterminate amount of time, such as retrieving data from a database or, worse, retrieving data from an API (that is, over the internet rather than locally from your device).</p>
			<p>Calling this kind of method can bring your unit test to a screeching halt, making it almost unusable. To avoid this, we create fake representations of the database or the API using an object called a <strong class="bold">mock</strong>.</p>
			<p>Mocks offer two advantages: they respond instantly and, perhaps as importantly, they respond predictably. Once written, they give the same input and mock will always provide the same output.</p>
			<p>In order to use mocks, we’ll need to implement dependency injection for some of our classes, so let’s start there.</p>
			<h1 id="_idParaDest-167"><a id="_idTextAnchor175"/>Dependency injection</h1>
			<p>Until now, anytime<a id="_idIndexMarker386"/> we needed an object inside a class, we passed in the object or we created it in the body of the class. This creates a <code>PreferencesViewModel</code>, we need a <code>PreferenceService</code> object. The approach we’ve taken so far is to <em class="italic">new one up</em> in the constructor:</p>
			<pre class="source-code">
private readonly PreferenceService service;
public PreferencesViewModel()
{
  service = new();
}</pre>
			<p>Dependency injection<a id="_idIndexMarker388"/> decouples the classes and allows for more powerful unit testing, as we’ll see when we continue the discussion of mocks. Rather than <em class="italic">newing-up</em> a <code>PreferenceService</code>, we want to pass in an interface and have .NET MAUI create it for us (that is, no calling function will add the interface to the constructor call – it will be done automatically).</p>
			<p class="callout-heading">Not just for testing</p>
			<p class="callout">Dependency injection can be used throughout your project, not only for unit tests. In fact, when combined <a id="_idIndexMarker389"/>with an <strong class="bold">Inversion of Control</strong> (<strong class="bold">IoC</strong>) container, dependency injection creates a powerful pattern for decoupling objects throughout the app. More on IoC containers later.</p>
			<h2 id="_idParaDest-168"><a id="_idTextAnchor176"/>Creating an interface</h2>
			<p>To do this, we <a id="_idIndexMarker390"/>first need to create an <code>IPreferenceService</code> interface.</p>
			<p class="callout-heading">Resharper</p>
			<p class="callout">Everything I’m about to show uses <strong class="bold">Resharper</strong>, an<a id="_idIndexMarker391"/> essential tool for serious .NET MAUI programmers, but it is not free. You can certainly do all this by hand; it is just that Resharper makes it much easier. Since I highly recommend buying Resharper, I’ll show you how to do the following with that tool. (Please note, as a Microsoft MVP, I get my copy of Resharper for free.)</p>
			<p>First, go<a id="_idIndexMarker392"/> to <strong class="bold">Solution Explorer</strong>, open <strong class="bold">PreferenceService</strong>, and follow these steps:</p>
			<ol>
				<li value="1">Right-click on the class name and choose <strong class="bold">Refactor This</strong>. A context menu will appear, as shown in the following figure:</li>
			</ol>
			<div><div><img src="img/Figure_9.9_B19723.jpg" alt="Figure 9.9 – Refactor context menu&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.9 – Refactor context menu</p>
			<ol>
				<li value="2">Select <strong class="bold">Extract Interface</strong>, and a dialog box will appear as shown here:</li>
			</ol>
			<div><div><img src="img/Figure_9.10_B19723.jpg" alt="Figure 9.10 – Extracting the interface&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.10 – Extracting the interface</p>
			<ol>
				<li value="3">Be sure<a id="_idIndexMarker393"/> to check all the public methods and choose the <strong class="bold">Its own file</strong> radio button for where to move the interface.</li>
			</ol>
			<p>Hey, presto! You’ll have an interface file in the same directory (<code>Services</code>), as shown in <em class="italic">Figure 9</em><em class="italic">.11</em>:</p>
			<div><div><img src="img/Figure_9.11_B19723.jpg" alt="Figure 9.11 – New interface file in the Services folder&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.11 – New interface file in the Services folder</p>
			<p>Open your new file and you’ll see a typical C# interface:</p>
			<pre class="source-code">
public interface IPreferenceService
{
  public Task&lt;List&lt;Preference&gt;&gt; GetPreferences();
  public Task&lt;List&lt;Preference&gt;&gt; GetPreferencesMock();
}</pre>
			<p>Now, check the original <code>PreferenceService</code>. Resharper was nice enough to designate that <code>PreferenceService</code> implements <code>IPreferenceService</code>:</p>
			<pre class="source-code">
public class PreferenceService : IPreferenceService</pre>
			<p>Please make <code>PreferenceService.GetPreferencesMock</code> public.</p>
			<p>With an<a id="_idIndexMarker394"/> interface, we can use constructor injection – that is, we can define that we’re going to pass an instance of the interface into the constructor, and then pass in anything that implements that interface.</p>
			<h2 id="_idParaDest-169"><a id="_idTextAnchor177"/>Modifying the class constructor</h2>
			<p>Let’s go <a id="_idIndexMarker395"/>back to <code>PreferencesViewModel</code>. Since we know we’re going to use dependency injection to send <code>PreferenceService</code> into <code>ViewModel</code>, we can modify the declaration of <code>PreferenceService</code> and the constructor:</p>
			<pre class="source-code">
Private readonly IPreferenceService service;   [1]
public PreferencesViewModel(IPreferenceService service) [2]
{
  this.service = service; [3]
}</pre>
			<p>[1] We change the local service member to an interface.</p>
			<p>[2] We pass <code>IPreferenceService</code> into the constructor.</p>
			<p>[3] We assign the member to the passed-in parameter.</p>
			<p>But who calls <code>PreferencesViewModel</code> with the <code>IPreference</code> service, and where does that method get it?</p>
			<p>The answer is that the IoC container is responsible for all of this.</p>
			<h2 id="_idParaDest-170"><a id="_idTextAnchor178"/>The .NET MAUI IoC container</h2>
			<p>.NET MAUI has <a id="_idIndexMarker396"/>a built-in IoC container that <a id="_idIndexMarker397"/>we use by registering the interfaces we want to be managed. You do this in the <code>CreateMauiApp</code> method in <code>MauiProgram.cs</code>:</p>
			<pre class="source-code">
public static MauiApp CreateMauiApp()
{
    var builder = MauiApp.CreateBuilder(); [1]
     builder
    .UseMauiApp&lt;App&gt;()
    .UseMauiCommunityToolkit()
    .UseMauiCommunityToolkitMarkup()
    .ConfigureFonts(fonts =&gt;
    {
      fonts.AddFont("OpenSans-Regular.ttf",
        "OpenSansRegular");
      fonts.AddFont("OpenSans-Semibold.ttf",
        "OpenSansSemibold");
    })
    .UseMauiMaps();
if DEBUG
    builder.Logging.AddDebug();
endif
    return builder.Build();
}</pre>
			<p>As seen in <code>[1]</code>, the first thing we do is instantiate a <code>MauiAppBuilder</code> object. We then tack a<a id="_idIndexMarker398"/> number of other configuration requirements onto the Builder.</p>
			<p>We’ll use that to register all the interfaces to all our services. In fact, we’ll also register our views and ViewModels so that we can pass them into methods using dependency injection.</p>
			<h2 id="_idParaDest-171"><a id="_idTextAnchor179"/>Registering your interfaces, services, and ViewModels</h2>
			<p>.NET MAUI <a id="_idIndexMarker399"/>provides an IoC container. By registering our interfaces, services, and so on, .NET MAUI will supply what we need when<a id="_idIndexMarker400"/> we need it, without our having to <em class="italic">new-up</em> instances. Beyond that, the IoC container will also fix up all the dependencies.</p>
			<p>To register the <code>IPreferences</code> interface, we add a call to <code>Builder.Services.AddTransient</code>, passing in the interface and the class that implements that interface:</p>
			<pre class="source-code">
builder.Services.AddTransient&lt;IPreferenceService,
  PreferenceService&gt;();</pre>
			<p><code>Builder.Services</code> offers two ways to register your interface:</p>
			<ul>
				<li><code>AddTransient</code></li>
				<li><code>AddSingleton</code></li>
			</ul>
			<p>You’ll use <code>AddTransient</code> when you may or may not instantiate the object (we may never look at the user’s preferences, and thus may never need the service). You use <code>AddSingleton</code> when you know you’ll want the object and there is no point in creating more than one.</p>
			<p>While we’re here, let’s register all the<a id="_idIndexMarker401"/> ViewModels. We don’t need interfaces for them, as we won’t be passing them anywhere via dependency injection:</p>
			<pre class="source-code">
builder.Services.AddTransient&lt;AboutViewModel&gt;();
builder.Services.AddTransient&lt;BuddiesViewModel&gt;();
builder.Services.AddTransient&lt;BuddyDetailsViewModel&gt;();
builder.Services.AddTransient&lt;PreferencesViewModel&gt;();
builder.Services.AddTransient&lt;LoginViewModel&gt;();</pre>
			<p>Putting it <a id="_idIndexMarker402"/>together, this <a id="_idIndexMarker403"/>is what <code>CreateMauiApp</code> looks<a id="_idIndexMarker404"/> like now:</p>
			<pre class="source-code">
public static MauiApp CreateMauiApp()
{
    var builder = MauiApp.CreateBuilder();
  builder
    .UseMauiApp&lt;App&gt;()
    .UseMauiCommunityToolkit()
    .UseMauiCommunityToolkitMarkup()
    .ConfigureFonts(fonts =&gt;
    {
      fonts.AddFont("OpenSans-Regular.ttf",
         "OpenSansRegular");
      fonts.AddFont("OpenSans-Semibold.ttf",
         "OpenSansSemibold");
    })
    .UseMauiMaps();
if DEBUG
    builder.Logging.AddDebug();
endif
  builder.Services.AddTransient&lt;IPreferenceService,
    PreferenceService&gt;();
  builder.Services.AddTransient&lt;AboutViewModel&gt;();
  builder.Services.AddTransient&lt;BuddyDetailsViewModel&gt;();
  builder.Services.AddTransient&lt;PreferencesViewModel&gt;();
  builder.Services.AddTransient&lt;LoginViewModel&gt;();
  return builder.Build();
}</pre>
			<p>Notice that all the <a id="_idIndexMarker405"/>registration <a id="_idIndexMarker406"/>happens before we return the result of calling <code>Build</code> on the <code>Builder</code> object.</p>
			<p>We will be using<a id="_idIndexMarker407"/> dependency injection to inject mock objects where objects that would otherwise take an unpredictable amount of time would normally be used. That is, rather than waiting for a database or API call, we can inject a mock database or a mock service and get back a response instantly and predictably.</p>
			<p>Our first decision is which mocking library to use.</p>
			<h1 id="_idParaDest-172"><a id="_idTextAnchor180"/>Using the NSubstitute package</h1>
			<p>There are a number of different mocking libraries available to you, some free and some commercial. For this book, we’ll use <strong class="bold">NSubstitute</strong>, an open source and free option available as a <a id="_idIndexMarker408"/>NuGet package.</p>
			<p>To get started, follow these steps:</p>
			<ol>
				<li value="1">Right-click on your solution and choose <strong class="bold">ManageNugetPackagesForSolution</strong>.</li>
				<li>Go to the <code>NSubstitute</code>.</li>
			</ol>
			<p>The first package you want is <strong class="bold">NSubstitute</strong> by Anthony Egerton et al., as shown here:</p>
			<div><div><img src="img/Figure_9.12_B19723.jpg" alt="Figure 9.12 – NSubstitute NuGet package&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.12 – NSubstitute NuGet package</p>
			<ol>
				<li value="3">On the right, click<a id="_idIndexMarker409"/> on the project you want this added to (<code>ForgetMeNotDemo.Tests</code>) and click on <strong class="bold">Install</strong>, as shown in <em class="italic">Figure 9</em><em class="italic">.13</em>:</li>
			</ol>
			<div><div><img src="img/Figure_9.13_B19723.jpg" alt="Figure 9.13 – Installing NSubstitute&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.13 – Installing NSubstitute</p>
			<ol>
				<li value="4">Once that installs, install <strong class="bold">NSubstitute.Analyzers.CSharp</strong>, as shown in the following figure:</li>
			</ol>
			<div><div><img src="img/Figure_9.14_B19723.jpg" alt="Figure 9.14 – Selecting NSubstitute.Analyzers.CSharp&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.14 – Selecting NSubstitute.Analyzers.CSharp</p>
			<p>While not strictly <a id="_idIndexMarker410"/>required, this second library will detect potential mistakes in your use of NSubstitute. Install it into the test project as you did previously.</p>
			<h2 id="_idParaDest-173"><a id="_idTextAnchor181"/>Adding NSubstitute to your test fixture</h2>
			<p>To add<a id="_idIndexMarker411"/> NSubstitute to your test fixture, add <code>using NSubstitute;</code> to the top of the C# file.</p>
			<p>We can now create a substitute for <code>PreferenceService</code>.</p>
			<p class="callout-heading">Mocks depend on constructor dependency injection</p>
			<p class="callout">Turn to the constructor in <code>PreferencesViewModel</code> and notice that the service is injected as an interface:</p>
			<p class="callout"><code>public </code><code>PreferencesViewModel(IPreferenceService service)</code></p>
			<p class="callout"><code> {</code></p>
			<p class="callout"><code>   this.service = </code><code>service;</code></p>
			<p class="callout"><code> }</code></p>
			<p class="callout">This is critical. Mocks only work with constructor injection.</p>
			<p>Back in our unit test, let’s declare a mock for the service:</p>
			<pre class="source-code">
[Fact]
public async void AfterCallingInitPreferencesIsNotEmpty()
{
  // Arrange
  var service = Substitute.For&lt;IPreferenceService&gt;();   [1]
  var = new PreferencesViewModel(service); [2]
  // Act
  await preferencesViewModel.Init();
  // Assert
  Assert.NotEmpty(preferencesViewModel.PreferenceList);
}</pre>
			<p>[1] Declare the mock for <code>IpreferenceService</code>.</p>
			<p>[2] Pass that mock into the constructor for <code>PreferencesViewModel</code>.</p>
			<p>Run the<a id="_idIndexMarker412"/> test. It fails with the error that the collection cannot be null. Why?</p>
			<p>The original service was returning a list of <code>Preference</code> objects, but our new mock is not. We need to teach the mock to return a predictable set of <code>Preference</code> objects.</p>
			<p>Here is the top of the <code>Arrange</code> method, in which we create a couple of <code>Preference</code> objects and then add them to a list:</p>
			<pre class="source-code">
public async void AfterCallingInitPreferencesIsNotEmpty()
{
  // Arrange
  Preference pref1 = new()
  {
    Id = 1,
    PreferencePrompt = "Shirt Size",
    PreferenceValue = "Large"
  };
  Preference pref2 = new()
  {
    PreferencePrompt = "Favorite Music Genre",
    PreferenceValue = "Jazz"
  };
  List&lt;Preference&gt; prefs = new()
  {
    pref1,
    pref2
  };</pre>
			<p>We can <a id="_idIndexMarker413"/>now create our substitute:</p>
			<pre class="source-code">
var serviceMock = Substitute.For&lt;IPreferenceService&gt;(); [1]
  serviceMock.GetPreferences() [2]
  .Returns(prefs); [3]</pre>
			<p>[1] Create the mock.</p>
			<p>[2] Tell the mock which method it will be mocking.</p>
			<p>[3] Tell the mock what to return when that method is invoked.</p>
			<p>We use the mock in calling the <code>PreferencesViewModel</code> constructor, which you will remember takes <code>IpreferenceService</code>:</p>
			<pre class="source-code">
preferencesViewModel = new PreferencesViewModel
  (serviceMock);</pre>
			<p>In the <code>Act</code> portion of the test, we’ll call <code>Init</code> on that <code>PreferencesViewModel</code> object and then<a id="_idIndexMarker414"/> assert that the list is not empty. This will work this time because the service it relies on can now be predicted to return a list of two preferences.</p>
			<h2 id="_idParaDest-174"><a id="_idTextAnchor182"/>Testing corner cases</h2>
			<p>What <a id="_idIndexMarker415"/>happens if <code>PreferenceService</code> returns no records? Will that cause <code>ViewModel</code> to blow up? We can test that:</p>
			<pre class="source-code">
  [Fact]
  public async void AfterCallingInitPreferencesIsEmptyButNo
    Exception()
  {
    // Arrange
    List&lt;Preference&gt; preferences = new(); [1]
    var serviceMock = Substitute.For&lt;IPreferenceService&gt;();
    serviceMock.GetPreferences()
      .Returns(preferences); [2]
    preferencesViewModel = new PreferencesViewModel
      (serviceMock);
    // Act
    var exception = await Record.ExceptionAsync (async ()
      =&gt; await preferencesViewModel.Init()); [3]
    // Assert
    Assert.Null(exception); [4]
  }</pre>
			<p>[1] Set up <code>List&lt;Preference&gt;</code> to be empty.</p>
			<p>[2] Have<a id="_idIndexMarker416"/> the service return the empty preferences list.</p>
			<p>[3] Use <code>Record.ExceptionAsync</code> and pass in the call to <code>Init</code>. This will return the exception or null if none was thrown.</p>
			<p>[4] Assert that there was no exception thrown.</p>
			<p>A complete description of all the uses of NSubstitute is available at <a href="https://nsubstitute.github.io/help.html">https://nsubstitute.github.io/help.html</a>.</p>
			<h1 id="_idParaDest-175"><a id="_idTextAnchor183"/>Summary</h1>
			<p>In this chapter, we reviewed the critical importance of writing unit tests and comprehensively testing your program. In a nutshell, unit tests allow you to code with confidence, knowing that if you make a change and it breaks something seemingly unrelated, you’ll find out about it immediately.</p>
			<p>We saw that, at times, your unit test must interact with slower external systems (APIs, databases, and more) and that you can keep your subsecond response time by using mocks; the mocking library we chose is <code>NSubstitute</code>, though there are other free mocking systems as well (a very popular one is <strong class="bold">Moq</strong>).</p>
			<p>In order to facilitate using mocks, we looked at dependency injection and briefly reviewed the role of IoC containers. In the next chapter, <em class="italic">Consuming a Rest Service</em>, we will look at getting our data from a cloud-based (Azure) service, rather than mocking the data.</p>
			<h1 id="_idParaDest-176"><a id="_idTextAnchor184"/>Quiz</h1>
			<ol>
				<li value="1">Why is it important to write unit tests?</li>
				<li>Where is most of the code you will test?</li>
				<li>Why do you use mocks?</li>
				<li>Why is dependency injection important for mocks?</li>
			</ol>
			<h1 id="_idParaDest-177"><a id="_idTextAnchor185"/>You try it</h1>
			<p>Identify a method in the ViewModel or service that interacts with the API or database, and write a unit test that uses a mock.</p>
		</div>
		<div><div></div>
		</div>
	

		<div><h1 id="_idParaDest-178"><a id="_idTextAnchor186"/>Part 3 – Advanced Topics</h1>
			<p>In this final part, we will dive into ninja-level topics, including how to interact with a REST-based service (in our case, Azure) and how to modify the appearance of our app based on the runtime data.</p>
			<p>This part has the following chapters:</p>
			<ul>
				<li><a href="B19723_10.xhtml#_idTextAnchor187"><em class="italic">Chapter 10</em></a>, <em class="italic">Consuming REST Services</em></li>
				<li><a href="B19723_11.xhtml#_idTextAnchor216"><em class="italic">Chapter 11</em></a>, <em class="italic">Exploring Advanced Topics</em></li>
			</ul>
		</div>
		<div><div></div>
		</div>
	</body></html>