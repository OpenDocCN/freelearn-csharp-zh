<html><head></head><body>
        

                            
                    <h1 class="header-title" id="calibre_pb_0">User Interface and System Feedback</h1>
                
            
            
                
<p class="calibre3">Have you ever seen the top of an iceberg? Well, so far, that's what we have done throughout the previous six chapters. In this chapter, we will keep on improving on our game's user interface and feedback system. We will create a heads-up display that will be responsible for managing the user interaction with the system menus, as well as the system giving feedback to the player.</p>
<p class="calibre3">In this chapter, we will cover the following:</p>
<ul class="calibre11">
<li class="calibre12">Designing a heads-up display</li>
<li class="calibre12">HUD basics</li>
<li class="calibre12">Our design</li>
<li class="calibre12">HUD framework</li>
<li class="calibre12">Completing our HUD design</li>
<li class="calibre12">Character info panel</li>
<li class="calibre12">Active items panel</li>
<li class="calibre12">Special items panel</li>
<li class="calibre12">Integrating the code</li>
<li class="calibre12">Enemy stats in the HUD</li>
<li class="calibre12">NPC stats user interface</li>
<li class="calibre12">Creating the NPC canvas</li>
<li class="calibre12">NPC taking a hit</li>
<li class="calibre12">Enhancing the code</li>
</ul>
<p class="calibre3">Let's get started!</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Designing a heads-up display</h1>
                
            
            
                
<p class="calibre3">Designing a <strong class="calibre5">Heads-Up Display</strong> (<strong class="calibre5">HUD</strong>) is a very challenging task. The HUD is the interface through which your players can interact with the virtual world and receive feedback from the virtual world environment. As with everything else we have designed so far, the HUD design is also heavily related to the type and the needs of the game you are trying to make.</p>
<p class="calibre3">For instance, a <strong class="calibre5">Real-Time Strategy</strong> (<strong class="calibre5">RTS</strong>) game will have a very different type of HUD design to a <strong class="calibre5">First-Person Shooter</strong> (<strong class="calibre5">FPS</strong>) or a <strong class="calibre5">Role-Playing Game</strong> (<strong class="calibre5">RPG</strong>). They will have some things in common, but their individual design is very distinctive, as well as some of the features and functionality.</p>
<p class="calibre3">We could have a whole book just about the design and development of user interfaces and how to approach them in a scientific manner. But that is outside the scope of this book, and we are concerned with the theories.</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">HUD basics</h1>
                
            
            
                
<p class="calibre3">Any simple heads-up display will have, at a minimum, a way to display the following information:</p>
<ul class="calibre11">
<li class="calibre12">Basic information about the player character</li>
<li class="calibre12">Health</li>
<li class="calibre12">Mana</li>
<li class="calibre12">Strength</li>
<li class="calibre12">Level</li>
<li class="calibre12">Current inventory items consumed by the player character</li>
<li class="calibre12">Current weapon used by the player</li>
<li class="calibre12">Current armor used by the player</li>
<li class="calibre12">Available potions and/or health</li>
<li class="calibre12">Feedback from the game environment</li>
<li class="calibre12">Anything useful pertaining to the game</li>
<li class="calibre12">Power ups</li>
<li class="calibre12">Level ups</li>
</ul>
<p class="calibre3">Let's go ahead and design our HUD. Once again, we will start with a simple framework and slowly build on top of it as and when we need to.</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Our design</h1>
                
            
            
                
<p class="calibre3">Taking everything into consideration, let's go ahead and design a HUD that will be useful for our game. At the same time, we will keep it simple but useful. We should have a HUD that will display the basic player character information in a manner that does not block the gameplay, but at the same time gives critical information to the player regarding their character's state.</p>
<p class="calibre3">We should also design a way to display the current inventory items the player has activated to be used, such as the weapon or the armor. Finally, we should also have a simple way for the player to use any health packets and/or potions they might have during gameplay.</p>
<p class="calibre3">The following figure shows a quick sketch of how I want my HUD to look. Again, you are free, and in fact, I encourage you, to come up with your own design:</p>
<div><img src="img/00145.jpeg" class="calibre119"/></div>
<p class="calibre3">I have clearly marked roughly how I would like my HUD to look during gameplay.</p>
<p class="calibre3">Notice that I have kept it simple. In the top-left corner, I have placed the immediate information that the player will need to have, such as their health and perhaps their strength.</p>
<p class="calibre3">In the bottom-left corner, I have placed a scroll-able panel that will list all of the active inventory items that the player may have active on their player character, and on the right-hand side of the screen I have three slots that will be used for immediate access to things such as health packets and/or potions that the player might need to use during their gameplay.</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">HUD framework</h1>
                
            
            
                
<p class="calibre3">Now that we have an understanding of how we want our UI to look, let's start implementing it in Unity. We need to create a new canvas to hold our HUD. To create the canvas, right-click in the Hierarchy window and select UI | Canvas. Rename the new canvas GameObject  <kbd class="calibre13">CanvasHUD</kbd>.</p>
<p class="calibre3">Let's go ahead and put into place all of the different sections for our UI. We will need three main panels for each section, as indicated in the following screenshot.</p>
<p class="calibre3">We need a panel to hold the character information in the top-left corner of the screen. We will also need a panel to hold the active inventory items in the bottom-left corner of the screen, and another panel to hold the special items on the right-hand side of the screen.</p>
<p class="calibre3">Create each panel by right-clicking the Hierarchy window and selecting UI | Panel. Make sure the panels are a child of the <kbd class="calibre13">CanvasHUD</kbd> GameObject. Rename each panel accordingly. I have named mine: <kbd class="calibre13">PanelCharacterInfo</kbd>, <kbd class="calibre13">PanelActiveItems</kbd>, and <kbd class="calibre13">PanelSpecialItems</kbd>. Take a look at the following screenshot:</p>
<div><img src="img/00146.jpeg" class="calibre120"/></div>
<p>Initial HUD outline</p>
<p class="calibre3"/>
<p class="calibre3"/>
<p class="calibre3">The preceding screenshot gives you a feeling of the HUD framework.</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Completing our HUD design</h1>
                
            
            
                
<p class="calibre3">Now that we have the framework in place, let's go ahead and complete each section individually. I would like to start with the <kbd class="calibre13">PanelCharacterInfo</kbd>.</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Character info panel</h1>
                
            
            
                
<p class="calibre3">From a design point of view, the panel that will contain the visual components for the character will be very complex. The panel will be composed of five images.</p>
<p class="calibre3">The main image will be used to hold an avatar of the character. The other four images will be used to display the health and mana of the character. Since these values will be displayed in a bar format, we will be using two images per item. One of the images will host the border, and the other the representation of the actual value.</p>
<p class="calibre3">To come up with the images, I will use external tools such as Photoshop; Microsoft Expression Design is a good tool for creating frames and so on. Take a look at the following screenshot:</p>
<div><img src="img/00147.jpeg" class="calibre121"/></div>
<p class="calibre3">In the preceding screenshot, I have made a nice image portraying the avatar of the player character. You should take into consideration the actual size of the image you will be placing inside the <kbd class="calibre13">PanelCharacterInfo</kbd> panel. The image size I have generated is 301 × 301 pixels.</p>
<p class="calibre3">To create the graphics for the bars representing the health and the mana for our character player, we will actually need to have three images. One image representing the negative value for the bar, one image representing the positive value of the bar, and the third will be the boarder image for the bar. They will be overlaid on top of each other to give the illusion of our graphic bars, as shown in the following screenshot:</p>
<div><img src="img/00148.jpeg" class="calibre45"/></div>
<p>Health bar graphics</p>
<p class="calibre3">Creating the three distinct sprites and overlaying them will give you a good illusion of what you are looking for.</p>
<p class="calibre3">After exporting our images, we need to import them into Unity. Use your file system to move your images from their original location to the <kbd class="calibre13">Assets</kbd> folder under your Unity project.</p>
<p class="calibre3"/>
<p class="calibre3">I have placed my textures in the following directory: Assets | RPG_2E | Textures.</p>
<p class="calibre3">Once you have moved them into the desired location within your Unity project, you will need to convert the images to sprites. Select all of the images that will be used for GUI, and from the Inspector window, change the Texture Type to Sprite (2D and UI). Take a look at the following screenshot:</p>
<div><img src="img/00149.jpeg" class="calibre45"/></div>
<p>Image import properties</p>
<p class="calibre3">It's time to apply our textures to the actual UI elements we have defined under the <kbd class="calibre13">PanelCharacterInfo</kbd> panel within the <kbd class="calibre13">Canvas</kbd> object.</p>
<p>Note: There are a few steps that need to be performed before we can fully apply the UI elements to the HUD.</p>
<p class="calibre3">The first thing you should do if you have not done so already is creating three new UI image elements under the <kbd class="calibre13">PanelCharacterInfo</kbd> panel by right-clicking the panel and selecting UI | Image.</p>
<p class="calibre3">I have named my three images <kbd class="calibre13">imgHealthRebBackground</kbd>, <kbd class="calibre13">imgHealthGreenBackground</kbd> and <kbd class="calibre13">imgHealthBorder</kbd>. The order of the images does matter. You should take a note of it when you are designing the UI. Generally speaking, if a UI element is lower in the hierarchy, it will be rendered on top of the other elements.</p>
<p class="calibre3">Take a look at the following screenshot:</p>
<div><img src="img/00150.jpeg" class="calibre45"/></div>
<p>Health-bar hookup</p>
<p class="calibre3">Notice the order of the images representing the health bar. The image that represents the green bar will need to be modified using the <em class="calibre14">Inspector </em>w<em class="calibre14">indow</em>. Select it, and change the <em class="calibre14">Image Type</em> to Filled, change the <em class="calibre14">Fill Method</em> to <em class="calibre14">Horizontal</em> and the <em class="calibre14">Fill Origin</em> to <em class="calibre14">Left</em>. We will be using the <em class="calibre14">Fill Amount</em> to control the visual part of our health bar. Notice that I have set it to <kbd class="calibre13">0.77</kbd> for demonstration purposes.</p>
<p class="calibre3"/>
<p class="calibre3">By default, when the game starts, we will be starting at a <em class="calibre14">Fill Amount</em> of <kbd class="calibre13">1</kbd>, which is equivalent to 100 percent for the player character's health. <kbd class="calibre13">0.77</kbd> is equivalent to 77 percent and so on.</p>
<p class="calibre3">We will apply the same technique for our mana bar. Go ahead and create two more images, which will represent the two backgrounds for our mana bar.</p>
<p>Note: We will be using the same border image for both bars.</p>
<p class="calibre3">Again, don't forget you will need to make the appropriate changes to the imported textures within Unity. Convert them to Sprite <em class="calibre14">(2D and UI) Texture Type</em>.</p>
<p class="calibre3">Create the necessary image UI elements under the panel, and apply the textures to the image element within the canvas. You should have something like the following screenshot:</p>
<div><img src="img/00151.jpeg" class="calibre122"/></div>
<p>Mana-bar hookup</p>
<p class="calibre3">That's all there is to it! Not bad for a person with no artistic background!</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Active inventory items panel</h1>
                
            
            
                
<p class="calibre3">Creating the UI for active inventory items is similar to what we have done in <a target="_blank" href="part0122.html#3KB4K0-7a1ef7ae3ef249cdb149f8344d2e8e79" class="calibre10">Chapter 6</a>, <em class="calibre14">Inventory System</em>. The difference is that we will be listing only the items that have been consumed by the player character using the inventory system.</p>
<p class="calibre3">In other words, the Active Inventory Items display is a visual indication of the items that have been activated within the inventory. It is important to keep in mind that we are more interested in learning the concepts and applying them in a simple example that you can expand upon and improve on your own.</p>
<p class="calibre3">The basic idea is to create a scroll-able panel that will be used to add items as needed. We have already seen how to set up the scroll-able view and how to configure the UI components to support what we are trying to achieve. I won't be getting into the details here again; please refer to <a target="_blank" href="part0122.html#3KB4K0-7a1ef7ae3ef249cdb149f8344d2e8e79" class="calibre10">Chapter 6</a>, <em class="calibre14">Inventory System</em> for the necessary steps if needed.</p>
<p class="calibre3">From the <em class="calibre14">Hierarchy</em> window right-click on PanelActiveInventoryItems and select <em class="calibre14">UI</em> | <em class="calibre14">Scroll View</em>. Go ahead and remove the <kbd class="calibre13">Viewport</kbd><em class="calibre14">,</em> <kbd class="calibre13">Scrollbar Horizontal</kbd> and <kbd class="calibre13">Scrollbar Vertical</kbd> children that have been created with the <kbd class="calibre13">Scroll View</kbd> element.</p>
<p class="calibre3">You just need to make sure that the layout configuration you are applying is for horizontal and not vertical, as we did in <a target="_blank" href="part0122.html#3KB4K0-7a1ef7ae3ef249cdb149f8344d2e8e79" class="calibre10">Chapter 6</a>, <em class="calibre14">Inventory System</em>. Take a look at the following screenshot:</p>
<div><img src="img/00152.jpeg" class="calibre45"/></div>
<p>Active inventory panel</p>
<p class="calibre3">Double-check your anchors and alignments in the UI elements:</p>
<div><img src="img/00153.jpeg" class="calibre45"/></div>
<p class="calibre3"/>
<p class="calibre3"/>
<p class="calibre3">And finally, take a look at the following screenshot:</p>
<div><img src="img/00154.jpeg" class="calibre45"/></div>
<p class="calibre3">The three preceding figures illustrate the different parts of the configuration for the Active Inventory Items panel. If you are unsure of how to put this together, please go back to <a target="_blank" href="part0122.html#3KB4K0-7a1ef7ae3ef249cdb149f8344d2e8e79" class="calibre10">Chapter 6</a>, <em class="calibre14">Inventory System</em>, and read the <em class="calibre14">Designing a Dynamic Item Viewer</em> section.</p>
<p class="calibre3">Don't forget to make a prefab of the UI element that will be representing your active inventory item in the panel.</p>
<p class="calibre3">You will also need a script to reference the UI elements designated for your items. I have called this script <kbd class="calibre13">ActiveInventoryItemUi.cs</kbd>, and currently, there are two attributes; one is a reference to the <kbd class="calibre13">Image</kbd> element and the other a reference to the <kbd class="calibre13">Text</kbd> element.</p>
<p class="calibre3">The listing for the script is as follows:</p>
<pre class="calibre18">using UnityEngine;<br class="title-page-name"/>using UnityEngine.UI;<br class="title-page-name"/>namespace com.noorcon.rpg2e<br class="title-page-name"/>{<br class="title-page-name"/>public class ActiveInventoryItemUi : MonoBehaviour<br class="title-page-name"/>{<br class="title-page-name"/>public InventoryItem item;<br class="title-page-name"/>public Image imgActiveItem;<br class="title-page-name"/>public Text txtActiveItem;<br class="title-page-name"/>}<br class="title-page-name"/>}</pre>
<p class="calibre3">We will eventually need to integrate all of these scripts together to make things work properly.</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Special items panel</h1>
                
            
            
                
<p class="calibre3">Now we will look at the design of our last panel. The main difference between this panel and the last one we developed is the orientation. Everything else will be exactly the same. However, for this panel, our orientation will be vertical instead of horizontal.</p>
<p class="calibre3">Here is a screenshot capturing everything at once:</p>
<div><img src="img/00155.jpeg" class="calibre45"/></div>
<p>Special items panel</p>
<p class="calibre3"/>
<p class="calibre3">The procedure to create the panel has already been discussed several times, and you should not have any trouble creating it.</p>
<p>I have let you make your own textures and images to apply to the UI elements.</p>
<p class="calibre3">While designing the Special Items panel, I came up with a better idea of how to improve the panel UI. You might want to have a static icon representing each special item, and have a counter attached to the UI representing how many of each item you have. Each time you collect one, it will increase, and each time you consume one it will decrease.</p>
<p class="calibre3">The following screenshot shows how the current HUD looks based on our design:</p>
<div><img src="img/00156.jpeg" class="calibre45"/></div>
<p>Active inventory and special inventory runtime</p>
<p class="calibre3">We now need to start thinking about the integration of the HUD user interface with the code base we have developed so far.</p>
<p class="calibre3"/>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Integrating the code</h1>
                
            
            
                
<p class="calibre3">Now that we have our HUD design up and running, we will need to integrate the UI elements with the actual code that will be deriving them. There are a few scripts that will be created to support the new UI features and a few that will be updated to glue everything together.</p>
<p class="calibre3">The following scripts have been created: <kbd class="calibre13">ActiveInventoryItemUi.cs</kbd>, <kbd class="calibre13">ActiveSpecialItemUi.cs</kbd>, and <kbd class="calibre13">HudElementUi.cs</kbd>.</p>
<p class="calibre3">The listing of these scripts is as follows:</p>
<pre class="calibre18">using UnityEngine.EventSystems;<br class="title-page-name"/>namespace com.noorcon.rpg2e<br class="title-page-name"/>{<br class="title-page-name"/>public class ActiveSpecialItemUi : EventTrigger<br class="title-page-name"/>{<br class="title-page-name"/>public override void OnPointerClick(PointerEventData data)<br class="title-page-name"/>{<br class="title-page-name"/>InventoryItem iia =<br class="title-page-name"/>gameObject.GetComponent&lt;ActiveInventoryItemUi&gt;().item;<br class="title-page-name"/>switch (iia.Category)<br class="title-page-name"/>{<br class="title-page-name"/>case BaseItem.ItemCatrgory.Health:<br class="title-page-name"/>{<br class="title-page-name"/>// add the item to the special items panel<br class="title-page-name"/>GameMaster.instance.Ui.ApplySpecialInventoryItem(iia);<br class="title-page-name"/>Destroy(gameObject);<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>case BaseItem.ItemCatrgory.Potion:<br class="title-page-name"/>{<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>using UnityEngine;<br class="title-page-name"/>using UnityEngine.UI;<br class="title-page-name"/>namespace com.noorcon.rpg2e<br class="title-page-name"/>{<br class="title-page-name"/>public class HudElementUi : MonoBehaviour<br class="title-page-name"/>{<br class="title-page-name"/>public Image imgHealthBar;<br class="title-page-name"/>public Image imgManaBar;<br class="title-page-name"/>public GameObject activeInventoryItem;<br class="title-page-name"/>public GameObject activeSpecialItem;<br class="title-page-name"/>public Transform panelActiveInventoryItems;<br class="title-page-name"/>public Transform panelActiveSpecialItems;<br class="title-page-name"/>}<br class="title-page-name"/>}</pre>
<p class="calibre3">These scripts will be used on the HUD user interface to give us access to the elements. For instance, you will need to attach the <kbd class="calibre13">HudElementUi.cs</kbd> script to the <kbd class="calibre13">CanvasHUD</kbd> GameObject. Take a look at the following screenshot:</p>
<div><img src="img/00157.jpeg" class="calibre45"/></div>
<p>HUD canvas</p>
<p class="calibre3">The preceding screenshot illustrates how the HUD canvas is configured with the <kbd class="calibre13">HUDElementsUI.cs</kbd> script.</p>
<p class="calibre3"/>
<p class="calibre3">Now let's take a look at the prefabs we have created to represent the UI elements to be used for the panels. There are two; I have named them <kbd class="calibre13">PanelActiveItem</kbd> and <kbd class="calibre13">PanelSpecialItem</kbd>.</p>
<p class="calibre3">I will discuss <kbd class="calibre13">PanelSpecialItem</kbd> as it contains everything <kbd class="calibre13">PanelActiveItem</kbd> contains plus an additional script, which is attached to it for event handling. Take a look at the following screenshot:</p>
<div><img src="img/00158.jpeg" class="calibre45"/></div>
<p>HUD event triggers</p>
<p class="calibre3">What we have just covered was the implementation of the scripts that are used to have access to the proper UI elements within the HUD canvas.</p>
<p class="calibre3"/>
<p class="calibre3">You will notice that for the <kbd class="calibre13">PanelSpecialItem</kbd> prefab, we have two new and very important components that we have attached to it. One is the <strong class="calibre5">Event Trigger</strong> within Unity, and the other is the <kbd class="calibre13">ActiveSpecialItemUi.cs</kbd> script, which is used to handle the <kbd class="calibre13">PointerClick</kbd> event for the special item.</p>
<p class="calibre3">What this means is that we are basically making the item clickable, and when the player clicks on the item, something happens. In this case, it applies the special item to the player character.</p>
<p class="calibre3">Now we are ready to update the other scripts we have already developed to incorporate the HUD functionality. The scripts that will need to be modified are <kbd class="calibre13">InventorySystem.cs</kbd> and <kbd class="calibre13">UiController.cs</kbd>.</p>
<p class="calibre3">The listing of <kbd class="calibre13">InventorySystem.cs</kbd> is as follows:</p>
<pre class="calibre18">using System;<br class="title-page-name"/>using System.Collections.Generic;<br class="title-page-name"/>using UnityEngine;<br class="title-page-name"/>namespace com.noorcon.rpg2e<br class="title-page-name"/>{<br class="title-page-name"/>[Serializable]<br class="title-page-name"/>public class InventorySystem<br class="title-page-name"/>{<br class="title-page-name"/>[SerializeField]<br class="title-page-name"/>private List&lt;InventoryItem&gt; weapons<br class="title-page-name"/>= new List&lt;InventoryItem&gt;();<br class="title-page-name"/>[SerializeField]<br class="title-page-name"/>private List&lt;InventoryItem&gt; armour<br class="title-page-name"/>= new List&lt;InventoryItem&gt;();<br class="title-page-name"/>[SerializeField]<br class="title-page-name"/>private List&lt;InventoryItem&gt; clothing<br class="title-page-name"/>= new List&lt;InventoryItem&gt;();<br class="title-page-name"/>[SerializeField]<br class="title-page-name"/>private List&lt;InventoryItem&gt; health<br class="title-page-name"/>= new List&lt;InventoryItem&gt;();<br class="title-page-name"/>[SerializeField]<br class="title-page-name"/>private List&lt;InventoryItem&gt; potion<br class="title-page-name"/>= new List&lt;InventoryItem&gt;();<br class="title-page-name"/>public List&lt;InventoryItem&gt; Weapons<br class="title-page-name"/>{<br class="title-page-name"/>get { return weapons; }<br class="title-page-name"/>}<br class="title-page-name"/>public List&lt;InventoryItem&gt; Armour<br class="title-page-name"/>{<br class="title-page-name"/>get { return armour; }<br class="title-page-name"/>}<br class="title-page-name"/>public List&lt;InventoryItem&gt; Clothing<br class="title-page-name"/>{<br class="title-page-name"/>get { return clothing; }<br class="title-page-name"/>}<br class="title-page-name"/>public List&lt;InventoryItem&gt; Health<br class="title-page-name"/>{<br class="title-page-name"/>get { return health; }<br class="title-page-name"/>}<br class="title-page-name"/>public List&lt;InventoryItem&gt; Potion<br class="title-page-name"/>{<br class="title-page-name"/>get { return potion; }<br class="title-page-name"/>}<br class="title-page-name"/>private InventoryItem selectedWeapon;<br class="title-page-name"/>private InventoryItem selectedArmour;<br class="title-page-name"/>public InventoryItem SelectedWeapon<br class="title-page-name"/>{<br class="title-page-name"/>get { return selectedWeapon; }<br class="title-page-name"/>set { selectedWeapon = value; }<br class="title-page-name"/>}<br class="title-page-name"/>public InventoryItem SelectedArmour<br class="title-page-name"/>{<br class="title-page-name"/>get { return selectedArmour; }<br class="title-page-name"/>set { selectedArmour = value; }<br class="title-page-name"/>}<br class="title-page-name"/>public InventorySystem()<br class="title-page-name"/>{<br class="title-page-name"/>ClearInventory();<br class="title-page-name"/>}</pre>
<p class="calibre3">The listing for <kbd class="calibre13">ClearInventory()</kbd> and <kbd class="calibre13">AddItem()</kbd> is as follows:</p>
<pre class="calibre18">public void ClearInventory()<br class="title-page-name"/>{<br class="title-page-name"/>weapons.Clear();<br class="title-page-name"/>armour.Clear();<br class="title-page-name"/>clothing.Clear();<br class="title-page-name"/>health.Clear();<br class="title-page-name"/>potion.Clear();<br class="title-page-name"/>}<br class="title-page-name"/>// this function will add an inventory item<br class="title-page-name"/>public void AddItem(InventoryItem item)<br class="title-page-name"/>{<br class="title-page-name"/>switch (item.Category)<br class="title-page-name"/>{<br class="title-page-name"/>case BaseItem.ItemCatrgory.Armour:<br class="title-page-name"/>{<br class="title-page-name"/>armour.Add(item);<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>case BaseItem.ItemCatrgory.Clothing:<br class="title-page-name"/>{<br class="title-page-name"/>clothing.Add(item);<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>case BaseItem.ItemCatrgory.Health:<br class="title-page-name"/>{<br class="title-page-name"/>health.Add(item);<br class="title-page-name"/>GameMaster.instance.Ui.AddSpecialInventoryItem(item);<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>case BaseItem.ItemCatrgory.Potion:<br class="title-page-name"/>{<br class="title-page-name"/>potion.Add(item);<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>case BaseItem.ItemCatrgory.Weapon:<br class="title-page-name"/>{<br class="title-page-name"/>weapons.Add(item);<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}</pre>
<p class="calibre3"><kbd class="calibre13">DeleteItem()</kbd> will remove a given <kbd class="calibre13">InventoryItem</kbd> from the list. See the following code:</p>
<pre class="calibre18">// this function will remove an inventory item<br class="title-page-name"/>public void DeleteItem(InventoryItem item)<br class="title-page-name"/>{<br class="title-page-name"/>switch (item.Category)<br class="title-page-name"/>{<br class="title-page-name"/>case BaseItem.ItemCatrgory.Armour:<br class="title-page-name"/>{<br class="title-page-name"/>armour.Remove(item);<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>case BaseItem.ItemCatrgory.Clothing:<br class="title-page-name"/>{<br class="title-page-name"/>clothing.Remove(item);<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>case BaseItem.ItemCatrgory.Health:<br class="title-page-name"/>{<br class="title-page-name"/>// let's find the item and mark it for removal<br class="title-page-name"/>InventoryItem tmp = null;<br class="title-page-name"/>foreach (InventoryItem i in this.health)<br class="title-page-name"/>{<br class="title-page-name"/>if (item.Category.Equals(i.Category)<br class="title-page-name"/>&amp;&amp; item.Name.Equals(i.Name)<br class="title-page-name"/>&amp;&amp; item.Strength.Equals(i.Strength))<br class="title-page-name"/>{<br class="title-page-name"/>tmp = i;<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>health.Remove(tmp);<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>case BaseItem.ItemCatrgory.Potion:<br class="title-page-name"/>{<br class="title-page-name"/>// let's find the item and mark it for removal<br class="title-page-name"/>InventoryItem tmp = null;<br class="title-page-name"/>foreach (InventoryItem i in this.health)<br class="title-page-name"/>{<br class="title-page-name"/>if (item.Category.Equals(i.Category)<br class="title-page-name"/>&amp;&amp; item.Name.Equals(i.Name)<br class="title-page-name"/>&amp;&amp; item.Strength.Equals(i.Strength))<br class="title-page-name"/>{<br class="title-page-name"/>tmp = i;<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>potion.Remove(tmp);<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>case BaseItem.ItemCatrgory.Weapon:<br class="title-page-name"/>{<br class="title-page-name"/>weapons.Remove(item);<br class="title-page-name"/>break;<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}</pre>
<p class="calibre3">The listing for <kbd class="calibre13">UiController.cs</kbd> is as follows:</p>
<pre class="calibre18">using System;<br class="title-page-name"/>using UnityEngine;<br class="title-page-name"/>using UnityEngine.UI;<br class="title-page-name"/>namespace com.noorcon.rpg2e<br class="title-page-name"/>{<br class="title-page-name"/>public class UiController : MonoBehaviour<br class="title-page-name"/>{<br class="title-page-name"/>[Header("Main Menu Canvas")]<br class="title-page-name"/>public RectTransform MainMenuCanvas;<br class="title-page-name"/>[Header("Settings Window")]<br class="title-page-name"/>public RectTransform OptionsPanel;<br class="title-page-name"/>public Slider ControlMainVolume;<br class="title-page-name"/>public Slider ControlFXVolume;<br class="title-page-name"/>[Header("Inventory Window")]<br class="title-page-name"/>public RectTransform InventoryCanvas;<br class="title-page-name"/>[Tooltip("root for inventory items")]<br class="title-page-name"/>public Transform InventoryPanelItem;<br class="title-page-name"/>[Tooltip("prefab representing invenotry item UI")]<br class="title-page-name"/>public GameObject InventoryItemElement;<br class="title-page-name"/>[Header("HUD Window")]<br class="title-page-name"/>public RectTransform HudCanvas;<br class="title-page-name"/>public HudElementUi HudUi;<br class="title-page-name"/><a href="https://github.com/PacktPublishing/Building-an-RPG-with-Unity-2018-Second-Edition" class="calibre83">...</a><br class="title-page-name"/><br class="title-page-name"/>public void DisplaySettings()<br class="title-page-name"/>{<br class="title-page-name"/>GameMaster.instance.DisplaySettings = !GameMaster.instance.DisplaySettings;<br class="title-page-name"/>OptionsPanel.gameObject.SetActive(GameMaster.instance.DisplaySettings);<br class="title-page-name"/>}
public void MainVolume()
GameMaster.instance.MasterVolume(ControlMainVolume.value);
}
public void FXVolume()
{
GameMaster.instance.SoundFxVolume(ControlFXVolume.value);
}
#region INVENTORY UI FUNCTIONS
public void DisplayInventory()
{
InventoryCanvas.gameObject.SetActive(GameMaster.instance.DisplayInventory);<br class="title-page-name"/>Debug.Log("Display Inventory Function");<br class="title-page-name"/>}<br class="title-page-name"/>public void DisplayWeaponsCategory()<br class="title-page-name"/>{<br class="title-page-name"/>if (GameMaster.instance.DisplayInventory)<br class="title-page-name"/>{<br class="title-page-name"/>ClearInventoryPanelItems();<br class="title-page-name"/>foreach (InventoryItem item in GameMaster.instance.Inventory.Weapons)<br class="title-page-name"/>{<br class="title-page-name"/>GameObject newItem<br class="title-page-name"/>= Instantiate(InventoryItemElement) as GameObject;<br class="title-page-name"/>InventoryItemUi InventoryItemControl<br class="title-page-name"/>= newItem.GetComponent&lt;InventoryItemUi&gt;();<br class="title-page-name"/>InventoryItemControl.ItemElementText.text =<br class="title-page-name"/>string.Format("Name: {0}, Description: {1}, Strength: {2}, Weight:<br class="title-page-name"/>{3}",<br class="title-page-name"/>item.Name,<br class="title-page-name"/>item.Description,<br class="title-page-name"/>item.Strength,<br class="title-page-name"/>item.Weight);<br class="title-page-name"/>InventoryItemControl.Item = item;<br class="title-page-name"/>// button triggers<br class="title-page-name"/>InventoryItemControl.AddButton.GetComponent&lt;Button&gt;().onClick.AddListener(() =&gt;<br class="title-page-name"/>{<br class="title-page-name"/>Debug.Log(string.Format("ADD button for {0}",<br class="title-page-name"/>InventoryItemControl.ItemElementText.text));<br class="title-page-name"/>// apply selected weapon<br class="title-page-name"/>GameMaster.instance.PlayerCharacterData.SelectedWeapon<br class="title-page-name"/>= (PlayerCharacter.WeaponType)Enum.Parse(<br class="title-page-name"/>typeof(PlayerCharacter.WeaponType), InventoryItemControl.Item.Name);<br class="title-page-name"/>GameMaster.instance.PlayerWeaponChanged();<br class="title-page-name"/>AddActiveInventoryItem(InventoryItemControl.Item);<br class="title-page-name"/>});<br class="title-page-name"/>InventoryItemControl.DeleteButton.GetComponent&lt;Button&gt;().onClick.AddListener(() =&gt;<br class="title-page-name"/>{<br class="title-page-name"/>Debug.Log(string.Format("DELETE button for {0}",<br class="title-page-name"/>InventoryItemControl.ItemElementText.text));<br class="title-page-name"/>Destroy(newItem);<br class="title-page-name"/>});<br class="title-page-name"/>newItem.transform.SetParent(InventoryPanelItem);<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}</pre>
<p class="calibre3">A portion of script is listed as follows. Please refer to the download package for the full listing:</p>
<pre class="calibre18">public void DisplayArmourCategory()<br class="title-page-name"/>{<br class="title-page-name"/>if (GameMaster.instance.DisplayInventory)<br class="title-page-name"/>{<br class="title-page-name"/>ClearInventoryPanelItems();<br class="title-page-name"/>foreach (InventoryItem item in GameMaster.instance.Inventory.Armour)<br class="title-page-name"/>{<br class="title-page-name"/>GameObject newItem<br class="title-page-name"/>= Instantiate(InventoryItemElement) as GameObject;<br class="title-page-name"/>InventoryItemUi InventoryItemControl<br class="title-page-name"/>= newItem.GetComponent&lt;InventoryItemUi&gt;();<br class="title-page-name"/>InventoryItemControl.ItemElementText.text =<br class="title-page-name"/>string.Format("Name: {0}, Description: {1}, Strength: {2}, Weight:<br class="title-page-name"/>{3}",<br class="title-page-name"/>item.Name,<br class="title-page-name"/>item.Description,<br class="title-page-name"/>item.Strength,<br class="title-page-name"/>item.Weight);<br class="title-page-name"/>InventoryItemControl.Item = item;<br class="title-page-name"/>// button triggers<br class="title-page-name"/>InventoryItemControl.AddButton.GetComponent&lt;Button&gt;().onClick.AddListener(() =&gt;<br class="title-page-name"/>{<br class="title-page-name"/>Debug.Log(string.Format("ADD button for {0}",<br class="title-page-name"/>InventoryItemControl.ItemElementText.text));<br class="title-page-name"/>// apply selected weapon<br class="title-page-name"/>GameMaster.instance.PlayerCharacterData.SelectedArmour = InventoryItemControl.Item;<br class="title-page-name"/>GameMaster.instance.PlayerArmourChanged(InventoryItemControl.Item);<br class="title-page-name"/>AddActiveInventoryItem(InventoryItemControl.Item);<br class="title-page-name"/>});<br class="title-page-name"/>InventoryItemControl.DeleteButton.GetComponent&lt;Button&gt;().onClick.AddListener(() =&gt;<br class="title-page-name"/>{<br class="title-page-name"/>Debug.Log(string.Format("DELETE button for {0}",<br class="title-page-name"/>InventoryItemControl.ItemElementText.text));<br class="title-page-name"/>Destroy(newItem);<br class="title-page-name"/>});<br class="title-page-name"/>newItem.transform.SetParent(InventoryPanelItem);<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/><a href="https://github.com/PacktPublishing/Building-an-RPG-with-Unity-2018-Second-Edition" class="calibre83">...</a></pre>
<p class="calibre3">Now that you have everything in place, you can go ahead and test run the game to make sure everything is working as expected. This is also a good time to test/debug your code and your project settings if you have not done so already.</p>
<p class="calibre3">I have to make the following point once again: the idea is to grasp the concept. We are looking at one way to implement what we want to achieve; you might come up with a better method along the way, or decide to do something totally different. I encourage that!</p>
<p class="calibre3"/>
<p class="calibre3">Take a look at the following screenshot:</p>
<div><img src="img/00159.jpeg" class="calibre45"/></div>
<p>Initial state</p>
<p class="calibre3">The preceding screenshot illustrates the state of the player character and that of the inventory when the level initially loads. I have indicated the critical parts that we are testing and will track, to make sure our code works properly.</p>
<p class="calibre3">In the next figure, the player character has picked up a few of the inventory items we have laid on the level. When you bring up the Inventory window and click on any one of the categories defined, such as weapons, you will get a listing of all the weapons that we have in our inventory, and so forth.</p>
<p class="calibre3">We have collected one weapon type, one health packet, and a couple of defensive items. Note that our Special Items panel is displaying an item. This is the health packet we have picked up:</p>
<div><img src="img/00160.jpeg" class="calibre45"/></div>
<p>Special item interaction</p>
<p class="calibre3">The next screenshot illustrates how the HUD updates itself when the player starts to consume some of the inventory items by adding them using the Inventory window during gameplay.</p>
<p class="calibre3">Notice that we have activated three inventory items: two weapons, named axe2 and club1, and two armors of type SP04 and SP03 respectively.</p>
<p class="calibre3"/>
<p class="calibre3">You can visually see them on the player character as well as the panel holding the active inventory items. Pretty cool:</p>
<div><img src="img/00161.jpeg" class="calibre45"/></div>
<p>Active panel interaction</p>
<p class="calibre3">It's time to go and meet the enemy. We have not discussed much about the interaction between the player character and the <strong class="calibre5">non-player characters</strong> (<strong class="calibre5">NPCs</strong>). We will do this shortly.</p>
<p class="calibre3">We have applied some of the inventory items from our inventory to the player character, and now we can actually go and face the enemy. We will allow the enemy to attack us, to see how our health reduces. Then we will use the health packet from our special items panel to increase our health once more.</p>
<p class="calibre3">The two following screenshots illustrate this scenario:</p>
<div><img src="img/00162.jpeg" class="calibre45"/></div>
<p class="calibre3"/>
<p class="calibre3">The following screenshot shows us running away and applying our health packet:</p>
<div><img src="img/00163.jpeg" class="calibre123"/></div>
<p class="calibre3">Notice how, when we apply the health packet, it removes itself from the inventory system as well as the special items panel.</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Enemy stats in the HUD</h1>
                
            
            
                
<p class="calibre3">We have not really discussed how to handle and manage the statistics and the visual representation of the NPC with the player. It is now time to do just that! We need to decide what it is that we want to display as information to the player. At the moment, let's keep it simple and just display the basic health and strength of the enemy.</p>
<p class="calibre3">The question is, what is the best way to display this information? Should we display the information based on a distance threshold between the player character and the NPC, or should we display it when the player requests it at some time during gameplay?</p>
<p class="calibre3">Let's go ahead and take the first scenario. We will display the information of the NPC when there is a certain distance between the player character and the NPC. We can even make this distance the same as the line of sight we have set for the NPC! This is good, because, if they can see us, then they are close enough for us to see their stats! Let's get to work!</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">NPC stats user interface</h1>
                
            
            
                
<p class="calibre3">We will be using some of the existing textures that we have created for our player character, such as the textures for the health bar and strength bar. We just need to create a canvas that will be in the world space and attached to the NPC character.</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Creating the NPC canvas</h1>
                
            
            
                
<p class="calibre3">The main differences between the canvas we will create for the NPC and that of the one we have been creating for the player are some of the configurations.</p>
<p class="calibre3">One of the main differences will be the <em class="calibre14">Render Mode</em> of the canvas. The NPC canvas will have a <em class="calibre14">World Space Render Mode</em>. This will allow us to position the canvas as another GameObject within the scene. The next important difference will be the <em class="calibre14">Rect Transform</em> attributes and, more importantly, the <em class="calibre14">Scale</em> and <em class="calibre14">Rotation</em> attributes.</p>
<p class="calibre3"/>
<p class="calibre3">Take a look at the following screenshot:</p>
<div><img src="img/00164.jpeg" class="calibre45"/></div>
<p>NPC health bar</p>
<p class="calibre3">To make life easier, all you need to do is create the canvas and change the properties of the canvas as shown in the preceding screenshot. For the next step, you can copy the whole <kbd class="calibre13">PanelCharacterInfo</kbd> we developed in the previous sections, and paste it as a child of the new canvas. This way, you will not have to recreate each UI element one by one, which will save a lot of time. However, you will need to change the <em class="calibre14">Scale</em> and the Tranform properties on the <kbd class="calibre13">PanelCharacterInfo</kbd> panel—the new one—to arrange it so that it renders above the NPC's head!</p>
<p class="calibre3">The next step is for us to be able to control the values of the stat bars from the code. For this, we will create a new script called <kbd class="calibre13">NPCStatUi.cs</kbd> and attach it to the canvas object we just created for the NPC stats.</p>
<p class="calibre3"/>
<p>I have renamed the canvas <kbd class="calibre85">CanvasNPCStats</kbd>.</p>
<p class="calibre3">The listing of the script is as follows:</p>
<pre class="calibre18">using UnityEngine;<br class="title-page-name"/>using UnityEngine.UI;<br class="title-page-name"/>namespace com.noorcon.rpg2e<br class="title-page-name"/>{<br class="title-page-name"/>public class NpcStatusUi : MonoBehaviour<br class="title-page-name"/>{<br class="title-page-name"/>public Image imgHealthBar;<br class="title-page-name"/>public Image imgManaBar;<br class="title-page-name"/>}<br class="title-page-name"/>}</pre>
<p class="calibre3">The script we just created will only give us a reference to the image elements. We still need to be able to have a method to update the values.</p>
<p class="calibre3">We need to find a way to reference all the NPC characters in a given scene. Once that is determined, we will need to set the initial values of the health and strength bar. Then, during gameplay, we will need to be able to update each NPC's stats according to the state of the game.</p>
<p class="calibre3">In order for us to identify the NPCs in a given scene, we will use the <kbd class="calibre13">Tag</kbd> element defined in each GameObject. We need to create a new <kbd class="calibre13">Tag</kbd> element named <em class="calibre14">Enemy</em>, and every NPC that is of enemy type will need to be tagged as such. This is an easy way to do a quick search and get a list of GameObjects based on their <kbd class="calibre13">Tag</kbd> value.</p>
<p class="calibre3">You should also start thinking about how are you going to dynamically attach the NPC stat canvas to the NPC at runtime. At the moment, for testing purposes, I will leave it attached to the model. But the question is, where do you actually attach it? Well, we have an empty GameObject named <em class="calibre14">Follow</em> attached to our model prefab. Since this is driven from our player character model, we have embedded <em class="calibre14">Follow</em> as a placeholder for the main camera during gameplay. For the NPC, we will use it to attach the NPC canvas as a child GameObject to the <kbd class="calibre13">Follow</kbd> GameObject in the model hierarchy. You can see these in the preceding screenshots.</p>
<p class="calibre3"/>
<p class="calibre3">We will use the <kbd class="calibre13">NpcAgent.cs</kbd> script to initialize the NPC status canvas prefab and the appropriate values of the UI elements. This is the best place to place the initialization because it will be self-contained. The new listing for the script is as follows:</p>
<pre class="calibre18">using UnityEngine;<br class="title-page-name"/>namespace com.noorcon.rpg2e<br class="title-page-name"/>{<br class="title-page-name"/>public class NpcAgent : MonoBehaviour<br class="title-page-name"/>{<br class="title-page-name"/>[SerializeField]<br class="title-page-name"/>public Npc NpcData;<br class="title-page-name"/>[SerializeField]<br class="title-page-name"/>public Transform CanvasAttachmentPoint;<br class="title-page-name"/>[SerializeField]<br class="title-page-name"/>public Canvas CanvasNpcStats;<br class="title-page-name"/>[SerializeField]<br class="title-page-name"/>public GameObject CanvasNpcStatsPrefab;<br class="title-page-name"/>public void SetHealthValue(float value)<br class="title-page-name"/>{<br class="title-page-name"/>CanvasNpcStats.GetComponent&lt;NpcStatusUi&gt;().imgHealthBar.fillAmount =<br class="title-page-name"/>value;<br class="title-page-name"/>}<br class="title-page-name"/>public void SetStrengthValue(float value)<br class="title-page-name"/>{<br class="title-page-name"/>CanvasNpcStats.GetComponent&lt;NpcStatusUi&gt;().imgManaBar.fillAmount =<br class="title-page-name"/>value;<br class="title-page-name"/>}<br class="title-page-name"/>//// Use this for initialization<br class="title-page-name"/>void Start()<br class="title-page-name"/>{<br class="title-page-name"/>// let's go ahead and instantiate our stats<br class="title-page-name"/>GameObject tmpCanvasGO = Instantiate(<br class="title-page-name"/>CanvasNpcStatsPrefab,<br class="title-page-name"/>new Vector3(CanvasAttachmentPoint.position.x, 2, 0),<br class="title-page-name"/>CanvasNpcStatsPrefab.transform.rotation) as GameObject;<br class="title-page-name"/>tmpCanvasGO.transform.SetParent(CanvasAttachmentPoint, false);<br class="title-page-name"/>CanvasNpcStats = tmpCanvasGO.GetComponent&lt;Canvas&gt;();<br class="title-page-name"/>CanvasNpcStats.GetComponent&lt;NpcStatusUi&gt;().imgHealthBar.fillAmount = 1.0f;<br class="title-page-name"/>CanvasNpcStats.GetComponent&lt;NpcStatusUi&gt;().imgManaBar.fillAmount = 1.0f;<br class="title-page-name"/>Npc tmp = new Npc();<br class="title-page-name"/>tmp.Tag = "Enemy";<br class="title-page-name"/>tmp.CharacterGameObject = transform.gameObject;<br class="title-page-name"/>tmp.Name = "B1";<br class="title-page-name"/>tmp.Health = 100.0f;<br class="title-page-name"/>tmp.Defense= 50.0f;<br class="title-page-name"/>tmp.Description = "The Beast";<br class="title-page-name"/>tmp.Dexterity = 33.0f;<br class="title-page-name"/>tmp.Intelligence = 80.0f;<br class="title-page-name"/>tmp.Strength = 60.0f;<br class="title-page-name"/>NpcData = tmp;<br class="title-page-name"/>}<br class="title-page-name"/>//// Update is called once per frame<br class="title-page-name"/>void Update()<br class="title-page-name"/>{<br class="title-page-name"/>if (NpcData.Health &lt; 0.0f)<br class="title-page-name"/>{<br class="title-page-name"/>NpcData.Health = 0.0f;<br class="title-page-name"/>transform.GetComponent&lt;NpcBarbarianMovement&gt;().die = true;<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}</pre>
<p class="calibre3">Note that you will need to assign <kbd class="calibre13">canvasNPCStatsAttachment</kbd><em class="calibre14">,</em> which will be used to store a reference to the GameObject we will attach to the NCP canvas. <kbd class="calibre13">canvasNPCStatsPrefab</kbd> will be used to assign the prefab representing the NPC status canvas at design time. If you run the game now, you will have the prefab instantiated dynamically and attached to the <kbd class="calibre13">Follow</kbd> GameObject in the hierarchy with the fill values set to <kbd class="calibre13">1f</kbd>, that is, 100 percent.</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">NPC taking a hit</h1>
                
            
            
                
<p class="calibre3">We need to take a moment and go back to some of the initial scripts and configurations we did in earlier chapters, where we defined the player character's <em class="calibre14">Animator Controller</em> and <kbd class="calibre13">BarbarianCharacterController.cs</kbd> script.</p>
<p>Note: Please refer to Chapter 3, <em class="calibre30">RPG Character Design</em>, to refresh your memory on Animator Controller and Curves.</p>
<p class="calibre3"/>
<p class="calibre3">Open the animator controller we created in <a target="_blank" href="part0074.html#26I9K0-7a1ef7ae3ef249cdb149f8344d2e8e79" class="calibre10">Chapter 3</a>, <em class="calibre14">RPG Character Design</em>, named <kbd class="calibre13">BarbarianAnimatorController</kbd>. Select the <em class="calibre14">Parameters</em> tab and create new parameters called <em class="calibre14">Attack1, Attack2,</em> and <em class="calibre14">Attack3</em> of the <kbd class="calibre13">float</kbd> datatype. Take a look at the following screenshot:</p>
<div><img src="img/00165.jpeg" class="calibre45"/></div>
<p>Animator State Machine</p>
<p class="calibre3">For a refresher, go back to <a target="_blank" href="part0094.html#2PKKS0-7a1ef7ae3ef249cdb149f8344d2e8e79" class="calibre10">Chapter 4</a>, <em class="calibre14">The Game Mechanics</em>, section <em class="calibre14">PC and NPC Interaction</em>, and you will recall how we defined and configured the curve to assign the parameter based on the animation.</p>
<p>We have defined the curve only for one of the attack animations.</p>
<p class="calibre3">Once you have configured the parameter on the <em class="calibre14">Animator Controller</em> for the player character, then we have to update the <kbd class="calibre13">BarbarianCharacterController.cs</kbd> script to trigger an attack based on the parameter value.</p>
<p class="calibre3">The following listing is a partial listing of the script, displaying just the modified portion:</p>
<pre class="calibre18">void FixedUpdate()<br class="title-page-name"/>{<br class="title-page-name"/>// The Inputs are defined in the Input Manager<br class="title-page-name"/>// get value for horizontal axis<br class="title-page-name"/>h = Input.GetAxis("Horizontal");<br class="title-page-name"/>// get value for vertical axis<br class="title-page-name"/>v = Input.GetAxis("Vertical");<br class="title-page-name"/>speed = new Vector2(h, v).sqrMagnitude;<br class="title-page-name"/>animator.SetFloat("Speed", speed);<br class="title-page-name"/>animator.SetFloat("Horizontal", h);<br class="title-page-name"/>animator.SetFloat("Vertical", v);<br class="title-page-name"/>if (animator.GetFloat("Attack1") == 1.0f)<br class="title-page-name"/>{<br class="title-page-name"/>GameMaster.instance.AttackEnemy();<br class="title-page-name"/>}<br class="title-page-name"/>}</pre>
<p class="calibre3">In the code, we check to see if any of the attack modes are active and if so we check to see what the curve parameter <em class="calibre14">Attack1</em> is at the moment of the animation. If we are at <kbd class="calibre13">1.0f</kbd>, then we call the <kbd class="calibre13">GameMaster</kbd> object to perform the rest.</p>
<p class="calibre3">Now we need to take a look at a few functions we have defined/modified in the <kbd class="calibre13">GameMaster.cs</kbd> script:</p>
<pre class="calibre18">// for each level/scene that has been loaded<br class="title-page-name"/>// do some of the preparation work<br class="title-page-name"/>private void OnLevelWasLoaded(int level)<br class="title-page-name"/>{<br class="title-page-name"/>instance.LevelController.OnLevelWasLoaded();<br class="title-page-name"/>// find all NPC GameObjects of Enemy type<br class="title-page-name"/>if (GameObject.FindGameObjectsWithTag("Enemy").Length &gt; 0)<br class="title-page-name"/>{<br class="title-page-name"/>var tmpGONPCEnemy = GameObject.FindGameObjectsWithTag("Enemy");<br class="title-page-name"/>instance.NpcEnemyListGameObjects.Clear();<br class="title-page-name"/>foreach (GameObject goTmpNPCEnemy in tmpGONPCEnemy)<br class="title-page-name"/>{<br class="title-page-name"/>instance.NpcEnemyListGameObjects.Add(goTmpNPCEnemy);<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>public void AttackEnemy()<br class="title-page-name"/>{<br class="title-page-name"/>Npc npc =<br class="title-page-name"/>instance.ClosestNpcEnemy.GetComponent&lt;NpcAgent&gt;().NpcData;<br class="title-page-name"/>npc.Health -= 1;<br class="title-page-name"/>}</pre>
<p class="calibre3"/>
<p class="calibre3">Some explanation is needed here. So the <kbd class="calibre13">OnLevelWasLoaded()</kbd> function is called each time a new scene is loaded at runtime. This is where we query all GameObjects that are tagged <kbd class="calibre13">Enemy</kbd>. We then store them internally, for further processing down the line.</p>
<p>For testing purposes and due to the simplicity of the scene, there is only one enemy present for testing. I am also setting the <kbd class="calibre85">closestNPCEnemy</kbd> object to the last GameObject tagged <kbd class="calibre85">Enemy</kbd>. This variable is later used in the <kbd class="calibre85">PlayerAttachEnemy()</kbd> function to set the NPCs <kbd class="calibre85">Health</kbd> property.</p>
<p class="calibre3">When the <kbd class="calibre13">PlayerAttackEnemy()</kbd> function is called, we get a reference to the NPC component of the NPC character and reduce the health based on the attack.</p>
<p class="calibre3">Now, this also forces us to update the <kbd class="calibre13">BaseCharacter.cs</kbd> script. A listing of the modification is as follows:</p>
<pre class="calibre18">[SerializeField]<br class="title-page-name"/>private float health;<br class="title-page-name"/>public float Health<br class="title-page-name"/>{<br class="title-page-name"/>get { return health; }<br class="title-page-name"/>set<br class="title-page-name"/>{<br class="title-page-name"/>health = value;<br class="title-page-name"/>if (Tag.Equals("Player"))<br class="title-page-name"/>{<br class="title-page-name"/>if (GameMaster.instance.Ui.HudUi != null)<br class="title-page-name"/>{<br class="title-page-name"/>GameMaster.instance.Ui.HudUi.imgHealthBar.fillAmount<br class="title-page-name"/>= health / 100.0f;<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>else<br class="title-page-name"/>{<br class="title-page-name"/>CharacterGameObject.GetComponent&lt;NpcAgent&gt;().SetHealthValue(health / 100.0f);<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}</pre>
<p class="calibre3">In the <kbd class="calibre13">Health</kbd> property, we check to see if we are the player, or an NPC. If we are the player, we need to use <kbd class="calibre13">GameMaster</kbd> to update our <kbd class="calibre13">Stats</kbd> UI, if we are going to update our own NPC <kbd class="calibre13">Stats</kbd> UI.</p>
<p class="calibre3"/>
<p class="calibre3">This means that when you create your player character and/or NPC, you will need to make sure you are assigning the data elements properly; see the following code:</p>
<pre class="calibre18">void Awake()<br class="title-page-name"/>{<br class="title-page-name"/>PlayerCharacter tmp = new PlayerCharacter();<br class="title-page-name"/>tmp.Name = "Maximilian";<br class="title-page-name"/>tmp.Tag = transform.gameObject.tag;<br class="title-page-name"/>tmp.CharacterGameObject = transform.gameObject;<br class="title-page-name"/>tmp.Health = 100.0f;<br class="title-page-name"/>tmp.Defense = 50.0f;<br class="title-page-name"/>tmp.Description = "Our Hero";<br class="title-page-name"/>tmp.Dexterity = 33.0f;<br class="title-page-name"/>tmp.Intelligence = 80.0f;<br class="title-page-name"/>tmp.Strength = 60.0f;<br class="title-page-name"/>playerCharacterData = tmp;<br class="title-page-name"/>}
Awake()</kbd> from the <kbd class="calibre13">PlayerAgent.cs</kbd> script. You will need to perform the same for the <kbd class="calibre13">NpcAgent.cs</kbd> script; see the following code:</pre>
<pre class="calibre18">void Start()<br class="title-page-name"/>{<br class="title-page-name"/>// let's go ahead and instantiate our stats<br class="title-page-name"/>GameObject tmpCanvasGO = Instantiate(<br class="title-page-name"/>CanvasNpcStatsPrefab,<br class="title-page-name"/>new Vector3(CanvasAttachmentPoint.position.x, 2, 0),<br class="title-page-name"/>CanvasNpcStatsPrefab.transform.rotation) as GameObject;<br class="title-page-name"/>tmpCanvasGO.transform.SetParent(CanvasAttachmentPoint, false);<br class="title-page-name"/>CanvasNpcStats = tmpCanvasGO.GetComponent&lt;Canvas&gt;();<br class="title-page-name"/>CanvasNpcStats.GetComponent&lt;NpcStatusUi&gt;().imgHealthBar.fillAmount = 1.0f;<br class="title-page-name"/>CanvasNpcStats.GetComponent&lt;NpcStatusUi&gt;().imgManaBar.fillAmount = 1.0f;<br class="title-page-name"/>Npc tmp = new Npc();<br class="title-page-name"/>tmp.Tag = "Enemy";<br class="title-page-name"/>tmp.CharacterGameObject = transform.gameObject;<br class="title-page-name"/>tmp.Name = "B1";<br class="title-page-name"/>tmp.Health = 100.0f;<br class="title-page-name"/>tmp.Defense= 50.0f;<br class="title-page-name"/>tmp.Description = "The Beast";<br class="title-page-name"/>tmp.Dexterity = 33.0f;<br class="title-page-name"/>tmp.Intelligence = 80.0f;<br class="title-page-name"/>tmp.Strength = 60.0f;<br class="title-page-name"/>NpcData = tmp;<br class="title-page-name"/>}</pre>
<p class="calibre3"/>
<p class="calibre3"/>
<p class="calibre3"/>
<p class="calibre3"/>
<p class="calibre3"/>
<p class="calibre3"/>
<p class="calibre3">The code and scripts we have looked at have been used to test the ideas we have put forth. The results are positive. You might have noticed that when the player character attacks, we do not take into consideration its position relative to that of the enemy. We are also automatically assigning the closest NPC character in <kbd class="calibre13">GameMaster</kbd> to eventually be the last element of the query we give each time a level loads.</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Enhancing the code</h1>
                
            
            
                
<p class="calibre3">One last code implementation I would like to make before I close out the chapter, is to make sure that when we are in attack mode for the player character, the hit points will affect the NPC that it is intended for automatically. In other words, determine which NPC is closest to us based on our distance and view angle toward the NPC.</p>
<p class="calibre3">We have already created the logic to determine these quantities for the NPC character. We now need to implement something similar for the player character. Let's take a look at a partial listing of the code changes we need to make for the <kbd class="calibre13">BarbarianCharacterMovement.cs</kbd> script:</p>
<pre class="calibre18">using UnityEngine;<br class="title-page-name"/>namespace com.noorcon.rpg2e<br class="title-page-name"/>{<br class="title-page-name"/>public class BarbarianCharacterController : MonoBehaviour<br class="title-page-name"/>{<br class="title-page-name"/>public Animator animator;<br class="title-page-name"/>public float directionDampTime;<br class="title-page-name"/>public float speed = 6.0f;<br class="title-page-name"/>public float h = 0.0f;<br class="title-page-name"/>public float v = 0.0f;<br class="title-page-name"/>bool attack = false;<br class="title-page-name"/>bool punch = false;<br class="title-page-name"/>bool run = false;<br class="title-page-name"/>bool jump = false;<br class="title-page-name"/>[HideInInspector]<br class="title-page-name"/>public bool die = false;<br class="title-page-name"/>bool dead = false;<br class="title-page-name"/>public bool EnemyInSight;<br class="title-page-name"/>public GameObject EnemyToAttack;<br class="title-page-name"/>Quaternion StartingAttackAngle = Quaternion.AngleAxis(-25, Vector3.up);<br class="title-page-name"/>Quaternion StepAttackAngle = Quaternion.AngleAxis(5, Vector3.up);<br class="title-page-name"/>Vector3 AttackDistance = new Vector3(0, 0, 2);<br class="title-page-name"/>// Use this for initialization<br class="title-page-name"/>void Start()<br class="title-page-name"/>{<br class="title-page-name"/>animator = GetComponent&lt;Animator&gt;() as Animator;<br class="title-page-name"/>EnemyInSight = false;<br class="title-page-name"/>}<br class="title-page-name"/><a href="https://github.com/PacktPublishing/Building-an-RPG-with-Unity-2018-Second-Edition" class="calibre83">...</a><br class="title-page-name"/>void FixedUpdate()<br class="title-page-name"/>{<br class="title-page-name"/>// The Inputs are defined in the Input Manager<br class="title-page-name"/>// get value for horizontal axis<br class="title-page-name"/>h = Input.GetAxis("Horizontal");<br class="title-page-name"/>// get value for vertical axis<br class="title-page-name"/>v = Input.GetAxis("Vertical");<br class="title-page-name"/>speed = new Vector2(h, v).sqrMagnitude;<br class="title-page-name"/>animator.SetFloat("Speed", speed);<br class="title-page-name"/>animator.SetFloat("Horizontal", h);<br class="title-page-name"/>animator.SetFloat("Vertical", v);<br class="title-page-name"/>#region used for attack range<br class="title-page-name"/>RaycastHit hitAttack;<br class="title-page-name"/>var angleAttack = transform.rotation * StartingAttackAngle;<br class="title-page-name"/>var directionAttack = angleAttack * AttackDistance;<br class="title-page-name"/>var posAttack = transform.position + Vector3.up;<br class="title-page-name"/>for (var i = 0; i &lt; 10; i++)<br class="title-page-name"/>{<br class="title-page-name"/>Debug.DrawRay(posAttack, directionAttack, Color.yellow);<br class="title-page-name"/>if (Physics.Raycast(posAttack, directionAttack, out hitAttack, 1.0f))<br class="title-page-name"/>{<br class="title-page-name"/>var enemy = hitAttack.collider.GetComponent&lt;NpcAgent&gt;();<br class="title-page-name"/>if (enemy)<br class="title-page-name"/>{<br class="title-page-name"/>//Enemy was seen<br class="title-page-name"/>EnemyInSight = true;<br class="title-page-name"/>EnemyToAttack = hitAttack.collider.gameObject;<br class="title-page-name"/>GameMaster.instance.ClosestNpcEnemy = hitAttack.collider.gameObject;<br class="title-page-name"/>}<br class="title-page-name"/>else<br class="title-page-name"/>{<br class="title-page-name"/>this.EnemyInSight = false;<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>directionAttack = StepAttackAngle * directionAttack;<br class="title-page-name"/>}<br class="title-page-name"/>#endregion<br class="title-page-name"/>if (EnemyInSight)<br class="title-page-name"/>{<br class="title-page-name"/>if (animator.GetFloat("Attack1") == 1.0f)<br class="title-page-name"/>{<br class="title-page-name"/>PlayerCharacter pc<br class="title-page-name"/>= gameObject.GetComponent&lt;PlayerAgent&gt;().playerCharacterData;<br class="title-page-name"/>float impact = (pc.Strength + pc.Health) / 100.0f;<br class="title-page-name"/>GameMaster.instance.AttackEnemy(impact);<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}</pre>
<p class="calibre3">The way we calculate the sight and distance of the enemy NPCs is through <strong class="calibre5">Raycasting</strong>. This is done only when we are in attack mode; we check to see if the NPC is in front of us and, if so, we set the <kbd class="calibre13">ClosestNpcEnemy</kbd> object on <kbd class="calibre13">GameMaster</kbd> and set the <kbd class="calibre13">enemyInSight</kbd> flag, where we then perform the necessary subtraction from the health of the NPC.</p>
<p class="calibre3">Notice that I have also changed the way we compute the impact of the hit based on a simple equation, as follows:</p>
<div><img class="fm-editor-equation" src="img/00166.jpeg"/></div>
<p class="calibre3">Here, <em class="calibre14">pc</em> is the object reference to our player character. The same equation is used on the NPC objects. This is just a simple demonstration that the impact of the hit point of the player or the NPC is based on the strength and the health of the actors in the scene. Take a look at the following screenshot:</p>
<div><img src="img/00167.jpeg" class="calibre124"/></div>
<p>Determining if the NPC is in sight</p>
<p class="calibre3">The preceding screenshot illustrates how we detect if an NPC is in attack range or not.</p>
<p class="calibre3">In turn, you can derive the strength value from the components that the player or the NPC has activated throughout the gameplay.</p>
<p class="calibre3">A partial listing of <kbd class="calibre13">BaseCharacter.cs</kbd> illustrating the <kbd class="calibre13">HEALTH</kbd> property is as follows:</p>
<pre class="calibre18">[SerializeField]<br class="title-page-name"/>private float health;<br class="title-page-name"/>public float Health<br class="title-page-name"/>{<br class="title-page-name"/>get { return health; }<br class="title-page-name"/>set<br class="title-page-name"/>{<br class="title-page-name"/>health = value;<br class="title-page-name"/>if (Tag.Equals("Player"))<br class="title-page-name"/>{<br class="title-page-name"/>if (GameMaster.instance.Ui.HudUi != null)<br class="title-page-name"/>{<br class="title-page-name"/>GameMaster.instance.Ui.HudUi.imgHealthBar.fillAmount<br class="title-page-name"/>= health / 100.0f;<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>else<br class="title-page-name"/>{<br class="title-page-name"/>CharacterGameObject.GetComponent&lt;NpcAgent&gt;().SetHealthValue(health / 100.0f);<br class="title-page-name"/>}<br class="title-page-name"/>}<br class="title-page-name"/>}</pre>
<p>There are more code changes and updates; please refer to the associated files provided for details.</p>
<p class="calibre3"/>
<p class="calibre3">During the implementation process, I have modified a few other code locations, which are not listed within the book due to physical limitations. Here are the scripts that have been modified: <kbd class="calibre13">BaseCharacter.cs</kbd>, <kbd class="calibre13">BarbarianCharacterController.cs</kbd>, <kbd class="calibre13">GameMaster.cs</kbd>, <kbd class="calibre13">NpcAgent.cs</kbd>, <kbd class="calibre13">PlayerAgent.cs</kbd> and <kbd class="calibre13">NpcBarbarianMovement.cs</kbd>. Take a look at the following screenshot:</p>
<div><img src="img/00168.jpeg" class="calibre125"/></div>
<p>GameMaster handling multiple NPCs</p>
<p class="calibre3">You are encouraged to do some research and try different types of mechanics and implementation to enhance your skills.</p>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            
                
<p class="calibre3">In this chapter, we have expanded on our idea and looked at how to integrate all of the major pieces together. The main objective of the chapter was to create a heads-up display (HUD) for our game.</p>
<p class="calibre3">We started out with a design concept that was of interest to us, and created a layout for our HUD before the actual implementation. Once we concluded how the HUD should look, we started building the framework for it. We designed the three main sections of the HUD and referred to them as the following: <kbd class="calibre13">PanelCharacterInfo</kbd>, <kbd class="calibre13">PanelActiveItems</kbd>, and <kbd class="calibre13">PanelSpecialItems</kbd>.</p>
<p class="calibre3">Next, we started to build the UI elements and the code necessary to make the panels work with our code. We started with <kbd class="calibre13">PanelCharacterInfo</kbd>, which represented the stats for our character player, that is, a reference to the player's avatar, a reference to the health, and a reference to the strength of the character. In the process, we had to create or update several of the scripts to work with the new UI.</p>
<p class="calibre3">Next, we designed and developed the <kbd class="calibre13">PanelActiveItems</kbd> panel. The implementation and approach to this specific panel was a little more involved. The purpose of this panel is to display all of the current active inventory items that the player has consumed. We had to make the panel scroll-able since we don't know how many items the player will be consuming at any given time. We created the necessary prefabs to be placeholders for the inventory items, as well as the scripts that make them work together.</p>
<p class="calibre3">The design for <kbd class="calibre13">PanelSpecialItems</kbd> was very similar to that of <kbd class="calibre13">PanelActiveItems</kbd>, with two main differences. First, we had to make sure that the panel was vertical instead of horizontal, so we had to make sure that the proper configuration was applied. Secondly, the main functionality was different for this panel. The items displayed were supposed to be intractable, which meant that we had to create custom event handlers, apply the necessary values to the player character, and update the whole game state.</p>
<p class="calibre3">Once we were satisfied with the design of our HUD, we started building the necessary scripts to integrate the UI elements with the <kbd class="calibre13">GameMaster</kbd> and other scripts. This was basically making sure that our UI was always reflecting the state of the object that was of interest to us. The health, stamina, and inventory are the main items we used to communicate the concepts.</p>
<p class="calibre3"/>
<p class="calibre3"/>
<p class="calibre3">In the last section of the chapter, we concentrated on the implementation of the player's character movement and detection of the NPCs, and how to track the hit points between the player character and the NPC, which was not done in previous chapters.</p>
<p class="calibre3">We also had to do some backtracking and make some adjustments to the animation controller we had defined for our player character, to have curves defined for our attack animation values based on the motion.</p>
<p class="calibre3">During the process, we had to solve the following challenges: How do we know if we are in close enough range that we can actually attack and hit the NPC character? How are we going to detect which NPC is closer to us? More importantly, how is the data going to be passed along from the action of attacking to the actual hit on the NPC?</p>
<p class="calibre3">We have done a lot in a short period of time and in a small number of pages. Some of the functions have been left for the reader to solve on their own. For instance, we have not discussed how to delete an inventory item and so on. I felt this to be trivial, and that the reader will be comfortable enough to implement the function on their own once they see the bigger scope and how to connect everything together.</p>
<p class="calibre3">With that said, let's move on to the next and final chapter, covering multiplayer!</p>


            

            
        
    </body></html>