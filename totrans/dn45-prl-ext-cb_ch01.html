<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="z3998: http://www.daisy.org/z3998/2012/vocab/structure/#" lang="en" xml:lang="en">
<head>
    <title>1. Getting Started with Task Parallel Library</title>
    <link href="epub.css" rel="stylesheet" type="text/css"/>
    <link href="68851547a55f.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <div id="sbo-rt-content">
      <div class="chapter" title="Chapter&#160;1.&#160;Getting Started with Task Parallel Library">
        <div class="titlepage">
          <div>
            <div>
              <h1 class="title"><a id="ch01"></a>Chapter&#160;1.&#160;Getting Started with Task Parallel Library</h1>
            </div>
          </div>
        </div>
        <p>In this chapter, we will cover the following recipes:</p>
        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem" style="list-style-type: disc">Creating a task</li>
            <li class="listitem" style="list-style-type: disc">Waiting for tasks to finish</li>
            <li class="listitem" style="list-style-type: disc">Returning results from a task</li>
            <li class="listitem" style="list-style-type: disc">Passing data to a task</li>
            <li class="listitem" style="list-style-type: disc">Creating a child task</li>
            <li class="listitem" style="list-style-type: disc">Lazy task execution</li>
            <li class="listitem" style="list-style-type: disc">Handling task exceptions using try/catch block</li>
            <li class="listitem" style="list-style-type: disc">Handling task exceptions with AggregateException.Handle</li>
            <li class="listitem" style="list-style-type: disc">Cancelling a task</li>
            <li class="listitem" style="list-style-type: disc">Cancelling one of many tasks</li>
          </ul>
        </div>
        <div class="section" title="Introduction">
          <div class="titlepage">
            <div>
              <div>
                <h1 class="title" id="sigil_toc_id_3"><a id="ch01lvl1sec08"></a>Introduction</h1>
              </div>
            </div>
          </div>
          <p>At the beginning of the personal computer era, there was no concept of multiple threads offered by an operating system. Typically, operating system code and application code ran on a single thread of execution. The problem with this was that if a single application misbehaved, or simply took a long time to execute, the whole machine would stall, and often had to be rebooted.</p>
          <p>As the development of the Windows operating systems progressed, Microsoft realized that they needed to improve this situation. In the Windows NT kernel, each application runs in its own process. A process is a collection of resources in which a virtual address space is allocated for each application. The advent of these processes ensured that code and data being used by one application could not be accessed and corrupted by another application, thus improving the reliability of the system.</p>
          <p>Each process in Windows was also given its own thread. A thread is an operating system construct that functions like a virtual CPU. At any given moment, one of these threads is allowed to run on the physical CPU for a slice of time. When the time for a thread to run expires, it is swapped off of the CPU for another thread. Therefore, if a single thread enters an infinite loop, it can't monopolize all of the CPU time on the system. At the end of its time slice, it will be switched out for another thread.</p>
          <p>Over the years, computers with multiple processors began to appear. These multiple processor machines were able to execute multiple threads at once. It became possible for an application to spawn new threads to run a compute-bound process asynchronously, thus gaining a performance improvement.</p>
          <p>Over the past few years, the trend in processor development has shifted from making processors faster and faster, to making processors with multiple CPU cores on a single physical processor chip. Individuals who purchase these new machines expect their investment to pay off in terms of applications which are able to run efficiently across the available processor cores. Maximizing the utilization of the computing resources provided by the next generation of multi-core processors requires a change in the way the code is written.</p>
          <p>The .NET framework has supported writing multi-threaded applications from the beginning, but the complexity of doing so has remained just out of reach for many .NET developers. To fully take the advantage of multi-threading, you needed to know quite a bit about how Windows works under the hood. For starters, you had to create and manage your own threads, which can be a demanding task as the number of threads in an application grows, and can often be the source of hard-to-find bugs.</p>
          <p>Finally, help has arrived. Starting in .NET 4.0, Microsoft introduced the .NET Parallel Extensions, which gave us a new runtime, new class library types (the <span class="strong"><strong>Task Parallel Library</strong></span>
<a id="id0" class="indexterm"></a> (<span class="strong"><strong>TPL</strong></span>)), and new diagnostic tools to help with the inherent complexities of parallel programming.</p>
          <p>The TPL isn't just a collection of new types. It's a completely new way of thinking about parallel programming. No longer do we need to think in terms of threads. With the TPL, we can now think in terms of <code class="literal">task</code>. With this new task-based model, we just need to figure out the pieces of our application that can execute concurrently, and convert those pieces into tasks. The runtime will take care of managing and creating all of the underlying threads that actually do the work. The <code class="literal">System.Threading.Task</code> class<a id="id1" class="indexterm"></a>
<a id="id2" class="indexterm"></a> in itself is just a wrapper for passing a delegate, which is a data structure that refers to a <code class="literal">static</code> method<a id="id3" class="indexterm"></a> or to a class instance, and an instance method of that class.</p>
          <p>A TPL <code class="literal">task</code> still uses the classic thread pool internally, but the heavy lifting of spinning up new threads to carry out the <code class="literal">tasks</code> and determining the optimum number of threads required to take full advantage of the hardware, is all done by the runtime.</p>
          <p>In this chapter, we will take a look at the basics of creating a parallel <code class="literal">task</code>. You will learn how to pass data into a <code class="literal">Task</code> using the <code class="literal">Task</code> state object, returning data from a <code class="literal">Task</code>, cancelling the <code class="literal">Task</code>, and handling exceptions within a <code class="literal">Task</code>.</p>
        </div>
      </div>
    </div>


    <div id="sbo-rt-content">
      <div class="section" title="Creating a task">
        <div class="titlepage">
          <div>
            <div>
              <h1 class="title"><a id="ch01lvl1sec09"></a>Creating a task</h1>
            </div>
          </div>
        </div>
        <p>
<code class="literal">Tasks</code> are an abstraction in the .NET framework to represent asynchronous units of work. In some ways, a task resembles the creation of a classic .NET thread, but provides a higher level of abstraction,<a id="id4" class="indexterm"></a> which makes your code easier to write and read.</p>
        <p>We will look at the three basic ways to create and run a new task.</p>
        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem" style="list-style-type: disc">The <code class="literal">Parallel.Invoke()</code> method: <a id="id5" class="indexterm"></a>This method<a id="id6" class="indexterm"></a> provides an easy way to run any number of concurrent statements</li>
            <li class="listitem" style="list-style-type: disc">The <code class="literal">Task.Start()</code> method<a id="id7" class="indexterm"></a>: This method <a id="id8" class="indexterm"></a>starts a task and schedules it for execution with <code class="literal">TaskScheduler</code></li>
            <li class="listitem" style="list-style-type: disc">The <code class="literal">Task.Factory.StartNew()</code> method<a id="id9" class="indexterm"></a>: This method<a id="id10" class="indexterm"></a> creates and starts a task using <code class="literal">Task.Factory</code></li>
          </ul>
        </div>
        <p>In this recipe, we will create a new task using each of these three methods. To give our tasks something to do, we will be using <code class="literal">WebClient</code> to read the text of three classic books. We will then split the words of each book into a string array, and display a count of the words in each book.</p>
        <div class="section" title="How to do it…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec07"></a>How to do it…</h2>
              </div>
            </div>
          </div>
          <p>Ok, let's start building a <code class="literal">Console</code> application that demonstrates<a id="id11" class="indexterm"></a> the various ways to create a parallel task.</p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">Launch Visual Studio 2012.</li>
              <li class="listitem">Start a new project using the C# <span class="strong"><strong>Console Application</strong></span> project template, and assign <code class="literal">SimpleTasks</code> as the <span class="strong"><strong>Solution name</strong></span> as shown in the following screenshot:<div class="mediaobject"><img src="graphics/0225OT_01_01.jpg" alt="How to do it…"/></div></li>
              <li class="listitem">Add the following <code class="literal">using</code> statements<a id="id12" class="indexterm"></a> at the top of your <code class="literal">Program</code> class:<div class="informalexample"><pre class="programlisting">using System;
using System.Linq;
using System.Net;
using System.Threading.Tasks;</pre>
</div><div class="note" title="Note" style=""><div class="inner"><h3 class="title sigil_not_in_toc"><a id="tip02"></a>Tip</h3>
<p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p>
<p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p>
</div>
</div></li>
              <li class="listitem">First, let's create a task using <code class="literal">Parallel.Invoke</code>. Add the following code to the <code class="literal">Main</code> method of the <code class="literal">Program</code> class:<div class="informalexample"><pre class="programlisting">char[] delimiters = { ' ', ',', '.', ';', ':', '-', '_', '/', '\u000A' };
const string headerText = "Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)";

Parallel.Invoke(() =&gt;
    {
    Console.WriteLine("Starting first task using Parallel.Invoke");
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words =client.DownloadString(@"http://www.gutenberg.org/files/2009/2009.txt");
    var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    Console.WriteLine("Origin of Species word count: {0}", wordArray.Count());
    client.Dispose();
    }
);</pre>
</div></li>
              <li class="listitem">Next, let's start <code class="literal">task</code> using the <a id="id13" class="indexterm"></a><code class="literal">Start</code> method of the <code class="literal">Task</code> object. Add the following code to the <code class="literal">Main</code> method <a id="id14" class="indexterm"></a>of the <code class="literal">Program</code> class just below the code for the previous step:<div class="informalexample"><pre class="programlisting">var secondTask = new Task(() =&gt;
    {
    Console.WriteLine("Starting second task using Task.Start");
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words = client.DownloadString(@"http://www.gutenberg.org/files/16328/16328-8.txt");
    var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    Console.WriteLine("Beowulf word count: {0}", wordArray.Count());
    client.Dispose();
    } 
  );
secondTask.Start();</pre>
</div></li>
              <li class="listitem">Finally, let's create <code class="literal">task</code> using <code class="literal">Task.Factory.StartNew</code>. Add the following code to the <code class="literal">Main</code> method of the <code class="literal">Program</code> class:<div class="informalexample"><pre class="programlisting">Task.Factory.StartNew(() =&gt;
    {
    Console.WriteLine("Starting third task using Task.Factory.StartNew");
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words = client.DownloadString(@"http://www.gutenberg.org/files/4300/4300.txt");
    var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    Console.WriteLine("Ulysses word count: {0}", wordArray.Count());
    client.Dispose();
    }
);
//wait for Enter key to exit
Console.ReadLine();</pre>
</div></li>
              <li class="listitem">In Visual Studio 2012, press <span class="emphasis"><em>F5</em></span> to run the project. You should see output similar to the following<a id="id15" class="indexterm"></a> screenshot. Note that the exact order of the text you see may vary as <code class="literal">tasks</code> run asynchronously:<div class="mediaobject"><img src="graphics/0225OT_01_02.jpg" alt="How to do it…"/></div></li>
            </ol>
          </div>
        </div>
        <div class="section" title="How it works…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec08"></a>How it works…</h2>
              </div>
            </div>
          </div>
          <p>The <a id="id16" class="indexterm"></a>
<code class="literal">Parallel.Invoke</code> method <a id="id17" class="indexterm"></a>can implicitly create and run any number of statements concurrently by passing an action delegate for each delegate of work to be done.</p>
          <div class="informalexample">
            <pre class="programlisting">Parallel.Invoke(( )=&gt;DoSomething( ), ( )=&gt;DoSomethingElse( ));</pre>
          </div>
          <p>It is worth noting however, that the number of <code class="literal">tasks</code> actually created by <code class="literal">Parallel.Invoke</code> may or may not be equal to the number of delegates passed in, especially if there are a large number of delegates.</p>
          <p>Using <code class="literal">Task.Start()</code> or <code class="literal">Task.Factory.StartNew()</code> creates new tasks explicitly. The new <code class="literal">tasks</code> will be allocated threads by the <code class="literal">ThreadPool</code> class, which handles the actual creation of the threads the <code class="literal">tasks</code> use for carrying out their work. As developers, we are shielded from all of this thread creation work, because it is done for us by the <code class="literal">Task</code> object.</p>
          <p>When you create a task, you are really just creating a wrapper around a delegate of work to be performed. The <a id="id18" class="indexterm"></a>delegate can be a named delegate and anonymous method, or a lambda expression.</p>
          <p>So, which of these methods of creating <code class="literal">task</code> is the best? <code class="literal">Task.Factory.StartNew</code> is usually the preferred method, because it is more efficient in terms of the synchronization costs. Some amount of synchronization cost is incurred when using <code class="literal">Thread.Start</code>, because it is necessary to ensure that another thread is not simultaneously calling start on the same <code class="literal">Task</code> object. When using <code class="literal">Task.Factory.StartNew</code>, we know that the task has already been scheduled by the time <code class="literal">task</code> reference is handed back to our code.</p>
          <p>Note also that you can't call <code class="literal">Start()</code> on a task that has already run and completed. If you need the tasks to do the work again, you need to create new <code class="literal">task</code> with the same delegate of work.</p>
          <p>For the remainder of this book, we will primarily be using <code class="literal">Task.Factory.StartNew</code>.</p>
        </div>
      </div>
    </div>


    <div id="sbo-rt-content">
      <div class="section" title="Waiting for tasks to finish">
        <div class="titlepage">
          <div>
            <div>
              <h1 class="title"><a id="ch01lvl1sec10"></a>Waiting for tasks to finish</h1>
            </div>
          </div>
        </div>
        <p>When developing a parallel application, you will often have situations where a task must be completed before the main thread can continue processing. The Task Parallel Library includes several methods that allow you to wait for one or more parallel <code class="literal">tasks</code> to complete. This recipe will cover two such methods:<a id="id19" class="indexterm"></a> <code class="literal">Task.Wait()</code> and <code class="literal">Task.WaitAll()</code>.<a id="id20" class="indexterm"></a>
</p>
        <p>In this recipe we will be creating three tasks, all of which read in the text classic books and produce a <code class="literal">word count</code>. After we create the first task, we will wait for it to complete using <code class="literal">Task.Wait()</code>, before starting the second and third task. We will then wait for both the second and third tasks to complete using <code class="literal">Task.WaitAll()</code> before writing a message to the console.</p>
        <div class="section" title="How to do it…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec09"></a>How to do it…</h2>
              </div>
            </div>
          </div>
          <p>Let's create a <code class="literal">Console</code> application<a id="id21" class="indexterm"></a> that demonstrates how to wait for <code class="literal">task</code> completion.</p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">Launch Visual Studio 2012.</li>
              <li class="listitem">Start a new<a id="id22" class="indexterm"></a> project using the C# <span class="strong"><strong>Console Application</strong></span> project template, and assign <code class="literal">WordCount</code> as the <span class="strong"><strong>Solution name</strong></span>.<div class="mediaobject"><img src="graphics/0225OT_01_03.jpg" alt="How to do it…"/></div></li>
              <li class="listitem">Add the<a id="id23" class="indexterm"></a> following <a id="id24" class="indexterm"></a><code class="literal">using</code> statements at the top of your <code class="literal">Program</code> class:<div class="informalexample"><pre class="programlisting">using System;
using System.Linq;
using System.Net;
using System.Threading.Tasks;</pre>
</div></li>
              <li class="listitem">In the <code class="literal">Main</code> method of the <code class="literal">Program</code> class, add a character array containing the basic punctuation marks. We will use this array in <code class="literal">string.Split()</code> to eliminate punctuation marks. Also add a string <code class="literal">constant</code> for the <code class="literal">user-agent</code> header of the <code class="literal">WebClient</code>.<div class="informalexample"><pre class="programlisting">char[] delimiters = { ' ', ',', '.', ';', ':', '-', '_', '/', '\u000A' };
const string headerText = "Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)";</pre>
</div></li>
              <li class="listitem">OK, now let's create our first task. This task will use <code class="literal">WebClient</code> to read the <span class="emphasis"><em>Origin of Species</em></span> by Darwin, and get its word count. Enter the following code in <a id="id25" class="indexterm"></a>the <code class="literal">Main</code> method of the <code class="literal">Program</code> class just below the previous statement:<div class="informalexample"><pre class="programlisting">var task1 = Task.Factory.StartNew(() =&gt;
    {
    Console.WriteLine("Starting first task.");
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words = client.DownloadString(@"http://www.gutenberg.org/files/2009/2009.txt");
    var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    Console.WriteLine("Origin of Species word count: {0}", wordArray.Count());
    }
);</pre>
</div></li>
              <li class="listitem">Now, just <a id="id26" class="indexterm"></a>below the previous task, write the following<a id="id27" class="indexterm"></a> statements to wait on the task, and write a message to the <code class="literal">Console</code> application:<div class="informalexample"><pre class="programlisting">task1.Wait();
Console.WriteLine("Task 1 complete. Creating Task 2 and Task 3.");</pre>
</div></li>
              <li class="listitem">Below the previous statement, enter the code to create the second and third tasks. These tasks are very similar to the first task.<div class="informalexample"><pre class="programlisting">var task2 = Task.Factory.StartNew(() =&gt;
{
  Console.WriteLine("Starting second task.");
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words = client.DownloadString(@"http://www.gutenberg.org/files/16328/16328-8.txt");
    var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    Console.WriteLine("Beowulf word count: {0}", wordArray.Count());
 });

var task3 = Task.Factory.StartNew(() =&gt;
{
    Console.WriteLine("Starting third task.");
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words = client.DownloadString(@"http://www.gutenberg.org/files/4300/4300.txt");
    var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    Console.WriteLine("Ulysses word count: {0}", wordArray.Count());
});</pre>
</div></li>
              <li class="listitem">Finally, let's use <code class="literal">Task.WaitAll()</code> to wait for the second and third task to complete,<a id="id28" class="indexterm"></a> then prompt the user to exit the program. <code class="literal">Task.WaitAll()</code> takes an array of <code class="literal">task</code> as its parameter, and can be used to wait for any number of tasks to complete.<div class="informalexample"><pre class="programlisting">Task.WaitAll(task2,task3);
Console.WriteLine("All tasks complete.");
Console.WriteLine("Press &lt;Enter&gt; to exit.");
Console.ReadLine();</pre>
</div></li>
              <li class="listitem">In Visual<a id="id29" class="indexterm"></a> Studio 2012, press <span class="emphasis"><em>F5</em></span> to run the project. You should see<a id="id30" class="indexterm"></a> output similar to the following screenshot. Note that the exact order of the last few lines of text may still vary depending on the execution order of the second and third tasks.<div class="mediaobject"><img src="graphics/0225OT_01_04.jpg" alt="How to do it…"/></div></li>
            </ol>
          </div>
        </div>
        <div class="section" title="How it works…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec10"></a>How it works…</h2>
              </div>
            </div>
          </div>
          <p>Although <code class="literal">Task.Wait() </code>and <code class="literal">Task.WaitAll()</code> are fairly self-explanatory, both have several overloads that offer different functionalities.</p>
          <p>
<code class="literal">Task.Wait()</code> can take<a id="id31" class="indexterm"></a> either an <code class="literal">Int32</code> or <code class="literal">TimeSpan</code> parameter to specify a specific period of time to wait. It can also accept a <code class="literal">CancellationToken</code> token parameter for cancellation, which will be covered later in the chapter.</p>
          <p>
<code class="literal">Task.WaitAll()</code> <a id="id32" class="indexterm"></a>always takes an array of <code class="literal">Task</code> as its first parameter, and has a second parameter which can be an <code class="literal">Int32</code> or <code class="literal">TimeSpan</code> as in <code class="literal">Task.Wait</code>.</p>
          <p>Another useful <a id="id33" class="indexterm"></a>method not shown in the recipe is <code class="literal">Task.WaitAny()</code>. <code class="literal">WaitAny</code> is very similar to <code class="literal">WaitAll</code>, except that it waits for only one <code class="literal">Task</code> in the array of <code class="literal">Task</code> to complete. The first <code class="literal">Task</code> of <code class="literal">Task</code> array to finish, completes the wait condition, and execution of the main thread is allowed to move forward.</p>
          <p>It is important to note that when you call one of the <code class="literal">Wait</code> methods, the runtime will check to see if the task you are waiting on has started executing. If <code class="literal">task</code> has started executing, then the thread that called <code class="literal">Wait</code> will block until <code class="literal">task</code> has finished executing. However, if <code class="literal">task</code> has not started running, then the runtime may execute the task using the thread that calls <code class="literal">Wait</code>.</p>
          <p>The various overloads and behaviors of <code class="literal">Task.Wait</code>, <code class="literal">Task.WaitAll</code>, and <code class="literal">Task.WaitAny</code> are shown in the following table:</p>
          <div class="informaltable">
            <table border="1">
              <colgroup>
                <col style="text-align: left"/>
                <col style="text-align: left"/>
              </colgroup>
              <tbody>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">Wait()</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for the task to complete execution.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">Wait(CancellationToken)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for the task to complete execution or <code class="literal">CancellationToken</code> to be set.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">Wait(Int32)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for task to complete or number of milliseconds to pass. A value of <code class="literal">-1</code> waits indefinitely.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">Wait(TimeSpan)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for<a id="id34" class="indexterm"></a> the task to complete execution or specified timespan to pass.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">Wait(Int32, CancellationToken)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for task to complete, number of milliseconds to pass, or <code class="literal">CancellationToken</code> to be set.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">WaitAll(Task[])</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for all of the tasks in array to complete execution. <a id="id35" class="indexterm"></a>
</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">WaitAll(Task[], Int32)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for all of the tasks in the array to complete execution or number of milliseconds to pass. A value of <code class="literal">-1</code> waits indefinitely.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">WaitAll(Task[], CancellationToken)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for all of the tasks in array to complete execution or for a <code class="literal">CancellationToken</code> to be set.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">WaitAll(Task[], TimeSpan)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for all of the tasks in array to complete execution or specified timespan to pass.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">WaitAll(Task[], Int32, CancellationToken)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for all of the tasks in array to complete execution, number of milliseconds to pass, or <code class="literal">CancellationToken</code> to be set.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">WaitAny(Task[])</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for any of the tasks in the array to complete execution.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">WaitAny(Task[], Int32)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for<a id="id36" class="indexterm"></a> any of the tasks in array to complete execution or number of milliseconds to pass. A value of <code class="literal">-1</code> waits indefinitely.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">WaitAny(Task[], CancellationToken)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for<a id="id37" class="indexterm"></a> any of the tasks in array to complete execution or for a <code class="literal">CancellationToken</code> to be set.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">WaitAny(Task[], TimeSpan)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits for any of the tasks in array to complete execution or specified timespan to pass.</p>
</td>
                </tr>
                <tr>
                  <td style="text-align: left" valign="top">
<p>
<code class="literal">WaitAny(Task[], Int32, CancellationToken)</code>
</p>
</td>
                  <td style="text-align: left" valign="top">
<p>Waits<a id="id38" class="indexterm"></a> for any of the tasks in array to complete execution, number of milliseconds to pass, or <code class="literal">CancellationToken</code> to be set.</p>
</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>


    <div id="sbo-rt-content">
      <div class="section" title="Returning results from a task">
        <div class="titlepage">
          <div>
            <div>
              <h1 class="title"><a id="ch01lvl1sec11"></a>Returning results from a task</h1>
            </div>
          </div>
        </div>
        <p>So far, our tasks<a id="id39" class="indexterm"></a> have not returned any values. However, it is often necessary to return a result from a task so it can be used in another part of our application. This functionality is provided by the <code class="literal">Result</code> property<a id="id40" class="indexterm"></a> of <code class="literal">Task&lt;TResult</code>&gt;.</p>
        <p>In this recipe, we will be creating a solution similar with tasks similar to the previous solution, but each of our three tasks<a id="id41" class="indexterm"></a> return a result which can then be used to display the word count to the user.</p>
        <div class="section" title="How to do it…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec11"></a>How to do it…</h2>
              </div>
            </div>
          </div>
          <p>Let's go to Visual Studio and see how we can return result values from our tasks.</p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">Start a new project using the C# <span class="strong"><strong>Console Application</strong></span> project template, and assign <code class="literal">WordCount2</code> as the <span class="strong"><strong>Solution name</strong></span>.</li>
              <li class="listitem">Add the following <code class="literal">using</code> statements are at the top of your <code class="literal">Program</code> class:<div class="informalexample"><pre class="programlisting">using System;
using System.Linq;
using System.Net;
using System.Threading.Tasks;</pre>
</div></li>
              <li class="listitem">In the <code class="literal">Main</code> method of the <code class="literal">Program</code> class, add a character array containing the basic punctuation marks. We will use this array in <code class="literal">string.Split()</code> to eliminate punctuation marks. Also add a string constant for the <code class="literal">WebClient</code> <code class="literal">user-agent</code> header.<div class="informalexample"><pre class="programlisting">char[] delimiters = { ' ', ',', '.', ';', ':', '-', '_', '/', '\u000A' };
const string headerText = "Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)";  </pre>
</div></li>
              <li class="listitem">Start by <a id="id42" class="indexterm"></a>creating <a id="id43" class="indexterm"></a>three tasks of type <code class="literal">Task&lt;int&gt;</code> named <code class="literal">task1</code>, <code class="literal">task2</code>, and <code class="literal">task3</code>. Your tasks should look as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">Task&lt;int&gt; task1 = Task.Factory.StartNew(() =&gt;
{
    Console.WriteLine("Starting first task.");
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words = client.DownloadString(@"http://www.gutenberg.org/files/2009/2009.txt");
    var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    return wordArray.Count();
});

Task&lt;int&gt; task2 = Task.Factory.StartNew(() =&gt;
{
    Console.WriteLine("Starting second task.");
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words = client.DownloadString(@"http://www.gutenberg.org/files/16328/16328-8.txt");
    var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    return wordArray.Count();
});

 Task&lt;int&gt; task3 = Task.Factory.StartNew(()
 {
    Console.WriteLine("Starting third task.");
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words = client.DownloadString(@"http://www.gutenberg.org/files/4300/4300.txt");
    var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    return wordArray.Count();
});</pre>
</div></li>
              <li class="listitem">Immediately below your tasks, add <code class="literal">Console.Writeline()</code> statements that use <code class="literal">Task.Result</code> to display the results to the user. The remainder of the <code class="literal">Main</code> method <a id="id44" class="indexterm"></a>should now look as shown in the <a id="id45" class="indexterm"></a>following code snippet:<div class="informalexample"><pre class="programlisting">Console.WriteLine("task1 is complete. Origin of Species word count: {0}",task1.Result);
Console.WriteLine("task2 is complete. Beowulf word count: {0}", task2.Result);
Console.WriteLine("task3 is complete. Ulysses word count: {0}", task3.Result);
Console.WriteLine("Press &lt;Enter&gt; to exit.");
Console.ReadLine();</pre>
</div></li>
              <li class="listitem">In Visual Studio 2012, press <span class="emphasis"><em>F5</em></span> to run the project. You should see output similar to the following:<div class="mediaobject"><img src="graphics/0225OT_01_05.jpg" alt="How to do it…"/></div></li>
            </ol>
          </div>
        </div>
        <div class="section" title="How it works…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec12"></a>How it works…</h2>
              </div>
            </div>
          </div>
          <p>
<code class="literal">Task&lt;TResult&gt;</code> subclasses the standard <code class="literal">Task</code> class and provides the additional feature of the ability to return a value. This is done by switching from providing an <code class="literal">Action</code> delegate to providing a <code class="literal">Func&lt;TResult&gt;</code> delegate.</p>
          <p>It is worth <a id="id46" class="indexterm"></a>noting that calling the <code class="literal">Task.Result</code> accessor will ensure that the asynchronous operation is complete before returning, so this is another method of waiting for a task to complete.<a id="id47" class="indexterm"></a> Once the result of <code class="literal">Task</code> is available, it will be stored and returned immediately on later calls to the <code class="literal">Result</code> accessor.</p>
        </div>
      </div>
    </div>


    <div id="sbo-rt-content">
      <div class="section" title="Passing data to a task">
        <div class="titlepage">
          <div>
            <div>
              <h1 class="title"><a id="ch01lvl1sec12"></a>Passing data to a task</h1>
            </div>
          </div>
        </div>
        <p>You can supply the data used by <code class="literal">task</code> by passing an instance of <code class="literal">System.Action&lt;object&gt;</code> and an object representing the data to be used by the action.</p>
        <p>In this recipe, we will<a id="id48" class="indexterm"></a> be revisiting our WordCount example, but this time we will be parameterizing the data the tasks will act upon.</p>
        <div class="section" title="How to do it…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec13"></a>How to do it…</h2>
              </div>
            </div>
          </div>
          <p>The ability to pass<a id="id49" class="indexterm"></a> data into a task allows us to create a single task that can operate on multiple pieces of input data. Let's create a <code class="literal">Console</code> application so we can see how this works:</p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">Start a new project using the C# <span class="strong"><strong>Console Application </strong></span>project template and assign <code class="literal">WordCount3</code><span class="strong"><strong> </strong></span>as the <span class="strong"><strong>Solution name</strong></span>.</li>
              <li class="listitem">Add the following <code class="literal">using</code> statements at the top of your <code class="literal">Program</code> class:<div class="informalexample"><pre class="programlisting">using System;
using System.Linq;
using System.Net;
using System.Threading.Tasks;
using System.Collections.Generic;</pre>
</div></li>
              <li class="listitem">In the <code class="literal">Main</code> method of the <code class="literal">Program</code> class, add a character array containing the basic punctuation marks. We will use this array in <code class="literal">string.Split()</code> to eliminate punctuation marks. Also add a constant string for the <code class="literal">WebClients</code> user-agent task.<div class="informalexample"><pre class="programlisting">char[] delimiters = { ' ', ',', '.', ';', ':', '-', '_', '/', '\u000A' };
const string headerText = "Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)";</pre>
</div></li>
              <li class="listitem">For this recipe, let's create a <code class="literal">new Dictionary</code> instance that can hold our book titles and URLs. Immediately after the previous statement, add the following code to create and initialize the <code class="literal">dictionary</code>:<div class="informalexample"><pre class="programlisting">var dictionary = new Dictionary&lt;string, string&gt;
{
    {"Origin of Species", "http://www.gutenberg.org/files/2009/2009.txt"},
    {"Beowulf", "http://www.gutenberg.org/files/16328/16328-8.txt"},
    {"Ulysses", "http://www.gutenberg.org/files/4300/4300.txt"}
};</pre>
</div></li>
              <li class="listitem">This time <a id="id50" class="indexterm"></a>we will be creating anonymous tasks in a loop. We still would like to wait for the tasks to complete before prompting the user to exit the program. We need a collection to hold our tasks, so we can pass them to <code class="literal">Task.WaitAll()</code> and wait for completion. Below the previous statement, create a <code class="literal">List&lt;Task&gt;</code> to hold our tasks.<div class="informalexample"><pre class="programlisting">var tasks = new List&lt;Task&gt;();</pre>
</div></li>
              <li class="listitem">Next, <a id="id51" class="indexterm"></a>we want to create a <code class="literal">for</code> loop to loop through <code class="literal">KeyValuePairs</code> in the dictionary. Let's put the <code class="literal">for</code> loop below the previous statement.<div class="informalexample"><pre class="programlisting">foreach (var  pair in dictionary)
{
}</pre>
</div></li>
              <li class="listitem">Inside the body of your <code class="literal">for</code> loop, put the definition of <code class="literal">task</code>, and add it to your task list as follows. Note the <code class="literal">KeyValuePair</code> being passed into <code class="literal">task</code> is in the form of an object. In the delegate body, we cast this object back to a <code class="literal">KeyValuePair</code>. Other than that, task is pretty much the same.<div class="informalexample"><pre class="programlisting">tasks.Add( Task.Factory.StartNew((stateObj) =&gt;
{
    var taskData = (KeyValuePair&lt;string, string&gt;)stateObj;
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words = client.DownloadString(taskData.Value);
    var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    Console.WriteLine("Word count for {0}: {1}", taskData.Key, wordArray.Count());
},pair));</pre>
</div></li>
              <li class="listitem">After the <code class="literal">for</code> loop, let's finish things up by waiting on the tasks to complete using <code class="literal">Task.WaitAll()</code> and prompting the user to exit. The last few lines should be as follows:<div class="informalexample"><pre class="programlisting">Task.WaitAll(tasks.ToArray());
Console.WriteLine("Press &lt;Enter&gt; to exit.");
Console.ReadLine();</pre>
</div></li>
              <li class="listitem">In Visual <a id="id52" class="indexterm"></a>Studio 2012, press <span class="emphasis"><em>F5</em></span> to run the project. You should see output as shown in the following screenshot:<div class="mediaobject"><img src="graphics/0225OT_01_06.jpg" alt="How to do it…"/></div></li>
            </ol>
          </div>
        </div>
        <div class="section" title="How it works…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec14"></a>How it works…</h2>
              </div>
            </div>
          </div>
          <p>By passing data to <code class="literal">Task</code> using the state feature, we now have a very powerful model for task creation, because we can create many tasks at once, each having the same code statements in the body and passing in the data that <code class="literal">Task</code> operates on. It also makes our code much more<a id="id53" class="indexterm"></a> concise and readable.</p>
          <p>In our <a id="id54" class="indexterm"></a>application we need to pass two items of data into the <code class="literal">task</code>: a book title and the URL of the book, so we created <code class="literal">dictionary</code>.</p>
          <div class="informalexample">
            <pre class="programlisting">var dictionary = new Dictionary&lt;string, string&gt;
{
    {"Origin of Species", "http://www.gutenberg.org/files/2009/2009.txt"},
    {"Beowulf", "http://www.gutenberg.org/files/16328/16328-8.txt"},
    {"Ulysses", "http://www.gutenberg.org/files/4300/4300.txt"}
};</pre>
          </div>
          <p>We would also want to wait on all of these tasks to complete before we prompt the user to exit, so we need to create a collection that can be converted to an array of tasks to hold our <code class="literal">Task</code> objects.<a id="id55" class="indexterm"></a> In this case, we made a list of tasks. In the body of our look that creates the tasks, we will add the tasks to the list.</p>
          <div class="informalexample">
            <pre class="programlisting">var tasks = new List&lt;Task&gt;();

foreach (var pair in dictionary)
{
    tasks.Add( //TASK DECLARATION HERE   ));
}</pre>
          </div>
          <p>In our loop, we will pass in each of  <code class="literal">KeyValuePairs</code> in <code class="literal">dictionary</code> as an object, using the <code class="literal">Task(Action&lt;Object&gt;, Object)</code> constructor. This syntax is just a bit odd because you actually refer to the <code class="literal">state</code> object twice.</p>
          <div class="informalexample">
            <pre class="programlisting">Task.Factory.StartNew((stateObj) =&gt;
{
    // TASK Body
},pair ));}</pre>
          </div>
          <p>The key takeaway<a id="id56" class="indexterm"></a> here is that the only way to pass data to a <code class="literal">Task</code> constructor is using <code class="literal">Action&lt;Object&gt;</code>. To use the members of a specific type, you must convert or explicitly cast the data back to the desired type in the body of the <code class="literal">Task</code>.</p>
          <div class="informalexample">
            <pre class="programlisting">var taskData = (KeyValuePair&lt;string, string&gt;)stateObj;</pre>
          </div>
        </div>
      </div>
    </div>


    <div id="sbo-rt-content">
      <div class="section" title="Creating a child task">
        <div class="titlepage">
          <div>
            <div>
              <h1 class="title"><a id="ch01lvl1sec13"></a>Creating a child task</h1>
            </div>
          </div>
        </div>
        <p>Code that is running a task can create another task with the <code class="literal">TaskCreationOptions.AttachedToParent set</code>. In this case, the new task becomes a child of the original or parent task.</p>
        <p>In this recipe, we will be <a id="id57" class="indexterm"></a>using a simplified version of the WordCount solution that uses a parent task to get the text of one book into a string array, and then spins up a child task to print the results.</p>
        <div class="section" title="How to do it…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec15"></a>How to do it…</h2>
              </div>
            </div>
          </div>
          <p>Let's return to <a id="id58" class="indexterm"></a>our WordCount solution, so we can see how to create a child task and attach it to a parent.</p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">Start a new project using the C# <span class="strong"><strong>Console Application </strong></span>project template, and assign <code class="literal">WordCount4</code> as the <span class="strong"><strong>Solution name</strong></span>.</li>
              <li class="listitem">Add the following <code class="literal">using</code> statements at the top of your <code class="literal">Program</code> class:<div class="informalexample"><pre class="programlisting">using System;
using System.Linq;
using System.Net;
using System.Threading.Tasks;</pre>
</div></li>
              <li class="listitem">In the <code class="literal">Main</code> method of the <code class="literal">Program</code> class, add a character array containing the basic punctuation marks. We will use this array in <code class="literal">string.Split()</code> to eliminate<a id="id59" class="indexterm"></a> punctuation marks. Also, add a constant string for the <code class="literal">WebClient</code> <code class="literal">user-agent</code> header.<div class="informalexample"><pre class="programlisting">char[] delimiters = { ' ', ',', '.', ';', ':', '-', '_', '/', '\u000A' };
const string headerText = "Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)";</pre>
</div></li>
              <li class="listitem">First, let's create the basic structure of our parent task. This is very similar to the other<a id="id60" class="indexterm"></a> tasks we have created so far, and takes no parameters, and returns no values.<div class="informalexample"><pre class="programlisting">Task parent = Task.Factory.StartNew(() =&gt;
{
    Console.WriteLine("Parent task starting");
    const string uri = "http://www.gutenberg.org/files/2009/2009.txt";
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var book = client.DownloadString(uri);
    var wordArray = book.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    // Child Task will go here
});</pre>
</div></li>
              <li class="listitem">Next, right after the comment in the parent task, let's create a child task to print the results and set the <code class="literal">AttachedToParent </code>option.<div class="informalexample"><pre class="programlisting">Task.Factory.StartNew(()=&gt;
{
    Console.WriteLine("Child task starting");
    Console.WriteLine("Word count for Origin of Species: {0}",wordArray.Count());
    Console.WriteLine("Attached child task completed.");
},TaskCreationOptions.AttachedToParent);</pre>
</div></li>
              <li class="listitem">Finally, just below the close of the parent task, let's wait for the parent task to complete, and prompt the user to exit the application with the following code:<div class="informalexample"><pre class="programlisting">parent.Wait();
Console.WriteLine("Parent task completed.");
Console.WriteLine("Press &lt;Enter&gt; to exit.");
Console.ReadLine();</pre>
</div></li>
              <li class="listitem">That's pretty much it. In Visual Studio 2012, press <span class="emphasis"><em>F5</em></span> to run the project. You should see output as shown in the following screenshot:<div class="mediaobject"><img src="graphics/0225OT_01_07.jpg" alt="How to do it…"/></div></li>
            </ol>
          </div>
        </div>
        <div class="section" title="How it works…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec16"></a>How it works…</h2>
              </div>
            </div>
          </div>
          <p>Using <code class="literal">TaskCreationOptions.AttachedToParent</code> expresses structured parallelism. The parent task<a id="id61" class="indexterm"></a> will wait for the child task to finish, so at the end of<a id="id62" class="indexterm"></a> our program, all we have to do is wait for the parent task.</p>
          <p>The nested child task, itself, is just an ordinary <code class="literal">task</code> created in the delegate of another <code class="literal">task</code>. A parent task may create any number of child tasks, limited only by system resources.</p>
          <p>You can also create a nested task without using <code class="literal">TaskCreationOptions.AttachedToParent</code>. The only real difference is that the nested tasks created without this option are essentially independent from the outer task. A task created with the <code class="literal">TaskCreationOptions.AttachedToParent</code> option set is very closely synchronized with the parent.</p>
          <p>The outer task could also use the <code class="literal">DenyChildAttach </code>option<a id="id63" class="indexterm"></a> to prevent other tasks from attaching as child tasks. However, the same outer task could still create an independent nested task.</p>
        </div>
      </div>
    </div>


    <div id="sbo-rt-content">
      <div class="section" title="Lazy task execution">
        <div class="titlepage">
          <div>
            <div>
              <h1 class="title"><a id="ch01lvl1sec14"></a>Lazy task execution</h1>
            </div>
          </div>
        </div>
        <p>Lazy initialization of an object <a id="id64" class="indexterm"></a>means that object creation is deferred until the object is actually used by your program. If you have a parallel task that you want to execute only when the value returned from the task is actually needed, you can combine lazy task execution with the <code class="literal">Task.Factory.StartNew</code> method.</p>
        <p>In this recipe, we will <a id="id65" class="indexterm"></a>return to our, by now familiar WordCount solution, to show you how to execute a parallel task and compute a word count for our book, only when we display the result to the console.</p>
        <div class="section" title="How to do it…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec17"></a>How to do it…</h2>
              </div>
            </div>
          </div>
          <p>Let's create a console <a id="id66" class="indexterm"></a>application that demonstrates how we can defer task creation until the result of the task is needed.</p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">Start a new project using the C# <span class="strong"><strong>Console Application</strong></span> project template, and assign <code class="literal">WordCount5</code> as the <span class="strong"><strong>Solution name</strong></span>.</li>
              <li class="listitem">Add the following <code class="literal">using</code> statements at the top of your <code class="literal">Program</code> class.<div class="informalexample"><pre class="programlisting">using System;
using System.Linq;
using System.Net;
using System.Threading.Tasks;</pre>
</div></li>
              <li class="listitem">The first step is to declare <code class="literal">System.Threading.Task&lt;int&gt;</code> for lazy initialization. In the <code class="literal">Main</code> method of your <code class="literal">Program</code> class, put a <code class="literal">Lazy</code> declaration as follows:<div class="informalexample"><pre class="programlisting">var lazyCount = new Lazy&lt;Task&lt;int&gt;&gt;(()=
{
  //Task declaration and body go here
});</pre>
</div></li>
              <li class="listitem">Inside the <code class="literal">Lazy</code> initialization declaration, place the code to create to task. The entire statement should now look as the following code snippet:<div class="informalexample"><pre class="programlisting">Task&lt;int&gt;.Factory.StartNew(() =&gt;
{
    Console.WriteLine("Executing the task.");
    char[] delimiters = { ' ', ',', '.', ';', ':', '-', '_', '/', '\u000A' };
    const string headerText = "Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)";
    const string uri = "http://www.gutenberg.org/files/2009/2009.txt";
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words = client.DownloadString(uri);
    var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    return wordArray.Count();
}));</pre>
</div></li>
              <li class="listitem">Now we<a id="id67" class="indexterm"></a> just need to write the result to the <code class="literal">Console</code>. Just add the following code to the end of your program:<div class="informalexample"><pre class="programlisting">Console.WriteLine("Calling the lazy variable");
Console.WriteLine("Origin of species word count: {0}",lazyCount.Value.Result );
Console.WriteLine("Press &lt;Enter&gt; to exit.");
Console.ReadLine();</pre>
</div></li>
              <li class="listitem">All done. In <a id="id68" class="indexterm"></a>Visual Studio 2012, press <span class="emphasis"><em>F5</em></span> to run the project. You should see the output as shown in the following screenshot:<div class="mediaobject"><img src="graphics/0225OT_01_08.jpg" alt="How to do it…"/></div></li>
            </ol>
          </div>
        </div>
        <div class="section" title="How it works…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec18"></a>How it works…</h2>
              </div>
            </div>
          </div>
          <p>
<code class="literal">System.Lazy&lt;T&gt;</code> creates a thread safe Lazy initialization of an object. Lazy initialization is primarily used to improve performance and avoid computational overhead until necessary. You can pass a delegate (remember that System Threading Task is just a wrapper around a delegate) to the <code class="literal">System.Lazy</code> constructor, and as we have done in this recipe, you can use a lambda expression to specify a <code class="literal">factory</code> method for object creation. This keeps all of the initialization code in one place.</p>
          <p>
<code class="literal">Lazy</code> initialization<a id="id69" class="indexterm"></a> occurs the first time the <code class="literal">System.Lazy&lt;T&gt;.Value</code> property is accessed.</p>
        </div>
      </div>
    </div>


    <div id="sbo-rt-content">
      <div class="section" title="Handling task exceptions using try/catch block">
        <div class="titlepage">
          <div>
            <div>
              <h1 class="title"><a id="ch01lvl1sec15"></a>Handling task exceptions using try/catch block</h1>
            </div>
          </div>
        </div>
        <p>Let's face it; sometimes things just go wrong with our code. Even with the simplified parallel programming <a id="id70" class="indexterm"></a>model provided by the TPL, we still need to be able to handle our exceptions.</p>
        <p>Tasks use <code class="literal">System.AggregateException</code> to consolidate multiple failures into a single exception object. In this recipe, we will take a look at the simplest way to handle <code class="literal">System.AggregateException</code> in our <code class="literal">tasks</code>: the <code class="literal">try</code>/<code class="literal">catch</code> blocks.</p>
        <p>The try-catch statement <a id="id71" class="indexterm"></a>consists of a try block followed by one of more catch blocks, which specify handlers for different exceptions. The try block contains the guarded code that may cause the exception.</p>
        <div class="section" title="Getting ready…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec19"></a>Getting ready…</h2>
              </div>
            </div>
          </div>
          <p>For this recipe we need to turn off the Visual Studio 2012 Exception Assistant. The Exception Assistant appears whenever a runtime exception is thrown, and intercepts the exception before it gets to our handler.</p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">To turn off the Exception Assistant, go to the <span class="strong"><strong>Debug</strong></span> menu and select <span class="strong"><strong>Exceptions</strong></span>.</li>
              <li class="listitem">Uncheck the <span class="strong"><strong>user-unhandled </strong></span>checkbox next to <span class="strong"><strong>Common Language Runtime Exceptions</strong></span>.<div class="mediaobject"><img src="graphics/0225OT_01_09.jpg" alt="Getting ready…"/></div></li>
            </ol>
          </div>
        </div>
        <div class="section" title="How to do it…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec20"></a>How to do it…</h2>
              </div>
            </div>
          </div>
          <p>Let's return to our WordCount solution so we can see how to handle an <code class="literal">AggregateException</code> thrown by a parallel task.</p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">Start a new <a id="id72" class="indexterm"></a>project using the C# <span class="strong"><strong>Console Application</strong></span> project template and assign <code class="literal">WordCount6</code> as the <span class="strong"><strong>Solution name</strong></span>.</li>
              <li class="listitem">Add the <a id="id73" class="indexterm"></a>following <code class="literal">using</code> statements are at the top of your <code class="literal">Program</code> class:<div class="informalexample"><pre class="programlisting">using System;
using System.Linq;
using System.Net;
using System.Threading.Tasks;</pre>
</div></li>
              <li class="listitem">For this recipe, we will just need a single task. The task will be very similar to our other word count tasks, but in this one we will simulate a problem with the <code class="literal">System.Net.WebClient</code> by creating and throwing a <code class="literal">System.Net.WebException</code>. In the <code class="literal">Main</code> method of your <code class="literal">Program</code> class, create <code class="literal">System.Task</code> that looks as the following <code class="literal">Task</code>:<div class="informalexample"><pre class="programlisting">Task&lt;int&gt; task1 = Task.Factory.StartNew(() =&gt;
{
    const string headerText = "Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)";
    Console.WriteLine("Starting the task.");
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    var words = client.DownloadString(@"http://www.gutenberg.org/files/2009/2009.txt");
    var ex = new WebException("Unable to download book contents");
    throw ex;
    return 0;
});</pre>
</div></li>
              <li class="listitem">Just below the <code class="literal">Task</code>, let's put in our <code class="literal">try</code>/<code class="literal">catch</code> blocks as shown in the following code snippet. In the <code class="literal">catch</code> block, we will want to specifically catch <code class="literal">System.AggregateException</code>.<div class="informalexample"><pre class="programlisting">try
{
}
catch (AggregateException aggEx)
{ 
}</pre>
</div></li>
              <li class="listitem">Now let's implement the body of our <code class="literal">try</code> block. The body of the <code class="literal">try</code> block should be<a id="id74" class="indexterm"></a> as shown in the following code snippet. There are a couple of subtle but important concepts<a id="id75" class="indexterm"></a> in here that will be explained later in the chapter.<div class="informalexample"><pre class="programlisting">try
{
    task1.Wait();
    if (!task1.IsFaulted)
    {
     Console.WriteLine("Task complete. Origin of Species word count: {0}",task1.Result);
    }
}</pre>
</div></li>
              <li class="listitem">Next, let's implement the body of our <code class="literal">catch</code> block. It should look as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">catch (AggregateException aggEx)
{
    foreach (var ex in aggEx.InnerExceptions)
    {
      Console.WriteLine("Caught exception: {0}", ex.Message);
    }
}</pre>
</div></li>
              <li class="listitem">After the <code class="literal">catch</code> block, let's finish up by prompting the user to exit, and waiting on the user to hit <span class="emphasis"><em>Enter</em></span>.<div class="informalexample"><pre class="programlisting">Console.WriteLine("Press &lt;Enter&gt; to exit.");
Console.ReadLine();</pre>
</div></li>
              <li class="listitem">In Visual Studio 2012, press <span class="emphasis"><em>F5</em></span> to run the project. You should see output as shown in the following screenshot:<div class="mediaobject"><img src="graphics/0225OT_01_10.jpg" alt="How to do it…"/></div></li>
            </ol>
          </div>
        </div>
        <div class="section" title="How it works…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec21"></a>How it works…</h2>
              </div>
            </div>
          </div>
          <p>All of this stuff has<a id="id76" class="indexterm"></a> been pretty self-explanatory so far, but handling exceptions in task involves a couple of subtleties that need to be pointed out.</p>
          <p>The task itself is pretty straightforward. Other than throwing the <code class="literal">System.Net.WebException</code>, there is nothing out of the ordinary here.</p>
          <p>Let's take a<a id="id77" class="indexterm"></a> closer look at the try/catch blocks. The first statement in the <code class="literal">try</code> block <code class="literal">System.Threading.Task.Wait()</code> to wait on task completion. However, there is another purpose here. Unhandled exceptions thrown inside a <code class="literal">task</code> are swallowed by the runtime and wrapped up in <code class="literal">System.AggregateException</code>. It is your job to handle this.</p>
          <p>The TPL also has the concept of <code class="literal">AggregateException</code> being observed. If <code class="literal">AggregateException</code> is raised by your task, it will only be handled if it is currently being observed. This is very important to understand. If you never take an action that causes the exceptions to be observed, you are going to have a problem. When the <code class="literal">Task</code> object is garbage collected, the <code class="literal">Finalize</code> method of the <code class="literal">task</code> will see that the <code class="literal">task</code> had unobserved exceptions, and it will throw<code class="literal">System.AggregateException</code>. You will not be able to catch an exception thrown by the finalizer thread and your process will be terminated.</p>
          <p>So how to you observe an <code class="literal">AggregateException</code>, you ask? The <code class="literal">Systm.Threading.Task</code> class has a few methods and properties call triggers that cause <code class="literal">System.AggregateException</code> to be observed. A few of these are as follows:</p>
          <div class="itemizedlist">
            <ul class="itemizedlist">
              <li class="listitem" style="list-style-type: disc">Task.Wait</li>
              <li class="listitem" style="list-style-type: disc">Task.WaitAny</li>
              <li class="listitem" style="list-style-type: disc">Task.WaitAll</li>
              <li class="listitem" style="list-style-type: disc">Task.Result</li>
            </ul>
          </div>
          <p>Using any of these <code class="literal">trigger</code> methods indicates to the runtime that you are interested in observing any <code class="literal">System.AggregateException</code> that occurs. If you do not use one of the <code class="literal">trigger</code> methods on the <code class="literal">Task</code> class, the TPL will not raise any <code class="literal">AggregateException</code>, and an<a id="id78" class="indexterm"></a> unhandled exception will occur.</p>
          <p>Now, let's take a look at the <code class="literal">catch</code> block. <code class="literal">System.AggregateException</code> can wrap many individual exception objects. In our <code class="literal">catch</code> block, we need to loop through <code class="literal">AggregateException.InnerExceptions</code> to take a look at all of the individual exceptions that <a id="id79" class="indexterm"></a>occurred in a task.</p>
          <p>It is important to note that there is really no way to correlate an exception from the <code class="literal">AggregateExcetion.InnerExceptions</code> collection back to the particular <code class="literal">task</code> that threw an exception. All you really know is that some operation threw an <code class="literal">Exception</code>.</p>
          <p>
<code class="literal">System.AggregateException</code> overrides the <code class="literal">GetBaseException</code> method of exception, and returns the innermost exception, which is the initial cause of the problem.</p>
        </div>
      </div>
    </div>


    <div id="sbo-rt-content">
      <div class="section" title="Handling task exceptions with AggregateException.Handle">
        <div class="titlepage">
          <div>
            <div>
              <h1 class="title"><a id="ch01lvl1sec16"></a>Handling task exceptions with AggregateException.Handle</h1>
            </div>
          </div>
        </div>
        <p>In this recipe, we will look at another way to handle <code class="literal">System.AggregateException</code>, by using the <code class="literal">AggregateException.Handle</code> method. The <code class="literal">Handler</code> method invokes a handler function for each <a id="id80" class="indexterm"></a>exception wrapped in <code class="literal">AggregateException</code>.</p>
        <div class="section" title="Getting ready…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec22"></a>Getting ready…</h2>
              </div>
            </div>
          </div>
          <p>For this recipe, we<a id="id81" class="indexterm"></a> need to turn off the Visual Studio 2012 Exception Assistant. The Exception Assistant appears whenever a runtime exception is thrown and intercepts the exception before it gets to our handler. </p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">To turn off the Exception Assistant, go to the <span class="strong"><strong>Debug</strong></span> menu and select <span class="strong"><strong>Exceptions</strong></span>.</li>
              <li class="listitem">Uncheck the <span class="strong"><strong>user-unhandled</strong></span> checkbox next to <span class="strong"><strong>Common Language Runtime Exceptions</strong></span>.</li>
            </ol>
          </div>
        </div>
        <div class="section" title="How to do it…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec23"></a>How to do it…</h2>
              </div>
            </div>
          </div>
          <p>Let's take a look at how we can use <code class="literal">AggregateException.Handle</code> to provide an alternate method to handling exceptions in a parallel application.</p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">For this recipe, we will return to our <span class="strong"><strong>WordCount6</strong></span> project, and modify it to handle our exceptions in a different way. Start Visual Studio 2012 and open the <span class="strong"><strong>WordCount6</strong></span> project.</li>
              <li class="listitem">The first step is to define <a id="id82" class="indexterm"></a>our handler function that will be invoked when we call <code class="literal">AggregateException.Handle</code>. Following the <code class="literal">Main</code> method of your <code class="literal">Program</code> class, add a<a id="id83" class="indexterm"></a> new <code class="literal">private static handler</code> method that returns a bool. It should look as the following code snippet:<div class="informalexample"><pre class="programlisting">private static bool HandleWebExceptions(Exception ex)
{
    if (ex is WebException)
    {
      Console.WriteLine(("Caught WebException: {0}", ex.Message);
      return true;
    }
    else
    {
      Console.WriteLine("Caught exception: {0}", ex.Message);
      return false;
    }
}</pre>
</div></li>
              <li class="listitem">The only other step here is to replace the body of your <code class="literal">catch</code> block with a call to <code class="literal">System.AggregateException.Handle</code>, passing in the <code class="literal">HandleWebExceptions </code>predicate. The updated <code class="literal">try</code>/<code class="literal">catch</code> block should look as follows:<div class="informalexample"><pre class="programlisting">try
{
    task1.Wait();   
    if (!task1.IsFaulted)
    {
      Console.WriteLine("Task complete. Origin of Species word count: {0}",task1.Result);
    }
}
catch (AggregateException aggEx)
{
    aggEx.Handle(HandleWebExceptions);                
}</pre>
</div></li>
              <li class="listitem">Those are the only modifications necessary. In Visual Studio 2012, press <span class="emphasis"><em>F5</em></span> to run the <a id="id84" class="indexterm"></a>project. You should see output as shown in the following screenshot:<div class="mediaobject"><img src="graphics/0225OT_01_11.jpg" alt="How to do it…"/></div></li>
            </ol>
          </div>
        </div>
        <div class="section" title="How it works…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec24"></a>How it works…</h2>
              </div>
            </div>
          </div>
          <p>
<code class="literal">AggregateException.Handle()</code> takes a predicate that you supply, and the predicate will be invoked once for every exception wrapped in <code class="literal">System.AggregateException</code>.</p>
          <p>The predicate<a id="id85" class="indexterm"></a> itself<a id="id86" class="indexterm"></a> just needs to contain the logic to handle the various exception types that you expect, and to return true or false to indicate whether the exception was handled.</p>
          <p>If any of the exceptions went unhandled, they will be wrapped in a new <code class="literal">System.AggregateException</code> and thrown.</p>
        </div>
      </div>
    </div>


    <div id="sbo-rt-content">
      <div class="section" title="Cancelling a task">
        <div class="titlepage">
          <div>
            <div>
              <h1 class="title"><a id="ch01lvl1sec17"></a>Cancelling a task</h1>
            </div>
          </div>
        </div>
        <p>Up to this point, we <a id="id87" class="indexterm"></a>have focused on creating, running, and handling exceptions in <code class="literal">tasks</code>. Now we will begin to take a look at using <code class="literal">System.Threading.CancellationTokenSource</code> and <code class="literal">System.Threading.CancellationToken</code> to cancel <code class="literal">tasks</code>.</p>
        <p>This recipe will show how to cancel a single task.</p>
        <div class="section" title="How to do it…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec25"></a>How to do it…</h2>
              </div>
            </div>
          </div>
          <p>Let's create a <a id="id88" class="indexterm"></a>console application that shows how to cancel a parallel task.</p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">Start a new project using the C# <span class="strong"><strong>Console Application</strong></span> project template, and assign <code class="literal">WordCount7</code> as the <span class="strong"><strong>Solution name</strong></span>.</li>
              <li class="listitem">Add the following <code class="literal">using</code> statements at the top of your <code class="literal">Program</code> class:<div class="informalexample"><pre class="programlisting">using System;
using System.Linq;
using System.Net;
using System.Threading;
using System.Threading.Tasks;</pre>
</div></li>
              <li class="listitem">Let's start by creating <code class="literal">CancellationTokenSource </code>and getting our <code class="literal">CancellationToken</code>. In the <code class="literal">Main</code> method of your <code class="literal">Program</code> class, add the following statements:<div class="informalexample"><pre class="programlisting">//Create a cancellation token source
CancellationTokenSource tokenSource = new CancellationTokenSource();
//get the cancellation token
CancellationToken token = tokenSource.Token;</pre>
</div></li>
              <li class="listitem">Now we need to create our <code class="literal">Task</code> and pass <code class="literal">CancellationToken</code> into the constructor. Right after the previous line, put in the following <code class="literal">Task</code> definition:<div class="informalexample"><pre class="programlisting">Task&lt;int&gt; task1 = Task.Factory.StartNew(() =&gt;
{
    // The body of the task goes here                
}, token);  </pre>
</div></li>
              <li class="listitem">In the body of our <code class="literal">Task</code>, we need to check the <code class="literal">IsCancellationRequested</code> property of <code class="literal">CancellationToken</code>. If it has been, we dispose of our resource and throw <code class="literal">OperationCancelledException</code>. If not, we do our usual work. Enter the following code into the body of <code class="literal">Task</code>:<div class="informalexample"><pre class="programlisting">//wait a bit for the cancellation
Thread.Sleep(2000);
const string headerText = "Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0)";
var client = new WebClient();
client.Headers.Add("user-agent", headerText);
if(token.IsCancellationRequested)
{
    client.Dispose();
    throw new OperationCanceledException(token);
}
else
{
    var book = client.DownloadString(@"http://www.gutenberg.org/files/2009/2009.txt");
    char[] delimiters = { ' ', ',', '.', ';', ':', '-', '_', '/', '\u000A' };
    Console.WriteLine("Starting the task.");
    var wordArray = book.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
    return wordArray.Count();
}</pre>
</div></li>
              <li class="listitem">Right after the task, put in the following lines to write the cancellation status to the <code class="literal">Console</code>, and then call the <code class="literal">Cancel</code> method of <code class="literal">TokenSource</code>.<div class="informalexample"><pre class="programlisting">Console.WriteLine("Has the task been cancelled?: {0}", task1.IsCanceled);
//Cancel the token source
tokenSource.Cancel();</pre>
</div></li>
              <li class="listitem">The following<a id="id89" class="indexterm"></a> are the last statements put in a condition to check whether the task has been cancelled or faulted before we try to write out the results:<div class="informalexample"><pre class="programlisting">if (!task1.IsCanceled || !task1.IsFaulted)
{
    try
    {
        if (!task1.IsFaulted)
        {
          Console.WriteLine("Origin of Specied word count: {0}", task1.Result);
        }
    }
    catch (AggregateException aggEx)
    {
    foreach (Exception ex in aggEx.InnerExceptions)
    {
          Console.WriteLine("Caught exception: {0}", ex.Message);
    }
    }
}
else
{
    Console.WriteLine("The task has been cancelled");
}</pre>
</div></li>
              <li class="listitem">Lastly, we'll finish up by prompting the user to exit and waiting for the input.<div class="informalexample"><pre class="programlisting">Console.WriteLine("Press &lt;Enter&gt; to exit.");
Console.ReadLine();</pre>
</div></li>
              <li class="listitem">In Visual Studio 2012, press <span class="emphasis"><em>F5</em></span> to run the project. You should see the output as shown in the following screenshot:<div class="mediaobject"><img src="graphics/0225OT_01_12.jpg" alt="How to do it…"/></div></li>
            </ol>
          </div>
        </div>
        <div class="section" title="How it works…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec26"></a>How it works…</h2>
              </div>
            </div>
          </div>
          <p>The basic idea of cancelling <code class="literal">task</code> is that we create <code class="literal">CancellationTokenSource</code>, obtain <code class="literal">CancellationToken</code> from it, and then pass <code class="literal">CancellationToken</code> onto the <code class="literal">Task</code> constructor. Once <a id="id90" class="indexterm"></a>we have done that, we can call the <code class="literal">Cancel</code> method on the <code class="literal">CancellationTokenSource</code> to cancel the task.</p>
          <p>That's all easy enough. However, inside <code class="literal">task</code> we have a couple of options on how to handle the cancellation.</p>
          <p>If your task has resources that need to be cleaned up (such as the <code class="literal">WebClient</code>), you need to check the cancellation tokens <code class="literal">IsCancellationRequested</code> property<a id="id91" class="indexterm"></a>, then dispose of the resources, and throw a new <code class="literal">OperationCancelledException</code>.</p>
          <p>The other option, if your task doesn't use resources which need to be explicitly cleaned up, is to use the token <code class="literal">ThrowIsCancellationRequested()</code>, which will ensure the task transitions to a status of cancelled in a single statement.</p>
          <p>If you need to execute <code class="literal">task</code> and prevent it from being cancelled, you can obtain a special <code class="literal">CancellationToken</code> that is not associated with any <code class="literal">CancellationTokenSource</code> from the static <code class="literal">CancellationToken.None</code> property, and pass this token to <code class="literal">Task</code>. Since there is no associated <code class="literal">CancellationTokenSource</code>, it is not possible to call <code class="literal">Cancel</code> for this token, and any<a id="id92" class="indexterm"></a> code that is checking the <code class="literal">CancellationToken.IsCancellationRequested</code> property will always get back a false.</p>
        </div>
        <div class="section" title="There's more…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec27"></a>There's more…</h2>
              </div>
            </div>
          </div>
          <p>You can register one or more methods to be called when <code class="literal">CancellationTokenSource</code> is cancelled, by registering a <code class="literal">callback</code> method with the <code class="literal">CancellationToken.Register</code> method. You just need to pass <code class="literal">Action&lt;Object&gt;</code>, and optionally, a state value will be passed to <code class="literal">callback</code> and a <code class="literal">Boolean</code>, indicating whether to invoke the delegate using <code class="literal">SynchronizationContext</code> of the calling thread to the <code class="literal">Register</code> method. Passing in a value of false means the thread that calls <code class="literal">Cancel</code> will invoke the registered methods synchronously. If you pass true, the callbacks will be sent to <code class="literal">SynchronizationContext</code>, which determines which thread will invoke the callbacks.</p>
          <div class="informalexample">
            <pre class="programlisting">var source = new CancellationTokenSource();
source.Token.Register(()=&gt;
{
  Console.WriteLine("The operation has been cancelled.");
});</pre>
          </div>
          <p>The <code class="literal">Register</code> method<a id="id93" class="indexterm"></a> of <code class="literal">CancellationToken</code> returns a <code class="literal">CancellationTokenRegistration</code> object. To remove a registered callback from <code class="literal">CancellationTokenSource</code>, so it doesn't get invoked, call the <code class="literal">Dispose</code> method of the <code class="literal">CancellationTokenRegistration</code> object.</p>
          <p>You can also create <code class="literal">CancellationTokenSource</code> by linking other <code class="literal">CancellationTokenSource</code> objects together. The new composite <code class="literal">CancellationTokenSource</code> will be cancelled, if any of the linked <code class="literal">CancellationTokenSource</code> objects are cancelled.</p>
          <div class="informalexample">
            <pre class="programlisting">var source1 = new CancellationTokenSource();
var source2 = new CancellationTokenSource();
var linkedSource = CancellationTokenSource.CreateLinkedTokenSource(source1.Token, source2.Token);</pre>
          </div>
        </div>
      </div>
    </div>


    <div id="sbo-rt-content">
      <div class="section" title="Cancelling one of many tasks">
        <div class="titlepage">
          <div>
            <div>
              <h1 class="title"><a id="ch01lvl1sec18"></a>Cancelling one of many tasks</h1>
            </div>
          </div>
        </div>
        <p>Now that we have<a id="id94" class="indexterm"></a> seen how to cancel a task, let's take a look at how we can use <code class="literal">CancellationToken</code> to cancel multiple tasks with a single call to <code class="literal">CancellationTokenSource.Cancel()</code>.</p>
        <div class="section" title="How to do it…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec28"></a>How to do it…</h2>
              </div>
            </div>
          </div>
          <p>Now let's return to<a id="id95" class="indexterm"></a> our WordCount example and create a <code class="literal">Console</code> application that provides for the cancellation of multiple tasks with single <code class="literal">CancellationToken</code>.</p>
          <div class="orderedlist">
            <ol class="orderedlist arabic">
              <li class="listitem">Start a new project using the C# <span class="strong"><strong>Console Application</strong></span> project template, and assign <code class="literal">WordCount8</code> as the <span class="strong"><strong>Solution name</strong></span>.</li>
              <li class="listitem">Add the following <code class="literal">using</code> statements at the top of your <code class="literal">Program</code> class:<div class="informalexample"><pre class="programlisting">using System;
using System.Linq;
using System.Net;
using System.Threading;
using System.Threading.Tasks;</pre>
</div></li>
              <li class="listitem">First, let's create a <code class="literal">helper</code> method to display errors and cancellation status. Since we have multiple tasks, it's better to have this logic all in one place. Following the <code class="literal">Main</code> method of your <code class="literal">Program</code> class, create a <code class="literal">static</code> method call <code class="literal">HandleExceptions</code> which will display the errors and task status to the user.<div class="informalexample"><pre class="programlisting">private static void DisplayException(Task task, AggregateException outerEx, string bookName)
{
    foreach (Exception innerEx in outerEx.InnerExceptions)
    {
      Console.WriteLine("Handled exception for {0}:{1}",bookName,innerEx.Message);
    }
    Console.WriteLine("Cancellation status for book {0}: {1}", bookName, task.IsCanceled);
}</pre>
</div></li>
              <li class="listitem">Next, at the top of the <code class="literal">Main</code> method, create <code class="literal">CancellationTokenSource </code>and get our <code class="literal">CancellationToken</code>.<div class="informalexample"><pre class="programlisting">//Create a cancellation token source
CancellationTokenSource tokenSource = new CancellationTokenSource();
//get the cancellation token
CancellationToken token = tokenSource.Token;</pre>
</div></li>
              <li class="listitem">Now we <a id="id96" class="indexterm"></a>need to create our tasks and our array of <code class="literal">delimiters</code>. The tasks are the same as in the recipe for cancelling a single task. The key here is that we are passing the<a id="id97" class="indexterm"></a> same <code class="literal">CancellationToken</code> in for all three tasks.<div class="informalexample"><pre class="programlisting">char[] delimiters = { ' ', ',', '.', ';', ':', '-', '_', '/', '\u000A' };
const string headerText = "Mozilla/5.0 (compatible; MSIE 10.0; Windows NT<code class="literal"> 6.1; Trident/6.0)";</code>

 Task&lt;int&gt; task1 = Task.Factory.StartNew(() =&gt;
{
    // wait for the cancellation to happen
    Thread.Sleep(2000);
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    if (token.IsCancellationRequested)
    {
      client.Dispose();
      throw new OperationCanceledException(token);
    }
    else
    {
      var words = client.DownloadString(@"http://www.gutenberg.org/files/2009/2009.txt");
      Console.WriteLine("Starting the task for Origin of Species.");
      var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
      return wordArray.Count();
    }
},token);


 Task&lt;int&gt; task2 = Task.Factory.StartNew(() =&gt;
{
    // wait for the cancellation to happen
    Thread.Sleep(2000);
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    if (token.IsCancellationRequested)
    {
      client.Dispose();
      throw new OperationCanceledException(token);
    }
    else
    {
      var words = client.DownloadString(@"http://www.gutenberg.org/files/16328/16328-8.txt");
      Console.WriteLine("Starting the task for Beowulf.");
      var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
      return wordArray.Count();
    };
},token);

Task&lt;int&gt; task3 = Task.Factory.StartNew(() =&gt;
{
    // wait for the cancellation to happen
    Thread.Sleep(2000);
    var client = new WebClient();
    client.Headers.Add("user-agent", headerText);
    if (token.IsCancellationRequested)
    {
      client.Dispose();
      throw new OperationCanceledException(token);
    }
    else
    {
      var words = client.DownloadString(@"http://www.gutenberg.org/files/4300/4300.txt");
      Console.WriteLine("Starting the task for Ulysses.");
      var wordArray = words.Split(delimiters, StringSplitOptions.RemoveEmptyEntries);
      return wordArray.Count();
    };
},token);</pre>
</div></li>
              <li class="listitem">OK, let's finish up by calling <code class="literal">CancellationTokenSource.Cancel()</code> , checking the results, and catching the exceptions. The remainder of the <code class="literal">Main</code> method <a id="id98" class="indexterm"></a>should <a id="id99" class="indexterm"></a>look as the following code snippet:<div class="informalexample"><pre class="programlisting">//Cancel the token source
tokenSource.Cancel();
try
{
    if (!task1.IsFaulted || !task1.IsCanceled)
    {
      Console.WriteLine("Origin of Specied word count: {0}", task1.Result);
    }
}
catch(AggregateException outerEx1)
{
    DisplayException(task1, outerEx1, "Origin of Species");
}
try
{
    if (!task2.IsFaulted || !task2.IsCanceled)
    {
      Console.WriteLine("Beowulf word count: {0}", task2.Result);
    }
}
catch (AggregateException outerEx2)
{
    DisplayException(task2, outerEx2, "Beowulf");
}
try
{
    if (!task3.IsFaulted || !task3.IsCanceled)
    {
      Console.WriteLine("Ulysses word count: {0}", task3.Result);
    }
}
catch (AggregateException outerEx3)
{
   DisplayException(task3, outerEx3, "Ulysses");
}
Console.ReadLine();</pre>
</div></li>
              <li class="listitem">In Visual Studio 2012, press <span class="emphasis"><em>F5</em></span> to run the project. You should see output as shown in the following screenshot:<div class="mediaobject"><img src="graphics/0225OT_01_13.jpg" alt="How to do it…"/></div></li>
            </ol>
          </div>
        </div>
        <div class="section" title="How it works…">
          <div class="titlepage">
            <div>
              <div>
                <h2 class="title sigil_not_in_toc"><a id="ch01lvl2sec29"></a>How it works…</h2>
              </div>
            </div>
          </div>
          <p>Functionally, <a id="id100" class="indexterm"></a>cancelling multiple tasks is the same as cancelling a single task. In fact, the Parallel Extensions team has put a lot of work into making cancellation of various parallel structures very similar, as you will see as we go through the book.</p>
          <p>All that is <a id="id101" class="indexterm"></a>necessary to cancel multiple tasks is to create <code class="literal">CancellationToken</code>, then pass that token into all of the tasks you wish to cancel as shown in the following code snippet:</p>
          <div class="informalexample">
            <pre class="programlisting">CancellationTokenSource tokenSource = new CancellationTokenSource();
CancellationToken token = tokenSource.Token;

Task&lt;int&gt; task1 = Task.Factory.StartNew(() =&gt;
{
  ...
},token);
Task&lt;int&gt; task, = Task.Factory.StartNew(() =&gt;
{
  ...
},token);

tokenSource.Cancel();</pre>
          </div>
        </div>
      </div>
    </div>
</body>
</html>