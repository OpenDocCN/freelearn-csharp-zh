<html><head></head><body>
  <div id="_idContainer094">
   <h1 class="chapter-number" id="_idParaDest-131">
    <a id="_idTextAnchor132">
    </a>
    <span class="koboSpan" id="kobo.1.1">
     8
    </span>
   </h1>
   <h1 id="_idParaDest-132">
    <a id="_idTextAnchor133">
    </a>
    <span class="koboSpan" id="kobo.2.1">
     Enhancing Applications with Middleware in ASP.NET Core 9
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.3.1">
     ASP.NET Core 9 offers a robust and flexible framework designed to handle high-demand web applications.
    </span>
    <span class="koboSpan" id="kobo.3.2">
     A key component of this framework
    </span>
    <a id="_idIndexMarker636">
    </a>
    <span class="koboSpan" id="kobo.4.1">
     is middleware, which allows developers to interact directly with the request and response pipeline.
    </span>
    <span class="koboSpan" id="kobo.4.2">
     Understanding and leveraging middleware can significantly enhance your application’s capabilities.
    </span>
    <span class="koboSpan" id="kobo.4.3">
     This chapter will dive deep into middleware, exploring its structure, implementation, and practical applications, such as global error handling, request limiting,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.5.1">
      and more.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.6.1">
     In this chapter, we will focus on the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.7.1">
      following topics:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.8.1">
      Knowing the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.9.1">
       middleware pipeline
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.10.1">
      Implementing
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.11.1">
       custom middleware
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.12.1">
      Working with
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.13.1">
       factory-based middleware
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.14.1">
      Adding capabilities to applications
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.15.1">
       using middleware
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.16.1">
      Creating an extension method for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.17.1">
       middleware registration
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.18.1">
     In this chapter, we will explore essential best practices for developing applications with ASP.NET Core 9, covering the correct use of asynchronous mechanisms, HTTP requests, and application instrumentation
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.19.1">
      through logs.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-133">
    <a id="_idTextAnchor134">
    </a>
    <span class="koboSpan" id="kobo.20.1">
     Technical requirements
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.21.1">
     To support the learning of this chapter, the following tools must be present in your development
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.22.1">
      environment:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.23.1">
       Docker
      </span>
     </strong>
     <span class="koboSpan" id="kobo.24.1">
      : The Docker engine must be installed on your operating system and have an SQL Server container running.
     </span>
     <span class="koboSpan" id="kobo.24.2">
      You can find more details about Docker and SQL Server containers in
     </span>
     <a href="B21788_05.xhtml#_idTextAnchor078">
      <span class="No-Break">
       <em class="italic">
        <span class="koboSpan" id="kobo.25.1">
         Chapter 5
        </span>
       </em>
      </span>
     </a>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.26.1">
       .
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.27.1">
       Postman
      </span>
     </strong>
     <span class="koboSpan" id="kobo.28.1">
      : This tool will be used to execute requests to APIs of the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.29.1">
       developed application.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.30.1">
       Redis Insight
      </span>
     </strong>
     <span class="koboSpan" id="kobo.31.1">
      : This tool is used to connect to a Redis Server
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.32.1">
       database (
      </span>
     </span>
     <a href="https://redis.io/insight/">
      <span class="No-Break">
       <span class="koboSpan" id="kobo.33.1">
        https://redis.io/insight/
       </span>
      </span>
     </a>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.34.1">
       ).
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.35.1">
     The code examples used in this chapter can be found in the book’s GitHub
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.36.1">
      repository:
     </span>
    </span>
    <a href="https://github.com/PacktPublishing/ASP.NET-Core-9.0-Essentials/tree/main/Chapter08">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.37.1">
       https://github.com/PacktPublishing/ASP.NET-Core-9.0-Essentials/tree/main/Chapter08
      </span>
     </span>
    </a>
   </p>
   <h1 id="_idParaDest-134">
    <a id="_idTextAnchor135">
    </a>
    <span class="koboSpan" id="kobo.38.1">
     Knowing the middleware pipeline
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.39.1">
     During the previous chapters, we used several features of ASP.NET Core 9,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.40.1">
      including middleware.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.41.1">
     Middleware is a
    </span>
    <a id="_idIndexMarker637">
    </a>
    <span class="koboSpan" id="kobo.42.1">
     pipeline model used during the execution flow of an ASP.NET Core 9 web application to handle requests and responses, and the applications developed in this book already use some standard middleware
    </span>
    <a id="_idIndexMarker638">
    </a>
    <span class="koboSpan" id="kobo.43.1">
     from the .NET platform, such
    </span>
    <a id="_idIndexMarker639">
    </a>
    <span class="koboSpan" id="kobo.44.1">
     as
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.45.1">
      Authentication
     </span>
    </strong>
    <span class="koboSpan" id="kobo.46.1">
     ,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.47.1">
      Authorization
     </span>
    </strong>
    <span class="koboSpan" id="kobo.48.1">
     ,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.49.1">
      Cross-Origin Resource Sharing
     </span>
    </strong>
    <span class="koboSpan" id="kobo.50.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.51.1">
      CORS
     </span>
    </strong>
    <span class="koboSpan" id="kobo.52.1">
     ), and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.53.1">
      so
     </span>
    </span>
    <span class="No-Break">
     <a id="_idIndexMarker640">
     </a>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.54.1">
      on.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.55.1">
     The ASP.NET Core request pipeline consists of a sequence of request delegates, called one after the other.
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.56.1">
       Figure 8
      </span>
     </em>
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.57.1">
      .1
     </span>
    </em>
    <span class="koboSpan" id="kobo.58.1">
     demonstrates
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.59.1">
      the concept:
     </span>
    </span>
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer092">
     <span class="koboSpan" id="kobo.60.1">
      <img alt="Figure 8.1 – ASP.NET Core 9 middleware pipeline" src="image/B21788_08_01.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.61.1">
     Figure 8.1 – ASP.NET Core 9 middleware pipeline
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.62.1">
     Request delegates are configured using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.63.1">
      Run
     </span>
    </strong>
    <span class="koboSpan" id="kobo.64.1">
     ,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.65.1">
      Map
     </span>
    </strong>
    <span class="koboSpan" id="kobo.66.1">
     , and
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.67.1">
      Use
     </span>
    </strong>
    <span class="koboSpan" id="kobo.68.1">
     extension methods typically configured in the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.69.1">
       Program.cs
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.70.1">
      file.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.71.1">
     Each extension
    </span>
    <a id="_idIndexMarker641">
    </a>
    <span class="koboSpan" id="kobo.72.1">
     method has a template for registering a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.73.1">
      request delegate:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.74.1">
       Run
      </span>
     </strong>
     <span class="koboSpan" id="kobo.75.1">
      : The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.76.1">
       app.Run
      </span>
     </strong>
     <span class="koboSpan" id="kobo.77.1">
      method is used to define an inline middleware that handles the request and completes the response, as in the following example code that implements an
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.78.1">
       inline
      </span>
     </span>
     <span class="No-Break">
      <a id="_idIndexMarker642">
      </a>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.79.1">
       middleware:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.80.1">app.Run(</span></strong><span class="koboSpan" id="kobo.81.1">async context =&gt;
{
  await context.Response.WriteAsync("Hello Inline middleware!");
});</span></pre>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.82.1">
       Map
      </span>
     </strong>
     <span class="koboSpan" id="kobo.83.1">
      : The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.84.1">
       app.Map
      </span>
     </strong>
     <span class="koboSpan" id="kobo.85.1">
      method is used to create a branch in the middleware pipeline.
     </span>
     <span class="koboSpan" id="kobo.85.2">
      In the following code, requests to
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.86.1">
       /SomeRoute
      </span>
     </strong>
     <span class="koboSpan" id="kobo.87.1">
      are handled by this middleware branch.
     </span>
     <span class="koboSpan" id="kobo.87.2">
      The middleware in the branch writes a message to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.88.1">
       the response:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.89.1">app.Map("/SomeRoute"</span></strong><span class="koboSpan" id="kobo.90.1">, someRouteApp =&gt;
{
  someRouteApp.Use(async (context, next) =&gt;
  {
    Console.WriteLine("In SomeRoute middleware");
    await context.Response.WriteAsync("Hello from the SomeRoute middleware!");
  });
});</span></pre>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.91.1">
       Use
      </span>
     </strong>
     <span class="koboSpan" id="kobo.92.1">
      : The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.93.1">
       app.Use
      </span>
     </strong>
     <span class="koboSpan" id="kobo.94.1">
      method is used to add middleware to the pipeline.
     </span>
     <span class="koboSpan" id="kobo.94.2">
      The following code uses a middleware to log the request method and path before calling the next middleware in the pipeline.
     </span>
     <span class="koboSpan" id="kobo.94.3">
      After the next middleware completes, it logs the response
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.95.1">
       status code:
      </span>
     </span>
     <pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.96.1">app.Use</span></strong><span class="koboSpan" id="kobo.97.1">(async (context, next) =&gt;
{
  // Log the request
  Console.WriteLine($"Request:
    {context.Request.Method}
    {context.Request.Path}");
  await next.Invoke();
  // Log the response
  Console.WriteLine($"Response:
    {context.Response.StatusCode}");
});</span></pre>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.98.1">
     The use of
    </span>
    <a id="_idIndexMarker643">
    </a>
    <span class="koboSpan" id="kobo.99.1">
     middleware brings constant benefits to applications; we will understand in greater detail the use of different approaches, such as the creation of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.100.1">
      middleware classes.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.101.1">
     Now, let’s learn about how the middleware execution
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.102.1">
      flow works.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-135">
    <a id="_idTextAnchor136">
    </a>
    <span class="koboSpan" id="kobo.103.1">
     Understanding middleware flow
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.104.1">
     When the application
    </span>
    <a id="_idIndexMarker644">
    </a>
    <span class="koboSpan" id="kobo.105.1">
     receives a request, it goes through each middleware component in the order they are registered, and the following cases can
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.106.1">
      be executed:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.107.1">
       Process the request and pass it to the next piece of middleware
      </span>
     </strong>
     <span class="koboSpan" id="kobo.108.1">
      : It’s like a relay race where each runner passes the baton to the next.
     </span>
     <span class="koboSpan" id="kobo.108.2">
      Each piece of middleware does its part and then calls the next one in line to continue processing
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.109.1">
       the request.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.110.1">
       Process the request and break the chain, preventing other middleware from running
      </span>
     </strong>
     <span class="koboSpan" id="kobo.111.1">
      : Imagine a security checkpoint at an airport.
     </span>
     <span class="koboSpan" id="kobo.111.2">
      If security finds a problem, they may stop you for additional checks, preventing you from proceeding.
     </span>
     <span class="koboSpan" id="kobo.111.3">
      Likewise, the middleware may decide to handle the request completely and stop
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.112.1">
       further processing.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.113.1">
       Process the response as it moves up the chain
      </span>
     </strong>
     <span class="koboSpan" id="kobo.114.1">
      : This is like sending a package through multiple stages of inspection.
     </span>
     <span class="koboSpan" id="kobo.114.2">
      Once the package reaches the final stage, it is inspected again at each stage on the way back, ensuring that everything is in order before
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.115.1">
       being delivered.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.116.1">
     The layered approach allows for powerful and flexible handling of HTTP requests and responses.
    </span>
    <span class="koboSpan" id="kobo.116.2">
     Middleware
    </span>
    <a id="_idIndexMarker645">
    </a>
    <span class="koboSpan" id="kobo.117.1">
     can be used for a variety of tasks, such as logging, authentication, error handling,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.118.1">
      and more.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.119.1">
     Furthermore, the order in which you register middleware is crucial, as it defines the flow of the request and response pipeline.
    </span>
    <span class="koboSpan" id="kobo.119.2">
     We can see a representation of the middleware execution flow in
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.120.1">
       Figure 8
      </span>
     </em>
    </span>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.121.1">
       .2
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.122.1">
      :
     </span>
    </span>
   </p>
   <p class="IMG---Figure">
   </p>
   <div>
    <div class="IMG---Figure" id="_idContainer093">
     <span class="koboSpan" id="kobo.123.1">
      <img alt="Figure 8.2 – Middleware execution flow" src="image/B21788_08_02.jpg"/>
     </span>
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    <span class="koboSpan" id="kobo.124.1">
     Figure 8.2 – Middleware execution flow
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.125.1">
     Let’s see how the
    </span>
    <a id="_idIndexMarker646">
    </a>
    <span class="koboSpan" id="kobo.126.1">
     flow works
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.127.1">
      in detail:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.128.1">
       Request arrival
      </span>
     </strong>
     <span class="koboSpan" id="kobo.129.1">
      : When a request arrives at the server, it enters the pipeline and reaches the first
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.130.1">
       middleware component
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.131.1">
       Middleware execution
      </span>
     </strong>
     <span class="koboSpan" id="kobo.132.1">
      : Each middleware can do
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.133.1">
       the following:
      </span>
     </span>
     <ul>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.134.1">
         Modify the request
        </span>
       </strong>
       <span class="koboSpan" id="kobo.135.1">
        : Middleware can change aspects of the request, such as adding headers or changing the
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.136.1">
         request path
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.137.1">
         Move to next middleware
        </span>
       </strong>
       <span class="koboSpan" id="kobo.138.1">
        : After processing, the middleware can call the next middleware in the pipeline using
       </span>
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.139.1">
         await next
        </span>
       </strong>
       <span class="koboSpan" id="kobo.140.1">
        , which we’ll discuss in the
       </span>
       <em class="italic">
        <span class="koboSpan" id="kobo.141.1">
         Implementing custom
        </span>
       </em>
       <span class="No-Break">
        <em class="italic">
         <span class="koboSpan" id="kobo.142.1">
          middleware
         </span>
        </em>
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.143.1">
         section
        </span>
       </span>
      </li>
     </ul>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.144.1">
       Short-circuiting the pipeline
      </span>
     </strong>
     <span class="koboSpan" id="kobo.145.1">
      : The middleware may decide not to call the next middleware, effectively ending request
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.146.1">
       processing early
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.147.1">
       Response handling
      </span>
     </strong>
     <span class="koboSpan" id="kobo.148.1">
      : When the request reaches the end of the pipeline, the response goes back through the middleware components in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.149.1">
       reverse order
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.150.1">
       Modifying the response
      </span>
     </strong>
     <span class="koboSpan" id="kobo.151.1">
      : The middleware can change the response, such as adding headers, changing
     </span>
     <a id="_idIndexMarker647">
     </a>
     <span class="koboSpan" id="kobo.152.1">
      the status code, or
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.153.1">
       logging information
      </span>
     </span>
    </li>
   </ul>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.154.1">
     Middleware order
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.155.1">
     ASP.NET Core 9 has, by
    </span>
    <a id="_idIndexMarker648">
    </a>
    <span class="koboSpan" id="kobo.156.1">
     default, some middleware available to handle requests and responses.
    </span>
    <span class="koboSpan" id="kobo.156.2">
     However, the order in which this middleware is inserted completely changes the application’s execution flow and, in some cases, can cause malfunctions.
    </span>
    <span class="koboSpan" id="kobo.156.3">
     For example, it is important to add middleware authentication before middleware authorization; otherwise, how can you validate authorization without
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.157.1">
      being authenticated?
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.158.1">
     In any case, in addition to standard middleware, there is an order of execution for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.159.1">
      customized middleware.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.160.1">
     To learn more about
    </span>
    <a id="_idIndexMarker649">
    </a>
    <span class="koboSpan" id="kobo.161.1">
     middleware order, see the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.162.1">
      link:
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-9.0#middleware-order">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.163.1">
       https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-9.0#middleware-order
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.164.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.165.1">
     By working on the middleware execution flow, we have the ability to add several powerful possibilities to our applications, and we will learn some more benefits in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.166.1">
      next section.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-136">
    <a id="_idTextAnchor137">
    </a>
    <span class="koboSpan" id="kobo.167.1">
     Benefits of middleware and best practices
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.168.1">
     Middleware plays a key role in ASP.NET Core 9 applications, offering a number of benefits that contribute to the robustness, maintainability, and extensibility of your application.
    </span>
    <span class="koboSpan" id="kobo.168.2">
     Understanding these
    </span>
    <a id="_idIndexMarker650">
    </a>
    <span class="koboSpan" id="kobo.169.1">
     benefits allows you to use this resource effectively, so let’s look at this in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.170.1">
      more detail:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.171.1">
       Modularity
      </span>
     </strong>
     <span class="koboSpan" id="kobo.172.1">
      : Modularity means that middleware is an independent unit of functionality that can be easily added, removed, or replaced without affecting the rest of the application.
     </span>
     <span class="koboSpan" id="kobo.172.2">
      This modularity allows developers to create reusable middleware components that can be shared between different projects or in different parts of the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.173.1">
       same project.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.174.1">
       Composition
      </span>
     </strong>
     <span class="koboSpan" id="kobo.175.1">
      : Middleware can be composed in multiple orders to achieve different behaviors.
     </span>
     <span class="koboSpan" id="kobo.175.2">
      This compositional nature allows you to tailor the request and response pipeline to the specific needs of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.176.1">
       your application.
      </span>
     </span>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.177.1">
       Let’s say you have three middleware components: one for logging, one for authentication, and one for handling errors.
      </span>
      <span class="koboSpan" id="kobo.177.2">
       You can compose these middleware components in the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.178.1">
        desired order:
       </span>
      </span>
     </p>
     <pre class="source-code"><span class="koboSpan" id="kobo.179.1">
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();
</span><strong class="bold"><span class="koboSpan" id="kobo.180.1">app.UseMiddleware&lt;ErrorHandlingMiddleware&gt;();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.181.1">app.UseMiddleware&lt;AuthenticationMiddleware&gt;();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.182.1">app.UseMiddleware&lt;RequestLoggingMiddleware&gt;();</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.183.1">app.Run(async context =&gt;</span></strong><span class="koboSpan" id="kobo.184.1">
{
    await context.Response.WriteAsync("Hello,
      World!");
});
app.Run();</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.185.1">
       As you can see in
      </span>
      <a id="_idIndexMarker651">
      </a>
      <span class="koboSpan" id="kobo.186.1">
       the preceding code, the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.187.1">
        app.UseMiddleware
       </span>
      </strong>
      <span class="koboSpan" id="kobo.188.1">
       method adds middleware to handle errors, authentication, and logging in the application.
      </span>
      <span class="koboSpan" id="kobo.188.2">
       The
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.189.1">
        app.Run
       </span>
      </strong>
      <span class="koboSpan" id="kobo.190.1">
       method just creates a standard request response, returning a
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.191.1">
        Hello
       </span>
      </strong>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.192.1">
         World
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.193.1">
        message.
       </span>
      </span>
     </p>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.194.1">
       It is important to consider the
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.195.1">
        following factors:
       </span>
      </span>
     </p>
     <ul>
      <li>
       <span class="koboSpan" id="kobo.196.1">
        If you want to rearrange the order of these middleware components, the way requests are processed and errors are handled will
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.197.1">
         be different.
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.198.1">
         SoC (Separation of concerns)
        </span>
       </strong>
       <span class="koboSpan" id="kobo.199.1">
        : Middleware allows for a clear separation of different concerns, enabling the
       </span>
       <a id="_idIndexMarker652">
       </a>
       <span class="koboSpan" id="kobo.200.1">
        definition of a clear execution context in a pipeline and facilitating a clearer, extensible, and maintainable
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.201.1">
         code base.
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.202.1">
         Extensibility
        </span>
       </strong>
       <span class="koboSpan" id="kobo.203.1">
        : You can develop a custom middleware to extend the application’s functionality – for example, by adding validation capabilities to requests or modifying responses globally within
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.204.1">
         the application.
        </span>
       </span>
      </li>
     </ul>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.205.1">
       Suppose you need custom middleware to validate an API key in request headers.
      </span>
      <span class="koboSpan" id="kobo.205.2">
       You can create this middleware
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.206.1">
        as follows:
       </span>
      </span>
     </p>
     <pre class="source-code"><span class="koboSpan" id="kobo.207.1">public class ApiKeyCheckMiddleware
{
    private readonly RequestDelegate _next;
    </span><strong class="bold"><span class="koboSpan" id="kobo.208.1">private const string API_KEY = "X-API-KEY";</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.209.1">    private const string VALID_API_KEY = "XYZ123";</span></strong><span class="koboSpan" id="kobo.210.1">
    public ApiKeyCheckMiddleware(RequestDelegate next)
    {
        _next = next;
    }
    public async Task InvokeAsync(HttpContext context)
    {
        if (!context.Request.Headers
          .TryGetValue(API_KEY,
          out var extractedApiKey) ||
          extractedApiKey != VALID_API_KEY)
        {
            </span><strong class="bold"><span class="koboSpan" id="kobo.211.1">context.Response.StatusCode = 401;</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.212.1">            await context.Response</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.213.1">              .WriteAsync("Unauthorized");</span></strong><span class="koboSpan" id="kobo.214.1">
            return;
        }
        await _next(context);
    }
}</span></pre>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.215.1">
       The preceding
      </span>
      <a id="_idIndexMarker653">
      </a>
      <span class="koboSpan" id="kobo.216.1">
       code aims to create a customized middleware that checks the existence of an API key that must be provided in the header of a request, where the header key is
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.217.1">
        X-API-KEY
       </span>
      </strong>
      <span class="koboSpan" id="kobo.218.1">
       and the expected value is,
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.219.1">
        exactly,
       </span>
      </span>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.220.1">
         XYZ123
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.221.1">
        .
       </span>
      </span>
     </p>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.222.1">
       When performing validation, if the header and value are not part of the request, then the user receives an
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.223.1">
        unauthorized
       </span>
      </strong>
      <span class="koboSpan" id="kobo.224.1">
       return message with HTTP status
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.225.1">
        code
       </span>
      </span>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.226.1">
         401
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.227.1">
        .
       </span>
      </span>
     </p>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.228.1">
     In fact, middleware is a powerful feature that allows you to have greater control over the flow of requests and responses in an application developed in ASP.NET
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.229.1">
      Core 9.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.230.1">
     Don’t worry about the details related to the preceding code examples.
    </span>
    <span class="koboSpan" id="kobo.230.2">
     We will learn about the structure of a middleware class in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.231.1">
      Implementing custom
     </span>
    </em>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.232.1">
       middleware
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.233.1">
      section.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.234.1">
     Despite the great
    </span>
    <a id="_idIndexMarker654">
    </a>
    <span class="koboSpan" id="kobo.235.1">
     benefits of applications using middleware, it is important to be aware of good practices; otherwise, what could be a benefit could become a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.236.1">
      major problem.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.237.1">
     Let’s look at some
    </span>
    <a id="_idIndexMarker655">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.238.1">
      best practices:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.239.1">
       Order matters
      </span>
     </strong>
     <span class="koboSpan" id="kobo.240.1">
      : The order in which middleware components are added is crucial as it affects how requests and responses
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.241.1">
       are processed.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.242.1">
       Keep it simple
      </span>
     </strong>
     <span class="koboSpan" id="kobo.243.1">
      : Middleware should do one thing and do it well.
     </span>
     <span class="koboSpan" id="kobo.243.2">
      Complex logic should be avoided
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.244.1">
       in middleware.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.245.1">
       Error handling
      </span>
     </strong>
     <span class="koboSpan" id="kobo.246.1">
      : Make sure your middleware components handle exceptions and errors in the same way as other classes in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.247.1">
       your application.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.248.1">
       Performance
      </span>
     </strong>
     <span class="koboSpan" id="kobo.249.1">
      : Be aware of the impact of middleware on performance, especially in high-load scenarios.
     </span>
     <span class="koboSpan" id="kobo.249.2">
      As it operates in request and response processes, avoid large amounts of processing during these stages to avoid causing problems for users and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.250.1">
       the application.
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.251.1">
       Reuse existing middleware
      </span>
     </strong>
     <span class="koboSpan" id="kobo.252.1">
      : Use built-in middleware whenever possible to reduce the need for custom implementations.
     </span>
     <span class="koboSpan" id="kobo.252.2">
      As we have already learned, there is some middleware available in ASP.NET
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.253.1">
       Core 9.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.254.1">
     Now that we understand the principles, benefits, and best practices of middleware, let’s implement our first custom middleware and learn the details of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.255.1">
      this approach.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-137">
    <a id="_idTextAnchor138">
    </a>
    <span class="koboSpan" id="kobo.256.1">
     Implementing custom middleware
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.257.1">
     Custom middleware
    </span>
    <a id="_idIndexMarker656">
    </a>
    <span class="koboSpan" id="kobo.258.1">
     allows you to encapsulate functionality and reuse it in different parts of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.259.1">
      your application.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.260.1">
     Creating custom middleware in
    </span>
    <a id="_idIndexMarker657">
    </a>
    <span class="koboSpan" id="kobo.261.1">
     ASP.NET Core 9 involves several steps, such as
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.262.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.263.1">
      Middleware
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.264.1">
       class definition
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.265.1">
      The implementation of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.266.1">
       Invoke
      </span>
     </strong>
     <span class="koboSpan" id="kobo.267.1">
      or
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.268.1">
        InvokeAsync
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.269.1">
       method
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.270.1">
      Middleware registration in the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.271.1">
       request pipeline
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.272.1">
     Let’s analyze the following code, which represents a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.273.1">
      customized middleware:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.274.1">
public class BeforeAfterRequestMiddleware
{
</span><strong class="bold"><span class="koboSpan" id="kobo.275.1">  private readonly RequestDelegate _next;</span></strong><span class="koboSpan" id="kobo.276.1">
  public </span><strong class="bold"><span class="koboSpan" id="kobo.277.1">BeforeAfterRequestMiddleware(RequestDelegate next)</span></strong><span class="koboSpan" id="kobo.278.1">
  {
  _next = next;
  }
</span><strong class="bold"><span class="koboSpan" id="kobo.279.1">  public async Task InvokeAsync(HttpContext context)</span></strong><span class="koboSpan" id="kobo.280.1">
  {
    // Logging request information
    Console.WriteLine($"Request:
      {context.Request.Method}
      {context.Request.Path}");
    // Call the next middleware in the pipeline
</span><strong class="bold"><span class="koboSpan" id="kobo.281.1">    await _next(context);</span></strong><span class="koboSpan" id="kobo.282.1">
    // Logging response information
    Console.WriteLine($"Response:
      {context.Response.StatusCode}");
  }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.283.1">
     This custom middleware
    </span>
    <a id="_idIndexMarker658">
    </a>
    <span class="koboSpan" id="kobo.284.1">
     code aims to just write a string to the console at the beginning and in the response of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.285.1">
      the request.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.286.1">
     However, it is important to understand the structure of the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.287.1">
      preceding code:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.288.1">
       RequestDelegate
      </span>
     </strong>
     <span class="koboSpan" id="kobo.289.1">
      : This is a delegate that represents the next middleware in the pipeline.
     </span>
     <span class="koboSpan" id="kobo.289.2">
      This delegate is stored in a field called
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.290.1">
       _next
      </span>
     </strong>
     <span class="koboSpan" id="kobo.291.1">
      for use in the context of
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.292.1">
       the class.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.293.1">
       Constructor
      </span>
     </strong>
     <span class="koboSpan" id="kobo.294.1">
      : The class constructor receives an instance of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.295.1">
       RequestDelegate
      </span>
     </strong>
     <span class="koboSpan" id="kobo.296.1">
      class as a parameter, representing the next middleware in the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.297.1">
       execution flow.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.298.1">
       Invoke
      </span>
     </strong>
     <span class="koboSpan" id="kobo.299.1">
      or
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.300.1">
       InvokeAsync
      </span>
     </strong>
     <span class="koboSpan" id="kobo.301.1">
      method: Contains the logic for processing HTTP requests.
     </span>
     <span class="koboSpan" id="kobo.301.2">
      The difference between the methods is that one is executed asynchronously and the other is not.
     </span>
     <span class="koboSpan" id="kobo.301.3">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.302.1">
       InvokeAsync
      </span>
     </strong>
     <span class="koboSpan" id="kobo.303.1">
      method receives an
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.304.1">
       HttpContext
      </span>
     </strong>
     <span class="koboSpan" id="kobo.305.1">
      object as a parameter.
     </span>
     <span class="koboSpan" id="kobo.305.2">
      The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.306.1">
       HttpContext
      </span>
     </strong>
     <span class="koboSpan" id="kobo.307.1">
      object allows you to access request and response information.
     </span>
     <span class="koboSpan" id="kobo.307.2">
      It is a good practice to use the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.308.1">
       InvokeAsync
      </span>
     </strong>
     <span class="koboSpan" id="kobo.309.1">
      method to improve performance
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.310.1">
       and scalability.
      </span>
     </span>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.311.1">
       await _next(context)
      </span>
     </strong>
     <span class="koboSpan" id="kobo.312.1">
      : Execution of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.313.1">
       _next
      </span>
     </strong>
     <span class="koboSpan" id="kobo.314.1">
      delegate, which receives the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.315.1">
       HttpContext
      </span>
     </strong>
     <span class="koboSpan" id="kobo.316.1">
      object as a parameter.
     </span>
     <span class="koboSpan" id="kobo.316.2">
      In this example, we are just writing a string containing request information before propagating the execution of the next middleware, and then another string is written with response information after executing
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.317.1">
       the middleware.
      </span>
     </span>
    </li>
   </ul>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.318.1">
     Dependency injection (DI) in middleware
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.319.1">
     Custom middleware
    </span>
    <a id="_idIndexMarker659">
    </a>
    <span class="koboSpan" id="kobo.320.1">
     classes must use the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.321.1">
      Explicit Dependencies Principle
     </span>
    </strong>
    <span class="koboSpan" id="kobo.322.1">
     (
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.323.1">
      EDP
     </span>
    </strong>
    <span class="koboSpan" id="kobo.324.1">
     ), as
    </span>
    <a id="_idIndexMarker660">
    </a>
    <span class="koboSpan" id="kobo.325.1">
     we have already learned in previous chapters, where the dependencies of a class are defined in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.326.1">
      the constructor.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.327.1">
     As middleware is built during application initialization, it is not possible to inject services added to a scoped lifetime as is done with each request in a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.328.1">
      Controller
     </span>
    </strong>
    <span class="koboSpan" id="kobo.329.1">
     class,
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.330.1">
      for example.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.331.1">
     So, if you want to use any services available in DI control in a middleware class, add these services to the signature of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.332.1">
      InvokeAsync
     </span>
    </strong>
    <span class="koboSpan" id="kobo.333.1">
     method, which can accept additional parameters resolved
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.334.1">
      by DI.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.335.1">
     The previous code example, although simple, demonstrates the basic structure of a middleware, which requires a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.336.1">
      RequestDelegated
     </span>
    </strong>
    <span class="koboSpan" id="kobo.337.1">
     field, a constructor that depends on an instance of
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.338.1">
      RequestDelegated
     </span>
    </strong>
    <span class="koboSpan" id="kobo.339.1">
     , and the implementation of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.340.1">
      Invoke
     </span>
    </strong>
    <span class="koboSpan" id="kobo.341.1">
     or
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.342.1">
       InvokeAsync
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.343.1">
      method.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.344.1">
     For the customized middleware to be used in the application, it is necessary to register it in the ASP.NET Core 9 execution pipeline through the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.345.1">
       Program.cs
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.346.1">
      file:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.347.1">
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();
</span><strong class="bold"><span class="koboSpan" id="kobo.348.1">app.UseMiddleware&lt;BeforeAfterRequestMiddleware&gt;();</span></strong><span class="koboSpan" id="kobo.349.1">
app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello, World!");
});
app.Run();</span></pre>
   <p>
    <span class="koboSpan" id="kobo.350.1">
     The preceding code has been shortened to make it easier to read and learn.
    </span>
    <span class="koboSpan" id="kobo.350.2">
     For the middleware to be registered, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.351.1">
      UseMiddleware
     </span>
    </strong>
    <span class="koboSpan" id="kobo.352.1">
     extension method is used, which is a generic method, where we define the previously executed custom middleware as
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.353.1">
      the type.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.354.1">
     During the application
    </span>
    <a id="_idIndexMarker661">
    </a>
    <span class="koboSpan" id="kobo.355.1">
     startup flow, all custom or non-customized middleware is created, forming part of the application lifecycle, and not by request, as is generally done in scoped services.
    </span>
    <span class="koboSpan" id="kobo.355.2">
     This behavior prevents other dependencies from being added to the constructor of a custom middleware class but allows the addition of dependencies with parameters through the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.356.1">
      Invoke
     </span>
    </strong>
    <span class="koboSpan" id="kobo.357.1">
     and
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.358.1">
       InvokeAsync
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.359.1">
      methods.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.360.1">
     Obtaining HTTP context objects in middleware
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.361.1">
     As an alternative to using
    </span>
    <a id="_idIndexMarker662">
    </a>
    <span class="koboSpan" id="kobo.362.1">
     DI in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.363.1">
      InvokeAsync
     </span>
    </strong>
    <span class="koboSpan" id="kobo.364.1">
     method, it is possible to use the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.365.1">
      context.RequestService
     </span>
    </strong>
    <span class="koboSpan" id="kobo.366.1">
     property (
    </span>
    <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpcontext.requestservices?view=aspnetcore-9.0">
     <span class="koboSpan" id="kobo.367.1">
      https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httpcontext.requestservices?view=aspnetcore-9.0
     </span>
    </a>
    <span class="koboSpan" id="kobo.368.1">
     ), as shown in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.369.1">
      following code:
     </span>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.370.1">
      public async Task
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.371.1">
       InvokeAsync(HttpContext context)
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.372.1">
      {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.373.1">
      var logger =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.374.1">
       context.RequestServices
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.375.1">
      .
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.376.1">
       GetRequiredService&lt;Ilogger
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.377.1">
      &lt;
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.378.1">
       BeforeAfterRequestMiddleware &gt;&gt;();
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.379.1">
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.380.1">
       logger.LogInformation($"Request:{context.Request.Method}
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.381.1">
      {
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.382.1">
       context.Request.Path}");
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.383.1">
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.384.1">
       await _next(context);
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.385.1">
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.386.1">
       logger.LogInformation($"Response:
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.387.1">
      {
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.388.1">
       context.Response.StatusCode}");
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.389.1">
      }
     </span>
    </strong>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.390.1">
     However, this somewhat decreases dependency visibility
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.391.1">
      in code.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.392.1">
     However, ASP.NET Core 9 offers an approach to enabling the use of custom middleware on a per-request basis using factory-based middleware, which we will discuss in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.393.1">
      next section.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-138">
    <a id="_idTextAnchor139">
    </a>
    <span class="koboSpan" id="kobo.394.1">
     Working with factory-based middleware
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.395.1">
     Another way
    </span>
    <a id="_idIndexMarker663">
    </a>
    <span class="koboSpan" id="kobo.396.1">
     to create custom middleware is by using the factory-based approach, which offers better performance and flexibility
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.397.1">
      using DI.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.398.1">
     This approach is particularly useful when the middleware requires
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.399.1">
      scoped services.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.400.1">
     Factory-based middleware uses the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.401.1">
      IMiddleware
     </span>
    </strong>
    <span class="koboSpan" id="kobo.402.1">
     interface, which allows the middleware to be activated by
    </span>
    <a id="_idIndexMarker664">
    </a>
    <span class="koboSpan" id="kobo.403.1">
     the
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.404.1">
      DI
     </span>
    </strong>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.405.1">
       container
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.406.1">
      (
     </span>
    </span>
    <span class="No-Break">
     <strong class="bold">
      <span class="koboSpan" id="kobo.407.1">
       DIC
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.408.1">
      ).
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.409.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.410.1">
      IMiddleware
     </span>
    </strong>
    <span class="koboSpan" id="kobo.411.1">
     interface has only one
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.412.1">
      InvokeAsync
     </span>
    </strong>
    <span class="koboSpan" id="kobo.413.1">
     method that must be implemented in the class.
    </span>
    <span class="koboSpan" id="kobo.413.2">
     The structure of a customized middleware that uses the factory-based approach is very similar to the traditional approach learned in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.414.1">
      previous section.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.415.1">
     Let’s look at a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.416.1">
      code example:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.417.1">
public class RequestLimitingMiddleware : IMiddleware
{
  private readonly ILogger
    &lt;RequestLimitingMiddleware&gt; _logger;
  </span><strong class="bold"><span class="koboSpan" id="kobo.418.1">public RequestLimitingMiddleware</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.419.1">    (ILogger&lt;RequestLimitingMiddleware&gt; logger)</span></strong><span class="koboSpan" id="kobo.420.1">
  {
    _logger = logger;
  }
  public async Task InvokeAsync(HttpContext context,
    </span><strong class="bold"><span class="koboSpan" id="kobo.421.1">RequestDelegate next</span></strong><span class="koboSpan" id="kobo.422.1">)
  {
    // Logic to limit the number of requests
    _logger.LogInformation("Processing request");
    await next(context);
  }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.423.1">
     The big difference with the factory-based approach is the definition of a dependency in the class constructor instead of declaring it as a parameter in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.424.1">
      InvokeAsync
     </span>
    </strong>
    <span class="koboSpan" id="kobo.425.1">
     method.
    </span>
    <span class="koboSpan" id="kobo.425.2">
     In the preceding code example, the constructor has a dependency on an
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.426.1">
       ILogger
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.427.1">
      interface.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.428.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.429.1">
      InvokeAsync
     </span>
    </strong>
    <span class="koboSpan" id="kobo.430.1">
     method must only have two parameters,
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.431.1">
      HttpContext
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.432.1">
      and
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.433.1">
       RequestDelegate
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.434.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.435.1">
     Now, let’s look at custom middleware registration, using the factory-based approach, by analyzing
    </span>
    <a id="_idIndexMarker665">
    </a>
    <span class="koboSpan" id="kobo.436.1">
     the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.437.1">
      Program.cs
     </span>
    </strong>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.438.1">
      class code:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.439.1">
var builder = WebApplication.CreateBuilder(args);
</span><strong class="bold"><span class="koboSpan" id="kobo.440.1">builder.Services.AddScoped&lt;RequestLimitingMiddleware&gt;();</span></strong><span class="koboSpan" id="kobo.441.1">
var app = builder.Build();
</span><strong class="bold"><span class="koboSpan" id="kobo.442.1">app.UseMiddleware&lt;RequestLimitingMiddleware&gt;();</span></strong><span class="koboSpan" id="kobo.443.1">
app.Run(async context =&gt;
{
    await context.Response.WriteAsync("Hello, World!");
});
app.Run();</span></pre>
   <p>
    <span class="koboSpan" id="kobo.444.1">
     Middleware registration is done using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.445.1">
      app.UseMiddleware
     </span>
    </strong>
    <span class="koboSpan" id="kobo.446.1">
     method, as we have already learned.
    </span>
    <span class="koboSpan" id="kobo.446.2">
     However, note that the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.447.1">
      RequestLimitingMiddleware
     </span>
    </strong>
    <span class="koboSpan" id="kobo.448.1">
     class is added to the scoped lifetime through the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.449.1">
      builder.Services.AddScoped&lt;RequestLimitingMiddleware&gt;()
     </span>
    </strong>
    <span class="koboSpan" id="kobo.450.1">
     code with the lifecycle managed
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.451.1">
      per request.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.452.1">
     Service lifetimes
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.453.1">
     ASP.NET Core 9 offers different types of
    </span>
    <a id="_idIndexMarker666">
    </a>
    <span class="koboSpan" id="kobo.454.1">
     service lifetimes; you can learn more
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.455.1">
      at
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection#service-lifetimes">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.456.1">
       https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection#service-lifetimes
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.457.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.458.1">
     As we can see, the factory-based approach allows us to use DIC resources and manage the middleware lifecycle
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.459.1">
      by request.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.460.1">
     Whether to use a
    </span>
    <a id="_idIndexMarker667">
    </a>
    <span class="koboSpan" id="kobo.461.1">
     factory-based or the traditional approach depends, of course, on the application requirements.
    </span>
    <span class="koboSpan" id="kobo.461.2">
     However, both are powerful solutions that add precious features to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.462.1">
      our applications.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.463.1">
     In the next section, we will create and use some common middleware used in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.464.1">
      many applications.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-139">
    <a id="_idTextAnchor140">
    </a>
    <span class="koboSpan" id="kobo.465.1">
     Adding capabilities to applications using middleware
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.466.1">
     Now that we have knowledge about the features and possibilities of middleware, we will work on some capabilities that will bring greater quality to our
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.467.1">
      web applications.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.468.1">
     There is no strict standard directory structure or namespace for creating middleware classes.
    </span>
    <span class="koboSpan" id="kobo.468.2">
     However, it is good practice to organize classes into
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.469.1">
      well-defined namespaces.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.470.1">
     For this example, we will default to creating a folder called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.471.1">
      Middlewares
     </span>
    </strong>
    <span class="koboSpan" id="kobo.472.1">
     in the root of your
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.473.1">
      application project.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.474.1">
     In this section, we will focus on the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.475.1">
      following middleware:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <span class="koboSpan" id="kobo.476.1">
      Global
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.477.1">
       error handling
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.478.1">
      Adding request logging – logging
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.479.1">
       request information
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.480.1">
      Rate limiting – defining request limits in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.481.1">
       your application
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.482.1">
     The project containing the classes mentioned in the preceding list is available in the book repository, the link to which can be found in the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.483.1">
      Technical
     </span>
    </em>
    <span class="No-Break">
     <em class="italic">
      <span class="koboSpan" id="kobo.484.1">
       requirements
      </span>
     </em>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.485.1">
      section.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.486.1">
     Let’s create a new application.
    </span>
    <span class="koboSpan" id="kobo.486.2">
     Open the terminal, and in a folder of your choice, create a project with the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.487.1">
      following command:
     </span>
    </span>
   </p>
   <pre class="console"><span class="koboSpan" id="kobo.488.1">
dotnet new mvc -n CommonMiddlewares</span></pre>
   <p>
    <span class="koboSpan" id="kobo.489.1">
     Then, in the root of the directory, create a folder
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.490.1">
      called
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.491.1">
       Middlewares
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.492.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.493.1">
     Now, we will start creating the first middleware: global
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.494.1">
      error handling.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-140">
    <a id="_idTextAnchor141">
    </a>
    <span class="koboSpan" id="kobo.495.1">
     Global error handling
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.496.1">
     During the execution flow of an
    </span>
    <a id="_idIndexMarker668">
    </a>
    <span class="koboSpan" id="kobo.497.1">
     application, errors or exceptions may arise
    </span>
    <a id="_idIndexMarker669">
    </a>
    <span class="koboSpan" id="kobo.498.1">
     that, if not handled correctly, may cause inconvenience
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.499.1">
      to users.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.500.1">
     In this case, we must handle errors in our code to prevent exceptions from causing applications
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.501.1">
      to malfunction.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.502.1">
     To achieve this, a good practice is to use a global error-handling middleware that makes it possible to manage the application’s exception flow in a centralized manner, even allowing it to extend its functionality by adding logs in different monitoring tools, which is essential for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.503.1">
      error corrections.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.504.1">
     Create a file called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.505.1">
      ErrorHandlingMiddleware.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.506.1">
     in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.507.1">
      Middlewares
     </span>
    </strong>
    <span class="koboSpan" id="kobo.508.1">
     folder you created earlier and add the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.509.1">
      following code:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.510.1">
public class ErrorHandlingMiddleware
{
  private readonly RequestDelegate _next;
  public ErrorHandlingMiddleware(RequestDelegate next)
  {
    _next = next;
  }
  public async Task InvokeAsync(HttpContext context)
  {
    try
    {
      await _next(context);
    }
    catch (Exception ex)
    {
      </span><strong class="bold"><span class="koboSpan" id="kobo.511.1">await HandleExceptionAsync(context, ex);</span></strong><span class="koboSpan" id="kobo.512.1">
    }
  }
  private Task </span><strong class="bold"><span class="koboSpan" id="kobo.513.1">HandleExceptionAsync(HttpContext context,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.514.1">    Exception exception)</span></strong><span class="koboSpan" id="kobo.515.1">
  {
    context.Response.ContentType = "application/json";
    context.Response.StatusCode = (int)HttpStatusCode
      .InternalServerError;
    return context.Response.WriteAsync(new </span><strong class="bold"><span class="koboSpan" id="kobo.516.1">ErrorDetails()</span></strong><span class="koboSpan" id="kobo.517.1">
    {
      StatusCode = context.Response.StatusCode,
      Message = "Internal Server Error from the custom middleware."
</span><span class="koboSpan" id="kobo.517.2">    }.ToString());
  }
}
public class ErrorDetails
{
  public int StatusCode { get; set; }
  public string Message { get; set; }
  public override string ToString()
  {
    return JsonSerializer.Serialize(this);
  }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.518.1">
     We can see in the
    </span>
    <a id="_idIndexMarker670">
    </a>
    <span class="koboSpan" id="kobo.519.1">
     preceding code the common structure of a middleware.
    </span>
    <span class="koboSpan" id="kobo.519.2">
     The
    </span>
    <a id="_idIndexMarker671">
    </a>
    <span class="koboSpan" id="kobo.520.1">
     great functionality of this global error-handling middleware is the use of the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.521.1">
      try
     </span>
    </strong>
    <span class="koboSpan" id="kobo.522.1">
     /
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.523.1">
      catch
     </span>
    </strong>
    <span class="koboSpan" id="kobo.524.1">
     block, in the body of the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.525.1">
       InvokeAsync
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.526.1">
      method.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.527.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.528.1">
      await _next(context)
     </span>
    </strong>
    <span class="koboSpan" id="kobo.529.1">
     command is executed in a
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.530.1">
      try
     </span>
    </strong>
    <span class="koboSpan" id="kobo.531.1">
     block so that if there is an exception in the application, it will be handled globally.
    </span>
    <span class="koboSpan" id="kobo.531.2">
     Exception handling is done through the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.532.1">
      HandleExceptionAsync
     </span>
    </strong>
    <span class="koboSpan" id="kobo.533.1">
     method, called in the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.534.1">
       catch
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.535.1">
      block.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.536.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.537.1">
      HandleExceptionAsync
     </span>
    </strong>
    <span class="koboSpan" id="kobo.538.1">
     method modifies the request response by changing the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.539.1">
      StatusCode
     </span>
    </strong>
    <span class="koboSpan" id="kobo.540.1">
     property to Internal Server Error,
    </span>
    <strong class="bold">
     <span class="koboSpan" id="kobo.541.1">
      HTTP status code 500
     </span>
    </strong>
    <span class="koboSpan" id="kobo.542.1">
     , in addition to returning an object in the request body.
    </span>
    <span class="koboSpan" id="kobo.542.2">
     This object is
    </span>
    <a id="_idIndexMarker672">
    </a>
    <span class="koboSpan" id="kobo.543.1">
     represented by the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.544.1">
      ErrorDetails
     </span>
    </strong>
    <span class="koboSpan" id="kobo.545.1">
     class, which has the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.546.1">
      StatusCode
     </span>
    </strong>
    <span class="koboSpan" id="kobo.547.1">
     and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.548.1">
      Message properties.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.549.1">
     Therefore, in addition to guaranteeing the handling of any exception in the application, there is a customized, but common, return that can be used appropriately for handling in a UI, allowing a better experience for the developers and also for the users of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.550.1">
      the application.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.551.1">
     Problems Details in ASP.NET Core 9
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.552.1">
     ASP.NET Core 9 provides built-in support for Problem Details, a standardized format for error responses based on RFC 7807 (https://datatracker.ietf.org/doc/html/rfc7807).
    </span>
    <span class="koboSpan" id="kobo.552.2">
     By incorporating Trace ID into the response, developers can enhance debugging and
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.553.1">
      error tracking.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.554.1">
     A Problem Details response with a Trace ID looks
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.555.1">
      like this:
     </span>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.556.1">
      {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.557.1">
      "
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.558.1">
       type": "https://example.com/probs/server-error",
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.559.1">
      "title": "An unexpected
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.560.1">
       error occurred.",
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.561.1">
      "
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.562.1">
       status": 500,
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.563.1">
      "detail": "The system encountered
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.564.1">
       an issue.",
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.565.1">
      "
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.566.1">
       instance": "/example-path",
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.567.1">
      "
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.568.1">
       traceId": "00-abcdef1234567890abcdef1234567890-1234567890abcdef-01"
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.569.1">
      }
     </span>
    </strong>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.570.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.571.1">
      ProblemDetails
     </span>
    </strong>
    <span class="koboSpan" id="kobo.572.1">
     class can be used in conjunction with the Middleware following the following implementation example, changing the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.573.1">
      HandleExceptionAsync
     </span>
    </strong>
    <span class="koboSpan" id="kobo.574.1">
     method of the
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.575.1">
       ErrorHandlingMiddleware
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.576.1">
      class:
     </span>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.577.1">
      private static Task HandleExceptionAsync(HttpContext context,
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.578.1">
       Exception exception)
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.579.1">
      {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.580.1">
      var traceId = Activity.Current?.Id ??
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.581.1">
       context.TraceIdentifier;
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.582.1">
      var problemDetails =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.583.1">
       new ProblemDetails
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.584.1">
      {
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.585.1">
      Type = "
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.586.1">
       server-error",
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.587.1">
      Title = "An unexpected
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.588.1">
       error occurred.",
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.589.1">
      Status =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.590.1">
       StatusCodes.Status500InternalServerError,
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.591.1">
      Detail = “Internal Server Error from the
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.592.1">
       custom middleware.”,
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.593.1">
      Instance =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.594.1">
       context.Request.Path
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.595.1">
      };
     </span>
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.596.1">
      // Include the Trace ID in the
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.597.1">
       Problem Details.
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.598.1">
      problemDetails.Extensions["traceId"] =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.599.1">
       traceId;
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.600.1">
      context.Response.ContentType = "
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.601.1">
       application/problem+json";
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.602.1">
      context.Response.StatusCode =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.603.1">
       StatusCodes.Status500InternalServerError;
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
    </strong>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.604.1">
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.605.1">
       return context.Response.WriteAsJsonAsync(problemDetails);
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.606.1">
      }
     </span>
    </strong>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.607.1">
     The preceding code is a customization of the Global Error Handler implemented through Middleware.
    </span>
    <span class="koboSpan" id="kobo.607.2">
     In addition to using the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.608.1">
      ProblemDetails
     </span>
    </strong>
    <span class="koboSpan" id="kobo.609.1">
     class, code is added to obtain the trace
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.610.1">
      id value:
     </span>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.611.1">
      var traceId = Activity.Current?.Id ??
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.612.1">
       context.TraceIdentifier;
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.613.1">
     Then, the trace ID is added to the extensions of the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.614.1">
      object ProblemdDetails&gt;:
     </span>
    </span>
   </p>
   <p class="callout">
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.615.1">
      problemDetails.Extensions["traceId"] =
     </span>
    </strong>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.616.1">
       traceId;
      </span>
     </strong>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.617.1">
     The trace ID is excellent information that should be part of the application Log, facilitating the correlation between error responses to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.618.1">
      resolve issues.
     </span>
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.619.1">
     ASP.NET Core 9 also has alternatives for error handling that you can learn more about at the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.620.1">
      URL:
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/aspnet/core/web-api/handle-errors?view=aspnetcore-9.0">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.621.1">
       https://learn.microsoft.com/en-us/aspnet/core/web-api/handle-errors?view=aspnetcore-9.0
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.622.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.623.1">
     Using global
    </span>
    <a id="_idIndexMarker673">
    </a>
    <span class="koboSpan" id="kobo.624.1">
     error handling brings an excellent benefit to applications, and, in
    </span>
    <a id="_idIndexMarker674">
    </a>
    <span class="koboSpan" id="kobo.625.1">
     addition, some log writing strategies could be used in cloud monitoring tools, in the terminal, or even in files, facilitating
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.626.1">
      problem resolution.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.627.1">
     The log functionality can be used for other purposes, not just to handle errors.
    </span>
    <span class="koboSpan" id="kobo.627.2">
     Let’s analyze another middleware approach for
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.628.1">
      logging requests.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-141">
    <a id="_idTextAnchor142">
    </a>
    <span class="koboSpan" id="kobo.629.1">
     Adding request logging
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.630.1">
     Every web application has a
    </span>
    <a id="_idIndexMarker675">
    </a>
    <span class="koboSpan" id="kobo.631.1">
     constant flow of communication and processing of
    </span>
    <a id="_idIndexMarker676">
    </a>
    <span class="koboSpan" id="kobo.632.1">
     requests that generate different types of information, as well as exceptions that must be handled, and we took care of this scenario when creating global error-handling middleware in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.633.1">
      previous section.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.634.1">
     In addition to handling errors and exceptions, we must log this information to be able to carry out effective troubleshooting.
    </span>
    <span class="koboSpan" id="kobo.634.2">
     However, in many cases, it is necessary to log information processed during the request and response flow of an application.
    </span>
    <span class="koboSpan" id="kobo.634.3">
     This approach offers
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.635.1">
      several benefits:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.636.1">
       Centralized logging
      </span>
     </strong>
     <span class="koboSpan" id="kobo.637.1">
      : Centralize logging logic, ensuring all requests are logged consistently in a single location in
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.638.1">
       the pipeline
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.639.1">
       Request tracking
      </span>
     </strong>
     <span class="koboSpan" id="kobo.640.1">
      : The ability to trace all requests is useful for monitoring application performance, debugging issues, and understanding
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.641.1">
       user behavior
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.642.1">
       Security and auditing
      </span>
     </strong>
     <span class="koboSpan" id="kobo.643.1">
      : By logging requests, you can maintain an audit trail of access to your application, which is essential for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.644.1">
       security compliance
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.645.1">
       Error diagnosis
      </span>
     </strong>
     <span class="koboSpan" id="kobo.646.1">
      : When problems arise, logs can help you diagnose and troubleshoot problems by providing a detailed history of the request activity that led to
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.647.1">
       an error
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.648.1">
       Performance monitoring
      </span>
     </strong>
     <span class="koboSpan" id="kobo.649.1">
      : Logging the time it takes to process requests can help identify performance bottlenecks and optimize
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.650.1">
       application performance
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.651.1">
       Flexibility
      </span>
     </strong>
     <span class="koboSpan" id="kobo.652.1">
      : The middleware can be configured to log only certain types of requests or responses, providing flexibility in how logging
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.653.1">
       is implemented
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.654.1">
     Let’s look at an example of middleware responsible for logging request data into the application.
    </span>
    <span class="koboSpan" id="kobo.654.2">
     To do this, create a class called
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.655.1">
      PerformanceLoggingMiddleware.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.656.1">
     in
    </span>
    <a id="_idIndexMarker677">
    </a>
    <span class="koboSpan" id="kobo.657.1">
     the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.658.1">
      Middlewares
     </span>
    </strong>
    <span class="koboSpan" id="kobo.659.1">
     folder and
    </span>
    <a id="_idIndexMarker678">
    </a>
    <span class="koboSpan" id="kobo.660.1">
     add the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.661.1">
      following code:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.662.1">
public class PerformanceLoggingMiddleware
{
  private readonly RequestDelegate _next;
  public PerformanceLoggingMiddleware(RequestDelegate next)
  {
    _next = next;
  }
  public async Task InvokeAsync(HttpContext context,
    </span><strong class="bold"><span class="koboSpan" id="kobo.663.1">ILogger&lt;PerformanceLoggingMiddleware&gt; logger</span></strong><span class="koboSpan" id="kobo.664.1">)
  {
    </span><strong class="bold"><span class="koboSpan" id="kobo.665.1">var timestamp = Stopwatch.GetTimestamp();</span></strong><span class="koboSpan" id="kobo.666.1">
    await _next(context);
    var elapsedMilliseconds = Stopwatch
      .GetElapsedTime(timestamp).TotalMilliseconds;
    </span><strong class="bold"><span class="koboSpan" id="kobo.667.1">logger.LogInformation("Request {Method} {Path}</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.668.1">      took {ElapsedMilliseconds} ms",</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.669.1">      context.Request.Method, context.Request.Path,</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.670.1">      elapsedMilliseconds)</span></strong><span class="koboSpan" id="kobo.671.1">;
  }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.672.1">
     The preceding code
    </span>
    <a id="_idIndexMarker679">
    </a>
    <span class="koboSpan" id="kobo.673.1">
     aims to record the execution time of a request.
    </span>
    <span class="koboSpan" id="kobo.673.2">
     This is an
    </span>
    <a id="_idIndexMarker680">
    </a>
    <span class="koboSpan" id="kobo.674.1">
     interesting approach to measuring the limits of your application and allowing you to improve the performance of
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.675.1">
      your implementation.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.676.1">
     When analyzing the code, we have
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.677.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.678.1">
       DI
      </span>
     </strong>
     <span class="koboSpan" id="kobo.679.1">
      : The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.680.1">
       InvokeAsync
      </span>
     </strong>
     <span class="koboSpan" id="kobo.681.1">
      method accepts an
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.682.1">
       ILogger&lt;PerformanceLoggingMiddleware&gt;
      </span>
     </strong>
     <span class="koboSpan" id="kobo.683.1">
      parameter, which is provided
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.684.1">
       by DI
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.685.1">
       Log request metrics
      </span>
     </strong>
     <span class="koboSpan" id="kobo.686.1">
      : The
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.687.1">
       InvokeAsync
      </span>
     </strong>
     <span class="koboSpan" id="kobo.688.1">
      method uses the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.689.1">
       ILogger
      </span>
     </strong>
     <span class="koboSpan" id="kobo.690.1">
      instance to log the HTTP method, request path, and time taken to process
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.691.1">
       the request
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.692.1">
       Collecting the request execution time
      </span>
     </strong>
     <span class="koboSpan" id="kobo.693.1">
      : Before executing the request, use the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.694.1">
       GetTimestamp()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.695.1">
      static method of the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.696.1">
       Stopwatch
      </span>
     </strong>
     <span class="koboSpan" id="kobo.697.1">
      object to get the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.698.1">
       initial timestamp
      </span>
     </span>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.699.1">
       After executing the request through the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.700.1">
        _await _next(context)
       </span>
      </strong>
      <span class="koboSpan" id="kobo.701.1">
       request delegation, the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.702.1">
        Stop
       </span>
      </strong>
      <span class="koboSpan" id="kobo.703.1">
       method of the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.704.1">
        Stopwatch
       </span>
      </strong>
      <span class="koboSpan" id="kobo.705.1">
       object is used to end
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.706.1">
        the timer.
       </span>
      </span>
     </p>
     <p class="list-inset">
      <span class="koboSpan" id="kobo.707.1">
       A log is then created containing information about the request, such as the method, path, and execution time in milliseconds, obtained from the
      </span>
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.708.1">
        Stopwatch
       </span>
      </strong>
      <span class="koboSpan" id="kobo.709.1">
       class throughout the
      </span>
      <span class="No-Break">
       <strong class="source-inline">
        <span class="koboSpan" id="kobo.710.1">
         GetElapsedTime(timestamp).TotalMilliseconds
        </span>
       </strong>
      </span>
      <span class="No-Break">
       <span class="koboSpan" id="kobo.711.1">
        method.
       </span>
      </span>
     </p>
    </li>
   </ul>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.712.1">
     The Stopwatch class
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.713.1">
     The
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.714.1">
      Stopwatch
     </span>
    </strong>
    <span class="koboSpan" id="kobo.715.1">
     class in .NET is a high-resolution timer provided by the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.716.1">
      System.Diagnostics
     </span>
    </strong>
    <span class="koboSpan" id="kobo.717.1">
     namespace.
    </span>
    <span class="koboSpan" id="kobo.717.2">
     It is used to measure elapsed time with great precision, making it ideal for performance measurement and benchmarking tasks.
    </span>
    <span class="koboSpan" id="kobo.717.3">
     Get more information about the features available in
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.718.1">
      Stopwatch
     </span>
    </strong>
    <span class="koboSpan" id="kobo.719.1">
     through the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.720.1">
      documentation:
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.stopwatch?view=net-9.0">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.721.1">
       https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.stopwatch?view=net-9.0
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.722.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.723.1">
     As we can see when
    </span>
    <a id="_idIndexMarker681">
    </a>
    <span class="koboSpan" id="kobo.724.1">
     implementing customized logs such as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.725.1">
      PerformanceLoggingMiddleware
     </span>
    </strong>
    <span class="koboSpan" id="kobo.726.1">
     , creating customized middleware enhances the
    </span>
    <a id="_idIndexMarker682">
    </a>
    <span class="koboSpan" id="kobo.727.1">
     functionalities of our applications, helping both the experience of users who consume quality applications and supporting teams in maintenance processes, diagnostics, and also
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.728.1">
      application evolution.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.729.1">
     However, ASP.NET Core 9 provides some middleware capable of dealing with several other important aspects of an application’s execution flow, such as rate limiting, which we will understand in the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.730.1">
      next section.
     </span>
    </span>
   </p>
   <h2 id="_idParaDest-142">
    <a id="_idTextAnchor143">
    </a>
    <span class="koboSpan" id="kobo.731.1">
     Rate limiting
    </span>
   </h2>
   <p>
    <span class="koboSpan" id="kobo.732.1">
     The rate-limiting
    </span>
    <a id="_idIndexMarker683">
    </a>
    <span class="koboSpan" id="kobo.733.1">
     middleware
    </span>
    <a id="_idIndexMarker684">
    </a>
    <span class="koboSpan" id="kobo.734.1">
     in ASP.NET Core 9 is a powerful feature that is essential for protecting applications from abuse and improving overall performance and reliability.
    </span>
    <span class="koboSpan" id="kobo.734.2">
     This middleware controls the number of requests a client can make to a server within a specified period
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.735.1">
      of time.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.736.1">
     Using the rate-limiting middleware in ASP.NET Core 9 is done by adding the configuration in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.737.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.738.1">
     file.
    </span>
    <span class="koboSpan" id="kobo.738.2">
     The following is a
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.739.1">
      step-by-step guide:
     </span>
    </span>
   </p>
   <ol>
    <li>
     <span class="koboSpan" id="kobo.740.1">
      Add the required
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.741.1">
       NuGet packages.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.742.1">
      Register the middleware in the HTTP
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.743.1">
       request pipeline.
      </span>
     </span>
    </li>
    <li>
     <span class="koboSpan" id="kobo.744.1">
      Add rate-limiting middleware to the pipeline.
     </span>
     <span class="koboSpan" id="kobo.744.2">
      Rate-limiting middleware is included
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.745.1">
       in
      </span>
     </span>
     <span class="No-Break">
      <strong class="source-inline">
       <span class="koboSpan" id="kobo.746.1">
        Microsoft.AspNetCore.RateLimiting
       </span>
      </strong>
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.747.1">
       .
      </span>
     </span>
    </li>
   </ol>
   <p>
    <span class="koboSpan" id="kobo.748.1">
     Let’s see an example of implementation in a Razor Pages-type application using the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.749.1">
      following code:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.750.1">
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
</span><strong class="bold"><span class="koboSpan" id="kobo.751.1">using Microsoft.AspNetCore.RateLimiting;</span></strong><span class="koboSpan" id="kobo.752.1">
using System.Threading.RateLimiting;
var builder = WebApplication.CreateBuilder(args);
builder.Services.AddRazorPages();
// Configure rate limiting policies
</span><strong class="bold"><span class="koboSpan" id="kobo.753.1">builder.Services.AddRateLimiter(</span></strong><span class="koboSpan" id="kobo.754.1">options =&gt;
{
  options.AddPolicy("fixed", context =&gt;
    RateLimitPartition.GetFixedWindowLimiter(new
    RateLimitPartitionKey(context.Request
    .Headers["X-Forwarded-For"].ToString(),
    PartitionKeyKind.ClientIP), partition =&gt;
      new FixedWindowRateLimiterOptions
      {
        PermitLimit = 5,
        Window = TimeSpan.FromMinutes(1),
        QueueProcessingOrder = QueueProcessingOrder
          .OldestFirst,
          QueueLimit = 2
      }));
  options.AddPolicy("sliding", context =&gt;
    RateLimitPartition.GetSlidingWindowLimiter(new
    RateLimitPartitionKey(context.Request
    .Headers["X-Forwarded-For"].ToString(),
    PartitionKeyKind.ClientIP), partition =&gt;
      new SlidingWindowRateLimiterOptions
      {
        PermitLimit = 5,
        Window = TimeSpan.FromMinutes(1),
          SegmentsPerWindow = 3,
        QueueProcessingOrder = QueueProcessingOrder
          .OldestFirst,
          QueueLimit = 2
      }));
  options.AddPolicy("tokenBucket", context =&gt;
    RateLimitPartition.GetTokenBucketLimiter(new
    RateLimitPartitionKey(context.Request
    .Headers["X-Forwarded-For"].ToString(),
    PartitionKeyKind.ClientIP), partition =&gt;
      new TokenBucketRateLimiterOptions
      {
        TokenLimit = 10,
        TokensPerPeriod = 5,
        ReplenishmentPeriod = TimeSpan.FromSeconds(10),
        QueueProcessingOrder = QueueProcessingOrder
          .OldestFirst,
          QueueLimit = 2
      }));
});
var app = builder.Build();
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
}
// Use rate limiting middleware
</span><strong class="bold"><span class="koboSpan" id="kobo.755.1">app.UseRateLimiter();</span></strong><span class="koboSpan" id="kobo.756.1">
app.MapRazorPages();
app.Run();</span></pre>
   <p>
    <span class="koboSpan" id="kobo.757.1">
     Now, let’s analyze the
    </span>
    <a id="_idIndexMarker685">
    </a>
    <span class="koboSpan" id="kobo.758.1">
     important aspects of the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.759.1">
      preceding
     </span>
    </span>
    <span class="No-Break">
     <a id="_idIndexMarker686">
     </a>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.760.1">
      code:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.761.1">
       builder.Services.AddRateLimiter
      </span>
     </strong>
     <span class="koboSpan" id="kobo.762.1">
      : Required to define the rate limit policies that will be used in this application.
     </span>
     <span class="koboSpan" id="kobo.762.2">
      Each policy uses a unique client identifier, adding the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.763.1">
       X-Forwarded-For
      </span>
     </strong>
     <span class="koboSpan" id="kobo.764.1">
      HTTP header, to enforce limits per client IP address.
     </span>
     <span class="koboSpan" id="kobo.764.2">
      In the previous code, we configured three policies – namely,
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.765.1">
       the following:
      </span>
     </span>
     <ul>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.766.1">
         Fixed window
        </span>
       </strong>
       <span class="koboSpan" id="kobo.767.1">
        : Limits requests to 5 per minute.
       </span>
       <span class="koboSpan" id="kobo.767.2">
        Once the limit is reached, no further requests will be allowed until the window
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.768.1">
         is reset.
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.769.1">
         Sliding window
        </span>
       </strong>
       <span class="koboSpan" id="kobo.770.1">
        : Similar to the fixed window policy, but divides the window into segments, allowing for a more distributed request margin
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.771.1">
         per minute.
        </span>
       </span>
      </li>
      <li>
       <strong class="bold">
        <span class="koboSpan" id="kobo.772.1">
         Token bucket
        </span>
       </strong>
       <span class="koboSpan" id="kobo.773.1">
        : Allows you to make up to 10 tokens (requests) available, with 5 new tokens replenished every 10 seconds.
       </span>
       <span class="koboSpan" id="kobo.773.2">
        If tokens run out, incoming requests will
       </span>
       <span class="No-Break">
        <span class="koboSpan" id="kobo.774.1">
         be queued.
        </span>
       </span>
      </li>
     </ul>
    </li>
    <li>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.775.1">
       app.UseRateLimiter()
      </span>
     </strong>
     <span class="koboSpan" id="kobo.776.1">
      : This line adds the rate-limiting middleware to the request pipeline, enabling the configured rate-limiting policies to take effect.
     </span>
     <span class="koboSpan" id="kobo.776.2">
      Unlike the traditional way of adding middleware where the
     </span>
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.777.1">
       UseMiddleware&lt;&gt;
      </span>
     </strong>
     <span class="koboSpan" id="kobo.778.1">
      method is used, rate limiting has an exclusive extension method.
     </span>
     <span class="koboSpan" id="kobo.778.2">
      We will learn how to create extension methods to add middleware in the
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.779.1">
       next section.
      </span>
     </span>
    </li>
   </ul>
   <p>
    <span class="koboSpan" id="kobo.780.1">
     Rate limiting is
    </span>
    <a id="_idIndexMarker687">
    </a>
    <span class="koboSpan" id="kobo.781.1">
     an important
    </span>
    <a id="_idIndexMarker688">
    </a>
    <span class="koboSpan" id="kobo.782.1">
     feature that should be considered when developing ASP.NET Core 9 applications, bringing some benefits such as
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.783.1">
      the following:
     </span>
    </span>
   </p>
   <ul>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.784.1">
       Overload protection
      </span>
     </strong>
     <span class="koboSpan" id="kobo.785.1">
      : Prevents the server from being overloaded by too many requests, ensuring
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.786.1">
       stable performance
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.787.1">
       Fair use
      </span>
     </strong>
     <span class="koboSpan" id="kobo.788.1">
      : Ensures that no client can monopolize server resources, promoting equitable access for
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.789.1">
       all users
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.790.1">
       Security:
      </span>
     </strong>
     <span class="koboSpan" id="kobo.791.1">
      Mitigates certain types of attacks, such as
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.792.1">
       Distributed Denial-of-Service
      </span>
     </strong>
     <span class="koboSpan" id="kobo.793.1">
      (
     </span>
     <strong class="bold">
      <span class="koboSpan" id="kobo.794.1">
       DDoS
      </span>
     </strong>
     <span class="koboSpan" id="kobo.795.1">
      ) attacks, by limiting
     </span>
     <a id="_idIndexMarker689">
     </a>
     <span class="koboSpan" id="kobo.796.1">
      the rate at which clients can
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.797.1">
       make requests
      </span>
     </span>
    </li>
    <li>
     <strong class="bold">
      <span class="koboSpan" id="kobo.798.1">
       Improved user experience
      </span>
     </strong>
     <span class="koboSpan" id="kobo.799.1">
      : By preventing server overload, rate limiting helps maintain consistent response times and
     </span>
     <span class="No-Break">
      <span class="koboSpan" id="kobo.800.1">
       service availability
      </span>
     </span>
    </li>
   </ul>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.801.1">
     Learning more about rate-limiting middleware
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.802.1">
     Rate limiting has several other features that can add to your strategy for using this middleware.
    </span>
    <span class="koboSpan" id="kobo.802.2">
     See the documentation for more
    </span>
    <a id="_idIndexMarker690">
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.803.1">
      details:
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/aspnet/core/performance/rate-limit?view=aspnetcore-9.0">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.804.1">
       https://learn.microsoft.com/en-us/aspnet/core/performance/rate-limit?view=aspnetcore-9.0
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.805.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.806.1">
     In addition to rate-limiting middleware, ASP.NET Core 9 offers different other middleware that are widely used in different types of applications, such as authentication and authorization middleware, discussed in
    </span>
    <a href="B21788_06.xhtml#_idTextAnchor093">
     <span class="No-Break">
      <em class="italic">
       <span class="koboSpan" id="kobo.807.1">
        Chapter 6
       </span>
      </em>
     </span>
    </a>
    <span class="koboSpan" id="kobo.808.1">
     .
    </span>
    <span class="koboSpan" id="kobo.808.2">
     Depending on your application requirements, you can combine the capabilities of middleware to create powerful, high-quality
    </span>
    <a id="_idIndexMarker691">
    </a>
    <span class="koboSpan" id="kobo.809.1">
     solutions
    </span>
    <a id="_idIndexMarker692">
    </a>
    <span class="koboSpan" id="kobo.810.1">
     that run in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.811.1">
      modern environments.
     </span>
    </span>
   </p>
   <p class="callout-heading">
    <span class="koboSpan" id="kobo.812.1">
     ASP.NET Core 9 built-in middleware
    </span>
   </p>
   <p class="callout">
    <span class="koboSpan" id="kobo.813.1">
     Consult the documentation to analyze the
    </span>
    <a id="_idIndexMarker693">
    </a>
    <span class="koboSpan" id="kobo.814.1">
     different middleware available on the ASP.NET Core 9 platform at the following
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.815.1">
      URL:
     </span>
    </span>
    <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-9.0#built-in-middleware">
     <span class="No-Break">
      <span class="koboSpan" id="kobo.816.1">
       https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-9.0#built-in–middleware
      </span>
     </span>
    </a>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.817.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.818.1">
     Now that we have created customized middleware and learned how to use the rate-limiting middleware available in ASP.NET Core 9, it is time to learn a good practice for registering middleware using
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.819.1">
      extension methods.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-143">
    <a id="_idTextAnchor144">
    </a>
    <span class="koboSpan" id="kobo.820.1">
     Creating an extension method for middleware registration
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.821.1">
     With the
    </span>
    <a id="_idIndexMarker694">
    </a>
    <span class="koboSpan" id="kobo.822.1">
     exception of middleware
    </span>
    <a id="_idIndexMarker695">
    </a>
    <span class="koboSpan" id="kobo.823.1">
     built into ASP.NET Core 9, which have their respective extension methods for registration in the HTTP pipeline, each custom middleware must be registered using extension methods, such as
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.824.1">
      UseMiddleware&lt;&gt;
     </span>
    </strong>
    <span class="koboSpan" id="kobo.825.1">
     , already used in several code examples from
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.826.1">
      this chapter.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.827.1">
     However, the addition of different middleware to the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.828.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.829.1">
     file can create complexity in reading and maintaining these resources in
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.830.1">
      the application.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.831.1">
     A good practice is to create extension methods in order to centralize the registration of middleware and have the benefit of abstracting the complexity of configuring these mechanisms, in addition to centralizing
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.832.1">
      responsibilities appropriately.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.833.1">
     Let’s create an
    </span>
    <a id="_idIndexMarker696">
    </a>
    <span class="koboSpan" id="kobo.834.1">
     extension method to centralize
    </span>
    <a id="_idIndexMarker697">
    </a>
    <span class="koboSpan" id="kobo.835.1">
     the configurations of the previously created middleware.
    </span>
    <span class="koboSpan" id="kobo.835.2">
     To do this, in the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.836.1">
      Middlewares
     </span>
    </strong>
    <span class="koboSpan" id="kobo.837.1">
     folder, create a new class
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.838.1">
      called
     </span>
    </span>
    <span class="No-Break">
     <strong class="source-inline">
      <span class="koboSpan" id="kobo.839.1">
       CommonMiddlewareExtension.cs
      </span>
     </strong>
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.840.1">
      .
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.841.1">
     Add the following code to
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.842.1">
      this class:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.843.1">
using Microsoft.AspNetCore.Builder;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.AspNetCore.RateLimiting;
using System.Threading.RateLimiting;
public static class CommonMiddlewareExtensions
{
  public static IServiceCollection AddCustomRateLimiting
    (this IServiceCollection services)
  {
    services.AddRateLimiter(options =&gt;
    {
      options.AddPolicy("fixed", context =&gt;
        RateLimitPartition.GetFixedWindowLimiter(new
        RateLimitPartitionKey(context.Request
        .Headers["X-Forwarded-For"].ToString(),
        PartitionKeyKind.ClientIP), partition =&gt;
          new FixedWindowRateLimiterOptions
          {
            PermitLimit = 5,
            Window = TimeSpan.FromMinutes(1),
            QueueProcessingOrder = QueueProcessingOrder
              .OldestFirst,
              QueueLimit = 2
          }));
      options.AddPolicy("sliding", context =&gt;
        RateLimitPartition.GetSlidingWindowLimiter(new
        RateLimitPartitionKey(context.Request
        .Headers["X-Forwarded-For"].ToString(),
        PartitionKeyKind.ClientIP), partition =&gt;
          new SlidingWindowRateLimiterOptions
          {
            PermitLimit = 5,
            Window = TimeSpan.FromMinutes(1),
            SegmentsPerWindow = 3,
            QueueProcessingOrder = QueueProcessingOrder
              .OldestFirst,
              QueueLimit = 2
            }));
      options.AddPolicy("tokenBucket", context =&gt;
        RateLimitPartition.GetTokenBucketLimiter(new
        RateLimitPartitionKey(context.Request
        .Headers["X-Forwarded-For"].ToString(),
        PartitionKeyKind.ClientIP), partition =&gt;
          new TokenBucketRateLimiterOptions
          {
            TokenLimit = 10,
            TokensPerPeriod = 5,
            ReplenishmentPeriod = TimeSpan.FromSeconds(10),
            QueueProcessingOrder = QueueProcessingOrder
              .OldestFirst,
              QueueLimit = 2
          }));
    });
    return services;
  }
  public static void UseCommonApplicationMiddleware
    (this IApplicationBuilder app)
  {
    builder.UseMiddleware&lt;ErrorHandlingMiddleware&gt;();
    builder.UseMiddleware&lt;PerformanceLoggingMiddleware&gt;();
    app.UseRateLimiter();
  }
}</span></pre>
   <p>
    <span class="koboSpan" id="kobo.844.1">
     The preceding
    </span>
    <a id="_idIndexMarker698">
    </a>
    <span class="koboSpan" id="kobo.845.1">
     code contains all the rate-limiting
    </span>
    <a id="_idIndexMarker699">
    </a>
    <span class="koboSpan" id="kobo.846.1">
     middleware settings, in addition to the use of global error-handling and request performance
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.847.1">
      measurement middleware.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.848.1">
     This
    </span>
    <a id="_idIndexMarker700">
    </a>
    <span class="koboSpan" id="kobo.849.1">
     extension method class exposes two
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.850.1">
      AddCustomRateLimiting
     </span>
    </strong>
    <span class="koboSpan" id="kobo.851.1">
     methods, responsible for adding the rate-limiting policies, and
    </span>
    <a id="_idIndexMarker701">
    </a>
    <span class="koboSpan" id="kobo.852.1">
     the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.853.1">
      UseCommonApplicationMiddleware
     </span>
    </strong>
    <span class="koboSpan" id="kobo.854.1">
     method, responsible for adding the previously created custom middleware and the rate-limiting middleware to the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.855.1">
      HTTP pipeline.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.856.1">
     After creating the class, we will change the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.857.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.858.1">
     file, which will have the
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.859.1">
      following code:
     </span>
    </span>
   </p>
   <pre class="source-code"><span class="koboSpan" id="kobo.860.1">
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
var builder = WebApplication.CreateBuilder(args);
builder.Services.AddRazorPages();
</span><strong class="bold"><span class="koboSpan" id="kobo.861.1">builder.Services.AddCustomRateLimiting();</span></strong><span class="koboSpan" id="kobo.862.1">
var app = builder.Build();
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
}
// Use custom rate limiting middleware
</span><strong class="bold"><span class="koboSpan" id="kobo.863.1">app.UseCommonApplicationMiddleware();</span></strong><span class="koboSpan" id="kobo.864.1">
app.MapRazorPages();
app.Run();</span></pre>
   <p>
    <span class="koboSpan" id="kobo.865.1">
     As we
    </span>
    <a id="_idIndexMarker702">
    </a>
    <span class="koboSpan" id="kobo.866.1">
     can see in the highlighted code, the
    </span>
    <strong class="source-inline">
     <span class="koboSpan" id="kobo.867.1">
      Program.cs
     </span>
    </strong>
    <span class="koboSpan" id="kobo.868.1">
     class uses the previously created extension methods, making
    </span>
    <a id="_idIndexMarker703">
    </a>
    <span class="koboSpan" id="kobo.869.1">
     it more readable and easier
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.870.1">
      to maintain.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.871.1">
     The extension method approach is a good practice for grouping a set of configurations in your application flow in order to correctly
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.872.1">
      separate responsibilities.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.873.1">
     Use these features in your web application deployment flow with ASP.NET Core 9 and combine different middleware to create more
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.874.1">
      powerful applications.
     </span>
    </span>
   </p>
   <p>
    <span class="koboSpan" id="kobo.875.1">
     In the next chapters of the book, we will cover other different techniques to further add possibilities to your ASP.NET Core 9 applications, such as secure
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.876.1">
      configuration management.
     </span>
    </span>
   </p>
   <h1 id="_idParaDest-144">
    <a id="_idTextAnchor145">
    </a>
    <span class="koboSpan" id="kobo.877.1">
     Summary
    </span>
   </h1>
   <p>
    <span class="koboSpan" id="kobo.878.1">
     In this chapter, we learned how to use the power of middleware to customize the execution flow of ASP.NET Core 9 applications, understanding how the middleware pipeline works.
    </span>
    <span class="koboSpan" id="kobo.878.2">
     In addition, we learned how to implement custom middleware, work with factory-based middleware, and add capabilities to applications by working with global error handling approaches, information logging, and request limit settings.
    </span>
    <span class="koboSpan" id="kobo.878.3">
     In the next chapter, we will explore how to manage application
    </span>
    <span class="No-Break">
     <span class="koboSpan" id="kobo.879.1">
      configurations securely.
     </span>
    </span>
   </p>
  </div>
 </body></html>