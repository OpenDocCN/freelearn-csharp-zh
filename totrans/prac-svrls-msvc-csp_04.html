<html><head></head><body>
<div id="_idContainer101">
<h1 class="chapterNumber"><a id="_idTextAnchor105"/><span class="koboSpan" id="kobo.1.1">4</span></h1>
<h1 class="chapterTitle" id="_idParaDest-71"><a id="_idTextAnchor106"/><span class="koboSpan" id="kobo.2.1">Azure Functions and Triggers Available</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">The first three chapters of the book covered the background of serverless and microservices, focusing on how to use these technologies to design an application that works with a microservice-based architecture. </span><span class="koboSpan" id="kobo.3.2">This and the following chapters will go deep into the options you have for writing code for this, using the car-sharing example presented in </span><a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic"><span class="koboSpan" id="kobo.4.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.5.1">, </span><em class="italic"><span class="koboSpan" id="kobo.6.1">Demystifying Microservices Applications</span></em><span class="koboSpan" id="kobo.7.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.8.1">To do so, in this chapter, we will present the different triggers available in Azure Functions. </span><span class="koboSpan" id="kobo.8.2">The point here is not just to write about it, but to also test it with each of the triggers presented. </span><span class="koboSpan" id="kobo.8.3">In </span><a href="Chapter_1.xhtml#_idTextAnchor022"><em class="italic"><span class="koboSpan" id="kobo.9.1">Chapter 1</span></em></a><span class="koboSpan" id="kobo.10.1">, </span><em class="italic"><span class="koboSpan" id="kobo.11.1">Demystifying Serverless Application</span></em><span class="koboSpan" id="kobo.12.1">, we covered its basis, but we did not have the opportunity to implement them.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.13.1">In this chapter, we will focus on three important triggers that we can use when implementing Azure Functions – the HTTP, SQL, and Cosmos DB triggers. </span><span class="koboSpan" id="kobo.13.2">Together with their implementation, we will discuss their advantages, disadvantages, and when they are a good approach to be used. </span><span class="koboSpan" id="kobo.13.3">We will also see how they work using the car-sharing example as a basis for understanding the purpose of each trigger better. </span><span class="koboSpan" id="kobo.13.4">Let’s start!</span></p>
<h1 class="heading-1" id="_idParaDest-72"><a id="_idTextAnchor107"/><span class="koboSpan" id="kobo.14.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.15.1">This chapter requires the free </span><em class="italic"><span class="koboSpan" id="kobo.16.1">Community edition </span></em><span class="koboSpan" id="kobo.17.1">of Visual Studio 2022, or Visual Studio Code. </span><span class="koboSpan" id="kobo.17.2">You will also need an Azure account to create the sample environment. </span><span class="koboSpan" id="kobo.17.3">You can find the sample code for this chapter at </span><a href="https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp"><span class="url"><span class="koboSpan" id="kobo.18.1">https://github.com/PacktPublishing/Practical-Serverless-and-Microservices-with-Csharp</span></span></a><span class="koboSpan" id="kobo.19.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-73"><a id="_idTextAnchor108"/><span class="koboSpan" id="kobo.20.1">HTTP trigger</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.21.1">The most used trigger in Azure Functions is certainly the HTTP trigger. </span><span class="koboSpan" id="kobo.21.2">The basis of this option is to enable you to have</span><a id="_idIndexMarker238"/><span class="koboSpan" id="kobo.22.1"> HTTP requests, so you can build APIs, webhooks, and integrations in a very fast way. </span><span class="koboSpan" id="kobo.22.2">The idea is that a method in Azure Functions is triggered as soon as an HTTP request is made, enabling the appropriate function to return the corresponding response.</span></p>
<h1 class="heading-1" id="_idParaDest-74"><a id="_idTextAnchor109"/><span class="koboSpan" id="kobo.23.1">Advantages, disadvantages, and when to use the HTTP trigger</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.24.1">The main advantage </span><a id="_idIndexMarker239"/><span class="koboSpan" id="kobo.25.1">of the HTTP trigger is its ease of use. </span><span class="koboSpan" id="kobo.25.2">It is straightforward to implement and can be set up quickly. </span><span class="koboSpan" id="kobo.25.3">So, even if you are new to Azure Functions, you can get started with it quickly.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.26.1">Besides that, it supports multiple HTTP methods, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.27.1">GET</span></code><span class="koboSpan" id="kobo.28.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.29.1">POST</span></code><span class="koboSpan" id="kobo.30.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.31.1">PUT</span></code><span class="koboSpan" id="kobo.32.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.33.1">DELETE</span></code><span class="koboSpan" id="kobo.34.1">, allowing you to handle a variety of web requests and actions. </span><span class="koboSpan" id="kobo.34.2">You can also have more than one function running on the same application, so it is a great way of delivering a microservice.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.35.1">Another great advantage of HTTP triggers is that they can integrate with other Azure services and third-party APIs, so you can handle </span><a id="_idIndexMarker240"/><span class="koboSpan" id="kobo.36.1">complex logic. </span><span class="koboSpan" id="kobo.36.2">All these benefits come on top of the scalability and cost-effectiveness delivered by Azure Functions, so your application will remain responsive under high traffic and you will only pay for the executions that you carry out.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.37.1">When it comes to security, HTTP triggers enable us to implement different levels of authorization. </span><span class="koboSpan" id="kobo.37.2">These levels range from anonymous access up to the admin level, as described in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.38.1">AuthorizationLevel</span></code><span class="koboSpan" id="kobo.39.1"> enum:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.40.1"><img alt="Figure 4.1: Authorization level – source: Microsoft Learn" src="../Images/B31916_04_1.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.41.1">Figure 4.1: Authorization level – source: Microsoft Learn</span></p>
<p class="normal"><span class="koboSpan" id="kobo.42.1">It is worth mentioning</span><a id="_idIndexMarker241"/><span class="koboSpan" id="kobo.43.1"> that these keys are managed inside an Azure Functions app, as we can see in the following figure.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.44.1"><img alt="Figure 4.2: Azure Functions – App keys" src="../Images/B31916_04_2.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.45.1">Figure 4.2: Azure Functions – App keys</span></p>
<p class="normal"><span class="koboSpan" id="kobo.46.1">When it comes to the disadvantages </span><a id="_idIndexMarker242"/><span class="koboSpan" id="kobo.47.1">of HTTP triggers, there is what is called </span><strong class="keyWord"><span class="koboSpan" id="kobo.48.1">cold-start latency</span></strong><span class="koboSpan" id="kobo.49.1">, where there</span><a id="_idIndexMarker243"/><span class="koboSpan" id="kobo.50.1"> must be a delay the first time the function is invoked after a period of inactivity. </span><span class="koboSpan" id="kobo.50.2">Also, you must consider that the idea of this kind of application is to deliver stateless solutions, so handling stateful operations or long-running processes can be more challenging with HTTP triggers alone. </span><span class="koboSpan" id="kobo.50.3">For this, you may consider using Azure Durable Functions.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.51.1">You may also encounter some resource limits, such as execution timeouts and memory used, but these limits usually mean that you are encountering a design issue.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.52.1">Considering all the information </span><a id="_idIndexMarker244"/><span class="koboSpan" id="kobo.53.1">provided, the HTTP trigger is best used in scenarios where you need to create lightweight, stateless functions that respond to web requests. </span><span class="koboSpan" id="kobo.53.2">This may include RESTful APIs to expose an application’s functionality or a microservice, webhooks for handling real-time notifications, or even drive integrations. </span><span class="koboSpan" id="kobo.53.3">HTTP triggers can also be great for rapidly testing a scenario, using it as a prototype.</span></p>
<h2 class="heading-2" id="_idParaDest-75"><a id="_idTextAnchor110"/><span class="koboSpan" id="kobo.54.1">Car-sharing HTTP trigger example</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.55.1">As we discussed in </span><a href="Chapter_2.xhtml#_idTextAnchor038"><em class="italic"><span class="koboSpan" id="kobo.56.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.57.1">, </span><em class="italic"><span class="koboSpan" id="kobo.58.1">Demystifying Microservices Applications</span></em><span class="koboSpan" id="kobo.59.1">, the carholders’ requests can be called by a user throughout CRUD operations. </span><span class="koboSpan" id="kobo.59.2">The sample code provided in this chapter will give you an Azure Functions project</span><a id="_idIndexMarker245"/><span class="koboSpan" id="kobo.60.1"> with four HTTP trigger functions that represent these CRUD operations. </span><span class="koboSpan" id="kobo.60.2">Also, it is important to mention that today it is good practice to deliver APIs with OpenAPI documentation attached. </span><span class="koboSpan" id="kobo.60.3">To do so, this </span><a id="_idIndexMarker246"/><span class="koboSpan" id="kobo.61.1">example will make use of the </span><strong class="keyWord"><span class="koboSpan" id="kobo.62.1">OpenAPI extension for Azure Functions</span></strong><span class="koboSpan" id="kobo.63.1">. </span><span class="koboSpan" id="kobo.63.2">The result can be seen in the following figure, where we have described each Azure Functions HTTP trigger created.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.64.1"><img alt="Figure 4.3: Car Holding API sample" src="../Images/B31916_04_3.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.65.1">Figure 4.3: Car Holding API sample</span></p>
<p class="normal"><span class="koboSpan" id="kobo.66.1">The great thing about delivering APIs with this pattern is that you will be following the most common scenarios of APIs </span><a id="_idIndexMarker247"/><span class="koboSpan" id="kobo.67.1">that the current industry is requesting. </span><span class="koboSpan" id="kobo.67.2">Also, delivering versioned APIs is considered a great practice to follow, so you can guarantee compatibility with other systems.</span></p>
<h1 class="heading-1" id="_idParaDest-76"><a id="_idTextAnchor111"/><span class="koboSpan" id="kobo.68.1">Advantages, disadvantages, and when to use the Azure SQL trigger</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.69.1">Imagine the possibility of </span><a id="_idIndexMarker248"/><span class="koboSpan" id="kobo.70.1">having a function trigger as soon as an Azure SQL Database change happens. </span><span class="koboSpan" id="kobo.70.2">This is where the Azure SQL trigger can help you. </span><span class="koboSpan" id="kobo.70.3">With the possibility of monitoring rows that are inserted, updated, or deleted, this function is invoked as soon as the event happens, enabling real-time data processing and integration.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.71.1">It is important to mention that this trigger is only available if you have SQL Server change tracking enabled in your database and in the table that you define to monitor.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.72.1">Considering this possibility, real-time processing using this functionality is a great advantage. </span><span class="koboSpan" id="kobo.72.2">Since Azure Functions in general is a great way of achieving scalability only when needed, this functionality also gives</span><a id="_idIndexMarker249"/><span class="koboSpan" id="kobo.73.1"> us great architecture with great cost-efficiency, allowing us to integrate different scenarios and applications with it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.74.1">On the other hand, you need to pay </span><a id="_idIndexMarker250"/><span class="koboSpan" id="kobo.75.1">attention to the complexity of setting these triggers. </span><span class="koboSpan" id="kobo.75.2">You must consider what will be easier to design, a timer trigger monitoring your data or the option provided by this kind of trigger. </span><span class="koboSpan" id="kobo.75.3">Latency can also be a problem, so be careful with that.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.76.1">Certainly, the Azure SQL trigger is great to use in real-time data processing, where database changes can be critical to some operations. </span><span class="koboSpan" id="kobo.76.2">If you want to synchronize, audit, or even transform data, this can also be useful.</span></p>
<h2 class="heading-2" id="_idParaDest-77"><a id="_idTextAnchor112"/><span class="koboSpan" id="kobo.77.1">Car-sharing SQL trigger example</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.78.1">For this demo, an Azure SQL database</span><a id="_idIndexMarker251"/><span class="koboSpan" id="kobo.79.1"> was created called </span><code class="inlineCode"><span class="koboSpan" id="kobo.80.1">CarShareDB</span></code><span class="koboSpan" id="kobo.81.1">. </span><span class="koboSpan" id="kobo.81.2">In addition, a table called </span><code class="inlineCode"><span class="koboSpan" id="kobo.82.1">Carholder</span></code><span class="koboSpan" id="kobo.83.1"> was also created, and both the database and table were enabled to track their changes, as you can see in the following script:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.84.1">ALTER</span></span><span class="koboSpan" id="kobo.85.1"> DATABASE [CarShareDB]
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.86.1">SET</span></span><span class="koboSpan" id="kobo.87.1"> CHANGE_TRACKING </span><span class="hljs-operator"><span class="koboSpan" id="kobo.88.1">=</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.89.1">ON</span></span><span class="koboSpan" id="kobo.90.1">
(CHANGE_RETENTION </span><span class="hljs-operator"><span class="koboSpan" id="kobo.91.1">=</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.92.1">2</span></span><span class="koboSpan" id="kobo.93.1"> DAYS, AUTO_CLEANUP </span><span class="hljs-operator"><span class="koboSpan" id="kobo.94.1">=</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.95.1">ON</span></span><span class="koboSpan" id="kobo.96.1">);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.97.1">CREATE TABLE</span></span><span class="koboSpan" id="kobo.98.1"> [dbo].[Carholder](
  [Id] [</span><span class="hljs-type"><span class="koboSpan" id="kobo.99.1">int</span></span><span class="koboSpan" id="kobo.100.1">] </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.101.1">NOT NULL</span></span><span class="koboSpan" id="kobo.102.1">,
  [Name] [</span><span class="hljs-type"><span class="koboSpan" id="kobo.103.1">varchar</span></span><span class="koboSpan" id="kobo.104.1">](</span><span class="hljs-number"><span class="koboSpan" id="kobo.105.1">50</span></span><span class="koboSpan" id="kobo.106.1">) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.107.1">NOT NULL</span></span><span class="koboSpan" id="kobo.108.1">,
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.109.1">CONSTRAINT</span></span><span class="koboSpan" id="kobo.110.1"> [PK_Carholder] </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.111.1">PRIMARY KEY</span></span><span class="koboSpan" id="kobo.112.1"> CLUSTERED
(
  [Id] </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.113.1">ASC</span></span><span class="koboSpan" id="kobo.114.1">
)</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.115.1">WITH</span></span><span class="koboSpan" id="kobo.116.1"> (STATISTICS_NORECOMPUTE </span><span class="hljs-operator"><span class="koboSpan" id="kobo.117.1">=</span></span><span class="koboSpan" id="kobo.118.1"> OFF, IGNORE_DUP_KEY </span><span class="hljs-operator"><span class="koboSpan" id="kobo.119.1">=</span></span><span class="koboSpan" id="kobo.120.1"> OFF, OPTIMIZE_FOR_SEQUENTIAL_KEY </span><span class="hljs-operator"><span class="koboSpan" id="kobo.121.1">=</span></span><span class="koboSpan" id="kobo.122.1"> OFF) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.123.1">ON</span></span><span class="koboSpan" id="kobo.124.1"> [</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.125.1">PRIMARY</span></span><span class="koboSpan" id="kobo.126.1">]
) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.127.1">ON</span></span><span class="koboSpan" id="kobo.128.1"> [</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.129.1">PRIMARY</span></span><span class="koboSpan" id="kobo.130.1">]
GO
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.131.1">ALTER TABLE</span></span><span class="koboSpan" id="kobo.132.1"> [dbo].[Carholder]
ENABLE CHANGE_TRACKING;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.133.1">The idea behind this kind of Azure function is to be able to audit the changes made in the table that is being tracked. </span><span class="koboSpan" id="kobo.133.2">So, an </span><a id="_idIndexMarker252"/><span class="koboSpan" id="kobo.134.1">Azure function with a SQL trigger was created.</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.135.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.136.1">Microsoft</span></span><span class="koboSpan" id="kobo.137.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.138.1">Azure</span></span><span class="koboSpan" id="kobo.139.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.140.1">Functions</span></span><span class="koboSpan" id="kobo.141.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.142.1">Worker</span></span><span class="koboSpan" id="kobo.143.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.144.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.145.1">Microsoft</span></span><span class="koboSpan" id="kobo.146.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.147.1">Azure</span></span><span class="koboSpan" id="kobo.148.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.149.1">Functions</span></span><span class="koboSpan" id="kobo.150.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.151.1">Worker</span></span><span class="koboSpan" id="kobo.152.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.153.1">Extensions</span></span><span class="koboSpan" id="kobo.154.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.155.1">Sql</span></span><span class="koboSpan" id="kobo.156.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.157.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.158.1">Microsoft</span></span><span class="koboSpan" id="kobo.159.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.160.1">Extensions</span></span><span class="koboSpan" id="kobo.161.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.162.1">Logging</span></span><span class="koboSpan" id="kobo.163.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.164.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.165.1">Newtonsoft</span></span><span class="koboSpan" id="kobo.166.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.167.1">Json</span></span><span class="koboSpan" id="kobo.168.1">;
namespace </span><span class="hljs-title"><span class="koboSpan" id="kobo.169.1">AuditService</span></span><span class="koboSpan" id="kobo.170.1">
{
  public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.171.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.172.1">Audit</span></span><span class="koboSpan" id="kobo.173.1">
  {
    private readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.174.1">ILogger</span></span><span class="koboSpan" id="kobo.175.1"> _logger;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.176.1">Audit</span></span><span class="koboSpan" id="kobo.177.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.178.1">ILoggerFactory</span></span><span class="koboSpan" id="kobo.179.1"> loggerFactory)
    {
      _logger = loggerFactory.</span><span class="hljs-property"><span class="koboSpan" id="kobo.180.1">CreateLogger</span></span><span class="koboSpan" id="kobo.181.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.182.1">Audit</span></span><span class="koboSpan" id="kobo.183.1">&gt;();
    }
    [</span><span class="hljs-title"><span class="koboSpan" id="kobo.184.1">Function</span></span><span class="koboSpan" id="kobo.185.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.186.1">“Audit”</span></span><span class="koboSpan" id="kobo.187.1">)]
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.188.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.189.1">Run</span></span><span class="koboSpan" id="kobo.190.1">(
      [</span><span class="hljs-title"><span class="koboSpan" id="kobo.191.1">SqlTrigger</span></span><span class="koboSpan" id="kobo.192.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.193.1">“[dbo].[Carholder]”</span></span><span class="koboSpan" id="kobo.194.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.195.1">“CarShareConnectionString”</span></span><span class="koboSpan" id="kobo.196.1">)] </span><span class="hljs-title"><span class="koboSpan" id="kobo.197.1">IReadOnlyList</span></span><span class="koboSpan" id="kobo.198.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.199.1">SqlChange</span></span><span class="koboSpan" id="kobo.200.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.201.1">Carholder</span></span><span class="koboSpan" id="kobo.202.1">&gt;&gt; changes,
                </span><span class="hljs-title"><span class="koboSpan" id="kobo.203.1">FunctionContext</span></span><span class="koboSpan" id="kobo.204.1"> context)
        {
          _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.205.1">LogInformation</span></span><span class="koboSpan" id="kobo.206.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.207.1">“SQL Changes: “</span></span><span class="koboSpan" id="kobo.208.1"> + </span><span class="hljs-title"><span class="koboSpan" id="kobo.209.1">JsonConvert</span></span><span class="koboSpan" id="kobo.210.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.211.1">SerializeObject</span></span><span class="koboSpan" id="kobo.212.1">(changes));
        }
    }
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.213.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.214.1">Carholder</span></span><span class="koboSpan" id="kobo.215.1">
    {
      public int </span><span class="hljs-title"><span class="koboSpan" id="kobo.216.1">Id</span></span><span class="koboSpan" id="kobo.217.1"> { get; set; }
      public string </span><span class="hljs-title"><span class="koboSpan" id="kobo.218.1">Name</span></span><span class="koboSpan" id="kobo.219.1"> { get; set; }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.220.1">There are three important things to observe in this code. </span><span class="koboSpan" id="kobo.220.2">The first one is that this Functions app needs a variable called </span><code class="inlineCode"><span class="koboSpan" id="kobo.221.1">WEBSITE_SITE_NAME</span></code><span class="koboSpan" id="kobo.222.1">. </span><span class="koboSpan" id="kobo.222.2">This variable needs to be placed in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.223.1">local.settings.json</span></code><span class="koboSpan" id="kobo.224.1"> file for debugging locally and will be stored in the environment variables of the app when</span><a id="_idIndexMarker253"/><span class="koboSpan" id="kobo.225.1"> published. </span><span class="koboSpan" id="kobo.225.2">The code block shown below is the content of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.226.1">json</span></code><span class="koboSpan" id="kobo.227.1"> file we have mentioned, defining the </span><code class="inlineCode"><span class="koboSpan" id="kobo.228.1">WEBSITE_SITE_NAME</span></code><span class="koboSpan" id="kobo.229.1"> variable:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-punctuation"><span class="koboSpan" id="kobo.230.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.231.1">“IsEncrypted”</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.232.1">:</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.233.1">false</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.234.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.235.1">“Values”</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.236.1">:</span></span> <span class="hljs-punctuation"><span class="koboSpan" id="kobo.237.1">{</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.238.1">“AzureWebJobsStorage”</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.239.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.240.1">“UseDevelopmentStorage=true”</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.241.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.242.1">“FUNCTIONS_WORKER_RUNTIME”</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.243.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.244.1">“dotnet-isolated”</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.245.1">,</span></span>
<span class="hljs-attr"><span class="koboSpan" id="kobo.246.1">“WEBSITE_SITE_NAME”</span></span><span class="hljs-punctuation"><span class="koboSpan" id="kobo.247.1">:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.248.1">“AuditApp”</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.249.1">}</span></span>
<span class="hljs-punctuation"><span class="koboSpan" id="kobo.250.1">}</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.251.1">Second, there is a connection between the code and SQL Server using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.252.1">CarShareConnectionString</span></code><span class="koboSpan" id="kobo.253.1"> variable, which is stored in the local user secret, as we can see in the following figure.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.254.1"><img alt="Figure 4.4: Managing user secrets locally" src="../Images/B31916_04_4.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.255.1">Figure 4.4: Managing user secrets locally</span></p>
<p class="normal"><span class="koboSpan" id="kobo.256.1">The last thing to observe</span><a id="_idIndexMarker254"/><span class="koboSpan" id="kobo.257.1"> is that you need to define the class that represents the entity that is monitored so that every single change made in the table will be triggered and the data related to the change will be available for usage. </span><span class="koboSpan" id="kobo.257.2">In the example that we are presenting, the class was named </span><code class="inlineCode"><span class="koboSpan" id="kobo.258.1">Carholder</span></code><span class="koboSpan" id="kobo.259.1">.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.260.1"><img alt="Figure 4.5: Function trigger" src="../Images/B31916_04_5.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.261.1">Figure 4.5: Function trigger</span></p>
<p class="normal"><span class="koboSpan" id="kobo.262.1">The result of each trigger can be checked above. </span><span class="koboSpan" id="kobo.262.2">Notice that inserts and updates are sent with the object totally filled, while deletes returns only the ID of an object.</span></p>
<h1 class="heading-1" id="_idParaDest-78"><a id="_idTextAnchor113"/><span class="koboSpan" id="kobo.263.1">Advantages, disadvantages, and when to use the Cosmos DB trigger</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.264.1">In the same way that we have discussed the benefits and downsides when using Azure SQL triggers, we can also discuss Cosmos DB triggers. </span><span class="koboSpan" id="kobo.264.2">This is a powerful feature that allows you to execute serverless functions in response to changes in your Cosmos DB data. </span><span class="koboSpan" id="kobo.264.3">Regardless of whether the items are added, updated, or </span><a id="_idIndexMarker255"/><span class="koboSpan" id="kobo.265.1">deleted in a Cosmos DB collection, the trigger will automatically invoke your function, which enables real-time data processing and integration.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.266.1">Considering this scenario, it is important to </span><a id="_idIndexMarker256"/><span class="koboSpan" id="kobo.267.1">mention that Azure Cosmos DB gives you more flexibility with the data you are handling since it enables non-structured data. </span><span class="koboSpan" id="kobo.267.2">For instance, suppose you want to process telemetry sent by the car that is being shared. </span><span class="koboSpan" id="kobo.267.3">This kind of data would be a bit strange to be handled in Azure SQL Database. </span><span class="koboSpan" id="kobo.267.4">On the other hand, using this data in Cosmos DB can be a good approach.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.268.1">These great advantages can be analyzed together with some concerns that you may have while developing a solution using a Cosmos DB trigger. </span><span class="koboSpan" id="kobo.268.2">The most important one to consider is cost since Cosmos DB applications can be extremely expensive depending on the solution that is developed.</span></p>
<h2 class="heading-2" id="_idParaDest-79"><a id="_idTextAnchor114"/><span class="koboSpan" id="kobo.269.1">Car-sharing Cosmos DB trigger example</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.270.1">For high performance and globally </span><a id="_idIndexMarker257"/><span class="koboSpan" id="kobo.271.1">distributed data storage, suppose the car-sharing app uses Cosmos DB to store real-time car telemetry data, with user activity logs and location information.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.272.1">The following figure shows how an Azure Functions app was created to enable the connection to Azure Cosmos DB.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.273.1"><img alt="Figure 4.6: Creating an Azure Cosmos DB trigger function" src="../Images/B31916_04_6.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.274.1">Figure 4.6: Creating an Azure Cosmos DB trigger function</span></p>
<p class="normal"><span class="koboSpan" id="kobo.275.1">It is great to mention that there is an Azure Cosmos DB emulator that you can use to test and debug your solution, saving costs for this step of development. </span><span class="koboSpan" id="kobo.275.2">For that, you will need to install Docker. </span><span class="koboSpan" id="kobo.275.3">It is important to remember that this is an alternative for testing only; production environments must use Azure Cosmos DB itself.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.276.1">However, it should also be </span><a id="_idIndexMarker258"/><span class="koboSpan" id="kobo.277.1">noted that Visual Studio can also help you create your Azure Cosmos DB. </span><span class="koboSpan" id="kobo.277.2">As you can see in the following figure, there is a wizard where you can set the common variables needed to create the resource in your Azure account inside the Visual Studio environment.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.278.1"><img alt="Figure 4.7: Creating Azure Cosmos DB" src="../Images/B31916_04_7.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.279.1">Figure 4.7: Creating Azure Cosmos DB</span></p>
<p class="normal"><span class="koboSpan" id="kobo.280.1">It takes a while to create </span><a id="_idIndexMarker259"/><span class="koboSpan" id="kobo.281.1">Azure Cosmos DB. </span><span class="koboSpan" id="kobo.281.2">Once this step is done, it is time to analyze exactly how the function trigger works. </span><span class="koboSpan" id="kobo.281.3">Notice that it also works based on the connecting string to the database and the information you want to monitor. </span><span class="koboSpan" id="kobo.281.4">In the case of the example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.282.1">car-telemetry</span></code><span class="koboSpan" id="kobo.283.1"> is being monitored:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.284.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.285.1">Microsoft</span></span><span class="koboSpan" id="kobo.286.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.287.1">Azure</span></span><span class="koboSpan" id="kobo.288.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.289.1">Functions</span></span><span class="koboSpan" id="kobo.290.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.291.1">Worker</span></span><span class="koboSpan" id="kobo.292.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.293.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.294.1">Microsoft</span></span><span class="koboSpan" id="kobo.295.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.296.1">Extensions</span></span><span class="koboSpan" id="kobo.297.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.298.1">Logging</span></span><span class="koboSpan" id="kobo.299.1">;
namespace </span><span class="hljs-title"><span class="koboSpan" id="kobo.300.1">TemeletryService</span></span><span class="koboSpan" id="kobo.301.1">
{
  public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.302.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.303.1">Telemetry</span></span><span class="koboSpan" id="kobo.304.1">
  {
    private readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.305.1">ILogger</span></span><span class="koboSpan" id="kobo.306.1"> _logger;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.307.1">Telemetry</span></span><span class="koboSpan" id="kobo.308.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.309.1">ILoggerFactory</span></span><span class="koboSpan" id="kobo.310.1"> loggerFactory)
    {
      _logger = loggerFactory.</span><span class="hljs-property"><span class="koboSpan" id="kobo.311.1">CreateLogger</span></span><span class="koboSpan" id="kobo.312.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.313.1">Telemetry</span></span><span class="koboSpan" id="kobo.314.1">&gt;();
    }
    [</span><span class="hljs-title"><span class="koboSpan" id="kobo.315.1">Function</span></span><span class="koboSpan" id="kobo.316.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.317.1">“Telemetry”</span></span><span class="koboSpan" id="kobo.318.1">)]
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.319.1">void</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.320.1">Run</span></span><span class="koboSpan" id="kobo.321.1">([</span><span class="hljs-title"><span class="koboSpan" id="kobo.322.1">CosmosDBTrigger</span></span><span class="koboSpan" id="kobo.323.1">(
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.324.1">databaseName</span></span><span class="koboSpan" id="kobo.325.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.326.1">“carshare-db”</span></span><span class="koboSpan" id="kobo.327.1">,
      </span><span class="hljs-attr"><span class="koboSpan" id="kobo.328.1">containerName</span></span><span class="koboSpan" id="kobo.329.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.330.1">“car-telemetry”</span></span><span class="koboSpan" id="kobo.331.1">,
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.332.1">Connection</span></span><span class="koboSpan" id="kobo.333.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.334.1">“CosmosDBConnection”</span></span><span class="koboSpan" id="kobo.335.1">,
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.336.1">LeaseContainerName</span></span><span class="koboSpan" id="kobo.337.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.338.1">“leases”</span></span><span class="koboSpan" id="kobo.339.1">,
      </span><span class="hljs-title"><span class="koboSpan" id="kobo.340.1">CreateLeaseContainerIfNotExists</span></span><span class="koboSpan" id="kobo.341.1"> = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.342.1">true</span></span><span class="koboSpan" id="kobo.343.1">)] </span><span class="hljs-title"><span class="koboSpan" id="kobo.344.1">IReadOnlyList</span></span><span class="koboSpan" id="kobo.345.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.346.1">CarTelemetry</span></span><span class="koboSpan" id="kobo.347.1">&gt; 
          input)
      {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.348.1">if</span></span><span class="koboSpan" id="kobo.349.1"> (input != </span><span class="hljs-literal"><span class="koboSpan" id="kobo.350.1">null</span></span><span class="koboSpan" id="kobo.351.1"> &amp;&amp; input.</span><span class="hljs-property"><span class="koboSpan" id="kobo.352.1">Count</span></span><span class="koboSpan" id="kobo.353.1"> &gt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.354.1">0</span></span><span class="koboSpan" id="kobo.355.1">)
        {
          _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.356.1">LogInformation</span></span><span class="koboSpan" id="kobo.357.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.358.1">“Documents modified: “</span></span><span class="koboSpan" id="kobo.359.1"> + input.</span><span class="hljs-property"><span class="koboSpan" id="kobo.360.1">Count</span></span><span class="koboSpan" id="kobo.361.1">);
          _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.362.1">LogInformation</span></span><span class="koboSpan" id="kobo.363.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.364.1">“First document Id: “</span></span><span class="koboSpan" id="kobo.365.1"> + input[</span><span class="hljs-number"><span class="koboSpan" id="kobo.366.1">0</span></span><span class="koboSpan" id="kobo.367.1">].</span><span class="hljs-property"><span class="koboSpan" id="kobo.368.1">carid</span></span><span class="koboSpan" id="kobo.369.1">);
        }
      }
    }
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.370.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.371.1">CarTelemetry</span></span><span class="koboSpan" id="kobo.372.1">
    {
      public string carid { get; set; }
      public </span><span class="hljs-title"><span class="koboSpan" id="kobo.373.1">DateTime</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.374.1">Date</span></span><span class="koboSpan" id="kobo.375.1"> { get; set; }
      public string </span><span class="hljs-title"><span class="koboSpan" id="kobo.376.1">Data</span></span><span class="koboSpan" id="kobo.377.1"> { get; set; }
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.378.1">To test the function, you can</span><a id="_idIndexMarker260"/><span class="koboSpan" id="kobo.379.1"> use the user interface provided by Azure Cosmos DB in the Azure portal.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.380.1"><img alt="Figure 4.8: Inserting data into Azure Cosmos DB" src="../Images/B31916_04_8.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.381.1">Figure 4.8: Inserting data into Azure Cosmos DB</span></p>
<p class="normal"><span class="koboSpan" id="kobo.382.1">The result can be checked by inserting a breakpoint in the code of the Azure function, where we can check that the data sent can be seen in the code.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.383.1"><img alt="Figure 4.9: Azure Cosmos DB trigger" src="../Images/B31916_04_9.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.384.1">Figure 4.9: Azure Cosmos DB trigger</span></p>
<p class="normal"><span class="koboSpan" id="kobo.385.1">Although the Azure Cosmos DB trigger is very similar to the Azure SQL trigger, it is important to mention that the Azure </span><a id="_idIndexMarker261"/><span class="koboSpan" id="kobo.386.1">Cosmos DB trigger only monitors inserts and updates in Cosmos DB. </span><span class="koboSpan" id="kobo.386.2">So, if you need to monitor deletions, you will not have this option in this kind of trigger.</span></p>
<h1 class="heading-1" id="_idParaDest-80"><a id="_idTextAnchor115"/><span class="koboSpan" id="kobo.387.1">Azure Service Bus trigger</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.388.1">One of the most important components in</span><a id="_idIndexMarker262"/><span class="koboSpan" id="kobo.389.1"> a microservices solution is a service bus for enabling communication between the microservices. </span><span class="koboSpan" id="kobo.389.2">Azure Service Bus is one of the options presented on the market to do so.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.390.1">Azure Functions provides two ways of connecting to Azure Service Bus. </span><span class="koboSpan" id="kobo.390.2">You can monitor a specific queue or a general topic. </span><span class="koboSpan" id="kobo.390.3">The concept behind the Azure Service Bus queue service is to deliver a solution that enables reliable communication between distributed applications and services. </span><span class="koboSpan" id="kobo.390.4">It operates on a </span><strong class="keyWord"><span class="koboSpan" id="kobo.391.1">first-in, first-out</span></strong><span class="koboSpan" id="kobo.392.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.393.1">FIFO</span></strong><span class="koboSpan" id="kobo.394.1">) basis, ensuring that messages are processed in the order they were sent. </span><span class="koboSpan" id="kobo.394.2">If you need to</span><a id="_idIndexMarker263"/><span class="koboSpan" id="kobo.395.1"> decouple an application, enhance scalability, and maintain high availability by buffering messages during peak loads, you may decide to use it. </span><span class="koboSpan" id="kobo.395.2">It is important to remember that messages sent to the queue are stored until they are retrieved and processed by the receiving application, guaranteeing delivery even in the face of transient failures. </span><span class="koboSpan" id="kobo.395.3">It is great to mention that the Service Bus queue supports features such as message sessions for ordered processing, dead-letter queues for handling message failures, and duplicate detection to prevent the processing of duplicate messages.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.396.1">On the other hand, Azure Service Bus topics are designed for scenarios that require a publish/subscribe model. </span><span class="koboSpan" id="kobo.396.2">This feature enables multiple subscribers to receive copies of the same message, allowing for greater flexibility and scalability in your messaging infrastructure. </span><span class="koboSpan" id="kobo.396.3">With topics, you can filter messages </span><a id="_idIndexMarker264"/><span class="koboSpan" id="kobo.397.1">based on specific criteria, ensuring that each subscriber only receives the messages relevant to them. </span><span class="koboSpan" id="kobo.397.2">This is particularly useful in complex workflows where different components or services need to react to different types of events.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.398.1">The Azure Service Bus trigger also enables scalability, reliability, integration, and flexibility for your solution, since this is something delivered by default for any Azure function. </span><span class="koboSpan" id="kobo.398.2">As a point of concern, again, the cost must be considered. </span><span class="koboSpan" id="kobo.398.3">It is worth noting that queues are cheaper than topics, so you may analyze if topics are really needed for your solution. </span><span class="koboSpan" id="kobo.398.4">Also, do not forget to check that the performance you need for your application will not be degraded with the service bus you have selected.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.399.1">The Azure Service Bus trigger can be used when you are developing an event-driven solution and you want to process messages or even design a workflow automation. </span><span class="koboSpan" id="kobo.399.2">For instance, in the car-sharing example, we will use the trigger to represent when someone is searching for a car.</span></p>
<h2 class="heading-2" id="_idParaDest-81"><a id="_idTextAnchor116"/><span class="koboSpan" id="kobo.400.1">Comparison with the Kafka trigger and the RabbitMQ trigger</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.401.1">The </span><a id="_idIndexMarker265"/><span class="koboSpan" id="kobo.402.1">Azure Functions</span><a id="_idIndexMarker266"/><span class="koboSpan" id="kobo.403.1"> Service Bus trigger, Kafka trigger, and RabbitMQ trigger all serve </span><a id="_idIndexMarker267"/><span class="koboSpan" id="kobo.404.1">similar purposes. </span><span class="koboSpan" id="kobo.404.2">However, depending</span><a id="_idIndexMarker268"/><span class="koboSpan" id="kobo.405.1"> on the scenario you are working on, you may decide to select a different bus.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.406.1">For example, Kafka is well known for scenarios where distributed streaming is required, and where you will have high throughput with real-time data processing.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.407.1">On the other hand, RabbitMQ is easier to use, and it is better for lightweight and flexible messages, especially if you need compatibility with multiple messaging protocols.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.408.1">Azure Service Bus is well integrated </span><a id="_idIndexMarker269"/><span class="koboSpan" id="kobo.409.1">with Azure services, although it supports various message patterns. </span><span class="koboSpan" id="kobo.409.2">If you need reliable delivery </span><a id="_idIndexMarker270"/><span class="koboSpan" id="kobo.410.1">and processing, this may be the best option.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.411.1">As you can see, each of </span><a id="_idIndexMarker271"/><span class="koboSpan" id="kobo.412.1">these buses has its advantages and is suited for different types of applications. </span><span class="koboSpan" id="kobo.412.2">The triggers available in Azure Functions for them are very similar, so choosing the right trigger depends more on the specific requirements of the application you are designing.</span></p>
<h2 class="heading-2" id="_idParaDest-82"><a id="_idTextAnchor117"/><span class="koboSpan" id="kobo.413.1">Car-sharing example with the Azure Service Bus trigger</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.414.1">The Azure Service Bus trigger is </span><a id="_idIndexMarker272"/><span class="koboSpan" id="kobo.415.1">used in our example for the subscription of the message that indicates a car-seeking request. </span><span class="koboSpan" id="kobo.415.2">The idea behind using a topic here is that many microservices of the solution may want to know that a car-seeking request is being made. </span><span class="koboSpan" id="kobo.415.3">The service that we are simulating in the example is the one that will start the route planner for the car that is needed, as we can see in the following figure.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.416.1"><img alt="Figure 4.10: Route handling subsystem of a car-sharing application" src="../Images/B31916_04_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.417.1">Figure 4.10: Route handling subsystem of a car-sharing application</span></p>
<p class="normal"><span class="koboSpan" id="kobo.418.1">To do so, an Azure function for monitoring the Service Bus trigger in the topic </span><code class="inlineCode"><span class="koboSpan" id="kobo.419.1">car-seeking-requests</span></code><span class="koboSpan" id="kobo.420.1"> is created. </span><span class="koboSpan" id="kobo.420.2">The </span><a id="_idIndexMarker273"/><span class="koboSpan" id="kobo.421.1">messages that are subscribed from this topic are the ones named </span><code class="inlineCode"><span class="koboSpan" id="kobo.422.1">routes</span></code><span class="koboSpan" id="kobo.423.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.424.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.425.1">Azure</span></span><span class="koboSpan" id="kobo.426.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.427.1">Messaging</span></span><span class="koboSpan" id="kobo.428.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.429.1">ServiceBus</span></span><span class="koboSpan" id="kobo.430.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.431.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.432.1">Microsoft</span></span><span class="koboSpan" id="kobo.433.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.434.1">Azure</span></span><span class="koboSpan" id="kobo.435.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.436.1">Functions</span></span><span class="koboSpan" id="kobo.437.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.438.1">Worker</span></span><span class="koboSpan" id="kobo.439.1">;
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.440.1">using</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.441.1">Microsoft</span></span><span class="koboSpan" id="kobo.442.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.443.1">Extensions</span></span><span class="koboSpan" id="kobo.444.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.445.1">Logging</span></span><span class="koboSpan" id="kobo.446.1">;
namespace </span><span class="hljs-title"><span class="koboSpan" id="kobo.447.1">RoutesPlanner</span></span><span class="koboSpan" id="kobo.448.1">
{
  public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.449.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.450.1">CarSeeking</span></span><span class="koboSpan" id="kobo.451.1">
  {
    private readonly </span><span class="hljs-title"><span class="koboSpan" id="kobo.452.1">ILogger</span></span><span class="koboSpan" id="kobo.453.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.454.1">CarSeeking</span></span><span class="koboSpan" id="kobo.455.1">&gt; _logger;
    public </span><span class="hljs-title"><span class="koboSpan" id="kobo.456.1">CarSeeking</span></span><span class="koboSpan" id="kobo.457.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.458.1">ILogger</span></span><span class="koboSpan" id="kobo.459.1">&lt;</span><span class="hljs-title"><span class="koboSpan" id="kobo.460.1">CarSeeking</span></span><span class="koboSpan" id="kobo.461.1">&gt; logger)
    {
      _logger = logger;
    }
    [</span><span class="hljs-title"><span class="koboSpan" id="kobo.462.1">Function</span></span><span class="koboSpan" id="kobo.463.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.464.1">nameof</span></span><span class="koboSpan" id="kobo.465.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.466.1">CarSeeking</span></span><span class="koboSpan" id="kobo.467.1">))]
    public </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.468.1">async</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.469.1">Task</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.470.1">Run</span></span><span class="koboSpan" id="kobo.471.1">(
      [</span><span class="hljs-title"><span class="koboSpan" id="kobo.472.1">ServiceBusTrigger</span></span><span class="koboSpan" id="kobo.473.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.474.1">“car-seeking-requests”</span></span><span class="koboSpan" id="kobo.475.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.476.1">“routes”</span></span><span class="koboSpan" id="kobo.477.1">,
                          </span><span class="hljs-title"><span class="koboSpan" id="kobo.478.1">Connection</span></span><span class="koboSpan" id="kobo.479.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.480.1">“car-share-bus”</span></span><span class="koboSpan" id="kobo.481.1">)]
       </span><span class="hljs-title"><span class="koboSpan" id="kobo.482.1">ServiceBusReceivedMessage</span></span><span class="koboSpan" id="kobo.483.1"> message,
       </span><span class="hljs-title"><span class="koboSpan" id="kobo.484.1">ServiceBusMessageActions</span></span><span class="koboSpan" id="kobo.485.1"> messageActions)
       {
         _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.486.1">LogInformation</span></span><span class="koboSpan" id="kobo.487.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.488.1">“Message ID: {id}”</span></span><span class="koboSpan" id="kobo.489.1">, message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.490.1">MessageId</span></span><span class="koboSpan" id="kobo.491.1">);
         _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.492.1">LogInformation</span></span><span class="koboSpan" id="kobo.493.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.494.1">“Message Body: {body}”</span></span><span class="koboSpan" id="kobo.495.1">, message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.496.1">Body</span></span><span class="koboSpan" id="kobo.497.1">);
         _logger.</span><span class="hljs-title"><span class="koboSpan" id="kobo.498.1">LogInformation</span></span><span class="koboSpan" id="kobo.499.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.500.1">“Message Content-Type: {contentType}”</span></span><span class="koboSpan" id="kobo.501.1">,
                                 message.</span><span class="hljs-property"><span class="koboSpan" id="kobo.502.1">ContentType</span></span><span class="koboSpan" id="kobo.503.1">);
         </span><span class="hljs-comment"><span class="koboSpan" id="kobo.504.1">// Complete the message</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.505.1">await</span></span><span class="koboSpan" id="kobo.506.1"> messageActions.</span><span class="hljs-title"><span class="koboSpan" id="kobo.507.1">CompleteMessageAsync</span></span><span class="koboSpan" id="kobo.508.1">(message);
       }
    }
  }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.509.1">Once a message is sent for </span><a id="_idIndexMarker274"/><span class="koboSpan" id="kobo.510.1">a route, the function is automatically triggered, and all the information presented in the body of the message, together with information about the content type of the message and its ID, is available in the Azure function.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.511.1"><img alt="Figure 4.11: Message triggered after Azure Service Bus received the content" src="../Images/B31916_04_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.512.1">Figure 4.11: Message triggered after Azure Service Bus received the content</span></p>
<p class="normal"><span class="koboSpan" id="kobo.513.1">It is important to note that once the message is processed by the Azure function, since there is no other subscriber, the </span><a id="_idIndexMarker275"/><span class="koboSpan" id="kobo.514.1">message is cleared from the bus. </span><span class="koboSpan" id="kobo.514.2">It is also necessary to remember that if the function is not running, the bus service will retain them according to the settings configured in Azure Service Bus.</span></p>
<h1 class="heading-1" id="_idParaDest-83"><a id="_idTextAnchor118"/><span class="koboSpan" id="kobo.515.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.516.1">This chapter provided a comprehensive overview of various triggers available in Azure Functions, focusing on their advantages, disadvantages, and practical use cases. </span><span class="koboSpan" id="kobo.516.2">It then delved into specific triggers, starting with the HTTP trigger, which was highlighted for its ease of use and versatility in handling web requests. </span><span class="koboSpan" id="kobo.516.3">The support for multiple HTTP methods and integration with other Azure services were also advantages presented in the chapter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.517.1">The chapter also covered Azure SQL triggers, emphasizing their real-time data processing capabilities and the requirement for SQL Server change tracking. </span><span class="koboSpan" id="kobo.517.2">Similarly, the Cosmos DB trigger was explained, with its benefits in handling non-structured data and real-time processing presented.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.518.1">To finish, the chapter compared the Azure Service Bus, Kafka, and RabbitMQ services, presenting a demo using an Azure Service Bus trigger for the car-sharing application presented in the book.</span></p>
<h1 class="heading-1" id="_idParaDest-84"><a id="_idTextAnchor119"/><span class="koboSpan" id="kobo.519.1">Questions</span></h1>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.520.1">What are the main advantages of using HTTP triggers in Azure Functions?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.521.1">HTTP triggers offer a straightforward and standardized way of exposing your functions as web endpoints, making it easy to create APIs and webhooks. </span><span class="koboSpan" id="kobo.521.2">They allow rapid development and integration with other web services and client applications, leveraging familiar HTTP methods and status codes for communication.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.522.1">In addition, HTTP triggers enable automatic scaling, so your functions can handle varying loads efficiently. </span><span class="koboSpan" id="kobo.522.2">This helps ensure that your applications remain responsive under fluctuating traffic while benefiting from a pay-as-you-go pricing model that optimizes costs.</span></p>
<ol>
<li class="numberedList" value="2"><span class="koboSpan" id="kobo.523.1">What are some potential disadvantages of using HTTP triggers, and how can they be mitigated?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.524.1">One potential disadvantage is the occurrence of cold starts, particularly on the Consumption plan, which may cause delays during initial HTTP requests. </span><span class="koboSpan" id="kobo.524.2">Additionally, exposing functions via HTTP requires careful attention to security, as misconfigured endpoints could become vulnerable to unauthorized access or abuse.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.525.1">These concerns can be mitigated by implementing strategies such as using Premium or Dedicated plans to reduce cold start delays, adding warm-up triggers, or enforcing robust authentication and authorization policies. </span><span class="koboSpan" id="kobo.525.2">Leveraging API Management or other gateway solutions can also help secure and manage HTTP-triggered functions effectively.</span></p>
<ol>
<li class="numberedList" value="3"><span class="koboSpan" id="kobo.526.1">How does the Azure SQL trigger enable real-time data processing, and what are its requirements?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.527.1">Although Azure Functions does not include a native SQL trigger, real-time data processing can be achieved by combining database change detection (using SQL change tracking or change data capture) with a function that polls or listens for changes. </span><span class="koboSpan" id="kobo.527.2">This approach enables the system to react to data modifications almost immediately, triggering processing workflows as soon as a change is detected.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.528.1">To implement this, your Azure SQL database must have change tracking or CDC enabled, and you need to configure a reliable mechanism for querying changes at regular intervals. </span><span class="koboSpan" id="kobo.528.2">Proper connectivity, efficient query design, and handling of potential latency issues are key requirements for ensuring that real-time processing is both accurate and performant.</span></p>
<ol>
<li class="numberedList" value="4"><span class="koboSpan" id="kobo.529.1">What are the benefits and concerns associated with using Cosmos DB triggers in Azure Functions?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.530.1">Cosmos DB triggers provide near real-time processing of data changes by leveraging the Cosmos DB change feed. </span><span class="koboSpan" id="kobo.530.2">This integration allows your functions to automatically respond to new or updated documents, enabling event-driven workflows and scalable data processing without requiring manual polling.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.531.1">However, there are concerns such as potential throttling and cost implications if the throughput is not properly managed. </span><span class="koboSpan" id="kobo.531.2">Moreover, ensuring data consistency and handling high-volume change feeds can be challenging. </span><span class="koboSpan" id="kobo.531.3">These issues can be addressed through careful planning of request units (RUs), partitioning strategies, and monitoring the performance and load of your Cosmos DB account.</span></p>
<ol>
<li class="numberedList" value="5"><span class="koboSpan" id="kobo.532.1">How do Azure Service Bus triggers compare with Kafka and RabbitMQ triggers, and in what scenarios are they best used?</span></li>
</ol>
<p class="normal-one"><span class="koboSpan" id="kobo.533.1">Azure Service Bus triggers are part of a fully managed messaging service that offers features like reliable message delivery, dead-lettering, sessions, and auto-scaling. </span><span class="koboSpan" id="kobo.533.2">They integrate seamlessly with the Azure ecosystem, making them ideal for enterprise scenarios where robust, secure, and managed message processing is required.</span></p>
<p class="normal-one"><span class="koboSpan" id="kobo.534.1">In contrast, Kafka and RabbitMQ are often chosen for their high throughput (Kafka) or lightweight, flexible messaging (RabbitMQ) in environments where you might require more control over the infrastructure. </span><span class="koboSpan" id="kobo.534.2">Azure Service Bus triggers are best suited for scenarios that benefit from a managed service with deep integration into Azure, particularly when the application requires enterprise-level messaging reliability and scalability without the overhead of managing the messaging infrastructure.</span></p>
<h1 class="heading-1" id="_idParaDest-85"><a id="_idTextAnchor120"/><span class="koboSpan" id="kobo.535.1">Further reading</span></h1>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.536.1">Azure Function HTTP trigger: </span><a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook-trigger"><span class="url"><span class="koboSpan" id="kobo.537.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook-trigger</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.538.1">Azure Function SQL trigger: </span><a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-azure-sql"><span class="url"><span class="koboSpan" id="kobo.539.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-azure-sql</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.540.1">SQL Server change tracking: </span><a href="https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/about-change-tracking-sql-server"><span class="url"><span class="koboSpan" id="kobo.541.1">https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/about-change-tracking-sql-server</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.542.1">Azure Functions Cosmos DB trigger: </span><a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-cosmosdb"><span class="url"><span class="koboSpan" id="kobo.543.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-cosmosdb</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.544.1">Azure Functions Service Bus trigger: </span><a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-service-bus"><span class="url"><span class="koboSpan" id="kobo.545.1">https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-service-bus</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.546.1">Queue design pattern: </span><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling"><span class="url"><span class="koboSpan" id="kobo.547.1">https://learn.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.548.1">Publisher-Subscriber design pattern: </span><span class="url"><span class="koboSpan" id="kobo.549.1">https://learn.microsoft.com/en-us/azure/architecture/patterns/publisher-subscriber</span></span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.550.1">Storing secrets: </span><a href="https://learn.microsoft.com/en-us/aspnet/core/security/app-secrets"><span class="url"><span class="koboSpan" id="kobo.551.1">https://learn.microsoft.com/en-us/aspnet/core/security/app-secrets</span></span></a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-86"><span class="url"><a id="_idTextAnchor121"/></span><span class="koboSpan" id="kobo.552.1">Join our community on Discord</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.553.1">Join our community’s Discord space for discussions with the author and other readers:</span></p>
<p class="normal"><a href="https://packt.link/PSMCSharp"><span class="url"><span class="koboSpan" id="kobo.554.1">https://packt.link/PSMCSharp</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.555.1"><img alt="A qr code with black squares  AI-generated content may be incorrect." src="../Images/B31916_Discord-QR-Code.png"/></span></p>
</div>
</body></html>